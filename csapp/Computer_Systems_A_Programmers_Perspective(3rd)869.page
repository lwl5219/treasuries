<div id="pf365" class="pf w2 h11" data-page-no="365"><div class="pc pc365 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg365.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">868<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x14 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.28</div><div class="t m5 x14 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Linux<span class="_ _6"> </span>page<span class="_ _6"> </span>fault<span class="_ _13"> </span>handling.</div><div class="t m5 x86 h91 y70b5 ffbc fs57 fc1 sc0 ls0 ws0">Proce<span class="ffbd">ss</span> virt<span class="ffbd">ua</span>l memory</div><div class="t m5 x181 h91 y70b6 ffbd fs57 fc1 sc0 ls0 ws0">S<span class="ffbc">h</span>a<span class="ffbc">red li</span>b<span class="ffbc">r</span>a<span class="ffbc">rie</span>s</div><div class="t m5 x39 h91 y70b7 ffbc fs57 fc1 sc0 ls0 ws0">D<span class="ffbd">a</span>t<span class="ffbd">a</span></div><div class="t m5 x191 h91 y70b8 ffbc fs57 fc1 sc0 ls0 ws0">Code</div><div class="t m5 x1c3 h91 y70b9 ffbd fs57 fc1 sc0 ls0 ws0">S<span class="ffbc">egment</span>a<span class="ffbc">tion f</span>au<span class="ffbc">lt:</span></div><div class="t m5 x1c3 h91 y70ba ffbc fs57 fc1 sc0 ls0 ws0">Acce<span class="ffbd">ss</span>ing <span class="ffbd">a</span> nonexi<span class="ffbd">s</span>tent p<span class="ffbd">a</span>ge</div><div class="t m5 x1c3 h91 y70bb ffbc fs57 fc1 sc0 ls0 ws0">Norm<span class="ffbd">a</span>l p<span class="ffbd">a</span>ge f<span class="ffbd">au</span>lt</div><div class="t m5 x11f h91 y70bc ffbc fs57 fc1 sc0 ls0 ws0">Protection exception</div><div class="t m5 x11f h91 y70bd ffbc fs57 fc1 sc0 ls0 ws0">(e.g., viol<span class="ffbd">a</span>ting permi<span class="ffbd">ss</span>ion <span class="ffbd">b</span>y</div><div class="t m5 x11f h91 y70be ffbc fs57 fc1 sc0 ls0 ws0">writing to <span class="ffbd">a</span> re<span class="ffbd">a</span>d-only p<span class="ffbd">a</span>ge)</div><div class="t m5 x144 h91 y70bf ffbc fs57 fc1 sc0 ls0 ws0">1</div><div class="t m5 x144 h91 y70c0 ffbc fs57 fc1 sc0 ls0 ws0">3</div><div class="t m5 x144 h91 y70c1 ffbc fs57 fc1 sc0 ls0 ws0">2</div><div class="t m5 x18e h10c y70c2 ffbe fs57 fc1 sc0 ls0 ws0">vm_area_struct</div><div class="t m5 x6d h10c y70c3 ffbe fs57 fc1 sc0 ls0 ws0">0</div><div class="t m5 x50 h10c y70c4 ffbe fs57 fc1 sc0 ls0 ws0">vm_end</div><div class="t m5 x7c h10c y70c5 ffbe fs57 fc1 sc0 ls0 ws0">vm_start</div><div class="t m5 xf8 h10c y70c6 ffbe fs57 fc1 sc0 ls0 ws0">r/o</div><div class="t m5 x1a5 h10c y70c7 ffbe fs57 fc1 sc0 ls0 ws0">vm_next</div><div class="t m5 x50 h10c y70c8 ffbe fs57 fc1 sc0 ls0 ws0">vm_end</div><div class="t m5 x7c h10c y70c9 ffbe fs57 fc1 sc0 ls0 ws0">vm_start</div><div class="t m5 xf8 h10c y70ca ffbe fs57 fc1 sc0 ls0 ws0">r/w</div><div class="t m5 x1a5 h10c y70cb ffbe fs57 fc1 sc0 ls0 ws0">vm_next</div><div class="t m5 x50 h10c y70cc ffbe fs57 fc1 sc0 ls0 ws0">vm_end</div><div class="t m5 x7c h10c y70cd ffbe fs57 fc1 sc0 ls0 ws0">vm_start</div><div class="t m5 xf8 h10c y70ce ffbe fs57 fc1 sc0 ls0 ws0">r/o</div><div class="t m5 x1a5 h10c y70cf ffbe fs57 fc1 sc0 ls0 ws0">vm_next</div><div class="t m5 x1d h42 y70d0 ff6 fs29 fc6 sc0 ls0 ws0">Linux<span class="_ _11"> </span>Page<span class="_ _16"> </span>Fault<span class="_ _16"> </span>Exception<span class="_ _11"> </span>Handling</div><div class="t m5 x1d h26 y70d1 ff7 fs19 fc1 sc0 ls0 ws0">Suppose<span class="_ _15"> </span>the<span class="_ _15"> </span>MMU<span class="_ _15"> </span>triggers<span class="_ _15"> </span>a<span class="_ _15"> </span>page<span class="_ _15"> </span>fault<span class="_ _15"> </span>while<span class="_ _15"> </span>trying<span class="_ _15"> </span>to<span class="_ _15"> </span>translate<span class="_ _15"> </span>some<span class="_ _15"> </span>virtual</div><div class="t m5 x1d h26 y70d2 ff7 fs19 fc1 sc0 ls0 ws0">address<span class="_"> </span><span class="ff11">A</span>.<span class="_ _13"> </span>The<span class="_ _13"> </span>exception<span class="_"> </span>results<span class="_"> </span>in<span class="_"> </span>a<span class="_ _13"> </span>transfer<span class="_"> </span>of<span class="_"> </span>control<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>kernel’s<span class="_ _13"> </span>page<span class="_"> </span>fault</div><div class="t m5 x1d h26 y70d3 ff7 fs19 fc1 sc0 ls0 ws0">handler,<span class="_"> </span>which<span class="_"> </span>then<span class="_"> </span>performs<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>steps:</div><div class="t m5 xc5 h26 y70d4 ffc fs19 fc1 sc0 ls0 ws0">1.<span class="_ _e"> </span><span class="ff7">Is<span class="_ _13"> </span>virtual<span class="_ _13"> </span>address<span class="_ _13"> </span><span class="ff11">A<span class="_ _13"> </span></span>legal?<span class="_ _13"> </span>In<span class="_ _13"> </span>other<span class="_ _13"> </span>words<span class="_ _1"></span>,<span class="_"> </span>does<span class="_ _13"> </span><span class="ff11">A<span class="_ _13"> </span></span>lie<span class="_ _13"> </span>within<span class="_ _13"> </span>an<span class="_ _13"> </span>area<span class="_ _13"> </span>deﬁned<span class="_ _13"> </span>by</span></div><div class="t m5 x29 h26 y70d5 ff7 fs19 fc1 sc0 ls0 ws0">some<span class="_ _6"> </span>area<span class="_ _13"> </span>struct?<span class="_ _6"> </span>T<span class="_ _3"></span>o<span class="_ _6"> </span>answer<span class="_ _13"> </span>this<span class="_ _6"> </span>question,<span class="_ _13"> </span>the<span class="_ _6"> </span>fault<span class="_ _13"> </span>handler<span class="_ _6"> </span>searches<span class="_ _13"> </span>the<span class="_ _6"> </span>list<span class="_ _6"> </span>of</div><div class="t m5 x29 h26 y70d6 ff7 fs19 fc1 sc0 ls0 ws0">area<span class="_"> </span>structs<span class="_ _1"></span>,<span class="_"> </span>comparing<span class="_"> </span><span class="ff11">A<span class="_ _11"> </span></span>with<span class="_"> </span>the<span class="_"> </span><span class="ffd">vm_start<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ffd">vm_end<span class="_ _10"> </span></span>in<span class="_ _11"> </span>each<span class="_"> </span>area<span class="_"> </span>struct.</div><div class="t m5 x29 h26 y70d7 ff7 fs19 fc1 sc0 ls0 ws0">If<span class="_ _11"> </span>the<span class="_ _16"> </span>instruction<span class="_ _11"> </span>is<span class="_ _16"> </span>not<span class="_ _11"> </span>legal,<span class="_ _16"> </span>then<span class="_ _11"> </span>the<span class="_ _16"> </span>fault<span class="_ _11"> </span>handler<span class="_ _11"> </span>triggers<span class="_ _16"> </span>a<span class="_ _11"> </span>segmentation</div><div class="t m5 x29 h26 y70d8 ff7 fs19 fc1 sc0 ls0 ws0">fault,<span class="_ _13"> </span>which<span class="_ _6"> </span>terminates<span class="_ _13"> </span>the<span class="_ _13"> </span>process<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>his<span class="_ _13"> </span>situation<span class="_ _13"> </span>is<span class="_ _6"> </span>labeled<span class="_ _13"> </span>“1”<span class="_ _6"> </span>in<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>9.28.</div><div class="t m5 xcd h26 y70d9 ff7 fs19 fc1 sc0 ls0 ws0">Because<span class="_ _13"> </span>a<span class="_ _13"> </span>process<span class="_"> </span>can<span class="_ _13"> </span>create<span class="_ _13"> </span>an<span class="_ _13"> </span>arbitrary<span class="_ _13"> </span>number<span class="_"> </span>of<span class="_ _13"> </span>new<span class="_ _13"> </span>virtual<span class="_ _13"> </span>memory</div><div class="t m5 x29 h26 y70da ff7 fs19 fc1 sc0 ls0 ws0">areas<span class="_ _14"> </span>(using<span class="_ _15"> </span>the<span class="_ _15"> </span><span class="ffd">mmap<span class="_ _14"> </span></span>function<span class="_ _15"> </span>described<span class="_ _15"> </span>in<span class="_ _14"> </span>the<span class="_ _15"> </span>next<span class="_ _14"> </span>section),<span class="_ _21"> </span>a<span class="_ _15"> </span>sequential</div><div class="t m5 x29 h26 y70db ff7 fs19 fc1 sc0 ls0 ws0">search<span class="_ _14"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>list<span class="_ _14"> </span>of<span class="_ _14"> </span>area<span class="_ _14"> </span>structs<span class="_ _14"> </span>might<span class="_ _14"> </span>be<span class="_ _16"> </span>very<span class="_ _14"> </span>costly<span class="_ _3"></span>.<span class="_ _14"> </span>So<span class="_ _14"> </span>in<span class="_ _14"> </span>practice<span class="_ _1"></span>,<span class="_ _15"> </span>Linux</div><div class="t m5 x29 h26 y70dc ff7 fs19 fc1 sc0 ls0 ws0">superimposes<span class="_ _13"> </span>a<span class="_ _13"> </span>tree<span class="_ _13"> </span>on<span class="_"> </span>the<span class="_ _13"> </span>list,<span class="_ _13"> </span>using<span class="_ _13"> </span>some<span class="_ _13"> </span>ﬁelds<span class="_"> </span>that<span class="_ _13"> </span>we<span class="_ _13"> </span>have<span class="_ _13"> </span>not<span class="_ _13"> </span>shown,<span class="_"> </span>and</div><div class="t m5 x29 h26 y70dd ff7 fs19 fc1 sc0 ls0 ws0">performs<span class="_"> </span>the<span class="_"> </span>search<span class="_"> </span>on<span class="_"> </span>this<span class="_"> </span>tree<span class="_ _1"></span>.</div><div class="t m5 xc5 h26 y70de ffc fs19 fc1 sc0 ls0 ws0">2.<span class="_ _e"> </span><span class="ff7">Is<span class="_"> </span>the<span class="_"> </span>attempted<span class="_ _13"> </span>memory<span class="_"> </span>access<span class="_"> </span>legal?<span class="_ _13"> </span>In<span class="_"> </span>other<span class="_"> </span>words<span class="_ _3"></span>,<span class="_"> </span>does<span class="_"> </span>the<span class="_ _13"> </span>process<span class="_"> </span>have</span></div><div class="t m5 x29 h26 y70df ff7 fs19 fc1 sc0 ls0 ws0">permission<span class="_ _14"> </span>to<span class="_ _15"> </span>read,<span class="_ _21"> </span>write,<span class="_ _15"> </span>or<span class="_ _15"> </span>execute<span class="_ _14"> </span>the<span class="_ _15"> </span>pages<span class="_ _15"> </span>in<span class="_ _15"> </span>this<span class="_ _15"> </span>area?<span class="_ _14"> </span>F<span class="_ _0"></span>or<span class="_ _14"> </span>example,</div><div class="t m5 x29 h26 y70e0 ff7 fs19 fc1 sc0 ls0 ws0">was<span class="_ _16"> </span>the<span class="_ _11"> </span>page<span class="_ _16"> </span>fault<span class="_ _16"> </span>the<span class="_ _11"> </span>result<span class="_ _16"> </span>of<span class="_ _16"> </span>a<span class="_ _11"> </span>store<span class="_ _16"> </span>instruction<span class="_ _16"> </span>trying<span class="_ _11"> </span>to<span class="_ _16"> </span>write<span class="_ _16"> </span>to<span class="_ _16"> </span>a<span class="_ _11"> </span>read-</div><div class="t m5 x29 h26 y70e1 ff7 fs19 fc1 sc0 ls0 ws0">only<span class="_ _f"> </span>page<span class="_ _f"> </span>in<span class="_ _f"> </span>the<span class="_ _f"> </span>code<span class="_ _f"> </span>segment?<span class="_ _f"> </span>Is<span class="_ _f"> </span>the<span class="_ _f"> </span>page<span class="_ _e"> </span>fault<span class="_ _21"> </span>the<span class="_ _f"> </span>result<span class="_ _f"> </span>of<span class="_ _f"> </span>a<span class="_ _f"> </span>process</div><div class="t m5 x29 h26 y70e2 ff7 fs19 fc1 sc0 ls0 ws0">running<span class="_ _16"> </span>in<span class="_ _16"> </span>user<span class="_ _16"> </span>mode<span class="_ _16"> </span>that<span class="_ _16"> </span>is<span class="_ _16"> </span>attempting<span class="_ _16"> </span>to<span class="_ _16"> </span>read<span class="_ _16"> </span>a<span class="_ _16"> </span>word<span class="_ _16"> </span>from<span class="_ _16"> </span>kernel<span class="_ _16"> </span>virtual</div><div class="t m5 x29 h26 y70e3 ff7 fs19 fc1 sc0 ls0 ws0">memory?<span class="_ _13"> </span>If<span class="_"> </span>the<span class="_ _13"> </span>attempted<span class="_ _13"> </span>access<span class="_"> </span>is<span class="_ _13"> </span>not<span class="_ _13"> </span>legal,<span class="_"> </span>then<span class="_ _13"> </span>the<span class="_ _13"> </span>fault<span class="_ _13"> </span>handler<span class="_"> </span>triggers<span class="_ _13"> </span>a</div><div class="t m5 x29 h26 y70e4 ff7 fs19 fc1 sc0 ls0 ws0">protection<span class="_ _11"> </span>exception,<span class="_ _16"> </span>which<span class="_ _11"> </span>terminates<span class="_ _11"> </span>the<span class="_ _11"> </span>process<span class="_ _0"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>situation<span class="_ _11"> </span>is<span class="_ _11"> </span>labeled</div><div class="t m5 x29 h26 y70e5 ff7 fs19 fc1 sc0 ls0 ws0">“2”<span class="_"> </span>in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>9.28.</div><div class="t m5 xc5 h26 y70e6 ffc fs19 fc1 sc0 ls0 ws0">3.<span class="_ _e"> </span><span class="ff7">At<span class="_ _f"> </span>this<span class="_ _f"> </span>point,<span class="_ _e"> </span>the<span class="_ _21"> </span>kernel<span class="_ _f"> </span>knows<span class="_ _21"> </span>that<span class="_ _f"> </span>the<span class="_ _f"> </span>page<span class="_ _21"> </span>fault<span class="_ _f"> </span>resulted<span class="_ _f"> </span>from<span class="_ _21"> </span>a<span class="_ _f"> </span>legal</span></div><div class="t m5 x29 h26 y70e7 ff7 fs19 fc1 sc0 ls0 ws0">operation<span class="_"> </span>on<span class="_"> </span>a<span class="_"> </span>legal<span class="_ _11"> </span>virtual<span class="_"> </span>address<span class="_ _1"></span>.<span class="_"> </span>It<span class="_ _11"> </span>handles<span class="_"> </span>the<span class="_"> </span>fault<span class="_ _11"> </span>by<span class="_"> </span>selecting<span class="_"> </span>a<span class="_ _11"> </span>victim</div><div class="t m5 x29 h26 y70e8 ff7 fs19 fc1 sc0 ls0 ws0">page<span class="_ _1"></span>,<span class="_ _15"> </span>swapping<span class="_ _16"> </span>out<span class="_ _14"> </span>the<span class="_ _16"> </span>victim<span class="_ _14"> </span>page<span class="_ _16"> </span>if<span class="_ _14"> </span>it<span class="_ _14"> </span>is<span class="_ _16"> </span>dirty<span class="_ _3"></span>,<span class="_ _14"> </span>swapping<span class="_ _14"> </span>in<span class="_ _16"> </span>the<span class="_ _14"> </span>new<span class="_ _16"> </span>page,</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
