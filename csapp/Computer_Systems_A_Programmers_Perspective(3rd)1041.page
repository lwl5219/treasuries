<div id="pf411" class="pf w2 h11" data-page-no="411"><div class="pc pc411 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg411.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1040<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Limitations<span class="_ _11"> </span>of<span class="_ _11"> </span>progress<span class="_ _11"> </span>graphs</span></div><div class="t m5 x28 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">Progress<span class="_"> </span>graphs<span class="_"> </span>give<span class="_ _13"> </span>us<span class="_"> </span>a<span class="_"> </span>nice<span class="_"> </span>way<span class="_"> </span>to<span class="_ _13"> </span>visualize<span class="_"> </span>concurrent<span class="_"> </span>program<span class="_"> </span>execution<span class="_ _13"> </span>on<span class="_"> </span>uniprocessors<span class="_"> </span>and<span class="_"> </span>to</div><div class="t m5 x28 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">understand<span class="_ _13"> </span>why<span class="_ _13"> </span>we<span class="_ _13"> </span>need<span class="_ _13"> </span>synchronization.<span class="_ _13"> </span>However,<span class="_ _13"> </span>they<span class="_ _13"> </span>do<span class="_ _13"> </span>have<span class="_ _13"> </span>limitations<span class="_ _1"></span>,<span class="_ _13"> </span>particularly<span class="_ _13"> </span>with<span class="_ _13"> </span>respect</div><div class="t m5 x28 h2b y2d2 ff7 fs1e fc2 sc0 ls0 ws0">to<span class="_ _14"> </span>concurrent<span class="_ _15"> </span>execution<span class="_ _15"> </span>on<span class="_ _14"> </span>multiprocessors<span class="_ _0"></span>,<span class="_ _15"> </span>where<span class="_ _15"> </span>a<span class="_ _15"> </span>set<span class="_ _15"> </span>of<span class="_ _14"> </span>CPU/cache<span class="_ _15"> </span>pairs<span class="_ _15"> </span>share<span class="_ _14"> </span>the<span class="_ _15"> </span>same<span class="_ _15"> </span>main</div><div class="t m5 x28 h2b y2d3 ff7 fs1e fc2 sc0 ls0 ws0">memory<span class="_ _3"></span>.<span class="_"> </span>Multiprocessors<span class="_"> </span>behave<span class="_ _13"> </span>in<span class="_"> </span>ways<span class="_"> </span>that<span class="_"> </span>cannot<span class="_ _13"> </span>be<span class="_"> </span>explained<span class="_"> </span>by<span class="_"> </span>progress<span class="_ _13"> </span>graphs<span class="_ _1"></span>.<span class="_"> </span>In<span class="_"> </span>particular,<span class="_ _13"> </span>a</div><div class="t m5 x28 h2b y2d4 ff7 fs1e fc2 sc0 ls0 ws0">multiprocessor<span class="_ _6"> </span>memory<span class="_ _13"> </span>system<span class="_ _6"> </span>can<span class="_ _13"> </span>be<span class="_ _6"> </span>in<span class="_ _13"> </span>a<span class="_ _6"> </span>state<span class="_ _13"> </span>that<span class="_ _6"> </span>does<span class="_ _13"> </span>not<span class="_ _6"> </span>correspond<span class="_ _13"> </span>to<span class="_ _6"> </span>any<span class="_ _13"> </span>trajectory<span class="_ _6"> </span>in<span class="_ _6"> </span>a<span class="_ _13"> </span>progress</div><div class="t m5 x28 h2b y2d5 ff7 fs1e fc2 sc0 ls0 ws0">graph.<span class="_ _6"> </span>Regardless<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _6"> </span>message<span class="_ _13"> </span>remains<span class="_ _a"> </span>the<span class="_ _13"> </span>same:<span class="_ _6"> </span>always<span class="_ _6"> </span>synchronize<span class="_ _13"> </span>accesses<span class="_ _a"> </span>to<span class="_ _13"> </span>your<span class="_ _6"> </span>shared<span class="_ _6"> </span>variables<span class="_ _1"></span>,</div><div class="t m5 x28 h2b y2d6 ff7 fs1e fc2 sc0 ls0 ws0">regardless<span class="_"> </span>if<span class="_"> </span>you’re<span class="_"> </span>running<span class="_"> </span>on<span class="_"> </span>a<span class="_"> </span>uniprocessor<span class="_"> </span>or<span class="_"> </span>a<span class="_"> </span>multiprocessor<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y8255 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _14"> </span>an<span class="_ _15"> </span>operational<span class="_ _14"> </span>sense,<span class="_ _14"> </span>the<span class="_ _15"> </span>forbidden<span class="_ _14"> </span>region<span class="_ _15"> </span>created<span class="_ _14"> </span>by<span class="_ _15"> </span>the<span class="_ _14"> </span><span class="ff11">P<span class="_ _1f"> </span></span>and<span class="_ _15"> </span><span class="ff11">V<span class="_ _22"> </span></span>op-</div><div class="t m5 x1d h26 y8256 ff7 fs19 fc2 sc0 ls0 ws0">erations<span class="_ _11"> </span>makes<span class="_ _16"> </span>it<span class="_ _11"> </span>impossible<span class="_ _11"> </span>for<span class="_ _11"> </span>multiple<span class="_ _16"> </span>threads<span class="_ _11"> </span>to<span class="_ _11"> </span>be<span class="_ _16"> </span>executing<span class="_ _11"> </span>instructions<span class="_ _11"> </span>in</div><div class="t m5 x1d h26 y8257 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>enclosed<span class="_ _11"> </span>critical<span class="_ _16"> </span>region<span class="_ _16"> </span>at<span class="_ _16"> </span>any<span class="_ _11"> </span>point<span class="_ _16"> </span>in<span class="_ _16"> </span>time<span class="_ _0"></span>.<span class="_ _16"> </span>In<span class="_ _11"> </span>other<span class="_ _16"> </span>words<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>semaphore</div><div class="t m5 x1d h26 y8258 ff7 fs19 fc2 sc0 ls0 ws0">operations<span class="_"> </span>ensure<span class="_"> </span>mutually<span class="_"> </span>exclusive<span class="_"> </span>access<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>critical<span class="_"> </span>region.</div><div class="t m5 x29 h26 y8259 ff7 fs19 fc2 sc0 ls0 ws0">Putting<span class="_"> </span>it<span class="_ _13"> </span>all<span class="_"> </span>together,<span class="_"> </span>to<span class="_ _13"> </span>properly<span class="_"> </span>synchronize<span class="_"> </span>the<span class="_"> </span>example<span class="_ _13"> </span>counter<span class="_"> </span>program</div><div class="t m5 x1d h26 y825a ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>12.16<span class="_"> </span>using<span class="_"> </span>semaphores<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>ﬁrst<span class="_"> </span>declare<span class="_"> </span>a<span class="_"> </span>semaphore<span class="_"> </span>called<span class="_"> </span><span class="ffd">mutex</span>:</div><div class="t m5 x10c h2d y825b ffd fs1e fc2 sc0 ls0 ws0">volatile<span class="_ _e"> </span>long<span class="_ _1f"> </span>cnt<span class="_ _1f"> </span>=<span class="_ _e"> </span>0;<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Counter<span class="_ _1f"> </span>*/</div><div class="t m5 x10c h2d y825c ffd fs1e fc2 sc0 ls0 ws0">sem_t<span class="_ _e"> </span>mutex;<span class="_ _6b"> </span>/*<span class="_ _1f"> </span>Semaphore<span class="_ _e"> </span>that<span class="_ _1f"> </span>protects<span class="_ _1f"> </span>counter<span class="_ _e"> </span>*/</div><div class="t m5 x1d h26 y825d ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>then<span class="_"> </span>we<span class="_"> </span>initialize<span class="_"> </span>it<span class="_"> </span>to<span class="_"> </span>unity<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>main<span class="_"> </span>routine:</div><div class="t m5 x10c h2d y825e ffd fs1e fc2 sc0 ls0 ws0">Sem_init(&amp;mutex,<span class="_ _e"> </span>0,<span class="_ _1f"> </span>1);<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>mute<span class="ls33">x=1*<span class="_ _c4"></span>/</span></div><div class="t m5 x1d h26 y825f ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>inally<span class="_ _3"></span>,<span class="_"> </span>we<span class="_"> </span>protect<span class="_"> </span>the<span class="_"> </span>update<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>shared<span class="_"> </span><span class="ffd">cnt<span class="_ _13"> </span></span>variable<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>thread<span class="_"> </span>routine<span class="_"> </span>by</div><div class="t m5 x1d h26 y8260 ff7 fs19 fc2 sc0 ls0 ws0">surrounding<span class="_"> </span>it<span class="_"> </span>with<span class="_"> </span><span class="ff11">P<span class="_ _21"> </span></span>and<span class="_"> </span><span class="ff11">V<span class="_ _f"> </span></span>operations:</div><div class="t m5 x10c h2d y8261 ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>niters;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</div><div class="t m5 x22b h2d y8262 ffd fs1e fc2 sc0 ls0 ws0">P(&amp;mutex);</div><div class="t m5 x22b h2d y8263 ffd fs1e fc2 sc0 ls0 ws0">cnt++;</div><div class="t m5 x22b h2d y8264 ffd fs1e fc2 sc0 ls0 ws0">V(&amp;mutex);</div><div class="t m5 x10c h2d y8265 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x29 h26 y8266 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _6"> </span>we<span class="_ _13"> </span>run<span class="_ _13"> </span>the<span class="_ _6"> </span>properly<span class="_ _13"> </span>synchronized<span class="_ _13"> </span>program,<span class="_ _13"> </span>it<span class="_ _6"> </span>now<span class="_ _13"> </span>produces<span class="_ _13"> </span>the<span class="_ _6"> </span>correct</div><div class="t m5 x1d h26 y8267 ff7 fs19 fc2 sc0 ls0 ws0">answer<span class="_"> </span>each<span class="_"> </span>time<span class="_ _1"></span>.</div><div class="t m5 x1d h2d y8268 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _1a"> </span><span class="ff13">./goodcnt<span class="_ _e"> </span>1000000</span></div><div class="t m5 x1d h2d y8269 ffd fs1e fc2 sc0 ls0 ws0">OK<span class="_ _e"> </span>cnt=2000000</div><div class="t m5 x1d h2d y826a ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _1a"> </span><span class="ff13">./goodcnt<span class="_ _e"> </span>1000000</span></div><div class="t m5 x1d h2d y826b ffd fs1e fc2 sc0 ls0 ws0">OK<span class="_ _e"> </span>cnt=2000000</div><div class="t m5 x1d h41 y826c ffe fs29 fc2 sc0 ls0 ws0">12.5.4<span class="_ _48"> </span><span class="fs19">Using<span class="_"> </span>Semaphores<span class="_"> </span>to<span class="_"> </span>Schedule<span class="_"> </span>Shared<span class="_"> </span>Resources</span></div><div class="t m5 x1d h26 yeef ff7 fs19 fc2 sc0 ls0 ws0">Another<span class="_ _11"> </span>important<span class="_ _11"> </span>use<span class="_ _11"> </span>of<span class="_ _11"> </span>semaphores<span class="_ _1"></span>,<span class="_ _11"> </span>besides<span class="_ _11"> </span>providing<span class="_ _11"> </span>mutual<span class="_ _11"> </span>exclusion,<span class="_ _11"> </span>is<span class="_ _11"> </span>to</div><div class="t m5 x1d h26 yf74 ff7 fs19 fc2 sc0 ls0 ws0">schedule<span class="_ _13"> </span>accesses<span class="_"> </span>to<span class="_ _13"> </span>shared<span class="_ _13"> </span>resources<span class="_ _1"></span>.<span class="_"> </span>In<span class="_ _13"> </span>this<span class="_ _13"> </span>scenario,<span class="_ _13"> </span>a<span class="_ _13"> </span>thread<span class="_"> </span>uses<span class="_ _13"> </span>a<span class="_ _13"> </span>semaphore</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
