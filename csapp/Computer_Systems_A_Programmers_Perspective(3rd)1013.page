<div id="pf3f5" class="pf w2 h11" data-page-no="3f5"><div class="pc pc3f5 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3f5.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1012<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 xae h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoserverp<span class="_ _1"></span>.c</div><div class="t m5 xb h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 xb h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>echo(int<span class="_ _e"> </span>connfd);</span></div><div class="t m5 xb h2e y283 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 xb h2e y5fd0 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x244 h2d y284 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>sigchld_handler(int<span class="_ _1f"> </span>sig)</div><div class="t m5 xb h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 xb h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">while<span class="_ _e"> </span>(waitpid(-1,<span class="_ _1f"> </span>0,<span class="_ _1f"> </span>WNOHANG)<span class="_ _e"> </span>&gt;<span class="_ _1f"> </span>0)</span></div><div class="t m5 xb h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _70"> </span><span class="ffd fs1e fc2">;</span></div><div class="t m5 xb h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">return;</span></div><div class="t m5 xb h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2e y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x14 h2e y7428 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x244 h2d y4a9c ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _1f"> </span>argc,<span class="_ _1f"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x14 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x14 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>listenfd,<span class="_ _1f"> </span>connfd;</span></div><div class="t m5 x14 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">socklen_t<span class="_ _e"> </span>clientlen;</span></div><div class="t m5 x14 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">struct<span class="_ _e"> </span>sockaddr_storage<span class="_ _1f"> </span>clientaddr;</span></div><div class="t m5 x14 h2e y417 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x14 h2e y7429 ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x26 h2d y4aa0 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(argc<span class="_ _1f"> </span>!=<span class="_ _1f"> </span>2)<span class="_ _e"> </span>{</div><div class="t m5 x14 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _70"> </span><span class="ffd fs1e fc2">fprintf(stderr,<span class="_ _e"> </span>&quot;usage:<span class="_ _1f"> </span>%s<span class="_ _1f"> </span>&lt;port&gt;\n&quot;,<span class="_ _e"> </span>argv[0]);</span></div><div class="t m5 x14 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _70"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x14 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x14 h2e y6998 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x26 h2d y4aa1 ffd fs1e fc2 sc0 ls0 ws0">Signal(SIGCHLD,<span class="_ _e"> </span>sigchld_handler);</div><div class="t m5 x14 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _20"> </span><span class="ffd fs1e fc2">listenfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>Open_listenfd(argv[1]);</span></div><div class="t m5 x14 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">while<span class="_ _e"> </span>(1)<span class="_ _1f"> </span>{</span></div><div class="t m5 x14 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x249 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">clientlen<span class="_ _e"> </span>=<span class="_ _1f"> </span>sizeof(struct<span class="_ _1f"> </span>sockaddr_storage);</div><div class="t m5 x14 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _70"> </span><span class="ffd fs1e fc2">connfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>Accept(listenfd,<span class="_ _1f"> </span>(SA<span class="_ _e"> </span>*)<span class="_ _1f"> </span>&amp;clientaddr,<span class="_ _e"> </span>&amp;clientlen);</span></div><div class="t m5 x14 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(Fork()<span class="_ _1f"> </span>==<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{</span></div><div class="t m5 x14 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _d1"> </span><span class="ffd fs1e fc2">Close(listenfd);<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Child<span class="_ _1f"> </span>closes<span class="_ _e"> </span>its<span class="_ _1f"> </span>listening<span class="_ _1f"> </span>socket<span class="_ _e"> </span>*/</span></div><div class="t m5 x14 h2d y441 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _d1"> </span><span class="ffd fs1e fc2">echo(connfd);<span class="_ _46"> </span>/*<span class="_ _1f"> </span>Child<span class="_ _e"> </span>services<span class="_ _1f"> </span>client<span class="_ _e"> </span>*/</span></div><div class="t m5 x14 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _d1"> </span><span class="ffd fs1e fc2">Close(connfd);<span class="_ _3f"> </span>/*<span class="_ _1f"> </span>Child<span class="_ _e"> </span>closes<span class="_ _1f"> </span>connection<span class="_ _e"> </span>with<span class="_ _1f"> </span>client<span class="_ _1f"> </span>*/</span></div><div class="t m5 x14 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _d1"> </span><span class="ffd fs1e fc2">exit(0);<span class="_ _82"> </span>/*<span class="_ _1f"> </span>Child<span class="_ _1f"> </span>exits<span class="_ _e"> </span>*/</span></div><div class="t m5 x14 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _70"> </span><span class="ffd fs1e fc2">Close(connfd);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Parent<span class="_ _1f"> </span>closes<span class="_ _e"> </span>connected<span class="_ _1f"> </span>socket<span class="_ _e"> </span>(important!)<span class="_ _1f"> </span>*/</span></div><div class="t m5 x14 h2d y5fd ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d y4aa5 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 xae h2c y7f35 ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoserverp<span class="_ _1"></span>.c</div><div class="t m5 x14 h34 y7f36 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>12.5<span class="_ _66"> </span><span class="fc1">Concurrent<span class="_ _14"> </span>echo<span class="_ _16"> </span>server<span class="_ _16"> </span>based<span class="_ _16"> </span>on<span class="_ _16"> </span>processes.<span class="_ _16"> </span><span class="ff6">The<span class="_ _16"> </span>parent<span class="_ _16"> </span>forks<span class="_ _16"> </span>a<span class="_ _16"> </span>child<span class="_ _16"> </span>to<span class="_ _16"> </span>handle<span class="_ _16"> </span>each<span class="_ _16"> </span>new</span></span></div><div class="t m5 x14 h34 y7f37 ff6 fs16 fc1 sc0 ls0 ws0">connection<span class="_ _10"> </span>request.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
