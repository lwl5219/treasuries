<div id="pf41c" class="pf w2 h11" data-page-no="41c"><div class="pc pc41c w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg41c.png"/><div class="t m5 x250 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.6<span class="_ _60"> </span>Using<span class="_ _10"> </span>Threads<span class="_ _10"> </span>for<span class="_ _10"> </span>Parallelism<span class="_ _3e"> </span><span class="ffe fs1e">1051</span></div><div class="t m5 x1fc h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/psum-mutex.c</div><div class="t m5 x2c h2e y280 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x2d h2d yad1 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#define<span class="_ _1f"> </span>MAXTHREADS<span class="_ _e"> </span>32</span></div><div class="t m5 x2c h2e yad2 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2c h2e y6777 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2d h2d yad3 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*sum_mutex(void<span class="_ _1f"> </span>*vargp);<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Thread<span class="_ _1f"> </span>routine<span class="_ _e"> </span>*/</div><div class="t m5 x2c h2e y285 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y65f1 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2d h2d yad4 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Global<span class="_ _1f"> </span>shared<span class="_ _1f"> </span>variables<span class="_ _e"> </span>*/</div><div class="t m5 x2c h2d yad5 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">long<span class="_ _1f"> </span>gsum<span class="_ _e"> </span>=<span class="_ _1f"> </span>0;<span class="_ _6b"> </span>/*<span class="_ _e"> </span>Global<span class="_ _1f"> </span>sum<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d yad6 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">long<span class="_ _1f"> </span>nelems_per_thread;<span class="_ _1a"> </span>/*<span class="_ _e"> </span>Number<span class="_ _1f"> </span>of<span class="_ _1f"> </span>elements<span class="_ _e"> </span>to<span class="_ _1f"> </span>sum<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h2d y496b ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs1e fc2">sem_t<span class="_ _1f"> </span>mutex;<span class="_ _35"> </span>/*<span class="_ _1f"> </span>Mutex<span class="_ _e"> </span>to<span class="_ _1f"> </span>protect<span class="_ _1f"> </span>global<span class="_ _e"> </span>sum<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2e y50d4 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x17 h2e y73eb ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x2d h2d y4a9c ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _1f"> </span>argc,<span class="_ _1f"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x17 h2d y61b6 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y2181 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>i,<span class="_ _1f"> </span>nelems,<span class="_ _1f"> </span>log_nelems,<span class="_ _e"> </span>nthreads,<span class="_ _1f"> </span>myid[MAXTHREADS];</span></div><div class="t m5 x17 h2d y554b ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">pthread_t<span class="_ _e"> </span>tid[MAXTHREADS];</span></div><div class="t m5 x17 h2e y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x17 h2e y6a28 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x142 h2d y417 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Get<span class="_ _1f"> </span>input<span class="_ _1f"> </span>arguments<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(argc<span class="_ _1f"> </span>!=<span class="_ _1f"> </span>3)<span class="_ _e"> </span>{</span></div><div class="t m5 x17 h2d y3ec ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _70"> </span><span class="ffd fs1e fc2">printf(&quot;Usage:<span class="_ _e"> </span>%s<span class="_ _1f"> </span>&lt;nthreads&gt;<span class="_ _1f"> </span>&lt;log_nelems&gt;\n&quot;,<span class="_ _e"> </span>argv[0]);</span></div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _70"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y1ada ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _20"> </span><span class="ffd fs1e fc2">nthreads<span class="_ _e"> </span>=<span class="_ _1f"> </span>atoi(argv[1]);</span></div><div class="t m5 x17 h2d y61b9 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _20"> </span><span class="ffd fs1e fc2">log_nelems<span class="_ _e"> </span>=<span class="_ _1f"> </span>atoi(argv[2]);</span></div><div class="t m5 x17 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _20"> </span><span class="ffd fs1e fc2">nelems<span class="_ _e"> </span>=<span class="_ _1f"> </span>(1L<span class="_ _1f"> </span>&lt;&lt;<span class="_ _e"> </span>log_nelems);</span></div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">nelems_per_thread<span class="_ _e"> </span>=<span class="_ _1f"> </span>nelems<span class="_ _1f"> </span>/<span class="_ _e"> </span>nthreads;</span></div><div class="t m5 x17 h2d y3229 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _20"> </span><span class="ffd fs1e fc2">sem_init(&amp;mutex,<span class="_ _e"> </span>0,<span class="_ _1f"> </span>1);</span></div><div class="t m5 x17 h2e y322a ff6 fs20 fc6 sc0 ls0 ws0">26</div><div class="t m5 x17 h2e y8304 ff6 fs20 fc6 sc0 ls0 ws0">27</div><div class="t m5 x142 h2d y322b ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Create<span class="_ _1f"> </span>peer<span class="_ _1f"> </span>threads<span class="_ _e"> </span>and<span class="_ _1f"> </span>wait<span class="_ _e"> </span>for<span class="_ _1f"> </span>them<span class="_ _1f"> </span>to<span class="_ _e"> </span>finish<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>nthreads;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y441 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _70"> </span><span class="ffd fs1e fc2">myid[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>i;</span></div><div class="t m5 x17 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _70"> </span><span class="ffd fs1e fc2">Pthread_create(&amp;tid[i],<span class="_ _e"> </span>NULL,<span class="_ _1f"> </span>sum_mutex,<span class="_ _1f"> </span>&amp;myid[i]);</span></div><div class="t m5 x17 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>nthreads;<span class="_ _1f"> </span>i++)</span></div><div class="t m5 x17 h2d y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _70"> </span><span class="ffd fs1e fc2">Pthread_join(tid[i],<span class="_ _e"> </span>NULL);</span></div><div class="t m5 x17 h2e y5fd ff6 fs20 fc6 sc0 ls0 ws0">34</div><div class="t m5 x17 h2e y4aa4 ff6 fs20 fc6 sc0 ls0 ws0">35</div><div class="t m5 x142 h2d y4aa5 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Check<span class="_ _1f"> </span>final<span class="_ _1f"> </span>answer<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 x142 h2d y74d ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(gsum<span class="_ _1f"> </span>!=<span class="_ _1f"> </span>(nelems<span class="_ _e"> </span>*<span class="_ _1f"> </span>(nelems-1))/2)</div><div class="t m5 x17 h2d y277 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _70"> </span><span class="ffd fs1e fc2">printf(&quot;Error:<span class="_ _e"> </span>result=%ld\n&quot;,<span class="_ _1f"> </span>gsum);</span></div><div class="t m5 x17 h2e y2269 ff6 fs20 fc6 sc0 ls0 ws0">38</div><div class="t m5 x17 h2e y8305 ff6 fs20 fc6 sc0 ls0 ws0">39</div><div class="t m5 x142 h2d y226b ffd fs1e fc2 sc0 ls0 ws0">exit(0);</div><div class="t m5 x17 h2d y226d ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1fc h2c y62c3 ffa fs16 fc2 sc0 ls0 ws0">code/conc/psum-mutex.c</div><div class="t m5 x17 h2f y62c4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _6"> </span>12.31<span class="_ _c"> </span><span class="fc1">Main<span class="_ _6"> </span>routine<span class="_ _6"> </span>for</span></div><div class="t m5 x137 h3a y62c5 ffd fs19 fc1 sc0 ls0 ws0">psum-mutex<span class="ffe fs16">.<span class="_ _6"> </span><span class="ff6">Uses<span class="_ _6"> </span>multiple<span class="_ _6"> </span>threads<span class="_ _6"> </span>to<span class="_ _13"> </span>sum<span class="_ _a"> </span>the<span class="_ _6"> </span>elements</span></span></div><div class="t m5 x17 h34 y7cba ff6 fs16 fc1 sc0 ls0 ws0">of<span class="_ _10"> </span>a<span class="_ _11"> </span>sequence<span class="_ _10"> </span>into<span class="_ _10"> </span>a<span class="_ _11"> </span>shared<span class="_ _10"> </span>global<span class="_ _11"> </span>variable<span class="_ _10"> </span>protected<span class="_ _11"> </span>by<span class="_ _10"> </span>a<span class="_ _10"> </span>mutex.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
