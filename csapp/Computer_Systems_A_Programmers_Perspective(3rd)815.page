<div id="pf32f" class="pf w2 h11" data-page-no="32f"><div class="pc pc32f w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg32f.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">814<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 x1d h26 y9c ffd fs19 fc2 sc0 ls0 ws0">deletejob<span class="_ _11"> </span><span class="ff7">in<span class="_ _11"> </span>the<span class="_ _11"> </span>handler.<span class="_ _11"> </span>If<span class="_ _11"> </span></span>addjob<span class="_ _11"> </span><span class="ff7">wins<span class="_ _11"> </span>the<span class="_ _11"> </span>race,<span class="_"> </span>then<span class="_ _16"> </span>the<span class="_"> </span>answer<span class="_ _16"> </span>is<span class="_"> </span>correct.<span class="_ _11"> </span>If</span></div><div class="t m5 x1d h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">not,<span class="_ _13"> </span>the<span class="_ _13"> </span>answer<span class="_ _13"> </span>is<span class="_ _6"> </span>incorrect.<span class="_ _13"> </span>Such<span class="_ _13"> </span>errors<span class="_ _13"> </span>are<span class="_ _13"> </span>enormously<span class="_ _6"> </span>difﬁcult<span class="_ _13"> </span>to<span class="_ _13"> </span>debug<span class="_ _13"> </span>because</div><div class="t m5 x1d h26 y40a ff7 fs19 fc2 sc0 ls0 ws0">it<span class="_ _11"> </span>is<span class="_ _11"> </span>often<span class="_ _11"> </span>impossible<span class="_ _11"> </span>to<span class="_ _11"> </span>test<span class="_ _11"> </span>every<span class="_ _11"> </span>interleaving.<span class="_"> </span>Y<span class="_ _3"></span>ou<span class="_ _11"> </span>might<span class="_ _11"> </span>run<span class="_ _11"> </span>the<span class="_ _11"> </span>code<span class="_ _11"> </span>a<span class="_ _11"> </span>billion</div><div class="t m5 x1d h26 y40b ff7 fs19 fc2 sc0 ls0 ws0">times<span class="_ _15"> </span>without<span class="_ _15"> </span>a<span class="_ _15"> </span>problem,<span class="_ _21"> </span>but<span class="_ _15"> </span>then<span class="_ _15"> </span>the<span class="_ _14"> </span>next<span class="_ _15"> </span>test<span class="_ _15"> </span>results<span class="_ _15"> </span>in<span class="_ _15"> </span>an<span class="_ _15"> </span>interleaving<span class="_ _15"> </span>that</div><div class="t m5 x1d h26 y40c ff7 fs19 fc2 sc0 ls0 ws0">triggers<span class="_"> </span>the<span class="_"> </span>race<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y40d ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>8.40<span class="_ _11"> </span>shows<span class="_ _11"> </span>one<span class="_ _16"> </span>way<span class="_ _11"> </span>to<span class="_ _11"> </span>eliminate<span class="_ _16"> </span>the<span class="_ _11"> </span>race<span class="_ _11"> </span>in<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _16"> </span>8.39.<span class="_ _11"> </span>By<span class="_ _11"> </span>blocking</div><div class="t m5 x1d h26 y40e ff7 fs19 fc2 sc0 ls0 ws0">SIGCHLD<span class="_ _13"> </span>signals<span class="_ _13"> </span>before<span class="_ _13"> </span>the<span class="_ _13"> </span>call<span class="_ _13"> </span>to<span class="_ _13"> </span><span class="ffd">fork<span class="_ _13"> </span></span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>unblocking<span class="_ _13"> </span>them<span class="_ _13"> </span>only<span class="_ _13"> </span>after<span class="_ _13"> </span>we</div><div class="t m5 x1d h26 y40f ff7 fs19 fc2 sc0 ls0 ws0">have<span class="_"> </span>called<span class="_"> </span><span class="ffd">addjob</span>,<span class="_ _13"> </span>we<span class="_"> </span>guarantee<span class="_"> </span>that<span class="_"> </span>the<span class="_ _13"> </span>child<span class="_"> </span>will<span class="_"> </span>be<span class="_"> </span>reaped<span class="_"> </span><span class="ffa">after<span class="_"> </span></span>it<span class="_"> </span>is<span class="_"> </span>added<span class="_ _13"> </span>to</div><div class="t m5 x1d h26 y410 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _6"> </span>job<span class="_ _13"> </span>list.<span class="_ _a"> </span>Notice<span class="_ _13"> </span>that<span class="_ _6"> </span>children<span class="_ _6"> </span>inherit<span class="_ _13"> </span>the<span class="_ _6"> </span><span class="ffd">blocked<span class="_ _6"> </span></span>set<span class="_ _13"> </span>of<span class="_ _6"> </span>their<span class="_ _6"> </span>parents<span class="_ _1"></span>,<span class="_ _13"> </span>so<span class="_ _6"> </span>we<span class="_ _13"> </span>must</div><div class="t m5 x1d h26 y411 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_"> </span>careful<span class="_"> </span>to<span class="_"> </span>unblock<span class="_"> </span>the<span class="_"> </span>SIGCHLD<span class="_"> </span>signal<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>child<span class="_"> </span>before<span class="_"> </span>calling<span class="_"> </span><span class="ffd">execve</span>.</div><div class="t m5 x1d h41 y6a0d ffe fs29 fc2 sc0 ls0 ws0">8.5.7<span class="_ _48"> </span><span class="fs19">Explicitly<span class="_"> </span>W<span class="_ _1"></span>aiting<span class="_"> </span>for<span class="_"> </span>Signals</span></div><div class="t m5 x1d h26 y6a0e ff7 fs19 fc2 sc0 ls0 ws0">Sometimes<span class="_"> </span>a<span class="_ _13"> </span>main<span class="_"> </span>program<span class="_ _13"> </span>needs<span class="_"> </span>to<span class="_ _13"> </span>explicitly<span class="_"> </span>wait<span class="_ _13"> </span>for<span class="_"> </span>a<span class="_"> </span>certain<span class="_ _13"> </span>signal<span class="_"> </span>handler<span class="_ _13"> </span>to</div><div class="t m5 x1d h26 y6a0f ff7 fs19 fc2 sc0 ls0 ws0">run.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _14"> </span>when<span class="_ _16"> </span>a<span class="_ _16"> </span>Linux<span class="_ _16"> </span>shell<span class="_ _16"> </span>creates<span class="_ _11"> </span>a<span class="_ _16"> </span>foreground<span class="_ _16"> </span>job,<span class="_ _16"> </span>it<span class="_ _16"> </span>must<span class="_ _16"> </span>wait<span class="_ _11"> </span>for</div><div class="t m5 x1d h26 y6a10 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>job<span class="_ _11"> </span>to<span class="_ _16"> </span>terminate<span class="_ _16"> </span>and<span class="_ _16"> </span>be<span class="_ _16"> </span>reaped<span class="_ _11"> </span>by<span class="_ _16"> </span>the<span class="_ _16"> </span>SIGCHLD<span class="_ _16"> </span>handler<span class="_ _16"> </span>before<span class="_ _11"> </span>accepting</div><div class="t m5 x1d h26 y6a11 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>next<span class="_"> </span>user<span class="_"> </span>command.</div><div class="t m5 x29 h26 y6a12 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>8.41<span class="_ _13"> </span>shows<span class="_ _13"> </span>the<span class="_ _13"> </span>basic<span class="_ _13"> </span>idea.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>parent<span class="_"> </span>installs<span class="_ _13"> </span>handlers<span class="_ _13"> </span>for<span class="_ _13"> </span>SIGINT<span class="_ _13"> </span>and</div><div class="t m5 x1d h26 y6a13 ff7 fs19 fc2 sc0 ls0 ws0">SIGCHLD<span class="_ _13"> </span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>enters<span class="_ _13"> </span>an<span class="_ _13"> </span>inﬁnite<span class="_ _13"> </span>loop.<span class="_ _13"> </span>It<span class="_ _13"> </span>blocks<span class="_ _13"> </span>SIGCHLD<span class="_ _13"> </span>to<span class="_ _13"> </span>avoid<span class="_ _13"> </span>the<span class="_ _13"> </span>race</div><div class="t m5 x1d h26 y6a14 ff7 fs19 fc2 sc0 ls0 ws0">between<span class="_ _16"> </span>parent<span class="_ _14"> </span>and<span class="_ _16"> </span>child<span class="_ _14"> </span>that<span class="_ _16"> </span>we<span class="_ _14"> </span>discussed<span class="_ _14"> </span>in<span class="_ _16"> </span>Section<span class="_ _14"> </span>8.5.6.<span class="_ _16"> </span>After<span class="_ _14"> </span>creating<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y6a15 ff7 fs19 fc2 sc0 ls0 ws0">child,<span class="_"> </span>it<span class="_"> </span>resets<span class="_"> </span><span class="ffd">pid<span class="_ _10"> </span></span>to<span class="_"> </span>zero<span class="_ _1"></span>,<span class="_"> </span>unblocks<span class="_"> </span>SIGCHLD<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>waits<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>spin<span class="_"> </span>loop<span class="_"> </span>for</div><div class="t m5 x1d h26 y6a16 ffd fs19 fc2 sc0 ls0 ws0">pid<span class="_ _6"> </span><span class="ff7">to<span class="_ _13"> </span>become<span class="_ _6"> </span>nonzero<span class="_ _1"></span>.<span class="_ _13"> </span>After<span class="_ _6"> </span>the<span class="_ _6"> </span>child<span class="_ _13"> </span>terminates<span class="_ _3"></span>,<span class="_ _13"> </span>the<span class="_ _6"> </span>handler<span class="_ _13"> </span>reaps<span class="_ _6"> </span>it<span class="_ _13"> </span>and<span class="_ _a"> </span>assigns</span></div><div class="t m5 x1d h26 y6a17 ff7 fs19 fc2 sc0 ls0 ws0">its<span class="_"> </span>nonzero<span class="_"> </span>PID<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>global<span class="_"> </span><span class="ffd">pid<span class="_ _10"> </span></span>variable<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _0"></span>his<span class="_"> </span>terminates<span class="_"> </span>the<span class="_"> </span>spin<span class="_ _13"> </span>loop,<span class="_ _13"> </span>and<span class="_"> </span>the</div><div class="t m5 x1d h26 y6a18 ff7 fs19 fc2 sc0 ls0 ws0">parent<span class="_"> </span>continues<span class="_"> </span>with<span class="_"> </span>additional<span class="_"> </span>work<span class="_"> </span>before<span class="_"> </span>starting<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>iteration.</div><div class="t m5 x29 h26 y6a19 ff7 fs19 fc2 sc0 ls0 ws0">While<span class="_ _13"> </span>this<span class="_ _13"> </span>code<span class="_ _13"> </span>is<span class="_ _13"> </span>correct,<span class="_ _13"> </span>the<span class="_ _13"> </span>spin<span class="_ _13"> </span>loop<span class="_ _13"> </span>is<span class="_ _13"> </span>wasteful<span class="_ _13"> </span>of<span class="_ _13"> </span>processor<span class="_ _13"> </span>resources<span class="_ _1"></span>.<span class="_ _13"> </span>W<span class="_ _1"></span>e</div><div class="t m5 x1d h26 y6a1a ff7 fs19 fc2 sc0 ls0 ws0">might<span class="_"> </span>be<span class="_"> </span>tempted<span class="_"> </span>to<span class="_"> </span>ﬁx<span class="_"> </span>this<span class="_"> </span>by<span class="_"> </span>inserting<span class="_"> </span>a<span class="_"> </span><span class="ffd">pause<span class="_ _10"> </span></span>in<span class="_"> </span>the<span class="_"> </span>body<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>spin<span class="_"> </span>loop:</div><div class="t m5 x10c h2d y6a1b ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(!pid)<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Race!<span class="_ _1f"> </span>*/</div><div class="t m5 x22b h2d y6a1c ffd fs1e fc2 sc0 ls0 ws0">pause();</div><div class="t m5 x29 h26 y6a1d ff7 fs19 fc2 sc0 ls0 ws0">Notice<span class="_ _16"> </span>that<span class="_ _16"> </span>we<span class="_ _11"> </span>still<span class="_ _16"> </span>need<span class="_ _16"> </span>a<span class="_ _16"> </span>loop<span class="_ _16"> </span>because<span class="_ _16"> </span><span class="ffd">pause<span class="_ _16"> </span></span>might<span class="_ _16"> </span>be<span class="_ _16"> </span>interrupted<span class="_ _11"> </span>by<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y6a1e ff7 fs19 fc2 sc0 ls0 ws0">receipt<span class="_ _14"> </span>of<span class="_ _15"> </span>one<span class="_ _14"> </span>or<span class="_ _15"> </span>more<span class="_ _14"> </span>SIGINT<span class="_ _15"> </span>signals<span class="_ _1"></span>.<span class="_ _14"> </span>However,<span class="_ _15"> </span>this<span class="_ _14"> </span>code<span class="_ _15"> </span>has<span class="_ _14"> </span>a<span class="_ _15"> </span>serious<span class="_ _14"> </span>race</div><div class="t m5 x1d h26 y6a1f ff7 fs19 fc2 sc0 ls0 ws0">condition:<span class="_"> </span>if<span class="_"> </span>the<span class="_ _13"> </span>SIGCHLD<span class="_"> </span>is<span class="_"> </span>received<span class="_"> </span>after<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">while<span class="_ _10"> </span></span>test<span class="_"> </span>but<span class="_"> </span>before<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">pause</span>,</div><div class="t m5 x1d h26 y6a20 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span><span class="ffd">pause<span class="_ _10"> </span></span>will<span class="_"> </span>sleep<span class="_"> </span>forever.</div><div class="t m5 x29 h26 y6a21 ff7 fs19 fc2 sc0 ls0 ws0">Another<span class="_"> </span>option<span class="_"> </span>is<span class="_"> </span>to<span class="_"> </span>replace<span class="_"> </span>the<span class="_"> </span><span class="ffd">pause<span class="_ _10"> </span></span>with<span class="_"> </span><span class="ffd">sleep</span>:</div><div class="t m5 x10c h2d y6a22 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(!pid)<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>Too<span class="_ _e"> </span>slow!<span class="_ _1f"> </span>*/</div><div class="t m5 x22b h2d y6a23 ffd fs1e fc2 sc0 ls0 ws0">sleep(1);</div><div class="t m5 x29 h26 y2767 ff7 fs19 fc2 sc0 ls0 ws0">While<span class="_ _11"> </span>correct,<span class="_ _16"> </span>this<span class="_ _16"> </span>code<span class="_ _11"> </span>is<span class="_ _16"> </span>too<span class="_ _16"> </span>slow<span class="_ _3"></span>.<span class="_ _16"> </span>If<span class="_ _11"> </span>the<span class="_ _16"> </span>signal<span class="_ _16"> </span>is<span class="_ _11"> </span>received<span class="_ _16"> </span>after<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ffd">while</span></div><div class="t m5 x1d h26 y302b ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _16"> </span>before<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">sleep</span>,<span class="_ _14"> </span>the<span class="_ _14"> </span>program<span class="_ _14"> </span>must<span class="_ _14"> </span>wait<span class="_ _14"> </span>a<span class="_ _16"> </span>(relatively)<span class="_ _14"> </span>long<span class="_ _14"> </span>time<span class="_ _14"> </span>before<span class="_ _16"> </span>it</div><div class="t m5 x1d h26 y302c ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_ _11"> </span>check<span class="_ _16"> </span>the<span class="_ _11"> </span>loop<span class="_ _16"> </span>termination<span class="_ _11"> </span>condition<span class="_ _11"> </span>again.<span class="_ _16"> </span>Using<span class="_ _11"> </span>a<span class="_ _16"> </span>higher<span class="_ _1"></span>-resolution<span class="_ _11"> </span>sleep</div><div class="t m5 x1d h26 y302d ff7 fs19 fc2 sc0 ls0 ws0">function<span class="_"> </span>such<span class="_ _13"> </span>as<span class="_"> </span><span class="ffd">nanosleep<span class="_ _10"> </span></span>isn’<span class="_ _0"></span>t<span class="_"> </span>acceptable<span class="_ _1"></span>,<span class="_"> </span>either<span class="_ _0"></span>,<span class="_"> </span>because<span class="_ _13"> </span>there<span class="_"> </span>is<span class="_"> </span>no<span class="_ _13"> </span>good<span class="_"> </span>rule</div><div class="t m5 x1d h26 y302e ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_"> </span>determining<span class="_ _13"> </span>the<span class="_"> </span>sleep<span class="_"> </span>interval.<span class="_"> </span>Make<span class="_ _13"> </span>it<span class="_"> </span>too<span class="_"> </span>small<span class="_ _13"> </span>and<span class="_"> </span>the<span class="_"> </span>loop<span class="_ _13"> </span>is<span class="_"> </span>too<span class="_"> </span>wasteful.</div><div class="t m5 x1d h26 y6e1 ff7 fs19 fc2 sc0 ls0 ws0">Make<span class="_"> </span>it<span class="_"> </span>too<span class="_"> </span>high<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>is<span class="_"> </span>too<span class="_"> </span>slow<span class="_ _3"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
