<div id="pf374" class="pf w2 h11" data-page-no="374"><div class="pc pc374 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg374.png"/><div class="t m5 x1c9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.9<span class="_ _60"> </span>Dynamic<span class="_ _10"> </span>Memor<span class="_"> </span>y<span class="_ _10"> </span>Allocation<span class="_ _3e"> </span><span class="ffe fs1e">883</span></div><div class="t m5 x17 h26 ye7 ffd fs19 fc2 sc0 ls0 ws0">size<span class="_ _13"> </span><span class="ff7">bytes<span class="_ _1"></span>,<span class="_"> </span><span class="ffd">malloc<span class="_ _13"> </span></span>would<span class="_"> </span>save<span class="_ _13"> </span>the<span class="_ _13"> </span>current<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ffd">p<span class="_ _10"> </span></span>on<span class="_ _13"> </span>the<span class="_ _13"> </span>stack,<span class="_"> </span>increment<span class="_ _13"> </span><span class="ffd">p<span class="_ _10"> </span></span>by</span></div><div class="t m5 x17 h26 y2a7 ffd fs19 fc2 sc0 ls0 ws0">size<span class="ff7">,<span class="_"> </span>and<span class="_"> </span>return<span class="_"> </span>the<span class="_"> </span>old<span class="_ _11"> </span>value<span class="_"> </span>of<span class="_"> </span></span>p<span class="_ _10"> </span><span class="ff7">to<span class="_ _11"> </span>the<span class="_"> </span>caller.<span class="_"> </span></span>Free<span class="_ _10"> </span><span class="ff7">would<span class="_"> </span>simply<span class="_"> </span>return<span class="_"> </span>to<span class="_"> </span>the</span></div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">caller<span class="_"> </span>without<span class="_"> </span>doing<span class="_"> </span>anything.</div><div class="t m5 x26 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _13"> </span>naive<span class="_ _13"> </span>allocator<span class="_ _6"> </span>is<span class="_ _13"> </span>an<span class="_ _6"> </span>extreme<span class="_ _13"> </span>point<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>design<span class="_ _6"> </span>space.<span class="_ _6"> </span>Since<span class="_ _13"> </span>each<span class="_ _6"> </span><span class="ffd">malloc</span></div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span><span class="ffd">free<span class="_ _11"> </span></span>execute<span class="_"> </span>only<span class="_ _11"> </span>a<span class="_ _11"> </span>handful<span class="_"> </span>of<span class="_ _11"> </span>instructions<span class="_ _1"></span>,<span class="_ _11"> </span>throughput<span class="_ _11"> </span>would<span class="_"> </span>be<span class="_ _11"> </span>extremely</div><div class="t m5 x17 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">good.<span class="_ _16"> </span>However<span class="_ _0"></span>,<span class="_ _16"> </span>since<span class="_ _16"> </span>the<span class="_ _11"> </span>allocator<span class="_ _16"> </span>never<span class="_ _16"> </span>reuses<span class="_ _11"> </span>any<span class="_ _16"> </span>blocks<span class="_ _1"></span>,<span class="_ _16"> </span>memory<span class="_ _16"> </span>utilization</div><div class="t m5 x17 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">would<span class="_ _6"> </span>be<span class="_ _6"> </span>extremely<span class="_ _6"> </span>bad.<span class="_ _6"> </span>A<span class="_ _6"> </span>practical<span class="_ _6"> </span>allocator<span class="_ _6"> </span>that<span class="_ _6"> </span>strikes<span class="_ _6"> </span>a<span class="_ _6"> </span>better<span class="_ _6"> </span>balance<span class="_ _6"> </span>between</div><div class="t m5 x17 h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">throughput<span class="_"> </span>and<span class="_"> </span>utilization<span class="_"> </span>must<span class="_"> </span>consider<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>issues:</div><div class="t m5 x72 h26 y729c ffa fs19 fc2 sc0 ls0 ws0">Free<span class="_"> </span>bloc<span class="_ _0"></span>k<span class="_"> </span>organization.<span class="_ _21"> </span><span class="ff7">How<span class="_"> </span>do<span class="_"> </span>we<span class="_"> </span>keep<span class="_"> </span>track<span class="_"> </span>of<span class="_"> </span>free<span class="_"> </span>blocks?</span></div><div class="t m5 x72 h26 y729d ffa fs19 fc2 sc0 ls0 ws0">Placement.<span class="_ _21"> </span><span class="ff7">How<span class="_ _16"> </span>do<span class="_ _14"> </span>we<span class="_ _16"> </span>choose<span class="_ _16"> </span>an<span class="_ _14"> </span>appropriate<span class="_ _16"> </span>free<span class="_ _14"> </span>block<span class="_ _16"> </span>in<span class="_ _16"> </span>which<span class="_ _14"> </span>to<span class="_ _16"> </span>place<span class="_ _16"> </span>a</span></div><div class="t m5 x30 h26 y729e ff7 fs19 fc2 sc0 ls0 ws0">newly<span class="_"> </span>allocated<span class="_"> </span>block?</div><div class="t m5 x72 h26 y729f ffa fs19 fc2 sc0 ls0 ws0">Splitting.<span class="_ _15"> </span><span class="ff7">After<span class="_ _16"> </span>we<span class="_ _16"> </span>place<span class="_ _11"> </span>a<span class="_ _16"> </span>newly<span class="_ _11"> </span>allocated<span class="_ _16"> </span>block<span class="_ _16"> </span>in<span class="_ _11"> </span>some<span class="_ _16"> </span>free<span class="_ _16"> </span>block,<span class="_ _16"> </span>what<span class="_ _11"> </span>do</span></div><div class="t m5 x30 h26 y72a0 ff7 fs19 fc2 sc0 ls0 ws0">we<span class="_"> </span>do<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span>remainder<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>free<span class="_"> </span>block?</div><div class="t m5 x72 h26 y72a1 ffa fs19 fc2 sc0 ls0 ws0">Coalescing.<span class="_ _15"> </span><span class="ff7">What<span class="_"> </span>do<span class="_"> </span>we<span class="_"> </span>do<span class="_"> </span>with<span class="_"> </span>a<span class="_"> </span>block<span class="_"> </span>that<span class="_"> </span>has<span class="_"> </span>just<span class="_"> </span>been<span class="_"> </span>freed?</span></div><div class="t m5 x26 h26 y72a2 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>rest<span class="_ _16"> </span>of<span class="_ _16"> </span>this<span class="_ _14"> </span>section<span class="_ _16"> </span>looks<span class="_ _16"> </span>at<span class="_ _14"> </span>these<span class="_ _16"> </span>issues<span class="_ _14"> </span>in<span class="_ _16"> </span>more<span class="_ _16"> </span>detail.<span class="_ _14"> </span>Since<span class="_ _16"> </span>the<span class="_ _16"> </span>basic</div><div class="t m5 x17 h26 y72a3 ff7 fs19 fc2 sc0 ls0 ws0">techniques<span class="_ _11"> </span>of<span class="_ _11"> </span>placement,<span class="_ _11"> </span>splitting,<span class="_ _11"> </span>and<span class="_ _11"> </span>coalescing<span class="_ _11"> </span>cut<span class="_ _11"> </span>across<span class="_ _11"> </span>many<span class="_ _16"> </span>different<span class="_"> </span>free</div><div class="t m5 x17 h26 y72a4 ff7 fs19 fc2 sc0 ls0 ws0">block<span class="_"> </span>organizations<span class="_ _1"></span>,<span class="_ _11"> </span>we<span class="_"> </span>will<span class="_ _11"> </span>introduce<span class="_"> </span>them<span class="_ _11"> </span>in<span class="_"> </span>the<span class="_ _11"> </span>context<span class="_ _11"> </span>of<span class="_"> </span>a<span class="_ _11"> </span>simple<span class="_"> </span>free<span class="_ _11"> </span>block</div><div class="t m5 x17 h26 y72a5 ff7 fs19 fc2 sc0 ls0 ws0">organization<span class="_"> </span>known<span class="_"> </span>as<span class="_"> </span>an<span class="_"> </span>implicit<span class="_"> </span>free<span class="_"> </span>list.</div><div class="t m5 x17 h41 y72a6 ffe fs29 fc2 sc0 ls0 ws0">9.9.6<span class="_ _48"> </span><span class="fs19">Implicit<span class="_"> </span>Free<span class="_"> </span>Lists</span></div><div class="t m5 x17 h26 y72a7 ff7 fs19 fc2 sc0 ls0 ws0">Any<span class="_ _15"> </span>practical<span class="_ _15"> </span>allocator<span class="_ _15"> </span>needs<span class="_ _15"> </span>some<span class="_ _21"> </span>data<span class="_ _15"> </span>structure<span class="_ _15"> </span>that<span class="_ _15"> </span>allows<span class="_ _15"> </span>it<span class="_ _21"> </span>to<span class="_ _15"> </span>distinguish</div><div class="t m5 x17 h26 y72a8 ff7 fs19 fc2 sc0 ls0 ws0">block<span class="_ _f"> </span>boundaries<span class="_ _f"> </span>and<span class="_ _f"> </span>to<span class="_ _f"> </span>distinguish<span class="_ _f"> </span>between<span class="_ _f"> </span>allocated<span class="_ _f"> </span>and<span class="_ _f"> </span>free<span class="_ _f"> </span>blocks<span class="_ _1"></span>.<span class="_ _f"> </span>Most</div><div class="t m5 x17 h26 y72a9 ff7 fs19 fc2 sc0 ls0 ws0">allocators<span class="_ _13"> </span>embed<span class="_"> </span>this<span class="_ _13"> </span>information<span class="_ _13"> </span>in<span class="_"> </span>the<span class="_ _13"> </span>blocks<span class="_ _13"> </span>themselves<span class="_ _1"></span>.<span class="_ _13"> </span>One<span class="_"> </span>simple<span class="_ _13"> </span>approach</div><div class="t m5 x17 h26 y72aa ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_"> </span>shown<span class="_"> </span>in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>9.35.</div><div class="t m5 x26 h26 y72ab ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_"> </span>this<span class="_"> </span>case<span class="_ _0"></span>,<span class="_"> </span>a<span class="_"> </span>block<span class="_"> </span>consists<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>one-word<span class="_"> </span><span class="ffa">header<span class="_ _2"></span></span>,<span class="_ _11"> </span>the<span class="_"> </span>payload,<span class="_"> </span>and<span class="_"> </span>possibly</div><div class="t m5 x17 h26 y72ac ff7 fs19 fc2 sc0 ls0 ws0">some<span class="_ _13"> </span>additional<span class="_ _6"> </span><span class="ffa">padding<span class="_ _2"></span></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>header<span class="_ _6"> </span>encodes<span class="_ _13"> </span>the<span class="_ _13"> </span>block<span class="_ _6"> </span>size<span class="_ _13"> </span>(including<span class="_ _6"> </span>the<span class="_ _13"> </span>header</div><div class="t m5 x17 h26 y72ad ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>any<span class="_"> </span>padding)<span class="_ _13"> </span>as<span class="_"> </span>well<span class="_"> </span>as<span class="_"> </span>whether<span class="_ _13"> </span>the<span class="_"> </span>block<span class="_"> </span>is<span class="_"> </span>allocated<span class="_ _13"> </span>or<span class="_"> </span>free<span class="_ _0"></span>.<span class="_"> </span>If<span class="_ _13"> </span>we<span class="_"> </span>impose<span class="_"> </span>a</div><div class="t m5 x17 h26 y72ae ff7 fs19 fc2 sc0 ls0 ws0">double-word<span class="_ _13"> </span>alignment<span class="_ _6"> </span>constraint,<span class="_ _13"> </span>then<span class="_ _6"> </span>the<span class="_ _13"> </span>block<span class="_ _6"> </span>size<span class="_ _13"> </span>is<span class="_ _13"> </span>always<span class="_ _6"> </span>a<span class="_ _13"> </span>multiple<span class="_ _6"> </span>of<span class="_ _13"> </span>8<span class="_ _6"> </span>and</div><div class="t m5 x17 h26 y72af ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>3<span class="_"> </span>low-order<span class="_ _13"> </span>bits<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>block<span class="_ _13"> </span>size<span class="_"> </span>are<span class="_"> </span>always<span class="_"> </span>zero<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>need<span class="_ _13"> </span>to<span class="_"> </span>store<span class="_"> </span>only</div><div class="t m5 x17 h26 y72b0 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>29<span class="_ _14"> </span>high-order<span class="_ _14"> </span>bits<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>block<span class="_ _14"> </span>size<span class="_ _1"></span>,<span class="_ _15"> </span>freeing<span class="_ _14"> </span>the<span class="_ _14"> </span>remaining<span class="_ _14"> </span>3<span class="_ _14"> </span>bits<span class="_ _14"> </span>to<span class="_ _14"> </span>encode</div><div class="t m5 x17 h26 y72b1 ff7 fs19 fc2 sc0 ls0 ws0">other<span class="_ _15"> </span>information.<span class="_ _21"> </span>In<span class="_ _15"> </span>this<span class="_ _21"> </span>case<span class="_ _0"></span>,<span class="_ _f"> </span>we<span class="_ _15"> </span>are<span class="_ _21"> </span>using<span class="_ _15"> </span>the<span class="_ _21"> </span>least<span class="_ _21"> </span>signiÔ¨Åcant<span class="_ _15"> </span>of<span class="_ _21"> </span>these<span class="_ _21"> </span>bits</div><div class="t m5 x17 h2f y72b2 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.35</div><div class="t m5 x17 h2f y72b3 ffe fs16 fc1 sc0 ls0 ws0">Format<span class="_"> </span>of<span class="_ _16"> </span>a<span class="_"> </span>simple<span class="_ _11"> </span>heap</div><div class="t m5 x17 h2f y72b4 ffe fs16 fc1 sc0 ls0 ws0">block.</div><div class="t m5 x1a3 h91 y72b5 ffc6 fs57 fc1 sc0 ls0 ws0">Header</div><div class="t m5 x170 h91 y72b6 ffc6 fs57 fc1 sc0 ls0 ws0">Block size</div><div class="t m5 x3a h91 y72b7 ffc6 fs57 fc1 sc0 ls0 ws0">Payload</div><div class="t m5 xc0 h91 y72b8 ffc6 fs57 fc1 sc0 ls0 ws0">(allocated block only)</div><div class="t m5 x42 h91 y72b9 ffc6 fs57 fc1 sc0 ls0 ws0">Padding (optional)</div><div class="t m5 x169 h91 y72b6 ffc6 fs57 fc1 sc0 ls0 ws0">0 0 a</div><div class="t m5 xd6 h91 y72ba ffc8 fs57 fc1 sc0 ls0 ws0">The bloc<span class="_ _0"></span>k size includes</div><div class="t m5 xd6 h91 y72bb ffc8 fs57 fc1 sc0 ls0 ws0">the header<span class="_ _1"></span>, payload, an</div><div class="c xb3 y1db4 w34 h10f"><div class="t m5 x18 h91 y72bc ffc8 fs57 fc1 sc0 ls0 ws0">d</div></div><div class="t m5 xd6 h91 y72bd ffc8 fs57 fc1 sc0 ls0 ws0">any padding</div><div class="t m5 xd7 h91 y72be ffc8 fs57 fc1 sc0 ls0 ws0">a = 1:<span class="_ _1"></span> Allocated</div><div class="t m5 xd7 h91 y72bf ffc8 fs57 fc1 sc0 ls0 ws0">a = 0:<span class="_ _1"></span> Free</div><div class="t m5 xb3 hfb y72c0 ffc7 fs99 fc1 sc0 ls0 ws0">malloc<span class="ffc6 fs57"> <span class="ffc8">returns a</span></span></div><div class="t m5 xb3 h91 y72c1 ffc8 fs57 fc1 sc0 ls0 ws0">pointer to the beginning</div><div class="t m5 xb3 h91 y72c2 ffc8 fs57 fc1 sc0 ls0 ws0">of the payload</div><div class="t m5 x1e2 he3 y72c3 ffc6 fs94 fc1 sc0 ls0 ws0">31<span class="_ _6a"> </span>3<span class="_ _f"> </span>2<span class="_ _21"> </span>1<span class="_ _15"> </span>0</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
