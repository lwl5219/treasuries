<div id="pf331" class="pf w2 h11" data-page-no="331"><div class="pc pc331 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg331.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">816<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 x1e1 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/ecf/waitforsignal.c</div><div class="t m5 xb h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 xb h2e y281 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 xb h2e y282 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x244 h2d y283 ffd fs1e fc2 sc0 ls0 ws0">volatile<span class="_ _e"> </span>sig_atomic_t<span class="_ _1f"> </span>pid;</div><div class="t m5 xb h2e y284 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 xb h2e y69c3 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x244 h2d y285 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>sigchld_handler(int<span class="_ _1f"> </span>s)</div><div class="t m5 xb h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 xb h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>olderrno<span class="_ _1f"> </span>=<span class="_ _1f"> </span>errno;</span></div><div class="t m5 xb h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">pid<span class="_ _e"> </span>=<span class="_ _1f"> </span>waitpid(-1,<span class="_ _1f"> </span>NULL,<span class="_ _e"> </span>0);</span></div><div class="t m5 xb h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">errno<span class="_ _e"> </span>=<span class="_ _1f"> </span>olderrno;</span></div><div class="t m5 x14 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2e y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x14 h2e y65f2 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x244 h2d y906 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>sigint_handler(int<span class="_ _1f"> </span>s)</div><div class="t m5 x14 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x14 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2e y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x14 h2e y6a28 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x244 h2d y417 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _1f"> </span>argc,<span class="_ _1f"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x14 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x14 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">sigset_t<span class="_ _e"> </span>mask,<span class="_ _1f"> </span>prev;</span></div><div class="t m5 x14 h2e y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19</div><div class="t m5 x14 h2e y6779 ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 x26 h2d y1ab8 ffd fs1e fc2 sc0 ls0 ws0">Signal(SIGCHLD,<span class="_ _e"> </span>sigchld_handler);</div><div class="t m5 x14 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x26 h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">Signal(SIGINT,<span class="_ _e"> </span>sigint_handler);</div><div class="t m5 x14 h2d y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _20"> </span><span class="ffd fs1e fc2">Sigemptyset(&amp;mask);</span></div><div class="t m5 x14 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _20"> </span><span class="ffd fs1e fc2">Sigaddset(&amp;mask,<span class="_ _e"> </span>SIGCHLD);</span></div><div class="t m5 x14 h2e y35d ff6 fs20 fc6 sc0 ls0 ws0">24</div><div class="t m5 x14 h2e y6a29 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x26 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(1)<span class="_ _1f"> </span>{</div><div class="t m5 x14 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _70"> </span><span class="ffd fs1e fc2">Sigprocmask(SIG_BLOCK,<span class="_ _e"> </span>&amp;mask,<span class="_ _1f"> </span>&amp;prev);<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Block<span class="_ _1f"> </span>SIGCHLD<span class="_ _e"> </span>*/</span></div><div class="t m5 x14 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(Fork()<span class="_ _1f"> </span>==<span class="_ _1f"> </span>0)<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Child<span class="_ _e"> </span>*/</span></div><div class="t m5 x14 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _d1"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x14 h2e y441 ff6 fs20 fc6 sc0 ls0 ws0">29</div><div class="t m5 x14 h2e y6999 ff6 fs20 fc6 sc0 ls0 ws0">30</div><div class="t m5 x249 h2d y2c5c ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Parent<span class="_ _1f"> </span>*/</div><div class="t m5 x14 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _70"> </span><span class="ffd fs1e fc2 ls33">p<span class="_ _41"></span>i<span class="_ _41"></span>d=0<span class="_ _41"></span>;</span></div><div class="t m5 x14 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _70"> </span><span class="ffd fs1e fc2">Sigprocmask(SIG_SETMASK,<span class="_ _e"> </span>&amp;prev,<span class="_ _1f"> </span>NULL);<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Unblock<span class="_ _1f"> </span>SIGCHLD<span class="_ _e"> </span>*/</span></div><div class="t m5 x14 h2e y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33</div><div class="t m5 x14 h2e y677d ff6 fs20 fc6 sc0 ls0 ws0">34</div><div class="t m5 x249 h2d y5fd ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Wait<span class="_ _1f"> </span>for<span class="_ _1f"> </span>SIGCHLD<span class="_ _e"> </span>to<span class="_ _1f"> </span>be<span class="_ _e"> </span>received<span class="_ _1f"> </span>(wasteful)<span class="_ _1f"> </span>*/</div><div class="t m5 x14 h2d y4aa5 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _70"> </span><span class="ffd fs1e fc2">while<span class="_ _e"> </span>(!pid)</span></div><div class="t m5 x14 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 x1b0 h2d y74d ffd fs1e fc2 sc0 ls0 ws0">;</div><div class="t m5 x14 h2e y277 ff6 fs20 fc6 sc0 ls0 ws0">37</div><div class="t m5 x14 h2e y699a ff6 fs20 fc6 sc0 ls0 ws0">38</div><div class="t m5 x249 h2d y2269 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Do<span class="_ _1f"> </span>some<span class="_ _1f"> </span>work<span class="_ _e"> </span>after<span class="_ _1f"> </span>receiving<span class="_ _e"> </span>SIGCHLD<span class="_ _1f"> </span>*/</div><div class="t m5 x14 h2d y226b ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _70"> </span><span class="ffd fs1e fc2">printf(&quot;.&quot;);</span></div><div class="t m5 x14 h2d y226d ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d y8d5 ff6 fs20 fc6 sc0 ls0 ws0">41<span class="_ _20"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x14 h2d y2270 ff6 fs20 fc6 sc0 ls0 ws0">42<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1e1 h2c y677e ffa fs16 fc2 sc0 ls0 ws0">code/ecf/waitforsignal.c</div><div class="t m5 x14 h34 y677f ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>8.41<span class="_ _66"> </span><span class="fc1">Waiting<span class="_"> </span>for<span class="_"> </span>a<span class="_"> </span>signal<span class="_"> </span>with<span class="_"> </span>a<span class="_"> </span>spin<span class="_"> </span>loop.<span class="_"> </span><span class="ff6">This<span class="_ _10"> </span>code<span class="_ _10"> </span>is<span class="_ _11"> </span>correct,<span class="_ _10"> </span>but<span class="_ _10"> </span>the<span class="_ _11"> </span>spin<span class="_ _10"> </span>loop<span class="_ _11"> </span>is<span class="_ _10"> </span>wasteful.</span></span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
