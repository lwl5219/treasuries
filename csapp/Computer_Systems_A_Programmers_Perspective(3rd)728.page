<div id="pf2d8" class="pf w2 h11" data-page-no="2d8"><div class="pc pc2d8 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2d8.png"/><div class="t m5 x1bd h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>7.7<span class="_ _60"> </span>Relocation<span class="_ _3e"> </span><span class="ffe fs1e">727</span></div><div class="t m5 x30 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">encoded<span class="_ _13"> </span>in<span class="_"> </span>the<span class="_ _13"> </span>instruction<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>current<span class="_ _13"> </span>run-time<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>PC,<span class="_ _13"> </span>which</div><div class="t m5 x30 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_"> </span>always<span class="_"> </span>the<span class="_"> </span>address<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>instruction<span class="_"> </span>in<span class="_"> </span>memory<span class="_ _3"></span>.</div><div class="t m5 x72 h26 y52e9 ffd fs19 fc2 sc0 ls0 ws0">R_X86_64_32<span class="ff7">.<span class="_ _e"> </span>Relocate<span class="_ _14"> </span>a<span class="_ _16"> </span>reference<span class="_ _14"> </span>that<span class="_ _16"> </span>uses<span class="_ _16"> </span>a<span class="_ _14"> </span>32-bit<span class="_ _16"> </span>absolute<span class="_ _14"> </span>address<span class="_ _1"></span>.<span class="_ _16"> </span>With</span></div><div class="t m5 x30 h26 y3a97 ff7 fs19 fc2 sc0 ls0 ws0">absolute<span class="_ _16"> </span>addressing,<span class="_ _14"> </span>the<span class="_ _16"> </span>CPU<span class="_ _16"> </span>directly<span class="_ _14"> </span>uses<span class="_ _16"> </span>the<span class="_ _14"> </span>32-bit<span class="_ _16"> </span>value<span class="_ _14"> </span>encoded<span class="_ _16"> </span>in</div><div class="t m5 x30 h26 y3a98 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>instruction<span class="_"> </span>as<span class="_"> </span>the<span class="_"> </span>effective<span class="_"> </span>address<span class="_ _1"></span>,<span class="_"> </span>without<span class="_"> </span>further<span class="_"> </span>modiﬁcations<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y604e ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hese<span class="_ _14"> </span>two<span class="_ _16"> </span>relocation<span class="_ _16"> </span>types<span class="_ _16"> </span>support<span class="_ _14"> </span>the<span class="_ _16"> </span>x86-64<span class="_ _16"> </span><span class="ffa">small<span class="_ _16"> </span>code<span class="_ _14"> </span>model<span class="_ _2"></span></span>,<span class="_ _14"> </span>which<span class="_ _16"> </span>as-</div><div class="t m5 x17 h26 y604f ff7 fs19 fc2 sc0 ls0 ws0">sumes<span class="_ _13"> </span>that<span class="_ _6"> </span>the<span class="_ _13"> </span>total<span class="_ _6"> </span>size<span class="_ _13"> </span>of<span class="_ _6"> </span>the<span class="_ _13"> </span>code<span class="_ _6"> </span>and<span class="_ _13"> </span>data<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>executable<span class="_ _6"> </span>object<span class="_ _13"> </span>ﬁle<span class="_ _6"> </span>is<span class="_ _13"> </span>smaller</div><div class="t m5 x17 h26 y6050 ff7 fs19 fc2 sc0 ls0 ws0">than<span class="_ _6"> </span>2<span class="_ _13"> </span>GB<span class="_ _3"></span>,<span class="_ _13"> </span>and<span class="_ _6"> </span>thus<span class="_ _6"> </span>can<span class="_ _13"> </span>be<span class="_ _6"> </span>accessed<span class="_ _6"> </span>at<span class="_ _13"> </span>run-time<span class="_ _6"> </span>using<span class="_ _6"> </span>32-bit<span class="_ _13"> </span>PC-relative<span class="_ _6"> </span>addresses<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y6051 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>small<span class="_ _16"> </span>code<span class="_ _16"> </span>model<span class="_ _11"> </span>is<span class="_ _16"> </span>the<span class="_ _16"> </span>default<span class="_ _16"> </span>for<span class="_ _11"> </span><span class="ff9">gcc</span>.<span class="_ _16"> </span>Programs<span class="_ _16"> </span>larger<span class="_ _16"> </span>than<span class="_ _11"> </span>2<span class="_ _16"> </span>GB<span class="_ _16"> </span>can<span class="_ _16"> </span>be</div><div class="t m5 x17 h26 y6052 ff7 fs19 fc2 sc0 ls0 ws0">compiled<span class="_ _6"> </span>using<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">-mcmodel=medium<span class="_ _6"> </span></span>(<span class="ffa">medium<span class="_ _6"> </span>code<span class="_ _13"> </span>model</span>)<span class="_ _13"> </span>and<span class="_ _a"> </span><span class="ffd">-mcmodel=large</span></div><div class="t m5 x17 h26 y6053 ff7 fs19 fc2 sc0 ls0 ws0">(<span class="ffa">large<span class="_"> </span>code<span class="_"> </span>model<span class="_ _2"></span></span>)<span class="_"> </span>ﬂags<span class="_ _1"></span>,<span class="_"> </span>but<span class="_"> </span>we<span class="_"> </span>won’t<span class="_"> </span>discuss<span class="_"> </span>those<span class="_ _1"></span>.</div><div class="t m5 x17 h41 y6054 ffe fs29 fc2 sc0 ls0 ws0">7.7.2<span class="_ _48"> </span><span class="fs19">Relocating<span class="_"> </span>Symbol<span class="_"> </span>References</span></div><div class="t m5 x17 h26 y6055 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>7.10<span class="_ _16"> </span>shows<span class="_ _16"> </span>the<span class="_ _16"> </span>pseudocode<span class="_ _16"> </span>for<span class="_ _16"> </span>the<span class="_ _16"> </span>linker’s<span class="_ _16"> </span>relocation<span class="_ _16"> </span>algorithm.<span class="_ _16"> </span>Lines<span class="_ _16"> </span>1</div><div class="t m5 x17 h26 y6056 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>2<span class="_ _13"> </span>iterate<span class="_"> </span>over<span class="_ _13"> </span>each<span class="_"> </span>section<span class="_ _13"> </span><span class="ffd">s<span class="_ _10"> </span></span>and<span class="_"> </span>each<span class="_ _13"> </span>relocation<span class="_"> </span>entry<span class="_ _13"> </span><span class="ffd">r<span class="_ _10"> </span></span>associated<span class="_ _13"> </span>with<span class="_"> </span>each</div><div class="t m5 x17 h26 y6057 ff7 fs19 fc2 sc0 ls0 ws0">section.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_"> </span>concreteness<span class="_ _1"></span>,<span class="_"> </span>assume<span class="_ _13"> </span>that<span class="_"> </span>each<span class="_"> </span>section<span class="_ _13"> </span><span class="ffd">s<span class="_ _10"> </span></span>is<span class="_"> </span>an<span class="_"> </span>array<span class="_ _13"> </span>of<span class="_"> </span>bytes<span class="_"> </span>and<span class="_ _13"> </span>that</div><div class="t m5 x17 h26 y6058 ff7 fs19 fc2 sc0 ls0 ws0">each<span class="_"> </span>relocation<span class="_ _11"> </span>entry<span class="_ _11"> </span><span class="ffd">r<span class="_ _11"> </span></span>is<span class="_"> </span>a<span class="_ _11"> </span><span class="ffd">struct<span class="_ _11"> </span></span>of<span class="_"> </span>type<span class="_ _11"> </span><span class="ffd">Elf64_Rela</span>,<span class="_ _11"> </span>as<span class="_ _11"> </span>deﬁned<span class="_"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>7.9.</div><div class="t m5 x17 h26 y6059 ff7 fs19 fc2 sc0 ls0 ws0">Also<span class="_ _1"></span>,<span class="_ _15"> </span>assume<span class="_ _14"> </span>that<span class="_ _14"> </span>when<span class="_ _14"> </span>the<span class="_ _14"> </span>algorithm<span class="_ _14"> </span>runs<span class="_ _1"></span>,<span class="_ _14"> </span>the<span class="_ _14"> </span>linker<span class="_ _14"> </span>has<span class="_ _14"> </span>already<span class="_ _14"> </span>chosen<span class="_ _14"> </span>run-</div><div class="t m5 x17 h26 y605a ff7 fs19 fc2 sc0 ls0 ws0">time<span class="_ _14"> </span>addresses<span class="_ _15"> </span>for<span class="_ _15"> </span>each<span class="_ _15"> </span>section<span class="_ _14"> </span>(denoted<span class="_ _15"> </span><span class="ffd">ADDR(s)</span>)<span class="_ _15"> </span>and<span class="_ _15"> </span>each<span class="_ _14"> </span>symbol<span class="_ _15"> </span>(denoted</div><div class="t m5 x17 h26 y605b ffd fs19 fc2 sc0 ls0 ws0">ADDR(r.symbol)<span class="ff7">).<span class="_ _11"> </span>Line<span class="_ _16"> </span>3<span class="_ _16"> </span>computes<span class="_ _11"> </span>the<span class="_ _16"> </span>address<span class="_ _11"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span></span>s<span class="_ _11"> </span><span class="ff7">array<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>4-byte<span class="_ _16"> </span>ref-</span></div><div class="t m5 x17 h26 y605c ff7 fs19 fc2 sc0 ls0 ws0">erence<span class="_ _16"> </span>that<span class="_ _16"> </span>needs<span class="_ _16"> </span>to<span class="_ _11"> </span>be<span class="_ _16"> </span>relocated.<span class="_ _16"> </span>If<span class="_ _16"> </span>this<span class="_ _16"> </span>reference<span class="_ _16"> </span>uses<span class="_ _16"> </span>PC-relative<span class="_ _16"> </span>addressing,</div><div class="t m5 x17 h26 y605d ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>relocated<span class="_"> </span>by<span class="_ _11"> </span>lines<span class="_"> </span>5–9.<span class="_"> </span>If<span class="_"> </span>the<span class="_ _11"> </span>reference<span class="_"> </span>uses<span class="_"> </span>absolute<span class="_"> </span>addressing,<span class="_"> </span>then<span class="_"> </span>it</div><div class="t m5 x17 h26 y605e ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_"> </span>relocated<span class="_"> </span>by<span class="_"> </span>lines<span class="_"> </span>11–13.</div><div class="t m5 x2c h2d y605f ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">foreach<span class="_ _1f"> </span>section<span class="_ _e"> </span>s<span class="_ _1f"> </span>{</span></div><div class="t m5 x2c h2d y360e ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _20"> </span><span class="ffd fs1e fc2">foreach<span class="_ _e"> </span>relocation<span class="_ _1f"> </span>entry<span class="_ _1f"> </span>r<span class="_ _e"> </span>{</span></div><div class="t m5 x2c h2d y6060 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _70"> </span><span class="ffd fs1e fc2">refpt<span class="ls33">r=s+</span>r.offset;<span class="_ _1a"> </span>/*<span class="_ _e"> </span>ptr<span class="_ _1f"> </span>to<span class="_ _1f"> </span>reference<span class="_ _e"> </span>to<span class="_ _1f"> </span>be<span class="_ _e"> </span>relocated<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2e y5efa ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y6061 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 xc5 h2d y6062 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Relocate<span class="_ _1f"> </span>a<span class="_ _1f"> </span>PC-relative<span class="_ _e"> </span>reference<span class="_ _1f"> </span>*/</div><div class="t m5 x2c h2d y6063 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(r.type<span class="_ _1f"> </span>==<span class="_ _1f"> </span>R_X86_64_PC32)<span class="_ _e"> </span>{</span></div><div class="t m5 x2c h2d y5efe ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _d1"> </span><span class="ffd fs1e fc2">refaddr<span class="_ _1f"> </span>=<span class="_ _e"> </span>ADDR(s)<span class="_ _1f"> </span>+<span class="_ _e"> </span>r.offset;<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>ref’s<span class="_ _e"> </span>run-time<span class="_ _1f"> </span>address<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h2d y6064 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _d1"> </span><span class="ffd fs1e fc2">*refptr<span class="_ _1f"> </span>=<span class="_ _e"> </span>(unsigned)<span class="_ _1f"> </span>(ADDR(r.symbol)<span class="_ _e"> </span>+<span class="_ _1f"> </span>r.addend<span class="_ _1f"> </span>-<span class="_ _e"> </span>refaddr);</span></div><div class="t m5 x2c h2d y5f00 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y4fc9 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x17 h2e y6065 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 xc5 h2d y4fca ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Relocate<span class="_ _1f"> </span>an<span class="_ _1f"> </span>absolute<span class="_ _e"> </span>reference<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2e y6066 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 xc5 h2d y4fcb ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(r.type<span class="_ _1f"> </span>==<span class="_ _1f"> </span>R_X86_64_32)</div><div class="t m5 x17 h2e y4fcc ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x162 h2d y4fcd ffd fs1e fc2 sc0 ls0 ws0">*refptr<span class="_ _e"> </span>=<span class="_ _1f"> </span>(unsigned)<span class="_ _1f"> </span>(ADDR(r.symbol)<span class="_ _e"> </span>+<span class="_ _1f"> </span>r.addend);</div><div class="t m5 x17 h2d y4fce ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y4fcf ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2f y126e ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>7.10<span class="_ _66"> </span><span class="fc1">Relocation<span class="_"> </span>algorithm.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
