<div id="pf3d6" class="pf w2 h11" data-page-no="3d6"><div class="pc pc3d6 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3d6.png"/><div class="t m5 x1df h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>11.4<span class="_ _60"> </span>The<span class="_ _10"> </span>Sockets<span class="_ _10"> </span>Interface<span class="_ _3e"> </span><span class="ffe fs1e">981</span></div><div class="t m5 x61 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>open_listenfd(char<span class="_ _e"> </span>*port)</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">struct<span class="_ _e"> </span>addrinfo<span class="_ _1f"> </span>hints,<span class="_ _1f"> </span>*listp,<span class="_ _e"> </span>*p;</span></div><div class="t m5 x2c h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>listenfd,<span class="_ _1f"> </span>optval=1;</span></div><div class="t m5 x2c h2e y285 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y65f1 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x142 h2d y286 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Get<span class="_ _1f"> </span>a<span class="_ _1f"> </span>list<span class="_ _e"> </span>of<span class="_ _1f"> </span>potential<span class="_ _e"> </span>server<span class="_ _1f"> </span>addresses<span class="_ _1f"> </span>*/</div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">memset(&amp;hints,<span class="_ _e"> </span>0,<span class="_ _1f"> </span>sizeof(struct<span class="_ _1f"> </span>addrinfo));</span></div><div class="t m5 x2c h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">hints.ai_socktype<span class="_ _e"> </span>=<span class="_ _1f"> </span>SOCK_STREAM;<span class="_ _35"> </span>/*<span class="_ _1f"> </span>Accept<span class="_ _1f"> </span>connections<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">hints.ai_flags<span class="_ _e"> </span>=<span class="_ _1f"> </span>AI_PASSIVE<span class="_ _1f"> </span>|<span class="_ _e"> </span>AI_ADDRCONFIG;<span class="_ _1f"> </span>/*<span class="_ _e"> </span>...<span class="_ _1f"> </span>on<span class="_ _1f"> </span>any<span class="_ _e"> </span>IP<span class="_ _1f"> </span>address<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">hints.ai_flags<span class="_ _e"> </span>|=<span class="_ _1f"> </span>AI_NUMERICSERV;<span class="_ _44"> </span>/*<span class="_ _1f"> </span>...<span class="_ _e"> </span>using<span class="_ _1f"> </span>port<span class="_ _e"> </span>number<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">Getaddrinfo(NULL,<span class="_ _e"> </span>port,<span class="_ _1f"> </span>&amp;hints,<span class="_ _1f"> </span>&amp;listp);</span></div><div class="t m5 x17 h2e y906 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x17 h2e y62c1 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x142 h2d y4a9d ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Walk<span class="_ _1f"> </span>the<span class="_ _1f"> </span>list<span class="_ _e"> </span>for<span class="_ _1f"> </span>one<span class="_ _e"> </span>that<span class="_ _1f"> </span>we<span class="_ _1f"> </span>can<span class="_ _e"> </span>bind<span class="_ _1f"> </span>to<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(p<span class="_ _1f"> </span>=<span class="_ _1f"> </span>listp;<span class="_ _e"> </span>p;<span class="_ _1f"> </span>p<span class="_ _e"> </span>=<span class="_ _1f"> </span>p-&gt;ai_next)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _70"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Create<span class="_ _1f"> </span>a<span class="_ _1f"> </span>socket<span class="_ _e"> </span>descriptor<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((listenfd<span class="_ _1f"> </span>=<span class="_ _1f"> </span>socket(p-&gt;ai_family,<span class="_ _e"> </span>p-&gt;ai_socktype,<span class="_ _1f"> </span>p-&gt;ai_protocol))<span class="_ _e"> </span>&lt;<span class="_ _1f"> </span>0)</span></div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _d1"> </span><span class="ffd fs1e fc2">continue;<span class="_ _1a"> </span>/*<span class="_ _e"> </span>Socket<span class="_ _1f"> </span>failed,<span class="_ _1f"> </span>try<span class="_ _e"> </span>the<span class="_ _1f"> </span>next<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2e yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x17 h2e y6997 ff6 fs20 fc6 sc0 ls0 ws0">19</div><div class="t m5 xc5 h2d y2a2b ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Eliminates<span class="_ _1f"> </span>&quot;Address<span class="_ _1f"> </span>already<span class="_ _e"> </span>in<span class="_ _1f"> </span>use&quot;<span class="_ _e"> </span>error<span class="_ _1f"> </span>from<span class="_ _1f"> </span>bind<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _70"> </span><span class="ffd fs1e fc2">Setsockopt(listenfd,<span class="_ _e"> </span>SOL_SOCKET,<span class="_ _1f"> </span>SO_REUSEADDR,</span></div><div class="t m5 x17 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x1a h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">(const<span class="_ _e"> </span>void<span class="_ _1f"> </span>*)&amp;optval<span class="_ _1f"> </span>,<span class="_ _e"> </span>sizeof(int));</div><div class="t m5 x17 h2e y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x17 h2e y4aa2 ff6 fs20 fc6 sc0 ls0 ws0">23</div><div class="t m5 xc5 h2d y3228 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Bind<span class="_ _1f"> </span>the<span class="_ _1f"> </span>descriptor<span class="_ _e"> </span>to<span class="_ _1f"> </span>the<span class="_ _e"> </span>address<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(bind(listenfd,<span class="_ _1f"> </span>p-&gt;ai_addr,<span class="_ _1f"> </span>p-&gt;ai_addrlen)<span class="_ _e"> </span>==<span class="_ _1f"> </span>0)</span></div><div class="t m5 x17 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x162 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">break;<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Success<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _70"> </span><span class="ffd fs1e fc2">Close(listenfd);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Bind<span class="_ _1f"> </span>failed,<span class="_ _e"> </span>try<span class="_ _1f"> </span>the<span class="_ _e"> </span>next<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y322c ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x17 h2e y61ba ff6 fs20 fc6 sc0 ls0 ws0">29</div><div class="t m5 x142 h2d y441 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Clean<span class="_ _1f"> </span>up<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _20"> </span><span class="ffd fs1e fc2">Freeaddrinfo(listp);</span></div><div class="t m5 x17 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(!p)<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>No<span class="_ _e"> </span>address<span class="_ _1f"> </span>worked<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>-1;</span></div><div class="t m5 x17 h2e y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33</div><div class="t m5 x17 h2e y677d ff6 fs20 fc6 sc0 ls0 ws0">34</div><div class="t m5 x142 h2d y5fd ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Make<span class="_ _1f"> </span>it<span class="_ _1f"> </span>a<span class="_ _e"> </span>listening<span class="_ _1f"> </span>socket<span class="_ _e"> </span>ready<span class="_ _1f"> </span>to<span class="_ _1f"> </span>accept<span class="_ _e"> </span>connection<span class="_ _1f"> </span>requests<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y4aa5 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(listen(listenfd,<span class="_ _1f"> </span>LISTENQ)<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>0)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 xc5 h2d y74d ffd fs1e fc2 sc0 ls0 ws0">Close(listenfd);</div><div class="t m5 x17 h2d y277 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>-1;</span></div><div class="t m5 x17 h2d y2269 ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y226b ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>listenfd;</span></div><div class="t m5 x17 h2d y226d ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x61 h2c y62c3 ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y62c4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _14"> </span>11.19</div><div class="t m5 x17d h3a y62c5 ffd fs19 fc1 sc0 ls0 ws0">open_listenfd<span class="ffe fs16">:<span class="_ _14"> </span>Helper<span class="_ _15"> </span>function<span class="_ _15"> </span>that<span class="_ _14"> </span>opens<span class="_ _15"> </span>and<span class="_ _15"> </span>returns<span class="_ _15"> </span>a<span class="_ _14"> </span>listening<span class="_ _15"> </span>descriptor<span class="_ _1"></span>.<span class="_ _14"> </span><span class="ff6">It<span class="_ _15"> </span>is</span></span></div><div class="t m5 x17 h34 y7cba ff6 fs16 fc1 sc0 ls0 ws0">reentrant<span class="_ _10"> </span>and<span class="_ _11"> </span>protocol-independent.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
