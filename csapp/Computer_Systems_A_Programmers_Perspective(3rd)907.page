<div id="pf38b" class="pf w2 h11" data-page-no="38b"><div class="pc pc38b w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg38b.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">906<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>balanced<span class="_ _a"> </span>tree<span class="_ _13"> </span>approach<span class="_ _6"> </span>is<span class="_ _6"> </span>correct<span class="_ _13"> </span>in<span class="_ _a"> </span>the<span class="_ _13"> </span>sense<span class="_ _6"> </span>that<span class="_ _6"> </span>it<span class="_ _13"> </span>is<span class="_ _6"> </span>guaranteed<span class="_ _6"> </span>to<span class="_ _13"> </span>mark</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">all<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>nodes<span class="_ _11"> </span>that<span class="_ _11"> </span>are<span class="_ _11"> </span>reachable<span class="_ _16"> </span>from<span class="_"> </span>the<span class="_ _11"> </span>roots<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _11"> </span>is<span class="_ _11"> </span>a<span class="_ _11"> </span>necessary<span class="_ _11"> </span>guarantee,</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_"> </span>application<span class="_ _11"> </span>users<span class="_ _11"> </span>would<span class="_ _11"> </span>certainly<span class="_ _11"> </span>not<span class="_ _11"> </span>appreciate<span class="_ _11"> </span>having<span class="_ _11"> </span>their<span class="_ _11"> </span>allocated<span class="_ _11"> </span>blocks</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">prematurely<span class="_"> </span>returned<span class="_ _13"> </span>to<span class="_"> </span>the<span class="_ _13"> </span>free<span class="_"> </span>list.<span class="_ _13"> </span>However,<span class="_ _13"> </span>it<span class="_"> </span>is<span class="_ _13"> </span>conservative<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>sense<span class="_ _13"> </span>that</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">it<span class="_"> </span>may<span class="_"> </span>incorrectly<span class="_"> </span>mark<span class="_"> </span>blocks<span class="_"> </span>that<span class="_"> </span>are<span class="_ _11"> </span>actually<span class="_"> </span>unreachable<span class="_ _0"></span>,<span class="_"> </span>and<span class="_"> </span>thus<span class="_"> </span>it<span class="_"> </span>may<span class="_"> </span>fail</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _14"> </span>free<span class="_ _14"> </span>some<span class="_ _14"> </span>garbage.<span class="_ _16"> </span>While<span class="_ _14"> </span>this<span class="_ _14"> </span>does<span class="_ _14"> </span>not<span class="_ _14"> </span>affect<span class="_ _15"> </span>the<span class="_ _14"> </span>correctness<span class="_ _14"> </span>of<span class="_ _14"> </span>application</div><div class="t m5 x1d h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">programs<span class="_ _1"></span>,<span class="_"> </span>it<span class="_"> </span>can<span class="_"> </span>result<span class="_"> </span>in<span class="_"> </span>unnecessary<span class="_"> </span>external<span class="_"> </span>fragmentation.</div><div class="t m5 x29 h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>fundamental<span class="_ _16"> </span>reason<span class="_ _16"> </span>that<span class="_ _11"> </span>Mark&amp;Sweep<span class="_ _16"> </span>collectors<span class="_ _16"> </span>for<span class="_ _16"> </span>C<span class="_ _11"> </span>programs<span class="_ _16"> </span>must</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_ _11"> </span>conservative<span class="_ _16"> </span>is<span class="_ _11"> </span>that<span class="_ _16"> </span>the<span class="_ _11"> </span>C<span class="_ _16"> </span>language<span class="_ _11"> </span>does<span class="_ _16"> </span>not<span class="_ _11"> </span>tag<span class="_ _16"> </span>memory<span class="_ _11"> </span>locations<span class="_ _16"> </span>with<span class="_ _11"> </span>type</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">information.<span class="_ _16"> </span>Thus<span class="_ _3"></span>,<span class="_ _14"> </span>scalars<span class="_ _14"> </span>like<span class="_ _14"> </span><span class="ffd">int</span><span class="ls2c9">so<span class="_ _42"></span>r<span class="ffd ls0">float<span class="ff7">s<span class="_ _14"> </span>can<span class="_ _16"> </span>masquerade<span class="_ _14"> </span>as<span class="_ _14"> </span>pointers<span class="_ _1"></span>.<span class="_ _16"> </span>F<span class="_ _0"></span>or</span></span></span></div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_ _e"> </span>suppose<span class="_ _e"> </span>that<span class="_ _21"> </span>some<span class="_ _f"> </span>reachable<span class="_ _f"> </span>allocated<span class="_ _e"> </span>block<span class="_ _21"> </span>contains<span class="_ _f"> </span>an<span class="_ _f"> </span><span class="ffd">int<span class="_ _f"> </span></span>in<span class="_ _e"> </span>its</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">payload<span class="_ _13"> </span>whose<span class="_"> </span>value<span class="_ _13"> </span>happens<span class="_"> </span>to<span class="_ _13"> </span>correspond<span class="_ _13"> </span>to<span class="_"> </span>an<span class="_ _13"> </span>address<span class="_ _13"> </span>in<span class="_"> </span>the<span class="_ _13"> </span>payload<span class="_"> </span>of<span class="_ _13"> </span>some</div><div class="t m5 x1d h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">other<span class="_"> </span>allocated<span class="_ _11"> </span>block<span class="_"> </span><span class="ff11">b<span class="_ _2"></span></span>.<span class="_"> </span>T<span class="_ _0"></span>here<span class="_"> </span>is<span class="_ _11"> </span>no<span class="_"> </span>way<span class="_ _11"> </span>for<span class="_"> </span>the<span class="_ _11"> </span>collector<span class="_"> </span>to<span class="_ _11"> </span>infer<span class="_"> </span>that<span class="_ _11"> </span>the<span class="_"> </span>data<span class="_ _11"> </span>is</div><div class="t m5 x1d h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">really<span class="_ _13"> </span>an<span class="_ _13"> </span><span class="ffd">int<span class="_ _13"> </span></span>and<span class="_ _13"> </span>not<span class="_ _13"> </span>a<span class="_ _13"> </span>pointer<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _0"></span>herefore<span class="_ _1"></span>,<span class="_"> </span>the<span class="_ _13"> </span>allocator<span class="_ _6"> </span>must<span class="_ _13"> </span>conservatively<span class="_ _13"> </span>mark</div><div class="t m5 x1d h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">block<span class="_"> </span><span class="ff11">b<span class="_ _10"> </span></span>as<span class="_"> </span>reachable,<span class="_"> </span>when<span class="_"> </span>in<span class="_"> </span>fact<span class="_"> </span>it<span class="_"> </span>might<span class="_"> </span>not<span class="_"> </span>be<span class="_ _1"></span>.</div><div class="t m5 x1d h3b y751c fff fs24 fc6 sc0 ls0 ws0">9.11<span class="_ _17"> </span><span class="ffe fs18">Common<span class="_"> </span>Memor<span class="_ _2"></span>y-Related<span class="_"> </span>Bugs<span class="_"> </span>in<span class="_"> </span>C<span class="_"> </span>Programs</span></div><div class="t m5 x1d h26 y751d ff7 fs19 fc1 sc0 ls0 ws0">Managing<span class="_ _16"> </span>and<span class="_ _14"> </span>using<span class="_ _14"> </span>virtual<span class="_ _16"> </span>memory<span class="_ _14"> </span>can<span class="_ _16"> </span>be<span class="_ _14"> </span>a<span class="_ _14"> </span>difﬁcult<span class="_ _16"> </span>and<span class="_ _14"> </span>error<span class="_ _1"></span>-prone<span class="_ _14"> </span>task<span class="_ _16"> </span>for</div><div class="t m5 x1d h26 y751e ff7 fs19 fc1 sc0 ls0 ws0">C<span class="_ _16"> </span>programmers<span class="_ _1"></span>.<span class="_ _16"> </span>Memory-related<span class="_ _16"> </span>bugs<span class="_ _16"> </span>are<span class="_ _14"> </span>among<span class="_ _16"> </span>the<span class="_ _16"> </span>most<span class="_ _16"> </span>frightening<span class="_ _16"> </span>because</div><div class="t m5 x1d h26 y751f ff7 fs19 fc1 sc0 ls0 ws0">they<span class="_ _14"> </span>often<span class="_ _14"> </span>manifest<span class="_ _14"> </span>themselves<span class="_ _14"> </span>at<span class="_ _14"> </span>a<span class="_ _14"> </span>distance<span class="_ _1"></span>,<span class="_ _15"> </span>in<span class="_ _14"> </span>both<span class="_ _14"> </span>time<span class="_ _14"> </span>and<span class="_ _14"> </span>space,<span class="_ _14"> </span>from<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y7520 ff7 fs19 fc1 sc0 ls0 ws0">source<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>bug.<span class="_ _13"> </span>Write<span class="_"> </span>the<span class="_ _13"> </span>wrong<span class="_"> </span>data<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>wrong<span class="_"> </span>location,<span class="_ _13"> </span>and<span class="_"> </span>your<span class="_"> </span>program</div><div class="t m5 x1d h26 y7521 ff7 fs19 fc1 sc0 ls0 ws0">can<span class="_ _16"> </span>run<span class="_ _16"> </span>for<span class="_ _16"> </span>hours<span class="_ _11"> </span>before<span class="_ _16"> </span>it<span class="_ _16"> </span>ﬁnally<span class="_ _16"> </span>fails<span class="_ _16"> </span>in<span class="_ _16"> </span>some<span class="_ _16"> </span>distant<span class="_ _16"> </span>part<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>program.<span class="_ _16"> </span>W<span class="_ _1"></span>e</div><div class="t m5 x1d h26 y7522 ff7 fs19 fc1 sc0 ls0 ws0">conclude<span class="_"> </span>our<span class="_ _13"> </span>discussion<span class="_"> </span>of<span class="_"> </span>virtual<span class="_"> </span>memory<span class="_ _13"> </span>with<span class="_"> </span>a<span class="_"> </span>look<span class="_ _13"> </span>at<span class="_"> </span>of<span class="_"> </span>some<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>common</div><div class="t m5 x1d h26 y7523 ff7 fs19 fc1 sc0 ls0 ws0">memory-related<span class="_"> </span>bugs<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y7524 ffe fs29 fc1 sc0 ls0 ws0">9.11.1<span class="_ _48"> </span><span class="fs19">Dereferencing<span class="_"> </span>Bad<span class="_"> </span>Pointers</span></div><div class="t m5 x1d h26 y7525 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _6"> </span>we<span class="_ _6"> </span>learned<span class="_ _6"> </span>in<span class="_ _6"> </span>Section<span class="_ _13"> </span>9.7.2,<span class="_ _6"> </span>there<span class="_ _6"> </span>are<span class="_ _6"> </span>large<span class="_ _13"> </span>holes<span class="_ _a"> </span>in<span class="_ _6"> </span>the<span class="_ _6"> </span>virtual<span class="_ _13"> </span>address<span class="_ _a"> </span>space<span class="_ _6"> </span>of<span class="_ _13"> </span>a</div><div class="t m5 x1d h26 y7526 ff7 fs19 fc1 sc0 ls0 ws0">process<span class="_ _13"> </span>that<span class="_ _13"> </span>are<span class="_ _13"> </span>not<span class="_ _13"> </span>mapped<span class="_ _13"> </span>to<span class="_ _13"> </span>any<span class="_"> </span>meaningful<span class="_ _13"> </span>data.<span class="_ _13"> </span>If<span class="_ _13"> </span>we<span class="_ _13"> </span>attempt<span class="_ _13"> </span>to<span class="_ _13"> </span>dereference</div><div class="t m5 x1d h26 y7527 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _13"> </span>pointer<span class="_ _13"> </span>into<span class="_ _13"> </span>one<span class="_ _13"> </span>of<span class="_ _13"> </span>these<span class="_ _13"> </span>holes<span class="_ _1"></span>,<span class="_"> </span>the<span class="_ _13"> </span>operating<span class="_ _13"> </span>system<span class="_ _13"> </span>will<span class="_ _13"> </span>terminate<span class="_ _13"> </span>our<span class="_ _13"> </span>program</div><div class="t m5 x1d h26 y7528 ff7 fs19 fc1 sc0 ls0 ws0">with<span class="_ _13"> </span>a<span class="_ _13"> </span>segmentation<span class="_ _13"> </span>exception.<span class="_ _13"> </span>Also<span class="_ _0"></span>,<span class="_ _13"> </span>some<span class="_ _13"> </span>areas<span class="_ _13"> </span>of<span class="_ _13"> </span>virtual<span class="_ _13"> </span>memory<span class="_ _13"> </span>are<span class="_ _13"> </span>read-only<span class="_ _3"></span>.</div><div class="t m5 x1d h26 y7529 ff7 fs19 fc1 sc0 ls0 ws0">Attempting<span class="_ _6"> </span>to<span class="_ _6"> </span>write<span class="_ _6"> </span>to<span class="_ _13"> </span>one<span class="_ _a"> </span>of<span class="_ _13"> </span>these<span class="_ _a"> </span>areas<span class="_ _6"> </span>terminates<span class="_ _13"> </span>the<span class="_ _a"> </span>program<span class="_ _13"> </span>with<span class="_ _a"> </span>a<span class="_ _6"> </span>protection</div><div class="t m5 x1d h26 y752a ff7 fs19 fc1 sc0 ls0 ws0">exception.</div><div class="t m5 x29 h26 y752b ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_"> </span>common<span class="_ _11"> </span>example<span class="_ _11"> </span>of<span class="_ _11"> </span>dereferencing<span class="_ _11"> </span>a<span class="_ _11"> </span>bad<span class="_ _11"> </span>pointer<span class="_ _11"> </span>is<span class="_ _11"> </span>the<span class="_ _11"> </span>classic<span class="_ _11"> </span><span class="ffd">scanf<span class="_ _11"> </span></span>bug.</div><div class="t m5 x1d h26 y752c ff7 fs19 fc1 sc0 ls0 ws0">Suppose<span class="_ _15"> </span>we<span class="_ _15"> </span>want<span class="_ _15"> </span>to<span class="_ _14"> </span>use<span class="_ _15"> </span><span class="ffd">scanf<span class="_ _15"> </span></span>to<span class="_ _15"> </span>read<span class="_ _15"> </span>an<span class="_ _15"> </span>integer<span class="_ _15"> </span>from<span class="_ _15"> </span><span class="ffd">stdin<span class="_ _15"> </span></span>into<span class="_ _15"> </span>a<span class="_ _15"> </span>variable<span class="_ _0"></span>.</div><div class="t m5 x1d h26 y752d ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>correct<span class="_ _11"> </span>way<span class="_"> </span>to<span class="_"> </span>do<span class="_ _11"> </span>this<span class="_"> </span>is<span class="_"> </span>to<span class="_"> </span>pass<span class="_ _11"> </span><span class="ffd">scanf<span class="_ _10"> </span></span>a<span class="_"> </span>format<span class="_ _11"> </span>string<span class="_"> </span>and<span class="_"> </span>the<span class="_ _11"> </span><span class="ffa">address<span class="_"> </span></span>of<span class="_"> </span>the</div><div class="t m5 x1b0 h26 y752e ff7 fs19 fc1 sc0 ls0 ws0">variable:</div><div class="t m5 xa4 h2d y752f ffd fs1e fc2 sc0 ls0 ws0">scanf(&quot;%d&quot;,<span class="_ _e"> </span>&amp;val)</div><div class="t m5 x1d h26 y7530 ff7 fs19 fc2 sc0 ls0 ws0">However,<span class="_"> </span>it<span class="_ _11"> </span>is<span class="_ _11"> </span>easy<span class="_ _11"> </span>for<span class="_ _11"> </span>new<span class="_ _16"> </span>C<span class="_"> </span>programmers<span class="_ _11"> </span>(and<span class="_ _11"> </span>experienced<span class="_ _11"> </span>ones<span class="_ _11"> </span>too!)<span class="_ _11"> </span>to<span class="_ _11"> </span>pass</div><div class="t m5 x1d h26 y7531 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span><span class="ffa">contents<span class="_"> </span></span>of<span class="_"> </span><span class="ffd">val<span class="_ _10"> </span></span>instead<span class="_"> </span>of<span class="_"> </span>its<span class="_"> </span>address:</div><div class="t m5 xa4 h2d y1152 ffd fs1e fc2 sc0 ls0 ws0">scanf(&quot;%d&quot;,<span class="_ _e"> </span>val)</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
