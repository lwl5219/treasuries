<div id="pf24b" class="pf w2 h11" data-page-no="24b"><div class="pc pc24b w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg24b.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">586<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">“commit”<span class="_ _13"> </span>the<span class="_"> </span>results<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>speculatively<span class="_"> </span>executed<span class="_ _13"> </span>instructions<span class="_ _13"> </span>by<span class="_"> </span>storing<span class="_ _13"> </span>them<span class="_ _13"> </span>in</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">registers<span class="_"> </span>or<span class="_ _11"> </span>memory<span class="_ _3"></span>.<span class="_"> </span>If<span class="_ _11"> </span>the<span class="_ _11"> </span>prediction<span class="_"> </span>is<span class="_ _11"> </span>incorrect,<span class="_ _11"> </span>the<span class="_ _11"> </span>processor<span class="_"> </span>must<span class="_ _11"> </span>discard<span class="_ _11"> </span>all</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _16"> </span>the<span class="_ _16"> </span>speculatively<span class="_ _16"> </span>executed<span class="_ _16"> </span>results<span class="_ _16"> </span>and<span class="_ _16"> </span>restart<span class="_ _16"> </span>the<span class="_ _16"> </span>instruction<span class="_ _16"> </span>fetch<span class="_ _16"> </span>process<span class="_ _16"> </span>at</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>correct<span class="_ _11"> </span>location.<span class="_"> </span>The<span class="_"> </span>misprediction<span class="_"> </span>penalty<span class="_ _11"> </span>is<span class="_ _11"> </span>incurred<span class="_"> </span>in<span class="_ _11"> </span>doing<span class="_"> </span>this<span class="_ _0"></span>,<span class="_"> </span>because</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>instruction<span class="_"> </span>pipeline<span class="_"> </span>must<span class="_"> </span>be<span class="_"> </span>reﬁlled<span class="_"> </span>before<span class="_"> </span>useful<span class="_"> </span>results<span class="_"> </span>are<span class="_"> </span>generated.</div><div class="t m5 x29 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _16"> </span>saw<span class="_ _16"> </span>in<span class="_ _16"> </span>Section<span class="_ _11"> </span>3.6.6<span class="_ _16"> </span>that<span class="_ _16"> </span>recent<span class="_ _16"> </span>versions<span class="_ _16"> </span>of<span class="_ _16"> </span>x86<span class="_ _11"> </span>processors<span class="_ _1"></span>,<span class="_ _14"> </span>including<span class="_ _16"> </span>all</div><div class="t m5 x1d h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">processors<span class="_"> </span>capable<span class="_"> </span>of<span class="_"> </span>executing<span class="_"> </span>x86-64<span class="_"> </span>programs<span class="_ _3"></span>,<span class="_"> </span>have<span class="_"> </span><span class="ffa">conditional<span class="_"> </span>move<span class="_"> </span></span>instruc-</div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">tions<span class="_ _1"></span>.<span class="_ _16"> </span><span class="ff9">gcc<span class="_ _16"> </span></span>can<span class="_ _11"> </span>generate<span class="_ _16"> </span>code<span class="_ _16"> </span>that<span class="_ _16"> </span>uses<span class="_ _11"> </span>these<span class="_ _16"> </span>instructions<span class="_ _16"> </span>when<span class="_ _16"> </span>compiling<span class="_ _16"> </span>condi-</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">tional<span class="_ _16"> </span>statements<span class="_ _14"> </span>and<span class="_ _16"> </span>expressions<span class="_ _1"></span>,<span class="_ _14"> </span>rather<span class="_ _14"> </span>than<span class="_ _16"> </span>the<span class="_ _14"> </span>more<span class="_ _16"> </span>traditional<span class="_ _14"> </span>realizations</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">based<span class="_"> </span>on<span class="_"> </span>conditional<span class="_"> </span>transfers<span class="_ _11"> </span>of<span class="_"> </span>control.<span class="_"> </span>The<span class="_"> </span>basic<span class="_"> </span>idea<span class="_"> </span>for<span class="_"> </span>translating<span class="_"> </span>into<span class="_"> </span>con-</div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">ditional<span class="_ _15"> </span>moves<span class="_ _21"> </span>is<span class="_ _15"> </span>to<span class="_ _21"> </span>compute<span class="_ _21"> </span>the<span class="_ _15"> </span>values<span class="_ _21"> </span>along<span class="_ _15"> </span>both<span class="_ _21"> </span>branches<span class="_ _21"> </span>of<span class="_ _15"> </span>a<span class="_ _21"> </span>conditional</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">expression<span class="_ _6"> </span>or<span class="_ _6"> </span>statement<span class="_ _6"> </span>and<span class="_ _6"> </span>then<span class="_ _6"> </span>use<span class="_ _13"> </span>conditional<span class="_ _a"> </span>moves<span class="_ _6"> </span>to<span class="_ _6"> </span>select<span class="_ _6"> </span>the<span class="_ _6"> </span>desired<span class="_ _13"> </span>value<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _16"> </span>saw<span class="_ _16"> </span>in<span class="_ _11"> </span>Section<span class="_ _16"> </span>4.5.7<span class="_ _16"> </span>that<span class="_ _16"> </span>conditional<span class="_ _16"> </span>move<span class="_ _11"> </span>instructions<span class="_ _16"> </span>can<span class="_ _16"> </span>be<span class="_ _16"> </span>implemented</div><div class="t m5 x1d h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_ _16"> </span>part<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>pipelined<span class="_ _16"> </span>processing<span class="_ _16"> </span>of<span class="_ _16"> </span>ordinary<span class="_ _16"> </span>instructions<span class="_ _3"></span>.<span class="_ _16"> </span>There<span class="_ _11"> </span>is<span class="_ _16"> </span>no<span class="_ _16"> </span>need<span class="_ _16"> </span>to</div><div class="t m5 x1d h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">guess<span class="_ _11"> </span>whether<span class="_ _16"> </span>or<span class="_ _11"> </span>not<span class="_ _16"> </span>the<span class="_ _11"> </span>condition<span class="_ _11"> </span>will<span class="_ _16"> </span>hold,<span class="_ _16"> </span>and<span class="_ _11"> </span>hence<span class="_ _11"> </span>no<span class="_ _16"> </span>penalty<span class="_ _11"> </span>for<span class="_ _16"> </span>guessing</div><div class="t m5 x1d h26 y451 ff7 fs19 fc2 sc0 ls0 ws0">incorrectly<span class="_ _3"></span>.</div><div class="t m5 x29 h26 y452 ff7 fs19 fc2 sc0 ls0 ws0">How<span class="_ _3"></span>,<span class="_"> </span>then,<span class="_"> </span>can<span class="_"> </span>a<span class="_"> </span>C<span class="_"> </span>programmer<span class="_"> </span>make<span class="_"> </span>sure<span class="_"> </span>that<span class="_"> </span>branch<span class="_"> </span>misprediction<span class="_"> </span>penal-</div><div class="t m5 x1d h26 y453 ff7 fs19 fc2 sc0 ls0 ws0">ties<span class="_ _f"> </span>do<span class="_ _e"> </span>not<span class="_ _f"> </span>hamper<span class="_ _e"> </span>a<span class="_ _f"> </span>program’s<span class="_ _f"> </span>efﬁciency?<span class="_ _f"> </span>Given<span class="_ _e"> </span>the<span class="_ _f"> </span>19-cycle<span class="_ _f"> </span>misprediction</div><div class="t m5 x1d h26 y454 ff7 fs19 fc2 sc0 ls0 ws0">penalty<span class="_ _11"> </span>we<span class="_ _11"> </span>measured<span class="_ _16"> </span>for<span class="_"> </span>the<span class="_ _16"> </span>reference<span class="_ _11"> </span>machine<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>stakes<span class="_ _11"> </span>are<span class="_ _16"> </span>very<span class="_"> </span>high.<span class="_ _16"> </span>T<span class="_ _1"></span>here</div><div class="t m5 x1d h26 y455 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_"> </span>no<span class="_"> </span>simple<span class="_"> </span>answer<span class="_"> </span>to<span class="_"> </span>this<span class="_"> </span>question,<span class="_"> </span>but<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>general<span class="_"> </span>principles<span class="_"> </span>apply<span class="_ _3"></span>.</div><div class="t m5 x1d h42 y2dce ff6 fs29 fc6 sc0 ls0 ws0">Do<span class="_ _11"> </span>Not<span class="_ _16"> </span>Be<span class="_ _16"> </span>Overly<span class="_ _11"> </span>Concerned<span class="_ _16"> </span>about<span class="_ _16"> </span>Predictable<span class="_ _11"> </span>Branches</div><div class="t m5 x1d h26 y4f20 ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _11"> </span>have<span class="_ _11"> </span>seen<span class="_"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>effect<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_"> </span>mispredicted<span class="_ _11"> </span>branch<span class="_ _11"> </span>can<span class="_ _11"> </span>be<span class="_ _11"> </span>very<span class="_"> </span>high,<span class="_ _11"> </span>but<span class="_ _11"> </span>that</div><div class="t m5 x1d h26 y4f21 ff7 fs19 fc1 sc0 ls0 ws0">does<span class="_ _11"> </span>not<span class="_ _11"> </span>mean<span class="_ _16"> </span>that<span class="_ _11"> </span>all<span class="_ _11"> </span>program<span class="_ _11"> </span>branches<span class="_ _16"> </span>will<span class="_ _11"> </span>slow<span class="_ _11"> </span>a<span class="_ _11"> </span>program<span class="_ _16"> </span>down.<span class="_ _11"> </span>In<span class="_ _11"> </span>fact,<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y4f22 ff7 fs19 fc1 sc0 ls0 ws0">branch<span class="_ _14"> </span>prediction<span class="_ _15"> </span>logic<span class="_ _14"> </span>found<span class="_ _15"> </span>in<span class="_ _14"> </span>modern<span class="_ _15"> </span>processors<span class="_ _14"> </span>is<span class="_ _15"> </span>very<span class="_ _14"> </span>good<span class="_ _15"> </span>at<span class="_ _14"> </span>discerning</div><div class="t m5 x1d h26 y4f23 ff7 fs19 fc1 sc0 ls0 ws0">regular<span class="_ _16"> </span>patterns<span class="_ _14"> </span>and<span class="_ _16"> </span>long-term<span class="_ _14"> </span>trends<span class="_ _16"> </span>for<span class="_ _14"> </span>the<span class="_ _14"> </span>different<span class="_ _16"> </span>branch<span class="_ _14"> </span>instructions<span class="_ _1"></span>.<span class="_ _16"> </span>F<span class="_ _0"></span>or</div><div class="t m5 x1d h26 y4f24 ff7 fs19 fc1 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_"> </span>the<span class="_ _11"> </span>loop-closing<span class="_"> </span>branches<span class="_"> </span>in<span class="_"> </span>our<span class="_"> </span>combining<span class="_"> </span>routines<span class="_"> </span>would<span class="_"> </span>typically<span class="_"> </span>be</div><div class="t m5 x1d h26 y4f25 ff7 fs19 fc1 sc0 ls0 ws0">predicted<span class="_"> </span>as<span class="_"> </span>being<span class="_"> </span>taken,<span class="_"> </span>and<span class="_"> </span>hence<span class="_"> </span>would<span class="_"> </span>only<span class="_"> </span>incur<span class="_"> </span>a<span class="_"> </span>misprediction<span class="_"> </span>penalty<span class="_"> </span>on</div><div class="t m5 x1d h26 y4f26 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>last<span class="_"> </span>time<span class="_"> </span>around.</div><div class="t m5 x29 h26 y4f27 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _15"> </span>another<span class="_ _15"> </span>example<span class="_ _1"></span>,<span class="_ _f"> </span>consider<span class="_ _15"> </span>the<span class="_ _15"> </span>results<span class="_ _15"> </span>we<span class="_ _15"> </span>observed<span class="_ _15"> </span>when<span class="_ _15"> </span>shifting<span class="_ _15"> </span>from</div><div class="t m5 x1d h26 y4f28 ffd fs19 fc1 sc0 ls0 ws0">combine2<span class="_ _11"> </span><span class="ff7">to<span class="_ _11"> </span></span>combine3<span class="ff7">,<span class="_ _11"> </span>when<span class="_ _16"> </span>we<span class="_"> </span>took<span class="_ _16"> </span>the<span class="_"> </span>function<span class="_ _16"> </span></span>get_vec_element<span class="_ _10"> </span><span class="ff7">out<span class="_ _16"> </span>of<span class="_"> </span>the</span></div><div class="t m5 x1d h26 y4f29 ff7 fs19 fc1 sc0 ls0 ws0">inner<span class="_"> </span>loop<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>function,<span class="_"> </span>as<span class="_"> </span>is<span class="_"> </span>reproduced<span class="_"> </span>below:</div><div class="t m5 x1a3 h31 y47fb ff7 fs21 fc2 sc0 ls0 ws0">Integer<span class="_ _ba"> </span>Floating<span class="_"> </span>point</div><div class="t m5 x1d h31 y4f2a ff7 fs21 fc2 sc0 ls0 ws0">Function<span class="_ _76"> </span>Page<span class="_ _26"> </span>Method<span class="_ _1db"> </span><span class="ffd fs1e ls20c">+*+*</span></div><div class="t m5 x1d h31 y4f2b ffd fs1e fc2 sc0 ls0 ws0">combine2<span class="_ _73"> </span><span class="ff7 fs21">545<span class="_ _61"> </span>Move<span class="_"> </span></span>vec_length<span class="_ _74"> </span><span class="ff7 fs21">7.02<span class="_ _14a"> </span>9.03<span class="_ _14a"> </span>9.02<span class="_ _7b"> </span>11.03</span></div><div class="t m5 x1d h31 y4f2c ffd fs1e fc2 sc0 ls0 ws0">combine3<span class="_ _73"> </span><span class="ff7 fs21">549<span class="_ _61"> </span>Direct<span class="_"> </span>data<span class="_"> </span>access<span class="_ _78"> </span>7.17<span class="_ _14a"> </span>9.02<span class="_ _4f"> </span>9.02<span class="_ _7b"> </span>11.03</span></div><div class="t m5 x1d h26 y2767 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>CPE<span class="_ _13"> </span>did<span class="_"> </span>not<span class="_ _13"> </span>improve<span class="_ _0"></span>,<span class="_"> </span>even<span class="_ _13"> </span>though<span class="_ _13"> </span>the<span class="_"> </span>transformation<span class="_ _13"> </span>eliminated<span class="_"> </span>two<span class="_ _13"> </span>condi-</div><div class="t m5 x1d h26 y302b ff7 fs19 fc2 sc0 ls0 ws0">tionals<span class="_ _13"> </span>on<span class="_ _13"> </span>each<span class="_ _13"> </span>iteration<span class="_ _13"> </span>that<span class="_ _6"> </span>check<span class="_ _13"> </span>whether<span class="_ _13"> </span>the<span class="_ _13"> </span>vector<span class="_ _13"> </span>index<span class="_ _13"> </span>is<span class="_ _13"> </span>within<span class="_ _13"> </span>bounds<span class="_ _3"></span>.<span class="_ _13"> </span>F<span class="_ _1"></span>or</div><div class="t m5 x1d h26 y302c ff7 fs19 fc2 sc0 ls0 ws0">this<span class="_"> </span>function,<span class="_"> </span>the<span class="_"> </span>checks<span class="_"> </span>always<span class="_"> </span>succeed,<span class="_"> </span>and<span class="_"> </span>hence<span class="_"> </span>they<span class="_"> </span>are<span class="_"> </span>highly<span class="_"> </span>predictable<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y302d ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _11"> </span>a<span class="_ _16"> </span>way<span class="_ _16"> </span>to<span class="_ _11"> </span>measure<span class="_ _16"> </span>the<span class="_ _16"> </span>performance<span class="_ _11"> </span>impact<span class="_ _16"> </span>of<span class="_ _11"> </span>bounds<span class="_ _16"> </span>checking,<span class="_ _11"> </span>consider</div><div class="t m5 x1d h26 y302e ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _6"> </span>following<span class="_ _13"> </span>combining<span class="_ _6"> </span>code<span class="_ _0"></span>,<span class="_ _13"> </span>where<span class="_ _6"> </span>we<span class="_ _6"> </span>have<span class="_ _13"> </span>modiﬁed<span class="_ _6"> </span>the<span class="_ _6"> </span>inner<span class="_ _13"> </span>loop<span class="_ _6"> </span>of<span class="_ _13"> </span><span class="ffd">combine4</span></div><div class="t m5 x1d h26 y6e1 ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_ _21"> </span>replacing<span class="_ _f"> </span>the<span class="_ _f"> </span>access<span class="_ _f"> </span>to<span class="_ _f"> </span>the<span class="_ _21"> </span>data<span class="_ _f"> </span>element<span class="_ _f"> </span>with<span class="_ _f"> </span>the<span class="_ _f"> </span>result<span class="_ _21"> </span>of<span class="_ _f"> </span>performing<span class="_ _f"> </span>an</div><div class="t m5 x1d h26 y6e2 ff7 fs19 fc2 sc0 ls0 ws0">inline<span class="_ _13"> </span>substitution<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>code<span class="_ _13"> </span>for<span class="_ _13"> </span><span class="ffd">get_vec_element</span>.<span class="_ _13"> </span>W<span class="_ _1"></span>e<span class="_ _13"> </span>will<span class="_ _13"> </span>call<span class="_"> </span>this<span class="_ _13"> </span>new<span class="_ _13"> </span>version</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
