<div id="pf399" class="pf w2 h11" data-page-no="399"><div class="pc pc399 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg399.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">920<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x1d h28 ye7 ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>9.8<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>897)</span></div><div class="t m5 x1d h26 y1d16 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>here<span class="_ _14"> </span>is<span class="_ _15"> </span>nothing<span class="_ _14"> </span>very<span class="_ _14"> </span>tricky<span class="_ _14"> </span>here.<span class="_ _16"> </span>But<span class="_ _15"> </span>the<span class="_ _14"> </span>solution<span class="_ _14"> </span>requires<span class="_ _14"> </span>you<span class="_ _15"> </span>to<span class="_ _14"> </span>understand</div><div class="t m5 x1d h26 y1d17 ff7 fs19 fc1 sc0 ls0 ws0">how<span class="_ _14"> </span>the<span class="_ _14"> </span>rest<span class="_ _14"> </span>of<span class="_ _14"> </span>our<span class="_ _14"> </span>simple<span class="_ _14"> </span>implicit-list<span class="_ _14"> </span>allocator<span class="_ _14"> </span>works<span class="_ _15"> </span>and<span class="_ _14"> </span>how<span class="_ _14"> </span>to<span class="_ _14"> </span>manipulate</div><div class="t m5 x1d h26 y1d18 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>traverse<span class="_"> </span>blocks<span class="_ _1"></span>.</div><div class="t m5 x83 h2c y76bc ffa fs16 fc1 sc0 ls0 ws0">code/vm/malloc/mm.c</div><div class="t m5 x35 h2d y76bd ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">static<span class="_ _1f"> </span>void<span class="_ _e"> </span>*find_fit(size_t<span class="_ _1f"> </span>asize)</span></div><div class="t m5 x35 h2d y76be ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x35 h2e y76bf ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x126 h2d y76c0 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>First-fit<span class="_ _1f"> </span>search<span class="_ _1f"> </span>*/</div><div class="t m5 x35 h2d y76c1 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">void<span class="_ _e"> </span>*bp;</span></div><div class="t m5 x35 h2e y76c2 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x35 h2e y76c3 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x126 h2d y76c4 ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(bp<span class="_ _1f"> </span>=<span class="_ _1f"> </span>heap_listp;<span class="_ _e"> </span>GET_SIZE(HDRP(bp))<span class="_ _1f"> </span>&gt;<span class="_ _e"> </span>0;<span class="_ _1f"> </span>bp<span class="_ _1f"> </span>=<span class="_ _e"> </span>NEXT_BLKP(bp))<span class="_ _1f"> </span>{</div><div class="t m5 x35 h2e y76c5 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x207 h2d y76c6 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(!GET_ALLOC(HDRP(bp))<span class="_ _1f"> </span>&amp;&amp;<span class="_ _1f"> </span>(asize<span class="_ _e"> </span>&lt;=<span class="_ _1f"> </span>GET_SIZE(HDRP(bp))))<span class="_ _e"> </span>{</div><div class="t m5 x35 h2d y76c7 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _d1"> </span><span class="ffd fs1e fc2">return<span class="_ _1f"> </span>bp;</span></div><div class="t m5 x35 h2d y76c8 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x73 h2d y76c9 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x73 h2e y76ca ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x126 h2d y76cb ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>NULL;<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>No<span class="_ _e"> </span>fit<span class="_ _1f"> </span>*/</div><div class="t m5 x73 h2d y76cc ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">#endif</span></div><div class="t m5 x73 h2d y76cd ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x83 h2c y76ce ffa fs16 fc2 sc0 ls0 ws0">code/vm/malloc/mm.c</div><div class="t m5 x1d h28 y76cf ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>9.9<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>897)</span></div><div class="t m5 x1d h26 y76d0 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _15"> </span>is<span class="_ _15"> </span>another<span class="_ _14"> </span>warm-up<span class="_ _15"> </span>exercise<span class="_ _15"> </span>to<span class="_ _15"> </span>help<span class="_ _14"> </span>you<span class="_ _15"> </span>become<span class="_ _15"> </span>familiar<span class="_ _14"> </span>with<span class="_ _15"> </span>allocators<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y76d1 ff7 fs19 fc1 sc0 ls0 ws0">Notice<span class="_"> </span>that<span class="_ _13"> </span>for<span class="_"> </span>this<span class="_ _13"> </span>allocator<span class="_"> </span>the<span class="_ _13"> </span>minimum<span class="_"> </span>block<span class="_"> </span>size<span class="_ _13"> </span>is<span class="_"> </span>16<span class="_ _13"> </span>bytes<span class="_ _1"></span>.<span class="_"> </span>If<span class="_"> </span>the<span class="_ _13"> </span>remainder</div><div class="t m5 x1d h26 y76d2 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_"> </span>block<span class="_ _11"> </span>after<span class="_"> </span>splitting<span class="_"> </span>would<span class="_ _11"> </span>be<span class="_"> </span>greater<span class="_"> </span>than<span class="_ _11"> </span>or<span class="_"> </span>equal<span class="_"> </span>to<span class="_ _11"> </span>the<span class="_"> </span>minimum<span class="_"> </span>block</div><div class="t m5 x1d h26 y76d3 ff7 fs19 fc1 sc0 ls0 ws0">size<span class="_ _1"></span>,<span class="_ _11"> </span>then<span class="_ _11"> </span>we<span class="_ _11"> </span>go<span class="_ _11"> </span>ahead<span class="_ _11"> </span>and<span class="_ _11"> </span>split<span class="_"> </span>the<span class="_ _11"> </span>block<span class="_ _11"> </span>(lines<span class="_ _11"> </span>6â€“10).<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>only<span class="_ _11"> </span>tricky<span class="_ _11"> </span>part<span class="_ _11"> </span>here</div><div class="t m5 x1d h26 y76d4 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_"> </span>to<span class="_"> </span>realize<span class="_"> </span>that<span class="_"> </span>you<span class="_"> </span>need<span class="_"> </span>to<span class="_"> </span>place<span class="_"> </span>the<span class="_"> </span>new<span class="_"> </span>allocated<span class="_"> </span>block<span class="_"> </span>(lines<span class="_"> </span>6<span class="_"> </span>and<span class="_"> </span>7)<span class="_"> </span>before</div><div class="t m5 x1d h26 y76d5 ff7 fs19 fc1 sc0 ls0 ws0">moving<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>block<span class="_"> </span>(line<span class="_"> </span>8).</div><div class="t m5 x83 h2c y69dc ffa fs16 fc1 sc0 ls0 ws0">code/vm/malloc/mm.c</div><div class="t m5 x1f h2d y256f ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">static<span class="_ _1f"> </span>void<span class="_ _e"> </span>place(void<span class="_ _1f"> </span>*bp,<span class="_ _1f"> </span>size_t<span class="_ _e"> </span>asize)</span></div><div class="t m5 x1f h2d y2570 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2e y2571 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x33 h2d y2572 ffd fs1e fc2 sc0 ls0 ws0">size_t<span class="_ _e"> </span>csize<span class="_ _1f"> </span>=<span class="_ _1f"> </span>GET_SIZE(HDRP(bp));</div><div class="t m5 x1f h2e y2573 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x1f h2e y76d6 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x33 h2d y76d7 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>((csize<span class="_ _1f"> </span>-<span class="_ _1f"> </span>asize)<span class="_ _e"> </span>&gt;=<span class="_ _1f"> </span>(2*DSIZE))<span class="_ _e"> </span>{</div><div class="t m5 x1f h2d y76d8 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _70"> </span><span class="ffd fs1e fc2">PUT(HDRP(bp),<span class="_ _e"> </span>PACK(asize,<span class="_ _1f"> </span>1));</span></div><div class="t m5 x1f h2e y76d9 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 xf7 h2d y76da ffd fs1e fc2 sc0 ls0 ws0">PUT(FTRP(bp),<span class="_ _e"> </span>PACK(asize,<span class="_ _1f"> </span>1));</div><div class="t m5 x1f h2d y76db ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">bp<span class="_ _e"> </span>=<span class="_ _1f"> </span>NEXT_BLKP(bp);</span></div><div class="t m5 x1f h2d y76dc ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2">PUT(HDRP(bp),<span class="_ _e"> </span>PACK(csize-asize,<span class="_ _1f"> </span>0));</span></div><div class="t m5 x1b0 h2d y3397 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">PUT(FTRP(bp),<span class="_ _e"> </span>PACK(csize-asize,<span class="_ _1f"> </span>0));</span></div><div class="t m5 x1b0 h2e y22f ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x33 h2d y76dd ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1b0 h2e y76de ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x33 h2d y4912 ffd fs1e fc2 sc0 ls0 ws0">else<span class="_ _e"> </span>{</div><div class="t m5 x1b0 h2d y230 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _70"> </span><span class="ffd fs1e fc2">PUT(HDRP(bp),<span class="_ _e"> </span>PACK(csize,<span class="_ _1f"> </span>1));</span></div><div class="t m5 x1b0 h2d y76df ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">PUT(FTRP(bp),<span class="_ _e"> </span>PACK(csize,<span class="_ _1f"> </span>1));</span></div><div class="t m5 x1b0 h2d y76e0 ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d y55d3 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x83 h2c y76e1 ffa fs16 fc2 sc0 ls0 ws0">code/vm/malloc/mm.c</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
