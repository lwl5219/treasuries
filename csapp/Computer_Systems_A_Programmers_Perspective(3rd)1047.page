<div id="pf417" class="pf w2 h11" data-page-no="417"><div class="pc pc417 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg417.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1046<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Other<span class="_ _11"> </span>synchronization<span class="_ _11"> </span>mechanisms</span></div><div class="t m5 x28 h2b y258 ff7 fs1e fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _6"> </span>have<span class="_ _13"> </span>shown<span class="_ _a"> </span>you<span class="_ _6"> </span>how<span class="_ _6"> </span>to<span class="_ _13"> </span>synchronize<span class="_ _a"> </span>threads<span class="_ _6"> </span>using<span class="_ _6"> </span>semaphores<span class="_ _1"></span>,<span class="_ _13"> </span>mainly<span class="_ _6"> </span>because<span class="_ _6"> </span>they<span class="_ _6"> </span>are<span class="_ _6"> </span>simple,<span class="_ _6"> </span>clas-</div><div class="t m5 x28 h2b y259 ff7 fs1e fc2 sc0 ls0 ws0">sical,<span class="_ _16"> </span>and<span class="_ _11"> </span>have<span class="_ _11"> </span>a<span class="_ _16"> </span>clean<span class="_ _11"> </span>semantic<span class="_ _11"> </span>model.<span class="_ _16"> </span>But<span class="_ _11"> </span>you<span class="_ _11"> </span>should<span class="_ _16"> </span>know<span class="_ _11"> </span>that<span class="_ _11"> </span>other<span class="_ _16"> </span>synchronization<span class="_ _11"> </span>techniques</div><div class="t m5 x28 h2b y25a ff7 fs1e fc2 sc0 ls0 ws0">exist<span class="_"> </span>as<span class="_ _13"> </span>well.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_"> </span>example<span class="_ _1"></span>,<span class="_"> </span>J<span class="_ _3"></span>ava<span class="_"> </span>threads<span class="_"> </span>are<span class="_ _13"> </span>synchronized<span class="_ _13"> </span>with<span class="_"> </span>a<span class="_ _13"> </span>mechanism<span class="_"> </span>called<span class="_ _13"> </span>a<span class="_"> </span><span class="ffa">J<span class="_ _3"></span>ava<span class="_"> </span>monitor<span class="_"> </span><span class="ff7">[48],</span></span></div><div class="t m5 x28 h2b y4e2 ff7 fs1e fc2 sc0 ls0 ws0">which<span class="_"> </span>provides<span class="_"> </span>a<span class="_ _13"> </span>higher<span class="_ _1"></span>-level<span class="_"> </span>abstraction<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>mutual<span class="_"> </span>exclusion<span class="_"> </span>and<span class="_"> </span>scheduling<span class="_ _13"> </span>capabilities<span class="_"> </span>of<span class="_"> </span>sema-</div><div class="t m5 x28 h2b y4e3 ff7 fs1e fc2 sc0 ls0 ws0">phores;<span class="_ _15"> </span>in<span class="_ _14"> </span>fact,<span class="_ _15"> </span>monitors<span class="_ _14"> </span>can<span class="_ _16"> </span>be<span class="_ _14"> </span>implemented<span class="_ _14"> </span>with<span class="_ _14"> </span>semaphores<span class="_ _1"></span>.<span class="_ _14"> </span>As<span class="_ _14"> </span>another<span class="_ _14"> </span>example<span class="_ _1"></span>,<span class="_ _15"> </span>the<span class="_ _14"> </span>Pthreads</div><div class="t m5 x28 h2b y4e4 ff7 fs1e fc2 sc0 ls0 ws0">interface<span class="_ _11"> </span>deﬁnes<span class="_ _11"> </span>a<span class="_ _11"> </span>set<span class="_ _10"> </span>of<span class="_ _11"> </span>synchronization<span class="_ _11"> </span>operations<span class="_ _11"> </span>on<span class="_ _11"> </span><span class="ffa">mutex<span class="_ _11"> </span></span>and<span class="_ _11"> </span><span class="ffa">condition<span class="_ _11"> </span></span>variables<span class="_ _1"></span>.<span class="_ _11"> </span>Pthreads<span class="_ _11"> </span>mu-</div><div class="t m5 x28 h2b y945 ff7 fs1e fc2 sc0 ls0 ws0">texes<span class="_ _16"> </span>are<span class="_ _16"> </span>used<span class="_ _16"> </span>for<span class="_ _16"> </span>mutual<span class="_ _16"> </span>exclusion.<span class="_ _16"> </span>Condition<span class="_ _16"> </span>variables<span class="_ _16"> </span>are<span class="_ _16"> </span>used<span class="_ _16"> </span>for<span class="_ _16"> </span>scheduling<span class="_ _16"> </span>accesses<span class="_ _16"> </span>to<span class="_ _16"> </span>shared</div><div class="t m5 x28 h2b y946 ff7 fs1e fc2 sc0 ls0 ws0">resources<span class="_ _1"></span>,<span class="_"> </span>such<span class="_"> </span>as<span class="_"> </span>the<span class="_"> </span>bounded<span class="_"> </span>buffer<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>producer<span class="_ _1"></span>-consumer<span class="_"> </span>program.</div><div class="t m5 xa4 h3f y82d1 ffed fs27 fc1 sc0 ls0 ws0">Client</div><div class="t m5 xa4 h3f y82d2 ffed fs27 fc1 sc0 ls0 ws0">Client</div><div class="t m5 x1ed h3f y82d3 ffed fs27 fc1 sc0 ls0 ws0">Master</div><div class="t m5 x16d h3f y82d4 ffed fs27 fc1 sc0 ls0 ws0">thread</div><div class="t m5 x217 h3f y82d5 ffed fs27 fc1 sc0 ls0 ws0">Worker</div><div class="t m5 x20f h3f y82d6 ffed fs27 fc1 sc0 ls0 ws0">thread</div><div class="t m5 x5f h3f y82d7 ffed fs27 fc1 sc0 ls0 ws0">Pool of worker threads</div><div class="t m5 x217 h3f y82d8 ffed fs27 fc1 sc0 ls0 ws0">Worker</div><div class="t m5 x20f h3f y82d9 ffed fs27 fc1 sc0 ls0 ws0">thread</div><div class="t m5 x195 h3f y82da ffed fs27 fc1 sc0 ls0 ws0">Buffer</div><div class="t m5 x172 h3f y82db ffee fs27 fc1 sc0 ls0 ws0">Remov<span class="_ _0"></span>e</div><div class="t m5 x19e h3f y82dc ffee fs27 fc1 sc0 ls0 ws0">descriptors</div><div class="t m5 x1c6 h3f y82dd ffee fs27 fc1 sc0 ls0 ws0">Accept</div><div class="t m5 x145 h3f y82de ffee fs27 fc1 sc0 ls0 ws0">connections</div><div class="t m5 x7f h3f y82df ffee fs27 fc1 sc0 ls0 ws0">Inser<span class="_ _2"></span>t</div><div class="t m5 x122 h3f y82e0 ffee fs27 fc1 sc0 ls0 ws0">descriptors</div><div class="t m5 x121 h3f y82e1 ffee fs27 fc1 sc0 ls0 ws0">Service client</div><div class="t m5 x121 h3f y82e2 ffee fs27 fc1 sc0 ls0 ws0">Service client</div><div class="t m8 xc4 h11c y82e3 ffed fsa6 fc1 sc0 ls0 ws0">. . .</div><div class="t m8 x231 h11c y82e4 ffed fsa6 fc1 sc0 ls0 ws0">. . .</div><div class="t m5 x1d h34 y82e5 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>12.27<span class="_ _c"> </span><span class="fc1">Organization<span class="_ _14"> </span>of<span class="_ _14"> </span>a<span class="_ _16"> </span>prethreaded<span class="_ _14"> </span>concurrent<span class="_ _14"> </span>server<span class="_ _1"></span>.<span class="_ _16"> </span><span class="ff6">A<span class="_ _14"> </span>set<span class="_ _14"> </span>of<span class="_ _14"> </span>existing</span></span></div><div class="t m5 x1d h34 y82e6 ff6 fs16 fc1 sc0 ls0 ws0">threads<span class="_ _10"> </span>repeatedly<span class="_ _11"> </span>remove<span class="_ _10"> </span>and<span class="_ _10"> </span>process<span class="_ _11"> </span>connected<span class="_ _10"> </span>descriptors<span class="_ _11"> </span>from<span class="_ _10"> </span>a<span class="_ _11"> </span>bounded<span class="_ _10"> </span>buffer<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y2468 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _21"> </span>resulting<span class="_ _f"> </span>connected<span class="_ _f"> </span>descriptors<span class="_ _21"> </span>in<span class="_ _f"> </span>a<span class="_ _f"> </span>bounded<span class="_ _21"> </span>buffer.<span class="_ _21"> </span>Each<span class="_ _f"> </span>worker<span class="_ _f"> </span>thread</div><div class="t m5 x1d h26 y2469 ff7 fs19 fc1 sc0 ls0 ws0">repeatedly<span class="_ _6"> </span>removes<span class="_ _13"> </span>a<span class="_ _6"> </span>descriptor<span class="_ _6"> </span>from<span class="_ _13"> </span>the<span class="_ _6"> </span>buffer,<span class="_ _6"> </span>services<span class="_ _13"> </span>the<span class="_ _a"> </span>client,<span class="_ _13"> </span>and<span class="_ _6"> </span>then<span class="_ _13"> </span>waits</div><div class="t m5 x1d h26 y246a ff7 fs19 fc1 sc0 ls0 ws0">for<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>descriptor.</div><div class="t m5 x29 h26 y246b ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _f"> </span>12.28<span class="_ _f"> </span>shows<span class="_ _f"> </span>how<span class="_ _f"> </span>we<span class="_ _f"> </span>would<span class="_ _f"> </span>use<span class="_ _f"> </span>the<span class="_ _f"> </span><span class="ff9">Sbuf<span class="_ _21"> </span></span>package<span class="_ _f"> </span>to<span class="_ _f"> </span>implement<span class="_ _f"> </span>a</div><div class="t m5 x1d h26 y246c ff7 fs19 fc1 sc0 ls0 ws0">prethreaded<span class="_ _16"> </span>concurrent<span class="_ _11"> </span>echo<span class="_ _16"> </span>server.<span class="_ _11"> </span>After<span class="_ _16"> </span>initializing<span class="_ _16"> </span>buffer<span class="_ _11"> </span><span class="ffd">sbuf<span class="_ _16"> </span></span>(line<span class="_ _16"> </span>24),<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y246d ff7 fs19 fc1 sc0 ls0 ws0">main<span class="_ _14"> </span>thread<span class="_ _14"> </span>creates<span class="_ _14"> </span>the<span class="_ _14"> </span>set<span class="_ _16"> </span>of<span class="_ _14"> </span>worker<span class="_ _14"> </span>threads<span class="_ _14"> </span>(lines<span class="_ _14"> </span>25–26).<span class="_ _14"> </span>Then<span class="_ _16"> </span>it<span class="_ _14"> </span>enters<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y246e ff7 fs19 fc1 sc0 ls0 ws0">inﬁnite<span class="_ _21"> </span>server<span class="_ _f"> </span>loop,<span class="_ _e"> </span>accepting<span class="_ _15"> </span>connection<span class="_ _f"> </span>requests<span class="_ _f"> </span>and<span class="_ _f"> </span>inserting<span class="_ _f"> </span>the<span class="_ _f"> </span>resulting</div><div class="t m5 x1d h26 y246f ff7 fs19 fc1 sc0 ls0 ws0">connected<span class="_ _16"> </span>descriptors<span class="_ _16"> </span>in<span class="_ _16"> </span><span class="ffd">sbuf</span>.<span class="_ _16"> </span>Each<span class="_ _16"> </span>worker<span class="_ _16"> </span>thread<span class="_ _16"> </span>has<span class="_ _16"> </span>a<span class="_ _16"> </span>very<span class="_ _16"> </span>simple<span class="_ _16"> </span>behavior.</div><div class="t m5 x1d h26 y2470 ff7 fs19 fc1 sc0 ls0 ws0">It<span class="_"> </span>waits<span class="_"> </span>until<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>able<span class="_"> </span>to<span class="_ _13"> </span>remove<span class="_"> </span>a<span class="_"> </span>connected<span class="_"> </span>descriptor<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>buffer<span class="_"> </span>(line<span class="_"> </span>39)</div><div class="t m5 x1d h26 y2471 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>then<span class="_"> </span>calls<span class="_"> </span>the<span class="_"> </span><span class="ffd">echo_cnt<span class="_ _10"> </span></span>function<span class="_"> </span>to<span class="_"> </span>echo<span class="_"> </span>client<span class="_"> </span>input.</div><div class="t m5 x29 h26 y2472 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _e"> </span><span class="ffd ls0">echo_cnt<span class="_ _e"> </span><span class="ff7">function<span class="_ _21"> </span>in<span class="_ _e"> </span>F<span class="_ _1"></span>igure<span class="_ _f"> </span>12.29<span class="_ _e"> </span>is<span class="_ _f"> </span>a<span class="_ _f"> </span>version<span class="_ _e"> </span>of<span class="_ _f"> </span>the<span class="_ _f"> </span><span class="ffd">echo<span class="_ _e"> </span></span>function</span></span></div><div class="t m5 x1d h26 y2473 ff7 fs19 fc1 sc0 ls0 ws0">from<span class="_ _15"> </span>F<span class="_ _0"></span>igure<span class="_ _15"> </span>11.22<span class="_ _15"> </span>that<span class="_ _15"> </span>records<span class="_ _15"> </span>the<span class="_ _21"> </span>cumulative<span class="_ _15"> </span>number<span class="_ _15"> </span>of<span class="_ _21"> </span>bytes<span class="_ _15"> </span>received<span class="_ _15"> </span>from</div><div class="t m5 x1d h26 y2474 ff7 fs19 fc1 sc0 ls0 ws0">all<span class="_ _16"> </span>clients<span class="_ _16"> </span>in<span class="_ _16"> </span>a<span class="_ _11"> </span>global<span class="_ _16"> </span>variable<span class="_ _16"> </span>called<span class="_ _16"> </span><span class="ffd">byte_cnt</span>.<span class="_ _16"> </span>T<span class="_ _0"></span>his<span class="_ _16"> </span>is<span class="_ _16"> </span>interesting<span class="_ _16"> </span>code<span class="_ _11"> </span>to<span class="_ _16"> </span>study</div><div class="t m5 x1d h26 y2475 ff7 fs19 fc1 sc0 ls0 ws0">because<span class="_"> </span>it<span class="_"> </span>shows<span class="_"> </span>you<span class="_"> </span>a<span class="_ _11"> </span>general<span class="_"> </span>technique<span class="_"> </span>for<span class="_"> </span>initializing<span class="_ _11"> </span>packages<span class="_"> </span>that<span class="_"> </span>are<span class="_"> </span>called</div><div class="t m5 x1d h26 y2476 ff7 fs19 fc1 sc0 ls0 ws0">from<span class="_ _15"> </span>thread<span class="_ _21"> </span>routines<span class="_ _1"></span>.<span class="_ _21"> </span>In<span class="_ _15"> </span>our<span class="_ _21"> </span>case,<span class="_ _21"> </span>we<span class="_ _15"> </span>need<span class="_ _21"> </span>to<span class="_ _21"> </span>initialize<span class="_ _21"> </span>the<span class="_ _15"> </span><span class="ffd">byte_cnt<span class="_ _21"> </span></span>counter</div><div class="t m5 x1d h26 y2477 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">mutex<span class="_ _14"> </span></span>semaphore<span class="_ _1"></span>.<span class="_ _16"> </span>One<span class="_ _14"> </span>approach,<span class="_ _14"> </span>which<span class="_ _16"> </span>we<span class="_ _16"> </span>used<span class="_ _16"> </span>for<span class="_ _14"> </span>the<span class="_ _16"> </span><span class="ff9">Sbuf<span class="_ _16"> </span></span>and<span class="_ _16"> </span><span class="ff9">Rio</span></div><div class="t m5 x1d h26 y2478 ff7 fs19 fc1 sc0 ls0 ws0">packages<span class="_ _1"></span>,<span class="_"> </span>is<span class="_"> </span>to<span class="_ _13"> </span>require<span class="_"> </span>the<span class="_"> </span>main<span class="_"> </span>thread<span class="_ _13"> </span>to<span class="_"> </span>explicitly<span class="_"> </span>call<span class="_"> </span>an<span class="_ _13"> </span>initialization<span class="_"> </span>function.</div><div class="t m5 x1d h26 y4f1f ff7 fs19 fc1 sc0 ls0 ws0">Another<span class="_"> </span>approach,<span class="_ _11"> </span>shown<span class="_"> </span>here,<span class="_"> </span>uses<span class="_"> </span>the<span class="_ _11"> </span><span class="ffd">pthread_once<span class="_ _10"> </span></span>function<span class="_ _11"> </span>(line<span class="_"> </span>19)<span class="_ _11"> </span>to<span class="_ _11"> </span>call</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
