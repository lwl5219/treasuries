<div id="pf38a" class="pf w2 h11" data-page-no="38a"><div class="pc pc38a w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg38a.png"/><div class="t m5 x1f8 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.10<span class="_ _60"> </span>Garbage<span class="_ _10"> </span>Collection<span class="_ _3e"> </span><span class="ffe fs1e">905</span></div><div class="t m5 x17 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.52</div><div class="t m5 x17 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Mark&amp;Sweep<span class="_ _16"> </span>example.</div><div class="t m5 x17 h34 y58b ff6 fs16 fc1 sc0 ls0 ws0">Note<span class="_ _10"> </span>that<span class="_ _13"> </span>the<span class="_ _10"> </span>arrows<span class="_ _13"> </span>in<span class="_ _10"> </span>this</div><div class="t m5 x17 h34 y58c ff6 fs16 fc1 sc0 ls0 ws0">example<span class="_ _11"> </span>denote<span class="_ _16"> </span>memory</div><div class="t m5 x17 h34 y58d ff6 fs16 fc1 sc0 ls0 ws0">references,<span class="_ _14"> </span>not<span class="_ _16"> </span>free<span class="_ _14"> </span>list</div><div class="t m5 x17 h34 y58e ff6 fs16 fc1 sc0 ls0 ws0">pointers.</div><div class="t m5 x49 he3 y7504 ffcc fs94 fc1 sc0 ls2c7 ws0">1234<span class="_ _48"> </span>5<span class="_ _3a"> </span>6</div><div class="t m5 xb3 he3 y7505 ffcc fs94 fc1 sc0 ls0 ws0">Before mark:</div><div class="t m5 xfb he3 y7506 ffcc fs94 fc1 sc0 ls0 ws0">Root</div><div class="t m5 x1f2 he3 y7507 ffcc fs94 fc1 sc0 ls0 ws0">After mark:</div><div class="t m5 x1e he3 y7508 ffcc fs94 fc1 sc0 ls0 ws0">Unmarked bloc</div><div class="c xb3 y7509 w36 h116"><div class="t m5 xe4 he3 y750a ffcc fs94 fc1 sc0 ls0 ws0">k</div></div><div class="t m5 x1e he3 y750b ffcc fs94 fc1 sc0 ls0 ws0">header</div><div class="t m5 x1e he3 y750c ffcc fs94 fc1 sc0 ls0 ws0">Marked block</div><div class="t m5 x1e he3 y750d ffcc fs94 fc1 sc0 ls0 ws0">header</div><div class="t m5 x8f he3 y750e ffcc fs94 fc1 sc0 ls0 ws0">After sweep:<span class="_ _16a"> </span>Free<span class="_ _1de"></span>Free</div><div class="t m5 x17 h2f y750f ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.53</div><div class="t m5 x17 h2f y7510 ffe fs16 fc1 sc0 ls0 ws0">Left<span class="_ _16"> </span>and<span class="_ _16"> </span>right<span class="_ _11"> </span>pointers</div><div class="t m5 x17 h2f y7511 ffe fs16 fc1 sc0 ls0 ws0">in<span class="_ _14"> </span>a<span class="_ _16"> </span>balanced<span class="_ _14"> </span>tree<span class="_ _14"> </span>of</div><div class="t m5 x17 h2f y7512 ffe fs16 fc1 sc0 ls0 ws0">allocated<span class="_"> </span>blocks.</div><div class="t m5 x238 h3f y7513 ffcd fs27 fc1 sc0 ls0 ws0">Size<span class="_ _f1"> </span>Left<span class="_ _13c"> </span>Right<span class="_ _2c"> </span>Remainder of block</div><div class="t m5 x183 h3f y7514 ffcd fs27 fc1 sc0 ls0 ws0">Allocated block header</div><div class="t m5 xe2 h117 y7515 ff24 fs27 fc1 sc0 ls2c8 ws0"></div><div class="t m5 x26 h26 y7516 ff7 fs19 fc1 sc0 ls0 ws0">Initially<span class="_ _3"></span>,<span class="_ _13"> </span>the<span class="_"> </span>heap<span class="_ _13"> </span>in<span class="_ _13"> </span>Figure<span class="_ _13"> </span>9.52<span class="_ _13"> </span>consists<span class="_"> </span>of<span class="_ _13"> </span>six<span class="_ _13"> </span>allocated<span class="_ _13"> </span>blocks<span class="_ _0"></span>,<span class="_ _13"> </span>each<span class="_"> </span>of<span class="_ _13"> </span>which</div><div class="t m5 x17 h26 y7517 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _11"> </span>unmarked.<span class="_ _11"> </span>Block<span class="_ _11"> </span>3<span class="_ _16"> </span>contains<span class="_"> </span>a<span class="_ _16"> </span>pointer<span class="_"> </span>to<span class="_ _16"> </span>block<span class="_"> </span>1.<span class="_ _16"> </span>Block<span class="_"> </span>4<span class="_ _16"> </span>contains<span class="_"> </span>pointers<span class="_ _16"> </span>to</div><div class="t m5 x17 h26 y7518 ff7 fs19 fc1 sc0 ls0 ws0">blocks<span class="_ _6"> </span>3<span class="_ _6"> </span>and<span class="_ _6"> </span>6.<span class="_ _6"> </span>The<span class="_ _a"> </span>root<span class="_ _6"> </span>points<span class="_ _6"> </span>to<span class="_ _6"> </span>block<span class="_ _13"> </span>4.<span class="_ _a"> </span>After<span class="_ _6"> </span>the<span class="_ _6"> </span>mark<span class="_ _6"> </span>phase,<span class="_ _6"> </span>blocks<span class="_ _6"> </span>1,<span class="_ _13"> </span>3,<span class="_ _6"> </span>4,<span class="_ _13"> </span>and<span class="_ _a"> </span>6</div><div class="t m5 x17 h26 y7519 ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_ _6"> </span>marked<span class="_ _6"> </span>because<span class="_ _6"> </span>they<span class="_ _6"> </span>are<span class="_ _6"> </span>reachable<span class="_ _6"> </span>from<span class="_ _6"> </span>the<span class="_ _13"> </span>root.<span class="_ _a"> </span>Blocks<span class="_ _6"> </span>2<span class="_ _6"> </span>and<span class="_ _6"> </span>5<span class="_ _6"> </span>are<span class="_ _6"> </span>unmarked</div><div class="t m5 x17 h26 y751a ff7 fs19 fc1 sc0 ls0 ws0">because<span class="_ _13"> </span>they<span class="_ _13"> </span>are<span class="_ _13"> </span>unreachable.<span class="_ _13"> </span>After<span class="_ _13"> </span>the<span class="_ _13"> </span>sweep<span class="_ _13"> </span>phase<span class="_ _1"></span>,<span class="_"> </span>the<span class="_ _13"> </span>two<span class="_ _13"> </span>unreachable<span class="_ _13"> </span>blocks</div><div class="t m5 x17 h26 y751b ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_"> </span>reclaimed<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>free<span class="_"> </span>list.</div><div class="t m5 x17 h41 y322c ffe fs29 fc1 sc0 ls0 ws0">9.10.3<span class="_ _48"> </span><span class="fs19">Conservative<span class="_"> </span>Mark&amp;Sweep<span class="_"> </span>for<span class="_"> </span>C<span class="_"> </span>Programs</span></div><div class="t m5 x17 h26 y7fe ff7 fs19 fc1 sc0 ls0 ws0">Mark&amp;Sweep<span class="_"> </span>is<span class="_ _11"> </span>an<span class="_ _11"> </span>appropriate<span class="_ _11"> </span>approach<span class="_ _11"> </span>for<span class="_ _11"> </span>garbage<span class="_ _11"> </span>collecting<span class="_ _11"> </span>C<span class="_ _11"> </span>programs<span class="_ _11"> </span>be-</div><div class="t m5 x17 h26 y7ff ff7 fs19 fc1 sc0 ls0 ws0">cause<span class="_ _13"> </span>it<span class="_ _6"> </span>works<span class="_ _13"> </span>in<span class="_ _6"> </span>place<span class="_ _13"> </span>without<span class="_ _13"> </span>moving<span class="_ _6"> </span>any<span class="_ _13"> </span>blocks<span class="_ _1"></span>.<span class="_ _13"> </span>However<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>C<span class="_ _13"> </span>language<span class="_ _6"> </span>poses</div><div class="t m5 x17 h26 y800 ff7 fs19 fc1 sc0 ls0 ws0">some<span class="_"> </span>interesting<span class="_"> </span>challenges<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>implementation<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span><span class="ffd">isPtr<span class="_ _10"> </span></span>function.</div><div class="t m5 x26 h26 y801 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>irst,<span class="_"> </span>C<span class="_ _13"> </span>does<span class="_ _13"> </span>not<span class="_ _13"> </span>tag<span class="_ _13"> </span>memory<span class="_ _13"> </span>locations<span class="_ _13"> </span>with<span class="_ _13"> </span>any<span class="_ _13"> </span>type<span class="_ _13"> </span>information.<span class="_ _13"> </span>T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_ _13"> </span>there</div><div class="t m5 x17 h26 y802 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _6"> </span>no<span class="_ _13"> </span>obvious<span class="_ _a"> </span>way<span class="_ _13"> </span>for<span class="_ _a"> </span><span class="ffd">isPtr<span class="_ _13"> </span></span>to<span class="_ _6"> </span>determine<span class="_ _6"> </span>if<span class="_ _6"> </span>its<span class="_ _13"> </span>input<span class="_ _6"> </span>parameter<span class="_ _6"> </span><span class="ffd">p<span class="_ _13"> </span></span>is<span class="_ _a"> </span>a<span class="_ _13"> </span>pointer<span class="_ _a"> </span>or<span class="_ _13"> </span>not.</div><div class="t m5 x17 h26 y803 ff7 fs19 fc1 sc0 ls0 ws0">Second,<span class="_"> </span>even<span class="_"> </span>if<span class="_ _13"> </span>we<span class="_"> </span>were<span class="_"> </span>to<span class="_"> </span>know<span class="_"> </span>that<span class="_ _13"> </span><span class="ffd">p<span class="_ _10"> </span></span>was<span class="_"> </span>a<span class="_"> </span>pointer,<span class="_ _13"> </span>there<span class="_"> </span>would<span class="_"> </span>be<span class="_"> </span>no<span class="_"> </span>obvious</div><div class="t m5 x17 h26 y804 ff7 fs19 fc1 sc0 ls0 ws0">way<span class="_ _11"> </span>for<span class="_ _11"> </span><span class="ffd">isPtr<span class="_ _11"> </span></span>to<span class="_"> </span>determine<span class="_ _11"> </span>whether<span class="_ _16"> </span><span class="ffd">p<span class="_ _10"> </span></span>points<span class="_ _11"> </span>to<span class="_ _11"> </span>some<span class="_ _11"> </span>location<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>payload<span class="_ _11"> </span>of</div><div class="t m5 x17 h26 y805 ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_"> </span>allocated<span class="_"> </span>block.</div><div class="t m5 x26 h26 y806 ff7 fs19 fc1 sc0 ls0 ws0">One<span class="_ _11"> </span>solution<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span>latter<span class="_ _11"> </span>problem<span class="_ _11"> </span>is<span class="_ _16"> </span>to<span class="_ _11"> </span>maintain<span class="_ _11"> </span>the<span class="_ _11"> </span>set<span class="_ _16"> </span>of<span class="_ _11"> </span>allocated<span class="_ _11"> </span>blocks</div><div class="t m5 x17 h26 y807 ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_ _16"> </span>a<span class="_ _16"> </span>balanced<span class="_ _14"> </span>binary<span class="_ _16"> </span>tree<span class="_ _14"> </span>that<span class="_ _16"> </span>maintains<span class="_ _16"> </span>the<span class="_ _14"> </span>invariant<span class="_ _16"> </span>that<span class="_ _14"> </span>all<span class="_ _16"> </span>blocks<span class="_ _16"> </span>in<span class="_ _14"> </span>the<span class="_ _16"> </span>left</div><div class="t m5 x17 h26 y808 ff7 fs19 fc1 sc0 ls0 ws0">subtree<span class="_ _14"> </span>are<span class="_ _14"> </span>located<span class="_ _14"> </span>at<span class="_ _14"> </span>smaller<span class="_ _14"> </span>addresses<span class="_ _14"> </span>and<span class="_ _14"> </span>all<span class="_ _14"> </span>blocks<span class="_ _14"> </span>in<span class="_ _14"> </span>the<span class="_ _14"> </span>right<span class="_ _14"> </span>subtree<span class="_ _15"> </span>are</div><div class="t m5 x17 h26 y809 ff7 fs19 fc1 sc0 ls0 ws0">located<span class="_"> </span>in<span class="_"> </span>larger<span class="_ _11"> </span>addresses<span class="_ _1"></span>.<span class="_"> </span>As<span class="_ _11"> </span>shown<span class="_"> </span>in<span class="_"> </span>Figure<span class="_"> </span>9.53,<span class="_"> </span>this<span class="_"> </span>requires<span class="_ _11"> </span>two<span class="_"> </span>additional</div><div class="t m5 x17 h26 y80a ff7 fs19 fc1 sc0 ls0 ws0">ﬁelds<span class="_ _13"> </span>(<span class="ffd">left<span class="_ _10"> </span></span>and<span class="_ _13"> </span><span class="ffd">right</span>)<span class="_ _13"> </span>in<span class="_"> </span>the<span class="_ _13"> </span>header<span class="_ _13"> </span>of<span class="_"> </span>each<span class="_ _13"> </span>allocated<span class="_"> </span>block.<span class="_ _13"> </span>Each<span class="_ _13"> </span>ﬁeld<span class="_"> </span>points<span class="_ _13"> </span>to</div><div class="t m5 x17 h26 y80b ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>header<span class="_ _11"> </span>of<span class="_ _16"> </span>some<span class="_ _11"> </span>allocated<span class="_ _11"> </span>block.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span><span class="ffd">isPtr(ptr<span class="_ _16"> </span>p)<span class="_ _11"> </span></span>function<span class="_ _16"> </span>uses<span class="_ _11"> </span>the<span class="_ _11"> </span>tree<span class="_ _16"> </span>to</div><div class="t m5 x17 h26 y80c ff7 fs19 fc1 sc0 ls0 ws0">perform<span class="_"> </span>a<span class="_"> </span>binary<span class="_"> </span>search<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>allocated<span class="_"> </span>blocks<span class="_ _1"></span>.<span class="_"> </span>At<span class="_"> </span>each<span class="_"> </span>step,<span class="_"> </span>it<span class="_"> </span>relies<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>size</div><div class="t m5 x17 h26 y2b6f ff7 fs19 fc1 sc0 ls0 ws0">ﬁeld<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>block<span class="_"> </span>header<span class="_"> </span>to<span class="_"> </span>determine<span class="_"> </span>if<span class="_"> </span><span class="ffd">p<span class="_ _10"> </span></span>falls<span class="_"> </span>within<span class="_"> </span>the<span class="_"> </span>extent<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>block.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
