<div id="pf32d" class="pf w2 h11" data-page-no="32d"><div class="pc pc32d w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg32d.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">812<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 x1d h41 ye7 ffe fs29 fc2 sc0 ls0 ws0">8.5.6<span class="_ _48"> </span><span class="fs19">Synchronizing<span class="_"> </span>Flows<span class="_"> </span>to<span class="_"> </span>Avoid<span class="_"> </span>Nasty<span class="_"> </span>Concurrency<span class="_"> </span>Bugs</span></div><div class="t m5 x1d h26 ybbe ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>problem<span class="_ _16"> </span>of<span class="_ _16"> </span>how<span class="_ _16"> </span>to<span class="_ _16"> </span>program<span class="_ _16"> </span>concurrent<span class="_ _16"> </span>ﬂows<span class="_ _16"> </span>that<span class="_ _16"> </span>read<span class="_ _16"> </span>and<span class="_ _11"> </span>write<span class="_ _16"> </span>the<span class="_ _16"> </span>same</div><div class="t m5 x1d h26 ybbf ff7 fs19 fc2 sc0 ls0 ws0">storage<span class="_ _16"> </span>locations<span class="_ _14"> </span>has<span class="_ _14"> </span>challenged<span class="_ _16"> </span>generations<span class="_ _14"> </span>of<span class="_ _14"> </span>computer<span class="_ _16"> </span>scientists<span class="_ _1"></span>.<span class="_ _14"> </span>In<span class="_ _14"> </span>general,</div><div class="t m5 x1d h26 ybc0 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>number<span class="_"> </span>of<span class="_ _13"> </span>potential<span class="_"> </span>interleavings<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>ﬂows<span class="_"> </span>is<span class="_ _13"> </span>exponential<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>number<span class="_ _13"> </span>of</div><div class="t m5 x1d h26 ybc1 ff7 fs19 fc2 sc0 ls0 ws0">instructions<span class="_ _1"></span>.<span class="_ _13"> </span>Some<span class="_"> </span>of<span class="_ _13"> </span>those<span class="_ _13"> </span>interleavings<span class="_"> </span>will<span class="_ _13"> </span>produce<span class="_ _13"> </span>correct<span class="_"> </span>answers<span class="_ _3"></span>,<span class="_"> </span>and<span class="_ _13"> </span>others</div><div class="t m5 x1d h26 ybc2 ff7 fs19 fc2 sc0 ls0 ws0">will<span class="_ _15"> </span>not.<span class="_ _15"> </span>T<span class="_ _1"></span>he<span class="_ _21"> </span>fundamental<span class="_ _15"> </span>problem<span class="_ _15"> </span>is<span class="_ _15"> </span>to<span class="_ _15"> </span>somehow<span class="_ _15"> </span><span class="ffa">synchronize<span class="_ _14"> </span></span>the<span class="_ _21"> </span>concurrent</div><div class="t m5 x1d h26 y119b ff7 fs19 fc2 sc0 ls0 ws0">ﬂows<span class="_ _11"> </span>so<span class="_ _11"> </span>as<span class="_ _16"> </span>to<span class="_ _11"> </span>allow<span class="_ _11"> </span>the<span class="_ _11"> </span>largest<span class="_ _16"> </span>set<span class="_ _11"> </span>of<span class="_ _11"> </span>feasible<span class="_ _11"> </span>interleavings<span class="_ _16"> </span>such<span class="_ _11"> </span>that<span class="_ _11"> </span>each<span class="_ _11"> </span>of<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y119c ff7 fs19 fc2 sc0 ls0 ws0">feasible<span class="_"> </span>interleavings<span class="_"> </span>produces<span class="_"> </span>a<span class="_"> </span>correct<span class="_"> </span>answer.</div><div class="t m5 x29 h26 y216 ff7 fs19 fc2 sc0 ls0 ws0">Concurrent<span class="_ _6"> </span>programming<span class="_ _6"> </span>is<span class="_ _6"> </span>a<span class="_ _6"> </span>deep<span class="_ _13"> </span>and<span class="_ _a"> </span>important<span class="_ _6"> </span>problem<span class="_ _6"> </span>that<span class="_ _13"> </span>we<span class="_ _a"> </span>will<span class="_ _6"> </span>discuss</div><div class="t m5 x1d h26 y2364 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _16"> </span>more<span class="_ _14"> </span>detail<span class="_ _14"> </span>in<span class="_ _14"> </span>Chapter<span class="_ _14"> </span>12.<span class="_ _14"> </span>However,<span class="_ _14"> </span>we<span class="_ _16"> </span>can<span class="_ _14"> </span>use<span class="_ _14"> </span>what<span class="_ _14"> </span>you’ve<span class="_ _16"> </span>learned<span class="_ _14"> </span>about</div><div class="t m5 x1d h26 y2365 ff7 fs19 fc2 sc0 ls0 ws0">exceptional<span class="_ _15"> </span>control<span class="_ _21"> </span>ﬂow<span class="_ _21"> </span>in<span class="_ _21"> </span>this<span class="_ _21"> </span>chapter<span class="_ _21"> </span>to<span class="_ _21"> </span>give<span class="_ _21"> </span>you<span class="_ _21"> </span>a<span class="_ _21"> </span>sense<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>interesting</div><div class="t m5 x1d h26 y320 ff7 fs19 fc2 sc0 ls0 ws0">intellectual<span class="_ _15"> </span>challenges<span class="_ _21"> </span>associated<span class="_ _21"> </span>with<span class="_ _21"> </span>concurrency<span class="_ _3"></span>.<span class="_ _15"> </span>F<span class="_ _1"></span>or<span class="_ _21"> </span>example,<span class="_ _21"> </span>consider<span class="_ _21"> </span>the</div><div class="t m5 x1d h26 y321 ff7 fs19 fc2 sc0 ls0 ws0">program<span class="_"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>8.39,<span class="_ _11"> </span>which<span class="_ _11"> </span>captures<span class="_ _11"> </span>the<span class="_ _11"> </span>structure<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_"> </span>typical<span class="_ _11"> </span>Unix<span class="_ _11"> </span>shell.<span class="_ _11"> </span>The</div><div class="t m5 x1d h26 y301 ff7 fs19 fc2 sc0 ls0 ws0">parent<span class="_ _13"> </span>keeps<span class="_ _13"> </span>track<span class="_ _13"> </span>of<span class="_ _13"> </span>its<span class="_ _13"> </span>current<span class="_ _13"> </span>children<span class="_ _13"> </span>using<span class="_ _13"> </span>entries<span class="_ _13"> </span>in<span class="_ _13"> </span>a<span class="_ _13"> </span>global<span class="_ _13"> </span>job<span class="_ _6"> </span>list,<span class="_"> </span>with<span class="_ _13"> </span>one</div><div class="t m5 x1d h26 y302 ff7 fs19 fc2 sc0 ls0 ws0">entry<span class="_"> </span>per<span class="_ _13"> </span>job<span class="_ _0"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span><span class="ffd">addjob<span class="_ _13"> </span></span>and<span class="_"> </span><span class="ffd">deletejob<span class="_ _13"> </span></span>functions<span class="_"> </span>add<span class="_ _13"> </span>and<span class="_"> </span>remove<span class="_"> </span>entries<span class="_ _13"> </span>from</div><div class="t m5 x1d h26 y303 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>job<span class="_"> </span>list.</div><div class="t m5 x29 h26 y304 ff7 fs19 fc2 sc0 ls0 ws0">After<span class="_ _21"> </span>the<span class="_ _21"> </span>parent<span class="_ _21"> </span>creates<span class="_ _f"> </span>a<span class="_ _21"> </span>new<span class="_ _21"> </span>child<span class="_ _21"> </span>process<span class="_ _0"></span>,<span class="_ _f"> </span>it<span class="_ _f"> </span>adds<span class="_ _21"> </span>the<span class="_ _21"> </span>child<span class="_ _21"> </span>to<span class="_ _f"> </span>the<span class="_ _21"> </span>job</div><div class="t m5 x1d h26 y305 ff7 fs19 fc2 sc0 ls0 ws0">list.<span class="_"> </span>When<span class="_"> </span>the<span class="_ _11"> </span>parent<span class="_ _11"> </span>reaps<span class="_"> </span>a<span class="_ _11"> </span>terminated<span class="_ _11"> </span>(zombie)<span class="_ _11"> </span>child<span class="_"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>SIGCHLD<span class="_ _11"> </span>signal</div><div class="t m5 x1d h26 y306 ff7 fs19 fc2 sc0 ls0 ws0">handler,<span class="_"> </span>it<span class="_"> </span>deletes<span class="_"> </span>the<span class="_"> </span>child<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>job<span class="_"> </span>list.</div><div class="t m5 x29 h26 y307 ff7 fs19 fc2 sc0 ls0 ws0">At<span class="_ _11"> </span>ﬁrst<span class="_ _11"> </span>glance<span class="_ _0"></span>,<span class="_ _11"> </span>this<span class="_ _11"> </span>code<span class="_ _11"> </span>appears<span class="_ _11"> </span>to<span class="_ _11"> </span>be<span class="_ _16"> </span>correct.<span class="_"> </span>Unfortunately<span class="_ _3"></span>,<span class="_ _11"> </span>the<span class="_ _16"> </span>following</div><div class="t m5 x1d h26 y308 ff7 fs19 fc2 sc0 ls0 ws0">sequence<span class="_"> </span>of<span class="_"> </span>events<span class="_"> </span>is<span class="_"> </span>possible:</div><div class="t m5 xc5 h26 y309 ffc fs19 fc2 sc0 ls0 ws0">1.<span class="_ _e"> </span><span class="ff7">The<span class="_ _16"> </span>parent<span class="_ _14"> </span>executes<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">fork<span class="_ _14"> </span></span>function<span class="_ _14"> </span>and<span class="_ _14"> </span>the<span class="_ _16"> </span>kernel<span class="_ _14"> </span>schedules<span class="_ _14"> </span>the<span class="_ _14"> </span>newly</span></div><div class="t m5 x29 h26 y30a ff7 fs19 fc2 sc0 ls0 ws0">created<span class="_"> </span>child<span class="_"> </span>to<span class="_"> </span>run<span class="_"> </span>instead<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>parent.</div><div class="t m5 xc5 h26 y6a02 ffc fs19 fc2 sc0 ls0 ws0">2.<span class="_ _e"> </span><span class="ff7">Before<span class="_ _14"> </span>the<span class="_ _16"> </span>parent<span class="_ _14"> </span>is<span class="_ _16"> </span>able<span class="_ _14"> </span>to<span class="_ _16"> </span>run<span class="_ _14"> </span>again,<span class="_ _14"> </span>the<span class="_ _16"> </span>child<span class="_ _14"> </span>terminates<span class="_ _16"> </span>and<span class="_ _14"> </span>becomes<span class="_ _16"> </span>a</span></div><div class="t m5 x29 h26 y6a03 ff7 fs19 fc2 sc0 ls0 ws0">zombie<span class="_ _1"></span>,<span class="_"> </span>causing<span class="_"> </span>the<span class="_"> </span>kernel<span class="_"> </span>to<span class="_"> </span>deliver<span class="_"> </span>a<span class="_"> </span>SIGCHLD<span class="_"> </span>signal<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>parent.</div><div class="t m5 xc5 h26 y6a04 ffc fs19 fc2 sc0 ls0 ws0">3.<span class="_ _e"> </span><span class="ff7">Later,<span class="_"> </span>when<span class="_ _13"> </span>the<span class="_"> </span>parent<span class="_ _13"> </span>becomes<span class="_"> </span>runnable<span class="_ _13"> </span>again<span class="_"> </span>but<span class="_"> </span>before<span class="_ _13"> </span>it<span class="_"> </span>is<span class="_ _13"> </span>executed,<span class="_"> </span>the</span></div><div class="t m5 x29 h26 y6a05 ff7 fs19 fc2 sc0 ls0 ws0">kernel<span class="_ _13"> </span>notices<span class="_ _13"> </span>the<span class="_ _13"> </span>pending<span class="_ _13"> </span>SIGCHLD<span class="_ _13"> </span>and<span class="_ _13"> </span>causes<span class="_ _13"> </span>it<span class="_ _13"> </span>to<span class="_ _13"> </span>be<span class="_ _13"> </span>received<span class="_ _13"> </span>by<span class="_ _13"> </span>running</div><div class="t m5 x29 h26 y6a06 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>signal<span class="_"> </span>handler<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>parent.</div><div class="t m5 xc5 h26 y6a07 ffc fs19 fc2 sc0 ls0 ws0">4.<span class="_ _e"> </span><span class="ff7">The<span class="_ _6"> </span>signal<span class="_ _6"> </span>handler<span class="_ _13"> </span>reaps<span class="_ _a"> </span>the<span class="_ _13"> </span>terminated<span class="_ _6"> </span>child<span class="_ _6"> </span>and<span class="_ _13"> </span>calls<span class="_ _a"> </span><span class="ffd">deletejob</span>,<span class="_ _13"> </span>which<span class="_ _6"> </span>does</span></div><div class="t m5 x29 h26 y6a08 ff7 fs19 fc2 sc0 ls0 ws0">nothing<span class="_"> </span>because<span class="_"> </span>the<span class="_"> </span>parent<span class="_"> </span>has<span class="_"> </span>not<span class="_"> </span>added<span class="_"> </span>the<span class="_"> </span>child<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>list<span class="_"> </span>yet.</div><div class="t m5 xc5 h26 y313 ffc fs19 fc2 sc0 ls0 ws0">5.<span class="_ _e"> </span><span class="ff7">After<span class="_ _16"> </span>the<span class="_ _11"> </span>handler<span class="_ _11"> </span>completes<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>kernel<span class="_ _11"> </span>then<span class="_ _11"> </span>runs<span class="_ _16"> </span>the<span class="_ _11"> </span>parent,<span class="_ _11"> </span>which<span class="_ _11"> </span>returns</span></div><div class="t m5 x29 h26 y314 ff7 fs19 fc2 sc0 ls0 ws0">from<span class="_ _13"> </span><span class="ffd">fork<span class="_ _6"> </span></span>and<span class="_ _13"> </span>incorrectly<span class="_ _6"> </span>adds<span class="_ _13"> </span>the<span class="_ _13"> </span>(nonexistent)<span class="_ _6"> </span>child<span class="_ _13"> </span>to<span class="_ _6"> </span>the<span class="_ _13"> </span>job<span class="_ _13"> </span>list<span class="_ _6"> </span>by<span class="_ _13"> </span>calling</div><div class="t m5 x29 h26 y315 ffd fs19 fc2 sc0 ls0 ws0">addjob<span class="ff7">.</span></div><div class="t m5 x29 h26 y324 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_"> </span>for<span class="_ _13"> </span>some<span class="_"> </span>interleavings<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>parent’s<span class="_"> </span>main<span class="_ _13"> </span>routine<span class="_ _13"> </span>and<span class="_"> </span>signal-handling</div><div class="t m5 x1d h26 y325 ff7 fs19 fc2 sc0 ls0 ws0">ﬂows<span class="_ _1"></span>,<span class="_ _16"> </span>it<span class="_ _16"> </span>is<span class="_ _16"> </span>possible<span class="_ _11"> </span>for<span class="_ _16"> </span><span class="ffd">deletejob<span class="_ _16"> </span></span>to<span class="_ _16"> </span>be<span class="_ _11"> </span>called<span class="_ _16"> </span>before<span class="_ _16"> </span><span class="ffd">addjob</span>.<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>results<span class="_ _11"> </span>in<span class="_ _16"> </span>an</div><div class="t m5 x1d h26 y326 ff7 fs19 fc2 sc0 ls0 ws0">incorrect<span class="_ _13"> </span>entry<span class="_"> </span>on<span class="_ _13"> </span>the<span class="_ _13"> </span>job<span class="_ _13"> </span>list,<span class="_"> </span>for<span class="_ _13"> </span>a<span class="_ _13"> </span>job<span class="_"> </span>that<span class="_ _13"> </span>no<span class="_ _13"> </span>longer<span class="_"> </span>exists<span class="_ _13"> </span>and<span class="_ _13"> </span>that<span class="_ _13"> </span>will<span class="_"> </span>never<span class="_ _13"> </span>be</div><div class="t m5 x1d h26 y319 ff7 fs19 fc2 sc0 ls0 ws0">removed.<span class="_ _11"> </span>On<span class="_ _16"> </span>the<span class="_ _11"> </span>other<span class="_ _16"> </span>hand,<span class="_ _16"> </span>there<span class="_ _11"> </span>are<span class="_ _16"> </span>also<span class="_ _11"> </span>interleavings<span class="_ _16"> </span>where<span class="_ _11"> </span>events<span class="_ _16"> </span>occur<span class="_ _16"> </span>in</div><div class="t m5 x1d h26 y31a ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>correct<span class="_ _13"> </span>order<span class="_ _1"></span>.<span class="_ _13"> </span>F<span class="_ _1"></span>or<span class="_ _13"> </span>example<span class="_ _0"></span>,<span class="_ _13"> </span>if<span class="_ _13"> </span>the<span class="_ _13"> </span>kernel<span class="_ _6"> </span>happens<span class="_ _13"> </span>to<span class="_ _13"> </span>schedule<span class="_ _13"> </span>the<span class="_ _13"> </span>parent<span class="_ _13"> </span>to<span class="_ _6"> </span>run</div><div class="t m5 x1d h26 y31b ff7 fs19 fc2 sc0 ls0 ws0">when<span class="_"> </span>the<span class="_"> </span><span class="ffd">fork<span class="_ _10"> </span></span>call<span class="_"> </span>returns<span class="_"> </span>instead<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>child,<span class="_"> </span>then<span class="_"> </span>the<span class="_"> </span>parent<span class="_"> </span>will<span class="_"> </span>correctly<span class="_"> </span>add</div><div class="t m5 x1d h26 y31c ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>child<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>job<span class="_ _13"> </span>list<span class="_ _13"> </span>before<span class="_ _13"> </span>the<span class="_ _13"> </span>child<span class="_ _13"> </span>terminates<span class="_ _13"> </span>and<span class="_"> </span>the<span class="_ _13"> </span>signal<span class="_ _13"> </span>handler<span class="_ _13"> </span>removes</div><div class="t m5 x1d h26 y31d ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>job<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>list.</div><div class="t m5 x29 h26 y31e ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _11"> </span>is<span class="_"> </span>an<span class="_ _11"> </span>example<span class="_"> </span>of<span class="_ _11"> </span>a<span class="_"> </span>classic<span class="_"> </span>synchronization<span class="_ _11"> </span>error<span class="_"> </span>known<span class="_ _11"> </span>as<span class="_"> </span>a<span class="_ _11"> </span><span class="ffa">race</span>.<span class="_"> </span>In<span class="_ _11"> </span>this</div><div class="t m5 x1d h26 y31f ff7 fs19 fc2 sc0 ls0 ws0">case<span class="_ _1"></span>,<span class="_ _15"> </span>the<span class="_ _16"> </span>race<span class="_ _14"> </span>is<span class="_ _16"> </span>between<span class="_ _14"> </span>the<span class="_ _16"> </span>call<span class="_ _14"> </span>to<span class="_ _16"> </span><span class="ffd">addjob<span class="_ _14"> </span></span>in<span class="_ _16"> </span>the<span class="_ _14"> </span>main<span class="_ _14"> </span>routine<span class="_ _16"> </span>and<span class="_ _14"> </span>the<span class="_ _16"> </span>call<span class="_ _14"> </span>to</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
