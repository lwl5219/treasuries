<div id="pf427" class="pf w2 h11" data-page-no="427"><div class="pc pc427 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg427.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1062<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">ID<span class="_ _11"> </span>passed<span class="_ _11"> </span>in<span class="_ _11"> </span>its<span class="_ _11"> </span>argument<span class="_ _11"> </span>to<span class="_ _11"> </span>a<span class="_ _11"> </span>local<span class="_ _11"> </span>variable<span class="_ _11"> </span>(line<span class="_ _16"> </span>22)<span class="_"> </span>and<span class="_ _11"> </span>then<span class="_ _11"> </span>prints<span class="_ _11"> </span>a<span class="_ _16"> </span>message</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">containing<span class="_"> </span>the<span class="_ _11"> </span>ID<span class="_ _3"></span>.<span class="_ _11"> </span>It<span class="_"> </span>looks<span class="_ _11"> </span>simple<span class="_"> </span>enough,<span class="_ _11"> </span>but<span class="_"> </span>when<span class="_ _11"> </span>we<span class="_"> </span>run<span class="_ _11"> </span>this<span class="_ _11"> </span>program<span class="_"> </span>on<span class="_ _11"> </span>our</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">system,<span class="_"> </span>we<span class="_"> </span>get<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>incorrect<span class="_"> </span>result:</div><div class="t m5 x1d h2d y842d ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">./race</span></div><div class="t m5 x1d h2d y842e ffd fs1e fc2 sc0 ls0 ws0">Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>1</div><div class="t m5 x1d h2d y842f ffd fs1e fc2 sc0 ls0 ws0">Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>3</div><div class="t m5 x1d h2d y8430 ffd fs1e fc2 sc0 ls0 ws0">Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>2</div><div class="t m5 x1d h2d y8431 ffd fs1e fc2 sc0 ls0 ws0">Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>3</div><div class="t m5 x29 h26 y8432 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _21"> </span>problem<span class="_ _15"> </span>is<span class="_ _21"> </span>caused<span class="_ _15"> </span>by<span class="_ _21"> </span>a<span class="_ _15"> </span>race<span class="_ _21"> </span>between<span class="_ _15"> </span>each<span class="_ _21"> </span>peer<span class="_ _15"> </span>thread<span class="_ _21"> </span>and<span class="_ _15"> </span>the<span class="_ _21"> </span>main</div><div class="t m5 x1d h26 y8433 ff7 fs19 fc2 sc0 ls0 ws0">thread.<span class="_ _15"> </span>Can<span class="_ _15"> </span>you<span class="_ _21"> </span>spot<span class="_ _15"> </span>the<span class="_ _15"> </span>race?<span class="_ _21"> </span>Here<span class="_ _15"> </span>is<span class="_ _15"> </span>what<span class="_ _21"> </span>happens<span class="_ _1"></span>.<span class="_ _15"> </span>When<span class="_ _15"> </span>the<span class="_ _15"> </span>main<span class="_ _15"> </span>thread</div><div class="t m5 x1d h26 y8434 ff7 fs19 fc2 sc0 ls0 ws0">creates<span class="_ _15"> </span>a<span class="_ _15"> </span>peer<span class="_ _15"> </span>thread<span class="_ _15"> </span>in<span class="_ _15"> </span>line<span class="_ _21"> </span>13,<span class="_ _21"> </span>it<span class="_ _15"> </span>passes<span class="_ _15"> </span>a<span class="_ _21"> </span>pointer<span class="_ _15"> </span>to<span class="_ _15"> </span>the<span class="_ _15"> </span>local<span class="_ _15"> </span>stack<span class="_ _15"> </span>variable</div><div class="t m5 x1d h26 y8435 ff11 fs19 fc2 sc0 ls0 ws0">i<span class="_ _2"></span><span class="ff7">.<span class="_ _15"> </span>At<span class="_ _14"> </span>this<span class="_ _15"> </span>point,<span class="_ _15"> </span>the<span class="_ _15"> </span>race<span class="_ _14"> </span>is<span class="_ _14"> </span>on<span class="_ _15"> </span>between<span class="_ _14"> </span>the<span class="_ _15"> </span>next<span class="_ _14"> </span>increment<span class="_ _15"> </span>of<span class="_ _14"> </span><span class="ffd">i<span class="_ _15"> </span></span>in<span class="_ _14"> </span>line<span class="_ _15"> </span>12<span class="_ _14"> </span>and</span></div><div class="t m5 x1d h26 y8436 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>dereferencing<span class="_ _11"> </span>and<span class="_ _16"> </span>assignment<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>argument<span class="_ _11"> </span>in<span class="_ _16"> </span>line<span class="_ _16"> </span>22.<span class="_ _11"> </span>If<span class="_ _16"> </span>the<span class="_ _16"> </span>peer<span class="_ _11"> </span>thread</div><div class="t m5 x1d h26 y8437 ff7 fs19 fc2 sc0 ls0 ws0">executes<span class="_ _14"> </span>line<span class="_ _16"> </span>22<span class="_ _14"> </span>before<span class="_ _14"> </span>the<span class="_ _14"> </span>main<span class="_ _14"> </span>thread<span class="_ _14"> </span>increments<span class="_ _14"> </span><span class="ffd">i<span class="_ _14"> </span></span>in<span class="_ _14"> </span>line<span class="_ _14"> </span>12,<span class="_ _14"> </span>then<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">myid</span></div><div class="t m5 x1d h26 y8438 ff7 fs19 fc2 sc0 ls0 ws0">variable<span class="_ _6"> </span>gets<span class="_ _13"> </span>the<span class="_ _6"> </span>correct<span class="_ _13"> </span>ID<span class="_ _3"></span>.<span class="_ _13"> </span>Otherwise<span class="_ _1"></span>,<span class="_ _13"> </span>it<span class="_ _6"> </span>will<span class="_ _13"> </span>contain<span class="_ _6"> </span>the<span class="_ _13"> </span>ID<span class="_ _6"> </span>of<span class="_ _6"> </span>some<span class="_ _13"> </span>other<span class="_ _6"> </span>thread.</div><div class="t m5 x1d h26 y8439 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>scary<span class="_ _14"> </span>thing<span class="_ _16"> </span>is<span class="_ _14"> </span>that<span class="_ _14"> </span>whether<span class="_ _14"> </span>we<span class="_ _16"> </span>get<span class="_ _14"> </span>the<span class="_ _14"> </span>correct<span class="_ _14"> </span>answer<span class="_ _16"> </span>depends<span class="_ _14"> </span>on<span class="_ _14"> </span>how<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y843a ff7 fs19 fc2 sc0 ls0 ws0">kernel<span class="_"> </span>schedules<span class="_ _13"> </span>the<span class="_"> </span>execution<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>threads<span class="_ _3"></span>.<span class="_"> </span>On<span class="_"> </span>our<span class="_ _13"> </span>system<span class="_"> </span>it<span class="_ _13"> </span>fails<span class="_ _0"></span>,<span class="_"> </span>but<span class="_ _13"> </span>on<span class="_"> </span>other</div><div class="t m5 x1d h26 y843b ff7 fs19 fc2 sc0 ls0 ws0">systems<span class="_ _11"> </span>it<span class="_ _16"> </span>might<span class="_ _11"> </span>work<span class="_ _16"> </span>correctly<span class="_ _7"></span>,<span class="_ _16"> </span>leaving<span class="_ _16"> </span>the<span class="_ _11"> </span>programmer<span class="_ _16"> </span>blissfully<span class="_ _11"> </span>unaware<span class="_ _11"> </span>of<span class="_ _16"> </span>a</div><div class="t m5 x1d h26 y843c ff7 fs19 fc2 sc0 ls0 ws0">serious<span class="_"> </span>bug.</div><div class="t m5 x29 h26 y843d ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _11"> </span>eliminate<span class="_ _11"> </span>the<span class="_"> </span>race,<span class="_"> </span>we<span class="_ _11"> </span>can<span class="_"> </span>dynamically<span class="_ _11"> </span>allocate<span class="_ _11"> </span>a<span class="_"> </span>separate<span class="_ _11"> </span>block<span class="_ _11"> </span>for<span class="_"> </span>each</div><div class="t m5 x1d h26 y843e ff7 fs19 fc2 sc0 ls0 ws0">integer<span class="_ _16"> </span>ID<span class="_ _16"> </span>and<span class="_ _16"> </span>pass<span class="_ _16"> </span>the<span class="_ _16"> </span>thread<span class="_ _16"> </span>routine<span class="_ _16"> </span>a<span class="_ _16"> </span>pointer<span class="_ _16"> </span>to<span class="_ _16"> </span>this<span class="_ _16"> </span>block,<span class="_ _16"> </span>as<span class="_ _16"> </span>shown<span class="_ _16"> </span>in<span class="_ _16"> </span>Fig-</div><div class="t m5 x1d h26 y843f ff7 fs19 fc2 sc0 ls0 ws0">ure<span class="_ _13"> </span>12.43<span class="_ _13"> </span>(lines<span class="_ _13"> </span>12â€“14).<span class="_ _13"> </span>Notice<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_ _6"> </span>thread<span class="_ _13"> </span>routine<span class="_ _13"> </span>must<span class="_ _13"> </span>free<span class="_ _13"> </span>the<span class="_ _13"> </span>block<span class="_ _13"> </span>in<span class="_ _13"> </span>order</div><div class="t m5 x1d h26 y8440 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>avoid<span class="_"> </span>a<span class="_"> </span>memory<span class="_"> </span>leak.</div><div class="t m5 x29 h26 y8441 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_"> </span>we<span class="_"> </span>run<span class="_"> </span>this<span class="_"> </span>program<span class="_"> </span>on<span class="_"> </span>our<span class="_"> </span>system,<span class="_"> </span>we<span class="_"> </span>now<span class="_"> </span>get<span class="_"> </span>the<span class="_"> </span>correct<span class="_"> </span>result:</div><div class="t m5 x1d h2d y8442 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">./norace</span></div><div class="t m5 x1d h2d y8443 ffd fs1e fc2 sc0 ls0 ws0">Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>0</div><div class="t m5 x1d h2d y8444 ffd fs1e fc2 sc0 ls0 ws0">Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>1</div><div class="t m5 x1d h2d y8445 ffd fs1e fc2 sc0 ls0 ws0">Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>2</div><div class="t m5 x1d h2d y8446 ffd fs1e fc2 sc0 ls0 ws0">Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>3</div><div class="t m5 x1d h47 y8447 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>12.13<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>1075)</span></div><div class="t m5 x1d h26 y8448 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>12.43,<span class="_"> </span>we<span class="_ _13"> </span>might<span class="_ _13"> </span>be<span class="_ _13"> </span>tempted<span class="_ _13"> </span>to<span class="_ _13"> </span>free<span class="_ _13"> </span>the<span class="_ _13"> </span>allocated<span class="_ _13"> </span>memory<span class="_ _13"> </span>block<span class="_ _13"> </span>immedi-</div><div class="t m5 x1d h26 y8449 ff7 fs19 fc1 sc0 ls0 ws0">ately<span class="_"> </span>after<span class="_"> </span>line<span class="_"> </span>14<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>main<span class="_"> </span>thread,<span class="_"> </span>instead<span class="_"> </span>of<span class="_"> </span>freeing<span class="_"> </span>it<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>peer<span class="_"> </span>thread.<span class="_"> </span>But</div><div class="t m5 x1d h26 y844a ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>would<span class="_"> </span>be<span class="_"> </span>a<span class="_"> </span>bad<span class="_"> </span>idea.<span class="_"> </span>Why?</div><div class="t m5 x1d h47 y12d9 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>12.14<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>1075)</span></div><div class="t m5 x124 h26 y13c0 ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>In<span class="_ _16"> </span>Figure<span class="_ _16"> </span>12.43,<span class="_ _14"> </span>we<span class="_ _16"> </span>eliminated<span class="_ _14"> </span>the<span class="_ _16"> </span>race<span class="_ _14"> </span>by<span class="_ _16"> </span>allocating<span class="_ _14"> </span>a<span class="_ _16"> </span>separate<span class="_ _14"> </span>block<span class="_ _16"> </span>for</div><div class="t m5 x4f h26 y13c1 ff7 fs19 fc1 sc0 ls0 ws0">each<span class="_"> </span>integer<span class="_"> </span>ID<span class="_ _3"></span>.<span class="_ _11"> </span>Outline<span class="_"> </span>a<span class="_"> </span>different<span class="_"> </span>approach<span class="_ _11"> </span>that<span class="_"> </span>does<span class="_"> </span>not<span class="_"> </span>call<span class="_ _11"> </span>the<span class="_"> </span><span class="ffd">malloc</span></div><div class="t m5 x4f h26 y13c2 ff7 fs19 fc1 sc0 ls0 ws0">or<span class="_"> </span><span class="ffd">free<span class="_ _10"> </span></span>functions<span class="_ _1"></span>.</div><div class="t m5 x124 h26 y56f3 ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>What<span class="_"> </span>are<span class="_"> </span>the<span class="_"> </span>advantages<span class="_"> </span>and<span class="_"> </span>disadvantages<span class="_"> </span>of<span class="_"> </span>this<span class="_"> </span>approach?</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
