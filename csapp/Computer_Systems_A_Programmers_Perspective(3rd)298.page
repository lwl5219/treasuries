<div id="pf12a" class="pf w2 h11" data-page-no="12a"><div class="pc pc12a w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg12a.png"/><div class="t m5 xc0 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.8<span class="_ _60"> </span>Array<span class="_ _10"> </span>Allocation<span class="_ _10"> </span>and<span class="_ _10"> </span>Access<span class="_ _3e"> </span><span class="ffe fs1e">297</span></div><div class="t m5 x17 h34 ye7 ff6 fs16 fc2 sc0 ls0 ws0">(a)<span class="_ _10"> </span>Original<span class="_ _11"> </span>C<span class="_ _10"> </span>code</div><div class="t m5 x17 h2d y2283 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Compute<span class="_ _1f"> </span>i,k<span class="_ _1f"> </span>of<span class="_ _e"> </span>fixed<span class="_ _1f"> </span>matrix<span class="_ _e"> </span>product<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y2284 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>fix_prod_ele<span class="_ _1f"> </span>(fix_matrix<span class="_ _1f"> </span>A,<span class="_ _e"> </span>fix_matrix<span class="_ _1f"> </span>B,<span class="_ _e"> </span>long<span class="_ _1f"> </span>i,<span class="_ _1f"> </span>long<span class="_ _e"> </span>k)<span class="_ _1f"> </span>{</div><div class="t m5 x1b6 h2d y2285 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>j;</div><div class="t m5 x1b6 h2d y2286 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>result<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;</div><div class="t m5 x1b6 h2d y2288 ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>j=0<span class="_ _41"></span>;j&lt;N<span class="_ _41"></span>;<span class="ls0">j++)</span></div><div class="t m5 x21e h2d y23a1 ffd fs1e fc2 sc0 ls0 ws0">result<span class="_ _e"> </span>+=<span class="_ _1f"> </span>A[i][j]<span class="_ _1f"> </span>*<span class="_ _e"> </span>B[j][k];</div><div class="t m5 x1b6 h2d y2554 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>result;</div><div class="t m5 x17 h2d y2555 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h34 y2b2c ff6 fs16 fc2 sc0 ls0 ws0">(b)<span class="_ _10"> </span>Optimized<span class="_ _11"> </span>C<span class="_ _10"> </span>code</div><div class="t m5 x2c h2d y228c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Compute<span class="_ _e"> </span>i,k<span class="_ _1f"> </span>of<span class="_ _1f"> </span>fixed<span class="_ _e"> </span>matrix<span class="_ _1f"> </span>product<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h2d y2b2d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>fix_prod_ele_opt(fix_matrix<span class="_ _e"> </span>A,<span class="_ _1f"> </span>fix_matrix<span class="_ _1f"> </span>B,<span class="_ _e"> </span>long<span class="_ _1f"> </span>i,<span class="_ _e"> </span>long<span class="_ _1f"> </span>k)<span class="_ _1f"> </span>{</span></div><div class="t m5 x2c h2d y23a5 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>*Aptr<span class="_ _1f"> </span>=<span class="_ _1f"> </span>&amp;A[i][0];<span class="_ _7b"> </span>/*<span class="_ _1f"> </span>Points<span class="_ _1f"> </span>to<span class="_ _e"> </span>elements<span class="_ _1f"> </span>in<span class="_ _e"> </span>row<span class="_ _1f"> </span>i<span class="_ _1f"> </span>of<span class="_ _e"> </span>A<span class="_ _46"> </span>*/</span></div><div class="t m5 x2c h2d y23a6 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>*Bptr<span class="_ _1f"> </span>=<span class="_ _1f"> </span>&amp;B[0][k];<span class="_ _7b"> </span>/*<span class="_ _1f"> </span>Points<span class="_ _1f"> </span>to<span class="_ _e"> </span>elements<span class="_ _1f"> </span>in<span class="_ _e"> </span>column<span class="_ _1f"> </span>k<span class="_ _1f"> </span>of<span class="_ _e"> </span>B<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y23a7 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>*Bend<span class="_ _1f"> </span>=<span class="_ _1f"> </span>&amp;B[N][k];<span class="_ _7b"> </span>/*<span class="_ _1f"> </span>Marks<span class="_ _1f"> </span>stopping<span class="_ _e"> </span>point<span class="_ _1f"> </span>for<span class="_ _e"> </span>Bptr<span class="_ _6f"> </span>*/</span></div><div class="t m5 x2c h2d y23a8 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>result<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;</span></div><div class="t m5 x2c h2d y23a9 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">do<span class="_ _e"> </span>{<span class="_ _fd"> </span>/*<span class="_ _1f"> </span>No<span class="_ _e"> </span>need<span class="_ _1f"> </span>for<span class="_ _e"> </span>initial<span class="_ _1f"> </span>test<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y29fd ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">result<span class="_ _e"> </span>+=<span class="_ _1f"> </span>*Aptr<span class="_ _1f"> </span>*<span class="_ _e"> </span>*Bptr;<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Add<span class="_ _e"> </span>next<span class="_ _1f"> </span>product<span class="_ _1f"> </span>to<span class="_ _e"> </span>sum<span class="_ _1a"> </span>*/</span></div><div class="t m5 x2c h2d y29fe ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2">Aptr<span class="_ _e"> </span>++;<span class="_ _d9"> </span>/*<span class="_ _1f"> </span>Move<span class="_ _e"> </span>Aptr<span class="_ _1f"> </span>to<span class="_ _e"> </span>next<span class="_ _1f"> </span>column<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y2a05 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">Bptr<span class="_ _e"> </span>+=<span class="_ _1f"> </span>N;<span class="_ _12a"> </span>/*<span class="_ _e"> </span>Move<span class="_ _1f"> </span>Bptr<span class="_ _e"> </span>to<span class="_ _1f"> </span>next<span class="_ _1f"> </span>row<span class="_ _7b"> </span>*/</span></div><div class="t m5 x17 h2d y2a00 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">}<span class="_ _e"> </span>while<span class="_ _1f"> </span>(Bptr<span class="_ _1f"> </span>!=<span class="_ _e"> </span>Bend);<span class="_ _6f"> </span>/*<span class="_ _1f"> </span>Test<span class="_ _1f"> </span>for<span class="_ _e"> </span>stopping<span class="_ _1f"> </span>point<span class="_ _1a"> </span>*/</span></div><div class="t m5 x17 h2d y2a01 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>result;</span></div><div class="t m5 x17 h2d y28f5 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2f y2a2c ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _13"> </span>3.37<span class="_ _66"> </span><span class="fc1">Original<span class="_ _13"> </span>and<span class="_ _6"> </span>optimized<span class="_ _13"> </span>code<span class="_ _13"> </span>to<span class="_ _6"> </span>compute<span class="_ _13"> </span>element<span class="_ _13"> </span><span class="ff11 ls178">i,<span class="_ _6"> </span>k<span class="_ _13"> </span></span>of<span class="_ _13"> </span>matrix<span class="_ _13"> </span>product</span></div><div class="t m5 x17 h34 y2a2d ffe fs16 fc1 sc0 ls0 ws0">for<span class="_"> </span>Ô¨Åxed-length<span class="_"> </span>arrays.<span class="_"> </span><span class="ff6">The<span class="_ _10"> </span>compiler<span class="_ _11"> </span>performs<span class="_ _10"> </span>these<span class="_ _11"> </span>optimizations<span class="_ _10"> </span>automatically<span class="_ _1"></span>.</span></div><div class="t m5 x26 h26 y2b2e ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>following<span class="_ _13"> </span>is<span class="_"> </span>the<span class="_ _13"> </span>actual<span class="_ _13"> </span>assembly<span class="_"> </span>code<span class="_ _13"> </span>generated<span class="_"> </span>by<span class="_ _13"> </span><span class="ff9">gcc<span class="_ _10"> </span></span>for<span class="_ _13"> </span>function<span class="_"> </span><span class="ffd">fix_</span></div><div class="t m5 x17 h26 y2b2f ffd fs19 fc1 sc0 ls0 ws0">prod_ele<span class="ff7">.<span class="_ _13"> </span>W<span class="_ _3"></span>e<span class="_"> </span>see<span class="_ _13"> </span>that<span class="_ _13"> </span>four<span class="_ _13"> </span>registers<span class="_ _13"> </span>are<span class="_"> </span>used<span class="_ _13"> </span>as<span class="_ _13"> </span>follows:<span class="_ _13"> </span><span class="ffd">%eax<span class="_ _13"> </span></span>holds<span class="_"> </span><span class="ffd">result</span>,<span class="_ _13"> </span><span class="ffd">%rdi</span></span></div><div class="t m5 x17 h26 y2b30 ff7 fs19 fc1 sc0 ls0 ws0">holds<span class="_"> </span><span class="ffd">Aptr</span>,<span class="_"> </span><span class="ffd">%rcx<span class="_ _10"> </span></span>holds<span class="_"> </span><span class="ffd">Bptr</span>,<span class="_"> </span>and<span class="_"> </span><span class="ffd">%rsi<span class="_ _10"> </span></span>holds<span class="_"> </span><span class="ffd">Bend</span>.</div><div class="t m5 x2e h61 ye4e ff13 fs35 fc6 sc0 ls0 ws0">int<span class="_ _f"> </span>fix_prod_ele_opt(fix_matrix<span class="_ _f"> </span>A,<span class="_ _f"> </span>fix_matrix<span class="_ _e"> </span>B,<span class="_ _21"> </span>long<span class="_ _f"> </span>i,<span class="_ _e"> </span>long<span class="_ _21"> </span>k)</div><div class="t m5 x2e h61 y2b31 ff13 fs35 fc6 sc0 ls0 ws0">A<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>B<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi,<span class="_ _f"> </span>i<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>k<span class="_ _e"> </span>in<span class="_ _21"> </span>%rcx</div><div class="t m5 x2c h2d y107a ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">fix_prod_ele:</span></div><div class="t m5 x2c h2d yec2 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">salq<span class="_ _46"> </span>$6,<span class="_ _e"> </span>%rdx<span class="_ _16f"> </span></span><span class="ff13 fs35">Compute<span class="_ _f"> </span>64<span class="_ _f"> </span>*<span class="_ _f"> </span>i</span></div><div class="t m5 x2c h2e y561 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 xd1 h2d y5b5 ffd fs1e fc2 sc0 ls0 ws0">addq<span class="_ _46"> </span>%rdx,<span class="_ _e"> </span>%rdi<span class="_ _44"> </span><span class="ff13 fs35 fc6">Compute<span class="_ _e"> </span>Aptr<span class="_ _21"> </span>=<span class="_ _f"> </span><span class="ff11">x</span></span></div><div class="t m5 x1bb h7d y2b32 ffd fs45 fc6 sc0 ls0 ws0">A</div><div class="t m5 x170 h7e y5b5 ff12 fs35 fc6 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">64<span class="ff11">i<span class="_ _e"> </span><span class="ff13">=<span class="_ _f"> </span>&amp;A[i][0]</span></span></span></div><div class="t m5 x2c h2d y2578 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">leaq<span class="_ _46"> </span>(%rsi,%rcx,4),<span class="_ _e"> </span>%rcx<span class="_ _3f"> </span></span><span class="ff13 fs35">Compute<span class="_ _e"> </span>Bptr<span class="_ _21"> </span>=<span class="_ _f"> </span><span class="ff11">x</span></span></div><div class="t m5 x1bb h7d y2b33 ffd fs45 fc6 sc0 ls0 ws0">B</div><div class="t m5 x170 h7e y2578 ff12 fs35 fc6 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">4<span class="ff11">k<span class="_ _e"> </span><span class="ff13">=<span class="_ _21"> </span>&amp;B[0][k]</span></span></span></div><div class="t m5 x2c h2d y1204 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">leaq<span class="_ _46"> </span>1024(%rcx),<span class="_ _e"> </span>%rsi<span class="_ _b9"> </span></span><span class="ff13 fs35">Compute<span class="_ _21"> </span>Bend<span class="_ _e"> </span>=<span class="_ _21"> </span><span class="ff11">x</span></span></div><div class="t m5 x1bb h7d y2b34 ffd fs45 fc6 sc0 ls0 ws0">B</div><div class="t m5 x170 h7e y1204 ff12 fs35 fc6 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">4<span class="ff11">k<span class="_ _13"> </span></span></span>+<span class="_ _13"> </span><span class="ff7">1024<span class="_ _21"> </span><span class="ff13">=<span class="_ _e"> </span>&amp;B[N][k]</span></span></div><div class="t m5 x2c h2d ye93 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">movl<span class="_ _46"> </span>$0,<span class="_ _e"> </span>%eax<span class="_ _16f"> </span></span><span class="ff13 fs35">Set<span class="_ _f"> </span>result<span class="_ _f"> </span>=<span class="_ _f"> </span>0</span></div><div class="t m5 x2c h2e y832 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x2d h2d yd16 ffd fs1e fc2 sc0 ls0 ws0">.L7:<span class="_ _fd"> </span><span class="ff2d fs35 fc6">loop<span class="ff13">:</span></span></div><div class="t m5 x2c h2d yb04 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">movl<span class="_ _46"> </span>(%rdi),<span class="_ _e"> </span>%edx<span class="_ _86"> </span></span><span class="ff13 fs35">Read<span class="_ _e"> </span>*Aptr</span></div><div class="t m5 x2c h2d y6e1 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _45"> </span><span class="ffd fs1e fc2">imull<span class="_ _3f"> </span>(%rcx),<span class="_ _e"> </span>%edx<span class="_ _86"> </span></span><span class="ff13 fs35">Multiply<span class="_ _e"> </span>by<span class="_ _21"> </span>*Bptr</span></div><div class="t m5 x17 h2d y271e ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _45"> </span><span class="ffd fs1e fc2">addl<span class="_ _46"> </span>%edx,<span class="_ _e"> </span>%eax<span class="_ _44"> </span></span><span class="ff13 fs35">Add<span class="_ _e"> </span>to<span class="_ _21"> </span>result</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
