<div id="pf325" class="pf w2 h11" data-page-no="325"><div class="pc pc325 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg325.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">804<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 x126 h2d y6945 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</div><div class="t m5 x126 h2d y6946 ffd fs1e fc2 sc0 ls0 ws0">ssize_t<span class="_ _e"> </span>sio_putl(long<span class="_ _1f"> </span>v);</div><div class="t m5 x126 h2d y6947 ffd fs1e fc2 sc0 ls0 ws0">ssize_t<span class="_ _e"> </span>sio_puts(char<span class="_ _1f"> </span>s[]);</div><div class="t m5 x15 hf2 y6948 ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>number<span class="_"> </span>of<span class="_"> </span>bytes<span class="_"> </span>transferred<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span><span class="ff12">âˆ’</span>1<span class="_ _13"> </span>on<span class="_"> </span>error</div><div class="t m5 x126 h2d y6949 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>sio_error(char<span class="_ _1f"> </span>s[]);</div><div class="t m5 x46 hf1 y694a ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>nothing</div><div class="t m5 xcd h26 y694b ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">sio_putl<span class="_ _11"> </span><span class="ff7">and<span class="_ _11"> </span></span>sio_puts<span class="_ _11"> </span><span class="ff7">functions<span class="_ _11"> </span>emit<span class="_ _11"> </span>a<span class="_ _11"> </span></span>long<span class="_ _11"> </span><span class="ff7">and<span class="_ _11"> </span>a<span class="_ _11"> </span>string,<span class="_ _11"> </span>respec-</span></span></div><div class="t m5 xcd h26 y694c ff7 fs19 fc2 sc0 ls0 ws0">tively<span class="_ _3"></span>,<span class="_ _16"> </span>to<span class="_ _11"> </span>standard<span class="_ _16"> </span>output.<span class="_ _11"> </span>The<span class="_"> </span><span class="ffd">sio_error<span class="_ _16"> </span></span>function<span class="_ _16"> </span>prints<span class="_ _11"> </span>an<span class="_ _16"> </span>error<span class="_ _11"> </span>mes-</div><div class="t m5 xcd h26 y694d ff7 fs19 fc2 sc0 ls0 ws0">sage<span class="_"> </span>and<span class="_"> </span>terminates<span class="_ _1"></span>.</div><div class="t m5 x1c6 h26 y694e ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>8.34<span class="_ _13"> </span>shows<span class="_ _13"> </span>the<span class="_ _13"> </span>implementation<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ff9">Sio<span class="_ _13"> </span></span>package,<span class="_ _13"> </span>which<span class="_ _13"> </span>uses</div><div class="t m5 xcd h26 y694f ff7 fs19 fc2 sc0 ls0 ws0">two<span class="_"> </span>private<span class="_ _13"> </span>reentrant<span class="_"> </span>functions<span class="_"> </span>from<span class="_"> </span><span class="ffd">csapp.c</span><span class="ls289">.T<span class="_ _49"></span>h<span class="_ _4a"></span>e<span class="ffd ls0">sio_strlen<span class="_ _10"> </span><span class="ff7">function</span></span></span></div><div class="t m5 xcd h26 y6950 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_"> </span>line<span class="_ _11"> </span>3<span class="_"> </span>returns<span class="_ _11"> </span>the<span class="_ _11"> </span>length<span class="_"> </span>of<span class="_ _11"> </span>string<span class="_ _11"> </span><span class="ffd">s</span><span class="ls28a">.T<span class="_ _49"></span>h<span class="_ _49"></span>e<span class="ffd ls0">sio_ltoa<span class="_ _10"> </span><span class="ff7">function<span class="_ _11"> </span>in<span class="_ _11"> </span>line<span class="_"> </span>10,</span></span></span></div><div class="t m5 xcd h26 y6951 ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_ _16"> </span>is<span class="_ _14"> </span>based<span class="_ _16"> </span>on<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">itoa<span class="_ _16"> </span></span>function<span class="_ _14"> </span>from<span class="_ _16"> </span>[61],<span class="_ _15"> </span>converts<span class="_ _16"> </span><span class="ffd">v<span class="_ _14"> </span></span>to<span class="_ _14"> </span>its<span class="_ _16"> </span>base<span class="_ _14"> </span><span class="ffd">b</span></div><div class="t m5 xcd h26 y6952 ff7 fs19 fc2 sc0 ls0 ws0">string<span class="_ _13"> </span>representation<span class="_ _6"> </span>in<span class="_ _13"> </span><span class="ffd">s</span><span class="ls28b">.T<span class="_ _4a"></span>h<span class="_ _8"></span>e<span class="ffd ls0">_exit<span class="_ _13"> </span><span class="ff7">function<span class="_ _13"> </span>in<span class="_ _6"> </span>line<span class="_ _13"> </span>17<span class="_ _6"> </span>is<span class="_ _13"> </span>an<span class="_ _13"> </span>async-signal-</span></span></span></div><div class="t m5 xcd h26 y6953 ff7 fs19 fc2 sc0 ls0 ws0">safe<span class="_"> </span>variant<span class="_"> </span>of<span class="_"> </span><span class="ffd">exit</span>.</div><div class="t m5 x1c6 h26 y6954 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>8.35<span class="_ _15"> </span>shows<span class="_ _14"> </span>a<span class="_ _14"> </span>safe<span class="_ _14"> </span>version<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>SIGINT<span class="_ _14"> </span>handler<span class="_ _14"> </span>from<span class="_ _14"> </span>Fig-</div><div class="t m5 xcd h26 y6955 ff7 fs19 fc2 sc0 ls0 ws0">ure<span class="_"> </span>8.30.</div><div class="t m5 x23a h26 y6956 ffa fs19 fc2 sc0 ls0 ws0">G2.<span class="_"> </span>Save<span class="_"> </span>and<span class="_ _11"> </span>restore<span class="_"> </span><span class="ffd">errno</span>.<span class="_ _21"> </span><span class="ff7">Many<span class="_ _11"> </span>of<span class="_"> </span>the<span class="_"> </span>Linux<span class="_ _11"> </span>async-signal-safe<span class="_"> </span>functions<span class="_ _11"> </span>set</span></div><div class="t m5 xcd h26 y6957 ffd fs19 fc2 sc0 ls0 ws0">errno<span class="_ _15"> </span><span class="ff7">when<span class="_ _15"> </span>they<span class="_ _15"> </span>return<span class="_ _15"> </span>with<span class="_ _15"> </span>an<span class="_ _15"> </span>error.<span class="_ _14"> </span>Calling<span class="_ _15"> </span>such<span class="_ _15"> </span>functions<span class="_ _15"> </span>inside<span class="_ _15"> </span>a</span></div><div class="t m5 xcd h26 y6958 ff7 fs19 fc2 sc0 ls0 ws0">handler<span class="_ _6"> </span>might<span class="_ _6"> </span>interfere<span class="_ _6"> </span>with<span class="_ _6"> </span>other<span class="_ _6"> </span>parts<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _6"> </span>program<span class="_ _6"> </span>that<span class="_ _6"> </span>rely<span class="_ _6"> </span>on<span class="_ _6"> </span><span class="ffd">errno</span>.</div><div class="t m5 x16b h2c y6959 ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x1f h88 y695a ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">ssize_t<span class="_ _e"> </span>sio_puts(char<span class="_ _e"> </span>s[])<span class="_ _f"> </span>/*<span class="_ _e"> </span>Put<span class="_ _e"> </span>string<span class="_ _f"> </span>*/</span></div><div class="t m5 x1f h88 y695b ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x1f h88 y695c ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _e2"> </span><span class="ffd fs4e fc2">return<span class="_ _e"> </span>write(STDOUT_FILENO,<span class="_ _e"> </span>s,<span class="_ _f"> </span>sio_strlen(s));</span></div><div class="t m5 x1f h88 y695d ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1f h2e y695e ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x1f h2e y695f ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x4f h88 y6845 ffd fs4e fc2 sc0 ls0 ws0">ssize_t<span class="_ _e"> </span>sio_putl(long<span class="_ _f"> </span>v)<span class="_ _e"> </span>/*<span class="_ _e"> </span>Put<span class="_ _f"> </span>long<span class="_ _e"> </span>*/</div><div class="t m5 x1f h88 y6960 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x1f h88 y6961 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _e2"> </span><span class="ffd fs4e fc2">char<span class="_ _e"> </span>s[128];</span></div><div class="t m5 x1f h2e y6962 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1b0 h2e y6963 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x1b7 h88 y6964 ffd fs4e fc2 sc0 ls0 ws0">sio_ltoa(v,<span class="_ _e"> </span>s,<span class="_ _f"> </span>10);<span class="_ _e"> </span>/*<span class="_ _e"> </span>Based<span class="_ _f"> </span>on<span class="_ _e"> </span>K&amp;R<span class="_ _e"> </span>itoa()<span class="_ _f"> </span>*/</div><div class="t m5 x1b0 h88 y6965 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _e2"> </span><span class="ffd fs4e fc2">return<span class="_ _e"> </span>sio_puts(s);</span></div><div class="t m5 x1b0 h2e y4af ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x4f h88 y2606 ffd fs4e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1b0 h2e y6966 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x1b0 h2e y6967 ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x4f h88 y6968 ffd fs4e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>sio_error(char<span class="_ _f"> </span>s[])<span class="_ _e"> </span>/*<span class="_ _e"> </span>Put<span class="_ _f"> </span>error<span class="_ _e"> </span>message<span class="_ _e"> </span>and<span class="_ _f"> </span>exit<span class="_ _e"> </span>*/</div><div class="t m5 x1b0 h88 y6969 ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x1b0 h88 y696a ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _e2"> </span><span class="ffd fs4e fc2">sio_puts(s);</span></div><div class="t m5 x1b0 h88 y696b ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _e2"> </span><span class="ffd fs4e fc2">_exit(1);</span></div><div class="t m5 x1b0 h88 y68a6 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x16b h2c y68a7 ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x1d h2f y68a8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>8.34<span class="_ _66"> </span><span class="fc1">The<span class="_"> </span><span class="ff1b">Sio<span class="_ _11"> </span></span>(Safe<span class="_"> </span>I/O)<span class="_"> </span>package<span class="_"> </span>for<span class="_"> </span>signal<span class="_"> </span>handlers.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
