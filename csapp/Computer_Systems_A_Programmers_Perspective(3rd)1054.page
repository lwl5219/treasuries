<div id="pf41e" class="pf w2 h11" data-page-no="41e"><div class="pc pc41e w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg41e.png"/><div class="t m5 x250 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.6<span class="_ _60"> </span>Using<span class="_ _10"> </span>Threads<span class="_ _10"> </span>for<span class="_ _10"> </span>Parallelism<span class="_ _3e"> </span><span class="ffe fs1e">1053</span></div><div class="t m5 x26 h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _13"> </span>we<span class="_"> </span>run<span class="_"> </span><span class="ffd">psum-array<span class="_ _13"> </span></span>on<span class="_"> </span>our<span class="_ _13"> </span>four<span class="_ _1"></span>-core<span class="_"> </span>system,<span class="_"> </span>we<span class="_ _13"> </span>see<span class="_"> </span>that<span class="_"> </span>it<span class="_ _13"> </span>runs<span class="_"> </span>orders</div><div class="t m5 x17 h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>magnitude<span class="_"> </span>faster<span class="_"> </span>than<span class="_"> </span><span class="ffd">psum-mutex</span>:</div><div class="t m5 x21d h31 y831b ff7 fs21 fc2 sc0 ls0 ws0">Number<span class="_"> </span>of<span class="_"> </span>threads</div><div class="t m5 x17 h31 y831c ff7 fs21 fc2 sc0 ls0 ws0">V<span class="_ _3"></span>ersion<span class="_ _14c"> </span><span class="ls2f9">1248<span class="_ _80"></span>1<span class="_ _23c"></span>6</span></div><div class="t m5 x17 h31 y831d ffd fs1e fc2 sc0 ls0 ws0">psum-mutex<span class="_ _93"> </span><span class="ff7 fs21">68.00<span class="_ _46"> </span>432.00<span class="_ _1f9"> </span>719.00<span class="_ _46"> </span>552.00<span class="_ _46"> </span>599.00</span></div><div class="t m5 x17 h2d y831e ffd fs1e fc2 sc0 ls0 ws0">psum-array</div><div class="t m5 x177 h31 y831f ff7 fs21 fc2 sc0 ls0 ws0">7.26<span class="_ _28"> </span>3.64<span class="_ _11a"> </span>1.91<span class="_ _28"> </span>1.85<span class="_ _28"> </span>1.84</div><div class="t m5 x26 h26 y8320 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_"> </span>Chapter<span class="_"> </span>5,<span class="_"> </span>we<span class="_ _13"> </span>learned<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>use<span class="_"> </span>local<span class="_"> </span>variables<span class="_ _13"> </span>to<span class="_"> </span>eliminate<span class="_"> </span>unnecessary</div><div class="t m5 x17 h26 y8321 ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_ _13"> </span>references<span class="_ _1"></span>.<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>12.34<span class="_"> </span>shows<span class="_ _13"> </span>how<span class="_ _13"> </span>we<span class="_ _13"> </span>can<span class="_"> </span>apply<span class="_ _13"> </span>this<span class="_ _13"> </span>principle<span class="_ _13"> </span>by<span class="_"> </span>having</div><div class="t m5 x17 h26 y8322 ff7 fs19 fc2 sc0 ls0 ws0">each<span class="_ _21"> </span>peer<span class="_ _f"> </span>thread<span class="_ _f"> </span>accumulate<span class="_ _f"> </span>its<span class="_ _f"> </span>partial<span class="_ _f"> </span>sum<span class="_ _f"> </span>into<span class="_ _f"> </span>a<span class="_ _f"> </span>local<span class="_ _f"> </span>variable<span class="_ _f"> </span>rather<span class="_ _f"> </span>than</div><div class="t m5 x17 h26 y8323 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _14"> </span>global<span class="_ _14"> </span>variable.<span class="_ _14"> </span>When<span class="_ _16"> </span>we<span class="_ _15"> </span>run<span class="_ _14"> </span><span class="ffd">psum-local<span class="_ _14"> </span></span>on<span class="_ _15"> </span>our<span class="_ _14"> </span>four<span class="_ _1"></span>-core<span class="_ _15"> </span>machine<span class="_ _1"></span>,<span class="_ _21"> </span>we<span class="_ _14"> </span>get</div><div class="t m5 x17 h26 y8324 ff7 fs19 fc2 sc0 ls0 ws0">another<span class="_"> </span>order<span class="_ _1"></span>-of-magnitude<span class="_"> </span>decrease<span class="_"> </span>in<span class="_"> </span>running<span class="_"> </span>time:</div><div class="t m5 x21d h31 y8325 ff7 fs21 fc2 sc0 ls0 ws0">Number<span class="_"> </span>of<span class="_"> </span>threads</div><div class="t m5 x17 h31 y8326 ff7 fs21 fc2 sc0 ls0 ws0">V<span class="_ _3"></span>ersion<span class="_ _14c"> </span><span class="ls2f9">1248<span class="_ _80"></span>1<span class="_ _23c"></span>6</span></div><div class="t m5 x17 h31 y8327 ffd fs1e fc2 sc0 ls0 ws0">psum-mutex<span class="_ _93"> </span><span class="ff7 fs21">68.00<span class="_ _46"> </span>432.00<span class="_ _1f9"> </span>719.00<span class="_ _46"> </span>552.00<span class="_ _46"> </span>599.00</span></div><div class="t m5 x17 h2d y8328 ffd fs1e fc2 sc0 ls0 ws0">psum-array</div><div class="t m5 x177 h31 y8329 ff7 fs21 fc2 sc0 ls0 ws0">7.26<span class="_ _28"> </span>3.64<span class="_ _11a"> </span>1.91<span class="_ _28"> </span>1.85<span class="_ _28"> </span>1.84</div><div class="t m5 x17 h31 y832a ffd fs1e fc2 sc0 ls0 ws0">psum-local<span class="_ _62"> </span><span class="ff7 fs21">1.06<span class="_ _28"> </span>0.54<span class="_ _11a"> </span>0.28<span class="_ _28"> </span>0.29<span class="_ _28"> </span>0.30</span></div><div class="t m5 x1c1 h2c y832b ffa fs16 fc2 sc0 ls0 ws0">code/conc/psum-local.c</div><div class="t m5 x2c h88 y832c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">/*<span class="_ _e"> </span>Thread<span class="_ _e"> </span>routine<span class="_ _f"> </span>for<span class="_ _e"> </span>psum-local.c<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h88 y832d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>*sum_local(void<span class="_ _e"> </span>*vargp)</span></div><div class="t m5 x2c h88 y832e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x2c h88 y832f ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>myid<span class="_ _e"> </span>=<span class="_ _f"> </span>*((long<span class="_ _e"> </span>*)vargp);<span class="_ _c0"> </span>/*<span class="_ _e"> </span>Extract<span class="_ _f"> </span>the<span class="_ _e"> </span>thread<span class="_ _e"> </span>ID<span class="_ _f"> </span>*/</span></div><div class="t m5 x2c h88 y8330 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>start<span class="_ _e"> </span>=<span class="_ _f"> </span>myid<span class="_ _e"> </span>*<span class="_ _e"> </span>nelems_per_thread;<span class="_ _f"> </span>/*<span class="_ _e"> </span>Start<span class="_ _e"> </span>element<span class="_ _f"> </span>index<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h88 y8331 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>end<span class="_ _e"> </span>=<span class="_ _f"> </span>start<span class="_ _e"> </span>+<span class="_ _e"> </span>nelems_per_thread;<span class="_ _ea"> </span>/*<span class="_ _e"> </span>End<span class="_ _f"> </span>element<span class="_ _e"> </span>index<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h88 y8332 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>i,<span class="_ _e"> </span>sum<span class="_ _f"> </span>=<span class="_ _e"> </span>0;</span></div><div class="t m5 x2c h2e y8333 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x2c h2e y8334 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1a0 h88 y8335 ffd fs4e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _f"> </span>=<span class="_ _e"> </span>start;<span class="_ _e"> </span>i<span class="_ _f"> </span>&lt;<span class="_ _e"> </span>end;<span class="_ _e"> </span>i++)<span class="_ _f"> </span>{</div><div class="t m5 x17 h88 y8336 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _18b"> </span><span class="ffd fs4e fc2">sum<span class="_ _e"> </span>+=<span class="_ _f"> </span>i;</span></div><div class="t m5 x17 h88 y8337 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h88 y8338 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _e2"> </span><span class="ffd fs4e fc2">psum[myid]<span class="_ _e"> </span>=<span class="_ _e"> </span>sum;</span></div><div class="t m5 x17 h88 y8339 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _e2"> </span><span class="ffd fs4e fc2">return<span class="_ _e"> </span>NULL;</span></div><div class="t m5 x17 h88 y833a ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1c1 h2c y833b ffa fs16 fc2 sc0 ls0 ws0">code/conc/psum-local.c</div><div class="t m5 x17 h2f y833c ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>12.34<span class="_ _c"> </span><span class="fc1">Thread<span class="_ _14"> </span>routine<span class="_ _14"> </span>for</span></div><div class="t m5 x5d h3a y833d ffd fs19 fc1 sc0 ls0 ws0">psum-local<span class="ffe fs16">.<span class="_ _16"> </span><span class="ff6">Each<span class="_ _14"> </span>peer<span class="_ _14"> </span>thread<span class="_ _14"> </span>accumulates<span class="_ _16"> </span>its<span class="_ _14"> </span>partial<span class="_ _14"> </span>sum<span class="_ _16"> </span>in<span class="_ _14"> </span>a<span class="_ _14"> </span>local</span></span></div><div class="t m5 x17 h34 y833e ff6 fs16 fc1 sc0 ls0 ws0">variable.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
