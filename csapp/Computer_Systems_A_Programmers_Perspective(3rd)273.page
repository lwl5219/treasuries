<div id="pf111" class="pf w2 h11" data-page-no="111"><div class="pc pc111 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg111.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">272<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hese<span class="_"> </span>declarations<span class="_ _13"> </span>state<span class="_"> </span>that<span class="_ _13"> </span>within<span class="_ _13"> </span>the<span class="_"> </span>segment<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>object-code<span class="_ _13"> </span>ﬁle<span class="_"> </span>called</div><div class="t m5 x1d h26 y2a7 ffd fs19 fc2 sc0 ls0 ws0">.rodata<span class="_ _11"> </span><span class="ff7">(for<span class="_"> </span>“read-only<span class="_ _11"> </span>data”),<span class="_ _16"> </span>there<span class="_"> </span>should<span class="_ _11"> </span>be<span class="_ _11"> </span>a<span class="_ _11"> </span>sequence<span class="_ _11"> </span>of<span class="_ _11"> </span>seven<span class="_ _11"> </span>“quad”<span class="_ _11"> </span>(8-</span></div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">byte)<span class="_ _14"> </span>words<span class="_ _0"></span>,<span class="_ _15"> </span>where<span class="_ _15"> </span>the<span class="_ _15"> </span>value<span class="_ _15"> </span>of<span class="_ _14"> </span>each<span class="_ _15"> </span>word<span class="_ _15"> </span>is<span class="_ _15"> </span>given<span class="_ _15"> </span>by<span class="_ _14"> </span>the<span class="_ _15"> </span>instruction<span class="_ _15"> </span>address</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">associated<span class="_ _16"> </span>with<span class="_ _16"> </span>the<span class="_ _16"> </span>indicated<span class="_ _16"> </span>assembly-code<span class="_ _16"> </span>labels<span class="_ _16"> </span>(e.g<span class="_ _1"></span>.,<span class="_ _14"> </span><span class="ffd">.L3</span>).<span class="_ _16"> </span>Label<span class="_ _16"> </span><span class="ffd">.L4<span class="_ _16"> </span></span>marks</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>start<span class="_ _14"> </span>of<span class="_ _14"> </span>this<span class="_ _15"> </span>allocation.<span class="_ _14"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>address<span class="_ _14"> </span>associated<span class="_ _14"> </span>with<span class="_ _15"> </span>this<span class="_ _14"> </span>label<span class="_ _14"> </span>serves<span class="_ _15"> </span>as<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">base<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>indirect<span class="_"> </span>jump<span class="_"> </span>(line<span class="_"> </span>5).</div><div class="t m5 x29 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>different<span class="_ _11"> </span>code<span class="_ _16"> </span>blocks<span class="_ _16"> </span>(C<span class="_ _11"> </span>labels<span class="_ _16"> </span><span class="ffd">loc_A<span class="_ _11"> </span></span>through<span class="_ _16"> </span><span class="ffd">loc_D<span class="_ _11"> </span></span>and<span class="_ _16"> </span><span class="ffd">loc_def</span>)<span class="_ _11"> </span>im-</div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">plement<span class="_ _14"> </span>the<span class="_ _15"> </span>different<span class="_ _15"> </span>branches<span class="_ _15"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span><span class="ffd">switch<span class="_ _14"> </span></span>statement.<span class="_ _15"> </span>Most<span class="_ _15"> </span>of<span class="_ _15"> </span>them<span class="_ _15"> </span>simply</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">compute<span class="_ _14"> </span>a<span class="_ _14"> </span>value<span class="_ _14"> </span>for<span class="_ _14"> </span><span class="ffd">val<span class="_ _14"> </span></span>and<span class="_ _14"> </span>then<span class="_ _15"> </span>go<span class="_ _14"> </span>to<span class="_ _14"> </span>the<span class="_ _14"> </span>end<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>function.<span class="_ _15"> </span>Similarly<span class="_ _3"></span>,<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">assembly-code<span class="_"> </span>blocks<span class="_ _13"> </span>compute<span class="_"> </span>a<span class="_"> </span>value<span class="_ _13"> </span>for<span class="_"> </span>register<span class="_"> </span><span class="ffd">%rdi<span class="_ _13"> </span></span>and<span class="_"> </span>jump<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>position</div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">indicated<span class="_"> </span>by<span class="_ _13"> </span>label<span class="_"> </span><span class="ffd">.L2<span class="_ _10"> </span></span>at<span class="_"> </span>the<span class="_ _13"> </span>end<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>function.<span class="_"> </span>Only<span class="_"> </span>the<span class="_ _13"> </span>code<span class="_"> </span>for<span class="_"> </span>case<span class="_ _13"> </span>label<span class="_"> </span>102</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">does<span class="_ _16"> </span>not<span class="_ _14"> </span>follow<span class="_ _14"> </span>this<span class="_ _14"> </span>pattern,<span class="_ _14"> </span>to<span class="_ _14"> </span>account<span class="_ _14"> </span>for<span class="_ _14"> </span>the<span class="_ _14"> </span>way<span class="_ _16"> </span>the<span class="_ _14"> </span>code<span class="_ _14"> </span>for<span class="_ _14"> </span>this<span class="_ _14"> </span>case<span class="_ _16"> </span>falls</div><div class="t m5 x1d h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">through<span class="_"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span>block<span class="_ _11"> </span>with<span class="_ _11"> </span>label<span class="_ _11"> </span>103<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>original<span class="_ _11"> </span>C<span class="_ _11"> </span>code<span class="_ _0"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>his<span class="_ _11"> </span>is<span class="_ _11"> </span>handled<span class="_ _11"> </span>in<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">assembly-code<span class="_ _14"> </span>block<span class="_ _16"> </span>starting<span class="_ _14"> </span>with<span class="_ _14"> </span>label<span class="_ _14"> </span><span class="ffd">.L5</span>,<span class="_ _15"> </span>by<span class="_ _14"> </span>omitting<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">jmp<span class="_ _16"> </span></span>instruction<span class="_ _14"> </span>at</div><div class="t m5 x1d h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>end<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>block,<span class="_ _13"> </span>so<span class="_ _13"> </span>that<span class="_"> </span>the<span class="_ _13"> </span>code<span class="_"> </span>continues<span class="_ _13"> </span>execution<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>next<span class="_ _13"> </span>block.<span class="_"> </span>Simi-</div><div class="t m5 x1d h26 y451 ff7 fs19 fc2 sc0 ls0 ws0">larly<span class="_ _3"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>C<span class="_ _6"> </span>version<span class="_ _13"> </span><span class="ffd">switch_eg_impl<span class="_ _13"> </span></span>has<span class="_ _13"> </span>no<span class="_ _6"> </span><span class="ffd">goto<span class="_ _13"> </span></span>statement<span class="_ _13"> </span>at<span class="_ _13"> </span>the<span class="_ _6"> </span>end<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>block</div><div class="t m5 x1d h26 y452 ff7 fs19 fc2 sc0 ls0 ws0">starting<span class="_"> </span>with<span class="_"> </span>label<span class="_"> </span><span class="ffd">loc_B</span>.</div><div class="t m5 x29 h26 y453 ff7 fs19 fc2 sc0 ls0 ws0">Examining<span class="_ _11"> </span>all<span class="_ _16"> </span>of<span class="_ _11"> </span>this<span class="_ _11"> </span>code<span class="_ _11"> </span>requires<span class="_ _16"> </span>careful<span class="_ _11"> </span>study<span class="_ _3"></span>,<span class="_ _16"> </span>but<span class="_ _11"> </span>the<span class="_ _11"> </span>key<span class="_ _16"> </span>point<span class="_ _11"> </span>is<span class="_ _11"> </span>to<span class="_ _16"> </span>see</div><div class="t m5 x1d h26 y454 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_"> </span>the<span class="_ _11"> </span>use<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_ _11"> </span>jump<span class="_ _11"> </span>table<span class="_"> </span>allows<span class="_ _11"> </span>a<span class="_ _11"> </span>very<span class="_ _11"> </span>efﬁcient<span class="_ _11"> </span>way<span class="_ _11"> </span>to<span class="_"> </span>implement<span class="_ _11"> </span>a<span class="_ _11"> </span>multiway</div><div class="t m5 x1d h26 y455 ff7 fs19 fc2 sc0 ls0 ws0">branch.<span class="_ _14"> </span>In<span class="_ _14"> </span>our<span class="_ _15"> </span>case<span class="_ _0"></span>,<span class="_ _15"> </span>the<span class="_ _14"> </span>program<span class="_ _15"> </span>could<span class="_ _14"> </span>branch<span class="_ _15"> </span>to<span class="_ _14"> </span>ﬁve<span class="_ _14"> </span>distinct<span class="_ _15"> </span>locations<span class="_ _14"> </span>with<span class="_ _15"> </span>a</div><div class="t m5 x1d h26 y456 ff7 fs19 fc2 sc0 ls0 ws0">single<span class="_"> </span>jump<span class="_"> </span>table<span class="_ _13"> </span>reference.<span class="_ _13"> </span>Even<span class="_"> </span>if<span class="_"> </span>we<span class="_"> </span>had<span class="_ _13"> </span>a<span class="_"> </span><span class="ffd">switch<span class="_ _10"> </span></span>statement<span class="_"> </span>with<span class="_"> </span>hundreds<span class="_ _13"> </span>of</div><div class="t m5 x1d h26 y457 ff7 fs19 fc2 sc0 ls0 ws0">cases<span class="_ _1"></span>,<span class="_"> </span>they<span class="_"> </span>could<span class="_"> </span>be<span class="_"> </span>handled<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>single<span class="_"> </span>jump<span class="_"> </span>table<span class="_"> </span>access<span class="_ _1"></span>.</div><div class="t m5 x1d h47 y28a1 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>3.30<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>374)</span></div><div class="t m5 x1d h26 y28a2 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _13"> </span>the<span class="_ _13"> </span>C<span class="_ _13"> </span>function<span class="_"> </span>that<span class="_ _13"> </span>follows<span class="_ _3"></span>,<span class="_"> </span>we<span class="_ _13"> </span>have<span class="_ _13"> </span>omitted<span class="_ _13"> </span>the<span class="_ _13"> </span>body<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">switch<span class="_ _13"> </span></span>statement.</div><div class="t m5 x1d h26 y28a3 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _13"> </span>the<span class="_ _13"> </span>C<span class="_ _13"> </span>code,<span class="_ _13"> </span>the<span class="_ _13"> </span>case<span class="_ _13"> </span>labels<span class="_ _13"> </span>did<span class="_ _13"> </span>not<span class="_"> </span>span<span class="_ _13"> </span>a<span class="_ _13"> </span>contiguous<span class="_ _13"> </span>range<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _13"> </span>some<span class="_ _13"> </span>cases<span class="_ _13"> </span>had</div><div class="t m5 x1d h26 y28a4 ff7 fs19 fc1 sc0 ls0 ws0">multiple<span class="_"> </span>labels<span class="_ _1"></span>.</div><div class="t m5 x1d h2d y28a5 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>switch2(short<span class="_ _1f"> </span>x,<span class="_ _1f"> </span>short<span class="_ _e"> </span>*dest)<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y28a6 ffd fs1e fc2 sc0 ls0 ws0">short<span class="_ _e"> </span>val<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;</div><div class="t m5 x10c h2d y28a7 ffd fs1e fc2 sc0 ls0 ws0">switch<span class="_ _e"> </span>(x)<span class="_ _1f"> </span>{</div><div class="t m5 x22b h2d y28a8 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x22b h2d y28a9 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x22b h2d y28aa ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x129 h53 y28ab ffa fs1e fc2 sc0 ls0 ws0">Body<span class="_"> </span>of<span class="_"> </span>switch<span class="_"> </span>statement<span class="_"> </span>omitted</div><div class="t m5 x10c h2d y28ac ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x10c h2d y28ad ffd fs1e fc2 sc0 ls0 ws0">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>val;</div><div class="t m5 x1d h2d y28ae ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x29 h26 y28af ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _11"> </span>compiling<span class="_ _16"> </span>the<span class="_ _16"> </span>function,<span class="_ _16"> </span><span class="ff9">gcc<span class="_ _11"> </span></span>generates<span class="_ _16"> </span>the<span class="_ _11"> </span>assembly<span class="_ _16"> </span>code<span class="_ _11"> </span>that<span class="_ _16"> </span>follows<span class="_ _16"> </span>for</div><div class="t m5 x1d h26 y28b0 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>initial<span class="_"> </span>part<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>procedure<span class="_ _1"></span>,<span class="_"> </span>with<span class="_"> </span>variable<span class="_"> </span><span class="ffd">x<span class="_ _11"> </span></span>in<span class="_"> </span><span class="ffd">%rdi</span>:</div><div class="t m5 xad h61 y107b ff13 fs35 fc6 sc0 ls0 ws0">void<span class="_ _f"> </span>switch2(short<span class="_ _f"> </span>x,<span class="_ _f"> </span>short<span class="_ _e"> </span>*dest)</div><div class="t m5 xad h61 y28b1 ff13 fs35 fc6 sc0 ls0 ws0">x<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi</div><div class="t m5 x1f h2e y587 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x4f h2d y832 ffd fs1e fc2 sc0 ls0 ws0">switch2:</div><div class="t m5 x1f h2d y8d6 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$2,<span class="_ _e"> </span>%rdi</span></div><div class="t m5 x1f h2d y77e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">cmpq<span class="_ _46"> </span>$8,<span class="_ _e"> </span>%rdi</span></div><div class="t m5 x1f h2d ye95 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">ja<span class="_ _5a"> </span>.L2</span></div><div class="t m5 x1f h2d y177d ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">jmp<span class="_ _8c"> </span>*.L4(,%rdi,8)</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
