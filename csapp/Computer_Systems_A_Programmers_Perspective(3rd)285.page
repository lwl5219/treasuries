<div id="pf11d" class="pf w2 h11" data-page-no="11d"><div class="pc pc11d w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg11d.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">284<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1f h2d ye7 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">movl<span class="_ _46"> </span>$6,<span class="_ _e"> </span>%eax</span></div><div class="t m5 x1f h2d yc4d ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">ret</span></div><div class="t m5 x29 h26 y29d1 ff7 fs19 fc2 sc0 ls0 ws0">Determine<span class="_"> </span>a<span class="_ _11"> </span>valid<span class="_ _11"> </span>ordering<span class="_ _11"> </span>and<span class="_ _11"> </span>types<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>four<span class="_ _11"> </span>parameters<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>here<span class="_ _11"> </span>are<span class="_ _11"> </span>two</div><div class="t m5 x1d h26 y29d2 ff7 fs19 fc2 sc0 ls0 ws0">correct<span class="_"> </span>answers<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y29d3 ffe fs29 fc1 sc0 ls0 ws0">3.7.4</div><div class="t m5 x8c h43 y29d4 ffe fs19 fc1 sc0 ls0 ws0">Local<span class="_"> </span>Storage<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>Stack</div><div class="t m5 x1d h26 y29d5 ff7 fs19 fc1 sc0 ls0 ws0">Most<span class="_ _14"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>procedure<span class="_ _14"> </span>examples<span class="_ _14"> </span>we<span class="_ _14"> </span>have<span class="_ _14"> </span>seen<span class="_ _14"> </span>so<span class="_ _14"> </span>far<span class="_ _14"> </span>did<span class="_ _14"> </span>not<span class="_ _16"> </span>require<span class="_ _14"> </span>any<span class="_ _14"> </span>local</div><div class="t m5 x1d h26 y29d6 ff7 fs19 fc1 sc0 ls0 ws0">storage<span class="_ _13"> </span>beyond<span class="_ _13"> </span>what<span class="_ _13"> </span>could<span class="_ _13"> </span>be<span class="_ _6"> </span>held<span class="_ _13"> </span>in<span class="_ _13"> </span>registers<span class="_ _1"></span>.<span class="_ _13"> </span>At<span class="_ _13"> </span>times<span class="_ _1"></span>,<span class="_ _13"> </span>however,<span class="_ _13"> </span>local<span class="_ _13"> </span>data<span class="_ _13"> </span>must</div><div class="t m5 x1d h26 y29d7 ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_"> </span>stored<span class="_"> </span>in<span class="_"> </span>memory<span class="_ _3"></span>.<span class="_"> </span>Common<span class="_"> </span>cases<span class="_"> </span>of<span class="_"> </span>this<span class="_"> </span>include<span class="_"> </span>these:</div><div class="t m5 x75 h3d y29d8 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y29d9 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>here<span class="_"> </span>are<span class="_"> </span>not<span class="_"> </span>enough<span class="_"> </span>registers<span class="_"> </span>to<span class="_"> </span>hold<span class="_"> </span>all<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>local<span class="_"> </span>data.</div><div class="t m5 x75 h3d y29da ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y29db ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>address<span class="_ _11"> </span>operator<span class="_"> </span>‘<span class="ffd">&amp;</span>’<span class="_"> </span>is<span class="_"> </span>applied<span class="_"> </span>to<span class="_ _11"> </span>a<span class="_"> </span>local<span class="_"> </span>variable<span class="_ _0"></span>,<span class="_"> </span>and<span class="_"> </span>hence<span class="_"> </span>we<span class="_"> </span>must<span class="_ _11"> </span>be</div><div class="t m5 x29 h26 y29dc ff7 fs19 fc1 sc0 ls0 ws0">able<span class="_"> </span>to<span class="_"> </span>generate<span class="_"> </span>an<span class="_"> </span>address<span class="_"> </span>for<span class="_"> </span>it.</div><div class="t m5 x75 h3d y29dd ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y29de ff7 fs19 fc1 sc0 ls0 ws0">Some<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _6"> </span>local<span class="_ _6"> </span>variables<span class="_ _6"> </span>are<span class="_ _6"> </span>arrays<span class="_ _6"> </span>or<span class="_ _6"> </span>structures<span class="_ _6"> </span>and<span class="_ _6"> </span>hence<span class="_ _6"> </span>must<span class="_ _13"> </span>be<span class="_ _a"> </span>accessed</div><div class="t m5 x29 h26 y29df ff7 fs19 fc1 sc0 ls0 ws0">by<span class="_ _21"> </span>array<span class="_ _f"> </span>or<span class="_ _f"> </span>structure<span class="_ _f"> </span>references<span class="_ _1"></span>.<span class="_ _f"> </span>W<span class="_ _1"></span>e<span class="_ _f"> </span>will<span class="_ _21"> </span>discuss<span class="_ _f"> </span>this<span class="_ _f"> </span>possibility<span class="_ _f"> </span>when<span class="_ _f"> </span>we</div><div class="t m5 x29 h26 y29e0 ff7 fs19 fc1 sc0 ls0 ws0">describe<span class="_"> </span>how<span class="_"> </span>arrays<span class="_"> </span>and<span class="_"> </span>structures<span class="_"> </span>are<span class="_"> </span>allocated.</div><div class="t m5 x1d h26 y29e1 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>ypically<span class="_ _3"></span>,<span class="_ _15"> </span>a<span class="_ _15"> </span>procedure<span class="_ _14"> </span>allocates<span class="_ _15"> </span>space<span class="_ _14"> </span>on<span class="_ _14"> </span>the<span class="_ _15"> </span>stack<span class="_ _14"> </span>frame<span class="_ _15"> </span>by<span class="_ _14"> </span>decrementing<span class="_ _15"> </span>the</div><div class="t m5 x1d h26 y29e2 ff7 fs19 fc1 sc0 ls0 ws0">stack<span class="_ _11"> </span>pointer.<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>results<span class="_ _11"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>portion<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>stack<span class="_ _11"> </span>frame<span class="_ _16"> </span>labeled<span class="_ _16"> </span>“Local<span class="_ _11"> </span>vari-</div><div class="t m5 x1d h26 y29e3 ff7 fs19 fc1 sc0 ls0 ws0">ables”<span class="_"> </span>in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>3.25.</div><div class="t m5 x29 h26 y29e4 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _15"> </span>an<span class="_ _21"> </span>example<span class="_ _21"> </span>of<span class="_ _15"> </span>the<span class="_ _21"> </span>handling<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _15"> </span>address<span class="_ _21"> </span>operator,<span class="_ _f"> </span>consider<span class="_ _15"> </span>the<span class="_ _21"> </span>two</div><div class="t m5 x1d h26 y29e5 ff7 fs19 fc1 sc0 ls0 ws0">functions<span class="_ _16"> </span>shown<span class="_ _11"> </span>in<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _16"> </span>3.31(a).<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>function<span class="_ _16"> </span><span class="ffd">swap_add<span class="_ _11"> </span></span>swaps<span class="_ _16"> </span>the<span class="_ _16"> </span>two<span class="_ _16"> </span>values</div><div class="t m5 x1d h26 y29e6 ff7 fs19 fc1 sc0 ls0 ws0">designated<span class="_"> </span>by<span class="_"> </span>pointers<span class="_"> </span><span class="ffd">xp<span class="_ _10"> </span></span>and<span class="_"> </span><span class="ffd">yp<span class="_ _10"> </span></span>and<span class="_"> </span>also<span class="_"> </span>returns<span class="_"> </span>the<span class="_"> </span>sum<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>two<span class="_"> </span>values<span class="_ _1"></span>.<span class="_"> </span>The</div><div class="t m5 x1d h26 y29e7 ff7 fs19 fc1 sc0 ls0 ws0">function<span class="_ _13"> </span><span class="ffd">caller<span class="_ _6"> </span></span>creates<span class="_ _13"> </span>pointers<span class="_ _6"> </span>to<span class="_ _13"> </span>local<span class="_ _13"> </span>variables<span class="_ _6"> </span><span class="ffd">arg1<span class="_ _13"> </span></span>and<span class="_ _6"> </span><span class="ffd">arg2<span class="_ _13"> </span></span>and<span class="_ _13"> </span>passes<span class="_ _6"> </span>these</div><div class="t m5 x1d h26 y29e8 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _11"> </span><span class="ffd">swap_add</span>.<span class="_ _11"> </span>F<span class="_ _1"></span>igure<span class="_ _11"> </span>3.31(b)<span class="_ _11"> </span>shows<span class="_ _11"> </span>how<span class="_ _11"> </span><span class="ffd">caller<span class="_ _11"> </span></span>uses<span class="_ _11"> </span>a<span class="_ _11"> </span>stack<span class="_ _11"> </span>frame<span class="_ _11"> </span>to<span class="_ _11"> </span>implement</div><div class="t m5 x1d h26 y29e9 ff7 fs19 fc1 sc0 ls0 ws0">these<span class="_ _6"> </span>local<span class="_ _13"> </span>variables<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _3"></span>he<span class="_ _13"> </span>code<span class="_ _6"> </span>for<span class="_ _13"> </span><span class="ffd">caller<span class="_ _6"> </span></span>starts<span class="_ _13"> </span>by<span class="_ _6"> </span>decrementing<span class="_ _13"> </span>the<span class="_ _6"> </span>stack<span class="_ _13"> </span>pointer</div><div class="t m5 x1d h26 y29ea ff7 fs19 fc1 sc0 ls0 ws0">by<span class="_ _13"> </span>16;<span class="_ _13"> </span>this<span class="_ _13"> </span>effectively<span class="_ _13"> </span>allocates<span class="_ _13"> </span>16<span class="_ _13"> </span>bytes<span class="_ _13"> </span>on<span class="_ _13"> </span>the<span class="_"> </span>stack.<span class="_ _13"> </span>Letting<span class="_ _13"> </span><span class="ff11">S<span class="_ _10"> </span></span>denote<span class="_ _13"> </span>the<span class="_ _13"> </span>value<span class="_ _13"> </span>of</div><div class="t m5 x1d h46 y29eb ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>stack<span class="_ _6"> </span>pointer,<span class="_ _13"> </span>we<span class="_ _13"> </span>can<span class="_ _6"> </span>see<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_ _6"> </span>code<span class="_ _13"> </span>computes<span class="_ _13"> </span><span class="ffd">&amp;arg2<span class="_ _6"> </span></span>as<span class="_ _13"> </span><span class="ff11">S<span class="_ _10"> </span><span class="ff12">+<span class="_ _13"> </span></span></span>8<span class="_ _13"> </span>(line<span class="_ _13"> </span>5),<span class="_ _13"> </span><span class="ffd">&amp;arg1</span></div><div class="t m5 x1d h26 y29ec ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_"> </span><span class="ff11">S<span class="_ _11"> </span></span>(line<span class="_"> </span>6).<span class="_"> </span>W<span class="_ _7"></span>e<span class="_"> </span>can<span class="_"> </span>therefore<span class="_"> </span>infer<span class="_ _13"> </span>that<span class="_"> </span>local<span class="_"> </span>variables<span class="_"> </span><span class="ffd">arg1<span class="_ _13"> </span></span>and<span class="_"> </span><span class="ffd">arg2<span class="_ _10"> </span></span>are<span class="_"> </span>stored</div><div class="t m5 x1d h26 y29ed ff7 fs19 fc1 sc0 ls0 ws0">within<span class="_ _13"> </span>the<span class="_ _6"> </span>stack<span class="_ _13"> </span>frame<span class="_ _13"> </span>at<span class="_ _13"> </span>offsets<span class="_ _6"> </span>0<span class="_ _13"> </span>and<span class="_ _13"> </span>8<span class="_ _6"> </span>relative<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>stack<span class="_ _6"> </span>pointer.<span class="_ _13"> </span>W<span class="_ _1"></span>hen<span class="_ _13"> </span>the<span class="_ _13"> </span>call</div><div class="t m5 x1d h26 y29ee ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _16"> </span><span class="ffd">swap_add<span class="_ _11"> </span></span>completes<span class="_ _0"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>code<span class="_ _16"> </span>for<span class="_ _11"> </span><span class="ffd">caller<span class="_ _16"> </span></span>then<span class="_ _16"> </span>retrieves<span class="_ _16"> </span>the<span class="_ _11"> </span>two<span class="_ _16"> </span>values<span class="_ _16"> </span>from</div><div class="t m5 x1d h26 y29ef ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>stack<span class="_ _16"> </span>(lines<span class="_ _16"> </span>8–9),<span class="_ _16"> </span>computes<span class="_ _11"> </span>their<span class="_ _16"> </span>difference<span class="_ _1"></span>,<span class="_ _16"> </span>and<span class="_ _16"> </span>multiplies<span class="_ _11"> </span>this<span class="_ _16"> </span>by<span class="_ _11"> </span>the<span class="_ _16"> </span>value</div><div class="t m5 x1d h26 y29f0 ff7 fs19 fc1 sc0 ls0 ws0">returned<span class="_"> </span>by<span class="_ _11"> </span><span class="ffd">swap_add<span class="_ _11"> </span></span>in<span class="_"> </span>register<span class="_ _11"> </span><span class="ffd">%rax<span class="_ _11"> </span></span>(line<span class="_"> </span>10).<span class="_ _11"> </span>Finally<span class="_ _7"></span>,<span class="_ _11"> </span>the<span class="_"> </span>function<span class="_ _11"> </span>deallocates</div><div class="t m5 x1d h26 y29f1 ff7 fs19 fc1 sc0 ls0 ws0">its<span class="_"> </span>stack<span class="_"> </span>frame<span class="_ _13"> </span>by<span class="_"> </span>incrementing<span class="_"> </span>the<span class="_"> </span>stack<span class="_ _13"> </span>pointer<span class="_"> </span>by<span class="_"> </span>16<span class="_"> </span>(line<span class="_ _13"> </span>11.)<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>can<span class="_"> </span>see<span class="_"> </span>with</div><div class="t m5 x1d h26 y29f2 ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>example<span class="_ _11"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>run-time<span class="_ _11"> </span>stack<span class="_ _11"> </span>provides<span class="_ _11"> </span>a<span class="_ _11"> </span>simple<span class="_ _11"> </span>mechanism<span class="_ _11"> </span>for<span class="_ _11"> </span>allocating</div><div class="t m5 x1d h26 y29f3 ff7 fs19 fc1 sc0 ls0 ws0">local<span class="_"> </span>storage<span class="_ _13"> </span>when<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>required<span class="_ _13"> </span>and<span class="_"> </span>deallocating<span class="_"> </span>it<span class="_ _13"> </span>when<span class="_"> </span>the<span class="_"> </span>function<span class="_ _13"> </span>completes<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y29f4 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _11"> </span>a<span class="_ _11"> </span>more<span class="_ _11"> </span>complex<span class="_ _11"> </span>example<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_"> </span>function<span class="_ _11"> </span><span class="ffd">call_proc</span>,<span class="_ _16"> </span>shown<span class="_"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>3.32,</div><div class="t m5 x1d h26 y29f5 ff7 fs19 fc1 sc0 ls0 ws0">illustrates<span class="_ _11"> </span>many<span class="_ _16"> </span>aspects<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>x86-64<span class="_ _16"> </span>stack<span class="_ _11"> </span>discipline<span class="_ _0"></span>.<span class="_ _11"> </span>Despite<span class="_ _16"> </span>the<span class="_ _11"> </span>length<span class="_ _11"> </span>of<span class="_ _16"> </span>this</div><div class="t m5 x1d h26 y29f6 ff7 fs19 fc1 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_ _e"> </span>it<span class="_ _15"> </span>is<span class="_ _21"> </span>worth<span class="_ _21"> </span>studying<span class="_ _15"> </span>carefully<span class="_ _3"></span>.<span class="_ _21"> </span>It<span class="_ _21"> </span>shows<span class="_ _21"> </span>a<span class="_ _21"> </span>function<span class="_ _21"> </span>that<span class="_ _21"> </span>must<span class="_ _21"> </span>allocate</div><div class="t m5 x1d h26 y29f7 ff7 fs19 fc1 sc0 ls0 ws0">storage<span class="_ _13"> </span>on<span class="_"> </span>the<span class="_ _13"> </span>stack<span class="_ _13"> </span>for<span class="_ _13"> </span>local<span class="_"> </span>variables<span class="_ _3"></span>,<span class="_"> </span>as<span class="_ _13"> </span>well<span class="_ _13"> </span>as<span class="_"> </span>to<span class="_ _13"> </span>pass<span class="_ _13"> </span>values<span class="_ _13"> </span>to<span class="_"> </span>the<span class="_ _13"> </span>8-argument</div><div class="t m5 x1d h26 y29f8 ff7 fs19 fc1 sc0 ls0 ws0">function<span class="_ _16"> </span><span class="ffd">proc<span class="_ _11"> </span></span>(Figure<span class="_ _11"> </span>3.29).<span class="_ _16"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span>function<span class="_ _11"> </span>creates<span class="_ _16"> </span>a<span class="_ _16"> </span>stack<span class="_ _16"> </span>frame<span class="_ _1"></span>,<span class="_ _16"> </span>diagrammed<span class="_ _16"> </span>in</div><div class="t m5 x1d h26 y29f9 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>3.33.</div><div class="t m5 x29 h26 y29fa ff7 fs19 fc1 sc0 ls0 ws0">Looking<span class="_ _14"> </span>at<span class="_ _15"> </span>the<span class="_ _15"> </span>assembly<span class="_ _15"> </span>code<span class="_ _15"> </span>for<span class="_ _14"> </span><span class="ffd">call_proc<span class="_ _15"> </span></span>(Figure<span class="_ _14"> </span>3.32(b)),<span class="_ _21"> </span>we<span class="_ _15"> </span>can<span class="_ _14"> </span>see</div><div class="t m5 x1d h26 y29fb ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _16"> </span>a<span class="_ _14"> </span>large<span class="_ _16"> </span>portion<span class="_ _14"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>code<span class="_ _16"> </span>(lines<span class="_ _14"> </span>2–15)<span class="_ _16"> </span>involves<span class="_ _14"> </span>preparing<span class="_ _16"> </span>to<span class="_ _14"> </span>call<span class="_ _16"> </span>function</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
