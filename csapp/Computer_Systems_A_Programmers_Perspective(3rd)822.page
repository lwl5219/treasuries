<div id="pf336" class="pf w2 h11" data-page-no="336"><div class="pc pc336 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg336.png"/><div class="t m5 x54 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>8.6<span class="_ _60"> </span>Nonlocal<span class="_ _10"> </span>Jumps<span class="_ _3e"> </span><span class="ffe fs1e">821</span></div><div class="t m5 xa9 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/ecf/restart.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h2e y281 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x2c h2e y282 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2d h2d y283 ffd fs1e fc2 sc0 ls0 ws0">sigjmp_buf<span class="_ _e"> </span>buf;</div><div class="t m5 x2c h2e y284 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y69c3 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2d h2d y285 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>handler(int<span class="_ _1f"> </span>sig)</div><div class="t m5 x2c h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">siglongjmp(buf,<span class="_ _e"> </span>1);</span></div><div class="t m5 x2c h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x2c h2e y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x17 h2e y6a52 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x2d h2d y4a9b ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(!sigsetjmp(buf,<span class="_ _1f"> </span>1))<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _70"> </span><span class="ffd fs1e fc2">Signal(SIGINT,<span class="_ _e"> </span>handler);</span></div><div class="t m5 x17 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">Sio_puts(&quot;starting\n&quot;);</span></div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">else</span></div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _70"> </span><span class="ffd fs1e fc2">Sio_puts(&quot;restarting\n&quot;);</span></div><div class="t m5 x17 h2e yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x17 h2e y6997 ff6 fs20 fc6 sc0 ls0 ws0">19</div><div class="t m5 x142 h2d y2a2b ffd fs1e fc2 sc0 ls0 ws0">while(1)<span class="_ _e"> </span>{</div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _70"> </span><span class="ffd fs1e fc2">Sleep(1);</span></div><div class="t m5 x17 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 xc5 h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">Sio_puts(&quot;processing...\n&quot;);</div><div class="t m5 x17 h2d y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _20"> </span><span class="ffd fs1e fc2">exit(0);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Control<span class="_ _1f"> </span>never<span class="_ _e"> </span>reaches<span class="_ _1f"> </span>here<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 xa9 h2c y6a56 ffa fs16 fc2 sc0 ls0 ws0">code/ecf/restart.c</div><div class="t m5 x17 h2f y6a57 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>8.44<span class="_ _c"> </span><span class="fc1">A<span class="_ _16"> </span>program<span class="_ _16"> </span>that<span class="_ _14"> </span>uses<span class="_ _16"> </span>nonlocal<span class="_ _16"> </span>jumps<span class="_ _16"> </span>to<span class="_ _16"> </span>restart<span class="_ _14"> </span>itself<span class="_ _16"> </span>when<span class="_ _16"> </span>the<span class="_ _16"> </span>user</span></div><div class="t m5 x17 h2f y6a58 ffe fs16 fc1 sc0 ls0 ws0">types<span class="_"> </span>Ctrl+C.</div><div class="t m5 x26 h26 ycc7 ff7 fs19 fc1 sc0 ls0 ws0">Another<span class="_"> </span>important<span class="_"> </span>application<span class="_"> </span>of<span class="_"> </span>nonlocal<span class="_"> </span>jumps<span class="_"> </span>is<span class="_"> </span>to<span class="_"> </span>branch<span class="_"> </span>out<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>signal</div><div class="t m5 x17 h26 ycc8 ff7 fs19 fc1 sc0 ls0 ws0">handler<span class="_ _6"> </span>to<span class="_ _13"> </span>a<span class="_ _a"> </span>speciﬁc<span class="_ _13"> </span>code<span class="_ _a"> </span>location,<span class="_ _13"> </span>rather<span class="_ _6"> </span>than<span class="_ _13"> </span>returning<span class="_ _a"> </span>to<span class="_ _13"> </span>the<span class="_ _6"> </span>instruction<span class="_ _6"> </span>that<span class="_ _13"> </span>was</div><div class="t m5 x17 h26 ycc9 ff7 fs19 fc1 sc0 ls0 ws0">interrupted<span class="_ _11"> </span>by<span class="_ _11"> </span>the<span class="_ _11"> </span>arrival<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>signal.<span class="_ _11"> </span>F<span class="_ _0"></span>igure<span class="_"> </span>8.44<span class="_ _11"> </span>shows<span class="_ _11"> </span>a<span class="_ _16"> </span>simple<span class="_"> </span>program<span class="_ _11"> </span>that</div><div class="t m5 x17 h26 ycca ff7 fs19 fc1 sc0 ls0 ws0">illustrates<span class="_ _16"> </span>this<span class="_ _16"> </span>basic<span class="_ _11"> </span>technique.<span class="_ _11"> </span>The<span class="_ _11"> </span>program<span class="_ _16"> </span>uses<span class="_ _16"> </span>signals<span class="_ _16"> </span>and<span class="_ _11"> </span>nonlocal<span class="_ _16"> </span>jumps<span class="_ _16"> </span>to</div><div class="t m5 x17 h26 yccb ff7 fs19 fc1 sc0 ls0 ws0">do<span class="_"> </span>a<span class="_ _13"> </span>soft<span class="_"> </span>restart<span class="_ _13"> </span>whenever<span class="_"> </span>the<span class="_ _13"> </span>user<span class="_"> </span>types<span class="_"> </span>Ctrl+C<span class="_ _13"> </span>at<span class="_"> </span>the<span class="_ _13"> </span>keyboard.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span><span class="ffd">sigsetjmp</span></div><div class="t m5 x17 h26 yccc ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _11"> </span><span class="ffd">siglongjmp<span class="_ _11"> </span></span>functions<span class="_ _11"> </span>are<span class="_ _11"> </span>versions<span class="_ _16"> </span>of<span class="_"> </span><span class="ffd">setjmp<span class="_ _16"> </span></span>and<span class="_"> </span><span class="ffd">longjmp<span class="_ _16"> </span></span>that<span class="_"> </span>can<span class="_ _16"> </span>be<span class="_"> </span>used</div><div class="t m5 x17 h26 yccd ff7 fs19 fc1 sc0 ls0 ws0">by<span class="_"> </span>signal<span class="_"> </span>handlers<span class="_ _1"></span>.</div><div class="t m5 x26 h26 ycce ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>initial<span class="_ _11"> </span>call<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span><span class="ffd">sigsetjmp<span class="_ _11"> </span></span>function<span class="_ _11"> </span>saves<span class="_ _11"> </span>the<span class="_ _11"> </span>calling<span class="_ _11"> </span>environment<span class="_ _11"> </span>and</div><div class="t m5 x17 h26 yccf ff7 fs19 fc1 sc0 ls0 ws0">signal<span class="_ _11"> </span>context<span class="_ _16"> </span>(including<span class="_ _11"> </span>the<span class="_ _11"> </span>pending<span class="_ _11"> </span>and<span class="_ _16"> </span>blocked<span class="_ _11"> </span>signal<span class="_ _11"> </span>vectors)<span class="_ _16"> </span>when<span class="_ _11"> </span>the<span class="_ _11"> </span>pro-</div><div class="t m5 x17 h26 ycd0 ff7 fs19 fc1 sc0 ls0 ws0">gram<span class="_ _11"> </span>ﬁrst<span class="_ _11"> </span>starts<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_"> </span>main<span class="_ _16"> </span>routine<span class="_"> </span>then<span class="_ _11"> </span>enters<span class="_ _11"> </span>an<span class="_ _11"> </span>inﬁnite<span class="_ _11"> </span>processing<span class="_ _11"> </span>loop.<span class="_"> </span>When</div><div class="t m5 x17 h26 ycd1 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _14"> </span>user<span class="_ _14"> </span>types<span class="_ _14"> </span>Ctrl+C,<span class="_ _14"> </span>the<span class="_ _15"> </span>kernel<span class="_ _14"> </span>sends<span class="_ _14"> </span>a<span class="_ _14"> </span>SIGINT<span class="_ _14"> </span>signal<span class="_ _14"> </span>to<span class="_ _15"> </span>the<span class="_ _14"> </span>process<span class="_ _1"></span>,<span class="_ _15"> </span>which</div><div class="t m5 x17 h26 ycd2 ff7 fs19 fc1 sc0 ls0 ws0">catches<span class="_"> </span>it.<span class="_"> </span>Instead<span class="_ _13"> </span>of<span class="_"> </span>returning<span class="_"> </span>from<span class="_"> </span>the<span class="_ _13"> </span>signal<span class="_"> </span>handler,<span class="_"> </span>which<span class="_ _13"> </span>would<span class="_"> </span>pass<span class="_"> </span>control</div><div class="t m5 x17 h26 ycd3 ff7 fs19 fc1 sc0 ls0 ws0">back<span class="_ _16"> </span>to<span class="_ _14"> </span>the<span class="_ _14"> </span>interrupted<span class="_ _16"> </span>processing<span class="_ _14"> </span>loop<span class="_ _1"></span>,<span class="_ _15"> </span>the<span class="_ _16"> </span>handler<span class="_ _14"> </span>performs<span class="_ _14"> </span>a<span class="_ _16"> </span>nonlocal<span class="_ _14"> </span>jump</div><div class="t m5 x17 h26 ycd4 ff7 fs19 fc1 sc0 ls0 ws0">back<span class="_ _14"> </span>to<span class="_ _16"> </span>the<span class="_ _14"> </span>beginning<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">main<span class="_ _14"> </span></span>program.<span class="_ _14"> </span>When<span class="_ _16"> </span>we<span class="_ _14"> </span>run<span class="_ _14"> </span>the<span class="_ _14"> </span>program<span class="_ _14"> </span>on<span class="_ _14"> </span>our</div><div class="t m5 x17 h26 ycd5 ff7 fs19 fc1 sc0 ls0 ws0">system,<span class="_"> </span>we<span class="_"> </span>get<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>output:</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
