<div id="pf141" class="pf w2 h11" data-page-no="141"><div class="pc pc141 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg141.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">320<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x124 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">D<span class="_ _3"></span>.<span class="_ _23"> </span>What<span class="_"> </span>register(s)<span class="_"> </span>have<span class="_"> </span>corrupted<span class="_"> </span>value(s)<span class="_"> </span>when<span class="_"> </span><span class="ffd">get_line<span class="_ _10"> </span></span>returns?</div><div class="t m5 x124 h26 y10aa ff7 fs19 fc2 sc0 ls0 ws0">E.<span class="_ _25"> </span>Besides<span class="_ _11"> </span>the<span class="_ _11"> </span>potential<span class="_ _11"> </span>for<span class="_ _11"> </span>buffer<span class="_ _16"> </span>overﬂow<span class="_ _7"></span>,<span class="_ _16"> </span>what<span class="_ _11"> </span>two<span class="_ _11"> </span>other<span class="_ _11"> </span>things<span class="_ _11"> </span>are<span class="_ _16"> </span>wrong</div><div class="t m5 x4f h26 y1acd ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span><span class="ffd">get_line</span>?</div><div class="t m5 x29 h26 y2dda ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_ _15"> </span>more<span class="_ _21"> </span>pernicious<span class="_ _15"> </span>use<span class="_ _21"> </span>of<span class="_ _15"> </span>buffer<span class="_ _21"> </span>overﬂow<span class="_ _15"> </span>is<span class="_ _21"> </span>to<span class="_ _15"> </span>get<span class="_ _21"> </span>a<span class="_ _15"> </span>program<span class="_ _21"> </span>to<span class="_ _15"> </span>perform</div><div class="t m5 x1d h26 y2ddb ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _15"> </span>function<span class="_ _15"> </span>that<span class="_ _15"> </span>it<span class="_ _15"> </span>would<span class="_ _15"> </span>otherwise<span class="_ _15"> </span>be<span class="_ _15"> </span>unwilling<span class="_ _21"> </span>to<span class="_ _15"> </span>do<span class="_ _1"></span>.<span class="_ _21"> </span>T<span class="_ _1"></span>his<span class="_ _15"> </span>is<span class="_ _21"> </span>one<span class="_ _15"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>most</div><div class="t m5 x1d h26 y2ddc ff7 fs19 fc1 sc0 ls0 ws0">common<span class="_ _14"> </span>methods<span class="_ _14"> </span>to<span class="_ _14"> </span>attack<span class="_ _14"> </span>the<span class="_ _14"> </span>security<span class="_ _14"> </span>of<span class="_ _14"> </span>a<span class="_ _14"> </span>system<span class="_ _14"> </span>over<span class="_ _14"> </span>a<span class="_ _14"> </span>computer<span class="_ _14"> </span>network.</div><div class="t m5 x1d h26 y2ddd ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>ypically<span class="_ _3"></span>,<span class="_"> </span>the<span class="_ _13"> </span>program<span class="_ _13"> </span>is<span class="_ _13"> </span>fed<span class="_"> </span>with<span class="_ _13"> </span>a<span class="_ _13"> </span>string<span class="_"> </span>that<span class="_ _13"> </span>contains<span class="_ _13"> </span>the<span class="_"> </span>byte<span class="_ _13"> </span>encoding<span class="_ _13"> </span>of<span class="_"> </span>some</div><div class="t m5 x1d h26 y2dde ff7 fs19 fc1 sc0 ls0 ws0">executable<span class="_"> </span>code<span class="_ _1"></span>,<span class="_"> </span>called<span class="_"> </span>the<span class="_"> </span><span class="ffa">exploit<span class="_"> </span>code</span>,<span class="_"> </span>plus<span class="_"> </span>some<span class="_"> </span>extra<span class="_"> </span>bytes<span class="_"> </span>that<span class="_ _13"> </span>overwrite<span class="_"> </span>the</div><div class="t m5 x1d h26 y2ddf ff7 fs19 fc1 sc0 ls0 ws0">return<span class="_"> </span>address<span class="_"> </span>with<span class="_"> </span>a<span class="_"> </span>pointer<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>exploit<span class="_"> </span>code.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>effect<span class="_"> </span>of<span class="_"> </span>executing<span class="_"> </span>the<span class="_ _11"> </span><span class="ffd">ret</span></div><div class="t m5 x1d h26 y2de0 ff7 fs19 fc1 sc0 ls0 ws0">instruction<span class="_"> </span>is<span class="_"> </span>then<span class="_"> </span>to<span class="_"> </span>jump<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>exploit<span class="_"> </span>code<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2de1 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _16"> </span>one<span class="_ _11"> </span>form<span class="_ _16"> </span>of<span class="_ _16"> </span>attack,<span class="_ _16"> </span>the<span class="_ _16"> </span>exploit<span class="_ _16"> </span>code<span class="_ _11"> </span>then<span class="_ _16"> </span>uses<span class="_ _16"> </span>a<span class="_ _16"> </span>system<span class="_ _11"> </span>call<span class="_ _16"> </span>to<span class="_ _16"> </span>start<span class="_ _16"> </span>up<span class="_ _11"> </span>a</div><div class="t m5 x1d h26 y2de2 ff7 fs19 fc1 sc0 ls0 ws0">shell<span class="_"> </span>program,<span class="_"> </span>providing<span class="_"> </span>the<span class="_"> </span>attacker<span class="_ _13"> </span>with<span class="_"> </span>a<span class="_"> </span>range<span class="_"> </span>of<span class="_"> </span>operating<span class="_"> </span>system<span class="_"> </span>functions<span class="_ _3"></span>.</div><div class="t m5 x1d h26 y2de3 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _16"> </span>another<span class="_ _14"> </span>form,<span class="_ _15"> </span>the<span class="_ _16"> </span>exploit<span class="_ _14"> </span>code<span class="_ _14"> </span>performs<span class="_ _14"> </span>some<span class="_ _14"> </span>otherwise<span class="_ _16"> </span>unauthorized<span class="_ _14"> </span>task,</div><div class="t m5 x1d h26 y2de4 ff7 fs19 fc1 sc0 ls0 ws0">repairs<span class="_"> </span>the<span class="_"> </span>damage<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>stack,<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>executes<span class="_"> </span><span class="ffd">ret<span class="_ _10"> </span></span>a<span class="_"> </span>second<span class="_"> </span>time<span class="_ _1"></span>,<span class="_"> </span>causing<span class="_"> </span>an</div><div class="t m5 x1d h26 y2de5 ff7 fs19 fc1 sc0 ls0 ws0">(apparently)<span class="_"> </span>normal<span class="_"> </span>return<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>caller.</div><div class="t m5 x29 h26 y2de6 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _11"> </span>an<span class="_ _11"> </span>example<span class="_ _0"></span>,<span class="_ _11"> </span>the<span class="_ _11"> </span>famous<span class="_ _16"> </span>Internet<span class="_"> </span>worm<span class="_ _16"> </span>of<span class="_"> </span>November<span class="_ _16"> </span>1988<span class="_"> </span>used<span class="_ _16"> </span>four<span class="_"> </span>dif-</div><div class="t m5 x1d h26 y2de7 ff7 fs19 fc1 sc0 ls0 ws0">ferent<span class="_"> </span>ways<span class="_ _13"> </span>to<span class="_"> </span>gain<span class="_ _13"> </span>access<span class="_"> </span>to<span class="_"> </span>many<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>computers<span class="_"> </span>across<span class="_"> </span>the<span class="_ _13"> </span>Internet.<span class="_"> </span>One<span class="_ _13"> </span>was</div><div class="t m5 x1d h26 y2de8 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_"> </span>buffer<span class="_"> </span>overﬂow<span class="_ _13"> </span>attack<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>ﬁnger<span class="_ _13"> </span>daemon<span class="_"> </span><span class="ffd">fingerd</span>,<span class="_"> </span>which<span class="_"> </span>serves<span class="_"> </span>requests<span class="_ _13"> </span>by</div><div class="t m5 x1d h26 y2de9 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span><span class="ff9">ﬁnger<span class="_ _16"> </span></span>command.<span class="_ _16"> </span>By<span class="_ _16"> </span>invoking<span class="_ _16"> </span><span class="ff9">ﬁnger<span class="_ _16"> </span></span>with<span class="_ _16"> </span>an<span class="_ _16"> </span>appropriate<span class="_ _16"> </span>string,<span class="_ _16"> </span>the<span class="_ _16"> </span>worm</div><div class="t m5 x1d h26 y2dea ff7 fs19 fc1 sc0 ls0 ws0">could<span class="_"> </span>make<span class="_ _13"> </span>the<span class="_"> </span>daemon<span class="_ _13"> </span>at<span class="_"> </span>a<span class="_ _13"> </span>remote<span class="_"> </span>site<span class="_ _13"> </span>have<span class="_"> </span>a<span class="_ _13"> </span>buffer<span class="_"> </span>overﬂow<span class="_ _13"> </span>and<span class="_"> </span>execute<span class="_"> </span>code</div><div class="t m5 x1d h26 y2deb ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _13"> </span>gave<span class="_ _6"> </span>the<span class="_ _13"> </span>worm<span class="_ _13"> </span>access<span class="_ _6"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>remote<span class="_ _13"> </span>system.<span class="_ _6"> </span>Once<span class="_ _13"> </span>the<span class="_ _13"> </span>worm<span class="_ _6"> </span>gained<span class="_ _13"> </span>access<span class="_ _13"> </span>to<span class="_ _6"> </span>a</div><div class="t m5 x1d h26 y2dec ff7 fs19 fc1 sc0 ls0 ws0">system,<span class="_ _13"> </span>it<span class="_ _6"> </span>would<span class="_ _13"> </span>replicate<span class="_ _6"> </span>itself<span class="_ _13"> </span>and<span class="_ _6"> </span>consume<span class="_ _13"> </span>virtually<span class="_ _6"> </span>all<span class="_ _13"> </span>of<span class="_ _6"> </span>the<span class="_ _13"> </span>machine’<span class="_ _0"></span>s<span class="_ _6"> </span>comput-</div><div class="t m5 x1d h26 y2ded ff7 fs19 fc1 sc0 ls0 ws0">ing<span class="_ _13"> </span>resources<span class="_ _3"></span>.<span class="_ _13"> </span>As<span class="_ _6"> </span>a<span class="_ _13"> </span>consequence<span class="_ _0"></span>,<span class="_ _13"> </span>hundreds<span class="_ _6"> </span>of<span class="_ _13"> </span>machines<span class="_ _13"> </span>were<span class="_ _6"> </span>effectively<span class="_ _13"> </span>paralyzed</div><div class="t m5 x1d h26 y2dee ff7 fs19 fc1 sc0 ls0 ws0">until<span class="_"> </span>security<span class="_"> </span>experts<span class="_"> </span>could<span class="_"> </span>determine<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>eliminate<span class="_"> </span>the<span class="_"> </span>worm.<span class="_"> </span>The<span class="_"> </span>author<span class="_"> </span>of</div><div class="t m5 x1d h26 y2def ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>worm<span class="_"> </span>was<span class="_ _13"> </span>caught<span class="_ _13"> </span>and<span class="_ _13"> </span>prosecuted.<span class="_"> </span>He<span class="_ _13"> </span>was<span class="_ _13"> </span>sentenced<span class="_"> </span>to<span class="_ _13"> </span>3<span class="_ _13"> </span>years<span class="_ _13"> </span>probation,<span class="_"> </span>400</div><div class="t m5 x1d h26 y2df0 ff7 fs19 fc1 sc0 ls0 ws0">hours<span class="_ _13"> </span>of<span class="_"> </span>community<span class="_ _13"> </span>service<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _13"> </span>a<span class="_"> </span>$10,500<span class="_ _13"> </span>ﬁne<span class="_ _1"></span>.<span class="_"> </span>Even<span class="_ _13"> </span>to<span class="_ _13"> </span>this<span class="_"> </span>day<span class="_ _7"></span>,<span class="_"> </span>however<span class="_ _0"></span>,<span class="_ _13"> </span>people</div><div class="t m5 x1d h26 y2df1 ff7 fs19 fc1 sc0 ls0 ws0">continue<span class="_ _14"> </span>to<span class="_ _15"> </span>ﬁnd<span class="_ _14"> </span>security<span class="_ _14"> </span>leaks<span class="_ _15"> </span>in<span class="_ _14"> </span>systems<span class="_ _15"> </span>that<span class="_ _14"> </span>leave<span class="_ _15"> </span>them<span class="_ _14"> </span>vulnerable<span class="_ _15"> </span>to<span class="_ _14"> </span>buffer</div><div class="t m5 x1d h26 y2df2 ff7 fs19 fc1 sc0 ls0 ws0">overﬂow<span class="_ _13"> </span>attacks<span class="_ _1"></span>.<span class="_ _13"> </span>This<span class="_ _13"> </span>highlights<span class="_ _13"> </span>the<span class="_ _13"> </span>need<span class="_ _13"> </span>for<span class="_ _13"> </span>careful<span class="_ _13"> </span>programming.<span class="_ _13"> </span>Any<span class="_ _13"> </span>interface</div><div class="t m5 x1d h26 y2df3 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _13"> </span>the<span class="_ _13"> </span>external<span class="_"> </span>environment<span class="_ _13"> </span>should<span class="_ _13"> </span>be<span class="_ _13"> </span>made<span class="_ _13"> </span>“bulletproof”<span class="_ _13"> </span>so<span class="_"> </span>that<span class="_ _13"> </span>no<span class="_ _13"> </span>behavior<span class="_ _13"> </span>by</div><div class="t m5 x1d h26 y2df4 ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_"> </span>external<span class="_"> </span>agent<span class="_"> </span>can<span class="_"> </span>cause<span class="_"> </span>the<span class="_"> </span>system<span class="_"> </span>to<span class="_"> </span>misbehave<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y2df5 ffe fs29 fc1 sc0 ls0 ws0">3.10.4<span class="_ _48"> </span><span class="fs19">Thwarting<span class="_"> </span>Buffer<span class="_"> </span>Overﬂow<span class="_"> </span>Attacks</span></div><div class="t m5 x1d h26 y2df6 ff7 fs19 fc1 sc0 ls0 ws0">Buffer<span class="_ _f"> </span>overﬂow<span class="_ _f"> </span>attacks<span class="_ _f"> </span>have<span class="_ _f"> </span>become<span class="_ _f"> </span>so<span class="_ _f"> </span>pervasive<span class="_ _f"> </span>and<span class="_ _f"> </span>have<span class="_ _f"> </span>caused<span class="_ _f"> </span>so<span class="_ _f"> </span>many</div><div class="t m5 x1d h26 y2df7 ff7 fs19 fc1 sc0 ls0 ws0">problems<span class="_ _16"> </span>with<span class="_ _16"> </span>computer<span class="_ _16"> </span>systems<span class="_ _14"> </span>that<span class="_ _16"> </span>modern<span class="_ _16"> </span>compilers<span class="_ _14"> </span>and<span class="_ _16"> </span>operating<span class="_ _16"> </span>systems</div><div class="t m5 x1d h26 y2df8 ff7 fs19 fc1 sc0 ls0 ws0">have<span class="_ _11"> </span>implemented<span class="_ _16"> </span>mechanisms<span class="_ _11"> </span>to<span class="_ _11"> </span>make<span class="_ _16"> </span>it<span class="_ _11"> </span>more<span class="_ _11"> </span>difﬁcult<span class="_ _16"> </span>to<span class="_ _11"> </span>mount<span class="_ _11"> </span>these<span class="_ _16"> </span>attacks</div><div class="t m5 x1d h26 y2df9 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _13"> </span>to<span class="_ _6"> </span>limit<span class="_ _13"> </span>the<span class="_ _6"> </span>ways<span class="_ _13"> </span>by<span class="_ _13"> </span>which<span class="_ _6"> </span>an<span class="_ _13"> </span>intruder<span class="_ _13"> </span>can<span class="_ _6"> </span>seize<span class="_ _13"> </span>control<span class="_ _6"> </span>of<span class="_ _13"> </span>a<span class="_ _13"> </span>system<span class="_ _6"> </span>via<span class="_ _13"> </span>a<span class="_ _6"> </span>buffer</div><div class="t m5 x1d h26 y2dfa ff7 fs19 fc1 sc0 ls0 ws0">overﬂow<span class="_"> </span>attack.<span class="_"> </span>In<span class="_"> </span>this<span class="_"> </span>section,<span class="_"> </span>we<span class="_"> </span>will<span class="_"> </span>present<span class="_"> </span>mechanisms<span class="_ _13"> </span>that<span class="_"> </span>are<span class="_"> </span>provided<span class="_"> </span>by</div><div class="t m5 x1d h26 y2dfb ff7 fs19 fc1 sc0 ls0 ws0">recent<span class="_"> </span>versions<span class="_"> </span>of<span class="_"> </span><span class="ff9">gcc<span class="_ _10"> </span></span>for<span class="_"> </span>Linux.</div><div class="t m5 x1d h42 y1b65 ff6 fs29 fc6 sc0 ls0 ws0">Stack<span class="_ _11"> </span>Randomization</div><div class="t m5 x1d h26 yd7a ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _14"> </span>order<span class="_ _14"> </span>to<span class="_ _14"> </span>insert<span class="_ _14"> </span>exploit<span class="_ _15"> </span>code<span class="_ _14"> </span>into<span class="_ _14"> </span>a<span class="_ _14"> </span>system,<span class="_ _15"> </span>the<span class="_ _15"> </span>attacker<span class="_ _14"> </span>needs<span class="_ _14"> </span>to<span class="_ _14"> </span>inject<span class="_ _14"> </span>both</div><div class="t m5 x1d h26 y1cc0 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>code<span class="_ _11"> </span>as<span class="_ _11"> </span>well<span class="_ _11"> </span>as<span class="_ _11"> </span>a<span class="_ _11"> </span>pointer<span class="_ _11"> </span>to<span class="_ _11"> </span>this<span class="_ _11"> </span>code<span class="_ _11"> </span>as<span class="_ _11"> </span>part<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>attack<span class="_ _11"> </span>string.<span class="_"> </span>Generating</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
