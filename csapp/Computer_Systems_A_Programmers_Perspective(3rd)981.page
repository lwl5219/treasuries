<div id="pf3d5" class="pf w2 h11" data-page-no="3d5"><div class="pc pc3d5 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3d5.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">980<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>11<span class="_ _3d"> </span>Network<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1d h42 ye7 ff6 fs29 fc6 sc0 ls0 ws0">The<span class="_ _11"> </span><span class="ffd fs2b">open_listenfd<span class="_ _16"> </span></span>Function</div><div class="t m5 x1d h26 y5bd ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_ _13"> </span>server<span class="_ _13"> </span>creates<span class="_ _13"> </span>a<span class="_ _13"> </span>listening<span class="_"> </span>descriptor<span class="_ _13"> </span>that<span class="_ _13"> </span>is<span class="_ _13"> </span>ready<span class="_ _13"> </span>to<span class="_ _13"> </span>receive<span class="_ _13"> </span>connection<span class="_ _13"> </span>requests</div><div class="t m5 x1d h26 y5be ff7 fs19 fc1 sc0 ls0 ws0">by<span class="_"> </span>calling<span class="_"> </span>the<span class="_"> </span><span class="ffd">open_listenfd<span class="_ _10"> </span></span>function.</div><div class="t m5 x126 h2d y7c99 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</div><div class="t m5 x126 h2d y7c9a ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>open_listenfd(char<span class="_ _1f"> </span>*port);</div><div class="t m5 xfe hf2 y7c9b ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>descriptor<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span><span class="ff12">−</span>1<span class="_ _13"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y7c9c ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _10"> </span><span class="ffd ls0">open_listenfd<span class="_ _13"> </span><span class="ff7">function<span class="_ _13"> </span>returns<span class="_ _13"> </span>a<span class="_ _13"> </span>listening<span class="_ _13"> </span>descriptor<span class="_ _13"> </span>that<span class="_ _13"> </span>is<span class="_ _13"> </span>ready<span class="_ _13"> </span>to<span class="_ _6"> </span>receive</span></span></div><div class="t m5 x1d h26 y7c9d ff7 fs19 fc2 sc0 ls0 ws0">connection<span class="_ _6"> </span>requests<span class="_ _6"> </span>on<span class="_ _6"> </span>port<span class="_ _6"> </span><span class="ffd">port</span>.<span class="_ _6"> </span>F<span class="_ _1"></span>igure<span class="_ _6"> </span>11.19<span class="_ _6"> </span>shows<span class="_ _6"> </span>the<span class="_ _6"> </span>code<span class="_ _6"> </span>for<span class="_ _6"> </span><span class="ffd">open_listenfd</span>.</div><div class="t m5 x29 h26 y7c9e ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>style<span class="_ _16"> </span>is<span class="_ _16"> </span>similar<span class="_ _16"> </span>to<span class="_ _16"> </span><span class="ffd">open_clientfd</span>.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>call<span class="_ _16"> </span><span class="ffd">getaddrinfo<span class="_ _16"> </span></span>and<span class="_ _16"> </span>then<span class="_ _16"> </span>walk</div><div class="t m5 x1d h26 y7c9f ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>resulting<span class="_ _16"> </span>list<span class="_ _11"> </span>until<span class="_ _11"> </span>the<span class="_ _16"> </span>calls<span class="_ _11"> </span>to<span class="_ _11"> </span><span class="ffd">socket<span class="_ _16"> </span></span>and<span class="_ _11"> </span><span class="ffd">bind<span class="_ _11"> </span></span>succeed.<span class="_ _16"> </span>Note<span class="_ _11"> </span>that<span class="_ _11"> </span>in<span class="_ _16"> </span>line<span class="_ _11"> </span>20</div><div class="t m5 x1d h26 y7ca0 ff7 fs19 fc2 sc0 ls0 ws0">we<span class="_ _11"> </span>use<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">setsockopt<span class="_ _11"> </span></span>function<span class="_ _16"> </span>(not<span class="_ _16"> </span>described<span class="_ _11"> </span>here)<span class="_ _16"> </span>to<span class="_ _11"> </span>conﬁgure<span class="_ _16"> </span>the<span class="_ _16"> </span>server<span class="_ _11"> </span>so</div><div class="t m5 x1d h26 y7ca1 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _11"> </span>it<span class="_ _11"> </span>can<span class="_ _16"> </span>be<span class="_ _11"> </span>terminated,<span class="_ _16"> </span>be<span class="_ _11"> </span>restarted,<span class="_ _11"> </span>and<span class="_ _16"> </span>begin<span class="_ _11"> </span>accepting<span class="_ _11"> </span>connection<span class="_ _16"> </span>requests</div><div class="t m5 x1d h26 y7ca2 ff7 fs19 fc2 sc0 ls0 ws0">immediately<span class="_ _3"></span>.<span class="_ _14"> </span>By<span class="_ _14"> </span>default,<span class="_ _15"> </span>a<span class="_ _14"> </span>restarted<span class="_ _14"> </span>server<span class="_ _14"> </span>will<span class="_ _14"> </span>deny<span class="_ _14"> </span>connection<span class="_ _14"> </span>requests<span class="_ _14"> </span>from</div><div class="t m5 x1d h26 y7ca3 ff7 fs19 fc2 sc0 ls0 ws0">clients<span class="_"> </span>for<span class="_"> </span>approximately<span class="_"> </span>30<span class="_"> </span>seconds<span class="_ _1"></span>,<span class="_"> </span>which<span class="_"> </span>seriously<span class="_"> </span>hinders<span class="_"> </span>debugging.</div><div class="t m5 x29 h26 y7ca4 ff7 fs19 fc2 sc0 ls0 ws0">Since<span class="_ _11"> </span>we<span class="_ _11"> </span>have<span class="_ _11"> </span>called<span class="_ _11"> </span><span class="ffd">getaddrinfo<span class="_ _11"> </span></span>with<span class="_ _16"> </span>the<span class="_"> </span>AI_P<span class="_ _3"></span>ASSIVE<span class="_ _11"> </span>ﬂag<span class="_ _11"> </span>and<span class="_ _11"> </span>a<span class="_ _11"> </span>NULL</div><div class="t m5 x1d h26 y7ca5 ffd fs19 fc2 sc0 ls0 ws0">host<span class="_ _14"> </span><span class="ff7">argument,<span class="_ _21"> </span>the<span class="_ _15"> </span>address<span class="_ _14"> </span>ﬁeld<span class="_ _15"> </span>in<span class="_ _15"> </span>each<span class="_ _15"> </span>socket<span class="_ _14"> </span>address<span class="_ _15"> </span>structure<span class="_ _15"> </span>is<span class="_ _14"> </span>set<span class="_ _15"> </span>to<span class="_ _15"> </span>the</span></div><div class="t m5 x1d h26 y7ca6 ff7 fs19 fc2 sc0 ls0 ws0">wildcard<span class="_ _13"> </span>address<span class="_ _1"></span>,<span class="_"> </span>which<span class="_ _13"> </span>tells<span class="_ _13"> </span>the<span class="_ _13"> </span>kernel<span class="_"> </span>that<span class="_ _13"> </span>this<span class="_ _13"> </span>server<span class="_ _13"> </span>will<span class="_"> </span>accept<span class="_ _13"> </span>requests<span class="_ _13"> </span>to<span class="_ _13"> </span>any</div><div class="t m5 x1d h26 y7ca7 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_"> </span>IP<span class="_"> </span>addresses<span class="_"> </span>for<span class="_"> </span>this<span class="_"> </span>host.</div><div class="t m5 x29 h26 y7ca8 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>inally<span class="_ _3"></span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>call<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">listen<span class="_ _6"> </span></span>function<span class="_ _13"> </span>to<span class="_ _6"> </span>convert<span class="_ _13"> </span><span class="ffd">listenfd<span class="_ _6"> </span></span>to<span class="_ _13"> </span>a<span class="_ _6"> </span>listening<span class="_ _13"> </span>descrip-</div><div class="t m5 x1d h26 y7ca9 ff7 fs19 fc2 sc0 ls0 ws0">tor<span class="_ _13"> </span>and<span class="_ _13"> </span>return<span class="_ _13"> </span>it<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>caller.<span class="_ _13"> </span>If<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">listen<span class="_ _13"> </span></span>fails<span class="_ _1"></span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>are<span class="_ _13"> </span>careful<span class="_ _13"> </span>to<span class="_ _13"> </span>avoid<span class="_"> </span>a<span class="_ _13"> </span>memory</div><div class="t m5 x1d h26 y7caa ff7 fs19 fc2 sc0 ls0 ws0">leak<span class="_"> </span>by<span class="_"> </span>closing<span class="_"> </span>the<span class="_"> </span>descriptor<span class="_"> </span>before<span class="_"> </span>returning.</div><div class="t m5 x1d h41 y322b ffe fs29 fc2 sc0 ls0 ws0">11.4.9<span class="_ _48"> </span><span class="fs19">Example<span class="_"> </span>Echo<span class="_"> </span>Client<span class="_"> </span>and<span class="_"> </span>Server</span></div><div class="t m5 x1d h26 y2b69 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>best<span class="_"> </span>way<span class="_ _13"> </span>to<span class="_"> </span>learn<span class="_"> </span>the<span class="_ _13"> </span>sockets<span class="_"> </span>interface<span class="_ _13"> </span>is<span class="_"> </span>to<span class="_"> </span>study<span class="_ _13"> </span>example<span class="_"> </span>code<span class="_ _1"></span>.<span class="_"> </span>F<span class="_ _0"></span>igure<span class="_"> </span>11.20</div><div class="t m5 x1d h26 y2b6b ff7 fs19 fc2 sc0 ls0 ws0">shows<span class="_ _13"> </span>the<span class="_ _13"> </span>code<span class="_"> </span>for<span class="_ _13"> </span>an<span class="_ _13"> </span>echo<span class="_ _13"> </span>client.<span class="_"> </span>After<span class="_ _13"> </span>establishing<span class="_ _13"> </span>a<span class="_ _13"> </span>connection<span class="_"> </span>with<span class="_ _13"> </span>the<span class="_ _13"> </span>server,</div><div class="t m5 x1d h26 y7cab ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>client<span class="_ _13"> </span>enters<span class="_ _6"> </span>a<span class="_ _13"> </span>loop<span class="_ _13"> </span>that<span class="_ _13"> </span>repeatedly<span class="_ _6"> </span>reads<span class="_ _13"> </span>a<span class="_ _13"> </span>text<span class="_ _13"> </span>line<span class="_ _13"> </span>from<span class="_ _6"> </span>standard<span class="_ _13"> </span>input,<span class="_ _13"> </span>sends</div><div class="t m5 x1d h26 y7cac ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>text<span class="_ _13"> </span>line<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>server,<span class="_ _13"> </span>reads<span class="_ _13"> </span>the<span class="_ _13"> </span>echo<span class="_ _13"> </span>line<span class="_ _13"> </span>from<span class="_ _13"> </span>the<span class="_ _13"> </span>server<span class="_ _0"></span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>prints<span class="_ _13"> </span>the<span class="_ _13"> </span>result</div><div class="t m5 x1d h26 y7cad ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _13"> </span>standard<span class="_ _6"> </span>output.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>loop<span class="_ _6"> </span>terminates<span class="_ _13"> </span>when<span class="_ _6"> </span><span class="ffd">fgets<span class="_ _13"> </span></span>encounters<span class="_ _6"> </span>EOF<span class="_ _13"> </span>on<span class="_ _6"> </span>standard</div><div class="t m5 x1d h26 y7cae ff7 fs19 fc2 sc0 ls0 ws0">input,<span class="_ _15"> </span>either<span class="_ _14"> </span>because<span class="_ _15"> </span>the<span class="_ _14"> </span>user<span class="_ _15"> </span>typed<span class="_ _14"> </span>Ctrl+D<span class="_ _14"> </span>at<span class="_ _15"> </span>the<span class="_ _14"> </span>keyboard<span class="_ _15"> </span>or<span class="_ _14"> </span>because<span class="_ _14"> </span>it<span class="_ _15"> </span>has</div><div class="t m5 x1d h26 y7caf ff7 fs19 fc2 sc0 ls0 ws0">exhausted<span class="_"> </span>the<span class="_"> </span>text<span class="_"> </span>lines<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>redirected<span class="_"> </span>input<span class="_"> </span>ﬁle<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y7cb0 ff7 fs19 fc2 sc0 ls0 ws0">After<span class="_ _11"> </span>the<span class="_ _16"> </span>loop<span class="_ _11"> </span>terminates<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>client<span class="_ _11"> </span>closes<span class="_ _16"> </span>the<span class="_ _11"> </span>descriptor.<span class="_ _11"> </span>T<span class="_ _0"></span>his<span class="_ _11"> </span>results<span class="_ _16"> </span>in<span class="_ _11"> </span>an</div><div class="t m5 x1d h26 y7cb1 ff7 fs19 fc2 sc0 ls0 ws0">EOF<span class="_ _6"> </span>notiﬁcation<span class="_ _13"> </span>being<span class="_ _6"> </span>sent<span class="_ _13"> </span>to<span class="_ _6"> </span>the<span class="_ _13"> </span>server<span class="_ _0"></span>,<span class="_ _13"> </span>which<span class="_ _6"> </span>it<span class="_ _13"> </span>detects<span class="_ _6"> </span>when<span class="_ _13"> </span>it<span class="_ _6"> </span>receives<span class="_ _13"> </span>a<span class="_ _6"> </span>return</div><div class="t m5 x1d h26 y7cb2 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _16"> </span>of<span class="_ _14"> </span>zero<span class="_ _14"> </span>from<span class="_ _14"> </span>its<span class="_ _14"> </span><span class="ffd">rio_readlineb<span class="_ _14"> </span></span>function.<span class="_ _14"> </span>After<span class="_ _16"> </span>closing<span class="_ _14"> </span>its<span class="_ _14"> </span>descriptor,<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y7cb3 ff7 fs19 fc2 sc0 ls0 ws0">client<span class="_ _6"> </span>terminates<span class="_ _1"></span>.<span class="_ _13"> </span>Since<span class="_ _a"> </span>the<span class="_ _13"> </span>client’<span class="_ _1"></span>s<span class="_ _13"> </span>kernel<span class="_ _a"> </span>automatically<span class="_ _13"> </span>closes<span class="_ _a"> </span>all<span class="_ _13"> </span>open<span class="_ _a"> </span>descriptors</div><div class="t m5 x1d h26 y7cb4 ff7 fs19 fc2 sc0 ls0 ws0">when<span class="_ _6"> </span>a<span class="_ _6"> </span>process<span class="_ _6"> </span>terminates<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _a"> </span><span class="ffd">close<span class="_ _13"> </span></span>in<span class="_ _a"> </span>line<span class="_ _6"> </span>24<span class="_ _6"> </span>is<span class="_ _6"> </span>not<span class="_ _13"> </span>necessary<span class="_ _7"></span>.<span class="_ _6"> </span>However,<span class="_ _6"> </span>it<span class="_ _6"> </span>is<span class="_ _6"> </span>good</div><div class="t m5 x1d h26 y7cb5 ff7 fs19 fc2 sc0 ls0 ws0">programming<span class="_"> </span>practice<span class="_"> </span>to<span class="_"> </span>explicitly<span class="_"> </span>close<span class="_"> </span>any<span class="_"> </span>descriptors<span class="_"> </span>that<span class="_"> </span>you<span class="_"> </span>have<span class="_"> </span>opened.</div><div class="t m5 x29 h26 y7cb6 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>11.21<span class="_ _16"> </span>shows<span class="_ _16"> </span>the<span class="_ _16"> </span>main<span class="_ _16"> </span>routine<span class="_ _11"> </span>for<span class="_ _16"> </span>the<span class="_ _16"> </span>echo<span class="_ _16"> </span>server.<span class="_ _11"> </span>After<span class="_ _16"> </span>opening<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y7cb7 ff7 fs19 fc2 sc0 ls0 ws0">listening<span class="_ _13"> </span>descriptor<span class="_ _1"></span>,<span class="_ _13"> </span>it<span class="_ _13"> </span>enters<span class="_ _13"> </span>an<span class="_ _13"> </span>inﬁnite<span class="_ _6"> </span>loop<span class="_ _0"></span>.<span class="_ _13"> </span>Each<span class="_ _6"> </span>iteration<span class="_ _13"> </span>waits<span class="_ _13"> </span>for<span class="_ _6"> </span>a<span class="_ _13"> </span>connection</div><div class="t m5 x1d h26 y7cb8 ff7 fs19 fc2 sc0 ls0 ws0">request<span class="_ _6"> </span>from<span class="_ _13"> </span>a<span class="_ _a"> </span>client,<span class="_ _13"> </span>prints<span class="_ _6"> </span>the<span class="_ _13"> </span>domain<span class="_ _a"> </span>name<span class="_ _13"> </span>and<span class="_ _6"> </span>port<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _a"> </span>connected<span class="_ _13"> </span>client,<span class="_ _6"> </span>and</div><div class="t m5 x1d h26 y7cb9 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_ _13"> </span>calls<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">echo<span class="_ _13"> </span></span>function<span class="_ _13"> </span>that<span class="_ _6"> </span>services<span class="_ _13"> </span>the<span class="_ _13"> </span>client.<span class="_ _6"> </span>After<span class="_ _13"> </span>the<span class="_ _13"> </span>echo<span class="_ _13"> </span>routine<span class="_ _6"> </span>returns<span class="_ _1"></span>,</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
