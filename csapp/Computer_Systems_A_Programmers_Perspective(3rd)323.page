<div id="pf143" class="pf w2 h11" data-page-no="143"><div class="pc pc143 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg143.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">322<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">regions<span class="_ _6"> </span>of<span class="_ _13"> </span>memory<span class="_ _6"> </span>each<span class="_ _13"> </span>time<span class="_ _6"> </span>a<span class="_ _13"> </span>program<span class="_ _6"> </span>is<span class="_ _13"> </span>run.<span class="_ _6"> </span>T<span class="_ _1"></span>hat<span class="_ _13"> </span>means<span class="_ _6"> </span>that<span class="_ _13"> </span>a<span class="_ _6"> </span>program<span class="_ _13"> </span>running</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_ _13"> </span>one<span class="_ _13"> </span>machine<span class="_ _13"> </span>will<span class="_ _13"> </span>have<span class="_ _13"> </span>very<span class="_ _13"> </span>different<span class="_ _13"> </span>address<span class="_ _13"> </span>mappings<span class="_ _13"> </span>than<span class="_ _13"> </span>the<span class="_ _13"> </span>same<span class="_ _13"> </span>program</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">running<span class="_"> </span>on<span class="_"> </span>other<span class="_"> </span>machines<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>can<span class="_"> </span>thwart<span class="_"> </span>some<span class="_"> </span>forms<span class="_"> </span>of<span class="_"> </span>attack.</div><div class="t m5 x29 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">Overall,<span class="_ _13"> </span>however,<span class="_ _13"> </span>a<span class="_ _13"> </span>persistent<span class="_ _6"> </span>attacker<span class="_ _13"> </span>can<span class="_ _13"> </span>overcome<span class="_ _13"> </span>randomization<span class="_ _6"> </span>by<span class="_ _13"> </span>brute</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">force<span class="_ _1"></span>,<span class="_ _11"> </span>repeatedly<span class="_ _11"> </span>attempting<span class="_"> </span>attacks<span class="_ _11"> </span>with<span class="_ _11"> </span>different<span class="_"> </span>addresses<span class="_ _1"></span>.<span class="_ _11"> </span>A<span class="_"> </span>common<span class="_ _11"> </span>trick<span class="_ _11"> </span>is</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _13"> </span>include<span class="_ _13"> </span>a<span class="_ _13"> </span>long<span class="_ _13"> </span>sequence<span class="_"> </span>of<span class="_ _13"> </span><span class="ffd">nop<span class="_ _13"> </span></span>(pronounced<span class="_ _13"> </span>“no<span class="_ _13"> </span>op<span class="_ _1"></span>,<span class="_ _1"></span>”<span class="_"> </span>short<span class="_ _13"> </span>for<span class="_ _13"> </span>“no<span class="_ _13"> </span>operation”)</div><div class="t m5 x1d h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">instructions<span class="_ _11"> </span>before<span class="_ _16"> </span>the<span class="_ _16"> </span>actual<span class="_ _11"> </span>exploit<span class="_ _16"> </span>code<span class="_ _1"></span>.<span class="_ _16"> </span>Executing<span class="_ _16"> </span>this<span class="_ _11"> </span>instruction<span class="_ _16"> </span>has<span class="_ _16"> </span>no<span class="_ _11"> </span>ef-</div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">fect,<span class="_ _13"> </span>other<span class="_ _13"> </span>than<span class="_ _13"> </span>incrementing<span class="_ _6"> </span>the<span class="_ _13"> </span>program<span class="_ _13"> </span>counter<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _6"> </span>next<span class="_ _13"> </span>instruction.<span class="_ _13"> </span>As<span class="_ _13"> </span>long</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_ _13"> </span>the<span class="_ _6"> </span>attacker<span class="_ _13"> </span>can<span class="_ _13"> </span>guess<span class="_ _13"> </span>an<span class="_ _6"> </span>address<span class="_ _13"> </span>somewhere<span class="_ _13"> </span>within<span class="_ _6"> </span>this<span class="_ _13"> </span>sequence<span class="_ _0"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>program</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">will<span class="_ _13"> </span>run<span class="_ _13"> </span>through<span class="_ _13"> </span>the<span class="_ _13"> </span>sequence<span class="_ _6"> </span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>hit<span class="_ _13"> </span>the<span class="_ _13"> </span>exploit<span class="_ _13"> </span>code<span class="_ _1"></span>.<span class="_ _13"> </span>The<span class="_ _6"> </span>common<span class="_ _13"> </span>term<span class="_ _13"> </span>for</div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">this<span class="_ _11"> </span>sequence<span class="_ _16"> </span>is<span class="_ _11"> </span>a<span class="_ _11"> </span>“nop<span class="_ _11"> </span>sled”<span class="_ _16"> </span>[97],<span class="_ _11"> </span>expressing<span class="_ _16"> </span>the<span class="_ _11"> </span>idea<span class="_ _11"> </span>that<span class="_ _16"> </span>the<span class="_ _11"> </span>program<span class="_ _11"> </span>“slides”</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">through<span class="_ _16"> </span>the<span class="_ _11"> </span>sequence.<span class="_ _11"> </span>If<span class="_ _16"> </span>we<span class="_ _11"> </span>set<span class="_ _16"> </span>up<span class="_ _16"> </span>a<span class="_ _11"> </span>256-byte<span class="_ _16"> </span>nop<span class="_ _16"> </span>sled,<span class="_ _16"> </span>then<span class="_ _11"> </span>the<span class="_ _16"> </span>randomization</div><div class="t m5 x1d h46 y2e1b ff7 fs19 fc2 sc0 ls0 ws0">over<span class="_ _13"> </span><span class="ff11">n<span class="_ _13"> </span><span class="ff12">=<span class="_ _13"></span></span></span>2</div><div class="t m5 x33 h3c y2e1c ff7 fs25 fc2 sc0 ls0 ws0">23</div><div class="t m5 x18e h26 y2e1d ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_ _13"> </span>be<span class="_ _6"> </span>cracked<span class="_ _13"> </span>by<span class="_ _13"> </span>enumerating<span class="_ _13"> </span>2</div><div class="t m5 x15f h3c y2e1c ff7 fs25 fc2 sc0 ls0 ws0">15</div><div class="t m5 x19a h46 y2e1d ff12 fs19 fc2 sc0 ls0 ws0">=<span class="_ _13"></span><span class="ff7">32<span class="ff11">,</span>768<span class="_ _13"> </span>starting<span class="_ _13"> </span>addresses<span class="_ _3"></span>,<span class="_ _13"> </span>which</span></div><div class="t m5 x1d h26 y2e1e ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _13"> </span>entirely<span class="_ _6"> </span>feasible<span class="_ _13"> </span>for<span class="_ _13"> </span>a<span class="_ _6"> </span>determined<span class="_ _13"> </span>attacker.<span class="_ _6"> </span>F<span class="_ _1"></span>or<span class="_ _13"> </span>the<span class="_ _13"> </span>64-bit<span class="_ _6"> </span>case,<span class="_ _13"> </span>trying<span class="_ _6"> </span>to<span class="_ _13"> </span>enumer<span class="_ _1"></span>-</div><div class="t m5 x1d h26 y2e1f ff7 fs19 fc2 sc0 ls0 ws0">ate<span class="_"> </span>2</div><div class="t m5 xce h3c y2e20 ff7 fs25 fc2 sc0 ls0 ws0">24</div><div class="t m5 xa3 h46 y2e21 ff12 fs19 fc2 sc0 ls0 ws0">=<span class="_ _13"> </span><span class="ff7">16<span class="ff11">,</span>777<span class="ff11">,</span>216<span class="_"> </span>is<span class="_"> </span>a<span class="_"> </span>bit<span class="_"> </span>more<span class="_ _11"> </span>daunting.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>can<span class="_"> </span>see<span class="_"> </span>that<span class="_"> </span>stack<span class="_"> </span>randomization</span></div><div class="t m5 x1d h26 y2e22 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _13"> </span>other<span class="_ _6"> </span>aspects<span class="_ _13"> </span>of<span class="_ _6"> </span>ASLR<span class="_ _13"> </span>can<span class="_ _6"> </span>increase<span class="_ _13"> </span>the<span class="_ _6"> </span>effort<span class="_ _13"> </span>required<span class="_ _6"> </span>to<span class="_ _13"> </span>successfully<span class="_ _6"> </span>attack<span class="_ _13"> </span>a</div><div class="t m5 x1d h26 y2e23 ff7 fs19 fc2 sc0 ls0 ws0">system,<span class="_ _13"> </span>and<span class="_ _13"> </span>therefore<span class="_ _13"> </span>greatly<span class="_ _13"> </span>reduce<span class="_ _13"> </span>the<span class="_ _13"> </span>rate<span class="_ _13"> </span>at<span class="_ _13"> </span>which<span class="_ _13"> </span>a<span class="_ _13"> </span>virus<span class="_ _13"> </span>or<span class="_ _13"> </span>worm<span class="_ _13"> </span>can<span class="_ _13"> </span>spread,</div><div class="t m5 x1d h26 y2e24 ff7 fs19 fc2 sc0 ls0 ws0">but<span class="_"> </span>it<span class="_"> </span>cannot<span class="_"> </span>provide<span class="_"> </span>a<span class="_"> </span>complete<span class="_"> </span>safeguard.</div><div class="t m5 x1d h47 y2e25 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>3.47<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>383)</span></div><div class="t m5 x1d h26 y2e26 ff7 fs19 fc1 sc0 ls0 ws0">Running<span class="_ _14"> </span>our<span class="_ _14"> </span>stack-checking<span class="_ _14"> </span>code<span class="_ _14"> </span>10,000<span class="_ _14"> </span>times<span class="_ _14"> </span>on<span class="_ _14"> </span>a<span class="_ _14"> </span>system<span class="_ _14"> </span>running<span class="_ _14"> </span>Linux<span class="_ _14"> </span>ver<span class="_ _0"></span>-</div><div class="t m5 x1d h26 y2e27 ff7 fs19 fc1 sc0 ls0 ws0">sion<span class="_ _11"> </span>2.6.16,<span class="_ _16"> </span>we<span class="_ _11"> </span>obtained<span class="_ _11"> </span>addresses<span class="_ _16"> </span>ranging<span class="_ _11"> </span>from<span class="_ _11"> </span>a<span class="_ _11"> </span>minimum<span class="_ _16"> </span>of<span class="_ _11"> </span><span class="ffd">0xffffb754<span class="_ _11"> </span></span>to<span class="_ _16"> </span>a</div><div class="t m5 x1d h26 y2e28 ff7 fs19 fc1 sc0 ls0 ws0">maximum<span class="_"> </span>of<span class="_"> </span><span class="ffd">0xffffd754</span>.</div><div class="t m5 x124 h26 y2e29 ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>What<span class="_"> </span>is<span class="_"> </span>the<span class="_"> </span>approximate<span class="_"> </span>range<span class="_"> </span>of<span class="_"> </span>addresses?</div><div class="t m5 x124 h26 y2e2a ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>If<span class="_"> </span>we<span class="_ _13"> </span>attempted<span class="_"> </span>a<span class="_ _13"> </span>buffer<span class="_"> </span>overrun<span class="_ _13"> </span>with<span class="_"> </span>a<span class="_ _13"> </span>128-byte<span class="_"> </span>nop<span class="_ _13"> </span>sled,<span class="_"> </span>about<span class="_ _13"> </span>how<span class="_"> </span>many</div><div class="t m5 x4f h26 y2e2b ff7 fs19 fc1 sc0 ls0 ws0">attempts<span class="_"> </span>would<span class="_"> </span>it<span class="_"> </span>take<span class="_"> </span>to<span class="_"> </span>test<span class="_"> </span>all<span class="_"> </span>starting<span class="_"> </span>addresses?</div><div class="t m5 x1d h42 y2e2c ff6 fs29 fc6 sc0 ls0 ws0">Stack<span class="_ _11"> </span>Corruption<span class="_ _16"> </span>Detection</div><div class="t m5 x1d h26 y2e2d ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_"> </span>second<span class="_"> </span>line<span class="_"> </span>of<span class="_"> </span>defense<span class="_"> </span>is<span class="_"> </span>to<span class="_"> </span>be<span class="_"> </span>able<span class="_"> </span>to<span class="_"> </span>detect<span class="_"> </span>when<span class="_"> </span>a<span class="_"> </span>stack<span class="_"> </span>has<span class="_"> </span>been<span class="_"> </span>corrupted.</div><div class="t m5 x1d h26 y2e2e ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _15"> </span>saw<span class="_ _15"> </span>in<span class="_ _15"> </span>the<span class="_ _15"> </span>example<span class="_ _15"> </span>of<span class="_ _15"> </span>the<span class="_ _14"> </span><span class="ffd">echo<span class="_ _15"> </span></span>function<span class="_ _15"> </span>(Figure<span class="_ _14"> </span>3.40)<span class="_ _15"> </span>that<span class="_ _15"> </span>the<span class="_ _15"> </span>corruption</div><div class="t m5 x1d h26 y2e2f ff7 fs19 fc1 sc0 ls0 ws0">typically<span class="_ _16"> </span>occurs<span class="_ _14"> </span>when<span class="_ _16"> </span>the<span class="_ _14"> </span>program<span class="_ _16"> </span>overruns<span class="_ _16"> </span>the<span class="_ _14"> </span>bounds<span class="_ _16"> </span>of<span class="_ _14"> </span>a<span class="_ _16"> </span>local<span class="_ _14"> </span>buffer.<span class="_ _16"> </span>In<span class="_ _16"> </span>C,</div><div class="t m5 x1d h26 y2e30 ff7 fs19 fc1 sc0 ls0 ws0">there<span class="_ _13"> </span>is<span class="_ _13"> </span>no<span class="_ _13"> </span>reliable<span class="_ _13"> </span>way<span class="_ _13"> </span>to<span class="_ _13"> </span>prevent<span class="_ _13"> </span>writing<span class="_ _13"> </span>beyond<span class="_ _13"> </span>the<span class="_ _13"> </span>bounds<span class="_ _13"> </span>of<span class="_ _13"> </span>an<span class="_"> </span>array<span class="_ _7"></span>.<span class="_ _13"> </span>Instead,</div><div class="t m5 x1d h26 y2e31 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>program<span class="_ _11"> </span>can<span class="_ _16"> </span>attempt<span class="_ _11"> </span>to<span class="_ _11"> </span>detect<span class="_ _16"> </span>when<span class="_"> </span>such<span class="_ _16"> </span>a<span class="_ _11"> </span>write<span class="_ _11"> </span>has<span class="_ _16"> </span>occurred<span class="_ _11"> </span>before<span class="_ _11"> </span>it<span class="_ _11"> </span>can</div><div class="t m5 x1d h26 y2e32 ff7 fs19 fc1 sc0 ls0 ws0">have<span class="_"> </span>any<span class="_"> </span>harmful<span class="_"> </span>effects<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2e33 ff7 fs19 fc1 sc0 ls0 ws0">Recent<span class="_ _11"> </span>versions<span class="_ _11"> </span>of<span class="_ _11"> </span><span class="ff9">gcc<span class="_ _11"> </span></span>incorporate<span class="_ _11"> </span>a<span class="_ _11"> </span>mechanism<span class="_ _11"> </span>known<span class="_ _11"> </span>as<span class="_ _11"> </span>a<span class="_ _11"> </span><span class="ffa">stack<span class="_ _11"> </span>protector</span></div><div class="t m5 x1d h26 y2e34 ff7 fs19 fc1 sc0 ls0 ws0">into<span class="_ _16"> </span>the<span class="_ _16"> </span>generated<span class="_ _16"> </span>code<span class="_ _11"> </span>to<span class="_ _16"> </span>detect<span class="_ _16"> </span>buffer<span class="_ _16"> </span>overruns<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span>idea<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _11"> </span>store<span class="_ _16"> </span>a<span class="_ _16"> </span>special</div><div class="t m5 x1d h26 y2e35 ffa fs19 fc1 sc0 ls0 ws0">canary<span class="_ _13"> </span><span class="ff7">value</span></div><div class="t m5 x1c6 h3c y2e36 ff7 fs25 fc1 sc0 ls0 ws0">4</div><div class="t m5 x1a h26 y2e37 ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_ _13"> </span>the<span class="_ _13"> </span>stack<span class="_"> </span>frame<span class="_ _13"> </span>between<span class="_ _13"> </span>any<span class="_ _13"> </span>local<span class="_ _13"> </span>buffer<span class="_ _13"> </span>and<span class="_"> </span>the<span class="_ _13"> </span>rest<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>stack</div><div class="t m5 x1d h26 y2e38 ff7 fs19 fc1 sc0 ls0 ws0">state<span class="_ _1"></span>,<span class="_ _11"> </span>as<span class="_"> </span>illustrated<span class="_"> </span>in<span class="_"> </span>Figure<span class="_"> </span>3.42<span class="_"> </span>[26,<span class="_"> </span>97].<span class="_"> </span>This<span class="_"> </span>canary<span class="_"> </span>value<span class="_ _1"></span>,<span class="_"> </span>also<span class="_ _11"> </span>referred<span class="_"> </span>to<span class="_"> </span>as<span class="_"> </span>a</div><div class="t m5 x1d h26 y2e39 ffa fs19 fc1 sc0 ls0 ws0">guard<span class="_ _13"> </span>value<span class="ff7">,<span class="_ _13"> </span>is<span class="_ _13"> </span>generated<span class="_ _13"> </span>randomly<span class="_ _13"> </span>each<span class="_ _13"> </span>time<span class="_ _13"> </span>the<span class="_ _13"> </span>program<span class="_ _13"> </span>runs<span class="_ _0"></span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>so<span class="_ _13"> </span>there<span class="_ _13"> </span>is<span class="_ _13"> </span>no</span></div><div class="t m5 x1d h1d y2e3a ff7 fs17 fc2 sc0 ls0 ws0">4.<span class="_ _6"> </span>The<span class="_ _6"> </span>term<span class="_"> </span>“canary”<span class="_ _6"> </span>refers<span class="_"> </span>to<span class="_ _6"> </span>the<span class="_ _6"> </span>historic<span class="_"> </span>use<span class="_ _6"> </span>of<span class="_"> </span>these<span class="_ _6"> </span>birds<span class="_"> </span>to<span class="_ _6"> </span>detect<span class="_"> </span>the<span class="_ _6"> </span>presence<span class="_"> </span>of<span class="_ _6"> </span>dangerous<span class="_ _6"> </span>gases</div><div class="t m5 x1d h1d y2e3b ff7 fs17 fc2 sc0 ls0 ws0">in<span class="_"> </span>coal<span class="_"> </span>mines<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
