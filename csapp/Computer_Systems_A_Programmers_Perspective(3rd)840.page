<div id="pf348" class="pf w2 h11" data-page-no="348"><div class="pc pc348 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg348.png"/><div class="t m5 x1d9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.1<span class="_ _60"> </span>Physical<span class="_ _10"> </span>and<span class="_ _10"> </span>Virtual<span class="_ _10"> </span>Addressing<span class="_ _1b"> </span><span class="ffe fs1e">839</span></div><div class="t m5 x26 h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _14"> </span>chapter<span class="_ _16"> </span>looks<span class="_ _14"> </span>at<span class="_ _14"> </span>virtual<span class="_ _16"> </span>memory<span class="_ _14"> </span>from<span class="_ _16"> </span>two<span class="_ _14"> </span>angles<span class="_ _1"></span>.<span class="_ _14"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span>ﬁrst<span class="_ _14"> </span>half<span class="_ _16"> </span>of<span class="_ _14"> </span>the</div><div class="t m5 x17 h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">chapter<span class="_ _f"> </span>describes<span class="_ _f"> </span>how<span class="_ _f"> </span>virtual<span class="_ _f"> </span>memory<span class="_ _f"> </span>works<span class="_ _1"></span>.<span class="_ _f"> </span>T<span class="_ _1"></span>he<span class="_ _f"> </span>second<span class="_ _f"> </span>half<span class="_ _f"> </span>describes<span class="_ _f"> </span>how</div><div class="t m5 x17 h26 y40a ff7 fs19 fc2 sc0 ls0 ws0">virtual<span class="_ _14"> </span>memory<span class="_ _14"> </span>is<span class="_ _14"> </span>used<span class="_ _14"> </span>and<span class="_ _14"> </span>managed<span class="_ _14"> </span>by<span class="_ _15"> </span>applications<span class="_ _1"></span>.<span class="_ _14"> </span>T<span class="_ _1"></span>here<span class="_ _15"> </span>is<span class="_ _14"> </span>no<span class="_ _14"> </span>avoiding<span class="_ _14"> </span>the</div><div class="t m5 x17 h26 y40b ff7 fs19 fc2 sc0 ls0 ws0">fact<span class="_ _16"> </span>that<span class="_ _11"> </span>VM<span class="_ _16"> </span>is<span class="_ _16"> </span>complicated,<span class="_ _16"> </span>and<span class="_ _11"> </span>the<span class="_ _16"> </span>discussion<span class="_ _16"> </span>reﬂects<span class="_ _11"> </span>this<span class="_ _16"> </span>in<span class="_ _16"> </span>places<span class="_ _3"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>good</div><div class="t m5 x17 h26 y40c ff7 fs19 fc2 sc0 ls0 ws0">news<span class="_ _13"> </span>is<span class="_ _13"> </span>that<span class="_ _13"> </span>if<span class="_ _6"> </span>you<span class="_ _13"> </span>work<span class="_ _13"> </span>through<span class="_ _13"> </span>the<span class="_ _13"> </span>details<span class="_ _1"></span>,<span class="_ _13"> </span>you<span class="_ _13"> </span>will<span class="_ _13"> </span>be<span class="_ _13"> </span>able<span class="_ _6"> </span>to<span class="_ _13"> </span>simulate<span class="_ _13"> </span>the<span class="_ _13"> </span>virtual</div><div class="t m5 x17 h26 y40d ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_"> </span>mechanism<span class="_"> </span>of<span class="_ _11"> </span>a<span class="_"> </span>small<span class="_"> </span>system<span class="_ _11"> </span>by<span class="_"> </span>hand,<span class="_ _11"> </span>and<span class="_"> </span>the<span class="_"> </span>virtual<span class="_ _11"> </span>memory<span class="_"> </span>idea<span class="_ _11"> </span>will</div><div class="t m5 x17 h26 y40e ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_"> </span>forever<span class="_"> </span>demystiﬁed.</div><div class="t m5 x26 h26 y40f ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>second<span class="_ _16"> </span>half<span class="_ _14"> </span>builds<span class="_ _16"> </span>on<span class="_ _16"> </span>this<span class="_ _14"> </span>understanding,<span class="_ _16"> </span>showing<span class="_ _14"> </span>you<span class="_ _16"> </span>how<span class="_ _14"> </span>to<span class="_ _16"> </span>use<span class="_ _14"> </span>and</div><div class="t m5 x17 h26 y410 ff7 fs19 fc2 sc0 ls0 ws0">manage<span class="_"> </span>virtual<span class="_ _11"> </span>memory<span class="_ _11"> </span>in<span class="_ _11"> </span>your<span class="_ _11"> </span>programs<span class="_ _1"></span>.<span class="_ _11"> </span>Y<span class="_ _3"></span>ou<span class="_ _11"> </span>will<span class="_ _11"> </span>learn<span class="_ _11"> </span>how<span class="_ _11"> </span>to<span class="_ _11"> </span>manage<span class="_ _11"> </span>virtual</div><div class="t m5 x17 h26 y411 ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_ _13"> </span>via<span class="_ _6"> </span>explicit<span class="_ _13"> </span>memory<span class="_ _6"> </span>mapping<span class="_ _13"> </span>and<span class="_ _6"> </span>calls<span class="_ _13"> </span>to<span class="_ _6"> </span>dynamic<span class="_ _13"> </span>storage<span class="_ _13"> </span>allocators<span class="_ _6"> </span>such</div><div class="t m5 x17 h26 y412 ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_ _15"> </span>the<span class="_ _15"> </span><span class="ffd">malloc<span class="_ _15"> </span></span>package<span class="_ _1"></span>.<span class="_ _15"> </span>Y<span class="_ _3"></span>ou<span class="_ _15"> </span>will<span class="_ _15"> </span>also<span class="_ _15"> </span>learn<span class="_ _15"> </span>about<span class="_ _15"> </span>a<span class="_ _15"> </span>host<span class="_ _15"> </span>of<span class="_ _15"> </span>common<span class="_ _15"> </span>memory-</div><div class="t m5 x17 h26 y413 ff7 fs19 fc2 sc0 ls0 ws0">related<span class="_"> </span>errors<span class="_"> </span>in<span class="_"> </span>C<span class="_"> </span>programs<span class="_"> </span>and<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>avoid<span class="_"> </span>them.</div><div class="t m5 x17 h3b y6bdd fff fs24 fc6 sc0 ls0 ws0">9.1<span class="_ _17"> </span><span class="ffe fs18">Physical<span class="_"> </span>and<span class="_"> </span>Virtual<span class="_"> </span>Addressing</span></div><div class="t m5 x17 h26 y6bde ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>main<span class="_ _13"> </span>memory<span class="_"> </span>of<span class="_ _13"> </span>a<span class="_ _13"> </span>computer<span class="_"> </span>system<span class="_ _13"> </span>is<span class="_ _13"> </span>organized<span class="_"> </span>as<span class="_ _13"> </span>an<span class="_"> </span>array<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ff11">M<span class="_"> </span></span>contiguous</div><div class="t m5 x17 h26 y6bdf ff7 fs19 fc1 sc0 ls0 ws0">byte-size<span class="_ _16"> </span>cells<span class="_ _1"></span>.<span class="_ _16"> </span>Each<span class="_ _16"> </span>byte<span class="_ _16"> </span>has<span class="_ _16"> </span>a<span class="_ _16"> </span>unique<span class="_ _16"> </span><span class="ffa">physical<span class="_ _16"> </span>address<span class="_ _16"> </span>(P<span class="_ _3"></span>A)<span class="_ _1"></span><span class="ff7">.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>ﬁrst<span class="_ _16"> </span>byte<span class="_ _16"> </span>has</span></span></div><div class="t m5 x17 h26 y6be0 ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_ _15"> </span>address<span class="_ _15"> </span>of<span class="_ _15"> </span>0,<span class="_ _f"> </span>the<span class="_ _15"> </span>next<span class="_ _15"> </span>byte<span class="_ _21"> </span>an<span class="_ _15"> </span>address<span class="_ _15"> </span>of<span class="_ _15"> </span>1,<span class="_ _f"> </span>the<span class="_ _15"> </span>next<span class="_ _15"> </span>byte<span class="_ _21"> </span>an<span class="_ _15"> </span>address<span class="_ _15"> </span>of<span class="_ _21"> </span>2,</div><div class="t m5 x17 h26 y6be1 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _14"> </span>so<span class="_ _14"> </span>on.<span class="_ _14"> </span>Given<span class="_ _15"> </span>this<span class="_ _14"> </span>simple<span class="_ _14"> </span>organization,<span class="_ _15"> </span>the<span class="_ _14"> </span>most<span class="_ _15"> </span>natural<span class="_ _14"> </span>way<span class="_ _14"> </span>for<span class="_ _14"> </span>a<span class="_ _15"> </span>CPU<span class="_ _14"> </span>to</div><div class="t m5 x17 h26 y6be2 ff7 fs19 fc1 sc0 ls0 ws0">access<span class="_ _13"> </span>memory<span class="_"> </span>would<span class="_ _13"> </span>be<span class="_ _13"> </span>to<span class="_ _13"> </span>use<span class="_"> </span>physical<span class="_ _13"> </span>addresses<span class="_ _3"></span>.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_ _13"> </span>call<span class="_"> </span>this<span class="_ _13"> </span>approach<span class="_ _13"> </span><span class="ffa">physical</span></div><div class="t m5 x17 h26 y6be3 ffa fs19 fc1 sc0 ls0 ws0">addressing<span class="_ _2"></span><span class="ff7">.<span class="_"> </span>Figure<span class="_"> </span>9.1<span class="_"> </span>shows<span class="_ _11"> </span>an<span class="_ _11"> </span>example<span class="_"> </span>of<span class="_ _11"> </span>physical<span class="_ _11"> </span>addressing<span class="_ _11"> </span>in<span class="_"> </span>the<span class="_ _11"> </span>context<span class="_ _11"> </span>of</span></div><div class="t m5 x17 h26 y6be4 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_"> </span>load<span class="_"> </span>instruction<span class="_ _13"> </span>that<span class="_"> </span>reads<span class="_"> </span>the<span class="_"> </span>4-byte<span class="_"> </span>word<span class="_ _13"> </span>starting<span class="_"> </span>at<span class="_"> </span>physical<span class="_"> </span>address<span class="_"> </span>4.<span class="_ _13"> </span>When</div><div class="t m5 x17 h26 y6be5 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>CPU<span class="_ _11"> </span>executes<span class="_ _11"> </span>the<span class="_ _11"> </span>load<span class="_ _11"> </span>instruction,<span class="_ _11"> </span>it<span class="_"> </span>generates<span class="_ _11"> </span>an<span class="_ _11"> </span>effective<span class="_ _11"> </span>physical<span class="_ _11"> </span>address</div><div class="t m5 x17 h26 y6be6 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _13"> </span>passes<span class="_ _13"> </span>it<span class="_ _6"> </span>to<span class="_ _13"> </span>main<span class="_ _13"> </span>memory<span class="_ _13"> </span>over<span class="_ _6"> </span>the<span class="_ _13"> </span>memory<span class="_ _13"> </span>bus<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>main<span class="_ _13"> </span>memory<span class="_ _13"> </span>fetches<span class="_ _6"> </span>the</div><div class="t m5 x17 h26 y6be7 ff7 fs19 fc1 sc0 ls0 ws0">4-byte<span class="_"> </span>word<span class="_"> </span>starting<span class="_"> </span>at<span class="_"> </span>physical<span class="_ _13"> </span>address<span class="_"> </span>4<span class="_"> </span>and<span class="_"> </span>returns<span class="_"> </span>it<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>CPU<span class="_ _7"></span>,<span class="_"> </span>which<span class="_"> </span>stores</div><div class="t m5 x17 h26 y6be8 ff7 fs19 fc1 sc0 ls0 ws0">it<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>register.</div><div class="t m5 x26 h26 y6be9 ff7 fs19 fc1 sc0 ls0 ws0">Early<span class="_ _16"> </span>PCs<span class="_ _14"> </span>used<span class="_ _14"> </span>physical<span class="_ _16"> </span>addressing,<span class="_ _14"> </span>and<span class="_ _14"> </span>systems<span class="_ _16"> </span>such<span class="_ _14"> </span>as<span class="_ _14"> </span>digital<span class="_ _16"> </span>signal<span class="_ _14"> </span>pro-</div><div class="t m5 x17 h26 y6bea ff7 fs19 fc1 sc0 ls0 ws0">cessors<span class="_ _1"></span>,<span class="_"> </span>embedded<span class="_ _13"> </span>microcontrollers<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _13"> </span>Cray<span class="_"> </span>supercomputers<span class="_ _13"> </span>continue<span class="_"> </span>to<span class="_ _13"> </span>do<span class="_"> </span>so<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y6beb ff7 fs19 fc1 sc0 ls0 ws0">However,<span class="_"> </span>modern<span class="_"> </span>processors<span class="_"> </span>use<span class="_ _11"> </span>a<span class="_"> </span>form<span class="_ _11"> </span>of<span class="_"> </span>addressing<span class="_ _11"> </span>known<span class="_"> </span>as<span class="_ _11"> </span><span class="ffa">virtual<span class="_"> </span>address-</span></div><div class="t m5 x17 h26 y6bec ffa fs19 fc1 sc0 ls0 ws0">ing<span class="_ _2"></span><span class="ff7">,<span class="_"> </span>as<span class="_"> </span>shown<span class="_"> </span>in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>9.2.</span></div><div class="t m5 x17 h2f y6bed ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.1</div><div class="t m5 x17 h2f y6bee ffe fs16 fc1 sc0 ls0 ws0">A<span class="_ _15"> </span>system<span class="_ _15"> </span>that<span class="_ _15"> </span>uses</div><div class="t m5 x17 h2f y6bef ffe fs16 fc1 sc0 ls0 ws0">physical<span class="_"> </span>addressing.</div><div class="t m8 x170 h3f y6bf0 ffa6 fs27 fc1 sc0 ls0 ws0">. . .</div><div class="t m5 x5e h3f y6bf1 ffa6 fs27 fc1 sc0 ls0 ws0">Main memory</div><div class="t m5 x24 h3f y6bf2 ffa6 fs27 fc1 sc0 ls0 ws0">0:</div><div class="t m5 x24 h3f y6bf3 ffa6 fs27 fc1 sc0 ls0 ws0">1:</div><div class="t m5 x24 h3f y6bf4 ffa6 fs27 fc1 sc0 ls0 ws0">2:</div><div class="t m5 x24 h3f y6bf5 ffa6 fs27 fc1 sc0 ls0 ws0">3:</div><div class="t m5 x24 h3f y6bf6 ffa6 fs27 fc1 sc0 ls0 ws0">4:</div><div class="t m5 x24 h3f y6bf7 ffa6 fs27 fc1 sc0 ls0 ws0">5:</div><div class="t m5 x24 h3f y6bf8 ffa6 fs27 fc1 sc0 ls0 ws0">6:</div><div class="t m5 x24 h3f y6bf9 ffa6 fs27 fc1 sc0 ls0 ws0">7:</div><div class="t m5 x24 h3f y6bfa ffa6 fs27 fc1 sc0 ls0 ws0">8:</div><div class="t m5 x176 h3f y6bfb ffa6 fs27 fc1 sc0 ls0 ws0">Physical</div><div class="t m5 x1c8 h3f y6bfc ffa6 fs27 fc1 sc0 ls0 ws0">address</div><div class="t m5 x88 h3f y6bfd ffa6 fs27 fc1 sc0 ls0 ws0">(P<span class="_ _1"></span>A)</div><div class="t m5 x10e h3f y6bfe ffa6 fs27 fc1 sc0 ls0 ws0">CPU</div><div class="t m5 x16 h40 y6bff ffa7 fs28 fc1 sc0 ls0 ws0">4</div><div class="t m5 x99 h3f y6c00 ffa8 fs27 fc1 sc0 ls0 ws0">M<span class="_ _5"></span><span class="ff24"><span class="ffa6">1:</span></span></div><div class="t m5 x16f h3f y6c01 ffa6 fs27 fc1 sc0 ls0 ws0">Data word</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
