<div id="pf412" class="pf w2 h11" data-page-no="412"><div class="pc pc412 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg412.png"/><div class="t m5 x69 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.5<span class="_ _60"> </span>Synchronizing<span class="_ _10"> </span>Threads<span class="_ _10"> </span>with<span class="_ _10"> </span>Semaphores<span class="_ _3e"> </span><span class="ffe fs1e">1041</span></div><div class="t m5 xee h3f y826d ffed fs27 fc1 sc0 ls0 ws0">Producer</div><div class="t m5 x63 h3f y826e ffed fs27 fc1 sc0 ls0 ws0">thread</div><div class="t m5 x192 h3f y826d ffed fs27 fc1 sc0 ls0 ws0">Consumer</div><div class="t m5 x67 h3f y826e ffed fs27 fc1 sc0 ls0 ws0">thread</div><div class="t m5 x10d h3f y826f ffed fs27 fc1 sc0 ls0 ws0">Bounded</div><div class="t m5 x65 h3f y8270 ffed fs27 fc1 sc0 ls0 ws0">buffer</div><div class="t m5 x17 h34 y8271 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _10"> </span>12.23<span class="_ _66"> </span><span class="fc1">Producer-consumer<span class="_"> </span>problem.<span class="_ _13"> </span><span class="ff6">The<span class="_ _10"> </span>producer<span class="_ _13"> </span>generates<span class="_ _10"> </span>items<span class="_ _13"> </span>and<span class="_ _10"> </span>inserts</span></span></div><div class="t m5 x17 h34 y8272 ff6 fs16 fc1 sc0 ls0 ws0">them<span class="_ _16"> </span>into<span class="_ _16"> </span>a<span class="_ _14"> </span>bounded<span class="_ _16"> </span>buffer<span class="_ _1"></span>.<span class="_ _16"> </span>The<span class="_ _14"> </span>consumer<span class="_ _16"> </span>removes<span class="_ _16"> </span>items<span class="_ _14"> </span>from<span class="_ _16"> </span>the<span class="_ _14"> </span>buffer<span class="_ _16"> </span>and<span class="_ _16"> </span>then</div><div class="t m5 x17 h34 y8273 ff6 fs16 fc1 sc0 ls0 ws0">consumes<span class="_ _10"> </span>them.</div><div class="t m5 x17 h26 y8274 ff7 fs19 fc1 sc0 ls0 ws0">operation<span class="_ _11"> </span>to<span class="_ _11"> </span>notify<span class="_ _11"> </span>another<span class="_ _11"> </span>thread<span class="_ _11"> </span>that<span class="_ _11"> </span>some<span class="_ _11"> </span>condition<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _16"> </span>program<span class="_"> </span>state<span class="_ _11"> </span>has</div><div class="t m5 x17 h26 y8275 ff7 fs19 fc1 sc0 ls0 ws0">become<span class="_ _16"> </span>true<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _7"></span>wo<span class="_ _16"> </span>classical<span class="_ _11"> </span>and<span class="_ _16"> </span>useful<span class="_ _16"> </span>examples<span class="_ _11"> </span>are<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffa">producer<span class="_ _1"></span>-consumer<span class="_ _14"> </span><span class="ff7">and</span></span></div><div class="t m5 x17 h26 y8276 ffa fs19 fc1 sc0 ls0 ws0">readers-writers<span class="_"> </span><span class="ff7">problems<span class="_ _1"></span>.</span></div><div class="t m5 x17 h42 y2b56 ff6 fs29 fc6 sc0 ls0 ws0">Producer-Consumer<span class="_ _11"> </span>Problem</div><div class="t m5 x17 h26 y19a5 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffa ls0">producer-consumer<span class="_ _16"> </span><span class="ff7">problem<span class="_ _11"> </span>is<span class="_ _11"> </span>shown<span class="_ _16"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>12.23.<span class="_ _16"> </span>A<span class="_ _11"> </span>producer<span class="_ _11"> </span>and<span class="_ _16"> </span>con-</span></span></div><div class="t m5 x17 h26 y19a6 ff7 fs19 fc1 sc0 ls0 ws0">sumer<span class="_ _13"> </span>thread<span class="_ _13"> </span>share<span class="_ _13"> </span>a<span class="_ _13"> </span><span class="ffa">bounded<span class="_ _13"> </span>buffer<span class="_"> </span></span>with<span class="_ _13"> </span><span class="ff11">n<span class="_ _13"> </span><span class="ffa">slots</span></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>producer<span class="_ _13"> </span>thread<span class="_ _13"> </span>repeatedly</div><div class="t m5 x17 h26 y19a7 ff7 fs19 fc1 sc0 ls0 ws0">produces<span class="_"> </span>new<span class="_ _11"> </span><span class="ffa">items<span class="_ _11"> </span></span>and<span class="_"> </span>inserts<span class="_ _11"> </span>them<span class="_ _11"> </span>in<span class="_"> </span>the<span class="_ _11"> </span>buffer.<span class="_"> </span>T<span class="_ _0"></span>he<span class="_"> </span>consumer<span class="_ _11"> </span>thread<span class="_ _11"> </span>repeat-</div><div class="t m5 x17 h26 y2182 ff7 fs19 fc1 sc0 ls0 ws0">edly<span class="_ _13"> </span>removes<span class="_ _13"> </span>items<span class="_ _13"> </span>from<span class="_ _13"> </span>the<span class="_ _13"> </span>buffer<span class="_ _13"> </span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>consumes<span class="_"> </span>(uses)<span class="_ _13"> </span>them.<span class="_ _13"> </span>V<span class="_ _7"></span>ariants<span class="_ _13"> </span>with</div><div class="t m5 x17 h26 y2183 ff7 fs19 fc1 sc0 ls0 ws0">multiple<span class="_"> </span>producers<span class="_"> </span>and<span class="_"> </span>consumers<span class="_"> </span>are<span class="_"> </span>also<span class="_"> </span>possible<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y2184 ff7 fs19 fc1 sc0 ls0 ws0">Since<span class="_ _14"> </span>inserting<span class="_ _14"> </span>and<span class="_ _15"> </span>removing<span class="_ _14"> </span>items<span class="_ _15"> </span>involves<span class="_ _14"> </span>updating<span class="_ _15"> </span>shared<span class="_ _14"> </span>variables<span class="_ _1"></span>,<span class="_ _15"> </span>we</div><div class="t m5 x17 h26 y2185 ff7 fs19 fc1 sc0 ls0 ws0">must<span class="_"> </span>guarantee<span class="_"> </span>mutually<span class="_ _13"> </span>exclusive<span class="_"> </span>access<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>buffer<span class="_ _1"></span>.<span class="_"> </span>But<span class="_"> </span>guaranteeing<span class="_"> </span>mutual</div><div class="t m5 x17 h26 y2186 ff7 fs19 fc1 sc0 ls0 ws0">exclusion<span class="_"> </span>is<span class="_"> </span>not<span class="_ _11"> </span>sufﬁcient.<span class="_"> </span>W<span class="_ _1"></span>e<span class="_"> </span>also<span class="_ _11"> </span>need<span class="_"> </span>to<span class="_ _11"> </span>schedule<span class="_"> </span>accesses<span class="_"> </span>to<span class="_ _11"> </span>the<span class="_"> </span>buffer.<span class="_"> </span>If<span class="_ _11"> </span>the</div><div class="t m5 x17 h26 y2187 ff7 fs19 fc1 sc0 ls0 ws0">buffer<span class="_ _11"> </span>is<span class="_ _11"> </span>full<span class="_ _11"> </span>(there<span class="_ _16"> </span>are<span class="_ _11"> </span>no<span class="_ _11"> </span>empty<span class="_ _11"> </span>slots),<span class="_ _16"> </span>then<span class="_ _11"> </span>the<span class="_ _11"> </span>producer<span class="_ _11"> </span>must<span class="_ _11"> </span>wait<span class="_ _16"> </span>until<span class="_ _11"> </span>a<span class="_ _11"> </span>slot</div><div class="t m5 x17 h26 y2188 ff7 fs19 fc1 sc0 ls0 ws0">becomes<span class="_"> </span>available<span class="_ _1"></span>.<span class="_"> </span>Similarly<span class="_ _7"></span>,<span class="_"> </span>if<span class="_"> </span>the<span class="_ _13"> </span>buffer<span class="_"> </span>is<span class="_"> </span>empty<span class="_ _13"> </span>(there<span class="_"> </span>are<span class="_ _13"> </span>no<span class="_"> </span>available<span class="_"> </span>items),</div><div class="t m5 x17 h26 y2189 ff7 fs19 fc1 sc0 ls0 ws0">then<span class="_"> </span>the<span class="_"> </span>consumer<span class="_"> </span>must<span class="_"> </span>wait<span class="_"> </span>until<span class="_"> </span>an<span class="_"> </span>item<span class="_"> </span>becomes<span class="_"> </span>available<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y218a ff7 fs19 fc1 sc0 ls0 ws0">Producer<span class="_ _1"></span>-consumer<span class="_ _11"> </span>interactions<span class="_ _11"> </span>occur<span class="_ _16"> </span>frequently<span class="_ _11"> </span>in<span class="_ _11"> </span>real<span class="_ _16"> </span>systems<span class="_ _3"></span>.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>exam-</div><div class="t m5 x17 h26 y218b ff7 fs19 fc1 sc0 ls0 ws0">ple<span class="_ _1"></span>,<span class="_ _14"> </span>in<span class="_ _16"> </span>a<span class="_ _16"> </span>multimedia<span class="_ _16"> </span>system,<span class="_ _16"> </span>the<span class="_ _16"> </span>producer<span class="_ _16"> </span>might<span class="_ _16"> </span>encode<span class="_ _16"> </span>video<span class="_ _16"> </span>frames<span class="_ _16"> </span>while<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y218c ff7 fs19 fc1 sc0 ls0 ws0">consumer<span class="_ _11"> </span>decodes<span class="_ _11"> </span>and<span class="_ _11"> </span>renders<span class="_ _11"> </span>them<span class="_ _11"> </span>on<span class="_ _11"> </span>the<span class="_ _16"> </span>screen.<span class="_"> </span>The<span class="_"> </span>purpose<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>buffer<span class="_ _11"> </span>is</div><div class="t m5 x17 h26 y218d ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _11"> </span>reduce<span class="_ _11"> </span>jitter<span class="_ _16"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>video<span class="_ _16"> </span>stream<span class="_ _11"> </span>caused<span class="_ _11"> </span>by<span class="_ _16"> </span>data-dependent<span class="_ _11"> </span>differences<span class="_ _11"> </span>in<span class="_ _11"> </span>the</div><div class="t m5 x17 h26 y218e ff7 fs19 fc1 sc0 ls0 ws0">encoding<span class="_ _11"> </span>and<span class="_ _16"> </span>decoding<span class="_ _11"> </span>times<span class="_ _11"> </span>for<span class="_ _16"> </span>individual<span class="_ _11"> </span>frames<span class="_ _1"></span>.<span class="_ _11"> </span>The<span class="_"> </span>buffer<span class="_ _16"> </span>provides<span class="_ _11"> </span>a<span class="_ _11"> </span>reser<span class="_ _0"></span>-</div><div class="t m5 x17 h26 y218f ff7 fs19 fc1 sc0 ls0 ws0">voir<span class="_"> </span>of<span class="_ _11"> </span>slots<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_"> </span>producer<span class="_ _11"> </span>and<span class="_ _11"> </span>a<span class="_ _11"> </span>reservoir<span class="_"> </span>of<span class="_ _11"> </span>encoded<span class="_ _11"> </span>frames<span class="_ _11"> </span>to<span class="_"> </span>the<span class="_ _11"> </span>consumer.</div><div class="t m5 x17 h26 y2190 ff7 fs19 fc1 sc0 ls0 ws0">Another<span class="_ _13"> </span>common<span class="_ _6"> </span>example<span class="_ _13"> </span>is<span class="_ _13"> </span>the<span class="_ _6"> </span>design<span class="_ _13"> </span>of<span class="_ _13"> </span>graphical<span class="_ _6"> </span>user<span class="_ _13"> </span>interfaces<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>producer</div><div class="t m5 x17 h26 y2191 ff7 fs19 fc1 sc0 ls0 ws0">detects<span class="_"> </span>mouse<span class="_ _13"> </span>and<span class="_"> </span>keyboard<span class="_ _13"> </span>events<span class="_"> </span>and<span class="_ _13"> </span>inserts<span class="_"> </span>them<span class="_ _13"> </span>in<span class="_"> </span>the<span class="_ _13"> </span>buffer.<span class="_ _13"> </span>The<span class="_ _13"> </span>consumer</div><div class="t m5 x17 h26 y2192 ff7 fs19 fc1 sc0 ls0 ws0">removes<span class="_ _13"> </span>the<span class="_"> </span>events<span class="_ _13"> </span>from<span class="_"> </span>the<span class="_ _13"> </span>buffer<span class="_ _13"> </span>in<span class="_"> </span>some<span class="_ _13"> </span>priority-based<span class="_ _13"> </span>manner<span class="_"> </span>and<span class="_ _13"> </span>paints<span class="_"> </span>the</div><div class="t m5 x17 h26 y2193 ff7 fs19 fc1 sc0 ls0 ws0">screen.</div><div class="t m5 x26 h26 y2194 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _16"> </span>this<span class="_ _14"> </span>section,<span class="_ _15"> </span>we<span class="_ _14"> </span>will<span class="_ _16"> </span>develop<span class="_ _14"> </span>a<span class="_ _14"> </span>simple<span class="_ _14"> </span>package<span class="_ _0"></span>,<span class="_ _14"> </span>called<span class="_ _14"> </span><span class="ff9">Sbuf</span>,<span class="_ _14"> </span>for<span class="_ _14"> </span>building</div><div class="t m5 x17 h26 y2195 ff7 fs19 fc1 sc0 ls0 ws0">producer<span class="_ _1"></span>-consumer<span class="_ _15"> </span>programs<span class="_ _1"></span>.<span class="_ _15"> </span>In<span class="_ _15"> </span>the<span class="_ _14"> </span>next<span class="_ _15"> </span>section,<span class="_ _21"> </span>we<span class="_ _15"> </span>look<span class="_ _15"> </span>at<span class="_ _15"> </span>how<span class="_ _15"> </span>to<span class="_ _15"> </span>use<span class="_ _15"> </span>it<span class="_ _14"> </span>to</div><div class="t m5 x17 h26 y2196 ff7 fs19 fc1 sc0 ls0 ws0">build<span class="_ _11"> </span>an<span class="_ _16"> </span>interesting<span class="_ _16"> </span>concurrent<span class="_ _11"> </span>server<span class="_ _16"> </span>based<span class="_ _11"> </span>on<span class="_ _16"> </span>prethreading.<span class="_ _11"> </span><span class="ff9">Sbuf<span class="_ _11"> </span></span>manipulates</div><div class="t m5 x17 h26 y2197 ff7 fs19 fc1 sc0 ls0 ws0">bounded<span class="_"> </span>buffers<span class="_ _13"> </span>of<span class="_"> </span>type<span class="_"> </span><span class="ffd">sbuf_t<span class="_ _13"> </span></span>(Figure<span class="_ _13"> </span>12.24).<span class="_"> </span>Items<span class="_"> </span>are<span class="_ _13"> </span>stored<span class="_"> </span>in<span class="_"> </span>a<span class="_ _13"> </span>dynamically</div><div class="t m5 x17 h26 y2198 ff7 fs19 fc1 sc0 ls0 ws0">allocated<span class="_ _21"> </span>integer<span class="_ _f"> </span>array<span class="_ _f"> </span>(<span class="ffd">buf</span>)<span class="_ _f"> </span>with<span class="_ _f"> </span><span class="ffd">n<span class="_ _f"> </span></span>items<span class="_ _1"></span>.<span class="_ _f"> </span>The<span class="_ _21"> </span><span class="ffd">front<span class="_ _f"> </span></span>and<span class="_ _f"> </span><span class="ffd">rear<span class="_ _f"> </span></span>indices<span class="_ _f"> </span>keep</div><div class="t m5 x17 h26 y2199 ff7 fs19 fc1 sc0 ls0 ws0">track<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>ﬁrst<span class="_ _13"> </span>and<span class="_"> </span>last<span class="_ _13"> </span>items<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>array<span class="_ _7"></span>.<span class="_"> </span>T<span class="_ _1"></span>hree<span class="_"> </span>semaphores<span class="_ _13"> </span>synchronize<span class="_"> </span>access</div><div class="t m5 x17 h26 y219a ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _14"> </span>the<span class="_ _14"> </span>buffer.<span class="_ _14"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span><span class="ffd">mutex<span class="_ _15"> </span></span>semaphore<span class="_ _14"> </span>provides<span class="_ _14"> </span>mutually<span class="_ _14"> </span>exclusive<span class="_ _14"> </span>buffer<span class="_ _14"> </span>access<span class="_ _0"></span>.</div><div class="t m5 x17 h26 y219b ff7 fs19 fc1 sc0 ls0 ws0">Semaphores<span class="_ _13"> </span><span class="ffd">slots<span class="_ _10"> </span></span>and<span class="_ _13"> </span><span class="ffd">items<span class="_ _10"> </span></span>are<span class="_ _13"> </span>counting<span class="_"> </span>semaphores<span class="_ _13"> </span>that<span class="_"> </span>count<span class="_ _13"> </span>the<span class="_ _13"> </span>number<span class="_"> </span>of</div><div class="t m5 x17 h26 y219c ff7 fs19 fc1 sc0 ls0 ws0">empty<span class="_"> </span>slots<span class="_"> </span>and<span class="_"> </span>available<span class="_"> </span>items<span class="_ _1"></span>,<span class="_"> </span>respectively<span class="_ _3"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
