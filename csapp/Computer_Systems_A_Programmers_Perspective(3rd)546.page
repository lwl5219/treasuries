<div id="pf222" class="pf w2 h11" data-page-no="222"><div class="pc pc222 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg222.png"/><div class="t m5 x1e2 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>5.4<span class="_ _60"> </span>Eliminating<span class="_ _10"> </span>Loop<span class="_ _10"> </span>Inefﬁciencies<span class="_ _3e"> </span><span class="ffe fs1e">545</span></div><div class="t m5 x2c h2d y4a2c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Move<span class="_ _e"> </span>call<span class="_ _1f"> </span>to<span class="_ _1f"> </span>vec_length<span class="_ _e"> </span>out<span class="_ _1f"> </span>of<span class="_ _e"> </span>loop<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y4a2d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>combine2(vec_ptr<span class="_ _e"> </span>v,<span class="_ _1f"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x2c h2d y4a2e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2e y4a2f ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x142 h2d y4a30 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>i;</div><div class="t m5 x2c h2d y4a31 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>length<span class="_ _1f"> </span>=<span class="_ _1f"> </span>vec_length(v);</span></div><div class="t m5 x2c h2e y4a32 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2c h2e y4ad7 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x142 h2d y4a33 ffd fs1e fc2 sc0 ls0 ws0">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>IDENT;</div><div class="t m5 x2c h2d y4a34 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>length;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</span></div><div class="t m5 x2c h2e y4a35 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 xc5 h2d y4aad ffd fs1e fc2 sc0 ls0 ws0">data_t<span class="_ _e"> </span>val;</div><div class="t m5 x17 h2d y4a37 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">get_vec_element(v,<span class="_ _e"> </span>i,<span class="_ _1f"> </span>&amp;val);</span></div><div class="t m5 x17 h2d y4a38 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _70"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>*dest<span class="_ _1f"> </span>OP<span class="_ _e"> </span>val;</span></div><div class="t m5 x17 h2d y4a39 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y4a3a ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h3a y4ad8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>5.6<span class="_ _c"> </span><span class="fc1">Improving<span class="_ _16"> </span>the<span class="_ _14"> </span>efﬁciency<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>loop<span class="_ _16"> </span>test.<span class="_ _16"> </span><span class="ff6">By<span class="_ _14"> </span>moving<span class="_ _16"> </span>the<span class="_ _14"> </span>call<span class="_ _16"> </span>to<span class="_ _16"> </span><span class="ffd fs19">vec_</span></span></span></div><div class="t m5 x17 h3a y4ad9 ffd fs19 fc1 sc0 ls0 ws0">length</div><div class="t m5 xd1 h34 y4ada ff6 fs16 fc1 sc0 ls0 ws0">out<span class="_ _10"> </span>of<span class="_ _11"> </span>the<span class="_ _10"> </span>loop<span class="_ _10"> </span>test,<span class="_ _11"> </span>we<span class="_ _10"> </span>eliminate<span class="_ _11"> </span>the<span class="_ _10"> </span>need<span class="_ _11"> </span>to<span class="_ _10"> </span>execute<span class="_ _10"> </span>it<span class="_ _11"> </span>on<span class="_ _10"> </span>ever<span class="_ _2"></span>y<span class="_ _10"> </span>iteration.</div><div class="t m5 x17 h26 y4adb ff7 fs19 fc1 sc0 ls0 ws0">times<span class="_ _1"></span>,<span class="_ _14"> </span>(e<span class="_ _0"></span>.g.,<span class="_ _16"> </span>within<span class="_ _14"> </span>a<span class="_ _16"> </span>loop),<span class="_ _14"> </span>but<span class="_ _16"> </span>such<span class="_ _14"> </span>that<span class="_ _16"> </span>the<span class="_ _14"> </span>result<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _16"> </span>computation<span class="_ _14"> </span>will<span class="_ _16"> </span>not</div><div class="t m5 x17 h26 y4adc ff7 fs19 fc1 sc0 ls0 ws0">change<span class="_ _1"></span>.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>can<span class="_"> </span>therefore<span class="_"> </span>move<span class="_ _13"> </span>the<span class="_"> </span>computation<span class="_"> </span>to<span class="_"> </span>an<span class="_"> </span>earlier<span class="_ _13"> </span>section<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>code</div><div class="t m5 x17 h26 y4add ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _13"> </span>does<span class="_ _13"> </span>not<span class="_ _13"> </span>get<span class="_ _13"> </span>evaluated<span class="_ _6"> </span>as<span class="_ _13"> </span>often.<span class="_ _13"> </span>In<span class="_ _13"> </span>this<span class="_ _13"> </span>case<span class="_ _1"></span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>moved<span class="_ _13"> </span>the<span class="_ _13"> </span>call<span class="_ _13"> </span>to<span class="_ _13"> </span><span class="ffd">vec_length</span></div><div class="t m5 x17 h26 y4ade ff7 fs19 fc1 sc0 ls0 ws0">from<span class="_"> </span>within<span class="_"> </span>the<span class="_"> </span>loop<span class="_"> </span>to<span class="_"> </span>just<span class="_"> </span>before<span class="_"> </span>the<span class="_"> </span>loop<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y4adf ff7 fs19 fc1 sc0 ls0 ws0">Optimizing<span class="_ _13"> </span>compilers<span class="_ _13"> </span>attempt<span class="_ _13"> </span>to<span class="_ _13"> </span>perform<span class="_ _13"> </span>code<span class="_ _13"> </span>motion.<span class="_ _13"> </span>Unfortunately<span class="_ _3"></span>,<span class="_ _13"> </span>as<span class="_ _13"> </span>dis-</div><div class="t m5 x17 h26 y4ae0 ff7 fs19 fc1 sc0 ls0 ws0">cussed<span class="_"> </span>previously<span class="_ _3"></span>,<span class="_"> </span>they<span class="_"> </span>are<span class="_"> </span>typically<span class="_"> </span>very<span class="_"> </span>cautious<span class="_"> </span>about<span class="_"> </span>making<span class="_"> </span>transformations</div><div class="t m5 x17 h26 y4ae1 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_"> </span>change<span class="_ _13"> </span>where<span class="_"> </span>or<span class="_"> </span>how<span class="_ _13"> </span>many<span class="_"> </span>times<span class="_"> </span>a<span class="_ _13"> </span>procedure<span class="_"> </span>is<span class="_"> </span>called.<span class="_ _13"> </span>T<span class="_ _0"></span>hey<span class="_"> </span>cannot<span class="_ _13"> </span>reliably</div><div class="t m5 x17 h26 y4ae2 ff7 fs19 fc1 sc0 ls0 ws0">detect<span class="_ _16"> </span>whether<span class="_ _16"> </span>or<span class="_ _16"> </span>not<span class="_ _16"> </span>a<span class="_ _11"> </span>function<span class="_ _16"> </span>will<span class="_ _16"> </span>have<span class="_ _16"> </span>side<span class="_ _16"> </span>effects<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _16"> </span>so<span class="_ _16"> </span>they<span class="_ _16"> </span>assume<span class="_ _11"> </span>that</div><div class="t m5 x17 h26 y4ae3 ff7 fs19 fc1 sc0 ls0 ws0">it<span class="_ _14"> </span>might.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>example,<span class="_ _14"> </span>if<span class="_ _14"> </span><span class="ffd">vec_length<span class="_ _16"> </span></span>had<span class="_ _14"> </span>some<span class="_ _14"> </span>side<span class="_ _14"> </span>effect,<span class="_ _15"> </span>then<span class="_ _16"> </span><span class="ffd">combine1<span class="_ _14"> </span></span>and</div><div class="t m5 x17 h26 y4ae4 ffd fs19 fc1 sc0 ls0 ws0">combine2<span class="_ _11"> </span><span class="ff7">could<span class="_"> </span>have<span class="_ _11"> </span>different<span class="_ _11"> </span>behaviors<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _3"></span>o<span class="_"> </span>improve<span class="_ _11"> </span>the<span class="_ _11"> </span>code<span class="_ _0"></span>,<span class="_ _11"> </span>the<span class="_"> </span>programmer</span></div><div class="t m5 x17 h26 y4ae5 ff7 fs19 fc1 sc0 ls0 ws0">must<span class="_"> </span>often<span class="_"> </span>help<span class="_"> </span>the<span class="_"> </span>compiler<span class="_"> </span>by<span class="_"> </span>explicitly<span class="_"> </span>performing<span class="_"> </span>code<span class="_"> </span>motion.</div><div class="t m5 x26 h26 y4ae6 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _6"> </span>an<span class="_ _13"> </span>extreme<span class="_ _6"> </span>example<span class="_ _13"> </span>of<span class="_ _6"> </span>the<span class="_ _6"> </span>loop<span class="_ _13"> </span>inefﬁcienc<span class="_ _0"></span>y<span class="_ _6"> </span>seen<span class="_ _13"> </span>in<span class="_ _6"> </span><span class="ffd">combine1</span>,<span class="_ _13"> </span>consider<span class="_ _6"> </span>the</div><div class="t m5 x17 h26 y4ae7 ff7 fs19 fc1 sc0 ls0 ws0">procedure<span class="_ _13"> </span><span class="ffd">lower1<span class="_ _13"> </span></span>shown<span class="_ _13"> </span>in<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>5.7.<span class="_ _13"> </span>T<span class="_ _1"></span>his<span class="_ _13"> </span>procedure<span class="_ _13"> </span>is<span class="_ _13"> </span>styled<span class="_ _13"> </span>after<span class="_ _6"> </span>routines<span class="_ _13"> </span>sub-</div><div class="t m5 x17 h26 y4ae8 ff7 fs19 fc1 sc0 ls0 ws0">mitted<span class="_"> </span>by<span class="_ _13"> </span>several<span class="_"> </span>students<span class="_ _13"> </span>as<span class="_"> </span>part<span class="_"> </span>of<span class="_ _13"> </span>a<span class="_"> </span>network<span class="_ _13"> </span>programming<span class="_"> </span>project.<span class="_"> </span>Its<span class="_ _13"> </span>purpose</div><div class="t m5 x17 h26 y4ae9 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _16"> </span>to<span class="_ _11"> </span>convert<span class="_ _16"> </span>all<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>uppercase<span class="_ _11"> </span>letters<span class="_ _16"> </span>in<span class="_ _16"> </span>a<span class="_ _11"> </span>string<span class="_ _16"> </span>to<span class="_ _16"> </span>lowercase<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>procedure</div><div class="t m5 x17 h26 y4aea ff7 fs19 fc1 sc0 ls0 ws0">steps<span class="_ _11"> </span>through<span class="_ _16"> </span>the<span class="_ _16"> </span>string<span class="_ _0"></span>,<span class="_ _16"> </span>converting<span class="_ _11"> </span>each<span class="_ _16"> </span>uppercase<span class="_ _16"> </span>character<span class="_ _11"> </span>to<span class="_ _16"> </span>lowercase<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he</div><div class="t m5 x17 h26 y4aeb ff7 fs19 fc1 sc0 ls0 ws0">case<span class="_"> </span>conversion<span class="_"> </span>involves<span class="_"> </span>shifting<span class="_"> </span>characters<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>range<span class="_"> </span>‘<span class="ffd">A</span><span class="ls20d">’t<span class="_ _4a"></span>o‘<span class="_ _4a"></span><span class="ffd ls0">Z<span class="ff7">’<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>range<span class="_"> </span>‘</span>a<span class="ff7">’</span></span></span></div><div class="t m5 x17 h26 y4aec ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>‘<span class="ffd">z</span>’.</div><div class="t m5 x26 h26 y4aed ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>library<span class="_ _16"> </span>function<span class="_ _11"> </span><span class="ffd">strlen<span class="_ _16"> </span></span>is<span class="_ _16"> </span>called<span class="_ _16"> </span>as<span class="_ _11"> </span>part<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>loop<span class="_ _16"> </span>test<span class="_ _16"> </span>of<span class="_ _16"> </span><span class="ffd">lower1</span>.<span class="_ _11"> </span>Al-</div><div class="t m5 x17 h26 y4aee ff7 fs19 fc1 sc0 ls0 ws0">though<span class="_ _13"> </span><span class="ffd">strlen<span class="_ _6"> </span></span>is<span class="_ _13"> </span>typically<span class="_ _6"> </span>implemented<span class="_ _13"> </span>with<span class="_ _6"> </span>special<span class="_ _13"> </span>x86<span class="_ _6"> </span>string-processing<span class="_ _13"> </span>instruc-</div><div class="t m5 x17 h26 y4aef ff7 fs19 fc1 sc0 ls0 ws0">tions<span class="_ _1"></span>,<span class="_ _14"> </span>its<span class="_ _16"> </span>overall<span class="_ _14"> </span>execution<span class="_ _14"> </span>is<span class="_ _16"> </span>similar<span class="_ _14"> </span>to<span class="_ _16"> </span>the<span class="_ _14"> </span>simple<span class="_ _16"> </span>version<span class="_ _14"> </span>that<span class="_ _16"> </span>is<span class="_ _14"> </span>also<span class="_ _16"> </span>shown<span class="_ _14"> </span>in</div><div class="t m5 x17 h26 y4af0 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>5.7.<span class="_ _13"> </span>Since<span class="_ _13"> </span>strings<span class="_ _13"> </span>in<span class="_ _13"> </span>C<span class="_"> </span>are<span class="_ _13"> </span>null-terminated<span class="_ _13"> </span>character<span class="_ _13"> </span>sequences<span class="_ _1"></span>,<span class="_"> </span><span class="ffd">strlen<span class="_ _13"> </span></span>can</div><div class="t m5 x17 h26 y4af1 ff7 fs19 fc1 sc0 ls0 ws0">only<span class="_ _16"> </span>determine<span class="_ _14"> </span>the<span class="_ _14"> </span>length<span class="_ _16"> </span>of<span class="_ _14"> </span>a<span class="_ _16"> </span>string<span class="_ _14"> </span>by<span class="_ _14"> </span>stepping<span class="_ _16"> </span>through<span class="_ _14"> </span>the<span class="_ _14"> </span>sequence<span class="_ _16"> </span>until<span class="_ _14"> </span>it</div><div class="t m5 x17 h26 y4af2 ff7 fs19 fc1 sc0 ls0 ws0">hits<span class="_"> </span>a<span class="_ _13"> </span>null<span class="_"> </span>character<span class="_ _1"></span>.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_"> </span>a<span class="_ _13"> </span>string<span class="_"> </span>of<span class="_ _13"> </span>length<span class="_"> </span><span class="ff11">n</span>,<span class="_"> </span><span class="ffd">strlen<span class="_ _13"> </span></span>takes<span class="_"> </span>time<span class="_ _13"> </span>proportional<span class="_"> </span>to<span class="_ _13"> </span><span class="ff11">n</span>.</div><div class="t m5 x17 h26 y4af3 ff7 fs19 fc1 sc0 ls0 ws0">Since<span class="_ _11"> </span><span class="ffd">strlen<span class="_ _11"> </span></span>is<span class="_ _11"> </span>called<span class="_ _11"> </span>in<span class="_ _11"> </span>each<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ff11">n<span class="_ _10"> </span></span>iterations<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffd">lower1</span>,<span class="_ _11"> </span>the<span class="_ _11"> </span>overall<span class="_ _11"> </span>run<span class="_ _11"> </span>time</div><div class="t m5 x17 h26 y4af4 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span><span class="ffd">lower1<span class="_ _10"> </span></span>is<span class="_"> </span>quadratic<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>string<span class="_"> </span>length,<span class="_"> </span>proportional<span class="_"> </span>to<span class="_"> </span><span class="ff11">n</span></div><div class="t m5 x1ad h3c y4af5 ff7 fs25 fc1 sc0 ls0 ws0">2</div><div class="t m5 x18b h26 y4af6 ff7 fs19 fc1 sc0 ls0 ws0">.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
