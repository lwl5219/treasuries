<div id="pf29f" class="pf w2 h11" data-page-no="29f"><div class="pc pc29f w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg29f.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">670<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>6<span class="_ _3d"> </span>The<span class="_ _10"> </span>Memory<span class="_ _10"> </span>Hierarchy</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Cache<span class="_ _11"> </span>lines,<span class="_ _11"> </span>sets,<span class="_ _11"> </span>and<span class="_ _16"> </span>blocks:<span class="_ _11"> </span>What’<span class="_ _1"></span>s<span class="_ _11"> </span>the<span class="_ _16"> </span>difference?</span></div><div class="t m5 x28 h2b y258 ff7 fs1e fc2 sc0 ls0 ws0">It<span class="_"> </span>is<span class="_ _10"> </span>easy<span class="_ _10"> </span>to<span class="_ _11"> </span>confuse<span class="_"> </span>the<span class="_ _10"> </span>distinction<span class="_ _10"> </span>between<span class="_ _11"> </span>cache<span class="_"> </span>lines<span class="_ _1"></span>,<span class="_ _11"> </span>sets<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _10"> </span>blocks<span class="_ _0"></span>.<span class="_"> </span>Let’s<span class="_"> </span>review<span class="_"> </span>these<span class="_ _11"> </span>ideas<span class="_"> </span>and</div><div class="t m5 x28 h2b y259 ff7 fs1e fc2 sc0 ls0 ws0">make<span class="_"> </span>sure<span class="_"> </span>they<span class="_"> </span>are<span class="_"> </span>clear:</div><div class="t m5 x56 h3d y5920 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x57 h2b ye5c ff7 fs1e fc2 sc0 ls0 ws0">A<span class="_ _13"> </span><span class="ffa">block<span class="_"> </span></span>is<span class="_ _13"> </span>a<span class="_"> </span>ﬁxed-size<span class="_ _13"> </span>packet<span class="_ _13"> </span>of<span class="_ _13"> </span>information<span class="_"> </span>that<span class="_ _13"> </span>moves<span class="_ _13"> </span>back<span class="_ _13"> </span>and<span class="_"> </span>forth<span class="_ _13"> </span>between<span class="_ _13"> </span>a<span class="_"> </span>cache<span class="_ _13"> </span>and<span class="_ _13"> </span>main</div><div class="t m5 x57 h2b y5921 ff7 fs1e fc2 sc0 ls0 ws0">memory<span class="_"> </span>(or<span class="_"> </span>a<span class="_"> </span>lower<span class="_ _1"></span>-level<span class="_"> </span>cache).</div><div class="t m5 x56 h3d y5922 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x57 h2b y83f ff7 fs1e fc2 sc0 ls0 ws0">A<span class="_ _10"> </span><span class="ffa">line<span class="_ _11"> </span></span>is<span class="_ _11"> </span>a<span class="_ _11"> </span>container<span class="_ _10"> </span>in<span class="_ _11"> </span>a<span class="_ _11"> </span>cache<span class="_ _10"> </span>that<span class="_ _11"> </span>stores<span class="_ _11"> </span>a<span class="_ _11"> </span>block,<span class="_ _10"> </span>as<span class="_ _11"> </span>well<span class="_ _11"> </span>as<span class="_ _11"> </span>other<span class="_ _10"> </span>information<span class="_ _11"> </span>such<span class="_ _11"> </span>as<span class="_ _10"> </span>the<span class="_ _11"> </span>valid</div><div class="t m5 x57 h2b y840 ff7 fs1e fc2 sc0 ls0 ws0">bit<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>tag<span class="_"> </span>bits<span class="_ _1"></span>.</div><div class="t m5 x56 h3d y5923 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x57 h2b y5924 ff7 fs1e fc2 sc0 ls0 ws0">A<span class="_"> </span><span class="ffa">set<span class="_"> </span></span>is<span class="_"> </span>a<span class="_ _13"> </span>collection<span class="_"> </span>of<span class="_ _13"> </span>one<span class="_"> </span>or<span class="_ _13"> </span>more<span class="_"> </span>lines<span class="_ _3"></span>.<span class="_"> </span>Sets<span class="_"> </span>in<span class="_ _13"> </span>direct-mapped<span class="_"> </span>caches<span class="_ _13"> </span>consist<span class="_"> </span>of<span class="_ _13"> </span>a<span class="_"> </span>single<span class="_ _13"> </span>line<span class="_ _0"></span>.<span class="_"> </span>Sets</div><div class="t m5 x57 h2b y5925 ff7 fs1e fc2 sc0 ls0 ws0">in<span class="_"> </span>set<span class="_"> </span>associative<span class="_"> </span>and<span class="_"> </span>fully<span class="_"> </span>associative<span class="_"> </span>caches<span class="_"> </span>consist<span class="_"> </span>of<span class="_"> </span>multiple<span class="_"> </span>lines<span class="_ _1"></span>.</div><div class="t m5 x28 h2b y5926 ff7 fs1e fc2 sc0 ls0 ws0">In<span class="_ _13"> </span>direct-mapped<span class="_"> </span>caches<span class="_ _3"></span>,<span class="_"> </span>sets<span class="_ _13"> </span>and<span class="_"> </span>lines<span class="_ _13"> </span>are<span class="_ _13"> </span>indeed<span class="_"> </span>equivalent.<span class="_ _13"> </span>However,<span class="_ _13"> </span>in<span class="_ _13"> </span>associative<span class="_"> </span>caches<span class="_ _3"></span>,<span class="_"> </span>sets<span class="_ _13"> </span>and</div><div class="t m5 x28 h2b y5927 ff7 fs1e fc2 sc0 ls0 ws0">lines<span class="_"> </span>are<span class="_"> </span>very<span class="_"> </span>different<span class="_"> </span>things<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>terms<span class="_"> </span>cannot<span class="_"> </span>be<span class="_"> </span>used<span class="_"> </span>interchangeably<span class="_ _3"></span>.</div><div class="t m5 x57 h2b y5928 ff7 fs1e fc2 sc0 ls0 ws0">Since<span class="_"> </span>a<span class="_"> </span>line<span class="_ _13"> </span>always<span class="_"> </span>stores<span class="_"> </span>a<span class="_ _13"> </span>single<span class="_"> </span>block,<span class="_"> </span>the<span class="_ _13"> </span>terms<span class="_"> </span>“line”<span class="_"> </span>and<span class="_ _13"> </span>“block”<span class="_"> </span>are<span class="_"> </span>often<span class="_ _13"> </span>used<span class="_"> </span>interchange-</div><div class="t m5 x28 h2b y5929 ff7 fs1e fc2 sc0 ls0 ws0">ably<span class="_ _3"></span>.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _16"> </span>example<span class="_ _0"></span>,<span class="_ _16"> </span>systems<span class="_ _16"> </span>professionals<span class="_ _16"> </span>usually<span class="_ _14"> </span>refer<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>“line<span class="_ _16"> </span>size”<span class="_ _16"> </span>of<span class="_ _16"> </span>a<span class="_ _16"> </span>cache<span class="_ _0"></span>,<span class="_ _16"> </span>when<span class="_ _16"> </span>what<span class="_ _16"> </span>they</div><div class="t m5 x28 h2b y592a ff7 fs1e fc2 sc0 ls0 ws0">really<span class="_"> </span>mean<span class="_"> </span>is<span class="_"> </span>the<span class="_"> </span>block<span class="_"> </span>size.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>usage<span class="_"> </span>is<span class="_"> </span>very<span class="_"> </span>common<span class="_ _10"> </span>and<span class="_"> </span>shouldn’t<span class="_"> </span>cause<span class="_"> </span>any<span class="_"> </span>confusion<span class="_"> </span>as<span class="_"> </span>long<span class="_ _10"> </span>as</div><div class="t m5 x28 h2b y592b ff7 fs1e fc2 sc0 ls0 ws0">you<span class="_"> </span>understand<span class="_"> </span>the<span class="_"> </span>distinction<span class="_"> </span>between<span class="_"> </span>blocks<span class="_"> </span>and<span class="_"> </span>lines<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y592c ff7 fs19 fc2 sc0 ls0 ws0">write<span class="_"> </span>code<span class="_"> </span>that<span class="_"> </span>is<span class="_"> </span><span class="ffa">cache<span class="_"> </span>friendly</span>,<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>sense<span class="_"> </span>that<span class="_ _11"> </span>it<span class="_"> </span>has<span class="_"> </span>good<span class="_"> </span>locality<span class="_ _3"></span>.<span class="_"> </span>Here<span class="_"> </span>is<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y592d ff7 fs19 fc2 sc0 ls0 ws0">basic<span class="_"> </span>approach<span class="_"> </span>we<span class="_"> </span>use<span class="_"> </span>to<span class="_"> </span>try<span class="_"> </span>to<span class="_"> </span>ensure<span class="_"> </span>that<span class="_"> </span>our<span class="_"> </span>code<span class="_"> </span>is<span class="_"> </span>cache<span class="_"> </span>friendly<span class="_ _3"></span>.</div><div class="t m5 xc5 h26 y592e ffc fs19 fc2 sc0 ls0 ws0">1.<span class="_ _e"> </span><span class="ffa">Make<span class="_ _11"> </span>the<span class="_"> </span>common<span class="_ _11"> </span>case<span class="_"> </span>go<span class="_ _11"> </span>fast.<span class="_ _13"> </span><span class="ff7">Programs<span class="_"> </span>often<span class="_"> </span>spend<span class="_"> </span>most<span class="_ _11"> </span>of<span class="_"> </span>their<span class="_"> </span>time<span class="_ _11"> </span>in<span class="_"> </span>a</span></span></div><div class="t m5 x29 h26 y592f ff7 fs19 fc2 sc0 ls0 ws0">few<span class="_ _16"> </span>core<span class="_ _16"> </span>functions<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>hese<span class="_ _16"> </span>functions<span class="_ _16"> </span>often<span class="_ _16"> </span>spend<span class="_ _16"> </span>most<span class="_ _16"> </span>of<span class="_ _16"> </span>their<span class="_ _16"> </span>time<span class="_ _16"> </span>in<span class="_ _11"> </span>a<span class="_ _16"> </span>few</div><div class="t m5 x29 h26 y5930 ff7 fs19 fc2 sc0 ls0 ws0">loops<span class="_ _1"></span>.<span class="_"> </span>So<span class="_"> </span>focus<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>inner<span class="_"> </span>loops<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>core<span class="_"> </span>functions<span class="_"> </span>and<span class="_"> </span>ignore<span class="_"> </span>the<span class="_"> </span>rest.</div><div class="t m5 xc5 h26 y5931 ffc fs19 fc2 sc0 ls0 ws0">2.<span class="_ _e"> </span><span class="ffa">Minimize<span class="_ _13"> </span>the<span class="_ _13"> </span>number<span class="_ _13"> </span>of<span class="_ _13"> </span>cache<span class="_ _6"> </span>misses<span class="_ _13"> </span>in<span class="_ _13"> </span>each<span class="_ _13"> </span>inner<span class="_ _13"> </span>loop<span class="_ _3"></span>.<span class="_ _a"> </span><span class="ff7">All<span class="_ _13"> </span>other<span class="_ _13"> </span>things<span class="_ _13"> </span>being</span></span></div><div class="t m5 x29 h26 y5932 ff7 fs19 fc2 sc0 ls0 ws0">equal,<span class="_ _13"> </span>such<span class="_ _6"> </span>as<span class="_ _6"> </span>the<span class="_ _13"> </span>total<span class="_ _6"> </span>number<span class="_ _6"> </span>of<span class="_ _13"> </span>loads<span class="_ _6"> </span>and<span class="_ _6"> </span>stores<span class="_ _0"></span>,<span class="_ _13"> </span>loops<span class="_ _6"> </span>with<span class="_ _6"> </span>better<span class="_ _13"> </span>miss<span class="_ _6"> </span>rates</div><div class="t m5 x29 h26 y5933 ff7 fs19 fc2 sc0 ls0 ws0">will<span class="_"> </span>run<span class="_"> </span>faster.</div><div class="t m5 x29 h26 y5934 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _15"> </span>see<span class="_ _14"> </span>how<span class="_ _14"> </span>this<span class="_ _14"> </span>works<span class="_ _14"> </span>in<span class="_ _15"> </span>practice<span class="_ _1"></span>,<span class="_ _15"> </span>consider<span class="_ _15"> </span>the<span class="_ _14"> </span><span class="ffd">sumvec<span class="_ _14"> </span></span>function<span class="_ _14"> </span>from<span class="_ _14"> </span>Sec-</div><div class="t m5 x1d h26 y5935 ff7 fs19 fc2 sc0 ls0 ws0">tion<span class="_"> </span>6.2:</div><div class="t m5 x1f h2d y5936 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>sumvec(int<span class="_ _e"> </span>v[N])</span></div><div class="t m5 x1f h2d y5937 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y5938 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i,<span class="_ _1f"> </span>sum<span class="_ _1f"> </span>=<span class="_ _e"> </span>0;</span></div><div class="t m5 x1f h2e y5939 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x1f h2e y593a ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x33 h2d y593b ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;N<span class="_ _41"></span>;<span class="ls0">i++)</span></div><div class="t m5 x1f h2d y593c ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _70"> </span><span class="ffd fs1e fc2">sum<span class="_ _e"> </span>+=<span class="_ _1f"> </span>v[i];</span></div><div class="t m5 x1f h2e y593d ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x33 h2d y593e ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>sum;</div><div class="t m5 x1f h2d y593f ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1d h26 y587 ff7 fs19 fc2 sc0 ls0 ws0">Is<span class="_ _13"> </span>this<span class="_"> </span>function<span class="_ _13"> </span>cache<span class="_"> </span>friendly?<span class="_ _13"> </span>F<span class="_ _1"></span>irst,<span class="_"> </span>notice<span class="_ _13"> </span>that<span class="_"> </span>there<span class="_ _13"> </span>is<span class="_ _13"> </span>good<span class="_"> </span>temporal<span class="_ _13"> </span>locality<span class="_"> </span>in</div><div class="t m5 x1d h26 y588 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>loop<span class="_"> </span>body<span class="_ _13"> </span>with<span class="_"> </span>respect<span class="_"> </span>to<span class="_"> </span>the<span class="_ _13"> </span>local<span class="_"> </span>variables<span class="_"> </span><span class="ffd">i<span class="_ _10"> </span></span>and<span class="_"> </span><span class="ffd">sum</span>.<span class="_ _13"> </span>In<span class="_"> </span>fact,<span class="_"> </span>because<span class="_"> </span>these</div><div class="t m5 x1d h26 y589 ff7 fs19 fc2 sc0 ls0 ws0">are<span class="_ _14"> </span>local<span class="_ _15"> </span>variables<span class="_ _1"></span>,<span class="_ _21"> </span>any<span class="_ _15"> </span>reasonable<span class="_ _15"> </span>optimizing<span class="_ _15"> </span>compiler<span class="_ _15"> </span>will<span class="_ _15"> </span>cache<span class="_ _15"> </span>them<span class="_ _14"> </span>in<span class="_ _15"> </span>the</div><div class="t m5 x1d h26 ya77 ff7 fs19 fc2 sc0 ls0 ws0">register<span class="_ _11"> </span>ﬁle<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>highest<span class="_ _11"> </span>level<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>memory<span class="_ _11"> </span>hierarchy<span class="_ _3"></span>.<span class="_ _11"> </span>Now<span class="_ _11"> </span>consider<span class="_ _16"> </span>the<span class="_"> </span>stride-</div><div class="t m5 x1d h26 y5940 ff7 fs19 fc2 sc0 ls0 ws0">1<span class="_"> </span>references<span class="_ _11"> </span>to<span class="_ _11"> </span>vector<span class="_ _11"> </span><span class="ffd">v</span>.<span class="_ _11"> </span>In<span class="_ _11"> </span>general,<span class="_ _11"> </span>if<span class="_ _11"> </span>a<span class="_ _11"> </span>cache<span class="_ _11"> </span>has<span class="_ _11"> </span>a<span class="_ _11"> </span>block<span class="_ _11"> </span>size<span class="_"> </span>of<span class="_ _11"> </span><span class="ff11">B<span class="_ _14"> </span></span>bytes<span class="_ _1"></span>,<span class="_ _11"> </span>then<span class="_ _11"> </span>a</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
