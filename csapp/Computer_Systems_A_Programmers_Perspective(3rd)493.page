<div id="pf1ed" class="pf w2 h11" data-page-no="1ed"><div class="pc pc1ed w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1ed.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">492<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>4<span class="_ _3d"> </span>Processor<span class="_ _10"> </span>Architecture</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>was<span class="_"> </span>illustrated<span class="_"> </span>by<span class="_"> </span>a<span class="_ _13"> </span>simpliÔ¨Åed<span class="_"> </span>pipeline<span class="_"> </span>diagram<span class="_"> </span>in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>4.55<span class="_"> </span>for<span class="_"> </span>processing</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>following<span class="_"> </span>program:</div><div class="t m5 x1d h2d y44a5 ffd fs1e fc2 sc0 ls0 ws0">0x000:<span class="_ _46"> </span>irmovq<span class="_ _e"> </span>stack,%rsp<span class="_ _1a"> </span>#<span class="_ _3f"> </span>Initialize<span class="_ _1f"> </span>stack<span class="_ _1f"> </span>pointer</div><div class="t m5 x1d h2d y44a6 ffd fs1e fc2 sc0 ls0 ws0">0x00a:<span class="_ _46"> </span>call<span class="_ _e"> </span>proc<span class="_ _86"> </span>#<span class="_ _3f"> </span>Procedure<span class="_ _1f"> </span>call</div><div class="t m5 x1d h2d y44a7 ffd fs1e fc2 sc0 ls0 ws0">0x013:<span class="_ _46"> </span>irmovq<span class="_ _e"> </span>$10,%rdx<span class="_ _46"> </span>#<span class="_ _3f"> </span>Return<span class="_ _1f"> </span>point</div><div class="t m5 x1d h2d y44a8 ffd fs1e fc2 sc0 ls0 ws0">0x01d:<span class="_ _46"> </span>halt</div><div class="t m5 x1d h2d y44a9 ffd fs1e fc2 sc0 ls0 ws0">0x020:<span class="_ _e"> </span>.pos<span class="_ _1f"> </span>0x20</div><div class="t m5 x1d h2d y44aa ffd fs1e fc2 sc0 ls0 ws0">0x020:<span class="_ _e"> </span>proc:<span class="_ _15a"> </span>#<span class="_ _1f"> </span>proc:</div><div class="t m5 x1d h2d y44ab ffd fs1e fc2 sc0 ls0 ws0">0x020:<span class="_ _46"> </span>ret<span class="_ _12a"> </span>#<span class="_ _3f"> </span>Return<span class="_ _e"> </span>immediately</div><div class="t m5 x1d h2d y44ac ffd fs1e fc2 sc0 ls0 ws0">0x021:<span class="_ _46"> </span>rrmovq<span class="_ _e"> </span>%rdx,%rbx<span class="_ _3f"> </span>#<span class="_ _3f"> </span>Not<span class="_ _1f"> </span>executed</div><div class="t m5 x1d h2d y44ad ffd fs1e fc2 sc0 ls0 ws0">0x030:<span class="_ _e"> </span>.pos<span class="_ _1f"> </span>0x30</div><div class="t m5 x1d h2d y44ae ffd fs1e fc2 sc0 ls0 ws0">0x030:<span class="_ _e"> </span>stack:<span class="_ _12a"> </span>#<span class="_ _1f"> </span>stack:<span class="_ _e"> </span>Stack<span class="_ _1f"> </span>pointer</div><div class="t m5 x29 h26 y44af ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>4.62<span class="_"> </span>provides<span class="_ _11"> </span>a<span class="_ _16"> </span>detailed<span class="_"> </span>view<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_"> </span>processing<span class="_ _16"> </span>of<span class="_"> </span>the<span class="_ _11"> </span><span class="ffd">ret<span class="_ _16"> </span></span>instruction</div><div class="t m5 x1d h26 y44b0 ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_ _14"> </span>the<span class="_ _15"> </span>example<span class="_ _15"> </span>program.<span class="_ _15"> </span>T<span class="_ _1"></span>he<span class="_ _15"> </span>key<span class="_ _15"> </span>observation<span class="_ _14"> </span>here<span class="_ _15"> </span>is<span class="_ _15"> </span>that<span class="_ _15"> </span>there<span class="_ _14"> </span>is<span class="_ _15"> </span>no<span class="_ _15"> </span>way<span class="_ _15"> </span>to</div><div class="t m5 x1d h26 y44b1 ff7 fs19 fc2 sc0 ls0 ws0">inject<span class="_"> </span>a<span class="_ _13"> </span>bubble<span class="_"> </span>into<span class="_ _13"> </span>the<span class="_"> </span>fetch<span class="_ _13"> </span>stage<span class="_"> </span>of<span class="_ _13"> </span>our<span class="_"> </span>pipeline<span class="_ _1"></span>.<span class="_ _13"> </span>On<span class="_"> </span>every<span class="_ _13"> </span>cycle<span class="_ _0"></span>,<span class="_"> </span>the<span class="_ _13"> </span>fetch<span class="_"> </span>stage</div><div class="t m5 x1d h26 y44b2 ff7 fs19 fc2 sc0 ls0 ws0">reads<span class="_ _16"> </span><span class="ffa">some<span class="_ _16"> </span></span>instruction<span class="_ _16"> </span>from<span class="_ _16"> </span>the<span class="_ _16"> </span>instruction<span class="_ _16"> </span>memory<span class="_ _3"></span>.<span class="_ _16"> </span>Looking<span class="_ _16"> </span>at<span class="_ _16"> </span>the<span class="_ _16"> </span>HCL<span class="_ _16"> </span>code</div><div class="t m5 x1d h26 y44b3 ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_"> </span>implementing<span class="_"> </span>the<span class="_"> </span>PC<span class="_"> </span>prediction<span class="_"> </span>logic<span class="_"> </span>in<span class="_"> </span>Section<span class="_"> </span>4.5.7,<span class="_"> </span>we<span class="_"> </span>can<span class="_"> </span>see<span class="_"> </span>that<span class="_"> </span>for<span class="_"> </span>the</div><div class="t m5 x1d h26 y44b4 ffd fs19 fc2 sc0 ls0 ws0">ret<span class="_ _13"> </span><span class="ff7">instruction,<span class="_"> </span>the<span class="_ _13"> </span>new<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>PC<span class="_ _13"> </span>is<span class="_"> </span>predicted<span class="_ _13"> </span>to<span class="_ _13"> </span>be<span class="_"> </span><span class="ff6">valP</span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>address<span class="_"> </span>of<span class="_ _13"> </span>the</span></div><div class="t m5 x1d h26 y44b5 ff7 fs19 fc2 sc0 ls0 ws0">following<span class="_"> </span>instruction.<span class="_ _11"> </span>In<span class="_"> </span>our<span class="_ _11"> </span>example<span class="_"> </span>program,<span class="_ _11"> </span>this<span class="_"> </span>would<span class="_ _11"> </span>be<span class="_ _11"> </span><span class="ffd">0x021</span>,<span class="_"> </span>the<span class="_ _11"> </span>address</div><div class="t m5 x1d h26 y44b6 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_"> </span><span class="ffd">rrmovq<span class="_ _13"> </span></span>instruction<span class="_"> </span>following<span class="_"> </span>the<span class="_"> </span><span class="ffd">ret</span>.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>prediction<span class="_"> </span>is<span class="_"> </span>not<span class="_ _13"> </span>correct<span class="_"> </span>for<span class="_"> </span>this</div><div class="t m5 x1d h26 y44b7 ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_ _13"> </span>nor<span class="_ _6"> </span>would<span class="_ _6"> </span>it<span class="_ _6"> </span>be<span class="_ _6"> </span>for<span class="_ _13"> </span>most<span class="_ _a"> </span>cases<span class="_ _1"></span>,<span class="_ _13"> </span>but<span class="_ _a"> </span>we<span class="_ _13"> </span>are<span class="_ _a"> </span>not<span class="_ _6"> </span>attempting<span class="_ _13"> </span>to<span class="_ _a"> </span>predict<span class="_ _6"> </span>return</div><div class="t m5 x1d h26 y44b8 ff7 fs19 fc2 sc0 ls0 ws0">addresses<span class="_ _15"> </span>correctly<span class="_ _15"> </span>in<span class="_ _15"> </span>our<span class="_ _14"> </span>design.<span class="_ _15"> </span>F<span class="_ _0"></span>or<span class="_ _14"> </span>three<span class="_ _15"> </span>clock<span class="_ _15"> </span>cycles<span class="_ _1"></span>,<span class="_ _21"> </span>the<span class="_ _15"> </span>fetch<span class="_ _15"> </span>stage<span class="_ _15"> </span>stalls<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y44b9 ff7 fs19 fc2 sc0 ls0 ws0">causing<span class="_"> </span>the<span class="_ _13"> </span><span class="ffd">rrmovq<span class="_ _10"> </span></span>instruction<span class="_"> </span>to<span class="_"> </span>be<span class="_ _13"> </span>fetched<span class="_"> </span>but<span class="_"> </span>then<span class="_"> </span>replaced<span class="_ _13"> </span>by<span class="_"> </span>a<span class="_"> </span>bubble<span class="_ _13"> </span>in<span class="_"> </span>the</div><div class="t m5 x1d h26 y44ba ff7 fs19 fc2 sc0 ls0 ws0">decode<span class="_ _13"> </span>stage<span class="_ _1"></span>.<span class="_ _13"> </span>This<span class="_ _13"> </span>process<span class="_ _13"> </span>is<span class="_ _13"> </span>illustrated<span class="_ _13"> </span>in<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>4.62<span class="_ _13"> </span>by<span class="_ _13"> </span>the<span class="_ _13"> </span>three<span class="_ _13"> </span>fetches<span class="_ _1"></span>,<span class="_"> </span>with<span class="_ _13"> </span>an</div><div class="t m5 x1d h26 y44bb ff7 fs19 fc2 sc0 ls0 ws0">arrow<span class="_ _13"> </span>leading<span class="_ _13"> </span>down<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>bubbles<span class="_ _13"> </span>passing<span class="_"> </span>through<span class="_ _13"> </span>the<span class="_ _13"> </span>remaining<span class="_ _13"> </span>pipeline<span class="_ _13"> </span>stages<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y44bc ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>inally<span class="_ _3"></span>,<span class="_ _11"> </span>the<span class="_ _11"> </span><span class="ffd">irmovq<span class="_ _11"> </span></span>instruction<span class="_"> </span>is<span class="_ _11"> </span>fetched<span class="_ _11"> </span>on<span class="_ _11"> </span>cycle<span class="_"> </span>7.<span class="_"> </span>Comparing<span class="_ _11"> </span>Figure<span class="_"> </span>4.62<span class="_"> </span>with</div><div class="t m5 x15 ha0 y44bd ff50 fs62 fc1 sc0 ls1f7 ws0">FDE<span class="_ _3"></span>M<span class="_ _8"></span>W</div><div class="t m5 x16f ha0 y44be ff50 fs62 fc1 sc0 ls1f8 ws0">FDE<span class="_ _3"></span>M<span class="_ _4"></span>W</div><div class="t m5 x40 ha0 y44bf ff50 fs62 fc1 sc0 ls1f9 ws0">FD</div><div class="t m5 x3a ha0 y44c0 ff50 fs62 fc1 sc0 ls1fa ws0">EM<span class="_ _7"></span>W</div><div class="t m5 x205 ha0 y44c1 ff50 fs62 fc1 sc0 ls0 ws0">F</div><div class="t m5 x3a ha0 y44c2 ff50 fs62 fc1 sc0 ls1fb ws0">DE<span class="_ _0"></span>M<span class="_ _7"></span>W</div><div class="t m5 x195 ha0 y44c3 ff50 fs62 fc1 sc0 ls0 ws0">F</div><div class="t m5 x18a ha0 y44c4 ff50 fs62 fc1 sc0 ls0 ws0">D</div><div class="t m5 x54 ha0 y44c5 ff50 fs62 fc1 sc0 ls0 ws0">F</div><div class="t m5 x169 ha0 y44c4 ff50 fs62 fc1 sc0 ls1fc ws0">EM<span class="_ _7"></span>W</div><div class="t m5 x169 ha0 y44c6 ff50 fs62 fc1 sc0 ls1fd ws0">FD<span class="_ _0"></span>E<span class="_ _3"></span>M<span class="_ _8"></span>W</div><div class="t m5 x1d h9e y44c7 ff4a fs63 fc1 sc0 ls0 ws0">0x000: irmovq Stack,%rsp</div><div class="t m5 x1d h9e y44c8 ff4a fs63 fc1 sc0 ls0 ws0">0x00a: call proc</div><div class="t m5 x1d h9e y44c9 ff4a fs63 fc1 sc0 ls0 ws0">0x020: ret</div><div class="t m5 x1d h9e y44ca ff4a fs63 fc1 sc0 ls0 ws0">0x021: rrmovq %rdx,%rbx # Not executed</div><div class="t m5 x1d h9e y44cb ff4a fs63 fc1 sc0 ls0 ws0">       </div><div class="t m5 x1d h9e y44cc ff4a fs63 fc1 sc0 ls0 ws0">0x021: rrmovq %rdx,%rbx # Not executed</div><div class="t m5 x1d h9e y44cd ff4a fs63 fc1 sc0 ls0 ws0">       </div><div class="t m5 x1d h9e y44ce ff4a fs63 fc1 sc0 ls0 ws0">0x021: rrmovq %rdx,%rbx # Not executed</div><div class="t m5 x1d h9e y44cf ff4a fs63 fc1 sc0 ls0 ws0">       </div><div class="t m5 x1d h9e y44d0 ff4a fs63 fc1 sc0 ls0 ws0">0x013: irmovq $10,%rdx # Return point</div><div class="t mb xc2 ha9 y44d1 ff4a fs68 fc1 sc0 ls0 ws0">bubble</div><div class="c x1d y44d2 w11 hc8"><div class="t mb x25e ha9 y44d3 ff4a fs68 fc3 sc1 ls0 ws0">bubble</div></div><div class="t mb xc2 ha9 y44d4 ff4a fs68 fc1 sc0 ls0 ws0">bubble</div><div class="c x1d y44d2 w11 hc8"><div class="t mb x25e ha9 y44d5 ff4a fs68 fc3 sc1 ls0 ws0">bubble</div></div><div class="t mb xc2 ha9 y44d6 ff4a fs68 fc1 sc0 ls0 ws0">bubble</div><div class="c x1d y44d2 w11 hc8"><div class="t mb x25e ha9 y44d7 ff4a fs68 fc3 sc1 ls0 ws0">bubble</div></div><div class="t m5 x1d h9e y44d8 ff4a fs63 fc1 sc0 ls0 ws0"># prog6</div><div class="c x1d y44d2 w11 hc8"><div class="t m5 x0 h9e y44d9 ff4a fs63 fc3 sc1 ls0 ws0"># prog6</div></div><div class="t m5 x200 ha1 y44da ff50 fs64 fc6 sc0 ls1cf ws0">12345</div><div class="t m5 x204 ha1 y44db ff50 fs64 fc6 sc0 ls0 ws0">6</div><div class="t m5 x1bd ha1 y44dc ff50 fs64 fc6 sc0 ls0 ws0">7</div><div class="t m5 x103 ha1 y44dd ff50 fs64 fc6 sc0 ls0 ws0">8</div><div class="t m5 x104 ha1 y44de ff50 fs64 fc6 sc0 ls1d0 ws0">91<span class="_ _184"></span>0<span class="_ _2"></span>1<span class="_ _1c4"></span>1</div><div class="t m5 x169 ha0 y44df ff50 fs62 fc1 sc0 ls1fe ws0">DE<span class="_ _1"></span>M<span class="_ _8"></span>W</div><div class="t m5 x1d h3a y44e0 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _11"> </span>4.62<span class="_ _c"> </span><span class="fc1">Detailed<span class="_ _11"> </span>processing<span class="_ _16"> </span>of<span class="_"> </span>the<span class="_ _16"> </span><span class="ffd fs19">ret<span class="_ _11"> </span></span>instruction.<span class="_ _11"> </span><span class="ff6">The<span class="_ _11"> </span>fetch<span class="_ _16"> </span>stage<span class="_ _11"> </span>repeatedly</span></span></div><div class="t m5 x1d h34 y44e1 ff6 fs16 fc1 sc0 ls0 ws0">fetches<span class="_ _14"> </span>the</div><div class="t m5 xe0 h3a ya2a ffd fs19 fc1 sc0 ls0 ws0">rrmovq<span class="_ _14"> </span><span class="ff6 fs16">instruction<span class="_ _14"> </span>following<span class="_ _14"> </span>the<span class="_ _15"> </span></span>ret<span class="_ _14"> </span><span class="ff6 fs16">instruction,<span class="_ _15"> </span>but<span class="_ _14"> </span>then<span class="_ _15"> </span>the<span class="_ _14"> </span>pipeline</span></div><div class="t m5 x1d h34 ya2b ff6 fs16 fc1 sc0 ls0 ws0">control<span class="_ _16"> </span>logic<span class="_ _16"> </span>injects<span class="_ _11"> </span>a<span class="_ _16"> </span>bubble<span class="_ _16"> </span>into<span class="_ _16"> </span>the<span class="_ _16"> </span>decode<span class="_ _16"> </span>stage<span class="_ _16"> </span>rather<span class="_ _11"> </span>than<span class="_ _16"> </span>allowing<span class="_ _16"> </span>the</div><div class="t m5 x6f h3a y126b ffd fs19 fc1 sc0 ls0 ws0">rrmovq</div><div class="t m5 x1d h34 y126e ff6 fs16 fc1 sc0 ls0 ws0">instruction<span class="_ _13"> </span>to<span class="_ _10"> </span>proceed.<span class="_ _13"> </span>The<span class="_ _10"> </span>resulting<span class="_ _13"> </span>behavior<span class="_ _10"> </span>is<span class="_ _13"> </span>equivalent<span class="_ _10"> </span>to<span class="_ _13"> </span>that<span class="_ _13"> </span>shown<span class="_ _10"> </span>in<span class="_ _13"> </span>Figure<span class="_ _10"> </span>4.55.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
