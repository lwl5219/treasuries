<div id="pf409" class="pf w2 h11" data-page-no="409"><div class="pc pc409 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg409.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1032<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x103 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/badcnt.c</div><div class="t m5 x1f h88 y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">/*<span class="_ _e"> </span>WARNING:<span class="_ _e"> </span>This<span class="_ _f"> </span>code<span class="_ _e"> </span>is<span class="_ _e"> </span>buggy!<span class="_ _f"> </span>*/</span></div><div class="t m5 x1f h88 y35f1 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x1f h2e ye97 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x1f h2e y80e9 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x4f h88 y59ed ffd fs4e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*thread(void<span class="_ _f"> </span>*vargp);<span class="_ _13d"> </span>/*<span class="_ _e"> </span>Thread<span class="_ _e"> </span>routine<span class="_ _f"> </span>prototype<span class="_ _e"> </span>*/</div><div class="t m5 x1f h2e y2827 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x1f h2e y80ea ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x4f h88 y59ee ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Global<span class="_ _f"> </span>shared<span class="_ _e"> </span>variable<span class="_ _e"> </span>*/</div><div class="t m5 x1f h88 y180c ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs4e fc2">volatile<span class="_ _e"> </span>long<span class="_ _e"> </span>cnt<span class="_ _f"> </span>=<span class="_ _e"> </span>0;<span class="_ _e"> </span>/*<span class="_ _f"> </span>Counter<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f h2e y59ef ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x1f h2e y7cbc ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x4f h88 y59f0 ffd fs4e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _f"> </span>argc,<span class="_ _e"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x1b0 h2e y59f1 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x4f h88 y59f2 ffd fs4e fc2 sc0 ls0 ws0">{</div><div class="t m5 x1b0 h88 y59f3 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>niters;</span></div><div class="t m5 x1b0 h88 y59f4 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _e2"> </span><span class="ffd fs4e fc2">pthread_t<span class="_ _e"> </span>tid1,<span class="_ _e"> </span>tid2;</span></div><div class="t m5 x1b0 h2e y59f6 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x1b0 h2e y80eb ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x1b7 h88 y59f7 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Check<span class="_ _f"> </span>input<span class="_ _e"> </span>argument<span class="_ _e"> </span>*/</div><div class="t m5 x1b0 h88 y37bd ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _e2"> </span><span class="ffd fs4e fc2">if<span class="_ _e"> </span>(argc<span class="_ _e"> </span>!=<span class="_ _f"> </span>2)<span class="_ _e"> </span>{</span></div><div class="t m5 x1b0 h88 y59f8 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _18b"> </span><span class="ffd fs4e fc2">printf(&quot;usage:<span class="_ _e"> </span>%s<span class="_ _f"> </span>&lt;niters&gt;\n&quot;,<span class="_ _e"> </span>argv[0]);</span></div><div class="t m5 x1b0 h88 y4b5d ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _18b"> </span><span class="ffd fs4e fc2">exit(0);</span></div><div class="t m5 x1b0 h88 y59f9 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1b0 h88 y59fa ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _e2"> </span><span class="ffd fs4e fc2">niters<span class="_ _e"> </span>=<span class="_ _e"> </span>atoi(argv[1]);</span></div><div class="t m5 x1b0 h2e y59fb ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 x1b0 h2e y59fc ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x1b7 h88 y59fd ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Create<span class="_ _f"> </span>threads<span class="_ _e"> </span>and<span class="_ _e"> </span>wait<span class="_ _f"> </span>for<span class="_ _e"> </span>them<span class="_ _e"> </span>to<span class="_ _f"> </span>finish<span class="_ _e"> </span>*/</div><div class="t m5 x1b0 h88 y59fe ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _e2"> </span><span class="ffd fs4e fc2">Pthread_create(&amp;tid1,<span class="_ _e"> </span>NULL,<span class="_ _e"> </span>thread,<span class="_ _f"> </span>&amp;niters);</span></div><div class="t m5 x1b0 h88 y59ff ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _e2"> </span><span class="ffd fs4e fc2">Pthread_create(&amp;tid2,<span class="_ _e"> </span>NULL,<span class="_ _e"> </span>thread,<span class="_ _f"> </span>&amp;niters);</span></div><div class="t m5 x1b0 h88 y2568 ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _e2"> </span><span class="ffd fs4e fc2">Pthread_join(tid1,<span class="_ _e"> </span>NULL);</span></div><div class="t m5 x1b0 h88 y5a00 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _e2"> </span><span class="ffd fs4e fc2">Pthread_join(tid2,<span class="_ _e"> </span>NULL);</span></div><div class="t m5 x1b0 h2e y5a01 ff6 fs20 fc6 sc0 ls0 ws0">26</div><div class="t m5 x1b0 h2e y80ec ff6 fs20 fc6 sc0 ls0 ws0">27</div><div class="t m5 x1b7 h88 y301c ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Check<span class="_ _f"> </span>result<span class="_ _e"> </span>*/</div><div class="t m5 x1b0 h2e y7df1 ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x1b7 h88 y5a03 ffd fs4e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(cnt<span class="_ _f"> </span>!=<span class="_ _e"> </span>(2<span class="_ _e"> </span>*<span class="_ _f"> </span>niters))</div><div class="t m5 x1b0 h88 y5a04 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _18b"> </span><span class="ffd fs4e fc2">printf(&quot;BOOM!<span class="_ _e"> </span>cnt=%ld\n&quot;,<span class="_ _f"> </span>cnt);</span></div><div class="t m5 x1b0 h88 y5a05 ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _e2"> </span><span class="ffd fs4e fc2">else</span></div><div class="t m5 x1b0 h88 y5a06 ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _18b"> </span><span class="ffd fs4e fc2">printf(&quot;OK<span class="_ _e"> </span>cnt=%ld\n&quot;,<span class="_ _f"> </span>cnt);</span></div><div class="t m5 x1b0 h88 y1dd5 ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _e2"> </span><span class="ffd fs4e fc2">exit(0);</span></div><div class="t m5 x1b0 h88 y1abf ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1b0 h2e y296f ff6 fs20 fc6 sc0 ls0 ws0">34</div><div class="t m5 x1b0 h2e y80ed ff6 fs20 fc6 sc0 ls0 ws0">35</div><div class="t m5 x4f h88 y5a07 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Thread<span class="_ _f"> </span>routine<span class="_ _e"> </span>*/</div><div class="t m5 x1b0 h88 y5a08 ff6 fs20 fc6 sc0 ls0 ws0">36<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>*thread(void<span class="_ _e"> </span>*vargp)</span></div><div class="t m5 x1b0 h88 y5a0a ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x1b0 h88 y55cc ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>i,<span class="_ _e"> </span>niters<span class="_ _f"> </span>=<span class="_ _e"> </span>*((long<span class="_ _e"> </span>*)vargp);</span></div><div class="t m5 x1b0 h2e y3028 ff6 fs20 fc6 sc0 ls0 ws0">39</div><div class="t m5 x1b0 h2e y80ee ff6 fs20 fc6 sc0 ls0 ws0">40</div><div class="t m5 x1b7 h88 y55cd ffd fs4e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _f"> </span>=<span class="_ _e"> </span>0;<span class="_ _e"> </span>i<span class="_ _f"> </span>&lt;<span class="_ _e"> </span>niters;<span class="_ _e"> </span>i++)</div><div class="t m5 x1b0 h88 yc47 ff6 fs20 fc6 sc0 ls0 ws0">41<span class="_ _18b"> </span><span class="ffd fs4e fc2">cnt++;</span></div><div class="t m5 x1b0 h2e y6294 ff6 fs20 fc6 sc0 ls0 ws0">42</div><div class="t m5 x1b0 h2e y80ef ff6 fs20 fc6 sc0 ls0 ws0">43</div><div class="t m5 x1b7 h88 y6295 ffd fs4e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>NULL;</div><div class="t m5 x1b0 h88 yc0 ff6 fs20 fc6 sc0 ls0 ws0">44<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x103 h2c y7fbe ffa fs16 fc2 sc0 ls0 ws0">code/conc/badcnt.c</div><div class="t m5 x1d h2f y7fbf ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.16</div><div class="t m5 x1a h3a y80f0 ffd fs19 fc1 sc0 ls0 ws0">badcnt.c<span class="ffe fs16">:<span class="_"> </span>An<span class="_"> </span>improperly<span class="_"> </span>synchronized<span class="_"> </span>counter<span class="_"> </span>program.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
