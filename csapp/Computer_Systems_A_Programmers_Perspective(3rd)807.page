<div id="pf327" class="pf w2 h11" data-page-no="327"><div class="pc pc327 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg327.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">806<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 xcd h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">clears<span class="_"> </span>the<span class="_ _13"> </span>ﬂag.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_"> </span>ﬂags<span class="_ _13"> </span>that<span class="_"> </span>are<span class="_"> </span>shared<span class="_ _13"> </span>in<span class="_"> </span>this<span class="_"> </span>way<span class="_ _7"></span>,<span class="_"> </span>C<span class="_"> </span>provides<span class="_ _13"> </span>an<span class="_"> </span>integer</div><div class="t m5 xcd h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">data<span class="_ _13"> </span>type<span class="_ _1"></span>,<span class="_ _13"> </span><span class="ffd">sig_atomic_t</span>,<span class="_ _13"> </span>for<span class="_ _13"> </span>which<span class="_ _6"> </span>reads<span class="_ _13"> </span>and<span class="_ _13"> </span>writes<span class="_ _6"> </span>are<span class="_ _13"> </span>guaranteed<span class="_ _13"> </span>to<span class="_ _6"> </span>be</div><div class="t m5 xcd h26 y2a8 ffa fs19 fc2 sc0 ls0 ws0">atomic<span class="_ _11"> </span><span class="ff7">(uninterruptible)<span class="_"> </span>because<span class="_ _11"> </span>they<span class="_ _11"> </span>can<span class="_"> </span>be<span class="_ _11"> </span>implemented<span class="_ _11"> </span>with<span class="_"> </span>a<span class="_ _11"> </span>single</span></div><div class="t m5 xcd h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">instruction:</div><div class="t m5 x59 h2d y6987 ffd fs1e fc2 sc0 ls0 ws0">volatile<span class="_ _e"> </span>sig_atomic_t<span class="_ _1f"> </span>flag;</div><div class="t m5 x1c6 h26 y6988 ff7 fs19 fc2 sc0 ls0 ws0">Since<span class="_ _13"> </span>they<span class="_ _13"> </span>can’t<span class="_ _13"> </span>be<span class="_ _13"> </span>interrupted,<span class="_ _13"> </span>you<span class="_ _13"> </span>can<span class="_ _13"> </span>safely<span class="_ _13"> </span>read<span class="_ _13"> </span>from<span class="_ _13"> </span>and<span class="_ _13"> </span>write<span class="_"> </span>to</div><div class="t m5 xcd h26 y6989 ffd fs19 fc2 sc0 ls0 ws0">sig_atomic_t<span class="_ _10"> </span><span class="ff7">variables<span class="_ _11"> </span>without<span class="_ _11"> </span>temporarily<span class="_"> </span>blocking<span class="_ _11"> </span>signals<span class="_ _1"></span>.<span class="_ _11"> </span>Note<span class="_"> </span>that</span></div><div class="t m5 xcd h26 y698a ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>guarantee<span class="_ _15"> </span>of<span class="_ _14"> </span>atomicity<span class="_ _15"> </span>only<span class="_ _14"> </span>applies<span class="_ _15"> </span>to<span class="_ _14"> </span>individual<span class="_ _15"> </span>reads<span class="_ _15"> </span>and<span class="_ _14"> </span>writes<span class="_ _1"></span>.</div><div class="t m5 xcd h26 y698b ff7 fs19 fc2 sc0 ls0 ws0">It<span class="_ _11"> </span>does<span class="_ _11"> </span>not<span class="_ _11"> </span>apply<span class="_ _16"> </span>to<span class="_ _11"> </span>updates<span class="_ _11"> </span>such<span class="_ _11"> </span>as<span class="_ _11"> </span><span class="ffd">flag++<span class="_ _16"> </span></span>or<span class="_"> </span><span class="ffd">flag<span class="_ _16"> </span>=<span class="_ _16"> </span>flag<span class="_ _11"> </span>+<span class="_ _16"> </span>10</span>,<span class="_ _11"> </span>which</div><div class="t m5 xcd h26 y698c ff7 fs19 fc2 sc0 ls0 ws0">might<span class="_"> </span>require<span class="_"> </span>multiple<span class="_"> </span>instructions<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y698d ff7 fs19 fc2 sc0 ls0 ws0">Keep<span class="_ _21"> </span>in<span class="_ _f"> </span>mind<span class="_ _f"> </span>that<span class="_ _21"> </span>the<span class="_ _f"> </span>guidelines<span class="_ _f"> </span>we<span class="_ _f"> </span>have<span class="_ _f"> </span>presented<span class="_ _f"> </span>are<span class="_ _f"> </span>conservative<span class="_ _1"></span>,<span class="_ _e"> </span>in</div><div class="t m5 x1d h26 y698e ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>sense<span class="_ _14"> </span>that<span class="_ _16"> </span>they<span class="_ _14"> </span>are<span class="_ _14"> </span>not<span class="_ _14"> </span>always<span class="_ _14"> </span>strictly<span class="_ _14"> </span>necessary<span class="_ _3"></span>.<span class="_ _14"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>example<span class="_ _0"></span>,<span class="_ _14"> </span>if<span class="_ _14"> </span>you<span class="_ _14"> </span>know</div><div class="t m5 x1d h26 y698f ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _11"> </span>a<span class="_ _11"> </span>handler<span class="_ _11"> </span>can<span class="_ _16"> </span>never<span class="_ _11"> </span>modify<span class="_ _11"> </span><span class="ffd">errno</span>,<span class="_ _16"> </span>then<span class="_"> </span>you<span class="_ _16"> </span>don’<span class="_ _0"></span>t<span class="_ _11"> </span>need<span class="_ _11"> </span>to<span class="_ _11"> </span>save<span class="_ _16"> </span>and<span class="_ _11"> </span>restore</div><div class="t m5 x1d h26 y6990 ffd fs19 fc2 sc0 ls0 ws0">errno<span class="ff7">.<span class="_ _16"> </span>Or<span class="_ _14"> </span>if<span class="_ _16"> </span>you<span class="_ _14"> </span>can<span class="_ _14"> </span>prove<span class="_ _16"> </span>that<span class="_ _14"> </span>no<span class="_ _16"> </span>instance<span class="_ _14"> </span>of<span class="_ _14"> </span></span>printf<span class="_ _16"> </span><span class="ff7">can<span class="_ _14"> </span>ever<span class="_ _16"> </span>be<span class="_ _14"> </span>interrupted</span></div><div class="t m5 x1d h26 y6991 ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_ _11"> </span>a<span class="_ _11"> </span>handler,<span class="_ _11"> </span>then<span class="_ _16"> </span>it<span class="_ _11"> </span>is<span class="_ _11"> </span>safe<span class="_ _16"> </span>to<span class="_ _11"> </span>call<span class="_ _11"> </span><span class="ffd">printf<span class="_ _11"> </span></span>from<span class="_ _16"> </span>the<span class="_ _11"> </span>handler.<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>same<span class="_ _11"> </span>holds<span class="_ _11"> </span>for</div><div class="t m5 x1d h26 y6992 ff7 fs19 fc2 sc0 ls0 ws0">accesses<span class="_ _13"> </span>to<span class="_ _6"> </span>shared<span class="_ _13"> </span>global<span class="_ _6"> </span>data<span class="_ _13"> </span>structures<span class="_ _1"></span>.<span class="_ _13"> </span>However<span class="_ _0"></span>,<span class="_ _13"> </span>it<span class="_ _6"> </span>is<span class="_ _13"> </span>very<span class="_ _13"> </span>difﬁcult<span class="_ _6"> </span>to<span class="_ _13"> </span>prove<span class="_ _13"> </span>such</div><div class="t m5 x1d h26 y6993 ff7 fs19 fc2 sc0 ls0 ws0">assertions<span class="_"> </span>in<span class="_ _13"> </span>general.<span class="_"> </span>So<span class="_"> </span>we<span class="_"> </span>recommend<span class="_ _13"> </span>that<span class="_"> </span>you<span class="_"> </span>take<span class="_ _13"> </span>the<span class="_"> </span>conservative<span class="_"> </span>approach</div><div class="t m5 x1d h26 y6994 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>follow<span class="_ _11"> </span>the<span class="_ _11"> </span>guidelines<span class="_ _11"> </span>by<span class="_ _11"> </span>keeping<span class="_ _11"> </span>your<span class="_ _11"> </span>handlers<span class="_ _11"> </span>as<span class="_ _11"> </span>simple<span class="_ _11"> </span>as<span class="_ _11"> </span>possible<span class="_ _1"></span>,<span class="_ _11"> </span>calling</div><div class="t m5 x1d h26 y6995 ff7 fs19 fc2 sc0 ls0 ws0">safe<span class="_ _21"> </span>functions<span class="_ _1"></span>,<span class="_ _f"> </span>saving<span class="_ _f"> </span>and<span class="_ _21"> </span>restoring<span class="_ _21"> </span><span class="ffd">errno</span>,<span class="_ _e"> </span>protecting<span class="_ _15"> </span>accesses<span class="_ _21"> </span>to<span class="_ _21"> </span>shared<span class="_ _21"> </span>data</div><div class="t m5 x1d h26 y6996 ff7 fs19 fc2 sc0 ls0 ws0">structures<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>using<span class="_"> </span><span class="ffd">volatile<span class="_ _10"> </span></span>and<span class="_"> </span><span class="ffd">sig_atomic_t</span>.</div><div class="t m5 x1d h42 y2e8d ff6 fs29 fc6 sc0 ls0 ws0">Correct<span class="_ _11"> </span>Signal<span class="_ _16"> </span>Handling</div><div class="t m5 x1d h26 y2659 ff7 fs19 fc1 sc0 ls0 ws0">One<span class="_"> </span>of<span class="_"> </span>the<span class="_ _11"> </span>nonintuitive<span class="_"> </span>aspects<span class="_"> </span>of<span class="_ _11"> </span>signals<span class="_"> </span>is<span class="_"> </span>that<span class="_ _11"> </span>pending<span class="_"> </span>signals<span class="_"> </span>are<span class="_ _11"> </span>not<span class="_"> </span>queued.</div><div class="t m5 x1d h26 y2e8e ff7 fs19 fc1 sc0 ls0 ws0">Because<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ffd">pending<span class="_ _16"> </span></span>bit<span class="_ _16"> </span>vector<span class="_ _16"> </span>contains<span class="_ _11"> </span>exactly<span class="_ _16"> </span>one<span class="_ _16"> </span>bit<span class="_ _16"> </span>for<span class="_ _16"> </span>each<span class="_ _11"> </span>type<span class="_ _16"> </span>of<span class="_ _16"> </span>signal,</div><div class="t m5 x1d h26 y2e8f ff7 fs19 fc1 sc0 ls0 ws0">there<span class="_ _13"> </span>can<span class="_"> </span>be<span class="_ _13"> </span>at<span class="_ _13"> </span>most<span class="_ _13"> </span>one<span class="_"> </span>pending<span class="_ _13"> </span>signal<span class="_ _13"> </span>of<span class="_ _13"> </span>any<span class="_"> </span>particular<span class="_ _13"> </span>type<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _3"></span>hus<span class="_ _0"></span>,<span class="_ _13"> </span>if<span class="_"> </span>two<span class="_ _13"> </span>signals</div><div class="t m5 x1d h26 y2e90 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _16"> </span>type<span class="_ _11"> </span><span class="ff11">k<span class="_ _15"> </span></span>are<span class="_ _16"> </span>sent<span class="_ _11"> </span>to<span class="_ _16"> </span>a<span class="_ _16"> </span>destination<span class="_ _16"> </span>process<span class="_ _16"> </span>while<span class="_ _16"> </span>signal<span class="_ _11"> </span><span class="ff11">k<span class="_ _14"> </span></span>is<span class="_ _16"> </span>blocked<span class="_ _16"> </span>because<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y2e91 ff7 fs19 fc1 sc0 ls0 ws0">destination<span class="_"> </span>process<span class="_ _11"> </span>is<span class="_ _11"> </span>currently<span class="_ _11"> </span>executing<span class="_ _11"> </span>a<span class="_"> </span>handler<span class="_ _11"> </span>for<span class="_ _11"> </span>signal<span class="_ _11"> </span><span class="ff11">k<span class="_ _2"></span></span>,<span class="_ _11"> </span>then<span class="_ _11"> </span>the<span class="_"> </span>second</div><div class="t m5 x1d h26 y2e92 ff7 fs19 fc1 sc0 ls0 ws0">signal<span class="_"> </span>is<span class="_"> </span>simply<span class="_"> </span>discarded;<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>not<span class="_ _13"> </span>queued.<span class="_"> </span>The<span class="_"> </span>key<span class="_ _13"> </span>idea<span class="_"> </span>is<span class="_"> </span>that<span class="_"> </span>the<span class="_"> </span>existence<span class="_"> </span>of<span class="_"> </span>a</div><div class="t m5 x1d h26 y2e93 ff7 fs19 fc1 sc0 ls0 ws0">pending<span class="_"> </span>signal<span class="_"> </span>merely<span class="_"> </span>indicates<span class="_"> </span>that<span class="_"> </span><span class="ffa">at<span class="_"> </span>least<span class="_ _11"> </span></span>one<span class="_"> </span>signal<span class="_"> </span>has<span class="_"> </span>arrived.</div><div class="t m5 x29 h26 y2e94 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _21"> </span>see<span class="_ _21"> </span>how<span class="_ _21"> </span>this<span class="_ _15"> </span>affects<span class="_ _21"> </span>correctness<span class="_ _1"></span>,<span class="_ _f"> </span>let’s<span class="_ _15"> </span>look<span class="_ _21"> </span>at<span class="_ _21"> </span>a<span class="_ _15"> </span>simple<span class="_ _21"> </span>application<span class="_ _21"> </span>that</div><div class="t m5 x1d h26 y2e95 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _14"> </span>similar<span class="_ _14"> </span>in<span class="_ _14"> </span>nature<span class="_ _15"> </span>to<span class="_ _14"> </span>real<span class="_ _14"> </span>programs<span class="_ _14"> </span>such<span class="_ _15"> </span>as<span class="_ _14"> </span>shells<span class="_ _14"> </span>and<span class="_ _14"> </span>W<span class="_ _1"></span>eb<span class="_ _14"> </span>servers<span class="_ _1"></span>.<span class="_ _14"> </span>The<span class="_ _16"> </span>basic</div><div class="t m5 x1d h26 y2e96 ff7 fs19 fc1 sc0 ls0 ws0">structure<span class="_ _13"> </span>is<span class="_ _13"> </span>that<span class="_ _13"> </span>a<span class="_ _13"> </span>parent<span class="_ _13"> </span>process<span class="_ _13"> </span>creates<span class="_ _6"> </span>some<span class="_ _13"> </span>children<span class="_ _13"> </span>that<span class="_ _13"> </span>run<span class="_ _13"> </span>independently<span class="_ _13"> </span>for</div><div class="t m5 x1d h26 y2e97 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _16"> </span>while<span class="_ _16"> </span>and<span class="_ _16"> </span>then<span class="_ _16"> </span>terminate<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span>parent<span class="_ _16"> </span>must<span class="_ _16"> </span>reap<span class="_ _16"> </span>the<span class="_ _16"> </span>children<span class="_ _16"> </span>to<span class="_ _11"> </span>avoid<span class="_ _16"> </span>leaving</div><div class="t m5 x1d h26 y2e98 ff7 fs19 fc1 sc0 ls0 ws0">zombies<span class="_ _11"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>system.<span class="_ _16"> </span>But<span class="_ _11"> </span>we<span class="_ _16"> </span>also<span class="_ _11"> </span>want<span class="_ _16"> </span>the<span class="_ _11"> </span>parent<span class="_ _11"> </span>to<span class="_ _16"> </span>be<span class="_ _11"> </span>free<span class="_ _16"> </span>to<span class="_ _11"> </span>do<span class="_ _16"> </span>other<span class="_ _11"> </span>work</div><div class="t m5 x1d h26 y2e99 ff7 fs19 fc1 sc0 ls0 ws0">while<span class="_ _6"> </span>the<span class="_ _13"> </span>children<span class="_ _6"> </span>are<span class="_ _6"> </span>running.<span class="_ _6"> </span>So<span class="_ _13"> </span>we<span class="_ _a"> </span>decide<span class="_ _13"> </span>to<span class="_ _6"> </span>reap<span class="_ _6"> </span>the<span class="_ _13"> </span>children<span class="_ _6"> </span>with<span class="_ _6"> </span>a<span class="_ _13"> </span>SIGCHLD</div><div class="t m5 x1d h26 y2e9a ff7 fs19 fc1 sc0 ls0 ws0">handler,<span class="_ _16"> </span>instead<span class="_ _14"> </span>of<span class="_ _14"> </span>explicitly<span class="_ _16"> </span>waiting<span class="_ _14"> </span>for<span class="_ _16"> </span>the<span class="_ _14"> </span>children<span class="_ _14"> </span>to<span class="_ _16"> </span>terminate.<span class="_ _16"> </span>(Recall<span class="_ _16"> </span>that</div><div class="t m5 x1d h26 y2e9b ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span>kernel<span class="_ _16"> </span>sends<span class="_ _11"> </span>a<span class="_ _16"> </span>SIGCHLD<span class="_ _16"> </span>signal<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>parent<span class="_ _11"> </span>whenever<span class="_ _16"> </span>one<span class="_ _16"> </span>of<span class="_ _16"> </span>its<span class="_ _16"> </span>children</div><div class="t m5 x1d h26 y2e9c ff7 fs19 fc1 sc0 ls0 ws0">terminates<span class="_"> </span>or<span class="_"> </span>stops<span class="_ _1"></span>.)</div><div class="t m5 x29 h26 y2e9d ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _11"> </span>8.36<span class="_"> </span>shows<span class="_"> </span>our<span class="_ _11"> </span>ﬁrst<span class="_"> </span>attempt.<span class="_"> </span>The<span class="_"> </span>parent<span class="_"> </span>installs<span class="_"> </span>a<span class="_"> </span>SIGCHLD<span class="_ _11"> </span>handler</div><div class="t m5 x1d h26 y2e9e ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _16"> </span>then<span class="_ _16"> </span>creates<span class="_ _16"> </span>three<span class="_ _16"> </span>children.<span class="_ _16"> </span>In<span class="_ _14"> </span>the<span class="_ _16"> </span>meantime<span class="_ _0"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>parent<span class="_ _14"> </span>waits<span class="_ _16"> </span>for<span class="_ _16"> </span>a<span class="_ _16"> </span>line<span class="_ _16"> </span>of</div><div class="t m5 x1d h26 y2e9f ff7 fs19 fc1 sc0 ls0 ws0">input<span class="_ _21"> </span>from<span class="_ _21"> </span>the<span class="_ _f"> </span>terminal<span class="_ _21"> </span>and<span class="_ _f"> </span>then<span class="_ _21"> </span>processes<span class="_ _21"> </span>it.<span class="_ _f"> </span>T<span class="_ _1"></span>his<span class="_ _f"> </span>processing<span class="_ _21"> </span>is<span class="_ _f"> </span>modeled<span class="_ _21"> </span>by</div><div class="t m5 x1d h26 y2ea0 ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_ _14"> </span>inﬁnite<span class="_ _15"> </span>loop<span class="_ _0"></span>.<span class="_ _14"> </span>When<span class="_ _14"> </span>each<span class="_ _15"> </span>child<span class="_ _15"> </span>terminates<span class="_ _1"></span>,<span class="_ _15"> </span>the<span class="_ _15"> </span>kernel<span class="_ _15"> </span>notiﬁes<span class="_ _15"> </span>the<span class="_ _14"> </span>parent<span class="_ _15"> </span>by</div><div class="t m5 x1d h26 y2ea1 ff7 fs19 fc1 sc0 ls0 ws0">sending<span class="_ _13"> </span>it<span class="_ _13"> </span>a<span class="_ _13"> </span>SIGCHLD<span class="_ _13"> </span>signal.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>parent<span class="_ _13"> </span>catches<span class="_ _13"> </span>the<span class="_ _13"> </span>SIGCHLD<span class="_ _3"></span>,<span class="_ _13"> </span>reaps<span class="_ _13"> </span>one<span class="_ _13"> </span>child,</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
