<div id="pf227" class="pf w2 h11" data-page-no="227"><div class="pc pc227 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg227.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">550<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1d h3b y9c fff fs24 fc6 sc0 ls0 ws0">5.6<span class="_ _17"> </span><span class="ffe fs18">Eliminating<span class="_"> </span>Unneeded<span class="_"> </span>Memor<span class="_ _2"></span>y<span class="_"> </span>References</span></div><div class="t m5 x1d h26 y327 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>code<span class="_ _11"> </span>for<span class="_"> </span><span class="ffd">combine3<span class="_ _10"> </span></span>accumulates<span class="_"> </span>the<span class="_ _11"> </span>value<span class="_"> </span>being<span class="_"> </span>computed<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>combining</div><div class="t m5 x1d h26 y328 ff7 fs19 fc1 sc0 ls0 ws0">operation<span class="_ _6"> </span>at<span class="_ _6"> </span>the<span class="_ _13"> </span>location<span class="_ _a"> </span>designated<span class="_ _13"> </span>by<span class="_ _a"> </span>the<span class="_ _13"> </span>pointer<span class="_ _a"> </span><span class="ffd">dest</span>.<span class="_ _13"> </span>T<span class="_ _3"></span>his<span class="_ _13"> </span>attribute<span class="_ _a"> </span>can<span class="_ _13"> </span>be<span class="_ _a"> </span>seen</div><div class="t m5 x1d h26 y329 ff7 fs19 fc1 sc0 ls0 ws0">by<span class="_ _14"> </span>examining<span class="_ _15"> </span>the<span class="_ _14"> </span>assembly<span class="_ _15"> </span>code<span class="_ _15"> </span>generated<span class="_ _14"> </span>for<span class="_ _15"> </span>the<span class="_ _14"> </span>inner<span class="_ _15"> </span>loop<span class="_ _14"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>compiled</div><div class="t m5 x1d h26 y32a ff7 fs19 fc1 sc0 ls0 ws0">code<span class="_ _1"></span>.<span class="_ _15"> </span>W<span class="_ _3"></span>e<span class="_ _14"> </span>show<span class="_ _15"> </span>here<span class="_ _14"> </span>the<span class="_ _15"> </span>x86-64<span class="_ _14"> </span>code<span class="_ _14"> </span>generated<span class="_ _15"> </span>for<span class="_ _14"> </span>data<span class="_ _14"> </span>type<span class="_ _15"> </span><span class="ffd">double<span class="_ _14"> </span></span>and<span class="_ _14"> </span>with</div><div class="t m5 x1d h26 y32b ff7 fs19 fc1 sc0 ls0 ws0">multiplication<span class="_"> </span>as<span class="_"> </span>the<span class="_"> </span>combining<span class="_"> </span>operation:</div><div class="t m5 xad h61 y1a10 ff13 fs35 fc6 sc0 ls0 ws0">Inner<span class="_ _f"> </span>loop<span class="_ _f"> </span>of<span class="_ _f"> </span>combine3.<span class="_ _3d"> </span>data_t<span class="_ _f"> </span>=<span class="_ _e"> </span>double,<span class="_ _21"> </span>OP<span class="_ _f"> </span>=<span class="_ _e"> </span>*</div><div class="t m5 xad h61 y4b59 ff13 fs35 fc6 sc0 ls0 ws0">dest<span class="_ _f"> </span>in<span class="_ _f"> </span>%rbx,<span class="_ _f"> </span>data+i<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>data+length<span class="_ _e"> </span>in<span class="_ _21"> </span>%rax</div><div class="t m5 x1f h2d y4b5a ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">.L17:<span class="_ _160"> </span></span><span class="ff2d fs35">loop:</span></div><div class="t m5 x1f h2d y1ab0 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovsd<span class="_ _1a"> </span>(%rbx),<span class="_ _e"> </span>%xmm0<span class="_ _12e"> </span></span><span class="ff13 fs35">Read<span class="_ _e"> </span>product<span class="_ _21"> </span>from<span class="_ _f"> </span>dest</span></div><div class="t m5 x1f h2d y4b5b ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">vmulsd<span class="_ _1a"> </span>(%rdx),<span class="_ _e"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0<span class="_ _3a"> </span></span><span class="ff13 fs35">Multiply<span class="_ _f"> </span>product<span class="_ _f"> </span>by<span class="_ _f"> </span>data[i]</span></div><div class="t m5 x1f h2d y4b5c ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovsd<span class="_ _1a"> </span>%xmm0,<span class="_ _e"> </span>(%rbx)<span class="_ _12e"> </span></span><span class="ff13 fs35">Store<span class="_ _e"> </span>product<span class="_ _21"> </span>at<span class="_ _f"> </span>dest</span></div><div class="t m5 x1f h2d yeab ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$8,<span class="_ _e"> </span>%rdx<span class="_ _d5"> </span></span><span class="ff13 fs35">Increment<span class="_ _f"> </span>data+i</span></div><div class="t m5 x1f h2d y19a5 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">cmpq<span class="_ _46"> </span>%rax,<span class="_ _e"> </span>%rdx<span class="_ _161"> </span></span><span class="ff13 fs35">Compare<span class="_ _f"> </span>to<span class="_ _f"> </span>data+length</span></div><div class="t m5 x1f h2d y4b5d ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _45"> </span><span class="ffd fs1e fc2">jne<span class="_ _8c"> </span>.L17<span class="_ _136"> </span></span><span class="ff13 fs35">If<span class="_ _f"> </span>!=,<span class="_ _f"> </span>goto<span class="_ _f"> </span><span class="ff2d">loop</span></span></div><div class="t m5 x1d h26 y3ec ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_"> </span>see<span class="_ _13"> </span>in<span class="_"> </span>this<span class="_"> </span>loop<span class="_ _13"> </span>code<span class="_"> </span>that<span class="_ _13"> </span>the<span class="_"> </span>address<span class="_ _13"> </span>corresponding<span class="_"> </span>to<span class="_"> </span>pointer<span class="_ _13"> </span><span class="ffd">dest<span class="_ _10"> </span></span>is<span class="_ _13"> </span>held<span class="_"> </span>in</div><div class="t m5 x1d h26 y4b5e ff7 fs19 fc2 sc0 ls0 ws0">register<span class="_ _13"> </span><span class="ffd">%rbx</span>.<span class="_ _6"> </span>It<span class="_ _13"> </span>has<span class="_ _6"> </span>also<span class="_ _13"> </span>transformed<span class="_ _6"> </span>the<span class="_ _13"> </span>code<span class="_ _13"> </span>to<span class="_ _6"> </span>maintain<span class="_ _13"> </span>a<span class="_ _6"> </span>pointer<span class="_ _13"> </span>to<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ff11">i<span class="_ _5"></span></span>th<span class="_ _13"> </span>data</div><div class="t m5 x1d h26 y4b5f ff7 fs19 fc2 sc0 ls0 ws0">element<span class="_"> </span>in<span class="_ _11"> </span>register<span class="_ _11"> </span><span class="ffd">%rdx</span>,<span class="_ _16"> </span>shown<span class="_"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>annotations<span class="_ _11"> </span>as<span class="_ _11"> </span><span class="ffd">data+i</span>.<span class="_ _11"> </span>T<span class="_ _0"></span>his<span class="_"> </span>pointer<span class="_ _11"> </span>is<span class="_ _11"> </span>in-</div><div class="t m5 x1d h26 y4b60 ff7 fs19 fc2 sc0 ls0 ws0">cremented<span class="_ _13"> </span>by<span class="_ _13"> </span>8<span class="_ _13"> </span>on<span class="_ _13"> </span>every<span class="_ _13"> </span>iteration.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>loop<span class="_ _13"> </span>termination<span class="_ _13"> </span>is<span class="_ _13"> </span>detected<span class="_ _13"> </span>by<span class="_ _13"> </span>comparing</div><div class="t m5 x1d h26 y4b61 ff7 fs19 fc2 sc0 ls0 ws0">this<span class="_ _13"> </span>pointer<span class="_"> </span>to<span class="_ _13"> </span>one<span class="_"> </span>stored<span class="_ _13"> </span>in<span class="_"> </span>register<span class="_ _13"> </span><span class="ffd">%rax</span>.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>can<span class="_ _13"> </span>see<span class="_ _13"> </span>that<span class="_"> </span>the<span class="_ _13"> </span>accumulated<span class="_"> </span>value</div><div class="t m5 x1d h26 y4b62 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_"> </span>read<span class="_ _13"> </span>from<span class="_"> </span>and<span class="_"> </span>written<span class="_"> </span>to<span class="_ _13"> </span>memory<span class="_"> </span>on<span class="_"> </span>each<span class="_ _13"> </span>iteration.<span class="_"> </span>T<span class="_ _0"></span>his<span class="_"> </span>reading<span class="_ _13"> </span>and<span class="_"> </span>writing<span class="_"> </span>is</div><div class="t m5 x1d h26 y4b63 ff7 fs19 fc2 sc0 ls0 ws0">wasteful,<span class="_"> </span>since<span class="_ _13"> </span>the<span class="_ _13"> </span>value<span class="_"> </span>read<span class="_ _13"> </span>from<span class="_"> </span><span class="ffd">dest<span class="_ _13"> </span></span>at<span class="_"> </span>the<span class="_ _13"> </span>beginning<span class="_ _13"> </span>of<span class="_"> </span>each<span class="_ _13"> </span>iteration<span class="_"> </span>should</div><div class="t m5 x1d h26 y4b64 ff7 fs19 fc2 sc0 ls0 ws0">simply<span class="_"> </span>be<span class="_"> </span>the<span class="_"> </span>value<span class="_"> </span>written<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>end<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>previous<span class="_"> </span>iteration.</div><div class="t m5 x29 h26 y4b65 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _13"> </span>can<span class="_ _a"> </span>eliminate<span class="_ _13"> </span>this<span class="_ _a"> </span>needless<span class="_ _13"> </span>reading<span class="_ _a"> </span>and<span class="_ _13"> </span>writing<span class="_ _a"> </span>of<span class="_ _13"> </span>memory<span class="_ _6"> </span>by<span class="_ _6"> </span>rewriting<span class="_ _6"> </span>the</div><div class="t m5 x1d h26 y4b66 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>style<span class="_ _11"> </span>of<span class="_ _11"> </span><span class="ffd">combine4<span class="_ _16"> </span></span>in<span class="_"> </span>Figure<span class="_"> </span>5.10.<span class="_ _11"> </span>W<span class="_ _1"></span>e<span class="_ _11"> </span>introduce<span class="_ _11"> </span>a<span class="_ _11"> </span>temporary<span class="_ _11"> </span>variable</div><div class="t m5 x1d h26 y4b67 ffd fs19 fc2 sc0 ls0 ws0">acc<span class="_ _13"> </span><span class="ff7">that<span class="_ _13"> </span>is<span class="_ _13"> </span>used<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>loop<span class="_ _13"> </span>to<span class="_ _13"> </span>accumulate<span class="_"> </span>the<span class="_ _13"> </span>computed<span class="_ _13"> </span>value<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_"> </span>result<span class="_ _13"> </span>is<span class="_ _13"> </span>stored</span></div><div class="t m5 x1d h26 y4b68 ff7 fs19 fc2 sc0 ls0 ws0">at<span class="_ _13"> </span><span class="ffd">dest<span class="_ _13"> </span></span>only<span class="_ _13"> </span>after<span class="_ _13"> </span>the<span class="_ _13"> </span>loop<span class="_ _13"> </span>has<span class="_ _13"> </span>been<span class="_ _13"> </span>completed.<span class="_ _13"> </span>As<span class="_ _13"> </span>the<span class="_ _13"> </span>assembly<span class="_ _13"> </span>code<span class="_ _6"> </span>that<span class="_ _13"> </span>follows</div><div class="t m5 x1d h26 y4b69 ff7 fs19 fc2 sc0 ls0 ws0">shows<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>compiler<span class="_ _16"> </span>can<span class="_ _14"> </span>now<span class="_ _16"> </span>use<span class="_ _16"> </span>register<span class="_ _16"> </span><span class="ffd">%xmm0<span class="_ _16"> </span></span>to<span class="_ _16"> </span>hold<span class="_ _16"> </span>the<span class="_ _16"> </span>accumulated<span class="_ _16"> </span>value.</div><div class="t m5 x1d h26 y4b6a ff7 fs19 fc2 sc0 ls0 ws0">Compared<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>loop<span class="_"> </span>in<span class="_"> </span><span class="ffd">combine3</span>,<span class="_ _13"> </span>we<span class="_"> </span>have<span class="_"> </span>reduced<span class="_"> </span>the<span class="_ _13"> </span>memory<span class="_"> </span>operations<span class="_"> </span>per</div><div class="t m5 x1d h26 y4b6b ff7 fs19 fc2 sc0 ls0 ws0">iteration<span class="_"> </span>from<span class="_"> </span>two<span class="_"> </span>reads<span class="_"> </span>and<span class="_"> </span>one<span class="_"> </span>write<span class="_"> </span>to<span class="_"> </span>just<span class="_"> </span>a<span class="_"> </span>single<span class="_"> </span>read.</div><div class="t m5 xad h61 y93b ff13 fs35 fc6 sc0 ls0 ws0">Inner<span class="_ _f"> </span>loop<span class="_ _f"> </span>of<span class="_ _f"> </span>combine4.<span class="_ _3d"> </span>data_t<span class="_ _f"> </span>=<span class="_ _e"> </span>double,<span class="_ _21"> </span>OP<span class="_ _f"> </span>=<span class="_ _e"> </span>*</div><div class="t m5 xad h61 y4b6c ff13 fs35 fc6 sc0 ls0 ws0">acc<span class="_ _f"> </span>in<span class="_ _f"> </span>%xmm0,<span class="_ _f"> </span>data+i<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>data+length<span class="_ _e"> </span>in<span class="_ _21"> </span>%rax</div><div class="t m5 x1f h2d y1ac5 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">.L25:<span class="_ _160"> </span></span><span class="ff2d fs35">loop:</span></div><div class="t m5 x1f h2e y4b6d ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x10d h2d y4b6e ffd fs1e fc2 sc0 ls0 ws0">vmulsd<span class="_ _1a"> </span>(%rdx),<span class="_ _e"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0<span class="_ _3a"> </span><span class="ff13 fs35 fc6">Multiply<span class="_ _f"> </span>acc<span class="_ _f"> </span>by<span class="_ _f"> </span>data[i]</span></div><div class="t m5 x1f h2d y4b6f ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$8,<span class="_ _e"> </span>%rdx<span class="_ _d5"> </span></span><span class="ff13 fs35">Increment<span class="_ _f"> </span>data+i</span></div><div class="t m5 x1f h2e y1aca ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x10d h2d y4b70 ffd fs1e fc2 sc0 ls0 ws0">cmpq<span class="_ _46"> </span>%rax,<span class="_ _e"> </span>%rdx<span class="_ _161"> </span><span class="ff13 fs35 fc6">Compare<span class="_ _f"> </span>to<span class="_ _f"> </span>data+length</span></div><div class="t m5 x1f h2d y35a0 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">jne<span class="_ _8c"> </span>.L25<span class="_ _136"> </span></span><span class="ff13 fs35">If<span class="_ _f"> </span>!=,<span class="_ _f"> </span>goto<span class="_ _f"> </span><span class="ff2d">loop</span></span></div><div class="t m5 x29 h26 y7a6 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _16"> </span>see<span class="_ _11"> </span>a<span class="_ _16"> </span>signiﬁcant<span class="_ _11"> </span>improvement<span class="_ _11"> </span>in<span class="_ _16"> </span>program<span class="_ _11"> </span>performance,<span class="_ _11"> </span>as<span class="_ _16"> </span>shown<span class="_ _11"> </span>in<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y7a7 ff7 fs19 fc2 sc0 ls0 ws0">following<span class="_"> </span>table:</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
