<div id="pf2e5" class="pf w2 h11" data-page-no="2e5"><div class="pc pc2e5 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2e5.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">740<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Shared<span class="_ _11"> </span>libraries<span class="_ _11"> </span>and<span class="_ _11"> </span>the<span class="_ _16"> </span>Java<span class="_ _11"> </span>Native<span class="_ _11"> </span>Interface</span></div><div class="t m5 x28 h2b y258 ff7 fs1e fc2 sc0 ls0 ws0">J<span class="_ _3"></span>ava<span class="_ _16"> </span>deﬁnes<span class="_ _14"> </span>a<span class="_ _16"> </span>standard<span class="_ _16"> </span>calling<span class="_ _14"> </span>convention<span class="_ _16"> </span>called<span class="_ _16"> </span><span class="ffa">J<span class="_ _1"></span>ava<span class="_ _16"> </span>Native<span class="_ _14"> </span>Interface<span class="_ _16"> </span>(JNI)<span class="_ _10"> </span><span class="ff7">that<span class="_ _14"> </span>allows<span class="_ _16"> </span>“native”<span class="_ _16"> </span>C</span></span></div><div class="t m5 x28 h2b y259 ff7 fs1e fc2 sc0 ls0 ws0">and<span class="_ _11"> </span>C++<span class="_ _11"> </span>functions<span class="_ _11"> </span>to<span class="_ _11"> </span>be<span class="_ _11"> </span>called<span class="_ _11"> </span>from<span class="_ _11"> </span>J<span class="_ _3"></span>ava<span class="_ _11"> </span>programs<span class="_ _1"></span>.<span class="_ _11"> </span>The<span class="_"> </span>basic<span class="_ _11"> </span>idea<span class="_ _11"> </span>of<span class="_ _11"> </span>JNI<span class="_ _11"> </span>is<span class="_ _11"> </span>to<span class="_ _11"> </span>compile<span class="_ _11"> </span>the<span class="_ _11"> </span>native<span class="_ _11"> </span>C</div><div class="t m5 x28 h2b y25a ff7 fs1e fc2 sc0 ls0 ws0">function,<span class="_"> </span>say<span class="_ _7"></span>,<span class="_"> </span><span class="ffd">foo</span>,<span class="_"> </span>into<span class="_"> </span>a<span class="_ _13"> </span>shared<span class="_"> </span>library<span class="_ _7"></span>,<span class="_"> </span>say<span class="_ _3"></span>,<span class="_"> </span><span class="ffd">foo.so</span>.<span class="_"> </span>W<span class="_ _1"></span>hen<span class="_"> </span>a<span class="_"> </span>running<span class="_"> </span>J<span class="_ _3"></span>ava<span class="_"> </span>program<span class="_ _13"> </span>attempts<span class="_"> </span>to<span class="_ _13"> </span>invoke</div><div class="t m5 x28 h2b y4e2 ff7 fs1e fc2 sc0 ls0 ws0">function<span class="_"> </span><span class="ffd">foo</span>,<span class="_ _10"> </span>the<span class="_ _10"> </span>J<span class="_ _1"></span>ava<span class="_"> </span>interpreter<span class="_ _10"> </span>uses<span class="_ _11"> </span>the<span class="_"> </span><span class="ffd">dlopen<span class="_ _10"> </span></span>interface<span class="_ _10"> </span>(or<span class="_ _10"> </span>something<span class="_ _11"> </span>like<span class="_"> </span>it)<span class="_"> </span>to<span class="_ _10"> </span>dynamically<span class="_ _11"> </span>link</div><div class="t m5 x28 h2b y4e3 ff7 fs1e fc2 sc0 ls0 ws0">and<span class="_"> </span>load<span class="_"> </span><span class="ffd">foo.so<span class="_ _10"> </span></span>and<span class="_"> </span>then<span class="_"> </span>call<span class="_"> </span><span class="ffd">foo</span>.</div><div class="t m5 x1d h3b y61bc fff fs24 fc6 sc0 ls0 ws0">7.12<span class="_ _17"> </span><span class="ffe fs18">Position-Independent<span class="_"> </span>Code<span class="_"> </span>(PIC)</span></div><div class="t m5 x1d h26 y61bd ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_"> </span>key<span class="_"> </span>purpose<span class="_"> </span>of<span class="_ _11"> </span>shared<span class="_"> </span>libraries<span class="_"> </span>is<span class="_"> </span>to<span class="_ _11"> </span>allow<span class="_"> </span>multiple<span class="_"> </span>running<span class="_"> </span>processes<span class="_ _11"> </span>to<span class="_"> </span>share</div><div class="t m5 x1d h26 y61be ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span>same<span class="_ _16"> </span>library<span class="_ _16"> </span>code<span class="_ _16"> </span>in<span class="_ _16"> </span>memory<span class="_ _16"> </span>and<span class="_ _16"> </span>thus<span class="_ _16"> </span>save<span class="_ _16"> </span>precious<span class="_ _16"> </span>memory<span class="_ _16"> </span>resources<span class="_ _3"></span>.<span class="_ _16"> </span>So</div><div class="t m5 x1d h26 y61bf ff7 fs19 fc1 sc0 ls0 ws0">how<span class="_ _6"> </span>can<span class="_ _6"> </span>multiple<span class="_ _13"> </span>processes<span class="_ _6"> </span>share<span class="_ _6"> </span>a<span class="_ _6"> </span>single<span class="_ _13"> </span>copy<span class="_ _6"> </span>of<span class="_ _6"> </span>a<span class="_ _6"> </span>program?<span class="_ _13"> </span>One<span class="_ _6"> </span>approach<span class="_ _6"> </span>would</div><div class="t m5 x1d h26 y61c0 ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_ _13"> </span>to<span class="_ _13"> </span>assign<span class="_"> </span>a<span class="_ _13"> </span>priori<span class="_ _13"> </span>a<span class="_ _13"> </span>dedicated<span class="_ _13"> </span>chunk<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>address<span class="_ _13"> </span>space<span class="_ _13"> </span>to<span class="_ _13"> </span>each<span class="_"> </span>shared<span class="_ _13"> </span>library<span class="_ _7"></span>,</div><div class="t m5 x1d h26 y61c1 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _15"> </span>then<span class="_ _21"> </span>require<span class="_ _15"> </span>the<span class="_ _21"> </span>loader<span class="_ _15"> </span>to<span class="_ _21"> </span>always<span class="_ _15"> </span>load<span class="_ _21"> </span>the<span class="_ _15"> </span>shared<span class="_ _21"> </span>library<span class="_ _15"> </span>at<span class="_ _21"> </span>that<span class="_ _15"> </span>address<span class="_ _0"></span>.</div><div class="t m5 x1d h26 y61c2 ff7 fs19 fc1 sc0 ls0 ws0">While<span class="_ _15"> </span>straightforward,<span class="_ _f"> </span>this<span class="_ _21"> </span>approach<span class="_ _15"> </span>creates<span class="_ _21"> </span>some<span class="_ _21"> </span>serious<span class="_ _21"> </span>problems<span class="_ _1"></span>.<span class="_ _21"> </span>It<span class="_ _21"> </span>would</div><div class="t m5 x1d h26 y61c3 ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_ _14"> </span>an<span class="_ _14"> </span>inefﬁcient<span class="_ _14"> </span>use<span class="_ _14"> </span>of<span class="_ _15"> </span>the<span class="_ _14"> </span>address<span class="_ _14"> </span>space<span class="_ _14"> </span>because<span class="_ _14"> </span>portions<span class="_ _15"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>space<span class="_ _14"> </span>would</div><div class="t m5 x1d h26 y61c4 ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_ _16"> </span>allocated<span class="_ _11"> </span>even<span class="_ _16"> </span>if<span class="_ _16"> </span>a<span class="_ _16"> </span>process<span class="_ _11"> </span>didn’t<span class="_ _16"> </span>use<span class="_ _16"> </span>the<span class="_ _11"> </span>library<span class="_ _3"></span>.<span class="_ _16"> </span>It<span class="_ _16"> </span>would<span class="_ _11"> </span>also<span class="_ _16"> </span>be<span class="_ _16"> </span>difﬁcult<span class="_ _16"> </span>to</div><div class="t m5 x1d h26 y61c5 ff7 fs19 fc1 sc0 ls0 ws0">manage<span class="_ _1"></span>.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_ _13"> </span>would<span class="_ _13"> </span>have<span class="_ _13"> </span>to<span class="_"> </span>ensure<span class="_ _13"> </span>that<span class="_ _13"> </span>none<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>chunks<span class="_ _13"> </span>overlapped.<span class="_ _13"> </span>Each<span class="_ _13"> </span>time</div><div class="t m5 x1d h26 y61c6 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_"> </span>library<span class="_ _11"> </span>was<span class="_ _11"> </span>modiﬁed,<span class="_ _11"> </span>we<span class="_ _11"> </span>would<span class="_ _11"> </span>have<span class="_ _11"> </span>to<span class="_ _11"> </span>make<span class="_ _11"> </span>sure<span class="_"> </span>that<span class="_ _11"> </span>it<span class="_ _11"> </span>still<span class="_ _11"> </span>ﬁt<span class="_ _11"> </span>in<span class="_ _11"> </span>its<span class="_ _11"> </span>assigned</div><div class="t m5 x1d h26 y61c7 ff7 fs19 fc1 sc0 ls0 ws0">chunk.<span class="_ _15"> </span>If<span class="_ _21"> </span>not,<span class="_ _f"> </span>then<span class="_ _21"> </span>we<span class="_ _15"> </span>would<span class="_ _21"> </span>have<span class="_ _21"> </span>to<span class="_ _15"> </span>ﬁnd<span class="_ _21"> </span>a<span class="_ _21"> </span>new<span class="_ _21"> </span>chunk.<span class="_ _15"> </span>And<span class="_ _21"> </span>if<span class="_ _21"> </span>we<span class="_ _15"> </span>created<span class="_ _21"> </span>a</div><div class="t m5 x1d h26 y61c8 ff7 fs19 fc1 sc0 ls0 ws0">new<span class="_ _14"> </span>library<span class="_ _3"></span>,<span class="_ _14"> </span>we<span class="_ _14"> </span>would<span class="_ _14"> </span>have<span class="_ _14"> </span>to<span class="_ _14"> </span>ﬁnd<span class="_ _14"> </span>room<span class="_ _16"> </span>for<span class="_ _14"> </span>it.<span class="_ _14"> </span>Over<span class="_ _14"> </span>time,<span class="_ _14"> </span>given<span class="_ _14"> </span>the<span class="_ _16"> </span>hundreds</div><div class="t m5 x1d h26 y61c9 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _11"> </span>libraries<span class="_ _11"> </span>and<span class="_ _11"> </span>versions<span class="_"> </span>of<span class="_ _11"> </span>libraries<span class="_ _11"> </span>in<span class="_ _11"> </span>a<span class="_ _11"> </span>system,<span class="_ _16"> </span>it<span class="_"> </span>would<span class="_ _11"> </span>be<span class="_ _11"> </span>difﬁcult<span class="_ _11"> </span>to<span class="_ _11"> </span>keep<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y61ca ff7 fs19 fc1 sc0 ls0 ws0">address<span class="_ _6"> </span>space<span class="_ _13"> </span>from<span class="_ _6"> </span>fragmenting<span class="_ _13"> </span>into<span class="_ _6"> </span>lots<span class="_ _13"> </span>of<span class="_ _6"> </span>small<span class="_ _13"> </span>unused<span class="_ _6"> </span>but<span class="_ _13"> </span>unusable<span class="_ _6"> </span>holes<span class="_ _1"></span>.<span class="_ _13"> </span>Even</div><div class="t m5 x1d h26 y61cb ff7 fs19 fc1 sc0 ls0 ws0">worse<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>assignment<span class="_"> </span>of<span class="_"> </span>libraries<span class="_ _13"> </span>to<span class="_"> </span>memory<span class="_"> </span>would<span class="_"> </span>be<span class="_"> </span>different<span class="_ _13"> </span>for<span class="_"> </span>each<span class="_"> </span>system,</div><div class="t m5 x1d h26 y61cc ff7 fs19 fc1 sc0 ls0 ws0">thus<span class="_"> </span>creating<span class="_"> </span>even<span class="_"> </span>more<span class="_"> </span>management<span class="_"> </span>headaches<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y61cd ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _e"> </span>avoid<span class="_ _f"> </span>these<span class="_ _f"> </span>problems<span class="_ _1"></span>,<span class="_ _1f"> </span>modern<span class="_ _f"> </span>systems<span class="_ _e"> </span>compile<span class="_ _21"> </span>the<span class="_ _e"> </span>code<span class="_ _f"> </span>segments<span class="_ _f"> </span>of</div><div class="t m5 x1d h26 y61ce ff7 fs19 fc1 sc0 ls0 ws0">shared<span class="_ _13"> </span>modules<span class="_ _6"> </span>so<span class="_ _13"> </span>that<span class="_ _13"> </span>they<span class="_ _6"> </span>can<span class="_ _13"> </span>be<span class="_ _13"> </span>loaded<span class="_ _13"> </span>anywhere<span class="_ _6"> </span>in<span class="_ _13"> </span>memory<span class="_ _13"> </span>without<span class="_ _6"> </span>having<span class="_ _13"> </span>to</div><div class="t m5 x1d h26 y61cf ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_"> </span>modiﬁed<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>linker<span class="_ _1"></span>.<span class="_"> </span>W<span class="_ _0"></span>ith<span class="_"> </span>this<span class="_"> </span>approach,<span class="_"> </span>a<span class="_"> </span>single<span class="_ _13"> </span>copy<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>shared<span class="_"> </span>module’s</div><div class="t m5 x1d h26 y61d0 ff7 fs19 fc1 sc0 ls0 ws0">code<span class="_ _6"> </span>segment<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _6"> </span>shared<span class="_ _13"> </span>by<span class="_ _6"> </span>an<span class="_ _13"> </span>unlimited<span class="_ _6"> </span>number<span class="_ _6"> </span>of<span class="_ _13"> </span>processes<span class="_ _3"></span>.<span class="_ _13"> </span>(Of<span class="_ _6"> </span>course<span class="_ _0"></span>,<span class="_ _13"> </span>each</div><div class="t m5 x1d h26 y61d1 ff7 fs19 fc1 sc0 ls0 ws0">process<span class="_"> </span>will<span class="_"> </span>still<span class="_"> </span>get<span class="_"> </span>its<span class="_"> </span>own<span class="_"> </span>copy<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>read/write<span class="_"> </span>data<span class="_"> </span>segment.)</div><div class="t m5 x29 h26 y61d2 ff7 fs19 fc1 sc0 ls0 ws0">Code<span class="_ _6"> </span>that<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _13"> </span>loaded<span class="_ _6"> </span>without<span class="_ _6"> </span>needing<span class="_ _13"> </span>any<span class="_ _6"> </span>relocations<span class="_ _13"> </span>is<span class="_ _a"> </span>known<span class="_ _13"> </span>as<span class="_ _6"> </span><span class="ffa">position-</span></div><div class="t m5 x1d h26 y61d3 ffa fs19 fc1 sc0 ls0 ws0">independent<span class="_"> </span>code<span class="_"> </span>(PIC)<span class="_ _3"></span><span class="ff7">.<span class="_"> </span>Users<span class="_"> </span>direct<span class="_"> </span>GNU<span class="_"> </span>compilation<span class="_"> </span>systems<span class="_"> </span>to<span class="_"> </span>generate<span class="_"> </span>PIC</span></div><div class="t m5 x1d h26 y61d4 ff7 fs19 fc1 sc0 ls0 ws0">code<span class="_ _13"> </span>with<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">-fpic<span class="_ _13"> </span></span>option<span class="_ _13"> </span>to<span class="_ _13"> </span><span class="ff9">gcc</span>.<span class="_"> </span>Shared<span class="_ _13"> </span>libraries<span class="_ _13"> </span>must<span class="_ _13"> </span>always<span class="_"> </span>be<span class="_ _13"> </span>compiled<span class="_ _13"> </span>with</div><div class="t m5 x1d h26 y61d5 ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>option.</div><div class="t m5 x29 h26 y61d6 ff7 fs19 fc1 sc0 ls0 ws0">On<span class="_ _13"> </span>x86-64<span class="_ _13"> </span>systems<span class="_ _1"></span>,<span class="_"> </span>references<span class="_ _13"> </span>to<span class="_ _13"> </span>symbols<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>same<span class="_ _13"> </span>executable<span class="_ _13"> </span>object<span class="_ _13"> </span>mod-</div><div class="t m5 x1d h26 y61d7 ff7 fs19 fc1 sc0 ls0 ws0">ule<span class="_ _6"> </span>require<span class="_ _13"> </span>no<span class="_ _a"> </span>special<span class="_ _13"> </span>treatment<span class="_ _6"> </span>to<span class="_ _6"> </span>be<span class="_ _13"> </span>PIC<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>hese<span class="_ _6"> </span>references<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _6"> </span>compiled<span class="_ _13"> </span>using</div><div class="t m5 x1d h26 y61d8 ff7 fs19 fc1 sc0 ls0 ws0">PC-relative<span class="_ _13"> </span>addressing<span class="_"> </span>and<span class="_ _13"> </span>relocated<span class="_"> </span>by<span class="_ _13"> </span>the<span class="_"> </span>static<span class="_ _13"> </span>linker<span class="_"> </span>when<span class="_ _13"> </span>it<span class="_"> </span>builds<span class="_ _13"> </span>the<span class="_"> </span>object</div><div class="t m5 x1d h26 y61d9 ff7 fs19 fc1 sc0 ls0 ws0">ﬁle<span class="_ _1"></span>.<span class="_"> </span>However,<span class="_ _13"> </span>references<span class="_"> </span>to<span class="_"> </span>external<span class="_ _13"> </span>procedures<span class="_"> </span>and<span class="_"> </span>global<span class="_ _13"> </span>variables<span class="_"> </span>that<span class="_"> </span>are<span class="_ _13"> </span>de-</div><div class="t m5 x1d h26 y61da ff7 fs19 fc1 sc0 ls0 ws0">ﬁned<span class="_ _13"> </span>by<span class="_ _13"> </span>shared<span class="_ _13"> </span>modules<span class="_ _13"> </span>require<span class="_ _13"> </span>some<span class="_ _13"> </span>special<span class="_ _13"> </span>techniques<span class="_ _1"></span>,<span class="_"> </span>which<span class="_ _13"> </span>we<span class="_ _13"> </span>describe<span class="_ _13"> </span>next.</div><div class="t m5 x1d h42 y1a57 ff6 fs29 fc6 sc0 ls0 ws0">PIC<span class="_ _11"> </span>Data<span class="_ _16"> </span>References</div><div class="t m5 x1d h26 y15bf ff7 fs19 fc1 sc0 ls0 ws0">Compilers<span class="_ _13"> </span>generate<span class="_ _13"> </span>PIC<span class="_ _13"> </span>references<span class="_ _13"> </span>to<span class="_ _13"> </span>global<span class="_ _13"> </span>variables<span class="_ _13"> </span>by<span class="_ _13"> </span>exploiting<span class="_ _13"> </span>the<span class="_ _13"> </span>following</div><div class="t m5 x1d h26 y15c0 ff7 fs19 fc1 sc0 ls0 ws0">interesting<span class="_ _15"> </span>fact:<span class="_ _21"> </span>no<span class="_ _15"> </span>matter<span class="_ _21"> </span>where<span class="_ _15"> </span>we<span class="_ _21"> </span>load<span class="_ _15"> </span>an<span class="_ _21"> </span>object<span class="_ _15"> </span>module<span class="_ _21"> </span>(including<span class="_ _15"> </span>shared</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
