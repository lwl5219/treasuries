<div id="pf3e2" class="pf w2 h11" data-page-no="3e2"><div class="pc pc3e2 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3e2.png"/><div class="t m5 x23d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>11.6<span class="_ _60"> </span>Putting<span class="_ _10"> </span>It<span class="_ _10"> </span>T<span class="_ _1"></span>ogether:<span class="_ _10"> </span>The<span class="_ _10"> </span><span class="ff1b ls2e5">Ti<span class="_ _2"></span>n<span class="_ _5"> </span>y<span class="_ _16"> </span></span>W<span class="_ _1"></span>eb<span class="_ _10"> </span>Server<span class="_ _3e"> </span><span class="ffe fs1e">993</span></div><div class="t m5 x212 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _1f"> </span>tiny.c<span class="_ _e"> </span>-<span class="_ _1f"> </span>A<span class="_ _1f"> </span>simple,<span class="_ _e"> </span>iterative<span class="_ _1f"> </span>HTTP/1.0<span class="_ _e"> </span>Web<span class="_ _1f"> </span>server<span class="_ _1f"> </span>that<span class="_ _e"> </span>uses<span class="_ _1f"> </span>the</span></div><div class="t m5 x2c h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _8c"> </span>GET<span class="_ _1f"> </span>method<span class="_ _e"> </span>to<span class="_ _1f"> </span>serve<span class="_ _1f"> </span>static<span class="_ _e"> </span>and<span class="_ _1f"> </span>dynamic<span class="_ _e"> </span>content</span></div><div class="t m5 x2c h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _73"> </span><span class="ffd fs1e fc2">*/</span></div><div class="t m5 x2c h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h2e y286 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2c h2e y6298 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x2d h2d y287 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>doit(int<span class="_ _1f"> </span>fd);</div><div class="t m5 x2c h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>read_requesthdrs(rio_t<span class="_ _e"> </span>*rp);</span></div><div class="t m5 x2c h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>parse_uri(char<span class="_ _e"> </span>*uri,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*filename,<span class="_ _e"> </span>char<span class="_ _1f"> </span>*cgiargs);</span></div><div class="t m5 x17 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>serve_static(int<span class="_ _e"> </span>fd,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*filename,<span class="_ _e"> </span>int<span class="_ _1f"> </span>filesize);</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>get_filetype(char<span class="_ _e"> </span>*filename,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*filetype);</span></div><div class="t m5 x17 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>serve_dynamic(int<span class="_ _e"> </span>fd,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*filename,<span class="_ _e"> </span>char<span class="_ _1f"> </span>*cgiargs);</span></div><div class="t m5 x17 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>clienterror(int<span class="_ _e"> </span>fd,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*cause,<span class="_ _e"> </span>char<span class="_ _1f"> </span>*errnum,</span></div><div class="t m5 x17 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _17b"> </span><span class="ffd fs1e fc2">char<span class="_ _1f"> </span>*shortmsg,<span class="_ _1f"> </span>char<span class="_ _e"> </span>*longmsg);</span></div><div class="t m5 x17 h2e y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x17 h2e y6a28 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x2d h2d y417 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _1f"> </span>argc,<span class="_ _1f"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>listenfd,<span class="_ _1f"> </span>connfd;</span></div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>hostname[MAXLINE],<span class="_ _1f"> </span>port[MAXLINE];</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">socklen_t<span class="_ _e"> </span>clientlen;</span></div><div class="t m5 x17 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x142 h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">struct<span class="_ _e"> </span>sockaddr_storage<span class="_ _1f"> </span>clientaddr;</div><div class="t m5 x17 h2e y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x17 h2e y4aa2 ff6 fs20 fc6 sc0 ls0 ws0">23</div><div class="t m5 x142 h2d y3228 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Check<span class="_ _1f"> </span>command-line<span class="_ _1f"> </span>args<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(argc<span class="_ _1f"> </span>!=<span class="_ _1f"> </span>2)<span class="_ _e"> </span>{</span></div><div class="t m5 x17 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 xc5 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">fprintf(stderr,<span class="_ _e"> </span>&quot;usage:<span class="_ _1f"> </span>%s<span class="_ _1f"> </span>&lt;port&gt;\n&quot;,<span class="_ _e"> </span>argv[0]);</div><div class="t m5 x17 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _70"> </span><span class="ffd fs1e fc2">exit(1);</span></div><div class="t m5 x17 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y322c ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x17 h2e y61ba ff6 fs20 fc6 sc0 ls0 ws0">29</div><div class="t m5 x142 h2d y441 ffd fs1e fc2 sc0 ls0 ws0">listenfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>Open_listenfd(argv[1]);</div><div class="t m5 x17 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _20"> </span><span class="ffd fs1e fc2">while<span class="_ _e"> </span>(1)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _70"> </span><span class="ffd fs1e fc2">clientlen<span class="_ _e"> </span>=<span class="_ _1f"> </span>sizeof(clientaddr);</span></div><div class="t m5 x17 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _70"> </span><span class="ffd fs1e fc2">connfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>Accept(listenfd,<span class="_ _1f"> </span>(SA<span class="_ _e"> </span>*)&amp;clientaddr,<span class="_ _1f"> </span>&amp;clientlen);</span></div><div class="t m5 x17 h2d y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _70"> </span><span class="ffd fs1e fc2">Getnameinfo((SA<span class="_ _e"> </span>*)<span class="_ _1f"> </span>&amp;clientaddr,<span class="_ _1f"> </span>clientlen,<span class="_ _e"> </span>hostname,<span class="_ _1f"> </span>MAXLINE,</span></div><div class="t m5 x17 h2d y5fd ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _15e"> </span><span class="ffd fs1e fc2">port,<span class="_ _e"> </span>MAXLINE,<span class="_ _1f"> </span>0);</span></div><div class="t m5 x17 h2d y4aa5 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _70"> </span><span class="ffd fs1e fc2">printf(&quot;Accepted<span class="_ _e"> </span>connection<span class="_ _1f"> </span>from<span class="_ _1f"> </span>(%s,<span class="_ _e"> </span>%s)\n&quot;,<span class="_ _1f"> </span>hostname,<span class="_ _e"> </span>port);</span></div><div class="t m5 x17 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 xc5 h2d y74d ffd fs1e fc2 sc0 ls0 ws0">doit(connfd);</div><div class="t m5 x17 h2d y277 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _70"> </span><span class="ffd fs1e fc2">Close(connfd);</span></div><div class="t m5 x17 h2d y2269 ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y226b ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x212 h2c y4aa6 ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y4aa7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>11.29<span class="_ _66"> </span><span class="fc1">The<span class="_"> </span><span class="ff1b ls2e6">Ti<span class="_ _5"></span>n<span class="_ _5"></span>y<span class="_ _16"> </span></span>W<span class="_ _0"></span>eb<span class="_"> </span>server<span class="_ _1"></span>.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
