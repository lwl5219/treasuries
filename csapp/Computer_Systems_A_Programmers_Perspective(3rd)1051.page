<div id="pf41b" class="pf w2 h11" data-page-no="41b"><div class="pc pc41b w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg41b.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1050<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1d h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">threads<span class="_"> </span>to<span class="_"> </span>work<span class="_"> </span>on<span class="_"> </span>its<span class="_"> </span>own<span class="_"> </span>region.<span class="_ _13"> </span>F<span class="_ _1"></span>or<span class="_"> </span>simplicity<span class="_ _3"></span>,<span class="_"> </span>assume<span class="_"> </span>that<span class="_"> </span><span class="ff11">n<span class="_ _10"> </span></span>is<span class="_"> </span>a<span class="_"> </span>multiple<span class="_"> </span>of<span class="_"> </span><span class="ff11">t<span class="_ _5"></span></span>,</div><div class="t m5 x1d h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">such<span class="_ _11"> </span>that<span class="_ _11"> </span>each<span class="_ _16"> </span>region<span class="_ _11"> </span>has<span class="_ _11"> </span><span class="ff11">n/<span class="_ _5"></span>t<span class="_ _15"> </span></span>elements<span class="_ _1"></span>.<span class="_ _11"> </span>Let’s<span class="_ _11"> </span>look<span class="_ _11"> </span>at<span class="_ _16"> </span>some<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>different<span class="_"> </span>ways</div><div class="t m5 x1d h26 y40a ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_"> </span>multiple<span class="_"> </span>threads<span class="_"> </span>might<span class="_"> </span>work<span class="_"> </span>on<span class="_"> </span>their<span class="_"> </span>assigned<span class="_"> </span>regions<span class="_"> </span>in<span class="_"> </span>parallel.</div><div class="t m5 x29 h26 y40b ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>simplest<span class="_"> </span>and<span class="_ _13"> </span>most<span class="_"> </span>straightforward<span class="_ _13"> </span>option<span class="_"> </span>is<span class="_"> </span>to<span class="_ _13"> </span>have<span class="_"> </span>the<span class="_ _13"> </span>threads<span class="_"> </span>sum<span class="_"> </span>into</div><div class="t m5 x1d h26 y40c ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>shared<span class="_"> </span>global<span class="_"> </span>variable<span class="_"> </span>that<span class="_"> </span>is<span class="_"> </span>protected<span class="_ _13"> </span>by<span class="_"> </span>a<span class="_"> </span>mutex.<span class="_"> </span>F<span class="_ _0"></span>igure<span class="_"> </span>12.31<span class="_"> </span>shows<span class="_"> </span>how<span class="_"> </span>we</div><div class="t m5 x1d h26 y40d ff7 fs19 fc2 sc0 ls0 ws0">might<span class="_ _14"> </span>implement<span class="_ _14"> </span>this<span class="_ _1"></span>.<span class="_ _14"> </span>In<span class="_ _14"> </span>lines<span class="_ _14"> </span>28–33,<span class="_ _15"> </span>the<span class="_ _14"> </span>main<span class="_ _14"> </span>thread<span class="_ _14"> </span>creates<span class="_ _14"> </span>the<span class="_ _14"> </span>peer<span class="_ _14"> </span>threads</div><div class="t m5 x1d h26 y40e ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>then<span class="_ _11"> </span>waits<span class="_"> </span>for<span class="_ _11"> </span>them<span class="_"> </span>to<span class="_ _11"> </span>terminate<span class="_ _0"></span>.<span class="_"> </span>Notice<span class="_"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>main<span class="_"> </span>thread<span class="_ _11"> </span>passes<span class="_"> </span>a<span class="_ _11"> </span>small</div><div class="t m5 x1d h26 y40f ff7 fs19 fc2 sc0 ls0 ws0">integer<span class="_ _11"> </span>to<span class="_ _16"> </span>each<span class="_ _11"> </span>peer<span class="_ _11"> </span>thread<span class="_ _16"> </span>that<span class="_ _11"> </span>serves<span class="_ _11"> </span>as<span class="_ _16"> </span>a<span class="_ _11"> </span>unique<span class="_ _11"> </span>thread<span class="_ _16"> </span>ID<span class="_ _3"></span>.<span class="_ _11"> </span>Each<span class="_ _16"> </span>peer<span class="_ _11"> </span>thread</div><div class="t m5 x1d h26 y410 ff7 fs19 fc2 sc0 ls0 ws0">will<span class="_"> </span>use<span class="_"> </span>its<span class="_ _11"> </span>thread<span class="_"> </span>ID<span class="_"> </span>to<span class="_ _11"> </span>determine<span class="_"> </span>which<span class="_"> </span>portion<span class="_ _11"> </span>of<span class="_"> </span>the<span class="_"> </span>sequence<span class="_ _11"> </span>it<span class="_"> </span>should<span class="_"> </span>work</div><div class="t m5 x1d h26 y411 ff7 fs19 fc2 sc0 ls0 ws0">on.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>idea<span class="_"> </span>of<span class="_ _11"> </span>passing<span class="_"> </span>a<span class="_"> </span>small<span class="_"> </span>unique<span class="_"> </span>thread<span class="_"> </span>ID<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>peer<span class="_"> </span>threads<span class="_"> </span>is<span class="_"> </span>a<span class="_"> </span>general</div><div class="t m5 x1d h26 y412 ff7 fs19 fc2 sc0 ls0 ws0">technique<span class="_"> </span>that<span class="_ _11"> </span>is<span class="_"> </span>used<span class="_ _11"> </span>in<span class="_ _11"> </span>many<span class="_"> </span>parallel<span class="_ _11"> </span>applications<span class="_ _1"></span>.<span class="_ _11"> </span>After<span class="_"> </span>the<span class="_ _11"> </span>peer<span class="_ _11"> </span>threads<span class="_"> </span>have</div><div class="t m5 x1d h26 y413 ff7 fs19 fc2 sc0 ls0 ws0">terminated,<span class="_ _13"> </span>the<span class="_"> </span>global<span class="_ _13"> </span>variable<span class="_ _13"> </span><span class="ffd">gsum<span class="_ _13"> </span></span>contains<span class="_"> </span>the<span class="_ _13"> </span>ﬁnal<span class="_ _13"> </span>sum.<span class="_"> </span>T<span class="_ _3"></span>he<span class="_"> </span>main<span class="_ _13"> </span>thread<span class="_ _13"> </span>then</div><div class="t m5 x1d h26 y414 ff7 fs19 fc2 sc0 ls0 ws0">uses<span class="_"> </span>the<span class="_"> </span>closed-form<span class="_"> </span>solution<span class="_"> </span>to<span class="_"> </span>verify<span class="_"> </span>the<span class="_"> </span>result<span class="_"> </span>(lines<span class="_"> </span>36–37).</div><div class="t m5 x29 h26 y415 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>12.32<span class="_"> </span>shows<span class="_"> </span>the<span class="_"> </span>function<span class="_"> </span>that<span class="_"> </span>each<span class="_"> </span>peer<span class="_"> </span>thread<span class="_"> </span>executes<span class="_ _1"></span>.<span class="_"> </span>In<span class="_"> </span>line<span class="_"> </span>4,<span class="_"> </span>the</div><div class="t m5 x1d h26 y416 ff7 fs19 fc2 sc0 ls0 ws0">thread<span class="_"> </span>extracts<span class="_"> </span>the<span class="_"> </span>thread<span class="_"> </span>ID<span class="_"> </span>from<span class="_ _11"> </span>the<span class="_"> </span>thread<span class="_"> </span>argument<span class="_"> </span>and<span class="_"> </span>then<span class="_ _11"> </span>uses<span class="_"> </span>this<span class="_"> </span>ID<span class="_"> </span>to</div><div class="t m5 x1d h26 y434 ff7 fs19 fc2 sc0 ls0 ws0">determine<span class="_"> </span>the<span class="_"> </span>region<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>sequence<span class="_"> </span>it<span class="_ _13"> </span>should<span class="_"> </span>work<span class="_"> </span>on<span class="_"> </span>(lines<span class="_"> </span>5–6).<span class="_ _13"> </span>In<span class="_"> </span>lines<span class="_"> </span>9–13,</div><div class="t m5 x1d h26 y435 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>thread<span class="_ _16"> </span>iterates<span class="_ _14"> </span>over<span class="_ _16"> </span>its<span class="_ _16"> </span>portion<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _16"> </span>sequence,<span class="_ _16"> </span>updating<span class="_ _16"> </span>the<span class="_ _16"> </span>shared<span class="_ _14"> </span>global</div><div class="t m5 x1d h26 y436 ff7 fs19 fc2 sc0 ls0 ws0">variable<span class="_ _13"> </span><span class="ffd">gsum<span class="_ _10"> </span></span>on<span class="_ _13"> </span>each<span class="_"> </span>iteration.<span class="_ _13"> </span>Notice<span class="_"> </span>that<span class="_ _13"> </span>we<span class="_"> </span>are<span class="_ _13"> </span>careful<span class="_"> </span>to<span class="_ _13"> </span>protect<span class="_ _13"> </span>each<span class="_"> </span>update</div><div class="t m5 x1d h26 y437 ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_"> </span><span class="ff11">P<span class="_ _21"> </span></span>and<span class="_"> </span><span class="ff11">V<span class="_ _f"> </span></span>mutex<span class="_"> </span>operations<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y438 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_"> </span>we<span class="_"> </span>run<span class="_ _11"> </span><span class="ffd">psum-mutex<span class="_ _11"> </span></span>on<span class="_"> </span>a<span class="_ _11"> </span>system<span class="_ _11"> </span>with<span class="_ _11"> </span>four<span class="_"> </span>cores<span class="_ _11"> </span>on<span class="_ _11"> </span>a<span class="_"> </span>sequence<span class="_ _11"> </span>of<span class="_ _11"> </span>size</div><div class="t m5 x1d h46 y82f9 ff11 fs19 fc2 sc0 ls0 ws0">n<span class="_ _13"> </span><span class="ff12">=<span class="_ _10"> </span><span class="ff7">2</span></span></div><div class="t m5 x22c h3c y82fa ff7 fs25 fc2 sc0 ls0 ws0">31</div><div class="t m5 x203 h26 y82fb ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>measure<span class="_"> </span>its<span class="_"> </span>running<span class="_ _11"> </span>time<span class="_"> </span>(in<span class="_"> </span>seconds)<span class="_ _11"> </span>as<span class="_"> </span>a<span class="_"> </span>function<span class="_ _11"> </span>of<span class="_"> </span>the<span class="_"> </span>number<span class="_"> </span>of</div><div class="t m5 x1d h26 y82fc ff7 fs19 fc2 sc0 ls0 ws0">threads<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>get<span class="_"> </span>a<span class="_"> </span>nasty<span class="_"> </span>surprise:</div><div class="t m5 x1eb h31 y82fd ff7 fs21 fc2 sc0 ls0 ws0">Number<span class="_"> </span>of<span class="_"> </span>threads</div><div class="t m5 x1d h31 y82fe ff7 fs21 fc2 sc0 ls0 ws0">V<span class="_ _3"></span>ersion<span class="_ _1b3"> </span>1<span class="_ _8c"> </span>2<span class="_ _5c"> </span>4<span class="_ _5c"> </span>8<span class="_ _8c"> </span>16</div><div class="t m5 x1d h31 y82ff ffd fs1e fc2 sc0 ls0 ws0">psum-mutex<span class="_ _26"> </span><span class="ff7 fs21">68<span class="_ _26"> </span>432<span class="_ _26"> </span>719<span class="_ _26"> </span>552<span class="_ _26"> </span>599</span></div><div class="t m5 x1d h26 y6bc7 ff7 fs19 fc2 sc0 ls0 ws0">Not<span class="_ _21"> </span>only<span class="_ _21"> </span>is<span class="_ _21"> </span>the<span class="_ _21"> </span>program<span class="_ _21"> </span>extremely<span class="_ _21"> </span>slow<span class="_ _21"> </span>when<span class="_ _f"> </span>it<span class="_ _21"> </span>runs<span class="_ _21"> </span>sequentially<span class="_ _21"> </span>as<span class="_ _21"> </span>a<span class="_ _21"> </span>single</div><div class="t m5 x1d h26 y8300 ff7 fs19 fc2 sc0 ls0 ws0">thread,<span class="_ _e"> </span>it<span class="_ _f"> </span>is<span class="_ _f"> </span>nearly<span class="_ _f"> </span>an<span class="_ _e"> </span>order<span class="_ _21"> </span>of<span class="_ _f"> </span>magnitude<span class="_ _e"> </span>slower<span class="_ _21"> </span>when<span class="_ _f"> </span>it<span class="_ _f"> </span>runs<span class="_ _e"> </span>in<span class="_ _21"> </span>parallel<span class="_ _f"> </span>as</div><div class="t m5 x1d h26 y8301 ff7 fs19 fc2 sc0 ls0 ws0">multiple<span class="_ _14"> </span>threads<span class="_ _0"></span>.<span class="_ _14"> </span>And<span class="_ _15"> </span>the<span class="_ _15"> </span>performance<span class="_ _15"> </span>gets<span class="_ _15"> </span>worse<span class="_ _15"> </span>as<span class="_ _15"> </span>we<span class="_ _14"> </span>add<span class="_ _15"> </span>more<span class="_ _15"> </span>cores<span class="_ _1"></span>.<span class="_ _15"> </span>T<span class="_ _0"></span>he</div><div class="t m5 x1d h26 y8302 ff7 fs19 fc2 sc0 ls0 ws0">reason<span class="_ _13"> </span>for<span class="_ _6"> </span>this<span class="_ _13"> </span>poor<span class="_ _13"> </span>performance<span class="_ _6"> </span>is<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_ _13"> </span>synchronization<span class="_ _6"> </span>operations<span class="_ _13"> </span>(<span class="ff11">P<span class="_"> </span></span>and<span class="_ _13"> </span><span class="ff11">V<span class="_ _6"> </span></span>)</div><div class="t m5 x1d h26 y8303 ff7 fs19 fc2 sc0 ls0 ws0">are<span class="_"> </span>very<span class="_"> </span>expensive<span class="_"> </span>relative<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>cost<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>single<span class="_"> </span>memory<span class="_"> </span>update<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>highlights</div><div class="t m5 x1d h26 y450f ff7 fs19 fc2 sc0 ls0 ws0">an<span class="_ _15"> </span>important<span class="_ _21"> </span>lesson<span class="_ _21"> </span>about<span class="_ _21"> </span>parallel<span class="_ _21"> </span>programming:<span class="_ _21"> </span><span class="ffa">Synchronization<span class="_ _15"> </span>overhead<span class="_ _21"> </span>is</span></div><div class="t m5 x1d h30 y4510 ffa fs19 fc2 sc0 ls0 ws0">expensive<span class="_"> </span>and<span class="_ _11"> </span>should<span class="_ _11"> </span>be<span class="_"> </span>avoided<span class="_ _11"> </span>if<span class="_ _11"> </span>possible.<span class="_"> </span>If<span class="_"> </span>it<span class="_ _11"> </span>cannot<span class="_ _11"> </span>be<span class="_ _11"> </span>avoided,<span class="_"> </span>the<span class="_ _11"> </span>overhead</div><div class="t m5 x1d h30 y4511 ffa fs19 fc2 sc0 ls0 ws0">should<span class="_"> </span>be<span class="_"> </span>amortized<span class="_"> </span>b<span class="_ _1"></span>y<span class="_"> </span>as<span class="_"> </span>much<span class="_"> </span>useful<span class="_"> </span>computation<span class="_"> </span>as<span class="_"> </span>possible.</div><div class="t m5 x29 h26 y4512 ff7 fs19 fc2 sc0 ls0 ws0">One<span class="_ _16"> </span>way<span class="_ _16"> </span>to<span class="_ _16"> </span>avoid<span class="_ _14"> </span>synchronization<span class="_ _16"> </span>in<span class="_ _16"> </span>our<span class="_ _14"> </span>example<span class="_ _16"> </span>program<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _14"> </span>have<span class="_ _16"> </span>each</div><div class="t m5 x1d h26 y4513 ff7 fs19 fc2 sc0 ls0 ws0">peer<span class="_ _11"> </span>thread<span class="_ _16"> </span>compute<span class="_ _11"> </span>its<span class="_ _16"> </span>partial<span class="_ _11"> </span>sum<span class="_ _16"> </span>in<span class="_ _11"> </span>a<span class="_ _16"> </span>private<span class="_ _11"> </span>variable<span class="_ _16"> </span>that<span class="_ _11"> </span>is<span class="_ _16"> </span>not<span class="_ _11"> </span>shared<span class="_ _16"> </span>with</div><div class="t m5 x1d h26 y4514 ff7 fs19 fc2 sc0 ls0 ws0">any<span class="_"> </span>other<span class="_"> </span>thread,<span class="_"> </span>as<span class="_"> </span>shown<span class="_"> </span>in<span class="_"> </span>Figure<span class="_"> </span>12.33.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>main<span class="_"> </span>thread<span class="_"> </span>(not<span class="_"> </span>shown)<span class="_"> </span>deﬁnes</div><div class="t m5 x1d h26 y4515 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _11"> </span>global<span class="_ _11"> </span>array<span class="_ _11"> </span>called<span class="_ _11"> </span><span class="ffd">psum</span>,<span class="_ _11"> </span>and<span class="_ _11"> </span>each<span class="_ _11"> </span>peer<span class="_ _16"> </span>thread<span class="_"> </span><span class="ff11">i<span class="_"> </span></span>accumulates<span class="_ _11"> </span>its<span class="_ _16"> </span>partial<span class="_"> </span>sum<span class="_ _11"> </span>in</div><div class="t m5 x1d h26 y4516 ffd fs19 fc2 sc0 ls0 ws0">psum[i]<span class="ff7">.<span class="_ _13"> </span>Since<span class="_"> </span>we<span class="_ _13"> </span>are<span class="_"> </span>careful<span class="_ _13"> </span>to<span class="_"> </span>give<span class="_ _13"> </span>each<span class="_ _13"> </span>peer<span class="_"> </span>thread<span class="_ _13"> </span>a<span class="_"> </span>unique<span class="_ _13"> </span>memory<span class="_ _13"> </span>location</span></div><div class="t m5 x1d h26 y4517 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _15"> </span>update<span class="_ _1"></span>,<span class="_ _21"> </span>it<span class="_ _15"> </span>is<span class="_ _15"> </span>not<span class="_ _15"> </span>necessary<span class="_ _15"> </span>to<span class="_ _15"> </span>protect<span class="_ _15"> </span>these<span class="_ _15"> </span>updates<span class="_ _15"> </span>with<span class="_ _15"> </span>mutexes<span class="_ _1"></span>.<span class="_ _15"> </span>T<span class="_ _1"></span>he<span class="_ _15"> </span>only</div><div class="t m5 x1d h26 y4518 ff7 fs19 fc2 sc0 ls0 ws0">necessary<span class="_ _13"> </span>synchronization<span class="_"> </span>is<span class="_ _13"> </span>that<span class="_"> </span>the<span class="_ _13"> </span>main<span class="_ _13"> </span>thread<span class="_"> </span>must<span class="_ _13"> </span>wait<span class="_ _13"> </span>for<span class="_"> </span>all<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>children</div><div class="t m5 x1d h26 y4519 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _16"> </span>ﬁnish.<span class="_ _16"> </span>After<span class="_ _14"> </span>the<span class="_ _16"> </span>peer<span class="_ _16"> </span>threads<span class="_ _16"> </span>have<span class="_ _14"> </span>terminated,<span class="_ _14"> </span>the<span class="_ _16"> </span>main<span class="_ _16"> </span>thread<span class="_ _14"> </span>sums<span class="_ _16"> </span>up<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y451a ff7 fs19 fc2 sc0 ls0 ws0">elements<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span><span class="ffd">psum<span class="_ _10"> </span></span>vector<span class="_"> </span>to<span class="_"> </span>arrive<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>ﬁnal<span class="_"> </span>result.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
