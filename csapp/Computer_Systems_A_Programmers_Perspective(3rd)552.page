<div id="pf228" class="pf w2 h11" data-page-no="228"><div class="pc pc228 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg228.png"/><div class="t m5 x86 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>5.6<span class="_ _60"> </span>Eliminating<span class="_ _10"> </span>Unneeded<span class="_ _10"> </span>Memory<span class="_ _10"> </span>References<span class="_ _3e"> </span><span class="ffe fs1e">551</span></div><div class="t m5 x2c h2d y4a2c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Accumulate<span class="_ _e"> </span>result<span class="_ _1f"> </span>in<span class="_ _1f"> </span>local<span class="_ _e"> </span>variable<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y4a2d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>combine4(vec_ptr<span class="_ _e"> </span>v,<span class="_ _1f"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x2c h2d y4a2e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y4a30 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>i;</span></div><div class="t m5 x2c h2d y4aaa ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>length<span class="_ _1f"> </span>=<span class="_ _1f"> </span>vec_length(v);</span></div><div class="t m5 x2c h2d y4aac ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>*data<span class="_ _1f"> </span>=<span class="_ _1f"> </span>get_vec_start(v);</span></div><div class="t m5 x2c h2d y4a33 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>acc<span class="_ _1f"> </span>=<span class="_ _1f"> </span>IDENT;</span></div><div class="t m5 x2c h2e y4a34 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x2c h2e y4b71 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x142 h2d y4aad ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>length;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</div><div class="t m5 x17 h2d y4a37 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">acc<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc<span class="_ _1f"> </span>OP<span class="_ _e"> </span>data[i];</span></div><div class="t m5 x17 h2d y4a38 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y4a39 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc;</span></div><div class="t m5 x17 h2d y4a3a ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h34 y4ad8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _6"> </span>5.10<span class="_ _c"> </span><span class="fc1">Accumulating<span class="_ _13"> </span>result<span class="_ _6"> </span>in<span class="_ _13"> </span>temporary<span class="_ _3"></span>.<span class="_ _13"> </span><span class="ff6">Holding<span class="_ _6"> </span>the<span class="_ _13"> </span>accumulated<span class="_ _6"> </span>value<span class="_ _13"> </span>in<span class="_ _6"> </span>local</span></span></div><div class="t m5 x17 h34 y4b72 ff6 fs16 fc1 sc0 ls0 ws0">variable</div><div class="t m5 xd1 h3a y4ada ffd fs19 fc1 sc0 ls0 ws0">acc<span class="_ _11"> </span><span class="ff6 fs16">(short<span class="_ _16"> </span>for<span class="_ _11"> </span>“accumulator”)<span class="_ _11"> </span>eliminates<span class="_ _16"> </span>the<span class="_ _11"> </span>need<span class="_ _11"> </span>to<span class="_ _16"> </span>retrieve<span class="_ _11"> </span>it<span class="_ _11"> </span>from<span class="_ _16"> </span>memory</span></div><div class="t m5 x17 h34 y4b73 ff6 fs16 fc1 sc0 ls0 ws0">and<span class="_ _10"> </span>write<span class="_ _11"> </span>back<span class="_ _10"> </span>the<span class="_ _10"> </span>updated<span class="_ _11"> </span>value<span class="_ _10"> </span>on<span class="_ _11"> </span>every<span class="_ _10"> </span>loop<span class="_ _11"> </span>iteration.</div><div class="t m5 x250 h31 y4b74 ff7 fs21 fc2 sc0 ls0 ws0">Integer<span class="_ _ba"> </span>Floating<span class="_"> </span>point</div><div class="t m5 x17 h31 y4b75 ff7 fs21 fc2 sc0 ls0 ws0">Function<span class="_ _76"> </span>Page<span class="_ _26"> </span>Method<span class="_ _14f"> </span><span class="ffd fs1e ls20c">+*+*</span></div><div class="t m5 x17 h31 y4b76 ffd fs1e fc2 sc0 ls0 ws0">combine3<span class="_ _73"> </span><span class="ff7 fs21">549<span class="_ _61"> </span>Direct<span class="_"> </span>data<span class="_"> </span>access<span class="_ _192"> </span>7.17<span class="_ _4f"> </span>9.02<span class="_ _14a"> </span>9.02<span class="_ _7b"> </span>11.03</span></div><div class="t m5 x17 h31 y4b77 ffd fs1e fc2 sc0 ls0 ws0">combine4<span class="_ _73"> </span><span class="ff7 fs21">551<span class="_ _61"> </span>Accumulate<span class="_"> </span>in<span class="_"> </span>temporary<span class="_ _74"> </span>1.27<span class="_ _14a"> </span>3.01<span class="_ _14a"> </span>3.01<span class="_ _14a"> </span>5.01</span></div><div class="t m5 x17 h46 y4b78 ff7 fs19 fc2 sc0 ls0 ws0">All<span class="_ _11"> </span>of<span class="_ _16"> </span>our<span class="_ _11"> </span>times<span class="_ _16"> </span>improve<span class="_ _11"> </span>by<span class="_ _16"> </span>factors<span class="_ _11"> </span>ranging<span class="_ _16"> </span>from<span class="_ _11"> </span>2.2<span class="ff12">×<span class="_ _16"> </span></span>to<span class="_ _11"> </span>5.7<span class="ff12">×</span>,<span class="_ _16"> </span>with<span class="_ _11"> </span>the<span class="_ _16"> </span>integer</div><div class="t m5 x17 h26 y4b79 ff7 fs19 fc2 sc0 ls0 ws0">addition<span class="_"> </span>case<span class="_"> </span>dropping<span class="_"> </span>to<span class="_"> </span>just<span class="_"> </span>1.27<span class="_"> </span>clock<span class="_"> </span>cycles<span class="_"> </span>per<span class="_"> </span>element.</div><div class="t m5 x26 h26 y4b7a ff7 fs19 fc2 sc0 ls0 ws0">Again,<span class="_ _13"> </span>one<span class="_"> </span>might<span class="_ _13"> </span>think<span class="_ _13"> </span>that<span class="_"> </span>a<span class="_ _13"> </span>compiler<span class="_ _13"> </span>should<span class="_ _13"> </span>be<span class="_"> </span>able<span class="_ _13"> </span>to<span class="_ _13"> </span>automatically<span class="_"> </span>trans-</div><div class="t m5 x17 h26 y4b7b ff7 fs19 fc2 sc0 ls0 ws0">form<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">combine3<span class="_ _13"> </span></span>code<span class="_ _13"> </span>shown<span class="_ _13"> </span>in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>5.9<span class="_"> </span>to<span class="_ _13"> </span>accumulate<span class="_ _13"> </span>the<span class="_ _13"> </span>value<span class="_"> </span>in<span class="_ _13"> </span>a<span class="_ _13"> </span>register,</div><div class="t m5 x17 h26 y4b7c ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_"> </span>it<span class="_"> </span>does<span class="_ _11"> </span>with<span class="_"> </span>the<span class="_ _11"> </span>code<span class="_"> </span>for<span class="_ _11"> </span><span class="ffd">combine4<span class="_ _10"> </span></span>shown<span class="_ _11"> </span>in<span class="_"> </span>Figure<span class="_"> </span>5.10.<span class="_"> </span>In<span class="_"> </span>fact,<span class="_"> </span>however,<span class="_"> </span>the</div><div class="t m5 x17 h26 y4b7d ff7 fs19 fc2 sc0 ls0 ws0">two<span class="_"> </span>functions<span class="_ _13"> </span>can<span class="_"> </span>have<span class="_"> </span>different<span class="_ _13"> </span>behaviors<span class="_"> </span>due<span class="_ _13"> </span>to<span class="_"> </span>memory<span class="_"> </span>aliasing<span class="_ _0"></span>.<span class="_"> </span>Consider<span class="_ _1"></span>,<span class="_"> </span>for</div><div class="t m5 x17 h26 y4b7e ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_"> </span>the<span class="_ _13"> </span>case<span class="_"> </span>of<span class="_ _13"> </span>integer<span class="_ _13"> </span>data<span class="_ _13"> </span>with<span class="_"> </span>multiplication<span class="_ _13"> </span>as<span class="_ _13"> </span>the<span class="_"> </span>operation<span class="_ _13"> </span>and<span class="_ _13"> </span>1<span class="_"> </span>as<span class="_ _13"> </span>the</div><div class="t m5 x17 h46 y4b7f ff7 fs19 fc2 sc0 ls0 ws0">identity<span class="_"> </span>element.<span class="_ _11"> </span>Let<span class="_ _11"> </span><span class="ffd">v<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"> </span></span></span>[2<span class="_ _2"></span><span class="ff11">,<span class="_ _13"> </span></span>3<span class="ff11">,<span class="_ _13"> </span></span>5]<span class="_"> </span>be<span class="_"> </span>a<span class="_"> </span>vector<span class="_ _11"> </span>of<span class="_ _11"> </span>three<span class="_ _11"> </span>elements<span class="_"> </span>and<span class="_ _11"> </span>consider<span class="_ _11"> </span>the</div><div class="t m5 x17 h26 y4b80 ff7 fs19 fc2 sc0 ls0 ws0">following<span class="_"> </span>two<span class="_"> </span>function<span class="_"> </span>calls:</div><div class="t m5 x1b6 h2d y4b81 ffd fs1e fc2 sc0 ls0 ws0">combine3(v,<span class="_ _e"> </span>get_vec_start(v)<span class="_ _1f"> </span>+<span class="_ _1f"> </span>2);</div><div class="t m5 x1b6 h2d y4b82 ffd fs1e fc2 sc0 ls0 ws0">combine4(v,<span class="_ _e"> </span>get_vec_start(v)<span class="_ _1f"> </span>+<span class="_ _1f"> </span>2);</div><div class="t m5 x17 h26 y4b83 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hat<span class="_"> </span>is<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>create<span class="_ _13"> </span>an<span class="_"> </span>alias<span class="_"> </span>between<span class="_ _13"> </span>the<span class="_"> </span>last<span class="_"> </span>element<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>vector<span class="_"> </span>and<span class="_ _13"> </span>the<span class="_"> </span>destina-</div><div class="t m5 x17 h26 y4b84 ff7 fs19 fc2 sc0 ls0 ws0">tion<span class="_"> </span>for<span class="_"> </span>storing<span class="_"> </span>the<span class="_"> </span>result.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>two<span class="_"> </span>functions<span class="_"> </span>would<span class="_"> </span>then<span class="_"> </span>execute<span class="_"> </span>as<span class="_"> </span>follows:</div><div class="t m5 x17 h31 y4b85 ff7 fs21 fc2 sc0 ls0 ws0">Function<span class="_ _76"> </span>Initial<span class="_ _74"> </span>Before<span class="_"> </span>loop</div><div class="t m5 xa8 h31 y4b86 ffd fs1e fc2 sc0 ls0 ws0">i<span class="_ _10"> </span><span class="ff7 fs21 ls128">=0</span></div><div class="t m5 x9a h31 y4b87 ffd fs1e fc2 sc0 ls0 ws0">i<span class="_ _10"> </span><span class="ff7 fs21 ls128">=1<span class="_ _72"> </span></span>i<span class="_ _10"> </span><span class="ff7 fs21">=<span class="_"> </span>2<span class="_ _68"> </span>F<span class="_ _1"></span>inal</span></div><div class="t m5 x17 h2d y4b88 ffd fs1e fc2 sc0 ls0 ws0">combine3</div><div class="t m5 x1b0 h31 y4b89 ff7 fs21 fc2 sc0 ls0 ws0">[2<span class="ff11">,<span class="_ _13"> </span></span>3<span class="ff11">,<span class="_ _13"> </span></span>5]<span class="_ _13c"> </span>[2<span class="_ _2"></span><span class="ff11">,<span class="_ _13"> </span></span>3<span class="_ _0"></span><span class="ff11">,<span class="_ _13"> </span><span class="ff7">1]<span class="_ _20"> </span>[2</span>,<span class="_ _13"> </span><span class="ff7">3</span>,<span class="_ _13"> </span><span class="ff7">2]<span class="_ _19"> </span>[2</span>,<span class="_ _13"> </span><span class="ff7">3</span>,<span class="_ _13"> </span><span class="ff7">6]<span class="_ _13c"> </span>[2</span>,<span class="_ _10"> </span><span class="ff7">3<span class="_ _1"></span><span class="ff11">,<span class="_ _13"> </span><span class="ff7">36]<span class="_ _19"> </span>[2</span>,<span class="_ _10"> </span><span class="ff7">3<span class="_ _1"></span><span class="ff11">,<span class="_ _13"> </span><span class="ff7">36]</span></span></span></span></span></span></div><div class="t m5 x17 h31 y4b8a ffd fs1e fc2 sc0 ls0 ws0">combine4<span class="_ _26"> </span><span class="ff7 fs21">[2<span class="ff11">,<span class="_ _13"> </span></span>3<span class="ff11">,<span class="_ _13"> </span></span>5]<span class="_ _13c"> </span>[2<span class="_ _2"></span><span class="ff11">,<span class="_ _13"> </span></span>3<span class="_ _0"></span><span class="ff11">,<span class="_ _13"> </span><span class="ff7">5]<span class="_ _20"> </span>[2</span>,<span class="_ _13"> </span><span class="ff7">3</span>,<span class="_ _13"> </span><span class="ff7">5]<span class="_ _19"> </span>[2</span>,<span class="_ _13"> </span><span class="ff7">3</span>,<span class="_ _13"> </span><span class="ff7">5]<span class="_ _13c"> </span>[2</span>,<span class="_ _10"> </span><span class="ff7">3<span class="_ _1"></span><span class="ff11">,<span class="_ _13"> </span><span class="ff7">5]<span class="_ _4c"> </span>[2<span class="_ _2"></span></span>,<span class="_ _13"> </span><span class="ff7">3<span class="_ _0"></span><span class="ff11">,<span class="_ _13"> </span><span class="ff7">30]</span></span></span></span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
