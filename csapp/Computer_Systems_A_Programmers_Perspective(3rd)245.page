<div id="pff5" class="pf w2 h11" data-page-no="f5"><div class="pc pcf5 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bgf5.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">244<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">What<span class="_ _11"> </span>do<span class="_ _11"> </span>the<span class="_ _11"> </span>instructions<span class="_ _16"> </span><span class="ffd fs2b">rep<span class="_ _11"> </span></span>and<span class="_ _11"> </span><span class="ffd fs2b">repz<span class="_ _11"> </span></span>do?</span></div><div class="t m5 x28 h2b y258 ff7 fs1e fc2 sc0 ls0 ws0">Line<span class="_"> </span>8<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>assembly<span class="_"> </span>code<span class="_"> </span>shown<span class="_"> </span>on<span class="_"> </span>page<span class="_"> </span>243<span class="_ _13"> </span>contains<span class="_"> </span>the<span class="_"> </span>instruction<span class="_"> </span>combination<span class="_"> </span><span class="ffd">rep;<span class="_ _11"> </span>ret</span>.<span class="_"> </span>T<span class="_ _1"></span>hese</div><div class="t m5 x28 h2b y259 ff7 fs1e fc2 sc0 ls0 ws0">are<span class="_ _16"> </span>rendered<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span>disassembled<span class="_ _16"> </span>code<span class="_ _11"> </span>(line<span class="_ _16"> </span>6)<span class="_ _16"> </span>as<span class="_ _16"> </span><span class="ffd">repz<span class="_ _16"> </span>retq</span>.<span class="_ _16"> </span>One<span class="_ _11"> </span>can<span class="_ _16"> </span>infer<span class="_ _16"> </span>that<span class="_ _16"> </span><span class="ffd">repz<span class="_ _16"> </span></span>is<span class="_ _16"> </span>a<span class="_ _16"> </span>synonym</div><div class="t m5 x28 h2b y25a ff7 fs1e fc2 sc0 ls0 ws0">for<span class="_ _14"> </span><span class="ffd">rep</span>,<span class="_ _15"> </span>just<span class="_ _14"> </span>as<span class="_ _14"> </span><span class="ffd">retq<span class="_ _14"> </span></span>is<span class="_ _14"> </span>a<span class="_ _14"> </span>synonym<span class="_ _14"> </span>for<span class="_ _14"> </span><span class="ffd">ret</span>.<span class="_ _14"> </span>Looking<span class="_ _14"> </span>at<span class="_ _14"> </span>the<span class="_ _14"> </span>Intel<span class="_ _14"> </span>and<span class="_ _14"> </span>AMD<span class="_ _14"> </span>documentation<span class="_ _14"> </span>for<span class="_ _14"> </span>the</div><div class="t m5 x28 h2b y4e2 ffd fs1e fc2 sc0 ls0 ws0">rep<span class="_ _11"> </span><span class="ff7">instruction,<span class="_ _16"> </span>we<span class="_ _16"> </span>ﬁnd<span class="_ _11"> </span>that<span class="_ _11"> </span>it<span class="_ _16"> </span>is<span class="_ _11"> </span>normally<span class="_ _16"> </span>used<span class="_ _11"> </span>to<span class="_ _16"> </span>implement<span class="_ _11"> </span>a<span class="_ _16"> </span>repeating<span class="_ _11"> </span>string<span class="_ _11"> </span>operation<span class="_ _16"> </span>[3,<span class="_ _16"> </span>51].<span class="_ _11"> </span>It</span></div><div class="t m5 x28 h2b y4e3 ff7 fs1e fc2 sc0 ls0 ws0">seems<span class="_ _11"> </span>completely<span class="_ _11"> </span>inappropriate<span class="_ _11"> </span>here.<span class="_ _10"> </span>The<span class="_ _10"> </span>answer<span class="_ _11"> </span>to<span class="_ _16"> </span>this<span class="_ _11"> </span>puzzle<span class="_ _11"> </span>can<span class="_ _11"> </span>be<span class="_ _11"> </span>seen<span class="_ _11"> </span>in<span class="_ _16"> </span>AMD’<span class="_ _0"></span>s<span class="_ _11"> </span>guidelines<span class="_ _11"> </span>to</div><div class="t m5 x28 h2b y4e4 ff7 fs1e fc2 sc0 ls0 ws0">compiler<span class="_"> </span>writers<span class="_"> </span>[1].<span class="_"> </span>T<span class="_ _1"></span>hey<span class="_"> </span>recommend<span class="_"> </span>using<span class="_"> </span>the<span class="_"> </span>combination<span class="_"> </span>of<span class="_"> </span><span class="ffd">rep<span class="_ _10"> </span></span>followed<span class="_"> </span>by<span class="_ _13"> </span><span class="ffd">ret<span class="_ _10"> </span></span>to<span class="_"> </span>avoid<span class="_"> </span>making</div><div class="t m5 x28 h2b y945 ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_"> </span><span class="ffd">ret<span class="_ _10"> </span></span>instruction<span class="_ _10"> </span>the<span class="_ _10"> </span>destination<span class="_ _11"> </span>of<span class="_"> </span>a<span class="_"> </span>conditional<span class="_ _10"> </span>jump<span class="_ _11"> </span>instruction.<span class="_"> </span>W<span class="_ _0"></span>ithout<span class="_"> </span>the<span class="_"> </span><span class="ffd">rep<span class="_ _10"> </span></span>instruction,<span class="_ _11"> </span>the</div><div class="t m5 x28 h2b y946 ffd fs1e fc2 sc0 ls0 ws0">jg<span class="_ _13"> </span><span class="ff7">instruction<span class="_ _6"> </span>(line<span class="_ _13"> </span>7<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>assembly<span class="_ _13"> </span>code)<span class="_ _13"> </span>would<span class="_ _6"> </span>proceed<span class="_ _13"> </span>to<span class="_ _6"> </span>the<span class="_ _13"> </span></span>ret<span class="_ _6"> </span><span class="ff7">instruction<span class="_ _13"> </span>when<span class="_ _6"> </span>the<span class="_ _13"> </span>branch<span class="_ _13"> </span>is<span class="_ _6"> </span>not</span></div><div class="t m5 x28 h2b y947 ff7 fs1e fc2 sc0 ls0 ws0">taken.<span class="_ _13"> </span>According<span class="_ _6"> </span>to<span class="_ _13"> </span>AMD<span class="_ _3"></span>,<span class="_ _13"> </span>their<span class="_ _6"> </span>processors<span class="_ _13"> </span>cannot<span class="_ _13"> </span>properly<span class="_ _6"> </span>predict<span class="_ _13"> </span>the<span class="_ _6"> </span>destination<span class="_ _13"> </span>of<span class="_ _13"> </span>a<span class="_ _6"> </span><span class="ffd">ret<span class="_ _13"> </span></span>instruction</div><div class="t m5 x28 h2b y948 ff7 fs1e fc2 sc0 ls0 ws0">when<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>reached<span class="_"> </span>from<span class="_"> </span>a<span class="_ _13"> </span>jump<span class="_"> </span>instruction.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span><span class="ffd">rep<span class="_ _10"> </span></span>instruction<span class="_"> </span>serves<span class="_"> </span>as<span class="_"> </span>a<span class="_"> </span>form<span class="_"> </span>of<span class="_"> </span>no-operation<span class="_ _13"> </span>here,</div><div class="t m5 x28 h2b y949 ff7 fs1e fc2 sc0 ls0 ws0">and<span class="_ _16"> </span>so<span class="_ _16"> </span>inserting<span class="_ _16"> </span>it<span class="_ _11"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span>jump<span class="_ _16"> </span>destination<span class="_ _16"> </span>does<span class="_ _16"> </span>not<span class="_ _16"> </span>change<span class="_ _16"> </span>behavior<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>code,<span class="_ _16"> </span>except<span class="_ _16"> </span>to<span class="_ _11"> </span>make<span class="_ _16"> </span>it</div><div class="t m5 x28 h2b y94a ff7 fs1e fc2 sc0 ls0 ws0">faster<span class="_"> </span>on<span class="_ _11"> </span>AMD<span class="_"> </span>processors<span class="_ _1"></span>.<span class="_ _11"> </span>W<span class="_ _3"></span>e<span class="_ _10"> </span>can<span class="_ _11"> </span>safely<span class="_"> </span>ignore<span class="_ _11"> </span>any<span class="_"> </span><span class="ffd">rep<span class="_ _10"> </span></span>or<span class="_ _11"> </span><span class="ffd">repz<span class="_ _10"> </span></span>instruction<span class="_ _10"> </span>we<span class="_ _11"> </span>see<span class="_"> </span>in<span class="_ _11"> </span>the<span class="_"> </span>rest<span class="_ _10"> </span>of<span class="_ _11"> </span>the</div><div class="t m5 x28 h2b y94b ff7 fs1e fc2 sc0 ls0 ws0">code<span class="_"> </span>presented<span class="_"> </span>in<span class="_"> </span>this<span class="_"> </span>book.</div><div class="t m5 x1d h26 y251f ff7 fs19 fc2 sc0 ls0 ws0">address<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>following<span class="_ _11"> </span>instruction,<span class="_"> </span>we<span class="_ _11"> </span>get<span class="_"> </span>jump<span class="_ _11"> </span>target<span class="_"> </span>address<span class="_ _11"> </span><span class="ffd">0x8</span>,<span class="_"> </span>the<span class="_ _11"> </span>address</div><div class="t m5 x1d h26 y2520 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_"> </span>instruction<span class="_"> </span>on<span class="_"> </span>line<span class="_"> </span>4.</div><div class="t m5 x29 h26 y2521 ff7 fs19 fc2 sc0 ls0 ws0">Similarly<span class="_ _3"></span>,<span class="_"> </span>the<span class="_"> </span>target<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>second<span class="_"> </span>jump<span class="_"> </span>instruction<span class="_"> </span>is<span class="_"> </span>encoded<span class="_"> </span>as<span class="_"> </span><span class="ffd">0xf8<span class="_ _10"> </span></span>(deci-</div><div class="t m5 x1d h46 y2522 ff7 fs19 fc2 sc0 ls0 ws0">mal<span class="_ _13"> </span><span class="ff12">−</span>8)<span class="_"> </span>using<span class="_ _13"> </span>a<span class="_ _13"> </span>single-byte<span class="_"> </span>two’<span class="_ _1"></span>s-complement<span class="_"> </span>representation.<span class="_ _13"> </span>Adding<span class="_ _13"> </span>this<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">0xd</span></div><div class="t m5 x1d h26 y2523 ff7 fs19 fc2 sc0 ls0 ws0">(decimal<span class="_ _11"> </span>13),<span class="_ _16"> </span>the<span class="_ _11"> </span>address<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>instruction<span class="_ _11"> </span>on<span class="_ _16"> </span>line<span class="_ _11"> </span>6,<span class="_ _16"> </span>we<span class="_ _11"> </span>get<span class="_ _11"> </span><span class="ffd">0x5</span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>address<span class="_ _11"> </span>of</div><div class="t m5 x1d h26 y2524 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>instruction<span class="_"> </span>on<span class="_"> </span>line<span class="_"> </span>3.</div><div class="t m5 x29 h26 y2525 ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _13"> </span>these<span class="_ _13"> </span>examples<span class="_ _6"> </span>illustrate,<span class="_ _13"> </span>the<span class="_ _13"> </span>value<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>program<span class="_ _13"> </span>counter<span class="_ _13"> </span>when<span class="_ _6"> </span>perform-</div><div class="t m5 x1d h26 y2526 ff7 fs19 fc2 sc0 ls0 ws0">ing<span class="_ _13"> </span>PC-relative<span class="_ _13"> </span>addressing<span class="_ _6"> </span>is<span class="_ _13"> </span>the<span class="_ _13"> </span>address<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>instruction<span class="_ _6"> </span>following<span class="_ _13"> </span>the<span class="_ _13"> </span>jump<span class="_ _1"></span>,<span class="_ _13"> </span>not</div><div class="t m5 x1d h26 y2527 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>jump<span class="_ _13"> </span>itself<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>his<span class="_ _13"> </span>convention<span class="_ _13"> </span>dates<span class="_ _13"> </span>back<span class="_ _13"> </span>to<span class="_ _13"> </span>early<span class="_ _13"> </span>implementations<span class="_ _1"></span>,<span class="_ _13"> </span>when</div><div class="t m5 x1d h26 y2528 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>processor<span class="_ _11"> </span>would<span class="_ _16"> </span>update<span class="_ _11"> </span>the<span class="_ _11"> </span>program<span class="_ _16"> </span>counter<span class="_"> </span>as<span class="_ _16"> </span>its<span class="_ _11"> </span>ﬁrst<span class="_ _11"> </span>step<span class="_ _16"> </span>in<span class="_ _11"> </span>executing<span class="_ _11"> </span>an</div><div class="t m5 x1d h26 y2529 ff7 fs19 fc2 sc0 ls0 ws0">instruction.</div><div class="t m5 x29 h26 y252a ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>following<span class="_"> </span>shows<span class="_"> </span>the<span class="_"> </span>disassembled<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>after<span class="_"> </span>linking:</div><div class="t m5 x1f h2d y252b ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _45"> </span><span class="ffd fs1e fc2">4004d0:<span class="_ _1a"> </span>48<span class="_ _e"> </span>89<span class="_ _1f"> </span>f8<span class="_ _12a"> </span>mov<span class="_ _7b"> </span>%rdi,%rax</span></div><div class="t m5 x1f h2d y252c ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">4004d3:<span class="_ _1a"> </span>eb<span class="_ _e"> </span>03<span class="_ _104"> </span>jmp<span class="_ _46"> </span>4004d8<span class="_ _e"> </span>&lt;loop+0x8&gt;</span></div><div class="t m5 x1f h2d y252d ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">4004d5:<span class="_ _1a"> </span>48<span class="_ _e"> </span>d1<span class="_ _1f"> </span>f8<span class="_ _12a"> </span>sar<span class="_ _7b"> </span>%rax</span></div><div class="t m5 x1f h2e y252e ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x10d h2d y252f ffd fs1e fc2 sc0 ls0 ws0">4004d8:<span class="_ _1a"> </span>48<span class="_ _e"> </span>85<span class="_ _1f"> </span>c0<span class="_ _12a"> </span>test<span class="_ _3f"> </span>%rax,%rax</div><div class="t m5 x1f h2d y2530 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">4004db:<span class="_ _1a"> </span>7f<span class="_ _e"> </span>f8<span class="_ _104"> </span>jg<span class="_ _8c"> </span>4004d5<span class="_ _e"> </span>&lt;loop+0x5&gt;</span></div><div class="t m5 x1f h2d y2531 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">4004dd:<span class="_ _1a"> </span>f3<span class="_ _e"> </span>c3<span class="_ _104"> </span>repz<span class="_ _e"> </span>retq</span></div><div class="t m5 x1d h26 ye93 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _15"> </span>instructions<span class="_ _14"> </span>have<span class="_ _15"> </span>been<span class="_ _14"> </span>relocated<span class="_ _15"> </span>to<span class="_ _15"> </span>different<span class="_ _14"> </span>addresses<span class="_ _1"></span>,<span class="_ _21"> </span>but<span class="_ _14"> </span>the<span class="_ _15"> </span>encodings</div><div class="t m5 x1d h26 y2532 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _14"> </span>the<span class="_ _14"> </span>jump<span class="_ _14"> </span>targets<span class="_ _15"> </span>in<span class="_ _14"> </span>lines<span class="_ _14"> </span>2<span class="_ _14"> </span>and<span class="_ _15"> </span>5<span class="_ _14"> </span>remain<span class="_ _14"> </span>unchanged.<span class="_ _14"> </span>By<span class="_ _15"> </span>using<span class="_ _14"> </span>a<span class="_ _14"> </span>PC-relative</div><div class="t m5 x1d h26 y2533 ff7 fs19 fc2 sc0 ls0 ws0">encoding<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _6"> </span>jump<span class="_ _6"> </span>targets<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _a"> </span>instructions<span class="_ _6"> </span>can<span class="_ _13"> </span>be<span class="_ _a"> </span>compactly<span class="_ _6"> </span>encoded<span class="_ _6"> </span>(requiring</div><div class="t m5 x1d h26 y2534 ff7 fs19 fc2 sc0 ls0 ws0">just<span class="_"> </span>2<span class="_"> </span>bytes),<span class="_"> </span>and<span class="_ _11"> </span>the<span class="_"> </span>object<span class="_"> </span>code<span class="_"> </span>can<span class="_ _11"> </span>be<span class="_"> </span>shifted<span class="_"> </span>to<span class="_ _11"> </span>different<span class="_"> </span>positions<span class="_"> </span>in<span class="_"> </span>memory</div><div class="t m5 x1d h26 y2535 ff7 fs19 fc2 sc0 ls0 ws0">without<span class="_"> </span>alteration.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
