<div id="pf3d4" class="pf w2 h11" data-page-no="3d4"><div class="pc pc3d4 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3d4.png"/><div class="t m5 x1df h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>11.4<span class="_ _60"> </span>The<span class="_ _10"> </span>Sockets<span class="_ _10"> </span>Interface<span class="_ _3e"> </span><span class="ffe fs1e">979</span></div><div class="t m5 x61 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>open_clientfd(char<span class="_ _e"> </span>*hostname,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*port)<span class="_ _e"> </span>{</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>clientfd;</span></div><div class="t m5 x2c h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">struct<span class="_ _e"> </span>addrinfo<span class="_ _1f"> </span>hints,<span class="_ _1f"> </span>*listp,<span class="_ _e"> </span>*p;</span></div><div class="t m5 x2c h2e y284 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y69c3 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x142 h2d y285 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Get<span class="_ _1f"> </span>a<span class="_ _1f"> </span>list<span class="_ _e"> </span>of<span class="_ _1f"> </span>potential<span class="_ _e"> </span>server<span class="_ _1f"> </span>addresses<span class="_ _1f"> </span>*/</div><div class="t m5 x2c h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">memset(&amp;hints,<span class="_ _e"> </span>0,<span class="_ _1f"> </span>sizeof(struct<span class="_ _1f"> </span>addrinfo));</span></div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">hints.ai_socktype<span class="_ _e"> </span>=<span class="_ _1f"> </span>SOCK_STREAM;<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Open<span class="_ _e"> </span>a<span class="_ _1f"> </span>connection<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">hints.ai_flags<span class="_ _e"> </span>=<span class="_ _1f"> </span>AI_NUMERICSERV;<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>...<span class="_ _e"> </span>using<span class="_ _1f"> </span>a<span class="_ _e"> </span>numeric<span class="_ _1f"> </span>port<span class="_ _1f"> </span>arg.<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">hints.ai_flags<span class="_ _e"> </span>|=<span class="_ _1f"> </span>AI_ADDRCONFIG;<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Recommended<span class="_ _e"> </span>for<span class="_ _1f"> </span>connections<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">Getaddrinfo(hostname,<span class="_ _e"> </span>port,<span class="_ _1f"> </span>&amp;hints,<span class="_ _1f"> </span>&amp;listp);</span></div><div class="t m5 x17 h2e y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x17 h2e y65f2 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x142 h2d y906 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Walk<span class="_ _1f"> </span>the<span class="_ _1f"> </span>list<span class="_ _e"> </span>for<span class="_ _1f"> </span>one<span class="_ _e"> </span>that<span class="_ _1f"> </span>we<span class="_ _1f"> </span>can<span class="_ _e"> </span>successfully<span class="_ _1f"> </span>connect<span class="_ _e"> </span>to<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(p<span class="_ _1f"> </span>=<span class="_ _1f"> </span>listp;<span class="_ _e"> </span>p;<span class="_ _1f"> </span>p<span class="_ _e"> </span>=<span class="_ _1f"> </span>p-&gt;ai_next)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Create<span class="_ _1f"> </span>a<span class="_ _1f"> </span>socket<span class="_ _e"> </span>descriptor<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((clientfd<span class="_ _1f"> </span>=<span class="_ _1f"> </span>socket(p-&gt;ai_family,<span class="_ _e"> </span>p-&gt;ai_socktype,<span class="_ _1f"> </span>p-&gt;ai_protocol))<span class="_ _e"> </span>&lt;<span class="_ _1f"> </span>0)</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _d1"> </span><span class="ffd fs1e fc2">continue;<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Socket<span class="_ _1f"> </span>failed,<span class="_ _e"> </span>try<span class="_ _1f"> </span>the<span class="_ _1f"> </span>next<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2e y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x17 h2e y6a25 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 xc5 h2d yeb4 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Connect<span class="_ _1f"> </span>to<span class="_ _1f"> </span>the<span class="_ _e"> </span>server<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(connect(clientfd,<span class="_ _1f"> </span>p-&gt;ai_addr,<span class="_ _1f"> </span>p-&gt;ai_addrlen)<span class="_ _e"> </span>!=<span class="_ _1f"> </span>-1)</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _d1"> </span><span class="ffd fs1e fc2">break;<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Success<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 xc5 h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">Close(clientfd);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Connect<span class="_ _1f"> </span>failed,<span class="_ _e"> </span>try<span class="_ _1f"> </span>another<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y3228 ff6 fs20 fc6 sc0 ls0 ws0">23</div><div class="t m5 x17 h2e y66e1 ff6 fs20 fc6 sc0 ls0 ws0">24</div><div class="t m5 x142 h2d y35d ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Clean<span class="_ _1f"> </span>up<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x142 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">Freeaddrinfo(listp);</div><div class="t m5 x17 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(!p)<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>All<span class="_ _e"> </span>connects<span class="_ _1f"> </span>failed<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>-1;</span></div><div class="t m5 x17 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _20"> </span><span class="ffd fs1e fc2">else<span class="_ _46"> </span>/*<span class="_ _e"> </span>The<span class="_ _1f"> </span>last<span class="_ _1f"> </span>connect<span class="_ _e"> </span>succeeded<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y441 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>clientfd;</span></div><div class="t m5 x17 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x61 h2c y7c95 ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y7c96 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _13"> </span>11.18</div><div class="t m5 x155 h3a y7c97 ffd fs19 fc1 sc0 ls0 ws0">open_clientfd<span class="ffe fs16">:<span class="_ _13"> </span>Helper<span class="_ _13"> </span>function<span class="_ _13"> </span>that<span class="_ _13"> </span>establishes<span class="_ _13"> </span>a<span class="_ _13"> </span>connection<span class="_ _13"> </span>with<span class="_ _13"> </span>a<span class="_ _13"> </span>server<span class="_ _1"></span>.<span class="_ _13"> </span><span class="ff6">It<span class="_ _13"> </span>is<span class="_ _13"> </span>reentrant</span></span></div><div class="t m5 x17 h34 y7c98 ff6 fs16 fc1 sc0 ls0 ws0">and<span class="_ _10"> </span>protocol-independent.</div><div class="t m5 x17 h26 y4174 ff7 fs19 fc1 sc0 ls0 ws0">nection<span class="_ _11"> </span>with<span class="_ _11"> </span>a<span class="_ _11"> </span>server<span class="_ _11"> </span>running<span class="_ _11"> </span>on<span class="_ _16"> </span><span class="ffd">hostname<span class="_ _10"> </span></span>and<span class="_ _16"> </span>listening<span class="_"> </span>on<span class="_ _11"> </span><span class="ffd">port</span>.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _11"> </span>then<span class="_ _11"> </span>walk</div><div class="t m5 x17 h26 y4175 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>list,<span class="_ _16"> </span>trying<span class="_ _16"> </span>each<span class="_ _16"> </span>list<span class="_ _11"> </span>entry<span class="_ _16"> </span>in<span class="_ _11"> </span>turn,<span class="_ _16"> </span>until<span class="_ _16"> </span>the<span class="_ _16"> </span>calls<span class="_ _11"> </span>to<span class="_ _16"> </span><span class="ffd">socket<span class="_ _11"> </span></span>and<span class="_ _16"> </span><span class="ffd">connect<span class="_ _16"> </span></span>suc-</div><div class="t m5 x17 h26 y4176 ff7 fs19 fc1 sc0 ls0 ws0">ceed.<span class="_ _14"> </span>If<span class="_ _15"> </span>the<span class="_ _14"> </span><span class="ffd">connect<span class="_ _15"> </span></span>fails<span class="_ _1"></span>,<span class="_ _21"> </span>we<span class="_ _14"> </span>are<span class="_ _15"> </span>careful<span class="_ _14"> </span>to<span class="_ _15"> </span>close<span class="_ _15"> </span>the<span class="_ _14"> </span>socket<span class="_ _15"> </span>descriptor<span class="_ _14"> </span>before</div><div class="t m5 x17 h26 y4177 ff7 fs19 fc1 sc0 ls0 ws0">trying<span class="_"> </span>the<span class="_ _13"> </span>next<span class="_"> </span>entry<span class="_ _7"></span>.<span class="_"> </span>If<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">connect<span class="_ _10"> </span></span>succeeds<span class="_ _3"></span>,<span class="_"> </span>we<span class="_"> </span>free<span class="_ _13"> </span>the<span class="_"> </span>list<span class="_ _13"> </span>memory<span class="_"> </span>and<span class="_"> </span>return</div><div class="t m5 x17 h26 y4178 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>socket<span class="_ _16"> </span>descriptor<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span>client,<span class="_ _16"> </span>which<span class="_ _11"> </span>can<span class="_ _16"> </span>immediately<span class="_ _11"> </span>begin<span class="_ _16"> </span>using<span class="_ _11"> </span>Unix<span class="_ _16"> </span>I/O</div><div class="t m5 x17 h26 y4179 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>communicate<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span>server.</div><div class="t m5 x26 h26 y417a ff7 fs19 fc1 sc0 ls0 ws0">Notice<span class="_"> </span>how<span class="_ _13"> </span>there<span class="_"> </span>is<span class="_"> </span>no<span class="_"> </span>dependence<span class="_ _13"> </span>on<span class="_"> </span>any<span class="_"> </span>particular<span class="_ _13"> </span>version<span class="_"> </span>of<span class="_"> </span>IP<span class="_ _13"> </span>anywhere</div><div class="t m5 x17 h26 y417b ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_ _13"> </span>the<span class="_"> </span>code<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _3"></span>he<span class="_"> </span>arguments<span class="_ _13"> </span>to<span class="_"> </span><span class="ffd">socket<span class="_ _13"> </span></span>and<span class="_ _13"> </span><span class="ffd">connect<span class="_ _10"> </span></span>are<span class="_ _13"> </span>generated<span class="_"> </span>for<span class="_ _13"> </span>us<span class="_ _13"> </span>automat-</div><div class="t m5 x17 h26 y417c ff7 fs19 fc1 sc0 ls0 ws0">ically<span class="_"> </span>by<span class="_"> </span><span class="ffd">getaddrinfo</span>,<span class="_"> </span>which<span class="_"> </span>allows<span class="_"> </span>our<span class="_"> </span>code<span class="_"> </span>to<span class="_"> </span>be<span class="_"> </span>clean<span class="_"> </span>and<span class="_"> </span>portable<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
