<div id="pf377" class="pf w2 h11" data-page-no="377"><div class="pc pc377 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg377.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">886<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x56 h110 y72c4 ffc6 fsa0 fc1 sc0 ls0 ws0">Unused</div><div class="t m5 x14 h110 y72c5 ffc6 fsa0 fc1 sc0 ls0 ws0">Start</div><div class="t m5 x25d h110 y72c6 ffc6 fsa0 fc1 sc0 ls0 ws0">of</div><div class="t m5 x14 h110 y72c7 ffc6 fsa0 fc1 sc0 ls0 ws0">heap</div><div class="t m5 x73 h110 y72c8 ffc6 fsa0 fc1 sc0 ls0 ws0">8/0<span class="_ _74"> </span>16/1<span class="_ _1b1"> </span>16/1<span class="_ _224"> </span>16/1<span class="_ _225"></span>16/0<span class="_ _17a"> </span>0/1</div><div class="t m5 x223 h110 y730b ffc6 fsa0 fc1 sc0 ls0 ws0">Double-</div><div class="t m5 x165 h110 y730c ffc6 fsa0 fc1 sc0 ls0 ws0">word</div><div class="t m5 x233 h110 y730d ffc6 fsa0 fc1 sc0 ls0 ws0">aligned</div><div class="t m5 x14 h34 y72cc ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _13"> </span>9.37<span class="_ _c"> </span><span class="fc1">Splitting<span class="_"> </span>a<span class="_ _13"> </span>free<span class="_"> </span>block<span class="_ _13"> </span>to<span class="_ _10"> </span>satisfy<span class="_ _13"> </span>a<span class="_"> </span>three-word<span class="_ _13"> </span>allocation<span class="_ _10"> </span>request.<span class="_ _13"> </span><span class="ff6">Allocated<span class="_ _10"> </span>blocks<span class="_ _13"> </span>are<span class="_ _10"> </span>shaded.</span></span></div><div class="t m5 x14 h34 y72cd ff6 fs16 fc1 sc0 ls0 ws0">Free<span class="_ _10"> </span>blocks<span class="_ _11"> </span>are<span class="_ _10"> </span>unshaded.<span class="_ _10"> </span>Headers<span class="_ _11"> </span>are<span class="_ _10"> </span>labeled<span class="_ _11"> </span>with<span class="_ _10"> </span>(size<span class="_ _11"> </span>(bytes)/allocated<span class="_ _10"> </span>bit).</div><div class="t m5 x1d h26 y730e ff7 fs19 fc1 sc0 ls0 ws0">introduces<span class="_"> </span>internal<span class="_ _13"> </span>fragmentation.<span class="_"> </span>If<span class="_ _13"> </span>the<span class="_"> </span>placement<span class="_ _13"> </span>policy<span class="_"> </span>tends<span class="_ _13"> </span>to<span class="_"> </span>produce<span class="_ _13"> </span>good</div><div class="t m5 x1d h26 y730f ff7 fs19 fc1 sc0 ls0 ws0">ﬁts<span class="_ _1"></span>,<span class="_"> </span>then<span class="_"> </span>some<span class="_"> </span>additional<span class="_"> </span>internal<span class="_"> </span>fragmentation<span class="_"> </span>might<span class="_"> </span>be<span class="_"> </span>acceptable<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y7310 ff7 fs19 fc1 sc0 ls0 ws0">However,<span class="_ _21"> </span>if<span class="_ _15"> </span>the<span class="_ _15"> </span>ﬁt<span class="_ _21"> </span>is<span class="_ _15"> </span>not<span class="_ _21"> </span>good,<span class="_ _21"> </span>then<span class="_ _21"> </span>the<span class="_ _15"> </span>allocator<span class="_ _21"> </span>will<span class="_ _15"> </span>usually<span class="_ _15"> </span>opt<span class="_ _21"> </span>to<span class="_ _15"> </span><span class="ffa">split</span></div><div class="t m5 x1d h26 y7311 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>free<span class="_ _11"> </span>block<span class="_"> </span>into<span class="_ _11"> </span>two<span class="_ _11"> </span>parts<span class="_ _1"></span>.<span class="_"> </span>The<span class="_"> </span>ﬁrst<span class="_"> </span>part<span class="_ _11"> </span>becomes<span class="_"> </span>the<span class="_ _11"> </span>allocated<span class="_"> </span>block,<span class="_ _11"> </span>and<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y7312 ff7 fs19 fc1 sc0 ls0 ws0">remainder<span class="_"> </span>becomes<span class="_ _11"> </span>a<span class="_"> </span>new<span class="_ _11"> </span>free<span class="_"> </span>block.<span class="_ _11"> </span>F<span class="_ _0"></span>igure<span class="_"> </span>9.37<span class="_"> </span>shows<span class="_ _11"> </span>how<span class="_ _11"> </span>the<span class="_"> </span>allocator<span class="_ _11"> </span>might</div><div class="t m5 x1d h26 y7313 ff7 fs19 fc1 sc0 ls0 ws0">split<span class="_ _13"> </span>the<span class="_ _13"> </span>eight-word<span class="_ _13"> </span>free<span class="_"> </span>block<span class="_ _13"> </span>in<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>9.36<span class="_ _13"> </span>to<span class="_ _13"> </span>satisfy<span class="_ _13"> </span>an<span class="_ _13"> </span>application’s<span class="_ _13"> </span>request<span class="_ _13"> </span>for</div><div class="t m5 x1d h26 y7314 ff7 fs19 fc1 sc0 ls0 ws0">three<span class="_"> </span>words<span class="_"> </span>of<span class="_"> </span>heap<span class="_"> </span>memory<span class="_ _3"></span>.</div><div class="t m5 x1d h41 y7315 ffe fs29 fc1 sc0 ls0 ws0">9.9.9<span class="_ _48"> </span><span class="fs19">Getting<span class="_"> </span>Additional<span class="_"> </span>Heap<span class="_"> </span>Memory</span></div><div class="t m5 x1d h26 y7316 ff7 fs19 fc1 sc0 ls0 ws0">What<span class="_"> </span>happens<span class="_ _13"> </span>if<span class="_"> </span>the<span class="_"> </span>allocator<span class="_"> </span>is<span class="_"> </span>unable<span class="_"> </span>to<span class="_"> </span>ﬁnd<span class="_"> </span>a<span class="_"> </span>ﬁt<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>requested<span class="_"> </span>block?<span class="_ _13"> </span>One</div><div class="t m5 x1d h26 y7317 ff7 fs19 fc1 sc0 ls0 ws0">option<span class="_ _14"> </span>is<span class="_ _15"> </span>to<span class="_ _15"> </span>try<span class="_ _14"> </span>to<span class="_ _15"> </span>create<span class="_ _15"> </span>some<span class="_ _14"> </span>larger<span class="_ _15"> </span>free<span class="_ _15"> </span>blocks<span class="_ _14"> </span>by<span class="_ _15"> </span>merging<span class="_ _15"> </span>(coalescing)<span class="_ _14"> </span>free</div><div class="t m5 x1d h26 y7318 ff7 fs19 fc1 sc0 ls0 ws0">blocks<span class="_ _15"> </span>that<span class="_ _15"> </span>are<span class="_ _15"> </span>physically<span class="_ _15"> </span>adjacent<span class="_ _15"> </span>in<span class="_ _15"> </span>memory<span class="_ _15"> </span>(next<span class="_ _15"> </span>section).<span class="_ _15"> </span>However,<span class="_ _15"> </span>if<span class="_ _15"> </span>this</div><div class="t m5 x1d h26 y7319 ff7 fs19 fc1 sc0 ls0 ws0">does<span class="_ _13"> </span>not<span class="_ _13"> </span>yield<span class="_ _6"> </span>a<span class="_ _13"> </span>sufﬁciently<span class="_ _13"> </span>large<span class="_ _13"> </span>block,<span class="_ _13"> </span>or<span class="_ _6"> </span>if<span class="_ _13"> </span>the<span class="_ _13"> </span>free<span class="_ _13"> </span>blocks<span class="_ _13"> </span>are<span class="_ _6"> </span>already<span class="_ _13"> </span>maximally</div><div class="t m5 x1d h26 y731a ff7 fs19 fc1 sc0 ls0 ws0">coalesced,<span class="_ _13"> </span>then<span class="_ _a"> </span>the<span class="_ _6"> </span>allocator<span class="_ _13"> </span>asks<span class="_ _a"> </span>the<span class="_ _6"> </span>kernel<span class="_ _13"> </span>for<span class="_ _a"> </span>additional<span class="_ _13"> </span>heap<span class="_ _a"> </span>memory<span class="_ _6"> </span>by<span class="_ _13"> </span>calling</div><div class="t m5 x1d h26 y731b ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span><span class="ffd">sbrk<span class="_ _10"> </span></span>function.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_"> </span>allocator<span class="_ _13"> </span>transforms<span class="_ _13"> </span>the<span class="_"> </span>additional<span class="_ _13"> </span>memory<span class="_ _13"> </span>into<span class="_"> </span>one<span class="_ _13"> </span>large</div><div class="t m5 x1d h26 y731c ff7 fs19 fc1 sc0 ls0 ws0">free<span class="_"> </span>block,<span class="_ _13"> </span>inserts<span class="_"> </span>the<span class="_ _13"> </span>block<span class="_"> </span>into<span class="_ _13"> </span>the<span class="_"> </span>free<span class="_ _13"> </span>list,<span class="_"> </span>and<span class="_"> </span>then<span class="_ _13"> </span>places<span class="_"> </span>the<span class="_ _13"> </span>requested<span class="_"> </span>block</div><div class="t m5 x1d h26 y731d ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_"> </span>this<span class="_"> </span>new<span class="_"> </span>free<span class="_"> </span>block.</div><div class="t m5 x1d h41 y322c ffe fs29 fc1 sc0 ls0 ws0">9.9.10<span class="_ _48"> </span><span class="fs19">Coalescing<span class="_"> </span>Free<span class="_"> </span>Blocks</span></div><div class="t m5 x1d h26 y7fe ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _14"> </span>the<span class="_ _15"> </span>allocator<span class="_ _15"> </span>frees<span class="_ _15"> </span>an<span class="_ _15"> </span>allocated<span class="_ _21"> </span>block,<span class="_ _21"> </span>there<span class="_ _15"> </span>might<span class="_ _15"> </span>be<span class="_ _15"> </span>other<span class="_ _15"> </span>free<span class="_ _15"> </span>blocks</div><div class="t m5 x1d h26 y7ff ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _16"> </span>are<span class="_ _16"> </span>adjacent<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>newly<span class="_ _16"> </span>freed<span class="_ _16"> </span>block.<span class="_ _16"> </span>Such<span class="_ _16"> </span>adjacent<span class="_ _16"> </span>free<span class="_ _16"> </span>blocks<span class="_ _16"> </span>can<span class="_ _16"> </span>cause</div><div class="t m5 x1d h26 y800 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _13"> </span>phenomenon<span class="_"> </span>known<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ffa">false<span class="_ _13"> </span>fragmentation</span>,<span class="_"> </span>where<span class="_ _13"> </span>there<span class="_ _13"> </span>is<span class="_ _13"> </span>a<span class="_"> </span>lot<span class="_ _13"> </span>of<span class="_ _13"> </span>available<span class="_ _13"> </span>free</div><div class="t m5 x1d h26 y801 ff7 fs19 fc1 sc0 ls0 ws0">memory<span class="_ _16"> </span>chopped<span class="_ _16"> </span>up<span class="_ _16"> </span>into<span class="_ _14"> </span>small,<span class="_ _14"> </span>unusable<span class="_ _16"> </span>free<span class="_ _16"> </span>blocks<span class="_ _1"></span>.<span class="_ _16"> </span>F<span class="_ _0"></span>or<span class="_ _16"> </span>example<span class="_ _0"></span>,<span class="_ _16"> </span>Figure<span class="_ _16"> </span>9.38</div><div class="t m5 x1d h26 y802 ff7 fs19 fc1 sc0 ls0 ws0">shows<span class="_"> </span>the<span class="_"> </span>result<span class="_"> </span>of<span class="_ _11"> </span>freeing<span class="_"> </span>the<span class="_"> </span>block<span class="_"> </span>that<span class="_ _11"> </span>was<span class="_"> </span>allocated<span class="_"> </span>in<span class="_"> </span>Figure<span class="_"> </span>9.37.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>result</div><div class="t m5 x1d h26 y803 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _21"> </span>two<span class="_ _21"> </span>adjacent<span class="_ _21"> </span>free<span class="_ _21"> </span>blocks<span class="_ _21"> </span>with<span class="_ _21"> </span>payloads<span class="_ _21"> </span>of<span class="_ _f"> </span>three<span class="_ _21"> </span>words<span class="_ _21"> </span>each.<span class="_ _21"> </span>As<span class="_ _21"> </span>a<span class="_ _21"> </span>result,<span class="_ _e"> </span>a</div><div class="t m5 x1d h26 y804 ff7 fs19 fc1 sc0 ls0 ws0">subsequent<span class="_ _f"> </span>request<span class="_ _e"> </span>for<span class="_ _21"> </span>a<span class="_ _e"> </span>payload<span class="_ _21"> </span>of<span class="_ _e"> </span>four<span class="_ _21"> </span>words<span class="_ _e"> </span>would<span class="_ _f"> </span>fail,<span class="_ _e"> </span>even<span class="_ _e"> </span>though<span class="_ _21"> </span>the</div><div class="t m5 x1d h26 y805 ff7 fs19 fc1 sc0 ls0 ws0">aggregate<span class="_"> </span>size<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>two<span class="_"> </span>free<span class="_"> </span>blocks<span class="_"> </span>is<span class="_"> </span>large<span class="_"> </span>enough<span class="_"> </span>to<span class="_"> </span>satisfy<span class="_"> </span>the<span class="_"> </span>request.</div><div class="t m5 x29 h26 y806 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _16"> </span>combat<span class="_ _11"> </span>false<span class="_ _16"> </span>fragmentation,<span class="_ _11"> </span>any<span class="_ _16"> </span>practical<span class="_ _11"> </span>allocator<span class="_ _11"> </span>must<span class="_ _16"> </span>merge<span class="_ _11"> </span>adjacent</div><div class="t m5 x1d h26 y807 ff7 fs19 fc1 sc0 ls0 ws0">free<span class="_ _21"> </span>blocks<span class="_ _f"> </span>in<span class="_ _21"> </span>a<span class="_ _f"> </span>process<span class="_ _21"> </span>known<span class="_ _f"> </span>as<span class="_ _21"> </span><span class="ffa">coalescing<span class="_ _2"></span></span>.<span class="_ _21"> </span>This<span class="_ _15"> </span>raises<span class="_ _f"> </span>an<span class="_ _21"> </span>important<span class="_ _f"> </span>policy</div><div class="t m5 x1d h26 y808 ff7 fs19 fc1 sc0 ls0 ws0">decision<span class="_ _11"> </span>about<span class="_ _11"> </span>when<span class="_ _11"> </span>to<span class="_ _11"> </span>perform<span class="_ _16"> </span>coalescing<span class="_ _0"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>allocator<span class="_"> </span>can<span class="_ _16"> </span>opt<span class="_"> </span>for<span class="_ _16"> </span><span class="ffa">immediate</span></div><div class="t m5 x1d h26 y809 ffa fs19 fc1 sc0 ls0 ws0">coalescing<span class="_"> </span><span class="ff7">by<span class="_ _13"> </span>merging<span class="_ _6"> </span>any<span class="_ _13"> </span>adjacent<span class="_ _13"> </span>blocks<span class="_ _13"> </span>each<span class="_ _13"> </span>time<span class="_ _13"> </span>a<span class="_ _13"> </span>block<span class="_ _13"> </span>is<span class="_ _13"> </span>freed.<span class="_ _13"> </span>Or<span class="_ _13"> </span>it<span class="_ _13"> </span>can<span class="_ _13"> </span>opt</span></div><div class="t m5 x1d h26 y80a ff7 fs19 fc1 sc0 ls0 ws0">for<span class="_"> </span><span class="ffa">deferred<span class="_ _11"> </span>coalescing<span class="_ _16"> </span></span>by<span class="_ _11"> </span>waiting<span class="_ _11"> </span>to<span class="_ _11"> </span>coalesce<span class="_"> </span>free<span class="_ _11"> </span>blocks<span class="_ _11"> </span>at<span class="_ _11"> </span>some<span class="_ _11"> </span>later<span class="_ _11"> </span>time<span class="_ _0"></span>.<span class="_"> </span>F<span class="_ _1"></span>or</div><div class="t m5 x1d h26 y80b ff7 fs19 fc1 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_ _11"> </span>the<span class="_ _11"> </span>allocator<span class="_ _11"> </span>might<span class="_ _11"> </span>defer<span class="_ _11"> </span>coalescing<span class="_"> </span>until<span class="_ _11"> </span>some<span class="_ _11"> </span>allocation<span class="_ _11"> </span>request<span class="_ _11"> </span>fails<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y80c ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>then<span class="_"> </span>scan<span class="_"> </span>the<span class="_"> </span>entire<span class="_"> </span>heap<span class="_ _1"></span>,<span class="_"> </span>coalescing<span class="_"> </span>all<span class="_"> </span>free<span class="_"> </span>blocks<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
