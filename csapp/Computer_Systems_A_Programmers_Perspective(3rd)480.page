<div id="pf1e0" class="pf w2 h11" data-page-no="1e0"><div class="pc pc1e0 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1e0.png"/><div class="t m5 x13d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>4.5<span class="_ _60"> </span>Pipelined<span class="_ _10"> </span>Y86-64<span class="_ _10"> </span>Implementations<span class="_ _3e"> </span><span class="ffe fs1e">479</span></div><div class="t m5 x48 h3f y42d9 ff49 fs27 fc1 sc0 ls1ea ws0">FD<span class="_ _0"></span>E<span class="_ _3"></span>M<span class="_ _4"></span>W</div><div class="t m5 xec h3f y42da ff49 fs27 fc1 sc0 ls1eb ws0">FDE<span class="_ _3"></span>M<span class="_ _8"></span>W</div><div class="t m5 x16e h3f y42db ff49 fs27 fc1 sc0 ls1ec ws0">FD</div><div class="t m5 xd8 h3f y42dc ff49 fs27 fc1 sc0 ls1ed ws0">EM<span class="_ _7"></span>W</div><div class="t m5 x184 h3f y42dd ff49 fs27 fc1 sc0 ls0 ws0">F</div><div class="t m5 xd8 h3f y42de ff49 fs27 fc1 sc0 ls1ee ws0">DE<span class="_ _1"></span>M<span class="_ _7"></span>W</div><div class="t m5 xd8 h3f y42df ff49 fs27 fc1 sc0 ls1ec ws0">FDE<span class="_ _3"></span>M<span class="_ _4"></span>W</div><div class="t m5 x15f h3f y42e0 ff49 fs27 fc1 sc0 ls1ec ws0">FDE<span class="_ _3"></span>M<span class="_ _4"></span>W</div><div class="t m5 x80 h3f y42e1 ff49 fs27 fc1 sc0 ls1ef ws0">FDE<span class="_ _7"></span>M<span class="_ _8"></span>W</div><div class="t m5 x17 h40 y42e2 ff4a fs28 fc1 sc0 ls0 ws0">0x000: irmovq Stack,%edx</div><div class="t m5 x17 h40 y42e3 ff4a fs28 fc1 sc0 ls0 ws0">0x00a: call proc</div><div class="t m5 x17 h40 y42e4 ff4a fs28 fc1 sc0 ls0 ws0">0x020: ret</div><div class="t m5 x17 h40 y42e5 ff4a fs28 fc1 sc0 ls0 ws0">       </div><div class="t m5 x17 h40 y42e6 ff4a fs28 fc1 sc0 ls0 ws0">       </div><div class="t m5 x17 h40 y42e7 ff4a fs28 fc1 sc0 ls0 ws0">       </div><div class="t m5 x17 h40 y42e8 ff4a fs28 fc1 sc0 ls0 ws0">0x013: irmovq $10,%edx # Return point</div><div class="t mc x77 hba y42e9 ff4a fs73 fc1 sc0 ls0 ws0">bubble</div><div class="c x17 y42ea we hbb"><div class="t mc x259 hba y42eb ff4a fs73 fc3 sc1 ls0 ws0">bubble</div></div><div class="t mc x77 hba y42ec ff4a fs73 fc1 sc0 ls0 ws0">bubble</div><div class="c x17 y42ea we hbb"><div class="t mc x259 hba y42ed ff4a fs73 fc3 sc1 ls0 ws0">bubble</div></div><div class="t mc x77 hba y42ee ff4a fs73 fc1 sc0 ls0 ws0">bubble</div><div class="c x17 y42ea we hbb"><div class="t mc x259 hba y42ef ff4a fs73 fc3 sc1 ls0 ws0">bubble</div></div><div class="t m5 x17 h40 y42f0 ff4a fs28 fc1 sc0 ls0 ws0"># prog7</div><div class="c x17 y42ea we hbb"><div class="t m5 x0 h40 y42f1 ff4a fs28 fc3 sc1 ls0 ws0"># prog7</div></div><div class="t m5 x47 h44 y42f2 ff49 fs2a fc6 sc0 ls1d7 ws0">12345</div><div class="t m5 x205 h44 y42f3 ff49 fs2a fc6 sc0 ls0 ws0">6</div><div class="t m5 x6c h44 y42f4 ff49 fs2a fc6 sc0 ls0 ws0">7</div><div class="t m5 x11a h44 y42f5 ff49 fs2a fc6 sc0 ls0 ws0">8</div><div class="t m5 x1f3 h44 y42f6 ff49 fs2a fc6 sc0 ls1e9 ws0">91<span class="_ _1c5"></span>0<span class="_ _2"></span>1<span class="_ _c5"></span>1</div><div class="t m5 x17 h3a y42f7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>4.55<span class="_ _c"> </span><span class="fc1">Simpliﬁed<span class="_"> </span>view<span class="_"> </span>of<span class="_"> </span><span class="ffd fs19">ret<span class="_ _11"> </span></span>instruction<span class="_"> </span>processing.<span class="_"> </span><span class="ff6">The<span class="_ _10"> </span>pipeline<span class="_ _11"> </span>should<span class="_ _11"> </span>stall<span class="_ _10"> </span>while<span class="_ _11"> </span>the<span class="_ _10"> </span><span class="ffd fs19">ret<span class="_ _11"> </span></span>passes</span></span></div><div class="t m5 x17 h34 y42f8 ff6 fs16 fc1 sc0 ls0 ws0">through<span class="_ _11"> </span>the<span class="_ _11"> </span>decode,<span class="_ _16"> </span>execute,<span class="_ _11"> </span>and<span class="_ _16"> </span>memory<span class="_ _11"> </span>stages,<span class="_ _16"> </span>injecting<span class="_ _11"> </span>three<span class="_ _11"> </span>bubbles<span class="_ _16"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>process.<span class="_ _11"> </span>The<span class="_ _16"> </span>PC<span class="_ _11"> </span>selection</div><div class="t m5 x17 h34 y42f9 ff6 fs16 fc1 sc0 ls0 ws0">logic<span class="_ _13"> </span>will<span class="_ _10"> </span>choose<span class="_ _13"> </span>the<span class="_ _10"> </span>return<span class="_ _10"> </span>address<span class="_ _13"> </span>as<span class="_ _10"> </span>the<span class="_ _13"> </span>instruction<span class="_ _10"> </span>fetch<span class="_ _13"> </span>address<span class="_ _10"> </span>once<span class="_ _13"> </span>the</div><div class="t m5 x11f h3a y42fa ffd fs19 fc1 sc0 ls0 ws0">ret<span class="_ _13"> </span><span class="ff6 fs16">reaches<span class="_ _10"> </span>the<span class="_ _13"> </span>write-back<span class="_ _10"> </span>stage</span></div><div class="t m5 x17 h34 y42fb ff6 fs16 fc1 sc0 ls0 ws0">(cycle<span class="_ _10"> </span>7).</div><div class="t m5 x17 h26 y42fc ff7 fs19 fc1 sc0 ls0 ws0">time<span class="_ _15"> </span>growing<span class="_ _15"> </span>to<span class="_ _15"> </span>the<span class="_ _14"> </span>right.<span class="_ _15"> </span>Unlike<span class="_ _15"> </span>before,<span class="_ _15"> </span>the<span class="_ _15"> </span>instructions<span class="_ _15"> </span>are<span class="_ _15"> </span>not<span class="_ _15"> </span>listed<span class="_ _15"> </span>in<span class="_ _15"> </span>the</div><div class="t m5 x17 h26 y42fd ff7 fs19 fc1 sc0 ls0 ws0">same<span class="_"> </span>order<span class="_"> </span>they<span class="_"> </span>occur<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>program,<span class="_"> </span>since<span class="_"> </span>this<span class="_"> </span>program<span class="_"> </span>involves<span class="_"> </span>a<span class="_"> </span>control<span class="_"> </span>ﬂow</div><div class="t m5 x17 h26 y42fe ff7 fs19 fc1 sc0 ls0 ws0">where<span class="_ _13"> </span>instructions<span class="_"> </span>are<span class="_ _13"> </span>not<span class="_ _13"> </span>executed<span class="_"> </span>in<span class="_ _13"> </span>a<span class="_ _13"> </span>linear<span class="_"> </span>sequence<span class="_ _1"></span>.<span class="_ _13"> </span>It<span class="_"> </span>is<span class="_ _13"> </span>useful<span class="_ _13"> </span>to<span class="_"> </span>look<span class="_ _13"> </span>at<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y42ff ff7 fs19 fc1 sc0 ls0 ws0">instruction<span class="_"> </span>addresses<span class="_"> </span>to<span class="_"> </span>identify<span class="_"> </span>the<span class="_"> </span>different<span class="_"> </span>instructions<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>program.</div><div class="t m5 x26 h26 y4300 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _f"> </span>this<span class="_ _f"> </span>diagram<span class="_ _f"> </span>shows<span class="_ _0"></span>,<span class="_ _e"> </span>the<span class="_ _f"> </span><span class="ffd">ret<span class="_ _f"> </span></span>instruction<span class="_ _f"> </span>is<span class="_ _e"> </span>fetched<span class="_ _21"> </span>during<span class="_ _f"> </span>cycle<span class="_ _f"> </span>3<span class="_ _f"> </span>and</div><div class="t m5 x17 h26 y4301 ff7 fs19 fc1 sc0 ls0 ws0">proceeds<span class="_ _15"> </span>down<span class="_ _15"> </span>the<span class="_ _15"> </span>pipeline<span class="_ _1"></span>,<span class="_ _f"> </span>reaching<span class="_ _15"> </span>the<span class="_ _15"> </span>write-back<span class="_ _15"> </span>stage<span class="_ _15"> </span>in<span class="_ _15"> </span>cycle<span class="_ _14"> </span>7.<span class="_ _15"> </span>While<span class="_ _15"> </span>it</div><div class="t m5 x17 h26 y4302 ff7 fs19 fc1 sc0 ls0 ws0">passes<span class="_ _16"> </span>through<span class="_ _11"> </span>the<span class="_ _16"> </span>decode<span class="_ _0"></span>,<span class="_ _16"> </span>execute<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _16"> </span>memory<span class="_ _11"> </span>stages<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>pipeline<span class="_ _16"> </span>cannot<span class="_ _16"> </span>do</div><div class="t m5 x17 h26 y4303 ff7 fs19 fc1 sc0 ls0 ws0">any<span class="_ _13"> </span>useful<span class="_ _6"> </span>activity<span class="_ _3"></span>.<span class="_ _13"> </span>Instead,<span class="_ _13"> </span>we<span class="_ _6"> </span>want<span class="_ _13"> </span>to<span class="_ _13"> </span>inject<span class="_ _6"> </span>three<span class="_ _13"> </span>bubbles<span class="_ _13"> </span>into<span class="_ _6"> </span>the<span class="_ _13"> </span>pipeline<span class="_ _1"></span>.<span class="_ _13"> </span>Once</div><div class="t m5 x17 h26 y4304 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span><span class="ffd">ret<span class="_ _13"> </span></span>instruction<span class="_ _13"> </span>reaches<span class="_ _13"> </span>the<span class="_"> </span>write-back<span class="_ _13"> </span>stage<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>PC<span class="_"> </span>selection<span class="_ _13"> </span>logic<span class="_ _13"> </span>will<span class="_ _13"> </span>set<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y4305 ff7 fs19 fc1 sc0 ls0 ws0">program<span class="_ _13"> </span>counter<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>return<span class="_ _13"> </span>address<span class="_ _3"></span>,<span class="_"> </span>and<span class="_ _13"> </span>therefore<span class="_ _13"> </span>the<span class="_ _13"> </span>fetch<span class="_ _13"> </span>stage<span class="_"> </span>will<span class="_ _13"> </span>fetch<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y4306 ffd fs19 fc1 sc0 ls0 ws0">irmovq<span class="_ _10"> </span><span class="ff7">instruction<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>return<span class="_"> </span>point<span class="_"> </span>(address<span class="_"> </span></span>0x013<span class="ff7">).</span></div><div class="t m5 x26 h26 y4307 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _16"> </span>handle<span class="_ _11"> </span>a<span class="_ _11"> </span>mispredicted<span class="_ _11"> </span>branch,<span class="_ _16"> </span>consider<span class="_ _11"> </span>the<span class="_ _11"> </span>following<span class="_ _11"> </span>program,<span class="_ _16"> </span>shown<span class="_ _11"> </span>in</div><div class="t m5 x17 h26 y4308 ff7 fs19 fc1 sc0 ls0 ws0">assembly<span class="_"> </span>code<span class="_"> </span>but<span class="_ _13"> </span>with<span class="_"> </span>the<span class="_"> </span>instruction<span class="_"> </span>addresses<span class="_"> </span>shown<span class="_ _13"> </span>on<span class="_"> </span>the<span class="_"> </span>left<span class="_"> </span>for<span class="_"> </span>reference:</div><div class="t m5 x17 h2d y4309 ffd fs1e fc2 sc0 ls0 ws0">0x000:<span class="_ _46"> </span>xorq<span class="_ _e"> </span>%rax,%rax</div><div class="t m5 x17 h2d y430a ffd fs1e fc2 sc0 ls0 ws0">0x002:<span class="_ _46"> </span>jne<span class="_ _1a"> </span>target<span class="_ _71"> </span>#<span class="_ _1f"> </span>Not<span class="_ _e"> </span>taken</div><div class="t m5 x17 h2d y430b ffd fs1e fc2 sc0 ls0 ws0">0x00b:<span class="_ _46"> </span>irmovq<span class="_ _e"> </span>$1,<span class="_ _1f"> </span>%rax<span class="_ _46"> </span>#<span class="_ _1f"> </span>Fall<span class="_ _e"> </span>through</div><div class="t m5 x17 h2d y430c ffd fs1e fc2 sc0 ls0 ws0">0x015:<span class="_ _46"> </span>halt</div><div class="t m5 x17 h2d y430d ffd fs1e fc2 sc0 ls0 ws0">0x016:<span class="_ _e"> </span>target:</div><div class="t m5 x17 h2d y430e ffd fs1e fc2 sc0 ls0 ws0">0x016:<span class="_ _46"> </span>irmovq<span class="_ _e"> </span>$2,<span class="_ _1f"> </span>%rdx<span class="_ _46"> </span>#<span class="_ _1f"> </span>Target</div><div class="t m5 x17 h2d y430f ffd fs1e fc2 sc0 ls0 ws0">0x020:<span class="_ _46"> </span>irmovq<span class="_ _e"> </span>$3,<span class="_ _1f"> </span>%rbx<span class="_ _46"> </span>#<span class="_ _1f"> </span>Target+1</div><div class="t m5 x17 h2d y4310 ffd fs1e fc2 sc0 ls0 ws0">0x02a:<span class="_ _46"> </span>halt</div><div class="t m5 x26 h26 y5b5 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _13"> </span>4.56<span class="_ _a"> </span>shows<span class="_ _13"> </span>how<span class="_ _6"> </span>these<span class="_ _6"> </span>instructions<span class="_ _6"> </span>are<span class="_ _13"> </span>processed.<span class="_ _6"> </span>As<span class="_ _6"> </span>before<span class="_ _0"></span>,<span class="_ _13"> </span>the<span class="_ _a"> </span>instruc-</div><div class="t m5 x17 h26 y5b6 ff7 fs19 fc2 sc0 ls0 ws0">tions<span class="_ _6"> </span>are<span class="_ _6"> </span>listed<span class="_ _13"> </span>in<span class="_ _a"> </span>the<span class="_ _6"> </span>order<span class="_ _13"> </span>they<span class="_ _a"> </span>enter<span class="_ _13"> </span>the<span class="_ _a"> </span>pipeline,<span class="_ _6"> </span>rather<span class="_ _6"> </span>than<span class="_ _13"> </span>the<span class="_ _a"> </span>order<span class="_ _6"> </span>they<span class="_ _13"> </span>occur</div><div class="t m5 x17 h26 y5b7 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _13"> </span>the<span class="_ _13"> </span>program.<span class="_ _13"> </span>Since<span class="_ _13"> </span>the<span class="_ _13"> </span>jump<span class="_ _13"> </span>instruction<span class="_ _13"> </span>is<span class="_ _13"> </span>predicted<span class="_ _6"> </span>as<span class="_ _13"> </span>being<span class="_ _13"> </span>taken,<span class="_ _13"> </span>the<span class="_ _13"> </span>instruc-</div><div class="t m5 x17 h26 y5b8 ff7 fs19 fc2 sc0 ls0 ws0">tion<span class="_ _13"> </span>at<span class="_"> </span>the<span class="_ _13"> </span>jump<span class="_ _13"> </span>target<span class="_"> </span>will<span class="_ _13"> </span>be<span class="_ _13"> </span>fetched<span class="_ _13"> </span>in<span class="_"> </span>c<span class="_ _1"></span>ycle<span class="_"> </span>3,<span class="_ _13"> </span>and<span class="_"> </span>the<span class="_ _13"> </span>instruction<span class="_ _13"> </span>following<span class="_ _13"> </span>this</div><div class="t m5 x17 h26 y5b9 ff7 fs19 fc2 sc0 ls0 ws0">one<span class="_"> </span>will<span class="_ _11"> </span>be<span class="_"> </span>fetched<span class="_ _11"> </span>in<span class="_"> </span>cycle<span class="_"> </span>4.<span class="_ _11"> </span>By<span class="_"> </span>the<span class="_ _11"> </span>time<span class="_"> </span>the<span class="_ _11"> </span>branch<span class="_"> </span>logic<span class="_ _11"> </span>detects<span class="_"> </span>that<span class="_ _11"> </span>the<span class="_"> </span>jump</div><div class="t m5 x17 h26 y5ba ff7 fs19 fc2 sc0 ls0 ws0">should<span class="_ _13"> </span>not<span class="_ _13"> </span>be<span class="_ _13"> </span>taken<span class="_ _13"> </span>during<span class="_ _13"> </span>c<span class="_ _1"></span>ycle<span class="_ _13"> </span>4,<span class="_ _13"> </span>two<span class="_ _13"> </span>instructions<span class="_ _13"> </span>have<span class="_ _13"> </span>been<span class="_ _13"> </span>fetched<span class="_ _13"> </span>that<span class="_ _13"> </span>should</div><div class="t m5 x17 h26 y5bb ff7 fs19 fc2 sc0 ls0 ws0">not<span class="_ _13"> </span>continue<span class="_ _13"> </span>being<span class="_"> </span>executed.<span class="_ _13"> </span>F<span class="_ _3"></span>ortunately<span class="_ _3"></span>,<span class="_"> </span>neither<span class="_ _13"> </span>of<span class="_ _13"> </span>these<span class="_ _13"> </span>instructions<span class="_"> </span>has<span class="_ _13"> </span>caused</div><div class="t m5 x17 h26 y5bc ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _13"> </span>change<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>programmer<span class="_ _1"></span>-visible<span class="_ _13"> </span>state<span class="_ _1"></span>.<span class="_ _13"> </span>That<span class="_ _13"> </span>can<span class="_ _13"> </span>only<span class="_ _13"> </span>occur<span class="_ _13"> </span>when<span class="_ _13"> </span>an<span class="_ _13"> </span>instruction</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
