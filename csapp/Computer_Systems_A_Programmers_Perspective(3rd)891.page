<div id="pf37b" class="pf w2 h11" data-page-no="37b"><div class="pc pc37b w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg37b.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">890<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x111 h31 ye7 ff7 fs21 fc2 sc0 ls0 ws0">Minimum<span class="_"> </span>block</div><div class="t m5 x1d h31 y739b ff7 fs21 fc2 sc0 ls0 ws0">Alignment<span class="_ _2e"> </span>Allocated<span class="_"> </span>block<span class="_ _147"> </span>Free<span class="_"> </span>block<span class="_ _8f"> </span>size<span class="_"> </span>(bytes)</div><div class="t m5 x1d h31 y739c ff7 fs21 fc2 sc0 ls0 ws0">Single<span class="_"> </span>word<span class="_ _74"> </span>Header<span class="_"> </span>and<span class="_"> </span>footer<span class="_ _128"> </span>Header<span class="_"> </span>and<span class="_"> </span>footer</div><div class="t m5 x1d h31 y1983 ff7 fs21 fc1 sc0 ls0 ws0">Single<span class="_"> </span>word<span class="_ _74"> </span>Header,<span class="_"> </span>but<span class="_"> </span>no<span class="_"> </span>footer<span class="_ _26"> </span>Header<span class="_"> </span>and<span class="_"> </span>footer</div><div class="t m5 x1d h31 y739d ff7 fs21 fc1 sc0 ls0 ws0">Double<span class="_"> </span>word<span class="_ _26"> </span>Header<span class="_"> </span>and<span class="_"> </span>footer<span class="_ _128"> </span>Header<span class="_"> </span>and<span class="_"> </span>footer</div><div class="t m5 x1d h31 y1808 ff7 fs21 fc1 sc0 ls0 ws0">Double<span class="_"> </span>word<span class="_ _26"> </span>Header,<span class="_"> </span>but<span class="_"> </span>no<span class="_"> </span>footer<span class="_ _26"> </span>Header<span class="_"> </span>and<span class="_"> </span>footer</div><div class="t m5 x1d h41 y739e ffe fs29 fc1 sc0 ls0 ws0">9.9.12<span class="_ _48"> </span><span class="fs19">Putting<span class="_"> </span>It<span class="_"> </span>T<span class="_ _3"></span>ogether:<span class="_"> </span>Implementing<span class="_"> </span>a<span class="_"> </span>Simple<span class="_"> </span>Allocator</span></div><div class="t m5 x1d h26 y739f ff7 fs19 fc1 sc0 ls0 ws0">Building<span class="_ _14"> </span>an<span class="_ _15"> </span>allocator<span class="_ _15"> </span>is<span class="_ _15"> </span>a<span class="_ _15"> </span>challenging<span class="_ _14"> </span>task.<span class="_ _15"> </span>T<span class="_ _0"></span>he<span class="_ _15"> </span>design<span class="_ _14"> </span>space<span class="_ _15"> </span>is<span class="_ _15"> </span>large<span class="_ _0"></span>,<span class="_ _15"> </span>with<span class="_ _15"> </span>nu-</div><div class="t m5 x1d h26 y73a0 ff7 fs19 fc1 sc0 ls0 ws0">merous<span class="_ _16"> </span>alternatives<span class="_ _16"> </span>for<span class="_ _16"> </span>block<span class="_ _16"> </span>format<span class="_ _16"> </span>and<span class="_ _16"> </span>free<span class="_ _16"> </span>list<span class="_ _16"> </span>format,<span class="_ _16"> </span>as<span class="_ _16"> </span>well<span class="_ _16"> </span>as<span class="_ _16"> </span>placement,</div><div class="t m5 x1d h26 y73a1 ff7 fs19 fc1 sc0 ls0 ws0">splitting,<span class="_ _11"> </span>and<span class="_ _16"> </span>coalescing<span class="_ _11"> </span>policies<span class="_ _1"></span>.<span class="_ _16"> </span>Another<span class="_ _11"> </span>challenge<span class="_ _16"> </span>is<span class="_ _11"> </span>that<span class="_ _11"> </span>you<span class="_ _16"> </span>are<span class="_ _11"> </span>often<span class="_ _16"> </span>forced</div><div class="t m5 x1d h26 y73a2 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _11"> </span>program<span class="_ _16"> </span>outside<span class="_ _11"> </span>the<span class="_ _16"> </span>safe<span class="_ _0"></span>,<span class="_ _16"> </span>familiar<span class="_ _11"> </span>conﬁnes<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>type<span class="_ _11"> </span>system,<span class="_ _16"> </span>relying<span class="_ _16"> </span>on<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y73a3 ff7 fs19 fc1 sc0 ls0 ws0">error<span class="_ _1"></span>-prone<span class="_"> </span>pointer<span class="_"> </span>casting<span class="_ _13"> </span>and<span class="_"> </span>pointer<span class="_"> </span>arithmetic<span class="_"> </span>that<span class="_"> </span>is<span class="_ _13"> </span>typical<span class="_"> </span>of<span class="_"> </span>low-level<span class="_"> </span>sys-</div><div class="t m5 x1d h26 y73a4 ff7 fs19 fc1 sc0 ls0 ws0">tems<span class="_"> </span>programming.</div><div class="t m5 x29 h26 y73a5 ff7 fs19 fc1 sc0 ls0 ws0">While<span class="_ _11"> </span>allocators<span class="_ _16"> </span>do<span class="_ _11"> </span>not<span class="_ _16"> </span>require<span class="_ _16"> </span>enormous<span class="_ _16"> </span>amounts<span class="_ _11"> </span>of<span class="_ _16"> </span>code<span class="_ _1"></span>,<span class="_ _16"> </span>they<span class="_ _16"> </span>are<span class="_ _16"> </span>subtle</div><div class="t m5 x1d h26 y73a6 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _13"> </span>unforgiving<span class="_ _1"></span>.<span class="_ _13"> </span>Students<span class="_ _6"> </span>familiar<span class="_ _13"> </span>with<span class="_ _6"> </span>higher<span class="_ _1"></span>-level<span class="_ _13"> </span>languages<span class="_ _6"> </span>such<span class="_ _13"> </span>as<span class="_ _6"> </span>C++<span class="_ _13"> </span>or<span class="_ _13"> </span>J<span class="_ _7"></span>ava</div><div class="t m5 x1d h26 y73a7 ff7 fs19 fc1 sc0 ls0 ws0">often<span class="_ _13"> </span>hit<span class="_ _6"> </span>a<span class="_ _13"> </span>conceptual<span class="_ _13"> </span>wall<span class="_ _6"> </span>when<span class="_ _13"> </span>they<span class="_ _13"> </span>ﬁrst<span class="_ _6"> </span>encounter<span class="_ _13"> </span>this<span class="_ _13"> </span>style<span class="_ _6"> </span>of<span class="_ _13"> </span>programming<span class="_ _0"></span>.<span class="_ _13"> </span>T<span class="_ _7"></span>o</div><div class="t m5 x1d h26 y73a8 ff7 fs19 fc1 sc0 ls0 ws0">help<span class="_ _11"> </span>you<span class="_ _11"> </span>clear<span class="_ _11"> </span>this<span class="_ _11"> </span>hurdle<span class="_ _0"></span>,<span class="_ _11"> </span>we<span class="_ _11"> </span>will<span class="_ _11"> </span>work<span class="_ _11"> </span>through<span class="_ _11"> </span>the<span class="_ _16"> </span>implementation<span class="_"> </span>of<span class="_ _11"> </span>a<span class="_ _11"> </span>simple</div><div class="t m5 x1d h26 y73a9 ff7 fs19 fc1 sc0 ls0 ws0">allocator<span class="_ _11"> </span>based<span class="_ _16"> </span>on<span class="_ _16"> </span>an<span class="_ _11"> </span>implicit<span class="_ _16"> </span>free<span class="_ _16"> </span>list<span class="_ _11"> </span>with<span class="_ _16"> </span>immediate<span class="_ _16"> </span>boundary-tag<span class="_ _11"> </span>coalescing.</div><div class="t m5 x1d h26 y73aa ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>maximum<span class="_"> </span>block<span class="_"> </span>size<span class="_"> </span>is<span class="_"> </span>2</div><div class="t m5 xe4 h3c y73ab ff7 fs25 fc1 sc0 ls0 ws0">32</div><div class="t m5 x7b h46 y73ac ff12 fs19 fc1 sc0 ls0 ws0">=<span class="_ _13"> </span><span class="ff7">4<span class="_"> </span>GB.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>code<span class="_"> </span>is<span class="_"> </span>64-bit<span class="_"> </span>clean,<span class="_ _13"> </span>running<span class="_"> </span>without</span></div><div class="t m5 x1d h26 y73ad ff7 fs19 fc1 sc0 ls0 ws0">modiﬁcation<span class="_"> </span>in<span class="_"> </span>32-bit<span class="_"> </span>(<span class="ffd">gcc<span class="_ _11"> </span>-m32</span>)<span class="_"> </span>or<span class="_"> </span>64-bit<span class="_"> </span>(<span class="ffd">gcc<span class="_ _16"> </span>-m64</span>)<span class="_"> </span>processes<span class="_ _1"></span>.</div><div class="t m5 x1d h42 y73ae ff6 fs29 fc6 sc0 ls0 ws0">General<span class="_ _11"> </span>Allocator<span class="_ _16"> </span>Design</div><div class="t m5 x1d h26 y73af ff7 fs19 fc1 sc0 ls0 ws0">Our<span class="_ _15"> </span>allocator<span class="_ _21"> </span>uses<span class="_ _21"> </span>a<span class="_ _21"> </span>model<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>memory<span class="_ _21"> </span>system<span class="_ _21"> </span>provided<span class="_ _15"> </span>by<span class="_ _21"> </span>the<span class="_ _21"> </span><span class="ffd">memlib.c</span></div><div class="t m5 x1d h26 y73b0 ff7 fs19 fc1 sc0 ls0 ws0">package<span class="_ _14"> </span>shown<span class="_ _15"> </span>in<span class="_ _14"> </span>Figure<span class="_ _14"> </span>9.41.<span class="_ _14"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>purpose<span class="_ _15"> </span>of<span class="_ _14"> </span>the<span class="_ _15"> </span>model<span class="_ _14"> </span>is<span class="_ _15"> </span>to<span class="_ _15"> </span>allow<span class="_ _14"> </span>us<span class="_ _15"> </span>to<span class="_ _14"> </span>run</div><div class="t m5 x1d h26 y73b1 ff7 fs19 fc1 sc0 ls0 ws0">our<span class="_"> </span>allocator<span class="_"> </span>without<span class="_"> </span>interfering<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span>existing<span class="_"> </span>system-level<span class="_"> </span><span class="ffd">malloc<span class="_ _10"> </span></span>package<span class="_ _0"></span>.</div><div class="t m5 x29 h26 y73b2 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _11"> </span><span class="ffd ls0">mem_init<span class="_ _10"> </span><span class="ff7">function<span class="_"> </span>models<span class="_"> </span>the<span class="_"> </span>virtual<span class="_ _13"> </span>memory<span class="_"> </span>available<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>heap<span class="_ _13"> </span>as<span class="_"> </span>a</span></span></div><div class="t m5 x1d h26 y73b3 ff7 fs19 fc1 sc0 ls0 ws0">large<span class="_"> </span>double-word<span class="_"> </span>aligned<span class="_"> </span>array<span class="_"> </span>of<span class="_"> </span>bytes<span class="_ _3"></span>.<span class="_"> </span>The<span class="_"> </span>bytes<span class="_"> </span>between<span class="_ _13"> </span><span class="ffd">mem_heap<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ffd">mem_</span></div><div class="t m5 x1d h26 y73b4 ffd fs19 fc1 sc0 ls0 ws0">brk<span class="_ _16"> </span><span class="ff7">represent<span class="_ _11"> </span>allocated<span class="_ _16"> </span>virtual<span class="_ _16"> </span>memory<span class="_ _3"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>bytes<span class="_ _16"> </span>following<span class="_ _11"> </span><span class="ffd">mem_brk<span class="_ _16"> </span></span>represent</span></div><div class="t m5 x1d h26 y73b5 ff7 fs19 fc1 sc0 ls0 ws0">unallocated<span class="_ _16"> </span>virtual<span class="_ _16"> </span>memory<span class="_ _3"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>allocator<span class="_ _16"> </span>requests<span class="_ _16"> </span>additional<span class="_ _16"> </span>heap<span class="_ _16"> </span>memory<span class="_ _16"> </span>by</div><div class="t m5 x1d h26 y73b6 ff7 fs19 fc1 sc0 ls0 ws0">calling<span class="_"> </span>the<span class="_"> </span><span class="ffd">mem_sbrk<span class="_ _11"> </span></span>function,<span class="_"> </span>which<span class="_"> </span>has<span class="_"> </span>the<span class="_ _11"> </span>same<span class="_"> </span>interface<span class="_"> </span>as<span class="_ _11"> </span>the<span class="_"> </span>system’s<span class="_"> </span><span class="ffd">sbrk</span></div><div class="t m5 x1d h26 y73b7 ff7 fs19 fc1 sc0 ls0 ws0">function,<span class="_ _16"> </span>as<span class="_ _16"> </span>well<span class="_ _16"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span>same<span class="_ _16"> </span>semantics<span class="_ _1"></span>,<span class="_ _14"> </span>except<span class="_ _16"> </span>that<span class="_ _16"> </span>it<span class="_ _16"> </span>rejects<span class="_ _16"> </span>requests<span class="_ _16"> </span>to<span class="_ _16"> </span>shrink</div><div class="t m5 x1d h26 y73b8 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>heap<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y73b9 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>allocator<span class="_"> </span>itself<span class="_"> </span>is<span class="_"> </span>contained<span class="_"> </span>in<span class="_"> </span>a<span class="_ _13"> </span>source<span class="_"> </span>ﬁle<span class="_"> </span>(<span class="ffd">mm.c</span>)<span class="_"> </span>that<span class="_"> </span>users<span class="_"> </span>can<span class="_"> </span>compile</div><div class="t m5 x1d h26 y73ba ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>link<span class="_ _11"> </span>into<span class="_ _11"> </span>their<span class="_ _11"> </span>applications<span class="_ _1"></span>.<span class="_"> </span>The<span class="_"> </span>allocator<span class="_"> </span>exports<span class="_ _11"> </span>three<span class="_ _11"> </span>functions<span class="_ _11"> </span>to<span class="_"> </span>applica-</div><div class="t m5 x1d h26 y73bb ff7 fs19 fc1 sc0 ls0 ws0">tion<span class="_"> </span>programs:</div><div class="t m5 x1f h2d y73bc ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">extern<span class="_ _1f"> </span>int<span class="_ _e"> </span>mm_init(void);</span></div><div class="t m5 x1f h2d y73bd ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">extern<span class="_ _1f"> </span>void<span class="_ _e"> </span>*mm_malloc<span class="_ _1f"> </span>(size_t<span class="_ _1f"> </span>size);</span></div><div class="t m5 x1f h2d y73be ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">extern<span class="_ _1f"> </span>void<span class="_ _e"> </span>mm_free<span class="_ _1f"> </span>(void<span class="_ _1f"> </span>*ptr);</span></div><div class="t m5 x29 h26 y7a6 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _15"> </span><span class="ffd ls0">mm_init<span class="_ _14"> </span><span class="ff7">function<span class="_ _16"> </span>initializes<span class="_ _14"> </span>the<span class="_ _14"> </span>allocator,<span class="_ _14"> </span>returning<span class="_ _14"> </span>0<span class="_ _16"> </span>if<span class="_ _14"> </span>successful<span class="_ _14"> </span>and</span></span></div><div class="t m5 x1d h46 y7a7 ff12 fs19 fc2 sc0 ls0 ws0">−<span class="ff7">1<span class="_ _16"> </span>otherwise<span class="_ _1"></span>.<span class="_ _14"> </span>The<span class="_ _16"> </span><span class="ffd">mm_malloc<span class="_ _15"> </span></span>and<span class="_ _14"> </span><span class="ffd">mm_free<span class="_ _14"> </span></span>functions<span class="_ _15"> </span>have<span class="_ _14"> </span>the<span class="_ _14"> </span>same<span class="_ _15"> </span>interfaces</span></div><div class="t m5 x1d h26 y7a8 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _11"> </span>semantics<span class="_ _16"> </span>as<span class="_ _16"> </span>their<span class="_ _11"> </span>system<span class="_ _16"> </span>counterparts<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>allocator<span class="_ _11"> </span>uses<span class="_ _16"> </span>the<span class="_ _16"> </span>block<span class="_ _11"> </span>format</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
