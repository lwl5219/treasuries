<div id="pf12d" class="pf w2 h11" data-page-no="12d"><div class="pc pc12d w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg12d.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">300<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x14 h34 ye7 ff6 fs16 fc2 sc0 ls0 ws0">(a)<span class="_ _10"> </span>Original<span class="_ _11"> </span>C<span class="_ _10"> </span>code</div><div class="t m5 xb h2d y2283 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Compute<span class="_ _e"> </span>i,k<span class="_ _1f"> </span>of<span class="_ _1f"> </span>variable<span class="_ _e"> </span>matrix<span class="_ _1f"> </span>product<span class="_ _e"> </span>*/</span></div><div class="t m5 xb h2d y2b70 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>var_prod_ele(long<span class="_ _e"> </span>n,<span class="_ _1f"> </span>int<span class="_ _1f"> </span>A[n][n],<span class="_ _e"> </span>int<span class="_ _1f"> </span>B[n][n],<span class="_ _e"> </span>long<span class="_ _1f"> </span>i,<span class="_ _1f"> </span>long<span class="_ _e"> </span>k)<span class="_ _1f"> </span>{</span></div><div class="t m5 xb h2d yc51 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>j;</span></div><div class="t m5 xb h2d y28e5 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>result<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;</span></div><div class="t m5 xb h2e y28e6 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 xb h2e y2b71 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x26 h2d ye9d ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>j=0<span class="_ _41"></span>;j&lt;n<span class="_ _41"></span>;<span class="ls0">j++)</span></div><div class="t m5 xb h2d y28e8 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _70"> </span><span class="ffd fs1e fc2">result<span class="_ _e"> </span>+=<span class="_ _1f"> </span>A[i][j]<span class="_ _1f"> </span>*<span class="_ _e"> </span>B[j][k];</span></div><div class="t m5 xb h2e y28e9 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 xb h2e y2b72 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x26 h2d y1814 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>result;</div><div class="t m5 x14 h2d y28ea ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h34 y2b2c ff6 fs16 fc2 sc0 ls0 ws0">(b)<span class="_ _10"> </span>Optimized<span class="_ _11"> </span>C<span class="_ _10"> </span>code</div><div class="t m5 x14 h2d y228c ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Compute<span class="_ _1f"> </span>i,k<span class="_ _1f"> </span>of<span class="_ _e"> </span>variable<span class="_ _1f"> </span>matrix<span class="_ _e"> </span>product<span class="_ _1f"> </span>*/</div><div class="t m5 x14 h2d y2b73 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>var_prod_ele_opt(long<span class="_ _1f"> </span>n,<span class="_ _1f"> </span>int<span class="_ _e"> </span>A[n][n],<span class="_ _1f"> </span>int<span class="_ _e"> </span>B[n][n],<span class="_ _1f"> </span>long<span class="_ _1f"> </span>i,<span class="_ _e"> </span>long<span class="_ _1f"> </span>k)<span class="_ _e"> </span>{</div><div class="t m5 xc8 h2d y2b74 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>*Arow<span class="_ _1f"> </span>=<span class="_ _1f"> </span>A[i];</div><div class="t m5 xc8 h2d y2b75 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>*Bptr<span class="_ _1f"> </span>=<span class="_ _1f"> </span>&amp;B[0][k];</div><div class="t m5 xc8 h2d y2b76 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>result<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;</div><div class="t m5 xc8 h2d y2b77 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>j;</div><div class="t m5 xc8 h2d y2b78 ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>j=0<span class="_ _41"></span>;j&lt;n<span class="_ _41"></span>;<span class="ls0">j++)<span class="_ _e"> </span>{</span></div><div class="t m5 x63 h2d y2b79 ffd fs1e fc2 sc0 ls0 ws0">result<span class="_ _e"> </span>+=<span class="_ _1f"> </span>Arow[j]<span class="_ _1f"> </span>*<span class="_ _e"> </span>*Bptr;</div><div class="t m5 x63 h2d y2b7a ffd fs1e fc2 sc0 ls0 ws0">Bptr<span class="_ _e"> </span>+=<span class="_ _1f"> </span>n;</div><div class="t m5 xc8 h2d y2b7b ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 xc8 h2d y2b7c ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>result;</div><div class="t m5 x14 h2d y2b7d ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x14 h2f y2b7e ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _11"> </span>3.38<span class="_ _c"> </span><span class="fc1">Original<span class="_ _11"> </span>and<span class="_ _11"> </span>optimized<span class="_ _16"> </span>code<span class="_"> </span>to<span class="_ _11"> </span>compute<span class="_ _16"> </span>element<span class="_"> </span><span class="ff11 ls178">i,<span class="_ _13"> </span>k<span class="_ _16"> </span></span>of<span class="_ _16"> </span>matrix<span class="_"> </span>product<span class="_ _11"> </span>for<span class="_ _16"> </span>variable-size</span></div><div class="t m5 x14 h34 y2b7f ffe fs16 fc1 sc0 ls0 ws0">arrays.<span class="_"> </span><span class="ff6">The<span class="_ _10"> </span>compiler<span class="_ _11"> </span>performs<span class="_ _10"> </span>these<span class="_ _11"> </span>optimizations<span class="_ _10"> </span>automatically<span class="_ _1"></span>.</span></div><div class="t m5 x1d h26 y2b80 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>loop<span class="_ _11"> </span>has<span class="_ _11"> </span>terminated<span class="_ _16"> </span>and<span class="_"> </span>to<span class="_ _16"> </span>index<span class="_"> </span>into<span class="_ _16"> </span>an<span class="_"> </span>array<span class="_ _16"> </span>consisting<span class="_"> </span>of<span class="_ _16"> </span>the<span class="_"> </span>elements<span class="_ _16"> </span>of</div><div class="t m5 x1d h26 y2b81 ff7 fs19 fc1 sc0 ls0 ws0">row<span class="_"> </span><span class="ff11">i<span class="_"> </span></span>of<span class="_"> </span><span class="ffd">A</span>.</div><div class="t m5 x29 h26 y2b82 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>following<span class="_"> </span>is<span class="_"> </span>the<span class="_"> </span>assembly<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>loop<span class="_"> </span>of<span class="_"> </span><span class="ffd">var_prod_ele</span>:</div><div class="t m5 xad h61 y2b83 ff13 fs35 fc6 sc0 ls0 ws0">Registers:<span class="_ _f"> </span>n<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _e"> </span>Arow<span class="_ _21"> </span>in<span class="_ _f"> </span>%rsi,<span class="_ _e"> </span>Bptr<span class="_ _21"> </span>in<span class="_ _f"> </span>%rcx</div><div class="t m5 x76 h61 y2b84 ff13 fs35 fc6 sc0 ls0 ws0">4n<span class="_ _f"> </span>in<span class="_ _f"> </span>%r9,<span class="_ _f"> </span>result<span class="_ _e"> </span>in<span class="_ _21"> </span>%eax,<span class="_ _f"> </span>j<span class="_ _e"> </span>in<span class="_ _21"> </span>%edx</div><div class="t m5 x1f h2e yb96 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x4f h2d y2b85 ffd fs1e fc2 sc0 ls0 ws0">.L24:<span class="_ _170"> </span><span class="ff2d fs35 fc6">loop:</span></div><div class="t m5 x1f h2d y2b86 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">movl<span class="_ _46"> </span>(%rsi,%rdx,4),<span class="_ _e"> </span>%r8d<span class="_ _10d"> </span></span><span class="ff13 fs35">Read<span class="_ _e"> </span>Arow[j]</span></div><div class="t m5 x1f h2d y2b87 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">imull<span class="_ _3f"> </span>(%rcx),<span class="_ _e"> </span>%r8d<span class="_ _15f"> </span></span><span class="ff13 fs35">Multiply<span class="_ _f"> </span>by<span class="_ _f"> </span>*Bptr</span></div><div class="t m5 x1f h2d y2b88 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">addl<span class="_ _46"> </span>%r8d,<span class="_ _e"> </span>%eax<span class="_ _171"> </span></span><span class="ff13 fs35">Add<span class="_ _f"> </span>to<span class="_ _f"> </span>result</span></div><div class="t m5 x1f h2d y2b89 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$1,<span class="_ _e"> </span>%rdx<span class="_ _172"> </span></span><span class="ff13 fs35">j++</span></div><div class="t m5 x1f h2d y2b8a ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>%r9,<span class="_ _e"> </span>%rcx<span class="_ _151"> </span></span><span class="ff13 fs35">Bptr<span class="_ _21"> </span>+=<span class="_ _f"> </span>n</span></div><div class="t m5 x1f h2d y2b8b ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _45"> </span><span class="ffd fs1e fc2">cmpq<span class="_ _46"> </span>%rdi,<span class="_ _e"> </span>%rdx<span class="_ _171"> </span></span><span class="ff13 fs35">Compare<span class="_ _f"> </span>j:n</span></div><div class="t m5 x1f h2d y2b8c ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">jne<span class="_ _8c"> </span>.L24<span class="_ _d2"> </span></span><span class="ff13 fs35">If<span class="_ _21"> </span>!=,<span class="_ _e"> </span>goto<span class="_ _21"> </span><span class="ff2d">loop</span></span></div><div class="t m5 x1d h26 y6e1 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _16"> </span>see<span class="_ _16"> </span>that<span class="_ _11"> </span>the<span class="_ _16"> </span>program<span class="_ _16"> </span>makes<span class="_ _16"> </span>use<span class="_ _11"> </span>of<span class="_ _16"> </span>both<span class="_ _16"> </span>a<span class="_ _16"> </span>scaled<span class="_ _11"> </span>value<span class="_ _16"> </span>4<span class="ff11">n<span class="_"> </span></span>(register<span class="_ _11"> </span><span class="ffd">%r9</span>)<span class="_ _16"> </span>for</div><div class="t m5 x1d h26 y6e2 ff7 fs19 fc2 sc0 ls0 ws0">incrementing<span class="_ _15"> </span><span class="ffd">Bptr<span class="_ _15"> </span></span>as<span class="_ _21"> </span>well<span class="_ _15"> </span>as<span class="_ _21"> </span>the<span class="_ _15"> </span>value<span class="_ _15"> </span>of<span class="_ _21"> </span><span class="ff11">n<span class="_ _15"> </span></span>(register<span class="_ _21"> </span><span class="ffd">%rdi</span>)<span class="_ _15"> </span>to<span class="_ _15"> </span>check<span class="_ _21"> </span>the<span class="_ _15"> </span>loop</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
