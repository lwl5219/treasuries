<div id="pf34f" class="pf w2 h11" data-page-no="34f"><div class="pc pc34f w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg34f.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">846<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x14 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.8</div><div class="t m5 x14 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Allocating<span class="_ _11"> </span>a<span class="_ _16"> </span>new<span class="_ _11"> </span>virtual</div><div class="t m5 x14 h34 y58b ffe fs16 fc1 sc0 ls0 ws0">page.<span class="_"> </span><span class="ff6">The<span class="_ _11"> </span>kernel<span class="_ _11"> </span>allocates</span></div><div class="t m5 x14 h34 y58c ff6 fs16 fc1 sc0 ls0 ws0">VP<span class="_ _13"> </span>5<span class="_ _10"> </span>on<span class="_ _13"> </span>disk<span class="_ _13"> </span>and<span class="_ _10"> </span>points<span class="_ _13"> </span>PTE</div><div class="t m5 x14 h34 y58d ff6 fs16 fc1 sc0 ls0 ws0">5<span class="_ _10"> </span>to<span class="_ _11"> </span>this<span class="_ _10"> </span>new<span class="_ _10"> </span>location.</div><div class="t m5 xe0 h3f y6d30 ffa9 fs27 fc1 sc0 ls0 ws0">PTE 0</div><div class="t m5 x111 h3f y6d31 ffa9 fs27 fc1 sc0 ls0 ws0">PP 0</div><div class="t m5 x111 h3f y6d32 ffa9 fs27 fc1 sc0 ls0 ws0">PP 3</div><div class="t m5 xf1 h3f y6d33 ffa9 fs27 fc1 sc0 ls0 ws0">1</div><div class="t m5 xf1 h3f y6d34 ffa9 fs27 fc1 sc0 ls0 ws0">1</div><div class="t m5 xf1 h3f y6d35 ffa9 fs27 fc1 sc0 ls0 ws0">1</div><div class="t m5 xf1 h3f y6d36 ffa9 fs27 fc1 sc0 ls0 ws0">0</div><div class="t m5 xf1 h3f y6d37 ffa9 fs27 fc1 sc0 ls0 ws0">0</div><div class="t m5 xf1 h3f y6d38 ffa9 fs27 fc1 sc0 ls0 ws0">0</div><div class="t m5 xf1 h3f y6d39 ffa9 fs27 fc1 sc0 ls0 ws0">1</div><div class="t m5 xf1 h3f y6d3a ffa9 fs27 fc1 sc0 ls0 ws0">0</div><div class="t m5 xe0 h3f y6d3b ffa9 fs27 fc1 sc0 ls0 ws0">PTE 7</div><div class="t m5 xe5 h3f y6d3c ffa9 fs27 fc1 sc0 ls0 ws0">Null</div><div class="t m5 xb9 h3f y6d39 ffa9 fs27 fc1 sc0 ls0 ws0">VP 1</div><div class="t m5 xb9 h3f y6d3d ffa9 fs27 fc1 sc0 ls0 ws0">VP 3</div><div class="t m5 xb9 h3f y6d3e ffa9 fs27 fc1 sc0 ls0 ws0">VP 7</div><div class="t m5 xb9 h3f y6d3f ffa9 fs27 fc1 sc0 ls0 ws0">VP 2</div><div class="t m5 xb9 h3f y6d40 ffa9 fs27 fc1 sc0 ls0 ws0">VP 1</div><div class="t m5 xb9 h3f y6d41 ffa9 fs27 fc1 sc0 ls0 ws0">VP 2</div><div class="t m5 xb9 h3f y6d42 ffa9 fs27 fc1 sc0 ls0 ws0">VP 3</div><div class="t m5 xb9 h3f y6d43 ffa9 fs27 fc1 sc0 ls0 ws0">VP 4</div><div class="t m5 xb9 h3f y6d44 ffa9 fs27 fc1 sc0 ls0 ws0">VP 5</div><div class="t m5 xb9 h3f y6d45 ffa9 fs27 fc1 sc0 ls0 ws0">VP 6</div><div class="t m5 xb9 h3f y6d46 ffa9 fs27 fc1 sc0 ls0 ws0">VP 7</div><div class="t m5 x91 h3f y6d47 ffaa fs27 fc1 sc0 ls0 ws0">Physical page</div><div class="t m5 x167 h3f y6d48 ffaa fs27 fc1 sc0 ls0 ws0">number or</div><div class="t m5 x18d h3f y6d49 ffaa fs27 fc1 sc0 ls0 ws0">disk address</div><div class="t m5 x183 h3f y6d4a ffa9 fs27 fc1 sc0 ls0 ws0">Memory-resident</div><div class="t m5 x1b2 h3f y6d4b ffa9 fs27 fc1 sc0 ls0 ws0">page table</div><div class="t m5 x115 h3f y6d4c ffa9 fs27 fc1 sc0 ls0 ws0">(DRAM)</div><div class="t m5 xff h3f y6d4d ffa9 fs27 fc1 sc0 ls0 ws0">Virtual memory</div><div class="t m5 x1a1 h3f y6d4e ffa9 fs27 fc1 sc0 ls0 ws0">(disk)</div><div class="t m5 x18b h3f y6d4f ffa9 fs27 fc1 sc0 ls0 ws0">Physical memory</div><div class="t m5 xda h3f y6d50 ffa9 fs27 fc1 sc0 ls0 ws0">(DRAM)</div><div class="t m5 x235 h3f y6d51 ffaa fs27 fc1 sc0 ls0 ws0">V<span class="_ _1"></span>alid</div><div class="t m5 x1d h26 y6d52 ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_ _13"> </span>a<span class="_ _13"> </span>page<span class="_ _1"></span>,<span class="_ _13"> </span>when<span class="_ _13"> </span>a<span class="_ _13"> </span>miss<span class="_ _6"> </span>occurs<span class="_ _1"></span>,<span class="_ _13"> </span>is<span class="_ _13"> </span>known<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ffa">demand<span class="_ _13"> </span>paging</span>.<span class="_ _13"> </span>Other<span class="_ _13"> </span>approaches<span class="_ _3"></span>,<span class="_ _13"> </span>such</div><div class="t m5 x1d h26 y6d53 ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_"> </span>trying<span class="_"> </span>to<span class="_"> </span>predict<span class="_ _13"> </span>misses<span class="_"> </span>and<span class="_"> </span>swap<span class="_"> </span>pages<span class="_"> </span>in<span class="_"> </span>before<span class="_"> </span>they<span class="_ _13"> </span>are<span class="_"> </span>actually<span class="_"> </span>referenced,</div><div class="t m5 x1d h26 y6d54 ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_"> </span>possible<span class="_ _1"></span>.<span class="_"> </span>However,<span class="_"> </span>all<span class="_"> </span>modern<span class="_"> </span>systems<span class="_"> </span>use<span class="_"> </span>demand<span class="_"> </span>paging.</div><div class="t m5 x1d h41 y6d55 ffe fs29 fc1 sc0 ls0 ws0">9.3.5<span class="_ _48"> </span><span class="fs19">Allocating<span class="_"> </span>Pages</span></div><div class="t m5 x1d h26 y6d56 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>9.8<span class="_"> </span>shows<span class="_ _13"> </span>the<span class="_"> </span>effect<span class="_ _13"> </span>on<span class="_"> </span>our<span class="_ _13"> </span>example<span class="_"> </span>page<span class="_ _13"> </span>table<span class="_"> </span>when<span class="_"> </span>the<span class="_ _13"> </span>operating<span class="_"> </span>system</div><div class="t m5 x1d h26 y6d57 ff7 fs19 fc1 sc0 ls0 ws0">allocates<span class="_ _6"> </span>a<span class="_ _13"> </span>new<span class="_ _6"> </span>page<span class="_ _13"> </span>of<span class="_ _6"> </span>virtual<span class="_ _6"> </span>memory—for<span class="_ _13"> </span>example<span class="_ _1"></span>,<span class="_ _13"> </span>as<span class="_ _6"> </span>a<span class="_ _13"> </span>result<span class="_ _6"> </span>of<span class="_ _13"> </span>calling<span class="_ _6"> </span><span class="ffd">malloc</span>.</div><div class="t m5 x1d h26 y6d58 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _11"> </span>the<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _16"> </span>VP<span class="_ _11"> </span>5<span class="_ _11"> </span>is<span class="_ _16"> </span>allocated<span class="_ _11"> </span>by<span class="_ _11"> </span>creating<span class="_ _16"> </span>room<span class="_ _11"> </span>on<span class="_ _16"> </span>disk<span class="_ _11"> </span>and<span class="_ _11"> </span>updating<span class="_ _16"> </span>PTE<span class="_ _11"> </span>5</div><div class="t m5 x1d h26 y6d59 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>point<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>newly<span class="_"> </span>created<span class="_"> </span>page<span class="_"> </span>on<span class="_"> </span>disk.</div><div class="t m5 x1d h41 y6d5a ffe fs29 fc1 sc0 ls0 ws0">9.3.6</div><div class="t m5 x8c h43 y322c ffe fs19 fc1 sc0 ls0 ws0">Locality<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>Rescue<span class="_"> </span>Again</div><div class="t m5 x1d h26 y7fe ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_"> </span>many<span class="_ _11"> </span>of<span class="_ _16"> </span>us<span class="_ _11"> </span>learn<span class="_ _11"> </span>about<span class="_ _11"> </span>the<span class="_ _11"> </span>idea<span class="_ _16"> </span>of<span class="_ _11"> </span>virtual<span class="_ _11"> </span>memory<span class="_ _3"></span>,<span class="_ _11"> </span>our<span class="_ _16"> </span>ﬁrst<span class="_"> </span>impression<span class="_ _16"> </span>is</div><div class="t m5 x1d h26 y7ff ff7 fs19 fc1 sc0 ls0 ws0">often<span class="_"> </span>that<span class="_"> </span>it<span class="_"> </span>must<span class="_"> </span>be<span class="_"> </span>terribly<span class="_"> </span>inefﬁcient.<span class="_"> </span>Given<span class="_"> </span>the<span class="_"> </span>large<span class="_"> </span>miss<span class="_"> </span>penalties<span class="_ _3"></span>,<span class="_"> </span>we<span class="_"> </span>worry</div><div class="t m5 x1d h26 y800 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_"> </span>paging<span class="_ _13"> </span>will<span class="_"> </span>destroy<span class="_ _13"> </span>program<span class="_"> </span>performance<span class="_ _3"></span>.<span class="_"> </span>In<span class="_"> </span>practice<span class="_ _3"></span>,<span class="_"> </span>virtual<span class="_"> </span>memory<span class="_ _13"> </span>works</div><div class="t m5 x1d h26 y801 ff7 fs19 fc1 sc0 ls0 ws0">well,<span class="_"> </span>mainly<span class="_"> </span>because<span class="_"> </span>of<span class="_"> </span>our<span class="_"> </span>old<span class="_"> </span>friend<span class="_"> </span><span class="ffa">locality</span>.</div><div class="t m5 x29 h26 y802 ff7 fs19 fc1 sc0 ls0 ws0">Although<span class="_ _6"> </span>the<span class="_ _6"> </span>total<span class="_ _6"> </span>number<span class="_ _6"> </span>of<span class="_ _13"> </span>distinct<span class="_ _a"> </span>pages<span class="_ _6"> </span>that<span class="_ _6"> </span>programs<span class="_ _13"> </span>reference<span class="_ _a"> </span>during<span class="_ _6"> </span>an</div><div class="t m5 x1d h26 y803 ff7 fs19 fc1 sc0 ls0 ws0">entire<span class="_ _13"> </span>run<span class="_"> </span>might<span class="_ _13"> </span>exceed<span class="_ _13"> </span>the<span class="_"> </span>total<span class="_ _13"> </span>size<span class="_ _13"> </span>of<span class="_ _13"> </span>physical<span class="_"> </span>memory<span class="_ _7"></span>,<span class="_"> </span>the<span class="_ _13"> </span>principle<span class="_ _13"> </span>of<span class="_"> </span>locality</div><div class="t m5 x1d h26 y804 ff7 fs19 fc1 sc0 ls0 ws0">promises<span class="_"> </span>that<span class="_ _13"> </span>at<span class="_"> </span>any<span class="_ _13"> </span>point<span class="_"> </span>in<span class="_"> </span>time<span class="_ _13"> </span>they<span class="_"> </span>will<span class="_ _13"> </span>tend<span class="_"> </span>to<span class="_"> </span>work<span class="_ _13"> </span>on<span class="_"> </span>a<span class="_ _13"> </span>smaller<span class="_"> </span>set<span class="_"> </span>of<span class="_ _13"> </span><span class="ffa">active</span></div><div class="t m5 x1d h26 y805 ffa fs19 fc1 sc0 ls0 ws0">pages<span class="_ _16"> </span><span class="ff7">known<span class="_ _16"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span></span>working<span class="_ _16"> </span>set<span class="_ _15"> </span><span class="ff7">or<span class="_ _16"> </span></span>resident<span class="_ _16"> </span>set<span class="_ _2"></span><span class="ff7">.<span class="_ _16"> </span>After<span class="_ _16"> </span>an<span class="_ _16"> </span>initial<span class="_ _16"> </span>overhead<span class="_ _16"> </span>where</span></div><div class="t m5 x1d h26 y806 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>working<span class="_ _11"> </span>set<span class="_ _11"> </span>is<span class="_ _16"> </span>paged<span class="_ _11"> </span>into<span class="_ _11"> </span>memory<span class="_ _3"></span>,<span class="_ _11"> </span>subsequent<span class="_ _16"> </span>references<span class="_"> </span>to<span class="_ _16"> </span>the<span class="_"> </span>working<span class="_ _16"> </span>set</div><div class="t m5 x1d h26 y807 ff7 fs19 fc1 sc0 ls0 ws0">result<span class="_"> </span>in<span class="_"> </span>hits<span class="_ _1"></span>,<span class="_"> </span>with<span class="_"> </span>no<span class="_"> </span>additional<span class="_"> </span>disk<span class="_"> </span>trafﬁc.</div><div class="t m5 x29 h26 y808 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _13"> </span>long<span class="_ _13"> </span>as<span class="_ _6"> </span>our<span class="_ _13"> </span>programs<span class="_ _13"> </span>have<span class="_ _13"> </span>good<span class="_ _13"> </span>temporal<span class="_ _13"> </span>locality<span class="_ _7"></span>,<span class="_ _13"> </span>virtual<span class="_ _13"> </span>memory<span class="_ _13"> </span>systems</div><div class="t m5 x1d h26 y809 ff7 fs19 fc1 sc0 ls0 ws0">work<span class="_"> </span>quite<span class="_ _13"> </span>well.<span class="_"> </span>But<span class="_ _13"> </span>of<span class="_"> </span>course<span class="_ _0"></span>,<span class="_"> </span>not<span class="_ _13"> </span>all<span class="_"> </span>programs<span class="_"> </span>exhibit<span class="_ _13"> </span>good<span class="_"> </span>temporal<span class="_ _13"> </span>locality<span class="_ _3"></span>.<span class="_"> </span>If</div><div class="t m5 x1d h26 y80a ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>working<span class="_ _16"> </span>set<span class="_ _16"> </span>size<span class="_ _11"> </span>exceeds<span class="_ _16"> </span>the<span class="_ _16"> </span>size<span class="_ _11"> </span>of<span class="_ _16"> </span>physical<span class="_ _11"> </span>memory<span class="_ _3"></span>,<span class="_ _16"> </span>then<span class="_ _16"> </span>the<span class="_ _11"> </span>program<span class="_ _16"> </span>can</div><div class="t m5 x1d h26 y80b ff7 fs19 fc1 sc0 ls0 ws0">produce<span class="_ _13"> </span>an<span class="_ _6"> </span>unfortunate<span class="_ _13"> </span>situation<span class="_ _6"> </span>known<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ffa">thrashing</span>,<span class="_ _13"> </span>where<span class="_ _13"> </span>pages<span class="_ _6"> </span>are<span class="_ _13"> </span>swapped<span class="_ _13"> </span>in</div><div class="t m5 x1d h26 y80c ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _13"> </span>out<span class="_"> </span>continuously<span class="_ _7"></span>.<span class="_"> </span>Although<span class="_ _13"> </span>virtual<span class="_"> </span>memory<span class="_ _13"> </span>is<span class="_"> </span>usually<span class="_ _13"> </span>efﬁcient,<span class="_"> </span>if<span class="_ _13"> </span>a<span class="_"> </span>program’<span class="_ _1"></span>s</div><div class="t m5 x1d h26 y2b6f ff7 fs19 fc1 sc0 ls0 ws0">performance<span class="_ _11"> </span>slows<span class="_ _16"> </span>to<span class="_ _11"> </span>a<span class="_ _11"> </span>crawl,<span class="_ _16"> </span>the<span class="_ _11"> </span>wise<span class="_ _16"> </span>programmer<span class="_ _11"> </span>will<span class="_ _16"> </span>consider<span class="_ _11"> </span>the<span class="_ _11"> </span>possibility</div><div class="t m5 x1d h26 y6d5b ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>thrashing.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
