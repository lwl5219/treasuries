<div id="pf21f" class="pf w2 h11" data-page-no="21f"><div class="pc pc21f w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg21f.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">542<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x221 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/opt/vec.c</div><div class="t m5 x1f h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Create<span class="_ _e"> </span>vector<span class="_ _1f"> </span>of<span class="_ _1f"> </span>specified<span class="_ _e"> </span>length<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1f h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">vec_ptr<span class="_ _1f"> </span>new_vec(long<span class="_ _e"> </span>len)</span></div><div class="t m5 x1f h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Allocate<span class="_ _1f"> </span>header<span class="_ _1f"> </span>structure<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">vec_ptr<span class="_ _e"> </span>result<span class="_ _1f"> </span>=<span class="_ _1f"> </span>(vec_ptr)<span class="_ _e"> </span>malloc(sizeof(vec_rec));</span></div><div class="t m5 x1f h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>*data<span class="_ _1f"> </span>=<span class="_ _1f"> </span>NULL;</span></div><div class="t m5 x1f h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(!result)</span></div><div class="t m5 x1f h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>NULL;<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Couldn’t<span class="_ _1f"> </span>allocate<span class="_ _e"> </span>storage<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1f h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">result-&gt;len<span class="_ _e"> </span>=<span class="_ _1f"> </span>len;</span></div><div class="t m5 x1b0 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Allocate<span class="_ _1f"> </span>array<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1b0 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(len<span class="_ _1f"> </span>&gt;<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{</span></div><div class="t m5 x1b0 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">data<span class="_ _e"> </span>=<span class="_ _1f"> </span>(data_t<span class="_ _1f"> </span>*)calloc(len,<span class="_ _e"> </span>sizeof(data_t));</span></div><div class="t m5 x1b0 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(!data)<span class="_ _1f"> </span>{</span></div><div class="t m5 x1b0 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _d1"> </span><span class="ffd fs1e fc2">free((void<span class="_ _1f"> </span>*)<span class="_ _e"> </span>result);</span></div><div class="t m5 x1b0 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _d1"> </span><span class="ffd fs1e fc2">return<span class="_ _1f"> </span>NULL;<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Couldn’t<span class="_ _e"> </span>allocate<span class="_ _1f"> </span>storage<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1b0 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Data<span class="_ _1f"> </span>will<span class="_ _1f"> </span>either<span class="_ _e"> </span>be<span class="_ _1f"> </span>NULL<span class="_ _e"> </span>or<span class="_ _1f"> </span>allocated<span class="_ _1f"> </span>array<span class="_ _e"> </span>*/</span></div><div class="t m5 x1b0 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">result-&gt;data<span class="_ _e"> </span>=<span class="_ _1f"> </span>data;</span></div><div class="t m5 x1b0 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>result;</span></div><div class="t m5 x1b0 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x4f h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1b0 h2e y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x1b0 h2e y4aa2 ff6 fs20 fc6 sc0 ls0 ws0">23</div><div class="t m5 x4f h2d y3228 ffd fs1e fc2 sc0 ls0 ws0">/*</div><div class="t m5 x1b0 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _1f"> </span>Retrieve<span class="_ _e"> </span>vector<span class="_ _1f"> </span>element<span class="_ _1f"> </span>and<span class="_ _e"> </span>store<span class="_ _1f"> </span>at<span class="_ _e"> </span>dest.</span></div><div class="t m5 x1b0 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 xc2 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">*<span class="_ _e"> </span>Return<span class="_ _1f"> </span>0<span class="_ _1f"> </span>(out<span class="_ _e"> </span>of<span class="_ _1f"> </span>bounds)<span class="_ _e"> </span>or<span class="_ _1f"> </span>1<span class="_ _1f"> </span>(successful)</div><div class="t m5 x1b0 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _73"> </span><span class="ffd fs1e fc2">*/</span></div><div class="t m5 x1b0 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>get_vec_element(vec_ptr<span class="_ _e"> </span>v,<span class="_ _1f"> </span>long<span class="_ _1f"> </span>index,<span class="_ _e"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x1b0 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1b0 h2d y441 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(inde<span class="ls33">x&lt;0|<span class="_ _41"></span>|<span class="ls0">index<span class="_ _1f"> </span>&gt;=<span class="_ _1f"> </span>v-&gt;len)</span></span></span></div><div class="t m5 x1b0 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>0;</span></div><div class="t m5 x1b0 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _20"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>v-&gt;data[index];</span></div><div class="t m5 x1b0 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>1;</span></div><div class="t m5 x1b0 h2d y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2e y5fd ff6 fs20 fc6 sc0 ls0 ws0">34</div><div class="t m5 x1b0 h2e y4aa4 ff6 fs20 fc6 sc0 ls0 ws0">35</div><div class="t m5 x4f h2d y4aa5 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Return<span class="_ _1f"> </span>length<span class="_ _1f"> </span>of<span class="_ _e"> </span>vector<span class="_ _1f"> </span>*/</div><div class="t m5 x1b0 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 x4f h2d y74d ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>vec_length(vec_ptr<span class="_ _1f"> </span>v)</div><div class="t m5 x1b0 h2d y277 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1b0 h2d y2269 ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>v-&gt;len;</span></div><div class="t m5 x1b0 h2d y226b ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x221 h2c y4aa6 ffa fs16 fc2 sc0 ls0 ws0">code/opt/vec.c</div><div class="t m5 x1d h34 y4aa7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _13"> </span>5.4<span class="_ _c"> </span><span class="fc1">Implementation<span class="_"> </span>of<span class="_ _13"> </span>vector<span class="_ _13"> </span>abstract<span class="_"> </span>data<span class="_ _13"> </span>type.<span class="_ _10"> </span><span class="ff6">In<span class="_ _13"> </span>the<span class="_ _10"> </span>actual<span class="_ _13"> </span>program,<span class="_ _10"> </span>data</span></span></div><div class="t m5 x1d h34 y4aa8 ff6 fs16 fc1 sc0 ls0 ws0">type</div><div class="t m5 x10c h3a y4aa9 ffd fs19 fc1 sc0 ls0 ws0">data_t<span class="_ _10"> </span><span class="ff6 fs16">is<span class="_ _11"> </span>declared<span class="_ _10"> </span>to<span class="_ _10"> </span>be<span class="_ _11"> </span></span>int<span class="ff6 fs16">,<span class="_ _10"> </span></span>long<span class="ff6 fs16">,<span class="_ _11"> </span></span>float<span class="ff6 fs16 ls20b">,o<span class="_ _4a"></span>r<span class="ffd fs19 ls0">double</span><span class="ls0">.</span></span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
