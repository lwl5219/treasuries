<div id="pf207" class="pf w2 h11" data-page-no="207"><div class="pc pc207 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg207.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">518<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>4<span class="_ _3d"> </span>Processor<span class="_ _10"> </span>Architecture</span></div><div class="t m5 x1d h28 y9c ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>4.3<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>405)</span></div><div class="t m5 x1d h26 y1d16 ff7 fs19 fc1 sc0 ls0 ws0">Using<span class="_"> </span>the<span class="_"> </span><span class="ffd">iaddq<span class="_ _10"> </span></span>instruction,<span class="_"> </span>we<span class="_"> </span>can<span class="_"> </span>rewrite<span class="_"> </span>the<span class="_"> </span><span class="ffd">sum<span class="_ _10"> </span></span>function<span class="_"> </span>as</div><div class="t m5 x1d h2d y47c2 ffd fs1e fc2 sc0 ls0 ws0">#<span class="_ _e"> </span>long<span class="_ _1f"> </span>sum(long<span class="_ _1f"> </span>*start,<span class="_ _e"> </span>long<span class="_ _1f"> </span>count)</div><div class="t m5 x1d h2d y47c3 ffd fs1e fc2 sc0 ls0 ws0">#<span class="_ _e"> </span>start<span class="_ _1f"> </span>in<span class="_ _1f"> </span>%rdi,<span class="_ _e"> </span>count<span class="_ _1f"> </span>in<span class="_ _e"> </span>%rsi</div><div class="t m5 x1d h2d y47c4 ffd fs1e fc2 sc0 ls0 ws0">sum:</div><div class="t m5 x22b h2d y47c5 ffd fs1e fc2 sc0 ls0 ws0">xorq<span class="_ _e"> </span>%rax,%rax<span class="_ _86"> </span>#<span class="_ _1f"> </span>sum<span class="_ _1f"> </span>=<span class="_ _e"> </span>0</div><div class="t m5 x22b h2d y47c6 ffd fs1e fc2 sc0 ls0 ws0">andq<span class="_ _e"> </span>%rsi,%rsi<span class="_ _86"> </span>#<span class="_ _1f"> </span>Set<span class="_ _1f"> </span>condition<span class="_ _e"> </span>codes</div><div class="t m5 x22b h2d y47c7 ffd fs1e fc2 sc0 ls0 ws0">jmp<span class="_ _46"> </span>test</div><div class="t m5 x1d h2d y47c8 ffd fs1e fc2 sc0 ls0 ws0">loop:</div><div class="t m5 x22b h2d y47c9 ffd fs1e fc2 sc0 ls0 ws0">mrmovq<span class="_ _e"> </span>(%rdi),%r10<span class="_ _b9"> </span>#<span class="_ _e"> </span>Get<span class="_ _1f"> </span>*start</div><div class="t m5 x22b h2d y47ca ffd fs1e fc2 sc0 ls0 ws0">addq<span class="_ _e"> </span>%r10,%rax<span class="_ _86"> </span>#<span class="_ _1f"> </span>Add<span class="_ _1f"> </span>to<span class="_ _e"> </span>sum</div><div class="t m5 x22b h2d y47cb ffd fs1e fc2 sc0 ls0 ws0">iaddq<span class="_ _e"> </span>$8,%rdi<span class="_ _6b"> </span>#<span class="_ _1f"> </span>start++</div><div class="t m5 x22b h2d y47cc ffd fs1e fc2 sc0 ls0 ws0">iaddq<span class="_ _e"> </span>$-1,%rsi<span class="_ _86"> </span>#<span class="_ _1f"> </span>count--</div><div class="t m5 x1d h2d y47cd ffd fs1e fc2 sc0 ls0 ws0">test:</div><div class="t m5 x22b h2d y47ce ffd fs1e fc2 sc0 ls0 ws0">jne<span class="_ _46"> </span>loop<span class="_ _35"> </span>#<span class="_ _1f"> </span>Stop<span class="_ _e"> </span>when<span class="_ _1f"> </span>0</div><div class="t m5 x22b h2d y47cf ffd fs1e fc2 sc0 ls0 ws0">ret</div><div class="t m5 x1d h28 y47d0 ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>4.4</div><div class="t m5 x1ed h2f y47d1 ffe fs16 fc6 sc0 ls0 ws0">(page<span class="_"> </span>406)</div><div class="t m5 x1d h26 y47d2 ff9 fs19 fc1 sc0 ls0 ws0">Gcc<span class="ff7">,<span class="_"> </span>running<span class="_"> </span>on<span class="_"> </span>an<span class="_"> </span>x86-64<span class="_"> </span>machine<span class="_ _1"></span>,<span class="_"> </span>produces<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span><span class="ffd">rproduct</span>:</span></div><div class="t m5 x17e h61 y47d3 ff13 fs35 fc6 sc0 ls0 ws0">long<span class="_ _f"> </span>rproduct(long<span class="_ _f"> </span>*start,<span class="_ _f"> </span>long<span class="_ _e"> </span>count)</div><div class="t m5 x17e h61 y47d4 ff13 fs35 fc6 sc0 ls0 ws0">start<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>count<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi</div><div class="t m5 x1d h2d y47d5 ffd fs1e fc2 sc0 ls0 ws0">rproduct:</div><div class="t m5 x75 h2d y47d6 ffd fs1e fc2 sc0 ls0 ws0">movl<span class="_ _46"> </span>$1,<span class="_ _e"> </span>%eax</div><div class="t m5 x75 h2d y47d7 ffd fs1e fc2 sc0 ls0 ws0">testq<span class="_ _3f"> </span>%rsi,<span class="_ _e"> </span>%rsi</div><div class="t m5 x75 h2d y47d8 ffd fs1e fc2 sc0 ls0 ws0">jle<span class="_ _8c"> </span>.L9</div><div class="t m5 x75 h2d y47d9 ffd fs1e fc2 sc0 ls0 ws0">pushq<span class="_ _3f"> </span>%rbx</div><div class="t m5 x75 h2d y47da ffd fs1e fc2 sc0 ls0 ws0">movq<span class="_ _46"> </span>(%rdi),<span class="_ _e"> </span>%rbx</div><div class="t m5 x75 h2d y47db ffd fs1e fc2 sc0 ls0 ws0">subq<span class="_ _46"> </span>$1,<span class="_ _e"> </span>%rsi</div><div class="t m5 x75 h2d y47dc ffd fs1e fc2 sc0 ls0 ws0">addq<span class="_ _46"> </span>$8,<span class="_ _e"> </span>%rdi</div><div class="t m5 x75 h2d y47dd ffd fs1e fc2 sc0 ls0 ws0">call<span class="_ _46"> </span>rproduct</div><div class="t m5 x75 h2d y47de ffd fs1e fc2 sc0 ls0 ws0">imulq<span class="_ _3f"> </span>%rbx,<span class="_ _e"> </span>%rax</div><div class="t m5 x75 h2d y47df ffd fs1e fc2 sc0 ls0 ws0">popq<span class="_ _46"> </span>%rbx</div><div class="t m5 x1d h2d y47e0 ffd fs1e fc2 sc0 ls0 ws0">.L9:</div><div class="t m5 x75 h2d y47e1 ffd fs1e fc2 sc0 ls0 ws0">rep;<span class="_ _e"> </span>ret</div><div class="t m5 x1d h26 y47e2 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>can<span class="_"> </span>easily<span class="_"> </span>be<span class="_"> </span>adapted<span class="_"> </span>to<span class="_"> </span>produce<span class="_"> </span>Y86-64<span class="_"> </span>code:</div><div class="t m5 x1d h2d yc47 ffd fs1e fc2 sc0 ls0 ws0">#<span class="_ _e"> </span>long<span class="_ _1f"> </span>rproduct(long<span class="_ _1f"> </span>*start,<span class="_ _e"> </span>long<span class="_ _1f"> </span>count)</div><div class="t m5 x1d h2d y47e3 ffd fs1e fc2 sc0 ls0 ws0">#<span class="_ _e"> </span>start<span class="_ _1f"> </span>in<span class="_ _1f"> </span>%rdi,<span class="_ _e"> </span>count<span class="_ _1f"> </span>in<span class="_ _e"> </span>%rsi</div><div class="t m5 x1d h2d y47e4 ffd fs1e fc2 sc0 ls0 ws0">rproduct:</div><div class="t m5 x22b h2d y47e5 ffd fs1e fc2 sc0 ls0 ws0">xorq<span class="_ _3f"> </span>%rax,%rax<span class="_ _71"> </span>#<span class="_ _1f"> </span>Set<span class="_ _e"> </span>return<span class="_ _1f"> </span>value<span class="_ _1f"> </span>to<span class="_ _e"> </span>1</div><div class="t m5 x22b h2d y47e6 ffd fs1e fc2 sc0 ls0 ws0">andq<span class="_ _3f"> </span>%rsi,%rsi<span class="_ _71"> </span>#<span class="_ _1f"> </span>Set<span class="_ _e"> </span>condition<span class="_ _1f"> </span>codes</div><div class="t m5 x22b h2d y47e7 ffd fs1e fc2 sc0 ls0 ws0">je<span class="_ _8c"> </span>return<span class="_ _192"> </span>#<span class="_ _1f"> </span>If<span class="_ _1f"> </span>count<span class="_ _e"> </span>&lt;=<span class="_ _1f"> </span>0,<span class="_ _e"> </span>return<span class="_ _1f"> </span>1</div><div class="t m5 x22b h2d y47e8 ffd fs1e fc2 sc0 ls0 ws0">pushq<span class="_ _1a"> </span>%rbx<span class="_ _35"> </span>#<span class="_ _1f"> </span>Save<span class="_ _e"> </span>callee-saved<span class="_ _1f"> </span>register</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
