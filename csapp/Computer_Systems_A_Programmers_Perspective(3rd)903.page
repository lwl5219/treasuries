<div id="pf387" class="pf w2 h11" data-page-no="387"><div class="pc pc387 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg387.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">902<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _3"></span>ailing<span class="_ _13"> </span>to<span class="_ _13"> </span>free<span class="_ _13"> </span>allocated<span class="_ _6"> </span>blocks<span class="_ _13"> </span>is<span class="_ _13"> </span>a<span class="_ _13"> </span>common<span class="_ _6"> </span>programming<span class="_ _13"> </span>error.<span class="_ _6"> </span>F<span class="_ _0"></span>or<span class="_ _13"> </span>example<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">consider<span class="_ _11"> </span>the<span class="_ _11"> </span>following<span class="_ _16"> </span>C<span class="_ _11"> </span>function<span class="_ _11"> </span>that<span class="_ _16"> </span>allocates<span class="_ _11"> </span>a<span class="_ _11"> </span>block<span class="_ _16"> </span>of<span class="_ _11"> </span>temporary<span class="_ _11"> </span>storage<span class="_ _11"> </span>as</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">part<span class="_"> </span>of<span class="_"> </span>its<span class="_"> </span>processing:</div><div class="t m5 x1f h2d y74a7 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>garbage()</span></div><div class="t m5 x1f h2d y74a8 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y74a9 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>*p<span class="_ _1f"> </span>=<span class="_ _1f"> </span>(int<span class="_ _e"> </span>*)Malloc(15213);</span></div><div class="t m5 x1f h2e y74aa ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x1f h2e y74ab ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x33 h2d y74ac ffd fs1e fc2 sc0 ls0 ws0">return;<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Array<span class="_ _1f"> </span>p<span class="_ _e"> </span>is<span class="_ _1f"> </span>garbage<span class="_ _e"> </span>at<span class="_ _1f"> </span>this<span class="_ _1f"> </span>point<span class="_ _e"> </span>*/</div><div class="t m5 x1f h2d y74ad ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x29 h26 y74ae ff7 fs19 fc2 sc0 ls0 ws0">Since<span class="_"> </span><span class="ffd">p<span class="_ _13"> </span></span>is<span class="_"> </span>no<span class="_ _13"> </span>longer<span class="_"> </span>needed<span class="_ _13"> </span>by<span class="_"> </span>the<span class="_"> </span>program,<span class="_ _13"> </span>it<span class="_"> </span>should<span class="_ _13"> </span>have<span class="_"> </span>been<span class="_"> </span>freed<span class="_ _13"> </span>before</div><div class="t m5 x1d h26 y74af ffd fs19 fc2 sc0 ls0 ws0">garbage<span class="_ _6"> </span><span class="ff7">returned.<span class="_ _13"> </span>Unfortunately<span class="_ _7"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>programmer<span class="_ _6"> </span>has<span class="_ _13"> </span>forgotten<span class="_ _6"> </span>to<span class="_ _6"> </span>free<span class="_ _13"> </span>the<span class="_ _6"> </span>block.</span></div><div class="t m5 x1d h26 y74b0 ff7 fs19 fc2 sc0 ls0 ws0">It<span class="_ _16"> </span>remains<span class="_ _16"> </span>allocated<span class="_ _16"> </span>for<span class="_ _16"> </span>the<span class="_ _16"> </span>lifetime<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>program,<span class="_ _16"> </span>needlessly<span class="_ _14"> </span>occupying<span class="_ _16"> </span>heap</div><div class="t m5 x1d h26 y74b1 ff7 fs19 fc2 sc0 ls0 ws0">space<span class="_"> </span>that<span class="_"> </span>could<span class="_"> </span>be<span class="_"> </span>used<span class="_"> </span>to<span class="_"> </span>satisfy<span class="_"> </span>subsequent<span class="_"> </span>allocation<span class="_"> </span>requests<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y74b2 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _13"> </span><span class="ffa">garbage<span class="_"> </span>collector<span class="_"> </span></span>is<span class="_ _13"> </span>a<span class="_"> </span>dynamic<span class="_ _13"> </span>storage<span class="_ _13"> </span>allocator<span class="_"> </span>that<span class="_ _13"> </span>automatically<span class="_ _13"> </span>frees<span class="_"> </span>al-</div><div class="t m5 x1d h26 y74b3 ff7 fs19 fc2 sc0 ls0 ws0">located<span class="_"> </span>blocks<span class="_ _13"> </span>that<span class="_"> </span>are<span class="_"> </span>no<span class="_ _13"> </span>longer<span class="_"> </span>needed<span class="_"> </span>by<span class="_ _13"> </span>the<span class="_"> </span>program.<span class="_"> </span>Such<span class="_ _13"> </span>blocks<span class="_"> </span>are<span class="_"> </span>known</div><div class="t m5 x1d h26 y74b4 ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_ _14"> </span><span class="ffa">garbage<span class="_ _15"> </span></span>(hence<span class="_ _14"> </span>the<span class="_ _15"> </span>term<span class="_ _14"> </span>“garbage<span class="_ _14"> </span>collector”).<span class="_ _15"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>process<span class="_ _14"> </span>of<span class="_ _15"> </span>automatically</div><div class="t m5 x1b0 h26 y74b5 ff7 fs19 fc2 sc0 ls0 ws0">reclaiming<span class="_"> </span>heap<span class="_"> </span>storage<span class="_ _13"> </span>is<span class="_"> </span>known<span class="_"> </span>as<span class="_"> </span><span class="ffa">garbage<span class="_"> </span>collection</span>.<span class="_ _13"> </span>In<span class="_"> </span>a<span class="_"> </span>system<span class="_"> </span>that<span class="_"> </span>supports</div><div class="t m5 x1d h26 y74b6 ff7 fs19 fc2 sc0 ls0 ws0">garbage<span class="_ _11"> </span>collection,<span class="_ _16"> </span>applications<span class="_ _16"> </span>explicitly<span class="_ _11"> </span>allocate<span class="_ _11"> </span>heap<span class="_ _16"> </span>blocks<span class="_ _11"> </span>but<span class="_ _16"> </span>never<span class="_ _11"> </span>explic-</div><div class="t m5 x1d h26 y74b7 ff7 fs19 fc2 sc0 ls0 ws0">itly<span class="_ _14"> </span>free<span class="_ _14"> </span>them.<span class="_ _14"> </span>In<span class="_ _14"> </span>the<span class="_ _14"> </span>context<span class="_ _14"> </span>of<span class="_ _14"> </span>a<span class="_ _14"> </span>C<span class="_ _14"> </span>program,<span class="_ _15"> </span>the<span class="_ _14"> </span>application<span class="_ _14"> </span>calls<span class="_ _14"> </span><span class="ffd">malloc<span class="_ _14"> </span></span>but</div><div class="t m5 x1d h26 y74b8 ff7 fs19 fc2 sc0 ls0 ws0">never<span class="_ _13"> </span>calls<span class="_"> </span><span class="ffd">free</span>.<span class="_ _13"> </span>Instead,<span class="_ _13"> </span>the<span class="_ _13"> </span>garbage<span class="_"> </span>collector<span class="_ _13"> </span>periodically<span class="_ _13"> </span>identiﬁes<span class="_ _13"> </span>the<span class="_"> </span>garbage</div><div class="t m5 x1d h26 y74b9 ff7 fs19 fc2 sc0 ls0 ws0">blocks<span class="_"> </span>and<span class="_"> </span>makes<span class="_"> </span>the<span class="_"> </span>appropriate<span class="_ _13"> </span>calls<span class="_"> </span>to<span class="_"> </span><span class="ffd">free<span class="_ _10"> </span></span>to<span class="_"> </span>place<span class="_"> </span>those<span class="_"> </span>blocks<span class="_"> </span>back<span class="_"> </span>on<span class="_ _13"> </span>the</div><div class="t m5 x1d h26 y74ba ff7 fs19 fc2 sc0 ls0 ws0">free<span class="_"> </span>list.</div><div class="t m5 x29 h26 y74bb ff7 fs19 fc2 sc0 ls0 ws0">Garbage<span class="_"> </span>collection<span class="_"> </span>dates<span class="_"> </span>back<span class="_"> </span>to<span class="_"> </span>Lisp<span class="_"> </span>systems<span class="_ _11"> </span>developed<span class="_"> </span>by<span class="_"> </span>J<span class="_ _1"></span>ohn<span class="_"> </span>McCarthy</div><div class="t m5 x1d h26 y74bc ff7 fs19 fc2 sc0 ls0 ws0">at<span class="_ _13"> </span>MIT<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>early<span class="_ _13"> </span>1960s<span class="_ _1"></span>.<span class="_ _13"> </span>It<span class="_ _13"> </span>is<span class="_ _13"> </span>an<span class="_ _13"> </span>important<span class="_ _13"> </span>part<span class="_ _13"> </span>of<span class="_ _13"> </span>modern<span class="_ _13"> </span>language<span class="_ _13"> </span>systems<span class="_ _13"> </span>such</div><div class="t m5 x1d h26 y74bd ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_ _6"> </span>J<span class="_ _3"></span>ava,<span class="_ _13"> </span>ML,<span class="_ _13"> </span>Perl,<span class="_ _6"> </span>and<span class="_ _6"> </span>Mathematica,<span class="_ _13"> </span>and<span class="_ _6"> </span>it<span class="_ _6"> </span>remains<span class="_ _6"> </span>an<span class="_ _13"> </span>active<span class="_ _a"> </span>and<span class="_ _13"> </span>important<span class="_ _a"> </span>area<span class="_ _6"> </span>of</div><div class="t m5 x1d h26 y74be ff7 fs19 fc2 sc0 ls0 ws0">research.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>literature<span class="_ _11"> </span>describes<span class="_"> </span>an<span class="_"> </span>amazing<span class="_"> </span>number<span class="_"> </span>of<span class="_"> </span>approaches<span class="_"> </span>for<span class="_"> </span>garbage</div><div class="t m5 x1d h26 y74bf ff7 fs19 fc2 sc0 ls0 ws0">collection.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>will<span class="_ _16"> </span>limit<span class="_ _16"> </span>our<span class="_ _16"> </span>discussion<span class="_ _16"> </span>to<span class="_ _16"> </span>McCarthy’s<span class="_ _16"> </span>original<span class="_ _16"> </span><span class="ffa">Mark&amp;Sweep<span class="_ _11"> </span></span>al-</div><div class="t m5 x1d h26 y74c0 ff7 fs19 fc2 sc0 ls0 ws0">gorithm,<span class="_"> </span>which<span class="_ _11"> </span>is<span class="_"> </span>interesting<span class="_"> </span>because<span class="_ _11"> </span>it<span class="_"> </span>can<span class="_ _11"> </span>be<span class="_"> </span>built<span class="_ _11"> </span>on<span class="_"> </span>top<span class="_ _11"> </span>of<span class="_"> </span>an<span class="_ _11"> </span>existing<span class="_"> </span><span class="ffd">malloc</span></div><div class="t m5 x1d h26 y74c1 ff7 fs19 fc2 sc0 ls0 ws0">package<span class="_"> </span>to<span class="_"> </span>provide<span class="_"> </span>garbage<span class="_"> </span>collection<span class="_"> </span>for<span class="_"> </span>C<span class="_"> </span>and<span class="_"> </span>C++<span class="_"> </span>programs<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y24a ffe fs29 fc2 sc0 ls0 ws0">9.10.1<span class="_ _48"> </span><span class="fs19">Garbage<span class="_"> </span>Collector<span class="_"> </span>Basics</span></div><div class="t m5 x1d h26 y24b ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _16"> </span>garbage<span class="_ _16"> </span>collector<span class="_ _14"> </span>views<span class="_ _16"> </span>memory<span class="_ _14"> </span>as<span class="_ _16"> </span>a<span class="_ _16"> </span>directed<span class="_ _14"> </span><span class="ffa">reachability<span class="_ _16"> </span>graph<span class="_ _16"> </span></span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>form</div><div class="t m5 x1d h26 y24c ff7 fs19 fc2 sc0 ls0 ws0">shown<span class="_ _16"> </span>in<span class="_ _14"> </span>Figure<span class="_ _16"> </span>9.49.<span class="_ _16"> </span>The<span class="_ _16"> </span>nodes<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>graph<span class="_ _16"> </span>are<span class="_ _14"> </span>partitioned<span class="_ _14"> </span>into<span class="_ _14"> </span>a<span class="_ _16"> </span>set<span class="_ _14"> </span>of<span class="_ _16"> </span><span class="ffa">root</span></div><div class="t m5 x1d h26 y24d ffa fs19 fc2 sc0 ls0 ws0">nodes<span class="_"> </span><span class="ff7">and<span class="_ _13"> </span>a<span class="_"> </span>set<span class="_ _13"> </span>of<span class="_"> </span></span>heap<span class="_"> </span>nodes<span class="ff7">.<span class="_ _13"> </span>Each<span class="_"> </span>heap<span class="_ _13"> </span>node<span class="_"> </span>corresponds<span class="_ _13"> </span>to<span class="_"> </span>an<span class="_"> </span>allocated<span class="_ _13"> </span>block</span></div><div class="t m5 x1d h46 y24e ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _13"> </span>the<span class="_"> </span>heap<span class="_ _1"></span>.<span class="_"> </span>A<span class="_ _13"> </span>directed<span class="_"> </span>edge<span class="_ _13"> </span><span class="ff11">p<span class="_ _10"> </span><span class="ff12">→<span class="_ _13"> </span></span>q<span class="_"> </span></span>means<span class="_ _13"> </span>that<span class="_"> </span>some<span class="_ _13"> </span>location<span class="_"> </span>in<span class="_ _13"> </span>block<span class="_"> </span><span class="ff11">p<span class="_ _10"> </span></span>points<span class="_ _13"> </span>to</div><div class="t m5 x1d h26 y24f ff7 fs19 fc2 sc0 ls0 ws0">some<span class="_ _13"> </span>location<span class="_"> </span>in<span class="_ _13"> </span>block<span class="_ _13"> </span><span class="ff11">q<span class="_ _5"></span></span>.<span class="_"> </span>Root<span class="_ _13"> </span>nodes<span class="_ _13"> </span>correspond<span class="_"> </span>to<span class="_ _13"> </span>locations<span class="_ _13"> </span>not<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>heap<span class="_"> </span>that</div><div class="t m5 x1d h26 y250 ff7 fs19 fc2 sc0 ls0 ws0">contain<span class="_ _11"> </span>pointers<span class="_ _11"> </span>into<span class="_ _11"> </span>the<span class="_"> </span>heap.<span class="_"> </span>T<span class="_ _0"></span>hese<span class="_ _11"> </span>locations<span class="_ _11"> </span>can<span class="_ _11"> </span>be<span class="_"> </span>registers<span class="_ _0"></span>,<span class="_ _11"> </span>variables<span class="_ _11"> </span>on<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y251 ff7 fs19 fc2 sc0 ls0 ws0">stack,<span class="_"> </span>or<span class="_"> </span>global<span class="_"> </span>variables<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>read/write<span class="_"> </span>data<span class="_"> </span>area<span class="_"> </span>of<span class="_"> </span>virtual<span class="_"> </span>memory<span class="_ _3"></span>.</div><div class="t m5 x29 h26 y252 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_"> </span>say<span class="_ _13"> </span>that<span class="_"> </span>a<span class="_ _13"> </span>node<span class="_"> </span><span class="ff11">p<span class="_ _10"> </span></span>is<span class="_ _13"> </span><span class="ffa">reachable<span class="_"> </span></span>if<span class="_ _13"> </span>there<span class="_"> </span>exists<span class="_ _13"> </span>a<span class="_"> </span>directed<span class="_ _13"> </span>path<span class="_"> </span>from<span class="_ _13"> </span>any<span class="_"> </span>root</div><div class="t m5 x1d h26 y253 ff7 fs19 fc2 sc0 ls0 ws0">node<span class="_ _13"> </span>to<span class="_ _6"> </span><span class="ff11">p<span class="_ _2"></span></span>.<span class="_ _13"> </span>At<span class="_ _13"> </span>any<span class="_ _6"> </span>point<span class="_ _13"> </span>in<span class="_ _13"> </span>time<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>unreachable<span class="_ _13"> </span>nodes<span class="_ _6"> </span>correspond<span class="_ _13"> </span>to<span class="_ _13"> </span>garbage<span class="_ _13"> </span>that</div><div class="t m5 x1d h26 y254 ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_ _11"> </span>never<span class="_ _16"> </span>be<span class="_ _11"> </span>used<span class="_ _11"> </span>again<span class="_ _16"> </span>by<span class="_ _11"> </span>the<span class="_ _16"> </span>application.<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>role<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_ _16"> </span>garbage<span class="_ _11"> </span>collector<span class="_ _16"> </span>is<span class="_ _11"> </span>to</div><div class="t m5 x1d h26 y255 ff7 fs19 fc2 sc0 ls0 ws0">maintain<span class="_ _11"> </span>some<span class="_ _11"> </span>representation<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>reachability<span class="_ _11"> </span>graph<span class="_ _11"> </span>and<span class="_ _11"> </span>periodically<span class="_ _11"> </span>reclaim</div><div class="t m5 x1d h26 y256 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>unreachable<span class="_"> </span>nodes<span class="_"> </span>by<span class="_"> </span>freeing<span class="_"> </span>them<span class="_"> </span>and<span class="_"> </span>returning<span class="_"> </span>them<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>free<span class="_"> </span>list.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
