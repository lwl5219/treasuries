<div id="pf1ec" class="pf w2 h11" data-page-no="1ec"><div class="pc pc1ec w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1ec.png"/><div class="t m5 x13d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>4.5<span class="_ _60"> </span>Pipelined<span class="_ _10"> </span>Y86-64<span class="_ _10"> </span>Implementations<span class="_ _3e"> </span><span class="ffe fs1e">491</span></div><div class="t m5 x17 h47 yb1f ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>4.36<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>528)</span></div><div class="t m5 x17 h26 y9ba ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _13"> </span>this<span class="_ _13"> </span>stage<span class="_ _1"></span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>can<span class="_ _13"> </span>complete<span class="_ _6"> </span>the<span class="_ _13"> </span>computation<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>status<span class="_ _13"> </span>code<span class="_ _13"> </span><span class="ff6">Stat<span class="_ _13"> </span></span>by<span class="_ _6"> </span>detecting</div><div class="t m5 x17 h26 y302f ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>case<span class="_ _13"> </span>of<span class="_"> </span>an<span class="_ _13"> </span>invalid<span class="_ _13"> </span>address<span class="_ _13"> </span>for<span class="_ _13"> </span>the<span class="_ _13"> </span>data<span class="_"> </span>memory<span class="_ _7"></span>.<span class="_ _13"> </span>Write<span class="_"> </span>HCL<span class="_ _13"> </span>code<span class="_ _13"> </span>for<span class="_ _13"> </span>the<span class="_ _13"> </span>signal</div><div class="t m5 x17 h26 y4491 ff6 fs19 fc1 sc0 ls0 ws0">m_stat<span class="ff7">.</span></div><div class="t m5 x17 h41 y4492 ffe fs29 fc1 sc0 ls0 ws0">4.5.8<span class="_ _48"> </span><span class="fs19">Pipeline<span class="_"> </span>Control<span class="_"> </span>Logic</span></div><div class="t m5 x17 h26 y4493 ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _13"> </span>are<span class="_ _6"> </span>now<span class="_ _6"> </span>ready<span class="_ _13"> </span>to<span class="_ _6"> </span>complete<span class="_ _6"> </span>our<span class="_ _13"> </span>design<span class="_ _6"> </span>for<span class="_ _13"> </span>PIPE<span class="_ _6"> </span>by<span class="_ _6"> </span>creating<span class="_ _13"> </span>the<span class="_ _6"> </span>pipeline<span class="_ _6"> </span>control</div><div class="t m5 x17 h26 y4494 ff7 fs19 fc1 sc0 ls0 ws0">logic.<span class="_ _15"> </span>T<span class="_ _1"></span>his<span class="_ _21"> </span>logic<span class="_ _21"> </span>must<span class="_ _21"> </span>handle<span class="_ _21"> </span>the<span class="_ _21"> </span>following<span class="_ _21"> </span>four<span class="_ _21"> </span>control<span class="_ _21"> </span>cases<span class="_ _15"> </span>for<span class="_ _21"> </span>which<span class="_ _21"> </span>other</div><div class="t m5 x17 h26 y4495 ff7 fs19 fc1 sc0 ls0 ws0">mechanisms<span class="_ _1"></span>,<span class="_"> </span>such<span class="_"> </span>as<span class="_"> </span>data<span class="_"> </span>forwarding<span class="_"> </span>and<span class="_"> </span>branch<span class="_"> </span>prediction,<span class="_"> </span>do<span class="_"> </span>not<span class="_"> </span>sufﬁce:</div><div class="t m5 x72 h26 y4496 ffa fs19 fc1 sc0 ls0 ws0">Load/use<span class="_"> </span>hazar<span class="_ _1"></span>ds<span class="_ _1"></span>.<span class="_ _f"> </span><span class="ff7">T<span class="_ _0"></span>he<span class="_"> </span>pipeline<span class="_ _13"> </span>must<span class="_"> </span>stall<span class="_"> </span>for<span class="_ _13"> </span>one<span class="_"> </span>c<span class="_ _0"></span>ycle<span class="_"> </span>between<span class="_ _13"> </span>an<span class="_"> </span>instruction</span></div><div class="t m5 x30 h26 y4497 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_"> </span>reads<span class="_"> </span>a<span class="_"> </span>value<span class="_"> </span>from<span class="_"> </span>memory<span class="_"> </span>and<span class="_"> </span>an<span class="_"> </span>instruction<span class="_"> </span>that<span class="_"> </span>uses<span class="_"> </span>this<span class="_"> </span>value<span class="_ _1"></span>.</div><div class="t m5 x72 h26 y4498 ffa fs19 fc1 sc0 ls0 ws0">Processing<span class="_ _15"> </span><span class="ffd">ret<span class="ff7">.<span class="_ _1f"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span>pipeline<span class="_ _14"> </span>must<span class="_ _14"> </span>stall<span class="_ _14"> </span>until<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">ret<span class="_ _14"> </span></span>instruction<span class="_ _14"> </span>reaches<span class="_ _14"> </span>the</span></span></div><div class="t m5 x30 h26 y4499 ff7 fs19 fc1 sc0 ls0 ws0">write-back<span class="_"> </span>stage<span class="_ _1"></span>.</div><div class="t m5 x72 h26 y449a ffa fs19 fc1 sc0 ls0 ws0">Mispredicted<span class="_ _13"> </span>branches<span class="_ _1"></span>.<span class="_ _21"> </span><span class="ff7">By<span class="_"> </span>the<span class="_ _13"> </span>time<span class="_"> </span>the<span class="_ _13"> </span>branch<span class="_"> </span>logic<span class="_ _13"> </span>detects<span class="_ _13"> </span>that<span class="_"> </span>a<span class="_ _13"> </span>jump<span class="_"> </span>should</span></div><div class="t m5 x30 h26 y449b ff7 fs19 fc1 sc0 ls0 ws0">not<span class="_ _16"> </span>have<span class="_ _11"> </span>been<span class="_ _16"> </span>taken,<span class="_ _16"> </span>several<span class="_ _16"> </span>instructions<span class="_ _16"> </span>at<span class="_ _16"> </span>the<span class="_ _16"> </span>branch<span class="_ _11"> </span>target<span class="_ _16"> </span>will<span class="_ _16"> </span>have</div><div class="t m5 x30 h26 y449c ff7 fs19 fc1 sc0 ls0 ws0">started<span class="_ _13"> </span>down<span class="_ _6"> </span>the<span class="_ _13"> </span>pipeline<span class="_ _1"></span>.<span class="_ _6"> </span>These<span class="_ _6"> </span>instructions<span class="_ _13"> </span>must<span class="_ _6"> </span>be<span class="_ _13"> </span>canceled,<span class="_ _13"> </span>and<span class="_ _6"> </span>fetch-</div><div class="t m5 x30 h26 y449d ff7 fs19 fc1 sc0 ls0 ws0">ing<span class="_"> </span>should<span class="_"> </span>begin<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>instruction<span class="_"> </span>following<span class="_"> </span>the<span class="_"> </span>jump<span class="_"> </span>instruction.</div><div class="t m5 x72 h26 y449e ffa fs19 fc1 sc0 ls0 ws0">Exceptions<span class="_ _1"></span>.<span class="_ _21"> </span><span class="ff7">When<span class="_ _16"> </span>an<span class="_ _16"> </span>instruction<span class="_ _16"> </span>causes<span class="_ _16"> </span>an<span class="_ _16"> </span>exception,<span class="_ _16"> </span>we<span class="_ _16"> </span>want<span class="_ _16"> </span>to<span class="_ _16"> </span>disable<span class="_ _16"> </span>the</span></div><div class="t m5 x30 h26 y449f ff7 fs19 fc1 sc0 ls0 ws0">updating<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>programmer<span class="_ _1"></span>-visible<span class="_ _14"> </span>state<span class="_ _14"> </span>by<span class="_ _15"> </span>later<span class="_ _14"> </span>instructions<span class="_ _14"> </span>and<span class="_ _14"> </span>halt</div><div class="t m5 x30 h26 y44a0 ff7 fs19 fc1 sc0 ls0 ws0">execution<span class="_"> </span>once<span class="_"> </span>the<span class="_"> </span>excepting<span class="_"> </span>instruction<span class="_"> </span>reaches<span class="_"> </span>the<span class="_"> </span>write-back<span class="_"> </span>stage<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y44a1 ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _6"> </span>will<span class="_ _13"> </span>go<span class="_ _a"> </span>through<span class="_ _6"> </span>the<span class="_ _13"> </span>desired<span class="_ _a"> </span>actions<span class="_ _13"> </span>for<span class="_ _a"> </span>each<span class="_ _6"> </span>of<span class="_ _13"> </span>these<span class="_ _a"> </span>cases<span class="_ _6"> </span>and<span class="_ _13"> </span>then<span class="_ _a"> </span>develop</div><div class="t m5 x17 h26 y44a2 ff7 fs19 fc1 sc0 ls0 ws0">control<span class="_"> </span>logic<span class="_"> </span>to<span class="_"> </span>handle<span class="_"> </span>all<span class="_"> </span>of<span class="_"> </span>them.</div><div class="t m5 x17 h42 y44a3 ff6 fs29 fc6 sc0 ls0 ws0">Desired<span class="_ _11"> </span>Handling<span class="_ _16"> </span>of<span class="_ _16"> </span>Special<span class="_ _11"> </span>Control<span class="_ _16"> </span>Cases</div><div class="t m5 x17 h26 y2156 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_ _13"> </span>a<span class="_ _6"> </span>load/use<span class="_ _13"> </span>hazard,<span class="_ _13"> </span>we<span class="_ _13"> </span>have<span class="_ _6"> </span>described<span class="_ _13"> </span>the<span class="_ _13"> </span>desired<span class="_ _6"> </span>pipeline<span class="_ _13"> </span>operation<span class="_ _13"> </span>in<span class="_ _6"> </span>Section</div><div class="t m5 x17 h26 y248b ff7 fs19 fc1 sc0 ls0 ws0">4.5.5,<span class="_ _21"> </span>as<span class="_ _21"> </span>illustrated<span class="_ _15"> </span>by<span class="_ _21"> </span>the<span class="_ _15"> </span>example<span class="_ _21"> </span>of<span class="_ _15"> </span>Figure<span class="_ _14"> </span>4.54.<span class="_ _21"> </span>Only<span class="_ _15"> </span>the<span class="_ _21"> </span><span class="ffd">mrmovq<span class="_ _15"> </span></span>and<span class="_ _21"> </span><span class="ffd">popq</span></div><div class="t m5 x17 h26 y248c ff7 fs19 fc1 sc0 ls0 ws0">instructions<span class="_ _16"> </span>read<span class="_ _16"> </span>data<span class="_ _14"> </span>from<span class="_ _16"> </span>memory<span class="_ _3"></span>.<span class="_ _16"> </span>When<span class="_ _16"> </span>(1)<span class="_ _16"> </span>either<span class="_ _16"> </span>of<span class="_ _14"> </span>these<span class="_ _16"> </span>is<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _14"> </span>execute</div><div class="t m5 x17 h26 y248d ff7 fs19 fc1 sc0 ls0 ws0">stage<span class="_ _15"> </span>and<span class="_ _14"> </span>(2)<span class="_ _15"> </span>an<span class="_ _15"> </span>instruction<span class="_ _15"> </span>requiring<span class="_ _15"> </span>the<span class="_ _15"> </span>destination<span class="_ _15"> </span>register<span class="_ _15"> </span>is<span class="_ _14"> </span>in<span class="_ _15"> </span>the<span class="_ _15"> </span>decode</div><div class="t m5 x17 h26 y248e ff7 fs19 fc1 sc0 ls0 ws0">stage<span class="_ _1"></span>,<span class="_"> </span>we<span class="_ _13"> </span>want<span class="_ _13"> </span>to<span class="_ _13"> </span>hold<span class="_ _13"> </span>back<span class="_ _13"> </span>the<span class="_ _13"> </span>second<span class="_ _13"> </span>instruction<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>decode<span class="_ _13"> </span>stage<span class="_ _13"> </span>and<span class="_ _13"> </span>inject<span class="_ _13"> </span>a</div><div class="t m5 x17 h26 y248f ff7 fs19 fc1 sc0 ls0 ws0">bubble<span class="_ _6"> </span>into<span class="_ _13"> </span>the<span class="_ _6"> </span>execute<span class="_ _13"> </span>stage<span class="_ _6"> </span>on<span class="_ _13"> </span>the<span class="_ _6"> </span>next<span class="_ _13"> </span>c<span class="_ _0"></span>ycle<span class="_ _1"></span>.<span class="_ _13"> </span>After<span class="_ _6"> </span>this<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>forwarding<span class="_ _6"> </span>logic<span class="_ _13"> </span>will</div><div class="t m5 x17 h26 y2490 ff7 fs19 fc1 sc0 ls0 ws0">resolve<span class="_"> </span>the<span class="_ _11"> </span>data<span class="_"> </span>hazard.<span class="_ _11"> </span>The<span class="_"> </span>pipeline<span class="_"> </span>can<span class="_ _11"> </span>hold<span class="_"> </span>back<span class="_ _11"> </span>an<span class="_"> </span>instruction<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_"> </span>decode</div><div class="t m5 x17 h26 y2491 ff7 fs19 fc1 sc0 ls0 ws0">stage<span class="_ _16"> </span>by<span class="_ _14"> </span>keeping<span class="_ _16"> </span>pipeline<span class="_ _14"> </span>register<span class="_ _16"> </span>D<span class="_ _14"> </span>in<span class="_ _16"> </span>a<span class="_ _14"> </span>ﬁxed<span class="_ _16"> </span>state.<span class="_ _16"> </span>In<span class="_ _16"> </span>doing<span class="_ _16"> </span>so,<span class="_ _16"> </span>it<span class="_ _14"> </span>should<span class="_ _16"> </span>also</div><div class="t m5 x17 h26 y2492 ff7 fs19 fc1 sc0 ls0 ws0">keep<span class="_ _13"> </span>pipeline<span class="_ _13"> </span>register<span class="_ _13"> </span>F<span class="_"> </span>in<span class="_ _13"> </span>a<span class="_ _13"> </span>ﬁxed<span class="_ _13"> </span>state<span class="_ _0"></span>,<span class="_ _13"> </span>so<span class="_ _13"> </span>that<span class="_"> </span>the<span class="_ _13"> </span>next<span class="_ _13"> </span>instruction<span class="_ _13"> </span>will<span class="_ _13"> </span>be<span class="_ _13"> </span>fetched</div><div class="t m5 x17 h26 y2493 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _13"> </span>second<span class="_ _13"> </span>time<span class="_ _1"></span>.<span class="_ _13"> </span>In<span class="_ _13"> </span>summary<span class="_ _3"></span>,<span class="_ _13"> </span>implementing<span class="_ _13"> </span>this<span class="_ _13"> </span>pipeline<span class="_ _13"> </span>ﬂow<span class="_ _13"> </span>requires<span class="_ _13"> </span>detecting<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y2494 ff7 fs19 fc1 sc0 ls0 ws0">hazard<span class="_ _13"> </span>condition,<span class="_"> </span>keeping<span class="_ _13"> </span>pipeline<span class="_"> </span>registers<span class="_ _13"> </span>F<span class="_ _13"> </span>and<span class="_"> </span>D<span class="_ _13"> </span>ﬁxed,<span class="_ _13"> </span>and<span class="_"> </span>injecting<span class="_ _13"> </span>a<span class="_ _13"> </span>bubble</div><div class="t m5 x17 h26 y2495 ff7 fs19 fc1 sc0 ls0 ws0">into<span class="_"> </span>the<span class="_"> </span>execute<span class="_"> </span>stage<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y2496 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_ _13"> </span>the<span class="_ _6"> </span>processing<span class="_ _13"> </span>of<span class="_ _6"> </span>a<span class="_ _13"> </span><span class="ffd">ret<span class="_ _13"> </span></span>instruction,<span class="_ _6"> </span>we<span class="_ _13"> </span>have<span class="_ _13"> </span>described<span class="_ _6"> </span>the<span class="_ _13"> </span>desired<span class="_ _6"> </span>pipeline</div><div class="t m5 x17 h26 y2497 ff7 fs19 fc1 sc0 ls0 ws0">operation<span class="_ _21"> </span>in<span class="_ _21"> </span>Section<span class="_ _f"> </span>4.5.5.<span class="_ _21"> </span>The<span class="_ _15"> </span>pipeline<span class="_ _f"> </span>should<span class="_ _21"> </span>stall<span class="_ _21"> </span>for<span class="_ _f"> </span>three<span class="_ _21"> </span>cycles<span class="_ _21"> </span>until<span class="_ _f"> </span>the</div><div class="t m5 x17 h26 y44a4 ff7 fs19 fc1 sc0 ls0 ws0">return<span class="_ _16"> </span>address<span class="_ _14"> </span>is<span class="_ _14"> </span>read<span class="_ _14"> </span>as<span class="_ _16"> </span>the<span class="_ _14"> </span><span class="ffd">ret<span class="_ _14"> </span></span>instruction<span class="_ _14"> </span>passes<span class="_ _14"> </span>through<span class="_ _16"> </span>the<span class="_ _14"> </span>memory<span class="_ _14"> </span>stage<span class="_ _0"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
