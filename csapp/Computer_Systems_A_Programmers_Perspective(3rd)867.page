<div id="pf363" class="pf w2 h11" data-page-no="363"><div class="pc pc363 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg363.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">866<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x28 h2a y548 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Optimizing<span class="_ _11"> </span>address<span class="_ _11"> </span>translation</span></div><div class="t m5 x28 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">In<span class="_ _16"> </span>our<span class="_ _11"> </span>discussion<span class="_ _16"> </span>of<span class="_ _16"> </span>address<span class="_ _11"> </span>translation,<span class="_ _16"> </span>we<span class="_ _16"> </span>have<span class="_ _16"> </span>described<span class="_ _11"> </span>a<span class="_ _16"> </span>sequential<span class="_ _16"> </span>two-step<span class="_ _11"> </span>process<span class="_ _16"> </span>where<span class="_ _16"> </span>the</div><div class="t m5 x28 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">MMU<span class="_"> </span>(1)<span class="_ _10"> </span>translates<span class="_ _10"> </span>the<span class="_ _11"> </span>virtual<span class="_"> </span>address<span class="_ _10"> </span>to<span class="_ _10"> </span>a<span class="_ _11"> </span>physical<span class="_"> </span>address<span class="_ _10"> </span>and<span class="_ _10"> </span>then<span class="_ _11"> </span>(2)<span class="_"> </span>passes<span class="_"> </span>the<span class="_ _11"> </span>physical<span class="_"> </span>address</div><div class="t m5 x28 h2b y2d2 ff7 fs1e fc2 sc0 ls0 ws0">to<span class="_ _11"> </span>the<span class="_ _11"> </span>L1<span class="_ _11"> </span>cache.<span class="_ _10"> </span>However,<span class="_ _11"> </span>real<span class="_ _16"> </span>hardware<span class="_ _11"> </span>implementations<span class="_ _11"> </span>use<span class="_ _11"> </span>a<span class="_ _11"> </span>neat<span class="_ _16"> </span>trick<span class="_ _11"> </span>that<span class="_ _11"> </span>allows<span class="_ _11"> </span>these<span class="_ _11"> </span>steps<span class="_ _11"> </span>to</div><div class="t m5 x28 h2b y2d3 ff7 fs1e fc2 sc0 ls0 ws0">be<span class="_"> </span>partially<span class="_ _11"> </span>overlapped,<span class="_ _11"> </span>thus<span class="_ _10"> </span>speeding<span class="_ _11"> </span>up<span class="_ _10"> </span>accesses<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_"> </span>L1<span class="_ _11"> </span>cache<span class="_ _0"></span>.<span class="_"> </span>F<span class="_ _0"></span>or<span class="_ _10"> </span>example,<span class="_"> </span>a<span class="_ _11"> </span>virtual<span class="_"> </span>address<span class="_ _11"> </span>on</div><div class="t m5 x28 h2b y2d4 ff7 fs1e fc2 sc0 ls0 ws0">a<span class="_"> </span>Core<span class="_"> </span>i7<span class="_"> </span>with<span class="_ _10"> </span>4<span class="_ _10"> </span>KB<span class="_"> </span>pages<span class="_ _10"> </span>has<span class="_ _10"> </span>12<span class="_ _10"> </span>bits<span class="_ _10"> </span>of<span class="_ _10"> </span>VPO<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>these<span class="_ _10"> </span>bits<span class="_ _10"> </span>are<span class="_ _10"> </span>identical<span class="_ _10"> </span>to<span class="_ _10"> </span>the<span class="_"> </span>12<span class="_ _10"> </span>bits<span class="_ _10"> </span>of<span class="_ _10"> </span>PPO<span class="_ _10"> </span>in<span class="_ _10"> </span>the</div><div class="t m5 x28 h2b y2d5 ff7 fs1e fc2 sc0 ls0 ws0">corresponding<span class="_ _11"> </span>physical<span class="_ _16"> </span>address<span class="_ _1"></span>.<span class="_ _16"> </span>Since<span class="_ _11"> </span>the<span class="_ _16"> </span>8-way<span class="_ _11"> </span>set<span class="_ _16"> </span>associative<span class="_ _11"> </span>physically<span class="_ _16"> </span>addressed<span class="_ _11"> </span>L1<span class="_ _16"> </span>caches<span class="_ _16"> </span>have</div><div class="t m5 x28 h2b y2d6 ff7 fs1e fc2 sc0 ls0 ws0">64<span class="_"> </span>sets<span class="_"> </span>and<span class="_"> </span>64-byte<span class="_ _13"> </span>cache<span class="_"> </span>blocks<span class="_ _1"></span>,<span class="_"> </span>each<span class="_"> </span>physical<span class="_"> </span>address<span class="_"> </span>has<span class="_"> </span>6<span class="_ _13"> </span>(log</div><div class="t m5 x1c2 h48 y707b ff7 fs2c fc2 sc0 ls0 ws0">2</div><div class="t m5 x24f h2b y844 ff7 fs1e fc2 sc0 ls40 ws0">64)<span class="_"> </span>cache<span class="_"> </span>offset<span class="_"> </span>bits<span class="_ _13"> </span>and<span class="_"> </span>6<span class="_"> </span>(log</div><div class="t m5 x223 h48 y707b ff7 fs2c fc2 sc0 ls0 ws0">2</div><div class="t m5 xdb h2b y844 ff7 fs1e fc2 sc0 ls2ad ws0">64)</div><div class="t m5 x28 h2b y845 ff7 fs1e fc2 sc0 ls0 ws0">index<span class="_"> </span>bits<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>hese<span class="_ _10"> </span>12<span class="_ _11"> </span>bits<span class="_"> </span>ﬁt<span class="_ _10"> </span>exactly<span class="_ _11"> </span>in<span class="_"> </span>the<span class="_ _10"> </span>12-bit<span class="_ _11"> </span>VPO<span class="_"> </span>of<span class="_ _10"> </span>a<span class="_ _11"> </span>virtual<span class="_"> </span>address<span class="_ _1"></span>,<span class="_ _11"> </span>which<span class="_"> </span>is<span class="_ _10"> </span>no<span class="_ _11"> </span>accident!<span class="_"> </span>When</div><div class="t m5 x28 h2b y846 ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>CPU<span class="_ _16"> </span>needs<span class="_ _16"> </span>a<span class="_ _16"> </span>virtual<span class="_ _16"> </span>address<span class="_ _16"> </span>translated,<span class="_ _16"> </span>it<span class="_ _16"> </span>sends<span class="_ _16"> </span>the<span class="_ _16"> </span>VPN<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>MMU<span class="_ _16"> </span>and<span class="_ _16"> </span>the<span class="_ _16"> </span>VPO<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>L1</div><div class="t m5 x28 h2b y707c ff7 fs1e fc2 sc0 ls0 ws0">cache<span class="_ _1"></span>.<span class="_ _11"> </span>While<span class="_"> </span>the<span class="_"> </span>MMU<span class="_ _11"> </span>is<span class="_"> </span>requesting<span class="_ _11"> </span>a<span class="_"> </span>page<span class="_ _11"> </span>table<span class="_"> </span>entry<span class="_ _11"> </span>from<span class="_"> </span>the<span class="_ _11"> </span>TLB<span class="_ _3"></span>,<span class="_ _11"> </span>the<span class="_"> </span>L1<span class="_ _11"> </span>cache<span class="_"> </span>is<span class="_ _11"> </span>busy<span class="_"> </span>using<span class="_ _11"> </span>the</div><div class="t m5 x28 h2b y707d ff7 fs1e fc2 sc0 ls0 ws0">VPO<span class="_"> </span>bits<span class="_"> </span>to<span class="_"> </span>ﬁnd<span class="_"> </span>the<span class="_"> </span>appropriate<span class="_"> </span>set<span class="_"> </span>and<span class="_"> </span>read<span class="_ _10"> </span>out<span class="_"> </span>the<span class="_"> </span>eight<span class="_ _10"> </span>tags<span class="_"> </span>and<span class="_"> </span>corresponding<span class="_ _10"> </span>data<span class="_"> </span>words<span class="_ _10"> </span>in<span class="_"> </span>that</div><div class="t m5 x28 h2b y707e ff7 fs1e fc2 sc0 ls0 ws0">set.<span class="_ _10"> </span>When<span class="_ _10"> </span>the<span class="_ _11"> </span>MMU<span class="_ _10"> </span>gets<span class="_ _11"> </span>the<span class="_ _11"> </span>PPN<span class="_"> </span>back<span class="_ _11"> </span>from<span class="_ _11"> </span>the<span class="_"> </span>TLB<span class="_ _1"></span>,<span class="_ _11"> </span>the<span class="_ _10"> </span>cache<span class="_ _11"> </span>is<span class="_ _11"> </span>ready<span class="_"> </span>to<span class="_ _11"> </span>try<span class="_ _11"> </span>to<span class="_"> </span>match<span class="_ _11"> </span>the<span class="_ _10"> </span>PPN<span class="_ _11"> </span>to</div><div class="t m5 x28 h2b y707f ff7 fs1e fc2 sc0 ls0 ws0">one<span class="_"> </span>of<span class="_"> </span>these<span class="_"> </span>eight<span class="_"> </span>tags<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y7080 ff7 fs19 fc2 sc0 ls0 ws0">are<span class="_ _16"> </span>shared<span class="_ _16"> </span>by<span class="_ _14"> </span>all<span class="_ _16"> </span>processes<span class="_ _1"></span>.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>example<span class="_ _1"></span>,<span class="_ _14"> </span>each<span class="_ _14"> </span>process<span class="_ _16"> </span>shares<span class="_ _16"> </span>the<span class="_ _16"> </span>kernel’s<span class="_ _16"> </span>code</div><div class="t m5 x1d h26 y7081 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _21"> </span>global<span class="_ _f"> </span>data<span class="_ _21"> </span>structures<span class="_ _1"></span>.<span class="_ _f"> </span>Interestingly<span class="_ _3"></span>,<span class="_ _e"> </span>Linux<span class="_ _21"> </span>also<span class="_ _21"> </span>maps<span class="_ _f"> </span>a<span class="_ _21"> </span>set<span class="_ _f"> </span>of<span class="_ _f"> </span>contiguous</div><div class="t m5 x1d h26 y7082 ff7 fs19 fc2 sc0 ls0 ws0">virtual<span class="_ _16"> </span>pages<span class="_ _11"> </span>(equal<span class="_ _16"> </span>in<span class="_ _16"> </span>size<span class="_ _16"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>total<span class="_ _16"> </span>amount<span class="_ _16"> </span>of<span class="_ _11"> </span>DRAM<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>system)<span class="_ _16"> </span>to<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y7083 ff7 fs19 fc2 sc0 ls0 ws0">corresponding<span class="_ _16"> </span>set<span class="_ _16"> </span>of<span class="_ _16"> </span>contiguous<span class="_ _16"> </span>physical<span class="_ _16"> </span>pages<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>provides<span class="_ _16"> </span>the<span class="_ _16"> </span>kernel<span class="_ _16"> </span>with<span class="_ _16"> </span>a</div><div class="t m5 x1d h26 y7084 ff7 fs19 fc2 sc0 ls0 ws0">convenient<span class="_"> </span>way<span class="_"> </span>to<span class="_"> </span>access<span class="_ _13"> </span>any<span class="_"> </span>speciﬁc<span class="_"> </span>location<span class="_"> </span>in<span class="_"> </span>physical<span class="_"> </span>memory—for<span class="_ _13"> </span>example,</div><div class="t m5 x1d h26 y7085 ff7 fs19 fc2 sc0 ls0 ws0">when<span class="_ _13"> </span>it<span class="_ _6"> </span>needs<span class="_ _13"> </span>to<span class="_ _13"> </span>access<span class="_ _13"> </span>page<span class="_ _6"> </span>tables<span class="_ _13"> </span>or<span class="_ _13"> </span>to<span class="_ _13"> </span>perform<span class="_ _6"> </span>memory-mapped<span class="_ _13"> </span>I/O<span class="_ _13"> </span>operations</div><div class="t m5 x1d h26 y7086 ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_"> </span>devices<span class="_"> </span>that<span class="_"> </span>are<span class="_"> </span>mapped<span class="_"> </span>to<span class="_"> </span>particular<span class="_"> </span>physical<span class="_"> </span>memory<span class="_"> </span>locations<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y7087 ff7 fs19 fc2 sc0 ls0 ws0">Other<span class="_ _21"> </span>regions<span class="_ _f"> </span>of<span class="_ _f"> </span>kernel<span class="_ _f"> </span>virtual<span class="_ _21"> </span>memory<span class="_ _f"> </span>contain<span class="_ _f"> </span>data<span class="_ _f"> </span>that<span class="_ _21"> </span>differ<span class="_ _f"> </span>for<span class="_ _f"> </span>each</div><div class="t m5 x1d h26 y7088 ff7 fs19 fc2 sc0 ls0 ws0">process<span class="_ _1"></span>.<span class="_ _16"> </span>Examples<span class="_ _16"> </span>include<span class="_ _16"> </span>page<span class="_ _16"> </span>tables<span class="_ _0"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>stack<span class="_ _14"> </span>that<span class="_ _16"> </span>the<span class="_ _16"> </span>kernel<span class="_ _16"> </span>uses<span class="_ _16"> </span>when<span class="_ _16"> </span>it<span class="_ _14"> </span>is</div><div class="t m5 x1d h26 y7089 ff7 fs19 fc2 sc0 ls0 ws0">executing<span class="_ _13"> </span>code<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>context<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>process<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _13"> </span>various<span class="_ _13"> </span>data<span class="_ _13"> </span>structures<span class="_ _13"> </span>that<span class="_ _13"> </span>keep</div><div class="t m5 x1d h26 y708a ff7 fs19 fc2 sc0 ls0 ws0">track<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>current<span class="_"> </span>organization<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>virtual<span class="_"> </span>address<span class="_"> </span>space<span class="_ _1"></span>.</div><div class="t m5 x1d h42 y5dd9 ff6 fs29 fc6 sc0 ls0 ws0">Linux<span class="_ _11"> </span>Virtual<span class="_ _16"> </span>Memory<span class="_ _16"> </span>Areas</div><div class="t m5 x1d h26 y464d ff7 fs19 fc1 sc0 ls0 ws0">Linux<span class="_ _13"> </span>organizes<span class="_ _13"> </span>the<span class="_ _13"> </span>virtual<span class="_ _13"> </span>memory<span class="_ _13"> </span>as<span class="_ _13"> </span>a<span class="_ _13"> </span>collection<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ffa">areas<span class="_"> </span></span>(also<span class="_ _13"> </span>called<span class="_ _13"> </span><span class="ffa">segments</span>).</div><div class="t m5 x1d h26 y464e ff7 fs19 fc1 sc0 ls0 ws0">An<span class="_ _13"> </span>area<span class="_ _13"> </span>is<span class="_ _13"> </span>a<span class="_ _13"> </span>contiguous<span class="_ _13"> </span>chunk<span class="_ _13"> </span>of<span class="_ _13"> </span>existing<span class="_ _13"> </span>(allocated)<span class="_ _13"> </span>virtual<span class="_ _13"> </span>memory<span class="_ _13"> </span>whose<span class="_ _13"> </span>pages</div><div class="t m5 x1d h26 y464f ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_ _15"> </span>related<span class="_ _15"> </span>in<span class="_ _15"> </span>some<span class="_ _15"> </span>way<span class="_ _3"></span>.<span class="_ _15"> </span>F<span class="_ _1"></span>or<span class="_ _15"> </span>example<span class="_ _0"></span>,<span class="_ _21"> </span>the<span class="_ _15"> </span>code<span class="_ _15"> </span>segment,<span class="_ _21"> </span>data<span class="_ _15"> </span>segment,<span class="_ _f"> </span>heap<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y4650 ff7 fs19 fc1 sc0 ls0 ws0">shared<span class="_"> </span>library<span class="_"> </span>segment,<span class="_"> </span>and<span class="_"> </span>user<span class="_"> </span>stack<span class="_"> </span>are<span class="_"> </span>all<span class="_"> </span>distinct<span class="_"> </span>areas<span class="_ _1"></span>.<span class="_"> </span>Each<span class="_"> </span>existing<span class="_"> </span>virtual</div><div class="t m5 x1d h26 y4651 ff7 fs19 fc1 sc0 ls0 ws0">page<span class="_"> </span>is<span class="_"> </span>contained<span class="_ _13"> </span>in<span class="_"> </span>some<span class="_"> </span>area,<span class="_"> </span>and<span class="_"> </span>any<span class="_ _13"> </span>virtual<span class="_"> </span>page<span class="_"> </span>that<span class="_"> </span>is<span class="_ _13"> </span>not<span class="_"> </span>part<span class="_"> </span>of<span class="_"> </span>some<span class="_"> </span>area</div><div class="t m5 x1d h26 y1fde ff7 fs19 fc1 sc0 ls0 ws0">does<span class="_ _11"> </span>not<span class="_ _11"> </span>exist<span class="_ _11"> </span>and<span class="_ _11"> </span>cannot<span class="_ _11"> </span>be<span class="_ _11"> </span>referenced<span class="_ _11"> </span>by<span class="_ _11"> </span>the<span class="_ _11"> </span>process<span class="_ _0"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>notion<span class="_ _11"> </span>of<span class="_ _16"> </span>an<span class="_"> </span>area<span class="_ _11"> </span>is</div><div class="t m5 x1d h26 y1fdf ff7 fs19 fc1 sc0 ls0 ws0">important<span class="_ _6"> </span>because<span class="_ _13"> </span>it<span class="_ _6"> </span>allows<span class="_ _13"> </span>the<span class="_ _6"> </span>virtual<span class="_ _13"> </span>address<span class="_ _6"> </span>space<span class="_ _13"> </span>to<span class="_ _6"> </span>have<span class="_ _13"> </span>gaps<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _6"> </span>kernel<span class="_ _13"> </span>does</div><div class="t m5 x1d h26 y4652 ff7 fs19 fc1 sc0 ls0 ws0">not<span class="_"> </span>keep<span class="_"> </span>track<span class="_ _11"> </span>of<span class="_"> </span>virtual<span class="_ _11"> </span>pages<span class="_"> </span>that<span class="_ _11"> </span>do<span class="_"> </span>not<span class="_ _11"> </span>exist,<span class="_"> </span>and<span class="_ _11"> </span>such<span class="_"> </span>pages<span class="_ _11"> </span>do<span class="_"> </span>not<span class="_"> </span>consume</div><div class="t m5 x1d h26 y4653 ff7 fs19 fc1 sc0 ls0 ws0">any<span class="_"> </span>additional<span class="_"> </span>resources<span class="_"> </span>in<span class="_"> </span>memory<span class="_ _3"></span>,<span class="_"> </span>on<span class="_"> </span>disk,<span class="_"> </span>or<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>kernel<span class="_"> </span>itself<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y4654 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>9.27<span class="_"> </span>highlights<span class="_ _13"> </span>the<span class="_"> </span>kernel<span class="_ _13"> </span>data<span class="_"> </span>structures<span class="_ _13"> </span>that<span class="_"> </span>keep<span class="_ _13"> </span>track<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>virtual</div><div class="t m5 x1d h26 y4655 ff7 fs19 fc1 sc0 ls0 ws0">memory<span class="_"> </span>areas<span class="_"> </span>in<span class="_ _11"> </span>a<span class="_"> </span>process<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>kernel<span class="_"> </span>maintains<span class="_"> </span>a<span class="_ _11"> </span>distinct<span class="_"> </span>task<span class="_ _11"> </span>structure<span class="_"> </span>(<span class="ffd">task_</span></div><div class="t m5 x1d h26 y4656 ffd fs19 fc1 sc0 ls0 ws0">struct<span class="_ _6"> </span><span class="ff7">in<span class="_ _13"> </span>the<span class="_ _6"> </span>source<span class="_ _13"> </span>code)<span class="_ _6"> </span>for<span class="_ _13"> </span>each<span class="_ _6"> </span>process<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>system.<span class="_ _6"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>elements<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>task</span></div><div class="t m5 x1d h26 y1fe4 ff7 fs19 fc1 sc0 ls0 ws0">structure<span class="_"> </span>either<span class="_ _13"> </span>contain<span class="_"> </span>or<span class="_ _13"> </span>point<span class="_"> </span>to<span class="_"> </span>all<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>information<span class="_ _13"> </span>that<span class="_"> </span>the<span class="_ _13"> </span>kernel<span class="_"> </span>needs<span class="_"> </span>to</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
