<div id="pf361" class="pf w2 h11" data-page-no="361"><div class="pc pc361 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg361.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">864<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x1e5 h6a y701a ffb6 fs3b fc1 sc0 ls0 ws0">R/W<span class="_ _ee"></span>U/S<span class="_ _19f"></span>WT<span class="_ _206"></span><span class="ls2a7">CD<span class="_ _f2"></span><span class="ls0">A<span class="_ _125"></span><span class="ls2ab">0D<span class="_ _221"></span><span class="ls0">G<span class="_ _222"></span>Page physical base addr<span class="_ _fe"> </span>Unused<span class="_ _101"></span>Unused<span class="_ _21e"> </span><span class="ffb8">P=1</span></span></span></span></span></div><div class="t m5 x5d h6a y701b ffb6 fs3b fc1 sc0 ls0 ws0">Available for OS (page table location on disk)<span class="_ _9e"> </span><span class="ffb8">P=0</span></div><div class="t m5 x226 h8e y701c ffb6 fs54 fc1 sc0 ls0 ws0">0<span class="_ _cc"></span>1<span class="_ _ad"></span>2<span class="_ _cc"></span>3</div><div class="t m5 x1f h6a y701a ffb6 fs3b fc1 sc0 ls0 ws0">XD</div><div class="t m5 xc5 h8e y701c ffb6 fs54 fc1 sc0 ls0 ws0">63<span class="_ _21f"> </span>4<span class="_ _cc"></span>5<span class="_ _ad"></span>6<span class="_ _cc"></span>7<span class="_ _ad"></span>8<span class="_ _c5"></span>9<span class="_ _19f"></span><span class="ls2a8">11<span class="_ _1c4"></span><span class="ls0">12<span class="_ _220"></span>51<span class="_ _208"></span>52<span class="_ _ee"></span>62</span></span></div><div class="t m5 x1d h31 y701d ff7 fs21 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>ield<span class="_ _64"> </span>Description</div><div class="t m5 x1d h31 y701e ff7 fs21 fc2 sc0 ls0 ws0">P<span class="_ _18b"> </span>Child<span class="_"> </span>page<span class="_"> </span>present<span class="_"> </span>in<span class="_"> </span>physical<span class="_"> </span>memory<span class="_"> </span>(1)<span class="_"> </span>or<span class="_"> </span>not<span class="_"> </span>(0).</div><div class="t m5 x1d h31 y701f ff7 fs21 fc2 sc0 ls0 ws0">R/W<span class="_ _148"> </span>Read-only<span class="_"> </span>or<span class="_"> </span>read/write<span class="_"> </span>access<span class="_"> </span>permission<span class="_"> </span>for<span class="_"> </span>child<span class="_"> </span>page<span class="_ _1"></span>.</div><div class="t m5 x1d h31 y7020 ff7 fs21 fc2 sc0 ls0 ws0">U/S<span class="_ _53"> </span>User<span class="_"> </span>or<span class="_"> </span>supervisor<span class="_"> </span>mode<span class="_"> </span>(kernel<span class="_"> </span>mode)<span class="_"> </span>access<span class="_"> </span>permission<span class="_"> </span>for<span class="_"> </span>child<span class="_"> </span>page.</div><div class="t m5 x1d h31 y7021 ff7 fs21 fc2 sc0 ls0 ws0">WT<span class="_ _53"> </span>Write-through<span class="_"> </span>or<span class="_"> </span>write-back<span class="_"> </span>cache<span class="_"> </span>policy<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>child<span class="_"> </span>page<span class="_ _0"></span>.</div><div class="t m5 x1d h31 y7022 ff7 fs21 fc2 sc0 ls0 ws0">CD<span class="_ _1b4"> </span>Cache<span class="_"> </span>disabled<span class="_"> </span>or<span class="_"> </span>enabled.</div><div class="t m5 x1d h31 y7023 ff7 fs21 fc2 sc0 ls0 ws0">A<span class="_ _84"> </span>Reference<span class="_"> </span>bit<span class="_"> </span>(set<span class="_"> </span>by<span class="_"> </span>MMU<span class="_"> </span>on<span class="_"> </span>reads<span class="_"> </span>and<span class="_"> </span>writes<span class="_ _1"></span>,<span class="_"> </span>cleared<span class="_"> </span>by<span class="_"> </span>software).</div><div class="t m5 x1d h31 y7024 ff7 fs21 fc2 sc0 ls0 ws0">D<span class="_ _84"> </span>Dirty<span class="_"> </span>bit<span class="_"> </span>(set<span class="_"> </span>by<span class="_"> </span>MMU<span class="_"> </span>on<span class="_"> </span>writes<span class="_ _1"></span>,<span class="_"> </span>cleared<span class="_"> </span>by<span class="_"> </span>software).</div><div class="t m5 x1d h31 y7025 ff7 fs21 fc2 sc0 ls0 ws0">G<span class="_ _84"> </span>Global<span class="_"> </span>page<span class="_"> </span>(don’t<span class="_"> </span>evict<span class="_"> </span>from<span class="_"> </span>TLB<span class="_"> </span>on<span class="_"> </span>task<span class="_"> </span>switch).</div><div class="t m5 x1d h31 y7026 ff7 fs21 fc2 sc0 ls0 ws0">Base<span class="_"> </span>addr<span class="_ _26"> </span>40<span class="_"> </span>most<span class="_"> </span>signiﬁcant<span class="_"> </span>bits<span class="_"> </span>of<span class="_"> </span>physical<span class="_"> </span>base<span class="_"> </span>address<span class="_"> </span>of<span class="_"> </span>child<span class="_"> </span>page<span class="_ _1"></span>.</div><div class="t m5 x1d h31 y7029 ff7 fs21 fc2 sc0 ls0 ws0">XD<span class="_ _77"> </span>Disable<span class="_"> </span>or<span class="_"> </span>enable<span class="_"> </span>instruction<span class="_"> </span>fetches<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>child<span class="_"> </span>page.</div><div class="t m5 x1d h34 y702a ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.24<span class="_ _c"> </span><span class="fc1">Format<span class="_ _11"> </span>of<span class="_ _11"> </span>level<span class="_"> </span>4<span class="_ _11"> </span>page<span class="_ _11"> </span>table<span class="_ _11"> </span>entries.<span class="_ _11"> </span><span class="ff6">Each<span class="_ _11"> </span>entry<span class="_ _11"> </span>reference<span class="ls2ac">sa4K<span class="_ _4a"></span>B<span class="ls0">child</span></span></span></span></div><div class="t m5 x1d h34 y702b ff6 fs16 fc1 sc0 ls0 ws0">page.</div><div class="t m5 x1d h26 y702c ff7 fs19 fc1 sc0 ls0 ws0">write<span class="_ _11"> </span>back<span class="_ _16"> </span>a<span class="_ _16"> </span>victim<span class="_ _11"> </span>page<span class="_ _16"> </span>before<span class="_ _11"> </span>it<span class="_ _16"> </span>copies<span class="_ _11"> </span>in<span class="_ _16"> </span>a<span class="_ _11"> </span>replacement<span class="_ _16"> </span>page<span class="_ _0"></span>.<span class="_ _11"> </span>The<span class="_ _11"> </span>kernel<span class="_ _11"> </span>can</div><div class="t m5 x1d h26 y702d ff7 fs19 fc1 sc0 ls0 ws0">call<span class="_"> </span>a<span class="_"> </span>special<span class="_"> </span>kernel-mode<span class="_"> </span>instruction<span class="_"> </span>to<span class="_"> </span>clear<span class="_"> </span>the<span class="_"> </span>reference<span class="_"> </span>or<span class="_"> </span>dirty<span class="_"> </span>bits<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y702e ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>9.25<span class="_"> </span>shows<span class="_ _16"> </span>how<span class="_"> </span>the<span class="_ _11"> </span>Core<span class="_ _16"> </span>i7<span class="_"> </span>MMU<span class="_ _16"> </span>uses<span class="_"> </span>the<span class="_ _16"> </span>four<span class="_"> </span>levels<span class="_ _16"> </span>of<span class="_"> </span>page<span class="_ _16"> </span>tables</div><div class="t m5 x1d h26 y702f ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>translate<span class="_"> </span>a<span class="_"> </span>virtual<span class="_"> </span>address<span class="_"> </span>to<span class="_"> </span>a<span class="_ _11"> </span>physical<span class="_"> </span>address<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _0"></span>he<span class="_"> </span>36-bit<span class="_"> </span>VPN<span class="_"> </span>is<span class="_"> </span>partitioned</div><div class="t m5 x1d h26 y7030 ff7 fs19 fc1 sc0 ls0 ws0">into<span class="_ _16"> </span>four<span class="_ _16"> </span>9-bit<span class="_ _16"> </span>chunks<span class="_ _1"></span>,<span class="_ _14"> </span>each<span class="_ _16"> </span>of<span class="_ _14"> </span>which<span class="_ _16"> </span>is<span class="_ _16"> </span>used<span class="_ _16"> </span>as<span class="_ _16"> </span>an<span class="_ _14"> </span>offset<span class="_ _16"> </span>into<span class="_ _16"> </span>a<span class="_ _16"> </span>page<span class="_ _16"> </span>table.<span class="_ _16"> </span>T<span class="_ _1"></span>he</div><div class="t m5 x1d h26 y7031 ff7 fs19 fc1 sc0 ls0 ws0">CR3<span class="_"> </span>register<span class="_ _11"> </span>contains<span class="_"> </span>the<span class="_ _11"> </span>physical<span class="_ _11"> </span>address<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>L1<span class="_"> </span>page<span class="_ _11"> </span>table<span class="_ _0"></span>.<span class="_"> </span>VPN<span class="_ _11"> </span>1<span class="_ _11"> </span>provides</div><div class="t m5 x1d h26 y7032 ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_ _13"> </span>offset<span class="_ _13"> </span>to<span class="_ _13"> </span>an<span class="_ _13"> </span>L1<span class="_ _6"> </span>PTE,<span class="_ _13"> </span>which<span class="_ _13"> </span>contains<span class="_ _13"> </span>the<span class="_ _13"> </span>base<span class="_ _13"> </span>address<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>L2<span class="_ _13"> </span>page<span class="_ _6"> </span>table.<span class="_ _13"> </span>VPN</div><div class="t m5 x1d h26 y7033 ff7 fs19 fc1 sc0 ls0 ws0">2<span class="_"> </span>provides<span class="_"> </span>an<span class="_"> </span>offset<span class="_"> </span>to<span class="_"> </span>an<span class="_"> </span>L2<span class="_"> </span>PTE,<span class="_"> </span>and<span class="_"> </span>so<span class="_"> </span>on.</div><div class="t m5 x1d h41 y630 ffe fs29 fc1 sc0 ls0 ws0">9.7.2<span class="_ _48"> </span><span class="fs19">Linux<span class="_"> </span>Virtual<span class="_"> </span>Memory<span class="_"> </span>System</span></div><div class="t m5 x1d h26 ye4e ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_ _11"> </span>virtual<span class="_ _11"> </span>memory<span class="_ _11"> </span>system<span class="_ _16"> </span>requires<span class="_ _11"> </span>close<span class="_ _11"> </span>cooperation<span class="_ _11"> </span>between<span class="_ _11"> </span>the<span class="_ _16"> </span>hardware<span class="_ _11"> </span>and</div><div class="t m5 x1d h26 ye4f ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _14"> </span>kernel.<span class="_ _14"> </span>Details<span class="_ _14"> </span>vary<span class="_ _14"> </span>from<span class="_ _14"> </span>version<span class="_ _14"> </span>to<span class="_ _14"> </span>version,<span class="_ _15"> </span>and<span class="_ _14"> </span>a<span class="_ _14"> </span>complete<span class="_ _14"> </span>description<span class="_ _14"> </span>is</div><div class="t m5 x1d h26 ye50 ff7 fs19 fc1 sc0 ls0 ws0">beyond<span class="_ _16"> </span>our<span class="_ _16"> </span>scope<span class="_ _1"></span>.<span class="_ _16"> </span>Nonetheless<span class="_ _1"></span>,<span class="_ _16"> </span>our<span class="_ _16"> </span>aim<span class="_ _16"> </span>in<span class="_ _16"> </span>this<span class="_ _16"> </span>section<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _11"> </span>describe<span class="_ _16"> </span>enough<span class="_ _16"> </span>of</div><div class="t m5 x1d h26 ye51 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _6"> </span>Linux<span class="_ _6"> </span>virtual<span class="_ _6"> </span>memory<span class="_ _6"> </span>system<span class="_ _13"> </span>to<span class="_ _a"> </span>give<span class="_ _6"> </span>you<span class="_ _13"> </span>a<span class="_ _a"> </span>sense<span class="_ _6"> </span>of<span class="_ _13"> </span>how<span class="_ _a"> </span>a<span class="_ _6"> </span>real<span class="_ _6"> </span>operating<span class="_ _13"> </span>system</div><div class="t m5 x1d h26 ye52 ff7 fs19 fc1 sc0 ls0 ws0">organizes<span class="_"> </span>virtual<span class="_"> </span>memory<span class="_"> </span>and<span class="_"> </span>how<span class="_"> </span>it<span class="_"> </span>handles<span class="_"> </span>page<span class="_"> </span>faults<span class="_ _1"></span>.</div><div class="t m5 x29 h26 ye53 ff7 fs19 fc1 sc0 ls0 ws0">Linux<span class="_ _13"> </span>maintains<span class="_"> </span>a<span class="_ _13"> </span>separate<span class="_"> </span>virtual<span class="_ _13"> </span>address<span class="_"> </span>space<span class="_ _13"> </span>for<span class="_"> </span>each<span class="_ _13"> </span>process<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>form</div><div class="t m5 x1d h26 ye54 ff7 fs19 fc1 sc0 ls0 ws0">shown<span class="_ _11"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>9.26.<span class="_ _11"> </span>W<span class="_ _1"></span>e<span class="_ _11"> </span>have<span class="_ _11"> </span>seen<span class="_ _11"> </span>this<span class="_ _16"> </span>picture<span class="_"> </span>a<span class="_ _16"> </span>number<span class="_"> </span>of<span class="_ _16"> </span>times<span class="_"> </span>already<span class="_ _3"></span>,<span class="_ _16"> </span>with</div><div class="t m5 x1d h26 ye55 ff7 fs19 fc1 sc0 ls0 ws0">its<span class="_ _15"> </span>familiar<span class="_ _15"> </span>code,<span class="_ _15"> </span>data,<span class="_ _f"> </span>heap<span class="_ _0"></span>,<span class="_ _21"> </span>shared<span class="_ _15"> </span>library<span class="_ _3"></span>,<span class="_ _f"> </span>and<span class="_ _15"> </span>stack<span class="_ _15"> </span>segments<span class="_ _1"></span>.<span class="_ _21"> </span>Now<span class="_ _15"> </span>that<span class="_ _15"> </span>we</div><div class="t m5 x1d h26 ye56 ff7 fs19 fc1 sc0 ls0 ws0">understand<span class="_"> </span>address<span class="_"> </span>translation,<span class="_"> </span>we<span class="_"> </span>can<span class="_"> </span>ﬁll<span class="_"> </span>in<span class="_"> </span>some<span class="_"> </span>more<span class="_"> </span>details<span class="_"> </span>about<span class="_"> </span>the<span class="_"> </span>kernel</div><div class="t m5 x1d h26 ye57 ff7 fs19 fc1 sc0 ls0 ws0">virtual<span class="_"> </span>memory<span class="_"> </span>that<span class="_"> </span>lies<span class="_"> </span>above<span class="_"> </span>the<span class="_"> </span>user<span class="_"> </span>stack.</div><div class="t m5 x29 h26 ye58 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>kernel<span class="_ _6"> </span>virtual<span class="_ _6"> </span>memory<span class="_ _13"> </span>contains<span class="_ _6"> </span>the<span class="_ _6"> </span>code<span class="_ _13"> </span>and<span class="_ _6"> </span>data<span class="_ _6"> </span>structures<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _6"> </span>kernel.</div><div class="t m5 x1d h26 ye59 ff7 fs19 fc1 sc0 ls0 ws0">Some<span class="_ _14"> </span>regions<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _15"> </span>kernel<span class="_ _14"> </span>virtual<span class="_ _14"> </span>memory<span class="_ _15"> </span>are<span class="_ _14"> </span>mapped<span class="_ _14"> </span>to<span class="_ _14"> </span>physical<span class="_ _15"> </span>pages<span class="_ _14"> </span>that</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
