<div id="pf3e4" class="pf w2 h11" data-page-no="3e4"><div class="pc pc3e4 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3e4.png"/><div class="t m5 x23d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>11.6<span class="_ _60"> </span>Putting<span class="_ _10"> </span>It<span class="_ _10"> </span>T<span class="_ _1"></span>ogether:<span class="_ _10"> </span>The<span class="_ _10"> </span><span class="ff1b ls2e5">Ti<span class="_ _2"></span>n<span class="_ _5"> </span>y<span class="_ _16"> </span></span>W<span class="_ _1"></span>eb<span class="_ _10"> </span>Server<span class="_ _3e"> </span><span class="ffe fs1e">995</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">(lines<span class="_ _16"> </span>15–19),<span class="_ _14"> </span>which<span class="_ _14"> </span>then<span class="_ _16"> </span>closes<span class="_ _14"> </span>the<span class="_ _16"> </span>connection<span class="_ _14"> </span>and<span class="_ _16"> </span>awaits<span class="_ _14"> </span>the<span class="_ _16"> </span>next<span class="_ _14"> </span>connection</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">request.<span class="_ _15"> </span>Otherwise<span class="_ _0"></span>,<span class="_ _21"> </span>we<span class="_ _15"> </span>read<span class="_ _21"> </span>and<span class="_ _15"> </span>(as<span class="_ _15"> </span>we<span class="_ _15"> </span>shall<span class="_ _21"> </span>see)<span class="_ _15"> </span>ignore<span class="_ _15"> </span>any<span class="_ _15"> </span>request<span class="_ _21"> </span>headers</div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">(line<span class="_"> </span>20).</div><div class="t m5 x26 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">Next,<span class="_"> </span>we<span class="_"> </span>parse<span class="_"> </span>the<span class="_"> </span>URI<span class="_"> </span>into<span class="_"> </span>a<span class="_ _11"> </span>ﬁlename<span class="_"> </span>and<span class="_"> </span>a<span class="_"> </span>possibly<span class="_"> </span>empty<span class="_"> </span>CGI<span class="_ _11"> </span>argument</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">string,<span class="_ _13"> </span>and<span class="_"> </span>we<span class="_"> </span>set<span class="_ _13"> </span>a<span class="_"> </span>ﬂag<span class="_ _13"> </span>that<span class="_"> </span>indicates<span class="_"> </span>whether<span class="_ _13"> </span>the<span class="_"> </span>request<span class="_ _13"> </span>is<span class="_"> </span>for<span class="_"> </span>static<span class="_ _13"> </span>or<span class="_"> </span>dynamic</div><div class="t m5 x17 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">content<span class="_"> </span>(line<span class="_ _11"> </span>23).<span class="_"> </span>If<span class="_ _11"> </span>the<span class="_"> </span>ﬁle<span class="_ _11"> </span>does<span class="_"> </span>not<span class="_ _11"> </span>exist<span class="_"> </span>on<span class="_ _11"> </span>disk,<span class="_ _11"> </span>we<span class="_"> </span>immediately<span class="_ _11"> </span>send<span class="_"> </span>an<span class="_ _11"> </span>error</div><div class="t m5 x17 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">message<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>client<span class="_"> </span>and<span class="_"> </span>return.</div><div class="t m5 x26 h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>inally<span class="_ _3"></span>,<span class="_ _16"> </span>if<span class="_ _16"> </span>the<span class="_ _11"> </span>request<span class="_ _16"> </span>is<span class="_ _11"> </span>for<span class="_ _16"> </span>static<span class="_ _11"> </span>content,<span class="_ _16"> </span>we<span class="_ _11"> </span>verify<span class="_ _16"> </span>that<span class="_ _11"> </span>the<span class="_ _16"> </span>ﬁle<span class="_ _11"> </span>is<span class="_ _16"> </span>a<span class="_ _11"> </span>regular</div><div class="t m5 x17 h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">ﬁle<span class="_ _11"> </span>and<span class="_ _11"> </span>that<span class="_ _11"> </span>we<span class="_ _11"> </span>have<span class="_ _11"> </span>read<span class="_ _16"> </span>permission<span class="_"> </span>(line<span class="_ _11"> </span>31).<span class="_ _16"> </span>If<span class="_"> </span>so,<span class="_"> </span>we<span class="_ _16"> </span>serve<span class="_"> </span>the<span class="_ _11"> </span>static<span class="_ _16"> </span>content</div><div class="t m5 x17 h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">(line<span class="_ _16"> </span>36)<span class="_ _16"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>client.<span class="_ _16"> </span>Similarly<span class="_ _3"></span>,<span class="_ _16"> </span>if<span class="_ _16"> </span>the<span class="_ _16"> </span>request<span class="_ _16"> </span>is<span class="_ _16"> </span>for<span class="_ _11"> </span>dynamic<span class="_ _16"> </span>content,<span class="_ _16"> </span>we<span class="_ _16"> </span>verify</div><div class="t m5 x17 h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_"> </span>the<span class="_"> </span>ﬁle<span class="_"> </span>is<span class="_"> </span>executable<span class="_"> </span>(line<span class="_ _13"> </span>39),<span class="_"> </span>and,<span class="_"> </span>if<span class="_"> </span>so<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>go<span class="_"> </span>ahead<span class="_"> </span>and<span class="_"> </span>serve<span class="_"> </span>the<span class="_"> </span>dynamic</div><div class="t m5 x17 h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">content<span class="_"> </span>(line<span class="_"> </span>44).</div><div class="t m5 x17 h42 y7df8 ff6 fs29 fc6 sc0 ls0 ws0">The<span class="_ _11"> </span><span class="ffd fs2b">clienterror<span class="_ _16"> </span></span>Function</div><div class="t m5 x17 h26 y7df9 ff9 fs19 fc1 sc0 ls0 ws0">T<span class="_ _3"></span>iny<span class="_ _11"> </span><span class="ff7">lacks<span class="_"> </span>many<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>error<span class="_ _1"></span>-handling<span class="_ _11"> </span>features<span class="_"> </span>of<span class="_ _11"> </span>a<span class="_"> </span>real<span class="_ _11"> </span>server.<span class="_"> </span>However,<span class="_"> </span>it<span class="_"> </span>does</span></div><div class="t m5 x17 h26 y7dfa ff7 fs19 fc1 sc0 ls0 ws0">check<span class="_ _11"> </span>for<span class="_ _11"> </span>some<span class="_ _16"> </span>obvious<span class="_"> </span>errors<span class="_ _16"> </span>and<span class="_ _11"> </span>reports<span class="_ _11"> </span>them<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_"> </span>client.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span><span class="ffd">clienterror</span></div><div class="t m5 x17 h26 y7dfb ff7 fs19 fc1 sc0 ls0 ws0">function<span class="_ _6"> </span>in<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _6"> </span>11.31<span class="_ _13"> </span>sends<span class="_ _6"> </span>an<span class="_ _13"> </span>HTTP<span class="_ _a"> </span>response<span class="_ _13"> </span>to<span class="_ _6"> </span>the<span class="_ _6"> </span>client<span class="_ _13"> </span>with<span class="_ _6"> </span>the<span class="_ _13"> </span>appropriate</div><div class="t m5 x212 h2c y7dfc ffa fs16 fc1 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y7dfd ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>clienterror(int<span class="_ _e"> </span>fd,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*cause,<span class="_ _e"> </span>char<span class="_ _1f"> </span>*errnum,</span></div><div class="t m5 x2c h2d y7dfe ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _17b"> </span><span class="ffd fs1e fc2">char<span class="_ _1f"> </span>*shortmsg,<span class="_ _1f"> </span>char<span class="_ _e"> </span>*longmsg)</span></div><div class="t m5 x2c h2d y7dff ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2e y7e00 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x142 h2d y7e01 ffd fs1e fc2 sc0 ls0 ws0">char<span class="_ _e"> </span>buf[MAXLINE],<span class="_ _1f"> </span>body[MAXBUF];</div><div class="t m5 x2c h2e y7e02 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y7e03 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x142 h2d y6840 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Build<span class="_ _1f"> </span>the<span class="_ _1f"> </span>HTTP<span class="_ _e"> </span>response<span class="_ _1f"> </span>body<span class="_ _e"> </span>*/</div><div class="t m5 x2c h2d y6842 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(body,<span class="_ _e"> </span>&quot;&lt;html&gt;&lt;title&gt;Tiny<span class="_ _1f"> </span>Error&lt;/title&gt;&quot;);</span></div><div class="t m5 x2c h2d y6843 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(body,<span class="_ _e"> </span>&quot;%s&lt;body<span class="_ _1f"> </span>bgcolor=&quot;&quot;ffffff&quot;&quot;&gt;\r\n&quot;,<span class="_ _1f"> </span>body);</span></div><div class="t m5 x2c h2d y7e04 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(body,<span class="_ _e"> </span>&quot;%s%s:<span class="_ _1f"> </span>%s\r\n&quot;,<span class="_ _1f"> </span>body,<span class="_ _e"> </span>errnum,<span class="_ _1f"> </span>shortmsg);</span></div><div class="t m5 x17 h2d y7e05 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(body,<span class="_ _e"> </span>&quot;%s&lt;p&gt;%s:<span class="_ _1f"> </span>%s\r\n&quot;,<span class="_ _1f"> </span>body,<span class="_ _e"> </span>longmsg,<span class="_ _1f"> </span>cause);</span></div><div class="t m5 x17 h2d y7e06 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(body,<span class="_ _e"> </span>&quot;%s&lt;hr&gt;&lt;em&gt;The<span class="_ _1f"> </span>Tiny<span class="_ _1f"> </span>Web<span class="_ _e"> </span>server&lt;/em&gt;\r\n&quot;,<span class="_ _1f"> </span>body);</span></div><div class="t m5 x17 h2e y6848 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x17 h2e y7e07 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x142 h2d y6849 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Print<span class="_ _1f"> </span>the<span class="_ _1f"> </span>HTTP<span class="_ _e"> </span>response<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2e y7e08 ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x142 h2d y684a ffd fs1e fc2 sc0 ls0 ws0">sprintf(buf,<span class="_ _e"> </span>&quot;HTTP/1.0<span class="_ _1f"> </span>%s<span class="_ _1f"> </span>%s\r\n&quot;,<span class="_ _e"> </span>errnum,<span class="_ _1f"> </span>shortmsg);</div><div class="t m5 x17 h2d y684b ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">Rio_writen(fd,<span class="_ _e"> </span>buf,<span class="_ _1f"> </span>strlen(buf));</span></div><div class="t m5 x17 h2d y684c ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(buf,<span class="_ _e"> </span>&quot;Content-type:<span class="_ _1f"> </span>text/html\r\n&quot;);</span></div><div class="t m5 x17 h2d y684d ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _20"> </span><span class="ffd fs1e fc2">Rio_writen(fd,<span class="_ _e"> </span>buf,<span class="_ _1f"> </span>strlen(buf));</span></div><div class="t m5 x17 h2e ya25 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x142 h2d ya26 ffd fs1e fc2 sc0 ls0 ws0">sprintf(buf,<span class="_ _e"> </span>&quot;Content-length:<span class="_ _1f"> </span>%d\r\n\r\n&quot;,<span class="_ _1f"> </span>(int)strlen(body));</div><div class="t m5 x17 h2d y684f ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">Rio_writen(fd,<span class="_ _e"> </span>buf,<span class="_ _1f"> </span>strlen(buf));</span></div><div class="t m5 x17 h2d y1862 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">Rio_writen(fd,<span class="_ _e"> </span>body,<span class="_ _1f"> </span>strlen(body));</span></div><div class="t m5 x17 h2d y18db ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x212 h2c y6850 ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y6851 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>11.31<span class="_ _66"> </span><span class="ff1b fc1 ls2e6">Ti<span class="_ _5"></span>n<span class="_ _5"></span>y</span></div><div class="t m5 x13 h3a y126e ffd fs19 fc1 sc0 ls0 ws0">clienterror<span class="_ _10"> </span><span class="ffe fs16">sends<span class="_"> </span>an<span class="_"> </span>error<span class="_"> </span>message<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>client.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
