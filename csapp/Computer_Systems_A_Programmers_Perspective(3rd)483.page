<div id="pf1e3" class="pf w2 h11" data-page-no="1e3"><div class="pc pc1e3 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1e3.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">482<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>4<span class="_ _3d"> </span>Processor<span class="_ _10"> </span>Architecture</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_"> </span>third<span class="_ _11"> </span>subtlety<span class="_"> </span>arises<span class="_ _11"> </span>because<span class="_"> </span>a<span class="_ _11"> </span>pipelined<span class="_ _11"> </span>processor<span class="_"> </span>updates<span class="_ _11"> </span>different<span class="_"> </span>parts</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _16"> </span>the<span class="_ _16"> </span>system<span class="_ _16"> </span>state<span class="_ _16"> </span>in<span class="_ _16"> </span>different<span class="_ _14"> </span>stages<span class="_ _1"></span>.<span class="_ _16"> </span>It<span class="_ _16"> </span>is<span class="_ _16"> </span>possible<span class="_ _16"> </span>for<span class="_ _14"> </span>an<span class="_ _16"> </span>instruction<span class="_ _16"> </span>following</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">one<span class="_ _15"> </span>causing<span class="_ _15"> </span>an<span class="_ _21"> </span>exception<span class="_ _15"> </span>to<span class="_ _21"> </span>alter<span class="_ _15"> </span>some<span class="_ _21"> </span>part<span class="_ _15"> </span>of<span class="_ _21"> </span>the<span class="_ _15"> </span>state<span class="_ _21"> </span>before<span class="_ _15"> </span>the<span class="_ _15"> </span>excepting</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">instruction<span class="_ _f"> </span>completes<span class="_ _1"></span>.<span class="_ _f"> </span>F<span class="_ _1"></span>or<span class="_ _f"> </span>example,<span class="_ _e"> </span>consider<span class="_ _21"> </span>the<span class="_ _f"> </span>following<span class="_ _f"> </span>code<span class="_ _f"> </span>sequence,<span class="_ _e"> </span>in</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_ _16"> </span>we<span class="_ _16"> </span>assume<span class="_ _11"> </span>that<span class="_ _16"> </span>user<span class="_ _16"> </span>programs<span class="_ _16"> </span>are<span class="_ _16"> </span>not<span class="_ _16"> </span>allowed<span class="_ _11"> </span>to<span class="_ _16"> </span>access<span class="_ _16"> </span>addresses<span class="_ _16"> </span>at<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">upper<span class="_"> </span>end<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>64-bit<span class="_"> </span>range:</div><div class="t m5 x1f h2d yed0 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _45"> </span><span class="ffd fs1e fc2">irmovq<span class="_ _e"> </span>$1,%rax</span></div><div class="t m5 x1f h2d y20fe ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">xorq<span class="_ _e"> </span>%rsp,%rsp<span class="_ _3f"> </span>#<span class="_ _1f"> </span>Set<span class="_ _1f"> </span>stack<span class="_ _e"> </span>pointer<span class="_ _1f"> </span>to<span class="_ _e"> </span>0<span class="_ _1f"> </span>and<span class="_ _1f"> </span>CC<span class="_ _e"> </span>to<span class="_ _1f"> </span>100</span></div><div class="t m5 x1f h2d yed3 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">pushq<span class="_ _e"> </span>%rax<span class="_ _2b"> </span>#<span class="_ _e"> </span>Attempt<span class="_ _1f"> </span>to<span class="_ _1f"> </span>write<span class="_ _e"> </span>to<span class="_ _1f"> </span>0xfffffffffffffff8</span></div><div class="t m5 x1f h2d yed4 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _1a"> </span>%rax,%rax<span class="_ _1a"> </span>#<span class="_ _e"> </span>(Should<span class="_ _1f"> </span>not<span class="_ _1f"> </span>be<span class="_ _e"> </span>executed)<span class="_ _1f"> </span>Would<span class="_ _e"> </span>set<span class="_ _1f"> </span>CC<span class="_ _1f"> </span>to<span class="_ _e"> </span>000</span></div><div class="t m5 x29 h26 y26dd ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_"> </span><span class="ffd ls0">pushq<span class="_ _13"> </span><span class="ff7">instruction<span class="_ _13"> </span>causes<span class="_ _6"> </span>an<span class="_ _13"> </span>address<span class="_ _13"> </span>exception,<span class="_ _6"> </span>because<span class="_ _13"> </span>decrementing<span class="_ _13"> </span>the</span></span></div><div class="t m5 x1d h26 y4345 ff7 fs19 fc2 sc0 ls0 ws0">stack<span class="_ _16"> </span>pointer<span class="_ _16"> </span>causes<span class="_ _16"> </span>it<span class="_ _16"> </span>to<span class="_ _16"> </span>wrap<span class="_ _16"> </span>around<span class="_ _14"> </span>to<span class="_ _16"> </span><span class="ffd">0xfffffffffffffff8</span>.<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _14"> </span>exception</div><div class="t m5 x1d h26 y4346 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _14"> </span>detected<span class="_ _15"> </span>in<span class="_ _15"> </span>the<span class="_ _14"> </span>memory<span class="_ _15"> </span>stage<span class="_ _0"></span>.<span class="_ _14"> </span>On<span class="_ _15"> </span>the<span class="_ _15"> </span>same<span class="_ _14"> </span>cycle<span class="_ _1"></span>,<span class="_ _21"> </span>the<span class="_ _15"> </span><span class="ffd">addq<span class="_ _14"> </span></span>instruction<span class="_ _15"> </span>is<span class="_ _15"> </span>in</div><div class="t m5 x1d h26 y4347 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>execute<span class="_ _16"> </span>stage<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _16"> </span>it<span class="_ _16"> </span>will<span class="_ _16"> </span>cause<span class="_ _16"> </span>the<span class="_ _16"> </span>condition<span class="_ _14"> </span>codes<span class="_ _16"> </span>to<span class="_ _16"> </span>be<span class="_ _16"> </span>set<span class="_ _16"> </span>to<span class="_ _16"> </span>new<span class="_ _16"> </span>values<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y4348 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _14"> </span>would<span class="_ _14"> </span>violate<span class="_ _14"> </span>our<span class="_ _14"> </span>requirement<span class="_ _14"> </span>that<span class="_ _14"> </span>none<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>instructions<span class="_ _14"> </span>following<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y4349 ff7 fs19 fc2 sc0 ls0 ws0">excepting<span class="_"> </span>instruction<span class="_"> </span>should<span class="_"> </span>have<span class="_"> </span>had<span class="_"> </span>any<span class="_"> </span>effect<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>system<span class="_"> </span>state<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y434a ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_"> </span>general,<span class="_"> </span>we<span class="_"> </span>can<span class="_"> </span>both<span class="_ _13"> </span>correctly<span class="_"> </span>choose<span class="_"> </span>among<span class="_"> </span>the<span class="_"> </span>different<span class="_"> </span>exceptions<span class="_"> </span>and</div><div class="t m5 x1d h26 y434b ff7 fs19 fc2 sc0 ls0 ws0">avoid<span class="_ _21"> </span>raising<span class="_ _f"> </span>exceptions<span class="_ _21"> </span>for<span class="_ _f"> </span>instructions<span class="_ _21"> </span>that<span class="_ _f"> </span>are<span class="_ _21"> </span>fetched<span class="_ _f"> </span>due<span class="_ _21"> </span>to<span class="_ _f"> </span>mispredicted</div><div class="t m5 x1d h26 y434c ff7 fs19 fc2 sc0 ls0 ws0">branches<span class="_ _13"> </span>by<span class="_ _6"> </span>merging<span class="_ _13"> </span>the<span class="_ _6"> </span>exception-handling<span class="_ _13"> </span>logic<span class="_ _6"> </span>into<span class="_ _13"> </span>the<span class="_ _6"> </span>pipeline<span class="_ _13"> </span>structure<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>hat</div><div class="t m5 x1d h26 y434d ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _6"> </span>the<span class="_ _13"> </span>motivation<span class="_ _6"> </span>for<span class="_ _13"> </span>us<span class="_ _6"> </span>to<span class="_ _6"> </span>include<span class="_ _13"> </span>a<span class="_ _6"> </span>status<span class="_ _13"> </span>code<span class="_ _a"> </span><span class="ff6">stat<span class="_ _13"> </span></span>in<span class="_ _6"> </span>each<span class="_ _13"> </span>of<span class="_ _a"> </span>our<span class="_ _13"> </span>pipeline<span class="_ _6"> </span>registers</div><div class="t m5 x1d h26 y434e ff7 fs19 fc2 sc0 ls0 ws0">(F<span class="_ _1"></span>igures<span class="_ _11"> </span>4.41<span class="_"> </span>and<span class="_ _11"> </span>4.52).<span class="_"> </span>If<span class="_ _11"> </span>an<span class="_"> </span>instruction<span class="_ _11"> </span>generates<span class="_"> </span>an<span class="_ _11"> </span>exception<span class="_"> </span>at<span class="_ _11"> </span>some<span class="_"> </span>stage<span class="_ _11"> </span>in</div><div class="t m5 x1d h26 y434f ff7 fs19 fc2 sc0 ls0 ws0">its<span class="_ _16"> </span>processing,<span class="_ _16"> </span>the<span class="_ _11"> </span>status<span class="_ _16"> </span>ﬁeld<span class="_ _16"> </span>is<span class="_ _16"> </span>set<span class="_ _16"> </span>to<span class="_ _16"> </span>indicate<span class="_ _16"> </span>the<span class="_ _11"> </span>nature<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>exception.<span class="_ _16"> </span>T<span class="_ _1"></span>he</div><div class="t m5 x1d h26 y4350 ff7 fs19 fc2 sc0 ls0 ws0">exception<span class="_"> </span>status<span class="_"> </span>propagates<span class="_ _13"> </span>through<span class="_"> </span>the<span class="_"> </span>pipeline<span class="_"> </span>with<span class="_ _13"> </span>the<span class="_"> </span>rest<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>information</div><div class="t m5 x1d h26 y4351 ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_ _13"> </span>that<span class="_ _6"> </span>instruction,<span class="_ _13"> </span>until<span class="_ _13"> </span>it<span class="_ _13"> </span>reaches<span class="_ _6"> </span>the<span class="_ _13"> </span>write-back<span class="_ _13"> </span>stage<span class="_ _1"></span>.<span class="_ _13"> </span>At<span class="_ _6"> </span>this<span class="_ _13"> </span>point,<span class="_ _13"> </span>the<span class="_ _6"> </span>pipeline</div><div class="t m5 x1d h26 y4352 ff7 fs19 fc2 sc0 ls0 ws0">control<span class="_"> </span>logic<span class="_"> </span>detects<span class="_"> </span>the<span class="_"> </span>occurrence<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>exception<span class="_"> </span>and<span class="_"> </span>stops<span class="_"> </span>execution.</div><div class="t m5 x29 h26 y4353 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_"> </span>avoid<span class="_ _13"> </span>having<span class="_"> </span>any<span class="_ _13"> </span>updating<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>programmer<span class="_ _1"></span>-visible<span class="_"> </span>state<span class="_ _13"> </span>by<span class="_"> </span>instructions</div><div class="t m5 x1d h26 y4354 ff7 fs19 fc2 sc0 ls0 ws0">beyond<span class="_ _f"> </span>the<span class="_ _f"> </span>excepting<span class="_ _f"> </span>instruction,<span class="_ _e"> </span>the<span class="_ _f"> </span>pipeline<span class="_ _f"> </span>control<span class="_ _f"> </span>logic<span class="_ _f"> </span>must<span class="_ _f"> </span>disable<span class="_ _f"> </span>any</div><div class="t m5 x1d h26 y4355 ff7 fs19 fc2 sc0 ls0 ws0">updating<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>condition<span class="_ _6"> </span>code<span class="_ _13"> </span>register<span class="_ _13"> </span>or<span class="_ _13"> </span>the<span class="_ _13"> </span>data<span class="_ _13"> </span>memory<span class="_ _13"> </span>when<span class="_ _6"> </span>an<span class="_ _13"> </span>instruction<span class="_ _13"> </span>in</div><div class="t m5 x1d h26 y4356 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _6"> </span>memory<span class="_ _13"> </span>or<span class="_ _a"> </span>write-back<span class="_ _13"> </span>stages<span class="_ _6"> </span>has<span class="_ _6"> </span>caused<span class="_ _13"> </span>an<span class="_ _6"> </span>exception.<span class="_ _6"> </span>In<span class="_ _13"> </span>the<span class="_ _6"> </span>example<span class="_ _6"> </span>program</div><div class="t m5 x1d h26 y4357 ff7 fs19 fc2 sc0 ls0 ws0">above<span class="_ _1"></span>,<span class="_"> </span>the<span class="_ _13"> </span>control<span class="_ _13"> </span>logic<span class="_"> </span>will<span class="_ _13"> </span>detect<span class="_ _13"> </span>that<span class="_"> </span>the<span class="_ _13"> </span><span class="ffd">pushq<span class="_ _13"> </span></span>in<span class="_"> </span>the<span class="_ _13"> </span>memory<span class="_ _13"> </span>stage<span class="_ _13"> </span>has<span class="_"> </span>caused</div><div class="t m5 x1d h26 y4358 ff7 fs19 fc2 sc0 ls0 ws0">an<span class="_ _14"> </span>exception,<span class="_ _15"> </span>and<span class="_ _14"> </span>therefore<span class="_ _14"> </span>the<span class="_ _14"> </span>updating<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _15"> </span>condition<span class="_ _14"> </span>code<span class="_ _14"> </span>register<span class="_ _14"> </span>by<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y4359 ffd fs19 fc2 sc0 ls0 ws0">addq<span class="_ _10"> </span><span class="ff7">instruction<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>execute<span class="_"> </span>stage<span class="_"> </span>will<span class="_"> </span>be<span class="_"> </span>disabled.</span></div><div class="t m5 x29 h26 y435a ff7 fs19 fc2 sc0 ls0 ws0">Let<span class="_ _11"> </span>us<span class="_ _16"> </span>consider<span class="_ _11"> </span>how<span class="_ _16"> </span>this<span class="_ _11"> </span>method<span class="_ _16"> </span>of<span class="_ _11"> </span>handling<span class="_ _16"> </span>exceptions<span class="_ _11"> </span>deals<span class="_ _16"> </span>with<span class="_ _11"> </span>the<span class="_ _16"> </span>sub-</div><div class="t m5 x1d h26 y435b ff7 fs19 fc2 sc0 ls0 ws0">tleties<span class="_"> </span>we<span class="_"> </span>have<span class="_ _11"> </span>mentioned.<span class="_"> </span>When<span class="_"> </span>an<span class="_ _11"> </span>exception<span class="_"> </span>occurs<span class="_ _11"> </span>in<span class="_"> </span>one<span class="_"> </span>or<span class="_ _11"> </span>more<span class="_"> </span>stages<span class="_ _11"> </span>of<span class="_"> </span>a</div><div class="t m5 x1d h26 y435c ff7 fs19 fc2 sc0 ls0 ws0">pipeline<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>information<span class="_ _16"> </span>is<span class="_ _11"> </span>simply<span class="_ _16"> </span>stored<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _16"> </span>status<span class="_ _11"> </span>ﬁelds<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>pipeline<span class="_ _16"> </span>reg-</div><div class="t m5 x1d h26 y435d ff7 fs19 fc2 sc0 ls0 ws0">isters<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>event<span class="_"> </span>has<span class="_ _11"> </span>no<span class="_ _11"> </span>effect<span class="_ _11"> </span>on<span class="_ _16"> </span>the<span class="_"> </span>ﬂow<span class="_ _11"> </span>of<span class="_ _11"> </span>instructions<span class="_ _16"> </span>in<span class="_"> </span>the<span class="_ _11"> </span>pipeline<span class="_ _11"> </span>until<span class="_ _11"> </span>an</div><div class="t m5 x1d h26 y435e ff7 fs19 fc2 sc0 ls0 ws0">excepting<span class="_ _13"> </span>instruction<span class="_ _13"> </span>reaches<span class="_ _13"> </span>the<span class="_"> </span>ﬁnal<span class="_ _13"> </span>pipeline<span class="_ _13"> </span>stage<span class="_ _1"></span>,<span class="_"> </span>except<span class="_ _13"> </span>to<span class="_ _13"> </span>disable<span class="_ _13"> </span>any<span class="_ _13"> </span>updat-</div><div class="t m5 x1d h26 y435f ff7 fs19 fc2 sc0 ls0 ws0">ing<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>programmer<span class="_ _1"></span>-visible<span class="_"> </span>state<span class="_ _13"> </span>(the<span class="_ _13"> </span>condition<span class="_"> </span>code<span class="_ _13"> </span>register<span class="_ _13"> </span>and<span class="_"> </span>the<span class="_ _13"> </span>memory)</div><div class="t m5 x1d h26 y4360 ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_"> </span>later<span class="_"> </span>instructions<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>pipeline<span class="_ _1"></span>.<span class="_"> </span>Since<span class="_"> </span>instructions<span class="_"> </span>reach<span class="_"> </span>the<span class="_"> </span>write-back<span class="_"> </span>stage</div><div class="t m5 x1d h26 y4361 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_"> </span>the<span class="_"> </span>same<span class="_"> </span>order<span class="_"> </span>as<span class="_"> </span>they<span class="_"> </span>would<span class="_"> </span>be<span class="_"> </span>executed<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>nonpipelined<span class="_"> </span>processor,<span class="_"> </span>we<span class="_"> </span>are</div><div class="t m5 x1d h26 y4362 ff7 fs19 fc2 sc0 ls0 ws0">guaranteed<span class="_"> </span>that<span class="_"> </span>the<span class="_ _11"> </span>ﬁrst<span class="_"> </span>instruction<span class="_"> </span>encountering<span class="_ _11"> </span>an<span class="_"> </span>exception<span class="_"> </span>will<span class="_ _11"> </span>arrive<span class="_"> </span>ﬁrst<span class="_"> </span>in</div><div class="t m5 x1d h26 y4363 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>write-back<span class="_ _16"> </span>stage,<span class="_ _16"> </span>at<span class="_ _16"> </span>which<span class="_ _14"> </span>point<span class="_ _16"> </span>program<span class="_ _16"> </span>execution<span class="_ _14"> </span>can<span class="_ _16"> </span>stop<span class="_ _16"> </span>and<span class="_ _14"> </span>the<span class="_ _16"> </span>status</div><div class="t m5 x1d h26 y4364 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _14"> </span>in<span class="_ _14"> </span>pipeline<span class="_ _14"> </span>register<span class="_ _14"> </span>W<span class="_ _16"> </span>can<span class="_ _14"> </span>be<span class="_ _14"> </span>recorded<span class="_ _14"> </span>as<span class="_ _14"> </span>the<span class="_ _14"> </span>program<span class="_ _14"> </span>status<span class="_ _1"></span>.<span class="_ _14"> </span>If<span class="_ _14"> </span>some<span class="_ _14"> </span>in-</div><div class="t m5 x1d h26 y4365 ff7 fs19 fc2 sc0 ls0 ws0">struction<span class="_ _13"> </span>is<span class="_ _13"> </span>fetched<span class="_ _13"> </span>but<span class="_ _13"> </span>later<span class="_"> </span>canceled,<span class="_ _13"> </span>any<span class="_ _13"> </span>exception<span class="_ _13"> </span>status<span class="_ _13"> </span>information<span class="_ _13"> </span>about<span class="_ _13"> </span>the</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
