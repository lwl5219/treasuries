<div id="pf23d" class="pf w2 h11" data-page-no="23d"><div class="pc pc23d w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg23d.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">572<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1d h3b y9c fff fs24 fc6 sc0 ls0 ws0">5.9<span class="_ _17"> </span><span class="ffe fs18">Enhancing<span class="_"> </span>Parallelism</span></div><div class="t m5 x1d h26 y327 ff7 fs19 fc1 sc0 ls0 ws0">At<span class="_ _11"> </span>this<span class="_ _16"> </span>point,<span class="_ _11"> </span>our<span class="_ _16"> </span>functions<span class="_ _11"> </span>have<span class="_ _11"> </span>hit<span class="_ _16"> </span>the<span class="_ _11"> </span>bounds<span class="_ _16"> </span>imposed<span class="_ _11"> </span>by<span class="_ _11"> </span>the<span class="_ _16"> </span>latencies<span class="_ _11"> </span>of<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y328 ff7 fs19 fc1 sc0 ls0 ws0">arithmetic<span class="_"> </span>units<span class="_ _3"></span>.<span class="_"> </span>As<span class="_"> </span>we<span class="_"> </span>have<span class="_"> </span>noted,<span class="_"> </span>however<span class="_ _0"></span>,<span class="_"> </span>the<span class="_"> </span>functional<span class="_"> </span>units<span class="_ _13"> </span>performing<span class="_"> </span>ad-</div><div class="t m5 x1d h26 y329 ff7 fs19 fc1 sc0 ls0 ws0">dition<span class="_ _11"> </span>and<span class="_ _11"> </span>multiplication<span class="_ _11"> </span>are<span class="_"> </span>all<span class="_ _11"> </span>fully<span class="_ _11"> </span>pipelined,<span class="_ _16"> </span>meaning<span class="_"> </span>that<span class="_ _11"> </span>they<span class="_ _11"> </span>can<span class="_ _11"> </span>start<span class="_ _11"> </span>new</div><div class="t m5 x1d h26 y32a ff7 fs19 fc1 sc0 ls0 ws0">operations<span class="_ _14"> </span>every<span class="_ _14"> </span>clock<span class="_ _14"> </span>cycle<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _14"> </span>some<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>operations<span class="_ _14"> </span>can<span class="_ _14"> </span>be<span class="_ _14"> </span>performed<span class="_ _14"> </span>by</div><div class="t m5 x1d h26 y32b ff7 fs19 fc1 sc0 ls0 ws0">multiple<span class="_ _11"> </span>functional<span class="_ _11"> </span>units<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>hardware<span class="_ _16"> </span>has<span class="_ _11"> </span>the<span class="_ _11"> </span>potential<span class="_ _11"> </span>to<span class="_ _16"> </span>perform<span class="_ _11"> </span>multiplica-</div><div class="t m5 x1d h26 y32c ff7 fs19 fc1 sc0 ls0 ws0">tions<span class="_"> </span>and<span class="_"> </span>additions<span class="_"> </span>at<span class="_"> </span>a<span class="_"> </span>much<span class="_"> </span>higher<span class="_"> </span>rate<span class="_ _1"></span>,<span class="_"> </span>but<span class="_"> </span>our<span class="_"> </span>code<span class="_"> </span>cannot<span class="_"> </span>take<span class="_"> </span>advantage<span class="_"> </span>of</div><div class="t m5 x1d h26 y32d ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>capability<span class="_ _7"></span>,<span class="_"> </span>even<span class="_"> </span>with<span class="_"> </span>loop<span class="_"> </span>unrolling<span class="_ _1"></span>,<span class="_"> </span>since<span class="_"> </span>we<span class="_"> </span>are<span class="_"> </span>accumulating<span class="_ _13"> </span>the<span class="_"> </span>value<span class="_"> </span>as<span class="_"> </span>a</div><div class="t m5 x1d h26 y32e ff7 fs19 fc1 sc0 ls0 ws0">single<span class="_ _11"> </span>variable<span class="_ _11"> </span><span class="ffd">acc</span>.<span class="_ _11"> </span>W<span class="_ _1"></span>e<span class="_ _11"> </span>cannot<span class="_ _11"> </span>compute<span class="_ _16"> </span>a<span class="_ _11"> </span>new<span class="_ _11"> </span>value<span class="_ _11"> </span>for<span class="_ _11"> </span><span class="ffd">acc<span class="_ _16"> </span></span>until<span class="_"> </span>the<span class="_ _16"> </span>preceding</div><div class="t m5 x1d h26 y1cf ff7 fs19 fc1 sc0 ls0 ws0">computation<span class="_ _16"> </span>has<span class="_ _14"> </span>completed.<span class="_ _16"> </span>Even<span class="_ _14"> </span>though<span class="_ _16"> </span>the<span class="_ _14"> </span>functional<span class="_ _14"> </span>unit<span class="_ _16"> </span>computing<span class="_ _14"> </span>a<span class="_ _16"> </span>new</div><div class="t m5 x1d h26 y32f ff7 fs19 fc1 sc0 ls0 ws0">value<span class="_ _16"> </span>for<span class="_ _14"> </span><span class="ffd">acc<span class="_ _14"> </span></span>can<span class="_ _16"> </span>start<span class="_ _14"> </span>a<span class="_ _16"> </span>new<span class="_ _14"> </span>operation<span class="_ _14"> </span>every<span class="_ _16"> </span>clock<span class="_ _14"> </span>cycle<span class="_ _1"></span>,<span class="_ _14"> </span>it<span class="_ _14"> </span>will<span class="_ _14"> </span>only<span class="_ _16"> </span>start<span class="_ _14"> </span>one</div><div class="t m5 x1d h26 y330 ff7 fs19 fc1 sc0 ls0 ws0">every<span class="_ _16"> </span><span class="ff11">L<span class="_ _16"> </span></span>c<span class="_ _0"></span>ycles<span class="_ _1"></span>,<span class="_ _16"> </span>where<span class="_ _16"> </span><span class="ff11">L<span class="_"> </span></span>is<span class="_ _11"> </span>the<span class="_ _16"> </span>latency<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>combining<span class="_ _16"> </span>operation.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>will<span class="_ _16"> </span>now</div><div class="t m5 x1d h26 y331 ff7 fs19 fc1 sc0 ls0 ws0">investigate<span class="_"> </span>ways<span class="_ _13"> </span>to<span class="_"> </span>break<span class="_ _13"> </span>this<span class="_"> </span>sequential<span class="_"> </span>dependenc<span class="_ _0"></span>y<span class="_"> </span>and<span class="_ _13"> </span>get<span class="_"> </span>performance<span class="_ _13"> </span>better</div><div class="t m5 x1d h26 y4da6 ff7 fs19 fc1 sc0 ls0 ws0">than<span class="_"> </span>the<span class="_"> </span>latency<span class="_"> </span>bound.</div><div class="t m5 x1d h41 y4da7 ffe fs29 fc1 sc0 ls0 ws0">5.9.1<span class="_ _48"> </span><span class="fs19">Multiple<span class="_"> </span>Accumulators</span></div><div class="t m5 x1d h26 y4da8 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_ _16"> </span>a<span class="_ _16"> </span>combining<span class="_ _14"> </span>operation<span class="_ _16"> </span>that<span class="_ _16"> </span>is<span class="_ _14"> </span>associative<span class="_ _16"> </span>and<span class="_ _16"> </span>commutative,<span class="_ _16"> </span>such<span class="_ _16"> </span>as<span class="_ _16"> </span>integer</div><div class="t m5 x1d h26 y4da9 ff7 fs19 fc1 sc0 ls0 ws0">addition<span class="_ _14"> </span>or<span class="_ _15"> </span>multiplication,<span class="_ _15"> </span>we<span class="_ _15"> </span>can<span class="_ _14"> </span>improve<span class="_ _15"> </span>performance<span class="_ _14"> </span>by<span class="_ _15"> </span>splitting<span class="_ _14"> </span>the<span class="_ _15"> </span>set<span class="_ _14"> </span>of</div><div class="t m5 x1d h26 y4daa ff7 fs19 fc1 sc0 ls0 ws0">combining<span class="_ _14"> </span>operations<span class="_ _15"> </span>into<span class="_ _14"> </span>two<span class="_ _14"> </span>or<span class="_ _15"> </span>more<span class="_ _14"> </span>parts<span class="_ _15"> </span>and<span class="_ _14"> </span>combining<span class="_ _15"> </span>the<span class="_ _14"> </span>results<span class="_ _15"> </span>at<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y4dab ff7 fs19 fc1 sc0 ls0 ws0">end.<span class="_"> </span>F<span class="_ _1"></span>or<span class="_"> </span>example<span class="_ _1"></span>,<span class="_"> </span>let<span class="_"> </span><span class="ff11">P</span></div><div class="t m5 x117 h50 y4dac ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 x206 h26 y4dad ff7 fs19 fc1 sc0 ls0 ws0">denote<span class="_"> </span>the<span class="_"> </span>product<span class="_"> </span>of<span class="_"> </span>elements<span class="_"> </span><span class="ff11">a</span></div><div class="t m5 x23f h3c y4dac ff7 fs25 fc1 sc0 ls0 ws0">0</div><div class="t m5 x169 h45 y4dae ff11 fs19 fc1 sc0 ls42 ws0">,a</div><div class="t m5 x1f0 h3c y4daf ff7 fs25 fc1 sc0 ls0 ws0">1</div><div class="t m5 x1e0 h45 y4dae ff11 fs19 fc1 sc0 ls42 ws0">,...,a</div><div class="t m5 x109 h4b y4daf ff11 fs25 fc1 sc0 ls0 ws0">n<span class="ff12">−<span class="ff7">1</span></span></div><div class="t m5 x6f h26 y4db0 ff7 fs19 fc1 sc0 ls0 ws0">:</div><div class="t m5 x20c h45 y4db1 ff11 fs19 fc1 sc0 ls0 ws0">P</div><div class="t m5 x139 h50 y4db2 ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 x13d h46 y4db3 ff12 fs19 fc1 sc0 ls0 ws0">=</div><div class="t m5 x24 h4b y4db4 ff11 fs25 fc1 sc0 ls0 ws0">n<span class="ff12">−<span class="ff7">1</span></span></div><div class="t m5 x3f h5c y4db5 ff1e fs19 fc1 sc0 ls0 ws0"></div><div class="t m5 x3f h4b y4db6 ff11 fs25 fc1 sc0 ls0 ws0">i<span class="_ _2"></span><span class="ff12">=<span class="ff7">0</span></span></div><div class="t m5 xfb h45 y4db3 ff11 fs19 fc1 sc0 ls0 ws0">a</div><div class="t m5 x1bb h50 y4db2 ff11 fs25 fc1 sc0 ls0 ws0">i</div><div class="t m5 x1d h26 y4db7 ff7 fs19 fc1 sc0 ls0 ws0">Assuming<span class="_"> </span><span class="ff11">n<span class="_ _11"> </span></span>is<span class="_"> </span>even,<span class="_ _11"> </span>we<span class="_"> </span>can<span class="_ _11"> </span>also<span class="_"> </span>write<span class="_ _11"> </span>this<span class="_ _11"> </span>as<span class="_"> </span><span class="ff11">P</span></div><div class="t m5 xf9 h50 y4db8 ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 x1df h46 y4db7 ff12 fs19 fc1 sc0 ls0 ws0">=<span class="_ _13"> </span><span class="ffa">PE</span></div><div class="t m5 x22f h50 y4db8 ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 xf3 h46 y4db7 ff12 fs19 fc1 sc0 ls0 ws0">×<span class="_ _13"> </span><span class="ffa">PO</span></div><div class="t m5 x261 h50 y4db8 ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 x44 h26 y4db7 ff7 fs19 fc1 sc0 ls0 ws0">,<span class="_"> </span>where<span class="_ _11"> </span><span class="ffa">PE</span></div><div class="t m5 x216 h50 y4db8 ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 x149 h26 y4db7 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_"> </span>the</div><div class="t m5 x1d h26 y4db9 ff7 fs19 fc1 sc0 ls0 ws0">product<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>elements<span class="_ _13"> </span>with<span class="_ _13"> </span>even<span class="_ _13"> </span>indices<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _13"> </span><span class="ffa">PO</span></div><div class="t m5 x6c h50 y4dba ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 x6b h26 y4dbb ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _13"> </span>the<span class="_ _13"> </span>product<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>elements</div><div class="t m5 x1d h26 y4dbc ff7 fs19 fc1 sc0 ls0 ws0">with<span class="_"> </span>odd<span class="_"> </span>indices:</div><div class="t m5 xd3 h30 y4dbd ffa fs19 fc1 sc0 ls0 ws0">PE</div><div class="t m5 x20c h50 y4dbe ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 x179 h46 y4dbf ff12 fs19 fc1 sc0 ls0 ws0">=</div><div class="t m5 xb1 h4b y4dc0 ff11 fs25 fc1 sc0 ls0 ws0">n/<span class="ff7">2<span class="ff12">−</span>1</span></div><div class="t m5 x1db h5c y4dc1 ff1e fs19 fc1 sc0 ls0 ws0"></div><div class="t m5 x1db h4b y4dc2 ff11 fs25 fc1 sc0 ls0 ws0">i<span class="_ _2"></span><span class="ff12">=<span class="ff7">0</span></span></div><div class="t m5 xc0 h45 y4dbf ff11 fs19 fc1 sc0 ls0 ws0">a</div><div class="t m5 x42 h3c y4dc3 ff7 fs25 fc1 sc0 ls0 ws0">2<span class="ff11">i</span></div><div class="t m5 xd3 h30 y4dc4 ffa fs19 fc1 sc0 ls0 ws0">PO</div><div class="t m5 x20c h50 y4dc5 ff11 fs25 fc1 sc0 ls0 ws0">n</div><div class="t m5 x179 h46 y4dc4 ff12 fs19 fc1 sc0 ls0 ws0">=</div><div class="t m5 xb1 h4b y4dc6 ff11 fs25 fc1 sc0 ls0 ws0">n/<span class="ff7">2<span class="ff12">−</span>1</span></div><div class="t m5 x1db h5c y4dc7 ff1e fs19 fc1 sc0 ls0 ws0"></div><div class="t m5 x1db h4b y4dc8 ff11 fs25 fc1 sc0 ls0 ws0">i<span class="_ _2"></span><span class="ff12">=<span class="ff7">0</span></span></div><div class="t m5 xc0 h45 y4dc4 ff11 fs19 fc1 sc0 ls0 ws0">a</div><div class="t m5 x42 h4b y4dc5 ff7 fs25 fc1 sc0 ls0 ws0">2<span class="ff11">i<span class="_ _2"></span><span class="ff12">+</span></span>1</div><div class="t m5 x29 h26 y5fe ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _f"> </span>5.21<span class="_ _21"> </span>shows<span class="_ _f"> </span>code<span class="_ _21"> </span>that<span class="_ _21"> </span>uses<span class="_ _f"> </span>this<span class="_ _21"> </span>method.<span class="_ _f"> </span>It<span class="_ _21"> </span>uses<span class="_ _21"> </span>both<span class="_ _f"> </span>two-way<span class="_ _21"> </span>loop</div><div class="t m5 x1d h26 y5ff ff7 fs19 fc1 sc0 ls0 ws0">unrolling,<span class="_ _e"> </span>to<span class="_ _f"> </span>combine<span class="_ _e"> </span>more<span class="_ _f"> </span>elements<span class="_ _e"> </span>per<span class="_ _f"> </span>iteration,<span class="_ _1f"> </span>and<span class="_ _f"> </span>two-way<span class="_ _e"> </span>parallelism,</div><div class="t m5 x1d h26 y600 ff7 fs19 fc1 sc0 ls0 ws0">accumulating<span class="_"> </span>elements<span class="_"> </span>with<span class="_"> </span>even<span class="_"> </span>indices<span class="_"> </span>in<span class="_ _13"> </span>variable<span class="_"> </span><span class="ffd">acc0<span class="_ _10"> </span></span>and<span class="_"> </span>elements<span class="_"> </span>with<span class="_"> </span>odd</div><div class="t m5 x1d h46 y601 ff7 fs19 fc1 sc0 ls0 ws0">indices<span class="_ _11"> </span>in<span class="_ _11"> </span>variable<span class="_ _11"> </span><span class="ffd">acc1</span>.<span class="_ _11"> </span>W<span class="_ _1"></span>e<span class="_ _11"> </span>therefore<span class="_ _11"> </span>refer<span class="_ _11"> </span>to<span class="_ _11"> </span>this<span class="_ _11"> </span>as<span class="_ _11"> </span>“2<span class="_"> </span><span class="ff12">×<span class="_ _10"> </span></span>2<span class="_"> </span>loop<span class="_ _11"> </span>unrolling.<span class="_ _1"></span>”<span class="_ _11"> </span>As</div><div class="t m5 x1d h26 y602 ff7 fs19 fc1 sc0 ls0 ws0">before<span class="_ _1"></span>,<span class="_"> </span>we<span class="_ _13"> </span>include<span class="_"> </span>a<span class="_ _13"> </span>second<span class="_"> </span>loop<span class="_ _13"> </span>to<span class="_"> </span>accumulate<span class="_ _13"> </span>any<span class="_"> </span>remaining<span class="_ _13"> </span>array<span class="_"> </span>elements<span class="_ _13"> </span>for</div><div class="t m5 x1d h26 y603 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _6"> </span>case<span class="_ _6"> </span>where<span class="_ _6"> </span>the<span class="_ _6"> </span>vector<span class="_ _13"> </span>length<span class="_ _a"> </span>is<span class="_ _6"> </span>not<span class="_ _13"> </span>a<span class="_ _a"> </span>multiple<span class="_ _6"> </span>of<span class="_ _13"> </span>2.<span class="_ _a"> </span>W<span class="_ _3"></span>e<span class="_ _13"> </span>then<span class="_ _a"> </span>apply<span class="_ _6"> </span>the<span class="_ _13"> </span>combining</div><div class="t m5 x1d h26 y604 ff7 fs19 fc1 sc0 ls0 ws0">operation<span class="_"> </span>to<span class="_"> </span><span class="ffd">acc0<span class="_ _10"> </span></span>and<span class="_"> </span><span class="ffd">acc1<span class="_ _10"> </span></span>to<span class="_"> </span>compute<span class="_"> </span>the<span class="_"> </span>ﬁnal<span class="_"> </span>result.</div><div class="t m5 x29 h26 y605 ff7 fs19 fc1 sc0 ls0 ws0">Comparing<span class="_"> </span>loop<span class="_ _11"> </span>unrolling<span class="_ _11"> </span>alone<span class="_ _11"> </span>to<span class="_ _11"> </span>loop<span class="_ _11"> </span>unrolling<span class="_ _11"> </span>with<span class="_ _11"> </span>two-way<span class="_"> </span>parallelism,</div><div class="t m5 x1d h26 y606 ff7 fs19 fc1 sc0 ls0 ws0">we<span class="_"> </span>obtain<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>performance:</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
