<div id="pf103" class="pf w2 h11" data-page-no="103"><div class="pc pc103 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg103.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">258<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Reverse<span class="_ _11"> </span>engineering<span class="_ _11"> </span>loops</span></div><div class="t m5 x28 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">A<span class="_ _13"> </span>key<span class="_ _13"> </span>to<span class="_ _6"> </span>understanding<span class="_ _13"> </span>how<span class="_ _13"> </span>the<span class="_ _13"> </span>generated<span class="_ _13"> </span>assembly<span class="_ _6"> </span>code<span class="_ _13"> </span>relates<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>original<span class="_ _6"> </span>source<span class="_ _13"> </span>code<span class="_ _13"> </span>is<span class="_ _13"> </span>to<span class="_ _13"> </span>Ô¨Ånd<span class="_ _6"> </span>a</div><div class="t m5 x28 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">mapping<span class="_ _6"> </span>between<span class="_ _13"> </span>program<span class="_ _6"> </span>values<span class="_ _6"> </span>and<span class="_ _13"> </span>registers<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>his<span class="_ _13"> </span>task<span class="_ _a"> </span>was<span class="_ _13"> </span>simple<span class="_ _6"> </span>enough<span class="_ _13"> </span>for<span class="_ _a"> </span>the<span class="_ _13"> </span>loop<span class="_ _6"> </span>of<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _6"> </span>3.19,</div><div class="t m5 x28 h2b y2d2 ff7 fs1e fc2 sc0 ls0 ws0">but<span class="_"> </span>it<span class="_ _13"> </span>can<span class="_"> </span>be<span class="_"> </span>much<span class="_ _13"> </span>more<span class="_"> </span>challenging<span class="_ _13"> </span>for<span class="_"> </span>more<span class="_"> </span>complex<span class="_ _13"> </span>programs<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>C<span class="_"> </span>compiler<span class="_ _13"> </span>will<span class="_"> </span>often<span class="_ _13"> </span>rearrange</div><div class="t m5 x28 h2b y2d3 ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_"> </span>computations<span class="_ _1"></span>,<span class="_ _10"> </span>so<span class="_ _10"> </span>that<span class="_ _10"> </span>some<span class="_ _11"> </span>variables<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>C<span class="_ _11"> </span>code<span class="_"> </span>have<span class="_"> </span>no<span class="_"> </span>counterpart<span class="_ _10"> </span>in<span class="_ _11"> </span>the<span class="_"> </span>machine<span class="_"> </span>code,<span class="_"> </span>and</div><div class="t m5 x28 h2b y2d4 ff7 fs1e fc2 sc0 ls0 ws0">new<span class="_ _13"> </span>values<span class="_"> </span>are<span class="_ _13"> </span>introduced<span class="_ _13"> </span>into<span class="_"> </span>the<span class="_ _13"> </span>machine<span class="_ _13"> </span>code<span class="_ _13"> </span>that<span class="_"> </span>do<span class="_ _13"> </span>not<span class="_ _13"> </span>exist<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>source<span class="_"> </span>code<span class="_ _1"></span>.<span class="_ _13"> </span>Moreover,<span class="_ _13"> </span>it<span class="_"> </span>will</div><div class="t m5 x28 h2b y2d5 ff7 fs1e fc2 sc0 ls0 ws0">often<span class="_"> </span>try<span class="_"> </span>to<span class="_"> </span>minimize<span class="_"> </span>register<span class="_"> </span>usage<span class="_"> </span>by<span class="_"> </span>mapping<span class="_"> </span>multiple<span class="_"> </span>program<span class="_"> </span>values<span class="_"> </span>onto<span class="_"> </span>a<span class="_"> </span>single<span class="_"> </span>register.</div><div class="t m5 x57 h2b y2d6 ff7 fs1e fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>process<span class="_ _11"> </span>we<span class="_"> </span>described<span class="_ _11"> </span>for<span class="_ _11"> </span><span class="ffd">fact_do<span class="_ _10"> </span></span>works<span class="_ _11"> </span>as<span class="_ _10"> </span>a<span class="_ _11"> </span>general<span class="_ _11"> </span>strategy<span class="_ _10"> </span>for<span class="_ _11"> </span>reverse<span class="_ _10"> </span>engineering<span class="_ _11"> </span>loops<span class="_ _1"></span>.</div><div class="t m5 x28 h2b y549 ff7 fs1e fc2 sc0 ls0 ws0">Look<span class="_ _16"> </span>at<span class="_ _16"> </span>how<span class="_ _16"> </span>registers<span class="_ _16"> </span>are<span class="_ _16"> </span>initialized<span class="_ _14"> </span>before<span class="_ _16"> </span>the<span class="_ _16"> </span>loop<span class="_ _1"></span>,<span class="_ _14"> </span>updated<span class="_ _16"> </span>and<span class="_ _14"> </span>tested<span class="_ _16"> </span>within<span class="_ _16"> </span>the<span class="_ _16"> </span>loop<span class="_ _0"></span>,<span class="_ _16"> </span>and<span class="_ _14"> </span>used</div><div class="t m5 x28 h2b y54a ff7 fs1e fc2 sc0 ls0 ws0">after<span class="_"> </span>the<span class="_ _11"> </span>loop<span class="_ _1"></span>.<span class="_ _11"> </span>Each<span class="_ _10"> </span>of<span class="_ _11"> </span>these<span class="_ _10"> </span>provides<span class="_ _11"> </span>a<span class="_"> </span>clue<span class="_ _11"> </span>that<span class="_ _10"> </span>can<span class="_ _11"> </span>be<span class="_ _10"> </span>combined<span class="_ _11"> </span>to<span class="_"> </span>solve<span class="_ _11"> </span>a<span class="_ _10"> </span>puzzle.<span class="_"> </span>Be<span class="_ _10"> </span>prepared<span class="_ _11"> </span>for</div><div class="t m5 x28 h2b y54b ff7 fs1e fc2 sc0 ls0 ws0">surprising<span class="_ _11"> </span>transformations<span class="_ _1"></span>,<span class="_ _16"> </span>some<span class="_ _11"> </span>of<span class="_ _11"> </span>which<span class="_ _11"> </span>are<span class="_ _11"> </span>clearly<span class="_ _16"> </span>cases<span class="_ _11"> </span>where<span class="_ _11"> </span>the<span class="_ _11"> </span>compiler<span class="_ _11"> </span>was<span class="_ _16"> </span>able<span class="_ _11"> </span>to<span class="_ _11"> </span>optimize</div><div class="t m5 x28 h2b y54c ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_"> </span>code<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>others<span class="_"> </span>where<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>hard<span class="_"> </span>to<span class="_"> </span>explain<span class="_"> </span>why<span class="_"> </span>the<span class="_"> </span>compiler<span class="_"> </span>chose<span class="_"> </span>that<span class="_"> </span>particular<span class="_"> </span>strategy<span class="_ _3"></span>.</div><div class="t m5 x1d h26 y26c3 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>assembly<span class="_ _13"> </span>code<span class="_ _13"> </span>from<span class="_ _13"> </span>which<span class="_ _13"> </span>the<span class="_ _13"> </span>goto<span class="_ _13"> </span>code<span class="_ _13"> </span>was<span class="_ _6"> </span>generated.<span class="_ _13"> </span>The<span class="_ _13"> </span>conditional<span class="_ _6"> </span>jump</div><div class="t m5 x1d h26 y26c4 ff7 fs19 fc2 sc0 ls0 ws0">instruction<span class="_ _13"> </span><span class="ffd">jg<span class="_ _10"> </span></span>(line<span class="_ _13"> </span>7)<span class="_"> </span>is<span class="_ _13"> </span>the<span class="_"> </span>key<span class="_ _13"> </span>instruction<span class="_ _13"> </span>in<span class="_"> </span>implementing<span class="_ _13"> </span>a<span class="_"> </span>loop<span class="_ _3"></span>.<span class="_"> </span>It<span class="_ _13"> </span>determines</div><div class="t m5 x1d h26 y26c5 ff7 fs19 fc2 sc0 ls0 ws0">whether<span class="_"> </span>to<span class="_"> </span>continue<span class="_"> </span>iterating<span class="_"> </span>or<span class="_"> </span>to<span class="_"> </span>exit<span class="_"> </span>the<span class="_"> </span>loop<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y26c6 ff7 fs19 fc2 sc0 ls0 ws0">Reverse<span class="_ _16"> </span>engineering<span class="_ _11"> </span>assembly<span class="_ _16"> </span>code,<span class="_ _11"> </span>such<span class="_ _16"> </span>as<span class="_ _16"> </span>that<span class="_ _16"> </span>of<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _16"> </span>3.19(c),<span class="_ _16"> </span>requires</div><div class="t m5 x1d h26 y26c7 ff7 fs19 fc2 sc0 ls0 ws0">determining<span class="_ _11"> </span>which<span class="_ _16"> </span>registers<span class="_ _11"> </span>are<span class="_ _11"> </span>used<span class="_ _16"> </span>for<span class="_ _11"> </span>which<span class="_ _16"> </span>program<span class="_ _11"> </span>values<span class="_ _1"></span>.<span class="_ _11"> </span>In<span class="_ _16"> </span>this<span class="_ _11"> </span>case<span class="_ _0"></span>,<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y26c8 ff7 fs19 fc2 sc0 ls0 ws0">mapping<span class="_ _21"> </span>is<span class="_ _f"> </span>fairly<span class="_ _21"> </span>simple<span class="_ _f"> </span>to<span class="_ _21"> </span>determine:<span class="_ _f"> </span>W<span class="_ _3"></span>e<span class="_ _f"> </span>know<span class="_ _f"> </span>that<span class="_ _21"> </span><span class="ff11">n<span class="_ _f"> </span></span>will<span class="_ _21"> </span>be<span class="_ _f"> </span>passed<span class="_ _21"> </span>to<span class="_ _f"> </span>the</div><div class="t m5 x1d h26 y26c9 ff7 fs19 fc2 sc0 ls0 ws0">function<span class="_ _16"> </span>in<span class="_ _14"> </span>register<span class="_ _14"> </span><span class="ffd">%rdi</span>.<span class="_ _16"> </span>W<span class="_ _1"></span>e<span class="_ _14"> </span>can<span class="_ _16"> </span>see<span class="_ _14"> </span>register<span class="_ _14"> </span><span class="ffd">%rax<span class="_ _16"> </span></span>getting<span class="_ _14"> </span>initialized<span class="_ _14"> </span>to<span class="_ _16"> </span>1<span class="_ _14"> </span>(line</div><div class="t m5 x1d h26 y26ca ff7 fs19 fc2 sc0 ls0 ws0">2).<span class="_ _16"> </span>(Recall<span class="_ _16"> </span>that,<span class="_ _14"> </span>although<span class="_ _16"> </span>the<span class="_ _16"> </span>instruction<span class="_ _14"> </span>has<span class="_ _16"> </span><span class="ffd">%eax<span class="_ _16"> </span></span>as<span class="_ _16"> </span>its<span class="_ _14"> </span>destination,<span class="_ _16"> </span>it<span class="_ _14"> </span>will<span class="_ _16"> </span>also</div><div class="t m5 x1d h26 y26cb ff7 fs19 fc2 sc0 ls0 ws0">set<span class="_ _11"> </span>the<span class="_ _16"> </span>upper<span class="_ _11"> </span>4<span class="_ _16"> </span>bytes<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffd">%rax<span class="_ _11"> </span></span>to<span class="_ _16"> </span>0.)<span class="_ _11"> </span>W<span class="_ _1"></span>e<span class="_ _11"> </span>can<span class="_ _16"> </span>see<span class="_ _11"> </span>that<span class="_ _16"> </span>this<span class="_ _11"> </span>register<span class="_ _16"> </span>is<span class="_ _11"> </span>also<span class="_ _16"> </span>updated</div><div class="t m5 x1d h26 y26cc ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_ _13"> </span>multiplication<span class="_"> </span>on<span class="_ _13"> </span>line<span class="_ _13"> </span>4.<span class="_"> </span>Furthermore<span class="_ _1"></span>,<span class="_"> </span>since<span class="_ _13"> </span><span class="ffd">%rax<span class="_ _13"> </span></span>is<span class="_"> </span>used<span class="_ _13"> </span>to<span class="_"> </span>return<span class="_ _13"> </span>the<span class="_ _13"> </span>function</div><div class="t m5 x1d h26 y26cd ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_ _1"></span>,<span class="_ _16"> </span>it<span class="_ _11"> </span>is<span class="_ _16"> </span>often<span class="_ _11"> </span>chosen<span class="_ _16"> </span>to<span class="_ _11"> </span>hold<span class="_ _11"> </span>program<span class="_ _16"> </span>values<span class="_ _11"> </span>that<span class="_ _11"> </span>are<span class="_ _16"> </span>returned.<span class="_ _11"> </span>W<span class="_ _1"></span>e<span class="_ _11"> </span>therefore</div><div class="t m5 x1d h26 y26ce ff7 fs19 fc2 sc0 ls0 ws0">conclude<span class="_"> </span>that<span class="_"> </span><span class="ffd">%rax<span class="_ _10"> </span></span>corresponds<span class="_"> </span>to<span class="_"> </span>program<span class="_"> </span>value<span class="_"> </span><span class="ffd">result</span>.</div><div class="t m5 x1d h47 y26cf ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>3.23<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>370)</span></div><div class="t m5 x1d h26 y26d0 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_"> </span>the<span class="_"> </span>C<span class="_"> </span>code</div><div class="t m5 x1d h2d y26d1 ffd fs1e fc2 sc0 ls0 ws0">short<span class="_ _e"> </span>dw_loop(short<span class="_ _1f"> </span>x)<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y26d2 ffd fs1e fc2 sc0 ls0 ws0">short<span class="_ _e"> </span>y<span class="_ _1f"> </span>=<span class="_ _1f"> </span>x/9;</div><div class="t m5 x10c h2d y26d3 ffd fs1e fc2 sc0 ls0 ws0">short<span class="_ _e"> </span>*p<span class="_ _1f"> </span>=<span class="_ _1f"> </span>&amp;x;</div><div class="t m5 x10c h2d y26d4 ffd fs1e fc2 sc0 ls0 ws0">short<span class="_ _e"> </span>n<span class="_ _1f"> </span>=<span class="_ _1f"> </span>4*x;</div><div class="t m5 x10c h2d y26d5 ffd fs1e fc2 sc0 ls0 ws0">do<span class="_ _e"> </span>{</div><div class="t m5 x22b h2d y26d6 ffd fs1e fc2 sc0 ls33 ws0">x+<span class="_ _41"></span>=y<span class="_ _41"></span>;</div><div class="t m5 x22b h2d y26d7 ffd fs1e fc2 sc0 ls0 ws0">(*p)<span class="_ _e"> </span>+=<span class="_ _1f"> </span>5;</div><div class="t m5 x22b h2d y26d8 ffd fs1e fc2 sc0 ls33 ws0">n-<span class="_ _41"></span>=2<span class="_ _41"></span>;</div><div class="t m5 x10c h2d y26d9 ffd fs1e fc2 sc0 ls0 ws0">}<span class="_ _e"> </span>while<span class="_ _1f"> </span>(n<span class="_ _1f"> </span>&gt;<span class="_ _e"> </span>0);</div><div class="t m5 x10c h2d y26da ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>x;</div><div class="t m5 x1d h2d y26db ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1d h26 ye95 ff9 fs19 fc2 sc0 ls0 ws0">gcc<span class="_ _10"> </span><span class="ff7">generates<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>assembly<span class="_"> </span>code:</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
