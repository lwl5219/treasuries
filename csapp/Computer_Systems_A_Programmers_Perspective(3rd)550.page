<div id="pf226" class="pf w2 h11" data-page-no="226"><div class="pc pc226 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg226.png"/><div class="t m5 x12e h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>5.5<span class="_ _60"> </span>Reducing<span class="_ _10"> </span>Procedure<span class="_ _10"> </span>Calls<span class="_ _3e"> </span><span class="ffe fs1e">549</span></div><div class="t m5 x108 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/opt/vec.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">data_t<span class="_ _1f"> </span>*get_vec_start(vec_ptr<span class="_ _e"> </span>v)</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>v-&gt;data;</span></div><div class="t m5 x2c h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x108 h2c y4b3b ffa fs16 fc2 sc0 ls0 ws0">code/opt/vec.c</div><div class="t m5 x2c h2d y4b3c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Direct<span class="_ _e"> </span>access<span class="_ _1f"> </span>to<span class="_ _1f"> </span>vector<span class="_ _e"> </span>data<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y4b3d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>combine3(vec_ptr<span class="_ _e"> </span>v,<span class="_ _1f"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x2c h2d y4b3e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y4b3f ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>i;</span></div><div class="t m5 x2c h2d y4b40 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>length<span class="_ _1f"> </span>=<span class="_ _1f"> </span>vec_length(v);</span></div><div class="t m5 x2c h2d yea7 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>*data<span class="_ _1f"> </span>=<span class="_ _1f"> </span>get_vec_start(v);</span></div><div class="t m5 x2c h2e y4b41 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x2c h2e y4b42 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x142 h2d y4b43 ffd fs1e fc2 sc0 ls0 ws0">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>IDENT;</div><div class="t m5 x2c h2d y4b44 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>length;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y2a66 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>*dest<span class="_ _1f"> </span>OP<span class="_ _e"> </span>data[i];</span></div><div class="t m5 x17 h2d y4b45 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y4b46 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x2d h2d y4b47 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h34 y4b48 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>5.9<span class="_ _66"> </span><span class="fc1">Eliminating<span class="_ _16"> </span>function<span class="_ _11"> </span>calls<span class="_ _16"> </span>within<span class="_ _16"> </span>the<span class="_ _16"> </span>loop.<span class="_ _11"> </span><span class="ff6">The<span class="_ _16"> </span>resulting<span class="_ _11"> </span>code<span class="_ _16"> </span>does<span class="_ _16"> </span>not</span></span></div><div class="t m5 x17 h34 y4b49 ff6 fs16 fc1 sc0 ls0 ws0">show<span class="_ _10"> </span>a<span class="_ _11"> </span>performance<span class="_ _10"> </span>gain,<span class="_ _11"> </span>but<span class="_ _10"> </span>it<span class="_ _11"> </span>enables<span class="_ _10"> </span>additional<span class="_ _10"> </span>optimizations.</div><div class="t m5 x26 h26 y4b4a ff7 fs19 fc1 sc0 ls0 ws0">Suppose<span class="_"> </span>instead<span class="_ _11"> </span>that<span class="_ _11"> </span>we<span class="_ _11"> </span>add<span class="_ _11"> </span>a<span class="_ _11"> </span>function<span class="_ _11"> </span><span class="ffd">get_vec_start<span class="_ _11"> </span></span>to<span class="_"> </span>our<span class="_ _11"> </span>abstract<span class="_ _11"> </span>data</div><div class="t m5 x17 h26 y4b4b ff7 fs19 fc1 sc0 ls0 ws0">type<span class="_ _1"></span>.<span class="_ _21"> </span>T<span class="_ _0"></span>his<span class="_ _15"> </span>function<span class="_ _21"> </span>returns<span class="_ _15"> </span>the<span class="_ _21"> </span>starting<span class="_ _15"> </span>address<span class="_ _21"> </span>of<span class="_ _15"> </span>the<span class="_ _21"> </span>data<span class="_ _15"> </span>array<span class="_ _3"></span>,<span class="_ _f"> </span>as<span class="_ _15"> </span>shown<span class="_ _21"> </span>in</div><div class="t m5 x17 h26 y4b4c ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>5.9.<span class="_ _11"> </span>W<span class="_ _3"></span>e<span class="_ _11"> </span>could<span class="_ _16"> </span>then<span class="_ _11"> </span>write<span class="_ _11"> </span>the<span class="_ _11"> </span>procedure<span class="_ _16"> </span>shown<span class="_ _11"> </span>as<span class="_ _11"> </span><span class="ffd">combine3<span class="_ _11"> </span></span>in<span class="_ _16"> </span>this<span class="_ _11"> </span>Ô¨Ågure<span class="_ _1"></span>,</div><div class="t m5 x17 h26 y4b4d ff7 fs19 fc1 sc0 ls0 ws0">having<span class="_ _11"> </span>no<span class="_ _11"> </span>function<span class="_ _11"> </span>calls<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>inner<span class="_ _16"> </span>loop<span class="_ _1"></span>.<span class="_ _11"> </span>Rather<span class="_ _11"> </span>than<span class="_ _11"> </span>making<span class="_ _11"> </span>a<span class="_ _11"> </span>function<span class="_ _16"> </span>call<span class="_"> </span>to</div><div class="t m5 x17 h26 y4b4e ff7 fs19 fc1 sc0 ls0 ws0">retrieve<span class="_ _13"> </span>each<span class="_ _13"> </span>vector<span class="_"> </span>element,<span class="_ _13"> </span>it<span class="_ _13"> </span>accesses<span class="_ _13"> </span>the<span class="_ _13"> </span>array<span class="_"> </span>directly<span class="_ _7"></span>.<span class="_ _13"> </span>A<span class="_"> </span>purist<span class="_ _13"> </span>might<span class="_ _13"> </span>say<span class="_ _13"> </span>that</div><div class="t m5 x17 h26 y4b4f ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_ _14"> </span>transformation<span class="_ _15"> </span>seriously<span class="_ _14"> </span>impairs<span class="_ _14"> </span>the<span class="_ _15"> </span>program<span class="_ _14"> </span>modularity<span class="_ _3"></span>.<span class="_ _15"> </span>In<span class="_ _14"> </span>principle,<span class="_ _14"> </span>the</div><div class="t m5 x17 h26 y4b50 ff7 fs19 fc1 sc0 ls0 ws0">user<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>vector<span class="_"> </span>abstract<span class="_ _13"> </span>data<span class="_ _13"> </span>type<span class="_ _13"> </span>should<span class="_ _13"> </span>not<span class="_ _13"> </span>even<span class="_"> </span>need<span class="_ _13"> </span>to<span class="_ _13"> </span>know<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_ _13"> </span>vector</div><div class="t m5 x17 h26 y4b51 ff7 fs19 fc1 sc0 ls0 ws0">contents<span class="_"> </span>are<span class="_ _13"> </span>stored<span class="_"> </span>as<span class="_ _13"> </span>an<span class="_"> </span>array<span class="_ _7"></span>,<span class="_"> </span>rather<span class="_ _13"> </span>than<span class="_"> </span>as<span class="_"> </span>some<span class="_ _13"> </span>other<span class="_"> </span>data<span class="_ _13"> </span>structure<span class="_"> </span>such<span class="_ _13"> </span>as<span class="_"> </span>a</div><div class="t m5 x17 h26 y4b52 ff7 fs19 fc1 sc0 ls0 ws0">linked<span class="_ _11"> </span>list.<span class="_ _11"> </span>A<span class="_ _11"> </span>more<span class="_"> </span>pragmatic<span class="_ _11"> </span>programmer<span class="_ _11"> </span>would<span class="_ _11"> </span>argue<span class="_ _11"> </span>that<span class="_ _11"> </span>this<span class="_ _11"> </span>transformation</div><div class="t m5 x17 h26 y4b53 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_"> </span>a<span class="_"> </span>necessary<span class="_"> </span>step<span class="_"> </span>toward<span class="_"> </span>achieving<span class="_"> </span>high-performance<span class="_"> </span>results<span class="_ _1"></span>.</div><div class="t m5 x1b3 h31 y4b54 ff7 fs21 fc2 sc0 ls0 ws0">Integer<span class="_ _ba"> </span>Floating<span class="_"> </span>point</div><div class="t m5 x17 h31 y4b55 ff7 fs21 fc2 sc0 ls0 ws0">Function<span class="_ _76"> </span>Page<span class="_ _26"> </span>Method<span class="_ _1db"> </span><span class="ffd fs1e ls20c">+*+*</span></div><div class="t m5 x17 h31 y4b56 ffd fs1e fc2 sc0 ls0 ws0">combine2<span class="_ _73"> </span><span class="ff7 fs21">545<span class="_ _61"> </span>Move<span class="_"> </span></span>vec_length<span class="_ _74"> </span><span class="ff7 fs21">7.02<span class="_ _14a"> </span>9.03<span class="_ _14a"> </span>9.02<span class="_ _7b"> </span>11.03</span></div><div class="t m5 x17 h2d y4b57 ffd fs1e fc2 sc0 ls0 ws0">combine3</div><div class="t m5 x5a h31 y4b58 ff7 fs21 fc2 sc0 ls0 ws0">549<span class="_ _73"> </span>Direct<span class="_"> </span>data<span class="_"> </span>access<span class="_ _45"> </span>7.17<span class="_ _14a"> </span>9.02<span class="_ _14a"> </span>9.02<span class="_ _7b"> </span>11.03</div><div class="t m5 x26 h26 yc21 ff7 fs19 fc2 sc0 ls0 ws0">Surprisingly<span class="_ _3"></span>,<span class="_ _f"> </span>there<span class="_ _21"> </span>is<span class="_ _f"> </span>no<span class="_ _21"> </span>apparent<span class="_ _21"> </span>performance<span class="_ _f"> </span>improvement.<span class="_ _21"> </span>Indeed,<span class="_ _e"> </span>the</div><div class="t m5 x17 h26 yc22 ff7 fs19 fc2 sc0 ls0 ws0">performance<span class="_ _6"> </span>for<span class="_ _13"> </span>integer<span class="_ _6"> </span>sum<span class="_ _6"> </span>has<span class="_ _13"> </span>gotten<span class="_ _6"> </span>slightly<span class="_ _6"> </span>worse.<span class="_ _6"> </span>Evidently<span class="_ _3"></span>,<span class="_ _13"> </span>other<span class="_ _6"> </span>operations</div><div class="t m5 x17 h26 yc23 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _21"> </span>the<span class="_ _f"> </span>inner<span class="_ _f"> </span>loop<span class="_ _f"> </span>are<span class="_ _f"> </span>forming<span class="_ _f"> </span>a<span class="_ _f"> </span>bottleneck<span class="_ _f"> </span>that<span class="_ _f"> </span>limits<span class="_ _f"> </span>the<span class="_ _f"> </span>performance<span class="_ _f"> </span>more</div><div class="t m5 x17 h26 yc24 ff7 fs19 fc2 sc0 ls0 ws0">than<span class="_ _11"> </span>the<span class="_ _16"> </span>call<span class="_ _16"> </span>to<span class="_ _11"> </span><span class="ffd">get_vec_element</span>.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>will<span class="_ _11"> </span>return<span class="_ _16"> </span>to<span class="_ _11"> </span>this<span class="_ _16"> </span>function<span class="_ _11"> </span>later<span class="_ _16"> </span>(Section</div><div class="t m5 x17 h26 yc25 ff7 fs19 fc2 sc0 ls0 ws0">5.11.2)<span class="_"> </span>and<span class="_ _11"> </span>see<span class="_ _11"> </span>why<span class="_"> </span>the<span class="_ _11"> </span>repeated<span class="_ _11"> </span>bounds<span class="_"> </span>checking<span class="_ _11"> </span>by<span class="_ _11"> </span><span class="ffd">combine2<span class="_ _10"> </span></span>does<span class="_ _11"> </span>not<span class="_ _11"> </span>incur<span class="_ _11"> </span>a</div><div class="t m5 x17 h26 yc26 ff7 fs19 fc2 sc0 ls0 ws0">performance<span class="_"> </span>penalty<span class="_ _3"></span>.<span class="_"> </span>F<span class="_ _1"></span>or<span class="_"> </span>now<span class="_ _3"></span>,<span class="_"> </span>we<span class="_"> </span>can<span class="_"> </span>view<span class="_"> </span>this<span class="_"> </span>transformation<span class="_"> </span>as<span class="_"> </span>one<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>series</div><div class="t m5 x17 h26 y14b5 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>steps<span class="_"> </span>that<span class="_"> </span>will<span class="_"> </span>ultimately<span class="_"> </span>lead<span class="_"> </span>to<span class="_"> </span>greatly<span class="_"> </span>improved<span class="_"> </span>performance<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
