<div id="pf2d7" class="pf w2 h11" data-page-no="2d7"><div class="pc pc2d7 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2d7.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">726<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">ﬁle<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>linker<span class="_ _13"> </span>then<span class="_ _13"> </span>assigns<span class="_"> </span>run-time<span class="_ _13"> </span>memory<span class="_"> </span>addresses<span class="_ _13"> </span>to<span class="_"> </span>the<span class="_ _13"> </span>new<span class="_ _13"> </span>aggregate</div><div class="t m5 x29 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">sections<span class="_ _1"></span>,<span class="_ _14"> </span>to<span class="_ _16"> </span>each<span class="_ _14"> </span>section<span class="_ _16"> </span>deﬁned<span class="_ _14"> </span>by<span class="_ _16"> </span>the<span class="_ _14"> </span>input<span class="_ _16"> </span>modules<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _14"> </span>to<span class="_ _16"> </span>each<span class="_ _14"> </span>symbol</div><div class="t m5 x29 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">deﬁned<span class="_ _16"> </span>by<span class="_ _14"> </span>the<span class="_ _14"> </span>input<span class="_ _16"> </span>modules<span class="_ _0"></span>.<span class="_ _16"> </span>When<span class="_ _16"> </span>this<span class="_ _14"> </span>step<span class="_ _14"> </span>is<span class="_ _16"> </span>complete,<span class="_ _14"> </span>each<span class="_ _16"> </span>instruction</div><div class="t m5 x29 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>global<span class="_"> </span>variable<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>has<span class="_"> </span>a<span class="_"> </span>unique<span class="_"> </span>run-time<span class="_"> </span>memory<span class="_"> </span>address<span class="_ _1"></span>.</div><div class="t m5 xc5 h26 y602a ffc fs19 fc2 sc0 ls0 ws0">2.<span class="_ _e"> </span><span class="ffa">Relocating<span class="_ _16"> </span>symbol<span class="_ _11"> </span>references<span class="_ _11"> </span>within<span class="_ _11"> </span>sections<span class="_ _1"></span>.<span class="_ _13"> </span><span class="ff7">In<span class="_ _11"> </span>this<span class="_ _16"> </span>step<span class="_ _1"></span>,<span class="_ _11"> </span>the<span class="_ _16"> </span>linker<span class="_ _11"> </span>modiﬁes</span></span></div><div class="t m5 x29 h26 y602b ff7 fs19 fc2 sc0 ls0 ws0">every<span class="_ _16"> </span>symbol<span class="_ _14"> </span>reference<span class="_ _14"> </span>in<span class="_ _14"> </span>the<span class="_ _16"> </span>bodies<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>code<span class="_ _16"> </span>and<span class="_ _14"> </span>data<span class="_ _14"> </span>sections<span class="_ _16"> </span>so<span class="_ _14"> </span>that</div><div class="t m5 x29 h26 y602c ff7 fs19 fc2 sc0 ls0 ws0">they<span class="_"> </span>point<span class="_ _11"> </span>to<span class="_"> </span>the<span class="_ _11"> </span>correct<span class="_"> </span>run-time<span class="_ _11"> </span>addresses<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _7"></span>o<span class="_ _11"> </span>perform<span class="_ _11"> </span>this<span class="_"> </span>step,<span class="_"> </span>the<span class="_"> </span>linker</div><div class="t m5 x29 h26 y602d ff7 fs19 fc2 sc0 ls0 ws0">relies<span class="_ _6"> </span>on<span class="_ _6"> </span>data<span class="_ _13"> </span>structures<span class="_ _a"> </span>in<span class="_ _13"> </span>the<span class="_ _a"> </span>relocatable<span class="_ _13"> </span>object<span class="_ _a"> </span>modules<span class="_ _13"> </span>known<span class="_ _a"> </span>as<span class="_ _13"> </span>relocation</div><div class="t m5 x29 h26 y602e ff7 fs19 fc2 sc0 ls0 ws0">entries<span class="_ _1"></span>,<span class="_"> </span>which<span class="_"> </span>we<span class="_"> </span>describe<span class="_"> </span>next.</div><div class="t m5 x1d h41 y602f ffe fs29 fc2 sc0 ls0 ws0">7.7.1<span class="_ _48"> </span><span class="fs19">Relocation<span class="_"> </span>Entries</span></div><div class="t m5 x1d h26 y6030 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _13"> </span>an<span class="_ _13"> </span>assembler<span class="_"> </span>generates<span class="_ _13"> </span>an<span class="_"> </span>object<span class="_ _13"> </span>module<span class="_ _0"></span>,<span class="_"> </span>it<span class="_ _13"> </span>does<span class="_ _13"> </span>not<span class="_"> </span>know<span class="_ _13"> </span>where<span class="_"> </span>the<span class="_ _13"> </span>code</div><div class="t m5 x1d h26 y6031 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _11"> </span>data<span class="_ _16"> </span>will<span class="_ _11"> </span>ultimately<span class="_ _11"> </span>be<span class="_ _16"> </span>stored<span class="_ _11"> </span>in<span class="_ _16"> </span>memory<span class="_ _7"></span>.<span class="_ _16"> </span>Nor<span class="_ _11"> </span>does<span class="_ _11"> </span>it<span class="_ _16"> </span>know<span class="_ _11"> </span>the<span class="_ _16"> </span>locations<span class="_ _11"> </span>of</div><div class="t m5 x1d h26 y6032 ff7 fs19 fc2 sc0 ls0 ws0">any<span class="_ _14"> </span>externally<span class="_ _15"> </span>deﬁned<span class="_ _14"> </span>functions<span class="_ _15"> </span>or<span class="_ _14"> </span>global<span class="_ _15"> </span>variables<span class="_ _14"> </span>that<span class="_ _15"> </span>are<span class="_ _14"> </span>referenced<span class="_ _15"> </span>by<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y6033 ff7 fs19 fc2 sc0 ls0 ws0">module<span class="_ _1"></span>.<span class="_ _14"> </span>So<span class="_ _16"> </span>whenever<span class="_ _16"> </span>the<span class="_ _16"> </span>assembler<span class="_ _16"> </span>encounters<span class="_ _16"> </span>a<span class="_ _14"> </span>reference<span class="_ _16"> </span>to<span class="_ _16"> </span>an<span class="_ _16"> </span>object<span class="_ _16"> </span>whose</div><div class="t m5 x1d h26 y6034 ff7 fs19 fc2 sc0 ls0 ws0">ultimate<span class="_ _11"> </span>location<span class="_ _16"> </span>is<span class="_ _11"> </span>unknown,<span class="_ _16"> </span>it<span class="_ _16"> </span>generates<span class="_ _11"> </span>a<span class="_ _16"> </span><span class="ffa">relocation<span class="_ _11"> </span>entry<span class="_ _11"> </span></span>that<span class="_ _16"> </span>tells<span class="_ _11"> </span>the<span class="_ _16"> </span>linker</div><div class="t m5 x1d h26 y6035 ff7 fs19 fc2 sc0 ls0 ws0">how<span class="_ _16"> </span>to<span class="_ _14"> </span>modify<span class="_ _14"> </span>the<span class="_ _14"> </span>reference<span class="_ _14"> </span>when<span class="_ _14"> </span>it<span class="_ _14"> </span>merges<span class="_ _16"> </span>the<span class="_ _14"> </span>object<span class="_ _14"> </span>ﬁle<span class="_ _14"> </span>into<span class="_ _14"> </span>an<span class="_ _14"> </span>executable<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y6036 ff7 fs19 fc2 sc0 ls0 ws0">Relocation<span class="_"> </span>entries<span class="_"> </span>for<span class="_"> </span>code<span class="_"> </span>are<span class="_ _11"> </span>placed<span class="_"> </span>in<span class="_"> </span><span class="ffd">.rel.text</span>.<span class="_"> </span>Relocation<span class="_ _11"> </span>entries<span class="_"> </span>for<span class="_"> </span>data</div><div class="t m5 x1d h26 y6037 ff7 fs19 fc2 sc0 ls0 ws0">are<span class="_"> </span>placed<span class="_"> </span>in<span class="_"> </span><span class="ffd">.rel.data</span>.</div><div class="t m5 x29 h26 y6038 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>7.9<span class="_ _14"> </span>shows<span class="_ _16"> </span>the<span class="_ _14"> </span>format<span class="_ _14"> </span>of<span class="_ _16"> </span>an<span class="_ _14"> </span>ELF<span class="_ _16"> </span>relocation<span class="_ _14"> </span>entry<span class="_ _3"></span>.<span class="_ _14"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span><span class="ffd">offset<span class="_ _14"> </span></span>is<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y6039 ff7 fs19 fc2 sc0 ls0 ws0">section<span class="_ _13"> </span>offset<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>reference<span class="_ _13"> </span>that<span class="_ _13"> </span>will<span class="_ _13"> </span>need<span class="_ _13"> </span>to<span class="_"> </span>be<span class="_ _13"> </span>modiﬁed.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span><span class="ffd">symbol<span class="_ _10"> </span></span>identiﬁes</div><div class="t m5 x1d h26 y603a ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>symbol<span class="_ _11"> </span>that<span class="_"> </span>the<span class="_ _11"> </span>modiﬁed<span class="_ _11"> </span>reference<span class="_"> </span>should<span class="_ _11"> </span>point<span class="_ _11"> </span>to<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_"> </span><span class="ffd">type<span class="_ _11"> </span></span>tells<span class="_"> </span>the<span class="_ _11"> </span>linker</div><div class="t m5 x1d h26 y603b ff7 fs19 fc2 sc0 ls0 ws0">how<span class="_"> </span>to<span class="_"> </span>modify<span class="_"> </span>the<span class="_ _13"> </span>new<span class="_"> </span>reference<span class="_ _0"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span><span class="ffd">addend<span class="_ _10"> </span></span>is<span class="_"> </span>a<span class="_"> </span>signed<span class="_"> </span>constant<span class="_ _13"> </span>that<span class="_"> </span>is<span class="_"> </span>used<span class="_"> </span>by</div><div class="t m5 x1d h26 y603c ff7 fs19 fc2 sc0 ls0 ws0">some<span class="_"> </span>types<span class="_"> </span>of<span class="_"> </span>relocations<span class="_"> </span>to<span class="_"> </span>bias<span class="_"> </span>the<span class="_"> </span>value<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>modiﬁed<span class="_"> </span>reference<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y603d ff7 fs19 fc2 sc0 ls0 ws0">ELF<span class="_ _14"> </span>deﬁnes<span class="_ _14"> </span>32<span class="_ _14"> </span>different<span class="_ _14"> </span>relocation<span class="_ _15"> </span>types<span class="_ _1"></span>,<span class="_ _15"> </span>many<span class="_ _14"> </span>quite<span class="_ _14"> </span>arcane.<span class="_ _16"> </span>W<span class="_ _1"></span>e<span class="_ _14"> </span>are<span class="_ _14"> </span>con-</div><div class="t m5 x1d h26 y603e ff7 fs19 fc2 sc0 ls0 ws0">cerned<span class="_"> </span>with<span class="_"> </span>only<span class="_"> </span>the<span class="_"> </span>two<span class="_"> </span>most<span class="_"> </span>basic<span class="_"> </span>relocation<span class="_"> </span>types:</div><div class="t m5 x75 h26 y603f ffd fs19 fc2 sc0 ls0 ws0">R_X86_64_PC32<span class="ff7">.<span class="_ _e"> </span>Relocate<span class="_ _14"> </span>a<span class="_ _14"> </span>reference<span class="_ _14"> </span>that<span class="_ _14"> </span>uses<span class="_ _14"> </span>a<span class="_ _14"> </span>32-bit<span class="_ _14"> </span>PC-relative<span class="_ _14"> </span>address<span class="_ _1"></span>.</span></div><div class="t m5 xcd h26 y6040 ff7 fs19 fc2 sc0 ls0 ws0">Recall<span class="_ _15"> </span>from<span class="_ _21"> </span>Section<span class="_ _21"> </span>3.6.3<span class="_ _21"> </span>that<span class="_ _21"> </span>a<span class="_ _21"> </span>PC-relative<span class="_ _21"> </span>address<span class="_ _21"> </span>is<span class="_ _21"> </span>an<span class="_ _15"> </span>offset<span class="_ _21"> </span>from</div><div class="t m5 xcd h26 y6041 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>current<span class="_"> </span>run-time<span class="_"> </span>value<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>program<span class="_"> </span>counter<span class="_"> </span>(PC).<span class="_"> </span>When<span class="_ _13"> </span>the<span class="_"> </span>CPU</div><div class="t m5 xcd h26 y6042 ff7 fs19 fc2 sc0 ls0 ws0">executes<span class="_ _13"> </span>an<span class="_ _6"> </span>instruction<span class="_ _13"> </span>using<span class="_ _13"> </span>PC-relative<span class="_ _13"> </span>addressing<span class="_ _1"></span>,<span class="_ _13"> </span>it<span class="_ _13"> </span>forms<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffa">effective</span></div><div class="t m5 xcd h26 y6043 ffa fs19 fc2 sc0 ls0 ws0">address<span class="_ _13"> </span><span class="ff7">(e<span class="_ _1"></span>.g.,<span class="_ _13"> </span>the<span class="_ _13"> </span>target<span class="_ _13"> </span>of<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">call<span class="_ _13"> </span></span>instruction)<span class="_ _13"> </span>by<span class="_ _6"> </span>adding<span class="_ _13"> </span>the<span class="_ _13"> </span>32-bit<span class="_ _13"> </span>value</span></div><div class="t m5 x43 h2c y6044 ffa fs16 fc2 sc0 ls0 ws0">code/link/elfstructs<span class="_ _1"></span>.c</div><div class="t m5 x1f h2d y6045 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">typedef<span class="_ _1f"> </span>struct<span class="_ _e"> </span>{</span></div><div class="t m5 x1f h2d y6046 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>offset;<span class="_ _46"> </span>/*<span class="_ _1f"> </span>Offset<span class="_ _1f"> </span>of<span class="_ _e"> </span>the<span class="_ _1f"> </span>reference<span class="_ _e"> </span>to<span class="_ _1f"> </span>relocate<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1f h2e y6047 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x33 h2d y6048 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>type:32,<span class="_ _3f"> </span>/*<span class="_ _1f"> </span>Relocation<span class="_ _1f"> </span>type<span class="_ _e"> </span>*/</div><div class="t m5 x1f h2d y6049 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _89"> </span><span class="ffd fs1e fc2">symbol:32;<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Symbol<span class="_ _1f"> </span>table<span class="_ _e"> </span>index<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1f h2d y604a ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>addend;<span class="_ _46"> </span>/*<span class="_ _1f"> </span>Constant<span class="_ _1f"> </span>part<span class="_ _e"> </span>of<span class="_ _1f"> </span>relocation<span class="_ _e"> </span>expression<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1f h2e y309f ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x4f h2d y30a0 ffd fs1e fc2 sc0 ls0 ws0">}<span class="_ _e"> </span>Elf64_Rela;</div><div class="t m5 x43 h2c y604b ffa fs16 fc2 sc0 ls0 ws0">code/link/elfstructs<span class="_ _1"></span>.c</div><div class="t m5 x1d h34 y604c ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _13"> </span>7.9<span class="_ _66"> </span><span class="fc1">ELF<span class="_ _13"> </span>relocation<span class="_ _6"> </span>entry<span class="_ _1"></span>.<span class="_ _13"> </span><span class="ff6">Each<span class="_ _6"> </span>entry<span class="_ _13"> </span>identiﬁes<span class="_ _13"> </span>a<span class="_ _6"> </span>reference<span class="_ _13"> </span>that<span class="_ _6"> </span>must<span class="_ _13"> </span>be<span class="_ _6"> </span>relocated</span></span></div><div class="t m5 x1d h34 y604d ff6 fs16 fc1 sc0 ls0 ws0">and<span class="_ _10"> </span>speciﬁes<span class="_ _11"> </span>how<span class="_ _10"> </span>to<span class="_ _10"> </span>compute<span class="_ _11"> </span>the<span class="_ _10"> </span>modiﬁed<span class="_ _11"> </span>reference.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
