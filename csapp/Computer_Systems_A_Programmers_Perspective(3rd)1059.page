<div id="pf423" class="pf w2 h11" data-page-no="423"><div class="pc pc423 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg423.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1058<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x172 h2c y6781 ffa fs16 fc2 sc0 ls0 ws0">code/conc/ctime-ts<span class="_ _1"></span>.c</div><div class="t m5 xb h2d yb20 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">char<span class="_ _1f"> </span>*ctime_ts(const<span class="_ _e"> </span>time_t<span class="_ _1f"> </span>*timep,<span class="_ _1f"> </span>char<span class="_ _e"> </span>*privatep)</span></div><div class="t m5 xb h2d y1980 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 xb h2d y1983 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*sharedp;</span></div><div class="t m5 xb h2e y6782 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 xb h2e y83c2 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x26 h2d y6783 ffd fs1e fc2 sc0 ls0 ws0">P(&amp;mutex);</div><div class="t m5 xb h2d y6784 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">sharedp<span class="_ _e"> </span>=<span class="_ _1f"> </span>ctime(timep);</span></div><div class="t m5 xb h2d y6785 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">strcpy(privatep,<span class="_ _e"> </span>sharedp);<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>Copy<span class="_ _e"> </span>string<span class="_ _1f"> </span>from<span class="_ _e"> </span>shared<span class="_ _1f"> </span>to<span class="_ _1f"> </span>private<span class="_ _e"> </span>*/</span></div><div class="t m5 xb h2d y6787 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">V(&amp;mutex);</span></div><div class="t m5 xb h2d y6788 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>privatep;</span></div><div class="t m5 x14 h2d y6789 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x172 h2c y83c3 ffa fs16 fc2 sc0 ls0 ws0">code/conc/ctime-ts<span class="_ _1"></span>.c</div><div class="t m5 x14 h2f y83c4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>12.38<span class="_ _66"> </span><span class="fc1">Thread-safe<span class="_ _16"> </span>wrapper<span class="_ _16"> </span>function<span class="_ _16"> </span>for<span class="_ _16"> </span>the<span class="_ _16"> </span>C<span class="_ _16"> </span>standard<span class="_ _16"> </span>librar<span class="_ _2"></span>y</span></div><div class="t m5 x17b h3a y83c5 ffd fs19 fc1 sc0 ls0 ws0">ctime<span class="_ _16"> </span><span class="ffe fs16">function.<span class="_ _16"> </span><span class="ff6">This<span class="_ _16"> </span>example</span></span></div><div class="t m5 x14 h34 y83c6 ff6 fs16 fc1 sc0 ls0 ws0">uses<span class="_ _10"> </span>the<span class="_ _11"> </span>lock-and-copy<span class="_ _10"> </span>technique<span class="_ _10"> </span>to<span class="_ _11"> </span>call<span class="_ _10"> </span>a<span class="_ _11"> </span>class<span class="_ _10"> </span>3<span class="_ _11"> </span>thread-unsafe<span class="_ _10"> </span>function.</div><div class="t m5 xcd h26 y83c7 ff7 fs19 fc1 sc0 ls0 ws0">concurrent<span class="_ _16"> </span>threads<span class="_ _0"></span>,<span class="_ _14"> </span>then<span class="_ _14"> </span>disaster<span class="_ _14"> </span>is<span class="_ _14"> </span>likely<span class="_ _3"></span>,<span class="_ _14"> </span>as<span class="_ _14"> </span>results<span class="_ _14"> </span>being<span class="_ _14"> </span>used<span class="_ _16"> </span>by<span class="_ _14"> </span>one</div><div class="t m5 xcd h26 y83c8 ff7 fs19 fc1 sc0 ls0 ws0">thread<span class="_"> </span>are<span class="_"> </span>silently<span class="_"> </span>overwritten<span class="_"> </span>by<span class="_"> </span>another<span class="_"> </span>thread.</div><div class="t m5 x1c6 h26 y83c9 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>here<span class="_ _21"> </span>are<span class="_ _21"> </span>two<span class="_ _f"> </span>ways<span class="_ _21"> </span>to<span class="_ _21"> </span>deal<span class="_ _21"> </span>with<span class="_ _21"> </span>this<span class="_ _21"> </span>class<span class="_ _21"> </span>of<span class="_ _21"> </span>thread-unsafe<span class="_ _f"> </span>func-</div><div class="t m5 xcd h26 y83ca ff7 fs19 fc1 sc0 ls0 ws0">tions<span class="_ _1"></span>.<span class="_ _16"> </span>One<span class="_ _11"> </span>option<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _11"> </span>rewrite<span class="_ _16"> </span>the<span class="_ _16"> </span>function<span class="_ _11"> </span>so<span class="_ _16"> </span>that<span class="_ _16"> </span>the<span class="_ _16"> </span>caller<span class="_ _11"> </span>passes<span class="_ _16"> </span>the</div><div class="t m5 xcd h26 y83cb ff7 fs19 fc1 sc0 ls0 ws0">address<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>variable<span class="_ _16"> </span>in<span class="_ _14"> </span>which<span class="_ _16"> </span>to<span class="_ _16"> </span>store<span class="_ _14"> </span>the<span class="_ _16"> </span>results<span class="_ _1"></span>.<span class="_ _14"> </span>T<span class="_ _1"></span>his<span class="_ _14"> </span>eliminates<span class="_ _16"> </span>all</div><div class="t m5 xcd h26 y83cc ff7 fs19 fc1 sc0 ls0 ws0">shared<span class="_ _13"> </span>data,<span class="_ _13"> </span>but<span class="_ _6"> </span>it<span class="_ _13"> </span>requires<span class="_ _13"> </span>the<span class="_ _6"> </span>programmer<span class="_ _13"> </span>to<span class="_ _13"> </span>have<span class="_ _6"> </span>access<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _6"> </span>function</div><div class="t m5 xcd h26 y83cd ff7 fs19 fc1 sc0 ls0 ws0">source<span class="_"> </span>code<span class="_ _1"></span>.</div><div class="t m5 x1c6 h26 y83ce ff7 fs19 fc1 sc0 ls0 ws0">If<span class="_ _13"> </span>the<span class="_ _13"> </span>thread-unsafe<span class="_"> </span>function<span class="_ _13"> </span>is<span class="_ _13"> </span>difﬁcult<span class="_ _13"> </span>or<span class="_ _13"> </span>impossible<span class="_ _13"> </span>to<span class="_"> </span>modify<span class="_ _13"> </span>(e<span class="_ _1"></span>.g.,</div><div class="t m5 xcd h26 y83cf ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>code<span class="_ _16"> </span>is<span class="_ _11"> </span>very<span class="_ _11"> </span>complex<span class="_ _16"> </span>or<span class="_ _11"> </span>there<span class="_ _11"> </span>is<span class="_ _16"> </span>no<span class="_ _11"> </span>source<span class="_ _11"> </span>code<span class="_ _16"> </span>available),<span class="_ _11"> </span>then<span class="_ _16"> </span>an-</div><div class="t m5 xcd h26 y83d0 ff7 fs19 fc1 sc0 ls0 ws0">other<span class="_ _16"> </span>option<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _16"> </span>use<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffa">lock-and-cop<span class="_ _1"></span>y<span class="_ _16"> </span><span class="ff7">technique.<span class="_ _11"> </span>The<span class="_ _11"> </span>basic<span class="_ _16"> </span>idea<span class="_ _16"> </span>is<span class="_ _16"> </span>to</span></span></div><div class="t m5 xcd h26 y83d1 ff7 fs19 fc1 sc0 ls0 ws0">associate<span class="_"> </span>a<span class="_"> </span>mutex<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span>thread-unsafe<span class="_"> </span>function.<span class="_"> </span>At<span class="_"> </span>each<span class="_"> </span>call<span class="_"> </span>site<span class="_ _1"></span>,<span class="_"> </span>lock</div><div class="t m5 xcd h26 y83d2 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span>mutex,<span class="_ _14"> </span>call<span class="_ _14"> </span>the<span class="_ _14"> </span>thread-unsafe<span class="_ _16"> </span>function,<span class="_ _14"> </span>copy<span class="_ _14"> </span>the<span class="_ _14"> </span>result<span class="_ _16"> </span>returned<span class="_ _14"> </span>by</div><div class="t m5 xcd h26 y83d3 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span>function<span class="_ _16"> </span>to<span class="_ _16"> </span>a<span class="_ _16"> </span>private<span class="_ _16"> </span>memory<span class="_ _16"> </span>location,<span class="_ _14"> </span>and<span class="_ _16"> </span>then<span class="_ _16"> </span>unlock<span class="_ _14"> </span>the<span class="_ _16"> </span>mutex.</div><div class="t m5 xcd h26 y83d4 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_"> </span>minimize<span class="_"> </span>changes<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>caller<span class="_ _0"></span>,<span class="_"> </span>you<span class="_"> </span>should<span class="_"> </span>deﬁne<span class="_ _13"> </span>a<span class="_"> </span>thread-safe<span class="_"> </span>wrap-</div><div class="t m5 xcd h26 y83d5 ff7 fs19 fc1 sc0 ls0 ws0">per<span class="_ _16"> </span>function<span class="_ _16"> </span>that<span class="_ _14"> </span>performs<span class="_ _16"> </span>the<span class="_ _16"> </span>lock-and-copy<span class="_ _14"> </span>and<span class="_ _16"> </span>then<span class="_ _16"> </span>replace<span class="_ _14"> </span>all<span class="_ _16"> </span>calls</div><div class="t m5 xcd h26 y83d6 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _21"> </span>the<span class="_ _21"> </span>thread-unsafe<span class="_ _21"> </span>function<span class="_ _21"> </span>with<span class="_ _21"> </span>calls<span class="_ _21"> </span>to<span class="_ _21"> </span>the<span class="_ _f"> </span>wrapper.<span class="_ _15"> </span>F<span class="_ _1"></span>or<span class="_ _21"> </span>example,</div><div class="t m5 xcd h26 y83d7 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>12.38<span class="_ _16"> </span>shows<span class="_ _16"> </span>a<span class="_ _16"> </span>thread-safe<span class="_ _16"> </span>wrapper<span class="_ _16"> </span>for<span class="_ _14"> </span><span class="ffd">ctime<span class="_ _16"> </span></span>that<span class="_ _16"> </span>uses<span class="_ _16"> </span>the<span class="_ _16"> </span>lock-</div><div class="t m5 xcd h26 y83d8 ff7 fs19 fc1 sc0 ls0 ws0">and-copy<span class="_"> </span>technique<span class="_ _1"></span>.</div><div class="t m5 x75 h26 y83d9 ff7 fs19 fc1 sc0 ls0 ws0">Class<span class="_ _6"> </span>4:<span class="_ _1f"> </span><span class="ffa">Functions<span class="_ _6"> </span>that<span class="_ _6"> </span>call<span class="_ _13"> </span>thread-unsafe<span class="_ _a"> </span>functions<span class="_ _0"></span>.<span class="_ _5"></span><span class="ff7">If<span class="_ _6"> </span>a<span class="_ _13"> </span>function<span class="_ _a"> </span><span class="ff11">f<span class="_"> </span></span>calls<span class="_ _13"> </span>a<span class="_ _a"> </span>thread-</span></span></div><div class="t m5 xcd h26 y83da ff7 fs19 fc1 sc0 ls0 ws0">unsafe<span class="_ _13"> </span>function<span class="_"> </span><span class="ff11">g</span><span class="ls66">,i<span class="_ _80"></span>s<span class="ff11 ls0">f<span class="_ _15"> </span><span class="ff7">thread-unsafe?<span class="_"> </span>It<span class="_ _13"> </span>depends<span class="_ _3"></span>.<span class="_"> </span>If<span class="_ _13"> </span><span class="ff11">g<span class="_ _10"> </span></span>is<span class="_ _13"> </span>a<span class="_"> </span>class<span class="_ _13"> </span>2<span class="_ _13"> </span>function</span></span></span></div><div class="t m5 xcd h26 y83db ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _15"> </span>relies<span class="_ _21"> </span>on<span class="_ _21"> </span>state<span class="_ _15"> </span>across<span class="_ _21"> </span>multiple<span class="_ _21"> </span>invocations<span class="_ _1"></span>,<span class="_ _f"> </span>then<span class="_ _21"> </span><span class="ff11">f<span class="_ _22"> </span></span>is<span class="_ _21"> </span>also<span class="_ _15"> </span>thread-</div><div class="t m5 xcd h26 y83dc ff7 fs19 fc1 sc0 ls0 ws0">unsafe<span class="_ _16"> </span>and<span class="_ _16"> </span>there<span class="_ _16"> </span>is<span class="_ _14"> </span>no<span class="_ _16"> </span>recourse<span class="_ _16"> </span>short<span class="_ _14"> </span>of<span class="_ _16"> </span>rewriting<span class="_ _16"> </span><span class="ff11">g<span class="_ _2"></span></span>.<span class="_ _16"> </span>However,<span class="_ _14"> </span>if<span class="_ _16"> </span><span class="ff11">g<span class="_ _14"> </span></span>is<span class="_ _14"> </span>a</div><div class="t m5 xcd h26 y83dd ff7 fs19 fc1 sc0 ls0 ws0">class<span class="_ _16"> </span>1<span class="_ _16"> </span>or<span class="_ _16"> </span>class<span class="_ _16"> </span>3<span class="_ _16"> </span>function,<span class="_ _16"> </span>then<span class="_ _16"> </span><span class="ff11">f<span class="_ _e"> </span></span>can<span class="_ _16"> </span>still<span class="_ _16"> </span>be<span class="_ _16"> </span>thread-safe<span class="_ _16"> </span>if<span class="_ _16"> </span>you<span class="_ _16"> </span>protect</div><div class="t m5 xcd h26 y83de ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span>call<span class="_ _11"> </span>site<span class="_ _16"> </span>and<span class="_ _16"> </span>any<span class="_ _11"> </span>resulting<span class="_ _16"> </span>shared<span class="_ _16"> </span>data<span class="_ _11"> </span>with<span class="_ _16"> </span>a<span class="_ _16"> </span>mutex.<span class="_ _11"> </span>W<span class="_ _1"></span>e<span class="_ _16"> </span>see<span class="_ _11"> </span>a<span class="_ _16"> </span>good</div><div class="t m5 xcd h26 y83df ff7 fs19 fc1 sc0 ls0 ws0">example<span class="_ _16"> </span>of<span class="_ _16"> </span>this<span class="_ _16"> </span>in<span class="_ _16"> </span>Figure<span class="_ _11"> </span>12.38,<span class="_ _14"> </span>where<span class="_ _16"> </span>we<span class="_ _16"> </span>use<span class="_ _16"> </span>lock-and-copy<span class="_ _14"> </span>to<span class="_ _16"> </span>write<span class="_ _16"> </span>a</div><div class="t m5 xcd h26 y83e0 ff7 fs19 fc1 sc0 ls0 ws0">thread-safe<span class="_"> </span>function<span class="_"> </span>that<span class="_"> </span>calls<span class="_"> </span>a<span class="_"> </span>thread-unsafe<span class="_"> </span>function.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
