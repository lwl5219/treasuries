<div id="pf3e3" class="pf w2 h11" data-page-no="3e3"><div class="pc pc3e3 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3e3.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">994<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>11<span class="_ _3d"> </span>Network<span class="_ _10"> </span>Programming</span></div><div class="t m5 x133 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 xb h88 y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>doit(int<span class="_ _e"> </span>fd)</span></div><div class="t m5 xb h88 y35f1 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 xb h88 ye97 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>is_static;</span></div><div class="t m5 xb h88 y59ed ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _e2"> </span><span class="ffd fs4e fc2">struct<span class="_ _e"> </span>stat<span class="_ _e"> </span>sbuf;</span></div><div class="t m5 xb h88 y2827 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _e2"> </span><span class="ffd fs4e fc2">char<span class="_ _e"> </span>buf[MAXLINE],<span class="_ _e"> </span>method[MAXLINE],<span class="_ _f"> </span>uri[MAXLINE],<span class="_ _e"> </span>version[MAXLINE];</span></div><div class="t m5 xb h88 y59ee ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _e2"> </span><span class="ffd fs4e fc2">char<span class="_ _e"> </span>filename[MAXLINE],<span class="_ _e"> </span>cgiargs[MAXLINE];</span></div><div class="t m5 xb h88 y180c ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _e2"> </span><span class="ffd fs4e fc2">rio_t<span class="_ _e"> </span>rio;</span></div><div class="t m5 xb h2e y59ef ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 xb h2e y7cbc ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x37 h88 y59f0 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Read<span class="_ _f"> </span>request<span class="_ _e"> </span>line<span class="_ _e"> </span>and<span class="_ _f"> </span>headers<span class="_ _e"> </span>*/</div><div class="t m5 x14 h2e y59f1 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x37 h88 y59f2 ffd fs4e fc2 sc0 ls0 ws0">Rio_readinitb(&amp;rio,<span class="_ _e"> </span>fd);</div><div class="t m5 x14 h88 y59f3 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _e2"> </span><span class="ffd fs4e fc2">Rio_readlineb(&amp;rio,<span class="_ _e"> </span>buf,<span class="_ _e"> </span>MAXLINE);</span></div><div class="t m5 x14 h88 y59f4 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _e2"> </span><span class="ffd fs4e fc2">printf(&quot;Request<span class="_ _e"> </span>headers:\n&quot;);</span></div><div class="t m5 x14 h88 y59f6 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _e2"> </span><span class="ffd fs4e fc2">printf(&quot;%s&quot;,<span class="_ _e"> </span>buf);</span></div><div class="t m5 x14 h88 y59f7 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _e2"> </span><span class="ffd fs4e fc2">sscanf(buf,<span class="_ _e"> </span>&quot;%s<span class="_ _e"> </span>%s<span class="_ _f"> </span>%s&quot;,<span class="_ _e"> </span>method,<span class="_ _e"> </span>uri,<span class="_ _f"> </span>version);</span></div><div class="t m5 x14 h88 y37bd ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _e2"> </span><span class="ffd fs4e fc2">if<span class="_ _e"> </span>(strcasecmp(method,<span class="_ _e"> </span>&quot;GET&quot;))<span class="_ _f"> </span>{</span></div><div class="t m5 x14 h88 y59f8 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _121"> </span><span class="ffd fs4e fc2">clienterror(fd,<span class="_ _e"> </span>method,<span class="_ _e"> </span>&quot;501&quot;,<span class="_ _e"> </span>&quot;Not<span class="_ _f"> </span>implemented&quot;,</span></div><div class="t m5 x14 h88 y4b5d ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _1b0"> </span><span class="ffd fs4e fc2">&quot;Tiny<span class="_ _e"> </span>does<span class="_ _e"> </span>not<span class="_ _f"> </span>implement<span class="_ _e"> </span>this<span class="_ _e"> </span>method&quot;);</span></div><div class="t m5 x14 h88 y59f9 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _18b"> </span><span class="ffd fs4e fc2">return;</span></div><div class="t m5 x14 h88 y59fa ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x14 h88 y59fb ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _e2"> </span><span class="ffd fs4e fc2">read_requesthdrs(&amp;rio);</span></div><div class="t m5 x14 h2e y59fd ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x14 h2e y7df0 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x37 h88 y59fe ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Parse<span class="_ _f"> </span>URI<span class="_ _e"> </span>from<span class="_ _e"> </span>GET<span class="_ _f"> </span>request<span class="_ _e"> </span>*/</div><div class="t m5 x14 h88 y59ff ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _e2"> </span><span class="ffd fs4e fc2">is_static<span class="_ _e"> </span>=<span class="_ _e"> </span>parse_uri(uri,<span class="_ _f"> </span>filename,<span class="_ _e"> </span>cgiargs);</span></div><div class="t m5 x14 h88 y2568 ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _e2"> </span><span class="ffd fs4e fc2">if<span class="_ _e"> </span>(stat(filename,<span class="_ _e"> </span>&amp;sbuf)<span class="_ _f"> </span>&lt;<span class="_ _e"> </span>0)<span class="_ _e"> </span>{</span></div><div class="t m5 x14 h88 y5a00 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _18b"> </span><span class="ffd fs4e fc2">clienterror(fd,<span class="_ _e"> </span>filename,<span class="_ _f"> </span>&quot;404&quot;,<span class="_ _e"> </span>&quot;Not<span class="_ _e"> </span>found&quot;,</span></div><div class="t m5 x14 h88 y5a01 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _232"> </span><span class="ffd fs4e fc2">&quot;Tiny<span class="_ _e"> </span>couldn’t<span class="_ _f"> </span>find<span class="_ _e"> </span>this<span class="_ _e"> </span>file&quot;);</span></div><div class="t m5 x14 h88 y301c ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _18b"> </span><span class="ffd fs4e fc2">return;</span></div><div class="t m5 x14 h2e y7df1 ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x37 h88 y5a03 ffd fs4e fc2 sc0 ls0 ws0">}</div><div class="t m5 x14 h2e y5a04 ff6 fs20 fc6 sc0 ls0 ws0">29</div><div class="t m5 x14 h2e y7df2 ff6 fs20 fc6 sc0 ls0 ws0">30</div><div class="t m5 x37 h88 y5a05 ffd fs4e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(is_static)<span class="_ _f"> </span>{<span class="_ _e"> </span>/*<span class="_ _e"> </span>Serve<span class="_ _f"> </span>static<span class="_ _e"> </span>content<span class="_ _e"> </span>*/</div><div class="t m5 x14 h88 y5a06 ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _18b"> </span><span class="ffd fs4e fc2">if<span class="_ _e"> </span>(!(S_ISREG(sbuf.st_mode))<span class="_ _f"> </span>||<span class="_ _e"> </span>!(S_IRUSR<span class="_ _e"> </span>&amp;<span class="_ _f"> </span>sbuf.st_mode))<span class="_ _e"> </span>{</span></div><div class="t m5 x14 h88 y1dd5 ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _1eb"> </span><span class="ffd fs4e fc2">clienterror(fd,<span class="_ _e"> </span>filename,<span class="_ _e"> </span>&quot;403&quot;,<span class="_ _f"> </span>&quot;Forbidden&quot;,</span></div><div class="t m5 x14 h88 y1abf ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _23a"> </span><span class="ffd fs4e fc2">&quot;Tiny<span class="_ _e"> </span>couldn’t<span class="_ _f"> </span>read<span class="_ _e"> </span>the<span class="_ _e"> </span>file&quot;);</span></div><div class="t m5 x14 h88 y296f ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _1eb"> </span><span class="ffd fs4e fc2">return;</span></div><div class="t m5 x14 h88 y5a07 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _18b"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x14 h88 y5a08 ff6 fs20 fc6 sc0 ls0 ws0">36<span class="_ _18b"> </span><span class="ffd fs4e fc2">serve_static(fd,<span class="_ _e"> </span>filename,<span class="_ _f"> </span>sbuf.st_size);</span></div><div class="t m5 x14 h88 y5a0a ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x14 h88 y55cc ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _e2"> </span><span class="ffd fs4e fc2">else<span class="_ _e"> </span>{<span class="_ _e"> </span>/*<span class="_ _f"> </span>Serve<span class="_ _e"> </span>dynamic<span class="_ _e"> </span>content<span class="_ _f"> </span>*/</span></div><div class="t m5 x14 h88 y3028 ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _18b"> </span><span class="ffd fs4e fc2">if<span class="_ _e"> </span>(!(S_ISREG(sbuf.st_mode))<span class="_ _f"> </span>||<span class="_ _e"> </span>!(S_IXUSR<span class="_ _e"> </span>&amp;<span class="_ _f"> </span>sbuf.st_mode))<span class="_ _e"> </span>{</span></div><div class="t m5 x14 h88 y55cd ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _1eb"> </span><span class="ffd fs4e fc2">clienterror(fd,<span class="_ _e"> </span>filename,<span class="_ _e"> </span>&quot;403&quot;,<span class="_ _f"> </span>&quot;Forbidden&quot;,</span></div><div class="t m5 x14 h88 yc47 ff6 fs20 fc6 sc0 ls0 ws0">41<span class="_ _23a"> </span><span class="ffd fs4e fc2">&quot;Tiny<span class="_ _e"> </span>couldn’t<span class="_ _f"> </span>run<span class="_ _e"> </span>the<span class="_ _e"> </span>CGI<span class="_ _f"> </span>program&quot;);</span></div><div class="t m5 x14 h88 y6294 ff6 fs20 fc6 sc0 ls0 ws0">42<span class="_ _1eb"> </span><span class="ffd fs4e fc2">return;</span></div><div class="t m5 x14 h88 y6295 ff6 fs20 fc6 sc0 ls0 ws0">43<span class="_ _18b"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x14 h88 yc0 ff6 fs20 fc6 sc0 ls0 ws0">44<span class="_ _18b"> </span><span class="ffd fs4e fc2">serve_dynamic(fd,<span class="_ _e"> </span>filename,<span class="_ _f"> </span>cgiargs);</span></div><div class="t m5 x14 h88 y7df3 ff6 fs20 fc6 sc0 ls0 ws0">45<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x14 h88 y7df4 ff6 fs20 fc6 sc0 ls0 ws0">46<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x133 h2c y7df5 ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x14 h2f y7df6 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>11.30<span class="_ _66"> </span><span class="ff1b fc1 ls2e6">Ti<span class="_ _5"></span>n<span class="_ _5"></span>y</span></div><div class="t m5 x156 h3a y7df7 ffd fs19 fc1 sc0 ls0 ws0">doit<span class="_ _10"> </span><span class="ffe fs16">handles<span class="_"> </span>one<span class="_"> </span>HTTP<span class="_"> </span>transaction.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
