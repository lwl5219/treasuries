<div id="pf304" class="pf w2 h11" data-page-no="304"><div class="pc pc304 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg304.png"/><div class="t m5 x11e h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>8.2<span class="_ _60"> </span>Processes<span class="_ _3e"> </span><span class="ffe fs1e">771</span></div><div class="t m5 x17 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>8.13</div><div class="t m5 x17 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Process<span class="_"> </span>address<span class="_"> </span>space.</div><div class="t m5 xb3 hfc y652c ff8d fs9a fc1 sc0 ls0 ws0">0x400000</div><div class="t m5 x228 hfc y652d ff8d fs9a fc1 sc0 ls0 ws0">0</div><div class="t m5 x219 hfd y652e ff96 fs99 fc1 sc0 ls0 ws0">Memory</div><div class="t m5 x219 hfd y652f ff96 fs99 fc1 sc0 ls0 ws0">invisible to</div><div class="t m5 x219 hfd y6530 ff96 fs99 fc1 sc0 ls0 ws0">user code</div><div class="t m5 x219 hfc y6531 ff8d fs9a fc1 sc0 ls0 ws0">%esp<span class="fs9b"> <span class="ff96 fs99">(stack pointer)</span></span></div><div class="t m5 x219 hfc y6532 ff8d fs9a fc1 sc0 ls0 ws0">brk</div><div class="t m5 x219 hfd y6533 ff96 fs99 fc1 sc0 ls0 ws0">Loaded from the</div><div class="t m5 x219 hfd y6534 ff96 fs99 fc1 sc0 ls0 ws0">executable file</div><div class="t m5 x23b hfd y6535 ff96 fs99 fc1 sc0 ls0 ws0">User stack</div><div class="t m5 x1b3 hfd y6536 ff96 fs99 fc1 sc0 ls0 ws0">(created at run time)</div><div class="t m5 x7b hfd y6537 ff96 fs99 fc1 sc0 ls0 ws0">Memory-mapped region for</div><div class="t m5 xd2 hfd y6538 ff96 fs99 fc1 sc0 ls0 ws0">shared libraries</div><div class="t m5 x139 hfd y6539 ff96 fs99 fc1 sc0 ls0 ws0">Run-time heap</div><div class="t m5 x1b3 hfd y653a ff96 fs99 fc1 sc0 ls0 ws0">(created by </div><div class="t m5 xc0 hfc y653b ff8d fs9a fc1 sc0 ls0 ws0">malloc<span class="ff96 fs99">)</span></div><div class="t m5 x181 hfd y653c ff96 fs99 fc1 sc0 ls0 ws0">Read/write segment</div><div class="t m5 x179 hfd y653d ff96 fs99 fc1 sc0 ls0 ws0">(</div><div class="t m5 x9a hfc y653e ff8d fs9a fc1 sc0 ls0 ws0">.data,.bss<span class="ff96 fs99">)</span></div><div class="t m5 x113 hfd y653f ff96 fs99 fc1 sc0 ls0 ws0">Read-only code segment</div><div class="t m5 x24e hfd y6540 ff96 fs99 fc1 sc0 ls0 ws0">(</div><div class="t m5 x16 hfc y6541 ff8d fs9a fc1 sc0 ls0 ws0">.init,.text,.rodata<span class="ff96 fs99">)</span></div><div class="t m5 x185 hfd y6542 ff96 fs99 fc1 sc0 ls0 ws0">Kernel virtual memory</div><div class="t m5 xa7 hfd y6543 ff96 fs99 fc1 sc0 ls0 ws0">(code, data, heap, stack)</div><div class="t m5 x22 hfc y6544 ff8d fs9a fc1 sc0 ls0 ws0">2</div><div class="t m5 x255 hfe y6545 ff8d fs9c fc1 sc0 ls0 ws0">48</div><div class="t m5 x24c hfc y6544 ff8d fs9a fc1 sc0 ls0 ws0">-1</div><div class="t m5 x17 h26 y950 ff7 fs19 fc1 sc0 ls0 ws0">application<span class="_ _16"> </span>can<span class="_ _16"> </span>execute,<span class="_ _16"> </span>as<span class="_ _14"> </span>well<span class="_ _16"> </span>as<span class="_ _16"> </span>the<span class="_ _14"> </span>portions<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>address<span class="_ _16"> </span>space<span class="_ _16"> </span>that<span class="_ _14"> </span>it<span class="_ _16"> </span>can</div><div class="t m5 x17 h26 y951 ff7 fs19 fc1 sc0 ls0 ws0">access<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y952 ff7 fs19 fc1 sc0 ls0 ws0">Processors<span class="_ _16"> </span>typically<span class="_ _16"> </span>provide<span class="_ _16"> </span>this<span class="_ _16"> </span>capability<span class="_ _16"> </span>with<span class="_ _16"> </span>a<span class="_ _11"> </span><span class="ffa">mode<span class="_ _16"> </span>bit<span class="_ _15"> </span></span>in<span class="_ _16"> </span>some<span class="_ _16"> </span>control</div><div class="t m5 x17 h26 y953 ff7 fs19 fc1 sc0 ls0 ws0">register<span class="_"> </span>that<span class="_ _11"> </span>characterizes<span class="_ _11"> </span>the<span class="_ _11"> </span>privileges<span class="_ _11"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>process<span class="_ _11"> </span>currently<span class="_"> </span>enjoys<span class="_ _0"></span>.<span class="_"> </span>When</div><div class="t m5 x17 h26 y954 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _21"> </span>mode<span class="_ _f"> </span>bit<span class="_ _f"> </span>is<span class="_ _f"> </span>set,<span class="_ _e"> </span>the<span class="_ _f"> </span>process<span class="_ _f"> </span>is<span class="_ _f"> </span>running<span class="_ _f"> </span>in<span class="_ _21"> </span><span class="ffa">kernel<span class="_ _f"> </span>mode<span class="_ _f"> </span></span>(sometimes<span class="_ _f"> </span>called</div><div class="t m5 x17 h26 y955 ffa fs19 fc1 sc0 ls0 ws0">supervisor<span class="_"> </span>mode<span class="ff7">).<span class="_"> </span>A<span class="_"> </span>process<span class="_"> </span>running<span class="_"> </span>in<span class="_"> </span>kernel<span class="_"> </span>mode<span class="_"> </span>can<span class="_"> </span>execute<span class="_"> </span>any<span class="_"> </span>instruction</span></div><div class="t m5 x17 h26 y956 ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_"> </span>the<span class="_"> </span>instruction<span class="_"> </span>set<span class="_"> </span>and<span class="_"> </span>access<span class="_"> </span>any<span class="_"> </span>memory<span class="_"> </span>location<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>system.</div><div class="t m5 x26 h26 y957 ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_"> </span>the<span class="_"> </span>mode<span class="_"> </span>bit<span class="_"> </span>is<span class="_"> </span>not<span class="_"> </span>set,<span class="_"> </span>the<span class="_"> </span>process<span class="_ _11"> </span>is<span class="_"> </span>running<span class="_"> </span>in<span class="_"> </span><span class="ffa">user<span class="_ _11"> </span>mode</span>.<span class="_"> </span>A<span class="_"> </span>process</div><div class="t m5 x17 h26 y958 ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_"> </span>user<span class="_"> </span>mode<span class="_ _11"> </span>is<span class="_"> </span>not<span class="_ _11"> </span>allowed<span class="_"> </span>to<span class="_ _11"> </span>execute<span class="_"> </span><span class="ffa">privileged<span class="_"> </span>instructions<span class="_ _11"> </span></span>that<span class="_"> </span>do<span class="_ _11"> </span>things<span class="_"> </span>such</div><div class="t m5 x17 h26 y959 ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_"> </span>halt<span class="_ _11"> </span>the<span class="_ _11"> </span>processor,<span class="_ _11"> </span>change<span class="_ _11"> </span>the<span class="_ _11"> </span>mode<span class="_"> </span>bit,<span class="_ _16"> </span>or<span class="_"> </span>initiate<span class="_ _11"> </span>an<span class="_ _11"> </span>I/O<span class="_ _11"> </span>operation.<span class="_ _11"> </span>Nor<span class="_ _11"> </span>is<span class="_"> </span>it</div><div class="t m5 x17 h26 y95a ff7 fs19 fc1 sc0 ls0 ws0">allowed<span class="_"> </span>to<span class="_ _13"> </span>directly<span class="_"> </span>reference<span class="_ _13"> </span>code<span class="_"> </span>or<span class="_ _13"> </span>data<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>kernel<span class="_"> </span>area<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>address<span class="_"> </span>space<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y95b ff7 fs19 fc1 sc0 ls0 ws0">Any<span class="_"> </span>such<span class="_ _11"> </span>attempt<span class="_ _11"> </span>results<span class="_ _11"> </span>in<span class="_ _11"> </span>a<span class="_ _11"> </span>fatal<span class="_"> </span>protection<span class="_ _11"> </span>fault.<span class="_ _11"> </span>User<span class="_ _11"> </span>programs<span class="_ _11"> </span>must<span class="_ _11"> </span>instead</div><div class="t m5 x17 h26 y95c ff7 fs19 fc1 sc0 ls0 ws0">access<span class="_"> </span>kernel<span class="_"> </span>code<span class="_"> </span>and<span class="_"> </span>data<span class="_"> </span>indirectly<span class="_"> </span>via<span class="_"> </span>the<span class="_"> </span>system<span class="_"> </span>call<span class="_"> </span>interface<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y95d ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_ _13"> </span>process<span class="_"> </span>running<span class="_ _13"> </span>application<span class="_ _13"> </span>code<span class="_"> </span>is<span class="_ _13"> </span>initially<span class="_ _13"> </span>in<span class="_"> </span>user<span class="_ _13"> </span>mode<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>only<span class="_"> </span>way<span class="_ _13"> </span>for</div><div class="t m5 x17 h26 y95e ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>process<span class="_"> </span>to<span class="_"> </span>change<span class="_"> </span>from<span class="_"> </span>user<span class="_ _13"> </span>mode<span class="_"> </span>to<span class="_"> </span>kernel<span class="_"> </span>mode<span class="_"> </span>is<span class="_"> </span>via<span class="_"> </span>an<span class="_"> </span>exception<span class="_"> </span>such<span class="_"> </span>as</div><div class="t m5 x17 h26 y95f ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_ _16"> </span>interrupt,<span class="_ _14"> </span>a<span class="_ _16"> </span>fault,<span class="_ _14"> </span>or<span class="_ _16"> </span>a<span class="_ _16"> </span>trapping<span class="_ _14"> </span>system<span class="_ _16"> </span>call.<span class="_ _16"> </span>When<span class="_ _16"> </span>the<span class="_ _16"> </span>exception<span class="_ _16"> </span>occurs<span class="_ _0"></span>,<span class="_ _16"> </span>and</div><div class="t m5 x17 h26 y960 ff7 fs19 fc1 sc0 ls0 ws0">control<span class="_ _14"> </span>passes<span class="_ _14"> </span>to<span class="_ _15"> </span>the<span class="_ _14"> </span>exception<span class="_ _15"> </span>handler,<span class="_ _14"> </span>the<span class="_ _15"> </span>processor<span class="_ _14"> </span>changes<span class="_ _15"> </span>the<span class="_ _14"> </span>mode<span class="_ _14"> </span>from</div><div class="t m5 x17 h26 y961 ff7 fs19 fc1 sc0 ls0 ws0">user<span class="_"> </span>mode<span class="_ _11"> </span>to<span class="_ _11"> </span>kernel<span class="_ _11"> </span>mode<span class="_ _0"></span>.<span class="_"> </span>The<span class="_"> </span>handler<span class="_ _11"> </span>runs<span class="_"> </span>in<span class="_ _11"> </span>kernel<span class="_ _11"> </span>mode.<span class="_"> </span>When<span class="_"> </span>it<span class="_"> </span>returns<span class="_ _11"> </span>to</div><div class="t m5 x17 h26 y962 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>application<span class="_ _11"> </span>code<span class="_ _0"></span>,<span class="_"> </span>the<span class="_ _11"> </span>processor<span class="_"> </span>changes<span class="_ _11"> </span>the<span class="_ _11"> </span>mode<span class="_"> </span>from<span class="_ _11"> </span>kernel<span class="_"> </span>mode<span class="_ _11"> </span>back<span class="_ _11"> </span>to</div><div class="t m5 x17 h26 y963 ff7 fs19 fc1 sc0 ls0 ws0">user<span class="_"> </span>mode<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y964 ff7 fs19 fc1 sc0 ls0 ws0">Linux<span class="_ _11"> </span>provides<span class="_ _16"> </span>a<span class="_ _11"> </span>clever<span class="_ _11"> </span>mechanism,<span class="_ _16"> </span>called<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffd">/proc<span class="_ _11"> </span></span>ﬁlesystem,<span class="_ _16"> </span>that<span class="_ _11"> </span>allows</div><div class="t m5 x17 h26 y965 ff7 fs19 fc1 sc0 ls0 ws0">user<span class="_ _11"> </span>mode<span class="_ _11"> </span>processes<span class="_ _16"> </span>to<span class="_ _11"> </span>access<span class="_ _11"> </span>the<span class="_ _16"> </span>contents<span class="_ _11"> </span>of<span class="_ _11"> </span>kernel<span class="_ _16"> </span>data<span class="_ _11"> </span>structures<span class="_ _1"></span>.<span class="_ _11"> </span>The<span class="_"> </span><span class="ffd">/proc</span></div><div class="t m5 x17 h26 y966 ff7 fs19 fc1 sc0 ls0 ws0">ﬁlesystem<span class="_ _6"> </span>exports<span class="_ _6"> </span>the<span class="_ _6"> </span>contents<span class="_ _6"> </span>of<span class="_ _6"> </span>many<span class="_ _6"> </span>kernel<span class="_ _6"> </span>data<span class="_ _6"> </span>structures<span class="_ _6"> </span>as<span class="_ _6"> </span>a<span class="_ _6"> </span>hierarchy<span class="_ _6"> </span>of<span class="_ _6"> </span>text</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
