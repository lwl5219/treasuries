<div id="pf406" class="pf w2 h11" data-page-no="406"><div class="pc pc406 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg406.png"/><div class="t m5 xd3 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.4<span class="_ _60"> </span>Shared<span class="_ _10"> </span>V<span class="_ _0"></span>ariables<span class="_ _10"> </span>in<span class="_ _10"> </span>Threaded<span class="_ _10"> </span>Programs<span class="_ _1b"> </span><span class="ffe fs1e">1029</span></div><div class="t m5 x195 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/sharing.c</div><div class="t m5 x2c h88 y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h88 y35f1 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">#define<span class="_ _e"> </span>N<span class="_ _e"> </span>2</span></div><div class="t m5 x2c h88 ye97 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>*thread(void<span class="_ _e"> </span>*vargp);</span></div><div class="t m5 x2c h2e y59ed ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y80ad ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2d h88 y2827 ffd fs4e fc2 sc0 ls0 ws0">char<span class="_ _e"> </span>**ptr;<span class="_ _ea"> </span>/*<span class="_ _e"> </span>Global<span class="_ _f"> </span>variable<span class="_ _e"> </span>*/</div><div class="t m5 x2c h2e y59ee ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2c h2e y80ae ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x2d h88 y180c ffd fs4e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x2c h88 y59ef ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x2c h88 y59f0 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>i;</span></div><div class="t m5 x17 h2e y59f1 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x1a0 h88 y59f2 ffd fs4e fc2 sc0 ls0 ws0">pthread_t<span class="_ _e"> </span>tid;</div><div class="t m5 x17 h88 y59f3 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _e2"> </span><span class="ffd fs4e fc2">char<span class="_ _e"> </span>*msgs[N]<span class="_ _e"> </span>=<span class="_ _f"> </span>{</span></div><div class="t m5 x17 h88 y59f4 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _18b"> </span><span class="ffd fs4e fc2">&quot;Hello<span class="_ _e"> </span>from<span class="_ _f"> </span>foo&quot;,</span></div><div class="t m5 x17 h88 y59f6 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _18b"> </span><span class="ffd fs4e fc2">&quot;Hello<span class="_ _e"> </span>from<span class="_ _f"> </span>bar&quot;</span></div><div class="t m5 x17 h88 y59f7 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _e2"> </span><span class="ffd fs4e fc2">};</span></div><div class="t m5 x17 h2e y37bd ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x17 h2e y7cbf ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x1a0 h88 y59f8 ffd fs4e fc2 sc0 ls0 ws0">ptr<span class="_ _e"> </span>=<span class="_ _f"> </span>msgs;</div><div class="t m5 x17 h88 y4b5d ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _e2"> </span><span class="ffd fs4e fc2 ls253">f<span class="_ _223"></span>o<span class="_ _8a"></span>r(<span class="_ _223"></span>i=0<span class="_ _8a"></span>;i&lt;N<span class="_ _223"></span>;<span class="ls0">i++)</span></span></div><div class="t m5 x17 h88 y59f9 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _18b"> </span><span class="ffd fs4e fc2">Pthread_create(&amp;tid,<span class="_ _e"> </span>NULL,<span class="_ _f"> </span>thread,<span class="_ _e"> </span>(void<span class="_ _e"> </span>*)i);</span></div><div class="t m5 x17 h88 y59fa ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _e2"> </span><span class="ffd fs4e fc2">Pthread_exit(NULL);</span></div><div class="t m5 x17 h88 y59fb ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h2e y59fd ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x17 h2e y7df0 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x2d h88 y59fe ffd fs4e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*thread(void<span class="_ _f"> </span>*vargp)</div><div class="t m5 x17 h88 y59ff ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x17 h88 y2568 ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>myid<span class="_ _e"> </span>=<span class="_ _f"> </span>(int)vargp;</span></div><div class="t m5 x17 h88 y5a00 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _e2"> </span><span class="ffd fs4e fc2">static<span class="_ _e"> </span>int<span class="_ _e"> </span>cnt<span class="_ _f"> </span>=<span class="_ _e"> </span>0;</span></div><div class="t m5 x17 h88 y5a01 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _e2"> </span><span class="ffd fs4e fc2">printf(&quot;[%d]:<span class="_ _e"> </span>%s<span class="_ _e"> </span>(cnt=%d)\n&quot;,<span class="_ _f"> </span>myid,<span class="_ _e"> </span>ptr[myid],<span class="_ _e"> </span>++cnt);</span></div><div class="t m5 x17 h88 y301c ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _e2"> </span><span class="ffd fs4e fc2">return<span class="_ _e"> </span>NULL;</span></div><div class="t m5 x17 h2e y7df1 ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x2d h88 y5a03 ffd fs4e fc2 sc0 ls0 ws0">}</div><div class="t m5 x195 h2c y80af ffa fs16 fc2 sc0 ls0 ws0">code/conc/sharing.c</div><div class="t m5 x17 h2f y80b0 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.15<span class="_ _66"> </span><span class="fc1">Example<span class="_"> </span>program<span class="_"> </span>that<span class="_"> </span>illustrates<span class="_"> </span>different<span class="_"> </span>aspects<span class="_"> </span>of<span class="_"> </span>sharing.</span></div><div class="t m5 x17 h26 y80b1 ff7 fs19 fc1 sc0 ls0 ws0">instances?<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>variable<span class="_ _16"> </span>is<span class="_ _16"> </span><span class="ffa">shared<span class="_ _16"> </span></span>if<span class="_ _16"> </span>and<span class="_ _16"> </span>only<span class="_ _16"> </span>if<span class="_ _11"> </span>multiple<span class="_ _16"> </span>threads<span class="_ _16"> </span>reference<span class="_ _16"> </span>some</div><div class="t m5 x17 h26 y80b2 ff7 fs19 fc1 sc0 ls0 ws0">instance<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>variable<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y80b3 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _16"> </span>keep<span class="_ _16"> </span>our<span class="_ _16"> </span>discussion<span class="_ _16"> </span>of<span class="_ _16"> </span>sharing<span class="_ _11"> </span>concrete,<span class="_ _16"> </span>we<span class="_ _16"> </span>will<span class="_ _11"> </span>use<span class="_ _16"> </span>the<span class="_ _16"> </span>program<span class="_ _16"> </span>in<span class="_ _16"> </span>F<span class="_ _1"></span>ig-</div><div class="t m5 x17 h26 y80b4 ff7 fs19 fc1 sc0 ls0 ws0">ure<span class="_ _11"> </span>12.15<span class="_ _11"> </span>as<span class="_ _11"> </span>a<span class="_ _16"> </span>running<span class="_ _11"> </span>example<span class="_ _1"></span>.<span class="_ _16"> </span>Although<span class="_"> </span>somewhat<span class="_ _16"> </span>contrived,<span class="_ _11"> </span>it<span class="_ _11"> </span>is<span class="_ _11"> </span>nonetheless</div><div class="t m5 x17 h26 y80b5 ff7 fs19 fc1 sc0 ls0 ws0">useful<span class="_"> </span>to<span class="_ _13"> </span>study<span class="_"> </span>because<span class="_"> </span>it<span class="_ _13"> </span>illustrates<span class="_"> </span>a<span class="_"> </span>number<span class="_ _13"> </span>of<span class="_"> </span>subtle<span class="_"> </span>points<span class="_ _13"> </span>about<span class="_"> </span>sharing.<span class="_ _13"> </span>The</div><div class="t m5 x17 h26 y80b6 ff7 fs19 fc1 sc0 ls0 ws0">example<span class="_ _14"> </span>program<span class="_ _14"> </span>consists<span class="_ _15"> </span>of<span class="_ _14"> </span>a<span class="_ _14"> </span>main<span class="_ _14"> </span>thread<span class="_ _15"> </span>that<span class="_ _14"> </span>creates<span class="_ _14"> </span>two<span class="_ _15"> </span>peer<span class="_ _14"> </span>threads<span class="_ _1"></span>.<span class="_ _14"> </span>The</div><div class="t m5 x17 h26 y80b7 ff7 fs19 fc1 sc0 ls0 ws0">main<span class="_ _11"> </span>thread<span class="_ _16"> </span>passes<span class="_ _11"> </span>a<span class="_ _16"> </span>unique<span class="_ _11"> </span>ID<span class="_ _16"> </span>to<span class="_ _11"> </span>each<span class="_ _16"> </span>peer<span class="_ _11"> </span>thread,<span class="_ _16"> </span>which<span class="_ _11"> </span>uses<span class="_ _16"> </span>the<span class="_ _11"> </span>ID<span class="_ _16"> </span>to<span class="_ _11"> </span>print</div><div class="t m5 x17 h26 y80b8 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _11"> </span>personalized<span class="_ _11"> </span>message<span class="_ _11"> </span>along<span class="_ _16"> </span>with<span class="_"> </span>a<span class="_ _16"> </span>count<span class="_"> </span>of<span class="_ _16"> </span>the<span class="_"> </span>total<span class="_ _16"> </span>number<span class="_"> </span>of<span class="_ _16"> </span>times<span class="_"> </span>that<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y80b9 ff7 fs19 fc1 sc0 ls0 ws0">thread<span class="_"> </span>routine<span class="_"> </span>has<span class="_"> </span>been<span class="_"> </span>invoked.</div><div class="t m5 x17 h41 y96 ffe fs29 fc1 sc0 ls0 ws0">12.4.1<span class="_ _48"> </span><span class="fs19">Threads<span class="_"> </span>Memory<span class="_"> </span>Model</span></div><div class="t m5 x17 h26 y27d ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_ _16"> </span>pool<span class="_ _16"> </span>of<span class="_ _14"> </span>concurrent<span class="_ _16"> </span>threads<span class="_ _16"> </span>runs<span class="_ _16"> </span>in<span class="_ _14"> </span>the<span class="_ _16"> </span>context<span class="_ _16"> </span>of<span class="_ _14"> </span>a<span class="_ _16"> </span>process<span class="_ _1"></span>.<span class="_ _16"> </span>Each<span class="_ _14"> </span>thread<span class="_ _16"> </span>has</div><div class="t m5 x17 h26 y27e ff7 fs19 fc1 sc0 ls0 ws0">its<span class="_"> </span>own<span class="_ _11"> </span>separate<span class="_ _11"> </span><span class="ffa">thread<span class="_ _11"> </span>context<span class="_ _2"></span></span>,<span class="_ _11"> </span>which<span class="_ _11"> </span>includes<span class="_ _11"> </span>a<span class="_ _11"> </span>thread<span class="_ _11"> </span>ID<span class="_ _3"></span>,<span class="_ _11"> </span>stack,<span class="_ _11"> </span>stack<span class="_ _11"> </span>pointer,</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
