<div id="pf37d" class="pf w2 h11" data-page-no="37d"><div class="pc pc37d w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg37d.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">892<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x1ce h112 y73c1 ffc9 fsa1 fc1 sc0 ls0 ws0">Prologue</div><div class="t m5 x239 h112 y73c2 ffc9 fsa1 fc1 sc0 ls0 ws0">block</div><div class="t m5 xad h112 y73c1 ffc6 fsa1 fc1 sc0 ls0 ws0">Regular</div><div class="t m5 xc4 h112 y73c2 ffc6 fsa1 fc1 sc0 ls0 ws0">block 1</div><div class="t m5 x117 h112 y73c1 ffc6 fsa1 fc1 sc0 ls0 ws0">Regular</div><div class="t m5 x16c h112 y73c2 ffc6 fsa1 fc1 sc0 ls0 ws0">block 2</div><div class="t m5 x14 h112 y73c3 ffc6 fsa1 fc1 sc0 ls0 ws0">Start</div><div class="t m5 x287 h112 y73c4 ffc6 fsa1 fc1 sc0 ls0 ws0">of</div><div class="t m5 x14 h112 y73c5 ffc6 fsa1 fc1 sc0 ls0 ws0">heap</div><div class="t m5 x2e h112 y73c6 ffc6 fsa1 fc1 sc0 ls0 ws0">8/1<span class="_ _3d"> </span>8/1<span class="_ _25"> </span>hdr<span class="_ _da"> </span>hdr<span class="_ _146"></span>ftr<span class="_ _13b"> </span>ftr</div><div class="t m5 xdf h112 y73c1 ffc6 fsa1 fc1 sc0 ls0 ws0">Regular</div><div class="t m5 x17b h112 y73c2 ffc6 fsa1 fc1 sc0 ls0 ws0">block <span class="ffc8">n</span></div><div class="t m5 x1cf h112 y73c1 ffc9 fsa1 fc1 sc0 ls0 ws0">Epilogue</div><div class="t m5 x158 h112 y73c2 ffc9 fsa1 fc1 sc0 ls0 ws0">block hdr</div><div class="t m5 x120 h112 y73c6 ffc6 fsa1 fc1 sc0 ls0 ws0">hdr<span class="_ _14d"> </span>ftr<span class="_ _1a"> </span>0/1</div><div class="t m5 x55 h113 y73c7 ffc7 fsa2 fc1 sc0 ls0 ws0">static char *heap_listp </div><div class="t m5 x14e h112 y73c8 ffc6 fsa1 fc1 sc0 ls0 ws0">Double-</div><div class="t m5 x149 h112 y73c9 ffc6 fsa1 fc1 sc0 ls0 ws0">word</div><div class="t m5 x223 h112 y73ca ffc6 fsa1 fc1 sc0 ls0 ws0">aligned</div><div class="t m5 x139 h112 y73cb ffc6 fsa1 fc1 sc0 ls0 ws0">. . .</div><div class="t m5 x14 h2f y73cc ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.42<span class="_ _66"> </span><span class="fc1">Invariant<span class="_"> </span>form<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>implicit<span class="_"> </span>free<span class="_"> </span>list.</span></div><div class="t m5 x1d h26 y73cd ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _16"> </span>consists<span class="_ _16"> </span>of<span class="_ _16"> </span>only<span class="_ _11"> </span>a<span class="_ _16"> </span>header.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>prologue<span class="_ _16"> </span>and<span class="_ _16"> </span>epilogue<span class="_ _16"> </span>blocks<span class="_ _16"> </span>are<span class="_ _16"> </span>tricks<span class="_ _16"> </span>that</div><div class="t m5 x1d h26 y73ce ff7 fs19 fc1 sc0 ls0 ws0">eliminate<span class="_ _6"> </span>the<span class="_ _13"> </span>edge<span class="_ _6"> </span>conditions<span class="_ _13"> </span>during<span class="_ _6"> </span>coalescing.<span class="_ _6"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>allocator<span class="_ _6"> </span>uses<span class="_ _13"> </span>a<span class="_ _6"> </span>single<span class="_ _13"> </span>private</div><div class="t m5 x1d h26 y73cf ff7 fs19 fc1 sc0 ls0 ws0">(<span class="ffd">static</span>)<span class="_"> </span>global<span class="_"> </span>variable<span class="_ _11"> </span>(<span class="ffd">heap_listp</span>)<span class="_"> </span>that<span class="_"> </span>always<span class="_ _11"> </span>points<span class="_"> </span>to<span class="_"> </span>the<span class="_ _11"> </span>prologue<span class="_"> </span>block.</div><div class="t m5 x1d h26 y73d0 ff7 fs19 fc1 sc0 ls0 ws0">(As<span class="_"> </span>a<span class="_ _13"> </span>minor<span class="_"> </span>optimization,<span class="_"> </span>we<span class="_ _13"> </span>could<span class="_"> </span>make<span class="_"> </span>it<span class="_ _13"> </span>point<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>next<span class="_"> </span>block<span class="_ _13"> </span>instead<span class="_"> </span>of<span class="_"> </span>the</div><div class="t m5 x1d h26 y73d1 ff7 fs19 fc1 sc0 ls0 ws0">prologue<span class="_"> </span>block.)</div><div class="t m5 x1d h42 y73d2 ff6 fs29 fc6 sc0 ls0 ws0">Basic<span class="_ _11"> </span>Constants<span class="_ _16"> </span>and<span class="_ _16"> </span>Macros<span class="_ _11"> </span>for<span class="_ _16"> </span>Manipulating<span class="_ _16"> </span>the<span class="_ _11"> </span>Free<span class="_ _16"> </span>List</div><div class="t m5 x1d h26 y73d3 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>9.43<span class="_ _16"> </span>shows<span class="_ _11"> </span>some<span class="_ _16"> </span>basic<span class="_ _11"> </span>constants<span class="_ _16"> </span>and<span class="_ _11"> </span>macros<span class="_ _16"> </span>that<span class="_ _11"> </span>we<span class="_ _16"> </span>will<span class="_ _16"> </span>use<span class="_ _11"> </span>throughout</div><div class="t m5 x1d h26 y73d4 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>allocator<span class="_ _11"> </span>code<span class="_ _0"></span>.<span class="_"> </span>Lines<span class="_ _11"> </span>2–4<span class="_ _11"> </span>deﬁne<span class="_ _11"> </span>some<span class="_"> </span>basic<span class="_ _11"> </span>size<span class="_ _11"> </span>constants:<span class="_"> </span>the<span class="_ _11"> </span>sizes<span class="_ _11"> </span>of<span class="_ _11"> </span>words</div><div class="t m5 x1d h26 y73d5 ff7 fs19 fc1 sc0 ls0 ws0">(WSIZE)<span class="_ _16"> </span>and<span class="_ _16"> </span>double<span class="_ _11"> </span>words<span class="_ _16"> </span>(DSIZE),<span class="_ _14"> </span>and<span class="_ _16"> </span>the<span class="_ _16"> </span>size<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>initial<span class="_ _16"> </span>free<span class="_ _16"> </span>block<span class="_ _16"> </span>and</div><div class="t m5 x1d h26 y73d6 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>default<span class="_"> </span>size<span class="_"> </span>for<span class="_"> </span>expanding<span class="_"> </span>the<span class="_"> </span>heap<span class="_"> </span>(CHUNKSIZE).</div><div class="t m5 x29 h26 y73d7 ff7 fs19 fc1 sc0 ls0 ws0">Manipulating<span class="_ _21"> </span>the<span class="_ _21"> </span>headers<span class="_ _21"> </span>and<span class="_ _f"> </span>footers<span class="_ _21"> </span>in<span class="_ _21"> </span>the<span class="_ _f"> </span>free<span class="_ _21"> </span>list<span class="_ _21"> </span>can<span class="_ _f"> </span>be<span class="_ _21"> </span>troublesome</div><div class="t m5 x1d h26 y73d8 ff7 fs19 fc1 sc0 ls0 ws0">because<span class="_"> </span>it<span class="_ _13"> </span>demands<span class="_"> </span>extensive<span class="_"> </span>use<span class="_ _13"> </span>of<span class="_"> </span>casting<span class="_"> </span>and<span class="_ _13"> </span>pointer<span class="_"> </span>arithmetic.<span class="_ _13"> </span>T<span class="_ _0"></span>hus<span class="_ _1"></span>,<span class="_"> </span>we<span class="_ _13"> </span>ﬁnd</div><div class="t m5 x1d h26 y73d9 ff7 fs19 fc1 sc0 ls0 ws0">it<span class="_"> </span>helpful<span class="_ _11"> </span>to<span class="_"> </span>deﬁne<span class="_ _11"> </span>a<span class="_"> </span>small<span class="_ _11"> </span>set<span class="_"> </span>of<span class="_ _11"> </span>macros<span class="_"> </span>for<span class="_ _11"> </span>accessing<span class="_"> </span>and<span class="_ _11"> </span>traversing<span class="_"> </span>the<span class="_ _11"> </span>free<span class="_ _11"> </span>list</div><div class="t m5 x1d h26 y73da ff7 fs19 fc1 sc0 ls0 ws0">(lines<span class="_ _16"> </span>9–25).<span class="_ _14"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span>P<span class="_ _7"></span>A<span class="_ _1"></span>CK<span class="_ _14"> </span>macro<span class="_ _14"> </span>(line<span class="_ _16"> </span>9)<span class="_ _14"> </span>combines<span class="_ _16"> </span>a<span class="_ _14"> </span>size<span class="_ _16"> </span>and<span class="_ _14"> </span>an<span class="_ _16"> </span>allocate<span class="_ _14"> </span>bit<span class="_ _16"> </span>and</div><div class="t m5 x1d h26 y73db ff7 fs19 fc1 sc0 ls0 ws0">returns<span class="_"> </span>a<span class="_"> </span>value<span class="_"> </span>that<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>stored<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>header<span class="_"> </span>or<span class="_"> </span>footer.</div><div class="t m5 x29 h26 y73dc ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _15"> </span>GET<span class="_ _14"> </span>macro<span class="_ _15"> </span>(line<span class="_ _14"> </span>12)<span class="_ _15"> </span>reads<span class="_ _14"> </span>and<span class="_ _15"> </span>returns<span class="_ _14"> </span>the<span class="_ _15"> </span>word<span class="_ _14"> </span>referenced<span class="_ _14"> </span>by<span class="_ _15"> </span>argu-</div><div class="t m5 x1d h26 y73dd ff7 fs19 fc1 sc0 ls0 ws0">ment<span class="_ _13"> </span><span class="ffd">p</span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>casting<span class="_"> </span>here<span class="_ _13"> </span>is<span class="_"> </span>crucial.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_"> </span>argument<span class="_ _13"> </span><span class="ffd">p<span class="_ _13"> </span></span>is<span class="_"> </span>typically<span class="_ _13"> </span>a<span class="_ _13"> </span>(<span class="ffd">void<span class="_ _16"> </span>*</span>)<span class="_"> </span>pointer<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y73de ff7 fs19 fc1 sc0 ls0 ws0">which<span class="_"> </span>cannot<span class="_"> </span>be<span class="_ _11"> </span>dereferenced<span class="_"> </span>directly<span class="_ _3"></span>.<span class="_"> </span>Similarly<span class="_ _3"></span>,<span class="_ _11"> </span>the<span class="_"> </span>PUT<span class="_"> </span>macro<span class="_ _11"> </span>(line<span class="_"> </span>13)<span class="_"> </span>stores</div><div class="t m5 x1d h26 y73df ffd fs19 fc1 sc0 ls0 ws0">val<span class="_ _10"> </span><span class="ff7">in<span class="_"> </span>the<span class="_"> </span>word<span class="_"> </span>pointed<span class="_"> </span>at<span class="_"> </span>by<span class="_"> </span>argument<span class="_"> </span></span>p<span class="ff7">.</span></div><div class="t m5 x29 h26 y73e0 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>GET_SIZE<span class="_"> </span>and<span class="_"> </span>GET_ALLOC<span class="_"> </span>macros<span class="_"> </span>(lines<span class="_ _13"> </span>16–17)<span class="_"> </span>return<span class="_"> </span>the<span class="_"> </span>size<span class="_"> </span>and</div><div class="t m5 x1d h26 y73e1 ff7 fs19 fc1 sc0 ls0 ws0">allocated<span class="_ _16"> </span>bit,<span class="_ _14"> </span>respectively<span class="_ _3"></span>,<span class="_ _14"> </span>from<span class="_ _16"> </span>a<span class="_ _16"> </span>header<span class="_ _14"> </span>or<span class="_ _16"> </span>footer<span class="_ _16"> </span>at<span class="_ _16"> </span>address<span class="_ _14"> </span><span class="ffd">p</span>.<span class="_ _16"> </span>The<span class="_ _11"> </span>remaining</div><div class="t m5 x1d h26 y73e2 ff7 fs19 fc1 sc0 ls0 ws0">macros<span class="_ _15"> </span>operate<span class="_ _21"> </span>on<span class="_ _15"> </span><span class="ffa">block<span class="_ _15"> </span>pointers<span class="_ _21"> </span></span>(denoted<span class="_ _15"> </span><span class="ffd">bp</span>)<span class="_ _21"> </span>that<span class="_ _15"> </span>point<span class="_ _15"> </span>to<span class="_ _21"> </span>the<span class="_ _15"> </span>ﬁrst<span class="_ _21"> </span>payload</div><div class="t m5 x1d h26 y73e3 ff7 fs19 fc1 sc0 ls0 ws0">byte<span class="_ _1"></span>.<span class="_"> </span>Given<span class="_ _13"> </span>a<span class="_"> </span>block<span class="_ _13"> </span>pointer<span class="_ _13"> </span><span class="ffd">bp</span>,<span class="_"> </span>the<span class="_ _13"> </span>HDRP<span class="_ _13"> </span>and<span class="_"> </span>FTRP<span class="_ _13"> </span>macros<span class="_ _13"> </span>(lines<span class="_"> </span>20–21)<span class="_ _13"> </span>return</div><div class="t m5 x1d h26 y73e4 ff7 fs19 fc1 sc0 ls0 ws0">pointers<span class="_ _21"> </span>to<span class="_ _f"> </span>the<span class="_ _f"> </span>block<span class="_ _21"> </span>header<span class="_ _f"> </span>and<span class="_ _f"> </span>footer,<span class="_ _e"> </span>respectively<span class="_ _7"></span>.<span class="_ _21"> </span>The<span class="_ _21"> </span>NEXT_BLKP<span class="_ _21"> </span>and</div><div class="t m5 x1d h26 y73e5 ff7 fs19 fc1 sc0 ls0 ws0">PREV_BLKP<span class="_ _21"> </span>macros<span class="_ _21"> </span>(lines<span class="_ _21"> </span>24–25)<span class="_ _21"> </span>return<span class="_ _21"> </span>the<span class="_ _21"> </span>block<span class="_ _21"> </span>pointers<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>next<span class="_ _21"> </span>and</div><div class="t m5 x1d h26 y73e6 ff7 fs19 fc1 sc0 ls0 ws0">previous<span class="_"> </span>blocks<span class="_ _1"></span>,<span class="_"> </span>respectively<span class="_ _3"></span>.</div><div class="t m5 x29 h26 y73e7 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>macros<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>composed<span class="_"> </span>in<span class="_"> </span>various<span class="_"> </span>ways<span class="_"> </span>to<span class="_"> </span>manipulate<span class="_"> </span>the<span class="_"> </span>free<span class="_"> </span>list.<span class="_"> </span>F<span class="_ _3"></span>or</div><div class="t m5 x1d h26 y73e8 ff7 fs19 fc1 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_ _11"> </span>given<span class="_"> </span>a<span class="_ _11"> </span>pointer<span class="_"> </span><span class="ffd">bp<span class="_ _11"> </span></span>to<span class="_"> </span>the<span class="_ _11"> </span>current<span class="_"> </span>block,<span class="_ _11"> </span>we<span class="_"> </span>could<span class="_"> </span>use<span class="_ _11"> </span>the<span class="_"> </span>following<span class="_ _11"> </span>line</div><div class="t m5 x1d h26 y73e9 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span>code<span class="_"> </span>to<span class="_"> </span>determine<span class="_"> </span>the<span class="_"> </span>size<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>block<span class="_"> </span>in<span class="_"> </span>memory:</div><div class="t m5 x1d h2d y15bf ffd fs1e fc2 sc0 ls0 ws0">size_t<span class="_ _e"> </span>size<span class="_ _1f"> </span>=<span class="_ _1f"> </span>GET_SIZE(HDRP(NEXT_BLKP(bp)));</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
