<div id="pf13e" class="pf w2 h11" data-page-no="13e"><div class="pc pc13e w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg13e.png"/><div class="t m5 xf8 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.10<span class="_ _60"> </span>Combining<span class="_ _10"> </span>Control<span class="_ _10"> </span>and<span class="_ _10"> </span>Data<span class="_ _10"> </span>in<span class="_ _10"> </span>Machine-Level<span class="_ _10"> </span>Programs<span class="_ _3e"> </span><span class="ffe fs1e">317</span></div><div class="t m5 x17 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>3.40</div><div class="t m5 x17 h2f y58a ffe fs16 fc2 sc0 ls0 ws0">Stack<span class="_ _16"> </span>organization<span class="_ _16"> </span>for</div><div class="t m5 x17 h3a y609 ffd fs19 fc2 sc0 ls0 ws0">echo<span class="_ _11"> </span><span class="ffe fs16">function.<span class="_ _11"> </span><span class="ff6">Character</span></span></div><div class="t m5 x17 h34 y60a ff6 fs16 fc2 sc0 ls0 ws0">array</div><div class="t m5 x1a2 h3a y2d53 ffd fs19 fc2 sc0 ls0 ws0">buf<span class="_ _16"> </span><span class="ff6 fs16">is<span class="_ _16"> </span>just<span class="_ _16"> </span>part<span class="_ _16"> </span>of</span></div><div class="t m5 x17 h34 y2d7c ff6 fs16 fc2 sc0 ls0 ws0">the<span class="_ _10"> </span>saved<span class="_ _11"> </span>state.<span class="_ _11"> </span>An<span class="_ _11"> </span>out-of-</div><div class="t m5 x17 h34 y2d7d ff6 fs16 fc2 sc0 ls0 ws0">bounds<span class="_ _11"> </span>write<span class="_ _16"> </span>to</div><div class="t m5 x124 h3a ydc7 ffd fs19 fc2 sc0 ls0 ws0">buf<span class="_ _11"> </span><span class="ff6 fs16">can</span></div><div class="t m5 x17 h34 ydc8 ff6 fs16 fc2 sc0 ls0 ws0">corrupt<span class="_ _10"> </span>the<span class="_ _11"> </span>program<span class="_ _10"> </span>state.</div><div class="t m5 xb3 h3f y2d7e ff30 fs27 fc1 sc0 ls0 ws0">Stack frame</div><div class="t m5 x5d h3f y2d7f ff30 fs27 fc1 sc0 ls0 ws0">for caller</div><div class="t m5 xb3 h3f y2d80 ff30 fs27 fc1 sc0 ls0 ws0">Stack frame</div><div class="t m5 x10e h3f y2d81 ff30 fs27 fc1 sc0 ls0 ws0">for </div><div class="t m5 x115 h40 y2d82 ff31 fs28 fc1 sc0 ls0 ws0">echo</div><div class="t m5 xfd h3f y2d83 ff30 fs27 fc1 sc0 ls0 ws0">Return address</div><div class="t m5 x24b h40 y2d84 ff31 fs28 fc1 sc0 ls170 ws0">%rsp+24</div><div class="t m5 x16e h40 y2d85 ff31 fs28 fc1 sc0 ls170 ws0">[7]</div><div class="t m5 x24b h40 y2d86 ff31 fs28 fc1 sc0 ls0 ws8">buf = %rsp</div><div class="t m5 x1b1 h40 y2d87 ff31 fs28 fc1 sc0 ls170 ws0">[6]<span class="_ _2"></span>[5]<span class="_ _5"></span>[4]<span class="_ _5"></span>[3]<span class="_ _5"></span>[2]<span class="_ _5"></span>[1]<span class="_ _5"></span>[0]</div><div class="t m5 x1b6 h2d y2d88 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>((c<span class="_ _1f"> </span>=<span class="_ _1f"> </span>getchar())<span class="_ _e"> </span>!=<span class="_ _1f"> </span>’\n’<span class="_ _e"> </span>&amp;&amp;<span class="_ _1f"> </span>c<span class="_ _1f"> </span>!=<span class="_ _e"> </span>EOF)</div><div class="t m5 x21e h2d y2d89 ffd fs1e fc2 sc0 ls0 ws0">*dest++<span class="_ _e"> </span>=<span class="_ _1f"> </span>c;</div><div class="t m5 x1b6 h2d y2d8a ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(c<span class="_ _1f"> </span>==<span class="_ _1f"> </span>EOF<span class="_ _e"> </span>&amp;&amp;<span class="_ _1f"> </span>dest<span class="_ _e"> </span>==<span class="_ _1f"> </span>s)</div><div class="t m5 x21e h2d y2d8b ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>No<span class="_ _1f"> </span>characters<span class="_ _1f"> </span>read<span class="_ _e"> </span>*/</div><div class="t m5 x21e h2d y2d8c ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>NULL;</div><div class="t m5 x1b6 h2d y2d8d ffd fs1e fc2 sc0 ls0 ws0">*dest++<span class="_ _e"> </span>=<span class="_ _1f"> </span>’\0’;<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Terminate<span class="_ _1f"> </span>string<span class="_ _e"> </span>*/</div><div class="t m5 x1b6 h2d y2d8e ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>s;</div><div class="t m5 x17 h2d y2d8f ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h2d y2d90 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Read<span class="_ _1f"> </span>input<span class="_ _1f"> </span>line<span class="_ _e"> </span>and<span class="_ _1f"> </span>write<span class="_ _e"> </span>it<span class="_ _1f"> </span>back<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y2d91 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>echo()</div><div class="t m5 x17 h2d y2d92 ffd fs1e fc2 sc0 ls0 ws0">{</div><div class="t m5 x1b6 h2d y2d93 ffd fs1e fc2 sc0 ls0 ws0">char<span class="_ _e"> </span>buf[8];<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Way<span class="_ _1f"> </span>too<span class="_ _e"> </span>small!<span class="_ _1f"> </span>*/</div><div class="t m5 x1b6 h2d y2d94 ffd fs1e fc2 sc0 ls0 ws0">gets(buf);</div><div class="t m5 x1b6 h2d y2d95 ffd fs1e fc2 sc0 ls0 ws0">puts(buf);</div><div class="t m5 x17 h2d y2d96 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x26 h26 y2d97 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _15"> </span>preceding<span class="_ _14"> </span>code<span class="_ _14"> </span>shows<span class="_ _14"> </span>an<span class="_ _15"> </span>implementation<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _15"> </span>library<span class="_ _14"> </span>function<span class="_ _14"> </span><span class="ffd">gets</span></div><div class="t m5 x17 h26 y2d98 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _21"> </span>demonstrate<span class="_ _21"> </span>a<span class="_ _21"> </span>serious<span class="_ _21"> </span>problem<span class="_ _f"> </span>with<span class="_ _21"> </span>this<span class="_ _21"> </span>function.<span class="_ _21"> </span>It<span class="_ _21"> </span>reads<span class="_ _f"> </span>a<span class="_ _21"> </span>line<span class="_ _21"> </span>from<span class="_ _21"> </span>the</div><div class="t m5 x17 h26 y2d99 ff7 fs19 fc2 sc0 ls0 ws0">standard<span class="_ _14"> </span>input,<span class="_ _21"> </span>stopping<span class="_ _15"> </span>when<span class="_ _14"> </span>either<span class="_ _15"> </span>a<span class="_ _14"> </span>terminating<span class="_ _15"> </span>newline<span class="_ _15"> </span>character<span class="_ _14"> </span>or<span class="_ _15"> </span>some</div><div class="t m5 x17 h26 y2d9a ff7 fs19 fc2 sc0 ls0 ws0">error<span class="_"> </span>condition<span class="_ _11"> </span>is<span class="_"> </span>encountered.<span class="_ _11"> </span>It<span class="_"> </span>copies<span class="_ _11"> </span>this<span class="_"> </span>string<span class="_"> </span>to<span class="_ _11"> </span>the<span class="_"> </span>location<span class="_ _11"> </span>designated<span class="_"> </span>by</div><div class="t m5 x17 h26 y2d9b ff7 fs19 fc2 sc0 ls0 ws0">argument<span class="_ _16"> </span><span class="ffd">s<span class="_ _16"> </span></span>and<span class="_ _11"> </span>terminates<span class="_ _16"> </span>the<span class="_ _16"> </span>string<span class="_ _16"> </span>with<span class="_ _16"> </span>a<span class="_ _16"> </span>null<span class="_ _16"> </span>character.<span class="_ _11"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>show<span class="_ _16"> </span>the<span class="_ _16"> </span>use<span class="_ _16"> </span>of</div><div class="t m5 x17 h26 y2d9c ffd fs19 fc2 sc0 ls0 ws0">gets<span class="_ _6"> </span><span class="ff7">in<span class="_ _13"> </span>the<span class="_ _6"> </span>function<span class="_ _13"> </span></span>echo<span class="ff7">,<span class="_ _13"> </span>which<span class="_ _6"> </span>simply<span class="_ _13"> </span>reads<span class="_ _6"> </span>a<span class="_ _13"> </span>line<span class="_ _6"> </span>from<span class="_ _6"> </span>standard<span class="_ _13"> </span>input<span class="_ _6"> </span>and<span class="_ _13"> </span>echos</span></div><div class="t m5 x17 h26 y2d9d ff7 fs19 fc2 sc0 ls0 ws0">it<span class="_"> </span>back<span class="_"> </span>to<span class="_"> </span>standard<span class="_"> </span>output.</div><div class="t m5 x26 h26 y2d9e ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>problem<span class="_ _11"> </span>with<span class="_ _11"> </span><span class="ffd">gets<span class="_ _11"> </span></span>is<span class="_ _11"> </span>that<span class="_"> </span>it<span class="_ _11"> </span>has<span class="_ _11"> </span>no<span class="_ _11"> </span>way<span class="_ _11"> </span>to<span class="_ _11"> </span>determine<span class="_ _11"> </span>whether<span class="_ _11"> </span>sufﬁcient</div><div class="t m5 x17 h26 y2d9f ff7 fs19 fc2 sc0 ls0 ws0">space<span class="_"> </span>has<span class="_ _11"> </span>been<span class="_"> </span>allocated<span class="_ _11"> </span>to<span class="_ _11"> </span>hold<span class="_"> </span>the<span class="_ _11"> </span>entire<span class="_ _11"> </span>string.<span class="_"> </span>In<span class="_"> </span>our<span class="_ _11"> </span><span class="ffd">echo<span class="_ _11"> </span></span>example<span class="_ _0"></span>,<span class="_"> </span>we<span class="_ _11"> </span>have</div><div class="t m5 x17 h26 y2da0 ff7 fs19 fc2 sc0 ls0 ws0">purposely<span class="_ _f"> </span>made<span class="_ _f"> </span>the<span class="_ _f"> </span>buffer<span class="_ _f"> </span>very<span class="_ _f"> </span>small—just<span class="_ _f"> </span>eight<span class="_ _f"> </span>characters<span class="_ _f"> </span>long.<span class="_ _f"> </span>Any<span class="_ _f"> </span>string</div><div class="t m5 x17 h26 y2da1 ff7 fs19 fc2 sc0 ls0 ws0">longer<span class="_"> </span>than<span class="_"> </span>seven<span class="_"> </span>characters<span class="_"> </span>will<span class="_"> </span>cause<span class="_"> </span>an<span class="_"> </span>out-of-bounds<span class="_"> </span>write<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y2da2 ff7 fs19 fc2 sc0 ls0 ws0">By<span class="_ _13"> </span>examining<span class="_ _13"> </span>the<span class="_ _13"> </span>assembly<span class="_"> </span>code<span class="_ _13"> </span>generated<span class="_ _13"> </span>by<span class="_ _13"> </span><span class="ff9">gcc<span class="_ _13"> </span></span>for<span class="_ _13"> </span><span class="ffd">echo</span>,<span class="_"> </span>we<span class="_ _13"> </span>can<span class="_ _13"> </span>infer<span class="_ _13"> </span>how</div><div class="t m5 x17 h26 y2da3 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>stack<span class="_"> </span>is<span class="_"> </span>organized:</div><div class="t m5 x2e h61 y2768 ff13 fs35 fc6 sc0 ls0 ws0">void<span class="_ _f"> </span>echo()</div><div class="t m5 x2c h2d y1c0f ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">echo:</span></div><div class="t m5 x2c h2e ye14 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 xd1 h2d yd76 ffd fs1e fc2 sc0 ls0 ws0">subq<span class="_ _46"> </span>$24,<span class="_ _e"> </span>%rsp<span class="_ _5d"> </span><span class="ff13 fs35 fc6">Allocate<span class="_ _f"> </span>24<span class="_ _e"> </span>bytes<span class="_ _21"> </span>on<span class="_ _f"> </span>stack</span></div><div class="t m5 x2c h2d yeef ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rsp,<span class="_ _e"> </span>%rdi<span class="_ _2a"> </span></span><span class="ff13 fs35">Compute<span class="_ _f"> </span>buf<span class="_ _f"> </span>as<span class="_ _e"> </span>%rsp</span></div><div class="t m5 x2c h2d yd7a ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">call<span class="_ _46"> </span>gets<span class="_ _17c"> </span></span><span class="ff13 fs35">Call<span class="_ _f"> </span>gets</span></div><div class="t m5 x2c h2d y2da4 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rsp,<span class="_ _e"> </span>%rdi<span class="_ _2a"> </span></span><span class="ff13 fs35">Compute<span class="_ _f"> </span>buf<span class="_ _f"> </span>as<span class="_ _e"> </span>%rsp</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
