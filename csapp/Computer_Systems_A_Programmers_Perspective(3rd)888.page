<div id="pf378" class="pf w2 h11" data-page-no="378"><div class="pc pc378 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg378.png"/><div class="t m5 x1c9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.9<span class="_ _60"> </span>Dynamic<span class="_ _10"> </span>Memor<span class="_"> </span>y<span class="_ _10"> </span>Allocation<span class="_ _3e"> </span><span class="ffe fs1e">887</span></div><div class="t m5 x253 h110 y72c4 ffc6 fsa0 fc1 sc0 ls0 ws0">Unused</div><div class="t m5 x17 h110 y72c5 ffc6 fsa0 fc1 sc0 ls0 ws0">Start</div><div class="t m5 x52 h110 y72c6 ffc6 fsa0 fc1 sc0 ls0 ws0">of</div><div class="t m5 x17 h110 y72c7 ffc6 fsa0 fc1 sc0 ls0 ws0">heap</div><div class="t m5 x26f h110 y72c8 ffc6 fsa0 fc1 sc0 ls0 ws0">8/0<span class="_ _74"> </span>16/1<span class="_ _1b1"> </span>16/0<span class="_ _224"> </span>16/1<span class="_ _225"></span>16/0<span class="_ _17a"> </span>0/1</div><div class="t m5 x105 h110 y730b ffc6 fsa0 fc1 sc0 ls0 ws0">Double-</div><div class="t m5 x271 h110 y730c ffc6 fsa0 fc1 sc0 ls0 ws0">word</div><div class="t m5 x285 h110 y730d ffc6 fsa0 fc1 sc0 ls0 ws0">aligned</div><div class="t m5 x17 h34 y72cc ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _11"> </span>9.38<span class="_ _c"> </span><span class="fc1">An<span class="_ _11"> </span>example<span class="_ _16"> </span>of<span class="_ _11"> </span>false<span class="_ _11"> </span>fragmentation.<span class="_ _16"> </span><span class="ff6">Allocated<span class="_ _11"> </span>blocks<span class="_ _11"> </span>are<span class="_ _16"> </span>shaded.<span class="_ _11"> </span>Free<span class="_ _16"> </span>blocks<span class="_ _11"> </span>are<span class="_ _11"> </span>unshaded.</span></span></div><div class="t m5 x17 h34 y72cd ff6 fs16 fc1 sc0 ls0 ws0">Headers<span class="_ _10"> </span>are<span class="_ _11"> </span>labeled<span class="_ _10"> </span>with<span class="_ _10"> </span>(size<span class="_ _11"> </span>(bytes)/allocated<span class="_ _10"> </span>bit).</div><div class="t m5 x26 h26 y731e ff7 fs19 fc1 sc0 ls0 ws0">Immediate<span class="_ _14"> </span>coalescing<span class="_ _14"> </span>is<span class="_ _14"> </span>straightforward<span class="_ _14"> </span>and<span class="_ _15"> </span>can<span class="_ _14"> </span>be<span class="_ _14"> </span>performed<span class="_ _14"> </span>in<span class="_ _14"> </span>constant</div><div class="t m5 x17 h26 y731f ff7 fs19 fc1 sc0 ls0 ws0">time<span class="_ _1"></span>,<span class="_"> </span>but<span class="_"> </span>with<span class="_ _13"> </span>some<span class="_"> </span>request<span class="_"> </span>patterns<span class="_ _13"> </span>it<span class="_"> </span>can<span class="_"> </span>introduce<span class="_ _13"> </span>a<span class="_"> </span>form<span class="_"> </span>of<span class="_ _13"> </span>thrashing<span class="_"> </span>where<span class="_ _13"> </span>a</div><div class="t m5 x17 h26 y7320 ff7 fs19 fc1 sc0 ls0 ws0">block<span class="_"> </span>is<span class="_"> </span>repeatedly<span class="_"> </span>coalesced<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>split<span class="_ _11"> </span>soon<span class="_"> </span>thereafter.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_ _11"> </span>example<span class="_ _1"></span>,<span class="_ _11"> </span>in<span class="_"> </span>F<span class="_ _0"></span>ig-</div><div class="t m5 x17 h26 y7321 ff7 fs19 fc1 sc0 ls0 ws0">ure<span class="_ _16"> </span>9.38,<span class="_ _16"> </span>a<span class="_ _16"> </span>repeated<span class="_ _11"> </span>pattern<span class="_ _16"> </span>of<span class="_ _16"> </span>allocating<span class="_ _16"> </span>and<span class="_ _11"> </span>freeing<span class="_ _16"> </span>a<span class="_ _16"> </span>three-word<span class="_ _16"> </span>block<span class="_ _11"> </span>would</div><div class="t m5 x17 h26 y7322 ff7 fs19 fc1 sc0 ls0 ws0">introduce<span class="_ _11"> </span>a<span class="_ _11"> </span>lot<span class="_ _11"> </span>of<span class="_ _11"> </span>unnecessary<span class="_ _11"> </span>splitting<span class="_ _11"> </span>and<span class="_ _11"> </span>coalescing.<span class="_"> </span>In<span class="_ _11"> </span>our<span class="_ _11"> </span>discussion<span class="_ _16"> </span>of<span class="_"> </span>allo-</div><div class="t m5 x17 h26 y7323 ff7 fs19 fc1 sc0 ls0 ws0">cators<span class="_ _1"></span>,<span class="_ _16"> </span>we<span class="_ _14"> </span>will<span class="_ _16"> </span>assume<span class="_ _16"> </span>immediate<span class="_ _16"> </span>coalescing,<span class="_ _16"> </span>but<span class="_ _16"> </span>you<span class="_ _16"> </span>should<span class="_ _14"> </span>be<span class="_ _16"> </span>aware<span class="_ _16"> </span>that<span class="_ _16"> </span>fast</div><div class="t m5 x17 h26 y7324 ff7 fs19 fc1 sc0 ls0 ws0">allocators<span class="_"> </span>often<span class="_"> </span>opt<span class="_"> </span>for<span class="_"> </span>some<span class="_"> </span>form<span class="_"> </span>of<span class="_"> </span>deferred<span class="_"> </span>coalescing.</div><div class="t m5 x17 h41 y7325 ffe fs29 fc1 sc0 ls0 ws0">9.9.11<span class="_ _48"> </span><span class="fs19">Coalescing<span class="_"> </span>with<span class="_"> </span>Boundary<span class="_"> </span>T<span class="_ _1"></span>ags</span></div><div class="t m5 x17 h26 y7326 ff7 fs19 fc1 sc0 ls0 ws0">How<span class="_ _11"> </span>does<span class="_ _11"> </span>an<span class="_ _11"> </span>allocator<span class="_ _11"> </span>implement<span class="_ _11"> </span>coalescing?<span class="_ _11"> </span>Let<span class="_ _11"> </span>us<span class="_ _11"> </span>refer<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_"> </span>block<span class="_ _11"> </span>we<span class="_ _11"> </span>want</div><div class="t m5 x17 h26 y7327 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _16"> </span>free<span class="_ _11"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffa">current<span class="_ _11"> </span>block<span class="_ _2"></span></span>.<span class="_ _11"> </span>Then<span class="_ _11"> </span>coalescing<span class="_ _16"> </span>the<span class="_ _11"> </span>next<span class="_ _16"> </span>free<span class="_ _16"> </span>block<span class="_ _11"> </span>(in<span class="_ _16"> </span>memory)<span class="_ _16"> </span>is</div><div class="t m5 x17 h26 y7328 ff7 fs19 fc1 sc0 ls0 ws0">straightforward<span class="_ _13"> </span>and<span class="_ _6"> </span>efÔ¨Åcient.<span class="_ _13"> </span>T<span class="_ _0"></span>he<span class="_ _13"> </span>header<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>current<span class="_ _13"> </span>block<span class="_ _6"> </span>points<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>header</div><div class="t m5 x17 h26 y7329 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_ _11"> </span>next<span class="_ _11"> </span>block,<span class="_ _11"> </span>which<span class="_ _11"> </span>can<span class="_ _11"> </span>be<span class="_ _11"> </span>checked<span class="_ _11"> </span>to<span class="_ _11"> </span>determine<span class="_ _11"> </span>if<span class="_ _11"> </span>the<span class="_ _11"> </span>next<span class="_ _11"> </span>block<span class="_ _11"> </span>is<span class="_"> </span>free.<span class="_"> </span>If</div><div class="t m5 x17 h26 y732a ff7 fs19 fc1 sc0 ls0 ws0">so<span class="_ _1"></span>,<span class="_ _15"> </span>its<span class="_ _16"> </span>size<span class="_ _14"> </span>is<span class="_ _14"> </span>simply<span class="_ _16"> </span>added<span class="_ _14"> </span>to<span class="_ _16"> </span>the<span class="_ _14"> </span>size<span class="_ _14"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>current<span class="_ _14"> </span>header<span class="_ _16"> </span>and<span class="_ _14"> </span>the<span class="_ _16"> </span>blocks<span class="_ _14"> </span>are</div><div class="t m5 x17 h26 y732b ff7 fs19 fc1 sc0 ls0 ws0">coalesced<span class="_"> </span>in<span class="_"> </span>constant<span class="_"> </span>time<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y732c ff7 fs19 fc1 sc0 ls0 ws0">But<span class="_"> </span>how<span class="_"> </span>would<span class="_"> </span>we<span class="_ _13"> </span>coalesce<span class="_"> </span>the<span class="_"> </span>previous<span class="_"> </span>block?<span class="_"> </span>Given<span class="_"> </span>an<span class="_"> </span>implicit<span class="_ _13"> </span>free<span class="_"> </span>list<span class="_"> </span>of</div><div class="t m5 x17 h26 y732d ff7 fs19 fc1 sc0 ls0 ws0">blocks<span class="_ _13"> </span>with<span class="_"> </span>headers<span class="_ _3"></span>,<span class="_"> </span>the<span class="_ _13"> </span>only<span class="_ _13"> </span>option<span class="_ _13"> </span>would<span class="_"> </span>be<span class="_ _13"> </span>to<span class="_ _13"> </span>search<span class="_"> </span>the<span class="_ _13"> </span>entire<span class="_ _13"> </span>list,<span class="_"> </span>remember<span class="_ _3"></span>-</div><div class="t m5 x17 h26 y732e ff7 fs19 fc1 sc0 ls0 ws0">ing<span class="_ _13"> </span>the<span class="_ _13"> </span>location<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>previous<span class="_ _13"> </span>block,<span class="_ _13"> </span>until<span class="_ _13"> </span>we<span class="_ _13"> </span>reached<span class="_ _13"> </span>the<span class="_ _13"> </span>current<span class="_ _13"> </span>block.<span class="_ _13"> </span>With<span class="_ _13"> </span>an</div><div class="t m5 x17 h26 y732f ff7 fs19 fc1 sc0 ls0 ws0">implicit<span class="_ _13"> </span>free<span class="_"> </span>list,<span class="_ _13"> </span>this<span class="_ _13"> </span>means<span class="_"> </span>that<span class="_ _13"> </span>each<span class="_ _13"> </span>call<span class="_ _13"> </span>to<span class="_"> </span><span class="ffd">free<span class="_ _13"> </span></span>would<span class="_ _13"> </span>require<span class="_"> </span>time<span class="_ _13"> </span>linear<span class="_ _13"> </span>in<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y7330 ff7 fs19 fc1 sc0 ls0 ws0">size<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>heap.<span class="_"> </span>Even<span class="_"> </span>with<span class="_ _11"> </span>more<span class="_ _11"> </span>sophisticated<span class="_ _11"> </span>free<span class="_ _11"> </span>list<span class="_ _11"> </span>organizations<span class="_ _1"></span>,<span class="_ _11"> </span>the<span class="_ _11"> </span>search</div><div class="t m5 x17 h26 y7331 ff7 fs19 fc1 sc0 ls0 ws0">time<span class="_"> </span>would<span class="_"> </span>not<span class="_"> </span>be<span class="_"> </span>constant.</div><div class="t m5 x26 h26 y7332 ff7 fs19 fc1 sc0 ls0 ws0">Knuth<span class="_ _16"> </span>developed<span class="_ _14"> </span>a<span class="_ _14"> </span>clever<span class="_ _16"> </span>and<span class="_ _14"> </span>general<span class="_ _16"> </span>technique,<span class="_ _14"> </span>known<span class="_ _16"> </span>as<span class="_ _14"> </span><span class="ffa">boundary<span class="_ _16"> </span>tags</span>,</div><div class="t m5 x17 h26 y7333 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_"> </span>allows<span class="_"> </span>for<span class="_"> </span>constant-time<span class="_"> </span>coalescing<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>previous<span class="_"> </span>block.<span class="_"> </span>The<span class="_"> </span>idea,<span class="_"> </span>which<span class="_"> </span>is</div><div class="t m5 x17 h26 y7334 ff7 fs19 fc1 sc0 ls0 ws0">shown<span class="_ _13"> </span>in<span class="_ _6"> </span>F<span class="_ _0"></span>igure<span class="_ _13"> </span>9.39,<span class="_ _13"> </span>is<span class="_ _6"> </span>to<span class="_ _13"> </span>add<span class="_ _6"> </span>a<span class="_ _13"> </span><span class="ffa">footer<span class="_ _13"> </span></span>(the<span class="_ _13"> </span>boundary<span class="_ _13"> </span>tag)<span class="_ _6"> </span>at<span class="_ _13"> </span>the<span class="_ _13"> </span>end<span class="_ _6"> </span>of<span class="_ _13"> </span>each<span class="_ _6"> </span>block,</div><div class="t m5 x17 h26 y7335 ff7 fs19 fc1 sc0 ls0 ws0">where<span class="_ _11"> </span>the<span class="_ _16"> </span>footer<span class="_ _11"> </span>is<span class="_ _16"> </span>a<span class="_ _11"> </span>replica<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>header.<span class="_ _11"> </span>If<span class="_ _11"> </span>each<span class="_ _16"> </span>block<span class="_ _11"> </span>includes<span class="_ _16"> </span>such<span class="_ _11"> </span>a<span class="_ _16"> </span>footer,</div><div class="t m5 x17 h26 y7336 ff7 fs19 fc1 sc0 ls0 ws0">then<span class="_ _11"> </span>the<span class="_ _11"> </span>allocator<span class="_ _11"> </span>can<span class="_ _16"> </span>determine<span class="_ _11"> </span>the<span class="_ _11"> </span>starting<span class="_ _11"> </span>location<span class="_ _11"> </span>and<span class="_ _16"> </span>status<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>previous</div><div class="t m5 x17 h26 y7337 ff7 fs19 fc1 sc0 ls0 ws0">block<span class="_ _13"> </span>by<span class="_ _13"> </span>inspecting<span class="_"> </span>its<span class="_ _13"> </span>footer,<span class="_ _13"> </span>which<span class="_ _13"> </span>is<span class="_ _13"> </span>always<span class="_"> </span>one<span class="_ _13"> </span>word<span class="_ _13"> </span>away<span class="_ _13"> </span>from<span class="_ _13"> </span>the<span class="_"> </span>start<span class="_ _13"> </span>of<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y7338 ff7 fs19 fc1 sc0 ls0 ws0">current<span class="_"> </span>block.</div><div class="t m5 x26 h26 y7339 ff7 fs19 fc1 sc0 ls0 ws0">Consider<span class="_ _13"> </span>all<span class="_ _6"> </span>the<span class="_ _13"> </span>cases<span class="_ _6"> </span>that<span class="_ _13"> </span>can<span class="_ _6"> </span>exist<span class="_ _13"> </span>when<span class="_ _6"> </span>the<span class="_ _13"> </span>allocator<span class="_ _6"> </span>frees<span class="_ _13"> </span>the<span class="_ _6"> </span>current<span class="_ _13"> </span>block:</div><div class="t m5 x1cd h26 y733a ffc fs19 fc1 sc0 ls0 ws0">1.<span class="_ _e"> </span><span class="ff7">The<span class="_"> </span>previous<span class="_"> </span>and<span class="_"> </span>next<span class="_"> </span>blocks<span class="_"> </span>are<span class="_"> </span>both<span class="_"> </span>allocated.</span></div><div class="t m5 x1cd h26 y733b ffc fs19 fc1 sc0 ls0 ws0">2.<span class="_ _e"> </span><span class="ff7">The<span class="_"> </span>previous<span class="_"> </span>block<span class="_"> </span>is<span class="_"> </span>allocated<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>block<span class="_"> </span>is<span class="_"> </span>free<span class="_ _1"></span>.</span></div><div class="t m5 x1cd h26 y733c ffc fs19 fc1 sc0 ls0 ws0">3.<span class="_ _e"> </span><span class="ff7">The<span class="_"> </span>previous<span class="_"> </span>block<span class="_"> </span>is<span class="_"> </span>free<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>block<span class="_"> </span>is<span class="_"> </span>allocated.</span></div><div class="t m5 x1cd h26 y733d ffc fs19 fc1 sc0 ls0 ws0">4.<span class="_ _e"> </span><span class="ff7">The<span class="_"> </span>previous<span class="_"> </span>and<span class="_"> </span>next<span class="_"> </span>blocks<span class="_"> </span>are<span class="_"> </span>both<span class="_"> </span>free<span class="_ _1"></span>.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
