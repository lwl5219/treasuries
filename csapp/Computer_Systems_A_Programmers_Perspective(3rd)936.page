<div id="pf3a8" class="pf w2 h11" data-page-no="3a8"><div class="pc pc3a8 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3a8.png"/><div class="t m5 x16c h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>10.5<span class="_ _60"> </span>Robust<span class="_ _10"> </span>Reading<span class="_ _10"> </span>and<span class="_ _10"> </span>Writing<span class="_ _10"> </span>with<span class="_ _10"> </span>the<span class="_ _10"> </span><span class="ff1b">Rio<span class="_ _10"> </span></span>Package<span class="_ _1b"> </span><span class="ffe fs1e">935</span></div><div class="t m5 x61 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">ssize_t<span class="_ _1f"> </span>rio_readn(int<span class="_ _e"> </span>fd,<span class="_ _1f"> </span>void<span class="_ _1f"> </span>*usrbuf,<span class="_ _e"> </span>size_t<span class="_ _1f"> </span>n)</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">size_t<span class="_ _e"> </span>nleft<span class="_ _1f"> </span>=<span class="_ _1f"> </span>n;</span></div><div class="t m5 x2c h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">ssize_t<span class="_ _e"> </span>nread;</span></div><div class="t m5 x2c h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*bufp<span class="_ _1f"> </span>=<span class="_ _1f"> </span>usrbuf;</span></div><div class="t m5 x2c h2e y286 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2c h2e y6298 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x142 h2d y287 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(nleft<span class="_ _1f"> </span>&gt;<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{</div><div class="t m5 x2c h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((nread<span class="_ _1f"> </span>=<span class="_ _1f"> </span>read(fd,<span class="_ _e"> </span>bufp,<span class="_ _1f"> </span>nleft))<span class="_ _e"> </span>&lt;<span class="_ _1f"> </span>0)<span class="_ _1f"> </span>{</span></div><div class="t m5 x2c h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _d1"> </span><span class="ffd fs1e fc2">if<span class="_ _1f"> </span>(errno<span class="_ _e"> </span>==<span class="_ _1f"> </span>EINTR)<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Interrupted<span class="_ _1f"> </span>by<span class="_ _e"> </span>sig<span class="_ _1f"> </span>handler<span class="_ _e"> </span>return<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _143"> </span><span class="ffd fs1e fc2">nread<span class="_ _e"> </span>=<span class="_ _1f"> </span>0;<span class="_ _5a"> </span>/*<span class="_ _1f"> </span>and<span class="_ _e"> </span>call<span class="_ _1f"> </span>read()<span class="_ _1f"> </span>again<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _d1"> </span><span class="ffd fs1e fc2">else</span></div><div class="t m5 x17 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _143"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>-1;<span class="_ _b9"> </span>/*<span class="_ _e"> </span>errno<span class="_ _1f"> </span>set<span class="_ _e"> </span>by<span class="_ _1f"> </span>read()<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">else<span class="_ _e"> </span>if<span class="_ _1f"> </span>(nread<span class="_ _1f"> </span>==<span class="_ _e"> </span>0)</span></div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _d1"> </span><span class="ffd fs1e fc2">break;<span class="_ _16f"> </span>/*<span class="_ _e"> </span>EOF<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _70"> </span><span class="ffd fs1e fc2">nleft<span class="_ _e"> </span>-=<span class="_ _1f"> </span>nread;</span></div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _70"> </span><span class="ffd fs1e fc2">bufp<span class="_ _e"> </span>+=<span class="_ _1f"> </span>nread;</span></div><div class="t m5 x17 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>(n<span class="_ _1f"> </span>-<span class="_ _1f"> </span>nleft);<span class="_ _82"> </span>/*<span class="_ _1f"> </span>Return<span class="_ _e"> </span>&gt;=<span class="_ _1f"> </span>0<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x61 h2c y77db ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x61 h2c y77dc ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y26ba ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">ssize_t<span class="_ _1f"> </span>rio_writen(int<span class="_ _e"> </span>fd,<span class="_ _1f"> </span>void<span class="_ _1f"> </span>*usrbuf,<span class="_ _e"> </span>size_t<span class="_ _1f"> </span>n)</span></div><div class="t m5 x2c h2d y47f6 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y530f ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">size_t<span class="_ _e"> </span>nleft<span class="_ _1f"> </span>=<span class="_ _1f"> </span>n;</span></div><div class="t m5 x2c h2d y77dd ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">ssize_t<span class="_ _e"> </span>nwritten;</span></div><div class="t m5 x2c h2d y2c5b ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*bufp<span class="_ _1f"> </span>=<span class="_ _1f"> </span>usrbuf;</span></div><div class="t m5 x2c h2e y2a53 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2c h2e y77de ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x142 h2d y29a8 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(nleft<span class="_ _1f"> </span>&gt;<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{</div><div class="t m5 x2c h2d y646e ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((nwritten<span class="_ _1f"> </span>=<span class="_ _1f"> </span>write(fd,<span class="_ _e"> </span>bufp,<span class="_ _1f"> </span>nleft))<span class="_ _e"> </span>&lt;=<span class="_ _1f"> </span>0)<span class="_ _1f"> </span>{</span></div><div class="t m5 x2c h2d y42a7 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _d1"> </span><span class="ffd fs1e fc2">if<span class="_ _1f"> </span>(errno<span class="_ _e"> </span>==<span class="_ _1f"> </span>EINTR)<span class="_ _1a"> </span>/*<span class="_ _e"> </span>Interrupted<span class="_ _1f"> </span>by<span class="_ _1f"> </span>sig<span class="_ _e"> </span>handler<span class="_ _1f"> </span>return<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y3eb4 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _143"> </span><span class="ffd fs1e fc2">nwritten<span class="_ _e"> </span>=<span class="_ _1f"> </span>0;<span class="_ _46"> </span>/*<span class="_ _1f"> </span>and<span class="_ _e"> </span>call<span class="_ _1f"> </span>write()<span class="_ _e"> </span>again<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y4490 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _d1"> </span><span class="ffd fs1e fc2">else</span></div><div class="t m5 x17 h2d y29ac ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _143"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>-1;<span class="_ _6f"> </span>/*<span class="_ _1f"> </span>errno<span class="_ _1f"> </span>set<span class="_ _e"> </span>by<span class="_ _1f"> </span>write()<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y3478 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y3de7 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">nleft<span class="_ _e"> </span>-=<span class="_ _1f"> </span>nwritten;</span></div><div class="t m5 x17 h2d y5982 ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _70"> </span><span class="ffd fs1e fc2">bufp<span class="_ _e"> </span>+=<span class="_ _1f"> </span>nwritten;</span></div><div class="t m5 x17 h2d y4c74 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y464c ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>n;</span></div><div class="t m5 x17 h2e y1864 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x2d h2d y2fb5 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x61 h2c y77df ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y77e0 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>10.4<span class="_ _66"> </span><span class="fc1">The</span></div><div class="t m5 x289 h3a yb1e ffd fs19 fc1 sc0 ls0 ws0">rio_readn<span class="_ _10"> </span><span class="ffe fs16">and<span class="_"> </span></span>rio_writen<span class="_ _11"> </span><span class="ffe fs16">functions.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
