<div id="pf317" class="pf w2 h11" data-page-no="317"><div class="pc pc317 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg317.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">790<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 x4e h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/ecf/shellex.c</div><div class="t m5 x1f h2e y280 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x4f h2d yad1 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</div><div class="t m5 x1f h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#define<span class="_ _1f"> </span>MAXARGS<span class="_ _3f"> </span>128</span></div><div class="t m5 x1f h2e yad2 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x1f h2e y6777 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x4f h2d yad3 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Function<span class="_ _1f"> </span>prototypes<span class="_ _1f"> </span>*/</div><div class="t m5 x1f h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>eval(char<span class="_ _e"> </span>*cmdline);</span></div><div class="t m5 x1f h2d yad4 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>parseline(char<span class="_ _e"> </span>*buf,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>**argv);</span></div><div class="t m5 x1f h2d yad5 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>builtin_command(char<span class="_ _e"> </span>**argv);</span></div><div class="t m5 x1f h2e yad6 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x1f h2e y61b5 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x4f h2d y496b ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x1b0 h2d y50d4 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1b0 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>cmdline[MAXLINE];<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>Command<span class="_ _e"> </span>line<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1b0 h2e y61b6 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x1b0 h2e y6778 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x33 h2d y2181 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(1)<span class="_ _1f"> </span>{</div><div class="t m5 x1b0 h2d y554b ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Read<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1b0 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _70"> </span><span class="ffd fs1e fc2">printf(&quot;&gt;<span class="_ _e"> </span>&quot;);</span></div><div class="t m5 x1b0 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _70"> </span><span class="ffd fs1e fc2">Fgets(cmdline,<span class="_ _e"> </span>MAXLINE,<span class="_ _1f"> </span>stdin);</span></div><div class="t m5 x1b0 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(feof(stdin))</span></div><div class="t m5 x1b0 h2d y3ec ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _d1"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x1b0 h2e y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19</div><div class="t m5 x1b0 h2e y6779 ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 xf7 h2d y1ab8 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Evaluate<span class="_ _1f"> </span>*/</div><div class="t m5 x1b0 h2d y1ada ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _70"> </span><span class="ffd fs1e fc2">eval(cmdline);</span></div><div class="t m5 x1b0 h2d y61b9 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x4e h2c y677a ffa fs16 fc2 sc0 ls0 ws0">code/ecf/shellex.c</div><div class="t m5 x1d h2f y677b ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>8.23<span class="_ _66"> </span><span class="fc1">The<span class="_"> </span>main<span class="_"> </span>routine<span class="_"> </span>for<span class="_"> </span>a<span class="_"> </span>simple<span class="_"> </span>shell<span class="_"> </span>program.</span></div><div class="t m5 x29 h26 y7fe ff7 fs19 fc1 sc0 ls0 ws0">After<span class="_ _6"> </span>parsing<span class="_ _13"> </span>the<span class="_ _6"> </span>command<span class="_ _6"> </span>line,<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">eval<span class="_ _6"> </span></span>function<span class="_ _6"> </span>calls<span class="_ _13"> </span>the<span class="_ _6"> </span><span class="ffd">builtin_command</span></div><div class="t m5 x1d h26 y7ff ff7 fs19 fc1 sc0 ls0 ws0">function,<span class="_ _13"> </span>which<span class="_ _13"> </span>checks<span class="_ _13"> </span>whether<span class="_ _13"> </span>the<span class="_ _13"> </span>ﬁrst<span class="_ _13"> </span>command-line<span class="_ _13"> </span>argument<span class="_ _6"> </span>is<span class="_ _13"> </span>a<span class="_ _13"> </span>built-in<span class="_ _13"> </span>shell</div><div class="t m5 x1d h26 y800 ff7 fs19 fc1 sc0 ls0 ws0">command.<span class="_ _13"> </span>If<span class="_ _13"> </span>so,<span class="_ _13"> </span>it<span class="_ _13"> </span>interprets<span class="_ _13"> </span>the<span class="_"> </span>command<span class="_ _13"> </span>immediately<span class="_ _13"> </span>and<span class="_ _13"> </span>returns<span class="_ _13"> </span>1.<span class="_"> </span>Otherwise<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y801 ff7 fs19 fc1 sc0 ls0 ws0">it<span class="_"> </span>returns<span class="_"> </span>0.<span class="_ _11"> </span>Our<span class="_"> </span>simple<span class="_"> </span>shell<span class="_ _11"> </span>has<span class="_"> </span>just<span class="_ _11"> </span>one<span class="_"> </span>built-in<span class="_"> </span>command,<span class="_ _11"> </span>the<span class="_"> </span><span class="ffd">quit<span class="_ _11"> </span></span>command,</div><div class="t m5 x1d h26 y802 ff7 fs19 fc1 sc0 ls0 ws0">which<span class="_ _16"> </span>terminates<span class="_ _14"> </span>the<span class="_ _16"> </span>shell.<span class="_ _14"> </span>Real<span class="_ _16"> </span>shells<span class="_ _16"> </span>have<span class="_ _14"> </span>numerous<span class="_ _16"> </span>commands<span class="_ _1"></span>,<span class="_ _15"> </span>such<span class="_ _16"> </span>as<span class="_ _16"> </span><span class="ffd">pwd</span>,</div><div class="t m5 x1d h26 y803 ffd fs19 fc1 sc0 ls0 ws0">jobs<span class="ff7">,<span class="_"> </span>and<span class="_"> </span></span>fg<span class="ff7">.</span></div><div class="t m5 x29 h26 y804 ff7 fs19 fc1 sc0 ls0 ws0">If<span class="_ _21"> </span><span class="ffd">builtin_command<span class="_ _f"> </span></span>returns<span class="_ _f"> </span>0,<span class="_ _e"> </span>then<span class="_ _f"> </span>the<span class="_ _f"> </span>shell<span class="_ _f"> </span>creates<span class="_ _f"> </span>a<span class="_ _f"> </span>child<span class="_ _f"> </span>process<span class="_ _f"> </span>and</div><div class="t m5 x1d h26 y805 ff7 fs19 fc1 sc0 ls0 ws0">executes<span class="_ _15"> </span>the<span class="_ _14"> </span>requested<span class="_ _15"> </span>program<span class="_ _15"> </span>inside<span class="_ _15"> </span>the<span class="_ _15"> </span>child.<span class="_ _15"> </span>If<span class="_ _15"> </span>the<span class="_ _15"> </span>user<span class="_ _14"> </span>has<span class="_ _15"> </span>asked<span class="_ _15"> </span>for<span class="_ _15"> </span>the</div><div class="t m5 x1d h26 y806 ff7 fs19 fc1 sc0 ls0 ws0">program<span class="_ _13"> </span>to<span class="_ _13"> </span>run<span class="_ _6"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>background,<span class="_ _13"> </span>then<span class="_ _13"> </span>the<span class="_ _6"> </span>shell<span class="_ _13"> </span>returns<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>top<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>loop<span class="_ _13"> </span>and</div><div class="t m5 x1d h26 y807 ff7 fs19 fc1 sc0 ls0 ws0">waits<span class="_ _11"> </span>for<span class="_ _16"> </span>the<span class="_ _11"> </span>next<span class="_ _16"> </span>command<span class="_ _11"> </span>line<span class="_ _0"></span>.<span class="_ _11"> </span>Otherwise<span class="_ _16"> </span>the<span class="_ _11"> </span>shell<span class="_ _16"> </span>uses<span class="_ _11"> </span>the<span class="_ _11"> </span><span class="ffd">waitpid<span class="_ _16"> </span></span>function</div><div class="t m5 x1d h26 y808 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>wait<span class="_ _13"> </span>for<span class="_"> </span>the<span class="_"> </span>job<span class="_"> </span>to<span class="_ _13"> </span>terminate.<span class="_ _13"> </span>When<span class="_"> </span>the<span class="_"> </span>job<span class="_ _13"> </span>terminates<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>shell<span class="_"> </span>goes<span class="_ _13"> </span>on<span class="_"> </span>to<span class="_"> </span>the</div><div class="t m5 x1d h26 y809 ff7 fs19 fc1 sc0 ls0 ws0">next<span class="_"> </span>iteration.</div><div class="t m5 x29 h26 y80a ff7 fs19 fc1 sc0 ls0 ws0">Notice<span class="_ _21"> </span>that<span class="_ _21"> </span>this<span class="_ _21"> </span>simple<span class="_ _21"> </span>shell<span class="_ _21"> </span>is<span class="_ _21"> </span>ﬂawed<span class="_ _21"> </span>because<span class="_ _21"> </span>it<span class="_ _21"> </span>does<span class="_ _21"> </span>not<span class="_ _21"> </span>reap<span class="_ _21"> </span>any<span class="_ _21"> </span>of<span class="_ _21"> </span>its</div><div class="t m5 x1d h26 y80b ff7 fs19 fc1 sc0 ls0 ws0">background<span class="_ _16"> </span>children.<span class="_ _14"> </span>Correcting<span class="_ _16"> </span>this<span class="_ _14"> </span>ﬂaw<span class="_ _14"> </span>requires<span class="_ _16"> </span>the<span class="_ _14"> </span>use<span class="_ _16"> </span>of<span class="_ _14"> </span>signals<span class="_ _1"></span>,<span class="_ _14"> </span>which<span class="_ _14"> </span>we</div><div class="t m5 x1d h26 y80c ff7 fs19 fc1 sc0 ls0 ws0">describe<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>section.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
