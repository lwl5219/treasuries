<div id="pf3fc" class="pf w2 h11" data-page-no="3fc"><div class="pc pc3fc w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3fc.png"/><div class="t m5 x125 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.2<span class="_ _60"> </span>Concurrent<span class="_ _10"> </span>Programming<span class="_ _10"> </span>with<span class="_ _10"> </span>I/O<span class="_ _10"> </span>Multiplexing<span class="_ _3e"> </span><span class="ffe fs1e">1019</span></div><div class="t m5 x12e h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoservers<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>init_pool(int<span class="_ _e"> </span>listenfd,<span class="_ _1f"> </span>pool<span class="_ _1f"> </span>*p)</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Initially,<span class="_ _1f"> </span>there<span class="_ _1f"> </span>are<span class="_ _e"> </span>no<span class="_ _1f"> </span>connected<span class="_ _e"> </span>descriptors<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i;</span></div><div class="t m5 x2c h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">p-&gt;maxi<span class="_ _e"> </span>=<span class="_ _1f"> </span>-1;</span></div><div class="t m5 x2c h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i=0;<span class="_ _1f"> </span>i&lt;<span class="_ _1f"> </span>FD_SETSIZE;<span class="_ _e"> </span>i++)</span></div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _70"> </span><span class="ffd fs1e fc2">p-&gt;clientfd[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>-1;</span></div><div class="t m5 x2c h2e y4493 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x2c h2e y66b4 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x142 h2d y4a9a ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Initially,<span class="_ _1f"> </span>listenfd<span class="_ _1f"> </span>is<span class="_ _e"> </span>only<span class="_ _1f"> </span>member<span class="_ _e"> </span>of<span class="_ _1f"> </span>select<span class="_ _1f"> </span>read<span class="_ _e"> </span>set<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">p-&gt;maxfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>listenfd;</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">FD_ZERO(&amp;p-&gt;read_set);</span></div><div class="t m5 x17 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">FD_SET(listenfd,<span class="_ _e"> </span>&amp;p-&gt;read_set);</span></div><div class="t m5 x17 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x12e h2c y5fd2 ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoservers<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y5fd3 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.9</div><div class="t m5 x156 h3a yeaf ffd fs19 fc1 sc0 ls0 ws0">init_pool<span class="_ _10"> </span><span class="ffe fs16">initializes<span class="_"> </span>the<span class="_"> </span>pool<span class="_"> </span>of<span class="_"> </span>active<span class="_"> </span>clients.</span></div><div class="t m5 x12e h2c y7fc1 ffa fs16 fc1 sc0 ls0 ws0">code/conc/echoservers<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y7fc2 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>add_client(int<span class="_ _e"> </span>connfd,<span class="_ _1f"> </span>pool<span class="_ _1f"> </span>*p)</span></div><div class="t m5 x2c h2d y7fc3 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y7fc4 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i;</span></div><div class="t m5 x2c h2d y7fc5 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">p-&gt;nready--;</span></div><div class="t m5 x2c h2d y7fc6 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>FD_SETSIZE;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Find<span class="_ _1f"> </span>an<span class="_ _e"> </span>available<span class="_ _1f"> </span>slot<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y7fc7 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(p-&gt;clientfd[i]<span class="_ _1f"> </span>&lt;<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{</span></div><div class="t m5 x2c h2e y7fc8 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x162 h2d y7fc9 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Add<span class="_ _1f"> </span>connected<span class="_ _1f"> </span>descriptor<span class="_ _e"> </span>to<span class="_ _1f"> </span>the<span class="_ _e"> </span>pool<span class="_ _1f"> </span>*/</div><div class="t m5 x2c h2e y7832 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x162 h2d y7833 ffd fs1e fc2 sc0 ls0 ws0">p-&gt;clientfd[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>connfd;</div><div class="t m5 x2c h2d y7fca ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _d1"> </span><span class="ffd fs1e fc2">Rio_readinitb(&amp;p-&gt;clientrio[i],<span class="_ _1f"> </span>connfd);</span></div><div class="t m5 x17 h2e y7fcb ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x17 h2e y7fcc ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x162 h2d y7fcd ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Add<span class="_ _1f"> </span>the<span class="_ _1f"> </span>descriptor<span class="_ _e"> </span>to<span class="_ _1f"> </span>descriptor<span class="_ _e"> </span>set<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y7fce ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _d1"> </span><span class="ffd fs1e fc2">FD_SET(connfd,<span class="_ _1f"> </span>&amp;p-&gt;read_set);</span></div><div class="t m5 x17 h2e y7fcf ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x17 h2e y7fd0 ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x162 h2d y7fd1 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Update<span class="_ _1f"> </span>max<span class="_ _1f"> </span>descriptor<span class="_ _e"> </span>and<span class="_ _1f"> </span>pool<span class="_ _e"> </span>high<span class="_ _1f"> </span>water<span class="_ _1f"> </span>mark<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y7fd2 ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _d1"> </span><span class="ffd fs1e fc2">if<span class="_ _1f"> </span>(connfd<span class="_ _e"> </span>&gt;<span class="_ _1f"> </span>p-&gt;maxfd)</span></div><div class="t m5 x17 h2d y1e87 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _143"> </span><span class="ffd fs1e fc2">p-&gt;maxfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>connfd;</span></div><div class="t m5 x17 h2e y7fd3 ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x162 h2d y7fd4 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(i<span class="_ _1f"> </span>&gt;<span class="_ _1f"> </span>p-&gt;maxi)</div><div class="t m5 x17 h2d y3097 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _143"> </span><span class="ffd fs1e fc2">p-&gt;maxi<span class="_ _e"> </span>=<span class="_ _1f"> </span>i;</span></div><div class="t m5 x17 h2d y7841 ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _d1"> </span><span class="ffd fs1e fc2">break;</span></div><div class="t m5 x17 h2e y7fd5 ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 xc5 h2d y7fd6 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h2d y7fd7 ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(i<span class="_ _1f"> </span>==<span class="_ _1f"> </span>FD_SETSIZE)<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Couldnâ€™t<span class="_ _e"> </span>find<span class="_ _1f"> </span>an<span class="_ _1f"> </span>empty<span class="_ _e"> </span>slot<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y7fd8 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _70"> </span><span class="ffd fs1e fc2">app_error(&quot;add_client<span class="_ _e"> </span>error:<span class="_ _1f"> </span>Too<span class="_ _1f"> </span>many<span class="_ _e"> </span>clients&quot;);</span></div><div class="t m5 x17 h2d y7fd9 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x12e h2c y7fda ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoservers<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y7fdb ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.10</div><div class="t m5 x155 h3a y7fdc ffd fs19 fc1 sc0 ls0 ws0">add_client<span class="_ _10"> </span><span class="ffe fs16">adds<span class="_"> </span>a<span class="_"> </span>new<span class="_"> </span>client<span class="_"> </span>connection<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>pool.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
