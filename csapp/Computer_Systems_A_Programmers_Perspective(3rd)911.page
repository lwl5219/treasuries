<div id="pf38f" class="pf w2 h11" data-page-no="38f"><div class="pc pc38f w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg38f.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">910<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x1d h41 ye7 ffe fs29 fc2 sc0 ls0 ws0">9.11.8<span class="_ _48"> </span><span class="fs19">Referencing<span class="_"> </span>Nonexistent<span class="_"> </span>V<span class="_ _1"></span>ariables</span></div><div class="t m5 x1d h26 ybbe ff7 fs19 fc2 sc0 ls0 ws0">Naive<span class="_"> </span>C<span class="_ _13"> </span>programmers<span class="_"> </span>who<span class="_ _13"> </span>do<span class="_"> </span>not<span class="_ _13"> </span>understand<span class="_"> </span>the<span class="_"> </span>stack<span class="_ _13"> </span>discipline<span class="_"> </span>will<span class="_ _13"> </span>sometimes</div><div class="t m5 x1d h26 ybbf ff7 fs19 fc2 sc0 ls0 ws0">reference<span class="_"> </span>local<span class="_"> </span>variables<span class="_"> </span>that<span class="_"> </span>are<span class="_"> </span>no<span class="_"> </span>longer<span class="_"> </span>valid,<span class="_"> </span>as<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>example:</div><div class="t m5 x1f h2d y759b ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>*stackref<span class="_ _e"> </span>()</span></div><div class="t m5 x1f h2d y759c ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y759d ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>val;</span></div><div class="t m5 x1f h2e y759e ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x1f h2e y759f ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x33 h2d y75a0 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>&amp;val;</div><div class="t m5 x1f h2d y75a1 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x29 h26 y75a2 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _14"> </span>function<span class="_ _16"> </span>returns<span class="_ _14"> </span>a<span class="_ _16"> </span>pointer<span class="_ _14"> </span>(say<span class="_ _3"></span>,<span class="_ _14"> </span><span class="ffd">p</span>)<span class="_ _16"> </span>to<span class="_ _16"> </span>a<span class="_ _14"> </span>local<span class="_ _16"> </span>variable<span class="_ _14"> </span>on<span class="_ _16"> </span>the<span class="_ _14"> </span>stack<span class="_ _16"> </span>and</div><div class="t m5 x1d h26 y75a3 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_ _16"> </span>pops<span class="_ _14"> </span>its<span class="_ _16"> </span>stack<span class="_ _14"> </span>frame.<span class="_ _16"> </span>Although<span class="_ _16"> </span><span class="ffd">p<span class="_ _14"> </span></span>still<span class="_ _16"> </span>points<span class="_ _14"> </span>to<span class="_ _14"> </span>a<span class="_ _16"> </span>valid<span class="_ _14"> </span>memory<span class="_ _16"> </span>address<span class="_ _1"></span>,<span class="_ _15"> </span>it</div><div class="t m5 x1d h26 y75a4 ff7 fs19 fc2 sc0 ls0 ws0">no<span class="_ _11"> </span>longer<span class="_ _11"> </span>points<span class="_ _11"> </span>to<span class="_ _11"> </span>a<span class="_ _11"> </span>valid<span class="_ _16"> </span>variable<span class="_ _1"></span>.<span class="_ _11"> </span>When<span class="_ _11"> </span>other<span class="_ _11"> </span>functions<span class="_ _11"> </span>are<span class="_ _11"> </span>called<span class="_ _11"> </span>later<span class="_ _11"> </span>in<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y75a5 ff7 fs19 fc2 sc0 ls0 ws0">program,<span class="_"> </span>the<span class="_"> </span>memory<span class="_"> </span>will<span class="_"> </span>be<span class="_"> </span>reused<span class="_"> </span>for<span class="_"> </span>their<span class="_"> </span>stack<span class="_ _11"> </span>frames<span class="_ _1"></span>.<span class="_"> </span>Later,<span class="_"> </span>if<span class="_"> </span>the<span class="_"> </span>program</div><div class="t m5 x1d h26 y75a6 ff7 fs19 fc2 sc0 ls0 ws0">assigns<span class="_"> </span>some<span class="_"> </span>value<span class="_"> </span>to<span class="_"> </span><span class="ffd">*p</span>,<span class="_"> </span>then<span class="_"> </span>it<span class="_"> </span>might<span class="_ _11"> </span>actually<span class="_"> </span>be<span class="_"> </span>modifying<span class="_"> </span>an<span class="_"> </span>entry<span class="_"> </span>in<span class="_"> </span>another</div><div class="t m5 x1d h26 y75a7 ff7 fs19 fc2 sc0 ls0 ws0">function’s<span class="_"> </span>stack<span class="_"> </span>frame<span class="_ _1"></span>,<span class="_"> </span>with<span class="_"> </span>potentially<span class="_"> </span>disastrous<span class="_"> </span>and<span class="_"> </span>bafﬂing<span class="_"> </span>consequences<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y75a8 ffe fs29 fc2 sc0 ls0 ws0">9.11.9<span class="_ _48"> </span><span class="fs19">Referencing<span class="_"> </span>Data<span class="_"> </span>in<span class="_"> </span>Free<span class="_"> </span>Heap<span class="_"> </span>Blocks</span></div><div class="t m5 x1d h26 y75a9 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _11"> </span>similar<span class="_ _11"> </span>error<span class="_ _11"> </span>is<span class="_ _11"> </span>to<span class="_ _11"> </span>reference<span class="_ _11"> </span>data<span class="_ _11"> </span>in<span class="_ _11"> </span>heap<span class="_ _11"> </span>blocks<span class="_ _11"> </span>that<span class="_ _11"> </span>have<span class="_ _11"> </span>already<span class="_ _11"> </span>been<span class="_ _11"> </span>freed.</div><div class="t m5 x1d h26 y75aa ff7 fs19 fc2 sc0 ls0 ws0">Consider<span class="_ _21"> </span>the<span class="_ _f"> </span>following<span class="_ _f"> </span>example<span class="_ _0"></span>,<span class="_ _e"> </span>which<span class="_ _21"> </span>allocates<span class="_ _f"> </span>an<span class="_ _f"> </span>integer<span class="_ _21"> </span>array<span class="_ _f"> </span><span class="ffd">x<span class="_ _f"> </span></span>in<span class="_ _f"> </span>line<span class="_ _f"> </span>6,</div><div class="t m5 x1d h26 y75ab ff7 fs19 fc2 sc0 ls0 ws0">prematurely<span class="_"> </span>frees<span class="_"> </span>block<span class="_"> </span><span class="ffd">x<span class="_ _10"> </span></span>in<span class="_"> </span>line<span class="_"> </span>10,<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>later<span class="_"> </span>references<span class="_"> </span>it<span class="_"> </span>in<span class="_"> </span>line<span class="_"> </span>14:</div><div class="t m5 x1f h2d y75ac ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>*heapref(int<span class="_ _e"> </span>n,<span class="_ _1f"> </span>int<span class="_ _1f"> </span>m)</span></div><div class="t m5 x1f h2d y75ad ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y75ae ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i;</span></div><div class="t m5 x1f h2d y75af ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>*x,<span class="_ _1f"> </span>*y;</span></div><div class="t m5 x1f h2e y75b0 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x1f h2e y75b1 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x33 h2d y75b2 ffd fs1e fc2 sc0 ls0 ws0">x<span class="_ _e"> </span>=<span class="_ _1f"> </span>(int<span class="_ _1f"> </span>*)Malloc(n<span class="_ _e"> </span>*<span class="_ _1f"> </span>sizeof(int));</div><div class="t m5 x1f h2e y75b3 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x1f h2e y75b4 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x33 h2d y75b5 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x33 h2d y75b6 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x33 h2d y75b7 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 xc1 h53 y75b8 ffa fs1e fc2 sc0 ls0 ws0">//<span class="_"> </span>Other<span class="_"> </span>calls<span class="_"> </span>to<span class="_"> </span>malloc<span class="_"> </span>and<span class="_"> </span>free<span class="_"> </span>go<span class="_"> </span>here</div><div class="t m5 x1f h2e y75b9 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1b0 h2e y75ba ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x33 h2d y75bb ffd fs1e fc2 sc0 ls0 ws0">free(x);</div><div class="t m5 x1b0 h2e y75bc ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x1b0 h2e y75bd ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x33 h2d y75be ffd fs1e fc2 sc0 ls0 ws0">y<span class="_ _e"> </span>=<span class="_ _1f"> </span>(int<span class="_ _1f"> </span>*)Malloc(m<span class="_ _e"> </span>*<span class="_ _1f"> </span>sizeof(int));</div><div class="t m5 x1b0 h2d y75bf ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2 ls33">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;m<span class="_ _41"></span>;<span class="ls0">i++)</span></span></div><div class="t m5 x1b0 h2e y75c0 ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 xf7 h2d y75c1 ffd fs1e fc2 sc0 ls0 ws0">y[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>x[i]++;<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Oops!<span class="_ _1f"> </span>x[i]<span class="_ _e"> </span>is<span class="_ _1f"> </span>a<span class="_ _1f"> </span>word<span class="_ _e"> </span>in<span class="_ _1f"> </span>a<span class="_ _e"> </span>free<span class="_ _1f"> </span>block<span class="_ _1f"> </span>*/</div><div class="t m5 x1b0 h2e y75c2 ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x1b0 h2e y75c3 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x33 h2d y75c4 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>y;</div><div class="t m5 x1b0 h2d y75c5 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x29 h26 y7a6 ff7 fs19 fc2 sc0 ls0 ws0">Depending<span class="_ _13"> </span>on<span class="_ _13"> </span>the<span class="_ _13"> </span>pattern<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ffd">malloc<span class="_ _13"> </span></span>and<span class="_ _13"> </span><span class="ffd">free<span class="_ _13"> </span></span>calls<span class="_ _13"> </span>that<span class="_ _13"> </span>occur<span class="_ _13"> </span>between<span class="_ _13"> </span>lines<span class="_ _13"> </span>6</div><div class="t m5 x1d h26 y7a7 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>10,<span class="_"> </span>when<span class="_ _13"> </span>the<span class="_"> </span>program<span class="_"> </span>references<span class="_ _13"> </span><span class="ffd">x[i]<span class="_ _10"> </span></span>in<span class="_"> </span>line<span class="_"> </span>14,<span class="_ _13"> </span>the<span class="_"> </span>array<span class="_"> </span><span class="ffd">x<span class="_ _10"> </span></span>might<span class="_ _13"> </span>be<span class="_"> </span>part<span class="_"> </span>of</div><div class="t m5 x1d h26 y7a8 ff7 fs19 fc2 sc0 ls0 ws0">some<span class="_ _11"> </span>other<span class="_ _11"> </span>allocated<span class="_ _11"> </span>heap<span class="_"> </span>block<span class="_ _11"> </span>and<span class="_ _11"> </span>may<span class="_ _11"> </span>have<span class="_ _11"> </span>been<span class="_ _11"> </span>overwritten.<span class="_ _11"> </span>As<span class="_ _11"> </span>with<span class="_ _11"> </span>many</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
