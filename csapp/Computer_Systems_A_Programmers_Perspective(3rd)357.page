<div id="pf165" class="pf w2 h11" data-page-no="165"><div class="pc pc165 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg165.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">356<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1b0 h2d y9c ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>72(%rsp),<span class="_ _e"> </span>%rax</span></div><div class="t m5 x1b0 h2d y2825 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>64(%rsp),<span class="_ _e"> </span>%rax</span></div><div class="t m5 x1b0 h2d y2826 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>80(%rsp),<span class="_ _e"> </span>%rax</span></div><div class="t m5 x1b0 h2e yecc ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x10d h2d y249b ffd fs1e fc2 sc0 ls0 ws0">addq<span class="_ _46"> </span>$104,<span class="_ _e"> </span>%rsp</div><div class="t m5 x1b0 h2d yecd ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _45"> </span><span class="ffd fs1e fc2">ret</span></div><div class="t m5 x124 h26 y322f ff7 fs19 fc2 sc0 ls0 ws0">A.<span class="_ _1f"> </span>W<span class="_ _3"></span>e<span class="_ _13"> </span>can<span class="_"> </span>see<span class="_ _13"> </span>on<span class="_ _13"> </span>line<span class="_ _13"> </span>2<span class="_"> </span>of<span class="_ _13"> </span>function<span class="_ _13"> </span><span class="ffd">eval<span class="_ _13"> </span></span>that<span class="_"> </span>it<span class="_ _13"> </span>allocates<span class="_ _13"> </span>104<span class="_ _13"> </span>bytes<span class="_"> </span>on<span class="_ _13"> </span>the<span class="_ _13"> </span>stack.</div><div class="t m5 x4f h26 y3230 ff7 fs19 fc2 sc0 ls0 ws0">Diagram<span class="_ _11"> </span>the<span class="_ _11"> </span>stack<span class="_ _16"> </span>frame<span class="_"> </span>for<span class="_ _16"> </span><span class="ffd">eval</span>,<span class="_ _11"> </span>showing<span class="_ _11"> </span>the<span class="_ _16"> </span>values<span class="_"> </span>that<span class="_ _16"> </span>it<span class="_ _11"> </span>stores<span class="_ _11"> </span>on<span class="_ _11"> </span>the</div><div class="t m5 x4f h26 y3231 ff7 fs19 fc2 sc0 ls0 ws0">stack<span class="_"> </span>prior<span class="_"> </span>to<span class="_"> </span>calling<span class="_"> </span><span class="ffd">process</span>.</div><div class="t m5 x124 h26 y3232 ff7 fs19 fc2 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>What<span class="_"> </span>value<span class="_"> </span>does<span class="_"> </span><span class="ffd">eval<span class="_ _10"> </span></span>pass<span class="_"> </span>in<span class="_"> </span>its<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">process</span>?</div><div class="t m5 x124 h26 y3233 ff7 fs19 fc2 sc0 ls0 ws0">C.<span class="_ _25"> </span>How<span class="_ _6"> </span>does<span class="_ _6"> </span>the<span class="_ _6"> </span>code<span class="_ _6"> </span>for<span class="_ _6"> </span><span class="ffd">process<span class="_ _6"> </span></span>access<span class="_ _6"> </span>the<span class="_ _6"> </span>elements<span class="_ _6"> </span>of<span class="_ _6"> </span>structure<span class="_ _6"> </span>argument<span class="_ _6"> </span><span class="ffd">s</span>?</div><div class="t m5 x124 h26 y3234 ff7 fs19 fc2 sc0 ls0 ws0">D<span class="_ _3"></span>.<span class="_ _23"> </span>How<span class="_"> </span>does<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span><span class="ffd">process<span class="_ _10"> </span></span>set<span class="_"> </span>the<span class="_"> </span>ﬁelds<span class="_"> </span>of<span class="_"> </span>result<span class="_"> </span>structure<span class="_"> </span><span class="ffd">r</span>?</div><div class="t m5 x124 h26 y3235 ff7 fs19 fc2 sc0 ls0 ws0">E.<span class="_ _25"> </span>Complete<span class="_ _15"> </span>your<span class="_ _21"> </span>diagram<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>stack<span class="_ _15"> </span>frame<span class="_ _21"> </span>for<span class="_ _21"> </span><span class="ffd">eval</span>,<span class="_ _f"> </span>showing<span class="_ _21"> </span>how<span class="_ _21"> </span><span class="ffd">eval</span></div><div class="t m5 x4f h26 y3236 ff7 fs19 fc2 sc0 ls0 ws0">accesses<span class="_"> </span>the<span class="_"> </span>elements<span class="_"> </span>of<span class="_"> </span>structure<span class="_"> </span><span class="ffd">r<span class="_ _10"> </span></span>following<span class="_"> </span>the<span class="_"> </span>return<span class="_"> </span>from<span class="_"> </span><span class="ffd">process</span>.</div><div class="t m5 x124 h26 y3237 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _7"></span>.<span class="_ _3d"> </span>W<span class="_ _0"></span>hat<span class="_ _15"> </span>general<span class="_ _f"> </span>principles<span class="_ _21"> </span>can<span class="_ _21"> </span>you<span class="_ _21"> </span>discern<span class="_ _21"> </span>about<span class="_ _21"> </span>how<span class="_ _21"> </span>structure<span class="_ _21"> </span>values<span class="_ _21"> </span>are</div><div class="t m5 x4f h26 y3238 ff7 fs19 fc2 sc0 ls0 ws0">passed<span class="_ _13"> </span>as<span class="_ _13"> </span>function<span class="_ _13"> </span>arguments<span class="_ _6"> </span>and<span class="_ _13"> </span>how<span class="_ _13"> </span>they<span class="_ _13"> </span>are<span class="_ _13"> </span>returned<span class="_ _13"> </span>as<span class="_ _6"> </span>function<span class="_ _13"> </span>results?</div><div class="t m5 x1d h73 y418 ffe fs1e fc6 sc0 ls0 ws0">3.68<span class="_ _23"> </span><span class="ff10 fs19">◆◆◆</span></div><div class="t m5 x1d h26 y419 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>code<span class="_ _1"></span>,<span class="_"> </span><span class="ff11">A<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ff11">B<span class="_"> </span></span>are<span class="_"> </span>constants<span class="_"> </span>deﬁned<span class="_"> </span>with<span class="_"> </span><span class="ffd">#define</span>:</div><div class="t m5 x1f h2d y3239 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">typedef<span class="_ _1f"> </span>struct<span class="_ _e"> </span>{</span></div><div class="t m5 x1f h2d y323a ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>x[A][B];<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>Unknown<span class="_ _e"> </span>constants<span class="_ _1f"> </span>A<span class="_ _e"> </span>and<span class="_ _1f"> </span>B<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1f h2d y323b ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>y;</span></div><div class="t m5 x1f h2d y323c ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">}<span class="_ _1f"> </span>str1;</span></div><div class="t m5 x1f h2e y2968 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x1f h2e y323d ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x4f h2d y323e ffd fs1e fc2 sc0 ls0 ws0">typedef<span class="_ _e"> </span>struct<span class="_ _1f"> </span>{</div><div class="t m5 x1f h2d y323f ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>array[B];</span></div><div class="t m5 x1f h2d y3240 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>t;</span></div><div class="t m5 x1f h2d y30bb ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">short<span class="_ _e"> </span>s[A];</span></div><div class="t m5 x1b0 h2d y3241 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>u;</span></div><div class="t m5 x1b0 h2d y1abf ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _1c"> </span><span class="ffd fs1e fc2">}<span class="_ _1f"> </span>str2;</span></div><div class="t m5 x1b0 h2e y3242 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x1b0 h2e y3243 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x4f h2d y1ac1 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>setVal(str1<span class="_ _1f"> </span>*p,<span class="_ _1f"> </span>str2<span class="_ _e"> </span>*q)<span class="_ _1f"> </span>{</div><div class="t m5 x1b0 h2d y1ac3 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>v1<span class="_ _1f"> </span>=<span class="_ _1f"> </span>q-&gt;t;</span></div><div class="t m5 x1b0 h2d y93b ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>v2<span class="_ _1f"> </span>=<span class="_ _1f"> </span>q-&gt;u;</span></div><div class="t m5 x1b0 h2d y3244 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">p-&gt;y<span class="_ _e"> </span>=<span class="_ _1f"> </span>v1+v2;</span></div><div class="t m5 x1b0 h2d y1ac5 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1d h26 y2269 ff9 fs19 fc2 sc0 ls0 ws0">Gcc<span class="_ _10"> </span><span class="ff7">generates<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span><span class="ffd">setVal</span>:</span></div><div class="t m5 xad h61 y24e1 ff13 fs35 fc6 sc0 ls0 ws0">void<span class="_ _f"> </span>setVal(str1<span class="_ _f"> </span>*p,<span class="_ _f"> </span>str2<span class="_ _e"> </span>*q)</div><div class="t m5 xad h61 y3245 ff13 fs35 fc6 sc0 ls0 ws0">p<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>q<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi</div><div class="t m5 x1f h2d ye14 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">setVal:</span></div><div class="t m5 x1f h2d yeef ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">movslq<span class="_ _1a"> </span>8(%rsi),<span class="_ _e"> </span>%rax</span></div><div class="t m5 x1f h2d yd7a ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>32(%rsi),<span class="_ _e"> </span>%rax</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
