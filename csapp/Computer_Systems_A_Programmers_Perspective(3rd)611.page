<div id="pf263" class="pf w2 h11" data-page-no="263"><div class="pc pc263 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg263.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">610<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1d h31 y9c ff7 fs21 fc2 sc0 ls0 ws0">Code<span class="_ _26"> </span><span class="ffd fs1e">min<span class="_ _26"> </span>max<span class="_ _26"> </span>incr<span class="_ _26"> </span>square</span></div><div class="t m5 xcf h31 y9ba ff7 fs21 fc2 sc0 ls0 ws0">A.<span class="_ _2c"> </span>1<span class="_ _93"> </span>91<span class="_ _78"> </span>90<span class="_ _63"> </span>90</div><div class="t m5 x10b h31 y43ee ff7 fs21 fc2 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _2e"> </span>91<span class="_ _62"> </span>1<span class="_ _78"> </span>90<span class="_ _18c"> </span>90</div><div class="t m5 x10b h31 y43ef ff7 fs21 fc2 sc0 ls0 ws0">C.<span class="_ _57"> </span>1<span class="_ _62"> </span>1<span class="_ _78"> </span>90<span class="_ _18c"> </span>90</div><div class="t m5 x1d h28 y51b4 ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>5.4<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>552)</span></div><div class="t m5 x1d h26 y51b5 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _16"> </span>assembly<span class="_"> </span>code<span class="_ _16"> </span>demonstrates<span class="_"> </span>a<span class="_ _16"> </span>clever<span class="_ _11"> </span>optimization<span class="_ _11"> </span>opportunity<span class="_ _11"> </span>detected<span class="_ _11"> </span>by</div><div class="t m5 x1d h26 y51b6 ff9 fs19 fc1 sc0 ls0 ws0">gcc<span class="ff7">.<span class="_"> </span>It<span class="_"> </span>is<span class="_"> </span>worth<span class="_"> </span>studying<span class="_"> </span>this<span class="_"> </span>code<span class="_"> </span>carefully<span class="_"> </span>to<span class="_ _13"> </span>better<span class="_"> </span>understand<span class="_"> </span>the<span class="_"> </span>subtleties<span class="_"> </span>of</span></div><div class="t m5 x1d h26 y51b7 ff7 fs19 fc1 sc0 ls0 ws0">code<span class="_"> </span>optimization.</div><div class="t m5 x124 h26 y51b8 ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>In<span class="_ _6"> </span>the<span class="_ _6"> </span>less<span class="_ _6"> </span>optimized<span class="_ _6"> </span>code<span class="_ _0"></span>,<span class="_ _6"> </span>register<span class="_ _6"> </span><span class="ffd">%xmm0<span class="_ _6"> </span></span>is<span class="_ _13"> </span>simply<span class="_ _a"> </span>used<span class="_ _6"> </span>as<span class="_ _6"> </span>a<span class="_ _6"> </span>temporary<span class="_ _6"> </span>value,</div><div class="t m5 x4f h26 y51b9 ff7 fs19 fc1 sc0 ls0 ws0">both<span class="_ _11"> </span>set<span class="_ _11"> </span>and<span class="_ _16"> </span>used<span class="_ _11"> </span>on<span class="_ _11"> </span>each<span class="_ _16"> </span>loop<span class="_ _11"> </span>iteration.<span class="_ _11"> </span>In<span class="_ _16"> </span>the<span class="_ _11"> </span>more<span class="_ _11"> </span>optimized<span class="_ _11"> </span>code,<span class="_ _11"> </span>it<span class="_ _11"> </span>is</div><div class="t m5 x4f h26 y51ba ff7 fs19 fc1 sc0 ls0 ws0">used<span class="_ _15"> </span>more<span class="_ _15"> </span>in<span class="_ _15"> </span>the<span class="_ _15"> </span>manner<span class="_ _15"> </span>of<span class="_ _15"> </span>variable<span class="_ _15"> </span><span class="ffd">acc<span class="_ _15"> </span></span>in<span class="_ _15"> </span><span class="ffd">combine4</span>,<span class="_ _21"> </span>accumulating<span class="_ _15"> </span>the</div><div class="t m5 x4f h26 y51bb ff7 fs19 fc1 sc0 ls0 ws0">product<span class="_ _15"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>vector<span class="_ _15"> </span>elements<span class="_ _1"></span>.<span class="_ _21"> </span>T<span class="_ _0"></span>he<span class="_ _15"> </span>difference<span class="_ _21"> </span>with<span class="_ _21"> </span><span class="ffd">combine4</span>,<span class="_ _f"> </span>however,</div><div class="t m5 x4f h26 y51bc ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _15"> </span>that<span class="_ _21"> </span>location<span class="_ _21"> </span><span class="ffd">dest<span class="_ _21"> </span></span>is<span class="_ _21"> </span>updated<span class="_ _21"> </span>on<span class="_ _15"> </span>each<span class="_ _21"> </span>iteration<span class="_ _21"> </span>by<span class="_ _21"> </span>the<span class="_ _21"> </span>second<span class="_ _21"> </span><span class="ffd">vmovsd</span></div><div class="t m5 x4f h26 y51bd ff7 fs19 fc1 sc0 ls0 ws0">instruction.</div><div class="t m5 x1b7 h26 y51be ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_"> </span>can<span class="_ _13"> </span>see<span class="_ _13"> </span>that<span class="_ _13"> </span>this<span class="_ _13"> </span>optimized<span class="_"> </span>version<span class="_ _13"> </span>operates<span class="_ _13"> </span>much<span class="_ _13"> </span>like<span class="_"> </span>the<span class="_ _13"> </span>following</div><div class="t m5 x4f h26 y51bf ff7 fs19 fc1 sc0 ls0 ws0">C<span class="_"> </span>code:</div><div class="t m5 x207 h2d y51c0 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Make<span class="_ _e"> </span>sure<span class="_ _1f"> </span>dest<span class="_ _1f"> </span>updated<span class="_ _e"> </span>on<span class="_ _1f"> </span>each<span class="_ _e"> </span>iteration<span class="_ _1f"> </span>*/</span></div><div class="t m5 x207 h2d y51c1 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>combine3w(vec_ptr<span class="_ _e"> </span>v,<span class="_ _1f"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x207 h2d y51c2 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x207 h2d y51c3 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>i;</span></div><div class="t m5 x207 h2d y51c4 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>length<span class="_ _1f"> </span>=<span class="_ _1f"> </span>vec_length(v);</span></div><div class="t m5 x207 h2d y51c5 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>*data<span class="_ _1f"> </span>=<span class="_ _1f"> </span>get_vec_start(v);</span></div><div class="t m5 x207 h2d y51c6 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>acc<span class="_ _1f"> </span>=<span class="_ _1f"> </span>IDENT;</span></div><div class="t m5 x207 h2e y51c7 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x207 h2e y51c8 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1ba h2d y51c9 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Initialize<span class="_ _1f"> </span>in<span class="_ _1f"> </span>event<span class="_ _e"> </span>length<span class="_ _1f"> </span>&lt;=<span class="_ _e"> </span>0<span class="_ _1f"> </span>*/</div><div class="t m5 x4f h2d y51ca ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc;</span></div><div class="t m5 x4f h2e y51cb ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x4f h2e y51cc ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x1ba h2d y51cd ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>length;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</div><div class="t m5 x4f h2d y51ce ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _70"> </span><span class="ffd fs1e fc2">acc<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc<span class="_ _1f"> </span>OP<span class="_ _e"> </span>data[i];</span></div><div class="t m5 x4f h2d y51cf ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc;</span></div><div class="t m5 x4f h2d y51d0 ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x4f h2d y51d1 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x124 h26 y1aca ff7 fs19 fc2 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>The<span class="_ _16"> </span>two<span class="_ _14"> </span>versions<span class="_ _14"> </span>of<span class="_ _14"> </span><span class="ffd">combine3<span class="_ _15"> </span></span>will<span class="_ _14"> </span>have<span class="_ _14"> </span>identical<span class="_ _14"> </span>functionality<span class="_ _3"></span>,<span class="_ _15"> </span>even<span class="_ _14"> </span>with</div><div class="t m5 x4f h26 y51d2 ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_"> </span>aliasing.</div><div class="t m5 x124 h26 yc4b ff7 fs19 fc2 sc0 ls0 ws0">C.<span class="_ _25"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>transformation<span class="_ _11"> </span>can<span class="_ _16"> </span>be<span class="_ _16"> </span>made<span class="_ _11"> </span>without<span class="_ _16"> </span>changing<span class="_ _16"> </span>the<span class="_ _11"> </span>program<span class="_ _16"> </span>behavior,</div><div class="t m5 x4f h26 yb04 ff7 fs19 fc2 sc0 ls0 ws0">because<span class="_ _1"></span>,<span class="_"> </span>with<span class="_ _13"> </span>the<span class="_ _13"> </span>exception<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>ﬁrst<span class="_ _13"> </span>iteration,<span class="_"> </span>the<span class="_ _13"> </span>value<span class="_ _13"> </span>read<span class="_ _13"> </span>from<span class="_ _13"> </span><span class="ffd">dest<span class="_ _13"> </span></span>at</div><div class="t m5 x4f h26 yb05 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>beginning<span class="_ _13"> </span>of<span class="_"> </span>each<span class="_ _13"> </span>iteration<span class="_ _13"> </span>will<span class="_ _13"> </span>be<span class="_ _13"> </span>the<span class="_"> </span>same<span class="_ _13"> </span>value<span class="_ _13"> </span>written<span class="_ _13"> </span>to<span class="_ _13"> </span>this<span class="_"> </span>register</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
