<div id="pf373" class="pf w2 h11" data-page-no="373"><div class="pc pc373 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg373.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">882<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Relaxing<span class="_ _11"> </span>the<span class="_ _11"> </span>monotonicity<span class="_ _11"> </span>assumption</span></div><div class="t m5 x28 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _13"> </span>could<span class="_ _13"> </span>relax<span class="_ _13"> </span>the<span class="_ _13"> </span>monotonically<span class="_ _6"> </span>nondecreasing<span class="_ _13"> </span>assumption<span class="_ _13"> </span>in<span class="_ _13"> </span>our<span class="_ _13"> </span>deﬁnition<span class="_ _6"> </span>of<span class="_ _13"> </span><span class="ff11">U</span></div><div class="t m5 x1e1 h54 y836 ff11 fs2c fc2 sc0 ls0 ws0">k</div><div class="t m5 x132 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">and<span class="_ _13"> </span>allow<span class="_ _13"> </span>the<span class="_ _6"> </span>heap</div><div class="t m5 x28 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">to<span class="_"> </span>grow<span class="_"> </span>up<span class="_"> </span>and<span class="_"> </span>down<span class="_"> </span>by<span class="_"> </span>letting<span class="_"> </span><span class="ff11">H</span></div><div class="t m5 x20 h54 y837 ff11 fs2c fc2 sc0 ls0 ws0">k</div><div class="t m5 x50 h4a y838 ff7 fs1e fc2 sc0 ls0 ws0">be<span class="_"> </span>the<span class="_"> </span>high-water<span class="_"> </span>mark<span class="_"> </span>over<span class="_"> </span>the<span class="_"> </span>ﬁrst<span class="_"> </span><span class="ff11">k<span class="_ _10"> </span><span class="ff12">+<span class="_ _13"> </span></span></span>1<span class="_ _13"> </span>requests<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y727c ffe fs29 fc2 sc0 ls0 ws0">9.9.4<span class="_ _48"> </span><span class="fs19">Fragmentation</span></div><div class="t m5 x1d h26 y727d ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>primary<span class="_ _11"> </span>cause<span class="_"> </span>of<span class="_ _11"> </span>poor<span class="_ _11"> </span>heap<span class="_"> </span>utilization<span class="_ _11"> </span>is<span class="_ _11"> </span>a<span class="_"> </span>phenomenon<span class="_ _11"> </span>known<span class="_ _11"> </span>as<span class="_ _11"> </span><span class="ffa">fragmen-</span></div><div class="t m5 x1d h26 y727e ffa fs19 fc2 sc0 ls0 ws0">tation<span class="ff7">,<span class="_ _14"> </span>which<span class="_ _15"> </span>occurs<span class="_ _14"> </span>when<span class="_ _14"> </span>otherwise<span class="_ _14"> </span>unused<span class="_ _14"> </span>memory<span class="_ _15"> </span>is<span class="_ _14"> </span>not<span class="_ _14"> </span>available<span class="_ _14"> </span>to<span class="_ _14"> </span>satisfy</span></div><div class="t m5 x1d h26 y727f ff7 fs19 fc2 sc0 ls0 ws0">allocate<span class="_ _16"> </span>requests<span class="_ _1"></span>.<span class="_ _14"> </span>T<span class="_ _1"></span>here<span class="_ _14"> </span>are<span class="_ _16"> </span>two<span class="_ _16"> </span>forms<span class="_ _14"> </span>of<span class="_ _16"> </span>fragmentation:<span class="_ _14"> </span><span class="ffa">internal<span class="_ _16"> </span>fragmentation</span></div><div class="t m5 x1d h26 y7280 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span><span class="ffa">external<span class="_"> </span>fragmentation</span>.</div><div class="t m5 x29 h26 y7281 ffa fs19 fc2 sc0 ls0 ws0">Internal<span class="_"> </span>fragmentation<span class="_"> </span><span class="ff7">occurs<span class="_ _13"> </span>when<span class="_"> </span>an<span class="_"> </span>allocated<span class="_"> </span>block<span class="_"> </span>is<span class="_"> </span>larger<span class="_"> </span>than<span class="_ _13"> </span>the<span class="_"> </span>pay-</span></div><div class="t m5 x1d h26 y7282 ff7 fs19 fc2 sc0 ls0 ws0">load.<span class="_ _6"> </span>T<span class="_ _1"></span>his<span class="_ _13"> </span>might<span class="_ _a"> </span>happen<span class="_ _6"> </span>for<span class="_ _6"> </span>a<span class="_ _13"> </span>number<span class="_ _a"> </span>of<span class="_ _6"> </span>reasons<span class="_ _1"></span>.<span class="_ _6"> </span>F<span class="_ _0"></span>or<span class="_ _6"> </span>example<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _6"> </span>implementation</div><div class="t m5 x1d h26 y7283 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _11"> </span>an<span class="_ _16"> </span>allocator<span class="_ _11"> </span>might<span class="_ _11"> </span>impose<span class="_ _16"> </span>a<span class="_ _11"> </span>minimum<span class="_ _16"> </span>size<span class="_ _11"> </span>on<span class="_ _11"> </span>allocated<span class="_ _16"> </span>blocks<span class="_ _11"> </span>that<span class="_ _16"> </span>is<span class="_ _11"> </span>greater</div><div class="t m5 x1d h26 y7284 ff7 fs19 fc2 sc0 ls0 ws0">than<span class="_ _13"> </span>some<span class="_ _13"> </span>requested<span class="_"> </span>payload.<span class="_ _13"> </span>Or<span class="_ _0"></span>,<span class="_ _13"> </span>as<span class="_ _13"> </span>we<span class="_"> </span>saw<span class="_ _13"> </span>in<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>9.34(b),<span class="_ _13"> </span>the<span class="_ _13"> </span>allocator<span class="_ _13"> </span>might</div><div class="t m5 x1d h26 y7285 ff7 fs19 fc2 sc0 ls0 ws0">increase<span class="_"> </span>the<span class="_"> </span>block<span class="_"> </span>size<span class="_"> </span>in<span class="_"> </span>order<span class="_"> </span>to<span class="_"> </span>satisfy<span class="_"> </span>alignment<span class="_"> </span>constraints<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y7286 ff7 fs19 fc2 sc0 ls0 ws0">Internal<span class="_"> </span>fragmentation<span class="_ _11"> </span>is<span class="_ _11"> </span>straightforward<span class="_ _11"> </span>to<span class="_ _11"> </span>quantify<span class="_ _3"></span>.<span class="_ _11"> </span>It<span class="_"> </span>is<span class="_ _11"> </span>simply<span class="_ _11"> </span>the<span class="_ _11"> </span>sum<span class="_ _11"> </span>of</div><div class="t m5 x1d h26 y7287 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>differences<span class="_"> </span>between<span class="_ _13"> </span>the<span class="_ _13"> </span>sizes<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>allocated<span class="_ _13"> </span>blocks<span class="_ _13"> </span>and<span class="_"> </span>their<span class="_ _13"> </span>payloads<span class="_ _3"></span>.<span class="_"> </span>T<span class="_ _1"></span>hus<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y7288 ff7 fs19 fc2 sc0 ls0 ws0">at<span class="_ _16"> </span>any<span class="_ _11"> </span>point<span class="_ _16"> </span>in<span class="_ _16"> </span>time<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>amount<span class="_ _16"> </span>of<span class="_ _11"> </span>internal<span class="_ _16"> </span>fragmentation<span class="_ _16"> </span>depends<span class="_ _16"> </span>only<span class="_ _11"> </span>on<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y7289 ff7 fs19 fc2 sc0 ls0 ws0">pattern<span class="_"> </span>of<span class="_"> </span>previous<span class="_"> </span>requests<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>allocator<span class="_"> </span>implementation.</div><div class="t m5 x29 h26 y728a ffa fs19 fc2 sc0 ls0 ws0">External<span class="_ _11"> </span>fragmentation<span class="_"> </span><span class="ff7">occurs<span class="_ _11"> </span>when<span class="_ _11"> </span>there<span class="_ _16"> </span></span>is<span class="_"> </span><span class="ff7">enough<span class="_ _11"> </span>aggregate<span class="_ _11"> </span>free<span class="_ _11"> </span>memory</span></div><div class="t m5 x1d h26 y728b ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _11"> </span>satisfy<span class="_ _16"> </span>an<span class="_ _16"> </span>allocate<span class="_ _11"> </span>request,<span class="_ _16"> </span>but<span class="_ _16"> </span>no<span class="_ _11"> </span>single<span class="_ _16"> </span>free<span class="_ _16"> </span>block<span class="_ _11"> </span>is<span class="_ _16"> </span>large<span class="_ _16"> </span>enough<span class="_ _11"> </span>to<span class="_ _16"> </span>handle</div><div class="t m5 x1d h26 y728c ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>request.<span class="_ _14"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>example<span class="_ _1"></span>,<span class="_ _15"> </span>if<span class="_ _14"> </span>the<span class="_ _14"> </span>request<span class="_ _14"> </span>in<span class="_ _14"> </span>Figure<span class="_ _16"> </span>9.34(e)<span class="_ _14"> </span>were<span class="_ _14"> </span>for<span class="_ _14"> </span>eight<span class="_ _14"> </span>words</div><div class="t m5 x1d h26 y728d ff7 fs19 fc2 sc0 ls0 ws0">rather<span class="_"> </span>than<span class="_"> </span>two<span class="_"> </span>words<span class="_ _3"></span>,<span class="_"> </span>then<span class="_"> </span>the<span class="_"> </span>request<span class="_"> </span>could<span class="_"> </span>not<span class="_"> </span>be<span class="_ _13"> </span>satisﬁed<span class="_"> </span>without<span class="_"> </span>requesting</div><div class="t m5 x1d h26 y728e ff7 fs19 fc2 sc0 ls0 ws0">additional<span class="_ _13"> </span>virtual<span class="_ _6"> </span>memory<span class="_ _13"> </span>from<span class="_ _6"> </span>the<span class="_ _13"> </span>kernel,<span class="_ _13"> </span>even<span class="_ _6"> </span>though<span class="_ _13"> </span>there<span class="_ _6"> </span>are<span class="_ _13"> </span>eight<span class="_ _6"> </span>free<span class="_ _13"> </span>words</div><div class="t m5 x1d h26 y728f ff7 fs19 fc2 sc0 ls0 ws0">remaining<span class="_"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>heap.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>problem<span class="_ _11"> </span>arises<span class="_ _11"> </span>because<span class="_ _11"> </span>these<span class="_ _11"> </span>eight<span class="_ _11"> </span>words<span class="_ _11"> </span>are<span class="_ _11"> </span>spread</div><div class="t m5 x1d h26 y7290 ff7 fs19 fc2 sc0 ls0 ws0">over<span class="_"> </span>two<span class="_"> </span>free<span class="_"> </span>blocks<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y7291 ff7 fs19 fc2 sc0 ls0 ws0">External<span class="_"> </span>fragmentation<span class="_"> </span>is<span class="_"> </span>much<span class="_"> </span>more<span class="_"> </span>difﬁcult<span class="_"> </span>to<span class="_"> </span>quantify<span class="_"> </span>than<span class="_"> </span>internal<span class="_"> </span>frag-</div><div class="t m5 x1d h26 y7292 ff7 fs19 fc2 sc0 ls0 ws0">mentation<span class="_ _13"> </span>because<span class="_ _13"> </span>it<span class="_ _6"> </span>depends<span class="_ _13"> </span>not<span class="_ _13"> </span>only<span class="_ _13"> </span>on<span class="_ _6"> </span>the<span class="_ _13"> </span>pattern<span class="_ _13"> </span>of<span class="_ _13"> </span>previous<span class="_ _13"> </span>requests<span class="_ _6"> </span>and<span class="_ _13"> </span>the</div><div class="t m5 x1d h26 y7293 ff7 fs19 fc2 sc0 ls0 ws0">allocator<span class="_"> </span>implementation<span class="_ _13"> </span>but<span class="_"> </span>also<span class="_"> </span>on<span class="_"> </span>the<span class="_ _13"> </span>pattern<span class="_"> </span>of<span class="_"> </span><span class="ffa">future<span class="_"> </span></span>requests<span class="_ _3"></span>.<span class="_"> </span>F<span class="_ _1"></span>or<span class="_"> </span>example<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y7294 ff7 fs19 fc2 sc0 ls0 ws0">suppose<span class="_"> </span>that<span class="_ _11"> </span>after<span class="_ _11"> </span><span class="ff11">k<span class="_"> </span></span>requests<span class="_"> </span>all<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>free<span class="_ _11"> </span>blocks<span class="_ _11"> </span>are<span class="_"> </span>exactly<span class="_ _11"> </span>four<span class="_ _11"> </span>words<span class="_ _11"> </span>in<span class="_"> </span>size.</div><div class="t m5 x1d h26 y7295 ff7 fs19 fc2 sc0 ls0 ws0">Does<span class="_ _11"> </span>this<span class="_ _11"> </span>heap<span class="_ _16"> </span>suffer<span class="_ _11"> </span>from<span class="_ _11"> </span>external<span class="_ _16"> </span>fragmentation?<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>answer<span class="_ _11"> </span>depends<span class="_ _11"> </span>on<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y7296 ff7 fs19 fc2 sc0 ls0 ws0">pattern<span class="_"> </span>of<span class="_"> </span>future<span class="_ _13"> </span>requests<span class="_ _0"></span>.<span class="_"> </span>If<span class="_"> </span>all<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>future<span class="_"> </span>allocate<span class="_"> </span>requests<span class="_"> </span>are<span class="_ _13"> </span>for<span class="_"> </span>blocks<span class="_"> </span>that</div><div class="t m5 x1d h26 y7297 ff7 fs19 fc2 sc0 ls0 ws0">are<span class="_"> </span>smaller<span class="_ _11"> </span>than<span class="_"> </span>or<span class="_ _11"> </span>equal<span class="_ _11"> </span>to<span class="_"> </span>four<span class="_ _11"> </span>words<span class="_ _1"></span>,<span class="_ _11"> </span>then<span class="_"> </span>there<span class="_ _11"> </span>is<span class="_"> </span>no<span class="_ _11"> </span>external<span class="_ _11"> </span>fragmentation.</div><div class="t m5 x1d h26 y7298 ff7 fs19 fc2 sc0 ls0 ws0">On<span class="_"> </span>the<span class="_"> </span>other<span class="_ _13"> </span>hand,<span class="_"> </span>if<span class="_"> </span>one<span class="_"> </span>or<span class="_ _13"> </span>more<span class="_"> </span>requests<span class="_"> </span>ask<span class="_"> </span>for<span class="_ _13"> </span>blocks<span class="_"> </span>larger<span class="_"> </span>than<span class="_"> </span>four<span class="_ _13"> </span>words<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y7299 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_"> </span>the<span class="_"> </span>heap<span class="_"> </span>does<span class="_"> </span>suffer<span class="_"> </span>from<span class="_"> </span>external<span class="_"> </span>fragmentation.</div><div class="t m5 x29 h26 y729a ff7 fs19 fc2 sc0 ls0 ws0">Since<span class="_ _13"> </span>external<span class="_ _13"> </span>fragmentation<span class="_ _13"> </span>is<span class="_ _13"> </span>difﬁcult<span class="_ _13"> </span>to<span class="_ _13"> </span>quantify<span class="_ _13"> </span>and<span class="_ _13"> </span>impossible<span class="_ _13"> </span>to<span class="_ _13"> </span>predict,</div><div class="t m5 x1d h26 y2ba6 ff7 fs19 fc2 sc0 ls0 ws0">allocators<span class="_ _11"> </span>typically<span class="_ _11"> </span>employ<span class="_ _11"> </span>heuristics<span class="_ _11"> </span>that<span class="_ _11"> </span>attempt<span class="_ _11"> </span>to<span class="_ _16"> </span>maintain<span class="_"> </span>small<span class="_ _11"> </span>numbers<span class="_ _11"> </span>of</div><div class="t m5 x1d h26 y729b ff7 fs19 fc2 sc0 ls0 ws0">larger<span class="_"> </span>free<span class="_"> </span>blocks<span class="_"> </span>rather<span class="_"> </span>than<span class="_"> </span>large<span class="_"> </span>numbers<span class="_"> </span>of<span class="_"> </span>smaller<span class="_"> </span>free<span class="_"> </span>blocks<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y15be ffe fs29 fc2 sc0 ls0 ws0">9.9.5<span class="_ _48"> </span><span class="fs19">Implementation<span class="_"> </span>Issues</span></div><div class="t m5 x1d h26 y15bf ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _15"> </span>simplest<span class="_ _14"> </span>imaginable<span class="_ _15"> </span>allocator<span class="_ _14"> </span>would<span class="_ _15"> </span>organize<span class="_ _15"> </span>the<span class="_ _14"> </span>heap<span class="_ _15"> </span>as<span class="_ _14"> </span>a<span class="_ _15"> </span>large<span class="_ _14"> </span>array<span class="_ _15"> </span>of</div><div class="t m5 x1d h26 y15c0 ff7 fs19 fc2 sc0 ls0 ws0">bytes<span class="_"> </span>and<span class="_"> </span>a<span class="_"> </span>pointer<span class="_"> </span><span class="ffd">p<span class="_ _10"> </span></span>that<span class="_"> </span>initially<span class="_"> </span>points<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>ﬁrst<span class="_"> </span>byte<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>array<span class="_ _7"></span>.<span class="_"> </span>T<span class="_ _3"></span>o<span class="_"> </span>allocate</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
