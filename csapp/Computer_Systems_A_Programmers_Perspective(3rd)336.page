<div id="pf150" class="pf w2 h11" data-page-no="150"><div class="pc pc150 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg150.png"/><div class="t m5 x195 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.11<span class="_ _60"> </span>Floating-Point<span class="_ _10"> </span>Code<span class="_ _3e"> </span><span class="ffe fs1e">335</span></div><div class="t m5 x17 h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">Suppose<span class="_ _13"> </span>these<span class="_ _13"> </span>instructions<span class="_"> </span>start<span class="_ _13"> </span>with<span class="_ _13"> </span>register<span class="_ _13"> </span><span class="ffd">%xmm0<span class="_ _13"> </span></span>holding<span class="_"> </span>two<span class="_ _13"> </span>double-precision</div><div class="t m5 x17 h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">values<span class="_ _6"> </span>[<span class="ff11">x</span></div><div class="t m5 x1a9 h3c yc4c ff7 fs25 fc2 sc0 ls0 ws0">1</div><div class="t m5 x1da h45 y2825 ff11 fs19 fc2 sc0 ls192 ws0">,x</div><div class="t m5 x5b h3c yc4c ff7 fs25 fc2 sc0 ls0 ws0">0</div><div class="t m5 x156 h26 y2825 ff7 fs19 fc2 sc0 ls0 ws0">]<span class="_ _1"></span>.<span class="_ _6"> </span>Then<span class="_ _a"> </span>the<span class="_ _13"> </span><span class="ffd">vmovddup<span class="_ _6"> </span></span>instruction<span class="_ _6"> </span>will<span class="_ _13"> </span>set<span class="_ _6"> </span>it<span class="_ _13"> </span>to<span class="_ _a"> </span>[<span class="ff11">x</span></div><div class="t m5 x205 h3c yc4c ff7 fs25 fc2 sc0 ls0 ws0">0</div><div class="t m5 xfe h45 y2825 ff11 fs19 fc2 sc0 ls192 ws0">,x</div><div class="t m5 xe8 h3c yc4c ff7 fs25 fc2 sc0 ls0 ws0">0</div><div class="t m5 x60 h26 y2825 ff7 fs19 fc2 sc0 ls2d ws0">].<span class="_ _10"> </span>Th<span class="_ _2"></span>e<span class="_ _10"> </span><span class="ffd ls0">vcvtpd2psx</span></div><div class="t m5 x17 h26 y300d ff7 fs19 fc2 sc0 ls0 ws0">instruction<span class="_ _e"> </span>will<span class="_ _e"> </span>convert<span class="_ _e"> </span>these<span class="_ _e"> </span>values<span class="_ _e"> </span>to<span class="_ _e"> </span>single<span class="_ _e"> </span>precision,<span class="_ _22"> </span>pack<span class="_ _e"> </span>them<span class="_ _e"> </span>into<span class="_ _e"> </span>the</div><div class="t m5 x17 h26 y300e ff7 fs19 fc2 sc0 ls0 ws0">low-order<span class="_ _e"> </span>half<span class="_ _e"> </span>of<span class="_ _f"> </span>the<span class="_ _e"> </span>register,<span class="_ _e"> </span>and<span class="_ _e"> </span>set<span class="_ _e"> </span>the<span class="_ _e"> </span>upper<span class="_ _e"> </span>half<span class="_ _f"> </span>to<span class="_ _e"> </span>0,<span class="_ _1f"> </span>yielding<span class="_ _e"> </span>a<span class="_ _e"> </span>result</div><div class="t m5 x17 h26 y300f ff7 fs19 fc2 sc0 ls0 ws0">[0<span class="ff11">.</span>0<span class="ff11">,<span class="_ _10"> </span></span>0<span class="ff11">.</span>0<span class="ff11 ls193">,x</span></div><div class="t m5 x12 h3c y1001 ff7 fs25 fc2 sc0 ls0 ws0">0</div><div class="t m5 x160 h45 yecd ff11 fs19 fc2 sc0 ls193 ws0">,x</div><div class="t m5 x155 h3c y1001 ff7 fs25 fc2 sc0 ls0 ws0">0</div><div class="t m5 xc5 h26 yecd ff7 fs19 fc2 sc0 ls0 ws0">]<span class="_ _11"> </span>(recall<span class="_ _14"> </span>that<span class="_ _14"> </span>ﬂoating-point<span class="_ _14"> </span>value<span class="_ _15"> </span>0<span class="ff11">.</span>0<span class="_ _14"> </span>is<span class="_ _14"> </span>represented<span class="_ _14"> </span>by<span class="_ _14"> </span>a<span class="_ _14"> </span>bit<span class="_ _15"> </span>pat-</div><div class="t m5 x17 h26 y1002 ff7 fs19 fc2 sc0 ls0 ws0">tern<span class="_ _13"> </span>of<span class="_"> </span>all<span class="_ _13"> </span>zeros).<span class="_"> </span>Again,<span class="_ _13"> </span>there<span class="_ _13"> </span>is<span class="_"> </span>no<span class="_ _13"> </span>clear<span class="_"> </span>value<span class="_ _13"> </span>in<span class="_ _13"> </span>computing<span class="_"> </span>the<span class="_ _13"> </span>conversion<span class="_ _13"> </span>from</div><div class="t m5 x17 h26 y1003 ff7 fs19 fc2 sc0 ls0 ws0">one<span class="_"> </span>precision<span class="_"> </span>to<span class="_"> </span>another<span class="_"> </span>this<span class="_"> </span>way<span class="_ _3"></span>,<span class="_"> </span>rather<span class="_"> </span>than<span class="_"> </span>by<span class="_"> </span>using<span class="_"> </span>the<span class="_"> </span>single<span class="_"> </span>instruction</div><div class="t m5 x1b6 h2d y3010 ffd fs1e fc2 sc0 ls0 ws0">vcvtsd2ss<span class="_ _e"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0</div><div class="t m5 x26 h26 y3011 ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _13"> </span>an<span class="_ _13"> </span>example<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>different<span class="_ _13"> </span>ﬂoating-point<span class="_"> </span>conversion<span class="_ _13"> </span>operations<span class="_ _3"></span>,<span class="_"> </span>consider</div><div class="t m5 x17 h26 y3012 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>C<span class="_"> </span>function</div><div class="t m5 x17 h2d y3013 ffd fs1e fc2 sc0 ls0 ws0">double<span class="_ _e"> </span>fcvt(int<span class="_ _1f"> </span>i,<span class="_ _1f"> </span>float<span class="_ _e"> </span>*fp,<span class="_ _1f"> </span>double<span class="_ _e"> </span>*dp,<span class="_ _1f"> </span>long<span class="_ _1f"> </span>*lp)</div><div class="t m5 x17 h2d y3014 ffd fs1e fc2 sc0 ls0 ws0">{</div><div class="t m5 x1b6 h2d y3015 ffd fs1e fc2 sc0 ls0 ws0">float<span class="_ _e"> </span>f<span class="_ _1f"> </span>=<span class="_ _1f"> </span>*fp;<span class="_ _e"> </span>double<span class="_ _1f"> </span>d<span class="_ _e"> </span>=<span class="_ _1f"> </span>*dp;<span class="_ _1f"> </span>long<span class="_ _e"> </span>l<span class="_ _1f"> </span>=<span class="_ _e"> </span>*lp;</div><div class="t m5 x1b6 h2d y3016 ffd fs1e fc2 sc0 ls0 ws0">*lp<span class="_ _e"> </span>=<span class="_ _1f"> </span>(long)<span class="_ _46"> </span>d;</div><div class="t m5 x1b6 h2d y3017 ffd fs1e fc2 sc0 ls0 ws0">*fp<span class="_ _e"> </span>=<span class="_ _1f"> </span>(float)<span class="_ _3f"> </span>i;</div><div class="t m5 x1b6 h2d y3018 ffd fs1e fc2 sc0 ls0 ws0">*dp<span class="_ _e"> </span>=<span class="_ _1f"> </span>(double)<span class="_ _1a"> </span>l;</div><div class="t m5 x1b6 h2d y3019 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>(double)<span class="_ _1f"> </span>f;</div><div class="t m5 x17 h2d y301a ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h26 y1ada ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>its<span class="_"> </span>associated<span class="_"> </span>x86-64<span class="_"> </span>assembly<span class="_"> </span>code</div><div class="t m5 x2e h61 y2350 ff13 fs35 fc6 sc0 ls0 ws0">double<span class="_ _f"> </span>fcvt(int<span class="_ _f"> </span>i,<span class="_ _f"> </span>float<span class="_ _e"> </span>*fp,<span class="_ _21"> </span>double<span class="_ _f"> </span>*dp,<span class="_ _e"> </span>long<span class="_ _21"> </span>*lp)</div><div class="t m5 x2e h61 y301b ff13 fs35 fc6 sc0 ls0 ws0">i<span class="_ _f"> </span>in<span class="_ _f"> </span>%edi,<span class="_ _f"> </span>fp<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi,<span class="_ _f"> </span>dp<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>lp<span class="_ _e"> </span>in<span class="_ _21"> </span>%rcx</div><div class="t m5 x2c h2d y301c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">fcvt:</span></div><div class="t m5 x2c h2d y301d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovss<span class="_ _1a"> </span>(%rsi),<span class="_ _e"> </span>%xmm0<span class="_ _12c"> </span></span><span class="ff13 fs35">Get<span class="_ _e"> </span>f<span class="_ _21"> </span>=<span class="_ _f"> </span>*fp</span></div><div class="t m5 x2c h2d y301e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>(%rcx),<span class="_ _e"> </span>%rax<span class="_ _142"> </span></span><span class="ff13 fs35">Get<span class="_ _e"> </span>l<span class="_ _21"> </span>=<span class="_ _f"> </span>*lp</span></div><div class="t m5 x2c h2d y301f ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">vcvttsd2siq<span class="_ _8c"> </span>(%rdx),<span class="_ _e"> </span>%r8<span class="_ _c1"> </span></span><span class="ff13 fs35">Get<span class="_ _f"> </span>d<span class="_ _f"> </span>=<span class="_ _e"> </span>*dp<span class="_ _21"> </span>and<span class="_ _f"> </span>convert<span class="_ _e"> </span>to<span class="_ _21"> </span>long</span></div><div class="t m5 x2c h2e y3020 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 xd1 h2d y3021 ffd fs1e fc2 sc0 ls0 ws0">movq<span class="_ _46"> </span>%r8,<span class="_ _e"> </span>(%rcx)<span class="_ _139"> </span><span class="ff13 fs35 fc6">Store<span class="_ _e"> </span>at<span class="_ _21"> </span>lp</span></div><div class="t m5 x2c h2d y3022 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">vcvtsi2ss<span class="_ _6f"> </span>%edi,<span class="_ _1f"> </span>%xmm1,<span class="_ _e"> </span>%xmm1<span class="_ _2a"> </span></span><span class="ff13 fs35">Convert<span class="_ _f"> </span>i<span class="_ _f"> </span>to<span class="_ _f"> </span>float</span></div><div class="t m5 x2c h2d y3023 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovss<span class="_ _1a"> </span>%xmm1,<span class="_ _e"> </span>(%rsi)<span class="_ _12c"> </span></span><span class="ff13 fs35">Store<span class="_ _e"> </span>at<span class="_ _21"> </span>fp</span></div><div class="t m5 x2c h2d y3024 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">vcvtsi2sdq<span class="_ _5a"> </span>%rax,<span class="_ _1f"> </span>%xmm1,<span class="_ _e"> </span>%xmm1<span class="_ _2a"> </span></span><span class="ff13 fs35">Convert<span class="_ _f"> </span>l<span class="_ _f"> </span>to<span class="_ _e"> </span>double</span></div><div class="t m5 x2c h2d y3025 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovsd<span class="_ _1a"> </span>%xmm1,<span class="_ _e"> </span>(%rdx)<span class="_ _12c"> </span></span><span class="ff13 fs35">Store<span class="_ _e"> </span>at<span class="_ _21"> </span>dp</span></div><div class="t m5 xd1 h61 y3026 ff13 fs35 fc6 sc0 ls0 ws0">The<span class="_ _f"> </span>following<span class="_ _f"> </span>two<span class="_ _f"> </span>instructions<span class="_ _e"> </span>convert<span class="_ _21"> </span>f<span class="_ _f"> </span>to<span class="_ _e"> </span>double</div><div class="t m5 x17 h2d y3027 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _45"> </span><span class="ffd fs1e fc2">vunpcklps<span class="_ _6f"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0,<span class="_ _e"> </span>%xmm0</span></div><div class="t m5 x17 h2d y3028 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _45"> </span><span class="ffd fs1e fc2">vcvtps2pd<span class="_ _6f"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0</span></div><div class="t m5 x17 h2e y3029 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 xd1 h2d y302a ffd fs1e fc2 sc0 ls0 ws0">ret<span class="_ _185"> </span><span class="ff13 fs35 fc6">Return<span class="_ _f"> </span>f</span></div><div class="t m5 x26 h26 y2767 ff7 fs19 fc2 sc0 ls0 ws0">All<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _6"> </span>arguments<span class="_ _13"> </span>to<span class="_ _a"> </span><span class="ffd">fcvt<span class="_ _13"> </span></span>are<span class="_ _a"> </span>passed<span class="_ _6"> </span>through<span class="_ _13"> </span>the<span class="_ _a"> </span>general-purpose<span class="_ _13"> </span>registers<span class="_ _3"></span>,</div><div class="t m5 x17 h26 y302b ff7 fs19 fc2 sc0 ls0 ws0">since<span class="_"> </span>they<span class="_"> </span>are<span class="_ _13"> </span>either<span class="_"> </span>integers<span class="_"> </span>or<span class="_"> </span>pointers<span class="_ _3"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>result<span class="_"> </span>is<span class="_"> </span>returned<span class="_ _13"> </span>in<span class="_"> </span>register<span class="_"> </span><span class="ffd">%xmm0</span>.</div><div class="t m5 x17 h26 y302c ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _11"> </span>is<span class="_ _11"> </span>documented<span class="_ _11"> </span>in<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _11"> </span>3.45,<span class="_ _16"> </span>this<span class="_ _11"> </span>is<span class="_ _11"> </span>the<span class="_ _11"> </span>designated<span class="_ _16"> </span>return<span class="_"> </span>register<span class="_ _16"> </span>for<span class="_ _11"> </span><span class="ffd">float</span></div><div class="t m5 x17 h26 y302d ff7 fs19 fc2 sc0 ls0 ws0">or<span class="_"> </span><span class="ffd">double<span class="_ _13"> </span></span>values<span class="_ _1"></span>.<span class="_"> </span>In<span class="_"> </span>this<span class="_"> </span>code<span class="_ _1"></span>,<span class="_"> </span>we<span class="_ _13"> </span>see<span class="_"> </span>a<span class="_"> </span>number<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>movement<span class="_"> </span>and<span class="_ _13"> </span>conversion</div><div class="t m5 x17 h26 y302e ff7 fs19 fc2 sc0 ls0 ws0">instructions<span class="_"> </span>of<span class="_"> </span>F<span class="_ _1"></span>igures<span class="_"> </span>3.46–3.48,<span class="_"> </span>as<span class="_"> </span>well<span class="_"> </span>as<span class="_"> </span><span class="ff9">gcc</span>’s<span class="_ _13"> </span>preferred<span class="_"> </span>method<span class="_"> </span>of<span class="_"> </span>converting</div><div class="t m5 x17 h26 y6e1 ff7 fs19 fc2 sc0 ls0 ws0">from<span class="_"> </span>single<span class="_"> </span>to<span class="_"> </span>double<span class="_"> </span>precision.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
