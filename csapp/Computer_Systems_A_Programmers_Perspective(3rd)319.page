<div id="pf13f" class="pf w2 h11" data-page-no="13f"><div class="pc pc13f w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg13f.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">318<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1f h2d ye7 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">call<span class="_ _46"> </span>puts<span class="_ _17c"> </span></span><span class="ff13 fs35">Call<span class="_ _f"> </span>puts</span></div><div class="t m5 x1f h2d yc4d ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$24,<span class="_ _e"> </span>%rsp<span class="_ _5d"> </span></span><span class="ff13 fs35">Deallocate<span class="_ _f"> </span>stack<span class="_ _e"> </span>space</span></div><div class="t m5 x1f h2d yecb ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">ret<span class="_ _139"> </span></span><span class="ff13 fs35">Return</span></div><div class="t m5 x29 h26 y2da5 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _13"> </span>3.40<span class="_ _6"> </span>illustrates<span class="_ _6"> </span>the<span class="_ _6"> </span>stack<span class="_ _13"> </span>organization<span class="_ _6"> </span>during<span class="_ _6"> </span>the<span class="_ _13"> </span>execution<span class="_ _a"> </span>of<span class="_ _13"> </span><span class="ffd">echo</span><span class="ls183">.T<span class="_ _80"></span>h<span class="_ _8"></span>e</span></div><div class="t m5 x1d h26 y2da6 ff7 fs19 fc2 sc0 ls0 ws0">program<span class="_"> </span>allocates<span class="_ _11"> </span>24<span class="_ _11"> </span>bytes<span class="_ _11"> </span>on<span class="_ _11"> </span>the<span class="_"> </span>stack<span class="_ _11"> </span>by<span class="_ _11"> </span>subtracting<span class="_ _11"> </span>24<span class="_ _11"> </span>from<span class="_"> </span>the<span class="_ _11"> </span>stack<span class="_ _11"> </span>pointer</div><div class="t m5 x1d h26 y2da7 ff7 fs19 fc2 sc0 ls0 ws0">(line<span class="_"> </span>2).<span class="_"> </span>Character<span class="_"> </span><span class="ffd">buf<span class="_ _10"> </span></span>is<span class="_"> </span>positioned<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>top<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>stack,<span class="_"> </span>as<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>seen<span class="_"> </span>by<span class="_"> </span>the</div><div class="t m5 x1d h26 y2da8 ff7 fs19 fc2 sc0 ls0 ws0">fact<span class="_ _16"> </span>that<span class="_ _16"> </span><span class="ffd">%rsp<span class="_ _16"> </span></span>is<span class="_ _16"> </span>copied<span class="_ _16"> </span>to<span class="_ _16"> </span><span class="ffd">%rdi<span class="_ _16"> </span></span>to<span class="_ _16"> </span>be<span class="_ _16"> </span>used<span class="_ _16"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span>argument<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>calls<span class="_ _16"> </span>to<span class="_ _16"> </span>both</div><div class="t m5 x1d h26 y2da9 ffd fs19 fc2 sc0 ls0 ws0">gets<span class="_ _11"> </span><span class="ff7">and<span class="_ _16"> </span></span>puts<span class="ff7">.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_ _11"> </span>16<span class="_ _16"> </span>bytes<span class="_ _11"> </span>between<span class="_ _11"> </span><span class="ffd">buf<span class="_ _16"> </span></span>and<span class="_ _11"> </span>the<span class="_ _16"> </span>stored<span class="_ _11"> </span>return<span class="_ _11"> </span>pointer<span class="_ _16"> </span>are<span class="_ _11"> </span>not</span></div><div class="t m5 x1d h26 y2daa ff7 fs19 fc2 sc0 ls0 ws0">used.<span class="_ _16"> </span>As<span class="_ _16"> </span>long<span class="_ _11"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span>user<span class="_ _16"> </span>types<span class="_ _16"> </span>at<span class="_ _16"> </span>most<span class="_ _11"> </span>seven<span class="_ _16"> </span>characters<span class="_ _1"></span>,<span class="_ _14"> </span>the<span class="_ _16"> </span>string<span class="_ _16"> </span>returned<span class="_ _11"> </span>by</div><div class="t m5 x1d h26 y2dab ffd fs19 fc2 sc0 ls0 ws0">gets<span class="_ _16"> </span><span class="ff7">(including<span class="_ _16"> </span>the<span class="_ _16"> </span>terminating<span class="_ _16"> </span>null)<span class="_ _16"> </span>will<span class="_ _16"> </span>ﬁt<span class="_ _16"> </span>within<span class="_ _16"> </span>the<span class="_ _14"> </span>space<span class="_ _16"> </span>allocated<span class="_ _16"> </span>for<span class="_ _16"> </span></span>buf<span class="ff7">.</span></div><div class="t m5 x1d h26 y2dac ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _16"> </span>longer<span class="_ _11"> </span>string,<span class="_ _16"> </span>however,<span class="_ _16"> </span>will<span class="_ _16"> </span>cause<span class="_ _16"> </span><span class="ffd">gets<span class="_ _11"> </span></span>to<span class="_ _16"> </span>overwrite<span class="_ _16"> </span>some<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>information</div><div class="t m5 x1d h26 y2dad ff7 fs19 fc2 sc0 ls0 ws0">stored<span class="_ _11"> </span>on<span class="_ _16"> </span>the<span class="_ _11"> </span>stack.<span class="_ _11"> </span>As<span class="_ _16"> </span>the<span class="_ _11"> </span>string<span class="_ _16"> </span>gets<span class="_ _11"> </span>longer,<span class="_ _11"> </span>the<span class="_ _16"> </span>following<span class="_ _11"> </span>information<span class="_ _16"> </span>will<span class="_ _11"> </span>get</div><div class="t m5 x1d h26 y2dae ff7 fs19 fc2 sc0 ls0 ws0">corrupted:</div><div class="t m5 x1d h31 y2daf ff7 fs21 fc2 sc0 ls0 ws0">Characters<span class="_"> </span>typed<span class="_ _26"> </span>Additional<span class="_"> </span>corrupted<span class="_"> </span>state</div><div class="t m5 x1d h31 y2db0 ff7 fs21 fc2 sc0 ls0 ws0">0–7<span class="_ _157"> </span>None</div><div class="t m5 x1d h31 y2db1 ff7 fs21 fc2 sc0 ls0 ws0">9–23<span class="_ _92"> </span>Unused<span class="_"> </span>stack<span class="_"> </span>space</div><div class="t m5 x1d h31 y2db2 ff7 fs21 fc2 sc0 ls0 ws0">24–31<span class="_ _107"> </span>Return<span class="_"> </span>address</div><div class="t m5 x1d h31 y2db3 ff7 fs21 fc2 sc0 ls0 ws0">32+<span class="_ _17d"> </span>Saved<span class="_"> </span>state<span class="_"> </span>in<span class="_"> </span>caller</div><div class="t m5 x29 h26 y2db4 ff7 fs19 fc2 sc0 ls0 ws0">No<span class="_"> </span>serious<span class="_"> </span>consequence<span class="_"> </span>occurs<span class="_"> </span>for<span class="_"> </span>strings<span class="_"> </span>of<span class="_"> </span>up<span class="_"> </span>to<span class="_ _13"> </span>23<span class="_"> </span>characters<span class="_ _1"></span>,<span class="_"> </span>but<span class="_"> </span>beyond</div><div class="t m5 x1d h26 y2db5 ff7 fs19 fc2 sc0 ls0 ws0">that,<span class="_ _f"> </span>the<span class="_ _21"> </span>value<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>return<span class="_ _21"> </span>pointer,<span class="_ _f"> </span>and<span class="_ _21"> </span>possibly<span class="_ _21"> </span>additional<span class="_ _21"> </span>saved<span class="_ _21"> </span>state,<span class="_ _21"> </span>will</div><div class="t m5 x1d h26 y2db6 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_ _21"> </span>corrupted.<span class="_ _21"> </span>If<span class="_ _21"> </span>the<span class="_ _21"> </span>stored<span class="_ _21"> </span>value<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>return<span class="_ _21"> </span>address<span class="_ _21"> </span>is<span class="_ _21"> </span>corrupted,<span class="_ _f"> </span>then<span class="_ _21"> </span>the</div><div class="t m5 x1d h26 y2db7 ffd fs19 fc2 sc0 ls0 ws0">ret<span class="_ _16"> </span><span class="ff7">instruction<span class="_ _14"> </span>(line<span class="_ _16"> </span>8)<span class="_ _14"> </span>will<span class="_ _14"> </span>cause<span class="_ _16"> </span>the<span class="_ _14"> </span>program<span class="_ _16"> </span>to<span class="_ _14"> </span>jump<span class="_ _14"> </span>to<span class="_ _16"> </span>a<span class="_ _14"> </span>totally<span class="_ _16"> </span>unexpected</span></div><div class="t m5 x1d h26 y2db8 ff7 fs19 fc2 sc0 ls0 ws0">location.<span class="_"> </span>None<span class="_"> </span>of<span class="_"> </span>these<span class="_"> </span>behaviors<span class="_"> </span>would<span class="_"> </span>seem<span class="_ _13"> </span>possible<span class="_"> </span>based<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>C<span class="_"> </span>code<span class="_ _1"></span>.<span class="_"> </span>The</div><div class="t m5 x1d h26 y2db9 ff7 fs19 fc2 sc0 ls0 ws0">impact<span class="_ _13"> </span>of<span class="_"> </span>out-of-bounds<span class="_ _13"> </span>writing<span class="_ _13"> </span>to<span class="_"> </span>memory<span class="_ _13"> </span>by<span class="_ _13"> </span>functions<span class="_"> </span>such<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ffd">gets<span class="_ _13"> </span></span>can<span class="_"> </span>only<span class="_ _13"> </span>be</div><div class="t m5 x1d h26 y2dba ff7 fs19 fc2 sc0 ls0 ws0">understood<span class="_"> </span>by<span class="_"> </span>studying<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>machine-code<span class="_"> </span>level.</div><div class="t m5 x29 h26 y2dbb ff7 fs19 fc2 sc0 ls0 ws0">Our<span class="_ _16"> </span>code<span class="_ _11"> </span>for<span class="_ _16"> </span><span class="ffd">echo<span class="_ _16"> </span></span>is<span class="_ _16"> </span>simple<span class="_ _16"> </span>but<span class="_ _16"> </span>sloppy<span class="_ _7"></span>.<span class="_ _16"> </span>A<span class="_ _16"> </span>better<span class="_ _16"> </span>version<span class="_ _16"> </span>involves<span class="_ _11"> </span>using<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y2dbc ff7 fs19 fc2 sc0 ls0 ws0">function<span class="_"> </span><span class="ffd">fgets</span>,<span class="_"> </span>which<span class="_"> </span>includes<span class="_ _13"> </span>as<span class="_"> </span>an<span class="_"> </span>argument<span class="_"> </span>a<span class="_"> </span>count<span class="_"> </span>on<span class="_"> </span>the<span class="_ _13"> </span>maximum<span class="_"> </span>number</div><div class="t m5 x1d h26 y2dbd ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>bytes<span class="_"> </span>to<span class="_"> </span>read.<span class="_ _13"> </span>Problem<span class="_"> </span>3.71<span class="_"> </span>asks<span class="_"> </span>you<span class="_"> </span>to<span class="_"> </span>write<span class="_ _13"> </span>an<span class="_"> </span>echo<span class="_"> </span>function<span class="_"> </span>that<span class="_"> </span>can<span class="_"> </span>handle</div><div class="t m5 x1d h26 y2dbe ff7 fs19 fc2 sc0 ls0 ws0">an<span class="_ _14"> </span>input<span class="_ _15"> </span>string<span class="_ _14"> </span>of<span class="_ _15"> </span>arbitrary<span class="_ _14"> </span>length.<span class="_ _15"> </span>In<span class="_ _14"> </span>general,<span class="_ _15"> </span>using<span class="_ _15"> </span><span class="ffd">gets<span class="_ _14"> </span></span>or<span class="_ _15"> </span>any<span class="_ _14"> </span>function<span class="_ _15"> </span>that</div><div class="t m5 x1d h26 y2dbf ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_ _16"> </span>overﬂow<span class="_ _16"> </span>storage<span class="_ _14"> </span>is<span class="_ _16"> </span>considered<span class="_ _16"> </span>a<span class="_ _14"> </span>bad<span class="_ _16"> </span>programming<span class="_ _16"> </span>practice.<span class="_ _16"> </span>Unfortunately<span class="_ _7"></span>,</div><div class="t m5 x1d h26 y2dc0 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _15"> </span>number<span class="_ _15"> </span>of<span class="_ _21"> </span>commonly<span class="_ _15"> </span>used<span class="_ _21"> </span>library<span class="_ _15"> </span>functions<span class="_ _1"></span>,<span class="_ _f"> </span>including<span class="_ _21"> </span><span class="ffd">strcpy</span>,<span class="_ _21"> </span><span class="ffd">strcat</span>,<span class="_ _f"> </span>and</div><div class="t m5 x1d h26 y2dc1 ffd fs19 fc2 sc0 ls0 ws0">sprintf<span class="ff7">,<span class="_"> </span>have<span class="_ _13"> </span>the<span class="_ _13"> </span>property<span class="_"> </span>that<span class="_ _13"> </span>they<span class="_"> </span>can<span class="_ _13"> </span>generate<span class="_ _13"> </span>a<span class="_"> </span>byte<span class="_ _13"> </span>sequence<span class="_"> </span>without<span class="_ _13"> </span>being</span></div><div class="t m5 x1d h26 y2dc2 ff7 fs19 fc2 sc0 ls0 ws0">given<span class="_ _13"> </span>any<span class="_"> </span>indication<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>size<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>destination<span class="_"> </span>buffer<span class="_ _13"> </span>[97].<span class="_"> </span>Such<span class="_ _13"> </span>conditions<span class="_ _13"> </span>can</div><div class="t m5 x1d h26 y2dc3 ff7 fs19 fc2 sc0 ls0 ws0">lead<span class="_"> </span>to<span class="_"> </span>vulnerabilities<span class="_"> </span>to<span class="_"> </span>buffer<span class="_"> </span>overﬂow<span class="_ _3"></span>.</div><div class="t m5 x1d h47 y2dc4 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>3.46<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>382)</span></div><div class="t m5 x1d h26 y2dc5 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>3.41<span class="_"> </span>shows<span class="_ _16"> </span>a<span class="_ _11"> </span>(low-quality)<span class="_ _11"> </span>implementation<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_ _16"> </span>function<span class="_ _11"> </span>that<span class="_ _11"> </span>reads<span class="_ _11"> </span>a<span class="_ _11"> </span>line</div><div class="t m5 x1d h26 y2dc6 ff7 fs19 fc1 sc0 ls0 ws0">from<span class="_ _16"> </span>standard<span class="_ _16"> </span>input,<span class="_ _16"> </span>copies<span class="_ _16"> </span>the<span class="_ _16"> </span>string<span class="_ _16"> </span>to<span class="_ _16"> </span>newly<span class="_ _16"> </span>allocated<span class="_ _14"> </span>storage<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _16"> </span>returns<span class="_ _16"> </span>a</div><div class="t m5 x1d h26 y2dc7 ff7 fs19 fc1 sc0 ls0 ws0">pointer<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>result.</div><div class="t m5 x29 h26 y2dc8 ff7 fs19 fc1 sc0 ls0 ws0">Consider<span class="_ _13"> </span>the<span class="_ _6"> </span>following<span class="_ _13"> </span>scenario<span class="_ _0"></span>.<span class="_ _13"> </span>Procedure<span class="_ _6"> </span><span class="ffd">get_line<span class="_ _13"> </span></span>is<span class="_ _13"> </span>called<span class="_ _13"> </span>with<span class="_ _6"> </span>the<span class="_ _13"> </span>return</div><div class="t m5 x1d h26 y2dc9 ff7 fs19 fc1 sc0 ls0 ws0">address<span class="_"> </span>equal<span class="_ _13"> </span>to<span class="_"> </span><span class="ffd">0x400776<span class="_ _13"> </span></span>and<span class="_"> </span>register<span class="_ _13"> </span><span class="ffd">%rbx<span class="_ _10"> </span></span>equal<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">0x0123456789ABCDEF</span><span class="ls184">.Y<span class="_ _42"></span>o<span class="_ _80"></span>u</span></div><div class="t m5 x1d h26 y2dca ff7 fs19 fc1 sc0 ls0 ws0">type<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>string</div><div class="t m5 x1d h2d y2dcb ffd fs1e fc2 sc0 ls0 ws0">0123456789012345678901234</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
