<div id="pf217" class="pf w2 h11" data-page-no="217"><div class="pc pc217 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg217.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">534<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_"> </span>also<span class="_"> </span>predict<span class="_"> </span>what<span class="_ _11"> </span>operations<span class="_"> </span>will<span class="_"> </span>be<span class="_"> </span>performed<span class="_ _11"> </span>in<span class="_"> </span>parallel<span class="_"> </span>and<span class="_"> </span>how<span class="_ _11"> </span>well<span class="_"> </span>they</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">will<span class="_"> </span>use<span class="_"> </span>the<span class="_"> </span>processor<span class="_"> </span>resources<span class="_ _1"></span>.<span class="_"> </span>As<span class="_"> </span>we<span class="_"> </span>will<span class="_ _11"> </span>see<span class="_ _1"></span>,<span class="_ _11"> </span>we<span class="_"> </span>can<span class="_"> </span>often<span class="_"> </span>determine<span class="_"> </span>the<span class="_"> </span>time</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">(or<span class="_"> </span>at<span class="_ _11"> </span>least<span class="_"> </span>a<span class="_ _11"> </span>lower<span class="_"> </span>bound<span class="_ _11"> </span>on<span class="_"> </span>the<span class="_ _11"> </span>time)<span class="_"> </span>required<span class="_ _11"> </span>to<span class="_"> </span>execute<span class="_ _11"> </span>a<span class="_"> </span>loop<span class="_ _11"> </span>by<span class="_ _11"> </span>identifying</div><div class="t m5 x1d h26 y2f7 ffa fs19 fc2 sc0 ls0 ws0">critical<span class="_ _11"> </span>paths<span class="ff7">,<span class="_ _16"> </span>chains<span class="_ _11"> </span>of<span class="_ _11"> </span>data<span class="_ _11"> </span>dependencies<span class="_ _16"> </span>that<span class="_ _11"> </span>form<span class="_ _11"> </span>during<span class="_ _11"> </span>repeated<span class="_ _16"> </span>executions</span></div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _14"> </span>a<span class="_ _14"> </span>loop<span class="_ _1"></span>.<span class="_ _14"> </span>W<span class="_ _3"></span>e<span class="_ _14"> </span>can<span class="_ _14"> </span>then<span class="_ _14"> </span>go<span class="_ _14"> </span>back<span class="_ _14"> </span>and<span class="_ _14"> </span>modify<span class="_ _14"> </span>the<span class="_ _14"> </span>source<span class="_ _14"> </span>code<span class="_ _14"> </span>to<span class="_ _14"> </span>try<span class="_ _14"> </span>to<span class="_ _14"> </span>steer<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">compiler<span class="_"> </span>toward<span class="_"> </span>more<span class="_"> </span>efﬁcient<span class="_"> </span>implementations<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">Most<span class="_ _11"> </span>major<span class="_ _11"> </span>compilers<span class="_ _1"></span>,<span class="_ _11"> </span>including<span class="_ _11"> </span><span class="ff9">gcc</span>,<span class="_ _11"> </span>are<span class="_ _11"> </span>continually<span class="_ _11"> </span>being<span class="_ _11"> </span>updated<span class="_ _11"> </span>and<span class="_ _11"> </span>im-</div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">proved,<span class="_ _13"> </span>especially<span class="_ _13"> </span>in<span class="_ _13"> </span>terms<span class="_"> </span>of<span class="_ _13"> </span>their<span class="_ _13"> </span>optimization<span class="_ _13"> </span>abilities<span class="_ _3"></span>.<span class="_ _13"> </span>One<span class="_"> </span>useful<span class="_ _13"> </span>strategy<span class="_ _13"> </span>is<span class="_ _13"> </span>to</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">do<span class="_"> </span>only<span class="_"> </span>as<span class="_"> </span>much<span class="_ _13"> </span>rewriting<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>program<span class="_"> </span>as<span class="_"> </span>is<span class="_"> </span>required<span class="_ _13"> </span>to<span class="_"> </span>get<span class="_"> </span>it<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>point<span class="_"> </span>where</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>compiler<span class="_ _16"> </span>can<span class="_ _11"> </span>then<span class="_ _16"> </span>generate<span class="_ _11"> </span>efﬁcient<span class="_ _16"> </span>code<span class="_ _1"></span>.<span class="_ _16"> </span>By<span class="_ _11"> </span>this<span class="_ _16"> </span>means<span class="_ _1"></span>,<span class="_ _16"> </span>we<span class="_ _11"> </span>avoid<span class="_ _16"> </span>compro-</div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">mising<span class="_ _13"> </span>the<span class="_ _13"> </span>readability<span class="_ _7"></span>,<span class="_ _13"> </span>modularity<span class="_ _3"></span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>portability<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>code<span class="_ _13"> </span>as<span class="_ _13"> </span>much<span class="_ _13"> </span>as<span class="_ _13"> </span>if<span class="_ _13"> </span>we<span class="_ _6"> </span>had</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>work<span class="_ _13"> </span>with<span class="_"> </span>a<span class="_ _13"> </span>compiler<span class="_"> </span>of<span class="_ _13"> </span>only<span class="_"> </span>minimal<span class="_ _13"> </span>capabilities<span class="_ _1"></span>.<span class="_"> </span>Again,<span class="_"> </span>it<span class="_ _13"> </span>helps<span class="_"> </span>to<span class="_ _13"> </span>iteratively</div><div class="t m5 x1d h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">modify<span class="_ _13"> </span>the<span class="_"> </span>code<span class="_ _13"> </span>and<span class="_"> </span>analyze<span class="_ _13"> </span>its<span class="_"> </span>performance<span class="_ _13"> </span>both<span class="_"> </span>through<span class="_ _13"> </span>measurements<span class="_"> </span>and<span class="_ _13"> </span>by</div><div class="t m5 x1d h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">examining<span class="_"> </span>the<span class="_"> </span>generated<span class="_"> </span>assembly<span class="_"> </span>code<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _11"> </span>novice<span class="_"> </span>programmers<span class="_ _1"></span>,<span class="_ _11"> </span>it<span class="_ _11"> </span>might<span class="_"> </span>seem<span class="_ _11"> </span>strange<span class="_"> </span>to<span class="_ _11"> </span>keep<span class="_"> </span>modifying<span class="_ _11"> </span>the<span class="_"> </span>source</div><div class="t m5 x1d h26 y451 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _16"> </span>in<span class="_ _16"> </span>an<span class="_ _14"> </span>attempt<span class="_ _16"> </span>to<span class="_ _16"> </span>coax<span class="_ _14"> </span>the<span class="_ _16"> </span>compiler<span class="_ _16"> </span>into<span class="_ _14"> </span>generating<span class="_ _16"> </span>efﬁcient<span class="_ _16"> </span>code,<span class="_ _16"> </span>but<span class="_ _16"> </span>this</div><div class="t m5 x1d h26 y452 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _14"> </span>indeed<span class="_ _14"> </span>how<span class="_ _16"> </span>many<span class="_ _14"> </span>high-performance<span class="_ _14"> </span>programs<span class="_ _14"> </span>are<span class="_ _14"> </span>written.<span class="_ _14"> </span>Compared<span class="_ _14"> </span>to<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y453 ff7 fs19 fc2 sc0 ls0 ws0">alternative<span class="_ _16"> </span>of<span class="_ _16"> </span>writing<span class="_ _16"> </span>code<span class="_ _16"> </span>in<span class="_ _16"> </span>assembly<span class="_ _16"> </span>language<span class="_ _1"></span>,<span class="_ _14"> </span>this<span class="_ _16"> </span>indirect<span class="_ _16"> </span>approach<span class="_ _16"> </span>has<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y454 ff7 fs19 fc2 sc0 ls0 ws0">advantage<span class="_ _11"> </span>that<span class="_ _16"> </span>the<span class="_ _11"> </span>resulting<span class="_ _16"> </span>code<span class="_ _11"> </span>will<span class="_ _16"> </span>still<span class="_ _11"> </span>run<span class="_ _16"> </span>on<span class="_ _11"> </span>other<span class="_ _11"> </span>machines<span class="_ _1"></span>,<span class="_ _16"> </span>although<span class="_ _16"> </span>per<span class="_ _1"></span>-</div><div class="t m5 x1d h26 y455 ff7 fs19 fc2 sc0 ls0 ws0">haps<span class="_"> </span>not<span class="_"> </span>with<span class="_"> </span>peak<span class="_"> </span>performance<span class="_ _1"></span>.</div><div class="t m5 x1d h3b y4982 fff fs24 fc6 sc0 ls0 ws0">5.1<span class="_ _17"> </span><span class="ffe fs18">Capabilities<span class="_"> </span>and<span class="_"> </span>Limitations<span class="_"> </span>of<span class="_"> </span>Optimizing<span class="_"> </span>Compilers</span></div><div class="t m5 x1d h26 y2e8d ff7 fs19 fc1 sc0 ls0 ws0">Modern<span class="_ _13"> </span>compilers<span class="_"> </span>employ<span class="_ _13"> </span>sophisticated<span class="_"> </span>algorithms<span class="_ _13"> </span>to<span class="_"> </span>determine<span class="_ _13"> </span>what<span class="_"> </span>values<span class="_ _13"> </span>are</div><div class="t m5 x1d h26 y4983 ff7 fs19 fc1 sc0 ls0 ws0">computed<span class="_"> </span>in<span class="_"> </span>a<span class="_ _13"> </span>program<span class="_"> </span>and<span class="_"> </span>how<span class="_"> </span>they<span class="_"> </span>are<span class="_"> </span>used.<span class="_ _13"> </span>They<span class="_ _13"> </span>can<span class="_"> </span>then<span class="_"> </span>exploit<span class="_"> </span>opportuni-</div><div class="t m5 x1d h26 y4984 ff7 fs19 fc1 sc0 ls0 ws0">ties<span class="_ _13"> </span>to<span class="_ _13"> </span>simplify<span class="_ _13"> </span>expressions<span class="_ _1"></span>,<span class="_ _13"> </span>to<span class="_ _13"> </span>use<span class="_ _13"> </span>a<span class="_ _13"> </span>single<span class="_ _13"> </span>computation<span class="_ _13"> </span>in<span class="_ _13"> </span>several<span class="_ _13"> </span>different<span class="_ _13"> </span>places<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y4985 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _13"> </span>to<span class="_"> </span>reduce<span class="_ _13"> </span>the<span class="_ _13"> </span>number<span class="_ _13"> </span>of<span class="_"> </span>times<span class="_ _13"> </span>a<span class="_ _13"> </span>given<span class="_ _13"> </span>computation<span class="_"> </span>must<span class="_ _13"> </span>be<span class="_ _13"> </span>performed.<span class="_ _13"> </span>Most</div><div class="t m5 x1d h26 y4986 ff7 fs19 fc1 sc0 ls0 ws0">compilers<span class="_ _1"></span>,<span class="_ _16"> </span>including<span class="_ _16"> </span><span class="ff9">gcc</span>,<span class="_ _16"> </span>provide<span class="_ _16"> </span>users<span class="_ _16"> </span>with<span class="_ _16"> </span>some<span class="_ _16"> </span>control<span class="_ _11"> </span>over<span class="_ _16"> </span>which<span class="_ _16"> </span>optimiza-</div><div class="t m5 x1d h26 y4987 ff7 fs19 fc1 sc0 ls0 ws0">tions<span class="_"> </span>they<span class="_ _11"> </span>apply<span class="_ _3"></span>.<span class="_ _11"> </span>As<span class="_ _11"> </span>discussed<span class="_ _11"> </span>in<span class="_ _11"> </span>Chapter<span class="_"> </span>3,<span class="_ _16"> </span>the<span class="_"> </span>simplest<span class="_ _11"> </span>control<span class="_ _11"> </span>is<span class="_ _11"> </span>to<span class="_"> </span>specify<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y4988 ffa fs19 fc1 sc0 ls0 ws0">optimization<span class="_"> </span>level<span class="_ _2"></span><span class="ff7">.<span class="_"> </span>F<span class="_ _1"></span>or<span class="_"> </span>example<span class="_ _0"></span>,<span class="_"> </span>invoking<span class="_"> </span><span class="ff9">gcc<span class="_ _10"> </span></span>with<span class="_"> </span>the<span class="_"> </span>command-line<span class="_"> </span>option<span class="_"> </span><span class="ffd">-Og</span></span></div><div class="t m5 x1d h26 y4989 ff7 fs19 fc1 sc0 ls0 ws0">speciﬁes<span class="_"> </span>that<span class="_"> </span>it<span class="_"> </span>should<span class="_"> </span>apply<span class="_"> </span>a<span class="_"> </span>basic<span class="_"> </span>set<span class="_"> </span>of<span class="_"> </span>optimizations<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y498a ff7 fs19 fc1 sc0 ls0 ws0">Invoking<span class="_ _13"> </span><span class="ff9">gcc<span class="_ _13"> </span></span>with<span class="_ _13"> </span>option<span class="_"> </span><span class="ffd">-O1<span class="_ _13"> </span></span>or<span class="_ _13"> </span>higher<span class="_ _13"> </span>(e<span class="_ _0"></span>.g.,<span class="_ _13"> </span><span class="ffd">-O2<span class="_ _13"> </span></span>or<span class="_ _13"> </span><span class="ffd">-O3</span>)<span class="_ _13"> </span>will<span class="_"> </span>cause<span class="_ _13"> </span>it<span class="_ _13"> </span>to<span class="_ _13"> </span>apply</div><div class="t m5 x1d h26 y498b ff7 fs19 fc1 sc0 ls0 ws0">more<span class="_"> </span>extensive<span class="_ _11"> </span>optimizations<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _0"></span>hese<span class="_"> </span>can<span class="_ _11"> </span>further<span class="_ _11"> </span>improve<span class="_"> </span>program<span class="_ _11"> </span>performance,</div><div class="t m5 x1d h26 y498c ff7 fs19 fc1 sc0 ls0 ws0">but<span class="_ _14"> </span>they<span class="_ _14"> </span>may<span class="_ _15"> </span>expand<span class="_ _14"> </span>the<span class="_ _15"> </span>program<span class="_ _14"> </span>size<span class="_ _14"> </span>and<span class="_ _15"> </span>they<span class="_ _14"> </span>may<span class="_ _14"> </span>make<span class="_ _15"> </span>the<span class="_ _14"> </span>program<span class="_ _15"> </span>more</div><div class="t m5 x1d h26 y498d ff7 fs19 fc1 sc0 ls0 ws0">difﬁcult<span class="_ _16"> </span>to<span class="_ _16"> </span>debug<span class="_ _16"> </span>using<span class="_ _14"> </span>standard<span class="_ _16"> </span>debugging<span class="_ _16"> </span>tools<span class="_ _1"></span>.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>our<span class="_ _16"> </span>presentation,<span class="_ _14"> </span>we<span class="_ _16"> </span>will</div><div class="t m5 x1d h26 y498e ff7 fs19 fc1 sc0 ls0 ws0">mostly<span class="_ _15"> </span>consider<span class="_ _14"> </span>code<span class="_ _15"> </span>compiled<span class="_ _15"> </span>with<span class="_ _15"> </span>optimization<span class="_ _15"> </span>level<span class="_ _15"> </span><span class="ffd">-O1</span>,<span class="_ _21"> </span>even<span class="_ _15"> </span>though<span class="_ _15"> </span>level</div><div class="t m5 x1d h26 y498f ffd fs19 fc1 sc0 ls0 ws0">-O2<span class="_ _16"> </span><span class="ff7">has<span class="_ _16"> </span>become<span class="_ _16"> </span>the<span class="_ _14"> </span>accepted<span class="_ _16"> </span>standard<span class="_ _16"> </span>for<span class="_ _16"> </span>most<span class="_ _14"> </span>software<span class="_ _16"> </span>projects<span class="_ _16"> </span>that<span class="_ _16"> </span>use<span class="_ _16"> </span><span class="ff9">gcc</span>.</span></div><div class="t m5 x1d h26 y4990 ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _16"> </span>purposely<span class="_ _11"> </span>limit<span class="_ _11"> </span>the<span class="_ _16"> </span>level<span class="_ _11"> </span>of<span class="_ _11"> </span>optimization<span class="_ _16"> </span>to<span class="_ _11"> </span>demonstrate<span class="_ _16"> </span>how<span class="_ _11"> </span>different<span class="_ _11"> </span>ways</div><div class="t m5 x1d h26 y4991 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _14"> </span>writing<span class="_ _15"> </span>a<span class="_ _15"> </span>function<span class="_ _15"> </span>in<span class="_ _15"> </span>C<span class="_ _15"> </span>can<span class="_ _14"> </span>affect<span class="_ _15"> </span>the<span class="_ _15"> </span>efﬁciency<span class="_ _14"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>code<span class="_ _15"> </span>generated<span class="_ _14"> </span>by<span class="_ _15"> </span>a</div><div class="t m5 x1d h26 y4992 ff7 fs19 fc1 sc0 ls0 ws0">compiler.<span class="_ _16"> </span>W<span class="_ _1"></span>e<span class="_ _14"> </span>will<span class="_ _14"> </span>ﬁnd<span class="_ _14"> </span>that<span class="_ _14"> </span>we<span class="_ _14"> </span>can<span class="_ _14"> </span>write<span class="_ _14"> </span>C<span class="_ _14"> </span>code<span class="_ _14"> </span>that,<span class="_ _15"> </span>when<span class="_ _14"> </span>compiled<span class="_ _14"> </span>just<span class="_ _14"> </span>with</div><div class="t m5 x1d h26 y4993 ff7 fs19 fc1 sc0 ls0 ws0">option<span class="_ _16"> </span><span class="ffd">-O1</span>,<span class="_ _14"> </span>vastly<span class="_ _16"> </span>outperforms<span class="_ _16"> </span>a<span class="_ _14"> </span>more<span class="_ _16"> </span>naive<span class="_ _16"> </span>version<span class="_ _14"> </span>compiled<span class="_ _16"> </span>with<span class="_ _16"> </span>the<span class="_ _14"> </span>highest</div><div class="t m5 x1d h26 y4994 ff7 fs19 fc1 sc0 ls0 ws0">possible<span class="_"> </span>optimization<span class="_"> </span>levels<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y4995 ff7 fs19 fc1 sc0 ls0 ws0">Compilers<span class="_ _15"> </span>must<span class="_ _15"> </span>be<span class="_ _21"> </span>careful<span class="_ _15"> </span>to<span class="_ _21"> </span>apply<span class="_ _15"> </span>only<span class="_ _21"> </span><span class="ffa">safe<span class="_ _15"> </span></span>optimizations<span class="_ _21"> </span>to<span class="_ _15"> </span>a<span class="_ _15"> </span>program,</div><div class="t m5 x1d h26 y4996 ff7 fs19 fc1 sc0 ls0 ws0">meaning<span class="_ _11"> </span>that<span class="_ _16"> </span>the<span class="_ _16"> </span>resulting<span class="_ _11"> </span>program<span class="_ _16"> </span>will<span class="_ _11"> </span>have<span class="_ _16"> </span>the<span class="_ _11"> </span>exact<span class="_ _16"> </span>same<span class="_ _11"> </span>behavior<span class="_ _16"> </span>as<span class="_ _16"> </span>would</div><div class="t m5 x1d h26 y4997 ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_ _11"> </span>unoptimized<span class="_ _16"> </span>version<span class="_ _11"> </span>for<span class="_ _11"> </span>all<span class="_ _16"> </span>possible<span class="_ _11"> </span>cases<span class="_ _16"> </span>the<span class="_ _11"> </span>program<span class="_ _11"> </span>may<span class="_ _16"> </span>encounter<span class="_ _0"></span>,<span class="_ _16"> </span>up<span class="_ _11"> </span>to</div><div class="t m5 x1d h26 y4998 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>limits<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>guarantees<span class="_ _16"> </span>provided<span class="_"> </span>by<span class="_ _16"> </span>the<span class="_"> </span>C<span class="_ _16"> </span>language<span class="_"> </span>standards<span class="_ _1"></span>.<span class="_ _16"> </span>Constraining</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
