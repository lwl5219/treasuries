<div id="pf119" class="pf w2 h11" data-page-no="119"><div class="pc pc119 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg119.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">280<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1d h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">demonstrate<span class="_ _14"> </span>the<span class="_ _15"> </span>important<span class="_ _15"> </span>role<span class="_ _14"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>run-time<span class="_ _14"> </span>stack<span class="_ _15"> </span>in<span class="_ _15"> </span>managing<span class="_ _14"> </span>the<span class="_ _15"> </span>storage</div><div class="t m5 x1d h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">needed<span class="_"> </span>to<span class="_"> </span>support<span class="_"> </span>procedure<span class="_"> </span>calls<span class="_"> </span>and<span class="_"> </span>returns<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y40a ff7 fs19 fc2 sc0 ls0 ws0">Instruction<span class="_ _13"> </span><span class="ffd">L1<span class="_ _13"> </span></span>of<span class="_ _13"> </span><span class="ffd">leaf<span class="_ _13"> </span></span>sets<span class="_ _13"> </span><span class="ffd">%rax<span class="_ _13"> </span></span>to<span class="_ _13"> </span>97,<span class="_ _13"> </span>the<span class="_ _13"> </span>value<span class="_ _13"> </span>to<span class="_ _13"> </span>be<span class="_ _13"> </span>returned.<span class="_ _13"> </span>Instruction<span class="_ _13"> </span><span class="ffd">L2</span></div><div class="t m5 x1d h26 y40b ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_"> </span>returns<span class="_ _1"></span>.<span class="_ _11"> </span>It<span class="_ _11"> </span>pops<span class="_ _11"> </span><span class="ffd">0x400054e<span class="_ _11"> </span></span>from<span class="_"> </span>the<span class="_ _11"> </span>stack.<span class="_ _11"> </span>In<span class="_ _11"> </span>setting<span class="_ _11"> </span>the<span class="_"> </span>PC<span class="_ _11"> </span>to<span class="_ _11"> </span>this<span class="_ _11"> </span>popped</div><div class="t m5 x1d h26 y40c ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_ _1"></span>,<span class="_ _13"> </span>control<span class="_ _13"> </span>transfers<span class="_ _6"> </span>back<span class="_ _6"> </span>to<span class="_ _13"> </span>instruction<span class="_ _6"> </span><span class="ffd">T3<span class="_ _13"> </span></span>of<span class="_ _6"> </span><span class="ffd">top</span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _6"> </span>program<span class="_ _13"> </span>has<span class="_ _6"> </span>successfully</div><div class="t m5 x1d h26 y40d ff7 fs19 fc2 sc0 ls0 ws0">completed<span class="_"> </span>the<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">leaf<span class="_ _10"> </span></span>and<span class="_"> </span>returned<span class="_"> </span>to<span class="_"> </span><span class="ffd">top</span>.</div><div class="t m5 x29 h26 y40e ff7 fs19 fc2 sc0 ls0 ws0">Instruction<span class="_ _13"> </span><span class="ffd">T3<span class="_ _13"> </span></span>sets<span class="_ _13"> </span><span class="ffd">%rax<span class="_ _13"> </span></span>to<span class="_ _13"> </span>194,<span class="_"> </span>the<span class="_ _13"> </span>value<span class="_ _13"> </span>to<span class="_ _13"> </span>be<span class="_ _13"> </span>returned<span class="_ _13"> </span>from<span class="_ _13"> </span><span class="ffd">top</span>.<span class="_ _13"> </span>Instruction</div><div class="t m5 x1d h26 y40f ffd fs19 fc2 sc0 ls0 ws0">T4<span class="_ _15"> </span><span class="ff7">then<span class="_ _21"> </span>returns<span class="_ _1"></span>.<span class="_ _21"> </span>It<span class="_ _21"> </span>pops<span class="_ _21"> </span><span class="ffd">0x4000560<span class="_ _21"> </span></span>from<span class="_ _21"> </span>the<span class="_ _15"> </span>stack,<span class="_ _e"> </span>thereby<span class="_ _15"> </span>setting<span class="_ _21"> </span>the<span class="_ _15"> </span>PC<span class="_ _21"> </span>to</span></div><div class="t m5 x1d h26 y410 ff7 fs19 fc2 sc0 ls0 ws0">instruction<span class="_ _16"> </span><span class="ffd">M2<span class="_ _14"> </span></span>of<span class="_ _14"> </span><span class="ffd">main</span>.<span class="_ _16"> </span>The<span class="_ _16"> </span>program<span class="_ _14"> </span>has<span class="_ _16"> </span>successfully<span class="_ _14"> </span>completed<span class="_ _14"> </span>the<span class="_ _16"> </span>call<span class="_ _14"> </span>to<span class="_ _14"> </span><span class="ffd">top</span></div><div class="t m5 x1d h26 y411 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _14"> </span>returned<span class="_ _15"> </span>to<span class="_ _14"> </span><span class="ffd">main</span>.<span class="_ _15"> </span>W<span class="_ _3"></span>e<span class="_ _15"> </span>see<span class="_ _15"> </span>that<span class="_ _14"> </span>the<span class="_ _15"> </span>stack<span class="_ _14"> </span>pointer<span class="_ _15"> </span>has<span class="_ _14"> </span>also<span class="_ _15"> </span>been<span class="_ _15"> </span>restored<span class="_ _14"> </span>to</div><div class="t m5 x1d h26 y412 ffd fs19 fc2 sc0 ls0 ws0">0x7fffffffe820<span class="ff7">,<span class="_"> </span>the<span class="_"> </span>value<span class="_"> </span>it<span class="_"> </span>had<span class="_"> </span>before<span class="_"> </span>the<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span></span>top<span class="ff7">.</span></div><div class="t m5 x29 h26 y413 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _14"> </span>can<span class="_ _16"> </span>see<span class="_ _14"> </span>that<span class="_ _14"> </span>this<span class="_ _16"> </span>simple<span class="_ _14"> </span>mechanism<span class="_ _14"> </span>of<span class="_ _16"> </span>pushing<span class="_ _14"> </span>the<span class="_ _16"> </span>return<span class="_ _14"> </span>address<span class="_ _14"> </span>onto</div><div class="t m5 x1d h26 y414 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>stack<span class="_ _14"> </span>makes<span class="_ _14"> </span>it<span class="_ _14"> </span>possible<span class="_ _15"> </span>for<span class="_ _14"> </span>the<span class="_ _14"> </span>function<span class="_ _14"> </span>to<span class="_ _14"> </span>later<span class="_ _14"> </span>return<span class="_ _15"> </span>to<span class="_ _14"> </span>the<span class="_ _14"> </span>proper<span class="_ _14"> </span>point</div><div class="t m5 x1d h26 y415 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_"> </span>the<span class="_"> </span>program.<span class="_"> </span>The<span class="_"> </span>standard<span class="_"> </span>call/return<span class="_"> </span>mechanism<span class="_"> </span>of<span class="_"> </span>C<span class="_"> </span>(and<span class="_ _11"> </span>of<span class="_"> </span>most<span class="_"> </span>program-</div><div class="t m5 x1d h26 y416 ff7 fs19 fc2 sc0 ls0 ws0">ming<span class="_"> </span>languages)<span class="_ _13"> </span>conveniently<span class="_"> </span>matches<span class="_"> </span>the<span class="_"> </span>last-in,<span class="_ _13"> </span>Ô¨Årst-out<span class="_"> </span>memory<span class="_"> </span>management</div><div class="t m5 x1d h26 y434 ff7 fs19 fc2 sc0 ls0 ws0">discipline<span class="_"> </span>provided<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>stack.</div><div class="t m5 x1d h47 y2974 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>3.32<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>375)</span></div><div class="t m5 x1d h26 y2975 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>disassembled<span class="_ _11"> </span>code<span class="_ _11"> </span>for<span class="_ _16"> </span>two<span class="_ _11"> </span>functions<span class="_ _16"> </span><span class="ffd">first<span class="_ _11"> </span></span>and<span class="_ _11"> </span><span class="ffd">last<span class="_ _16"> </span></span>is<span class="_ _11"> </span>shown<span class="_ _16"> </span>below<span class="_ _7"></span>,<span class="_ _16"> </span>along</div><div class="t m5 x1d h26 y2976 ff7 fs19 fc1 sc0 ls0 ws0">with<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span>a<span class="_"> </span>call<span class="_"> </span>of<span class="_"> </span><span class="ffd">first<span class="_ _10"> </span></span>by<span class="_"> </span>function<span class="_"> </span><span class="ffd">main</span>:</div><div class="t m5 x26 h61 y2977 ff13 fs35 fc6 sc0 ls0 ws0">Disassembly<span class="_ _f"> </span>of<span class="_ _f"> </span>last(long<span class="_ _f"> </span>u,<span class="_ _e"> </span>long<span class="_ _21"> </span>v)</div><div class="t m5 x26 h61 y2978 ff13 fs35 fc6 sc0 ls0 ws0">u<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>v<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi</div><div class="t m5 xcb h2d y2979 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">0000000000400540<span class="_ _1f"> </span>&lt;last&gt;:</span></div><div class="t m5 xcb h2d y297a ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">400540:<span class="_ _1a"> </span>48<span class="_ _e"> </span>89<span class="_ _1f"> </span>f8<span class="_ _12a"> </span>mov<span class="_ _7b"> </span>%rdi,%rax<span class="_ _5d"> </span></span><span class="ff13 fs35">L1:<span class="_ _f"> </span>u</span></div><div class="t m5 xcb h2d y297b ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">400543:<span class="_ _1a"> </span>48<span class="_ _e"> </span>0f<span class="_ _1f"> </span>af<span class="_ _1f"> </span>c6<span class="_ _35"> </span>imul<span class="_ _3f"> </span>%rsi,%rax<span class="_ _5d"> </span></span><span class="ff13 fs35">L2:<span class="_ _21"> </span>u*v</span></div><div class="t m5 xcb h2d y297c ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">400547:<span class="_ _1a"> </span>c3<span class="_ _129"> </span>retq<span class="_ _12c"> </span></span><span class="ff13 fs35">L3:<span class="_ _21"> </span>Return</span></div><div class="t m5 x26 h61 y297d ff13 fs35 fc6 sc0 ls0 ws0">Disassembly<span class="_ _f"> </span>of<span class="_ _f"> </span>last(long<span class="_ _f"> </span>x)</div><div class="t m5 x26 h61 y297e ff13 fs35 fc6 sc0 ls0 ws0">x<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi</div><div class="t m5 xcb h2d y297f ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs1e fc2">0000000000400548<span class="_ _1f"> </span>&lt;first&gt;:</span></div><div class="t m5 xcb h2d y2980 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">400548:<span class="_ _1a"> </span>48<span class="_ _e"> </span>8d<span class="_ _1f"> </span>77<span class="_ _1f"> </span>01<span class="_ _35"> </span>lea<span class="_ _46"> </span>0x1(%rdi),%rsi<span class="_ _95"> </span></span><span class="ff13 fs35">F1:<span class="_ _f"> </span>x+1</span></div><div class="t m5 xcb h2e y2981 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x2e h2d y2982 ffd fs1e fc2 sc0 ls0 ws0">40054c:<span class="_ _1a"> </span>48<span class="_ _e"> </span>83<span class="_ _1f"> </span>ef<span class="_ _1f"> </span>01<span class="_ _35"> </span>sub<span class="_ _46"> </span>$0x1,%rdi<span class="_ _5d"> </span><span class="ff13 fs35 fc6">F2:<span class="_ _21"> </span>x-1</span></div><div class="t m5 xcb h2d y2983 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">400550:<span class="_ _1a"> </span>e8<span class="_ _e"> </span>eb<span class="_ _1f"> </span>ff<span class="_ _1f"> </span>ff<span class="_ _e"> </span>ff<span class="_ _86"> </span>callq<span class="_ _1a"> </span>400540<span class="_ _1f"> </span>&lt;last&gt;<span class="_ _74"> </span></span><span class="ff13 fs35">F3:<span class="_ _f"> </span>Call<span class="_ _f"> </span>last(x-1,x+1)</span></div><div class="t m5 xcb h2d y2984 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _45"> </span><span class="ffd fs1e fc2">400555:<span class="_ _1a"> </span>f3<span class="_ _e"> </span>c3<span class="_ _104"> </span>repz<span class="_ _e"> </span>retq<span class="_ _165"> </span></span><span class="ff13 fs35">F4:<span class="_ _f"> </span>Return</span></div><div class="t m5 x2d h2d y2985 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x2d h2d y2986 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x2d h2d y2987 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 xc7 h2d y2988 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _45"> </span><span class="ffd fs1e fc2">400560:<span class="_ _1a"> </span>e8<span class="_ _e"> </span>e3<span class="_ _1f"> </span>ff<span class="_ _1f"> </span>ff<span class="_ _e"> </span>ff<span class="_ _86"> </span>callq<span class="_ _1a"> </span>400548<span class="_ _1f"> </span>&lt;first&gt;<span class="_ _95"> </span></span><span class="ff13 fs35">M1:<span class="_ _f"> </span>Call<span class="_ _f"> </span>first(10)</span></div><div class="t m5 xc7 h2d y2989 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _45"> </span><span class="ffd fs1e fc2">400565:<span class="_ _1a"> </span>48<span class="_ _e"> </span>89<span class="_ _1f"> </span>c2<span class="_ _12a"> </span>mov<span class="_ _7b"> </span>%rax,%rdx<span class="_ _5d"> </span></span><span class="ff13 fs35">M2:<span class="_ _f"> </span>Resume</span></div><div class="t m5 x29 h26 y13c0 ff7 fs19 fc2 sc0 ls0 ws0">Each<span class="_ _11"> </span>of<span class="_ _11"> </span>these<span class="_ _11"> </span>instructions<span class="_ _11"> </span>is<span class="_ _11"> </span>given<span class="_ _11"> </span>a<span class="_ _11"> </span>label,<span class="_ _11"> </span>similar<span class="_ _11"> </span>to<span class="_ _11"> </span>those<span class="_ _11"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>3.27(a).</div><div class="t m5 x1d h26 y13c1 ff7 fs19 fc2 sc0 ls0 ws0">Starting<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span>calling<span class="_ _11"> </span>of<span class="_"> </span><span class="ffd">first(10)<span class="_ _10"> </span></span>by<span class="_ _11"> </span><span class="ffd">main</span>,<span class="_"> </span>Ô¨Åll<span class="_"> </span>in<span class="_ _11"> </span>the<span class="_"> </span>following<span class="_"> </span>table<span class="_ _11"> </span>to<span class="_"> </span>trace</div><div class="t m5 x1d h26 y13c2 ff7 fs19 fc2 sc0 ls0 ws0">instruction<span class="_ _14"> </span>execution<span class="_ _15"> </span>through<span class="_ _15"> </span>to<span class="_ _15"> </span>the<span class="_ _15"> </span>point<span class="_ _15"> </span>where<span class="_ _15"> </span>the<span class="_ _14"> </span>program<span class="_ _15"> </span>returns<span class="_ _15"> </span>back<span class="_ _15"> </span>to</div><div class="t m5 x1d h26 y13c3 ffd fs19 fc2 sc0 ls0 ws0">main<span class="ff7">.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
