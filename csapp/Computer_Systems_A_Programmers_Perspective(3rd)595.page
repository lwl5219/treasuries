<div id="pf253" class="pf w2 h11" data-page-no="253"><div class="pc pc253 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg253.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">594<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x14 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>5.35</div><div class="t m5 x14 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Graphical<span class="_"> </span>representation</div><div class="t m5 x14 h2f y58b ffe fs16 fc1 sc0 ls0 ws0">of<span class="_ _15"> </span>inner-loop<span class="_ _15"> </span>code</div><div class="t m5 x14 h2f y58c ffe fs16 fc1 sc0 ls0 ws0">for</div><div class="t m5 xc7 h3a y2d53 ffd fs19 fc1 sc0 ls0 ws0">write_read<span class="ffe fs16">.<span class="_ _14"> </span><span class="ff6">The</span></span></div><div class="t m5 x14 h34 y2d7c ff6 fs16 fc1 sc0 ls0 ws0">ﬁrst</div><div class="t m5 x56 h3a y1323 ffd fs19 fc1 sc0 ls0 ws0">movl<span class="_ _16"> </span><span class="ff6 fs16">instruction<span class="_ _16"> </span>is</span></div><div class="t m5 x14 h34 y1324 ff6 fs16 fc1 sc0 ls0 ws0">decoded<span class="_ _16"> </span>into<span class="_ _14"> </span>separate</div><div class="t m5 x14 h34 y1325 ff6 fs16 fc1 sc0 ls0 ws0">operations<span class="_ _10"> </span>to<span class="_ _11"> </span>compute<span class="_ _10"> </span>the</div><div class="t m5 x14 h34 y1326 ff6 fs16 fc1 sc0 ls0 ws0">store<span class="_ _11"> </span>address<span class="_ _11"> </span>and<span class="_ _11"> </span>to<span class="_ _11"> </span>store</div><div class="t m5 x14 h34 y2ed2 ff6 fs16 fc1 sc0 ls0 ws0">the<span class="_ _10"> </span>data<span class="_ _11"> </span>to<span class="_ _10"> </span>memory<span class="_ _1"></span>.</div><div class="t m5 x18e h40 y5020 ff71 fs28 fc1 sc0 ls0 ws0">%rax<span class="_ _ea"> </span>%rdi<span class="_ _13d"> </span>%rsi<span class="_ _13d"> </span>%rdx</div><div class="t m5 x22f h40 y5021 ff71 fs28 fc1 sc0 ls0 ws0">movq %rax,(%rsi)</div><div class="t m5 x22f h40 y5022 ff71 fs28 fc1 sc0 ls0 ws0">movq (%rdi),%rax</div><div class="t m5 x22f h40 y5023 ff71 fs28 fc1 sc0 ls0 ws0">addq $1,%rax</div><div class="t m5 x22f h40 y5024 ff71 fs28 fc1 sc0 ls0 ws0">subq $1,%rdx</div><div class="t m5 x22f h40 y5025 ff71 fs28 fc1 sc0 ls0 ws0">jne loop </div><div class="t m5 x18e h40 y5026 ff71 fs28 fc1 sc0 ls0 ws0">%rax<span class="_ _ea"> </span>%rdi<span class="_ _13d"> </span>%rsi<span class="_ _13d"> </span>%rdx</div><div class="t m5 x40 h3f y5027 ff72 fs27 fc1 sc0 ls214 ws0">s_addr</div><div class="t m5 x40 h3f y5028 ff72 fs27 fc1 sc0 ls214 ws0">s_data</div><div class="t m5 x120 h3f y5029 ff72 fs27 fc1 sc0 ls214 ws0">load</div><div class="t m5 x82 h3f y502a ff72 fs27 fc1 sc0 ls214 ws0">add</div><div class="t m5 x82 h3f y502b ff72 fs27 fc1 sc0 ls214 ws0">sub</div><div class="t m5 x1e2 h3f y502c ff72 fs27 fc1 sc0 ls214 ws0">jne</div><div class="t m5 x1d h26 y502d ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>5.35<span class="_ _14"> </span>shows<span class="_ _14"> </span>a<span class="_ _14"> </span>data-ﬂow<span class="_ _14"> </span>representation<span class="_ _16"> </span>of<span class="_ _14"> </span>this<span class="_ _14"> </span>loop<span class="_ _14"> </span>code<span class="_ _0"></span>.<span class="_ _16"> </span>The<span class="_ _16"> </span>instruction</div><div class="t m5 x1d h26 y502e ffd fs19 fc1 sc0 ls0 ws0">movq<span class="_ _11"> </span>%rax,(%rsi)<span class="_ _10"> </span><span class="ff7">is<span class="_ _13"> </span>translated<span class="_"> </span>into<span class="_ _13"> </span>two<span class="_"> </span>operations:<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_"> </span><span class="ff6">s_addr<span class="_ _13"> </span></span>instruction<span class="_"> </span>com-</span></div><div class="t m5 x1d h26 y502f ff7 fs19 fc1 sc0 ls0 ws0">putes<span class="_"> </span>the<span class="_ _13"> </span>address<span class="_"> </span>for<span class="_ _13"> </span>the<span class="_"> </span>store<span class="_ _13"> </span>operation,<span class="_"> </span>creates<span class="_"> </span>an<span class="_ _13"> </span>entry<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>store<span class="_ _13"> </span>buffer,<span class="_"> </span>and</div><div class="t m5 x1d h26 y5030 ff7 fs19 fc1 sc0 ls0 ws0">sets<span class="_ _13"> </span>the<span class="_ _13"> </span>address<span class="_ _13"> </span>ﬁeld<span class="_ _13"> </span>for<span class="_ _13"> </span>that<span class="_ _13"> </span>entry<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span><span class="ff6">s_data<span class="_ _13"> </span></span>operation<span class="_ _13"> </span>sets<span class="_ _13"> </span>the<span class="_ _13"> </span>data<span class="_"> </span>ﬁeld<span class="_ _13"> </span>for<span class="_ _13"> </span>the</div><div class="t m5 x1d h26 y5031 ff7 fs19 fc1 sc0 ls0 ws0">entry<span class="_ _3"></span>.<span class="_ _16"> </span>As<span class="_ _11"> </span>we<span class="_ _16"> </span>will<span class="_ _16"> </span>see<span class="_ _0"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>fact<span class="_ _16"> </span>that<span class="_ _16"> </span>these<span class="_ _16"> </span>two<span class="_ _11"> </span>computations<span class="_ _16"> </span>are<span class="_ _16"> </span>performed<span class="_ _16"> </span>inde-</div><div class="t m5 x1d h26 y5032 ff7 fs19 fc1 sc0 ls0 ws0">pendently<span class="_ _13"> </span>can<span class="_ _13"> </span>be<span class="_ _13"> </span>important<span class="_"> </span>to<span class="_ _13"> </span>program<span class="_ _13"> </span>performance<span class="_ _1"></span>.<span class="_ _13"> </span>This<span class="_ _13"> </span>motivates<span class="_ _13"> </span>the<span class="_ _13"> </span>separate</div><div class="t m5 x1d h26 y5033 ff7 fs19 fc1 sc0 ls0 ws0">functional<span class="_"> </span>units<span class="_"> </span>for<span class="_"> </span>these<span class="_"> </span>operations<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>reference<span class="_"> </span>machine<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y5034 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _16"> </span>addition<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>data<span class="_ _11"> </span>dependencies<span class="_ _16"> </span>between<span class="_ _11"> </span>the<span class="_ _16"> </span>operations<span class="_ _16"> </span>caused<span class="_ _11"> </span>by<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y5035 ff7 fs19 fc1 sc0 ls0 ws0">writing<span class="_ _15"> </span>and<span class="_ _15"> </span>reading<span class="_ _15"> </span>of<span class="_ _21"> </span>registers<span class="_ _1"></span>,<span class="_ _21"> </span>the<span class="_ _15"> </span>arcs<span class="_ _21"> </span>on<span class="_ _15"> </span>the<span class="_ _15"> </span>right<span class="_ _21"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>operators<span class="_ _15"> </span>denote</div><div class="t m5 x1d h26 y5036 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _21"> </span>set<span class="_ _f"> </span>of<span class="_ _21"> </span>implicit<span class="_ _f"> </span>dependencies<span class="_ _21"> </span>for<span class="_ _f"> </span>these<span class="_ _21"> </span>operations<span class="_ _1"></span>.<span class="_ _f"> </span>In<span class="_ _21"> </span>particular,<span class="_ _e"> </span>the<span class="_ _15"> </span>address</div><div class="t m5 x1d h26 y5037 ff7 fs19 fc1 sc0 ls0 ws0">computation<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ff6">s_addr<span class="_ _6"> </span></span>operation<span class="_ _6"> </span>must<span class="_ _6"> </span>clearly<span class="_ _13"> </span>precede<span class="_ _6"> </span>the<span class="_ _6"> </span><span class="ff6">s_data<span class="_ _6"> </span></span>operation.<span class="_ _13"> </span>In</div><div class="t m5 x1d h26 y5038 ff7 fs19 fc1 sc0 ls0 ws0">addition,<span class="_ _13"> </span>the<span class="_"> </span><span class="ff6">load<span class="_ _13"> </span></span>operation<span class="_ _13"> </span>generated<span class="_"> </span>by<span class="_ _13"> </span>decoding<span class="_ _13"> </span>the<span class="_"> </span>instruction<span class="_ _13"> </span><span class="ffd">movq<span class="_ _11"> </span>(%rdi),</span></div><div class="t m5 x1d h26 y5039 ffd fs19 fc1 sc0 ls0 ws0">%rax<span class="_ _16"> </span><span class="ff7">must<span class="_ _16"> </span>check<span class="_ _11"> </span>the<span class="_ _16"> </span>addresses<span class="_ _16"> </span>of<span class="_ _16"> </span>any<span class="_ _16"> </span>pending<span class="_ _16"> </span>store<span class="_ _11"> </span>operations<span class="_ _0"></span>,<span class="_ _16"> </span>creating<span class="_ _16"> </span>a<span class="_ _16"> </span>data</span></div><div class="t m5 x1d h26 y503a ff7 fs19 fc1 sc0 ls0 ws0">dependency<span class="_"> </span>between<span class="_"> </span>it<span class="_ _11"> </span>and<span class="_ _11"> </span>the<span class="_"> </span><span class="ff6">s_addr<span class="_ _11"> </span></span>operation.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_"> </span>ﬁgure<span class="_ _11"> </span>shows<span class="_ _11"> </span>a<span class="_"> </span>dashed<span class="_ _11"> </span>arc</div><div class="t m5 x1d h26 y503b ff7 fs19 fc1 sc0 ls0 ws0">between<span class="_ _16"> </span>the<span class="_ _14"> </span><span class="ff6">s_data<span class="_ _14"> </span></span>and<span class="_ _14"> </span><span class="ff6">load<span class="_ _14"> </span></span>operations<span class="_ _1"></span>.<span class="_ _14"> </span>T<span class="_ _1"></span>his<span class="_ _14"> </span>dependency<span class="_ _16"> </span>is<span class="_ _14"> </span>conditional:<span class="_ _14"> </span>if<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y503c ff7 fs19 fc1 sc0 ls0 ws0">two<span class="_"> </span>addresses<span class="_ _13"> </span>match,<span class="_"> </span>the<span class="_ _13"> </span><span class="ff6">load<span class="_ _10"> </span></span>operation<span class="_"> </span>must<span class="_ _13"> </span>wait<span class="_"> </span>until<span class="_ _13"> </span>the<span class="_"> </span><span class="ff6">s_data<span class="_ _10"> </span></span>has<span class="_ _13"> </span>deposited</div><div class="t m5 x1d h26 y503d ff7 fs19 fc1 sc0 ls0 ws0">its<span class="_"> </span>result<span class="_ _11"> </span>into<span class="_"> </span>the<span class="_ _11"> </span>store<span class="_"> </span>buffer,<span class="_"> </span>but<span class="_ _11"> </span>if<span class="_ _11"> </span>the<span class="_"> </span>two<span class="_ _11"> </span>addresses<span class="_"> </span>differ,<span class="_"> </span>the<span class="_ _11"> </span>two<span class="_"> </span>operations</div><div class="t m5 x1d h26 y503e ff7 fs19 fc1 sc0 ls0 ws0">can<span class="_"> </span>proceed<span class="_"> </span>independently<span class="_ _3"></span>.</div><div class="t m5 x29 h26 y503f ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _11"> </span>5.36<span class="_ _11"> </span>illustrates<span class="_ _11"> </span>the<span class="_ _11"> </span>data<span class="_ _11"> </span>dependencies<span class="_"> </span>between<span class="_ _11"> </span>the<span class="_ _11"> </span>operations<span class="_ _11"> </span>for<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y5040 ff7 fs19 fc1 sc0 ls0 ws0">inner<span class="_ _11"> </span>loop<span class="_ _11"> </span>of<span class="_ _11"> </span><span class="ffd">write_read</span>.<span class="_ _11"> </span>In<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _11"> </span>5.36(a),<span class="_ _16"> </span>we<span class="_"> </span>have<span class="_ _16"> </span>rearranged<span class="_"> </span>the<span class="_ _16"> </span>operations</div><div class="t m5 x1d h26 y5041 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _14"> </span>allow<span class="_ _15"> </span>the<span class="_ _15"> </span>dependencies<span class="_ _15"> </span>to<span class="_ _14"> </span>be<span class="_ _15"> </span>seen<span class="_ _15"> </span>more<span class="_ _14"> </span>clearly<span class="_ _3"></span>.<span class="_ _15"> </span>W<span class="_ _3"></span>e<span class="_ _15"> </span>have<span class="_ _15"> </span>labeled<span class="_ _15"> </span>the<span class="_ _14"> </span>three</div><div class="t m5 x1d h26 y5042 ff7 fs19 fc1 sc0 ls0 ws0">dependencies<span class="_ _6"> </span>involving<span class="_ _13"> </span>the<span class="_ _a"> </span>load<span class="_ _13"> </span>and<span class="_ _a"> </span>store<span class="_ _13"> </span>operations<span class="_ _6"> </span>for<span class="_ _6"> </span>special<span class="_ _13"> </span>attention.<span class="_ _a"> </span>The<span class="_ _a"> </span>arc</div><div class="t m5 x1d h26 y5043 ff7 fs19 fc1 sc0 ls0 ws0">labeled<span class="_"> </span>“1”<span class="_"> </span>represents<span class="_"> </span>the<span class="_"> </span>requirement<span class="_"> </span>that<span class="_"> </span>the<span class="_ _11"> </span>store<span class="_"> </span>address<span class="_"> </span>must<span class="_"> </span>be<span class="_"> </span>computed</div><div class="t m5 x1d h26 y5044 ff7 fs19 fc1 sc0 ls0 ws0">before<span class="_ _14"> </span>the<span class="_ _14"> </span>data<span class="_ _16"> </span>can<span class="_ _14"> </span>be<span class="_ _14"> </span>stored.<span class="_ _14"> </span>The<span class="_ _16"> </span>arc<span class="_ _14"> </span>labeled<span class="_ _14"> </span>“2”<span class="_ _14"> </span>represents<span class="_ _14"> </span>the<span class="_ _14"> </span>need<span class="_ _16"> </span>for<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y5045 ff6 fs19 fc1 sc0 ls0 ws0">load<span class="_ _10"> </span><span class="ff7">operation<span class="_ _13"> </span>to<span class="_"> </span>compare<span class="_"> </span>its<span class="_ _13"> </span>address<span class="_"> </span>with<span class="_"> </span>that<span class="_ _13"> </span>for<span class="_"> </span>any<span class="_"> </span>pending<span class="_ _13"> </span>store<span class="_"> </span>operations<span class="_ _1"></span>.</span></div><div class="t m5 x1d h26 y5046 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>inally<span class="_ _3"></span>,<span class="_ _14"> </span>the<span class="_ _14"> </span>dashed<span class="_ _14"> </span>arc<span class="_ _16"> </span>labeled<span class="_ _14"> </span>“3”<span class="_ _16"> </span>represents<span class="_ _14"> </span>the<span class="_ _14"> </span>conditional<span class="_ _16"> </span>data<span class="_ _14"> </span>dependency</div><div class="t m5 x1d h26 y5047 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_"> </span>arises<span class="_"> </span>when<span class="_"> </span>the<span class="_"> </span>load<span class="_"> </span>and<span class="_"> </span>store<span class="_"> </span>addresses<span class="_"> </span>match.</div><div class="t m5 x29 h26 y5048 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _11"> </span>5.36(b)<span class="_"> </span>illustrates<span class="_"> </span>what<span class="_"> </span>happens<span class="_"> </span>when<span class="_ _11"> </span>we<span class="_"> </span>take<span class="_"> </span>away<span class="_"> </span>those<span class="_ _11"> </span>operations</div><div class="t m5 x1d h26 y5049 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _14"> </span>do<span class="_ _14"> </span>not<span class="_ _14"> </span>directly<span class="_ _14"> </span>affect<span class="_ _15"> </span>the<span class="_ _14"> </span>ﬂow<span class="_ _14"> </span>of<span class="_ _14"> </span>data<span class="_ _14"> </span>from<span class="_ _14"> </span>one<span class="_ _15"> </span>iteration<span class="_ _14"> </span>to<span class="_ _14"> </span>the<span class="_ _14"> </span>next.<span class="_ _14"> </span>The</div><div class="t m5 x1d h26 y504a ff7 fs19 fc1 sc0 ls0 ws0">data-ﬂow<span class="_ _11"> </span>graph<span class="_ _11"> </span>shows<span class="_ _11"> </span>just<span class="_ _11"> </span>two<span class="_ _11"> </span>chains<span class="_ _11"> </span>of<span class="_ _11"> </span>dependencies:<span class="_ _11"> </span>the<span class="_ _11"> </span>one<span class="_ _11"> </span>on<span class="_ _11"> </span>the<span class="_ _11"> </span>left,<span class="_ _16"> </span>with</div><div class="t m5 x1d h26 y504b ff7 fs19 fc1 sc0 ls0 ws0">data<span class="_"> </span>values<span class="_"> </span>being<span class="_"> </span>stored,<span class="_ _13"> </span>loaded,<span class="_"> </span>and<span class="_"> </span>incremented<span class="_"> </span>(only<span class="_"> </span>for<span class="_"> </span>the<span class="_ _13"> </span>case<span class="_"> </span>of<span class="_"> </span>matching</div><div class="t m5 x1d h26 y504c ff7 fs19 fc1 sc0 ls0 ws0">addresses);<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>one<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>right,<span class="_"> </span>decrementing<span class="_"> </span>variable<span class="_"> </span><span class="ffd">cnt</span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
