<div id="pf2e9" class="pf w2 h11" data-page-no="2e9"><div class="pc pc2e9 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2e9.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">744<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x1d h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">library<span class="_ _11"> </span>function<span class="_ _16"> </span>is<span class="_ _16"> </span>called,<span class="_ _11"> </span>validate<span class="_ _16"> </span>and<span class="_ _16"> </span>trace<span class="_ _11"> </span>its<span class="_ _16"> </span>input<span class="_ _11"> </span>and<span class="_ _16"> </span>output<span class="_ _11"> </span>values<span class="_ _1"></span>,<span class="_ _16"> </span>or<span class="_ _16"> </span>even</div><div class="t m5 x1d h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">replace<span class="_"> </span>it<span class="_"> </span>with<span class="_"> </span>a<span class="_"> </span>completely<span class="_"> </span>different<span class="_"> </span>implementation.</div><div class="t m5 x29 h26 y40a ff7 fs19 fc2 sc0 ls0 ws0">Here’s<span class="_ _16"> </span>the<span class="_ _14"> </span>basic<span class="_ _16"> </span>idea:<span class="_ _14"> </span>Given<span class="_ _14"> </span>some<span class="_ _14"> </span><span class="ffa">target<span class="_ _16"> </span>function<span class="_ _14"> </span></span>to<span class="_ _14"> </span>be<span class="_ _16"> </span>interposed<span class="_ _14"> </span>on,<span class="_ _15"> </span>you</div><div class="t m5 x1d h26 y40b ff7 fs19 fc2 sc0 ls0 ws0">create<span class="_ _6"> </span>a<span class="_ _6"> </span><span class="ffa">wrapper<span class="_ _6"> </span>function<span class="_ _6"> </span></span>whose<span class="_ _6"> </span>prototype<span class="_ _13"> </span>is<span class="_ _a"> </span>identical<span class="_ _6"> </span>to<span class="_ _13"> </span>the<span class="_ _a"> </span>target<span class="_ _6"> </span>function.<span class="_ _6"> </span>Using</div><div class="t m5 x1d h26 y40c ff7 fs19 fc2 sc0 ls0 ws0">some<span class="_ _13"> </span>particular<span class="_ _6"> </span>interpositioning<span class="_ _13"> </span>mechanism,<span class="_ _13"> </span>you<span class="_ _6"> </span>then<span class="_ _13"> </span>trick<span class="_ _13"> </span>the<span class="_ _6"> </span>system<span class="_ _13"> </span>into<span class="_ _6"> </span>calling</div><div class="t m5 x1d h26 y40d ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _6"> </span>wrapper<span class="_ _13"> </span>function<span class="_ _a"> </span>instead<span class="_ _13"> </span>of<span class="_ _a"> </span>the<span class="_ _13"> </span>target<span class="_ _6"> </span>function.<span class="_ _6"> </span>T<span class="_ _0"></span>he<span class="_ _6"> </span>wrapper<span class="_ _13"> </span>function<span class="_ _a"> </span>typically</div><div class="t m5 x1d h26 y40e ff7 fs19 fc2 sc0 ls0 ws0">executes<span class="_ _16"> </span>its<span class="_ _16"> </span>own<span class="_ _16"> </span>logic,<span class="_ _16"> </span>then<span class="_ _16"> </span>calls<span class="_ _14"> </span>the<span class="_ _16"> </span>target<span class="_ _16"> </span>function<span class="_ _16"> </span>and<span class="_ _16"> </span>passes<span class="_ _16"> </span>its<span class="_ _14"> </span>return<span class="_ _16"> </span>value</div><div class="t m5 x1d h26 y40f ff7 fs19 fc2 sc0 ls0 ws0">back<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>caller.</div><div class="t m5 x29 h26 y410 ff7 fs19 fc2 sc0 ls0 ws0">Interpositioning<span class="_ _21"> </span>can<span class="_ _f"> </span>occur<span class="_ _f"> </span>at<span class="_ _f"> </span>compile<span class="_ _f"> </span>time,<span class="_ _e"> </span>link<span class="_ _21"> </span>time<span class="_ _1"></span>,<span class="_ _e"> </span>or<span class="_ _f"> </span>run<span class="_ _f"> </span>time<span class="_ _f"> </span>as<span class="_ _f"> </span>the</div><div class="t m5 x1d h26 y411 ff7 fs19 fc2 sc0 ls0 ws0">program<span class="_ _16"> </span>is<span class="_ _14"> </span>being<span class="_ _14"> </span>loaded<span class="_ _14"> </span>and<span class="_ _14"> </span>executed.<span class="_ _16"> </span>T<span class="_ _3"></span>o<span class="_ _14"> </span>explore<span class="_ _14"> </span>these<span class="_ _16"> </span>different<span class="_ _14"> </span>mechanisms<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y412 ff7 fs19 fc2 sc0 ls0 ws0">we<span class="_ _11"> </span>will<span class="_ _11"> </span>use<span class="_ _11"> </span>the<span class="_"> </span>example<span class="_ _11"> </span>program<span class="_ _11"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>7.20(a)<span class="_ _11"> </span>as<span class="_ _11"> </span>a<span class="_ _11"> </span>running<span class="_ _11"> </span>example<span class="_ _0"></span>.<span class="_ _11"> </span>It<span class="_ _11"> </span>calls</div><div class="t m5 x1d h26 y413 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span><span class="ffd">malloc<span class="_ _10"> </span></span>and<span class="_ _13"> </span><span class="ffd">free<span class="_ _10"> </span></span>functions<span class="_ _13"> </span>from<span class="_"> </span>the<span class="_ _13"> </span>C<span class="_"> </span>standard<span class="_ _13"> </span>library<span class="_"> </span>(<span class="ffd">libc.so</span>).<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_"> </span>call<span class="_ _13"> </span>to</div><div class="t m5 x1d h26 y414 ffd fs19 fc2 sc0 ls0 ws0">malloc<span class="_ _16"> </span><span class="ff7">allocates<span class="_ _11"> </span>a<span class="_ _16"> </span>block<span class="_ _16"> </span>of<span class="_ _11"> </span>32<span class="_ _16"> </span>bytes<span class="_ _11"> </span>from<span class="_ _16"> </span>the<span class="_ _16"> </span>heap<span class="_ _11"> </span>and<span class="_ _16"> </span>returns<span class="_ _16"> </span>a<span class="_ _11"> </span>pointer<span class="_ _16"> </span>to<span class="_ _16"> </span>the</span></div><div class="t m5 x1d h26 y415 ff7 fs19 fc2 sc0 ls0 ws0">block.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>call<span class="_ _16"> </span>to<span class="_ _16"> </span><span class="ffd">free<span class="_ _16"> </span></span>gives<span class="_ _16"> </span>the<span class="_ _16"> </span>block<span class="_ _16"> </span>back<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>heap<span class="_ _1"></span>,<span class="_ _14"> </span>for<span class="_ _16"> </span>use<span class="_ _16"> </span>by<span class="_ _16"> </span>subsequent</div><div class="t m5 x1d h26 y416 ff7 fs19 fc2 sc0 ls0 ws0">calls<span class="_ _13"> </span>to<span class="_ _13"> </span><span class="ffd">malloc</span>.<span class="_"> </span>Our<span class="_ _13"> </span>goal<span class="_ _13"> </span>is<span class="_ _13"> </span>to<span class="_ _13"> </span>use<span class="_ _13"> </span>interpositioning<span class="_"> </span>to<span class="_ _13"> </span>trace<span class="_ _13"> </span>the<span class="_ _13"> </span>calls<span class="_ _13"> </span>to<span class="_"> </span><span class="ffd">malloc<span class="_ _13"> </span></span>and</div><div class="t m5 x1d h26 y434 ffd fs19 fc2 sc0 ls0 ws0">free<span class="_ _10"> </span><span class="ff7">as<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>runs<span class="_ _1"></span>.</span></div><div class="t m5 x1d h41 y6255 ffe fs29 fc2 sc0 ls0 ws0">7.13.1<span class="_ _48"> </span><span class="fs19">Compile-Time<span class="_"> </span>Interpositioning</span></div><div class="t m5 x1d h26 y6256 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>7.20<span class="_ _14"> </span>shows<span class="_ _16"> </span>how<span class="_ _14"> </span>to<span class="_ _14"> </span>use<span class="_ _14"> </span>the<span class="_ _16"> </span>C<span class="_ _14"> </span>preprocessor<span class="_ _14"> </span>to<span class="_ _16"> </span>interpose<span class="_ _14"> </span>at<span class="_ _14"> </span>compile<span class="_ _16"> </span>time.</div><div class="t m5 x1d h26 y6257 ff7 fs19 fc2 sc0 ls0 ws0">Each<span class="_ _16"> </span>wrapper<span class="_ _11"> </span>function<span class="_ _16"> </span>in<span class="_ _16"> </span><span class="ffd">mymalloc.c<span class="_ _11"> </span></span>(Figure<span class="_ _11"> </span>7.20(c))<span class="_ _16"> </span>calls<span class="_ _11"> </span>the<span class="_ _16"> </span>target<span class="_ _16"> </span>function,</div><div class="t m5 x1d h26 y6258 ff7 fs19 fc2 sc0 ls0 ws0">prints<span class="_ _6"> </span>a<span class="_ _6"> </span>trace,<span class="_ _6"> </span>and<span class="_ _6"> </span>returns<span class="_ _1"></span>.<span class="_ _6"> </span>The<span class="_ _a"> </span>local<span class="_ _6"> </span><span class="ffd">malloc.h<span class="_ _6"> </span></span>header<span class="_ _13"> </span>ﬁle<span class="_ _a"> </span>(Figure<span class="_ _a"> </span>7.20(b))<span class="_ _6"> </span>instructs</div><div class="t m5 x1d h26 y6259 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>preprocessor<span class="_ _13"> </span>to<span class="_ _13"> </span>replace<span class="_ _13"> </span>each<span class="_ _13"> </span>call<span class="_ _13"> </span>to<span class="_"> </span>a<span class="_ _13"> </span>target<span class="_ _13"> </span>function<span class="_ _13"> </span>with<span class="_ _13"> </span>a<span class="_ _13"> </span>call<span class="_ _13"> </span>to<span class="_ _13"> </span>its<span class="_ _13"> </span>wrapper.</div><div class="t m5 x1d h26 y625a ff7 fs19 fc2 sc0 ls0 ws0">Here<span class="_"> </span>is<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>compile<span class="_"> </span>and<span class="_"> </span>link<span class="_"> </span>the<span class="_"> </span>program:</div><div class="t m5 x1d h2d y625b ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-DCOMPILETIME<span class="_ _1f"> </span>-c<span class="_ _e"> </span>mymalloc.c</span></div><div class="t m5 x1d h2d y625c ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-I.<span class="_ _1f"> </span>-o<span class="_ _e"> </span>intc<span class="_ _1f"> </span>int.c<span class="_ _e"> </span>mymalloc.o</span></div><div class="t m5 x1d h26 y2d69 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _21"> </span>interpositioning<span class="_ _21"> </span>happens<span class="_ _21"> </span>because<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _f"> </span><span class="ffd">-I.<span class="_ _21"> </span></span>argument,<span class="_ _f"> </span>which<span class="_ _21"> </span>tells<span class="_ _21"> </span>the<span class="_ _21"> </span>C</div><div class="t m5 x1d h26 y625d ff7 fs19 fc2 sc0 ls0 ws0">preprocessor<span class="_"> </span>to<span class="_ _11"> </span>look<span class="_"> </span>for<span class="_ _11"> </span><span class="ffd">malloc.h<span class="_ _11"> </span></span>in<span class="_"> </span>the<span class="_ _11"> </span>current<span class="_ _11"> </span>directory<span class="_"> </span>before<span class="_ _11"> </span>looking<span class="_ _11"> </span>in<span class="_"> </span>the</div><div class="t m5 x1d h26 y625e ff7 fs19 fc2 sc0 ls0 ws0">usual<span class="_ _16"> </span>system<span class="_ _14"> </span>directories<span class="_ _1"></span>.<span class="_ _16"> </span>Notice<span class="_ _14"> </span>that<span class="_ _16"> </span>the<span class="_ _14"> </span>wrappers<span class="_ _16"> </span>in<span class="_ _14"> </span><span class="ffd">mymalloc.c<span class="_ _16"> </span></span>are<span class="_ _14"> </span>compiled</div><div class="t m5 x1d h26 y625f ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_"> </span>the<span class="_"> </span>standard<span class="_"> </span><span class="ffd">malloc.h<span class="_ _10"> </span></span>header<span class="_"> </span>ﬁle<span class="_ _0"></span>.</div><div class="t m5 x29 h26 y6260 ff7 fs19 fc2 sc0 ls0 ws0">Running<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>gives<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>trace:</div><div class="t m5 x1d h2d y6261 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">./intc</span></div><div class="t m5 x1d h2d y6262 ffd fs1e fc2 sc0 ls0 ws0">malloc(32)=0x9ee010</div><div class="t m5 x1d h2d y6263 ffd fs1e fc2 sc0 ls0 ws0">free(0x9ee010)</div><div class="t m5 x1d h41 y6264 ffe fs29 fc2 sc0 ls0 ws0">7.13.2<span class="_ _48"> </span><span class="fs19">Link-Time<span class="_"> </span>Interpositioning</span></div><div class="t m5 x1d h26 y6265 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>Linux<span class="_ _13"> </span>static<span class="_ _13"> </span>linker<span class="_ _13"> </span>supports<span class="_"> </span>link-time<span class="_ _13"> </span>interpositioning<span class="_ _13"> </span>with<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">--wrap<span class="_ _11"> </span>f<span class="_ _13"> </span></span>ﬂag.</div><div class="t m5 x1d h26 y6266 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _f"> </span>ﬂag<span class="_ _f"> </span>tells<span class="_ _f"> </span>the<span class="_ _e"> </span>linker<span class="_ _21"> </span>to<span class="_ _f"> </span>resolve<span class="_ _f"> </span>references<span class="_ _f"> </span>to<span class="_ _f"> </span>symbol<span class="_ _f"> </span><span class="ffd">f<span class="_ _f"> </span></span>as<span class="_ _f"> </span><span class="ffd">__wrap_f<span class="_ _f"> </span></span>(two</div><div class="t m5 x1d h26 y6267 ff7 fs19 fc2 sc0 ls0 ws0">underscores<span class="_ _1f"> </span>for<span class="_ _22"> </span>the<span class="_ _22"> </span>preﬁx),<span class="_ _23"> </span>and<span class="_ _22"> </span>to<span class="_ _22"> </span>resolve<span class="_ _1f"> </span>references<span class="_ _22"> </span>to<span class="_ _1f"> </span>symbol<span class="_ _22"> </span><span class="ffd">__real_f</span></div><div class="t m5 x1d h26 y6268 ff7 fs19 fc2 sc0 ls0 ws0">(two<span class="_ _15"> </span>underscores<span class="_ _21"> </span>for<span class="_ _15"> </span>the<span class="_ _15"> </span>preﬁx)<span class="_ _21"> </span>as<span class="_ _15"> </span><span class="ffd">f</span>.<span class="_ _21"> </span>F<span class="_ _0"></span>igure<span class="_ _15"> </span>7.21<span class="_ _21"> </span>shows<span class="_ _15"> </span>the<span class="_ _21"> </span>wrappers<span class="_ _15"> </span>for<span class="_ _21"> </span>our</div><div class="t m5 x1d h26 y6269 ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_"> </span>program.</div><div class="t m5 x29 h26 y626a ff7 fs19 fc2 sc0 ls0 ws0">Here<span class="_"> </span>is<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>compile<span class="_"> </span>the<span class="_"> </span>source<span class="_"> </span>ﬁles<span class="_"> </span>into<span class="_"> </span>relocatable<span class="_"> </span>object<span class="_"> </span>ﬁles:</div><div class="t m5 x1d h2d y626b ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-DLINKTIME<span class="_ _1f"> </span>-c<span class="_ _e"> </span>mymalloc.c</span></div><div class="t m5 x1d h2d y626c ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-c<span class="_ _1f"> </span>int.c</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
