<div id="pf25f" class="pf w2 h11" data-page-no="25f"><div class="pc pc25f w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg25f.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">606<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">takes<span class="_"> </span>a<span class="_"> </span>similar<span class="_ _13"> </span>approach<span class="_"> </span>but<span class="_"> </span>goes<span class="_"> </span>into<span class="_ _13"> </span>more<span class="_"> </span>detail<span class="_"> </span>with<span class="_"> </span>respect<span class="_ _13"> </span>to<span class="_"> </span>the<span class="_"> </span>processor’s</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">characteristics<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">Many<span class="_"> </span>publications<span class="_ _13"> </span>describe<span class="_"> </span>code<span class="_ _13"> </span>optimization<span class="_"> </span>from<span class="_ _13"> </span>a<span class="_"> </span>compiler’<span class="_ _1"></span>s<span class="_"> </span>perspective<span class="_ _1"></span>,</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">formulating<span class="_ _14"> </span>ways<span class="_ _15"> </span>that<span class="_ _15"> </span>compilers<span class="_ _15"> </span>can<span class="_ _15"> </span>generate<span class="_ _15"> </span>more<span class="_ _14"> </span>efﬁcient<span class="_ _15"> </span>code.<span class="_ _14"> </span>Muchnick’s</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">book<span class="_"> </span>is<span class="_"> </span>considered<span class="_"> </span>the<span class="_"> </span>most<span class="_"> </span>comprehensive<span class="_"> </span>[80].<span class="_"> </span>W<span class="_ _3"></span>adleigh<span class="_"> </span>and<span class="_"> </span>Crawford’<span class="_ _0"></span>s<span class="_"> </span>book</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_ _16"> </span>software<span class="_ _16"> </span>optimization<span class="_ _16"> </span>[115]<span class="_ _14"> </span>covers<span class="_ _16"> </span>some<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>material<span class="_ _16"> </span>we<span class="_ _16"> </span>have<span class="_ _16"> </span>presented,</div><div class="t m5 x1d h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">but<span class="_ _13"> </span>it<span class="_ _13"> </span>also<span class="_ _13"> </span>describes<span class="_ _13"> </span>the<span class="_ _13"> </span>process<span class="_ _13"> </span>of<span class="_ _13"> </span>getting<span class="_ _13"> </span>high<span class="_"> </span>performance<span class="_ _13"> </span>on<span class="_ _13"> </span>parallel<span class="_ _13"> </span>machines<span class="_ _3"></span>.</div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">An<span class="_"> </span>early<span class="_ _13"> </span>paper<span class="_"> </span>by<span class="_ _13"> </span>Mahlke<span class="_"> </span>et<span class="_"> </span>al.<span class="_ _13"> </span>[75]<span class="_"> </span>describes<span class="_ _13"> </span>how<span class="_"> </span>several<span class="_"> </span>techniques<span class="_ _13"> </span>developed</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_ _13"> </span>compilers<span class="_ _13"> </span>that<span class="_ _6"> </span>map<span class="_ _13"> </span>programs<span class="_ _13"> </span>onto<span class="_ _13"> </span>parallel<span class="_ _13"> </span>machines<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _13"> </span>adapted<span class="_ _13"> </span>to<span class="_ _13"> </span>exploit</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>instruction-level<span class="_ _13"> </span>parallelism<span class="_ _13"> </span>of<span class="_ _13"> </span>modern<span class="_ _13"> </span>processors<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _0"></span>his<span class="_ _13"> </span>paper<span class="_ _13"> </span>covers<span class="_ _13"> </span>the<span class="_ _13"> </span>code</div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">transformations<span class="_ _14"> </span>we<span class="_ _15"> </span>presented,<span class="_ _21"> </span>including<span class="_ _15"> </span>loop<span class="_ _15"> </span>unrolling,<span class="_ _15"> </span>multiple<span class="_ _15"> </span>accumulators</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">(which<span class="_ _13"> </span>they<span class="_ _13"> </span>refer<span class="_"> </span>to<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ffa">accumulator<span class="_ _13"> </span>variable<span class="_ _13"> </span>expansion</span>),<span class="_"> </span>and<span class="_ _13"> </span>reassociation<span class="_ _13"> </span>(which</div><div class="t m5 x1d h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">they<span class="_"> </span>refer<span class="_"> </span>to<span class="_"> </span>as<span class="_"> </span><span class="ffa">tree<span class="_"> </span>height<span class="_"> </span>reduction</span>).</div><div class="t m5 x29 h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">Our<span class="_"> </span>presentation<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>operation<span class="_"> </span>of<span class="_"> </span>an<span class="_"> </span>out-of-order<span class="_"> </span>processor<span class="_"> </span>is<span class="_"> </span>fairly<span class="_"> </span>brief</div><div class="t m5 x1d h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _13"> </span>abstract.<span class="_ _6"> </span>More<span class="_ _13"> </span>complete<span class="_ _13"> </span>descriptions<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>general<span class="_ _6"> </span>principles<span class="_ _13"> </span>can<span class="_ _13"> </span>be<span class="_ _6"> </span>found<span class="_ _13"> </span>in</div><div class="t m5 x1d h26 y451 ff7 fs19 fc2 sc0 ls0 ws0">advanced<span class="_ _13"> </span>computer<span class="_ _13"> </span>architecture<span class="_"> </span>textbooks<span class="_ _3"></span>,<span class="_"> </span>such<span class="_ _13"> </span>as<span class="_ _13"> </span>the<span class="_ _13"> </span>one<span class="_ _13"> </span>by<span class="_"> </span>Hennessy<span class="_ _13"> </span>and<span class="_ _13"> </span>Pat-</div><div class="t m5 x1d h26 y452 ff7 fs19 fc2 sc0 ls0 ws0">terson<span class="_ _13"> </span>[46,<span class="_ _13"> </span>Ch.<span class="_ _13"> </span>2–3].<span class="_ _13"> </span>Shen<span class="_ _13"> </span>and<span class="_ _6"> </span>Lipasti’s<span class="_ _13"> </span>book<span class="_ _13"> </span>[100]<span class="_ _13"> </span>provides<span class="_ _13"> </span>an<span class="_ _13"> </span>in-depth<span class="_ _6"> </span>treatment</div><div class="t m5 x1d h26 y453 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>modern<span class="_"> </span>processor<span class="_"> </span>design.</div><div class="t m5 x1d h29 y513a ffe fs14 fc2 sc0 ls0 ws0">Homework<span class="_"> </span>Problems</div><div class="t m5 x1d h73 y513b ffe fs1e fc6 sc0 ls0 ws0">5.13<span class="_ _23"> </span><span class="ff10 fs19">◆◆</span></div><div class="t m5 x1d h26 y513c ff7 fs19 fc1 sc0 ls0 ws0">Suppose<span class="_ _14"> </span>we<span class="_ _14"> </span>wish<span class="_ _16"> </span>to<span class="_ _14"> </span>write<span class="_ _14"> </span>a<span class="_ _14"> </span>procedure<span class="_ _14"> </span>that<span class="_ _14"> </span>computes<span class="_ _14"> </span>the<span class="_ _14"> </span>inner<span class="_ _14"> </span>product<span class="_ _14"> </span>of<span class="_ _14"> </span>two</div><div class="t m5 x1d h26 y513d ff7 fs19 fc1 sc0 ls0 ws0">vectors<span class="_"> </span><span class="ffd">u<span class="_ _13"> </span></span>and<span class="_"> </span><span class="ffd">v</span>.<span class="_"> </span>An<span class="_"> </span>abstract<span class="_ _13"> </span>version<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>function<span class="_"> </span>has<span class="_"> </span>a<span class="_"> </span>CPE<span class="_ _13"> </span>of<span class="_"> </span>14–18<span class="_"> </span>with<span class="_"> </span>x86-</div><div class="t m5 x1d h26 y513e ff7 fs19 fc1 sc0 ls0 ws0">64<span class="_ _16"> </span>for<span class="_ _11"> </span>different<span class="_ _16"> </span>types<span class="_ _16"> </span>of<span class="_ _11"> </span>integer<span class="_ _16"> </span>and<span class="_ _11"> </span>ﬂoating-point<span class="_ _16"> </span>data.<span class="_ _16"> </span>By<span class="_ _16"> </span>doing<span class="_ _11"> </span>the<span class="_ _16"> </span>same<span class="_ _16"> </span>sort</div><div class="t m5 x1d h26 y513f ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _16"> </span>transformations<span class="_ _11"> </span>we<span class="_ _16"> </span>did<span class="_ _16"> </span>to<span class="_ _16"> </span>transform<span class="_ _16"> </span>the<span class="_ _11"> </span>abstract<span class="_ _16"> </span>program<span class="_ _16"> </span><span class="ffd">combine1<span class="_ _16"> </span></span>into<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y5140 ff7 fs19 fc1 sc0 ls0 ws0">more<span class="_"> </span>efﬁcient<span class="_"> </span><span class="ffd">combine4</span>,<span class="_"> </span>we<span class="_"> </span>get<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>code:</div><div class="t m5 x1f h2d y5141 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Inner<span class="_ _e"> </span>product.<span class="_ _1a"> </span>Accumulate<span class="_ _1f"> </span>in<span class="_ _1f"> </span>temporary<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f h2d y5142 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>inner4(vec_ptr<span class="_ _e"> </span>u,<span class="_ _1f"> </span>vec_ptr<span class="_ _1f"> </span>v,<span class="_ _e"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x1f h2d y5143 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y5144 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>i;</span></div><div class="t m5 x1f h2d y5145 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>length<span class="_ _1f"> </span>=<span class="_ _1f"> </span>vec_length(u);</span></div><div class="t m5 x1f h2d y5146 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>*udata<span class="_ _1f"> </span>=<span class="_ _1f"> </span>get_vec_start(u);</span></div><div class="t m5 x1f h2e y5147 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x33 h2d y5148 ffd fs1e fc2 sc0 ls0 ws0">data_t<span class="_ _e"> </span>*vdata<span class="_ _1f"> </span>=<span class="_ _1f"> </span>get_vec_start(v);</div><div class="t m5 x1f h2d y5149 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>sum<span class="_ _1f"> </span>=<span class="_ _1f"> </span>(data_t)<span class="_ _e"> </span>0;</span></div><div class="t m5 x1f h2e y514a ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1b0 h2e y514b ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x33 h2d y514c ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>length;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</div><div class="t m5 x1b0 h2d y514d ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _70"> </span><span class="ffd fs1e fc2">sum<span class="_ _e"> </span>=<span class="_ _1f"> </span>sum<span class="_ _1f"> </span>+<span class="_ _e"> </span>udata[i]<span class="_ _1f"> </span>*<span class="_ _e"> </span>vdata[i];</span></div><div class="t m5 x1b0 h2d y514e ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2e y514f ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x33 h2d y5150 ffd fs1e fc2 sc0 ls0 ws0">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>sum;</div><div class="t m5 x1b0 h2d y5151 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x29 h26 y8d6 ff7 fs19 fc2 sc0 ls0 ws0">Our<span class="_"> </span>measurements<span class="_"> </span>show<span class="_"> </span>that<span class="_ _11"> </span>this<span class="_"> </span>function<span class="_"> </span>has<span class="_"> </span>CPEs<span class="_ _11"> </span>of<span class="_"> </span>1.50<span class="_"> </span>for<span class="_"> </span>integer<span class="_ _11"> </span>data</div><div class="t m5 x1d h26 y8d7 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>3.00<span class="_ _11"> </span>for<span class="_ _11"> </span>ﬂoating-point<span class="_"> </span>data.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>data<span class="_ _11"> </span>type<span class="_"> </span><span class="ffd">double</span>,<span class="_ _11"> </span>the<span class="_ _11"> </span>x86-64<span class="_ _11"> </span>assembly<span class="_"> </span>code</div><div class="t m5 x1d h26 y8d8 ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_"> </span>the<span class="_"> </span>inner<span class="_"> </span>loop<span class="_"> </span>is<span class="_"> </span>as<span class="_"> </span>follows:</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
