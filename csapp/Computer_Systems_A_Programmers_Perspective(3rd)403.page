<div id="pf193" class="pf w2 h11" data-page-no="193"><div class="pc pc193 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg193.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">402<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>4<span class="_ _3d"> </span>Processor<span class="_ _10"> </span>Architecture</span></div><div class="t m5 x75 h3d y2f34 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y9c ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>Y86-64<span class="_ _14"> </span>code<span class="_ _16"> </span>requires<span class="_ _16"> </span>two<span class="_ _16"> </span>instructions<span class="_ _14"> </span>(lines<span class="_ _16"> </span>8–9)<span class="_ _16"> </span>to<span class="_ _16"> </span>read<span class="_ _14"> </span>a<span class="_ _16"> </span>value<span class="_ _16"> </span>from</div><div class="t m5 x29 h26 y409 ff7 fs19 fc1 sc0 ls0 ws0">memory<span class="_ _11"> </span>and<span class="_ _11"> </span>add<span class="_ _11"> </span>it<span class="_ _16"> </span>to<span class="_ _11"> </span>a<span class="_ _11"> </span>register,<span class="_ _11"> </span>whereas<span class="_ _11"> </span>the<span class="_ _11"> </span>x86-64<span class="_ _16"> </span>code<span class="_"> </span>can<span class="_ _16"> </span>do<span class="_ _11"> </span>this<span class="_ _11"> </span>with<span class="_ _11"> </span>a</div><div class="t m5 x29 h26 y40a ff7 fs19 fc1 sc0 ls0 ws0">single<span class="_"> </span><span class="ffd">addq<span class="_ _10"> </span></span>instruction<span class="_"> </span>(line<span class="_"> </span>5).</div><div class="t m5 x75 h3d y37cf ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y37d0 ff7 fs19 fc1 sc0 ls0 ws0">Our<span class="_ _13"> </span>hand-coded<span class="_ _6"> </span>Y86-64<span class="_ _13"> </span>implementation<span class="_ _6"> </span>takes<span class="_ _13"> </span>advantage<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>property<span class="_ _13"> </span>that</div><div class="t m5 x29 h26 y37d1 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span><span class="ffd">subq<span class="_ _11"> </span></span>instruction<span class="_"> </span>(line<span class="_"> </span>11)<span class="_ _11"> </span>also<span class="_"> </span>sets<span class="_ _11"> </span>the<span class="_"> </span>condition<span class="_ _11"> </span>codes<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _11"> </span>so<span class="_"> </span>the<span class="_ _11"> </span><span class="ffd">testq</span></div><div class="t m5 x29 h26 y37d2 ff7 fs19 fc1 sc0 ls0 ws0">instruction<span class="_ _13"> </span>of<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ff9">gcc</span>-generated<span class="_ _13"> </span>code<span class="_ _6"> </span>(line<span class="_ _13"> </span>9)<span class="_ _13"> </span>is<span class="_ _6"> </span>not<span class="_ _13"> </span>required.<span class="_ _13"> </span>F<span class="_ _3"></span>or<span class="_ _13"> </span>this<span class="_ _6"> </span>to<span class="_ _13"> </span>work,</div><div class="t m5 x29 h26 y37d3 ff7 fs19 fc1 sc0 ls0 ws0">though,<span class="_ _16"> </span>the<span class="_ _16"> </span>Y86-64<span class="_ _16"> </span>code<span class="_ _16"> </span>must<span class="_ _16"> </span>set<span class="_ _16"> </span>the<span class="_ _16"> </span>condition<span class="_ _16"> </span>codes<span class="_ _16"> </span>prior<span class="_ _16"> </span>to<span class="_ _16"> </span>entering<span class="_ _16"> </span>the</div><div class="t m5 x29 h26 y37d4 ff7 fs19 fc1 sc0 ls0 ws0">loop<span class="_"> </span>with<span class="_"> </span>an<span class="_"> </span><span class="ffd">andq<span class="_ _10"> </span></span>instruction<span class="_"> </span>(line<span class="_"> </span>5).</div><div class="t m5 x29 h26 y37d5 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _f"> </span>4.7<span class="_ _f"> </span>shows<span class="_ _f"> </span>an<span class="_ _f"> </span>example<span class="_ _e"> </span>of<span class="_ _21"> </span>a<span class="_ _f"> </span>complete<span class="_ _f"> </span>program<span class="_ _f"> </span>ﬁle<span class="_ _f"> </span>written<span class="_ _f"> </span>in<span class="_ _f"> </span>Y86-</div><div class="t m5 x1d h26 y37d6 ff7 fs19 fc1 sc0 ls0 ws0">64<span class="_ _16"> </span>assembly<span class="_ _14"> </span>code.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span>program<span class="_ _14"> </span>contains<span class="_ _16"> </span>both<span class="_ _14"> </span>data<span class="_ _14"> </span>and<span class="_ _14"> </span>instructions<span class="_ _1"></span>.<span class="_ _16"> </span>Directives</div><div class="t m5 x1d h26 y37d7 ff7 fs19 fc1 sc0 ls0 ws0">indicate<span class="_ _16"> </span>where<span class="_ _11"> </span>to<span class="_ _16"> </span>place<span class="_ _16"> </span>code<span class="_ _16"> </span>or<span class="_ _16"> </span>data<span class="_ _11"> </span>and<span class="_ _16"> </span>how<span class="_ _16"> </span>to<span class="_ _16"> </span>align<span class="_ _16"> </span>it.<span class="_ _11"> </span>The<span class="_ _11"> </span>program<span class="_ _16"> </span>speciﬁes</div><div class="t m5 x1d h26 y37d8 ff7 fs19 fc1 sc0 ls0 ws0">issues<span class="_ _21"> </span>such<span class="_ _f"> </span>as<span class="_ _f"> </span>stack<span class="_ _21"> </span>placement,<span class="_ _e"> </span>data<span class="_ _21"> </span>initialization,<span class="_ _e"> </span>program<span class="_ _21"> </span>initialization,<span class="_ _e"> </span>and</div><div class="t m5 x1d h26 y37d9 ff7 fs19 fc1 sc0 ls0 ws0">program<span class="_"> </span>termination.</div><div class="t m5 x29 h26 y37da ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_"> </span>this<span class="_ _11"> </span>program,<span class="_ _11"> </span>words<span class="_"> </span>beginning<span class="_ _11"> </span>with<span class="_ _11"> </span>‘<span class="ffd">.</span>’<span class="_"> </span>are<span class="_ _11"> </span><span class="ffa">assembler<span class="_"> </span>directives<span class="_ _11"> </span></span>telling<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y37db ff7 fs19 fc1 sc0 ls0 ws0">assembler<span class="_ _16"> </span>to<span class="_ _16"> </span>adjust<span class="_ _16"> </span>the<span class="_ _16"> </span>address<span class="_ _16"> </span>at<span class="_ _16"> </span>which<span class="_ _16"> </span>it<span class="_ _16"> </span>is<span class="_ _16"> </span>generating<span class="_ _16"> </span>code<span class="_ _16"> </span>or<span class="_ _16"> </span>to<span class="_ _16"> </span>insert<span class="_ _16"> </span>some</div><div class="t m5 x1d h26 y37dc ff7 fs19 fc1 sc0 ls0 ws0">words<span class="_ _16"> </span>of<span class="_ _16"> </span>data.<span class="_ _11"> </span>The<span class="_ _11"> </span>directive<span class="_ _16"> </span><span class="ffd">.pos<span class="_ _16"> </span>0<span class="_ _16"> </span></span>(line<span class="_ _11"> </span>2)<span class="_ _16"> </span>indicates<span class="_ _16"> </span>that<span class="_ _16"> </span>the<span class="_ _16"> </span>assembler<span class="_ _16"> </span>should</div><div class="t m5 x1d h26 y37dd ff7 fs19 fc1 sc0 ls0 ws0">begin<span class="_ _14"> </span>generating<span class="_ _15"> </span>code<span class="_ _15"> </span>starting<span class="_ _15"> </span>at<span class="_ _15"> </span>address<span class="_ _14"> </span><span class="ffd">0</span>.<span class="_ _15"> </span>T<span class="_ _0"></span>his<span class="_ _14"> </span>is<span class="_ _15"> </span>the<span class="_ _15"> </span>starting<span class="_ _15"> </span>address<span class="_ _15"> </span>for<span class="_ _14"> </span>all</div><div class="t m5 x1d h26 y37de ff7 fs19 fc1 sc0 ls0 ws0">Y86-64<span class="_ _16"> </span>programs<span class="_ _1"></span>.<span class="_ _14"> </span>The<span class="_ _16"> </span>next<span class="_ _16"> </span>instruction<span class="_ _14"> </span>(line<span class="_ _14"> </span>3)<span class="_ _14"> </span>initializes<span class="_ _16"> </span>the<span class="_ _14"> </span>stack<span class="_ _14"> </span>pointer.<span class="_ _16"> </span>W<span class="_ _3"></span>e</div><div class="t m5 x1d h26 y37df ff7 fs19 fc1 sc0 ls0 ws0">can<span class="_ _16"> </span>see<span class="_ _14"> </span>that<span class="_ _16"> </span>the<span class="_ _14"> </span>label<span class="_ _16"> </span><span class="ffd">stack<span class="_ _14"> </span></span>is<span class="_ _16"> </span>declared<span class="_ _14"> </span>at<span class="_ _16"> </span>the<span class="_ _14"> </span>end<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>program<span class="_ _16"> </span>(line<span class="_ _14"> </span>40),<span class="_ _14"> </span>to</div><div class="t m5 x1d h26 y37e0 ff7 fs19 fc1 sc0 ls0 ws0">indicate<span class="_ _11"> </span>address<span class="_ _16"> </span><span class="ffd">0x200<span class="_ _11"> </span></span>using<span class="_ _16"> </span>a<span class="_ _11"> </span><span class="ffd">.pos<span class="_ _16"> </span></span>directive<span class="_ _11"> </span>(line<span class="_ _16"> </span>39).<span class="_ _11"> </span>Our<span class="_ _16"> </span>stack<span class="_ _11"> </span>will<span class="_ _16"> </span>therefore</div><div class="t m5 x1d h26 y37e1 ff7 fs19 fc1 sc0 ls0 ws0">start<span class="_ _16"> </span>at<span class="_ _11"> </span>this<span class="_ _16"> </span>address<span class="_ _16"> </span>and<span class="_ _16"> </span>grow<span class="_ _16"> </span>toward<span class="_ _16"> </span>lower<span class="_ _11"> </span>addresses<span class="_ _1"></span>.<span class="_ _16"> </span>W<span class="_ _1"></span>e<span class="_ _16"> </span>must<span class="_ _16"> </span>ensure<span class="_ _11"> </span>that<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y37e2 ff7 fs19 fc1 sc0 ls0 ws0">stack<span class="_"> </span>does<span class="_"> </span>not<span class="_"> </span>grow<span class="_"> </span>so<span class="_"> </span>large<span class="_"> </span>that<span class="_"> </span>it<span class="_"> </span>overwrites<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>or<span class="_"> </span>other<span class="_"> </span>program<span class="_"> </span>data.</div><div class="t m5 x29 h26 y37e3 ff7 fs19 fc1 sc0 ls0 ws0">Lines<span class="_ _13"> </span>8<span class="_ _13"> </span>to<span class="_"> </span>13<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>program<span class="_"> </span>declare<span class="_ _13"> </span>an<span class="_ _13"> </span>array<span class="_ _13"> </span>of<span class="_"> </span>four<span class="_ _13"> </span>words<span class="_ _1"></span>,<span class="_ _13"> </span>having<span class="_"> </span>the<span class="_ _13"> </span>values</div><div class="t m5 xf8 h3a y37e4 ffd fs19 fc1 sc0 ls0 ws0">0x000d000d000d000d<span class="ff11">,<span class="_ _10"> </span></span>0x00c000c000c000c0<span class="_ _0"></span><span class="ff11">,</span></div><div class="t m5 xf8 h3a y37e5 ffd fs19 fc1 sc0 ls0 ws0">0x0b000b000b000b00<span class="ff11">,<span class="_ _13"> </span></span>0xa000a000a000a000</div><div class="t m5 x1d h26 y37e6 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _6"> </span>label<span class="_ _6"> </span><span class="ffd">array<span class="_ _6"> </span></span>denotes<span class="_ _6"> </span>the<span class="_ _6"> </span>start<span class="_ _6"> </span>of<span class="_ _6"> </span>this<span class="_ _6"> </span>array<span class="_ _3"></span>,<span class="_ _13"> </span>and<span class="_ _a"> </span>is<span class="_ _6"> </span>aligned<span class="_ _6"> </span>on<span class="_ _6"> </span>an<span class="_ _6"> </span>8-byte<span class="_ _6"> </span>boundary</div><div class="t m5 x1d h26 y37e7 ff7 fs19 fc1 sc0 ls0 ws0">(using<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ffd">.align<span class="_ _16"> </span></span>directive).<span class="_ _16"> </span>Lines<span class="_ _11"> </span>16<span class="_ _16"> </span>to<span class="_ _16"> </span>19<span class="_ _16"> </span>show<span class="_ _11"> </span>a<span class="_ _16"> </span>“main”<span class="_ _16"> </span>procedure<span class="_ _11"> </span>that<span class="_ _16"> </span>calls</div><div class="t m5 x1d h26 y37e8 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>function<span class="_"> </span><span class="ffd">sum<span class="_ _10"> </span></span>on<span class="_"> </span>the<span class="_"> </span>four<span class="_ _1"></span>-word<span class="_"> </span>array<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>halts<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y37e9 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _14"> </span>this<span class="_ _15"> </span>example<span class="_ _15"> </span>shows<span class="_ _1"></span>,<span class="_ _21"> </span>since<span class="_ _14"> </span>our<span class="_ _15"> </span>only<span class="_ _15"> </span>tool<span class="_ _15"> </span>for<span class="_ _14"> </span>creating<span class="_ _15"> </span>Y86-64<span class="_ _15"> </span>code<span class="_ _14"> </span>is<span class="_ _15"> </span>an</div><div class="t m5 x1d h26 y37ea ff7 fs19 fc1 sc0 ls0 ws0">assembler,<span class="_ _f"> </span>the<span class="_ _21"> </span>programmer<span class="_ _21"> </span>must<span class="_ _f"> </span>perform<span class="_ _21"> </span>tasks<span class="_ _21"> </span>we<span class="_ _f"> </span>ordinarily<span class="_ _21"> </span>delegate<span class="_ _21"> </span>to<span class="_ _f"> </span>the</div><div class="t m5 x1d h26 y37eb ff7 fs19 fc1 sc0 ls0 ws0">compiler,<span class="_ _e"> </span>linker<span class="_ _1"></span>,<span class="_ _e"> </span>and<span class="_ _f"> </span>run-time<span class="_ _f"> </span>system.<span class="_ _f"> </span>F<span class="_ _1"></span>ortunately<span class="_ _3"></span>,<span class="_ _e"> </span>we<span class="_ _f"> </span>only<span class="_ _f"> </span>do<span class="_ _f"> </span>this<span class="_ _f"> </span>for<span class="_ _f"> </span>small</div><div class="t m5 x1d h26 y37ec ff7 fs19 fc1 sc0 ls0 ws0">programs<span class="_ _1"></span>,<span class="_"> </span>for<span class="_"> </span>which<span class="_"> </span>simple<span class="_"> </span>mechanisms<span class="_"> </span>sufﬁce<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y37ed ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _11"> </span>4.8<span class="_"> </span>shows<span class="_"> </span>the<span class="_ _11"> </span>result<span class="_"> </span>of<span class="_"> </span>assembling<span class="_ _11"> </span>the<span class="_"> </span>code<span class="_"> </span>shown<span class="_ _11"> </span>in<span class="_"> </span>Figure<span class="_"> </span>4.7<span class="_"> </span>by<span class="_"> </span>an</div><div class="t m5 x1d h26 y37ee ff7 fs19 fc1 sc0 ls0 ws0">assembler<span class="_"> </span>we<span class="_"> </span>call<span class="_ _11"> </span><span class="ff9 ls2a">ya<span class="_ _5"></span>s<span class="_ _5"></span></span>.<span class="_"> </span>The<span class="_"> </span>assembler<span class="_"> </span>output<span class="_"> </span>is<span class="_ _11"> </span>in<span class="_"> </span>ASCII<span class="_ _11"> </span>format<span class="_"> </span>to<span class="_ _11"> </span>make<span class="_"> </span>it<span class="_"> </span>more</div><div class="t m5 x1d h26 y37ef ff7 fs19 fc1 sc0 ls0 ws0">readable<span class="_ _1"></span>.<span class="_"> </span>On<span class="_ _13"> </span>lines<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>assembly<span class="_ _13"> </span>ﬁle<span class="_"> </span>that<span class="_ _13"> </span>contain<span class="_ _13"> </span>instructions<span class="_ _13"> </span>or<span class="_ _13"> </span>data,<span class="_"> </span>the<span class="_ _13"> </span>object</div><div class="t m5 x1d h26 y37f0 ff7 fs19 fc1 sc0 ls0 ws0">code<span class="_"> </span>contains<span class="_"> </span>an<span class="_"> </span>address<span class="_ _1"></span>,<span class="_"> </span>followed<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>values<span class="_"> </span>of<span class="_"> </span>between<span class="_"> </span>1<span class="_"> </span>and<span class="_"> </span>10<span class="_"> </span>bytes<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y37f1 ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _14"> </span>have<span class="_ _14"> </span>implemented<span class="_ _15"> </span>an<span class="_ _14"> </span><span class="ffa">instruction<span class="_ _14"> </span>set<span class="_ _14"> </span>simulator<span class="_ _21"> </span></span>we<span class="_ _14"> </span>call<span class="_ _14"> </span><span class="ff9">yis</span>,<span class="_ _21"> </span>the<span class="_ _14"> </span>purpose</div><div class="t m5 x1d h26 y37f2 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _16"> </span>which<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _16"> </span>model<span class="_ _14"> </span>the<span class="_ _16"> </span>execution<span class="_ _16"> </span>of<span class="_ _16"> </span>a<span class="_ _16"> </span>Y86-64<span class="_ _14"> </span>machine-code<span class="_ _16"> </span>program<span class="_ _16"> </span>without</div><div class="t m5 x1d h26 y37f3 ff7 fs19 fc1 sc0 ls0 ws0">attempting<span class="_"> </span>to<span class="_"> </span>model<span class="_"> </span>the<span class="_"> </span>behavior<span class="_"> </span>of<span class="_"> </span>any<span class="_"> </span>speciﬁc<span class="_"> </span>processor<span class="_ _13"> </span>implementation.<span class="_"> </span>This</div><div class="t m5 x1d h26 y37f4 ff7 fs19 fc1 sc0 ls0 ws0">form<span class="_ _14"> </span>of<span class="_ _14"> </span>simulation<span class="_ _14"> </span>is<span class="_ _14"> </span>useful<span class="_ _15"> </span>for<span class="_ _14"> </span>debugging<span class="_ _14"> </span>programs<span class="_ _14"> </span>before<span class="_ _14"> </span>actual<span class="_ _14"> </span>hardware<span class="_ _15"> </span>is</div><div class="t m5 x1d h26 y37f5 ff7 fs19 fc1 sc0 ls0 ws0">available<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _6"> </span>for<span class="_ _13"> </span>checking<span class="_ _13"> </span>the<span class="_ _13"> </span>result<span class="_ _13"> </span>of<span class="_ _13"> </span>either<span class="_ _13"> </span>simulating<span class="_ _13"> </span>the<span class="_ _13"> </span>hardware<span class="_ _13"> </span>or<span class="_ _6"> </span>running</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
