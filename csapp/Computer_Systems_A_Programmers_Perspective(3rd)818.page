<div id="pf332" class="pf w2 h11" data-page-no="332"><div class="pc pc332 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg332.png"/><div class="t m5 x54 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>8.6<span class="_ _60"> </span>Nonlocal<span class="_ _10"> </span>Jumps<span class="_ _3e"> </span><span class="ffe fs1e">817</span></div><div class="t m5 x26 h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>proper<span class="_"> </span>solution<span class="_"> </span>is<span class="_"> </span>to<span class="_"> </span>use<span class="_"> </span><span class="ffd">sigsuspend</span>.</div><div class="t m5 x31 h2d y6a2a ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;signal.h&gt;</div><div class="t m5 x31 h2d y6a2b ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>sigsuspend(const<span class="_ _1f"> </span>sigset_t<span class="_ _1f"> </span>*mask);</div><div class="t m5 x11a hf2 y6a2c ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span><span class="ff12">−</span>1</div><div class="t m5 x17 h26 y6a2d ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _11"> </span><span class="ffd ls0">sigsuspend<span class="_ _10"> </span><span class="ff7">function<span class="_"> </span>temporarily<span class="_ _13"> </span>replaces<span class="_"> </span>the<span class="_"> </span>current<span class="_"> </span>blocked<span class="_ _13"> </span>set<span class="_"> </span>with<span class="_"> </span></span>mask</span></div><div class="t m5 x17 h26 y6a2e ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>then<span class="_ _11"> </span>suspends<span class="_ _11"> </span>the<span class="_ _11"> </span>process<span class="_ _11"> </span>until<span class="_ _11"> </span>the<span class="_ _11"> </span>receipt<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_ _11"> </span>signal<span class="_ _11"> </span>whose<span class="_ _11"> </span>action<span class="_ _11"> </span>is<span class="_ _11"> </span>either</div><div class="t m5 x17 h26 y6a2f ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>run<span class="_ _13"> </span>a<span class="_"> </span>handler<span class="_ _13"> </span>or<span class="_"> </span>to<span class="_ _13"> </span>terminate<span class="_"> </span>the<span class="_ _13"> </span>process<span class="_ _1"></span>.<span class="_"> </span>If<span class="_ _13"> </span>the<span class="_"> </span>action<span class="_ _13"> </span>is<span class="_"> </span>to<span class="_ _13"> </span>terminate<span class="_ _1"></span>,<span class="_"> </span>then<span class="_"> </span>the</div><div class="t m5 x17 h26 y6a30 ff7 fs19 fc2 sc0 ls0 ws0">process<span class="_ _16"> </span>terminates<span class="_ _11"> </span>without<span class="_ _16"> </span>returning<span class="_ _16"> </span>from<span class="_ _11"> </span><span class="ffd">sigsuspend</span>.<span class="_ _16"> </span>If<span class="_ _16"> </span>the<span class="_ _11"> </span>action<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _11"> </span>run<span class="_ _16"> </span>a</div><div class="t m5 x17 h26 y6a31 ff7 fs19 fc2 sc0 ls0 ws0">handler,<span class="_ _13"> </span>then<span class="_ _13"> </span><span class="ffd">sigsuspend<span class="_ _13"> </span></span>returns<span class="_"> </span>after<span class="_ _13"> </span>the<span class="_ _13"> </span>handler<span class="_ _13"> </span>returns<span class="_ _1"></span>,<span class="_"> </span>restoring<span class="_ _13"> </span>the<span class="_ _13"> </span>blocked</div><div class="t m5 x17 h26 y6a32 ff7 fs19 fc2 sc0 ls0 ws0">set<span class="_"> </span>to<span class="_"> </span>its<span class="_"> </span>state<span class="_"> </span>when<span class="_"> </span><span class="ffd">sigsuspend<span class="_ _10"> </span></span>was<span class="_"> </span>called.</div><div class="t m5 x26 h26 y6a33 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _10"> </span><span class="ffd ls0">sigsuspend<span class="_ _13"> </span><span class="ff7">function<span class="_ _13"> </span>is<span class="_ _13"> </span>equivalent<span class="_ _13"> </span>to<span class="_ _13"> </span>an<span class="_ _13"> </span><span class="ffa">atomic<span class="_"> </span></span>(uninterruptible)<span class="_ _13"> </span>version</span></span></div><div class="t m5 x17 h26 y6a34 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_"> </span>following:</div><div class="t m5 x2c h2d y6a35 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _20"> </span><span class="ffd fs1e fc2">sigprocmask(SIG_BLOCK,<span class="_ _e"> </span>&amp;mask,<span class="_ _1f"> </span>&amp;prev);</span></div><div class="t m5 x2c h2d y6a36 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _20"> </span><span class="ffd fs1e fc2">pause();</span></div><div class="t m5 x2c h2d y6a37 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">sigprocmask(SIG_SETMASK,<span class="_ _e"> </span>&amp;prev,<span class="_ _1f"> </span>NULL);</span></div><div class="t m5 x17 h26 y6a38 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>atomic<span class="_"> </span>property<span class="_"> </span>guarantees<span class="_"> </span>that<span class="_ _13"> </span>the<span class="_"> </span>calls<span class="_"> </span>to<span class="_"> </span><span class="ffd">sigprocmask<span class="_ _10"> </span></span>(line<span class="_ _13"> </span>1)<span class="_"> </span>and<span class="_"> </span><span class="ffd">pause</span></div><div class="t m5 x17 h26 y6a39 ff7 fs19 fc2 sc0 ls0 ws0">(line<span class="_ _16"> </span>2)<span class="_ _16"> </span>occur<span class="_ _16"> </span>together<span class="_ _0"></span>,<span class="_ _16"> </span>without<span class="_ _16"> </span>being<span class="_ _16"> </span>interrupted.<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>eliminates<span class="_ _16"> </span>the<span class="_ _16"> </span>potential</div><div class="t m5 x17 h26 y6a3a ff7 fs19 fc2 sc0 ls0 ws0">race<span class="_ _11"> </span>where<span class="_ _11"> </span>a<span class="_ _16"> </span>signal<span class="_ _11"> </span>is<span class="_ _11"> </span>received<span class="_ _16"> </span>after<span class="_"> </span>the<span class="_ _16"> </span>call<span class="_ _11"> </span>to<span class="_ _11"> </span><span class="ffd">sigprocmask<span class="_ _16"> </span></span>and<span class="_ _11"> </span>before<span class="_ _11"> </span>the<span class="_ _11"> </span>call</div><div class="t m5 x17 h26 y6a3b ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span><span class="ffd">pause</span>.</div><div class="t m5 x26 h26 y6a3c ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _15"> </span>8.42<span class="_ _14"> </span>shows<span class="_ _14"> </span>how<span class="_ _15"> </span>we<span class="_ _14"> </span>would<span class="_ _14"> </span>use<span class="_ _15"> </span><span class="ffd">sigsuspend<span class="_ _14"> </span></span>to<span class="_ _14"> </span>replace<span class="_ _14"> </span>the<span class="_ _15"> </span>spin<span class="_ _14"> </span>loop</div><div class="t m5 x17 h26 y6a3d ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _e"> </span>F<span class="_ _0"></span>igure<span class="_ _e"> </span>8.41.<span class="_ _e"> </span>Before<span class="_ _1f"> </span>each<span class="_ _e"> </span>call<span class="_ _e"> </span>to<span class="_ _1f"> </span><span class="ffd">sigsuspend</span>,<span class="_ _1f"> </span>SIGCHLD<span class="_ _1f"> </span>is<span class="_ _e"> </span>blocked.<span class="_ _e"> </span>T<span class="_ _0"></span>he</div><div class="t m5 x17 h26 y6a3e ffd fs19 fc2 sc0 ls0 ws0">sigsuspend<span class="_ _14"> </span><span class="ff7">temporarily<span class="_ _14"> </span>unblocks<span class="_ _14"> </span>SIGCHLD<span class="_ _3"></span>,<span class="_ _15"> </span>and<span class="_ _14"> </span>then<span class="_ _14"> </span>sleeps<span class="_ _14"> </span>until<span class="_ _14"> </span>the<span class="_ _15"> </span>parent</span></div><div class="t m5 x17 h26 y6a3f ff7 fs19 fc2 sc0 ls0 ws0">catches<span class="_ _6"> </span>a<span class="_ _13"> </span>signal.<span class="_ _6"> </span>Before<span class="_ _6"> </span>returning,<span class="_ _13"> </span>it<span class="_ _6"> </span>restores<span class="_ _13"> </span>the<span class="_ _a"> </span>original<span class="_ _13"> </span>blocked<span class="_ _6"> </span>set,<span class="_ _13"> </span>which<span class="_ _6"> </span>blocks</div><div class="t m5 x17 h26 y6a40 ff7 fs19 fc2 sc0 ls0 ws0">SIGCHLD<span class="_"> </span>again.<span class="_ _13"> </span>If<span class="_"> </span>the<span class="_"> </span>parent<span class="_"> </span>caught<span class="_ _13"> </span>a<span class="_"> </span>SIGINT<span class="_ _7"></span>,<span class="_"> </span>then<span class="_"> </span>the<span class="_"> </span>loop<span class="_ _13"> </span>test<span class="_"> </span>succeeds<span class="_"> </span>and</div><div class="t m5 x17 h26 y6a41 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>next<span class="_ _13"> </span>iteration<span class="_"> </span>calls<span class="_"> </span><span class="ffd">sigsuspend<span class="_ _13"> </span></span>again.<span class="_"> </span>If<span class="_ _13"> </span>the<span class="_"> </span>parent<span class="_"> </span>caught<span class="_ _13"> </span>a<span class="_"> </span>SIGCHLD<span class="_ _3"></span>,<span class="_"> </span>then</div><div class="t m5 x17 h26 y6a42 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>loop<span class="_ _11"> </span>test<span class="_ _11"> </span>fails<span class="_ _11"> </span>and<span class="_ _11"> </span>we<span class="_"> </span>exit<span class="_ _11"> </span>the<span class="_ _11"> </span>loop<span class="_ _0"></span>.<span class="_"> </span>At<span class="_ _11"> </span>this<span class="_ _11"> </span>point,<span class="_ _11"> </span>SIGCHLD<span class="_ _11"> </span>is<span class="_"> </span>blocked,<span class="_ _11"> </span>and</div><div class="t m5 x17 h26 y6a43 ff7 fs19 fc2 sc0 ls0 ws0">so<span class="_"> </span>we<span class="_ _13"> </span>can<span class="_"> </span>optionally<span class="_"> </span>unblock<span class="_"> </span>SIGCHLD<span class="_ _3"></span>.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>might<span class="_"> </span>be<span class="_ _13"> </span>useful<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>real<span class="_ _13"> </span>shell<span class="_"> </span>with</div><div class="t m5 x17 h26 y6a44 ff7 fs19 fc2 sc0 ls0 ws0">background<span class="_"> </span>jobs<span class="_"> </span>that<span class="_"> </span>need<span class="_"> </span>to<span class="_"> </span>be<span class="_"> </span>reaped.</div><div class="t m5 x26 h26 y6a45 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_"> </span><span class="ffd ls0">sigsuspend<span class="_ _13"> </span><span class="ff7">version<span class="_ _13"> </span>is<span class="_ _13"> </span>less<span class="_ _13"> </span>wasteful<span class="_ _6"> </span>than<span class="_ _13"> </span>the<span class="_ _13"> </span>original<span class="_ _13"> </span>spin<span class="_ _13"> </span>loop<span class="_ _1"></span>,<span class="_ _13"> </span>avoids<span class="_ _13"> </span>the</span></span></div><div class="t m5 x17 h26 y6a46 ff7 fs19 fc2 sc0 ls0 ws0">race<span class="_"> </span>introduced<span class="_"> </span>by<span class="_"> </span><span class="ffd">pause</span>,<span class="_"> </span>and<span class="_"> </span>is<span class="_"> </span>more<span class="_"> </span>efﬁcient<span class="_"> </span>than<span class="_"> </span><span class="ffd">sleep</span>.</div><div class="t m5 x17 h3b y591f fff fs24 fc6 sc0 ls0 ws0">8.6</div><div class="t m5 x77 h3e y226b ffe fs18 fc6 sc0 ls0 ws0">Nonlocal<span class="_"> </span>Jumps</div><div class="t m5 x17 h26 y543 ff7 fs19 fc1 sc0 ls0 ws0">C<span class="_ _11"> </span>provides<span class="_ _11"> </span>a<span class="_ _11"> </span>form<span class="_ _11"> </span>of<span class="_ _11"> </span>user<span class="_ _1"></span>-level<span class="_ _11"> </span>exceptional<span class="_ _11"> </span>control<span class="_ _11"> </span>ﬂow<span class="_ _3"></span>,<span class="_ _16"> </span>called<span class="_"> </span>a<span class="_ _11"> </span><span class="ffa">nonlocal<span class="_ _11"> </span>jump</span>,</div><div class="t m5 x17 h26 y544 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _16"> </span>transfers<span class="_ _16"> </span>control<span class="_ _16"> </span>directly<span class="_ _16"> </span>from<span class="_ _16"> </span>one<span class="_ _16"> </span>function<span class="_ _16"> </span>to<span class="_ _16"> </span>another<span class="_ _14"> </span>currently<span class="_ _16"> </span>executing</div><div class="t m5 x17 h26 y545 ff7 fs19 fc1 sc0 ls0 ws0">function<span class="_ _13"> </span>without<span class="_"> </span>having<span class="_ _13"> </span>to<span class="_ _13"> </span>go<span class="_ _13"> </span>through<span class="_"> </span>the<span class="_ _13"> </span>normal<span class="_ _13"> </span>call-and-return<span class="_ _13"> </span>sequence.<span class="_ _13"> </span>Non-</div><div class="t m5 x17 h26 y546 ff7 fs19 fc1 sc0 ls0 ws0">local<span class="_"> </span>jumps<span class="_"> </span>are<span class="_"> </span>provided<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span><span class="ffd">setjmp<span class="_ _10"> </span></span>and<span class="_"> </span><span class="ffd">longjmp<span class="_ _10"> </span></span>functions<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
