<div id="pf306" class="pf w2 h11" data-page-no="306"><div class="pc pc306 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg306.png"/><div class="t m5 x205 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>8.3<span class="_ _60"> </span>System<span class="_ _10"> </span>Call<span class="_ _10"> </span>Error<span class="_ _10"> </span>Handling<span class="_ _3e"> </span><span class="ffe fs1e">773</span></div><div class="t m5 x17 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>8.14</div><div class="t m5 x17 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Anatomy<span class="_ _16"> </span>of<span class="_ _16"> </span>a<span class="_ _14"> </span>process</div><div class="t m5 x17 h2f y58b ffe fs16 fc1 sc0 ls0 ws0">context<span class="_"> </span>switch.</div><div class="t m5 x3f h3f y6568 ff97 fs27 fc1 sc0 ls0 ws5">Process A<span class="_ _b2"> </span>Process <span class="_ _2"></span>B</div><div class="t m5 xd6 h3f y6569 ff97 fs27 fc1 sc0 ls0 ws0">User code</div><div class="t m5 xd6 h3f y656a ff97 fs27 fc1 sc0 ls0 ws0">Kernel code</div><div class="t m5 x16b h3f y656b ff97 fs27 fc1 sc0 ls0 ws0">Kernel code</div><div class="t m5 xd6 h3f y656c ff97 fs27 fc1 sc0 ls0 ws0">User code</div><div class="t m5 x16b h3f y656d ff97 fs27 fc1 sc0 ls0 ws0">User code</div><div class="t m5 x211 h3f y656e ff98 fs27 fc1 sc0 ls0 ws0">Contex</div><div class="c xb3 y656f w29 hff"><div class="t m5 x18 h3f y6570 ff98 fs27 fc1 sc0 ls0 ws0">t</div></div><div class="t m5 x211 h3f y6571 ff98 fs27 fc1 sc0 ls0 ws0">switch</div><div class="t m5 x211 h3f y6572 ff98 fs27 fc1 sc0 ls0 ws0">Contex</div><div class="c xb3 y656f w29 hff"><div class="t m5 x18 h3f y6573 ff98 fs27 fc1 sc0 ls0 ws0">t</div></div><div class="t m5 x211 h3f y6574 ff98 fs27 fc1 sc0 ls0 ws0">switch</div><div class="t m5 xb3 h3f y6575 ff97 fs27 fc1 sc0 ls0 ws0">T<span class="_ _0"></span>ime</div><div class="t m5 xe1 h40 y6576 ff99 fs28 fc1 sc0 ls0 ws0">read</div><div class="t m5 x10e h3f y6577 ff98 fs27 fc1 sc0 ls0 ws0">Disk interrupt</div><div class="t m5 xbe h3f y6578 ff98 fs27 fc1 sc0 ls0 ws0">Return</div><div class="t m5 x1eb h3f y6579 ff98 fs27 fc1 sc0 ls0 ws0">from<span class="ff97"> </span></div><div class="t m5 xe1 h40 y657a ff99 fs28 fc1 sc0 ls0 ws0">read</div><div class="t m5 x17 h26 y657b ff7 fs19 fc1 sc0 ls0 ws0">processor<span class="_"> </span>after<span class="_"> </span>the<span class="_ _11"> </span>disk<span class="_"> </span>controller<span class="_"> </span>has<span class="_ _11"> </span>ﬁnished<span class="_"> </span>transferring<span class="_ _11"> </span>the<span class="_"> </span>data<span class="_"> </span>from<span class="_ _11"> </span>disk<span class="_"> </span>to</div><div class="t m5 x17 h26 y657c ff7 fs19 fc1 sc0 ls0 ws0">memory<span class="_ _3"></span>.</div><div class="t m5 x26 h26 y657d ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>disk<span class="_ _13"> </span>will<span class="_ _13"> </span>take<span class="_ _13"> </span>a<span class="_"> </span>relatively<span class="_ _13"> </span>long<span class="_ _13"> </span>time<span class="_"> </span>to<span class="_ _13"> </span>fetch<span class="_ _13"> </span>the<span class="_ _13"> </span>data<span class="_"> </span>(on<span class="_ _13"> </span>the<span class="_ _13"> </span>order<span class="_"> </span>of<span class="_ _13"> </span>tens</div><div class="t m5 x17 h26 y657e ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _13"> </span>milliseconds),<span class="_ _13"> </span>so<span class="_ _13"> </span>instead<span class="_ _13"> </span>of<span class="_ _13"> </span>waiting<span class="_ _13"> </span>and<span class="_ _13"> </span>doing<span class="_ _13"> </span>nothing<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>interim,<span class="_ _13"> </span>the<span class="_ _13"> </span>kernel</div><div class="t m5 x17 h26 y657f ff7 fs19 fc1 sc0 ls0 ws0">performs<span class="_"> </span>a<span class="_ _11"> </span>context<span class="_"> </span>switch<span class="_ _11"> </span>from<span class="_ _11"> </span>process<span class="_"> </span>A<span class="_ _11"> </span>to<span class="_"> </span>B<span class="_ _1"></span>.<span class="_"> </span>Note<span class="_ _11"> </span>that,<span class="_ _11"> </span>before<span class="_"> </span>the<span class="_ _11"> </span>switch,<span class="_ _11"> </span>the</div><div class="t m5 x17 h26 y6580 ff7 fs19 fc1 sc0 ls0 ws0">kernel<span class="_ _16"> </span>is<span class="_ _16"> </span>executing<span class="_ _16"> </span>instructions<span class="_ _16"> </span>in<span class="_ _11"> </span>user<span class="_ _16"> </span>mode<span class="_ _16"> </span>on<span class="_ _16"> </span>behalf<span class="_ _16"> </span>of<span class="_ _16"> </span>process<span class="_ _16"> </span>A<span class="_ _16"> </span>(i.e<span class="_ _1"></span>.,<span class="_ _14"> </span>there</div><div class="t m5 x17 h26 y6581 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _16"> </span>no<span class="_ _14"> </span>separate<span class="_ _16"> </span>kernel<span class="_ _14"> </span>process).<span class="_ _14"> </span>During<span class="_ _16"> </span>the<span class="_ _14"> </span>ﬁrst<span class="_ _16"> </span>part<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _16"> </span>switch,<span class="_ _15"> </span>the<span class="_ _16"> </span>kernel<span class="_ _14"> </span>is</div><div class="t m5 x17 h26 y6582 ff7 fs19 fc1 sc0 ls0 ws0">executing<span class="_ _13"> </span>instructions<span class="_"> </span>in<span class="_ _13"> </span>kernel<span class="_"> </span>mode<span class="_ _13"> </span>on<span class="_ _13"> </span>behalf<span class="_"> </span>of<span class="_ _13"> </span>process<span class="_ _13"> </span>A.<span class="_"> </span>T<span class="_ _1"></span>hen<span class="_"> </span>at<span class="_ _13"> </span>some<span class="_ _13"> </span>point</div><div class="t m5 x17 h26 y6583 ff7 fs19 fc1 sc0 ls0 ws0">it<span class="_"> </span>begins<span class="_ _13"> </span>executing<span class="_"> </span>instructions<span class="_ _13"> </span>(still<span class="_"> </span>in<span class="_"> </span>kernel<span class="_ _13"> </span>mode)<span class="_"> </span>on<span class="_"> </span>behalf<span class="_ _13"> </span>of<span class="_"> </span>process<span class="_ _13"> </span>B<span class="_ _1"></span>.<span class="_"> </span>And</div><div class="t m5 x17 h26 y6584 ff7 fs19 fc1 sc0 ls0 ws0">after<span class="_ _14"> </span>the<span class="_ _14"> </span>switch,<span class="_ _14"> </span>the<span class="_ _14"> </span>kernel<span class="_ _14"> </span>is<span class="_ _14"> </span>executing<span class="_ _14"> </span>instructions<span class="_ _14"> </span>in<span class="_ _14"> </span>user<span class="_ _14"> </span>mode<span class="_ _14"> </span>on<span class="_ _14"> </span>behalf<span class="_ _14"> </span>of</div><div class="t m5 x17 h26 y6585 ff7 fs19 fc1 sc0 ls0 ws0">process<span class="_"> </span>B<span class="_ _3"></span>.</div><div class="t m5 x26 h26 y6586 ff7 fs19 fc1 sc0 ls0 ws0">Process<span class="_"> </span>B<span class="_ _13"> </span>then<span class="_"> </span>runs<span class="_ _13"> </span>for<span class="_"> </span>a<span class="_ _13"> </span>while<span class="_"> </span>in<span class="_"> </span>user<span class="_ _13"> </span>mode<span class="_"> </span>until<span class="_ _13"> </span>the<span class="_"> </span>disk<span class="_"> </span>sends<span class="_ _13"> </span>an<span class="_"> </span>interrupt</div><div class="t m5 x17 h26 y6587 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _13"> </span>signal<span class="_ _13"> </span>that<span class="_ _13"> </span>data<span class="_ _13"> </span>have<span class="_ _13"> </span>been<span class="_ _13"> </span>transferred<span class="_ _13"> </span>from<span class="_ _13"> </span>disk<span class="_ _6"> </span>to<span class="_ _13"> </span>memory<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _0"></span>he<span class="_ _13"> </span>kernel<span class="_ _13"> </span>decides</div><div class="t m5 x17 h26 y6588 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _13"> </span>process<span class="_"> </span>B<span class="_ _13"> </span>has<span class="_ _13"> </span>run<span class="_"> </span>long<span class="_ _13"> </span>enough<span class="_ _13"> </span>and<span class="_ _13"> </span>performs<span class="_"> </span>a<span class="_ _13"> </span>context<span class="_ _13"> </span>switch<span class="_"> </span>from<span class="_ _13"> </span>process<span class="_ _13"> </span>B</div><div class="t m5 x17 h26 y6589 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>A,<span class="_"> </span>returning<span class="_"> </span>control<span class="_"> </span>in<span class="_"> </span>process<span class="_"> </span>A<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>instruction<span class="_"> </span>immediately<span class="_"> </span>following<span class="_"> </span>the</div><div class="t m5 x17 h26 y658a ffd fs19 fc1 sc0 ls0 ws0">read<span class="_ _10"> </span><span class="ff7">system<span class="_"> </span>call.<span class="_"> </span>Process<span class="_"> </span>A<span class="_"> </span>continues<span class="_"> </span>to<span class="_"> </span>run<span class="_"> </span>until<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>exception<span class="_"> </span>occurs<span class="_ _1"></span>,<span class="_"> </span>and</span></div><div class="t m5 x17 h26 y658b ff7 fs19 fc1 sc0 ls0 ws0">so<span class="_"> </span>on.</div><div class="t m5 x17 h3b y658c fff fs24 fc6 sc0 ls0 ws0">8.3<span class="_ _17"> </span><span class="ffe fs18">System<span class="_"> </span>Call<span class="_"> </span>Error<span class="_"> </span>Handling</span></div><div class="t m5 x17 h46 y658d ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _16"> </span>Unix<span class="_ _16"> </span>system-level<span class="_ _16"> </span>functions<span class="_ _14"> </span>encounter<span class="_ _16"> </span>an<span class="_ _16"> </span>error,<span class="_ _14"> </span>they<span class="_ _16"> </span>typically<span class="_ _14"> </span>return<span class="_ _16"> </span><span class="ff12">−</span>1</div><div class="t m5 x17 h26 y658e ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>set<span class="_"> </span>the<span class="_ _11"> </span>global<span class="_"> </span>integer<span class="_"> </span>variable<span class="_ _11"> </span><span class="ffd">errno<span class="_ _10"> </span></span>to<span class="_"> </span>indicate<span class="_ _11"> </span>what<span class="_"> </span>went<span class="_"> </span>wrong.<span class="_"> </span>Program-</div><div class="t m5 x17 h26 y658f ff7 fs19 fc1 sc0 ls0 ws0">mers<span class="_"> </span>should<span class="_ _13"> </span><span class="ffa">always<span class="_"> </span></span>check<span class="_ _13"> </span>for<span class="_"> </span>errors<span class="_ _1"></span>,<span class="_"> </span>but<span class="_ _13"> </span>unfortunately<span class="_ _3"></span>,<span class="_"> </span>many<span class="_"> </span>skip<span class="_ _13"> </span>error<span class="_"> </span>checking</div><div class="t m5 x17 h26 y6590 ff7 fs19 fc1 sc0 ls0 ws0">because<span class="_"> </span>it<span class="_"> </span>bloats<span class="_ _11"> </span>the<span class="_"> </span>code<span class="_"> </span>and<span class="_ _11"> </span>makes<span class="_"> </span>it<span class="_"> </span>harder<span class="_ _11"> </span>to<span class="_"> </span>read.<span class="_"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>example<span class="_ _0"></span>,<span class="_"> </span>here<span class="_"> </span>is<span class="_ _11"> </span>how</div><div class="t m5 x17 h26 y6591 ff7 fs19 fc1 sc0 ls0 ws0">we<span class="_"> </span>might<span class="_"> </span>check<span class="_"> </span>for<span class="_"> </span>errors<span class="_"> </span>when<span class="_"> </span>we<span class="_"> </span>call<span class="_"> </span>the<span class="_"> </span>Linux<span class="_"> </span><span class="ffd">fork<span class="_ _10"> </span></span>function:</div><div class="t m5 x2c h2d y6592 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((pid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>fork())<span class="_ _e"> </span>&lt;<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{</span></div><div class="t m5 x2c h2d y6593 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _70"> </span><span class="ffd fs1e fc2">fprintf(stderr,<span class="_ _e"> </span>&quot;fork<span class="_ _1f"> </span>error:<span class="_ _1f"> </span>%s\n&quot;,<span class="_ _e"> </span>strerror(errno));</span></div><div class="t m5 x2c h2d y6594 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _70"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x2c h2e y6595 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x142 h2d y6596 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h26 y7a6 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _15"> </span><span class="ffd ls0">strerror<span class="_ _14"> </span><span class="ff7">function<span class="_ _14"> </span>returns<span class="_ _14"> </span>a<span class="_ _14"> </span>text<span class="_ _14"> </span>string<span class="_ _14"> </span>that<span class="_ _14"> </span>describes<span class="_ _14"> </span>the<span class="_ _14"> </span>error<span class="_ _14"> </span>associated</span></span></div><div class="t m5 x17 h26 y7a7 ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_"> </span>a<span class="_"> </span>particular<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_"> </span><span class="ffd">errno</span>.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>can<span class="_"> </span>simplify<span class="_"> </span>this<span class="_"> </span>code<span class="_"> </span>somewhat<span class="_"> </span>by<span class="_ _13"> </span>deﬁning</div><div class="t m5 x17 h26 y7a8 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>following<span class="_"> </span><span class="ffa">error<span class="_ _1"></span>-reporting<span class="_"> </span>function:</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
