<div id="pf129" class="pf w2 h11" data-page-no="129"><div class="pc pc129 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg129.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">296<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 xad h61 ye7 ff13 fs35 fc6 sc0 ls0 ws0">long<span class="_ _f"> </span>sum_element(long<span class="_ _f"> </span>i,<span class="_ _f"> </span>long<span class="_ _e"> </span>j)</div><div class="t m5 xad h61 y26dc ff13 fs35 fc6 sc0 ls0 ws0">i<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>j<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi</div><div class="t m5 x1f h2d yecb ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">sum_element:</span></div><div class="t m5 x1f h2d yecc ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">leaq<span class="_ _46"> </span>0(,%rdi,8),<span class="_ _e"> </span>%rdx</span></div><div class="t m5 x1f h2d yecd ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">subq<span class="_ _46"> </span>%rdi,<span class="_ _e"> </span>%rdx</span></div><div class="t m5 x1f h2d yece ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>%rsi,<span class="_ _e"> </span>%rdx</span></div><div class="t m5 x1f h2d yecf ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">leaq<span class="_ _46"> </span>(%rsi,%rsi,4),<span class="_ _e"> </span>%rax</span></div><div class="t m5 x1f h2d yed0 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>%rax,<span class="_ _e"> </span>%rdi</span></div><div class="t m5 x1f h2e y20fe ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x10d h2d y1a10 ffd fs1e fc2 sc0 ls0 ws0">movq<span class="_ _46"> </span>Q(,%rdi,8),<span class="_ _e"> </span>%rax</div><div class="t m5 x1f h2d yed3 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>P(,%rdx,8),<span class="_ _e"> </span>%rax</span></div><div class="t m5 x1f h2d yed4 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _45"> </span><span class="ffd fs1e fc2">ret</span></div><div class="t m5 x29 h26 y2b09 ff7 fs19 fc2 sc0 ls0 ws0">Use<span class="_ _13"> </span>your<span class="_ _13"> </span>reverse<span class="_ _13"> </span>engineering<span class="_ _13"> </span>skills<span class="_ _13"> </span>to<span class="_ _13"> </span>determine<span class="_ _6"> </span>the<span class="_ _13"> </span>values<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ff11">M<span class="_ _11"> </span></span>and<span class="_ _13"> </span><span class="ff11">N<span class="_ _11"> </span></span>based</div><div class="t m5 x1d h26 y2b0a ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_"> </span>this<span class="_"> </span>assembly<span class="_"> </span>code<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y2b0b ffe fs29 fc1 sc0 ls0 ws0">3.8.4<span class="_ _48"> </span><span class="fs19">Fixed-Size<span class="_"> </span>Arrays</span></div><div class="t m5 x1d h26 y2b0c ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>C<span class="_"> </span>compiler<span class="_"> </span>is<span class="_ _11"> </span>able<span class="_"> </span>to<span class="_"> </span>make<span class="_"> </span>many<span class="_"> </span>optimizations<span class="_"> </span>for<span class="_"> </span>code<span class="_"> </span>operating<span class="_"> </span>on<span class="_"> </span>multi-</div><div class="t m5 x1d h26 y2b0d ff7 fs19 fc1 sc0 ls0 ws0">dimensional<span class="_"> </span>arrays<span class="_"> </span>of<span class="_"> </span>ﬁxed<span class="_"> </span>size<span class="_ _1"></span>.<span class="_"> </span>Here<span class="_"> </span>we<span class="_"> </span>demonstrate<span class="_"> </span>some<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>optimizations</div><div class="t m5 x1d h26 y2b0e ff7 fs19 fc1 sc0 ls0 ws0">made<span class="_ _14"> </span>by<span class="_ _15"> </span><span class="ff9">gcc<span class="_ _14"> </span></span>when<span class="_ _15"> </span>the<span class="_ _15"> </span>optimization<span class="_ _14"> </span>level<span class="_ _15"> </span>is<span class="_ _15"> </span>set<span class="_ _14"> </span>with<span class="_ _15"> </span>the<span class="_ _14"> </span>ﬂag<span class="_ _15"> </span><span class="ffd">-O1</span>.<span class="_ _15"> </span>Suppose<span class="_ _14"> </span>we</div><div class="t m5 x1d h46 y2b0f ff7 fs19 fc1 sc0 ls0 ws0">declare<span class="_"> </span>data<span class="_"> </span>type<span class="_"> </span><span class="ffd">fix_matrix<span class="_ _10"> </span></span>to<span class="_"> </span>be<span class="_"> </span>16<span class="_ _13"> </span><span class="ff12">×<span class="_ _10"> </span></span>16<span class="_"> </span>arrays<span class="_"> </span>of<span class="_"> </span>integers<span class="_"> </span>as<span class="_"> </span>follows:</div><div class="t m5 x1d h2d y2b10 ffd fs1e fc2 sc0 ls0 ws0">#define<span class="_ _e"> </span>N<span class="_ _1f"> </span>16</div><div class="t m5 x1d h2d y2b11 ffd fs1e fc2 sc0 ls0 ws0">typedef<span class="_ _e"> </span>int<span class="_ _1f"> </span>fix_matrix[N][N];</div><div class="t m5 x1d h26 y2b12 ff7 fs19 fc2 sc0 ls0 ws0">(T<span class="_ _1"></span>his<span class="_"> </span>example<span class="_"> </span>illustrates<span class="_"> </span>a<span class="_"> </span>good<span class="_ _13"> </span>coding<span class="_"> </span>practice<span class="_ _0"></span>.<span class="_"> </span>W<span class="_ _0"></span>henever<span class="_"> </span>a<span class="_"> </span>program<span class="_ _13"> </span>uses<span class="_"> </span>some</div><div class="t m5 x1d h26 y2b13 ff7 fs19 fc2 sc0 ls0 ws0">constant<span class="_ _11"> </span>as<span class="_ _16"> </span>an<span class="_ _11"> </span>array<span class="_ _11"> </span>dimension<span class="_ _16"> </span>or<span class="_ _11"> </span>buffer<span class="_ _11"> </span>size,<span class="_ _11"> </span>it<span class="_ _11"> </span>is<span class="_ _16"> </span>best<span class="_ _11"> </span>to<span class="_ _11"> </span>associate<span class="_ _16"> </span>a<span class="_ _11"> </span>name<span class="_ _11"> </span>with</div><div class="t m5 x1d h26 y2b14 ff7 fs19 fc2 sc0 ls0 ws0">it<span class="_ _15"> </span>via<span class="_ _21"> </span>a<span class="_ _21"> </span><span class="ffd">#define<span class="_ _15"> </span></span>declaration,<span class="_ _f"> </span>and<span class="_ _21"> </span>then<span class="_ _21"> </span>use<span class="_ _15"> </span>this<span class="_ _21"> </span>name<span class="_ _21"> </span>consistently<span class="_ _3"></span>,<span class="_ _21"> </span>rather<span class="_ _21"> </span>than</div><div class="t m5 x1d h26 y2b15 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>numeric<span class="_ _15"> </span>value.<span class="_ _14"> </span>T<span class="_ _1"></span>hat<span class="_ _15"> </span>way<span class="_ _3"></span>,<span class="_ _21"> </span>if<span class="_ _14"> </span>an<span class="_ _15"> </span>occasion<span class="_ _15"> </span>ever<span class="_ _15"> </span>arises<span class="_ _14"> </span>to<span class="_ _15"> </span>change<span class="_ _15"> </span>the<span class="_ _15"> </span>value<span class="_ _1"></span>,<span class="_ _21"> </span>it</div><div class="t m5 x1d h26 y2b16 ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_ _16"> </span>be<span class="_ _16"> </span>done<span class="_ _16"> </span>by<span class="_ _16"> </span>simply<span class="_ _16"> </span>modifying<span class="_ _16"> </span>the<span class="_ _14"> </span><span class="ffd">#define<span class="_ _16"> </span></span>declaration.)<span class="_ _16"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span>code<span class="_ _16"> </span>in<span class="_ _16"> </span>F<span class="_ _0"></span>igure</div><div class="t m5 x1d h26 y2b17 ff7 fs19 fc2 sc0 ls0 ws0">3.37(a)<span class="_ _f"> </span>computes<span class="_ _e"> </span>element<span class="_ _f"> </span><span class="ff11 ls93">i,<span class="_ _10"> </span>k<span class="_ _e"> </span></span>of<span class="_ _e"> </span>the<span class="_ _f"> </span>product<span class="_ _e"> </span>of<span class="_ _f"> </span>arrays<span class="_ _f"> </span><span class="ffd">A<span class="_ _e"> </span></span>and<span class="_ _f"> </span><span class="ffd">B</span>—that<span class="_ _e"> </span>is<span class="_ _3"></span>,<span class="_ _1f"> </span>the</div><div class="t m5 x1d h26 y2b18 ff7 fs19 fc2 sc0 ls0 ws0">inner<span class="_ _15"> </span>product<span class="_ _15"> </span>of<span class="_ _15"> </span>row<span class="_ _15"> </span><span class="ff11">i<span class="_ _e"> </span></span>from<span class="_ _14"> </span><span class="ffd">A<span class="_ _15"> </span></span>and<span class="_ _15"> </span>column<span class="_ _15"> </span><span class="ff11">k<span class="_ _f"> </span></span>from<span class="_ _15"> </span><span class="ffd">B</span>.<span class="_ _15"> </span>This<span class="_ _14"> </span>product<span class="_ _15"> </span>is<span class="_ _15"> </span>given<span class="_ _15"> </span>by</div><div class="t m5 x1d h26 y2b19 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _15"> </span>formula</div><div class="t m5 x59 h5c y2b1a ff1e fs19 fc2 sc0 ls0 ws0"></div><div class="t m5 x1a5 h4b y2b1b ff7 fs25 fc2 sc0 ls0 ws0">0<span class="ff12">≤<span class="ff11 ls175">j&lt;<span class="_ _3"></span>N</span></span></div><div class="t m5 x167 h45 y2b1c ff11 fs19 fc2 sc0 ls0 ws0">a</div><div class="t m5 x116 h50 y2b1d ff11 fs25 fc2 sc0 ls176 ws0">i,j</div><div class="t m5 x16d h45 y2b1e ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 xdd h45 y2b1f ff11 fs19 fc2 sc0 ls0 ws0">b</div><div class="t m5 x9e h50 y2b1d ff11 fs25 fc2 sc0 ls177 ws0">j,<span class="_ _1"></span>k</div><div class="t m5 x15 h26 y2b1c ff7 fs19 fc2 sc0 ls0 ws0">.<span class="_ _15"> </span><span class="ff9">Gcc<span class="_ _21"> </span></span>generates<span class="_ _21"> </span>code<span class="_ _21"> </span>that<span class="_ _21"> </span>we<span class="_ _21"> </span>then<span class="_ _21"> </span>recoded<span class="_ _21"> </span>into</div><div class="t m5 x1d h26 y2b20 ff7 fs19 fc2 sc0 ls0 ws0">C,<span class="_ _14"> </span>shown<span class="_ _15"> </span>as<span class="_ _15"> </span>function<span class="_ _15"> </span><span class="ffd">fix_prod_ele_opt<span class="_ _14"> </span></span>in<span class="_ _15"> </span>Figure<span class="_ _14"> </span>3.37(b).<span class="_ _14"> </span>This<span class="_ _14"> </span>code<span class="_ _14"> </span>contains</div><div class="t m5 x1d h26 y2b21 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>number<span class="_"> </span>of<span class="_"> </span>clever<span class="_"> </span>optimizations<span class="_ _1"></span>.<span class="_"> </span>It<span class="_"> </span>removes<span class="_"> </span>the<span class="_"> </span>integer<span class="_"> </span>index<span class="_"> </span><span class="ffd">j<span class="_ _10"> </span></span>and<span class="_"> </span>converts<span class="_"> </span>all</div><div class="t m5 x1d h26 y2b22 ff7 fs19 fc2 sc0 ls0 ws0">array<span class="_ _16"> </span>references<span class="_ _11"> </span>to<span class="_ _16"> </span>pointer<span class="_ _16"> </span>dereferences<span class="_ _3"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>involves<span class="_ _16"> </span>(1)<span class="_ _11"> </span>generating<span class="_ _16"> </span>a<span class="_ _16"> </span>pointer,</div><div class="t m5 x1d h26 y2b23 ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_ _15"> </span>we<span class="_ _21"> </span>have<span class="_ _21"> </span>named<span class="_ _21"> </span><span class="ffd">Aptr</span>,<span class="_ _f"> </span>that<span class="_ _21"> </span>points<span class="_ _21"> </span>to<span class="_ _21"> </span>successive<span class="_ _21"> </span>elements<span class="_ _15"> </span>in<span class="_ _21"> </span>row<span class="_ _21"> </span><span class="ff11">i<span class="_ _e"> </span></span>of<span class="_ _15"> </span><span class="ffd">A</span>,</div><div class="t m5 x1d h26 y2b24 ff7 fs19 fc2 sc0 ls0 ws0">(2)<span class="_ _14"> </span>generating<span class="_ _14"> </span>a<span class="_ _14"> </span>pointer,<span class="_ _14"> </span>which<span class="_ _14"> </span>we<span class="_ _14"> </span>have<span class="_ _14"> </span>named<span class="_ _14"> </span><span class="ffd">Bptr</span>,<span class="_ _15"> </span>that<span class="_ _14"> </span>points<span class="_ _14"> </span>to<span class="_ _15"> </span>successive</div><div class="t m5 x1d h26 y2b25 ff7 fs19 fc2 sc0 ls0 ws0">elements<span class="_ _16"> </span>in<span class="_ _16"> </span>column<span class="_ _16"> </span><span class="ff11">k<span class="_ _15"> </span></span>of<span class="_ _16"> </span><span class="ffd">B</span>,<span class="_ _16"> </span>and<span class="_ _14"> </span>(3)<span class="_ _16"> </span>generating<span class="_ _16"> </span>a<span class="_ _16"> </span>pointer,<span class="_ _16"> </span>which<span class="_ _16"> </span>we<span class="_ _16"> </span>have<span class="_ _14"> </span>named</div><div class="t m5 x1d h26 y2b26 ffd fs19 fc2 sc0 ls0 ws0">Bend<span class="ff7">,<span class="_ _11"> </span>that<span class="_ _16"> </span>equals<span class="_ _11"> </span>the<span class="_ _11"> </span>value<span class="_ _11"> </span></span>Bptr<span class="_ _16"> </span><span class="ff7">will<span class="_ _11"> </span>have<span class="_ _11"> </span>when<span class="_ _11"> </span>it<span class="_ _16"> </span>is<span class="_ _11"> </span>time<span class="_ _11"> </span>to<span class="_ _11"> </span>terminate<span class="_ _16"> </span>the<span class="_ _11"> </span>loop<span class="_ _1"></span>.</span></div><div class="t m5 x1d h26 y2b27 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>initial<span class="_ _16"> </span>value<span class="_ _16"> </span>for<span class="_ _11"> </span><span class="ffd">Aptr<span class="_ _16"> </span></span>is<span class="_ _16"> </span>the<span class="_ _16"> </span>address<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>ﬁrst<span class="_ _11"> </span>element<span class="_ _16"> </span>of<span class="_ _16"> </span>row<span class="_ _16"> </span><span class="ff11">i<span class="_ _14"> </span></span>of<span class="_ _16"> </span><span class="ffd">A</span>,<span class="_ _16"> </span>given</div><div class="t m5 x1d h26 y2b28 ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_"> </span>the<span class="_ _13"> </span>C<span class="_"> </span>expression<span class="_ _13"> </span><span class="ffd">&amp;A[i][0]</span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>initial<span class="_ _13"> </span>value<span class="_"> </span>for<span class="_ _13"> </span><span class="ffd">Bptr<span class="_ _10"> </span></span>is<span class="_ _13"> </span>the<span class="_"> </span>address<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>ﬁrst</div><div class="t m5 x1d h26 y2b29 ff7 fs19 fc2 sc0 ls0 ws0">element<span class="_ _13"> </span>of<span class="_ _13"> </span>column<span class="_ _13"> </span><span class="ff11">k<span class="_ _10"> </span></span>of<span class="_ _13"> </span><span class="ffd">B</span>,<span class="_"> </span>given<span class="_ _13"> </span>by<span class="_ _13"> </span>the<span class="_ _13"> </span>C<span class="_ _13"> </span>expression<span class="_ _13"> </span><span class="ffd">&amp;B[0][k]</span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>value<span class="_ _13"> </span>for<span class="_ _13"> </span><span class="ffd">Bend</span></div><div class="t m5 x1d h46 y2b2a ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_"> </span>the<span class="_ _13"> </span>index<span class="_"> </span>of<span class="_"> </span>what<span class="_"> </span>would<span class="_ _13"> </span>be<span class="_"> </span>the<span class="_"> </span><span class="ff11">(n<span class="_ _13"> </span><span class="ff12">+<span class="_ _10"> </span></span></span>1<span class="_ _3"></span><span class="ff11">)<span class="ff7">st<span class="_"> </span>element<span class="_"> </span>in<span class="_"> </span>column<span class="_ _13"> </span></span>j<span class="_ _14"> </span><span class="ff7">of<span class="_"> </span><span class="ffd">B</span>,<span class="_"> </span>given<span class="_"> </span>by<span class="_ _13"> </span>the</span></span></div><div class="t m5 x1b0 h26 y2b2b ff7 fs19 fc2 sc0 ls0 ws0">C<span class="_"> </span>expression<span class="_"> </span><span class="ffd">&amp;B[N][k]</span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
