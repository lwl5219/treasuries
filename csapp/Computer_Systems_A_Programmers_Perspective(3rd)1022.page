<div id="pf3fe" class="pf w2 h11" data-page-no="3fe"><div class="pc pc3fe w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3fe.png"/><div class="t m5 x88 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.3<span class="_ _60"> </span>Concurrent<span class="_ _10"> </span>Programming<span class="_ _10"> </span>with<span class="_ _10"> </span>Threads<span class="_ _3e"> </span><span class="ffe fs1e">1021</span></div><div class="t m5 x34 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Event-driven<span class="_ _11"> </span>W<span class="_ _1"></span>eb<span class="_ _16"> </span>servers</span></div><div class="t m5 x34 h2b y258 ff7 fs1e fc2 sc0 ls0 ws0">Despite<span class="_ _6"> </span>the<span class="_ _6"> </span>disadvantages<span class="_ _6"> </span>outlined<span class="_ _13"> </span>in<span class="_ _a"> </span>Section<span class="_ _6"> </span>12.2.2,<span class="_ _13"> </span>modern<span class="_ _6"> </span>high-performance<span class="_ _6"> </span>servers<span class="_ _6"> </span>such<span class="_ _6"> </span>as<span class="_ _13"> </span>Node<span class="_ _1"></span>.js<span class="_ _1"></span>,</div><div class="t m5 x34 h2b y259 ff7 fs1e fc2 sc0 ls0 ws0">nginx,<span class="_ _10"> </span>and<span class="_ _11"> </span>T<span class="_ _3"></span>ornado<span class="_"> </span>use<span class="_ _11"> </span>event-driven<span class="_"> </span>programming<span class="_ _11"> </span>based<span class="_ _10"> </span>on<span class="_ _11"> </span>I/O<span class="_"> </span>multiplexing,<span class="_ _11"> </span>mainly<span class="_"> </span>because<span class="_ _11"> </span>of<span class="_"> </span>the</div><div class="t m5 x34 h2b y25a ff7 fs1e fc2 sc0 ls0 ws0">signiﬁcant<span class="_"> </span>performance<span class="_"> </span>advantage<span class="_"> </span>compared<span class="_"> </span>to<span class="_"> </span>processes<span class="_"> </span>and<span class="_"> </span>threads<span class="_ _1"></span>.</div><div class="t m5 x17 h41 y7fe4 ffe fs29 fc2 sc0 ls0 ws0">12.2.2<span class="_ _48"> </span><span class="fs19">Pros<span class="_"> </span>and<span class="_"> </span>Cons<span class="_"> </span>of<span class="_"> </span>I/O<span class="_"> </span>Multiplexing</span></div><div class="t m5 x17 h26 y7fe5 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>server<span class="_ _16"> </span>in<span class="_ _16"> </span>Figure<span class="_ _11"> </span>12.8<span class="_ _16"> </span>provides<span class="_ _16"> </span>a<span class="_ _16"> </span>nice<span class="_ _16"> </span>example<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>advantages<span class="_ _16"> </span>and<span class="_ _16"> </span>disad-</div><div class="t m5 x17 h26 y7fe6 ff7 fs19 fc2 sc0 ls0 ws0">vantages<span class="_ _13"> </span>of<span class="_ _6"> </span>event-driven<span class="_ _13"> </span>programming<span class="_ _6"> </span>based<span class="_ _13"> </span>on<span class="_ _13"> </span>I/O<span class="_ _6"> </span>multiplexing.<span class="_ _6"> </span>One<span class="_ _13"> </span>advantage</div><div class="t m5 x17 h26 y7fe7 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_"> </span>that<span class="_"> </span>event-driven<span class="_"> </span>designs<span class="_"> </span>give<span class="_ _13"> </span>programmers<span class="_"> </span>more<span class="_"> </span>control<span class="_"> </span>over<span class="_"> </span>the<span class="_"> </span>behavior<span class="_"> </span>of</div><div class="t m5 x17 h26 y7fe8 ff7 fs19 fc2 sc0 ls0 ws0">their<span class="_ _14"> </span>programs<span class="_ _15"> </span>than<span class="_ _15"> </span>process-based<span class="_ _14"> </span>designs<span class="_ _1"></span>.<span class="_ _15"> </span>F<span class="_ _1"></span>or<span class="_ _15"> </span>example<span class="_ _1"></span>,<span class="_ _21"> </span>we<span class="_ _15"> </span>can<span class="_ _14"> </span>imagine<span class="_ _15"> </span>writ-</div><div class="t m5 x17 h26 y7fe9 ff7 fs19 fc2 sc0 ls0 ws0">ing<span class="_ _13"> </span>an<span class="_"> </span>event-driven<span class="_ _13"> </span>concurrent<span class="_ _13"> </span>server<span class="_"> </span>that<span class="_ _13"> </span>gives<span class="_ _13"> </span>preferred<span class="_"> </span>service<span class="_ _13"> </span>to<span class="_ _13"> </span>some<span class="_"> </span>clients<span class="_ _3"></span>,</div><div class="t m5 x17 h26 y7fea ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_"> </span>would<span class="_"> </span>be<span class="_"> </span>difﬁcult<span class="_"> </span>for<span class="_"> </span>a<span class="_"> </span>concurrent<span class="_"> </span>server<span class="_"> </span>based<span class="_"> </span>on<span class="_"> </span>processes<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y7feb ff7 fs19 fc2 sc0 ls0 ws0">Another<span class="_"> </span>advantage<span class="_ _11"> </span>is<span class="_"> </span>that<span class="_ _11"> </span>an<span class="_"> </span>event-driven<span class="_ _11"> </span>server<span class="_ _11"> </span>based<span class="_"> </span>on<span class="_ _11"> </span>I/O<span class="_"> </span>multiplexing</div><div class="t m5 x17 h26 y7fec ff7 fs19 fc2 sc0 ls0 ws0">runs<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>context<span class="_ _16"> </span>of<span class="_ _16"> </span>a<span class="_ _16"> </span>single<span class="_ _16"> </span>process<span class="_ _1"></span>,<span class="_ _16"> </span>and<span class="_ _16"> </span>thus<span class="_ _16"> </span>every<span class="_ _16"> </span>logical<span class="_ _11"> </span>ﬂow<span class="_ _16"> </span>has<span class="_ _16"> </span>access<span class="_ _16"> </span>to</div><div class="t m5 x17 h26 y7fed ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>entire<span class="_"> </span>address<span class="_"> </span>space<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>process<span class="_ _1"></span>.<span class="_"> </span>This<span class="_"> </span>makes<span class="_"> </span>it<span class="_"> </span>easy<span class="_"> </span>to<span class="_"> </span>share<span class="_"> </span>data<span class="_"> </span>between</div><div class="t m5 x17 h26 y7fee ff7 fs19 fc2 sc0 ls0 ws0">ﬂows<span class="_ _1"></span>.<span class="_ _16"> </span>A<span class="_ _16"> </span>related<span class="_ _16"> </span>advantage<span class="_ _16"> </span>of<span class="_ _14"> </span>running<span class="_ _16"> </span>as<span class="_ _16"> </span>a<span class="_ _16"> </span>single<span class="_ _16"> </span>process<span class="_ _16"> </span>is<span class="_ _14"> </span>that<span class="_ _16"> </span>you<span class="_ _16"> </span>can<span class="_ _16"> </span>debug</div><div class="t m5 x17 h26 y7fef ff7 fs19 fc2 sc0 ls0 ws0">your<span class="_ _14"> </span>concurrent<span class="_ _15"> </span>server<span class="_ _15"> </span>as<span class="_ _15"> </span>you<span class="_ _15"> </span>would<span class="_ _15"> </span>any<span class="_ _15"> </span>sequential<span class="_ _14"> </span>program,<span class="_ _21"> </span>using<span class="_ _15"> </span>a<span class="_ _15"> </span>familiar</div><div class="t m5 x17 h26 y7ff0 ff7 fs19 fc2 sc0 ls0 ws0">debugging<span class="_ _16"> </span>tool<span class="_ _16"> </span>such<span class="_ _16"> </span>as<span class="_ _16"> </span><span class="ff9">gdb</span>.<span class="_ _16"> </span>Finally<span class="_ _7"></span>,<span class="_ _14"> </span>event-driven<span class="_ _16"> </span>designs<span class="_ _16"> </span>are<span class="_ _16"> </span>often<span class="_ _16"> </span>signiﬁcantly</div><div class="t m5 x17 h26 y7ff1 ff7 fs19 fc2 sc0 ls0 ws0">more<span class="_ _11"> </span>efﬁcient<span class="_ _11"> </span>than<span class="_ _11"> </span>process-based<span class="_ _11"> </span>designs<span class="_ _11"> </span>because<span class="_ _11"> </span>they<span class="_ _11"> </span>do<span class="_ _11"> </span>not<span class="_ _11"> </span>require<span class="_ _16"> </span>a<span class="_"> </span>process</div><div class="t m5 x17 h26 y7ff2 ff7 fs19 fc2 sc0 ls0 ws0">context<span class="_"> </span>switch<span class="_"> </span>to<span class="_"> </span>schedule<span class="_"> </span>a<span class="_"> </span>new<span class="_"> </span>ﬂow<span class="_ _3"></span>.</div><div class="t m5 x26 h26 y7ff3 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_"> </span>signiﬁcant<span class="_"> </span>disadvantage<span class="_"> </span>of<span class="_"> </span>event-driven<span class="_"> </span>designs<span class="_"> </span>is<span class="_"> </span>coding<span class="_"> </span>complexity<span class="_ _3"></span>.<span class="_"> </span>Our</div><div class="t m5 x17 h26 y7ff4 ff7 fs19 fc2 sc0 ls0 ws0">event-driven<span class="_ _21"> </span>concurrent<span class="_ _21"> </span>echo<span class="_ _21"> </span>server<span class="_ _21"> </span>requires<span class="_ _21"> </span>three<span class="_ _21"> </span>times<span class="_ _21"> </span>more<span class="_ _21"> </span>code<span class="_ _21"> </span>than<span class="_ _21"> </span>the</div><div class="t m5 x17 h26 y7ff5 ff7 fs19 fc2 sc0 ls0 ws0">process-based<span class="_ _11"> </span>server.<span class="_ _11"> </span>Unfortunately<span class="_ _3"></span>,<span class="_ _11"> </span>the<span class="_ _11"> </span>complexity<span class="_ _16"> </span>increases<span class="_ _11"> </span>as<span class="_ _11"> </span>the<span class="_ _11"> </span>granularity</div><div class="t m5 x17 h26 y7ff6 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _13"> </span>the<span class="_ _13"> </span>concurrency<span class="_ _13"> </span>decreases<span class="_ _1"></span>.<span class="_"> </span>By<span class="_ _13"> </span><span class="ffa">granularity</span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>mean<span class="_ _13"> </span>the<span class="_"> </span>number<span class="_ _13"> </span>of<span class="_ _13"> </span>instructions</div><div class="t m5 x17 h26 y7ff7 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _13"> </span>each<span class="_ _13"> </span>logical<span class="_ _13"> </span>ﬂow<span class="_"> </span>executes<span class="_ _13"> </span>per<span class="_ _13"> </span>time<span class="_ _13"> </span>slice<span class="_ _1"></span>.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_ _13"> </span>instance,<span class="_ _13"> </span>in<span class="_ _13"> </span>our<span class="_ _13"> </span>example<span class="_ _13"> </span>concur<span class="_ _1"></span>-</div><div class="t m5 x17 h26 y7ff8 ff7 fs19 fc2 sc0 ls0 ws0">rent<span class="_"> </span>server<span class="_ _0"></span>,<span class="_"> </span>the<span class="_"> </span>granularity<span class="_ _13"> </span>of<span class="_"> </span>concurrency<span class="_"> </span>is<span class="_ _13"> </span>the<span class="_"> </span>number<span class="_"> </span>of<span class="_"> </span>instructions<span class="_ _13"> </span>required</div><div class="t m5 x17 h26 y7ff9 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>read<span class="_ _13"> </span>an<span class="_"> </span>entire<span class="_"> </span>text<span class="_ _13"> </span>line.<span class="_ _13"> </span>As<span class="_"> </span>long<span class="_"> </span>as<span class="_ _13"> </span>some<span class="_"> </span>logical<span class="_"> </span>ﬂow<span class="_ _13"> </span>is<span class="_"> </span>busy<span class="_"> </span>reading<span class="_ _13"> </span>a<span class="_"> </span>text<span class="_"> </span>line<span class="_ _1"></span>,</div><div class="t m5 x17 h26 y7ffa ff7 fs19 fc2 sc0 ls0 ws0">no<span class="_ _13"> </span>other<span class="_"> </span>logical<span class="_ _13"> </span>ﬂow<span class="_"> </span>can<span class="_ _13"> </span>make<span class="_ _13"> </span>progress<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>is<span class="_ _13"> </span>ﬁne<span class="_ _13"> </span>for<span class="_"> </span>our<span class="_ _13"> </span>example<span class="_ _0"></span>,<span class="_"> </span>but<span class="_ _13"> </span>it<span class="_ _13"> </span>makes</div><div class="t m5 x17 h26 y7ffb ff7 fs19 fc2 sc0 ls0 ws0">our<span class="_"> </span>event-driven<span class="_ _11"> </span>server<span class="_ _11"> </span>vulnerable<span class="_ _11"> </span>to<span class="_ _11"> </span>a<span class="_ _11"> </span>malicious<span class="_ _11"> </span>client<span class="_ _11"> </span>that<span class="_ _11"> </span>sends<span class="_ _11"> </span>only<span class="_ _11"> </span>a<span class="_"> </span>partial</div><div class="t m5 x17 h26 y7ffc ff7 fs19 fc2 sc0 ls0 ws0">text<span class="_ _16"> </span>line<span class="_ _11"> </span>and<span class="_ _16"> </span>then<span class="_ _16"> </span>halts<span class="_ _1"></span>.<span class="_ _16"> </span>Modifying<span class="_ _11"> </span>an<span class="_ _16"> </span>event-driven<span class="_ _16"> </span>server<span class="_ _11"> </span>to<span class="_ _16"> </span>handle<span class="_ _16"> </span>partial<span class="_ _16"> </span>text</div><div class="t m5 x17 h26 y7ffd ff7 fs19 fc2 sc0 ls0 ws0">lines<span class="_"> </span>is<span class="_"> </span>a<span class="_"> </span>nontrivial<span class="_"> </span>task,<span class="_"> </span>but<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>handled<span class="_"> </span>cleanly<span class="_"> </span>and<span class="_"> </span>automatically<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>process-</div><div class="t m5 x17 h26 y7ffe ff7 fs19 fc2 sc0 ls0 ws0">based<span class="_ _13"> </span>design.<span class="_ _13"> </span>Another<span class="_ _13"> </span>signiﬁcant<span class="_ _6"> </span>disadvantage<span class="_ _13"> </span>of<span class="_ _13"> </span>event-based<span class="_ _13"> </span>designs<span class="_ _13"> </span>is<span class="_ _13"> </span>that<span class="_ _13"> </span>they</div><div class="t m5 x17 h26 y7fff ff7 fs19 fc2 sc0 ls0 ws0">cannot<span class="_"> </span>fully<span class="_"> </span>utilize<span class="_"> </span>multi-core<span class="_"> </span>processors<span class="_ _1"></span>.</div><div class="t m5 x17 h3b y2269 fff fs24 fc6 sc0 ls0 ws0">12.3<span class="_ _17"> </span><span class="ffe fs18">Concurrent<span class="_"> </span>Programming<span class="_"> </span>with<span class="_"> </span>Threads</span></div><div class="t m5 x17 h26 y24e1 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _16"> </span>this<span class="_ _16"> </span>point,<span class="_ _11"> </span>we<span class="_ _16"> </span>have<span class="_ _16"> </span>looked<span class="_ _11"> </span>at<span class="_ _16"> </span>two<span class="_ _11"> </span>approaches<span class="_ _16"> </span>for<span class="_ _11"> </span>creating<span class="_ _16"> </span>concurrent<span class="_ _11"> </span>logical</div><div class="t m5 x17 h26 y4657 ff7 fs19 fc1 sc0 ls0 ws0">ﬂows<span class="_ _1"></span>.<span class="_ _13"> </span>With<span class="_ _13"> </span>the<span class="_"> </span>ﬁrst<span class="_ _13"> </span>approach,<span class="_ _13"> </span>we<span class="_"> </span>use<span class="_ _13"> </span>a<span class="_"> </span>separate<span class="_ _13"> </span>process<span class="_ _13"> </span>for<span class="_"> </span>each<span class="_ _13"> </span>ﬂow<span class="_ _3"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>kernel</div><div class="t m5 x17 h26 y4658 ff7 fs19 fc1 sc0 ls0 ws0">schedules<span class="_ _6"> </span>each<span class="_ _13"> </span>process<span class="_ _6"> </span>automatically<span class="_ _3"></span>,<span class="_ _13"> </span>and<span class="_ _6"> </span>each<span class="_ _13"> </span>process<span class="_ _6"> </span>has<span class="_ _13"> </span>its<span class="_ _6"> </span>own<span class="_ _13"> </span>private<span class="_ _6"> </span>address</div><div class="t m5 x17 h26 y4659 ff7 fs19 fc1 sc0 ls0 ws0">space<span class="_ _1"></span>,<span class="_"> </span>which<span class="_"> </span>makes<span class="_"> </span>it<span class="_"> </span>difﬁcult<span class="_"> </span>for<span class="_"> </span>ﬂows<span class="_"> </span>to<span class="_"> </span>share<span class="_"> </span>data.<span class="_"> </span>W<span class="_ _1"></span>ith<span class="_"> </span>the<span class="_"> </span>second<span class="_"> </span>approach,</div><div class="t m5 x17 h26 y465a ff7 fs19 fc1 sc0 ls0 ws0">we<span class="_ _16"> </span>create<span class="_ _16"> </span>our<span class="_ _14"> </span>own<span class="_ _16"> </span>logical<span class="_ _16"> </span>ﬂows<span class="_ _14"> </span>and<span class="_ _16"> </span>use<span class="_ _16"> </span>I/O<span class="_ _14"> </span>multiplexing<span class="_ _16"> </span>to<span class="_ _16"> </span>explicitly<span class="_ _14"> </span>schedule</div><div class="t m5 x17 h26 y271e ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>ﬂows<span class="_ _3"></span>.<span class="_"> </span>Because<span class="_"> </span>there<span class="_"> </span>is<span class="_"> </span>only<span class="_"> </span>one<span class="_ _13"> </span>process<span class="_ _1"></span>,<span class="_"> </span>ﬂows<span class="_"> </span>share<span class="_"> </span>the<span class="_"> </span>entire<span class="_"> </span>address<span class="_ _13"> </span>space.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
