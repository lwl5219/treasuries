<div id="pf2e4" class="pf w2 h11" data-page-no="2e4"><div class="pc pc2e4 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2e4.png"/><div class="t m5 xb7 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>7.11<span class="_ _60"> </span>Loading<span class="_ _10"> </span>and<span class="_ _10"> </span>Linking<span class="_ _10"> </span>Shared<span class="_ _10"> </span>Libraries<span class="_ _10"> </span>from<span class="_ _10"> </span>Applications<span class="_ _3e"> </span><span class="ffe fs1e">739</span></div><div class="t m5 x100 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/link/dll.c</div><div class="t m5 x2c h2e y280 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x2d h2d yad1 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;stdio.h&gt;</div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&lt;stdlib.h&gt;</span></div><div class="t m5 x2c h2d yad2 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&lt;dlfcn.h&gt;</span></div><div class="t m5 x2c h2e yad3 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y61b4 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2d h2d y285 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>x[2]<span class="_ _1f"> </span>=<span class="_ _1f"> </span>{1,<span class="_ _e"> </span>2};</div><div class="t m5 x2c h2d yad4 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>y[2]<span class="_ _e"> </span>=<span class="_ _1f"> </span>{3,<span class="_ _1f"> </span>4};</span></div><div class="t m5 x2c h2d yad5 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>z[2];</span></div><div class="t m5 x2c h2e yad6 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x2c h2e y61b5 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x2d h2d y496b ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x17 h2d y50d4 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">void<span class="_ _e"> </span>*handle;</span></div><div class="t m5 x17 h2d y61b6 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">void<span class="_ _e"> </span>(*addvec)(int<span class="_ _1f"> </span>*,<span class="_ _1f"> </span>int<span class="_ _e"> </span>*,<span class="_ _1f"> </span>int<span class="_ _e"> </span>*,<span class="_ _1f"> </span>int);</span></div><div class="t m5 x17 h2d y2181 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*error;</span></div><div class="t m5 x17 h2e y554b ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x17 h2e y61b7 ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x142 h2d y4a9f ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Dynamically<span class="_ _1f"> </span>load<span class="_ _1f"> </span>the<span class="_ _e"> </span>shared<span class="_ _1f"> </span>library<span class="_ _e"> </span>containing<span class="_ _1f"> </span>addvec()<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">handle<span class="_ _e"> </span>=<span class="_ _1f"> </span>dlopen(&quot;./libvector.so&quot;,<span class="_ _1f"> </span>RTLD_LAZY);</span></div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(!handle)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y3ec ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _70"> </span><span class="ffd fs1e fc2">fprintf(stderr,<span class="_ _e"> </span>&quot;%s\n&quot;,<span class="_ _1f"> </span>dlerror());</span></div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _70"> </span><span class="ffd fs1e fc2">exit(1);</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y1ada ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x17 h2e y61b8 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x142 h2d y61b9 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Get<span class="_ _1f"> </span>a<span class="_ _1f"> </span>pointer<span class="_ _e"> </span>to<span class="_ _1f"> </span>the<span class="_ _e"> </span>addvec()<span class="_ _1f"> </span>function<span class="_ _1f"> </span>we<span class="_ _e"> </span>just<span class="_ _1f"> </span>loaded<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _20"> </span><span class="ffd fs1e fc2">addvec<span class="_ _e"> </span>=<span class="_ _1f"> </span>dlsym(handle,<span class="_ _1f"> </span>&quot;addvec&quot;);</span></div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((error<span class="_ _1f"> </span>=<span class="_ _1f"> </span>dlerror())<span class="_ _e"> </span>!=<span class="_ _1f"> </span>NULL)<span class="_ _e"> </span>{</span></div><div class="t m5 x17 h2d y3229 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _70"> </span><span class="ffd fs1e fc2">fprintf(stderr,<span class="_ _e"> </span>&quot;%s\n&quot;,<span class="_ _1f"> </span>error);</span></div><div class="t m5 x17 h2d y322a ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _70"> </span><span class="ffd fs1e fc2">exit(1);</span></div><div class="t m5 x17 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y322c ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x17 h2e y61ba ff6 fs20 fc6 sc0 ls0 ws0">29</div><div class="t m5 x142 h2d y441 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Now<span class="_ _1f"> </span>we<span class="_ _1f"> </span>can<span class="_ _e"> </span>call<span class="_ _1f"> </span>addvec()<span class="_ _e"> </span>just<span class="_ _1f"> </span>like<span class="_ _1f"> </span>any<span class="_ _e"> </span>other<span class="_ _1f"> </span>function<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _20"> </span><span class="ffd fs1e fc2">addvec(x,<span class="_ _e"> </span>y,<span class="_ _1f"> </span>z,<span class="_ _1f"> </span>2);</span></div><div class="t m5 x17 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;z<span class="_ _e"> </span>=<span class="_ _1f"> </span>[%d<span class="_ _1f"> </span>%d]\n&quot;,<span class="_ _e"> </span>z[0],<span class="_ _1f"> </span>z[1]);</span></div><div class="t m5 x17 h2e y24a ff6 fs20 fc6 sc0 ls0 ws0">32</div><div class="t m5 x17 h2e y61bb ff6 fs20 fc6 sc0 ls0 ws0">33</div><div class="t m5 x142 h2d y8f9 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Unload<span class="_ _1f"> </span>the<span class="_ _1f"> </span>shared<span class="_ _e"> </span>library<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y5fd ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(dlclose(handle)<span class="_ _1f"> </span>&lt;<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{</span></div><div class="t m5 x17 h2d y4aa5 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _70"> </span><span class="ffd fs1e fc2">fprintf(stderr,<span class="_ _e"> </span>&quot;%s\n&quot;,<span class="_ _1f"> </span>dlerror());</span></div><div class="t m5 x17 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 xc5 h2d y74d ffd fs1e fc2 sc0 ls0 ws0">exit(1);</div><div class="t m5 x17 h2d y277 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y2269 ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>0;</span></div><div class="t m5 x17 h2d y226b ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x100 h2c y4aa6 ffa fs16 fc2 sc0 ls0 ws0">code/link/dll.c</div><div class="t m5 x17 h34 y4aa7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _15"> </span>7.17<span class="_ _c"> </span><span class="fc1">Example<span class="_ _21"> </span>program<span class="_ _15"> </span>3.<span class="_ _21"> </span><span class="ff6">Dynamically<span class="_ _15"> </span>loads<span class="_ _21"> </span>and<span class="_ _21"> </span>links<span class="_ _15"> </span>the<span class="_ _21"> </span>shared<span class="_ _15"> </span>librar<span class="_ _2"></span>y</span></span></div><div class="t m5 x17 h3a y4aa9 ffd fs19 fc1 sc0 ls0 ws0">libvector.so<span class="_ _10"> </span><span class="ff6 fs16">at<span class="_ _11"> </span>run<span class="_ _10"> </span>time.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
