<div id="pf2a5" class="pf w2 h11" data-page-no="2a5"><div class="pc pc2a5 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2a5.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">676<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>6<span class="_ _3d"> </span>The<span class="_ _10"> </span>Memory<span class="_ _10"> </span>Hierarchy</span></div><div class="t m5 x2b h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/mem/mountain/mountain.c</div><div class="t m5 xb h88 y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>data[MAXELEMS];<span class="_ _119"> </span>/*<span class="_ _e"> </span>The<span class="_ _f"> </span>global<span class="_ _e"> </span>array<span class="_ _e"> </span>weâ€™ll<span class="_ _f"> </span>be<span class="_ _e"> </span>traversing<span class="_ _e"> </span>*/</span></div><div class="t m5 xb h2e y35f1 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 xb h2e y59ec ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x244 h88 ye97 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>test<span class="_ _f"> </span>-<span class="_ _e"> </span>Iterate<span class="_ _e"> </span>over<span class="_ _f"> </span>first<span class="_ _e"> </span>&quot;elems&quot;<span class="_ _e"> </span>elements<span class="_ _f"> </span>of<span class="_ _e"> </span>array<span class="_ _e"> </span>&quot;data&quot;<span class="_ _e"> </span>with</div><div class="t m5 xb h88 y59ed ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _61"> </span><span class="ffd fs4e fc2">*<span class="_ _7f"> </span>stride<span class="_ _e"> </span>of<span class="_ _e"> </span>&quot;stride&quot;,<span class="_ _f"> </span>usin<span class="ls253">g4x4</span>loop<span class="_ _e"> </span>unrolling.</span></div><div class="t m5 xb h88 y2827 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _61"> </span><span class="ffd fs4e fc2">*/</span></div><div class="t m5 xb h88 y59ee ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>test(int<span class="_ _e"> </span>elems,<span class="_ _f"> </span>int<span class="_ _e"> </span>stride)</span></div><div class="t m5 xb h88 y180c ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 xb h88 y59ef ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>i,<span class="_ _e"> </span>sx2<span class="_ _f"> </span>=<span class="_ _e"> </span>stride*2,<span class="_ _e"> </span>sx3<span class="_ _f"> </span>=<span class="_ _e"> </span>stride*3,<span class="_ _e"> </span>sx4<span class="_ _f"> </span>=<span class="_ _e"> </span>stride*4;</span></div><div class="t m5 xb h88 y59f0 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>acc0<span class="_ _e"> </span>=<span class="_ _f"> </span>0,<span class="_ _e"> </span>acc1<span class="_ _e"> </span>=<span class="_ _f"> </span>0,<span class="_ _e"> </span>acc2<span class="_ _e"> </span>=<span class="_ _f"> </span>0,<span class="_ _e"> </span>acc3<span class="_ _e"> </span>=<span class="_ _f"> </span>0;</span></div><div class="t m5 x14 h2e y59f1 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x37 h88 y59f2 ffd fs4e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>length<span class="_ _f"> </span>=<span class="_ _e"> </span>elems;</div><div class="t m5 x14 h88 y59f3 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _e2"> </span><span class="ffd fs4e fc2">long<span class="_ _e"> </span>limit<span class="_ _e"> </span>=<span class="_ _f"> </span>length<span class="_ _e"> </span>-<span class="_ _e"> </span>sx4;</span></div><div class="t m5 x14 h2e y59f4 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x14 h2e y59f5 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x37 h88 y59f6 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Combine<span class="_ _f"> </span>4<span class="_ _e"> </span>elements<span class="_ _e"> </span>at<span class="_ _f"> </span>a<span class="_ _e"> </span>time<span class="_ _e"> </span>*/</div><div class="t m5 x14 h88 y59f7 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _e2"> </span><span class="ffd fs4e fc2">for<span class="_ _e"> </span>(i<span class="_ _e"> </span>=<span class="_ _f"> </span>0;<span class="_ _e"> </span>i<span class="_ _e"> </span>&lt;<span class="_ _f"> </span>limit;<span class="_ _e"> </span>i<span class="_ _e"> </span>+=<span class="_ _f"> </span>sx4)<span class="_ _e"> </span>{</span></div><div class="t m5 x14 h88 y37bd ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _18b"> </span><span class="ffd fs4e fc2">acc0<span class="_ _e"> </span>=<span class="_ _f"> </span>acc0<span class="_ _e"> </span>+<span class="_ _e"> </span>data[i];</span></div><div class="t m5 x14 h88 y59f8 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _18b"> </span><span class="ffd fs4e fc2">acc1<span class="_ _e"> </span>=<span class="_ _f"> </span>acc1<span class="_ _e"> </span>+<span class="_ _e"> </span>data[i+stride];</span></div><div class="t m5 x14 h88 y4b5d ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _18b"> </span><span class="ffd fs4e fc2">acc2<span class="_ _e"> </span>=<span class="_ _f"> </span>acc2<span class="_ _e"> </span>+<span class="_ _e"> </span>data[i+sx2];</span></div><div class="t m5 x14 h88 y59f9 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _18b"> </span><span class="ffd fs4e fc2">acc3<span class="_ _e"> </span>=<span class="_ _f"> </span>acc3<span class="_ _e"> </span>+<span class="_ _e"> </span>data[i+sx3];</span></div><div class="t m5 x14 h88 y59fa ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x14 h2e y59fb ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 x14 h2e y59fc ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x37 h88 y59fd ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Finish<span class="_ _f"> </span>any<span class="_ _e"> </span>remaining<span class="_ _e"> </span>elements<span class="_ _f"> </span>*/</div><div class="t m5 x14 h88 y59fe ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _e2"> </span><span class="ffd fs4e fc2">for<span class="_ _e"> </span>(;<span class="_ _e"> </span>i<span class="_ _f"> </span>&lt;<span class="_ _e"> </span>length;<span class="_ _e"> </span>i++)<span class="_ _f"> </span>{</span></div><div class="t m5 x14 h88 y59ff ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _18b"> </span><span class="ffd fs4e fc2">acc0<span class="_ _e"> </span>=<span class="_ _f"> </span>acc0<span class="_ _e"> </span>+<span class="_ _e"> </span>data[i];</span></div><div class="t m5 x14 h88 y2568 ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x14 h88 y5a00 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _e2"> </span><span class="ffd fs4e fc2">return<span class="_ _e"> </span>((acc0<span class="_ _e"> </span>+<span class="_ _f"> </span>acc1)<span class="_ _e"> </span>+<span class="_ _e"> </span>(acc2<span class="_ _f"> </span>+<span class="_ _e"> </span>acc3));</span></div><div class="t m5 x14 h88 y5a01 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x14 h2e y301c ff6 fs20 fc6 sc0 ls0 ws0">27</div><div class="t m5 x14 h2e y5a02 ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x244 h88 y5a03 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>run<span class="_ _f"> </span>-<span class="_ _e"> </span>Run<span class="_ _e"> </span>test(elems,<span class="_ _f"> </span>stride)<span class="_ _e"> </span>and<span class="_ _e"> </span>return<span class="_ _f"> </span>read<span class="_ _e"> </span>throughput<span class="_ _e"> </span>(MB/s).</div><div class="t m5 x14 h88 y5a04 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _61"> </span><span class="ffd fs4e fc2">*<span class="_ _68"> </span>&quot;size&quot;<span class="_ _e"> </span>is<span class="_ _f"> </span>in<span class="_ _e"> </span>bytes,<span class="_ _e"> </span>&quot;stride&quot;<span class="_ _f"> </span>is<span class="_ _e"> </span>in<span class="_ _e"> </span>array<span class="_ _f"> </span>elements,<span class="_ _e"> </span>and<span class="_ _e"> </span>Mhz<span class="_ _f"> </span>is</span></div><div class="t m5 x14 h88 y5a05 ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _61"> </span><span class="ffd fs4e fc2">*<span class="_ _68"> </span>CPU<span class="_ _e"> </span>clock<span class="_ _f"> </span>frequency<span class="_ _e"> </span>in<span class="_ _e"> </span>Mhz.</span></div><div class="t m5 x14 h88 y5a06 ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _61"> </span><span class="ffd fs4e fc2">*/</span></div><div class="t m5 x14 h88 y1dd5 ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _1c"> </span><span class="ffd fs4e fc2">double<span class="_ _e"> </span>run(int<span class="_ _e"> </span>size,<span class="_ _f"> </span>int<span class="_ _e"> </span>stride,<span class="_ _e"> </span>double<span class="_ _f"> </span>Mhz)</span></div><div class="t m5 x14 h88 y1abf ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x14 h88 y296f ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _e2"> </span><span class="ffd fs4e fc2">double<span class="_ _e"> </span>cycles;</span></div><div class="t m5 x14 h88 y5a07 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>elems<span class="_ _e"> </span>=<span class="_ _f"> </span>size<span class="_ _e"> </span>/<span class="_ _e"> </span>sizeof(double);</span></div><div class="t m5 x14 h2e y5a08 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 x14 h2e y5a09 ff6 fs20 fc6 sc0 ls0 ws0">37</div><div class="t m5 x37 h88 y5a0a ffd fs4e fc2 sc0 ls0 ws0">test(elems,<span class="_ _e"> </span>stride);<span class="_ _1a3"> </span>/*<span class="_ _e"> </span>Warm<span class="_ _e"> </span>up<span class="_ _f"> </span>the<span class="_ _e"> </span>cache<span class="_ _e"> </span>*/</div><div class="t m5 x14 h88 y55cc ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _e2"> </span><span class="ffd fs4e fc2">cycles<span class="_ _e"> </span>=<span class="_ _e"> </span>fcyc2(test,<span class="_ _f"> </span>elems,<span class="_ _e"> </span>stride,<span class="_ _e"> </span>0);<span class="_ _ea"> </span>/*<span class="_ _e"> </span>Call<span class="_ _f"> </span>test(elems,stride)<span class="_ _e"> </span>*/</span></div><div class="t m5 x14 h88 y3028 ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _e2"> </span><span class="ffd fs4e fc2">return<span class="_ _e"> </span>(size<span class="_ _e"> </span>/<span class="_ _f"> </span>stride)<span class="_ _e"> </span>/<span class="_ _e"> </span>(cycles<span class="_ _f"> </span>/<span class="_ _e"> </span>Mhz);<span class="_ _e"> </span>/*<span class="_ _f"> </span>Convert<span class="_ _e"> </span>cycles<span class="_ _e"> </span>to<span class="_ _f"> </span>MB/s<span class="_ _e"> </span>*/</span></div><div class="t m5 x14 h88 y55cd ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x2b h2c y5a0b ffa fs16 fc2 sc0 ls0 ws0">code/mem/mountain/mountain.c</div><div class="t m5 x14 h34 y5a0c ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _13"> </span>6.40<span class="_ _66"> </span><span class="fc1">Functions<span class="_ _13"> </span>that<span class="_ _6"> </span>measure<span class="_ _13"> </span>and<span class="_ _13"> </span>compute<span class="_ _6"> </span>read<span class="_ _13"> </span>throughput.<span class="_ _6"> </span><span class="ff6">We<span class="_ _6"> </span>can<span class="_ _13"> </span>generate<span class="_ _13"> </span>a<span class="_ _6"> </span>memory<span class="_ _13"> </span>mountain</span></span></div><div class="t m5 x14 h34 y5a0d ff6 fs16 fc1 sc0 ls0 ws0">for<span class="_ _16"> </span>a<span class="_ _16"> </span>particular<span class="_ _16"> </span>computer<span class="_ _11"> </span>by<span class="_ _16"> </span>calling<span class="_ _16"> </span>the</div><div class="t m5 x1f2 h3a y5a0e ffd fs19 fc1 sc0 ls0 ws0">run<span class="_ _16"> </span><span class="ff6 fs16">function<span class="_ _16"> </span>with<span class="_ _16"> </span>different<span class="_ _11"> </span>values<span class="_ _16"> </span>of<span class="_ _16"> </span></span>size<span class="_ _16"> </span><span class="ff6 fs16">(which<span class="_ _16"> </span>corresponds<span class="_ _16"> </span>to</span></div><div class="t m5 x14 h34 y5a0f ff6 fs16 fc1 sc0 ls0 ws0">temporal<span class="_ _10"> </span>locality)<span class="_ _11"> </span>and</div><div class="t m5 xcf h3a y5a10 ffd fs19 fc1 sc0 ls0 ws0">stride<span class="_ _10"> </span><span class="ff6 fs16">(which<span class="_ _11"> </span>corresponds<span class="_ _10"> </span>to<span class="_ _10"> </span>spatial<span class="_ _11"> </span>locality).</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
