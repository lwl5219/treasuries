<div id="pf358" class="pf w2 h11" data-page-no="358"><div class="pc pc358 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg358.png"/><div class="t m5 x6b h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.6<span class="_ _60"> </span>Address<span class="_ _10"> </span>T<span class="_ _1"></span>ranslation<span class="_ _3e"> </span><span class="ffe fs1e">855</span></div><div class="t m5 x72 h26 ye7 ffa fs19 fc2 sc0 ls0 ws0">Step<span class="_ _13"> </span>4.<span class="_ _21"> </span><span class="ff7">The<span class="_ _13"> </span>MMU<span class="_ _13"> </span>translates<span class="_ _13"> </span>the<span class="_"> </span>virtual<span class="_ _13"> </span>address<span class="_ _13"> </span>to<span class="_"> </span>a<span class="_ _13"> </span>physical<span class="_ _13"> </span>address<span class="_ _13"> </span>and<span class="_"> </span>sends</span></div><div class="t m5 x30 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">it<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>cache/main<span class="_"> </span>memory<span class="_ _3"></span>.</div><div class="t m5 x72 h26 y52e9 ffa fs19 fc2 sc0 ls0 ws0">Step<span class="_"> </span>5.<span class="_ _21"> </span><span class="ff7">T<span class="_ _0"></span>he<span class="_"> </span>cache/main<span class="_"> </span>memory<span class="_"> </span>returns<span class="_"> </span>the<span class="_"> </span>requested<span class="_"> </span>data<span class="_"> </span>word<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>CPU<span class="_ _3"></span>.</span></div><div class="t m5 x26 h26 y6eb0 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _11"> </span>there<span class="_ _11"> </span>is<span class="_ _16"> </span>a<span class="_ _11"> </span>TLB<span class="_ _16"> </span>miss<span class="_ _1"></span>,<span class="_ _16"> </span>then<span class="_ _11"> </span>the<span class="_ _16"> </span>MMU<span class="_ _11"> </span>must<span class="_ _16"> </span>fetch<span class="_ _11"> </span>the<span class="_ _16"> </span>PTE<span class="_ _11"> </span>from<span class="_ _11"> </span>the<span class="_ _16"> </span>L1</div><div class="t m5 x17 h26 y6eb1 ff7 fs19 fc2 sc0 ls0 ws0">cache<span class="_ _1"></span>,<span class="_ _16"> </span>as<span class="_ _16"> </span>shown<span class="_ _11"> </span>in<span class="_ _16"> </span>F<span class="_ _0"></span>igure<span class="_ _11"> </span>9.16(b).<span class="_ _16"> </span>T<span class="_ _0"></span>he<span class="_ _11"> </span>newly<span class="_ _16"> </span>fetched<span class="_ _16"> </span>PTE<span class="_ _11"> </span>is<span class="_ _16"> </span>stored<span class="_ _11"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>TLB<span class="_ _1"></span>,</div><div class="t m5 x17 h26 y6eb2 ff7 fs19 fc2 sc0 ls0 ws0">possibly<span class="_"> </span>overwriting<span class="_"> </span>an<span class="_"> </span>existing<span class="_"> </span>entry<span class="_ _3"></span>.</div><div class="t m5 x17 h41 y496b ffe fs29 fc2 sc0 ls0 ws0">9.6.3<span class="_ _48"> </span><span class="fs19">Multi-Level<span class="_"> </span>Page<span class="_"> </span>T<span class="_ _3"></span>ables</span></div><div class="t m5 x17 h26 y462 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hus<span class="_"> </span>far,<span class="_"> </span>we<span class="_"> </span>have<span class="_"> </span>assumed<span class="_ _11"> </span>that<span class="_"> </span>the<span class="_"> </span>system<span class="_"> </span>uses<span class="_"> </span>a<span class="_"> </span>single<span class="_ _11"> </span>page<span class="_"> </span>table<span class="_"> </span>to<span class="_"> </span>do<span class="_"> </span>address</div><div class="t m5 x17 h26 y463 ff7 fs19 fc2 sc0 ls0 ws0">translation.<span class="_ _11"> </span>But<span class="_ _11"> </span>if<span class="_ _11"> </span>we<span class="_ _11"> </span>had<span class="_ _11"> </span>a<span class="_ _11"> </span>32-bit<span class="_ _16"> </span>address<span class="_"> </span>space,<span class="_"> </span>4<span class="_ _11"> </span>KB<span class="_ _11"> </span>pages<span class="_ _0"></span>,<span class="_ _11"> </span>and<span class="_ _11"> </span>a<span class="_ _11"> </span>4-byte<span class="_ _11"> </span>PTE,</div><div class="t m5 x17 h26 y464 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_ _16"> </span>we<span class="_ _11"> </span>would<span class="_ _16"> </span>nee<span class="ls29b">da4M<span class="_ _49"></span>B<span class="ls0">page<span class="_ _16"> </span>table<span class="_ _11"> </span>resident<span class="_ _16"> </span>in<span class="_ _16"> </span>memory<span class="_ _16"> </span>at<span class="_ _11"> </span>all<span class="_ _16"> </span>times<span class="_ _1"></span>,<span class="_ _14"> </span>even<span class="_ _16"> </span>if</span></span></div><div class="t m5 x17 h26 y465 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>application<span class="_ _16"> </span>referenced<span class="_ _14"> </span>only<span class="_ _16"> </span>a<span class="_ _16"> </span>small<span class="_ _14"> </span>chunk<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>virtual<span class="_ _16"> </span>address<span class="_ _16"> </span>space.<span class="_ _16"> </span>T<span class="_ _1"></span>he</div><div class="t m5 x17 h26 y466 ff7 fs19 fc2 sc0 ls0 ws0">problem<span class="_"> </span>is<span class="_"> </span>compounded<span class="_"> </span>for<span class="_"> </span>systems<span class="_"> </span>with<span class="_"> </span>64-bit<span class="_"> </span>address<span class="_"> </span>spaces<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y467 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>common<span class="_ _16"> </span>approach<span class="_ _14"> </span>for<span class="_ _14"> </span>compacting<span class="_ _16"> </span>the<span class="_ _14"> </span>page<span class="_ _16"> </span>table<span class="_ _14"> </span>is<span class="_ _16"> </span>to<span class="_ _14"> </span>use<span class="_ _14"> </span>a<span class="_ _16"> </span>hierarchy</div><div class="t m5 x17 h26 y468 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>page<span class="_"> </span>tables<span class="_ _13"> </span>instead.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>idea<span class="_"> </span>is<span class="_"> </span>easiest<span class="_ _13"> </span>to<span class="_"> </span>understand<span class="_"> </span>with<span class="_"> </span>a<span class="_ _13"> </span>concrete<span class="_"> </span>example.</div><div class="t m5 x17 h26 y469 ff7 fs19 fc2 sc0 ls0 ws0">Consider<span class="_ _14"> </span>a<span class="_ _14"> </span>32-bit<span class="_ _14"> </span>virtual<span class="_ _14"> </span>address<span class="_ _14"> </span>space<span class="_ _14"> </span>partitioned<span class="_ _15"> </span>into<span class="_ _14"> </span>4<span class="_ _14"> </span>KB<span class="_ _14"> </span>pages<span class="_ _1"></span>,<span class="_ _15"> </span>with<span class="_ _14"> </span>page</div><div class="t m5 x17 h26 y46a ff7 fs19 fc2 sc0 ls0 ws0">table<span class="_ _6"> </span>entries<span class="_ _13"> </span>that<span class="_ _6"> </span>are<span class="_ _13"> </span>4<span class="_ _6"> </span>bytes<span class="_ _13"> </span>each.<span class="_ _6"> </span>Suppose<span class="_ _13"> </span>also<span class="_ _6"> </span>that<span class="_ _13"> </span>at<span class="_ _6"> </span>this<span class="_ _6"> </span>point<span class="_ _13"> </span>in<span class="_ _6"> </span>time<span class="_ _13"> </span>the<span class="_ _6"> </span>virtual</div><div class="t m5 x17 h26 y46b ff7 fs19 fc2 sc0 ls0 ws0">address<span class="_ _13"> </span>space<span class="_"> </span>has<span class="_ _13"> </span>the<span class="_ _13"> </span>following<span class="_ _13"> </span>form:<span class="_"> </span>T<span class="_ _3"></span>he<span class="_"> </span>Ô¨Årst<span class="_ _13"> </span>2<span class="_ _13"> </span>K<span class="_ _13"> </span>pages<span class="_"> </span>of<span class="_ _13"> </span>memory<span class="_ _13"> </span>are<span class="_ _13"> </span>allocated</div><div class="t m5 x17 h26 y46c ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_ _13"> </span>code<span class="_ _6"> </span>and<span class="_ _13"> </span>data,<span class="_ _13"> </span>the<span class="_ _6"> </span>next<span class="_ _13"> </span>6<span class="_ _13"> </span>K<span class="_ _6"> </span>pages<span class="_ _13"> </span>are<span class="_ _13"> </span>unallocated,<span class="_ _6"> </span>the<span class="_ _13"> </span>next<span class="_ _13"> </span>1,023<span class="_ _6"> </span>pages<span class="_ _13"> </span>are<span class="_ _6"> </span>also</div><div class="t m5 x17 h26 y46d ff7 fs19 fc2 sc0 ls0 ws0">unallocated,<span class="_ _16"> </span>and<span class="_ _11"> </span>the<span class="_ _11"> </span>next<span class="_ _16"> </span>page<span class="_ _11"> </span>is<span class="_ _16"> </span>allocated<span class="_ _11"> </span>for<span class="_ _11"> </span>the<span class="_ _16"> </span>user<span class="_ _11"> </span>stack.<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _16"> </span>9.17<span class="_ _11"> </span>shows</div><div class="t m5 x17 h26 y46e ff7 fs19 fc2 sc0 ls0 ws0">how<span class="_ _11"> </span>we<span class="_ _11"> </span>might<span class="_ _16"> </span>construct<span class="_ _11"> </span>a<span class="_ _11"> </span>two-level<span class="_ _16"> </span>page<span class="_ _11"> </span>table<span class="_ _11"> </span>hierarchy<span class="_ _16"> </span>for<span class="_ _11"> </span>this<span class="_ _11"> </span>virtual<span class="_ _11"> </span>address</div><div class="t m5 x17 h26 y46f ff7 fs19 fc2 sc0 ls0 ws0">space<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y470 ff7 fs19 fc2 sc0 ls0 ws0">Each<span class="_ _13"> </span>PTE<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>level<span class="_ _13"> </span>1<span class="_"> </span>table<span class="_ _13"> </span>is<span class="_"> </span>responsible<span class="_ _13"> </span>for<span class="_ _13"> </span>mappin<span class="ls29c">ga4M<span class="_ _80"></span>B<span class="ls0">chunk<span class="_"> </span>of<span class="_ _13"> </span>the</span></span></div><div class="t m5 x17 h26 y471 ff7 fs19 fc2 sc0 ls0 ws0">virtual<span class="_ _16"> </span>address<span class="_ _16"> </span>space<span class="_ _1"></span>,<span class="_ _16"> </span>where<span class="_ _16"> </span>each<span class="_ _16"> </span>chunk<span class="_ _16"> </span>consists<span class="_ _16"> </span>of<span class="_ _16"> </span>1,024<span class="_ _11"> </span>contiguous<span class="_ _16"> </span>pages<span class="_ _1"></span>.<span class="_ _16"> </span>F<span class="_ _1"></span>or</div><div class="t m5 x17 h26 y472 ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_"> </span>PTE<span class="_ _6"> </span>0<span class="_ _13"> </span>maps<span class="_ _13"> </span>the<span class="_ _13"> </span>Ô¨Årst<span class="_ _13"> </span>chunk,<span class="_ _13"> </span>PTE<span class="_ _13"> </span>1<span class="_ _13"> </span>the<span class="_ _13"> </span>next<span class="_ _13"> </span>chunk,<span class="_ _13"> </span>and<span class="_ _13"> </span>so<span class="_ _13"> </span>on.<span class="_ _13"> </span>Given<span class="_ _13"> </span>that</div><div class="t m5 x17 h26 y473 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>address<span class="_"> </span>space<span class="_"> </span>is<span class="_"> </span>4<span class="_"> </span>GB<span class="_ _3"></span>,<span class="_"> </span>1,024<span class="_"> </span>PTEs<span class="_"> </span>are<span class="_"> </span>sufÔ¨Åcient<span class="_"> </span>to<span class="_"> </span>cover<span class="_"> </span>the<span class="_"> </span>entire<span class="_"> </span>space.</div><div class="t m5 x26 h26 y474 ff7 fs19 fc2 sc0 ls0 ws0">If<span class="_ _13"> </span>every<span class="_ _13"> </span>page<span class="_ _13"> </span>in<span class="_ _13"> </span>chunk<span class="_ _13"> </span><span class="ff11">i<span class="_ _10"> </span></span>is<span class="_ _13"> </span>unallocated,<span class="_ _13"> </span>then<span class="_ _13"> </span>level<span class="_ _13"> </span>1<span class="_ _13"> </span>PTE<span class="_ _13"> </span><span class="ff11">i<span class="_ _10"> </span></span>is<span class="_ _13"> </span>null.<span class="_ _13"> </span>F<span class="_ _3"></span>or<span class="_ _13"> </span>example,</div><div class="t m5 x17 h26 y475 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _13"> </span>Figure<span class="_ _13"> </span>9.17,<span class="_ _13"> </span>chunks<span class="_"> </span>2‚Äì7<span class="_ _13"> </span>are<span class="_"> </span>unallocated.<span class="_ _13"> </span>However,<span class="_ _13"> </span>if<span class="_ _13"> </span>at<span class="_"> </span>least<span class="_ _13"> </span>one<span class="_"> </span>page<span class="_ _13"> </span>in<span class="_ _13"> </span>chunk</div><div class="t m5 x17 h26 y476 ff11 fs19 fc2 sc0 ls0 ws0">i<span class="_ _15"> </span><span class="ff7">is<span class="_ _14"> </span>allocated,<span class="_ _14"> </span>then<span class="_ _16"> </span>level<span class="_ _14"> </span>1<span class="_ _16"> </span>PTE<span class="_ _16"> </span></span>i<span class="_ _21"> </span><span class="ff7">points<span class="_ _16"> </span>to<span class="_ _14"> </span>the<span class="_ _16"> </span>base<span class="_ _14"> </span>of<span class="_ _16"> </span>a<span class="_ _14"> </span>level<span class="_ _16"> </span>2<span class="_ _16"> </span>page<span class="_ _14"> </span>table<span class="_ _0"></span>.<span class="_ _16"> </span>F<span class="_ _1"></span>or</span></div><div class="t m5 x17 h26 y477 ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_"> </span>in<span class="_ _13"> </span>Figure<span class="_ _13"> </span>9.17,<span class="_ _13"> </span>all<span class="_"> </span>or<span class="_ _13"> </span>portions<span class="_"> </span>of<span class="_ _13"> </span>chunks<span class="_ _13"> </span>0,<span class="_"> </span>1,<span class="_ _13"> </span>and<span class="_"> </span>8<span class="_ _13"> </span>are<span class="_ _13"> </span>allocated,<span class="_"> </span>so<span class="_ _13"> </span>their</div><div class="t m5 x17 h26 y478 ff7 fs19 fc2 sc0 ls0 ws0">level<span class="_"> </span>1<span class="_"> </span>PTEs<span class="_"> </span>point<span class="_"> </span>to<span class="_"> </span>level<span class="_"> </span>2<span class="_"> </span>page<span class="_"> </span>tables<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y479 ff7 fs19 fc2 sc0 ls0 ws0">Each<span class="_ _11"> </span>PTE<span class="_ _11"> </span>in<span class="_ _11"> </span>a<span class="_ _11"> </span>level<span class="_ _11"> </span>2<span class="_ _16"> </span>page<span class="_"> </span>table<span class="_ _11"> </span>is<span class="_ _16"> </span>responsible<span class="_"> </span>for<span class="_ _16"> </span>mapping<span class="_"> </span>a<span class="_ _11"> </span>4-KB<span class="_ _16"> </span>page<span class="_"> </span>of</div><div class="t m5 x17 h26 y47a ff7 fs19 fc2 sc0 ls0 ws0">virtual<span class="_"> </span>memory<span class="_ _7"></span>,<span class="_"> </span>just<span class="_"> </span>as<span class="_"> </span>before<span class="_"> </span>when<span class="_"> </span>we<span class="_"> </span>looked<span class="_"> </span>at<span class="_"> </span>single-level<span class="_"> </span>page<span class="_ _13"> </span>tables<span class="_ _0"></span>.<span class="_"> </span>Notice</div><div class="t m5 x17 h26 y47b ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _16"> </span>with<span class="_ _14"> </span>4-byte<span class="_ _14"> </span>PTEs<span class="_ _1"></span>,<span class="_ _14"> </span>each<span class="_ _14"> </span>level<span class="_ _14"> </span>1<span class="_ _16"> </span>and<span class="_ _14"> </span>level<span class="_ _14"> </span>2<span class="_ _16"> </span>page<span class="_ _14"> </span>table<span class="_ _14"> </span>is<span class="_ _16"> </span>4<span class="_ _14"> </span>kilobytes<span class="_ _1"></span>,<span class="_ _14"> </span>which</div><div class="t m5 x17 h26 y47c ff7 fs19 fc2 sc0 ls0 ws0">conveniently<span class="_"> </span>is<span class="_"> </span>the<span class="_"> </span>same<span class="_"> </span>size<span class="_"> </span>as<span class="_"> </span>a<span class="_"> </span>page<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y47d ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>scheme<span class="_ _13"> </span>reduces<span class="_"> </span>memory<span class="_ _13"> </span>requirements<span class="_"> </span>in<span class="_ _13"> </span>two<span class="_"> </span>ways<span class="_ _3"></span>.<span class="_"> </span>F<span class="_ _1"></span>irst,<span class="_"> </span>if<span class="_ _13"> </span>a<span class="_"> </span>PTE<span class="_ _13"> </span>in<span class="_"> </span>the</div><div class="t m5 x17 h26 y47e ff7 fs19 fc2 sc0 ls0 ws0">level<span class="_"> </span>1<span class="_"> </span>table<span class="_ _13"> </span>is<span class="_"> </span>null,<span class="_"> </span>then<span class="_"> </span>the<span class="_"> </span>corresponding<span class="_ _13"> </span>level<span class="_"> </span>2<span class="_"> </span>page<span class="_"> </span>table<span class="_"> </span>does<span class="_ _13"> </span>not<span class="_"> </span>even<span class="_"> </span>have</div><div class="t m5 x17 h26 y47f ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _14"> </span>exist.<span class="_ _14"> </span>This<span class="_ _16"> </span>represents<span class="_ _14"> </span>a<span class="_ _15"> </span>signiÔ¨Åcant<span class="_ _14"> </span>potential<span class="_ _14"> </span>savings<span class="_ _1"></span>,<span class="_ _15"> </span>since<span class="_ _15"> </span>most<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _15"> </span>4<span class="_ _14"> </span>GB</div><div class="t m5 x17 h26 y480 ff7 fs19 fc2 sc0 ls0 ws0">virtual<span class="_"> </span>address<span class="_ _11"> </span>space<span class="_"> </span>for<span class="_ _11"> </span>a<span class="_"> </span>typical<span class="_ _11"> </span>program<span class="_ _11"> </span>is<span class="_"> </span>unallocated.<span class="_ _11"> </span>Second,<span class="_"> </span>only<span class="_ _11"> </span>the<span class="_"> </span>level</div><div class="t m5 x17 h26 y481 ff7 fs19 fc2 sc0 ls0 ws0">1<span class="_ _16"> </span>table<span class="_ _16"> </span>needs<span class="_ _11"> </span>to<span class="_ _16"> </span>be<span class="_ _16"> </span>in<span class="_ _16"> </span>main<span class="_ _16"> </span>memory<span class="_ _16"> </span>at<span class="_ _11"> </span>all<span class="_ _16"> </span>times<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span>level<span class="_ _16"> </span>2<span class="_ _11"> </span>page<span class="_ _16"> </span>tables<span class="_ _16"> </span>can<span class="_ _16"> </span>be</div><div class="t m5 x17 h26 y482 ff7 fs19 fc2 sc0 ls0 ws0">created<span class="_ _13"> </span>and<span class="_ _13"> </span>paged<span class="_ _6"> </span>in<span class="_ _13"> </span>and<span class="_ _13"> </span>out<span class="_ _13"> </span>by<span class="_ _13"> </span>the<span class="_ _13"> </span>VM<span class="_ _6"> </span>system<span class="_ _13"> </span>as<span class="_ _13"> </span>they<span class="_ _13"> </span>are<span class="_ _13"> </span>needed,<span class="_ _13"> </span>which<span class="_ _6"> </span>reduces</div><div class="t m5 x17 h26 y483 ff7 fs19 fc2 sc0 ls0 ws0">pressure<span class="_ _13"> </span>on<span class="_"> </span>main<span class="_ _13"> </span>memory<span class="_ _3"></span>.<span class="_"> </span>Only<span class="_ _13"> </span>the<span class="_"> </span>most<span class="_ _13"> </span>heavily<span class="_"> </span>used<span class="_ _13"> </span>level<span class="_"> </span>2<span class="_ _13"> </span>page<span class="_"> </span>tables<span class="_ _13"> </span>need<span class="_"> </span>to</div><div class="t m5 x17 h26 y484 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_"> </span>cached<span class="_"> </span>in<span class="_"> </span>main<span class="_"> </span>memory<span class="_ _3"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
