<div id="pf2e3" class="pf w2 h11" data-page-no="2e3"><div class="pc pc2e3 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2e3.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">738<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x1d h26 y9c ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _14"> </span><span class="ffd ls0">dlopen<span class="_ _14"> </span><span class="ff7">function<span class="_ _16"> </span>loads<span class="_ _16"> </span>and<span class="_ _16"> </span>links<span class="_ _14"> </span>the<span class="_ _16"> </span>shared<span class="_ _16"> </span>library<span class="_ _16"> </span></span>filename<span class="ff7">.<span class="_ _14"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span>external</span></span></div><div class="t m5 x1d h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">symbols<span class="_ _6"> </span>in<span class="_ _6"> </span><span class="ffd">filename<span class="_ _6"> </span></span>are<span class="_ _13"> </span>resolved<span class="_ _a"> </span>using<span class="_ _6"> </span>libraries<span class="_ _13"> </span>previously<span class="_ _a"> </span>opened<span class="_ _6"> </span>with<span class="_ _13"> </span>the<span class="_ _a"> </span><span class="ffd">RTLD_</span></div><div class="t m5 x1d h26 y40a ffd fs19 fc2 sc0 ls0 ws0">GLOBAL<span class="_ _13"> </span><span class="ff7">ﬂag.<span class="_ _13"> </span>If<span class="_ _13"> </span>the<span class="_"> </span>current<span class="_ _13"> </span>executable<span class="_ _13"> </span>was<span class="_ _13"> </span>compiled<span class="_"> </span>with<span class="_ _13"> </span>the<span class="_ _13"> </span></span>-rdynamic<span class="_ _10"> </span><span class="ff7">ﬂag<span class="_ _0"></span>,<span class="_ _13"> </span>then</span></div><div class="t m5 x1d h26 y40b ff7 fs19 fc2 sc0 ls0 ws0">its<span class="_ _16"> </span>global<span class="_ _14"> </span>symbols<span class="_ _16"> </span>are<span class="_ _14"> </span>also<span class="_ _16"> </span>available<span class="_ _14"> </span>for<span class="_ _14"> </span>symbol<span class="_ _16"> </span>resolution.<span class="_ _14"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span><span class="ffd">flag<span class="_ _16"> </span></span>argument</div><div class="t m5 x1d h26 y40c ff7 fs19 fc2 sc0 ls0 ws0">must<span class="_ _f"> </span>include<span class="_ _f"> </span>either<span class="_ _e"> </span><span class="ffd">RTLD_NOW</span>,<span class="_ _e"> </span>which<span class="_ _f"> </span>tells<span class="_ _f"> </span>the<span class="_ _f"> </span>linker<span class="_ _e"> </span>to<span class="_ _21"> </span>resolve<span class="_ _e"> </span>references<span class="_ _21"> </span>to</div><div class="t m5 x1d h26 y40d ff7 fs19 fc2 sc0 ls0 ws0">external<span class="_ _16"> </span>symbols<span class="_ _16"> </span>immediately<span class="_ _3"></span>,<span class="_ _16"> </span>or<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">RTLD_LAZY<span class="_ _16"> </span></span>ﬂag,<span class="_ _16"> </span>which<span class="_ _16"> </span>instructs<span class="_ _16"> </span>the<span class="_ _16"> </span>linker</div><div class="t m5 x1d h26 y40e ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>defer<span class="_ _13"> </span>symbol<span class="_"> </span>resolution<span class="_ _13"> </span>until<span class="_"> </span>code<span class="_ _13"> </span>from<span class="_"> </span>the<span class="_ _13"> </span>library<span class="_"> </span>is<span class="_ _13"> </span>executed.<span class="_"> </span>Either<span class="_ _13"> </span>of<span class="_"> </span>these</div><div class="t m5 x1d h26 y40f ff7 fs19 fc2 sc0 ls0 ws0">values<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span><span class="ff9">or</span>ed<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span><span class="ffd">RTLD_GLOBAL<span class="_ _10"> </span></span>ﬂag.</div><div class="t m5 x126 h2d y619f ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;dlfcn.h&gt;</div><div class="t m5 x126 h2d y61a0 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*dlsym(void<span class="_ _1f"> </span>*handle,<span class="_ _1f"> </span>char<span class="_ _e"> </span>*symbol);</div><div class="t m5 xd2 hf1 y61a1 ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>pointer<span class="_"> </span>to<span class="_"> </span>symbol<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span>NULL<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y61a2 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _21"> </span><span class="ffd ls0">dlsym<span class="_ _15"> </span><span class="ff7">function<span class="_ _15"> </span>takes<span class="_ _15"> </span>a<span class="_ _15"> </span></span>handle<span class="_ _14"> </span><span class="ff7">to<span class="_ _15"> </span>a<span class="_ _15"> </span>previously<span class="_ _15"> </span>opened<span class="_ _15"> </span>shared<span class="_ _15"> </span>library<span class="_ _14"> </span>and</span></span></div><div class="t m5 x1d h26 y61a3 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _f"> </span><span class="ffd">symbol<span class="_ _f"> </span></span>name<span class="_ _f"> </span>and<span class="_ _f"> </span>returns<span class="_ _f"> </span>the<span class="_ _f"> </span>address<span class="_ _f"> </span>of<span class="_ _f"> </span>the<span class="_ _f"> </span>symbol,<span class="_ _e"> </span>if<span class="_ _21"> </span>it<span class="_ _f"> </span>exists<span class="_ _1"></span>,<span class="_ _e"> </span>or<span class="_ _f"> </span>NULL</div><div class="t m5 x1d h26 y61a4 ff7 fs19 fc2 sc0 ls0 ws0">otherwise<span class="_ _1"></span>.</div><div class="t m5 x126 h2d y61a5 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;dlfcn.h&gt;</div><div class="t m5 x126 h2d y61a6 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>dlclose<span class="_ _1f"> </span>(void<span class="_ _1f"> </span>*handle);</div><div class="t m5 x107 hf2 y61a7 ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>0<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span><span class="ff12">−</span>1<span class="_ _13"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y61a8 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">dlclose<span class="_ _11"> </span><span class="ff7">function<span class="_ _11"> </span>unloads<span class="_ _11"> </span>the<span class="_ _16"> </span>shared<span class="_"> </span>library<span class="_ _11"> </span>if<span class="_ _16"> </span>no<span class="_"> </span>other<span class="_ _16"> </span>shared<span class="_"> </span>libraries<span class="_ _11"> </span>are</span></span></div><div class="t m5 x1d h26 y61a9 ff7 fs19 fc2 sc0 ls0 ws0">still<span class="_"> </span>using<span class="_"> </span>it.</div><div class="t m5 x126 h2d y61aa ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;dlfcn.h&gt;</div><div class="t m5 x126 h2d y61ab ffd fs1e fc2 sc0 ls0 ws0">const<span class="_ _e"> </span>char<span class="_ _1f"> </span>*dlerror(void);</div><div class="t m5 x218 hf1 y61ac ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>error<span class="_"> </span>message<span class="_"> </span>if<span class="_"> </span>previous<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd fs4e">dlopen</span>,<span class="_"> </span><span class="ffd fs4e">dlsym</span><span class="ls277">,o<span class="_ _80"></span>r<span class="ffd fs4e ls0">dlclose<span class="_ _10"> </span></span><span class="ls0">failed;</span></span></div><div class="t m5 xb9 hf1 y61ad ff7 fs1f fc2 sc0 ls0 ws0">NULL<span class="_"> </span>if<span class="_"> </span>previous<span class="_"> </span>call<span class="_"> </span>was<span class="_"> </span>OK</div><div class="t m5 x1d h26 y61ae ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _14"> </span><span class="ffd ls0">dlerror<span class="_ _16"> </span><span class="ff7">function<span class="_ _16"> </span>returns<span class="_ _14"> </span>a<span class="_ _16"> </span>string<span class="_ _16"> </span>describing<span class="_ _16"> </span>the<span class="_ _16"> </span>most<span class="_ _16"> </span>recent<span class="_ _16"> </span>error<span class="_ _14"> </span>that<span class="_ _16"> </span>oc-</span></span></div><div class="t m5 x1d h26 y61af ff7 fs19 fc2 sc0 ls0 ws0">curred<span class="_ _15"> </span>as<span class="_ _15"> </span>a<span class="_ _15"> </span>result<span class="_ _21"> </span>of<span class="_ _15"> </span>calling<span class="_ _15"> </span><span class="ffd">dlopen</span>,<span class="_ _f"> </span><span class="ffd">dlsym</span><span class="ls278">,o<span class="_ _12"></span>r<span class="_ _1"></span><span class="ffd ls0">dlclose<span class="ff7">,<span class="_ _21"> </span>or<span class="_ _21"> </span>NULL<span class="_ _15"> </span>if<span class="_ _15"> </span>no<span class="_ _21"> </span>error</span></span></span></div><div class="t m5 x1d h26 y61b0 ff7 fs19 fc2 sc0 ls0 ws0">occurred.</div><div class="t m5 x29 h26 y61b1 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>7.17<span class="_ _14"> </span>shows<span class="_ _16"> </span>how<span class="_ _14"> </span>we<span class="_ _16"> </span>would<span class="_ _14"> </span>use<span class="_ _14"> </span>this<span class="_ _16"> </span>interface<span class="_ _14"> </span>to<span class="_ _16"> </span>dynamically<span class="_ _14"> </span>link<span class="_ _14"> </span>our</div><div class="t m5 x1d h26 y61b2 ffd fs19 fc2 sc0 ls0 ws0">libvector.so<span class="_ _11"> </span><span class="ff7">shared<span class="_"> </span>library<span class="_ _11"> </span>at<span class="_ _11"> </span>run<span class="_ _11"> </span>time<span class="_ _11"> </span>and<span class="_ _11"> </span>then<span class="_ _11"> </span>invoke<span class="_ _11"> </span>its<span class="_ _11"> </span></span>addvec<span class="_ _11"> </span><span class="ff7">routine<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _3"></span>o</span></div><div class="t m5 x1d h26 y61b3 ff7 fs19 fc2 sc0 ls0 ws0">compile<span class="_"> </span>the<span class="_"> </span>program,<span class="_"> </span>we<span class="_"> </span>would<span class="_"> </span>invoke<span class="_"> </span><span class="ff9">gcc<span class="_ _10"> </span></span>in<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>way:</div><div class="t m5 x1d h2d y27d ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-rdynamic<span class="_ _1f"> </span>-o<span class="_ _e"> </span>prog2r<span class="_ _1f"> </span>dll.c<span class="_ _e"> </span>-ldl</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
