<div id="pf3e7" class="pf w2 h11" data-page-no="3e7"><div class="pc pc3e7 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3e7.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">998<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>11<span class="_ _3d"> </span>Network<span class="_ _10"> </span>Programming</span></div><div class="t m5 x133 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x1f h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>serve_static(int<span class="_ _e"> </span>fd,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*filename,<span class="_ _e"> </span>int<span class="_ _1f"> </span>filesize)</span></div><div class="t m5 x1f h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>srcfd;</span></div><div class="t m5 x1f h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*srcp,<span class="_ _1f"> </span>filetype[MAXLINE],<span class="_ _1f"> </span>buf[MAXBUF];</span></div><div class="t m5 x1f h2e y285 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x1f h2e y65f1 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x33 h2d y286 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Send<span class="_ _1f"> </span>response<span class="_ _1f"> </span>headers<span class="_ _e"> </span>to<span class="_ _1f"> </span>client<span class="_ _e"> </span>*/</div><div class="t m5 x1f h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">get_filetype(filename,<span class="_ _e"> </span>filetype);</span></div><div class="t m5 x1f h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(buf,<span class="_ _e"> </span>&quot;HTTP/1.0<span class="_ _1f"> </span>200<span class="_ _1f"> </span>OK\r\n&quot;);</span></div><div class="t m5 x1f h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(buf,<span class="_ _e"> </span>&quot;%sServer:<span class="_ _1f"> </span>Tiny<span class="_ _1f"> </span>Web<span class="_ _e"> </span>Server\r\n&quot;,<span class="_ _1f"> </span>buf);</span></div><div class="t m5 x1b0 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(buf,<span class="_ _e"> </span>&quot;%sConnection:<span class="_ _1f"> </span>close\r\n&quot;,<span class="_ _1f"> </span>buf);</span></div><div class="t m5 x1b0 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(buf,<span class="_ _e"> </span>&quot;%sContent-length:<span class="_ _1f"> </span>%d\r\n&quot;,<span class="_ _1f"> </span>buf,<span class="_ _e"> </span>filesize);</span></div><div class="t m5 x1b0 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">sprintf(buf,<span class="_ _e"> </span>&quot;%sContent-type:<span class="_ _1f"> </span>%s\r\n\r\n&quot;,<span class="_ _1f"> </span>buf,<span class="_ _e"> </span>filetype);</span></div><div class="t m5 x1b0 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">Rio_writen(fd,<span class="_ _e"> </span>buf,<span class="_ _1f"> </span>strlen(buf));</span></div><div class="t m5 x1b0 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;Response<span class="_ _e"> </span>headers:\n&quot;);</span></div><div class="t m5 x1b0 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;%s&quot;,<span class="_ _e"> </span>buf);</span></div><div class="t m5 x1b0 h2e y417 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x1b0 h2e y7429 ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x33 h2d y4aa0 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Send<span class="_ _1f"> </span>response<span class="_ _1f"> </span>body<span class="_ _e"> </span>to<span class="_ _1f"> </span>client<span class="_ _e"> </span>*/</div><div class="t m5 x1b0 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">srcfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>Open(filename,<span class="_ _1f"> </span>O_RDONLY,<span class="_ _e"> </span>0);</span></div><div class="t m5 x1b0 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">srcp<span class="_ _e"> </span>=<span class="_ _1f"> </span>Mmap(0,<span class="_ _1f"> </span>filesize,<span class="_ _e"> </span>PROT_READ,<span class="_ _1f"> </span>MAP_PRIVATE,<span class="_ _e"> </span>srcfd,<span class="_ _1f"> </span>0);</span></div><div class="t m5 x1b0 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">Close(srcfd);</span></div><div class="t m5 x1b0 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x33 h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">Rio_writen(fd,<span class="_ _e"> </span>srcp,<span class="_ _1f"> </span>filesize);</div><div class="t m5 x1b0 h2d y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _20"> </span><span class="ffd fs1e fc2">Munmap(srcp,<span class="_ _e"> </span>filesize);</span></div><div class="t m5 x1b0 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2e y35d ff6 fs20 fc6 sc0 ls0 ws0">24</div><div class="t m5 x1b0 h2e y6a29 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x4f h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">/*</div><div class="t m5 x1b0 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _1f"> </span>get_filetype<span class="_ _e"> </span>-<span class="_ _1f"> </span>Derive<span class="_ _1f"> </span>file<span class="_ _e"> </span>type<span class="_ _1f"> </span>from<span class="_ _e"> </span>filename</span></div><div class="t m5 x1b0 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _73"> </span><span class="ffd fs1e fc2">*/</span></div><div class="t m5 x1b0 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>get_filetype(char<span class="_ _e"> </span>*filename,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*filetype)</span></div><div class="t m5 x1b0 h2d y441 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1b0 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(strstr(filename,<span class="_ _1f"> </span>&quot;.html&quot;))</span></div><div class="t m5 x1b0 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _70"> </span><span class="ffd fs1e fc2">strcpy(filetype,<span class="_ _e"> </span>&quot;text/html&quot;);</span></div><div class="t m5 x1b0 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _20"> </span><span class="ffd fs1e fc2">else<span class="_ _e"> </span>if<span class="_ _1f"> </span>(strstr(filename,<span class="_ _1f"> </span>&quot;.gif&quot;))</span></div><div class="t m5 x1b0 h2d y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _70"> </span><span class="ffd fs1e fc2">strcpy(filetype,<span class="_ _e"> </span>&quot;image/gif&quot;);</span></div><div class="t m5 x1b0 h2d y5fd ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _20"> </span><span class="ffd fs1e fc2">else<span class="_ _e"> </span>if<span class="_ _1f"> </span>(strstr(filename,<span class="_ _1f"> </span>&quot;.png&quot;))</span></div><div class="t m5 x1b0 h2d y4aa5 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _70"> </span><span class="ffd fs1e fc2">strcpy(filetype,<span class="_ _e"> </span>&quot;image/png&quot;);</span></div><div class="t m5 x1b0 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 x33 h2d y74d ffd fs1e fc2 sc0 ls0 ws0">else<span class="_ _e"> </span>if<span class="_ _1f"> </span>(strstr(filename,<span class="_ _1f"> </span>&quot;.jpg&quot;))</div><div class="t m5 x1b0 h2d y277 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _70"> </span><span class="ffd fs1e fc2">strcpy(filetype,<span class="_ _e"> </span>&quot;image/jpeg&quot;);</span></div><div class="t m5 x1b0 h2d y2269 ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _20"> </span><span class="ffd fs1e fc2">else</span></div><div class="t m5 x1b0 h2d y226b ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _70"> </span><span class="ffd fs1e fc2">strcpy(filetype,<span class="_ _e"> </span>&quot;text/plain&quot;);</span></div><div class="t m5 x1b0 h2d y226d ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x133 h2c y62c3 ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x1d h2f y62c4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>11.34<span class="_ _66"> </span><span class="ff1b fc1 ls2e6">Ti<span class="_ _5"></span>n<span class="_ _5"></span>y</span></div><div class="t m5 xd h3a y62c5 ffd fs19 fc1 sc0 ls0 ws0">serve_static<span class="_ _10"> </span><span class="ffe fs16">serves<span class="_"> </span>static<span class="_"> </span>content<span class="_"> </span>to<span class="_"> </span>a<span class="_"> </span>client.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
