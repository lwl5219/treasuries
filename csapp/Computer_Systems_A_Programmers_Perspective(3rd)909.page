<div id="pf38d" class="pf w2 h11" data-page-no="38d"><div class="pc pc38d w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg38d.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">908<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x1d h41 ye7 ffe fs29 fc2 sc0 ls0 ws0">9.11.4<span class="_ _48"> </span><span class="fs19">Assuming<span class="_"> </span>That<span class="_"> </span>Pointers<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>Objects<span class="_"> </span>They<span class="_"> </span>Point<span class="_"> </span>to</span></div><div class="t m5 x17f h43 y754f ffe fs19 fc2 sc0 ls0 ws0">Are<span class="_"> </span>the<span class="_"> </span>Same<span class="_"> </span>Size</div><div class="t m5 x1d h26 y7550 ff7 fs19 fc2 sc0 ls0 ws0">One<span class="_ _16"> </span>common<span class="_ _11"> </span>mistake<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _16"> </span>assume<span class="_ _16"> </span>that<span class="_ _11"> </span>pointers<span class="_ _16"> </span>to<span class="_ _16"> </span>objects<span class="_ _16"> </span>are<span class="_ _16"> </span>the<span class="_ _11"> </span>same<span class="_ _16"> </span>size<span class="_ _16"> </span>as</div><div class="t m5 x1d h26 y7551 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>objects<span class="_"> </span>they<span class="_"> </span>point<span class="_"> </span>to:</div><div class="t m5 x1f h2d y7552 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Create<span class="_ _e"> </span>an<span class="_ _1f"> </span>nxm<span class="_ _1f"> </span>array<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f h2d y7553 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>**makeArray1(int<span class="_ _e"> </span>n,<span class="_ _1f"> </span>int<span class="_ _1f"> </span>m)</span></div><div class="t m5 x1f h2d y7554 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2e y7555 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x33 h2d y7556 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>i;</div><div class="t m5 x1f h2d y7557 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>**A<span class="_ _1f"> </span>=<span class="_ _1f"> </span>(int<span class="_ _e"> </span>**)Malloc(n<span class="_ _1f"> </span>*<span class="_ _e"> </span>sizeof(int));</span></div><div class="t m5 x1f h2e y7558 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x1f h2e y7559 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x33 h2d y755a ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;n<span class="_ _41"></span>;<span class="ls0">i++)</span></div><div class="t m5 x1f h2d y755b ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">A[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>(int<span class="_ _1f"> </span>*)Malloc(m<span class="_ _e"> </span>*<span class="_ _1f"> </span>sizeof(int));</span></div><div class="t m5 x1f h2d y755c ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>A;</span></div><div class="t m5 x1b0 h2d y755d ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1d h26 y755e ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>intent<span class="_ _13"> </span>here<span class="_ _13"> </span>is<span class="_ _13"> </span>to<span class="_ _13"> </span>create<span class="_ _13"> </span>an<span class="_ _13"> </span>array<span class="_"> </span>of<span class="_ _13"> </span><span class="ff11">n<span class="_ _13"> </span></span>pointers<span class="_ _1"></span>,<span class="_ _13"> </span>each<span class="_ _13"> </span>of<span class="_"> </span>which<span class="_ _13"> </span>points<span class="_ _13"> </span>to<span class="_ _13"> </span>an<span class="_ _13"> </span>array</div><div class="t m5 x1d h26 y755f ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _11"> </span><span class="ff11">m<span class="_"> </span><span class="ffd">int</span></span>s<span class="_ _3"></span>.<span class="_ _16"> </span>However,<span class="_ _16"> </span>because<span class="_ _11"> </span>the<span class="_ _16"> </span>programmer<span class="_ _11"> </span>has<span class="_ _16"> </span>written<span class="_ _16"> </span><span class="ffd">sizeof(int)<span class="_ _11"> </span></span>instead</div><div class="t m5 x1d h26 y7560 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span><span class="ffd">sizeof(int<span class="_ _11"> </span>*)<span class="_ _11"> </span></span>in<span class="_"> </span>line<span class="_"> </span>5,<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>actually<span class="_"> </span>creates<span class="_"> </span>an<span class="_"> </span>array<span class="_"> </span>of<span class="_"> </span><span class="ffd">int</span><span class="ls73">s.</span></div><div class="t m5 x29 h26 y7561 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _11"> </span>code<span class="_ _11"> </span>will<span class="_ _11"> </span>run<span class="_ _11"> </span>ﬁne<span class="_ _11"> </span>on<span class="_"> </span>machines<span class="_ _11"> </span>where<span class="_ _11"> </span><span class="ffd">int</span>s<span class="_ _11"> </span>and<span class="_ _11"> </span>pointers<span class="_ _11"> </span>to<span class="_ _11"> </span><span class="ffd">int</span>s<span class="_ _11"> </span>are<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y7562 ff7 fs19 fc2 sc0 ls0 ws0">same<span class="_ _13"> </span>size<span class="_ _0"></span>.<span class="_ _13"> </span>But<span class="_ _13"> </span>if<span class="_ _13"> </span>we<span class="_ _13"> </span>run<span class="_"> </span>this<span class="_ _13"> </span>code<span class="_ _13"> </span>on<span class="_ _13"> </span>a<span class="_ _13"> </span>machine<span class="_ _13"> </span>like<span class="_ _13"> </span>the<span class="_ _13"> </span>Core<span class="_"> </span>i7,<span class="_ _13"> </span>where<span class="_ _13"> </span>a<span class="_ _13"> </span>pointer<span class="_ _13"> </span>is</div><div class="t m5 x1d h26 y7563 ff7 fs19 fc2 sc0 ls0 ws0">larger<span class="_ _13"> </span>than<span class="_"> </span>an<span class="_ _13"> </span><span class="ffd">int</span>,<span class="_"> </span>then<span class="_ _13"> </span>the<span class="_"> </span>loop<span class="_ _13"> </span>in<span class="_"> </span>lines<span class="_ _13"> </span>7–8<span class="_"> </span>will<span class="_ _13"> </span>write<span class="_ _13"> </span>past<span class="_"> </span>the<span class="_ _13"> </span>end<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">A<span class="_ _13"> </span></span>array<span class="_ _3"></span>.</div><div class="t m5 x1d h26 y7564 ff7 fs19 fc2 sc0 ls0 ws0">Since<span class="_ _16"> </span>one<span class="_ _11"> </span>of<span class="_ _16"> </span>these<span class="_ _16"> </span>words<span class="_ _11"> </span>will<span class="_ _16"> </span>likely<span class="_ _16"> </span>be<span class="_ _16"> </span>the<span class="_ _11"> </span>boundary-tag<span class="_ _16"> </span>footer<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>allocated</div><div class="t m5 x1d h26 y7565 ff7 fs19 fc2 sc0 ls0 ws0">block,<span class="_ _14"> </span>we<span class="_ _14"> </span>may<span class="_ _14"> </span>not<span class="_ _16"> </span>discover<span class="_ _14"> </span>the<span class="_ _14"> </span>error<span class="_ _14"> </span>until<span class="_ _14"> </span>we<span class="_ _16"> </span>free<span class="_ _14"> </span>the<span class="_ _14"> </span>block<span class="_ _14"> </span>much<span class="_ _16"> </span>later<span class="_ _14"> </span>in<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y7566 ff7 fs19 fc2 sc0 ls0 ws0">program,<span class="_"> </span>at<span class="_"> </span>which<span class="_ _13"> </span>point<span class="_"> </span>the<span class="_"> </span>coalescing<span class="_"> </span>code<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>allocator<span class="_"> </span>will<span class="_"> </span>fail<span class="_"> </span>dramatically</div><div class="t m5 x1d h26 y7567 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>for<span class="_"> </span>no<span class="_ _13"> </span>apparent<span class="_"> </span>reason.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>is<span class="_"> </span>an<span class="_"> </span>insidious<span class="_ _13"> </span>example<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>kind<span class="_"> </span>of<span class="_ _13"> </span>“action<span class="_"> </span>at</div><div class="t m5 x1d h26 y7568 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>distance”<span class="_"> </span>that<span class="_"> </span>is<span class="_"> </span>so<span class="_"> </span>typical<span class="_"> </span>of<span class="_"> </span>memory-related<span class="_"> </span>programming<span class="_"> </span>bugs<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y7569 ffe fs29 fc2 sc0 ls0 ws0">9.11.5<span class="_ _48"> </span><span class="fs19">Making<span class="_"> </span>Off-by-One<span class="_"> </span>Errors</span></div><div class="t m5 x1d h26 y756a ff7 fs19 fc2 sc0 ls0 ws0">Off-by-one<span class="_"> </span>errors<span class="_"> </span>are<span class="_"> </span>another<span class="_"> </span>common<span class="_"> </span>source<span class="_"> </span>of<span class="_"> </span>overwriting<span class="_"> </span>bugs:</div><div class="t m5 x1f h2d y756b ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Create<span class="_ _e"> </span>an<span class="_ _1f"> </span>nxm<span class="_ _1f"> </span>array<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f h2d y756c ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>**makeArray2(int<span class="_ _e"> </span>n,<span class="_ _1f"> </span>int<span class="_ _1f"> </span>m)</span></div><div class="t m5 x1f h2d y756d ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y756e ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i;</span></div><div class="t m5 x1f h2d y756f ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>**A<span class="_ _1f"> </span>=<span class="_ _1f"> </span>(int<span class="_ _e"> </span>**)Malloc(n<span class="_ _1f"> </span>*<span class="_ _e"> </span>sizeof(int<span class="_ _1f"> </span>*));</span></div><div class="t m5 x1f h2e y7570 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x1f h2e y7571 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x33 h2d y7572 ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;=<span class="_ _e"> </span>n;<span class="_ _1f"> </span>i++)</div><div class="t m5 x1f h2e y7573 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 xf7 h2d y7574 ffd fs1e fc2 sc0 ls0 ws0">A[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>(int<span class="_ _1f"> </span>*)Malloc(m<span class="_ _e"> </span>*<span class="_ _1f"> </span>sizeof(int));</div><div class="t m5 x1f h2e y7575 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x33 h2d y7576 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>A;</div><div class="t m5 x1b0 h2e y7577 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x4f h2d y7578 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x29 h26 y587 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>is<span class="_"> </span>another<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>previous<span class="_"> </span>section.<span class="_"> </span>Here<span class="_"> </span>we<span class="_"> </span>have</div><div class="t m5 x1d h46 y588 ff7 fs19 fc2 sc0 ls0 ws0">created<span class="_ _13"> </span>an<span class="_"> </span><span class="ff11">n</span>-element<span class="_ _13"> </span>array<span class="_"> </span>of<span class="_ _13"> </span>pointers<span class="_"> </span>in<span class="_ _13"> </span>line<span class="_ _13"> </span>5<span class="_"> </span>but<span class="_ _13"> </span>then<span class="_"> </span>tried<span class="_ _13"> </span>to<span class="_ _13"> </span>initialize<span class="_"> </span><span class="ff11">n<span class="_ _13"> </span><span class="ff12">+<span class="_ _10"> </span></span></span><span class="ls2c5">1o<span class="_ _8"></span>f</span></div><div class="t m5 x1d h26 y589 ff7 fs19 fc2 sc0 ls0 ws0">its<span class="_ _13"> </span>elements<span class="_"> </span>in<span class="_ _13"> </span>lines<span class="_ _13"> </span>7<span class="_"> </span>and<span class="_ _13"> </span>8,<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>process<span class="_"> </span>overwriting<span class="_ _13"> </span>some<span class="_ _13"> </span>memory<span class="_"> </span>that<span class="_ _13"> </span>follows</div><div class="t m5 x1d h26 ya77 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span><span class="ffd">A<span class="_ _10"> </span></span>array<span class="_ _3"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
