<div id="pf369" class="pf w2 h11" data-page-no="369"><div class="pc pc369 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg369.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">872<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">physical<span class="_ _13"> </span>copy<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>object.<span class="_ _13"> </span>F<span class="_ _1"></span>or<span class="_ _6"> </span>each<span class="_ _13"> </span>process<span class="_ _13"> </span>that<span class="_ _6"> </span>maps<span class="_ _13"> </span>the<span class="_ _6"> </span>private<span class="_ _13"> </span>object,<span class="_ _13"> </span>the<span class="_ _6"> </span>page</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">table<span class="_"> </span>entries<span class="_"> </span>for<span class="_ _11"> </span>the<span class="_"> </span>corresponding<span class="_ _11"> </span>private<span class="_"> </span>area<span class="_"> </span>are<span class="_ _11"> </span>ﬂagged<span class="_"> </span>as<span class="_ _11"> </span>read-only<span class="_ _3"></span>,<span class="_"> </span>and<span class="_"> </span>the</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">area<span class="_ _13"> </span>struct<span class="_"> </span>is<span class="_ _13"> </span>ﬂagged<span class="_"> </span>as<span class="_ _13"> </span><span class="ffa">private<span class="_"> </span>cop<span class="_ _1"></span>y-on-write<span class="_ _2"></span><span class="ff7">.<span class="_ _13"> </span>So<span class="_"> </span>long<span class="_ _13"> </span>as<span class="_"> </span>neither<span class="_ _13"> </span>process<span class="_"> </span>attempts</span></span></div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>write<span class="_ _11"> </span>to<span class="_"> </span>its<span class="_ _11"> </span>respective<span class="_ _11"> </span>private<span class="_"> </span>area,<span class="_ _11"> </span>they<span class="_ _11"> </span>continue<span class="_"> </span>to<span class="_ _11"> </span>share<span class="_"> </span>a<span class="_ _11"> </span>single<span class="_ _11"> </span>copy<span class="_"> </span>of<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">object<span class="_ _14"> </span>in<span class="_ _16"> </span>physical<span class="_ _14"> </span>memory<span class="_ _3"></span>.<span class="_ _14"> </span>However,<span class="_ _14"> </span>as<span class="_ _14"> </span>soon<span class="_ _14"> </span>as<span class="_ _14"> </span>a<span class="_ _16"> </span>process<span class="_ _14"> </span>attempts<span class="_ _14"> </span>to<span class="_ _14"> </span>write<span class="_ _14"> </span>to</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">some<span class="_"> </span>page<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>private<span class="_"> </span>area,<span class="_"> </span>the<span class="_"> </span>write<span class="_"> </span>triggers<span class="_"> </span>a<span class="_"> </span>protection<span class="_"> </span>fault.</div><div class="t m5 x29 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_"> </span>the<span class="_ _16"> </span>fault<span class="_ _11"> </span>handler<span class="_ _11"> </span>notices<span class="_ _16"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>protection<span class="_ _16"> </span>exception<span class="_ _11"> </span>was<span class="_ _11"> </span>caused<span class="_ _16"> </span>by</div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>process<span class="_ _11"> </span>trying<span class="_ _16"> </span>to<span class="_ _11"> </span>write<span class="_ _11"> </span>to<span class="_ _16"> </span>a<span class="_ _11"> </span>page<span class="_ _11"> </span>in<span class="_ _16"> </span>a<span class="_ _11"> </span>private<span class="_ _11"> </span>copy-on-write<span class="_ _11"> </span>area,<span class="_ _16"> </span>it<span class="_ _11"> </span>creates<span class="_ _16"> </span>a</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">new<span class="_ _11"> </span>copy<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>page<span class="_ _16"> </span>in<span class="_ _11"> </span>physical<span class="_ _16"> </span>memory<span class="_ _7"></span>,<span class="_ _16"> </span>updates<span class="_ _11"> </span>the<span class="_ _16"> </span>page<span class="_ _11"> </span>table<span class="_ _11"> </span>entry<span class="_ _16"> </span>to<span class="_ _11"> </span>point</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _14"> </span>the<span class="_ _15"> </span>new<span class="_ _14"> </span>copy<span class="_ _3"></span>,<span class="_ _21"> </span>and<span class="_ _15"> </span>then<span class="_ _14"> </span>restores<span class="_ _15"> </span>write<span class="_ _14"> </span>permissions<span class="_ _15"> </span>to<span class="_ _15"> </span>the<span class="_ _14"> </span>page,<span class="_ _15"> </span>as<span class="_ _14"> </span>shown<span class="_ _15"> </span>in</div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>9.30(b).<span class="_ _14"> </span>When<span class="_ _16"> </span>the<span class="_ _14"> </span>fault<span class="_ _16"> </span>handler<span class="_ _14"> </span>returns<span class="_ _1"></span>,<span class="_ _15"> </span>the<span class="_ _16"> </span>CPU<span class="_ _14"> </span>re-executes<span class="_ _14"> </span>the<span class="_ _16"> </span>write,</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_"> </span>now<span class="_"> </span>proceeds<span class="_"> </span>normally<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>newly<span class="_"> </span>created<span class="_"> </span>page<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">By<span class="_"> </span>deferring<span class="_ _13"> </span>the<span class="_"> </span>copying<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>pages<span class="_"> </span>in<span class="_ _13"> </span>private<span class="_"> </span>objects<span class="_ _13"> </span>until<span class="_"> </span>the<span class="_ _13"> </span>last<span class="_"> </span>possible</div><div class="t m5 x1d h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">moment,<span class="_"> </span>copy-on-write<span class="_"> </span>makes<span class="_"> </span>the<span class="_"> </span>most<span class="_"> </span>efﬁcient<span class="_"> </span>use<span class="_"> </span>of<span class="_"> </span>scarce<span class="_"> </span>physical<span class="_"> </span>memory<span class="_ _3"></span>.</div><div class="t m5 x1d h41 y7121 ffe fs29 fc2 sc0 ls0 ws0">9.8.2<span class="_ _48"> </span><span class="fs19">The<span class="_"> </span><span class="ffd fs1c">fork<span class="_ _11"> </span></span>Function<span class="_"> </span>Revisited</span></div><div class="t m5 x1d h26 y7122 ff7 fs19 fc2 sc0 ls0 ws0">Now<span class="_ _13"> </span>that<span class="_ _13"> </span>we<span class="_ _13"> </span>understand<span class="_ _13"> </span>virtual<span class="_ _13"> </span>memory<span class="_ _13"> </span>and<span class="_ _6"> </span>memory<span class="_ _13"> </span>mapping,<span class="_ _13"> </span>we<span class="_ _13"> </span>can<span class="_ _13"> </span>get<span class="_ _13"> </span>a<span class="_ _13"> </span>clear</div><div class="t m5 x1d h26 y7123 ff7 fs19 fc2 sc0 ls0 ws0">idea<span class="_ _16"> </span>of<span class="_ _14"> </span>how<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">fork<span class="_ _14"> </span></span>function<span class="_ _14"> </span>creates<span class="_ _16"> </span>a<span class="_ _14"> </span>new<span class="_ _14"> </span>process<span class="_ _14"> </span>with<span class="_ _14"> </span>its<span class="_ _14"> </span>own<span class="_ _16"> </span>independent</div><div class="t m5 x1d h26 y7124 ff7 fs19 fc2 sc0 ls0 ws0">virtual<span class="_"> </span>address<span class="_"> </span>space<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y7125 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">fork<span class="_ _16"> </span></span>function<span class="_ _14"> </span>is<span class="_ _16"> </span>called<span class="_ _16"> </span>by<span class="_ _14"> </span>the<span class="_ _16"> </span><span class="ffa">current<span class="_ _14"> </span>process</span>,<span class="_ _14"> </span>the<span class="_ _16"> </span>kernel<span class="_ _16"> </span>creates</div><div class="t m5 x1d h26 y7126 ff7 fs19 fc2 sc0 ls0 ws0">various<span class="_"> </span>data<span class="_"> </span>structures<span class="_"> </span>for<span class="_ _13"> </span>the<span class="_"> </span><span class="ffa">new<span class="_"> </span>process<span class="_"> </span></span>and<span class="_"> </span>assigns<span class="_"> </span>it<span class="_ _13"> </span>a<span class="_"> </span>unique<span class="_"> </span>PID<span class="_ _3"></span>.<span class="_"> </span>T<span class="_ _3"></span>o<span class="_"> </span>create</div><div class="t m5 x1d h26 y7127 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _15"> </span>virtual<span class="_ _15"> </span>memory<span class="_ _15"> </span>for<span class="_ _21"> </span>the<span class="_ _15"> </span>new<span class="_ _15"> </span>process<span class="_ _1"></span>,<span class="_ _f"> </span>it<span class="_ _15"> </span>creates<span class="_ _15"> </span>exact<span class="_ _21"> </span>copies<span class="_ _15"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>current</div><div class="t m5 x1d h26 y7128 ff7 fs19 fc2 sc0 ls0 ws0">process’s<span class="_ _15"> </span><span class="ffd">mm_struct</span>,<span class="_ _e"> </span>area<span class="_ _21"> </span>structs<span class="_ _1"></span>,<span class="_ _e"> </span>and<span class="_ _21"> </span>page<span class="_ _f"> </span>tables<span class="_ _1"></span>.<span class="_ _f"> </span>It<span class="_ _21"> </span>ﬂags<span class="_ _f"> </span>each<span class="_ _21"> </span>page<span class="_ _f"> </span>in<span class="_ _f"> </span>both</div><div class="t m5 x1d h26 y7129 ff7 fs19 fc2 sc0 ls0 ws0">processes<span class="_ _13"> </span>as<span class="_ _6"> </span>read-only<span class="_ _3"></span>,<span class="_ _13"> </span>and<span class="_ _6"> </span>ﬂags<span class="_ _13"> </span>each<span class="_ _6"> </span>area<span class="_ _13"> </span>struct<span class="_ _6"> </span>in<span class="_ _13"> </span>both<span class="_ _6"> </span>processes<span class="_ _13"> </span>as<span class="_ _6"> </span>private<span class="_ _13"> </span>copy-</div><div class="t m5 x1d h26 y712a ff7 fs19 fc2 sc0 ls0 ws0">on-write<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y712b ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">fork<span class="_ _10"> </span></span>returns<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>new<span class="_"> </span>process<span class="_ _3"></span>,<span class="_"> </span>the<span class="_"> </span>new<span class="_"> </span>process<span class="_"> </span>now<span class="_ _13"> </span>has<span class="_"> </span>an<span class="_"> </span>exact</div><div class="t m5 x1d h26 y712c ff7 fs19 fc2 sc0 ls0 ws0">copy<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>virtual<span class="_ _16"> </span>memory<span class="_ _16"> </span>as<span class="_ _16"> </span>it<span class="_ _16"> </span>existed<span class="_ _16"> </span>when<span class="_ _16"> </span>the<span class="_ _16"> </span>fork<span class="_ _11"> </span>was<span class="_ _16"> </span>called.<span class="_ _16"> </span>When<span class="_ _16"> </span>either</div><div class="t m5 x1d h26 y712d ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _16"> </span>the<span class="_ _16"> </span>processes<span class="_ _16"> </span>performs<span class="_ _16"> </span>any<span class="_ _16"> </span>subsequent<span class="_ _16"> </span>writes<span class="_ _1"></span>,<span class="_ _14"> </span>the<span class="_ _16"> </span>copy-on-write<span class="_ _16"> </span>mechanism</div><div class="t m5 x1d h26 y712e ff7 fs19 fc2 sc0 ls0 ws0">creates<span class="_ _11"> </span>new<span class="_ _11"> </span>pages<span class="_ _1"></span>,<span class="_ _11"> </span>thus<span class="_ _11"> </span>preserving<span class="_ _11"> </span>the<span class="_ _11"> </span>abstraction<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_ _11"> </span>private<span class="_ _11"> </span>address<span class="_ _11"> </span>space<span class="_ _11"> </span>for</div><div class="t m5 x1d h26 y712f ff7 fs19 fc2 sc0 ls0 ws0">each<span class="_"> </span>process<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y7130 ffe fs29 fc2 sc0 ls0 ws0">9.8.3<span class="_ _48"> </span><span class="fs19">The<span class="_"> </span><span class="ffd fs1c">execve<span class="_ _11"> </span></span>Function<span class="_"> </span>Revisited</span></div><div class="t m5 x1d h26 y3395 ff7 fs19 fc2 sc0 ls0 ws0">V<span class="_ _1"></span>irtual<span class="_ _13"> </span>memory<span class="_ _13"> </span>and<span class="_ _6"> </span>memory<span class="_ _13"> </span>mapping<span class="_ _6"> </span>also<span class="_ _13"> </span>play<span class="_ _6"> </span>key<span class="_ _13"> </span>roles<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>process<span class="_ _6"> </span>of<span class="_ _13"> </span>loading</div><div class="t m5 x1d h26 y3396 ff7 fs19 fc2 sc0 ls0 ws0">programs<span class="_ _16"> </span>into<span class="_ _16"> </span>memory<span class="_ _3"></span>.<span class="_ _16"> </span>Now<span class="_ _16"> </span>that<span class="_ _16"> </span>we<span class="_ _16"> </span>understand<span class="_ _16"> </span>these<span class="_ _16"> </span>concepts<span class="_ _1"></span>,<span class="_ _16"> </span>we<span class="_ _16"> </span>can<span class="_ _14"> </span>under<span class="_ _1"></span>-</div><div class="t m5 x1d h26 y7131 ff7 fs19 fc2 sc0 ls0 ws0">stand<span class="_"> </span>how<span class="_"> </span>the<span class="_"> </span><span class="ffd">execve<span class="_ _10"> </span></span>function<span class="_"> </span>really<span class="_"> </span>loads<span class="_"> </span>and<span class="_"> </span>executes<span class="_"> </span>programs<span class="_ _3"></span>.<span class="_"> </span>Suppose<span class="_"> </span>that</div><div class="t m5 x1d h26 y7132 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>program<span class="_"> </span>running<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>current<span class="_"> </span>process<span class="_"> </span>makes<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>call:</div><div class="t m5 x10c h2d y7133 ffd fs1e fc2 sc0 ls0 ws0">execve(&quot;a.out&quot;,<span class="_ _e"> </span>NULL,<span class="_ _1f"> </span>NULL);</div><div class="t m5 x29 h26 y587 ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _13"> </span>you<span class="_ _13"> </span>learned<span class="_ _13"> </span>in<span class="_"> </span>Chapter<span class="_ _13"> </span>8,<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">execve<span class="_ _13"> </span></span>function<span class="_ _13"> </span>loads<span class="_"> </span>and<span class="_ _13"> </span>runs<span class="_ _13"> </span>the<span class="_ _13"> </span>program</div><div class="t m5 x1d h26 y588 ff7 fs19 fc2 sc0 ls0 ws0">contained<span class="_ _6"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>executable<span class="_ _6"> </span>object<span class="_ _6"> </span>ﬁle<span class="_ _6"> </span><span class="ffd">a.out<span class="_ _13"> </span></span>within<span class="_ _6"> </span>the<span class="_ _6"> </span>current<span class="_ _6"> </span>process<span class="_ _0"></span>,<span class="_ _13"> </span>effectively</div><div class="t m5 x1d h26 y589 ff7 fs19 fc2 sc0 ls0 ws0">replacing<span class="_ _21"> </span>the<span class="_ _21"> </span>current<span class="_ _21"> </span>program<span class="_ _21"> </span>with<span class="_ _21"> </span>the<span class="_ _21"> </span><span class="ffd">a.out<span class="_ _21"> </span></span>program.<span class="_ _21"> </span>Loading<span class="_ _f"> </span>and<span class="_ _21"> </span>running</div><div class="t m5 x1d h26 ya77 ffd fs19 fc2 sc0 ls0 ws0">a.out<span class="_ _10"> </span><span class="ff7">requires<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>steps:</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
