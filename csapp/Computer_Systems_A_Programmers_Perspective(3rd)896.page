<div id="pf380" class="pf w2 h11" data-page-no="380"><div class="pc pc380 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg380.png"/><div class="t m5 x1c9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.9<span class="_ _60"> </span>Dynamic<span class="_ _10"> </span>Memor<span class="_"> </span>y<span class="_ _10"> </span>Allocation<span class="_ _3e"> </span><span class="ffe fs1e">895</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">multiple<span class="_ _16"> </span>of<span class="_ _16"> </span>2<span class="_ _16"> </span>words<span class="_ _16"> </span>(8<span class="_ _16"> </span>bytes)<span class="_ _16"> </span>and<span class="_ _11"> </span>then<span class="_ _16"> </span>requests<span class="_ _16"> </span>the<span class="_ _16"> </span>additional<span class="_ _16"> </span>heap<span class="_ _16"> </span>space<span class="_ _16"> </span>from</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>memory<span class="_"> </span>system<span class="_"> </span>(lines<span class="_"> </span>7–9).</div><div class="t m5 x26 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>remainder<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">extend_heap<span class="_ _13"> </span></span>function<span class="_ _13"> </span>(lines<span class="_ _13"> </span>12–17)<span class="_ _13"> </span>is<span class="_ _13"> </span>somewhat<span class="_ _13"> </span>subtle<span class="_ _0"></span>.</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>heap<span class="_ _11"> </span>begins<span class="_ _11"> </span>on<span class="_ _16"> </span>a<span class="_ _11"> </span>double-word<span class="_ _11"> </span>aligned<span class="_ _16"> </span>boundary<span class="_ _3"></span>,<span class="_ _11"> </span>and<span class="_ _16"> </span>every<span class="_ _11"> </span>call<span class="_ _11"> </span>to<span class="_ _16"> </span><span class="ffd">extend_</span></div><div class="t m5 x17 h26 y2f8 ffd fs19 fc2 sc0 ls0 ws0">heap<span class="_ _13"> </span><span class="ff7">returns<span class="_ _6"> </span>a<span class="_ _13"> </span>block<span class="_ _6"> </span>whose<span class="_ _13"> </span>size<span class="_ _6"> </span>is<span class="_ _13"> </span>an<span class="_ _6"> </span>integral<span class="_ _13"> </span>number<span class="_ _13"> </span>of<span class="_ _6"> </span>double<span class="_ _13"> </span>words<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_ _13"> </span>every</span></div><div class="t m5 x17 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">call<span class="_ _16"> </span>to<span class="_ _14"> </span><span class="ffd">mem_sbrk<span class="_ _16"> </span></span>returns<span class="_ _14"> </span>a<span class="_ _16"> </span>double-word<span class="_ _14"> </span>aligned<span class="_ _14"> </span>chunk<span class="_ _16"> </span>of<span class="_ _14"> </span>memory<span class="_ _16"> </span>immediately</div><div class="t m5 x17 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">following<span class="_ _16"> </span>the<span class="_ _16"> </span>header<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>epilogue<span class="_ _16"> </span>block.<span class="_ _16"> </span>T<span class="_ _0"></span>his<span class="_ _16"> </span>header<span class="_ _16"> </span>becomes<span class="_ _16"> </span>the<span class="_ _16"> </span>header<span class="_ _16"> </span>of</div><div class="t m5 x17 h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>new<span class="_ _14"> </span>free<span class="_ _14"> </span>block<span class="_ _14"> </span>(line<span class="_ _14"> </span>12),<span class="_ _15"> </span>and<span class="_ _14"> </span>the<span class="_ _15"> </span>last<span class="_ _14"> </span>word<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>chunk<span class="_ _14"> </span>becomes<span class="_ _14"> </span>the<span class="_ _15"> </span>new</div><div class="t m5 x17 h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">epilogue<span class="_"> </span>block<span class="_ _11"> </span>header<span class="_ _11"> </span>(line<span class="_ _11"> </span>14).<span class="_ _11"> </span>F<span class="_ _1"></span>inally<span class="_ _3"></span>,<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>likely<span class="_ _11"> </span>case<span class="_"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>previous<span class="_ _11"> </span>heap</div><div class="t m5 x17 h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">was<span class="_ _11"> </span>terminated<span class="_ _11"> </span>by<span class="_ _11"> </span>a<span class="_ _11"> </span>free<span class="_ _16"> </span>block,<span class="_ _11"> </span>we<span class="_ _11"> </span>call<span class="_ _11"> </span>the<span class="_ _11"> </span><span class="ffd">coalesce<span class="_ _16"> </span></span>function<span class="_"> </span>to<span class="_ _16"> </span>merge<span class="_"> </span>the<span class="_ _16"> </span>two</div><div class="t m5 x17 h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">free<span class="_"> </span>blocks<span class="_"> </span>and<span class="_"> </span>return<span class="_"> </span>the<span class="_"> </span>block<span class="_"> </span>pointer<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>merged<span class="_"> </span>blocks<span class="_"> </span>(line<span class="_"> </span>17).</div><div class="t m5 x17 h42 y4f52 ff6 fs29 fc6 sc0 ls0 ws0">Freeing<span class="_ _11"> </span>and<span class="_ _16"> </span>Coalescing<span class="_ _16"> </span>Blocks</div><div class="t m5 x17 h26 y740a ff7 fs19 fc1 sc0 ls0 ws0">An<span class="_"> </span>application<span class="_ _13"> </span>frees<span class="_"> </span>a<span class="_"> </span>previously<span class="_ _13"> </span>allocated<span class="_"> </span>block<span class="_ _13"> </span>by<span class="_"> </span>calling<span class="_"> </span>the<span class="_"> </span><span class="ffd">mm_free<span class="_ _13"> </span></span>function</div><div class="t m5 x17 h26 y740b ff7 fs19 fc1 sc0 ls0 ws0">(F<span class="_ _1"></span>igure<span class="_ _21"> </span>9.46),<span class="_ _f"> </span>which<span class="_ _21"> </span>frees<span class="_ _15"> </span>the<span class="_ _21"> </span>requested<span class="_ _21"> </span>block<span class="_ _15"> </span>(<span class="ffd">bp</span>)<span class="_ _21"> </span>and<span class="_ _21"> </span>then<span class="_ _15"> </span>merges<span class="_ _21"> </span>adjacent</div><div class="t m5 x17 h26 y740c ff7 fs19 fc1 sc0 ls0 ws0">free<span class="_ _15"> </span>blocks<span class="_ _15"> </span>using<span class="_ _21"> </span>the<span class="_ _15"> </span>boundary-tags<span class="_ _15"> </span>coalescing<span class="_ _21"> </span>technique<span class="_ _15"> </span>described<span class="_ _21"> </span>in<span class="_ _15"> </span>Section</div><div class="t m5 x17 h26 y740d ff7 fs19 fc1 sc0 ls0 ws0">9.9.11.</div><div class="t m5 x26 h26 y740e ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>code<span class="_ _6"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">coalesce<span class="_ _6"> </span></span>helper<span class="_ _6"> </span>function<span class="_ _13"> </span>is<span class="_ _6"> </span>a<span class="_ _6"> </span>straightforward<span class="_ _13"> </span>implementation</div><div class="t m5 x17 h26 y740f ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _13"> </span>the<span class="_ _13"> </span>four<span class="_ _13"> </span>cases<span class="_ _13"> </span>outlined<span class="_ _6"> </span>in<span class="_ _13"> </span>Figure<span class="_ _6"> </span>9.40.<span class="_ _13"> </span>T<span class="_ _0"></span>here<span class="_ _13"> </span>is<span class="_ _13"> </span>one<span class="_ _13"> </span>somewhat<span class="_ _13"> </span>subtle<span class="_ _6"> </span>aspect.<span class="_ _13"> </span>The</div><div class="t m5 x17 h26 y7410 ff7 fs19 fc1 sc0 ls0 ws0">free<span class="_ _11"> </span>list<span class="_ _16"> </span>format<span class="_ _16"> </span>we<span class="_ _11"> </span>have<span class="_ _16"> </span>chosen—with<span class="_ _11"> </span>its<span class="_ _16"> </span>prologue<span class="_ _11"> </span>and<span class="_ _16"> </span>epilogue<span class="_ _11"> </span>blocks<span class="_ _16"> </span>that<span class="_ _16"> </span>are</div><div class="t m5 x17 h26 y7411 ff7 fs19 fc1 sc0 ls0 ws0">always<span class="_ _13"> </span>marked<span class="_ _6"> </span>as<span class="_ _13"> </span>allocated—allows<span class="_ _13"> </span>us<span class="_ _6"> </span>to<span class="_ _13"> </span>ignore<span class="_ _13"> </span>the<span class="_ _13"> </span>potentially<span class="_ _6"> </span>troublesome<span class="_ _13"> </span>edge</div><div class="t m5 x17 h26 y7412 ff7 fs19 fc1 sc0 ls0 ws0">conditions<span class="_ _11"> </span>where<span class="_ _16"> </span>the<span class="_ _16"> </span>requested<span class="_ _11"> </span>block<span class="_ _16"> </span><span class="ffd">bp<span class="_ _11"> </span></span>is<span class="_ _16"> </span>at<span class="_ _16"> </span>the<span class="_ _11"> </span>beginning<span class="_ _16"> </span>or<span class="_ _16"> </span>end<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>heap.</div><div class="t m5 x17 h26 y7413 ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _1"></span>ithout<span class="_ _16"> </span>these<span class="_ _11"> </span>special<span class="_ _11"> </span>blocks<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>code<span class="_ _11"> </span>would<span class="_ _16"> </span>be<span class="_ _11"> </span>messier,<span class="_ _11"> </span>more<span class="_ _11"> </span>error<span class="_ _11"> </span>prone,<span class="_ _11"> </span>and</div><div class="t m5 x17 h26 y7414 ff7 fs19 fc1 sc0 ls0 ws0">slower<span class="_ _16"> </span>because<span class="_ _16"> </span>we<span class="_ _16"> </span>would<span class="_ _14"> </span>have<span class="_ _16"> </span>to<span class="_ _16"> </span>check<span class="_ _16"> </span>for<span class="_ _14"> </span>these<span class="_ _16"> </span>rare<span class="_ _16"> </span>edge<span class="_ _16"> </span>conditions<span class="_ _16"> </span>on<span class="_ _14"> </span>each</div><div class="t m5 x17 h26 y7415 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>every<span class="_"> </span>free<span class="_"> </span>request.</div><div class="t m5 x17 h42 y2155 ff6 fs29 fc6 sc0 ls0 ws0">Allocating<span class="_ _11"> </span>Blocks</div><div class="t m5 x17 h26 y7416 ff7 fs19 fc1 sc0 ls0 ws0">An<span class="_ _13"> </span>application<span class="_ _6"> </span>requests<span class="_ _13"> </span>a<span class="_ _6"> </span>block<span class="_ _13"> </span>of<span class="_ _6"> </span><span class="ffd">size<span class="_ _13"> </span></span>bytes<span class="_ _6"> </span>of<span class="_ _13"> </span>memory<span class="_ _6"> </span>by<span class="_ _13"> </span>calling<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">mm_malloc</span></div><div class="t m5 x17 h26 y7417 ff7 fs19 fc1 sc0 ls0 ws0">function<span class="_ _16"> </span>(Figure<span class="_ _16"> </span>9.47).<span class="_ _16"> </span>After<span class="_ _16"> </span>checking<span class="_ _14"> </span>for<span class="_ _16"> </span>spurious<span class="_ _16"> </span>requests<span class="_ _0"></span>,<span class="_ _14"> </span>the<span class="_ _16"> </span>allocator<span class="_ _14"> </span>must</div><div class="t m5 x17 h26 y7418 ff7 fs19 fc1 sc0 ls0 ws0">adjust<span class="_ _13"> </span>the<span class="_ _13"> </span>requested<span class="_ _13"> </span>block<span class="_ _6"> </span>size<span class="_ _13"> </span>to<span class="_ _13"> </span>allow<span class="_ _13"> </span>room<span class="_ _13"> </span>for<span class="_ _13"> </span>the<span class="_ _6"> </span>header<span class="_ _13"> </span>and<span class="_ _13"> </span>the<span class="_ _13"> </span>footer,<span class="_ _13"> </span>and<span class="_ _6"> </span>to</div><div class="t m5 x17 h26 y7419 ff7 fs19 fc1 sc0 ls0 ws0">satisfy<span class="_ _6"> </span>the<span class="_ _6"> </span>double-word<span class="_ _6"> </span>alignment<span class="_ _13"> </span>requirement.<span class="_ _a"> </span>Lines<span class="_ _13"> </span>12–13<span class="_ _a"> </span>enforce<span class="_ _6"> </span>the<span class="_ _13"> </span>minimum</div><div class="t m5 x17 h26 y741a ff7 fs19 fc1 sc0 ls0 ws0">block<span class="_ _16"> </span>size<span class="_ _16"> </span>of<span class="_ _16"> </span>16<span class="_ _16"> </span>bytes:<span class="_ _14"> </span>8<span class="_ _16"> </span>bytes<span class="_ _16"> </span>to<span class="_ _16"> </span>satisfy<span class="_ _16"> </span>the<span class="_ _14"> </span>alignment<span class="_ _16"> </span>requirement<span class="_ _16"> </span>and<span class="_ _16"> </span>8<span class="_ _16"> </span>more</div><div class="t m5 x17 h26 y741b ff7 fs19 fc1 sc0 ls0 ws0">bytes<span class="_ _6"> </span>for<span class="_ _13"> </span>the<span class="_ _6"> </span>overhead<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>header<span class="_ _13"> </span>and<span class="_ _6"> </span>footer.<span class="_ _6"> </span>F<span class="_ _1"></span>or<span class="_ _6"> </span>requests<span class="_ _13"> </span>over<span class="_ _6"> </span>8<span class="_ _6"> </span>bytes<span class="_ _13"> </span>(line<span class="_ _6"> </span>15),</div><div class="t m5 x17 h26 y741c ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>general<span class="_"> </span>rule<span class="_"> </span>is<span class="_"> </span>to<span class="_"> </span>add<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>overhead<span class="_"> </span>bytes<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>round<span class="_"> </span>up<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>nearest</div><div class="t m5 x17 h26 y741d ff7 fs19 fc1 sc0 ls0 ws0">multiple<span class="_"> </span>of<span class="_"> </span>8.</div><div class="t m5 x26 h26 y741e ff7 fs19 fc1 sc0 ls0 ws0">Once<span class="_ _6"> </span>the<span class="_ _13"> </span>allocator<span class="_ _6"> </span>has<span class="_ _13"> </span>adjusted<span class="_ _6"> </span>the<span class="_ _6"> </span>requested<span class="_ _13"> </span>size<span class="_ _1"></span>,<span class="_ _13"> </span>it<span class="_ _6"> </span>searches<span class="_ _13"> </span>the<span class="_ _6"> </span>free<span class="_ _6"> </span>list<span class="_ _13"> </span>for<span class="_ _6"> </span>a</div><div class="t m5 x17 h26 y741f ff7 fs19 fc1 sc0 ls0 ws0">suitable<span class="_ _13"> </span>free<span class="_ _13"> </span>block<span class="_ _6"> </span>(line<span class="_ _13"> </span>18).<span class="_ _13"> </span>If<span class="_ _13"> </span>there<span class="_ _6"> </span>is<span class="_ _13"> </span>a<span class="_ _13"> </span>ﬁt,<span class="_ _13"> </span>then<span class="_ _13"> </span>the<span class="_ _13"> </span>allocator<span class="_ _6"> </span>places<span class="_ _13"> </span>the<span class="_ _13"> </span>requested</div><div class="t m5 x17 h26 y7420 ff7 fs19 fc1 sc0 ls0 ws0">block<span class="_ _13"> </span>and<span class="_"> </span>optionally<span class="_ _13"> </span>splits<span class="_"> </span>the<span class="_ _13"> </span>excess<span class="_ _13"> </span>(line<span class="_"> </span>19)<span class="_ _13"> </span>and<span class="_ _13"> </span>then<span class="_"> </span>returns<span class="_ _13"> </span>the<span class="_"> </span>address<span class="_ _13"> </span>of<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y7421 ff7 fs19 fc1 sc0 ls0 ws0">newly<span class="_"> </span>allocated<span class="_"> </span>block.</div><div class="t m5 x26 h26 y7422 ff7 fs19 fc1 sc0 ls0 ws0">If<span class="_ _16"> </span>the<span class="_ _14"> </span>allocator<span class="_ _14"> </span>cannot<span class="_ _14"> </span>ﬁnd<span class="_ _16"> </span>a<span class="_ _14"> </span>ﬁt,<span class="_ _15"> </span>it<span class="_ _16"> </span>extends<span class="_ _14"> </span>the<span class="_ _14"> </span>heap<span class="_ _16"> </span>with<span class="_ _14"> </span>a<span class="_ _14"> </span>new<span class="_ _14"> </span>free<span class="_ _16"> </span>block</div><div class="t m5 x17 h26 y7423 ff7 fs19 fc1 sc0 ls0 ws0">(lines<span class="_ _13"> </span>24–26),<span class="_ _13"> </span>places<span class="_ _13"> </span>the<span class="_ _6"> </span>requested<span class="_ _13"> </span>block<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _6"> </span>new<span class="_ _13"> </span>free<span class="_ _13"> </span>block,<span class="_ _13"> </span>optionally<span class="_ _13"> </span>splitting</div><div class="t m5 x17 h26 y7424 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>block<span class="_"> </span>(line<span class="_"> </span>27),<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>returns<span class="_"> </span>a<span class="_"> </span>pointer<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>newly<span class="_"> </span>allocated<span class="_"> </span>block.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
