<div id="pf1d7" class="pf w2 h11" data-page-no="1d7"><div class="pc pc1d7 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1d7.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">470<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>4<span class="_ _3d"> </span>Processor<span class="_ _10"> </span>Architecture</span></div><div class="t m5 x200 h9e y412e ff49 fs62 fc1 sc0 ls0 ws0">F<span class="_ _1c3"></span><span class="ff4a fs63">0x000: irmovq $10,%rdx</span></div><div class="t m5 xa2 h9e y412f ff4a fs63 fc1 sc0 ls0 ws0"># prog2</div><div class="c x1d y4130 w9 ha8"><div class="t m5 x257 h9e y4131 ff4a fs63 fc3 sc1 ls0 ws0"># prog2</div></div><div class="t m5 xa2 h9e y4132 ff4a fs63 fc1 sc0 ls0 ws0">0x00a: irmovq  $3,%rax</div><div class="t m5 xa2 h9e y4133 ff4a fs63 fc1 sc0 ls0 ws0">0x014: nop</div><div class="t m5 xa2 h9e y4134 ff4a fs63 fc1 sc0 ls0 ws0">0x015: nop</div><div class="t mb xa2 ha9 y4135 ff4a fs68 fc1 sc0 ls0 ws0">       bubble</div><div class="c x1d y4130 w9 ha8"><div class="t mb x257 ha9 y4136 ff4a fs68 fc3 sc1 ls0 ws0">       bubble</div></div><div class="t m5 xa2 h9e y4137 ff4a fs63 fc1 sc0 ls0 ws0">0x016: addlq %rdx,%rax</div><div class="t m5 xa2 h9e y4138 ff4a fs63 fc1 sc0 ls0 ws0">0x018: halt</div><div class="t m5 x16f ha0 y412e ff49 fs62 fc1 sc0 ls1cc ws0">DE<span class="_ _1"></span>M<span class="_ _7"></span>W</div><div class="t m5 x16f ha0 y4139 ff49 fs62 fc1 sc0 ls1cd ws0">FDE<span class="_ _3"></span>M<span class="_ _8"></span>W</div><div class="t m5 x24 ha0 y413a ff49 fs62 fc1 sc0 ls1cd ws0">FDE<span class="_ _3"></span>M<span class="_ _8"></span>W</div><div class="t m5 x1bb ha0 y413b ff49 fs62 fc1 sc0 ls1ce ws0">FDE<span class="_ _3"></span>M<span class="_ _8"></span>W</div><div class="t m5 x1bd ha0 y413c ff49 fs62 fc1 sc0 ls1d8 ws0">EM<span class="_ _7"></span>W</div><div class="t m5 x195 ha0 y413d ff49 fs62 fc1 sc0 ls1ce ws0">FD<span class="_ _1"></span>DE<span class="_ _79"> </span>W<span class="_ _191"></span><span class="ls0">M</span></div><div class="t m5 x54 ha0 y413e ff49 fs62 fc1 sc0 ls1d9 ws0">FF<span class="_ _1"></span>D<span class="_ _1"></span>E<span class="_ _f1"> </span>W<span class="_ _1c6"></span><span class="ls0">M</span></div><div class="t m5 x86 ha1 y413f ff49 fs64 fc6 sc0 ls1da ws0">12345</div><div class="t m5 x100 ha1 y4140 ff49 fs64 fc6 sc0 ls0 ws0">6</div><div class="t m5 xae ha1 y4141 ff49 fs64 fc6 sc0 ls0 ws0">7</div><div class="t m5 x11d ha1 y4142 ff49 fs64 fc6 sc0 ls0 ws0">8</div><div class="t m5 x193 ha1 y4143 ff49 fs64 fc6 sc0 ls1db ws0">91<span class="_ _184"></span>0<span class="_ _2"></span>1<span class="_ _1c4"></span>1</div><div class="t m5 x1d h3a y4144 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _14"> </span>4.47<span class="_ _c"> </span><span class="fc1">Pipelined<span class="_ _14"> </span>execution<span class="_ _15"> </span>of<span class="_ _14"> </span><span class="ffd fs19">prog2<span class="_ _15"> </span></span>using<span class="_ _14"> </span>stalls.<span class="_ _15"> </span><span class="ff6">After<span class="_ _14"> </span>decoding<span class="_ _15"> </span>the<span class="_ _14"> </span><span class="ffd fs19">addq</span></span></span></div><div class="t m5 x1d h34 y21e2 ff6 fs16 fc1 sc0 ls0 ws0">instruction<span class="_ _11"> </span>in<span class="_ _16"> </span>cycle<span class="_ _16"> </span>6,<span class="_ _11"> </span>the<span class="_ _16"> </span>stall<span class="_ _16"> </span>control<span class="_ _11"> </span>logic<span class="_ _16"> </span>detects<span class="_ _11"> </span>a<span class="_ _16"> </span>data<span class="_ _16"> </span>hazard<span class="_ _11"> </span>due<span class="_ _16"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>pending</div><div class="t m5 x1d h34 y4145 ff6 fs16 fc1 sc0 ls0 ws0">write<span class="_ _10"> </span>to<span class="_ _11"> </span>register</div><div class="t m5 x15c h3a y4146 ffd fs19 fc1 sc0 ls0 ws0">%rax</div><div class="t m5 x1f4 h34 y4147 ff6 fs16 fc1 sc0 ls0 ws0">in<span class="_ _10"> </span>the<span class="_ _11"> </span>write-back<span class="_ _11"> </span>stage.<span class="_ _10"> </span>It<span class="_ _11"> </span>injects<span class="_ _11"> </span>a<span class="_ _10"> </span>bubble<span class="_ _11"> </span>into<span class="_ _11"> </span>the<span class="_ _10"> </span>execute<span class="_ _11"> </span>stage</div><div class="t m5 x1d h34 y4148 ff6 fs16 fc1 sc0 ls0 ws0">and<span class="_ _11"> </span>repeats<span class="_ _11"> </span>the<span class="_ _10"> </span>decoding<span class="_ _11"> </span>of<span class="_ _11"> </span>the</div><div class="t m5 xaa h3a y4149 ffd fs19 fc1 sc0 ls0 ws0">addq<span class="_ _11"> </span><span class="ff6 fs16">instruction<span class="_ _11"> </span>in<span class="_ _10"> </span>cycle<span class="_ _11"> </span>7.<span class="_ _11"> </span>In<span class="_ _11"> </span>effect,<span class="_ _11"> </span>the<span class="_ _11"> </span>machine<span class="_ _11"> </span>has</span></div><div class="t m5 x1d h34 y414a ff6 fs16 fc1 sc0 ls0 ws0">dynamically<span class="_ _16"> </span>inserted<span class="_ _16"> </span>a</div><div class="t m5 x189 h3a y414b ffd fs19 fc1 sc0 ls0 ws0">nop<span class="_ _16"> </span><span class="ff6 fs16">instruction,<span class="_ _16"> </span>giving<span class="_ _16"> </span>a<span class="_ _16"> </span>ﬂow<span class="_ _16"> </span>similar<span class="_ _11"> </span>to<span class="_ _16"> </span>that<span class="_ _16"> </span>shown<span class="_ _16"> </span>for<span class="_ _16"> </span></span>prog1</div><div class="t m5 x1d h34 y414c ff6 fs16 fc1 sc0 ls0 ws0">(Figure<span class="_ _10"> </span>4.43).</div><div class="t m5 x7b haa y414d ff49 fs69 fc1 sc0 ls0 ws0">F<span class="_ _1c7"></span><span class="ff4a fs6a">0x000: irmovq $10,%rdx</span></div><div class="t m5 x17d haa y414e ff4a fs6a fc1 sc0 ls0 ws0"># prog4</div><div class="c x1d y414f wa hab"><div class="t m5 x258 haa y4150 ff4a fs6a fc3 sc1 ls0 ws0"># prog4</div></div><div class="t m5 x17d haa y4151 ff4a fs6a fc1 sc0 ls0 ws0">0x00a: irmovq  $3,%rax</div><div class="t mc x17d hac y4152 ff4a fs6b fc1 sc0 ls0 ws0">       </div><div class="t md x58 had y4152 ff4a fs6c fc1 sc0 ls0 ws0">bubble</div><div class="c x1d y414f wa hab"><div class="t md x259 had y4153 ff4a fs6c fc3 sc1 ls0 ws0">bubble</div></div><div class="t mc x17d hac y4154 ff4a fs6b fc1 sc0 ls0 ws0">       </div><div class="t md x58 had y4154 ff4a fs6c fc1 sc0 ls0 ws0">bubble</div><div class="c x1d y414f wa hab"><div class="t md x259 had y4155 ff4a fs6c fc3 sc1 ls0 ws0">bubble</div></div><div class="t mc x17d hac y4156 ff4a fs6b fc1 sc0 ls0 ws0">       </div><div class="t md x58 had y4156 ff4a fs6c fc1 sc0 ls0 ws0">bubble</div><div class="c x1d y414f wa hab"><div class="t md x259 had y4157 ff4a fs6c fc3 sc1 ls0 ws0">bubble</div></div><div class="t m5 x17d haa y4158 ff4a fs6a fc1 sc0 ls0 ws0">0x014: addq %rdx,%rax</div><div class="t m5 x17d haa y4159 ff4a fs6a fc1 sc0 ls0 ws0">0x016: halt</div><div class="t m5 x101 hae y414d ff49 fs69 fc1 sc0 ls1dc ws0">DE<span class="_ _1"></span>M<span class="_ _7"></span>W</div><div class="t m5 x130 hae y415a ff49 fs69 fc1 sc0 ls1dd ws0">FDE<span class="_ _3"></span>M<span class="_ _8"></span>W</div><div class="t m5 x80 hae y415b ff49 fs69 fc1 sc0 ls1de ws0">EM<span class="_ _7"></span>W</div><div class="t m5 x54 hae y415c ff49 fs69 fc1 sc0 ls1df ws0">EM<span class="_ _7"></span>W</div><div class="t m5 x1bd hae y415d ff49 fs69 fc1 sc0 ls1de ws0">EM<span class="_ _7"></span>W</div><div class="t m5 x195 hae y415e ff49 fs69 fc1 sc0 ls0 ws0">D<span class="_ _f2"></span>D<span class="_ _f2"></span>F</div><div class="t m5 x80 hae y415f ff49 fs69 fc1 sc0 ls0 ws0">F<span class="_ _124"></span>F</div><div class="t m5 x54 hae y415e ff49 fs69 fc1 sc0 ls1e0 ws0">DDE<span class="_ _7b"> </span>W<span class="_ _1c8"></span><span class="ls0">M</span></div><div class="t m5 x204 hae y4160 ff49 fs69 fc1 sc0 ls1e1 ws0">FF<span class="_ _1"></span>D<span class="_ _1"></span>E<span class="_ _95"> </span>W<span class="_ _191"></span><span class="ls0">M</span></div><div class="t m5 x23d haf y4161 ff49 fs6d fc6 sc0 ls1e2 ws0">12345</div><div class="t m5 x100 haf y4162 ff49 fs6d fc6 sc0 ls0 ws0">6</div><div class="t m5 xae haf y4163 ff49 fs6d fc6 sc0 ls0 ws0">7</div><div class="t m5 x11d haf y4164 ff49 fs6d fc6 sc0 ls0 ws0">8</div><div class="t m5 x104 haf y4165 ff49 fs6d fc6 sc0 ls1e3 ws0">91<span class="_ _184"></span>0<span class="_ _2"></span>1<span class="_ _1c4"></span>1</div><div class="t m5 x1d h3a y4166 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _14"> </span>4.48<span class="_ _c"> </span><span class="fc1">Pipelined<span class="_ _14"> </span>execution<span class="_ _15"> </span>of<span class="_ _14"> </span><span class="ffd fs19">prog4<span class="_ _15"> </span></span>using<span class="_ _14"> </span>stalls.<span class="_ _15"> </span><span class="ff6">After<span class="_ _14"> </span>decoding<span class="_ _15"> </span>the<span class="_ _14"> </span><span class="ffd fs19">addq</span></span></span></div><div class="t m5 x1d h34 y4167 ff6 fs16 fc1 sc0 ls0 ws0">instruction<span class="_ _13"> </span>in<span class="_ _13"> </span>cycle<span class="_ _13"> </span>4,<span class="_ _13"> </span>the<span class="_ _13"> </span>stall<span class="_ _13"> </span>control<span class="_ _13"> </span>logic<span class="_ _13"> </span>detects<span class="_ _13"> </span>data<span class="_ _6"> </span>hazards<span class="_ _13"> </span>for<span class="_ _13"> </span>both<span class="_ _13"> </span>source<span class="_ _13"> </span>registers.</div><div class="t m5 x1d h34 y4168 ff6 fs16 fc1 sc0 ls0 ws0">It<span class="_ _6"> </span>injects<span class="_ _13"> </span>a<span class="_ _6"> </span>bubble<span class="_ _13"> </span>into<span class="_ _6"> </span>the<span class="_ _13"> </span>execute<span class="_ _6"> </span>stage<span class="_ _13"> </span>and<span class="_ _6"> </span>repeats<span class="_ _13"> </span>the<span class="_ _6"> </span>decoding<span class="_ _13"> </span>of<span class="_ _6"> </span>the</div><div class="t m5 x38 h3a y4169 ffd fs19 fc1 sc0 ls0 ws0">addq<span class="_ _6"> </span><span class="ff6 fs16">instruction</span></div><div class="t m5 x1d h34 y416a ff6 fs16 fc1 sc0 ls0 ws0">on<span class="_ _11"> </span>cycle<span class="_ _16"> </span>5.<span class="_ _11"> </span>It<span class="_ _16"> </span>again<span class="_ _11"> </span>detects<span class="_ _11"> </span>hazards<span class="_ _16"> </span>for<span class="_ _11"> </span>both<span class="_ _16"> </span>source<span class="_ _11"> </span>registers,<span class="_ _16"> </span>injects<span class="_ _11"> </span>a<span class="_ _11"> </span>bubble<span class="_ _16"> </span>into<span class="_ _11"> </span>the</div><div class="t m5 x1d h34 y416b ff6 fs16 fc1 sc0 ls0 ws0">execute<span class="_ _14"> </span>stage,<span class="_ _14"> </span>and<span class="_ _14"> </span>repeats<span class="_ _14"> </span>the<span class="_ _14"> </span>decoding<span class="_ _14"> </span>of<span class="_ _14"> </span>the</div><div class="t m5 xfe h3a y416c ffd fs19 fc1 sc0 ls0 ws0">addq<span class="_ _14"> </span><span class="ff6 fs16">instruction<span class="_ _14"> </span>on<span class="_ _16"> </span>cycle<span class="_ _14"> </span>6.<span class="_ _14"> </span>Still,<span class="_ _15"> </span>it</span></div><div class="t m5 x1d h34 y416d ff6 fs16 fc1 sc0 ls0 ws0">detects<span class="_ _11"> </span>a<span class="_ _11"> </span>hazard<span class="_ _16"> </span>for<span class="_ _11"> </span>source<span class="_ _11"> </span>register</div><div class="t m5 xd4 h3a y416e ffd fs19 fc1 sc0 ls0 ws0">%rax<span class="ff6 fs16">,<span class="_ _11"> </span>injects<span class="_ _16"> </span>a<span class="_ _11"> </span>bubble<span class="_ _11"> </span>into<span class="_ _16"> </span>the<span class="_ _11"> </span>execute<span class="_ _11"> </span>stage,<span class="_ _16"> </span>and</span></div><div class="t m5 x1d h34 y416f ff6 fs16 fc1 sc0 ls0 ws0">repeats<span class="_ _14"> </span>the<span class="_ _16"> </span>decoding<span class="_ _14"> </span>of<span class="_ _14"> </span>the</div><div class="t m5 xdd h3a y4170 ffd fs19 fc1 sc0 ls0 ws0">addq<span class="_ _14"> </span><span class="ff6 fs16">instruction<span class="_ _16"> </span>on<span class="_ _14"> </span>cycle<span class="_ _14"> </span>7.<span class="_ _14"> </span>In<span class="_ _14"> </span>effect,<span class="_ _14"> </span>the<span class="_ _14"> </span>machine<span class="_ _14"> </span>has</span></div><div class="t m5 x1d h34 y4171 ff6 fs16 fc1 sc0 ls0 ws0">dynamically<span class="_ _14"> </span>inserted<span class="_ _15"> </span>three</div><div class="t m5 x1ed h3a y4172 ffd fs19 fc1 sc0 ls0 ws0">nop<span class="_ _14"> </span><span class="ff6 fs16">instructions,<span class="_ _15"> </span>giving<span class="_ _15"> </span>a<span class="_ _14"> </span>ﬂow<span class="_ _15"> </span>similar<span class="_ _14"> </span>to<span class="_ _15"> </span>that<span class="_ _14"> </span>shown<span class="_ _15"> </span>for</span></div><div class="t m5 x1d h3a y4173 ffd fs19 fc1 sc0 ls0 ws0">prog1<span class="_ _10"> </span><span class="ff6 fs16">(Figure<span class="_ _11"> </span>4.43).</span></div><div class="t m5 x29 h26 y4174 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _11"> </span>holding<span class="_ _16"> </span>back<span class="_ _11"> </span>the<span class="_ _11"> </span><span class="ffd">addq<span class="_ _16"> </span></span>instruction<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _16"> </span>decode<span class="_ _11"> </span>stage,<span class="_ _11"> </span>we<span class="_ _11"> </span>must<span class="_ _16"> </span>also<span class="_ _11"> </span>hold</div><div class="t m5 x1d h26 y4175 ff7 fs19 fc1 sc0 ls0 ws0">back<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">halt<span class="_ _13"> </span></span>instruction<span class="_ _13"> </span>following<span class="_ _13"> </span>it<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>fetch<span class="_ _13"> </span>stage<span class="_ _1"></span>.<span class="_ _13"> </span>W<span class="_ _1"></span>e<span class="_ _13"> </span>can<span class="_ _13"> </span>do<span class="_ _13"> </span>this<span class="_ _13"> </span>by<span class="_ _13"> </span>keeping</div><div class="t m5 x1d h26 y4176 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>program<span class="_ _11"> </span>counter<span class="_"> </span>at<span class="_ _11"> </span>a<span class="_"> </span>ﬁxed<span class="_ _11"> </span>value<span class="_ _0"></span>,<span class="_"> </span>so<span class="_ _11"> </span>that<span class="_"> </span>the<span class="_ _11"> </span><span class="ffd">halt<span class="_ _11"> </span></span>instruction<span class="_"> </span>will<span class="_"> </span>be<span class="_ _11"> </span>fetched</div><div class="t m5 x1d h26 y4177 ff7 fs19 fc1 sc0 ls0 ws0">repeatedly<span class="_"> </span>until<span class="_"> </span>the<span class="_"> </span>stall<span class="_"> </span>has<span class="_"> </span>completed.</div><div class="t m5 x29 h26 y4178 ff7 fs19 fc1 sc0 ls0 ws0">Stalling<span class="_"> </span>involves<span class="_"> </span>holding<span class="_ _11"> </span>back<span class="_"> </span>one<span class="_ _11"> </span>group<span class="_"> </span>of<span class="_ _11"> </span>instructions<span class="_"> </span>in<span class="_ _11"> </span>their<span class="_"> </span>stages<span class="_ _11"> </span>while</div><div class="t m5 x1d h26 y4179 ff7 fs19 fc1 sc0 ls0 ws0">allowing<span class="_ _16"> </span>other<span class="_ _11"> </span>instructions<span class="_ _16"> </span>to<span class="_ _16"> </span>continue<span class="_ _11"> </span>ﬂowing<span class="_ _16"> </span>through<span class="_ _16"> </span>the<span class="_ _16"> </span>pipeline<span class="_ _1"></span>.<span class="_ _16"> </span>What<span class="_ _11"> </span>then</div><div class="t m5 x1d h26 y417a ff7 fs19 fc1 sc0 ls0 ws0">should<span class="_ _6"> </span>we<span class="_ _13"> </span>do<span class="_ _6"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>stages<span class="_ _6"> </span>that<span class="_ _6"> </span>would<span class="_ _13"> </span>normally<span class="_ _6"> </span>be<span class="_ _6"> </span>processing<span class="_ _13"> </span>the<span class="_ _6"> </span><span class="ffd">addq<span class="_ _13"> </span></span>instruction?</div><div class="t m5 x1d h26 y417b ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _16"> </span>handle<span class="_ _11"> </span>these<span class="_ _16"> </span>by<span class="_ _11"> </span>injecting<span class="_ _16"> </span>a<span class="_ _11"> </span><span class="ffa">bubble<span class="_ _16"> </span></span>into<span class="_ _11"> </span>the<span class="_ _16"> </span>execute<span class="_ _11"> </span>stage<span class="_ _16"> </span>each<span class="_ _11"> </span>time<span class="_ _16"> </span>we<span class="_ _11"> </span>hold</div><div class="t m5 x1d h26 y417c ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_"> </span>instruction<span class="_ _13"> </span>back<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>decode<span class="_ _13"> </span>stage.<span class="_ _13"> </span>A<span class="_"> </span>bubble<span class="_"> </span>is<span class="_ _13"> </span>like<span class="_"> </span>a<span class="_"> </span>dynamically<span class="_"> </span>generated</div><div class="t m5 x1d h26 y417d ffd fs19 fc1 sc0 ls0 ws0">nop<span class="_ _11"> </span><span class="ff7">instruction—it<span class="_ _11"> </span>does<span class="_ _11"> </span>not<span class="_ _16"> </span>cause<span class="_ _11"> </span>any<span class="_ _11"> </span>changes<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>registers<span class="_ _3"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>memory<span class="_ _3"></span>,<span class="_ _11"> </span>the</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
