<div id="pf148" class="pf w2 h11" data-page-no="148"><div class="pc pc148 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg148.png"/><div class="t m5 xf8 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.10<span class="_ _60"> </span>Combining<span class="_ _10"> </span>Control<span class="_ _10"> </span>and<span class="_ _10"> </span>Data<span class="_ _10"> </span>in<span class="_ _10"> </span>Machine-Level<span class="_ _10"> </span>Programs<span class="_ _3e"> </span><span class="ffe fs1e">327</span></div><div class="t m5 x17 h34 ye7 ff6 fs16 fc2 sc0 ls0 ws0">(a)<span class="_ _10"> </span>C<span class="_ _11"> </span>code</div><div class="t m5 x17 h2d y2283 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>vframe(long<span class="_ _1f"> </span>n,<span class="_ _1f"> </span>long<span class="_ _e"> </span>idx,<span class="_ _1f"> </span>long<span class="_ _e"> </span>*q)<span class="_ _1a"> </span>{</div><div class="t m5 x1b6 h2d y2284 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>i;</div><div class="t m5 x1b6 h2d y2285 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>*p[n];</div><div class="t m5 x1b6 h2d y2286 ffd fs1e fc2 sc0 ls0 ws0">p[0]<span class="_ _e"> </span>=<span class="_ _1f"> </span>&amp;i;</div><div class="t m5 x1b6 h2d y2287 ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=1<span class="_ _41"></span>;i&lt;n<span class="_ _41"></span>;<span class="ls0">i++)</span></div><div class="t m5 x21e h2d y2288 ffd fs1e fc2 sc0 ls0 ws0">p[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>q;</div><div class="t m5 x1b6 h2d y23a1 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>*p[idx];</div><div class="t m5 x17 h2d y23a2 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h34 y23a3 ff6 fs16 fc2 sc0 ls0 ws0">(b)<span class="_ _10"> </span>Portions<span class="_ _11"> </span>of<span class="_ _10"> </span>generated<span class="_ _10"> </span>assembly<span class="_ _11"> </span>code</div><div class="t m5 x2e h61 y1819 ff13 fs35 fc6 sc0 ls0 ws0">long<span class="_ _f"> </span>vframe(long<span class="_ _f"> </span>n,<span class="_ _f"> </span>long<span class="_ _e"> </span>idx,<span class="_ _21"> </span>long<span class="_ _f"> </span>*q)</div><div class="t m5 x2e h61 y23a4 ff13 fs35 fc6 sc0 ls0 ws0">n<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>idx<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi,<span class="_ _f"> </span>q<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx</div><div class="t m5 x2e h61 y2ec7 ff13 fs35 fc6 sc0 ls0 ws0">Only<span class="_ _f"> </span>portions<span class="_ _f"> </span>of<span class="_ _f"> </span>code<span class="_ _e"> </span>shown</div><div class="t m5 x2c h2d y228d ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">vframe:</span></div><div class="t m5 x2c h2e y23a5 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 xd1 h2d y13a3 ffd fs1e fc2 sc0 ls0 ws0">pushq<span class="_ _3f"> </span>%rbp<span class="_ _17f"> </span><span class="ff13 fs35 fc6">Save<span class="_ _f"> </span>old<span class="_ _f"> </span>%rbp</span></div><div class="t m5 x2c h2d y23a6 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rsp,<span class="_ _e"> </span>%rbp<span class="_ _d5"> </span></span><span class="ff13 fs35">Set<span class="_ _f"> </span>frame<span class="_ _e"> </span>pointer</span></div><div class="t m5 x2c h2d y23a7 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">subq<span class="_ _46"> </span>$16,<span class="_ _e"> </span>%rsp<span class="_ _171"> </span></span><span class="ff13 fs35">Allocate<span class="_ _f"> </span>space<span class="_ _f"> </span>for<span class="_ _f"> </span>i<span class="_ _e"> </span>(%rsp<span class="_ _21"> </span>=<span class="_ _f"> </span><span class="ff11">s</span></span></div><div class="t m5 x164 h80 y2ec8 ff7 fs46 fc6 sc0 ls0 ws0">1</div><div class="t m5 x1f1 h61 y23a7 ff13 fs35 fc6 sc0 ls0 ws0">)</div><div class="t m5 x2c h2d y23a8 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">leaq<span class="_ _46"> </span>22(,%rdi,8),<span class="_ _e"> </span>%rax</span></div><div class="t m5 x2c h2d y23a9 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">andq<span class="_ _46"> </span>$-16,<span class="_ _e"> </span>%rax</span></div><div class="t m5 x2c h2d y29fd ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _45"> </span><span class="ffd fs1e fc2">subq<span class="_ _46"> </span>%rax,<span class="_ _e"> </span>%rsp<span class="_ _d5"> </span></span><span class="ff13 fs35">Allocate<span class="_ _f"> </span>space<span class="_ _e"> </span>for<span class="_ _21"> </span>array<span class="_ _f"> </span>p<span class="_ _e"> </span>(%rsp<span class="_ _21"> </span>=<span class="_ _f"> </span><span class="ff11">s</span></span></div><div class="t m5 x12a h80 y2ec9 ff7 fs46 fc6 sc0 ls0 ws0">2</div><div class="t m5 x217 h61 y29fd ff13 fs35 fc6 sc0 ls0 ws0">)</div><div class="t m5 x2c h2d y29fe ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">leaq<span class="_ _46"> </span>7(%rsp),<span class="_ _e"> </span>%rax</span></div><div class="t m5 x2c h2d y2a05 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _45"> </span><span class="ffd fs1e fc2">shrq<span class="_ _46"> </span>$3,<span class="_ _e"> </span>%rax</span></div><div class="t m5 x17 h2d y2a00 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _45"> </span><span class="ffd fs1e fc2">leaq<span class="_ _46"> </span>0(,%rax,8),<span class="_ _e"> </span>%r8<span class="_ _12e"> </span></span><span class="ff13 fs35">Set<span class="_ _e"> </span>%r8<span class="_ _21"> </span>to<span class="_ _f"> </span>&amp;p[0]</span></div><div class="t m5 x17 h2d y2a01 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%r8,<span class="_ _e"> </span>%rcx<span class="_ _171"> </span></span><span class="ff13 fs35">Set<span class="_ _f"> </span>%rcx<span class="_ _f"> </span>to<span class="_ _f"> </span>&amp;p[0]<span class="_ _e"> </span>(%rcx<span class="_ _21"> </span>=<span class="_ _f"> </span><span class="ff11">p<span class="_ _2"></span></span>)</span></div><div class="t m5 x160 h61 y2eca ff13 fs35 fc6 sc0 ls156 ws0">...</div><div class="t m5 x2e h61 y2ecb ff13 fs35 fc6 sc0 ls0 ws0">Code<span class="_ _f"> </span>for<span class="_ _f"> </span>initialization<span class="_ _f"> </span>loop</div><div class="t m5 x2e h61 y2ecc ff13 fs35 fc6 sc0 ls0 ws0">i<span class="_ _f"> </span>in<span class="_ _f"> </span>%rax<span class="_ _f"> </span>and<span class="_ _e"> </span>on<span class="_ _21"> </span>stack,<span class="_ _f"> </span>n<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdi,<span class="_ _f"> </span>p<span class="_ _e"> </span>in<span class="_ _21"> </span>%rcx,<span class="_ _f"> </span>q<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx</div><div class="t m5 x17 h2d y2a07 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">.L3:<span class="_ _170"> </span></span><span class="ff2d fs35">loop:</span></div><div class="t m5 x17 h2d y28fa ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rdx,<span class="_ _e"> </span>(%rcx,%rax,8)<span class="_ _d0"> </span></span><span class="ff13 fs35">Set<span class="_ _21"> </span>p[i]<span class="_ _e"> </span>to<span class="_ _21"> </span>q</span></div><div class="t m5 x17 h2d y28fc ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$1,<span class="_ _e"> </span>%rax<span class="_ _17e"> </span></span><span class="ff13 fs35">Increment<span class="_ _f"> </span>i</span></div><div class="t m5 x17 h2e y2a08 ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 xd1 h2d y28fd ffd fs1e fc2 sc0 ls0 ws0">movq<span class="_ _46"> </span>%rax,<span class="_ _e"> </span>-8(%rbp)<span class="_ _10e"> </span><span class="ff13 fs35 fc6">Store<span class="_ _f"> </span>on<span class="_ _e"> </span>stack</span></div><div class="t m5 x17 h2d y2a09 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _1c"> </span><span class="ffd fs1e fc2">.L2:</span></div><div class="t m5 x17 h2d y28ff ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>-8(%rbp),<span class="_ _e"> </span>%rax<span class="_ _10e"> </span></span><span class="ff13 fs35">Retrieve<span class="_ _f"> </span>i<span class="_ _e"> </span>from<span class="_ _21"> </span>stack</span></div><div class="t m5 x17 h2d y2a0a ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _45"> </span><span class="ffd fs1e fc2">cmpq<span class="_ _46"> </span>%rdi,<span class="_ _e"> </span>%rax<span class="_ _d5"> </span></span><span class="ff13 fs35">Compare<span class="_ _f"> </span>i:n</span></div><div class="t m5 x17 h2d y2a0b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _45"> </span><span class="ffd fs1e fc2">jl<span class="_ _5a"> </span>.L3<span class="_ _d2"> </span></span><span class="ff13 fs35">If<span class="_ _f"> </span>&lt;,<span class="_ _f"> </span>goto<span class="_ _f"> </span><span class="ff2d">loop</span></span></div><div class="t m5 x160 h61 y2ecd ff13 fs35 fc6 sc0 ls156 ws0">...</div><div class="t m5 x2e h61 y2ece ff13 fs35 fc6 sc0 ls0 ws0">Code<span class="_ _f"> </span>for<span class="_ _f"> </span>function<span class="_ _f"> </span>exit</div><div class="t m5 x17 h2e y2a0e ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 xd1 h2d y2a0f ffd fs1e fc2 sc0 ls0 ws0">leave<span class="_ _180"> </span><span class="ff13 fs35 fc6">Restore<span class="_ _f"> </span>%rbp<span class="_ _f"> </span>and<span class="_ _f"> </span>%rsp</span></div><div class="t m5 x17 h2d y2ecf ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _45"> </span><span class="ffd fs1e fc2">ret<span class="_ _181"> </span></span><span class="ff13 fs35">Return</span></div><div class="t m5 x17 h34 y2ed0 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>3.43<span class="_ _c"> </span><span class="fc1">Function<span class="_"> </span>requiring<span class="_"> </span>the<span class="_"> </span>use<span class="_ _11"> </span>of<span class="_"> </span>a<span class="_"> </span>frame<span class="_ _11"> </span>pointer<span class="_ _1"></span>.<span class="_"> </span><span class="ff6">The<span class="_ _11"> </span>variable-size<span class="_ _10"> </span>array<span class="_ _11"> </span>implies<span class="_ _10"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>size<span class="_ _10"> </span>of</span></span></div><div class="t m5 x17 h34 y2ed1 ff6 fs16 fc1 sc0 ls0 ws0">the<span class="_ _10"> </span>stack<span class="_ _11"> </span>frame<span class="_ _10"> </span>cannot<span class="_ _10"> </span>be<span class="_ _11"> </span>determined<span class="_ _10"> </span>at<span class="_ _11"> </span>compile<span class="_ _10"> </span>time.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
