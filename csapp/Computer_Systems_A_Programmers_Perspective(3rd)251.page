<div id="pffb" class="pf w2 h11" data-page-no="fb"><div class="pc pcfb w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bgfb.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">250<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1d h41 ye7 ffe fs29 fc2 sc0 ls0 ws0">3.6.6<span class="_ _48"> </span><span class="fs19">Implementing<span class="_"> </span>Conditional<span class="_"> </span>Branches<span class="_"> </span>with<span class="_"> </span>Conditional<span class="_"> </span>Moves</span></div><div class="t m5 x1d h26 ybbe ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>conventional<span class="_ _14"> </span>way<span class="_ _14"> </span>to<span class="_ _16"> </span>implement<span class="_ _14"> </span>conditional<span class="_ _14"> </span>operations<span class="_ _14"> </span>is<span class="_ _14"> </span>through<span class="_ _16"> </span>a<span class="_ _14"> </span>condi-</div><div class="t m5 x1d h26 ybbf ff7 fs19 fc2 sc0 ls0 ws0">tional<span class="_ _16"> </span>transfer<span class="_ _14"> </span>of<span class="_ _16"> </span><span class="ffa">control<span class="_ _2"></span></span>,<span class="_ _15"> </span>where<span class="_ _16"> </span>the<span class="_ _14"> </span>program<span class="_ _16"> </span>follows<span class="_ _14"> </span>one<span class="_ _16"> </span>execution<span class="_ _14"> </span>path<span class="_ _16"> </span>when</div><div class="t m5 x1d h26 ybc0 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _16"> </span>condition<span class="_ _14"> </span>holds<span class="_ _14"> </span>and<span class="_ _16"> </span>another<span class="_ _14"> </span>when<span class="_ _14"> </span>it<span class="_ _16"> </span>does<span class="_ _14"> </span>not.<span class="_ _14"> </span>T<span class="_ _1"></span>his<span class="_ _14"> </span>mechanism<span class="_ _14"> </span>is<span class="_ _16"> </span>simple<span class="_ _14"> </span>and</div><div class="t m5 x1d h26 ybc1 ff7 fs19 fc2 sc0 ls0 ws0">general,<span class="_"> </span>but<span class="_"> </span>it<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>very<span class="_"> </span>inefÔ¨Åcient<span class="_"> </span>on<span class="_"> </span>modern<span class="_"> </span>processors<span class="_ _1"></span>.</div><div class="t m5 x29 h26 ybc2 ff7 fs19 fc2 sc0 ls0 ws0">An<span class="_"> </span>alternate<span class="_ _13"> </span>strategy<span class="_"> </span>is<span class="_ _13"> </span>through<span class="_"> </span>a<span class="_ _13"> </span>conditional<span class="_"> </span>transfer<span class="_ _13"> </span>of<span class="_"> </span><span class="ffa">data</span>.<span class="_ _13"> </span>This<span class="_ _13"> </span>approach</div><div class="t m5 x1d h26 y119b ff7 fs19 fc2 sc0 ls0 ws0">computes<span class="_ _13"> </span>both<span class="_ _13"> </span>outcomes<span class="_ _13"> </span>of<span class="_ _13"> </span>a<span class="_ _6"> </span>conditional<span class="_ _13"> </span>operation<span class="_ _13"> </span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>selects<span class="_ _13"> </span>one<span class="_ _13"> </span>based<span class="_ _13"> </span>on</div><div class="t m5 x1d h26 y119c ff7 fs19 fc2 sc0 ls0 ws0">whether<span class="_ _11"> </span>or<span class="_ _16"> </span>not<span class="_ _16"> </span>the<span class="_ _11"> </span>condition<span class="_ _16"> </span>holds<span class="_ _3"></span>.<span class="_ _16"> </span>T<span class="_ _0"></span>his<span class="_ _11"> </span>strategy<span class="_ _16"> </span>makes<span class="_ _11"> </span>sense<span class="_ _16"> </span>only<span class="_ _16"> </span>in<span class="_ _11"> </span>restricted</div><div class="t m5 x1d h26 y216 ff7 fs19 fc2 sc0 ls0 ws0">cases<span class="_ _1"></span>,<span class="_ _14"> </span>but<span class="_ _16"> </span>it<span class="_ _16"> </span>can<span class="_ _16"> </span>then<span class="_ _14"> </span>be<span class="_ _16"> </span>implemented<span class="_ _16"> </span>by<span class="_ _16"> </span>a<span class="_ _14"> </span>simple<span class="_ _16"> </span><span class="ffa">conditional<span class="_ _16"> </span>move<span class="_ _16"> </span></span>instruction</div><div class="t m5 x1d h26 y2364 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _16"> </span>is<span class="_ _11"> </span>better<span class="_ _16"> </span>matched<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span>performance<span class="_ _16"> </span>characteristics<span class="_ _16"> </span>of<span class="_ _16"> </span>modern<span class="_ _11"> </span>processors<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y2365 ff7 fs19 fc2 sc0 ls0 ws0">Here<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>examine<span class="_"> </span>this<span class="_"> </span>strategy<span class="_"> </span>and<span class="_"> </span>its<span class="_"> </span>implementation<span class="_"> </span>with<span class="_"> </span>x86-64.</div><div class="t m5 x29 h26 y320 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>3.17(a)<span class="_"> </span>shows<span class="_"> </span>an<span class="_"> </span>example<span class="_ _13"> </span>of<span class="_"> </span>code<span class="_"> </span>that<span class="_"> </span>can<span class="_ _13"> </span>be<span class="_"> </span>compiled<span class="_"> </span>using<span class="_"> </span>a<span class="_"> </span>condi-</div><div class="t m5 x1d h26 y321 ff7 fs19 fc2 sc0 ls0 ws0">tional<span class="_"> </span>move.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>function<span class="_ _11"> </span>computes<span class="_"> </span>the<span class="_ _11"> </span>absolute<span class="_ _11"> </span>value<span class="_"> </span>of<span class="_ _11"> </span>its<span class="_ _11"> </span>arguments<span class="_"> </span><span class="ffd">x<span class="_ _11"> </span></span>and<span class="_ _11"> </span><span class="ffd">y</span>,</div><div class="t m5 x1d h26 y301 ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_ _13"> </span>did<span class="_ _13"> </span>our<span class="_"> </span>earlier<span class="_ _13"> </span>example<span class="_ _13"> </span>(F<span class="_ _1"></span>igure<span class="_"> </span>3.16).<span class="_ _13"> </span>W<span class="_ _0"></span>hereas<span class="_ _13"> </span>the<span class="_ _13"> </span>earlier<span class="_"> </span>example<span class="_ _13"> </span>had<span class="_ _13"> </span>side<span class="_ _13"> </span>ef-</div><div class="t m5 x1d h26 y302 ff7 fs19 fc2 sc0 ls0 ws0">fects<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>branches<span class="_ _0"></span>,<span class="_ _13"> </span>modifying<span class="_ _13"> </span>the<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_ _13"> </span>either<span class="_ _13"> </span><span class="ffd">lt_cnt<span class="_ _13"> </span></span>or<span class="_ _13"> </span><span class="ffd">ge_cnt</span>,<span class="_"> </span>this<span class="_ _13"> </span>version</div><div class="t m5 x1d h26 y303 ff7 fs19 fc2 sc0 ls0 ws0">simply<span class="_"> </span>computes<span class="_"> </span>the<span class="_"> </span>value<span class="_"> </span>to<span class="_"> </span>be<span class="_"> </span>returned<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>function.</div><div class="t m5 x14 h34 y25ea ff6 fs16 fc2 sc0 ls0 ws0">(a)<span class="_ _10"> </span>Original<span class="_ _11"> </span>C<span class="_ _10"> </span>code</div><div class="t m5 x14 h2d y25eb ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>absdiff(long<span class="_ _1f"> </span>x,<span class="_ _1f"> </span>long<span class="_ _e"> </span>y)</div><div class="t m5 x14 h2d y25ec ffd fs1e fc2 sc0 ls0 ws0">{</div><div class="t m5 xc8 h2d y25ed ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>result;</div><div class="t m5 xc8 h2d y25ee ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(x<span class="_ _1f"> </span>&lt;<span class="_ _1f"> </span>y)</div><div class="t m5 x63 h2d y25ef ffd fs1e fc2 sc0 ls0 ws0">resul<span class="ls33">t=y-x<span class="_ _41"></span>;</span></div><div class="t m5 xc8 h2d y25f0 ffd fs1e fc2 sc0 ls0 ws0">else</div><div class="t m5 x63 h2d y25f1 ffd fs1e fc2 sc0 ls0 ws0">resul<span class="ls33">t=x-y<span class="_ _41"></span>;</span></div><div class="t m5 xc8 h2d y25f2 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>result;</div><div class="t m5 x14 h2d y25f3 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 xba h34 y25f4 ff6 fs16 fc2 sc0 ls0 ws0">(b)<span class="_ _10"> </span>Implementation<span class="_ _11"> </span>using<span class="_ _10"> </span>conditional<span class="_ _10"> </span>assignment</div><div class="t m5 x16d h2d y25f5 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">long<span class="_ _1f"> </span>cmovdiff(long<span class="_ _e"> </span>x,<span class="_ _1f"> </span>long<span class="_ _1f"> </span>y)</span></div><div class="t m5 x16d h2d y25f6 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x16d h2e y25f7 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x122 h2d y25f8 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>rval<span class="_ _1f"> </span>=<span class="_ _1f"> </span>y-x;</div><div class="t m5 x16d h2d y25f9 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>eval<span class="_ _1f"> </span>=<span class="_ _1f"> </span>x-y;</span></div><div class="t m5 x16d h2d y25fa ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>ntes<span class="ls33">t=x&gt;<span class="_ _41"></span>=y<span class="_ _41"></span>;</span></span></div><div class="t m5 x16d h2d y25fb ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Line<span class="_ _1f"> </span>below<span class="_ _1f"> </span>requires</span></div><div class="t m5 x16d h2d y25fc ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _65"> </span><span class="ffd fs1e fc2">single<span class="_ _e"> </span>instruction:<span class="_ _1f"> </span>*/</span></div><div class="t m5 x16d h2d y25fd ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(ntest)<span class="_ _1f"> </span>rval<span class="_ _1f"> </span>=<span class="_ _e"> </span>eval;</span></div><div class="t m5 x16d h2d y25fe ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>rval;</span></div><div class="t m5 xba h2d y25ff ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h34 y2600 ff6 fs16 fc2 sc0 ls0 ws0">(c)<span class="_ _10"> </span>Generated<span class="_ _11"> </span>assembly<span class="_ _10"> </span>code</div><div class="t m5 x244 h61 y2601 ff13 fs35 fc6 sc0 ls0 ws0">long<span class="_ _f"> </span>absdiff(long<span class="_ _f"> </span>x,<span class="_ _f"> </span>long<span class="_ _e"> </span>y)</div><div class="t m5 x244 h61 y2602 ff13 fs35 fc6 sc0 ls0 ws0">x<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>y<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi</div><div class="t m5 xb h2e y2603 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x244 h2d y2604 ffd fs1e fc2 sc0 ls0 ws0">absdiff:</div><div class="t m5 xb h2d y2605 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rsi,<span class="_ _e"> </span>%rax</span></div><div class="t m5 xb h2d y2606 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">subq<span class="_ _46"> </span>%rdi,<span class="_ _e"> </span>%rax<span class="_ _88"> </span></span><span class="ff13 fs35">rval<span class="_ _21"> </span>=<span class="_ _e"> </span>y-x</span></div><div class="t m5 xb h2d y2607 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rdi,<span class="_ _e"> </span>%rdx</span></div><div class="t m5 xb h2d y2608 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">subq<span class="_ _46"> </span>%rsi,<span class="_ _e"> </span>%rdx<span class="_ _88"> </span></span><span class="ff13 fs35">eval<span class="_ _21"> </span>=<span class="_ _e"> </span>x-y</span></div><div class="t m5 xb h2d y2609 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">cmpq<span class="_ _46"> </span>%rsi,<span class="_ _e"> </span>%rdi<span class="_ _88"> </span></span><span class="ff13 fs35">Compare<span class="_ _21"> </span>x:y</span></div><div class="t m5 xb h2d y1025 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _45"> </span><span class="ffd fs1e fc2">cmovge<span class="_ _1a"> </span>%rdx,<span class="_ _e"> </span>%rax<span class="_ _88"> </span></span><span class="ff13 fs35">If<span class="_ _21"> </span>&gt;=,<span class="_ _e"> </span>rval<span class="_ _21"> </span>=<span class="_ _f"> </span>eval</span></div><div class="t m5 xb h2d y260a ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">ret<span class="_ _142"> </span></span><span class="ff13 fs35">Return<span class="_ _f"> </span>tval</span></div><div class="t m5 x14 h34 y260b ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _21"> </span>3.17<span class="_ _c"> </span><span class="fc1">Compilation<span class="_ _15"> </span>of<span class="_ _f"> </span>conditional<span class="_ _21"> </span>statements<span class="_ _21"> </span>using<span class="_ _21"> </span>conditional<span class="_ _21"> </span>assignment.<span class="_ _21"> </span><span class="ff6">(a)<span class="_ _21"> </span>C<span class="_ _21"> </span>function</span></span></div><div class="t m5 x14 h3a y260c ffd fs19 fc1 sc0 ls0 ws0">absdiff<span class="_ _16"> </span><span class="ff6 fs16">contains<span class="_ _14"> </span>a<span class="_ _16"> </span>conditional<span class="_ _14"> </span>expression.<span class="_ _16"> </span>The<span class="_ _14"> </span>generated<span class="_ _16"> </span>assembly<span class="_ _14"> </span>code<span class="_ _14"> </span>is<span class="_ _16"> </span>shown<span class="_ _14"> </span>(c),<span class="_ _14"> </span>along<span class="_ _16"> </span>with<span class="_ _14"> </span>(b)<span class="_ _16"> </span>a</span></div><div class="t m5 x14 h34 y260d ff6 fs16 fc1 sc0 ls0 ws0">C<span class="_ _10"> </span>function</div><div class="t m5 x1a4 h3a y18e2 ffd fs19 fc1 sc0 ls0 ws0">cmovdiff<span class="_ _10"> </span><span class="ff6 fs16">that<span class="_ _11"> </span>mimics<span class="_ _10"> </span>the<span class="_ _10"> </span>operation<span class="_ _11"> </span>of<span class="_ _10"> </span>the<span class="_ _11"> </span>assembly<span class="_ _10"> </span>code.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
