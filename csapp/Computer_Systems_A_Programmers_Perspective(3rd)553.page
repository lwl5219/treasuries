<div id="pf229" class="pf w2 h11" data-page-no="229"><div class="pc pc229 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg229.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">552<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _f"> </span>shown<span class="_ _e"> </span>previously<span class="_ _7"></span>,<span class="_ _1f"> </span><span class="ffd">combine3<span class="_ _f"> </span></span>accumulates<span class="_ _e"> </span>its<span class="_ _f"> </span>result<span class="_ _f"> </span>at<span class="_ _e"> </span>the<span class="_ _f"> </span>destination,</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_ _16"> </span>in<span class="_ _14"> </span>this<span class="_ _16"> </span>case<span class="_ _16"> </span>is<span class="_ _14"> </span>the<span class="_ _16"> </span>ﬁnal<span class="_ _14"> </span>vector<span class="_ _16"> </span>element.<span class="_ _14"> </span>T<span class="_ _1"></span>his<span class="_ _14"> </span>value<span class="_ _16"> </span>is<span class="_ _16"> </span>therefore<span class="_ _14"> </span>set<span class="_ _16"> </span>ﬁrst<span class="_ _14"> </span>to</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">1,<span class="_ _16"> </span>then<span class="_ _16"> </span>to<span class="_ _16"> </span>2</div><div class="t m5 x141 h45 y4b8b ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x112 h46 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">1<span class="_ _13"> </span><span class="ff12">=<span class="_ _13"></span></span>2,<span class="_ _16"> </span>and<span class="_ _16"> </span>then<span class="_ _16"> </span>to<span class="_ _16"> </span>3</div><div class="t m5 xfc h45 y4b8b ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x20c h46 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">2<span class="_"> </span><span class="ff12">=<span class="_ _13"></span></span><span class="ls77">6.<span class="_ _16"> </span>On<span class="_ _16"> </span>the<span class="_ _11"> </span>last<span class="_ _16"> </span>iteration,<span class="_ _16"> </span>this<span class="_ _16"> </span>value<span class="_ _16"> </span>is<span class="_ _16"> </span>then</span></div><div class="t m5 x1b0 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">multiplied<span class="_ _13"> </span>by<span class="_ _13"> </span>itself<span class="_ _13"> </span>to<span class="_ _13"> </span>yield<span class="_ _13"> </span>a<span class="_ _13"> </span>ﬁnal<span class="_ _6"> </span>value<span class="_ _13"> </span>of<span class="_ _13"> </span>36.<span class="_ _13"> </span>F<span class="_ _1"></span>or<span class="_ _13"> </span>the<span class="_ _13"> </span>case<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ffd">combine4</span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>vector</div><div class="t m5 x1b0 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">remains<span class="_ _11"> </span>unchanged<span class="_ _16"> </span>until<span class="_ _11"> </span>the<span class="_ _11"> </span>end,<span class="_ _16"> </span>when<span class="_ _11"> </span>the<span class="_ _11"> </span>ﬁnal<span class="_ _16"> </span>element<span class="_ _11"> </span>is<span class="_ _11"> </span>set<span class="_ _16"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span>computed</div><div class="t m5 x1b0 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">result<span class="_"> </span>1</div><div class="t m5 x10d h45 y4b8c ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x214 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">2</div><div class="t m5 x1cc h45 y4b8c ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 xcc h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">3</div><div class="t m5 x112 h45 y4b8c ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x1d0 h46 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">5<span class="_ _13"> </span><span class="ff12">=<span class="_ _13"> </span></span><span class="ls24">30.</span></div><div class="t m5 x29 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">Of<span class="_ _1f"> </span>course<span class="_ _1"></span>,<span class="_ _23"> </span>our<span class="_ _1f"> </span>example<span class="_ _1f"> </span>showing<span class="_ _e"> </span>the<span class="_ _1f"> </span>distinction<span class="_ _1f"> </span>between<span class="_ _1f"> </span><span class="ffd">combine3<span class="_ _1f"> </span></span>and</div><div class="t m5 x1b0 h26 y2fb ffd fs19 fc2 sc0 ls0 ws0">combine4<span class="_ _15"> </span><span class="ff7">is<span class="_ _15"> </span>highly<span class="_ _15"> </span>contrived.<span class="_ _15"> </span>One<span class="_ _15"> </span>could<span class="_ _15"> </span>argue<span class="_ _15"> </span>that<span class="_ _15"> </span>the<span class="_ _15"> </span>behavior<span class="_ _21"> </span>of<span class="_ _15"> </span></span>combine4</div><div class="t m5 x1b0 h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">more<span class="_ _11"> </span>closely<span class="_ _11"> </span>matches<span class="_ _11"> </span>the<span class="_ _11"> </span>intention<span class="_ _16"> </span>of<span class="_"> </span>the<span class="_ _16"> </span>function<span class="_"> </span>description.<span class="_ _16"> </span>Unfortunately<span class="_ _7"></span>,<span class="_ _16"> </span>a</div><div class="t m5 x1b0 h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">compiler<span class="_ _16"> </span>cannot<span class="_ _16"> </span>make<span class="_ _11"> </span>a<span class="_ _16"> </span>judgment<span class="_ _16"> </span>about<span class="_ _16"> </span>the<span class="_ _16"> </span>conditions<span class="_ _16"> </span>under<span class="_ _11"> </span>which<span class="_ _16"> </span>a<span class="_ _16"> </span>function</div><div class="t m5 x1b0 h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">might<span class="_ _15"> </span>be<span class="_ _14"> </span>used<span class="_ _15"> </span>and<span class="_ _15"> </span>what<span class="_ _15"> </span>the<span class="_ _15"> </span>programmer’s<span class="_ _14"> </span>intentions<span class="_ _15"> </span>might<span class="_ _15"> </span>be.<span class="_ _14"> </span>Instead,<span class="_ _21"> </span>when</div><div class="t m5 x1b0 h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">given<span class="_ _15"> </span><span class="ffd">combine3<span class="_ _15"> </span></span>to<span class="_ _21"> </span>compile<span class="_ _0"></span>,<span class="_ _21"> </span>the<span class="_ _21"> </span>conservative<span class="_ _15"> </span>approach<span class="_ _15"> </span>is<span class="_ _21"> </span>to<span class="_ _15"> </span>keep<span class="_ _21"> </span>reading<span class="_ _15"> </span>and</div><div class="t m5 x1b0 h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">writing<span class="_"> </span>memory<span class="_ _3"></span>,<span class="_"> </span>even<span class="_"> </span>though<span class="_"> </span>this<span class="_"> </span>is<span class="_"> </span>less<span class="_"> </span>efﬁcient.</div><div class="t m5 x1d h47 y4b8d ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>5.4<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>610)</span></div><div class="t m5 x1d h26 y4b8e ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _16"> </span>we<span class="_ _14"> </span>use<span class="_ _14"> </span><span class="ff9">gcc<span class="_ _14"> </span></span>to<span class="_ _14"> </span>compile<span class="_ _16"> </span><span class="ffd">combine3<span class="_ _14"> </span></span>with<span class="_ _14"> </span>command-line<span class="_ _14"> </span>option<span class="_ _14"> </span><span class="ffd">-O2</span>,<span class="_ _15"> </span>we<span class="_ _14"> </span>get</div><div class="t m5 x1d h26 y4b8f ff7 fs19 fc1 sc0 ls0 ws0">code<span class="_"> </span>with<span class="_"> </span>substantially<span class="_"> </span>better<span class="_"> </span>CPE<span class="_"> </span>performance<span class="_"> </span>than<span class="_"> </span>with<span class="_"> </span><span class="ffd">-O1</span>:</div><div class="t m5 x18a h31 y4b90 ff7 fs21 fc2 sc0 ls0 ws0">Integer<span class="_ _ba"> </span>Floating<span class="_"> </span>point</div><div class="t m5 x1d h31 y4b91 ff7 fs21 fc2 sc0 ls0 ws0">Function<span class="_ _76"> </span>Page<span class="_ _26"> </span>Method<span class="_ _14f"> </span><span class="ffd fs1e ls20c">+*+*</span></div><div class="t m5 x1d h31 y4b92 ffd fs1e fc2 sc0 ls0 ws0">combine3<span class="_ _73"> </span><span class="ff7 fs21">549<span class="_ _61"> </span>Compiled<span class="_"> </span></span>-O1<span class="_ _16f"> </span><span class="ff7 fs21">7.17<span class="_ _14a"> </span>9.02<span class="_ _4f"> </span>9.02<span class="_ _46"> </span>11.03</span></div><div class="t m5 x1d h31 y4b93 ffd fs1e fc2 sc0 ls0 ws0">combine3<span class="_ _73"> </span><span class="ff7 fs21">549<span class="_ _61"> </span>Compiled<span class="_"> </span></span>-O2</div><div class="t m5 x12f h31 y4b94 ff7 fs21 fc2 sc0 ls0 ws0">1.60<span class="_ _14a"> </span>3.01<span class="_ _4f"> </span>3.01<span class="_ _14a"> </span>5.01</div><div class="t m5 x1d h31 y4b95 ffd fs1e fc2 sc0 ls0 ws0">combine4<span class="_ _73"> </span><span class="ff7 fs21">551<span class="_ _61"> </span>Accumulate<span class="_"> </span>in<span class="_"> </span>temporary<span class="_ _74"> </span>1.27<span class="_ _14a"> </span>3.01<span class="_ _14a"> </span>3.01<span class="_ _14a"> </span>5.01</span></div><div class="t m5 x29 h26 y4b96 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _13"> </span>achieve<span class="_ _6"> </span>performance<span class="_ _13"> </span>comparable<span class="_ _6"> </span>to<span class="_ _13"> </span>that<span class="_ _6"> </span>for<span class="_ _13"> </span><span class="ffd">combine4</span>,<span class="_ _13"> </span>except<span class="_ _6"> </span>for<span class="_ _13"> </span>the<span class="_ _6"> </span>case</div><div class="t m5 x1d h26 y4b97 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _6"> </span>integer<span class="_ _13"> </span>sum,<span class="_ _13"> </span>but<span class="_ _6"> </span>even<span class="_ _13"> </span>it<span class="_ _6"> </span>improves<span class="_ _13"> </span>signiﬁcantly<span class="_ _7"></span>.<span class="_ _13"> </span>On<span class="_ _6"> </span>examining<span class="_ _13"> </span>the<span class="_ _6"> </span>assembly<span class="_ _13"> </span>code</div><div class="t m5 x1d h26 y4b98 ff7 fs19 fc2 sc0 ls0 ws0">generated<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>compiler,<span class="_"> </span>we<span class="_"> </span>ﬁnd<span class="_"> </span>an<span class="_"> </span>interesting<span class="_"> </span>variant<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>inner<span class="_"> </span>loop:</div><div class="t m5 xad h61 y4b99 ff13 fs35 fc6 sc0 ls0 ws0">Inner<span class="_ _f"> </span>loop<span class="_ _f"> </span>of<span class="_ _f"> </span>combine3.<span class="_ _3d"> </span>data_t<span class="_ _f"> </span>=<span class="_ _e"> </span>double,<span class="_ _21"> </span>OP<span class="_ _f"> </span>=<span class="_ _e"> </span>*.<span class="_ _60"> </span>Compiled<span class="_ _f"> </span>-O2</div><div class="t m5 xad h61 y4b9a ff13 fs35 fc6 sc0 ls0 ws0">dest<span class="_ _f"> </span>in<span class="_ _f"> </span>%rbx,<span class="_ _f"> </span>data+i<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>data+length<span class="_ _e"> </span>in<span class="_ _21"> </span>%rax</div><div class="t m5 xad h61 y4b9b ff13 fs35 fc6 sc0 ls0 ws0">Accumulated<span class="_ _f"> </span>product<span class="_ _f"> </span>in<span class="_ _f"> </span>%xmm0</div><div class="t m5 x1f h2d y4b9c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">.L22:<span class="_ _160"> </span></span><span class="ff2d fs35">loop:</span></div><div class="t m5 x1f h2d y4b9d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">vmulsd<span class="_ _1a"> </span>(%rdx),<span class="_ _e"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0<span class="_ _3a"> </span></span><span class="ff13 fs35">Multiply<span class="_ _f"> </span>product<span class="_ _f"> </span>by<span class="_ _f"> </span>data[i]</span></div><div class="t m5 x1f h2d y4b9e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$8,<span class="_ _e"> </span>%rdx<span class="_ _d5"> </span></span><span class="ff13 fs35">Increment<span class="_ _f"> </span>data+i</span></div><div class="t m5 x1f h2d y4b9f ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">cmpq<span class="_ _46"> </span>%rax,<span class="_ _e"> </span>%rdx<span class="_ _161"> </span></span><span class="ff13 fs35">Compare<span class="_ _f"> </span>to<span class="_ _f"> </span>data+length</span></div><div class="t m5 x1f h2d y4ba0 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovsd<span class="_ _1a"> </span>%xmm0,<span class="_ _e"> </span>(%rbx)<span class="_ _12e"> </span></span><span class="ff13 fs35">Store<span class="_ _e"> </span>product<span class="_ _21"> </span>at<span class="_ _f"> </span>dest</span></div><div class="t m5 x1f h2d y4ba1 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">jne<span class="_ _8c"> </span>.L22<span class="_ _136"> </span></span><span class="ff13 fs35">If<span class="_ _f"> </span>!=,<span class="_ _f"> </span>goto<span class="_ _f"> </span><span class="ff2d">loop</span></span></div><div class="t m5 x1d h26 y4ba2 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_"> </span>can<span class="_"> </span>compare<span class="_"> </span>this<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>version<span class="_"> </span>created<span class="_"> </span>with<span class="_"> </span>optimization<span class="_"> </span>level<span class="_"> </span>1:</div><div class="t m5 xad h61 y107b ff13 fs35 fc6 sc0 ls0 ws0">Inner<span class="_ _f"> </span>loop<span class="_ _f"> </span>of<span class="_ _f"> </span>combine3.<span class="_ _3d"> </span>data_t<span class="_ _f"> </span>=<span class="_ _e"> </span>double,<span class="_ _21"> </span>OP<span class="_ _f"> </span>=<span class="_ _e"> </span>*.<span class="_ _60"> </span>Compiled<span class="_ _f"> </span>-O1</div><div class="t m5 xad h61 y28b1 ff13 fs35 fc6 sc0 ls0 ws0">dest<span class="_ _f"> </span>in<span class="_ _f"> </span>%rbx,<span class="_ _f"> </span>data+i<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>data+length<span class="_ _e"> </span>in<span class="_ _21"> </span>%rax</div><div class="t m5 x1f h2e y587 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x4f h2d y832 ffd fs1e fc2 sc0 ls0 ws0">.L17:<span class="_ _160"> </span><span class="ff2d fs35 fc6">loop:</span></div><div class="t m5 x1f h2d y8d6 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovsd<span class="_ _1a"> </span>(%rbx),<span class="_ _e"> </span>%xmm0<span class="_ _12e"> </span></span><span class="ff13 fs35">Read<span class="_ _e"> </span>product<span class="_ _21"> </span>from<span class="_ _f"> </span>dest</span></div><div class="t m5 x1f h2d y77e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">vmulsd<span class="_ _1a"> </span>(%rdx),<span class="_ _e"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0<span class="_ _3a"> </span></span><span class="ff13 fs35">Multiply<span class="_ _f"> </span>product<span class="_ _f"> </span>by<span class="_ _f"> </span>data[i]</span></div><div class="t m5 x1f h2d ye95 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovsd<span class="_ _1a"> </span>%xmm0,<span class="_ _e"> </span>(%rbx)<span class="_ _12e"> </span></span><span class="ff13 fs35">Store<span class="_ _e"> </span>product<span class="_ _21"> </span>at<span class="_ _f"> </span>dest</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
