<div id="pf419" class="pf w2 h11" data-page-no="419"><div class="pc pc419 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg419.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1048<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1e0 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/echo-cnt.c</div><div class="t m5 x1f h2e y280 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x4f h2d yad1 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</div><div class="t m5 x1f h2e y281 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x1f h2e y282 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x4f h2d yad2 ffd fs1e fc2 sc0 ls0 ws0">static<span class="_ _e"> </span>int<span class="_ _1f"> </span>byte_cnt;<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Byte<span class="_ _e"> </span>counter<span class="_ _1f"> </span>*/</div><div class="t m5 x1f h2d yad3 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">static<span class="_ _1f"> </span>sem_t<span class="_ _e"> </span>mutex;<span class="_ _3f"> </span>/*<span class="_ _1f"> </span>and<span class="_ _1f"> </span>the<span class="_ _e"> </span>mutex<span class="_ _1f"> </span>that<span class="_ _e"> </span>protects<span class="_ _1f"> </span>it<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1f h2e y285 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x1f h2e y65f1 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x4f h2d yad4 ffd fs1e fc2 sc0 ls0 ws0">static<span class="_ _e"> </span>void<span class="_ _1f"> </span>init_echo_cnt(void)</div><div class="t m5 x1f h2d yad5 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d yad6 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">Sem_init(&amp;mutex,<span class="_ _e"> </span>0,<span class="_ _1f"> </span>1);</span></div><div class="t m5 x1f h2d y496b ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">byte_cnt<span class="_ _e"> </span>=<span class="_ _1f"> </span>0;</span></div><div class="t m5 x1b0 h2d y50d4 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2e y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x1b0 h2e y65f2 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x4f h2d y61b6 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>echo_cnt(int<span class="_ _1f"> </span>connfd)</div><div class="t m5 x1b0 h2d y2181 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1b0 h2d y554b ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>n;</span></div><div class="t m5 x1b0 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>buf[MAXLINE];</span></div><div class="t m5 x1b0 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">rio_t<span class="_ _e"> </span>rio;</span></div><div class="t m5 x1b0 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _20"> </span><span class="ffd fs1e fc2">static<span class="_ _e"> </span>pthread_once_t<span class="_ _1f"> </span>once<span class="_ _1f"> </span>=<span class="_ _e"> </span>PTHREAD_ONCE_INIT;</span></div><div class="t m5 x1b0 h2e y3ec ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x1b0 h2e y73ec ff6 fs20 fc6 sc0 ls0 ws0">19</div><div class="t m5 x33 h2d y2a2b ffd fs1e fc2 sc0 ls0 ws0">Pthread_once(&amp;once,<span class="_ _e"> </span>init_echo_cnt);</div><div class="t m5 x1b0 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">Rio_readinitb(&amp;rio,<span class="_ _e"> </span>connfd);</span></div><div class="t m5 x1b0 h2d y1ada ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _20"> </span><span class="ffd fs1e fc2">while((n<span class="_ _e"> </span>=<span class="_ _1f"> </span>Rio_readlineb(&amp;rio,<span class="_ _1f"> </span>buf,<span class="_ _e"> </span>MAXLINE))<span class="_ _1f"> </span>!=<span class="_ _e"> </span>0)<span class="_ _1f"> </span>{</span></div><div class="t m5 x1b0 h2d y61b9 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _70"> </span><span class="ffd fs1e fc2">P(&amp;mutex);</span></div><div class="t m5 x1b0 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _70"> </span><span class="ffd fs1e fc2">byte_cnt<span class="_ _e"> </span>+=<span class="_ _1f"> </span>n;</span></div><div class="t m5 x1b0 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _70"> </span><span class="ffd fs1e fc2">printf(&quot;server<span class="_ _e"> </span>received<span class="_ _1f"> </span>%d<span class="_ _1f"> </span>(%d<span class="_ _e"> </span>total)<span class="_ _1f"> </span>bytes<span class="_ _e"> </span>on<span class="_ _1f"> </span>fd<span class="_ _1f"> </span>%d\n&quot;,</span></div><div class="t m5 x1b0 h2d y3229 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _1fe"> </span><span class="ffd fs1e fc2">n,<span class="_ _e"> </span>byte_cnt,<span class="_ _1f"> </span>connfd);</span></div><div class="t m5 x1b0 h2d y322a ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _70"> </span><span class="ffd fs1e fc2">V(&amp;mutex);</span></div><div class="t m5 x1b0 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _70"> </span><span class="ffd fs1e fc2">Rio_writen(connfd,<span class="_ _e"> </span>buf,<span class="_ _1f"> </span>n);</span></div><div class="t m5 x1b0 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d y441 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1e0 h2c y66e3 ffa fs16 fc2 sc0 ls0 ws0">code/conc/echo-cnt.c</div><div class="t m5 x1d h2f y66e4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _14"> </span>12.29</div><div class="t m5 x25 h3a y5165 ffd fs19 fc1 sc0 ls0 ws0">echo_cnt<span class="ffe fs16">:<span class="_ _14"> </span>A<span class="_ _14"> </span>version<span class="_ _14"> </span>of<span class="_ _15"> </span></span>echo<span class="_ _14"> </span><span class="ffe fs16">that<span class="_ _14"> </span>counts<span class="_ _15"> </span>all<span class="_ _14"> </span>bytes<span class="_ _14"> </span>received<span class="_ _14"> </span>from</span></div><div class="t m5 x1d h2f y82ed ffe fs16 fc1 sc0 ls0 ws0">clients.</div><div class="t m5 x1d h26 yec2 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>initialization<span class="_ _11"> </span>function<span class="_"> </span>the<span class="_ _11"> </span>ﬁrst<span class="_"> </span>time<span class="_ _11"> </span>some<span class="_"> </span>thread<span class="_ _11"> </span>calls<span class="_"> </span>the<span class="_ _11"> </span><span class="ffd">echo_cnt<span class="_ _10"> </span></span>function.</div><div class="t m5 x1d h26 yec3 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>advantage<span class="_ _16"> </span>of<span class="_ _14"> </span>this<span class="_ _14"> </span>approach<span class="_ _16"> </span>is<span class="_ _14"> </span>that<span class="_ _16"> </span>it<span class="_ _14"> </span>makes<span class="_ _14"> </span>the<span class="_ _16"> </span>package<span class="_ _14"> </span>easier<span class="_ _16"> </span>to<span class="_ _14"> </span>use.<span class="_ _16"> </span>T<span class="_ _1"></span>he</div><div class="t m5 x1d h26 yec4 ff7 fs19 fc1 sc0 ls0 ws0">disadvantage<span class="_"> </span>is<span class="_"> </span>that<span class="_"> </span>every<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">echo_cnt<span class="_ _10"> </span></span>makes<span class="_"> </span>a<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">pthread_once</span>,<span class="_"> </span>which</div><div class="t m5 x1d h26 yec5 ff7 fs19 fc1 sc0 ls0 ws0">most<span class="_"> </span>times<span class="_"> </span>does<span class="_"> </span>nothing<span class="_"> </span>useful.</div><div class="t m5 x29 h26 yec6 ff7 fs19 fc1 sc0 ls0 ws0">Once<span class="_ _21"> </span>the<span class="_ _f"> </span>package<span class="_ _f"> </span>is<span class="_ _21"> </span>initialized,<span class="_ _e"> </span>the<span class="_ _21"> </span><span class="ffd">echo_cnt<span class="_ _f"> </span></span>function<span class="_ _f"> </span>initializes<span class="_ _21"> </span>the<span class="_ _f"> </span><span class="ff9">Rio</span></div><div class="t m5 x1d h26 yec7 ff7 fs19 fc1 sc0 ls0 ws0">buffered<span class="_ _13"> </span>I/O<span class="_ _13"> </span>package<span class="_ _13"> </span>(line<span class="_ _6"> </span>20)<span class="_ _13"> </span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>echoes<span class="_ _13"> </span>each<span class="_ _13"> </span>text<span class="_ _6"> </span>line<span class="_ _13"> </span>that<span class="_ _13"> </span>is<span class="_ _13"> </span>received<span class="_ _13"> </span>from</div><div class="t m5 x1d h26 yec8 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>client.<span class="_ _13"> </span>Notice<span class="_"> </span>that<span class="_"> </span>the<span class="_ _13"> </span>accesses<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>shared<span class="_"> </span><span class="ffd">byte_cnt<span class="_ _13"> </span></span>variable<span class="_"> </span>in<span class="_"> </span>lines<span class="_ _13"> </span>23–25</div><div class="t m5 x1d h26 yec9 ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_"> </span>protected<span class="_"> </span>by<span class="_"> </span><span class="ff11">P<span class="_ _21"> </span></span>and<span class="_"> </span><span class="ff11">V<span class="_ _f"> </span></span>operations<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
