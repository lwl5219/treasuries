<div id="pf140" class="pf w2 h11" data-page-no="140"><div class="pc pc140 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg140.png"/><div class="t m5 xf8 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.10<span class="_ _60"> </span>Combining<span class="_ _10"> </span>Control<span class="_ _10"> </span>and<span class="_ _10"> </span>Data<span class="_ _10"> </span>in<span class="_ _10"> </span>Machine-Level<span class="_ _10"> </span>Programs<span class="_ _3e"> </span><span class="ffe fs1e">319</span></div><div class="t m5 x17 h34 ye7 ff6 fs16 fc2 sc0 ls0 ws0">(a)<span class="_ _10"> </span>C<span class="_ _11"> </span>code</div><div class="t m5 x17 h2d y2283 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>This<span class="_ _1f"> </span>is<span class="_ _1f"> </span>very<span class="_ _e"> </span>low-quality<span class="_ _1f"> </span>code.</div><div class="t m5 x245 h2d y2284 ffd fs1e fc2 sc0 ls0 ws0">It<span class="_ _e"> </span>is<span class="_ _1f"> </span>intended<span class="_ _1f"> </span>to<span class="_ _e"> </span>illustrate<span class="_ _1f"> </span>bad<span class="_ _e"> </span>programming<span class="_ _1f"> </span>practices.</div><div class="t m5 x245 h2d y2285 ffd fs1e fc2 sc0 ls0 ws0">See<span class="_ _e"> </span>Practice<span class="_ _1f"> </span>Problem<span class="_ _1f"> </span>3.46.<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y2286 ffd fs1e fc2 sc0 ls0 ws0">char<span class="_ _e"> </span>*get_line()</div><div class="t m5 x17 h2d y2287 ffd fs1e fc2 sc0 ls0 ws0">{</div><div class="t m5 x1b6 h2d y2288 ffd fs1e fc2 sc0 ls0 ws0">char<span class="_ _e"> </span>buf[4];</div><div class="t m5 x1b6 h2d y23a1 ffd fs1e fc2 sc0 ls0 ws0">char<span class="_ _e"> </span>*result;</div><div class="t m5 x1b6 h2d y23a2 ffd fs1e fc2 sc0 ls0 ws0">gets(buf);</div><div class="t m5 x1b6 h2d y2554 ffd fs1e fc2 sc0 ls0 ws0">result<span class="_ _e"> </span>=<span class="_ _1f"> </span>malloc(strlen(buf));</div><div class="t m5 x1b6 h2d y2555 ffd fs1e fc2 sc0 ls0 ws0">strcpy(result,<span class="_ _e"> </span>buf);</div><div class="t m5 x1b6 h2d y2556 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>result;</div><div class="t m5 x17 h2d y2557 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h3a y28a ff6 fs16 fc2 sc0 ls0 ws0">(b)<span class="_ _10"> </span>Disassembly<span class="_ _11"> </span>up<span class="_ _10"> </span>through<span class="_ _10"> </span>call<span class="_ _11"> </span>to<span class="_ _10"> </span><span class="ffd fs19">gets</span></div><div class="t m5 x239 h61 y23a5 ff13 fs35 fc6 sc0 ls0 ws0">char<span class="_ _f"> </span>*get_line()</div><div class="t m5 x2c h2d y23a6 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">0000000000400720<span class="_ _1f"> </span>&lt;get_line&gt;:</span></div><div class="t m5 x2c h2d y2dcc ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">400720:<span class="_ _1a"> </span>53<span class="_ _129"> </span>push<span class="_ _3f"> </span>%rbx</span></div><div class="t m5 x2c h2d y2dcd ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">400721:<span class="_ _1a"> </span>48<span class="_ _e"> </span>83<span class="_ _1f"> </span>ec<span class="_ _1f"> </span>10<span class="_ _35"> </span>sub<span class="_ _46"> </span>$0x10,%rsp</span></div><div class="t m5 x239 h61 y23a9 ff13 fs35 fc6 sc0 ls0 ws0">Diagram<span class="_ _f"> </span>stack<span class="_ _f"> </span>at<span class="_ _f"> </span>this<span class="_ _e"> </span>point</div><div class="t m5 x2c h2d y29fd ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">400725:<span class="_ _1a"> </span>48<span class="_ _e"> </span>89<span class="_ _1f"> </span>e7<span class="_ _12a"> </span>mov<span class="_ _7b"> </span>%rsp,%rdi</span></div><div class="t m5 x2c h2d y2dce ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">400728:<span class="_ _1a"> </span>e8<span class="_ _e"> </span>73<span class="_ _1f"> </span>ff<span class="_ _1f"> </span>ff<span class="_ _e"> </span>ff<span class="_ _86"> </span>callq<span class="_ _1a"> </span>4006a0<span class="_ _1f"> </span>&lt;gets&gt;</span></div><div class="t m5 x239 h61 y2a05 ff13 fs35 fc6 sc0 ls0 ws0">Modify<span class="_ _f"> </span>diagram<span class="_ _f"> </span>to<span class="_ _f"> </span>show<span class="_ _e"> </span>stack<span class="_ _21"> </span>contents<span class="_ _f"> </span>at<span class="_ _e"> </span>this<span class="_ _21"> </span>point</div><div class="t m5 x17 h2f y2dcf ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>3.41<span class="_ _66"> </span><span class="fc1">C<span class="_"> </span>and<span class="_"> </span>disassembled<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span>Practice<span class="_"> </span>Problem<span class="_"> </span>3.46.</span></div><div class="t m5 x17 h26 y2dd0 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>program<span class="_ _11"> </span>terminates<span class="_ _16"> </span>with<span class="_ _16"> </span>a<span class="_ _11"> </span>segmentation<span class="_ _16"> </span>fault.<span class="_ _11"> </span>Y<span class="_ _3"></span>ou<span class="_ _16"> </span>run<span class="_ _11"> </span><span class="ff9">gdb<span class="_ _16"> </span></span>and<span class="_ _16"> </span>determine</div><div class="t m5 x17 h26 y2dd1 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_"> </span>the<span class="_"> </span>error<span class="_"> </span>occurs<span class="_"> </span>during<span class="_"> </span>the<span class="_"> </span>execution<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span><span class="ffd">ret<span class="_ _10"> </span></span>instruction<span class="_"> </span>of<span class="_"> </span><span class="ffd">get_line</span>.</div><div class="t m5 x34 h26 y2dd2 ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>F<span class="_ _1"></span>ill<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _6"> </span>diagram<span class="_ _13"> </span>that<span class="_ _6"> </span>follows<span class="_ _1"></span>,<span class="_ _13"> </span>indicating<span class="_ _13"> </span>as<span class="_ _6"> </span>much<span class="_ _13"> </span>as<span class="_ _6"> </span>you<span class="_ _13"> </span>can<span class="_ _13"> </span>about<span class="_ _6"> </span>the<span class="_ _13"> </span>stack</div><div class="t m5 x2d h26 y2dd3 ff7 fs19 fc1 sc0 ls0 ws0">just<span class="_ _14"> </span>after<span class="_ _14"> </span>executing<span class="_ _14"> </span>the<span class="_ _14"> </span>instruction<span class="_ _14"> </span>at<span class="_ _14"> </span>line<span class="_ _14"> </span>3<span class="_ _14"> </span>in<span class="_ _15"> </span>the<span class="_ _14"> </span>disassembly<span class="_ _3"></span>.<span class="_ _14"> </span>Label<span class="_ _14"> </span>the</div><div class="t m5 x2d h26 y2dd4 ff7 fs19 fc1 sc0 ls0 ws0">quantities<span class="_ _13"> </span>stored<span class="_ _13"> </span>on<span class="_ _13"> </span>the<span class="_ _6"> </span>stack<span class="_ _13"> </span>(e.g<span class="_ _1"></span>.,<span class="_ _13"> </span>“Return<span class="_ _13"> </span>address”)<span class="_ _13"> </span>on<span class="_ _13"> </span>the<span class="_ _13"> </span>right,<span class="_ _13"> </span>and<span class="_ _13"> </span>their</div><div class="t m5 x2d h26 y2dd5 ff7 fs19 fc1 sc0 ls0 ws0">hexadecimal<span class="_"> </span>values<span class="_"> </span>(if<span class="_ _13"> </span>known)<span class="_"> </span>within<span class="_"> </span>the<span class="_"> </span>box.<span class="_ _13"> </span>Each<span class="_"> </span>box<span class="_"> </span>represents<span class="_"> </span>8<span class="_ _13"> </span>bytes<span class="_ _1"></span>.</div><div class="t m5 x2d h26 y2dd6 ff7 fs19 fc1 sc0 ls0 ws0">Indicate<span class="_ _13"> </span>the<span class="_ _6"> </span>position<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ffd">%rsp</span>.<span class="_ _6"> </span>Recall<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_ _6"> </span>ASCII<span class="_ _13"> </span>codes<span class="_ _13"> </span>for<span class="_ _6"> </span>characters<span class="_ _13"> </span><span class="ffd">0</span>–<span class="ffd">9</span></div><div class="t m5 x2d h26 y2dd7 ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_"> </span><span class="ffd">0x30</span>–<span class="ffd">0x39</span>.</div><div class="t m5 x146 h40 y2dd8 ff31 fs28 fc1 sc0 ls0 ws0">00 00 00 00 00 40 00 76</div><div class="t m5 x1f2 h3f y2dd9 ff30 fs27 fc1 sc0 ls0 ws0">Return address</div><div class="t m5 x34 h26 y4e0 ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>Modify<span class="_"> </span>your<span class="_"> </span>diagram<span class="_"> </span>to<span class="_"> </span>show<span class="_"> </span>the<span class="_"> </span>effect<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">gets<span class="_ _10"> </span></span>(line<span class="_"> </span>5).</div><div class="t m5 x34 h26 y99 ff7 fs19 fc1 sc0 ls0 ws0">C.<span class="_ _25"> </span>T<span class="_ _7"></span>o<span class="_"> </span>what<span class="_"> </span>address<span class="_"> </span>does<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>attempt<span class="_"> </span>to<span class="_"> </span>return?</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
