<div id="pf3f3" class="pf w2 h11" data-page-no="3f3"><div class="pc pc3f3 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3f3.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1010<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x14 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.2</div><div class="t m5 x14 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Step<span class="_ _16"> </span>2:<span class="_ _14"> </span>Server<span class="_ _14"> </span>forks<span class="_ _16"> </span>a</div><div class="t m5 x14 h2f y58b ffe fs16 fc1 sc0 ls0 ws0">child<span class="_ _16"> </span>process<span class="_ _11"> </span>to<span class="_ _16"> </span>service</div><div class="t m5 x14 h2f y58c ffe fs16 fc1 sc0 ls0 ws0">the<span class="_"> </span>client.</div><div class="t m5 x129 h4c y7ede ffe5 fs2d fc1 sc0 ls0 ws0">Client 1</div><div class="t m5 x137 hcb y7edf ffe6 fs7f fc1 sc0 ls0 ws0">clientfd</div><div class="t m5 x129 h4c y7ee0 ffe5 fs2d fc1 sc0 ls0 ws0">Client 2</div><div class="t m5 x137 hcb y7ee1 ffe6 fs7f fc1 sc0 ls0 ws0">clientfd</div><div class="t m5 xa7 hcb y7ee2 ffe6 fs7f fc1 sc0 ls0 ws0">connfd(4)</div><div class="t m5 x13d h4c y7ee3 ffe5 fs2d fc1 sc0 ls0 ws0">Child 1</div><div class="t m5 x24e hcb y7ee4 ffe6 fs7f fc1 sc0 ls0 ws0">listenfd(3)</div><div class="t m5 x23b h4c y7ee5 ffe5 fs2d fc1 sc0 ls0 ws0">Server</div><div class="t m5 xa8 h4c y7ee6 ffe5 fs2d fc1 sc0 ls0 ws0">Data</div><div class="t m5 x206 h4c y7ee7 ffe5 fs2d fc1 sc0 ls0 ws0">transfers</div><div class="t m5 x14 h2f y7ee8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.3</div><div class="t m5 x14 h2f y7ee9 ffe fs16 fc1 sc0 ls0 ws0">Step<span class="_ _16"> </span>3:<span class="_ _16"> </span>Server<span class="_ _14"> </span>accepts</div><div class="t m5 x14 h2f y7eea ffe fs16 fc1 sc0 ls0 ws0">another<span class="_ _14"> </span>connection</div><div class="t m5 x14 h2f y7eeb ffe fs16 fc1 sc0 ls0 ws0">request.</div><div class="t m5 x129 h4c y7eec ffe5 fs2d fc1 sc0 ls0 ws0">Client 1</div><div class="t m5 x137 hcb y7eed ffe6 fs7f fc1 sc0 ls0 ws0">clientfd</div><div class="t m5 x129 h4c y7eee ffe5 fs2d fc1 sc0 ls0 ws0">Client 2</div><div class="t m5 x137 hcb y7eef ffe6 fs7f fc1 sc0 ls0 ws0">clientfd</div><div class="t m5 xa7 hcb y7ef0 ffe6 fs7f fc1 sc0 ls0 ws0">connfd(4)</div><div class="t m5 xa7 hcb y7ef1 ffe6 fs7f fc1 sc0 ls0 ws0">connfd(5)</div><div class="t m5 x13d h4c y7ef2 ffe5 fs2d fc1 sc0 ls0 ws0">Child 1</div><div class="t m5 x24e hcb y7ef3 ffe6 fs7f fc1 sc0 ls0 ws0">listenfd(3)</div><div class="t m5 x23b h4c y7ef4 ffe5 fs2d fc1 sc0 ls0 ws0">Server</div><div class="t m5 xa8 h4c y7ef5 ffe5 fs2d fc1 sc0 ls0 ws0">Data</div><div class="t m5 x206 h4c y7ef6 ffe5 fs2d fc1 sc0 ls0 ws0">transfers</div><div class="t m5 x125 h4c y7ef7 ffe5 fs2d fc1 sc0 ls0 ws0">Connection</div><div class="t m5 xfa h4c y7ef8 ffe5 fs2d fc1 sc0 ls0 ws0">request</div><div class="t m5 x1d h26 y7ef9 ff7 fs19 fc1 sc0 ls0 ws0">descriptor.<span class="_ _16"> </span>Otherwise<span class="_ _1"></span>,<span class="_ _15"> </span>the<span class="_ _16"> </span>ﬁle<span class="_ _14"> </span>table<span class="_ _16"> </span>entry<span class="_ _14"> </span>for<span class="_ _14"> </span>connected<span class="_ _16"> </span>descriptor<span class="_ _14"> </span>4<span class="_ _16"> </span>will<span class="_ _14"> </span>never</div><div class="t m5 x1d h26 y7efa ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_"> </span>released,<span class="_ _13"> </span>and<span class="_"> </span>the<span class="_ _13"> </span>resulting<span class="_"> </span>memory<span class="_ _13"> </span>leak<span class="_"> </span>will<span class="_ _13"> </span>eventually<span class="_"> </span>consume<span class="_ _13"> </span>the<span class="_"> </span>available</div><div class="t m5 x1d h26 y7efb ff7 fs19 fc1 sc0 ls0 ws0">memory<span class="_"> </span>and<span class="_"> </span>crash<span class="_"> </span>the<span class="_"> </span>system.</div><div class="t m5 x29 h26 y7efc ff7 fs19 fc1 sc0 ls0 ws0">Now<span class="_ _14"> </span>suppose<span class="_ _15"> </span>that<span class="_ _14"> </span>after<span class="_ _15"> </span>the<span class="_ _14"> </span>parent<span class="_ _15"> </span>creates<span class="_ _14"> </span>the<span class="_ _14"> </span>child<span class="_ _15"> </span>for<span class="_ _14"> </span>client<span class="_ _15"> </span>1,<span class="_ _15"> </span>it<span class="_ _15"> </span>accepts</div><div class="t m5 x1d h26 y7efd ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _16"> </span>new<span class="_ _11"> </span>connection<span class="_ _16"> </span>request<span class="_ _16"> </span>from<span class="_ _16"> </span>client<span class="_ _16"> </span>2<span class="_ _11"> </span>and<span class="_ _16"> </span>returns<span class="_ _16"> </span>a<span class="_ _16"> </span>new<span class="_ _16"> </span>connected<span class="_ _11"> </span>descriptor</div><div class="t m5 x1d h26 y7efe ff7 fs19 fc1 sc0 ls0 ws0">(say<span class="_ _3"></span>,<span class="_ _13"> </span>5),<span class="_ _13"> </span>as<span class="_ _13"> </span>shown<span class="_ _6"> </span>in<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>12.3.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>parent<span class="_ _13"> </span>then<span class="_ _13"> </span>forks<span class="_ _6"> </span>another<span class="_ _13"> </span>child,<span class="_ _13"> </span>which<span class="_ _13"> </span>begins</div><div class="t m5 x1d h26 y7eff ff7 fs19 fc1 sc0 ls0 ws0">servicing<span class="_ _11"> </span>its<span class="_ _11"> </span>client<span class="_ _11"> </span>using<span class="_ _16"> </span>connected<span class="_"> </span>descriptor<span class="_ _16"> </span>5,<span class="_ _11"> </span>as<span class="_ _11"> </span>shown<span class="_ _11"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>12.4.<span class="_ _16"> </span>At<span class="_"> </span>this</div><div class="t m5 x1d h26 y7f00 ff7 fs19 fc1 sc0 ls0 ws0">point,<span class="_"> </span>the<span class="_ _11"> </span>parent<span class="_ _11"> </span>is<span class="_"> </span>waiting<span class="_ _11"> </span>for<span class="_ _11"> </span>the<span class="_"> </span>next<span class="_ _11"> </span>connection<span class="_ _11"> </span>request<span class="_ _11"> </span>and<span class="_"> </span>the<span class="_ _11"> </span>two<span class="_ _11"> </span>children</div><div class="t m5 x1d h26 y7f01 ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_"> </span>servicing<span class="_"> </span>their<span class="_"> </span>respective<span class="_"> </span>clients<span class="_"> </span>concurrently<span class="_ _3"></span>.</div><div class="t m5 x1d h41 y7f02 ffe fs29 fc1 sc0 ls0 ws0">12.1.1<span class="_ _48"> </span><span class="fs19">A<span class="_"> </span>Concurrent<span class="_"> </span>Server<span class="_"> </span>Based<span class="_"> </span>on<span class="_"> </span>Processes</span></div><div class="t m5 x1d h26 y7f03 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _f"> </span>12.5<span class="_ _f"> </span>shows<span class="_ _f"> </span>the<span class="_ _f"> </span>code<span class="_ _f"> </span>for<span class="_ _21"> </span>a<span class="_ _f"> </span>concurrent<span class="_ _f"> </span>echo<span class="_ _f"> </span>server<span class="_ _f"> </span>based<span class="_ _f"> </span>on<span class="_ _21"> </span>processes<span class="_ _0"></span>.</div><div class="t m5 x1d h26 y7f04 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _14"> </span><span class="ffd ls0">echo<span class="_ _14"> </span><span class="ff7">function<span class="_ _16"> </span>called<span class="_ _14"> </span>in<span class="_ _16"> </span>line<span class="_ _16"> </span>29<span class="_ _14"> </span>comes<span class="_ _16"> </span>from<span class="_ _14"> </span>F<span class="_ _1"></span>igure<span class="_ _14"> </span>11.22.<span class="_ _16"> </span>T<span class="_ _0"></span>here<span class="_ _16"> </span>are<span class="_ _14"> </span>several</span></span></div><div class="t m5 x1d h26 y7f05 ff7 fs19 fc1 sc0 ls0 ws0">important<span class="_"> </span>points<span class="_"> </span>to<span class="_"> </span>make<span class="_"> </span>about<span class="_"> </span>this<span class="_"> </span>server:</div><div class="t m5 x75 h3d y7f06 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y7f07 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>irst,<span class="_ _f"> </span>servers<span class="_ _21"> </span>typically<span class="_ _21"> </span>run<span class="_ _21"> </span>for<span class="_ _15"> </span>long<span class="_ _21"> </span>periods<span class="_ _21"> </span>of<span class="_ _21"> </span>time<span class="_ _1"></span>,<span class="_ _e"> </span>so<span class="_ _15"> </span>we<span class="_ _15"> </span>must<span class="_ _21"> </span>include<span class="_ _21"> </span>a</div><div class="t m5 x29 h26 y7f08 ff7 fs19 fc1 sc0 ls0 ws0">SIGCHLD<span class="_"> </span>handler<span class="_"> </span>that<span class="_ _11"> </span>reaps<span class="_"> </span>zombie<span class="_ _11"> </span>children<span class="_"> </span>(lines<span class="_ _11"> </span>4–9).<span class="_"> </span>Since<span class="_ _11"> </span>SIGCHLD</div><div class="t m5 x29 h26 y7f09 ff7 fs19 fc1 sc0 ls0 ws0">signals<span class="_ _13"> </span>are<span class="_ _6"> </span>blocked<span class="_ _13"> </span>while<span class="_ _6"> </span>the<span class="_ _13"> </span>SIGCHLD<span class="_ _6"> </span>handler<span class="_ _13"> </span>is<span class="_ _13"> </span>executing<span class="_ _1"></span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>since<span class="_ _6"> </span>Linux</div><div class="t m5 x29 h26 y7f0a ff7 fs19 fc1 sc0 ls0 ws0">signals<span class="_ _15"> </span>are<span class="_ _21"> </span>not<span class="_ _15"> </span>queued,<span class="_ _f"> </span>the<span class="_ _21"> </span>SIGCHLD<span class="_ _15"> </span>handler<span class="_ _21"> </span>must<span class="_ _15"> </span>be<span class="_ _21"> </span>prepared<span class="_ _15"> </span>to<span class="_ _21"> </span>reap</div><div class="t m5 x29 h26 y7f0b ff7 fs19 fc1 sc0 ls0 ws0">multiple<span class="_"> </span>zombie<span class="_"> </span>children.</div><div class="t m5 x75 h3d y7f0c ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y33bf ff7 fs19 fc1 sc0 ls0 ws0">Second,<span class="_"> </span>the<span class="_ _13"> </span>parent<span class="_"> </span>and<span class="_ _13"> </span>the<span class="_"> </span>child<span class="_"> </span>must<span class="_ _13"> </span>close<span class="_"> </span>their<span class="_ _13"> </span>respective<span class="_"> </span>copies<span class="_"> </span>of<span class="_ _13"> </span><span class="ffd">connfd</span></div><div class="t m5 x29 h26 y33c0 ff7 fs19 fc1 sc0 ls0 ws0">(lines<span class="_ _11"> </span>33<span class="_ _16"> </span>and<span class="_ _16"> </span>30,<span class="_ _16"> </span>respectively).<span class="_ _11"> </span>As<span class="_ _16"> </span>we<span class="_ _11"> </span>have<span class="_ _16"> </span>mentioned,<span class="_ _16"> </span>this<span class="_ _16"> </span>is<span class="_ _11"> </span>especially<span class="_ _16"> </span>im-</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
