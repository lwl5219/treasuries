<div id="pf326" class="pf w2 h11" data-page-no="326"><div class="pc pc326 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg326.png"/><div class="t m5 x1e0 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>8.5<span class="_ _60"> </span>Signals<span class="_ _3e"> </span><span class="ffe fs1e">805</span></div><div class="t m5 x195 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/ecf/sigintsafe.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h2e y281 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x2c h2e y282 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2d h2d y283 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>sigint_handler(int<span class="_ _1f"> </span>sig)<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Safe<span class="_ _1f"> </span>SIGINT<span class="_ _e"> </span>handler<span class="_ _1f"> </span>*/</div><div class="t m5 x2c h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">Sio_puts(&quot;Caught<span class="_ _e"> </span>SIGINT!\n&quot;);<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>Safe<span class="_ _e"> </span>output<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">_exit(0);<span class="_ _1fb"> </span>/*<span class="_ _e"> </span>Safe<span class="_ _1f"> </span>exit<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x195 h2c y288 ffa fs16 fc2 sc0 ls0 ws0">code/ecf/sigintsafe.c</div><div class="t m5 x17 h2f y289 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>8.35<span class="_ _66"> </span><span class="fc1">A<span class="_"> </span>safe<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>SIGINT<span class="_"> </span>handler<span class="_"> </span>from<span class="_"> </span>Figure<span class="_"> </span>8.30.</span></div><div class="t m5 x30 h26 y696c ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _6"> </span>workaround<span class="_ _6"> </span>is<span class="_ _13"> </span>to<span class="_ _a"> </span>save<span class="_ _6"> </span><span class="ffd">errno<span class="_ _6"> </span></span>to<span class="_ _6"> </span>a<span class="_ _13"> </span>local<span class="_ _a"> </span>variable<span class="_ _6"> </span>on<span class="_ _6"> </span>entry<span class="_ _6"> </span>to<span class="_ _6"> </span>the<span class="_ _6"> </span>handler</div><div class="t m5 x30 h26 y696d ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>restore<span class="_"> </span>it<span class="_ _13"> </span>before<span class="_"> </span>the<span class="_"> </span>handler<span class="_"> </span>returns<span class="_ _1"></span>.<span class="_"> </span>Note<span class="_"> </span>that<span class="_ _13"> </span>this<span class="_"> </span>is<span class="_"> </span>only<span class="_"> </span>necessary</div><div class="t m5 x30 h26 y696e ff7 fs19 fc1 sc0 ls0 ws0">if<span class="_ _14"> </span>the<span class="_ _14"> </span>handler<span class="_ _14"> </span>returns<span class="_ _1"></span>.<span class="_ _15"> </span>It<span class="_ _14"> </span>is<span class="_ _14"> </span>not<span class="_ _14"> </span>necessary<span class="_ _15"> </span>if<span class="_ _14"> </span>the<span class="_ _14"> </span>handler<span class="_ _14"> </span>terminates<span class="_ _15"> </span>the</div><div class="t m5 x30 h26 y696f ff7 fs19 fc1 sc0 ls0 ws0">process<span class="_"> </span>by<span class="_"> </span>calling<span class="_"> </span><span class="ffd">_exit</span>.</div><div class="t m5 x72 h26 y6970 ffa fs19 fc1 sc0 ls0 ws0">G3.<span class="_ _16"> </span>Protect<span class="_ _16"> </span>accesses<span class="_ _11"> </span>to<span class="_ _16"> </span>shared<span class="_ _16"> </span>global<span class="_ _16"> </span>data<span class="_ _16"> </span>structures<span class="_ _16"> </span>by<span class="_ _11"> </span>blocking<span class="_ _16"> </span>all<span class="_ _16"> </span>signals<span class="_ _3"></span>.<span class="_ _f"> </span><span class="ff7">If</span></div><div class="t m5 x30 h26 y6971 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _16"> </span>handler<span class="_ _11"> </span>shares<span class="_ _16"> </span>a<span class="_ _16"> </span>global<span class="_ _16"> </span>data<span class="_ _16"> </span>structure<span class="_ _16"> </span>with<span class="_ _11"> </span>the<span class="_ _16"> </span>main<span class="_ _16"> </span>program<span class="_ _16"> </span>or<span class="_ _16"> </span>with</div><div class="t m5 x30 h26 y6972 ff7 fs19 fc1 sc0 ls0 ws0">other<span class="_ _13"> </span>handlers<span class="_ _1"></span>,<span class="_ _13"> </span>then<span class="_ _13"> </span>your<span class="_ _13"> </span>handlers<span class="_ _13"> </span>and<span class="_ _13"> </span>main<span class="_ _13"> </span>program<span class="_ _13"> </span>should<span class="_ _13"> </span>temporarily</div><div class="t m5 x30 h26 y6973 ff7 fs19 fc1 sc0 ls0 ws0">block<span class="_ _11"> </span>all<span class="_ _11"> </span>signals<span class="_ _11"> </span>while<span class="_"> </span>accessing<span class="_ _11"> </span>(reading<span class="_ _11"> </span>or<span class="_ _11"> </span>writing)<span class="_ _11"> </span>that<span class="_ _11"> </span>data<span class="_ _11"> </span>structure.</div><div class="t m5 x30 h26 y6974 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>reason<span class="_ _13"> </span>for<span class="_"> </span>this<span class="_ _13"> </span>rule<span class="_"> </span>is<span class="_ _13"> </span>that<span class="_"> </span>accessing<span class="_"> </span>a<span class="_ _13"> </span>data<span class="_"> </span>structure<span class="_ _13"> </span><span class="ff11">d<span class="_ _16"> </span></span>from<span class="_ _13"> </span>the<span class="_"> </span>main</div><div class="t m5 x30 h26 y6975 ff7 fs19 fc1 sc0 ls0 ws0">program<span class="_ _11"> </span>typically<span class="_ _16"> </span>requires<span class="_ _11"> </span>a<span class="_ _16"> </span>sequence<span class="_ _11"> </span>of<span class="_ _16"> </span>instructions<span class="_ _1"></span>.<span class="_ _11"> </span>If<span class="_ _16"> </span>this<span class="_ _16"> </span>instruction</div><div class="t m5 x30 h26 y6976 ff7 fs19 fc1 sc0 ls0 ws0">sequence<span class="_ _14"> </span>is<span class="_ _14"> </span>interrupted<span class="_ _15"> </span>by<span class="_ _14"> </span>a<span class="_ _14"> </span>handler<span class="_ _14"> </span>that<span class="_ _15"> </span>accesses<span class="_ _14"> </span><span class="ff11">d<span class="_ _be"></span></span>,<span class="_ _15"> </span>then<span class="_ _14"> </span>the<span class="_ _14"> </span>handler</div><div class="t m5 x30 h26 y6977 ff7 fs19 fc1 sc0 ls0 ws0">might<span class="_ _11"> </span>ﬁnd<span class="_ _11"> </span><span class="ff11">d<span class="_ _15"> </span></span>in<span class="_ _11"> </span>an<span class="_ _16"> </span>inconsistent<span class="_ _11"> </span>state<span class="_ _1"></span>,<span class="_ _16"> </span>with<span class="_ _11"> </span>unpredictable<span class="_ _16"> </span>results<span class="_ _3"></span>.<span class="_ _16"> </span>T<span class="_ _7"></span>empo-</div><div class="t m5 x30 h26 y6978 ff7 fs19 fc1 sc0 ls0 ws0">rarily<span class="_ _11"> </span>blocking<span class="_ _16"> </span>signals<span class="_ _11"> </span>while<span class="_ _16"> </span>you<span class="_ _11"> </span>access<span class="_ _16"> </span><span class="ff11">d<span class="_"> </span></span>guarantees<span class="_ _16"> </span>that<span class="_ _11"> </span>a<span class="_ _16"> </span>handler<span class="_ _11"> </span>will</div><div class="t m5 x30 h26 y6979 ff7 fs19 fc1 sc0 ls0 ws0">not<span class="_"> </span>interrupt<span class="_"> </span>the<span class="_"> </span>instruction<span class="_"> </span>sequence<span class="_ _1"></span>.</div><div class="t m5 x62 h26 y697a ffa fs19 fc1 sc0 ls0 ws0">G4.<span class="_"> </span>Declare<span class="_ _13"> </span>global<span class="_"> </span>variables<span class="_"> </span>with<span class="_"> </span><span class="ffd">volatile</span>.<span class="_ _15"> </span><span class="ff7">Consider<span class="_"> </span>a<span class="_"> </span>handler<span class="_ _13"> </span>and<span class="_"> </span><span class="ffd">main<span class="_ _10"> </span></span>rou-</span></div><div class="t m5 x30 h26 y697b ff7 fs19 fc1 sc0 ls0 ws0">tine<span class="_ _11"> </span>that<span class="_ _11"> </span>share<span class="_ _11"> </span>a<span class="_ _11"> </span>global<span class="_ _16"> </span>variable<span class="_"> </span><span class="ff11">g<span class="_ _2"></span></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>handler<span class="_ _11"> </span>updates<span class="_ _16"> </span><span class="ff11">g<span class="_ _2"></span></span>,<span class="_ _11"> </span>and<span class="_ _11"> </span><span class="ffd">main<span class="_ _11"> </span></span>pe-</div><div class="t m5 x30 h26 y697c ff7 fs19 fc1 sc0 ls0 ws0">riodically<span class="_ _16"> </span>reads<span class="_ _14"> </span><span class="ff11">g<span class="_ _2"></span></span>.<span class="_ _14"> </span>T<span class="_ _3"></span>o<span class="_ _16"> </span>an<span class="_ _14"> </span>optimizing<span class="_ _14"> </span>compiler,<span class="_ _14"> </span>it<span class="_ _14"> </span>would<span class="_ _14"> </span>appear<span class="_ _16"> </span>that<span class="_ _14"> </span>the</div><div class="t m5 x30 h26 y697d ff7 fs19 fc1 sc0 ls0 ws0">value<span class="_"> </span>of<span class="_"> </span><span class="ff11">g<span class="_ _11"> </span></span>never<span class="_"> </span>changes<span class="_"> </span>in<span class="_"> </span><span class="ffd">main</span>,<span class="_"> </span>and<span class="_"> </span>thus<span class="_"> </span>it<span class="_"> </span>would<span class="_"> </span>be<span class="_"> </span>safe<span class="_ _13"> </span>to<span class="_"> </span>use<span class="_"> </span>a<span class="_"> </span>copy</div><div class="t m5 x30 h26 y697e ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _13"> </span><span class="ff11">g<span class="_ _10"> </span></span>that<span class="_"> </span>is<span class="_ _13"> </span>cached<span class="_ _13"> </span>in<span class="_ _13"> </span>a<span class="_"> </span>register<span class="_ _13"> </span>to<span class="_ _13"> </span>satisfy<span class="_ _13"> </span>every<span class="_"> </span>reference<span class="_ _13"> </span>to<span class="_ _13"> </span><span class="ff11">g<span class="_ _2"></span></span>.<span class="_ _13"> </span>In<span class="_"> </span>this<span class="_ _13"> </span>case<span class="_ _1"></span>,</div><div class="t m5 x30 h26 y697f ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span><span class="ffd">main<span class="_ _10"> </span></span>function<span class="_"> </span>would<span class="_"> </span>never<span class="_"> </span>see<span class="_"> </span>the<span class="_"> </span>updated<span class="_"> </span>values<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>handler.</div><div class="t m5 x20a h26 y6980 ff7 fs19 fc1 sc0 ls0 ws0">Y<span class="_ _3"></span>ou<span class="_"> </span>can<span class="_"> </span>tell<span class="_ _13"> </span>the<span class="_"> </span>compiler<span class="_"> </span>not<span class="_"> </span>to<span class="_"> </span>cache<span class="_"> </span>a<span class="_"> </span>variable<span class="_"> </span>by<span class="_ _13"> </span>declaring<span class="_"> </span>it<span class="_"> </span>with</div><div class="t m5 x30 h26 y6981 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span><span class="ffd">volatile<span class="_ _10"> </span></span>type<span class="_"> </span>qualiﬁer.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_"> </span>example:</div><div class="t m5 x8e h2d y6982 ffd fs1e fc2 sc0 ls0 ws0">volatile<span class="_ _e"> </span>int<span class="_ _1f"> </span>g;</div><div class="t m5 x30 h26 y6983 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _14"> </span><span class="ffd ls0">volatile<span class="_ _16"> </span><span class="ff7">qualiﬁer<span class="_ _16"> </span>forces<span class="_ _16"> </span>the<span class="_ _16"> </span>compiler<span class="_ _16"> </span>to<span class="_ _16"> </span>read<span class="_ _16"> </span>the<span class="_ _16"> </span>value<span class="_ _16"> </span>of<span class="_ _16"> </span></span>g<span class="_ _16"> </span><span class="ff7">from</span></span></div><div class="t m5 x30 h26 y6984 ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_ _14"> </span>each<span class="_ _16"> </span>time<span class="_ _14"> </span>it<span class="_ _14"> </span>is<span class="_ _14"> </span>referenced<span class="_ _14"> </span>in<span class="_ _14"> </span>the<span class="_ _14"> </span>code<span class="_ _1"></span>.<span class="_ _14"> </span>In<span class="_ _14"> </span>general,<span class="_ _15"> </span>as<span class="_ _14"> </span>with<span class="_ _16"> </span>any</div><div class="t m5 x30 h26 y6985 ff7 fs19 fc2 sc0 ls0 ws0">shared<span class="_ _13"> </span>data<span class="_ _6"> </span>structure<span class="_ _0"></span>,<span class="_ _13"> </span>each<span class="_ _6"> </span>access<span class="_ _13"> </span>to<span class="_ _13"> </span>a<span class="_ _6"> </span>global<span class="_ _13"> </span>variable<span class="_ _6"> </span>should<span class="_ _13"> </span>be<span class="_ _6"> </span>protected</div><div class="t m5 x30 h26 y6986 ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_"> </span>temporarily<span class="_"> </span>blocking<span class="_"> </span>signals<span class="_ _1"></span>.</div><div class="t m5 x62 h26 y27c ffa fs19 fc2 sc0 ls0 ws0">G5.<span class="_ _f"> </span>Declare<span class="_ _e"> </span>ﬂags<span class="_ _f"> </span>with<span class="_ _e"> </span><span class="ffd">sig_atomic_t</span>.<span class="_ _15"> </span><span class="ff7">In<span class="_ _e"> </span>one<span class="_ _f"> </span>common<span class="_ _e"> </span>handler<span class="_ _f"> </span>design,<span class="_ _e"> </span>the</span></div><div class="t m5 x30 h26 y27d ff7 fs19 fc2 sc0 ls0 ws0">handler<span class="_ _11"> </span>records<span class="_ _16"> </span>the<span class="_ _11"> </span>receipt<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>signal<span class="_ _16"> </span>by<span class="_ _11"> </span>writing<span class="_ _11"> </span>to<span class="_ _16"> </span>a<span class="_ _11"> </span>global<span class="_ _11"> </span><span class="ffa">ﬂag<span class="_ _2"></span></span><span class="ls28c">.T<span class="_ _42"></span>h<span class="_ _49"></span>e</span></div><div class="t m5 x30 h26 y27e ff7 fs19 fc2 sc0 ls0 ws0">main<span class="_ _21"> </span>program<span class="_ _21"> </span>periodically<span class="_ _21"> </span>reads<span class="_ _f"> </span>the<span class="_ _21"> </span>ﬂag,<span class="_ _f"> </span>responds<span class="_ _21"> </span>to<span class="_ _f"> </span>the<span class="_ _21"> </span>signal,<span class="_ _e"> </span>and</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
