<div id="pf261" class="pf w2 h11" data-page-no="261"><div class="pc pc261 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg261.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">608<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>function<span class="_"> </span>ﬁlls<span class="_"> </span><span class="ffd">n<span class="_ _10"> </span></span>bytes<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>memory<span class="_"> </span>area<span class="_"> </span>starting<span class="_ _13"> </span>at<span class="_"> </span><span class="ffd">s<span class="_ _10"> </span></span>with<span class="_"> </span>copies<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>low-</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">order<span class="_ _16"> </span>byte<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffd">c</span>.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _16"> </span>example<span class="_ _0"></span>,<span class="_ _16"> </span>it<span class="_ _16"> </span>can<span class="_ _16"> </span>be<span class="_ _11"> </span>used<span class="_ _16"> </span>to<span class="_ _16"> </span>zero<span class="_ _16"> </span>out<span class="_ _16"> </span>a<span class="_ _16"> </span>region<span class="_ _11"> </span>of<span class="_ _16"> </span>memory<span class="_ _16"> </span>by</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">giving<span class="_"> </span>argument<span class="_"> </span>0<span class="_"> </span>for<span class="_"> </span><span class="ffd">c</span>,<span class="_"> </span>but<span class="_"> </span>other<span class="_"> </span>values<span class="_"> </span>are<span class="_"> </span>possible<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>following<span class="_"> </span>is<span class="_"> </span>a<span class="_"> </span>straightforward<span class="_"> </span>implementation<span class="_"> </span>of<span class="_"> </span><span class="ffd">memset</span>:</div><div class="t m5 x1f h2d y9bd ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Basic<span class="_ _e"> </span>implementation<span class="_ _1f"> </span>of<span class="_ _1f"> </span>memset<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f h2d y493e ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>*basic_memset(void<span class="_ _e"> </span>*s,<span class="_ _1f"> </span>int<span class="_ _1f"> </span>c,<span class="_ _e"> </span>size_t<span class="_ _1f"> </span>n)</span></div><div class="t m5 x1f h2d y5170 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y5171 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">size_t<span class="_ _e"> </span>cnt<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;</span></div><div class="t m5 x1f h2d y2d58 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">unsigned<span class="_ _e"> </span>char<span class="_ _1f"> </span>*schar<span class="_ _1f"> </span>=<span class="_ _e"> </span>s;</span></div><div class="t m5 x1f h2d y2d5a ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">while<span class="_ _e"> </span>(cnt<span class="_ _1f"> </span>&lt;<span class="_ _1f"> </span>n)<span class="_ _e"> </span>{</span></div><div class="t m5 x1f h2d y5172 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _70"> </span><span class="ffd fs1e fc2">*schar++<span class="_ _e"> </span>=<span class="_ _1f"> </span>(unsigned<span class="_ _1f"> </span>char)<span class="_ _e"> </span>c;</span></div><div class="t m5 x1f h2d y5173 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">cnt++;</span></div><div class="t m5 x1f h2d y5174 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d y5175 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>s;</span></div><div class="t m5 x1b0 h2e y5176 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x4f h2d y5177 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x29 h26 y5178 ff7 fs19 fc2 sc0 ls0 ws0">Implement<span class="_ _16"> </span>a<span class="_ _16"> </span>more<span class="_ _16"> </span>efﬁcient<span class="_ _11"> </span>version<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>function<span class="_ _16"> </span>by<span class="_ _16"> </span>using<span class="_ _16"> </span>a<span class="_ _16"> </span>word<span class="_ _16"> </span>of<span class="_ _16"> </span>data</div><div class="t m5 x1d h26 y5179 ff7 fs19 fc2 sc0 ls0 ws0">type<span class="_ _11"> </span><span class="ffd">unsigned<span class="_ _16"> </span>long<span class="_ _11"> </span></span>to<span class="_ _16"> </span>pack<span class="_ _11"> </span>eight<span class="_ _16"> </span>copies<span class="_ _16"> </span>of<span class="_ _11"> </span><span class="ffd">c</span>,<span class="_ _16"> </span>and<span class="_ _11"> </span>then<span class="_ _16"> </span>step<span class="_ _11"> </span>through<span class="_ _16"> </span>the<span class="_ _11"> </span>region</div><div class="t m5 x1d h26 y517a ff7 fs19 fc2 sc0 ls0 ws0">using<span class="_"> </span>word-level<span class="_ _11"> </span>writes<span class="_ _1"></span>.<span class="_"> </span>Y<span class="_ _3"></span>ou<span class="_ _11"> </span>might<span class="_"> </span>ﬁnd<span class="_ _11"> </span>it<span class="_"> </span>helpful<span class="_ _11"> </span>to<span class="_ _11"> </span>do<span class="_"> </span>additional<span class="_ _11"> </span>loop<span class="_"> </span>unrolling</div><div class="t m5 x1d h26 y517b ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_"> </span>well.<span class="_ _13"> </span>On<span class="_"> </span>our<span class="_ _13"> </span>reference<span class="_"> </span>machine<span class="_ _1"></span>,<span class="_"> </span>we<span class="_ _13"> </span>were<span class="_"> </span>able<span class="_"> </span>to<span class="_ _13"> </span>reduce<span class="_"> </span>the<span class="_ _13"> </span>CPE<span class="_"> </span>from<span class="_ _13"> </span>1.00<span class="_"> </span>for</div><div class="t m5 x1d h26 y517c ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>straightforward<span class="_ _13"> </span>implementation<span class="_"> </span>to<span class="_"> </span>0.127.<span class="_ _13"> </span>That<span class="_ _13"> </span>is<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>program<span class="_ _13"> </span>is<span class="_"> </span>able<span class="_"> </span>to<span class="_ _13"> </span>write</div><div class="t m5 x1d h26 y517d ff7 fs19 fc2 sc0 ls0 ws0">8<span class="_"> </span>bytes<span class="_"> </span>every<span class="_"> </span>clock<span class="_"> </span>cycle<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y517e ff7 fs19 fc2 sc0 ls0 ws0">Here<span class="_ _11"> </span>are<span class="_ _11"> </span>some<span class="_ _11"> </span>additional<span class="_"> </span>guidelines<span class="_ _0"></span>.<span class="_"> </span>T<span class="_ _3"></span>o<span class="_ _11"> </span>ensure<span class="_ _11"> </span>portability<span class="_ _3"></span>,<span class="_ _11"> </span>let<span class="_ _11"> </span><span class="ff11">K<span class="_ _14"> </span></span>denote<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y517f ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_ _6"> </span>of<span class="_ _6"> </span><span class="ffd">sizeof(unsigned<span class="_ _16"> </span>long)<span class="_ _a"> </span></span>for<span class="_ _6"> </span>the<span class="_ _13"> </span>machine<span class="_ _a"> </span>on<span class="_ _6"> </span>which<span class="_ _6"> </span>you<span class="_ _6"> </span>run<span class="_ _6"> </span>your<span class="_ _6"> </span>program.</div><div class="t m5 x75 h3d y5180 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y5181 ff7 fs19 fc1 sc0 ls0 ws0">Y<span class="_ _3"></span>ou<span class="_"> </span>may<span class="_"> </span>not<span class="_"> </span>call<span class="_"> </span>any<span class="_"> </span>library<span class="_"> </span>functions<span class="_ _1"></span>.</div><div class="t m5 x75 h3d y5182 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y5183 ff7 fs19 fc1 sc0 ls0 ws0">Y<span class="_ _3"></span>our<span class="_ _16"> </span>code<span class="_ _16"> </span>should<span class="_ _14"> </span>work<span class="_ _16"> </span>for<span class="_ _16"> </span>arbitrary<span class="_ _14"> </span>values<span class="_ _16"> </span>of<span class="_ _16"> </span><span class="ffd">n</span>,<span class="_ _14"> </span>including<span class="_ _14"> </span>when<span class="_ _16"> </span>it<span class="_ _14"> </span>is<span class="_ _16"> </span>not<span class="_ _16"> </span>a</div><div class="t m5 x29 h26 y5184 ff7 fs19 fc1 sc0 ls0 ws0">multiple<span class="_ _16"> </span>of<span class="_ _11"> </span><span class="ff11">K<span class="_ _be"></span></span>.<span class="_ _16"> </span>Y<span class="_ _7"></span>ou<span class="_ _16"> </span>can<span class="_ _16"> </span>do<span class="_ _11"> </span>this<span class="_ _16"> </span>in<span class="_ _16"> </span>a<span class="_ _16"> </span>manner<span class="_ _11"> </span>similar<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span>way<span class="_ _16"> </span>we<span class="_ _16"> </span>ﬁnish<span class="_ _16"> </span>the</div><div class="t m5 x29 h26 y5185 ff7 fs19 fc1 sc0 ls0 ws0">last<span class="_"> </span>few<span class="_"> </span>iterations<span class="_"> </span>with<span class="_"> </span>loop<span class="_"> </span>unrolling.</div><div class="t m5 x75 h3d y5186 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y5187 ff7 fs19 fc1 sc0 ls0 ws0">Y<span class="_ _3"></span>ou<span class="_ _11"> </span>should<span class="_ _16"> </span>write<span class="_ _11"> </span>your<span class="_ _16"> </span>code<span class="_ _11"> </span>so<span class="_ _16"> </span>that<span class="_ _11"> </span>it<span class="_ _16"> </span>will<span class="_ _11"> </span>compile<span class="_ _16"> </span>and<span class="_ _11"> </span>run<span class="_ _16"> </span>correctly<span class="_ _11"> </span>on<span class="_ _16"> </span>any</div><div class="t m5 x29 h26 y5188 ff7 fs19 fc1 sc0 ls0 ws0">machine<span class="_ _11"> </span>regardless<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>value<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ff11">K<span class="_ _5"></span></span>.<span class="_ _16"> </span>Make<span class="_ _11"> </span>use<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>operation<span class="_ _11"> </span><span class="ffd">sizeof<span class="_ _16"> </span></span>to</div><div class="t m5 x29 h26 y5189 ff7 fs19 fc1 sc0 ls0 ws0">do<span class="_"> </span>this<span class="_ _1"></span>.</div><div class="t m5 x75 h3d y518a ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y518b ff7 fs19 fc1 sc0 ls0 ws0">On<span class="_ _11"> </span>some<span class="_ _11"> </span>machines<span class="_ _1"></span>,<span class="_ _11"> </span>unaligned<span class="_ _16"> </span>writes<span class="_"> </span>can<span class="_ _16"> </span>be<span class="_"> </span>much<span class="_ _11"> </span>slower<span class="_ _16"> </span>than<span class="_"> </span>aligned<span class="_ _16"> </span>ones<span class="_ _3"></span>.</div><div class="t m5 x29 h26 y518c ff7 fs19 fc1 sc0 ls0 ws0">(On<span class="_ _13"> </span>some<span class="_ _13"> </span>non-x86<span class="_ _13"> </span>machines<span class="_ _1"></span>,<span class="_"> </span>they<span class="_ _13"> </span>can<span class="_ _13"> </span>even<span class="_ _13"> </span>cause<span class="_ _13"> </span>segmentation<span class="_ _13"> </span>faults<span class="_ _1"></span>.)<span class="_ _13"> </span>Write</div><div class="t m5 x29 h26 y518d ff7 fs19 fc1 sc0 ls0 ws0">your<span class="_"> </span>code<span class="_"> </span>so<span class="_"> </span>that<span class="_"> </span>it<span class="_"> </span>starts<span class="_"> </span>with<span class="_ _11"> </span>byte-level<span class="_"> </span>writes<span class="_"> </span>until<span class="_"> </span>the<span class="_"> </span>destination<span class="_"> </span>address</div><div class="t m5 x29 h26 y518e ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _16"> </span>a<span class="_ _16"> </span>multiple<span class="_ _14"> </span>of<span class="_ _16"> </span><span class="ff11">K<span class="_ _be"></span></span>,<span class="_ _14"> </span>then<span class="_ _16"> </span>do<span class="_ _14"> </span>word-level<span class="_ _16"> </span>writes<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _14"> </span>then<span class="_ _16"> </span>(if<span class="_ _16"> </span>necessary)<span class="_ _14"> </span>ﬁnish</div><div class="t m5 x29 h26 y518f ff7 fs19 fc1 sc0 ls0 ws0">with<span class="_"> </span>byte-level<span class="_"> </span>writes<span class="_ _1"></span>.</div><div class="t m5 x75 h3d y5190 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y5191 ff7 fs19 fc1 sc0 ls0 ws0">Beware<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>case<span class="_ _21"> </span>where<span class="_ _21"> </span><span class="ffd">cnt<span class="_ _21"> </span></span>is<span class="_ _21"> </span>small<span class="_ _21"> </span>enough<span class="_ _21"> </span>that<span class="_ _21"> </span>the<span class="_ _21"> </span>upper<span class="_ _21"> </span>bounds<span class="_ _21"> </span>on</div><div class="t m5 x29 h26 y5192 ff7 fs19 fc1 sc0 ls0 ws0">some<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>loops<span class="_ _16"> </span>become<span class="_ _16"> </span>negative<span class="_ _0"></span>.<span class="_ _16"> </span>W<span class="_ _1"></span>ith<span class="_ _14"> </span>expressions<span class="_ _16"> </span>involving<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">sizeof</span></div><div class="t m5 x29 h26 y5193 ff7 fs19 fc1 sc0 ls0 ws0">operator,<span class="_ _11"> </span>the<span class="_ _16"> </span>testing<span class="_ _11"> </span>may<span class="_ _16"> </span>be<span class="_ _11"> </span>performed<span class="_ _16"> </span>with<span class="_ _11"> </span>unsigned<span class="_ _16"> </span>arithmetic.<span class="_"> </span>(See<span class="_ _16"> </span>Sec-</div><div class="t m5 x29 h26 y5194 ff7 fs19 fc1 sc0 ls0 ws0">tion<span class="_"> </span>2.2.8<span class="_"> </span>and<span class="_"> </span>Problem<span class="_"> </span>2.72.)</div><div class="t m5 x1d h73 y20a6 ffe fs1e fc6 sc0 ls0 ws0">5.18<span class="_ _23"> </span><span class="ff10 fs19">◆◆◆</span></div><div class="t m5 x1d h26 y5195 ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _13"> </span>considered<span class="_ _13"> </span>the<span class="_ _13"> </span>task<span class="_ _13"> </span>of<span class="_ _13"> </span>polynomial<span class="_ _13"> </span>evaluation<span class="_ _13"> </span>in<span class="_ _6"> </span>Practice<span class="_ _13"> </span>Problems<span class="_ _13"> </span>5.5<span class="_ _13"> </span>and<span class="_ _13"> </span>5.6,</div><div class="t m5 x1d h26 y5196 ff7 fs19 fc1 sc0 ls0 ws0">with<span class="_"> </span>both<span class="_ _13"> </span>a<span class="_"> </span>direct<span class="_"> </span>evaluation<span class="_"> </span>and<span class="_ _13"> </span>an<span class="_"> </span>evaluation<span class="_"> </span>by<span class="_ _13"> </span>Horner’s<span class="_"> </span>method.<span class="_ _13"> </span>T<span class="_ _3"></span>ry<span class="_"> </span>to<span class="_ _13"> </span>write</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
