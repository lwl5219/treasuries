<div id="pf3a7" class="pf w2 h11" data-page-no="3a7"><div class="pc pc3a7 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3a7.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">934<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>10<span class="_ _3d"> </span>System-Level<span class="_ _10"> </span>I/O</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>10.4<span class="_"> </span>shows<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span><span class="ffd">rio_readn<span class="_ _13"> </span></span>and<span class="_"> </span><span class="ffd">rio_writen</span>.<span class="_"> </span>Notice<span class="_"> </span>that<span class="_"> </span>each</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">function<span class="_ _16"> </span>manually<span class="_ _16"> </span>restarts<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffd">read<span class="_ _16"> </span></span>or<span class="_ _16"> </span><span class="ffd">write<span class="_ _16"> </span></span>function<span class="_ _16"> </span>if<span class="_ _11"> </span>it<span class="_ _16"> </span>is<span class="_ _16"> </span>interrupted<span class="_ _16"> </span>by<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">return<span class="_"> </span>from<span class="_"> </span>an<span class="_ _13"> </span>application<span class="_"> </span>signal<span class="_"> </span>handler.<span class="_ _13"> </span>T<span class="_ _3"></span>o<span class="_"> </span>be<span class="_"> </span>as<span class="_ _13"> </span>portable<span class="_"> </span>as<span class="_"> </span>possible<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>allow</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_"> </span>interrupted<span class="_"> </span>system<span class="_"> </span>calls<span class="_"> </span>and<span class="_"> </span>restart<span class="_"> </span>them<span class="_"> </span>when<span class="_"> </span>necessary<span class="_ _3"></span>.</div><div class="t m5 x1d h41 y77c9 ffe fs29 fc2 sc0 ls0 ws0">10.5.2<span class="_ _48"> </span><span class="ff1b fs19">Rio<span class="_ _11"> </span><span class="ffe">Buffered<span class="_"> </span>Input<span class="_"> </span>Functions</span></span></div><div class="t m5 x1d h26 y77ca ff7 fs19 fc2 sc0 ls0 ws0">Suppose<span class="_ _6"> </span>we<span class="_ _13"> </span>wanted<span class="_ _a"> </span>to<span class="_ _13"> </span>write<span class="_ _6"> </span>a<span class="_ _6"> </span>program<span class="_ _13"> </span>that<span class="_ _a"> </span>counts<span class="_ _13"> </span>the<span class="_ _6"> </span>number<span class="_ _6"> </span>of<span class="_ _13"> </span>lines<span class="_ _a"> </span>in<span class="_ _13"> </span>a<span class="_ _6"> </span>text<span class="_ _6"> </span>ﬁle.</div><div class="t m5 x1d h26 y77cb ff7 fs19 fc2 sc0 ls0 ws0">How<span class="_ _13"> </span>might<span class="_ _13"> </span>we<span class="_ _13"> </span>do<span class="_ _6"> </span>this?<span class="_ _13"> </span>One<span class="_ _13"> </span>approach<span class="_ _13"> </span>is<span class="_ _13"> </span>to<span class="_ _13"> </span>use<span class="_ _13"> </span>the<span class="_ _6"> </span><span class="ffd">read<span class="_ _13"> </span></span>function<span class="_ _13"> </span>to<span class="_ _13"> </span>transfer<span class="_ _13"> </span>1<span class="_ _13"> </span>byte</div><div class="t m5 x1d h26 y77cc ff7 fs19 fc2 sc0 ls0 ws0">at<span class="_ _11"> </span>a<span class="_ _16"> </span>time<span class="_ _11"> </span>from<span class="_ _11"> </span>the<span class="_ _16"> </span>ﬁle<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span>user’s<span class="_"> </span>memory<span class="_ _3"></span>,<span class="_ _16"> </span>checking<span class="_ _11"> </span>each<span class="_ _16"> </span>byte<span class="_ _11"> </span>for<span class="_ _16"> </span>the<span class="_ _11"> </span>newline</div><div class="t m5 x1d h26 y77cd ff7 fs19 fc2 sc0 ls0 ws0">character.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>disadvantage<span class="_ _14"> </span>of<span class="_ _16"> </span>this<span class="_ _16"> </span>approach<span class="_ _16"> </span>is<span class="_ _14"> </span>that<span class="_ _16"> </span>it<span class="_ _16"> </span>is<span class="_ _14"> </span>inefﬁcient,<span class="_ _14"> </span>requiring<span class="_ _16"> </span>a</div><div class="t m5 x1d h26 y77ce ff7 fs19 fc2 sc0 ls0 ws0">trap<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>kernel<span class="_"> </span>to<span class="_"> </span>read<span class="_"> </span>each<span class="_"> </span>byte<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>ﬁle<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y77cf ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_"> </span>better<span class="_"> </span>approach<span class="_"> </span>is<span class="_ _13"> </span>to<span class="_"> </span>call<span class="_"> </span>a<span class="_"> </span>wrapper<span class="_"> </span>function<span class="_"> </span>(<span class="ffd">rio_readlineb</span>)<span class="_ _13"> </span>that<span class="_"> </span>copies</div><div class="t m5 x1d h26 y77d0 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>text<span class="_ _13"> </span>line<span class="_ _6"> </span>from<span class="_ _13"> </span>an<span class="_ _13"> </span>internal<span class="_ _13"> </span><span class="ffa">read<span class="_ _13"> </span>buffer</span>,<span class="_"> </span>automatically<span class="_ _6"> </span>making<span class="_ _13"> </span>a<span class="_ _13"> </span><span class="ffd">read<span class="_ _13"> </span></span>call<span class="_ _13"> </span>to<span class="_ _6"> </span>reﬁll</div><div class="t m5 x1d h26 y77d1 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>buffer<span class="_ _16"> </span>whenever<span class="_ _11"> </span>it<span class="_ _11"> </span>becomes<span class="_ _16"> </span>empty<span class="_ _3"></span>.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _16"> </span>ﬁles<span class="_ _11"> </span>that<span class="_ _11"> </span>contain<span class="_ _16"> </span>both<span class="_ _11"> </span>text<span class="_ _16"> </span>lines<span class="_ _11"> </span>and</div><div class="t m5 x1d h26 y77d2 ff7 fs19 fc2 sc0 ls0 ws0">binary<span class="_ _14"> </span>data<span class="_ _14"> </span>(such<span class="_ _14"> </span>as<span class="_ _14"> </span>the<span class="_ _14"> </span>HTTP<span class="_ _14"> </span>responses<span class="_ _15"> </span>described<span class="_ _14"> </span>in<span class="_ _14"> </span>Section<span class="_ _14"> </span>11.5.3),<span class="_ _15"> </span>we<span class="_ _14"> </span>also</div><div class="t m5 x1d h26 y77d3 ff7 fs19 fc2 sc0 ls0 ws0">provide<span class="_ _16"> </span>a<span class="_ _11"> </span>buffered<span class="_ _16"> </span>version<span class="_ _16"> </span>of<span class="_ _11"> </span><span class="ffd">rio_readn</span>,<span class="_ _16"> </span>called<span class="_ _16"> </span><span class="ffd">rio_readnb</span>,<span class="_ _16"> </span>that<span class="_ _11"> </span>transfers<span class="_ _16"> </span>raw</div><div class="t m5 x1d h26 y77d4 ff7 fs19 fc2 sc0 ls0 ws0">bytes<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>same<span class="_"> </span>read<span class="_"> </span>buffer<span class="_"> </span>as<span class="_"> </span><span class="ffd">rio_readlineb</span>.</div><div class="t m5 x126 h2d y77d5 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</div><div class="t m5 x126 h2d y77d6 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>rio_readinitb(rio_t<span class="_ _1f"> </span>*rp,<span class="_ _1f"> </span>int<span class="_ _e"> </span>fd);</div><div class="t m5 x46 hf1 y77d7 ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>nothing</div><div class="t m5 x126 h2d y77d8 ffd fs1e fc2 sc0 ls0 ws0">ssize_t<span class="_ _e"> </span>rio_readlineb(rio_t<span class="_ _1f"> </span>*rp,<span class="_ _1f"> </span>void<span class="_ _e"> </span>*usrbuf,<span class="_ _1f"> </span>size_t<span class="_ _e"> </span>maxlen);</div><div class="t m5 x126 h2d y77d9 ffd fs1e fc2 sc0 ls0 ws0">ssize_t<span class="_ _e"> </span>rio_readnb(rio_t<span class="_ _1f"> </span>*rp,<span class="_ _1f"> </span>void<span class="_ _e"> </span>*usrbuf,<span class="_ _1f"> </span>size_t<span class="_ _e"> </span>n);</div><div class="t m5 xdd hf2 y77da ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>number<span class="_"> </span>of<span class="_"> </span>bytes<span class="_"> </span>read<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span>0<span class="_"> </span>on<span class="_"> </span>EOF<span class="_ _3"></span>,<span class="_"> </span><span class="ff12">−</span>1<span class="_ _13"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y2155 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _11"> </span><span class="ffd ls0">rio_readinitb<span class="_ _10"> </span><span class="ff7">function<span class="_ _11"> </span>is<span class="_"> </span>called<span class="_"> </span>once<span class="_"> </span>per<span class="_"> </span>open<span class="_"> </span>descriptor.<span class="_"> </span>It<span class="_"> </span>associates<span class="_"> </span>the</span></span></div><div class="t m5 x1d h26 y4814 ff7 fs19 fc2 sc0 ls0 ws0">descriptor<span class="_"> </span><span class="ffd">fd<span class="_ _10"> </span></span>with<span class="_"> </span>a<span class="_"> </span>read<span class="_"> </span>buffer<span class="_"> </span>of<span class="_"> </span>type<span class="_"> </span><span class="ffd">rio_t<span class="_ _10"> </span></span>at<span class="_"> </span>address<span class="_"> </span><span class="ffd">rp</span>.</div><div class="t m5 x29 h26 y5310 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">rio_readlineb<span class="_ _11"> </span><span class="ff7">function<span class="_ _11"> </span>reads<span class="_ _16"> </span>the<span class="_"> </span>next<span class="_ _11"> </span>text<span class="_ _16"> </span>line<span class="_"> </span>from<span class="_ _16"> </span>ﬁle<span class="_"> </span></span>rp<span class="_ _16"> </span><span class="ff7">(including</span></span></div><div class="t m5 x1d h26 y5311 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _15"> </span>terminating<span class="_ _15"> </span>newline<span class="_ _21"> </span>character),<span class="_ _f"> </span>copies<span class="_ _15"> </span>it<span class="_ _21"> </span>to<span class="_ _15"> </span>memory<span class="_ _15"> </span>location<span class="_ _21"> </span><span class="ffd">usrbuf</span>,<span class="_ _f"> </span>and</div><div class="t m5 x1d h26 y5312 ff7 fs19 fc2 sc0 ls0 ws0">terminates<span class="_ _15"> </span>the<span class="_ _15"> </span>text<span class="_ _21"> </span>line<span class="_ _15"> </span>with<span class="_ _15"> </span>the<span class="_ _21"> </span>NULL<span class="_ _15"> </span>(zero)<span class="_ _21"> </span>character.<span class="_ _14"> </span>The<span class="_ _14"> </span><span class="ffd">rio_readlineb</span></div><div class="t m5 x1d h26 y5313 ff7 fs19 fc2 sc0 ls0 ws0">function<span class="_ _11"> </span>reads<span class="_ _11"> </span>at<span class="_ _11"> </span>most<span class="_ _16"> </span><span class="ffd">maxlen-1<span class="_ _11"> </span></span>bytes<span class="_ _1"></span>,<span class="_ _11"> </span>leaving<span class="_ _11"> </span>room<span class="_ _16"> </span>for<span class="_"> </span>the<span class="_ _16"> </span>terminating<span class="_"> </span>NULL</div><div class="t m5 x1d h26 y5314 ff7 fs19 fc2 sc0 ls0 ws0">character.<span class="_ _16"> </span>T<span class="_ _7"></span>ext<span class="_ _15"> </span>lines<span class="_ _14"> </span>that<span class="_ _14"> </span>exceed<span class="_ _14"> </span><span class="ffd">maxlen-1<span class="_ _14"> </span></span>bytes<span class="_ _14"> </span>are<span class="_ _14"> </span>truncated<span class="_ _14"> </span>and<span class="_ _14"> </span>terminated</div><div class="t m5 x1d h26 y5315 ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_"> </span>a<span class="_"> </span>NULL<span class="_"> </span>character.</div><div class="t m5 x29 h26 y5316 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _10"> </span><span class="ffd ls0">rio_readnb<span class="_ _10"> </span><span class="ff7">function<span class="_ _13"> </span>reads<span class="_ _13"> </span>up<span class="_"> </span>to<span class="_ _13"> </span></span>n<span class="_ _13"> </span><span class="ff7">bytes<span class="_"> </span>from<span class="_ _13"> </span>ﬁle<span class="_ _13"> </span></span>rp<span class="_ _10"> </span><span class="ff7">to<span class="_ _13"> </span>memory<span class="_"> </span>location</span></span></div><div class="t m5 x1d h26 y5317 ffd fs19 fc2 sc0 ls0 ws0">usrbuf<span class="ff7">.<span class="_ _16"> </span>Calls<span class="_ _16"> </span>to<span class="_ _16"> </span></span>rio_readlineb<span class="_ _16"> </span><span class="ff7">and<span class="_ _16"> </span></span>rio_readnb<span class="_ _16"> </span><span class="ff7">can<span class="_ _16"> </span>be<span class="_ _11"> </span>interleaved<span class="_ _16"> </span>arbitrarily</span></div><div class="t m5 x1d h26 y5318 ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_"> </span>the<span class="_"> </span>same<span class="_"> </span>descriptor.<span class="_"> </span>However,<span class="_"> </span>calls<span class="_"> </span>to<span class="_"> </span>these<span class="_"> </span>buffered<span class="_"> </span>functions<span class="_"> </span>should<span class="_"> </span>not<span class="_"> </span>be</div><div class="t m5 x1d h26 y5319 ff7 fs19 fc2 sc0 ls0 ws0">interleaved<span class="_"> </span>with<span class="_"> </span>calls<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>unbuffered<span class="_"> </span><span class="ffd">rio_readn<span class="_ _10"> </span></span>function.</div><div class="t m5 x29 h26 y531a ff7 fs19 fc2 sc0 ls0 ws0">Y<span class="_ _3"></span>ou<span class="_ _13"> </span>will<span class="_ _13"> </span>encounter<span class="_ _13"> </span>numerous<span class="_ _13"> </span>examples<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_"> </span><span class="ff9">Rio<span class="_ _13"> </span></span>functions<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>remainder</div><div class="t m5 x1d h26 y531b ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _13"> </span>this<span class="_ _13"> </span>text.<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>10.5<span class="_ _13"> </span>shows<span class="_"> </span>how<span class="_ _13"> </span>to<span class="_ _13"> </span>use<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ff9">Rio<span class="_ _13"> </span></span>functions<span class="_"> </span>to<span class="_ _13"> </span>copy<span class="_ _13"> </span>a<span class="_ _13"> </span>text<span class="_ _13"> </span>ﬁle<span class="_"> </span>from</div><div class="t m5 x1d h26 y531c ff7 fs19 fc2 sc0 ls0 ws0">standard<span class="_"> </span>input<span class="_"> </span>to<span class="_"> </span>standard<span class="_"> </span>output,<span class="_"> </span>one<span class="_"> </span>line<span class="_"> </span>at<span class="_"> </span>a<span class="_"> </span>time<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y531d ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>10.6<span class="_ _14"> </span>shows<span class="_ _15"> </span>the<span class="_ _14"> </span>format<span class="_ _14"> </span>of<span class="_ _14"> </span>a<span class="_ _14"> </span>read<span class="_ _14"> </span>buffer,<span class="_ _14"> </span>along<span class="_ _14"> </span>with<span class="_ _14"> </span>the<span class="_ _14"> </span>code<span class="_ _14"> </span>for<span class="_ _15"> </span>the</div><div class="t m5 x1d h26 y531e ffd fs19 fc2 sc0 ls0 ws0">rio_readinitb<span class="_ _16"> </span><span class="ff7">function<span class="_ _16"> </span>that<span class="_ _16"> </span>initializes<span class="_ _16"> </span>it.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span><span class="ffd">rio_readinitb<span class="_ _16"> </span></span>function<span class="_ _16"> </span>sets<span class="_ _16"> </span>up</span></div><div class="t m5 x1d h26 y531f ff7 fs19 fc2 sc0 ls0 ws0">an<span class="_"> </span>empty<span class="_"> </span>read<span class="_"> </span>buffer<span class="_"> </span>and<span class="_"> </span>associates<span class="_"> </span>an<span class="_"> </span>open<span class="_"> </span>ﬁle<span class="_"> </span>descriptor<span class="_"> </span>with<span class="_"> </span>that<span class="_"> </span>buffer.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
