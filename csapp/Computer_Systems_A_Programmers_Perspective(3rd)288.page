<div id="pf120" class="pf w2 h11" data-page-no="120"><div class="pc pc120 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg120.png"/><div class="t m5 xb5 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.7<span class="_ _60"> </span>Procedures<span class="_ _3e"> </span><span class="ffe fs1e">287</span></div><div class="t m5 x17 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>3.33</div><div class="t m5 x17 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Stack<span class="_"> </span>frame<span class="_ _16"> </span>for<span class="_"> </span>function</div><div class="t m5 x17 h3a y609 ffd fs19 fc1 sc0 ls0 ws0">call_proc<span class="ffe fs16">.<span class="_ _16"> </span><span class="ff6">The<span class="_ _14"> </span>stack</span></span></div><div class="t m5 x17 h34 y60a ff6 fs16 fc1 sc0 ls0 ws0">frame<span class="_ _15"> </span>contains<span class="_ _15"> </span>local</div><div class="t m5 x17 h34 y2a12 ff6 fs16 fc1 sc0 ls0 ws0">variables,<span class="_ _11"> </span>as<span class="_ _10"> </span>well<span class="_ _11"> </span>as<span class="_ _11"> </span>two<span class="_ _11"> </span>of</div><div class="t m5 x17 h34 y2a13 ff6 fs16 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>arguments<span class="_ _16"> </span>to<span class="_ _11"> </span>pass<span class="_ _16"> </span>to</div><div class="t m5 x17 h34 y2a14 ff6 fs16 fc1 sc0 ls0 ws0">function</div><div class="t m5 x30 h3a y2a15 ffd fs19 fc1 sc0 ls0 ws0">proc<span class="ff6 fs16">.</span></div><div class="t m5 x84 h3f y2a16 ff26 fs27 fc1 sc0 ls0 ws0">Stack pointer</div><div class="t m5 x84 h40 y2a17 ff22 fs28 fc1 sc0 ls0 ws0">%rsp</div><div class="t m5 x110 h40 y2a18 ff26 fs27 fc1 sc0 ls0 ws0">Argument 8 = <span class="ff22 fs28 ls170">&amp;x4</span></div><div class="t m5 xa8 h3f y2a19 ff26 fs27 fc1 sc0 ls0 ws0">Argument 7</div><div class="t m5 x206 h3f y2a1a ff26 fs27 fc1 sc0 ls0 ws0">Return address</div><div class="t m5 x18 h40 y2a1b ff22 fs28 fc1 sc0 ls0 ws0">x1</div><div class="t m5 x19b h44 y2a1c ff26 fs2a fc1 sc0 ls171 ws0">32</div><div class="t m5 x19b h44 y2a1d ff26 fs2a fc1 sc0 ls171 ws0">24</div><div class="t m5 x19b h44 y2a1e ff26 fs2a fc1 sc0 ls171 ws0">16</div><div class="t m5 xfb h44 y2a1f ff26 fs2a fc1 sc0 ls0 ws0">8</div><div class="t m5 xfb h44 y2a20 ff26 fs2a fc1 sc0 ls0 ws0">0</div><div class="t m5 xd8 h44 y2a21 ff26 fs2a fc1 sc0 ls171 ws0">17<span class="_ _167"></span>18<span class="_ _11d"></span>20</div><div class="t m5 x208 h40 y2a22 ff22 fs28 fc1 sc0 ls0 ws0">x4<span class="_ _168"></span>x3<span class="_ _109"></span>x2<span class="_ _169"> </span>x4</div><div class="t m5 xf5 h40 y2a23 ff22 fs28 fc1 sc0 ls0 ws0">4</div><div class="t m5 x26 h26 y2a24 ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _16"> </span>procedure<span class="_ _16"> </span><span class="ffd">proc<span class="_ _14"> </span></span>is<span class="_ _14"> </span>called,<span class="_ _14"> </span>the<span class="_ _14"> </span>program<span class="_ _14"> </span>will<span class="_ _16"> </span>begin<span class="_ _14"> </span>executing<span class="_ _14"> </span>the<span class="_ _16"> </span>code</div><div class="t m5 x17 h26 y2a25 ff7 fs19 fc1 sc0 ls0 ws0">shown<span class="_ _14"> </span>in<span class="_ _14"> </span>Figure<span class="_ _14"> </span>3.29(b).<span class="_ _14"> </span>As<span class="_ _14"> </span>shown<span class="_ _15"> </span>in<span class="_ _14"> </span>Figure<span class="_ _16"> </span>3.30,<span class="_ _21"> </span>arguments<span class="_ _14"> </span>7<span class="_ _15"> </span>and<span class="_ _14"> </span>8<span class="_ _15"> </span>are<span class="_ _14"> </span>now</div><div class="t m5 x17 h26 y2a26 ff7 fs19 fc1 sc0 ls0 ws0">at<span class="_ _16"> </span>offsets<span class="_ _16"> </span>8<span class="_ _16"> </span>and<span class="_ _16"> </span>16<span class="_ _16"> </span>relative<span class="_ _16"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>stack<span class="_ _16"> </span>pointer,<span class="_ _16"> </span>because<span class="_ _16"> </span>the<span class="_ _16"> </span>return<span class="_ _16"> </span>address<span class="_ _16"> </span>was</div><div class="t m5 x17 h26 y2a27 ff7 fs19 fc1 sc0 ls0 ws0">pushed<span class="_"> </span>onto<span class="_"> </span>the<span class="_"> </span>stack.</div><div class="t m5 x26 h26 y2a28 ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _13"> </span>the<span class="_"> </span>program<span class="_ _13"> </span>returns<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">call_proc</span>,<span class="_"> </span>the<span class="_ _13"> </span>code<span class="_"> </span>retrieves<span class="_ _13"> </span>the<span class="_"> </span>values<span class="_ _13"> </span>of<span class="_"> </span>the</div><div class="t m5 x17 h26 y2a29 ff7 fs19 fc1 sc0 ls0 ws0">four<span class="_"> </span>local<span class="_"> </span>variables<span class="_ _11"> </span>(lines<span class="_"> </span>17–20)<span class="_ _11"> </span>and<span class="_"> </span>performs<span class="_"> </span>the<span class="_ _11"> </span>ﬁnal<span class="_"> </span>computations<span class="_ _1"></span>.<span class="_ _11"> </span>It<span class="_"> </span>ﬁnishes</div><div class="t m5 x17 h26 y2a2a ff7 fs19 fc1 sc0 ls0 ws0">by<span class="_"> </span>incrementing<span class="_"> </span>the<span class="_"> </span>stack<span class="_"> </span>pointer<span class="_"> </span>by<span class="_"> </span>32<span class="_"> </span>to<span class="_"> </span>deallocate<span class="_"> </span>the<span class="_"> </span>stack<span class="_"> </span>frame<span class="_ _1"></span>.</div><div class="t m5 x17 h41 y2a2b ffe fs29 fc1 sc0 ls0 ws0">3.7.5<span class="_ _48"> </span><span class="fs19">Local<span class="_"> </span>Storage<span class="_"> </span>in<span class="_"> </span>Registers</span></div><div class="t m5 x17 h26 y89a ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>set<span class="_"> </span>of<span class="_ _16"> </span>program<span class="_ _11"> </span>registers<span class="_ _11"> </span>acts<span class="_ _11"> </span>as<span class="_ _16"> </span>a<span class="_"> </span>single<span class="_ _16"> </span>resource<span class="_ _11"> </span>shared<span class="_ _11"> </span>by<span class="_ _11"> </span>all<span class="_ _16"> </span>of<span class="_"> </span>the<span class="_ _16"> </span>proce-</div><div class="t m5 x17 h26 y89b ff7 fs19 fc1 sc0 ls0 ws0">dures<span class="_ _1"></span>.<span class="_"> </span>Although<span class="_"> </span>only<span class="_"> </span>one<span class="_"> </span>procedure<span class="_"> </span>can<span class="_ _13"> </span>be<span class="_"> </span>active<span class="_"> </span>at<span class="_"> </span>a<span class="_"> </span>given<span class="_"> </span>time<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>must<span class="_"> </span>make</div><div class="t m5 x17 h26 y89c ff7 fs19 fc1 sc0 ls0 ws0">sure<span class="_ _13"> </span>that<span class="_ _6"> </span>when<span class="_ _13"> </span>one<span class="_ _6"> </span>procedure<span class="_ _13"> </span>(the<span class="_ _6"> </span><span class="ffa">caller<span class="_ _2"></span></span>)<span class="_ _13"> </span>calls<span class="_ _6"> </span>another<span class="_ _13"> </span>(the<span class="_ _13"> </span><span class="ffa">callee</span>),<span class="_ _13"> </span>the<span class="_ _6"> </span>callee<span class="_ _13"> </span>does</div><div class="t m5 x17 h26 y89d ff7 fs19 fc1 sc0 ls0 ws0">not<span class="_ _13"> </span>overwrite<span class="_ _13"> </span>some<span class="_"> </span>register<span class="_ _13"> </span>value<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_"> </span>caller<span class="_ _13"> </span>planned<span class="_ _13"> </span>to<span class="_ _13"> </span>use<span class="_ _13"> </span>later.<span class="_ _13"> </span>F<span class="_ _1"></span>or<span class="_"> </span>this<span class="_ _13"> </span>rea-</div><div class="t m5 x17 h26 y89e ff7 fs19 fc1 sc0 ls0 ws0">son,<span class="_ _16"> </span>x86-64<span class="_ _16"> </span>adopts<span class="_ _16"> </span>a<span class="_ _16"> </span>uniform<span class="_ _16"> </span>set<span class="_ _16"> </span>of<span class="_ _16"> </span>conventions<span class="_ _16"> </span>for<span class="_ _16"> </span>register<span class="_ _16"> </span>usage<span class="_ _16"> </span>that<span class="_ _16"> </span>must<span class="_ _16"> </span>be</div><div class="t m5 x17 h26 y89f ff7 fs19 fc1 sc0 ls0 ws0">respected<span class="_"> </span>by<span class="_"> </span>all<span class="_"> </span>procedures<span class="_ _1"></span>,<span class="_"> </span>including<span class="_"> </span>those<span class="_"> </span>in<span class="_"> </span>program<span class="_"> </span>libraries<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y8a0 ff7 fs19 fc1 sc0 ls0 ws0">By<span class="_ _16"> </span>convention,<span class="_ _16"> </span>registers<span class="_ _16"> </span><span class="ffd">%rbx</span>,<span class="_ _16"> </span><span class="ffd">%rbp</span>,<span class="_ _16"> </span>and<span class="_ _16"> </span><span class="ffd">%r12</span>–<span class="ffd">%r15<span class="_ _16"> </span></span>are<span class="_ _16"> </span>classiﬁed<span class="_ _11"> </span>as<span class="_ _16"> </span><span class="ffa">callee-</span></div><div class="t m5 x17 h26 y8a1 ffa fs19 fc1 sc0 ls0 ws0">saved<span class="_ _16"> </span><span class="ff7">registers<span class="_ _1"></span>.<span class="_ _11"> </span>When<span class="_ _11"> </span>procedure<span class="_ _16"> </span><span class="ffd">P<span class="_ _11"> </span></span>calls<span class="_ _16"> </span>procedure<span class="_ _11"> </span><span class="ffd">Q</span>,<span class="_ _16"> </span><span class="ffd">Q<span class="_ _16"> </span></span>must<span class="_ _11"> </span><span class="ffa">preserve<span class="_ _16"> </span></span>the<span class="_ _11"> </span>values</span></div><div class="t m5 x17 h26 y8a2 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span>these<span class="_"> </span>registers<span class="_ _1"></span>,<span class="_"> </span>ensuring<span class="_"> </span>that<span class="_"> </span>they<span class="_"> </span>have<span class="_"> </span>the<span class="_"> </span>same<span class="_"> </span>values<span class="_"> </span>when<span class="_"> </span><span class="ffd">Q<span class="_ _11"> </span></span>returns<span class="_"> </span>to<span class="_"> </span><span class="ffd">P<span class="_ _10"> </span></span>as</div><div class="t m5 x17 h26 y8a3 ff7 fs19 fc1 sc0 ls0 ws0">they<span class="_ _13"> </span>did<span class="_ _13"> </span>when<span class="_ _6"> </span><span class="ffd">Q<span class="_ _13"> </span></span>was<span class="_ _13"> </span>called.<span class="_ _13"> </span>Procedure<span class="_ _6"> </span><span class="ffd">Q<span class="_ _13"> </span></span>can<span class="_ _13"> </span>preserve<span class="_ _13"> </span>a<span class="_ _6"> </span>register<span class="_ _13"> </span>value<span class="_ _13"> </span>by<span class="_ _13"> </span>either<span class="_ _6"> </span>not</div><div class="t m5 x17 h26 y8a4 ff7 fs19 fc1 sc0 ls0 ws0">changing<span class="_ _13"> </span>it<span class="_ _13"> </span>at<span class="_ _13"> </span>all<span class="_ _13"> </span>or<span class="_ _13"> </span>by<span class="_ _13"> </span>pushing<span class="_ _13"> </span>the<span class="_ _13"> </span>original<span class="_ _13"> </span>value<span class="_ _13"> </span>on<span class="_ _13"> </span>the<span class="_ _13"> </span>stack,<span class="_ _13"> </span>altering<span class="_ _13"> </span>it,<span class="_"> </span>and<span class="_ _13"> </span>then</div><div class="t m5 x17 h26 y8a5 ff7 fs19 fc1 sc0 ls0 ws0">popping<span class="_ _16"> </span>the<span class="_ _14"> </span>old<span class="_ _14"> </span>value<span class="_ _14"> </span>from<span class="_ _16"> </span>the<span class="_ _14"> </span>stack<span class="_ _14"> </span>before<span class="_ _14"> </span>returning.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span>pushing<span class="_ _14"> </span>of<span class="_ _16"> </span>register</div><div class="t m5 x17 h26 y8a6 ff7 fs19 fc1 sc0 ls0 ws0">values<span class="_ _14"> </span>has<span class="_ _14"> </span>the<span class="_ _16"> </span>effect<span class="_ _14"> </span>of<span class="_ _14"> </span>creating<span class="_ _14"> </span>the<span class="_ _14"> </span>portion<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>stack<span class="_ _14"> </span>frame<span class="_ _14"> </span>labeled<span class="_ _14"> </span>“Saved</div><div class="t m5 x17 h26 y8a7 ff7 fs19 fc1 sc0 ls0 ws0">registers”<span class="_ _16"> </span>in<span class="_ _11"> </span>Figure<span class="_ _11"> </span>3.25.<span class="_ _16"> </span>W<span class="_ _0"></span>ith<span class="_ _16"> </span>this<span class="_ _11"> </span>convention,<span class="_ _14"> </span>the<span class="_ _16"> </span>code<span class="_ _11"> </span>for<span class="_ _16"> </span><span class="ffd">P<span class="_ _16"> </span></span>can<span class="_ _16"> </span>safely<span class="_ _16"> </span>store<span class="_ _11"> </span>a</div><div class="t m5 x17 h26 y8a8 ff7 fs19 fc1 sc0 ls0 ws0">value<span class="_ _16"> </span>in<span class="_ _16"> </span>a<span class="_ _16"> </span>callee-saved<span class="_ _16"> </span>register<span class="_ _16"> </span>(after<span class="_ _16"> </span>saving<span class="_ _16"> </span>the<span class="_ _16"> </span>previous<span class="_ _16"> </span>value<span class="_ _16"> </span>on<span class="_ _16"> </span>the<span class="_ _16"> </span>stack,<span class="_ _16"> </span>of</div><div class="t m5 x17 h26 y8a9 ff7 fs19 fc1 sc0 ls0 ws0">course),<span class="_ _13"> </span>call<span class="_"> </span><span class="ffd">Q</span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>use<span class="_"> </span>the<span class="_ _13"> </span>value<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>register<span class="_"> </span>without<span class="_ _13"> </span>risk<span class="_ _13"> </span>of<span class="_ _13"> </span>it<span class="_ _13"> </span>having<span class="_"> </span>been</div><div class="t m5 x17 h26 y8aa ff7 fs19 fc1 sc0 ls0 ws0">corrupted.</div><div class="t m5 x26 h26 y8ab ff7 fs19 fc1 sc0 ls0 ws0">All<span class="_ _11"> </span>other<span class="_ _11"> </span>registers<span class="_ _1"></span>,<span class="_ _11"> </span>except<span class="_ _11"> </span>for<span class="_ _16"> </span>the<span class="_"> </span>stack<span class="_ _11"> </span>pointer<span class="_ _16"> </span><span class="ffd">%rsp</span>,<span class="_"> </span>are<span class="_ _16"> </span>classiﬁed<span class="_"> </span>as<span class="_ _11"> </span><span class="ffa">caller-</span></div><div class="t m5 x17 h26 y8ac ffa fs19 fc1 sc0 ls0 ws0">saved<span class="_ _11"> </span><span class="ff7">registers<span class="_ _1"></span>.<span class="_"> </span>This<span class="_"> </span>means<span class="_"> </span>that<span class="_"> </span>they<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>modiﬁed<span class="_ _11"> </span>by<span class="_"> </span>any<span class="_"> </span>function.<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>name</span></div><div class="t m5 x17 h26 y8ad ff7 fs19 fc1 sc0 ls0 ws0">“caller<span class="_ _6"> </span>saved”<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _13"> </span>understood<span class="_ _6"> </span>in<span class="_ _13"> </span>the<span class="_ _6"> </span>context<span class="_ _13"> </span>of<span class="_ _6"> </span>a<span class="_ _13"> </span>procedure<span class="_ _6"> </span><span class="ffd">P<span class="_ _13"> </span></span>having<span class="_ _6"> </span>some<span class="_ _13"> </span>local</div><div class="t m5 x17 h26 y8ae ff7 fs19 fc1 sc0 ls0 ws0">data<span class="_ _13"> </span>in<span class="_"> </span>such<span class="_ _13"> </span>a<span class="_ _13"> </span>register<span class="_"> </span>and<span class="_ _13"> </span>calling<span class="_"> </span>procedure<span class="_ _13"> </span><span class="ffd">Q</span>.<span class="_ _13"> </span>Since<span class="_"> </span><span class="ffd">Q<span class="_ _13"> </span></span>is<span class="_ _13"> </span>free<span class="_"> </span>to<span class="_ _13"> </span>alter<span class="_ _13"> </span>this<span class="_"> </span>register<span class="_ _0"></span>,</div><div class="t m5 x17 h26 y8af ff7 fs19 fc1 sc0 ls0 ws0">it<span class="_"> </span>is<span class="_"> </span>incumbent<span class="_"> </span>upon<span class="_"> </span><span class="ffd">P<span class="_ _10"> </span></span>(the<span class="_"> </span>caller)<span class="_"> </span>to<span class="_"> </span>ﬁrst<span class="_"> </span>save<span class="_"> </span>the<span class="_"> </span>data<span class="_"> </span>before<span class="_"> </span>it<span class="_"> </span>makes<span class="_"> </span>the<span class="_"> </span>call.</div><div class="t m5 x26 h26 y8b0 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _6"> </span>an<span class="_ _13"> </span>example<span class="_ _1"></span>,<span class="_ _13"> </span>consider<span class="_ _a"> </span>the<span class="_ _13"> </span>function<span class="_ _6"> </span><span class="ffd">P<span class="_ _6"> </span></span>shown<span class="_ _13"> </span>in<span class="_ _6"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>3.34(a).<span class="_ _6"> </span>It<span class="_ _6"> </span>calls<span class="_ _13"> </span><span class="ffd">Q<span class="_ _a"> </span></span>twice.</div><div class="t m5 x17 h26 y8b1 ff7 fs19 fc1 sc0 ls0 ws0">During<span class="_ _16"> </span>the<span class="_ _11"> </span>ﬁrst<span class="_ _16"> </span>call,<span class="_ _16"> </span>it<span class="_ _16"> </span>must<span class="_ _16"> </span>retain<span class="_ _16"> </span>the<span class="_ _16"> </span>value<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffd">x<span class="_ _16"> </span></span>for<span class="_ _16"> </span>use<span class="_ _11"> </span>later.<span class="_ _16"> </span>Similarly<span class="_ _3"></span>,<span class="_ _16"> </span>during</div><div class="t m5 x17 h26 y8b2 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _14"> </span>second<span class="_ _14"> </span>call,<span class="_ _15"> </span>it<span class="_ _15"> </span>must<span class="_ _14"> </span>retain<span class="_ _14"> </span>the<span class="_ _14"> </span>value<span class="_ _15"> </span>computed<span class="_ _14"> </span>for<span class="_ _14"> </span><span class="ffd">Q(y)</span>.<span class="_ _15"> </span>In<span class="_ _14"> </span>F<span class="_ _0"></span>igure<span class="_ _14"> </span>3.34(b),</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
