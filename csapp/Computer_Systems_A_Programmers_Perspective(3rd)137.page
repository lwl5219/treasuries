<div id="pf89" class="pf w2 h11" data-page-no="89"><div class="pc pc89 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg89.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">136<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>2<span class="_ _3d"> </span>Representing<span class="_ _10"> </span>and<span class="_ _10"> </span>Manipulating<span class="_ _10"> </span>Information</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Security<span class="_ _11"> </span>vulnerability<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _16"> </span>XDR<span class="_ _11"> </span>library</span></div><div class="t m5 x55 h2b y258 ff7 fs1e fc2 sc0 ls0 ws0">In<span class="_"> </span>2002,<span class="_ _11"> </span>it<span class="_ _11"> </span>was<span class="_ _10"> </span>discovered<span class="_ _11"> </span>that<span class="_ _10"> </span>code<span class="_ _11"> </span>supplied<span class="_ _11"> </span>by<span class="_"> </span>Sun<span class="_ _11"> </span>Microsystems<span class="_ _10"> </span>to<span class="_ _11"> </span>implement<span class="_ _11"> </span>the<span class="_"> </span>XDR<span class="_ _11"> </span>library<span class="_ _3"></span>,<span class="_ _11"> </span>a</div><div class="t m5 x28 h2b y259 ff7 fs1e fc2 sc0 ls0 ws0">widely<span class="_"> </span>used<span class="_ _11"> </span>facility<span class="_"> </span>for<span class="_ _11"> </span>sharing<span class="_"> </span>data<span class="_ _11"> </span>structures<span class="_"> </span>between<span class="_ _11"> </span>programs<span class="_ _1"></span>,<span class="_ _11"> </span>had<span class="_"> </span>a<span class="_ _11"> </span>security<span class="_"> </span>vulnerability<span class="_ _11"> </span>arising</div><div class="t m5 x28 h2b y25a ff7 fs1e fc2 sc0 ls0 ws0">from<span class="_"> </span>the<span class="_"> </span>fact<span class="_"> </span>that<span class="_"> </span>multiplication<span class="_"> </span>can<span class="_"> </span>overﬂow<span class="_"> </span>without<span class="_"> </span>any<span class="_"> </span>notice<span class="_"> </span>being<span class="_"> </span>given<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>program.</div><div class="t m5 x57 h2b y4e2 ff7 fs1e fc2 sc0 ls0 ws0">Code<span class="_"> </span>similar<span class="_"> </span>to<span class="_"> </span>that<span class="_"> </span>containing<span class="_"> </span>the<span class="_"> </span>vulnerability<span class="_"> </span>is<span class="_"> </span>shown<span class="_"> </span>below:</div><div class="t m5 xc6 h2d y120a ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Illustration<span class="_ _e"> </span>of<span class="_ _1f"> </span>code<span class="_ _1f"> </span>vulnerability<span class="_ _e"> </span>similar<span class="_ _1f"> </span>to<span class="_ _e"> </span>that<span class="_ _1f"> </span>found<span class="_ _1f"> </span>in</span></div><div class="t m5 xc6 h2d y120b ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _1f"> </span>Sun’s<span class="_ _e"> </span>XDR<span class="_ _1f"> </span>library.</span></div><div class="t m5 xc6 h2d y120c ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _73"> </span><span class="ffd fs1e fc2">*/</span></div><div class="t m5 xc6 h2d y120d ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">void*<span class="_ _1f"> </span>copy_elements(void<span class="_ _e"> </span>*ele_src[],<span class="_ _1f"> </span>int<span class="_ _1f"> </span>ele_cnt,<span class="_ _e"> </span>size_t<span class="_ _1f"> </span>ele_size)<span class="_ _e"> </span>{</span></div><div class="t m5 xc6 h2e y1524 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x35 h2d y120f ffd fs1e fc2 sc0 ls0 ws0">/*</div><div class="t m5 xc6 h2d y1210 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _ed"> </span><span class="ffd fs1e fc2">*<span class="_ _e"> </span>Allocate<span class="_ _1f"> </span>buffer<span class="_ _1f"> </span>for<span class="_ _e"> </span>ele_cnt<span class="_ _1f"> </span>objects,<span class="_ _e"> </span>each<span class="_ _1f"> </span>of<span class="_ _1f"> </span>ele_size<span class="_ _e"> </span>bytes</span></div><div class="t m5 xc6 h2d y1211 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _ed"> </span><span class="ffd fs1e fc2">*<span class="_ _e"> </span>and<span class="_ _1f"> </span>copy<span class="_ _1f"> </span>from<span class="_ _e"> </span>locations<span class="_ _1f"> </span>designated<span class="_ _e"> </span>by<span class="_ _1f"> </span>ele_src</span></div><div class="t m5 xc6 h2d y1213 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _ed"> </span><span class="ffd fs1e fc2">*/</span></div><div class="t m5 xc6 h2d y1214 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">void<span class="_ _e"> </span>*result<span class="_ _1f"> </span>=<span class="_ _1f"> </span>malloc(ele_cnt<span class="_ _e"> </span>*<span class="_ _1f"> </span>ele_size);</span></div><div class="t m5 x28 h2d y1215 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(result<span class="_ _1f"> </span>==<span class="_ _1f"> </span>NULL)</span></div><div class="t m5 x28 h2e y1216 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x1d3 h2d y1525 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>malloc<span class="_ _1f"> </span>failed<span class="_ _1f"> </span>*/</div><div class="t m5 x28 h2d y1218 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>NULL;</span></div><div class="t m5 x28 h2d y1219 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">void<span class="_ _e"> </span>*next<span class="_ _1f"> </span>=<span class="_ _1f"> </span>result;</span></div><div class="t m5 x28 h2d y121a ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i;</span></div><div class="t m5 x28 h2d y121b ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>ele_cnt;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</span></div><div class="t m5 x28 h2d y121c ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _70"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Copy<span class="_ _1f"> </span>object<span class="_ _1f"> </span>i<span class="_ _e"> </span>to<span class="_ _1f"> </span>destination<span class="_ _e"> </span>*/</span></div><div class="t m5 x28 h2d y121d ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _70"> </span><span class="ffd fs1e fc2">memcpy(next,<span class="_ _e"> </span>ele_src[i],<span class="_ _1f"> </span>ele_size);</span></div><div class="t m5 x28 h2d y121e ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _70"> </span><span class="ffd fs1e fc2">/*<span class="_ _e"> </span>Move<span class="_ _1f"> </span>pointer<span class="_ _1f"> </span>to<span class="_ _e"> </span>next<span class="_ _1f"> </span>memory<span class="_ _e"> </span>region<span class="_ _1f"> </span>*/</span></div><div class="t m5 x28 h2d y1526 ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _70"> </span><span class="ffd fs1e fc2">next<span class="_ _e"> </span>+=<span class="_ _1f"> </span>ele_size;</span></div><div class="t m5 x28 h2d y1527 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x28 h2d y1528 ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>result;</span></div><div class="t m5 x28 h2d y1529 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x57 h2b y152a ff7 fs1e fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>function<span class="_"> </span><span class="ffd">copy_elements<span class="_ _13"> </span></span>is<span class="_"> </span>designed<span class="_ _13"> </span>to<span class="_"> </span>copy<span class="_"> </span><span class="ffd">ele_cnt<span class="_ _13"> </span></span>data<span class="_"> </span>structures<span class="_ _3"></span>,<span class="_"> </span>each<span class="_"> </span>consisting<span class="_ _13"> </span>of<span class="_"> </span><span class="ffd">ele_</span></div><div class="t m5 x28 h2b y152b ffd fs1e fc2 sc0 ls0 ws0">size<span class="_ _13"> </span><span class="ff7">bytes<span class="_"> </span>into<span class="_ _13"> </span>a<span class="_"> </span>buffer<span class="_ _13"> </span>allocated<span class="_"> </span>by<span class="_ _13"> </span>the<span class="_"> </span>function<span class="_ _13"> </span>on<span class="_ _13"> </span>line<span class="_"> </span>9.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_"> </span>number<span class="_"> </span>of<span class="_ _13"> </span>bytes<span class="_ _13"> </span>required<span class="_"> </span>is<span class="_ _13"> </span>computed</span></div><div class="t m5 x28 h2b y152c ff7 fs1e fc2 sc0 ls0 ws0">as<span class="_"> </span><span class="ffd">ele_cnt<span class="_ _11"> </span>*<span class="_ _11"> </span>ele_size</span>.</div><div class="t m5 x57 h2b y152d ff7 fs1e fc2 sc0 ls0 ws0">Imagine<span class="_ _1"></span>,<span class="_ _11"> </span>however,<span class="_ _11"> </span>that<span class="_ _10"> </span>a<span class="_ _11"> </span>malicious<span class="_ _11"> </span>programmer<span class="_ _10"> </span>calls<span class="_ _11"> </span>this<span class="_ _11"> </span>function<span class="_ _10"> </span>with<span class="_ _11"> </span><span class="ffd">ele_cnt<span class="_ _11"> </span></span>being<span class="_ _11"> </span>1,048,577</div><div class="t m5 x28 h2b y152e ff7 fs1e fc2 sc0 ls0 ws0">(2</div><div class="t m5 x21c h48 y152f ff7 fs2c fc2 sc0 ls0 ws0">20</div><div class="t m5 x57 h4a y1530 ff12 fs1e fc2 sc0 ls0 ws0">+<span class="_ _13"></span><span class="ff7">1<span class="_ _1"></span>)<span class="_ _13"> </span>and<span class="_ _6"> </span><span class="ffd">ele_size<span class="_ _13"> </span></span>being<span class="_ _6"> </span>4,096<span class="_ _13"> </span>(2</span></div><div class="t m5 x21d h48 y152f ff7 fs2c fc2 sc0 ls0 ws0">12</div><div class="t m5 x48 h2b y1530 ff7 fs1e fc2 sc0 ls0 ws0">)<span class="_ _13"> </span>with<span class="_ _6"> </span>the<span class="_ _13"> </span>program<span class="_ _6"> </span>compiled<span class="_ _13"> </span>for<span class="_ _6"> </span>32<span class="_ _13"> </span>bits<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>hen<span class="_ _13"> </span>the<span class="_ _6"> </span>multiplication</div><div class="t m5 x28 h2b y1531 ff7 fs1e fc2 sc0 ls0 ws0">on<span class="_ _16"> </span>line<span class="_ _16"> </span>9<span class="_ _11"> </span>will<span class="_ _16"> </span>overﬂow<span class="_ _3"></span>,<span class="_ _14"> </span>causing<span class="_ _16"> </span>only<span class="_ _16"> </span>4,096<span class="_ _11"> </span>bytes<span class="_ _16"> </span>to<span class="_ _16"> </span>be<span class="_ _16"> </span>allocated,<span class="_ _16"> </span>rather<span class="_ _16"> </span>than<span class="_ _16"> </span>the<span class="_ _16"> </span>4,294,971,392<span class="_ _16"> </span>bytes</div><div class="t m5 x28 h2b y1532 ff7 fs1e fc2 sc0 ls0 ws0">required<span class="_ _11"> </span>to<span class="_ _16"> </span>hold<span class="_ _16"> </span>that<span class="_ _11"> </span>much<span class="_ _16"> </span>data.<span class="_ _11"> </span>The<span class="_ _11"> </span>loop<span class="_ _16"> </span>starting<span class="_ _11"> </span>at<span class="_ _16"> </span>line<span class="_ _11"> </span>15<span class="_ _16"> </span>will<span class="_ _16"> </span>attempt<span class="_ _11"> </span>to<span class="_ _16"> </span>copy<span class="_ _11"> </span>all<span class="_ _16"> </span>of<span class="_ _16"> </span>those<span class="_ _11"> </span>bytes<span class="_ _1"></span>,</div><div class="t m5 x28 h2b y1533 ff7 fs1e fc2 sc0 ls0 ws0">overrunning<span class="_"> </span>the<span class="_ _13"> </span>end<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>allocated<span class="_"> </span>buffer<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>therefore<span class="_ _13"> </span>corrupting<span class="_ _13"> </span>other<span class="_"> </span>data<span class="_ _13"> </span>structures<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>could</div><div class="t m5 x28 h2b y1534 ff7 fs1e fc2 sc0 ls0 ws0">cause<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>to<span class="_"> </span>crash<span class="_"> </span>or<span class="_"> </span>otherwise<span class="_"> </span>misbehave<span class="_ _1"></span>.</div><div class="t m5 x57 h2b y1535 ff7 fs1e fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>Sun<span class="_ _16"> </span>code<span class="_ _16"> </span>was<span class="_ _16"> </span>used<span class="_ _16"> </span>by<span class="_ _11"> </span>almost<span class="_ _16"> </span>every<span class="_ _16"> </span>operating<span class="_ _16"> </span>system<span class="_ _16"> </span>and<span class="_ _16"> </span>in<span class="_ _11"> </span>such<span class="_ _16"> </span>widely<span class="_ _16"> </span>used<span class="_ _16"> </span>programs<span class="_ _16"> </span>as</div><div class="t m5 x28 h2b y1536 ff7 fs1e fc2 sc0 ls0 ws0">Internet<span class="_ _13"> </span>Explorer<span class="_ _6"> </span>and<span class="_ _13"> </span>the<span class="_ _13"> </span>Kerberos<span class="_ _6"> </span>authentication<span class="_ _13"> </span>system.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>Computer<span class="_ _13"> </span>Emergenc<span class="_ _0"></span>y<span class="_ _13"> </span>Response<span class="_ _6"> </span>T<span class="_ _3"></span>eam</div><div class="t m5 x28 h2b y1537 ff7 fs1e fc2 sc0 ls0 ws0">(CER<span class="_ _1"></span>T),<span class="_"> </span>an<span class="_"> </span>organization<span class="_ _13"> </span>run<span class="_"> </span>by<span class="_ _13"> </span>the<span class="_"> </span>Carnegie<span class="_ _13"> </span>Mellon<span class="_"> </span>Software<span class="_"> </span>Engineering<span class="_ _13"> </span>Institute<span class="_"> </span>to<span class="_ _13"> </span>track<span class="_"> </span>security</div><div class="t m5 x28 h2b y1538 ff7 fs1e fc2 sc0 ls0 ws0">vulnerabilities<span class="_ _13"> </span>and<span class="_ _6"> </span>breaches<span class="_ _1"></span>,<span class="_"> </span>issued<span class="_ _6"> </span>advisory<span class="_ _13"> </span>“CA-2002-25,<span class="_ _3"></span>”<span class="_ _13"> </span>and<span class="_ _13"> </span>many<span class="_ _13"> </span>companies<span class="_ _6"> </span>rushed<span class="_ _13"> </span>to<span class="_ _13"> </span>patch<span class="_ _6"> </span>their</div><div class="t m5 x28 h2b y1539 ff7 fs1e fc2 sc0 ls0 ws0">code<span class="_ _1"></span>.<span class="_"> </span>F<span class="_ _0"></span>ortunately<span class="_ _3"></span>,<span class="_"> </span>there<span class="_"> </span>were<span class="_"> </span>no<span class="_"> </span>reported<span class="_"> </span>security<span class="_"> </span>breaches<span class="_"> </span>caused<span class="_"> </span>by<span class="_"> </span>this<span class="_"> </span>vulnerability<span class="_ _3"></span>.</div><div class="t m5 x57 h2b y153a ff7 fs1e fc2 sc0 ls0 ws0">A<span class="_ _14"> </span>similar<span class="_ _16"> </span>vulnerability<span class="_ _14"> </span>existed<span class="_ _14"> </span>in<span class="_ _14"> </span>many<span class="_ _14"> </span>implementations<span class="_ _14"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>library<span class="_ _14"> </span>function<span class="_ _14"> </span><span class="ffd">calloc</span>.<span class="_ _14"> </span>T<span class="_ _0"></span>hese</div><div class="t m5 x28 h2b y153b ff7 fs1e fc2 sc0 ls0 ws0">have<span class="_"> </span>since<span class="_"> </span>been<span class="_"> </span>patched.<span class="_"> </span>Unfortunately<span class="_ _7"></span>,<span class="_"> </span>many<span class="_"> </span>programmers<span class="_"> </span>call<span class="_"> </span>allocation<span class="_"> </span>functions<span class="_ _1"></span>,<span class="_"> </span>such<span class="_"> </span>as<span class="_"> </span><span class="ffd">malloc</span>,</div><div class="t m5 x28 h2b y153c ff7 fs1e fc2 sc0 ls0 ws0">using<span class="_"> </span>arithmetic<span class="_"> </span>expressions<span class="_"> </span>as<span class="_ _13"> </span>arguments<span class="_ _1"></span>,<span class="_"> </span>without<span class="_"> </span>checking<span class="_"> </span>these<span class="_"> </span>expressions<span class="_"> </span>for<span class="_ _13"> </span>overﬂow<span class="_ _3"></span>.<span class="_"> </span>Writing<span class="_"> </span>a</div><div class="t m5 x28 h2b y153d ff7 fs1e fc2 sc0 ls0 ws0">reliable<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span><span class="ffd">calloc<span class="_ _10"> </span></span>is<span class="_"> </span>left<span class="_"> </span>as<span class="_"> </span>an<span class="_"> </span>exercise<span class="_"> </span>(Problem<span class="_"> </span>2.76).</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
