<div id="pf3aa" class="pf w2 h11" data-page-no="3aa"><div class="pc pc3aa w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3aa.png"/><div class="t m5 x16c h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>10.5<span class="_ _60"> </span>Robust<span class="_ _10"> </span>Reading<span class="_ _10"> </span>and<span class="_ _10"> </span>Writing<span class="_ _10"> </span>with<span class="_ _10"> </span>the<span class="_ _10"> </span><span class="ff1b">Rio<span class="_ _10"> </span></span>Package<span class="_ _1b"> </span><span class="ffe fs1e">937</span></div><div class="t m5 x61 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x2c h2e y280 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x2d h2d yad1 ffd fs1e fc2 sc0 ls0 ws0">static<span class="_ _e"> </span>ssize_t<span class="_ _1f"> </span>rio_read(rio_t<span class="_ _1f"> </span>*rp,<span class="_ _e"> </span>char<span class="_ _1f"> </span>*usrbuf,<span class="_ _e"> </span>size_t<span class="_ _1f"> </span>n)</div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d yad2 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>cnt;</span></div><div class="t m5 x2c h2e yad3 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y61b4 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x142 h2d y285 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(rp-&gt;rio_cnt<span class="_ _1f"> </span>&lt;=<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Refill<span class="_ _e"> </span>if<span class="_ _1f"> </span>buf<span class="_ _1f"> </span>is<span class="_ _e"> </span>empty<span class="_ _1f"> </span>*/</div><div class="t m5 x2c h2d yad4 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _70"> </span><span class="ffd fs1e fc2">rp-&gt;rio_cnt<span class="_ _e"> </span>=<span class="_ _1f"> </span>read(rp-&gt;rio_fd,<span class="_ _1f"> </span>rp-&gt;rio_buf,</span></div><div class="t m5 x2c h2d yad5 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _22a"> </span><span class="ffd fs1e fc2">sizeof(rp-&gt;rio_buf));</span></div><div class="t m5 x2c h2d yad6 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(rp-&gt;rio_cnt<span class="_ _1f"> </span>&lt;<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{</span></div><div class="t m5 x2c h2d y496b ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _d1"> </span><span class="ffd fs1e fc2">if<span class="_ _1f"> </span>(errno<span class="_ _e"> </span>!=<span class="_ _1f"> </span>EINTR)<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Interrupted<span class="_ _1f"> </span>by<span class="_ _e"> </span>sig<span class="_ _1f"> </span>handler<span class="_ _e"> </span>return<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y50d4 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _143"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>-1;</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y61b6 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">else<span class="_ _e"> </span>if<span class="_ _1f"> </span>(rp-&gt;rio_cnt<span class="_ _1f"> </span>==<span class="_ _e"> </span>0)<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>EOF<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y2181 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _d1"> </span><span class="ffd fs1e fc2">return<span class="_ _1f"> </span>0;</span></div><div class="t m5 x17 h2d y554b ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">else</span></div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _d1"> </span><span class="ffd fs1e fc2">rp-&gt;rio_bufptr<span class="_ _1f"> </span>=<span class="_ _e"> </span>rp-&gt;rio_buf;<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Reset<span class="_ _1f"> </span>buffer<span class="_ _1f"> </span>ptr<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x17 h2e y6a25 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x142 h2d y3ec ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Copy<span class="_ _1f"> </span>min(n,<span class="_ _1f"> </span>rp-&gt;rio_cnt)<span class="_ _e"> </span>bytes<span class="_ _1f"> </span>from<span class="_ _e"> </span>internal<span class="_ _1f"> </span>buf<span class="_ _1f"> </span>to<span class="_ _e"> </span>user<span class="_ _1f"> </span>buf<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2 ls33">c<span class="_ _41"></span>n<span class="_ _41"></span>t=n<span class="_ _41"></span>;</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(rp-&gt;rio_cnt<span class="_ _1f"> </span>&lt;<span class="_ _1f"> </span>n)</span></div><div class="t m5 x17 h2d y1ada ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _70"> </span><span class="ffd fs1e fc2">cnt<span class="_ _e"> </span>=<span class="_ _1f"> </span>rp-&gt;rio_cnt;</span></div><div class="t m5 x17 h2d y61b9 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _20"> </span><span class="ffd fs1e fc2">memcpy(usrbuf,<span class="_ _e"> </span>rp-&gt;rio_bufptr,<span class="_ _1f"> </span>cnt);</span></div><div class="t m5 x17 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _20"> </span><span class="ffd fs1e fc2">rp-&gt;rio_bufptr<span class="_ _e"> </span>+=<span class="_ _1f"> </span>cnt;</span></div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">rp-&gt;rio_cnt<span class="_ _e"> </span>-=<span class="_ _1f"> </span>cnt;</span></div><div class="t m5 x17 h2d y3229 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>cnt;</span></div><div class="t m5 x17 h2d y322a ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x61 h2c y77fc ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y77fd ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>10.7<span class="_ _66"> </span><span class="fc1">The<span class="_"> </span>internal</span></div><div class="t m5 x1ac h3a y77fe ffd fs19 fc1 sc0 ls0 ws0">rio_read<span class="_ _10"> </span><span class="ffe fs16">function.</span></div><div class="t m5 x17 h26 y6fe ff7 fs19 fc1 sc0 ls0 ws0">nonempty<span class="_ _3"></span>,<span class="_ _11"> </span><span class="ffd">rio_read<span class="_ _16"> </span></span>copies<span class="_ _11"> </span>the<span class="_ _11"> </span>minimum<span class="_ _16"> </span>of<span class="_ _11"> </span><span class="ffd">n<span class="_ _11"> </span></span>and<span class="_ _16"> </span><span class="ffd">rp-&gt;rio_cnt<span class="_ _11"> </span></span>bytes<span class="_ _11"> </span>from<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y6ff ff7 fs19 fc1 sc0 ls0 ws0">read<span class="_"> </span>buffer<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>user<span class="_"> </span>buffer<span class="_"> </span>and<span class="_"> </span>returns<span class="_"> </span>the<span class="_"> </span>number<span class="_"> </span>of<span class="_"> </span>bytes<span class="_"> </span>copied.</div><div class="t m5 x26 h26 y700 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_"> </span>an<span class="_"> </span>application<span class="_"> </span>program,<span class="_"> </span>the<span class="_ _13"> </span><span class="ffd">rio_read<span class="_ _10"> </span></span>function<span class="_"> </span>has<span class="_"> </span>the<span class="_"> </span>same<span class="_"> </span>semantics<span class="_ _13"> </span>as</div><div class="t m5 x17 h46 y701 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>Linux<span class="_"> </span><span class="ffd">read<span class="_ _13"> </span></span>function.<span class="_ _13"> </span>On<span class="_"> </span>error<span class="_ _1"></span>,<span class="_"> </span>it<span class="_ _13"> </span>returns<span class="_ _13"> </span><span class="ff12">âˆ’</span>1<span class="_ _13"> </span>and<span class="_ _13"> </span>sets<span class="_ _13"> </span><span class="ffd">errno<span class="_ _10"> </span></span>appropriately<span class="_ _7"></span>.<span class="_"> </span>On</div><div class="t m5 x17 h26 y702 ff7 fs19 fc1 sc0 ls0 ws0">EOF<span class="_ _7"></span>,<span class="_ _13"> </span>it<span class="_ _13"> </span>returns<span class="_ _13"> </span>0.<span class="_ _6"> </span>It<span class="_ _13"> </span>returns<span class="_ _13"> </span>a<span class="_ _6"> </span>short<span class="_ _13"> </span>count<span class="_ _13"> </span>if<span class="_ _6"> </span>the<span class="_ _13"> </span>number<span class="_ _13"> </span>of<span class="_ _6"> </span>requested<span class="_ _13"> </span>bytes<span class="_ _13"> </span>exceeds</div><div class="t m5 x17 h26 y703 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>number<span class="_"> </span>of<span class="_ _13"> </span>unread<span class="_"> </span>bytes<span class="_ _13"> </span>in<span class="_"> </span>the<span class="_ _13"> </span>read<span class="_ _13"> </span>buffer.<span class="_ _13"> </span>The<span class="_ _13"> </span>similarity<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>two<span class="_"> </span>functions</div><div class="t m5 x17 h26 y704 ff7 fs19 fc1 sc0 ls0 ws0">makes<span class="_ _16"> </span>it<span class="_ _11"> </span>easy<span class="_ _16"> </span>to<span class="_ _16"> </span>build<span class="_ _11"> </span>different<span class="_ _16"> </span>kinds<span class="_ _11"> </span>of<span class="_ _16"> </span>buffered<span class="_ _16"> </span>read<span class="_ _11"> </span>functions<span class="_ _16"> </span>by<span class="_ _16"> </span>substituting</div><div class="t m5 x17 h26 y705 ffd fs19 fc1 sc0 ls0 ws0">rio_read<span class="_ _10"> </span><span class="ff7">for<span class="_"> </span></span>read<span class="ff7">.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_"> </span>example,<span class="_"> </span>the<span class="_"> </span><span class="ffd">rio_readnb<span class="_ _10"> </span></span>function<span class="_ _11"> </span>in<span class="_"> </span>Figure<span class="_"> </span>10.8<span class="_"> </span>has<span class="_"> </span>the</span></div><div class="t m5 x17 h26 y706 ff7 fs19 fc1 sc0 ls0 ws0">same<span class="_ _11"> </span>structure<span class="_ _11"> </span>as<span class="_ _16"> </span><span class="ffd">rio_readn</span>,<span class="_ _11"> </span>with<span class="_ _16"> </span><span class="ffd">rio_read<span class="_ _11"> </span></span>substituted<span class="_ _11"> </span>for<span class="_ _11"> </span><span class="ffd">read</span>.<span class="_ _16"> </span>Similarly<span class="_ _7"></span>,<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y707 ffd fs19 fc1 sc0 ls0 ws0">rio_readlineb<span class="_ _14"> </span><span class="ff7">routine<span class="_ _15"> </span>in<span class="_ _15"> </span>F<span class="_ _0"></span>igure<span class="_ _14"> </span>10.8<span class="_ _15"> </span>calls<span class="_ _15"> </span><span class="ffd">rio_read<span class="_ _15"> </span></span>at<span class="_ _14"> </span>most<span class="_ _15"> </span><span class="ffd">maxlen-1<span class="_ _15"> </span></span>times<span class="_ _1"></span>.</span></div><div class="t m5 x17 h26 y708 ff7 fs19 fc1 sc0 ls0 ws0">Each<span class="_"> </span>call<span class="_ _13"> </span>returns<span class="_"> </span>1<span class="_ _13"> </span>byte<span class="_"> </span>from<span class="_"> </span>the<span class="_ _13"> </span>read<span class="_"> </span>buffer<span class="_ _0"></span>,<span class="_"> </span>which<span class="_ _13"> </span>is<span class="_"> </span>then<span class="_"> </span>checked<span class="_ _13"> </span>for<span class="_"> </span>being<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y709 ff7 fs19 fc1 sc0 ls0 ws0">terminating<span class="_"> </span>newline<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
