<div id="pf2eb" class="pf w2 h11" data-page-no="2eb"><div class="pc pc2eb w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2eb.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">746<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x53 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/mymalloc.c</div><div class="t m5 x1f h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#ifdef<span class="_ _1f"> </span>LINKTIME</span></div><div class="t m5 x1f h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&lt;stdio.h&gt;</span></div><div class="t m5 x1f h2e y283 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x1f h2e y5fd0 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x4f h2d y284 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*__real_malloc(size_t<span class="_ _1f"> </span>size);</div><div class="t m5 x1f h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>__real_free(void<span class="_ _e"> </span>*ptr);</span></div><div class="t m5 x1f h2e y286 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x1f h2e y6298 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x4f h2d y287 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>malloc<span class="_ _1f"> </span>wrapper<span class="_ _1f"> </span>function<span class="_ _e"> </span>*/</div><div class="t m5 x1f h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>*__wrap_malloc(size_t<span class="_ _e"> </span>size)</span></div><div class="t m5 x1f h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1b0 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">void<span class="_ _e"> </span>*ptr<span class="_ _1f"> </span>=<span class="_ _1f"> </span>__real_malloc(size);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Call<span class="_ _e"> </span>libc<span class="_ _1f"> </span>malloc<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1b0 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;malloc(%d)<span class="_ _e"> </span>=<span class="_ _1f"> </span>%p\n&quot;,<span class="_ _1f"> </span>(int)size,<span class="_ _e"> </span>ptr);</span></div><div class="t m5 x1b0 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>ptr;</span></div><div class="t m5 x1b0 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2e y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x1b0 h2e y6299 ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x4f h2d y4a9f ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>free<span class="_ _1f"> </span>wrapper<span class="_ _1f"> </span>function<span class="_ _e"> </span>*/</div><div class="t m5 x1b0 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>__wrap_free(void<span class="_ _e"> </span>*ptr)</span></div><div class="t m5 x1b0 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1b0 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">__real_free(ptr);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Call<span class="_ _1f"> </span>libc<span class="_ _e"> </span>free<span class="_ _1f"> </span>*/</span></div><div class="t m5 x1b0 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;free(%p)\n&quot;,<span class="_ _e"> </span>ptr);</span></div><div class="t m5 x1b0 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x4f h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">#endif</div><div class="t m5 x53 h2c y629a ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/mymalloc.c</div><div class="t m5 x1d h2f y629b ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>7.21<span class="_ _66"> </span><span class="fc1">Link-time<span class="_"> </span>interpositioning<span class="_"> </span>with<span class="_"> </span>the</span></div><div class="t m5 x94 h3a y5eb3 ffd fs19 fc1 sc0 ls0 ws0">--wrap<span class="_ _10"> </span><span class="ffe fs16">ﬂag.</span></div><div class="t m5 x1d h26 y629c ff7 fs19 fc1 sc0 ls0 ws0">And<span class="_"> </span>here<span class="_"> </span>is<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>link<span class="_"> </span>the<span class="_"> </span>object<span class="_"> </span>ﬁles<span class="_"> </span>into<span class="_"> </span>an<span class="_"> </span>executable:</div><div class="t m5 x1d h2d y629d ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-Wl,--wrap,malloc<span class="_ _1f"> </span>-Wl,--wrap,free<span class="_ _e"> </span>-o<span class="_ _1f"> </span>intl<span class="_ _e"> </span>int.o<span class="_ _1f"> </span>mymalloc.o</span></div><div class="t m5 x1d h26 y629e ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _e"> </span><span class="ffd ls0">-Wl,option<span class="_ _e"> </span><span class="ff7">ﬂag<span class="_ _21"> </span>passes<span class="_ _e"> </span></span>option<span class="_ _f"> </span><span class="ff7">to<span class="_ _e"> </span>the<span class="_ _f"> </span>linker.<span class="_ _f"> </span>Each<span class="_ _f"> </span>comma<span class="_ _e"> </span>in<span class="_ _f"> </span></span>option<span class="_ _e"> </span><span class="ff7">is</span></span></div><div class="t m5 x1d h26 y629f ff7 fs19 fc2 sc0 ls0 ws0">replaced<span class="_ _6"> </span>with<span class="_ _13"> </span>a<span class="_ _a"> </span>space.<span class="_ _6"> </span>So<span class="_ _6"> </span><span class="ffd">-Wl,--wrap,malloc<span class="_ _13"> </span></span>passes<span class="_ _6"> </span><span class="ffd">--wrap<span class="_ _11"> </span>malloc<span class="_ _13"> </span></span>to<span class="_ _6"> </span>the<span class="_ _6"> </span>linker,</div><div class="t m5 x1d h26 y62a0 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>similarly<span class="_"> </span>for<span class="_"> </span><span class="ffd">-Wl,--wrap,free</span>.</div><div class="t m5 x29 h26 y62a1 ff7 fs19 fc2 sc0 ls0 ws0">Running<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>gives<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>trace:</div><div class="t m5 x1d h2d y62a2 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">./intl</span></div><div class="t m5 x1d h2d y62a3 ffd fs1e fc2 sc0 ls0 ws0">malloc(32)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x18cf010</div><div class="t m5 x1d h2d y62a4 ffd fs1e fc2 sc0 ls0 ws0">free(0x18cf010)</div><div class="t m5 x1d h41 y5647 ffe fs29 fc2 sc0 ls0 ws0">7.13.3<span class="_ _48"> </span><span class="fs19">Run-Time<span class="_"> </span>Interpositioning</span></div><div class="t m5 x1d h26 y2878 ff7 fs19 fc2 sc0 ls0 ws0">Compile-time<span class="_ _16"> </span>interpositioning<span class="_ _16"> </span>requires<span class="_ _11"> </span>access<span class="_ _16"> </span>to<span class="_ _16"> </span>a<span class="_ _16"> </span>program’s<span class="_ _11"> </span>source<span class="_ _16"> </span>ﬁles<span class="_ _1"></span>.<span class="_ _16"> </span>Link-</div><div class="t m5 x1d h26 y2879 ff7 fs19 fc2 sc0 ls0 ws0">time<span class="_ _13"> </span>interpositioning<span class="_ _13"> </span>requires<span class="_ _6"> </span>access<span class="_ _13"> </span>to<span class="_ _13"> </span>its<span class="_ _13"> </span>relocatable<span class="_ _13"> </span>object<span class="_ _13"> </span>ﬁles<span class="_ _3"></span>.<span class="_ _13"> </span>However,<span class="_ _13"> </span>there</div><div class="t m5 x1d h26 y287a ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _16"> </span>a<span class="_ _16"> </span>mechanism<span class="_ _16"> </span>for<span class="_ _14"> </span>interpositioning<span class="_ _16"> </span>at<span class="_ _16"> </span>run<span class="_ _16"> </span>time<span class="_ _14"> </span>that<span class="_ _16"> </span>requires<span class="_ _16"> </span>access<span class="_ _16"> </span>only<span class="_ _16"> </span>to<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y287b ff7 fs19 fc2 sc0 ls0 ws0">executable<span class="_ _13"> </span>object<span class="_ _6"> </span>ﬁle<span class="_ _0"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>his<span class="_ _6"> </span>fascinating<span class="_ _13"> </span>mechanism<span class="_ _13"> </span>is<span class="_ _6"> </span>based<span class="_ _13"> </span>on<span class="_ _6"> </span>the<span class="_ _13"> </span>dynamic<span class="_ _13"> </span>linker’<span class="_ _1"></span>s</div><div class="t m5 x1d h26 y287c ffd fs19 fc2 sc0 ls0 ws0">LD_PRELOAD<span class="_ _10"> </span><span class="ff7">environment<span class="_"> </span>variable<span class="_ _0"></span>.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
