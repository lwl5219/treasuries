<div id="pf133" class="pf w2 h11" data-page-no="133"><div class="pc pc133 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg133.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">306<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1d h2d ye7 ffd fs1e fc2 sc0 ls0 ws0">union<span class="_ _e"> </span>U3<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y2682 ffd fs1e fc2 sc0 ls0 ws0">char<span class="_ _e"> </span>c;</div><div class="t m5 x10c h2d y2683 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>i[2];</div><div class="t m5 x10c h2d y2684 ffd fs1e fc2 sc0 ls0 ws0">double<span class="_ _e"> </span>v;</div><div class="t m5 x1d h2d y2685 ffd fs1e fc2 sc0 ls0 ws0">};</div><div class="t m5 x1d h26 y2c2d ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _11"> </span>compiled<span class="_ _16"> </span>on<span class="_ _11"> </span>an<span class="_ _16"> </span>x86-64<span class="_ _16"> </span>Linux<span class="_ _11"> </span>machine,<span class="_ _11"> </span>the<span class="_ _16"> </span>offsets<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>ﬁelds<span class="_ _1"></span>,<span class="_ _16"> </span>as<span class="_ _11"> </span>well<span class="_ _16"> </span>as</div><div class="t m5 x1d h26 y2c2e ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>total<span class="_"> </span>size<span class="_"> </span>of<span class="_"> </span>data<span class="_"> </span>types<span class="_"> </span><span class="ffd">S3<span class="_ _10"> </span></span>and<span class="_"> </span><span class="ffd">U3</span>,<span class="_"> </span>are<span class="_"> </span>as<span class="_"> </span>shown<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>table:</div><div class="t m5 x1d h31 yea1 ff7 fs21 fc2 sc0 ls0 ws0">T<span class="_ _7"></span>ype<span class="_ _26"> </span><span class="ffd fs1e ls17c">ci<span class="_ _10"> </span>v<span class="_ _11"> </span></span>Size</div><div class="t m5 x1f6 h31 y298e ffd fs1e fc2 sc0 ls0 ws0">S3<span class="_ _75"> </span><span class="ff7 fs21">0<span class="_ _5e"> </span>4<span class="_ _f1"> </span>16<span class="_ _4c"> </span>24</span></div><div class="t m5 x1f6 h31 y1037 ffd fs1e fc2 sc0 ls0 ws0">U3<span class="_ _75"> </span><span class="ff7 fs21 ls17d">00<span class="_ _1f"> </span>0<span class="_ _c"> </span>8</span></div><div class="t m5 x1d h26 y2c2f ff7 fs19 fc2 sc0 ls0 ws0">(W<span class="_ _3"></span>e<span class="_"> </span>will<span class="_ _13"> </span>see<span class="_ _13"> </span>shortly<span class="_ _13"> </span>why<span class="_"> </span><span class="ffd">i<span class="_ _13"> </span></span>has<span class="_ _13"> </span>offset<span class="_ _13"> </span>4<span class="_"> </span>in<span class="_ _13"> </span><span class="ffd">S3<span class="_ _13"> </span></span>rather<span class="_ _13"> </span>than<span class="_"> </span>1,<span class="_ _13"> </span>and<span class="_ _13"> </span>why<span class="_ _13"> </span><span class="ffd">v<span class="_ _10"> </span></span>has<span class="_ _13"> </span>offset<span class="_ _13"> </span>16,</div><div class="t m5 x1d h26 y2c30 ff7 fs19 fc2 sc0 ls0 ws0">rather<span class="_"> </span>than<span class="_"> </span>9<span class="_ _11"> </span>or<span class="_"> </span>12.)<span class="_"> </span>F<span class="_ _0"></span>or<span class="_"> </span>pointer<span class="_"> </span><span class="ffd">p<span class="_ _11"> </span></span>of<span class="_"> </span>type<span class="_"> </span><span class="ffd">union<span class="_ _11"> </span>U3<span class="_ _10"> </span>*</span>,<span class="_ _11"> </span>references<span class="_"> </span><span class="ffd">p-&gt;c</span>,<span class="_ _11"> </span><span class="ffd">p-&gt;i[0]</span>,</div><div class="t m5 x1d h26 y2c31 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _16"> </span><span class="ffd">p-&gt;v<span class="_ _16"> </span></span>would<span class="_ _14"> </span>all<span class="_ _16"> </span>reference<span class="_ _14"> </span>the<span class="_ _16"> </span>beginning<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _16"> </span>data<span class="_ _14"> </span>structure<span class="_ _1"></span>.<span class="_ _14"> </span>Observe<span class="_ _16"> </span>also</div><div class="t m5 x1d h26 y2c32 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_"> </span>the<span class="_"> </span>overall<span class="_"> </span>size<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>union<span class="_"> </span>equals<span class="_"> </span>the<span class="_"> </span>maximum<span class="_"> </span>size<span class="_"> </span>of<span class="_"> </span>any<span class="_"> </span>of<span class="_"> </span>its<span class="_"> </span>ﬁelds<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2c33 ff7 fs19 fc2 sc0 ls0 ws0">Unions<span class="_ _13"> </span>can<span class="_ _13"> </span>be<span class="_ _13"> </span>useful<span class="_ _13"> </span>in<span class="_ _13"> </span>several<span class="_ _13"> </span>contexts<span class="_ _1"></span>.<span class="_ _13"> </span>However,<span class="_ _13"> </span>they<span class="_ _13"> </span>can<span class="_ _13"> </span>also<span class="_ _13"> </span>lead<span class="_ _13"> </span>to<span class="_ _13"> </span>nasty</div><div class="t m5 x1d h26 y2c34 ff7 fs19 fc2 sc0 ls0 ws0">bugs<span class="_ _1"></span>,<span class="_"> </span>since<span class="_ _13"> </span>they<span class="_ _13"> </span>bypass<span class="_"> </span>the<span class="_ _13"> </span>safety<span class="_ _13"> </span>provided<span class="_"> </span>by<span class="_ _13"> </span>the<span class="_"> </span>C<span class="_ _13"> </span>type<span class="_ _13"> </span>system.<span class="_"> </span>One<span class="_ _13"> </span>application</div><div class="t m5 x1d h26 y2c35 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _13"> </span>when<span class="_"> </span>we<span class="_ _13"> </span>know<span class="_"> </span>in<span class="_ _13"> </span>advance<span class="_"> </span>that<span class="_ _13"> </span>the<span class="_"> </span>use<span class="_ _13"> </span>of<span class="_"> </span>two<span class="_ _13"> </span>different<span class="_"> </span>ﬁelds<span class="_ _13"> </span>in<span class="_ _13"> </span>a<span class="_"> </span>data<span class="_ _13"> </span>structure</div><div class="t m5 x1d h26 y2c36 ff7 fs19 fc2 sc0 ls0 ws0">will<span class="_ _6"> </span>be<span class="_ _13"> </span>mutually<span class="_ _a"> </span>exclusive.<span class="_ _a"> </span>Then,<span class="_ _6"> </span>declaring<span class="_ _13"> </span>these<span class="_ _a"> </span>two<span class="_ _13"> </span>ﬁelds<span class="_ _a"> </span>as<span class="_ _13"> </span>part<span class="_ _6"> </span>of<span class="_ _6"> </span>a<span class="_ _13"> </span>union<span class="_ _a"> </span>rather</div><div class="t m5 x1d h26 y2c37 ff7 fs19 fc2 sc0 ls0 ws0">than<span class="_"> </span>a<span class="_"> </span>structure<span class="_"> </span>will<span class="_"> </span>reduce<span class="_"> </span>the<span class="_"> </span>total<span class="_"> </span>space<span class="_"> </span>allocated.</div><div class="t m5 x29 h26 y2c38 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_ _21"> </span>example<span class="_ _0"></span>,<span class="_ _f"> </span>suppose<span class="_ _21"> </span>we<span class="_ _21"> </span>want<span class="_ _21"> </span>to<span class="_ _21"> </span>implement<span class="_ _21"> </span>a<span class="_ _21"> </span>binary<span class="_ _21"> </span>tree<span class="_ _21"> </span>data<span class="_ _21"> </span>structure</div><div class="t m5 x1d h26 y2c39 ff7 fs19 fc2 sc0 ls0 ws0">where<span class="_ _15"> </span>each<span class="_ _15"> </span>leaf<span class="_ _15"> </span>node<span class="_ _15"> </span>has<span class="_ _15"> </span>two<span class="_ _15"> </span><span class="ffd">double<span class="_ _21"> </span></span>data<span class="_ _15"> </span>values<span class="_ _15"> </span>and<span class="_ _15"> </span>each<span class="_ _15"> </span>internal<span class="_ _15"> </span>node<span class="_ _21"> </span>has</div><div class="t m5 x1d h26 y2c3a ff7 fs19 fc2 sc0 ls0 ws0">pointers<span class="_"> </span>to<span class="_"> </span>two<span class="_"> </span>children<span class="_"> </span>but<span class="_"> </span>no<span class="_"> </span>data.<span class="_"> </span>If<span class="_"> </span>we<span class="_"> </span>declare<span class="_"> </span>this<span class="_"> </span>as</div><div class="t m5 x1d h2d y2c3b ffd fs1e fc2 sc0 ls0 ws0">struct<span class="_ _e"> </span>node_s<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y2c3c ffd fs1e fc2 sc0 ls0 ws0">struct<span class="_ _e"> </span>node_s<span class="_ _1f"> </span>*left;</div><div class="t m5 x10c h2d y2c3d ffd fs1e fc2 sc0 ls0 ws0">struct<span class="_ _e"> </span>node_s<span class="_ _1f"> </span>*right;</div><div class="t m5 x10c h2d y2c3e ffd fs1e fc2 sc0 ls0 ws0">double<span class="_ _e"> </span>data[2];</div><div class="t m5 x1d h2d y2c3f ffd fs1e fc2 sc0 ls0 ws0">};</div><div class="t m5 x1d h26 y2572 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_ _6"> </span>every<span class="_ _13"> </span>node<span class="_ _6"> </span>requires<span class="_ _13"> </span>32<span class="_ _6"> </span>bytes<span class="_ _1"></span>,<span class="_ _13"> </span>with<span class="_ _13"> </span>half<span class="_ _6"> </span>the<span class="_ _6"> </span>bytes<span class="_ _13"> </span>wasted<span class="_ _6"> </span>for<span class="_ _13"> </span>each<span class="_ _6"> </span>type<span class="_ _13"> </span>of<span class="_ _6"> </span>node<span class="_ _0"></span>.</div><div class="t m5 x1d h26 y2c40 ff7 fs19 fc2 sc0 ls0 ws0">On<span class="_"> </span>the<span class="_"> </span>other<span class="_"> </span>hand,<span class="_"> </span>if<span class="_"> </span>we<span class="_"> </span>declare<span class="_"> </span>a<span class="_"> </span>node<span class="_"> </span>as</div><div class="t m5 x1d h2d y2a0a ffd fs1e fc2 sc0 ls0 ws0">union<span class="_ _e"> </span>node_u<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y2c41 ffd fs1e fc2 sc0 ls0 ws0">struct<span class="_ _e"> </span>{</div><div class="t m5 x22b h2d y2c42 ffd fs1e fc2 sc0 ls0 ws0">union<span class="_ _e"> </span>node_u<span class="_ _1f"> </span>*left;</div><div class="t m5 x22b h2d y2c43 ffd fs1e fc2 sc0 ls0 ws0">union<span class="_ _e"> </span>node_u<span class="_ _1f"> </span>*right;</div><div class="t m5 x10c h2d y2c44 ffd fs1e fc2 sc0 ls0 ws0">}<span class="_ _e"> </span>internal;</div><div class="t m5 x10c h2d y2c45 ffd fs1e fc2 sc0 ls0 ws0">double<span class="_ _e"> </span>data[2];</div><div class="t m5 x1d h2d y2c46 ffd fs1e fc2 sc0 ls0 ws0">};</div><div class="t m5 x1d h26 ye14 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_ _15"> </span>every<span class="_ _21"> </span>node<span class="_ _15"> </span>will<span class="_ _21"> </span>require<span class="_ _21"> </span>just<span class="_ _15"> </span>16<span class="_ _21"> </span>bytes<span class="_ _1"></span>.<span class="_ _21"> </span>If<span class="_ _15"> </span><span class="ffd">n<span class="_ _21"> </span></span>is<span class="_ _15"> </span>a<span class="_ _21"> </span>pointer<span class="_ _21"> </span>to<span class="_ _15"> </span>a<span class="_ _21"> </span>node<span class="_ _15"> </span>of<span class="_ _21"> </span>type</div><div class="t m5 x1d h26 ye15 ffd fs19 fc2 sc0 ls0 ws0">union<span class="_ _f"> </span>node_u<span class="_ _f"> </span>*<span class="ff7">,<span class="_ _e"> </span>we<span class="_ _f"> </span>would<span class="_ _e"> </span>reference<span class="_ _21"> </span>the<span class="_ _f"> </span>data<span class="_ _e"> </span>of<span class="_ _21"> </span>a<span class="_ _f"> </span>leaf<span class="_ _f"> </span>node<span class="_ _e"> </span>as<span class="_ _21"> </span></span>n-&gt;data[0]</div><div class="t m5 x1d h26 ye16 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span><span class="ffd">n-&gt;data[1]</span>,<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>children<span class="_"> </span>of<span class="_"> </span>an<span class="_"> </span>internal<span class="_"> </span>node<span class="_"> </span>as<span class="_"> </span><span class="ffd">n-&gt;internal.left<span class="_ _10"> </span></span>and</div><div class="t m5 x1d h26 ye17 ffd fs19 fc2 sc0 ls0 ws0">n-&gt;internal.right<span class="ff7">.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
