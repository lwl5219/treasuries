<div id="pf21a" class="pf w2 h11" data-page-no="21a"><div class="pc pc21a w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg21a.png"/><div class="t m5 x255 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>5.1<span class="_ _60"> </span>Capabilities<span class="_ _10"> </span>and<span class="_ _10"> </span>Limitations<span class="_ _10"> </span>of<span class="_ _10"> </span>Optimizing<span class="_ _10"> </span>Compilers<span class="_ _3e"> </span><span class="ffe fs1e">537</span></div><div class="t m5 x34 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Optimizing<span class="_ _11"> </span>function<span class="_ _11"> </span>calls<span class="_ _11"> </span>by<span class="_ _16"> </span>inline<span class="_ _11"> </span>substitution</span></div><div class="t m5 x34 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">Code<span class="_ _16"> </span>involving<span class="_ _16"> </span>function<span class="_ _16"> </span>calls<span class="_ _16"> </span>can<span class="_ _16"> </span>be<span class="_ _16"> </span>optimized<span class="_ _16"> </span>by<span class="_ _16"> </span>a<span class="_ _16"> </span>process<span class="_ _11"> </span>known<span class="_ _16"> </span>as<span class="_ _16"> </span><span class="ffa">inline<span class="_ _16"> </span>substitution<span class="_ _16"> </span></span>(or<span class="_ _16"> </span>simply</div><div class="t m5 x34 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">“inlining”),<span class="_"> </span>where<span class="_ _10"> </span>the<span class="_ _10"> </span>function<span class="_ _11"> </span>call<span class="_"> </span>is<span class="_"> </span>replaced<span class="_ _10"> </span>by<span class="_ _11"> </span>the<span class="_"> </span>code<span class="_"> </span>for<span class="_ _10"> </span>the<span class="_ _10"> </span>body<span class="_ _11"> </span>of<span class="_"> </span>the<span class="_"> </span>function.<span class="_ _10"> </span>F<span class="_ _0"></span>or<span class="_"> </span>example,</div><div class="t m5 x34 h2b y2d2 ff7 fs1e fc2 sc0 ls0 ws0">we<span class="_"> </span>can<span class="_"> </span>expand<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span><span class="ffd">func1<span class="_ _10"> </span></span>by<span class="_"> </span>substituting<span class="_"> </span>four<span class="_"> </span>instantiations<span class="_"> </span>of<span class="_"> </span>function<span class="_"> </span><span class="ffd">f</span>:</div><div class="t m5 x1f5 h2d y1209 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Result<span class="_ _e"> </span>of<span class="_ _1f"> </span>inlining<span class="_ _1f"> </span>f<span class="_ _e"> </span>in<span class="_ _1f"> </span>func1<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f5 h2d y120a ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">long<span class="_ _1f"> </span>func1in()<span class="_ _e"> </span>{</span></div><div class="t m5 x1f5 h2d y120b ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>t<span class="_ _1f"> </span>=<span class="_ _1f"> </span>counter++;<span class="_ _e"> </span>/*<span class="_ _1f"> </span>+0<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f5 h2d y120c ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">t<span class="_ _e"> </span>+=<span class="_ _1f"> </span>counter++;<span class="_ _8c"> </span>/*<span class="_ _1f"> </span>+1<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f5 h2d y120d ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">t<span class="_ _e"> </span>+=<span class="_ _1f"> </span>counter++;<span class="_ _8c"> </span>/*<span class="_ _1f"> </span>+2<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f5 h2d y120f ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">t<span class="_ _e"> </span>+=<span class="_ _1f"> </span>counter++;<span class="_ _8c"> </span>/*<span class="_ _1f"> </span>+3<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f5 h2d y49e1 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>t;</span></div><div class="t m5 x1f5 h2d y1211 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x34 h2b y49e2 ff7 fs1e fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>transformation<span class="_ _13"> </span>both<span class="_ _13"> </span>reduces<span class="_"> </span>the<span class="_ _13"> </span>overhead<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>function<span class="_ _13"> </span>calls<span class="_ _13"> </span>and<span class="_"> </span>allows<span class="_ _13"> </span>further<span class="_ _13"> </span>optimization<span class="_ _13"> </span>of</div><div class="t m5 x34 h2b y49e3 ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_"> </span>expanded<span class="_"> </span>code<span class="_ _1"></span>.<span class="_"> </span>F<span class="_ _1"></span>or<span class="_"> </span>example<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>compiler<span class="_"> </span>can<span class="_ _13"> </span>consolidate<span class="_"> </span>the<span class="_"> </span>updates<span class="_"> </span>of<span class="_ _13"> </span>global<span class="_"> </span>variable<span class="_"> </span><span class="ffd">counter</span></div><div class="t m5 x34 h2b y49e4 ff7 fs1e fc2 sc0 ls0 ws0">in<span class="_"> </span><span class="ffd">func1in<span class="_ _10"> </span></span>to<span class="_"> </span>generate<span class="_"> </span>an<span class="_"> </span>optimized<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>function:</div><div class="t m5 x1f5 h2d y49e5 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Optimization<span class="_ _e"> </span>of<span class="_ _1f"> </span>inlined<span class="_ _1f"> </span>code<span class="_ _e"> </span>*/</span></div><div class="t m5 x1f5 h2d y49e6 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">long<span class="_ _1f"> </span>func1opt()<span class="_ _e"> </span>{</span></div><div class="t m5 x1f5 h2d y4f2 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2 ls33">l<span class="_ _41"></span>o<span class="_ _41"></span>n<span class="_ _41"></span>gt=4*<span class="ls0">counter<span class="_ _e"> </span>+<span class="_ _1f"> </span>6;</span></span></div><div class="t m5 x1f5 h2d y49e7 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">counter<span class="_ _e"> </span>+=<span class="_ _1f"> </span>4;</span></div><div class="t m5 x1f5 h2d y49e8 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>t;</span></div><div class="t m5 x1f5 h2d y49e9 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x34 h2b y49ea ff7 fs1e fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>code<span class="_"> </span>faithfully<span class="_"> </span>reproduces<span class="_"> </span>the<span class="_"> </span>behavior<span class="_"> </span>of<span class="_"> </span><span class="ffd">func1<span class="_ _10"> </span></span>for<span class="_"> </span>this<span class="_"> </span>particular<span class="_"> </span>deﬁnition<span class="_"> </span>of<span class="_"> </span>function<span class="_"> </span><span class="ffd">f</span>.</div><div class="t m5 x35 h2b y49eb ff7 fs1e fc2 sc0 ls0 ws0">Recent<span class="_ _f"> </span>versions<span class="_ _f"> </span>of<span class="_ _e"> </span><span class="ff9">gcc<span class="_ _21"> </span></span>attempt<span class="_ _e"> </span>this<span class="_ _21"> </span>form<span class="_ _e"> </span>of<span class="_ _21"> </span>optimization,<span class="_ _e"> </span>either<span class="_ _e"> </span>when<span class="_ _21"> </span>directed<span class="_ _e"> </span>to<span class="_ _21"> </span>with<span class="_ _e"> </span>the</div><div class="t m5 x34 h2b y49ec ff7 fs1e fc2 sc0 ls0 ws0">command-line<span class="_ _15"> </span>option<span class="_ _14"> </span><span class="ffd">-finline<span class="_ _15"> </span></span>or<span class="_ _15"> </span>for<span class="_ _15"> </span>optimization<span class="_ _15"> </span>level<span class="_ _15"> </span><span class="ffd">-O1<span class="_ _15"> </span></span>and<span class="_ _15"> </span>higher.<span class="_ _14"> </span>Unfortunately<span class="_ _3"></span>,<span class="_ _21"> </span><span class="ff9">gcc<span class="_ _15"> </span></span>only</div><div class="t m5 x34 h2b y49ed ff7 fs1e fc2 sc0 ls0 ws0">attempts<span class="_ _16"> </span>inlining<span class="_ _14"> </span>for<span class="_ _14"> </span>functions<span class="_ _14"> </span>deﬁned<span class="_ _14"> </span>within<span class="_ _16"> </span>a<span class="_ _14"> </span>single<span class="_ _14"> </span>ﬁle<span class="_ _0"></span>.<span class="_ _16"> </span>That<span class="_ _16"> </span>means<span class="_ _14"> </span>it<span class="_ _16"> </span>will<span class="_ _14"> </span>not<span class="_ _14"> </span>be<span class="_ _14"> </span>applied<span class="_ _14"> </span>in<span class="_ _16"> </span>the</div><div class="t m5 x34 h2b y49ee ff7 fs1e fc2 sc0 ls0 ws0">common<span class="_ _11"> </span>case<span class="_ _10"> </span>where<span class="_ _11"> </span>a<span class="_ _11"> </span>set<span class="_ _11"> </span>of<span class="_ _11"> </span>library<span class="_ _11"> </span>functions<span class="_ _11"> </span>is<span class="_ _11"> </span>deﬁned<span class="_ _11"> </span>in<span class="_ _10"> </span>one<span class="_ _11"> </span>ﬁle<span class="_ _11"> </span>but<span class="_ _11"> </span>invoked<span class="_ _11"> </span>by<span class="_ _11"> </span>functions<span class="_ _11"> </span>in<span class="_ _11"> </span>other</div><div class="t m5 x34 h2b y49ef ff7 fs1e fc2 sc0 ls0 ws0">ﬁles<span class="_ _1"></span>.</div><div class="t m5 x35 h2b y49f0 ff7 fs1e fc2 sc0 ls0 ws0">T<span class="_ _1"></span>here<span class="_ _16"> </span>are<span class="_ _16"> </span>times<span class="_ _16"> </span>when<span class="_ _16"> </span>it<span class="_ _16"> </span>is<span class="_ _16"> </span>best<span class="_ _16"> </span>to<span class="_ _16"> </span>prevent<span class="_ _16"> </span>a<span class="_ _16"> </span>compiler<span class="_ _16"> </span>from<span class="_ _16"> </span>performing<span class="_ _16"> </span>inline<span class="_ _16"> </span>substitution.<span class="_ _16"> </span>One</div><div class="t m5 x34 h2b y49f1 ff7 fs1e fc2 sc0 ls0 ws0">is<span class="_ _16"> </span>when<span class="_ _16"> </span>the<span class="_ _16"> </span>code<span class="_ _16"> </span>will<span class="_ _16"> </span>be<span class="_ _16"> </span>evaluated<span class="_ _16"> </span>using<span class="_ _14"> </span>a<span class="_ _16"> </span>symbolic<span class="_ _16"> </span>debugger,<span class="_ _16"> </span>such<span class="_ _16"> </span>as<span class="_ _16"> </span><span class="ff9">gdb</span>,<span class="_ _14"> </span>as<span class="_ _16"> </span>described<span class="_ _16"> </span>in<span class="_ _16"> </span>Section</div><div class="t m5 x34 h2b y49f2 ff7 fs1e fc2 sc0 ls0 ws0">3.10.2.<span class="_"> </span>If<span class="_ _11"> </span>a<span class="_"> </span>function<span class="_ _11"> </span>call<span class="_"> </span>has<span class="_ _11"> </span>been<span class="_"> </span>optimized<span class="_ _11"> </span>away<span class="_"> </span>via<span class="_ _11"> </span>inline<span class="_"> </span>substitution,<span class="_ _11"> </span>then<span class="_ _10"> </span>any<span class="_ _11"> </span>attempt<span class="_ _10"> </span>to<span class="_ _11"> </span>trace<span class="_"> </span>or</div><div class="t m5 x34 h2b y49f3 ff7 fs1e fc2 sc0 ls0 ws0">set<span class="_ _11"> </span>a<span class="_ _16"> </span>breakpoint<span class="_ _16"> </span>for<span class="_ _11"> </span>that<span class="_ _16"> </span>call<span class="_ _11"> </span>will<span class="_ _16"> </span>fail.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>second<span class="_ _11"> </span>is<span class="_ _16"> </span>when<span class="_ _11"> </span>evaluating<span class="_ _16"> </span>the<span class="_ _16"> </span>performance<span class="_ _11"> </span>of<span class="_ _16"> </span>a<span class="_ _11"> </span>program</div><div class="t m5 x34 h2b y49f4 ff7 fs1e fc2 sc0 ls0 ws0">by<span class="_ _16"> </span>proﬁling,<span class="_ _16"> </span>as<span class="_ _16"> </span>is<span class="_ _16"> </span>discussed<span class="_ _16"> </span>in<span class="_ _16"> </span>Section<span class="_ _16"> </span>5.14.1.<span class="_ _16"> </span>Calls<span class="_ _16"> </span>to<span class="_ _16"> </span>functions<span class="_ _16"> </span>that<span class="_ _16"> </span>have<span class="_ _16"> </span>been<span class="_ _16"> </span>eliminated<span class="_ _16"> </span>by<span class="_ _16"> </span>inline</div><div class="t m5 x34 h2b y49f5 ff7 fs1e fc2 sc0 ls0 ws0">substitution<span class="_"> </span>will<span class="_"> </span>not<span class="_"> </span>be<span class="_"> </span>proﬁled<span class="_"> </span>correctly<span class="_ _3"></span>.</div><div class="t m5 x17 h46 y250 ff7 fs19 fc2 sc0 ls0 ws0">particular,<span class="_ _13"> </span>a<span class="_"> </span>call<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">func1<span class="_ _10"> </span></span>would<span class="_"> </span>return<span class="_"> </span>0<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"> </span></span>1<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"></span></span>2<span class="_"> </span><span class="ff12">+<span class="_ _13"></span></span>3<span class="_ _13"> </span><span class="ff12">=<span class="_ _13"></span></span><span class="ls17">6,<span class="_"> </span>whereas<span class="_"> </span>a<span class="_ _13"> </span>call<span class="_"> </span>to<span class="_"> </span></span><span class="ffd">func2</span></div><div class="t m5 x17 h26 y251 ff7 fs19 fc2 sc0 ls0 ws0">would<span class="_"> </span>return<span class="_"> </span>4</div><div class="t m5 x126 h45 y49f6 ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x1cb h46 y251 ff7 fs19 fc2 sc0 ls0 ws0">0<span class="_"> </span><span class="ff12">=<span class="_ _13"></span></span><span class="ls58">0,<span class="_"> </span>assuming<span class="_"> </span>both<span class="_ _11"> </span>started<span class="_"> </span>with<span class="_"> </span>global<span class="_ _11"> </span>variable<span class="_"> </span></span><span class="ffd">counter<span class="_ _10"> </span></span>set<span class="_ _11"> </span>to</div><div class="t m5 x17 h26 y252 ff7 fs19 fc2 sc0 ls0 ws0">zero<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y253 ff7 fs19 fc2 sc0 ls0 ws0">Most<span class="_ _14"> </span>compilers<span class="_ _15"> </span>do<span class="_ _15"> </span>not<span class="_ _15"> </span>try<span class="_ _14"> </span>to<span class="_ _15"> </span>determine<span class="_ _15"> </span>whether<span class="_ _15"> </span>a<span class="_ _14"> </span>function<span class="_ _15"> </span>is<span class="_ _15"> </span>free<span class="_ _15"> </span>of<span class="_ _14"> </span>side</div><div class="t m5 x17 h26 y254 ff7 fs19 fc2 sc0 ls0 ws0">effects<span class="_ _21"> </span>and<span class="_ _21"> </span>hence<span class="_ _21"> </span>is<span class="_ _21"> </span>a<span class="_ _21"> </span>candidate<span class="_ _21"> </span>for<span class="_ _21"> </span>optimizations<span class="_ _21"> </span>such<span class="_ _21"> </span>as<span class="_ _21"> </span>those<span class="_ _21"> </span>attempted<span class="_ _21"> </span>in</div><div class="t m5 x17 h26 y255 ffd fs19 fc2 sc0 ls0 ws0">func2<span class="ff7">.<span class="_ _15"> </span>Instead,<span class="_ _f"> </span>the<span class="_ _15"> </span>compiler<span class="_ _21"> </span>assumes<span class="_ _15"> </span>the<span class="_ _21"> </span>worst<span class="_ _15"> </span>case<span class="_ _21"> </span>and<span class="_ _15"> </span>leaves<span class="_ _15"> </span>function<span class="_ _21"> </span>calls</span></div><div class="t m5 x17 h26 y256 ff7 fs19 fc2 sc0 ls0 ws0">intact.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
