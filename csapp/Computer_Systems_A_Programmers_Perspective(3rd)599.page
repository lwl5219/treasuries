<div id="pf257" class="pf w2 h11" data-page-no="257"><div class="pc pc257 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg257.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">598<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 xe0 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">Eliminate<span class="_ _13"> </span>unnecessary<span class="_"> </span>memory<span class="_ _13"> </span>references<span class="_ _1"></span>.<span class="_ _13"> </span>Introduce<span class="_"> </span>temporary<span class="_ _13"> </span>vari-</div><div class="t m5 xe0 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">ables<span class="_"> </span>to<span class="_ _11"> </span>hold<span class="_ _11"> </span>intermediate<span class="_ _11"> </span>results<span class="_ _1"></span>.<span class="_ _11"> </span>Store<span class="_ _11"> </span>a<span class="_ _11"> </span>result<span class="_ _11"> </span>in<span class="_ _11"> </span>an<span class="_ _11"> </span>array<span class="_ _11"> </span>or<span class="_ _11"> </span>global</div><div class="t m5 xe0 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">variable<span class="_"> </span>only<span class="_"> </span>when<span class="_"> </span>the<span class="_"> </span>ﬁnal<span class="_"> </span>value<span class="_"> </span>has<span class="_"> </span>been<span class="_"> </span>computed.</div><div class="t m5 x75 h26 y3a97 ffa fs19 fc2 sc0 ls0 ws0">Low-level<span class="_ _21"> </span>optimizations<span class="_ _1"></span>.<span class="_ _21"> </span><span class="ff7">Structure<span class="_ _f"> </span>code<span class="_ _f"> </span>to<span class="_ _f"> </span>take<span class="_ _f"> </span>advantage<span class="_ _f"> </span>of<span class="_ _21"> </span>the<span class="_ _f"> </span>hardware</span></div><div class="t m5 xcd h26 y3a98 ff7 fs19 fc2 sc0 ls0 ws0">capabilities<span class="_ _1"></span>.</div><div class="t m5 xe0 h26 y28e6 ff7 fs19 fc2 sc0 ls0 ws0">Unroll<span class="_"> </span>loops<span class="_ _13"> </span>to<span class="_"> </span>reduce<span class="_"> </span>overhead<span class="_"> </span>and<span class="_ _13"> </span>to<span class="_"> </span>enable<span class="_"> </span>further<span class="_ _13"> </span>optimizations<span class="_ _1"></span>.</div><div class="t m5 xe0 h26 ye9d ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>ind<span class="_"> </span>ways<span class="_"> </span>to<span class="_"> </span>increase<span class="_"> </span>instruction-level<span class="_"> </span>parallelism<span class="_"> </span>by<span class="_"> </span>techniques<span class="_"> </span>such</div><div class="t m5 xe0 h26 y50a8 ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_"> </span>multiple<span class="_"> </span>accumulators<span class="_"> </span>and<span class="_"> </span>reassociation.</div><div class="t m5 xe0 h26 y50a9 ff7 fs19 fc2 sc0 ls0 ws0">Rewrite<span class="_ _11"> </span>conditional<span class="_ _11"> </span>operations<span class="_ _11"> </span>in<span class="_ _11"> </span>a<span class="_ _11"> </span>functional<span class="_ _11"> </span>style<span class="_ _11"> </span>to<span class="_ _11"> </span>enable<span class="_ _11"> </span>compi-</div><div class="t m5 xe0 h26 y50aa ff7 fs19 fc2 sc0 ls0 ws0">lation<span class="_"> </span>via<span class="_"> </span>conditional<span class="_"> </span>data<span class="_"> </span>transfers<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y50ab ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _14"> </span>ﬁnal<span class="_ _15"> </span>word<span class="_ _15"> </span>of<span class="_ _15"> </span>advice<span class="_ _15"> </span>to<span class="_ _14"> </span>the<span class="_ _15"> </span>reader<span class="_ _15"> </span>is<span class="_ _15"> </span>to<span class="_ _14"> </span>be<span class="_ _15"> </span>vigilant<span class="_ _15"> </span>to<span class="_ _15"> </span>avoid<span class="_ _15"> </span>introducing</div><div class="t m5 x1d h26 y50ac ff7 fs19 fc2 sc0 ls0 ws0">errors<span class="_"> </span>as<span class="_ _13"> </span>you<span class="_"> </span>rewrite<span class="_ _13"> </span>programs<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>interest<span class="_ _13"> </span>of<span class="_"> </span>efﬁcienc<span class="_ _1"></span>y<span class="_ _3"></span>.<span class="_"> </span>It<span class="_ _13"> </span>is<span class="_"> </span>very<span class="_ _13"> </span>easy<span class="_"> </span>to<span class="_ _13"> </span>make</div><div class="t m5 x1d h26 y50ad ff7 fs19 fc2 sc0 ls0 ws0">mistakes<span class="_"> </span>when<span class="_"> </span>introducing<span class="_ _13"> </span>new<span class="_"> </span>variables<span class="_ _1"></span>,<span class="_"> </span>changing<span class="_"> </span>loop<span class="_"> </span>bounds<span class="_ _3"></span>,<span class="_"> </span>and<span class="_"> </span>making<span class="_"> </span>the</div><div class="t m5 x1d h26 y50ae ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_"> </span>more<span class="_ _11"> </span>complex<span class="_"> </span>overall.<span class="_ _11"> </span>One<span class="_"> </span>useful<span class="_ _11"> </span>technique<span class="_"> </span>is<span class="_ _11"> </span>to<span class="_"> </span>use<span class="_ _11"> </span>checking<span class="_"> </span>code<span class="_ _11"> </span>to<span class="_"> </span>test</div><div class="t m5 x1d h26 y50af ff7 fs19 fc2 sc0 ls0 ws0">each<span class="_ _6"> </span>version<span class="_ _13"> </span>of<span class="_ _a"> </span>a<span class="_ _13"> </span>function<span class="_ _a"> </span>as<span class="_ _13"> </span>it<span class="_ _6"> </span>is<span class="_ _6"> </span>being<span class="_ _13"> </span>optimized,<span class="_ _6"> </span>to<span class="_ _6"> </span>ensure<span class="_ _13"> </span>no<span class="_ _6"> </span>bugs<span class="_ _6"> </span>are<span class="_ _13"> </span>introduced</div><div class="t m5 x1d h26 y50b0 ff7 fs19 fc2 sc0 ls0 ws0">during<span class="_"> </span>this<span class="_"> </span>process<span class="_ _1"></span>.<span class="_"> </span>Checking<span class="_"> </span>code<span class="_"> </span>applies<span class="_"> </span>a<span class="_"> </span>series<span class="_"> </span>of<span class="_"> </span>tests<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>new<span class="_"> </span>versions<span class="_"> </span>of</div><div class="t m5 x1d h26 y50b1 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _11"> </span>function<span class="_ _16"> </span>and<span class="_ _11"> </span>makes<span class="_ _11"> </span>sure<span class="_ _16"> </span>they<span class="_ _11"> </span>yield<span class="_ _16"> </span>the<span class="_ _11"> </span>same<span class="_ _11"> </span>results<span class="_ _16"> </span>as<span class="_ _11"> </span>the<span class="_ _11"> </span>original.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>set<span class="_ _11"> </span>of</div><div class="t m5 x1d h26 y50b2 ff7 fs19 fc2 sc0 ls0 ws0">test<span class="_ _16"> </span>cases<span class="_ _16"> </span>must<span class="_ _14"> </span>become<span class="_ _16"> </span>more<span class="_ _16"> </span>extensive<span class="_ _16"> </span>with<span class="_ _14"> </span>highly<span class="_ _16"> </span>optimized<span class="_ _16"> </span>code,<span class="_ _16"> </span>since<span class="_ _16"> </span>there</div><div class="t m5 x1d h26 y50b3 ff7 fs19 fc2 sc0 ls0 ws0">are<span class="_ _11"> </span>more<span class="_ _11"> </span>cases<span class="_ _11"> </span>to<span class="_ _16"> </span>consider<span class="_ _0"></span>.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>example,<span class="_"> </span>checking<span class="_ _16"> </span>code<span class="_"> </span>that<span class="_ _16"> </span>uses<span class="_"> </span>loop<span class="_ _16"> </span>unrolling</div><div class="t m5 x1d h26 y50b4 ff7 fs19 fc2 sc0 ls0 ws0">requires<span class="_"> </span>testing<span class="_"> </span>for<span class="_"> </span>many<span class="_ _13"> </span>different<span class="_"> </span>loop<span class="_"> </span>bounds<span class="_"> </span>to<span class="_"> </span>make<span class="_"> </span>sure<span class="_"> </span>it<span class="_ _13"> </span>handles<span class="_"> </span>all<span class="_"> </span>of<span class="_"> </span>the</div><div class="t m5 x1d h26 y50b5 ff7 fs19 fc2 sc0 ls0 ws0">different<span class="_"> </span>possible<span class="_"> </span>numbers<span class="_"> </span>of<span class="_"> </span>single-step<span class="_"> </span>iterations<span class="_"> </span>required<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>end.</div><div class="t m5 x1d h3b y50b6 fff fs24 fc6 sc0 ls0 ws0">5.14</div><div class="t m5 x1c4 h3e y50b7 ffe fs18 fc6 sc0 ls0 ws0">Identifying<span class="_"> </span>and<span class="_"> </span>Eliminating<span class="_"> </span>Performance<span class="_"> </span>Bottlenecks</div><div class="t m5 x1d h26 y50b8 ff7 fs19 fc1 sc0 ls0 ws0">Up<span class="_ _13"> </span>to<span class="_ _13"> </span>this<span class="_ _13"> </span>point,<span class="_ _13"> </span>we<span class="_ _13"> </span>have<span class="_ _13"> </span>only<span class="_ _13"> </span>considered<span class="_ _13"> </span>optimizing<span class="_ _13"> </span>small<span class="_ _13"> </span>programs<span class="_ _3"></span>,<span class="_"> </span>where<span class="_ _13"> </span>there</div><div class="t m5 x1d h26 y50b9 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _13"> </span>some<span class="_ _6"> </span>clear<span class="_ _13"> </span>place<span class="_ _6"> </span>in<span class="_ _13"> </span>the<span class="_ _6"> </span>program<span class="_ _13"> </span>that<span class="_ _6"> </span>limits<span class="_ _13"> </span>its<span class="_ _6"> </span>performance<span class="_ _13"> </span>and<span class="_ _6"> </span>therefore<span class="_ _13"> </span>should</div><div class="t m5 x1d h26 y50ba ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_ _13"> </span>the<span class="_"> </span>focus<span class="_ _13"> </span>of<span class="_ _13"> </span>our<span class="_"> </span>optimization<span class="_ _13"> </span>efforts<span class="_ _3"></span>.<span class="_"> </span>W<span class="_ _0"></span>hen<span class="_ _13"> </span>working<span class="_"> </span>with<span class="_ _13"> </span>large<span class="_ _13"> </span>programs<span class="_ _1"></span>,<span class="_"> </span>even</div><div class="t m5 x1d h26 y50bb ff7 fs19 fc1 sc0 ls0 ws0">knowing<span class="_ _11"> </span>where<span class="_ _11"> </span>to<span class="_ _16"> </span>focus<span class="_ _11"> </span>our<span class="_ _11"> </span>optimization<span class="_ _16"> </span>efforts<span class="_ _11"> </span>can<span class="_ _11"> </span>be<span class="_ _16"> </span>difﬁcult.<span class="_ _11"> </span>In<span class="_ _11"> </span>this<span class="_ _11"> </span>section,</div><div class="t m5 x1d h26 y50bc ff7 fs19 fc1 sc0 ls0 ws0">we<span class="_ _15"> </span>describe<span class="_ _21"> </span>how<span class="_ _21"> </span>to<span class="_ _21"> </span>use<span class="_ _15"> </span><span class="ffa">code<span class="_ _21"> </span>proﬁlers</span>,<span class="_ _e"> </span>analysis<span class="_ _15"> </span>tools<span class="_ _15"> </span>that<span class="_ _21"> </span>collect<span class="_ _21"> </span>performance</div><div class="t m5 x1d h26 y50bd ff7 fs19 fc1 sc0 ls0 ws0">data<span class="_ _21"> </span>about<span class="_ _21"> </span>a<span class="_ _21"> </span>program<span class="_ _f"> </span>as<span class="_ _21"> </span>it<span class="_ _21"> </span>executes<span class="_ _0"></span>.<span class="_ _21"> </span>W<span class="_ _3"></span>e<span class="_ _f"> </span>also<span class="_ _21"> </span>discuss<span class="_ _21"> </span>some<span class="_ _f"> </span>general<span class="_ _21"> </span>principles</div><div class="t m5 x1d h26 y50be ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _16"> </span>code<span class="_ _16"> </span>optimization,<span class="_ _16"> </span>including<span class="_ _16"> </span>the<span class="_ _11"> </span>implications<span class="_ _16"> </span>of<span class="_ _16"> </span>Amdahl’s<span class="_ _16"> </span>law<span class="_ _7"></span>,<span class="_ _14"> </span>introduced<span class="_ _16"> </span>in</div><div class="t m5 x1d h26 y50bf ff7 fs19 fc1 sc0 ls0 ws0">Section<span class="_"> </span>1.9.1.</div><div class="t m5 x1d h41 y5fd ffe fs29 fc1 sc0 ls0 ws0">5.14.1<span class="_ _48"> </span><span class="fs19">Program<span class="_"> </span>Proﬁling</span></div><div class="t m5 x1d h26 y5fe ff7 fs19 fc1 sc0 ls0 ws0">Program<span class="_"> </span><span class="ffa">proﬁling<span class="_"> </span></span>involves<span class="_"> </span>running<span class="_"> </span>a<span class="_"> </span>version<span class="_"> </span>of<span class="_ _13"> </span>a<span class="_"> </span>program<span class="_"> </span>in<span class="_"> </span>which<span class="_"> </span>instrumenta-</div><div class="t m5 x1d h26 y5ff ff7 fs19 fc1 sc0 ls0 ws0">tion<span class="_"> </span>code<span class="_"> </span>has<span class="_"> </span>been<span class="_"> </span>incorporated<span class="_"> </span>to<span class="_"> </span>determine<span class="_"> </span>how<span class="_"> </span>much<span class="_"> </span>time<span class="_"> </span>the<span class="_"> </span>different<span class="_"> </span>parts</div><div class="t m5 x1d h26 y600 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _13"> </span>the<span class="_ _13"> </span>program<span class="_ _13"> </span>require<span class="_ _0"></span>.<span class="_ _13"> </span>It<span class="_ _13"> </span>can<span class="_ _13"> </span>be<span class="_ _13"> </span>very<span class="_ _13"> </span>useful<span class="_ _13"> </span>for<span class="_ _13"> </span>identifying<span class="_ _13"> </span>the<span class="_ _13"> </span>parts<span class="_ _13"> </span>of<span class="_ _13"> </span>a<span class="_ _13"> </span>program</div><div class="t m5 x1d h26 y601 ff7 fs19 fc1 sc0 ls0 ws0">we<span class="_"> </span>should<span class="_"> </span>focus<span class="_"> </span>on<span class="_"> </span>in<span class="_"> </span>our<span class="_ _13"> </span>optimization<span class="_"> </span>efforts<span class="_ _1"></span>.<span class="_"> </span>One<span class="_"> </span>strength<span class="_"> </span>of<span class="_"> </span>proﬁling<span class="_"> </span>is<span class="_"> </span>that<span class="_"> </span>it</div><div class="t m5 x1d h26 y602 ff7 fs19 fc1 sc0 ls0 ws0">can<span class="_"> </span>be<span class="_"> </span>performed<span class="_ _13"> </span>while<span class="_"> </span>running<span class="_"> </span>the<span class="_"> </span>actual<span class="_"> </span>program<span class="_"> </span>on<span class="_ _13"> </span>realistic<span class="_"> </span>benchmark<span class="_"> </span>data.</div><div class="t m5 x29 h26 y603 ff7 fs19 fc1 sc0 ls0 ws0">Unix<span class="_ _16"> </span>systems<span class="_ _16"> </span>provide<span class="_ _16"> </span>the<span class="_ _14"> </span>proﬁling<span class="_ _16"> </span>program<span class="_ _16"> </span><span class="ff9">gprof</span>.<span class="_ _16"> </span>This<span class="_ _11"> </span>program<span class="_ _14"> </span>generates</div><div class="t m5 x1d h26 y604 ff7 fs19 fc1 sc0 ls0 ws0">two<span class="_ _14"> </span>forms<span class="_ _15"> </span>of<span class="_ _15"> </span>information.<span class="_ _15"> </span>F<span class="_ _1"></span>irst,<span class="_ _21"> </span>it<span class="_ _15"> </span>determines<span class="_ _15"> </span>how<span class="_ _15"> </span>much<span class="_ _15"> </span>CPU<span class="_ _14"> </span>time<span class="_ _15"> </span>was<span class="_ _15"> </span>spent</div><div class="t m5 x1d h26 y605 ff7 fs19 fc1 sc0 ls0 ws0">for<span class="_ _14"> </span>each<span class="_ _15"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>functions<span class="_ _15"> </span>in<span class="_ _14"> </span>the<span class="_ _15"> </span>program.<span class="_ _15"> </span>Second,<span class="_ _21"> </span>it<span class="_ _15"> </span>computes<span class="_ _14"> </span>a<span class="_ _15"> </span>count<span class="_ _15"> </span>of<span class="_ _15"> </span>how</div><div class="t m5 x1d h26 y606 ff7 fs19 fc1 sc0 ls0 ws0">many<span class="_ _13"> </span>times<span class="_"> </span>each<span class="_ _13"> </span>function<span class="_ _13"> </span>gets<span class="_"> </span>called,<span class="_ _13"> </span>categorized<span class="_ _13"> </span>by<span class="_"> </span>which<span class="_ _13"> </span>function<span class="_ _13"> </span>performs<span class="_"> </span>the</div><div class="t m5 x1d h26 y607 ff7 fs19 fc1 sc0 ls0 ws0">call.<span class="_ _16"> </span>Both<span class="_ _16"> </span>forms<span class="_ _11"> </span>of<span class="_ _16"> </span>information<span class="_ _16"> </span>can<span class="_ _16"> </span>be<span class="_ _16"> </span>quite<span class="_ _16"> </span>useful.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>timings<span class="_ _16"> </span>give<span class="_ _16"> </span>a<span class="_ _16"> </span>sense<span class="_ _16"> </span>of</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
