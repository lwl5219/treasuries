<div id="pf416" class="pf w2 h11" data-page-no="416"><div class="pc pc416 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg416.png"/><div class="t m5 x69 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.5<span class="_ _60"> </span>Synchronizing<span class="_ _10"> </span>Threads<span class="_ _10"> </span>with<span class="_ _10"> </span>Semaphores<span class="_ _3e"> </span><span class="ffe fs1e">1045</span></div><div class="t m5 x17 h2d y82b2 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Global<span class="_ _1f"> </span>variables<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y82b3 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>readcnt;<span class="_ _46"> </span>/*<span class="_ _1f"> </span>Initiall<span class="ls33">y=0*<span class="_ _41"></span>/</span></div><div class="t m5 x17 h2d y82b4 ffd fs1e fc2 sc0 ls0 ws0">sem_t<span class="_ _e"> </span>mutex,<span class="_ _1f"> </span>w;<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Both<span class="_ _1f"> </span>initiall<span class="ls33">y=1*<span class="_ _41"></span>/</span></div><div class="t m5 x17 h2d y82b5 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>reader(void)</div><div class="t m5 x17 h2d y82b6 ffd fs1e fc2 sc0 ls0 ws0">{</div><div class="t m5 x1b6 h2d y82b7 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(1)<span class="_ _1f"> </span>{</div><div class="t m5 x21e h2d y82b8 ffd fs1e fc2 sc0 ls0 ws0">P(&amp;mutex);</div><div class="t m5 x21e h2d y82b9 ffd fs1e fc2 sc0 ls0 ws0">readcnt++;</div><div class="t m5 x21e h2d y82ba ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(readcnt<span class="_ _1f"> </span>==<span class="_ _1f"> </span>1)<span class="_ _e"> </span>/*<span class="_ _1f"> </span>First<span class="_ _e"> </span>in<span class="_ _1f"> </span>*/</div><div class="t m5 x155 h2d y82bb ffd fs1e fc2 sc0 ls0 ws0">P(&amp;w);</div><div class="t m5 x21e h2d y82bc ffd fs1e fc2 sc0 ls0 ws0">V(&amp;mutex);</div><div class="t m5 x21e h2d y82bd ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Critical<span class="_ _1f"> </span>section<span class="_ _1f"> </span>*/</div><div class="t m5 x21e h2d y82be ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Reading<span class="_ _1f"> </span>happens<span class="_ _1a"> </span>*/</div><div class="t m5 x21e h2d y82bf ffd fs1e fc2 sc0 ls0 ws0">P(&amp;mutex);</div><div class="t m5 x21e h2d y82c0 ffd fs1e fc2 sc0 ls0 ws0">readcnt--;</div><div class="t m5 x21e h2d y82c1 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(readcnt<span class="_ _1f"> </span>==<span class="_ _1f"> </span>0)<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Last<span class="_ _e"> </span>out<span class="_ _1f"> </span>*/</div><div class="t m5 x155 h2d y82c2 ffd fs1e fc2 sc0 ls0 ws0">V(&amp;w);</div><div class="t m5 x21e h2d y82c3 ffd fs1e fc2 sc0 ls0 ws0">V(&amp;mutex);</div><div class="t m5 x1b6 h2d y82c4 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h2d y82c5 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h2d y82c6 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>writer(void)</div><div class="t m5 x17 h2d y82c7 ffd fs1e fc2 sc0 ls0 ws0">{</div><div class="t m5 x1b6 h2d y82c8 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(1)<span class="_ _1f"> </span>{</div><div class="t m5 x21e h2d y82c9 ffd fs1e fc2 sc0 ls0 ws0">P(&amp;w);</div><div class="t m5 x21e h2d y82ca ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Critical<span class="_ _1f"> </span>section<span class="_ _1f"> </span>*/</div><div class="t m5 x21e h2d y82cb ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Writing<span class="_ _1f"> </span>happens<span class="_ _1a"> </span>*/</div><div class="t m5 x21e h2d y82cc ffd fs1e fc2 sc0 ls0 ws0">V(&amp;w);</div><div class="t m5 x1b6 h2d y82cd ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h2d y82ce ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h34 y82cf ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _15"> </span>12.26<span class="_ _66"> </span><span class="fc1">Solution<span class="_ _15"> </span>to<span class="_ _15"> </span>the<span class="_ _15"> </span>Ô¨Årst<span class="_ _15"> </span>readers-writers<span class="_ _15"> </span>problem.<span class="_ _15"> </span><span class="ff6">Favors<span class="_ _15"> </span>readers<span class="_ _15"> </span>over</span></span></div><div class="t m5 x17 h34 y82d0 ff6 fs16 fc1 sc0 ls0 ws0">writers.</div><div class="t m5 x26 h26 y8ff ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _16"> </span>the<span class="_ _14"> </span>concurrent<span class="_ _16"> </span>server<span class="_ _14"> </span>in<span class="_ _16"> </span>Figure<span class="_ _16"> </span>12.14,<span class="_ _14"> </span>we<span class="_ _16"> </span>created<span class="_ _14"> </span>a<span class="_ _16"> </span>new<span class="_ _14"> </span>thread<span class="_ _16"> </span>for<span class="_ _14"> </span>each</div><div class="t m5 x17 h26 y900 ff7 fs19 fc1 sc0 ls0 ws0">new<span class="_ _16"> </span>client.<span class="_ _16"> </span>A<span class="_ _14"> </span>disadvantage<span class="_ _16"> </span>of<span class="_ _16"> </span>this<span class="_ _16"> </span>approach<span class="_ _14"> </span>is<span class="_ _16"> </span>that<span class="_ _16"> </span>we<span class="_ _16"> </span>incur<span class="_ _14"> </span>the<span class="_ _16"> </span>nontrivial<span class="_ _16"> </span>cost</div><div class="t m5 x17 h26 y901 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _15"> </span>creating<span class="_ _15"> </span>a<span class="_ _15"> </span>new<span class="_ _15"> </span>thread<span class="_ _15"> </span>for<span class="_ _15"> </span>each<span class="_ _15"> </span>new<span class="_ _15"> </span>client.<span class="_ _15"> </span>A<span class="_ _15"> </span>server<span class="_ _15"> </span>based<span class="_ _15"> </span>on<span class="_ _15"> </span>prethreading</div><div class="t m5 x17 h26 y902 ff7 fs19 fc1 sc0 ls0 ws0">tries<span class="_ _14"> </span>to<span class="_ _15"> </span>reduce<span class="_ _14"> </span>this<span class="_ _15"> </span>overhead<span class="_ _14"> </span>by<span class="_ _15"> </span>using<span class="_ _14"> </span>the<span class="_ _15"> </span>producer<span class="_ _1"></span>-consumer<span class="_ _14"> </span>model<span class="_ _15"> </span>shown<span class="_ _14"> </span>in</div><div class="t m5 x17 h26 y903 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>12.27.<span class="_ _14"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span>server<span class="_ _14"> </span>consists<span class="_ _16"> </span>of<span class="_ _14"> </span>a<span class="_ _16"> </span>main<span class="_ _14"> </span>thread<span class="_ _14"> </span>and<span class="_ _16"> </span>a<span class="_ _14"> </span>set<span class="_ _14"> </span>of<span class="_ _16"> </span>worker<span class="_ _14"> </span>threads<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y904 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>main<span class="_ _11"> </span>thread<span class="_ _11"> </span>repeatedly<span class="_ _11"> </span>accepts<span class="_ _16"> </span>connection<span class="_"> </span>requests<span class="_ _11"> </span>from<span class="_ _11"> </span>clients<span class="_ _11"> </span>and<span class="_ _11"> </span>places</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
