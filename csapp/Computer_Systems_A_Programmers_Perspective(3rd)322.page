<div id="pf142" class="pf w2 h11" data-page-no="142"><div class="pc pc142 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg142.png"/><div class="t m5 xf8 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.10<span class="_ _60"> </span>Combining<span class="_ _10"> </span>Control<span class="_ _10"> </span>and<span class="_ _10"> </span>Data<span class="_ _10"> </span>in<span class="_ _10"> </span>Machine-Level<span class="_ _10"> </span>Programs<span class="_ _3e"> </span><span class="ffe fs1e">321</span></div><div class="t m5 x34 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">W<span class="_ _1"></span>orms<span class="_ _11"> </span>and<span class="_ _16"> </span>viruses</span></div><div class="t m5 x34 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">Both<span class="_ _11"> </span>worms<span class="_ _11"> </span>and<span class="_ _16"> </span>viruses<span class="_ _11"> </span>are<span class="_ _11"> </span>pieces<span class="_ _11"> </span>of<span class="_ _16"> </span>code<span class="_ _11"> </span>that<span class="_ _11"> </span>attempt<span class="_ _16"> </span>to<span class="_ _11"> </span>spread<span class="_ _11"> </span>themselves<span class="_ _11"> </span>among<span class="_ _16"> </span>computers<span class="_ _1"></span>.<span class="_ _11"> </span>As</div><div class="t m5 x34 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">described<span class="_ _6"> </span>by<span class="_ _6"> </span>Spafford<span class="_ _6"> </span>[105],<span class="_ _13"> </span>a<span class="_ _a"> </span><span class="ffa">worm<span class="_ _6"> </span></span>is<span class="_ _6"> </span>a<span class="_ _6"> </span>program<span class="_ _6"> </span>that<span class="_ _6"> </span>can<span class="_ _6"> </span>run<span class="_ _6"> </span>by<span class="_ _13"> </span>itself<span class="_ _a"> </span>and<span class="_ _6"> </span>can<span class="_ _6"> </span>propagate<span class="_ _6"> </span>a<span class="_ _6"> </span>fully<span class="_ _6"> </span>working</div><div class="t m5 x34 h2b y2d2 ff7 fs1e fc2 sc0 ls0 ws0">version<span class="_ _6"> </span>of<span class="_ _13"> </span>itself<span class="_ _6"> </span>to<span class="_ _13"> </span>other<span class="_ _6"> </span>machines<span class="_ _1"></span>.<span class="_ _13"> </span>A<span class="_ _6"> </span><span class="ffa">virus<span class="_ _6"> </span></span>is<span class="_ _13"> </span>a<span class="_ _6"> </span>piece<span class="_ _13"> </span>of<span class="_ _6"> </span>code<span class="_ _13"> </span>that<span class="_ _a"> </span>adds<span class="_ _13"> </span>itself<span class="_ _6"> </span>to<span class="_ _13"> </span>other<span class="_ _6"> </span>programs<span class="_ _1"></span>,<span class="_ _13"> </span>including</div><div class="t m5 x34 h2b y2d3 ff7 fs1e fc2 sc0 ls0 ws0">operating<span class="_"> </span>systems<span class="_ _1"></span>.<span class="_ _10"> </span>It<span class="_ _10"> </span>cannot<span class="_ _10"> </span>run<span class="_ _11"> </span>independently<span class="_ _3"></span>.<span class="_"> </span>In<span class="_"> </span>the<span class="_ _10"> </span>popular<span class="_ _10"> </span>press<span class="_ _0"></span>,<span class="_"> </span>the<span class="_"> </span>term<span class="_ _11"> </span>“virus”<span class="_"> </span>is<span class="_"> </span>used<span class="_ _10"> </span>to<span class="_ _10"> </span>refer</div><div class="t m5 x34 h2b y2d4 ff7 fs1e fc2 sc0 ls0 ws0">to<span class="_ _11"> </span>a<span class="_ _16"> </span>variety<span class="_ _11"> </span>of<span class="_ _11"> </span>different<span class="_ _16"> </span>strategies<span class="_ _11"> </span>for<span class="_ _16"> </span>spreading<span class="_ _11"> </span>attacking<span class="_ _11"> </span>code<span class="_ _16"> </span>among<span class="_ _11"> </span>systems<span class="_ _1"></span>,<span class="_ _16"> </span>and<span class="_ _11"> </span>so<span class="_ _16"> </span>you<span class="_ _11"> </span>will<span class="_ _16"> </span>hear</div><div class="t m5 x34 h2b y2d5 ff7 fs1e fc2 sc0 ls0 ws0">people<span class="_"> </span>saying<span class="_"> </span>“virus”<span class="_"> </span>for<span class="_"> </span>what<span class="_"> </span>more<span class="_"> </span>properly<span class="_"> </span>should<span class="_"> </span>be<span class="_"> </span>called<span class="_"> </span>a<span class="_"> </span>“worm.<span class="_ _1"></span>”</div><div class="t m5 x17 h26 y2dfc ff7 fs19 fc2 sc0 ls0 ws0">this<span class="_ _11"> </span>pointer<span class="_ _11"> </span>requires<span class="_ _11"> </span>knowing<span class="_ _11"> </span>the<span class="_ _11"> </span>stack<span class="_ _16"> </span>address<span class="_"> </span>where<span class="_ _11"> </span>the<span class="_ _16"> </span>string<span class="_"> </span>will<span class="_ _16"> </span>be<span class="_"> </span>located.</div><div class="t m5 x17 h26 y2dfd ff7 fs19 fc2 sc0 ls0 ws0">Historically<span class="_ _3"></span>,<span class="_ _14"> </span>the<span class="_ _15"> </span>stack<span class="_ _14"> </span>addresses<span class="_ _14"> </span>for<span class="_ _14"> </span>a<span class="_ _14"> </span>program<span class="_ _14"> </span>were<span class="_ _14"> </span>highly<span class="_ _15"> </span>predictable<span class="_ _1"></span>.<span class="_ _14"> </span>F<span class="_ _0"></span>or<span class="_ _14"> </span>all</div><div class="t m5 x17 h26 y2dfe ff7 fs19 fc2 sc0 ls0 ws0">systems<span class="_"> </span>running<span class="_ _13"> </span>the<span class="_"> </span>same<span class="_ _13"> </span>combination<span class="_"> </span>of<span class="_ _13"> </span>program<span class="_"> </span>and<span class="_ _13"> </span>operating<span class="_"> </span>system<span class="_ _13"> </span>version,</div><div class="t m5 x17 h26 y2dff ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>stack<span class="_ _16"> </span>locations<span class="_ _14"> </span>were<span class="_ _16"> </span>fairly<span class="_ _16"> </span>stable<span class="_ _14"> </span>across<span class="_ _16"> </span>many<span class="_ _14"> </span>machines<span class="_ _1"></span>.<span class="_ _16"> </span>So<span class="_ _0"></span>,<span class="_ _14"> </span>for<span class="_ _16"> </span>example,<span class="_ _16"> </span>if</div><div class="t m5 x17 h26 y2e00 ff7 fs19 fc2 sc0 ls0 ws0">an<span class="_ _11"> </span>attacker<span class="_ _11"> </span>could<span class="_ _11"> </span>determine<span class="_ _11"> </span>the<span class="_ _11"> </span>stack<span class="_ _11"> </span>addresses<span class="_ _16"> </span>used<span class="_"> </span>by<span class="_ _11"> </span>a<span class="_ _11"> </span>common<span class="_ _16"> </span>W<span class="_ _3"></span>eb<span class="_ _11"> </span>server,</div><div class="t m5 x17 h26 y2e01 ff7 fs19 fc2 sc0 ls0 ws0">it<span class="_ _14"> </span>could<span class="_ _14"> </span>devise<span class="_ _14"> </span>an<span class="_ _14"> </span>attack<span class="_ _15"> </span>that<span class="_ _14"> </span>would<span class="_ _14"> </span>work<span class="_ _14"> </span>on<span class="_ _14"> </span>many<span class="_ _15"> </span>machines<span class="_ _1"></span>.<span class="_ _14"> </span>Using<span class="_ _14"> </span>infectious</div><div class="t m5 x17 h26 y2e02 ff7 fs19 fc2 sc0 ls0 ws0">disease<span class="_ _11"> </span>as<span class="_ _11"> </span>an<span class="_ _11"> </span>analogy<span class="_ _3"></span>,<span class="_ _11"> </span>many<span class="_ _11"> </span>systems<span class="_ _11"> </span>were<span class="_ _11"> </span>vulnerable<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_"> </span>exact<span class="_ _11"> </span>same<span class="_ _11"> </span>strain<span class="_ _11"> </span>of</div><div class="t m5 x17 h26 y2e03 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>virus<span class="_ _1"></span>,<span class="_"> </span>a<span class="_"> </span>phenomenon<span class="_"> </span>often<span class="_"> </span>referred<span class="_"> </span>to<span class="_"> </span>as<span class="_"> </span>a<span class="_"> </span><span class="ffa">security<span class="_"> </span>monoculture<span class="_"> </span></span>[96].</div><div class="t m5 x26 h26 y2e04 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>idea<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ffa">stack<span class="_ _13"> </span>randomization<span class="_ _13"> </span></span>is<span class="_ _13"> </span>to<span class="_ _13"> </span>make<span class="_ _13"> </span>the<span class="_ _13"> </span>position<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>stack<span class="_ _13"> </span>vary<span class="_ _13"> </span>from</div><div class="t m5 x17 h26 y2e05 ff7 fs19 fc2 sc0 ls0 ws0">one<span class="_ _6"> </span>run<span class="_ _6"> </span>of<span class="_ _6"> </span>a<span class="_ _a"> </span>program<span class="_ _6"> </span>to<span class="_ _6"> </span>another.<span class="_ _6"> </span>T<span class="_ _1"></span>hus<span class="_ _0"></span>,<span class="_ _6"> </span>even<span class="_ _6"> </span>if<span class="_ _6"> </span>many<span class="_ _6"> </span>machines<span class="_ _6"> </span>are<span class="_ _6"> </span>running<span class="_ _6"> </span>identical</div><div class="t m5 x17 h26 y2e06 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _1"></span>,<span class="_ _14"> </span>they<span class="_ _14"> </span>would<span class="_ _16"> </span>all<span class="_ _16"> </span>be<span class="_ _14"> </span>using<span class="_ _16"> </span>different<span class="_ _16"> </span>stack<span class="_ _14"> </span>addresses<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _0"></span>his<span class="_ _16"> </span>is<span class="_ _16"> </span>implemented<span class="_ _14"> </span>by</div><div class="t m5 x17 h26 y2e07 ff7 fs19 fc2 sc0 ls0 ws0">allocating<span class="_ _16"> </span>a<span class="_ _11"> </span>random<span class="_ _16"> </span>amount<span class="_ _16"> </span>of<span class="_ _11"> </span>space<span class="_ _16"> </span>between<span class="_ _11"> </span>0<span class="_ _16"> </span>and<span class="_ _16"> </span><span class="ff11">n<span class="_ _11"> </span></span>bytes<span class="_ _16"> </span>on<span class="_ _16"> </span>the<span class="_ _11"> </span>stack<span class="_ _16"> </span>at<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y2e08 ff7 fs19 fc2 sc0 ls0 ws0">start<span class="_ _16"> </span>of<span class="_ _16"> </span>a<span class="_ _11"> </span>program,<span class="_ _14"> </span>for<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _14"> </span>by<span class="_ _16"> </span>using<span class="_ _16"> </span>the<span class="_ _11"> </span>allocation<span class="_ _16"> </span>function<span class="_ _16"> </span><span class="ffd">alloca</span>,<span class="_ _16"> </span>which</div><div class="t m5 x17 h26 y2e09 ff7 fs19 fc2 sc0 ls0 ws0">allocates<span class="_ _13"> </span>space<span class="_ _13"> </span>for<span class="_ _13"> </span>a<span class="_ _6"> </span>speciﬁed<span class="_ _13"> </span>number<span class="_ _13"> </span>of<span class="_ _13"> </span>bytes<span class="_ _13"> </span>on<span class="_ _13"> </span>the<span class="_ _6"> </span>stack.<span class="_ _13"> </span>T<span class="_ _0"></span>his<span class="_ _13"> </span>allocated<span class="_ _13"> </span>space<span class="_ _6"> </span>is</div><div class="t m5 x17 h26 y2e0a ff7 fs19 fc2 sc0 ls0 ws0">not<span class="_"> </span>used<span class="_ _13"> </span>by<span class="_"> </span>the<span class="_ _13"> </span>program,<span class="_"> </span>but<span class="_ _13"> </span>it<span class="_"> </span>causes<span class="_ _13"> </span>all<span class="_"> </span>subsequent<span class="_ _13"> </span>stack<span class="_"> </span>locations<span class="_ _13"> </span>to<span class="_"> </span>vary<span class="_ _13"> </span>from</div><div class="t m5 x17 h26 y2e0b ff7 fs19 fc2 sc0 ls0 ws0">one<span class="_"> </span>execution<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_ _11"> </span>program<span class="_"> </span>to<span class="_ _11"> </span>another.<span class="_"> </span>The<span class="_"> </span>allocation<span class="_"> </span>range<span class="_ _11"> </span><span class="ff11">n<span class="_ _11"> </span></span>needs<span class="_"> </span>to<span class="_ _11"> </span>be<span class="_ _11"> </span>large</div><div class="t m5 x17 h26 y2e0c ff7 fs19 fc2 sc0 ls0 ws0">enough<span class="_"> </span>to<span class="_"> </span>get<span class="_"> </span>sufﬁcient<span class="_ _13"> </span>variations<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>stack<span class="_"> </span>addresses<span class="_ _3"></span>,<span class="_"> </span>yet<span class="_"> </span>small<span class="_"> </span>enough<span class="_"> </span>that<span class="_"> </span>it</div><div class="t m5 x17 h26 y2e0d ff7 fs19 fc2 sc0 ls0 ws0">does<span class="_"> </span>not<span class="_"> </span>waste<span class="_"> </span>too<span class="_"> </span>much<span class="_"> </span>space<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>program.</div><div class="t m5 x26 h26 y2e0e ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>following<span class="_ _6"> </span>code<span class="_ _13"> </span>shows<span class="_ _6"> </span>a<span class="_ _13"> </span>simple<span class="_ _6"> </span>way<span class="_ _6"> </span>to<span class="_ _13"> </span>determine<span class="_ _6"> </span>a<span class="_ _13"> </span>“typical”<span class="_ _6"> </span>stack<span class="_ _13"> </span>address:</div><div class="t m5 x17 h2d y2e0f ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()<span class="_ _1f"> </span>{</div><div class="t m5 x1b6 h2d y2e10 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>local;</div><div class="t m5 x1b6 h2d y2e11 ffd fs1e fc2 sc0 ls0 ws0">printf(&quot;local<span class="_ _e"> </span>at<span class="_ _1f"> </span>%p\n&quot;,<span class="_ _1f"> </span>&amp;local);</div><div class="t m5 x1b6 h2d y2e12 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>0;</div><div class="t m5 x17 h2d y2e13 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h26 y2e14 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _e"> </span>code<span class="_ _f"> </span>simply<span class="_ _f"> </span>prints<span class="_ _e"> </span>the<span class="_ _f"> </span>address<span class="_ _e"> </span>of<span class="_ _21"> </span>a<span class="_ _e"> </span>local<span class="_ _f"> </span>variable<span class="_ _f"> </span>in<span class="_ _e"> </span>the<span class="_ _f"> </span><span class="ffd">main<span class="_ _e"> </span></span>function.</div><div class="t m5 x17 h26 y2e15 ff7 fs19 fc2 sc0 ls0 ws0">Running<span class="_"> </span>the<span class="_"> </span>code<span class="_ _13"> </span>10,000<span class="_"> </span>times<span class="_"> </span>on<span class="_"> </span>a<span class="_ _13"> </span>Linux<span class="_"> </span>machine<span class="_"> </span>in<span class="_"> </span>32-bit<span class="_"> </span>mode<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>addresses</div><div class="t m5 x17 h26 y2e16 ff7 fs19 fc2 sc0 ls0 ws0">ranged<span class="_ _16"> </span>from<span class="_ _11"> </span><span class="ffd">0xff7fc59c<span class="_ _16"> </span></span>to<span class="_ _16"> </span><span class="ffd">0xffffd09c</span>,<span class="_ _16"> </span>a<span class="_ _11"> </span>range<span class="_ _16"> </span>of<span class="_ _16"> </span>around<span class="_ _11"> </span>2</div><div class="t m5 x6a h3c y2e17 ff7 fs25 fc2 sc0 ls0 ws0">23</div><div class="t m5 x6d h26 y2e18 ff7 fs19 fc2 sc0 ls0 ws0">.<span class="_ _16"> </span>Running<span class="_ _11"> </span>in<span class="_ _16"> </span>64-</div><div class="t m5 x17 h26 y2e19 ff7 fs19 fc2 sc0 ls0 ws0">bit<span class="_ _11"> </span>mode<span class="_ _16"> </span>on<span class="_ _11"> </span>the<span class="_ _16"> </span>newer<span class="_ _11"> </span>machine<span class="_ _0"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>addresses<span class="_ _11"> </span>ranged<span class="_ _16"> </span>from<span class="_ _11"> </span><span class="ffd">0x7fff0001b698<span class="_ _16"> </span></span>to</div><div class="t m5 x17 h26 y2e1a ffd fs19 fc2 sc0 ls0 ws0">0x7ffffffaa4a8<span class="ff7">,<span class="_"> </span>a<span class="_"> </span>range<span class="_"> </span>of<span class="_"> </span>nearly<span class="_"> </span>2</span></div><div class="t m5 x24c h3c yd72 ff7 fs25 fc2 sc0 ls0 ws0">32</div><div class="t m5 xba h26 y13c0 ff7 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x26 h26 y13c1 ff7 fs19 fc2 sc0 ls0 ws0">Stack<span class="_ _15"> </span>randomization<span class="_ _21"> </span>has<span class="_ _15"> </span>become<span class="_ _21"> </span>standard<span class="_ _21"> </span>practice<span class="_ _15"> </span>in<span class="_ _21"> </span>Linux<span class="_ _21"> </span>systems<span class="_ _1"></span>.<span class="_ _21"> </span>It<span class="_ _15"> </span>is</div><div class="t m5 x17 h26 y13c2 ff7 fs19 fc2 sc0 ls0 ws0">one<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>larger<span class="_"> </span>class<span class="_"> </span>of<span class="_"> </span>techniques<span class="_"> </span>known<span class="_"> </span>as<span class="_"> </span><span class="ffa">address-space<span class="_"> </span>la<span class="_ _0"></span>yout<span class="_"> </span>randomization<span class="ff7">,</span></span></div><div class="t m5 x17 h26 y13c3 ff7 fs19 fc2 sc0 ls0 ws0">or<span class="_ _14"> </span>ASLR<span class="_ _14"> </span>[99].<span class="_ _15"> </span>W<span class="_ _1"></span>ith<span class="_ _15"> </span>ASLR,<span class="_ _15"> </span>different<span class="_ _14"> </span>parts<span class="_ _15"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span>program,<span class="_ _21"> </span>including<span class="_ _14"> </span>program</div><div class="t m5 x17 h26 y1a80 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _1"></span>,<span class="_"> </span>library<span class="_ _13"> </span>code<span class="_ _1"></span>,<span class="_ _13"> </span>stack,<span class="_ _13"> </span>global<span class="_ _13"> </span>variables<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _13"> </span>heap<span class="_ _13"> </span>data,<span class="_ _13"> </span>are<span class="_ _13"> </span>loaded<span class="_ _13"> </span>into<span class="_ _13"> </span>different</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
