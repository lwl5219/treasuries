<div id="pf1e2" class="pf w2 h11" data-page-no="1e2"><div class="pc pc1e2 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1e2.png"/><div class="t m5 x13d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>4.5<span class="_ _60"> </span>Pipelined<span class="_ _10"> </span>Y86-64<span class="_ _10"> </span>Implementations<span class="_ _3e"> </span><span class="ffe fs1e">481</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">exceptions<span class="_ _6"> </span>correctly<span class="_ _6"> </span>is<span class="_ _6"> </span>a<span class="_ _6"> </span>challenging<span class="_ _6"> </span>aspect<span class="_ _6"> </span>of<span class="_ _6"> </span>any<span class="_ _13"> </span>microprocessor<span class="_ _a"> </span>design.<span class="_ _6"> </span>T<span class="_ _0"></span>hey<span class="_ _6"> </span>can</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">occur<span class="_"> </span>at<span class="_ _11"> </span>unpredictable<span class="_ _11"> </span>times<span class="_ _1"></span>,<span class="_ _11"> </span>and<span class="_ _11"> </span>they<span class="_ _11"> </span>require<span class="_ _11"> </span>creating<span class="_ _11"> </span>a<span class="_"> </span>clean<span class="_ _11"> </span>break<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>ﬂow</div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>instructions<span class="_"> </span>through<span class="_ _13"> </span>the<span class="_"> </span>processor<span class="_"> </span>pipeline<span class="_ _1"></span>.<span class="_"> </span>Our<span class="_"> </span>handling<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>three<span class="_"> </span>internal</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">exceptions<span class="_ _11"> </span>gives<span class="_ _16"> </span>just<span class="_ _11"> </span>a<span class="_ _11"> </span>glimpse<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>true<span class="_ _11"> </span>complexity<span class="_ _16"> </span>of<span class="_ _11"> </span>correctly<span class="_ _11"> </span>detecting<span class="_ _16"> </span>and</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">handling<span class="_"> </span>exceptions<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">Let<span class="_"> </span>us<span class="_ _11"> </span>refer<span class="_"> </span>to<span class="_ _11"> </span>the<span class="_"> </span>instruction<span class="_ _11"> </span>causing<span class="_"> </span>the<span class="_"> </span>exception<span class="_ _11"> </span>as<span class="_"> </span>the<span class="_ _11"> </span><span class="ffa">excepting<span class="_ _11"> </span>instruc-</span></div><div class="t m5 x17 h26 y2fa ffa fs19 fc2 sc0 ls0 ws0">tion<span class="ff7">.<span class="_ _14"> </span>In<span class="_ _15"> </span>the<span class="_ _15"> </span>case<span class="_ _15"> </span>of<span class="_ _15"> </span>an<span class="_ _15"> </span>invalid<span class="_ _14"> </span>instruction<span class="_ _15"> </span>address<span class="_ _1"></span>,<span class="_ _f"> </span>there<span class="_ _15"> </span>is<span class="_ _14"> </span>no<span class="_ _15"> </span>actual<span class="_ _15"> </span>excepting</span></div><div class="t m5 x17 h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">instruction,<span class="_ _16"> </span>but<span class="_ _16"> </span>it<span class="_ _11"> </span>is<span class="_ _16"> </span>useful<span class="_ _16"> </span>to<span class="_ _11"> </span>think<span class="_ _16"> </span>of<span class="_ _16"> </span>there<span class="_ _16"> </span>being<span class="_ _11"> </span>a<span class="_ _16"> </span>sort<span class="_ _16"> </span>of<span class="_ _11"> </span>“virtual<span class="_ _16"> </span>instruction”</div><div class="t m5 x17 h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">at<span class="_"> </span>the<span class="_ _13"> </span>invalid<span class="_"> </span>address<span class="_ _1"></span>.<span class="_"> </span>In<span class="_ _13"> </span>our<span class="_"> </span>simpliﬁed<span class="_"> </span>ISA<span class="_"> </span>model,<span class="_ _13"> </span>we<span class="_"> </span>want<span class="_"> </span>the<span class="_ _13"> </span>processor<span class="_"> </span>to<span class="_"> </span>halt</div><div class="t m5 x17 h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">when<span class="_ _6"> </span>it<span class="_ _13"> </span>reaches<span class="_ _6"> </span>an<span class="_ _13"> </span>exception<span class="_ _6"> </span>and<span class="_ _6"> </span>to<span class="_ _13"> </span>set<span class="_ _6"> </span>the<span class="_ _13"> </span>appropriate<span class="_ _a"> </span>status<span class="_ _13"> </span>code<span class="_ _1"></span>,<span class="_ _13"> </span>as<span class="_ _6"> </span>listed<span class="_ _13"> </span>in<span class="_ _6"> </span>F<span class="_ _0"></span>ig-</div><div class="t m5 x17 h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">ure<span class="_"> </span>4.5.<span class="_"> </span>It<span class="_ _13"> </span>should<span class="_"> </span>appear<span class="_"> </span>that<span class="_"> </span>all<span class="_"> </span>instructions<span class="_ _13"> </span>up<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>excepting<span class="_"> </span>instruction<span class="_ _13"> </span>have</div><div class="t m5 x17 h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">completed,<span class="_ _16"> </span>but<span class="_ _11"> </span>none<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>following<span class="_ _16"> </span>instructions<span class="_ _11"> </span>should<span class="_ _16"> </span>have<span class="_ _11"> </span>any<span class="_ _16"> </span>effect<span class="_ _11"> </span>on<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">programmer<span class="_ _1"></span>-visible<span class="_ _16"> </span>state<span class="_ _1"></span>.<span class="_ _16"> </span>In<span class="_ _16"> </span>a<span class="_ _16"> </span>more<span class="_ _16"> </span>complete<span class="_ _16"> </span>design,<span class="_ _14"> </span>the<span class="_ _16"> </span>processor<span class="_ _16"> </span>would<span class="_ _16"> </span>con-</div><div class="t m5 x17 h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">tinue<span class="_"> </span>by<span class="_"> </span>invoking<span class="_"> </span>an<span class="_"> </span>exception<span class="_ _11"> </span>handler,<span class="_"> </span>a<span class="_"> </span>procedure<span class="_"> </span>that<span class="_"> </span>is<span class="_"> </span>part<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>operating</div><div class="t m5 x17 h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">system,<span class="_ _11"> </span>but<span class="_ _11"> </span>implementing<span class="_ _11"> </span>this<span class="_ _11"> </span>part<span class="_ _11"> </span>of<span class="_ _11"> </span>exception<span class="_ _11"> </span>handling<span class="_ _11"> </span>is<span class="_ _11"> </span>beyond<span class="_ _11"> </span>the<span class="_ _11"> </span>scope<span class="_ _11"> </span>of</div><div class="t m5 x17 h26 y451 ff7 fs19 fc2 sc0 ls0 ws0">our<span class="_"> </span>presentation.</div><div class="t m5 x26 h26 y452 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _6"> </span>a<span class="_ _13"> </span>pipelined<span class="_ _6"> </span>system,<span class="_ _13"> </span>exception<span class="_ _6"> </span>handling<span class="_ _13"> </span>involves<span class="_ _a"> </span>several<span class="_ _13"> </span>subtleties<span class="_ _3"></span>.<span class="_ _13"> </span>F<span class="_ _1"></span>irst,<span class="_ _13"> </span>it<span class="_ _6"> </span>is</div><div class="t m5 x17 h26 y453 ff7 fs19 fc2 sc0 ls0 ws0">possible<span class="_ _13"> </span>to<span class="_ _13"> </span>have<span class="_"> </span>exceptions<span class="_ _13"> </span>triggered<span class="_ _13"> </span>by<span class="_ _13"> </span>multiple<span class="_"> </span>instructions<span class="_ _13"> </span>simultaneously<span class="_ _7"></span>.<span class="_"> </span>F<span class="_ _3"></span>or</div><div class="t m5 x17 h26 y454 ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_"> </span>during<span class="_ _13"> </span>one<span class="_ _13"> </span>cycle<span class="_ _13"> </span>of<span class="_ _13"> </span>pipeline<span class="_ _13"> </span>operation,<span class="_"> </span>we<span class="_ _13"> </span>could<span class="_ _13"> </span>have<span class="_ _13"> </span>a<span class="_ _13"> </span><span class="ffd">halt<span class="_ _10"> </span></span>instruction</div><div class="t m5 x17 h26 y455 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _f"> </span>the<span class="_ _f"> </span>fetch<span class="_ _f"> </span>stage,<span class="_ _e"> </span>and<span class="_ _21"> </span>the<span class="_ _e"> </span>data<span class="_ _21"> </span>memory<span class="_ _f"> </span>could<span class="_ _e"> </span>report<span class="_ _21"> </span>an<span class="_ _f"> </span>out-of-bounds<span class="_ _e"> </span>data</div><div class="t m5 x17 h26 y456 ff7 fs19 fc2 sc0 ls0 ws0">address<span class="_ _6"> </span>for<span class="_ _13"> </span>the<span class="_ _6"> </span>instruction<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _6"> </span>memory<span class="_ _13"> </span>stage<span class="_ _1"></span>.<span class="_ _13"> </span>W<span class="_ _7"></span>e<span class="_ _13"> </span>must<span class="_ _6"> </span>determine<span class="_ _13"> </span>which<span class="_ _6"> </span>of<span class="_ _6"> </span>these</div><div class="t m5 x17 h26 y457 ff7 fs19 fc2 sc0 ls0 ws0">exceptions<span class="_ _6"> </span>the<span class="_ _13"> </span>processor<span class="_ _6"> </span>should<span class="_ _13"> </span>report<span class="_ _6"> </span>to<span class="_ _13"> </span>the<span class="_ _6"> </span>operating<span class="_ _13"> </span>system.<span class="_ _6"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>basic<span class="_ _6"> </span>rule<span class="_ _13"> </span>is<span class="_ _6"> </span>to</div><div class="t m5 x17 h26 y458 ff7 fs19 fc2 sc0 ls0 ws0">put<span class="_ _13"> </span>priority<span class="_ _13"> </span>on<span class="_"> </span>the<span class="_ _13"> </span>exception<span class="_ _13"> </span>triggered<span class="_ _13"> </span>by<span class="_ _13"> </span>the<span class="_"> </span>instruction<span class="_ _13"> </span>that<span class="_ _13"> </span>is<span class="_ _13"> </span>furthest<span class="_ _13"> </span>along<span class="_"> </span>the</div><div class="t m5 x17 h26 y459 ff7 fs19 fc2 sc0 ls0 ws0">pipeline<span class="_ _1"></span>.<span class="_ _6"> </span>In<span class="_ _13"> </span>the<span class="_ _a"> </span>example<span class="_ _6"> </span>above<span class="_ _0"></span>,<span class="_ _6"> </span>this<span class="_ _6"> </span>would<span class="_ _13"> </span>be<span class="_ _a"> </span>the<span class="_ _6"> </span>out-of-bounds<span class="_ _6"> </span>address<span class="_ _6"> </span>attempted</div><div class="t m5 x17 h26 y45a ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_ _6"> </span>the<span class="_ _6"> </span>instruction<span class="_ _6"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>memory<span class="_ _a"> </span>stage.<span class="_ _a"> </span>In<span class="_ _6"> </span>terms<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _a"> </span>machine-language<span class="_ _6"> </span>program,</div><div class="t m5 x17 h26 y45b ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>instruction<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>memory<span class="_ _16"> </span>stage<span class="_ _16"> </span>should<span class="_ _11"> </span>appear<span class="_ _16"> </span>to<span class="_ _11"> </span>execute<span class="_ _16"> </span>before<span class="_ _16"> </span>one<span class="_ _11"> </span>in<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y45c ff7 fs19 fc2 sc0 ls0 ws0">fetch<span class="_ _13"> </span>stage,<span class="_ _13"> </span>and<span class="_"> </span>therefore<span class="_ _13"> </span>only<span class="_"> </span>this<span class="_ _13"> </span>exception<span class="_"> </span>should<span class="_ _13"> </span>be<span class="_"> </span>reported<span class="_ _13"> </span>to<span class="_"> </span>the<span class="_ _13"> </span>operating</div><div class="t m5 x17 h26 y227 ff7 fs19 fc2 sc0 ls0 ws0">system.</div><div class="t m5 x26 h26 y45d ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _f"> </span>second<span class="_ _e"> </span>subtlety<span class="_ _f"> </span>occurs<span class="_ _e"> </span>when<span class="_ _f"> </span>an<span class="_ _e"> </span>instruction<span class="_ _f"> </span>is<span class="_ _e"> </span>ﬁrst<span class="_ _f"> </span>fetched<span class="_ _e"> </span>and<span class="_ _f"> </span>begins</div><div class="t m5 x17 h26 y45e ff7 fs19 fc2 sc0 ls0 ws0">execution,<span class="_ _13"> </span>causes<span class="_ _6"> </span>an<span class="_ _13"> </span>exception,<span class="_ _6"> </span>and<span class="_ _13"> </span>later<span class="_ _6"> </span>is<span class="_ _13"> </span>canceled<span class="_ _6"> </span>due<span class="_ _13"> </span>to<span class="_ _6"> </span>a<span class="_ _6"> </span>mispredicted<span class="_ _13"> </span>branch.</div><div class="t m5 x17 h26 y4ad ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>following<span class="_"> </span>is<span class="_"> </span>an<span class="_"> </span>example<span class="_"> </span>of<span class="_"> </span>such<span class="_"> </span>a<span class="_"> </span>program<span class="_"> </span>in<span class="_"> </span>its<span class="_"> </span>object-code<span class="_"> </span>form:</div><div class="t m5 x17 h2d y19ba ffd fs1e fc2 sc0 ls0 ws0">0x000:<span class="_ _e"> </span>6300<span class="_ _15a"> </span>|<span class="_ _46"> </span>xorq<span class="_ _1f"> </span>%rax,%rax</div><div class="t m5 x17 h2d y4340 ffd fs1e fc2 sc0 ls0 ws0">0x002:<span class="_ _e"> </span>741600000000000000<span class="_ _3f"> </span>|<span class="_ _46"> </span>jne<span class="_ _1a"> </span>target<span class="_ _b9"> </span>#<span class="_ _e"> </span>Not<span class="_ _1f"> </span>taken</div><div class="t m5 x17 h2d y4341 ffd fs1e fc2 sc0 ls0 ws0">0x00b:<span class="_ _e"> </span>30f00100000000000000<span class="_ _1f"> </span>|<span class="_ _46"> </span>irmovq<span class="_ _1f"> </span>$1,<span class="_ _e"> </span>%rax<span class="_ _1a"> </span>#<span class="_ _1f"> </span>Fall<span class="_ _e"> </span>through</div><div class="t m5 x17 h2d y4342 ffd fs1e fc2 sc0 ls0 ws0">0x015:<span class="_ _e"> </span>00<span class="_ _104"> </span>|<span class="_ _46"> </span>halt</div><div class="t m5 x17 h2d y4343 ffd fs1e fc2 sc0 ls0 ws0">0x016:<span class="_ _129"> </span>|<span class="_ _e"> </span>target:</div><div class="t m5 x17 h2d y4344 ffd fs1e fc2 sc0 ls0 ws0">0x016:<span class="_ _e"> </span>ff<span class="_ _104"> </span>|<span class="_ _46"> </span>.byte<span class="_ _1f"> </span>0xFF<span class="_ _118"> </span>#<span class="_ _1f"> </span>Invalid<span class="_ _e"> </span>instruction<span class="_ _1f"> </span>code</div><div class="t m5 x26 h26 y278 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _14"> </span>this<span class="_ _14"> </span>program,<span class="_ _15"> </span>the<span class="_ _15"> </span>pipeline<span class="_ _14"> </span>will<span class="_ _14"> </span>predict<span class="_ _15"> </span>that<span class="_ _14"> </span>the<span class="_ _14"> </span>branch<span class="_ _15"> </span>should<span class="_ _14"> </span>be<span class="_ _14"> </span>taken,</div><div class="t m5 x17 h26 y279 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _16"> </span>so<span class="_ _14"> </span>it<span class="_ _16"> </span>will<span class="_ _16"> </span>fetch<span class="_ _14"> </span>and<span class="_ _16"> </span>attempt<span class="_ _14"> </span>to<span class="_ _16"> </span>use<span class="_ _14"> </span>a<span class="_ _16"> </span>byte<span class="_ _16"> </span>with<span class="_ _14"> </span>value<span class="_ _16"> </span><span class="ffd">0xFF<span class="_ _14"> </span></span>as<span class="_ _16"> </span>an<span class="_ _14"> </span>instruction</div><div class="t m5 x17 h26 y27a ff7 fs19 fc2 sc0 ls0 ws0">(generated<span class="_ _13"> </span>in<span class="_"> </span>the<span class="_ _13"> </span>assembly<span class="_ _13"> </span>code<span class="_ _13"> </span>using<span class="_"> </span>the<span class="_ _13"> </span><span class="ffd">.byte<span class="_ _13"> </span></span>directive).<span class="_"> </span>T<span class="_ _3"></span>he<span class="_"> </span>decode<span class="_ _13"> </span>stage<span class="_ _13"> </span>will</div><div class="t m5 x17 h26 y27b ff7 fs19 fc2 sc0 ls0 ws0">therefore<span class="_"> </span>detect<span class="_ _13"> </span>an<span class="_"> </span>invalid<span class="_ _13"> </span>instruction<span class="_"> </span>exception.<span class="_ _13"> </span>Later,<span class="_ _13"> </span>the<span class="_"> </span>pipeline<span class="_ _13"> </span>will<span class="_"> </span>discover</div><div class="t m5 x17 h26 y27c ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _21"> </span>the<span class="_ _21"> </span>branch<span class="_ _21"> </span>should<span class="_ _21"> </span>not<span class="_ _21"> </span>be<span class="_ _21"> </span>taken,<span class="_ _f"> </span>and<span class="_ _21"> </span>so<span class="_ _21"> </span>the<span class="_ _21"> </span>instruction<span class="_ _f"> </span>at<span class="_ _21"> </span>address<span class="_ _21"> </span><span class="ffd">0x016</span></div><div class="t m5 x17 h26 y27d ff7 fs19 fc2 sc0 ls0 ws0">should<span class="_ _11"> </span>never<span class="_ _16"> </span>even<span class="_ _16"> </span>have<span class="_ _11"> </span>been<span class="_ _16"> </span>fetched.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_ _11"> </span>pipeline<span class="_ _16"> </span>control<span class="_ _16"> </span>logic<span class="_ _11"> </span>will<span class="_ _16"> </span>cancel<span class="_ _11"> </span>this</div><div class="t m5 x17 h26 y27e ff7 fs19 fc2 sc0 ls0 ws0">instruction,<span class="_"> </span>but<span class="_"> </span>we<span class="_"> </span>want<span class="_"> </span>to<span class="_"> </span>avoid<span class="_"> </span>raising<span class="_"> </span>an<span class="_"> </span>exception.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
