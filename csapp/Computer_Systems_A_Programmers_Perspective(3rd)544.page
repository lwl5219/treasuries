<div id="pf220" class="pf w2 h11" data-page-no="220"><div class="pc pc220 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg220.png"/><div class="t m5 xb9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>5.3<span class="_ _60"> </span>Program<span class="_ _10"> </span>Example<span class="_ _3e"> </span><span class="ffe fs1e">543</span></div><div class="t m5 x2c h2d y4a2c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Implementation<span class="_ _e"> </span>with<span class="_ _1f"> </span>maximum<span class="_ _1f"> </span>use<span class="_ _e"> </span>of<span class="_ _1f"> </span>data<span class="_ _e"> </span>abstraction<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y4a2d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>combine1(vec_ptr<span class="_ _e"> </span>v,<span class="_ _1f"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x2c h2d y4a2e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y4a30 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>i;</span></div><div class="t m5 x2c h2e y4aaa ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y4aab ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x142 h2d y4aac ffd fs1e fc2 sc0 ls0 ws0">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>IDENT;</div><div class="t m5 x2c h2d y4a33 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>vec_length(v);<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</span></div><div class="t m5 x2c h2d y4a34 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>val;</span></div><div class="t m5 x2c h2d y4aad ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2">get_vec_element(v,<span class="_ _e"> </span>i,<span class="_ _1f"> </span>&amp;val);</span></div><div class="t m5 x17 h2d y4a37 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>*dest<span class="_ _1f"> </span>OP<span class="_ _e"> </span>val;</span></div><div class="t m5 x17 h2d y4a38 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y4a39 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h34 y4aae ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>5.5<span class="_ _c"> </span><span class="fc1">Initial<span class="_ _16"> </span>implementation<span class="_ _14"> </span>of<span class="_ _16"> </span>combining<span class="_ _14"> </span>operation.<span class="_ _16"> </span><span class="ff6">Using<span class="_ _16"> </span>different<span class="_ _14"> </span>decla-</span></span></div><div class="t m5 x17 h34 y4aaf ff6 fs16 fc1 sc0 ls0 ws0">rations<span class="_ _16"> </span>of<span class="_ _16"> </span>identity<span class="_ _16"> </span>element</div><div class="t m5 x1ec h3a y4ab0 ffd fs19 fc1 sc0 ls0 ws0">IDENT<span class="_ _16"> </span><span class="ff6 fs16">and<span class="_ _16"> </span>combining<span class="_ _16"> </span>operation<span class="_ _16"> </span></span>OP<span class="ff6 fs16">,<span class="_ _14"> </span>we<span class="_ _16"> </span>can<span class="_ _16"> </span>measure<span class="_ _16"> </span>the</span></div><div class="t m5 x17 h34 y4ab1 ff6 fs16 fc1 sc0 ls0 ws0">routine<span class="_ _10"> </span>for<span class="_ _11"> </span>different<span class="_ _10"> </span>operations.</div><div class="t m5 x17 h26 y418 ff7 fs19 fc1 sc0 ls0 ws0">we<span class="_ _11"> </span>measured<span class="_ _16"> </span>the<span class="_ _11"> </span>CPE<span class="_ _11"> </span>performance<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>functions<span class="_ _11"> </span>on<span class="_ _11"> </span>a<span class="_ _16"> </span>machine<span class="_ _11"> </span>with<span class="_ _16"> </span>an<span class="_ _11"> </span>Intel</div><div class="t m5 x17 h26 y419 ff7 fs19 fc1 sc0 ls0 ws0">Core<span class="_ _14"> </span>i7<span class="_ _14"> </span>Haswell<span class="_ _14"> </span>processor,<span class="_ _15"> </span>which<span class="_ _14"> </span>we<span class="_ _14"> </span>refer<span class="_ _15"> </span>to<span class="_ _14"> </span>as<span class="_ _14"> </span>our<span class="_ _14"> </span><span class="ffa">reference<span class="_ _15"> </span>machine</span>.<span class="_ _24"> </span>Some</div><div class="t m5 x17 h26 y41a ff7 fs19 fc1 sc0 ls0 ws0">characteristics<span class="_ _16"> </span>of<span class="_ _16"> </span>this<span class="_ _16"> </span>processor<span class="_ _16"> </span>were<span class="_ _16"> </span>given<span class="_ _16"> </span>in<span class="_ _16"> </span>Section<span class="_ _16"> </span>3.1.<span class="_ _16"> </span>These<span class="_ _11"> </span>measurements</div><div class="t m5 x17 h26 y41b ff7 fs19 fc1 sc0 ls0 ws0">characterize<span class="_ _13"> </span>performance<span class="_ _13"> </span>in<span class="_ _13"> </span>terms<span class="_ _13"> </span>of<span class="_"> </span>how<span class="_ _13"> </span>the<span class="_ _13"> </span>programs<span class="_ _13"> </span>run<span class="_ _13"> </span>on<span class="_ _13"> </span>just<span class="_ _13"> </span>one<span class="_ _13"> </span>particular</div><div class="t m5 x17 h26 y41c ff7 fs19 fc1 sc0 ls0 ws0">machine<span class="_ _1"></span>,<span class="_ _1f"> </span>and<span class="_ _e"> </span>so<span class="_ _21"> </span>there<span class="_ _e"> </span>is<span class="_ _f"> </span>no<span class="_ _e"> </span>guarantee<span class="_ _f"> </span>of<span class="_ _e"> </span>comparable<span class="_ _f"> </span>performance<span class="_ _e"> </span>on<span class="_ _21"> </span>other</div><div class="t m5 x17 h26 y41d ff7 fs19 fc1 sc0 ls0 ws0">combinations<span class="_"> </span>of<span class="_ _11"> </span>machine<span class="_"> </span>and<span class="_ _11"> </span>compiler.<span class="_"> </span>However,<span class="_"> </span>we<span class="_ _11"> </span>have<span class="_"> </span>compared<span class="_ _11"> </span>the<span class="_"> </span>results</div><div class="t m5 x17 h26 y41e ff7 fs19 fc1 sc0 ls0 ws0">with<span class="_ _14"> </span>those<span class="_ _14"> </span>for<span class="_ _15"> </span>a<span class="_ _14"> </span>number<span class="_ _15"> </span>of<span class="_ _14"> </span>different<span class="_ _15"> </span>compiler/processor<span class="_ _14"> </span>combinations<span class="_ _1"></span>,<span class="_ _15"> </span>and<span class="_ _15"> </span>we</div><div class="t m5 x17 h26 y41f ff7 fs19 fc1 sc0 ls0 ws0">have<span class="_"> </span>found<span class="_"> </span>them<span class="_"> </span>generally<span class="_"> </span>consistent<span class="_"> </span>with<span class="_"> </span>those<span class="_"> </span>presented<span class="_"> </span>here<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y420 ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _f"> </span>we<span class="_ _e"> </span>proceed<span class="_ _f"> </span>through<span class="_ _f"> </span>a<span class="_ _e"> </span>set<span class="_ _f"> </span>of<span class="_ _f"> </span>transformations<span class="_ _1"></span>,<span class="_ _1f"> </span>we<span class="_ _f"> </span>will<span class="_ _e"> </span>ﬁnd<span class="_ _21"> </span>that<span class="_ _e"> </span>many</div><div class="t m5 x17 h26 y421 ff7 fs19 fc1 sc0 ls0 ws0">lead<span class="_ _15"> </span>to<span class="_ _15"> </span>only<span class="_ _21"> </span>minimal<span class="_ _15"> </span>performance<span class="_ _21"> </span>gains<span class="_ _1"></span>,<span class="_ _21"> </span>while<span class="_ _21"> </span>others<span class="_ _15"> </span>have<span class="_ _21"> </span>more<span class="_ _15"> </span>dramatic<span class="_ _21"> </span>ef-</div><div class="t m5 x17 h26 y423 ff7 fs19 fc1 sc0 ls0 ws0">fects<span class="_ _1"></span>.<span class="_ _f"> </span>Determining<span class="_ _e"> </span>which<span class="_ _f"> </span>combinations<span class="_ _f"> </span>of<span class="_ _e"> </span>transformations<span class="_ _f"> </span>to<span class="_ _e"> </span>apply<span class="_ _21"> </span>is<span class="_ _e"> </span>indeed</div><div class="t m5 x17 h26 y424 ff7 fs19 fc1 sc0 ls0 ws0">part<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>“black<span class="_ _11"> </span>art”<span class="_ _11"> </span>of<span class="_ _16"> </span>writing<span class="_ _11"> </span>fast<span class="_ _11"> </span>code.<span class="_"> </span>Some<span class="_ _16"> </span>combinations<span class="_ _11"> </span>that<span class="_ _11"> </span>do<span class="_ _11"> </span>not<span class="_ _16"> </span>pro-</div><div class="t m5 x17 h26 y425 ff7 fs19 fc1 sc0 ls0 ws0">vide<span class="_ _15"> </span>measurable<span class="_ _15"> </span>beneﬁts<span class="_ _15"> </span>are<span class="_ _15"> </span>indeed<span class="_ _15"> </span>ineffective,<span class="_ _15"> </span>while<span class="_ _15"> </span>others<span class="_ _15"> </span>are<span class="_ _15"> </span>important<span class="_ _15"> </span>as</div><div class="t m5 x17 h26 y426 ff7 fs19 fc1 sc0 ls0 ws0">ways<span class="_ _21"> </span>to<span class="_ _f"> </span>enable<span class="_ _f"> </span>further<span class="_ _f"> </span>optimizations<span class="_ _f"> </span>by<span class="_ _f"> </span>the<span class="_ _f"> </span>compiler.<span class="_ _21"> </span>In<span class="_ _f"> </span>our<span class="_ _f"> </span>experience<span class="_ _1"></span>,<span class="_ _e"> </span>the</div><div class="t m5 x17 h26 y427 ff7 fs19 fc1 sc0 ls0 ws0">best<span class="_ _16"> </span>approach<span class="_ _14"> </span>involves<span class="_ _14"> </span>a<span class="_ _14"> </span>combination<span class="_ _16"> </span>of<span class="_ _14"> </span>experimentation<span class="_ _14"> </span>and<span class="_ _14"> </span>analysis:<span class="_ _14"> </span>repeat-</div><div class="t m5 x17 h26 y428 ff7 fs19 fc1 sc0 ls0 ws0">edly<span class="_"> </span>attempting<span class="_ _11"> </span>different<span class="_"> </span>approaches<span class="_ _1"></span>,<span class="_ _11"> </span>performing<span class="_"> </span>measurements<span class="_ _1"></span>,<span class="_ _11"> </span>and<span class="_"> </span>examining</div><div class="t m5 x17 h26 y429 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _f"> </span>assembly-code<span class="_ _f"> </span>representations<span class="_ _f"> </span>to<span class="_ _f"> </span>identify<span class="_ _e"> </span>underlying<span class="_ _21"> </span>performance<span class="_ _f"> </span>bottle-</div><div class="t m5 x17 h26 y42a ff7 fs19 fc1 sc0 ls0 ws0">necks<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y42b ff7 fs19 fc1 sc0 ls0 ws0">As<span class="_ _22"> </span>a<span class="_ _22"> </span>starting<span class="_ _22"> </span>point,<span class="_ _25"> </span>the<span class="_ _22"> </span>following<span class="_ _22"> </span>table<span class="_ _22"> </span>shows<span class="_ _22"> </span>CPE<span class="_ _23"> </span>measurements<span class="_ _22"> </span>for</div><div class="t m5 x17 h26 y42c ffd fs19 fc1 sc0 ls0 ws0">combine1<span class="_ _e"> </span><span class="ff7">running<span class="_ _f"> </span>on<span class="_ _e"> </span>our<span class="_ _e"> </span>reference<span class="_ _e"> </span>machine<span class="_ _1"></span>,<span class="_ _1f"> </span>with<span class="_ _e"> </span>different<span class="_ _e"> </span>combinations<span class="_ _f"> </span>of</span></div><div class="t m5 x17 h26 y42d ff7 fs19 fc1 sc0 ls0 ws0">operation<span class="_ _14"> </span>(addition<span class="_ _14"> </span>or<span class="_ _14"> </span>multiplication)<span class="_ _14"> </span>and<span class="_ _15"> </span>data<span class="_ _14"> </span>type<span class="_ _14"> </span>(long<span class="_ _14"> </span>integer<span class="_ _14"> </span>and<span class="_ _15"> </span>double-</div><div class="t m5 x17 h26 y42e ff7 fs19 fc1 sc0 ls0 ws0">precision<span class="_"> </span>ﬂoating<span class="_ _13"> </span>point).<span class="_"> </span>Our<span class="_"> </span>experiments<span class="_ _13"> </span>with<span class="_"> </span>many<span class="_"> </span>different<span class="_ _13"> </span>programs<span class="_"> </span>showed</div><div class="t m5 x17 h26 y42f ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _15"> </span>operations<span class="_ _15"> </span>on<span class="_ _21"> </span>32-bit<span class="_ _15"> </span>and<span class="_ _15"> </span>64-bit<span class="_ _21"> </span>integers<span class="_ _15"> </span>have<span class="_ _15"> </span>identical<span class="_ _21"> </span>performance<span class="_ _1"></span>,<span class="_ _f"> </span>with</div><div class="t m5 x17 h26 y430 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>exception<span class="_"> </span>of<span class="_"> </span>code<span class="_"> </span>involving<span class="_"> </span>division<span class="_"> </span>operations<span class="_ _1"></span>.<span class="_"> </span>Similarly<span class="_ _7"></span>,<span class="_"> </span>we<span class="_"> </span>found<span class="_"> </span>identical</div><div class="t m5 x17 h26 y431 ff7 fs19 fc1 sc0 ls0 ws0">performance<span class="_ _13"> </span>for<span class="_ _13"> </span>programs<span class="_ _13"> </span>operating<span class="_ _13"> </span>on<span class="_ _13"> </span>single-<span class="_ _13"> </span>or<span class="_ _13"> </span>double-precision<span class="_ _13"> </span>ﬂoating-point</div><div class="t m5 x17 h26 y432 ff7 fs19 fc1 sc0 ls0 ws0">data.<span class="_ _11"> </span>In<span class="_ _16"> </span>our<span class="_ _11"> </span>tables<span class="_ _1"></span>,<span class="_ _16"> </span>we<span class="_ _11"> </span>will<span class="_ _11"> </span>therefore<span class="_ _16"> </span>show<span class="_ _11"> </span>only<span class="_ _16"> </span>separate<span class="_ _11"> </span>results<span class="_ _11"> </span>for<span class="_ _16"> </span>integer<span class="_ _11"> </span>data</div><div class="t m5 x17 h26 y433 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>for<span class="_"> </span>ﬂoating-point<span class="_"> </span>data.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
