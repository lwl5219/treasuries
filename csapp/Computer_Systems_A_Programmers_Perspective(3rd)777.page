<div id="pf309" class="pf w2 h11" data-page-no="309"><div class="pc pc309 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg309.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">776<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _21"> </span><span class="ffa">parent<span class="_ _21"> </span>process<span class="_ _f"> </span></span>creates<span class="_ _21"> </span>a<span class="_ _21"> </span>new<span class="_ _f"> </span>running<span class="_ _21"> </span><span class="ffa">child<span class="_ _21"> </span>process<span class="_ _21"> </span></span>by<span class="_ _21"> </span>calling<span class="_ _f"> </span>the<span class="_ _21"> </span><span class="ffd">fork</span></div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">function.</div><div class="t m5 x126 h2d y65cb ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;sys/types.h&gt;</div><div class="t m5 x126 h2d y65cc ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;unistd.h&gt;</div><div class="t m5 x126 h2d y65cd ffd fs1e fc2 sc0 ls0 ws0">pid_t<span class="_ _e"> </span>fork(void);</div><div class="t m5 xa7 hf2 y65ce ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>0<span class="_"> </span>to<span class="_"> </span>child,<span class="_"> </span>PID<span class="_"> </span>of<span class="_"> </span>child<span class="_"> </span>to<span class="_"> </span>parent,<span class="_"> </span><span class="ff12">−</span>1<span class="_ _13"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y65cf ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>newly<span class="_ _11"> </span>created<span class="_ _11"> </span>child<span class="_ _16"> </span>process<span class="_ _11"> </span>is<span class="_ _11"> </span>almost,<span class="_ _16"> </span>but<span class="_ _11"> </span>not<span class="_ _16"> </span>quite<span class="_ _1"></span>,<span class="_ _16"> </span>identical<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span>parent.</div><div class="t m5 x1d h26 y65d0 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>child<span class="_ _16"> </span>gets<span class="_ _16"> </span>an<span class="_ _16"> </span>identical<span class="_ _16"> </span>(but<span class="_ _16"> </span>separate)<span class="_ _16"> </span>copy<span class="_ _14"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>parent’s<span class="_ _11"> </span>user<span class="_ _1"></span>-level<span class="_ _16"> </span>virtual</div><div class="t m5 x1d h26 y65d1 ff7 fs19 fc2 sc0 ls0 ws0">address<span class="_ _11"> </span>space<span class="_ _0"></span>,<span class="_ _11"> </span>including<span class="_ _16"> </span>the<span class="_ _11"> </span>code<span class="_ _11"> </span>and<span class="_ _16"> </span>data<span class="_ _11"> </span>segments<span class="_ _1"></span>,<span class="_ _11"> </span>heap,<span class="_ _11"> </span>shared<span class="_ _11"> </span>libraries<span class="_ _1"></span>,<span class="_ _16"> </span>and</div><div class="t m5 x1d h26 y65d2 ff7 fs19 fc2 sc0 ls0 ws0">user<span class="_ _14"> </span>stack.<span class="_ _15"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>child<span class="_ _15"> </span>also<span class="_ _15"> </span>gets<span class="_ _14"> </span>identical<span class="_ _15"> </span>copies<span class="_ _14"> </span>of<span class="_ _15"> </span>any<span class="_ _15"> </span>of<span class="_ _14"> </span>the<span class="_ _15"> </span>parent’s<span class="_ _14"> </span>open<span class="_ _15"> </span>ﬁle</div><div class="t m5 x1d h26 y65d3 ff7 fs19 fc2 sc0 ls0 ws0">descriptors<span class="_ _1"></span>,<span class="_"> </span>which<span class="_"> </span>means<span class="_ _11"> </span>the<span class="_"> </span>child<span class="_"> </span>can<span class="_"> </span>read<span class="_ _11"> </span>and<span class="_"> </span>write<span class="_"> </span>any<span class="_"> </span>ﬁles<span class="_ _11"> </span>that<span class="_"> </span>were<span class="_"> </span>open<span class="_"> </span>in</div><div class="t m5 x1d h26 y65d4 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>parent<span class="_ _13"> </span>when<span class="_ _6"> </span>it<span class="_ _13"> </span>called<span class="_ _13"> </span><span class="ffd">fork</span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>most<span class="_ _13"> </span>signiﬁcant<span class="_ _6"> </span>difference<span class="_ _13"> </span>between<span class="_ _13"> </span>the<span class="_ _13"> </span>parent</div><div class="t m5 x1d h26 y65d5 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>the<span class="_"> </span>newly<span class="_"> </span>created<span class="_"> </span>child<span class="_"> </span>is<span class="_"> </span>that<span class="_"> </span>they<span class="_"> </span>have<span class="_"> </span>different<span class="_"> </span>PIDs<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y65d6 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_"> </span><span class="ffd ls0">fork<span class="_ _13"> </span><span class="ff7">function<span class="_ _13"> </span>is<span class="_ _6"> </span>interesting<span class="_ _13"> </span>(and<span class="_ _13"> </span>often<span class="_ _6"> </span>confusing)<span class="_ _13"> </span>because<span class="_ _13"> </span>it<span class="_ _6"> </span>is<span class="_ _13"> </span>called<span class="_ _13"> </span><span class="ffa">once</span></span></span></div><div class="t m5 x1d h26 y65d7 ff7 fs19 fc2 sc0 ls0 ws0">but<span class="_ _13"> </span>it<span class="_ _13"> </span>returns<span class="_"> </span><span class="ffa">twice:<span class="_ _13"> </span></span>once<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>calling<span class="_ _13"> </span>process<span class="_ _13"> </span>(the<span class="_ _13"> </span>parent),<span class="_"> </span>and<span class="_ _13"> </span>once<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>newly</div><div class="t m5 x1d h26 y65d8 ff7 fs19 fc2 sc0 ls0 ws0">created<span class="_ _13"> </span>child<span class="_ _13"> </span>process<span class="_ _3"></span>.<span class="_ _13"> </span>In<span class="_ _13"> </span>the<span class="_ _13"> </span>parent,<span class="_ _13"> </span><span class="ffd">fork<span class="_ _6"> </span></span>returns<span class="_ _13"> </span>the<span class="_ _13"> </span>PID<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>child.<span class="_ _13"> </span>In<span class="_ _13"> </span>the<span class="_ _13"> </span>child,</div><div class="t m5 x1d h26 y65d9 ffd fs19 fc2 sc0 ls0 ws0">fork<span class="_ _10"> </span><span class="ff7">returns<span class="_ _13"> </span>a<span class="_"> </span>value<span class="_"> </span>of<span class="_ _13"> </span>0.<span class="_"> </span>Since<span class="_"> </span>the<span class="_ _13"> </span>PID<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>child<span class="_"> </span>is<span class="_"> </span>always<span class="_ _13"> </span>nonzero,<span class="_ _13"> </span>the<span class="_"> </span>return</span></div><div class="t m5 x1d h26 y65da ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_ _11"> </span>provides<span class="_ _16"> </span>an<span class="_ _11"> </span>unambiguous<span class="_ _16"> </span>way<span class="_ _11"> </span>to<span class="_ _11"> </span>tell<span class="_ _16"> </span>whether<span class="_ _11"> </span>the<span class="_ _16"> </span>program<span class="_ _11"> </span>is<span class="_ _16"> </span>executing<span class="_ _11"> </span>in</div><div class="t m5 x1d h26 y65db ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>parent<span class="_"> </span>or<span class="_"> </span>the<span class="_"> </span>child.</div><div class="t m5 x29 h26 y65dc ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _13"> </span>8.15<span class="_ _a"> </span>shows<span class="_ _6"> </span>a<span class="_ _6"> </span>simple<span class="_ _13"> </span>example<span class="_ _a"> </span>of<span class="_ _6"> </span>a<span class="_ _6"> </span>parent<span class="_ _6"> </span>process<span class="_ _13"> </span>that<span class="_ _a"> </span>uses<span class="_ _6"> </span><span class="ffd">fork<span class="_ _6"> </span></span>to<span class="_ _13"> </span>create</div><div class="t m5 x1d h26 y65dd ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>child<span class="_ _13"> </span>process<span class="_ _1"></span>.<span class="_"> </span>When<span class="_"> </span>the<span class="_ _13"> </span><span class="ffd">fork<span class="_ _10"> </span></span>call<span class="_"> </span>returns<span class="_ _13"> </span>in<span class="_"> </span>line<span class="_"> </span>6,<span class="_"> </span><span class="ffd">x<span class="_ _13"> </span></span>has<span class="_"> </span>a<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_"> </span>1<span class="_"> </span>in<span class="_ _13"> </span>both<span class="_"> </span>the</div><div class="t m5 x1d h26 y65de ff7 fs19 fc2 sc0 ls0 ws0">parent<span class="_"> </span>and<span class="_"> </span>child.<span class="_ _13"> </span>The<span class="_ _13"> </span>child<span class="_"> </span>increments<span class="_"> </span>and<span class="_"> </span>prints<span class="_ _13"> </span>its<span class="_"> </span>copy<span class="_"> </span>of<span class="_"> </span><span class="ffd">x<span class="_ _10"> </span></span>in<span class="_"> </span>line<span class="_ _13"> </span>8.<span class="_"> </span>Similarly<span class="_ _3"></span>,</div><div class="t m5 x1d h26 y65df ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>parent<span class="_"> </span>decrements<span class="_"> </span>and<span class="_"> </span>prints<span class="_"> </span>its<span class="_"> </span>copy<span class="_"> </span>of<span class="_"> </span><span class="ffd">x<span class="_ _10"> </span></span>in<span class="_"> </span>line<span class="_"> </span>13.</div><div class="t m5 x29 h26 y65e0 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_"> </span>we<span class="_"> </span>run<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>on<span class="_"> </span>our<span class="_"> </span>Unix<span class="_"> </span>system,<span class="_"> </span>we<span class="_"> </span>get<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>result:</div><div class="t m5 x1d h2d y65e1 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">./fork</span></div><div class="t m5 x1d h2d y65e2 ffd fs1e fc2 sc0 ls0 ws0">parent:<span class="_ _e"> </span>x=0</div><div class="t m5 x1d h2d y65e3 ffd fs1e fc2 sc0 ls0 ws0">child<span class="_ _e"> </span>:<span class="_ _1f"> </span>x=2</div><div class="t m5 x29 h26 y65e4 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>here<span class="_"> </span>are<span class="_"> </span>some<span class="_"> </span>subtle<span class="_"> </span>aspects<span class="_"> </span>to<span class="_"> </span>this<span class="_"> </span>simple<span class="_"> </span>example.</div><div class="t m5 x75 h26 y65e5 ffa fs19 fc2 sc0 ls0 ws0">Call<span class="_ _16"> </span>once,<span class="_ _16"> </span>return<span class="_ _16"> </span>twice<span class="_ _1"></span>.<span class="_ _f"> </span><span class="ff7 lsd">Th<span class="_ _2"></span>e<span class="_ _14"> </span></span><span class="ffd">fork<span class="_ _16"> </span><span class="ff7">function<span class="_ _16"> </span>is<span class="_ _16"> </span>called<span class="_ _16"> </span>once<span class="_ _16"> </span>by<span class="_ _16"> </span>the<span class="_ _16"> </span>parent,<span class="_ _14"> </span>but<span class="_ _16"> </span>it</span></span></div><div class="t m5 xcd h26 y65e6 ff7 fs19 fc2 sc0 ls0 ws0">returns<span class="_ _14"> </span>twice:<span class="_ _15"> </span>once<span class="_ _14"> </span>to<span class="_ _15"> </span>the<span class="_ _14"> </span>parent<span class="_ _15"> </span>and<span class="_ _14"> </span>once<span class="_ _14"> </span>to<span class="_ _15"> </span>the<span class="_ _14"> </span>newly<span class="_ _15"> </span>created<span class="_ _14"> </span>child.</div><div class="t m5 xcd h26 y65e7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _11"> </span>is<span class="_"> </span>fairly<span class="_ _11"> </span>straightforward<span class="_ _11"> </span>for<span class="_"> </span>programs<span class="_ _11"> </span>that<span class="_"> </span>create<span class="_ _11"> </span>a<span class="_ _11"> </span>single<span class="_"> </span>child.<span class="_ _11"> </span>But</div><div class="t m5 xcd h26 y65e8 ff7 fs19 fc2 sc0 ls0 ws0">programs<span class="_ _11"> </span>with<span class="_ _16"> </span>multiple<span class="_ _16"> </span>instances<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffd">fork<span class="_ _16"> </span></span>can<span class="_ _11"> </span>be<span class="_ _16"> </span>confusing<span class="_ _16"> </span>and<span class="_ _11"> </span>need<span class="_ _16"> </span>to</div><div class="t m5 xcd h26 y65e9 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_"> </span>reasoned<span class="_"> </span>about<span class="_"> </span>carefully<span class="_ _3"></span>.</div><div class="t m5 x23a h26 y65ea ffa fs19 fc2 sc0 ls0 ws0">Concurrent<span class="_ _21"> </span>execution.<span class="_ _21"> </span><span class="ff7">T<span class="_ _1"></span>he<span class="_ _f"> </span>parent<span class="_ _21"> </span>and<span class="_ _21"> </span>the<span class="_ _f"> </span>child<span class="_ _21"> </span>are<span class="_ _f"> </span>separate<span class="_ _21"> </span>processes<span class="_ _f"> </span>that</span></div><div class="t m5 xcd h26 y65eb ff7 fs19 fc2 sc0 ls0 ws0">run<span class="_ _14"> </span>concurrently<span class="_ _3"></span>.<span class="_ _15"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>instructions<span class="_ _15"> </span>in<span class="_ _15"> </span>their<span class="_ _15"> </span>logical<span class="_ _15"> </span>control<span class="_ _14"> </span>ﬂows<span class="_ _15"> </span>can<span class="_ _15"> </span>be</div><div class="t m5 xcd h26 y65ec ff7 fs19 fc2 sc0 ls0 ws0">interleaved<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>kernel<span class="_"> </span>in<span class="_"> </span>an<span class="_"> </span>arbitrary<span class="_ _11"> </span>way<span class="_ _3"></span>.<span class="_"> </span>When<span class="_"> </span>we<span class="_"> </span>run<span class="_"> </span>the<span class="_"> </span>program</div><div class="t m5 xcd h26 y65ed ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_ _16"> </span>our<span class="_ _16"> </span>system,<span class="_ _14"> </span>the<span class="_ _16"> </span>parent<span class="_ _16"> </span>process<span class="_ _16"> </span>completes<span class="_ _16"> </span>its<span class="_ _16"> </span><span class="ffd">printf<span class="_ _14"> </span></span>statement<span class="_ _16"> </span>ﬁrst,</div><div class="t m5 xcd h26 y65ee ff7 fs19 fc2 sc0 ls0 ws0">followed<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>child.<span class="_ _11"> </span>However,<span class="_"> </span>on<span class="_"> </span>another<span class="_"> </span>system<span class="_"> </span>the<span class="_"> </span>reverse<span class="_ _11"> </span>might<span class="_"> </span>be</div><div class="t m5 xcd h26 y65ef ff7 fs19 fc2 sc0 ls0 ws0">true<span class="_ _1"></span>.<span class="_ _11"> </span>In<span class="_ _11"> </span>general,<span class="_"> </span>as<span class="_ _11"> </span>programmers<span class="_ _11"> </span>we<span class="_"> </span>can<span class="_ _11"> </span>never<span class="_ _11"> </span>make<span class="_"> </span>assumptions<span class="_ _11"> </span>about</div><div class="t m5 xcd h26 y65f0 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>interleaving<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>instructions<span class="_"> </span>in<span class="_"> </span>different<span class="_"> </span>processes<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
