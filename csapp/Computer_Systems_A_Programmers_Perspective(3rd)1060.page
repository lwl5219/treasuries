<div id="pf424" class="pf w2 h11" data-page-no="424"><div class="pc pc424 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg424.png"/><div class="t m5 x13a h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.7<span class="_ _60"> </span>Other<span class="_ _10"> </span>Concurrency<span class="_ _10"> </span>Issues<span class="_ _3e"> </span><span class="ffe fs1e">1059</span></div><div class="t m5 x17 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.39</div><div class="t m5 x17 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Relationships<span class="_ _16"> </span>between</div><div class="t m5 x17 h2f y58b ffe fs16 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span>sets<span class="_ _14"> </span>of<span class="_ _14"> </span>reentrant,</div><div class="t m5 x17 h2f y58c ffe fs16 fc1 sc0 ls0 ws0">thread-safe,<span class="_ _11"> </span>and<span class="_ _11"> </span>thread-</div><div class="t m5 x17 h2f y58d ffe fs16 fc1 sc0 ls0 ws0">unsafe<span class="_"> </span>functions.</div><div class="t m5 xf8 h3f y83e1 fff1 fs27 fc1 sc0 ls0 ws0">All functions</div><div class="t m5 x255 h3f y83e2 fff1 fs27 fc1 sc0 ls0 ws0">Thread-safe</div><div class="t m5 x24c h3f y83e3 fff1 fs27 fc1 sc0 ls0 ws0">functions</div><div class="t m5 x7e h3f y83e4 fff1 fs27 fc1 sc0 ls0 ws0">Thread-unsafe</div><div class="t m5 xc0 h3f y83e5 fff1 fs27 fc1 sc0 ls0 ws0">functions</div><div class="t m5 x24c h3f y83e6 fff1 fs27 fc1 sc0 ls0 ws0">Reentrant</div><div class="t m5 x125 h3f y83e7 fff1 fs27 fc1 sc0 ls0 ws0">functions</div><div class="t m5 x6d h2c y83e8 ffa fs16 fc1 sc0 ls0 ws0">code/conc/rand-r<span class="_ _3"></span>.c</div><div class="t m5 x2c h2d y83e9 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>rand_r<span class="_ _e"> </span>-<span class="_ _1f"> </span>return<span class="_ _1f"> </span>a<span class="_ _e"> </span>pseudorandom<span class="_ _1f"> </span>integer<span class="_ _e"> </span>on<span class="_ _1f"> </span>0..32767<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y83ea ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">int<span class="_ _1f"> </span>rand_r(unsigned<span class="_ _e"> </span>int<span class="_ _1f"> </span>*nextp)</span></div><div class="t m5 x2c h2e y83eb ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2d h2d y83ec ffd fs1e fc2 sc0 ls0 ws0">{</div><div class="t m5 x2c h2d y83ed ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">*nextp<span class="_ _e"> </span>=<span class="_ _1f"> </span>*nextp<span class="_ _1f"> </span>*<span class="_ _e"> </span>1103515245<span class="_ _1f"> </span>+<span class="_ _e"> </span>12345;</span></div><div class="t m5 x2c h2d y83ee ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>(unsigned<span class="_ _1f"> </span>int)(*nextp<span class="_ _1f"> </span>/<span class="_ _e"> </span>65536)<span class="_ _1f"> </span>%<span class="_ _e"> </span>32768;</span></div><div class="t m5 x2c h2d y83ef ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x6d h2c y83f0 ffa fs16 fc2 sc0 ls0 ws0">code/conc/rand-r<span class="_ _3"></span>.c</div><div class="t m5 x17 h2f y83f1 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.40</div><div class="t m5 x155 h3a y83f2 ffd fs19 fc1 sc0 ls0 ws0">rand_r<span class="ffe fs16">:<span class="_"> </span>A<span class="_"> </span>reentrant<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span></span>rand<span class="_ _10"> </span><span class="ffe fs16">function<span class="_"> </span>from<span class="_"> </span>Figure<span class="_"> </span>12.37.</span></div><div class="t m5 x17 h41 y94f ffe fs29 fc1 sc0 ls0 ws0">12.7.2<span class="_ _48"> </span><span class="fs19">Reentrancy</span></div><div class="t m5 x17 h26 y950 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>here<span class="_"> </span>is<span class="_ _13"> </span>an<span class="_ _13"> </span>important<span class="_ _13"> </span>class<span class="_ _13"> </span>of<span class="_"> </span>thread-safe<span class="_ _13"> </span>functions<span class="_ _1"></span>,<span class="_ _13"> </span>known<span class="_"> </span>as<span class="_ _13"> </span><span class="ffa">reentrant<span class="_ _13"> </span>functions</span>,</div><div class="t m5 x17 h26 y951 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_"> </span>are<span class="_ _13"> </span>characterized<span class="_"> </span>by<span class="_"> </span>the<span class="_ _13"> </span>property<span class="_"> </span>that<span class="_"> </span>they<span class="_ _13"> </span>do<span class="_"> </span>not<span class="_"> </span>reference<span class="_ _13"> </span><span class="ffa">any<span class="_"> </span></span>shared<span class="_ _13"> </span>data</div><div class="t m5 x17 h26 y952 ff7 fs19 fc1 sc0 ls0 ws0">when<span class="_ _15"> </span>they<span class="_ _15"> </span>are<span class="_ _15"> </span>called<span class="_ _21"> </span>by<span class="_ _15"> </span>multiple<span class="_ _15"> </span>threads<span class="_ _1"></span>.<span class="_ _21"> </span>Although<span class="_ _15"> </span>the<span class="_ _15"> </span>terms<span class="_ _21"> </span><span class="ffa">thread-safe<span class="_ _15"> </span></span>and</div><div class="t m5 x17 h26 y953 ffa fs19 fc1 sc0 ls0 ws0">reentrant<span class="_ _11"> </span><span class="ff7">are<span class="_"> </span>sometimes<span class="_"> </span>used<span class="_"> </span>(incorrectly)<span class="_"> </span>as<span class="_"> </span>synonyms<span class="_ _3"></span>,<span class="_"> </span>there<span class="_"> </span>is<span class="_"> </span>a<span class="_"> </span>clear<span class="_ _13"> </span>technical</span></div><div class="t m5 x17 h26 y954 ff7 fs19 fc1 sc0 ls0 ws0">distinction<span class="_ _11"> </span>that<span class="_ _16"> </span>is<span class="_ _16"> </span>worth<span class="_ _11"> </span>preserving.<span class="_ _11"> </span>Figure<span class="_ _11"> </span>12.39<span class="_ _16"> </span>shows<span class="_ _11"> </span>the<span class="_ _16"> </span>set<span class="_ _11"> </span>relationships<span class="_ _16"> </span>be-</div><div class="t m5 x17 h26 y955 ff7 fs19 fc1 sc0 ls0 ws0">tween<span class="_ _13"> </span>reentrant,<span class="_"> </span>thread-safe<span class="_ _1"></span>,<span class="_ _13"> </span>and<span class="_"> </span>thread-unsafe<span class="_ _13"> </span>functions<span class="_ _3"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>set<span class="_ _13"> </span>of<span class="_"> </span>all<span class="_ _13"> </span>functions</div><div class="t m5 x17 h26 y956 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _13"> </span>partitioned<span class="_ _13"> </span>into<span class="_ _6"> </span>the<span class="_ _13"> </span>disjoint<span class="_ _13"> </span>sets<span class="_ _13"> </span>of<span class="_ _6"> </span>thread-safe<span class="_ _13"> </span>and<span class="_ _13"> </span>thread-unsafe<span class="_ _13"> </span>functions<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _0"></span>he</div><div class="t m5 x17 h26 y957 ff7 fs19 fc1 sc0 ls0 ws0">set<span class="_"> </span>of<span class="_"> </span>reentrant<span class="_"> </span>functions<span class="_"> </span>is<span class="_"> </span>a<span class="_"> </span>proper<span class="_"> </span>subset<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>thread-safe<span class="_"> </span>functions<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y958 ff7 fs19 fc1 sc0 ls0 ws0">Reentrant<span class="_ _16"> </span>functions<span class="_ _16"> </span>are<span class="_ _16"> </span>typically<span class="_ _16"> </span>more<span class="_ _16"> </span>efÔ¨Åcient<span class="_ _16"> </span>than<span class="_ _14"> </span>non-reentrant<span class="_ _16"> </span>thread-</div><div class="t m5 x17 h26 y959 ff7 fs19 fc1 sc0 ls0 ws0">safe<span class="_"> </span>functions<span class="_"> </span>because<span class="_"> </span>they<span class="_ _13"> </span>require<span class="_"> </span>no<span class="_"> </span>synchronization<span class="_"> </span>operations<span class="_ _1"></span>.<span class="_"> </span>Furthermore<span class="_ _1"></span>,</div><div class="t m5 x17 h26 y95a ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>only<span class="_"> </span>way<span class="_ _11"> </span>to<span class="_"> </span>convert<span class="_"> </span>a<span class="_ _11"> </span>class<span class="_"> </span>2<span class="_"> </span>thread-unsafe<span class="_ _11"> </span>function<span class="_"> </span>into<span class="_"> </span>a<span class="_ _11"> </span>thread-safe<span class="_"> </span>one<span class="_"> </span>is</div><div class="t m5 x17 h26 y95b ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _16"> </span>rewrite<span class="_ _16"> </span>it<span class="_ _11"> </span>so<span class="_ _16"> </span>that<span class="_ _16"> </span>it<span class="_ _16"> </span>is<span class="_ _16"> </span>reentrant.<span class="_ _16"> </span>F<span class="_ _3"></span>or<span class="_ _16"> </span>example,<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _16"> </span>12.40<span class="_ _16"> </span>shows<span class="_ _16"> </span>a<span class="_ _11"> </span>reentrant</div><div class="t m5 x17 h26 y95c ff7 fs19 fc1 sc0 ls0 ws0">version<span class="_ _15"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span><span class="ffd">rand<span class="_ _15"> </span></span>function<span class="_ _21"> </span>from<span class="_ _21"> </span>F<span class="_ _0"></span>igure<span class="_ _15"> </span>12.37.<span class="_ _21"> </span>T<span class="_ _0"></span>he<span class="_ _15"> </span>key<span class="_ _21"> </span>idea<span class="_ _15"> </span>is<span class="_ _21"> </span>that<span class="_ _21"> </span>we<span class="_ _21"> </span>have</div><div class="t m5 x17 h26 y95d ff7 fs19 fc1 sc0 ls0 ws0">replaced<span class="_"> </span>the<span class="_"> </span>static<span class="_"> </span><span class="ffd">next<span class="_ _10"> </span></span>variable<span class="_"> </span>with<span class="_"> </span>a<span class="_"> </span>pointer<span class="_"> </span>that<span class="_"> </span>is<span class="_"> </span>passed<span class="_"> </span>in<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>caller.</div><div class="t m5 x26 h26 y95e ff7 fs19 fc1 sc0 ls0 ws0">Is<span class="_ _13"> </span>it<span class="_ _13"> </span>possible<span class="_ _13"> </span>to<span class="_ _13"> </span>inspect<span class="_ _13"> </span>the<span class="_ _13"> </span>code<span class="_ _13"> </span>of<span class="_ _13"> </span>some<span class="_ _13"> </span>function<span class="_ _13"> </span>and<span class="_ _13"> </span>declare<span class="_ _13"> </span>a<span class="_ _13"> </span>priori<span class="_ _13"> </span>that<span class="_ _13"> </span>it<span class="_ _13"> </span>is</div><div class="t m5 x17 h26 y95f ff7 fs19 fc1 sc0 ls0 ws0">reentrant?<span class="_ _6"> </span>Unfortunately<span class="_ _3"></span>,<span class="_ _13"> </span>it<span class="_ _6"> </span>depends<span class="_ _1"></span>.<span class="_ _6"> </span>If<span class="_ _13"> </span>all<span class="_ _6"> </span>function<span class="_ _6"> </span>arguments<span class="_ _13"> </span>are<span class="_ _a"> </span>passed<span class="_ _13"> </span>by<span class="_ _6"> </span>value</div><div class="t m5 x17 h26 y960 ff7 fs19 fc1 sc0 ls0 ws0">(i.e<span class="_ _1"></span>.,<span class="_ _13"> </span>no<span class="_ _6"> </span>pointers)<span class="_ _13"> </span>and<span class="_ _a"> </span>all<span class="_ _13"> </span>data<span class="_ _a"> </span>references<span class="_ _13"> </span>are<span class="_ _6"> </span>to<span class="_ _6"> </span>local<span class="_ _13"> </span>automatic<span class="_ _a"> </span>stack<span class="_ _13"> </span>variables<span class="_ _a"> </span>(i.e.,</div><div class="t m5 x17 h26 y961 ff7 fs19 fc1 sc0 ls0 ws0">no<span class="_ _13"> </span>references<span class="_ _13"> </span>to<span class="_ _6"> </span>static<span class="_ _13"> </span>or<span class="_ _13"> </span>global<span class="_ _13"> </span>variables),<span class="_ _13"> </span>then<span class="_ _13"> </span>the<span class="_ _13"> </span>function<span class="_ _6"> </span>is<span class="_ _13"> </span><span class="ffa">explicitly<span class="_ _13"> </span>reentrant<span class="_ _2"></span></span>,</div><div class="t m5 x17 h26 y962 ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_"> </span>the<span class="_"> </span>sense<span class="_"> </span>that<span class="_"> </span>we<span class="_"> </span>can<span class="_"> </span>assert<span class="_"> </span>its<span class="_"> </span>reentrancy<span class="_"> </span>regardless<span class="_"> </span>of<span class="_"> </span>how<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>called.</div><div class="t m5 x26 h26 y963 ff7 fs19 fc1 sc0 ls0 ws0">However,<span class="_ _11"> </span>if<span class="_ _16"> </span>we<span class="_ _16"> </span>loosen<span class="_ _11"> </span>our<span class="_ _16"> </span>assumptions<span class="_ _16"> </span>a<span class="_ _16"> </span>bit<span class="_ _11"> </span>and<span class="_ _16"> </span>allow<span class="_ _16"> </span>some<span class="_ _11"> </span>parameters<span class="_ _16"> </span>in</div><div class="t m5 x17 h26 y964 ff7 fs19 fc1 sc0 ls0 ws0">our<span class="_ _15"> </span>otherwise<span class="_ _21"> </span>explicitly<span class="_ _21"> </span>reentrant<span class="_ _15"> </span>function<span class="_ _21"> </span>to<span class="_ _21"> </span>be<span class="_ _21"> </span>passed<span class="_ _15"> </span>by<span class="_ _21"> </span>reference<span class="_ _21"> </span>(i.e<span class="_ _0"></span>.,<span class="_ _f"> </span>we</div><div class="t m5 x17 h26 y965 ff7 fs19 fc1 sc0 ls0 ws0">allow<span class="_ _14"> </span>them<span class="_ _15"> </span>to<span class="_ _15"> </span>pass<span class="_ _15"> </span>pointers),<span class="_ _15"> </span>then<span class="_ _15"> </span>we<span class="_ _15"> </span>have<span class="_ _15"> </span>an<span class="_ _14"> </span><span class="ffa">implicitly<span class="_ _15"> </span>reentrant<span class="_ _f"> </span></span>function,<span class="_ _21"> </span>in</div><div class="t m5 x17 h26 y966 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>sense<span class="_ _13"> </span>that<span class="_"> </span>it<span class="_ _13"> </span>is<span class="_"> </span>only<span class="_ _13"> </span>reentrant<span class="_"> </span>if<span class="_ _13"> </span>the<span class="_"> </span>calling<span class="_ _13"> </span>threads<span class="_"> </span>are<span class="_ _13"> </span>careful<span class="_"> </span>to<span class="_"> </span>pass<span class="_ _13"> </span>pointers</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
