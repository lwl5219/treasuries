<div id="pf12c" class="pf w2 h11" data-page-no="12c"><div class="pc pc12c w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg12c.png"/><div class="t m5 xc0 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.8<span class="_ _60"> </span>Array<span class="_ _10"> </span>Allocation<span class="_ _10"> </span>and<span class="_ _10"> </span>Access<span class="_ _3e"> </span><span class="ffe fs1e">299</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">Programmers<span class="_ _6"> </span>requiring<span class="_ _6"> </span>variable-size<span class="_ _6"> </span>arrays<span class="_ _6"> </span>had<span class="_ _6"> </span>to<span class="_ _6"> </span>allocate<span class="_ _6"> </span>storage<span class="_ _6"> </span>for<span class="_ _6"> </span>these<span class="_ _6"> </span>arrays</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">using<span class="_ _11"> </span>functions<span class="_ _11"> </span>such<span class="_ _16"> </span>as<span class="_ _11"> </span><span class="ffd">malloc<span class="_ _11"> </span></span>or<span class="_ _16"> </span><span class="ffd">calloc</span>,<span class="_ _11"> </span>and<span class="_ _11"> </span>they<span class="_ _16"> </span>had<span class="_ _11"> </span>to<span class="_ _11"> </span>explicitly<span class="_ _11"> </span>encode<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">mapping<span class="_ _13"> </span>of<span class="_ _13"> </span>multidimensional<span class="_ _13"> </span>arrays<span class="_ _13"> </span>into<span class="_"> </span>single-dimension<span class="_ _13"> </span>ones<span class="_ _13"> </span>via<span class="_ _13"> </span>row-major<span class="_ _13"> </span>in-</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">dexing,<span class="_ _13"> </span>as<span class="_ _13"> </span>expressed<span class="_ _13"> </span>in<span class="_ _13"> </span>Equation<span class="_"> </span>3.1.<span class="_ _13"> </span>ISO<span class="_ _13"> </span>C99<span class="_ _13"> </span>introduced<span class="_ _13"> </span>the<span class="_ _13"> </span>capability<span class="_"> </span>of<span class="_ _13"> </span>having</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">array<span class="_"> </span>dimension<span class="_"> </span>expressions<span class="_"> </span>that<span class="_"> </span>are<span class="_"> </span>computed<span class="_"> </span>as<span class="_"> </span>the<span class="_"> </span>array<span class="_"> </span>is<span class="_"> </span>being<span class="_"> </span>allocated.</div><div class="t m5 x26 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_"> </span>the<span class="_"> </span>C<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>variable-size<span class="_"> </span>arrays<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>can<span class="_"> </span>declare<span class="_"> </span>an<span class="_"> </span>array</div><div class="t m5 x17 h53 y180c ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>A[<span class="ffa">expr1<span class="_ _1"></span><span class="ffd">][<span class="ffa">expr2</span>]</span></span></div><div class="t m5 x17 h26 y2b52 ff7 fs19 fc2 sc0 ls0 ws0">either<span class="_ _13"> </span>as<span class="_ _13"> </span>a<span class="_"> </span>local<span class="_ _13"> </span>variable<span class="_ _13"> </span>or<span class="_ _13"> </span>as<span class="_ _13"> </span>an<span class="_"> </span>argument<span class="_ _13"> </span>to<span class="_ _13"> </span>a<span class="_ _13"> </span>function,<span class="_"> </span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>the<span class="_ _13"> </span>dimensions</div><div class="t m5 x17 h26 y2b53 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_"> </span>array<span class="_ _11"> </span>are<span class="_"> </span>determined<span class="_"> </span>by<span class="_ _11"> </span>evaluating<span class="_"> </span>the<span class="_"> </span>expressions<span class="_ _11"> </span><span class="ffa">expr1<span class="_ _13"> </span></span>and<span class="_"> </span><span class="ffa">expr2<span class="_"> </span></span>at<span class="_"> </span>the</div><div class="t m5 x17 h26 y2b54 ff7 fs19 fc2 sc0 ls0 ws0">time<span class="_ _11"> </span>the<span class="_ _16"> </span>declaration<span class="_ _11"> </span>is<span class="_ _11"> </span>encountered.<span class="_ _16"> </span>So<span class="_ _1"></span>,<span class="_ _16"> </span>for<span class="_ _11"> </span>example<span class="_ _0"></span>,<span class="_ _11"> </span>we<span class="_ _16"> </span>can<span class="_ _11"> </span>write<span class="_ _16"> </span>a<span class="_ _11"> </span>function<span class="_ _11"> </span>to</div><div class="t m5 x17 h46 y2b55 ff7 fs19 fc2 sc0 ls0 ws0">access<span class="_"> </span>element<span class="_"> </span><span class="ff11 ls93">i,<span class="_ _13"> </span>j<span class="_ _15"> </span></span>of<span class="_"> </span>an<span class="_"> </span><span class="ff11">n<span class="_ _13"> </span><span class="ff12">×<span class="_ _10"> </span></span>n<span class="_ _10"> </span></span>array<span class="_"> </span>as<span class="_"> </span>follows:</div><div class="t m5 x17 h2d y2b56 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>var_ele(long<span class="_ _1f"> </span>n,<span class="_ _1f"> </span>int<span class="_ _e"> </span>A[n][n],<span class="_ _1f"> </span>long<span class="_ _e"> </span>i,<span class="_ _1f"> </span>long<span class="_ _1f"> </span>j)<span class="_ _e"> </span>{</div><div class="t m5 x1b6 h2d y2b57 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>A[i][j];</div><div class="t m5 x17 h2d y2b58 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h26 y2b59 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>parameter<span class="_ _11"> </span><span class="ffd">n<span class="_ _16"> </span></span>must<span class="_ _11"> </span>precede<span class="_ _16"> </span>the<span class="_ _11"> </span>parameter<span class="_ _16"> </span><span class="ffd">A[n][n]</span>,<span class="_ _16"> </span>so<span class="_ _11"> </span>that<span class="_ _11"> </span>the<span class="_ _16"> </span>function<span class="_ _11"> </span>can</div><div class="t m5 x17 h26 y2b5a ff7 fs19 fc2 sc0 ls0 ws0">compute<span class="_"> </span>the<span class="_"> </span>array<span class="_"> </span>dimensions<span class="_"> </span>as<span class="_"> </span>the<span class="_"> </span>parameter<span class="_"> </span>is<span class="_"> </span>encountered.</div><div class="t m5 x26 h26 y2b5b ff9 fs19 fc2 sc0 ls0 ws0">Gcc<span class="_ _10"> </span><span class="ff7">generates<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span>this<span class="_"> </span>referencing<span class="_"> </span>function<span class="_"> </span>as</span></div><div class="t m5 x2e h61 y2b5c ff13 fs35 fc6 sc0 ls0 ws0">int<span class="_ _f"> </span>var_ele(long<span class="_ _f"> </span>n,<span class="_ _f"> </span>int<span class="_ _e"> </span>A[n][n],<span class="_ _21"> </span>long<span class="_ _f"> </span>i,<span class="_ _e"> </span>long<span class="_ _21"> </span>j)</div><div class="t m5 x2e h61 y2b5d ff13 fs35 fc6 sc0 ls0 ws0">n<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>A<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi,<span class="_ _f"> </span>i<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>j<span class="_ _e"> </span>in<span class="_ _21"> </span>%rcx</div><div class="t m5 x2c h2e y2b5e ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x2d h2d y2350 ffd fs1e fc2 sc0 ls0 ws0">var_ele:</div><div class="t m5 x2c h2d y2b5f ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">imulq<span class="_ _3f"> </span>%rdx,<span class="_ _e"> </span>%rdi<span class="_ _165"> </span></span><span class="ff13 fs35">Compute<span class="_ _f"> </span><span class="ff11">n</span></span></div><div class="t m5 xfb h7f y2b60 ff11 fs35 fc6 sc0 ls0 ws0">.</div><div class="t m5 xfe h7f y2b5f ff11 fs35 fc6 sc0 ls0 ws0">i</div><div class="t m5 x2c h2d y2b61 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">leaq<span class="_ _46"> </span>(%rsi,%rdi,4),<span class="_ _e"> </span>%rax<span class="_ _88"> </span></span><span class="ff13 fs35">Compute<span class="_ _21"> </span><span class="ff11">x</span></span></div><div class="t m5 xf4 h7d y2b62 ffd fs45 fc6 sc0 ls0 ws0">A</div><div class="t m5 x1c7 h7e y2b61 ff12 fs35 fc6 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">4<span class="ff11">(n</span></span></div><div class="t m5 x1aa h7f y2b63 ff11 fs35 fc6 sc0 ls0 ws0">.</div><div class="t m5 x6d h7f y2b61 ff11 fs35 fc6 sc0 ls0 ws0">i</div><div class="t m5 x2c h2d y2b64 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">movl<span class="_ _46"> </span>(%rax,%rcx,4),<span class="_ _e"> </span>%eax<span class="_ _88"> </span></span><span class="ff13 fs35">Read<span class="_ _21"> </span>from<span class="_ _e"> </span><span class="ff6">M<span class="_ _3"></span><span class="ff7">[<span class="ff11">x</span></span></span></span></div><div class="t m5 x175 h7d y2b65 ffd fs45 fc6 sc0 ls0 ws0">A</div><div class="t m5 x19c h7e y2b64 ff12 fs35 fc6 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">4<span class="ff11">(n</span></span></div><div class="t m5 x53 h7f y2b66 ff11 fs35 fc6 sc0 ls0 ws0">.</div><div class="t m5 x11a h7e y2b64 ff11 fs35 fc6 sc0 ls179 ws0">i)<span class="_ _a"> </span><span class="ff12 ls0">+<span class="_ _13"> </span><span class="ff7">4<span class="ff11">j<span class="_ _5"></span></span>]</span></span></div><div class="t m5 x2c h2e y2b67 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 xd1 h2d y2b68 ffd fs1e fc2 sc0 ls0 ws0">ret</div><div class="t m5 x17 h26 y2b69 ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _11"> </span>the<span class="_ _11"> </span>annotations<span class="_ _11"> </span>show<span class="_ _3"></span>,<span class="_ _11"> </span>this<span class="_ _11"> </span>code<span class="_ _11"> </span>computes<span class="_ _11"> </span>the<span class="_ _11"> </span>address<span class="_ _16"> </span>of<span class="_"> </span>element<span class="_ _11"> </span><span class="ff11 ls93">i,<span class="_ _10"> </span>j<span class="_ _15"> </span></span>as<span class="_ _11"> </span><span class="ff11">x</span></div><div class="t m5 x11d h6e y2b6a ffd fs25 fc2 sc0 ls0 ws0">A</div><div class="t m5 x4e h46 y2b69 ff12 fs19 fc2 sc0 ls0 ws0">+</div><div class="t m5 x17 h26 y2b6b ff7 fs19 fc2 sc0 ls0 ws0">4<span class="ff11">(n</span></div><div class="t m5 x37 h45 y2b6c ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x1ce h46 y2b6b ff11 fs19 fc2 sc0 ls57 ws0">i)<span class="_ _6"> </span><span class="ff12 ls0">+<span class="_ _10"> </span><span class="ff7">4<span class="ff11">j<span class="_"> </span></span></span>=<span class="_ _13"> </span><span class="ff11">x</span></span></div><div class="t m5 x23a h6e y21f2 ffd fs25 fc2 sc0 ls0 ws0">A</div><div class="t m5 xa6 h46 y7fe ff12 fs19 fc2 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">4<span class="_ _2"></span><span class="ff11">(n</span></span></div><div class="t m5 x66 h45 y2b6d ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 xe0 h46 y7fe ff11 fs19 fc2 sc0 ls0 ws0">i<span class="_ _11"> </span><span class="ff12">+<span class="_ _10"> </span></span><span class="ls174">j)<span class="_ _7"></span><span class="ff7 ls0">.<span class="_"> </span>T<span class="_ _0"></span>he<span class="_"> </span>address<span class="_ _11"> </span>computation<span class="_ _11"> </span>is<span class="_"> </span>similar<span class="_ _11"> </span>to<span class="_ _11"> </span>that<span class="_"> </span>of<span class="_ _11"> </span>the</span></span></div><div class="t m5 x17 h26 y7ff ff7 fs19 fc2 sc0 ls0 ws0">ﬁxed-size<span class="_ _11"> </span>array<span class="_ _11"> </span>(Section<span class="_ _11"> </span>3.8.3),<span class="_ _11"> </span>except<span class="_ _11"> </span>that<span class="_ _11"> </span>(1)<span class="_ _11"> </span>the<span class="_ _11"> </span>register<span class="_ _11"> </span>usage<span class="_ _11"> </span>changes<span class="_ _11"> </span>due<span class="_ _11"> </span>to</div><div class="t m5 x17 h26 y800 ff7 fs19 fc2 sc0 ls0 ws0">added<span class="_ _13"> </span>parameter<span class="_"> </span><span class="ffd">n</span>,<span class="_ _13"> </span>and<span class="_"> </span>(2)<span class="_ _13"> </span>a<span class="_"> </span>multiply<span class="_ _13"> </span>instruction<span class="_ _13"> </span>is<span class="_"> </span>used<span class="_ _13"> </span>(line<span class="_"> </span>2)<span class="_ _13"> </span>to<span class="_"> </span>compute<span class="_ _13"> </span><span class="ff11">n</span></div><div class="t m5 x45 h45 y2b6e ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x38 h26 y800 ff11 fs19 fc2 sc0 ls0 ws0">i<span class="_ _2"></span><span class="ff7">,</span></div><div class="t m5 x17 h26 y801 ff7 fs19 fc2 sc0 ls0 ws0">rather<span class="_"> </span>than<span class="_"> </span>an<span class="_"> </span><span class="ffd">leaq<span class="_ _11"> </span></span>instruction<span class="_"> </span>to<span class="_"> </span>compute<span class="_"> </span>3<span class="ff11">i<span class="_ _2"></span></span>.<span class="_"> </span>W<span class="_ _1"></span>e<span class="_"> </span>see<span class="_"> </span>therefore<span class="_"> </span>that<span class="_"> </span>referencing</div><div class="t m5 x17 h26 y802 ff7 fs19 fc2 sc0 ls0 ws0">variable-size<span class="_"> </span>arrays<span class="_ _13"> </span>requires<span class="_"> </span>only<span class="_"> </span>a<span class="_"> </span>slight<span class="_ _13"> </span>generalization<span class="_"> </span>over<span class="_"> </span>ﬁxed-size<span class="_ _13"> </span>ones<span class="_ _0"></span>.<span class="_"> </span>T<span class="_ _1"></span>he</div><div class="t m5 x17 h26 y803 ff7 fs19 fc2 sc0 ls0 ws0">dynamic<span class="_"> </span>version<span class="_"> </span>must<span class="_"> </span>use<span class="_ _11"> </span>a<span class="_"> </span>multiplication<span class="_"> </span>instruction<span class="_ _11"> </span>to<span class="_"> </span>scale<span class="_"> </span><span class="ff11">i<span class="_"> </span></span>by<span class="_"> </span><span class="ff11">n</span>,<span class="_"> </span>rather<span class="_ _11"> </span>than</div><div class="t m5 x17 h26 y804 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _15"> </span>series<span class="_ _21"> </span>of<span class="_ _15"> </span>shifts<span class="_ _15"> </span>and<span class="_ _21"> </span>adds<span class="_ _1"></span>.<span class="_ _21"> </span>In<span class="_ _15"> </span>some<span class="_ _21"> </span>processors<span class="_ _1"></span>,<span class="_ _f"> </span>this<span class="_ _15"> </span>multiplication<span class="_ _21"> </span>can<span class="_ _15"> </span>incur<span class="_ _21"> </span>a</div><div class="t m5 x17 h26 y805 ff7 fs19 fc2 sc0 ls0 ws0">signiﬁcant<span class="_"> </span>performance<span class="_"> </span>penalty<span class="_ _3"></span>,<span class="_"> </span>but<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>unavoidable<span class="_"> </span>in<span class="_"> </span>this<span class="_"> </span>case<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y806 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _6"> </span>variable-size<span class="_ _6"> </span>arrays<span class="_ _13"> </span>are<span class="_ _6"> </span>referenced<span class="_ _6"> </span>within<span class="_ _13"> </span>a<span class="_ _a"> </span>loop,<span class="_ _6"> </span>the<span class="_ _13"> </span>compiler<span class="_ _6"> </span>can<span class="_ _6"> </span>often</div><div class="t m5 x17 h26 y807 ff7 fs19 fc2 sc0 ls0 ws0">optimize<span class="_ _6"> </span>the<span class="_ _6"> </span>index<span class="_ _6"> </span>computations<span class="_ _a"> </span>by<span class="_ _6"> </span>exploiting<span class="_ _6"> </span>the<span class="_ _6"> </span>regularity<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _6"> </span>access<span class="_ _6"> </span>patterns<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y808 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_"> </span>example<span class="_ _1"></span>,<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>3.38(a)<span class="_ _13"> </span>shows<span class="_"> </span>C<span class="_"> </span>code<span class="_ _13"> </span>to<span class="_"> </span>compute<span class="_"> </span>element<span class="_ _13"> </span><span class="ff11 ls93">i,<span class="_ _13"> </span>k<span class="_ _11"> </span></span>of<span class="_"> </span>the<span class="_ _13"> </span>product</div><div class="t m5 x17 h46 y809 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>two<span class="_ _11"> </span><span class="ff11">n<span class="_ _10"> </span><span class="ff12">×<span class="_ _13"></span></span>n<span class="_ _11"> </span></span>arrays<span class="_ _11"> </span><span class="ffd">A<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ffd">B</span>.<span class="_ _11"> </span><span class="ff9">Gcc<span class="_ _11"> </span></span>generates<span class="_ _11"> </span>assembly<span class="_ _11"> </span>code<span class="_ _1"></span>,<span class="_ _11"> </span>which<span class="_ _11"> </span>we<span class="_ _11"> </span>have<span class="_ _11"> </span>recast</div><div class="t m5 x17 h26 y80a ff7 fs19 fc2 sc0 ls0 ws0">into<span class="_ _14"> </span>C<span class="_ _15"> </span>(F<span class="_ _1"></span>igure<span class="_ _15"> </span>3.38(b)).<span class="_ _14"> </span>This<span class="_ _14"> </span>code<span class="_ _14"> </span>follows<span class="_ _15"> </span>a<span class="_ _14"> </span>different<span class="_ _15"> </span>style<span class="_ _14"> </span>from<span class="_ _15"> </span>the<span class="_ _14"> </span>optimized</div><div class="t m5 x17 h26 y80b ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _6"> </span>for<span class="_ _6"> </span>the<span class="_ _13"> </span>ﬁxed-size<span class="_ _a"> </span>array<span class="_ _13"> </span>(F<span class="_ _1"></span>igure<span class="_ _6"> </span>3.37),<span class="_ _13"> </span>but<span class="_ _6"> </span>that<span class="_ _6"> </span>is<span class="_ _13"> </span>more<span class="_ _a"> </span>an<span class="_ _13"> </span>artifact<span class="_ _a"> </span>of<span class="_ _13"> </span>the<span class="_ _a"> </span>choices</div><div class="t m5 x17 h26 y80c ff7 fs19 fc2 sc0 ls0 ws0">made<span class="_ _6"> </span>by<span class="_ _6"> </span>the<span class="_ _6"> </span>compiler,<span class="_ _6"> </span>rather<span class="_ _6"> </span>than<span class="_ _6"> </span>a<span class="_ _6"> </span>fundamental<span class="_ _6"> </span>requirement<span class="_ _6"> </span>for<span class="_ _6"> </span>the<span class="_ _6"> </span>two<span class="_ _6"> </span>different</div><div class="t m5 x17 h26 y2b6f ff7 fs19 fc2 sc0 ls0 ws0">functions<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>code<span class="_ _13"> </span>of<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>3.38(b)<span class="_"> </span>retains<span class="_ _13"> </span>loop<span class="_"> </span>variable<span class="_"> </span><span class="ffd">j</span>,<span class="_"> </span>both<span class="_ _13"> </span>to<span class="_"> </span>detect<span class="_"> </span>when</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
