<div id="pf2ea" class="pf w2 h11" data-page-no="2ea"><div class="pc pc2ea w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2ea.png"/><div class="t m5 x175 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>7.13<span class="_ _60"> </span>Librar<span class="_ _2"></span>y<span class="_ _10"> </span>Interpositioning<span class="_ _1b"> </span><span class="ffe fs1e">745</span></div><div class="t m5 x17 h3a y9c ff6 fs16 fc2 sc0 ls0 ws0">(a)<span class="_ _10"> </span>Example<span class="_ _11"> </span>program<span class="_ _10"> </span><span class="ffd fs19">int.c</span></div><div class="t m5 x1fb h2c y626d ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/int.c</div><div class="t m5 x2c h88 y626e ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&lt;stdio.h&gt;</span></div><div class="t m5 x2c h88 ye98 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&lt;malloc.h&gt;</span></div><div class="t m5 x2c h2e y626f ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2c h2e y6270 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2d h88 y2827 ffd fs4e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x2c h88 y6271 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x2c h88 y6272 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>*p<span class="_ _e"> </span>=<span class="_ _f"> </span>malloc(32);</span></div><div class="t m5 x2c h88 y59ef ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _e2"> </span><span class="ffd fs4e fc2">free(p);</span></div><div class="t m5 x2c h88 y22c1 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _e2"> </span><span class="ffd fs4e fc2">return(0);</span></div><div class="t m5 x2c h88 y59f2 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1fb h2c y6273 ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/int.c</div><div class="t m5 x17 h34 y6274 ff6 fs16 fc2 sc0 ls0 ws0">(b)<span class="_ _10"> </span>Local</div><div class="t m5 x1a9 h3a y6275 ffd fs19 fc2 sc0 ls0 ws0">malloc.h<span class="_ _10"> </span><span class="ff6 fs16">Ô¨Åle</span></div><div class="t m5 x7e h2c y6276 ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/malloc.h</div><div class="t m5 x2c h88 y6277 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">#define<span class="_ _e"> </span>malloc(size)<span class="_ _e"> </span>mymalloc(size)</span></div><div class="t m5 x2c h88 y6278 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">#define<span class="_ _e"> </span>free(ptr)<span class="_ _e"> </span>myfree(ptr)</span></div><div class="t m5 x2c h2e y6279 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2c h2e y627a ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2d h88 y627b ffd fs4e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*mymalloc(size_t<span class="_ _f"> </span>size);</div><div class="t m5 x2c h88 y627c ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>myfree(void<span class="_ _e"> </span>*ptr);</span></div><div class="t m5 x7e h2c y627d ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/malloc.h</div><div class="t m5 x17 h34 y627e ff6 fs16 fc2 sc0 ls0 ws0">(c)<span class="_ _10"> </span>Wrapper<span class="_ _10"> </span>functions<span class="_ _10"> </span>in</div><div class="t m5 x65 h3a y627f ffd fs19 fc2 sc0 ls0 ws0">mymalloc.c</div><div class="t m5 x254 h2c y6280 ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/mymalloc.c</div><div class="t m5 x2c h88 y6281 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">#ifdef<span class="_ _e"> </span>COMPILETIME</span></div><div class="t m5 x2c h88 y6282 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&lt;stdio.h&gt;</span></div><div class="t m5 x2c h2e y6283 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2d h88 y6284 ffd fs4e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;malloc.h&gt;</div><div class="t m5 x2c h2e y6285 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y6286 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2d h88 y6287 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>malloc<span class="_ _f"> </span>wrapper<span class="_ _e"> </span>function<span class="_ _e"> </span>*/</div><div class="t m5 x2c h88 y6288 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>*mymalloc(size_t<span class="_ _e"> </span>size)</span></div><div class="t m5 x2c h88 y6289 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x2c h88 y628a ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _e2"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>*ptr<span class="_ _e"> </span>=<span class="_ _f"> </span>malloc(size);</span></div><div class="t m5 x2c h88 y628b ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _e2"> </span><span class="ffd fs4e fc2">printf(&quot;malloc(%d)=%p\n&quot;,</span></div><div class="t m5 x17 h88 y628c ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _bf"> </span><span class="ffd fs4e fc2">(int)size,<span class="_ _e"> </span>ptr);</span></div><div class="t m5 x17 h88 y628d ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _e2"> </span><span class="ffd fs4e fc2">return<span class="_ _e"> </span>ptr;</span></div><div class="t m5 x17 h88 y628e ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h2e yc3f ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x17 h2e y628f ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x2d h88 y6290 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>free<span class="_ _f"> </span>wrapper<span class="_ _e"> </span>function<span class="_ _e"> </span>*/</div><div class="t m5 x17 h88 y6291 ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>myfree(void<span class="_ _e"> </span>*ptr)</span></div><div class="t m5 x17 h88 y6292 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x17 h88 y6293 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _e2"> </span><span class="ffd fs4e fc2">free(ptr);</span></div><div class="t m5 x17 h88 y6294 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _e2"> </span><span class="ffd fs4e fc2">printf(&quot;free(%p)\n&quot;,<span class="_ _e"> </span>ptr);</span></div><div class="t m5 x17 h88 y6295 ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h88 yc0 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _1c"> </span><span class="ffd fs4e fc2">#endif</span></div><div class="t m5 x254 h2c y6296 ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/mymalloc.c</div><div class="t m5 x17 h2f y6297 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>7.20<span class="_ _66"> </span><span class="fc1">Compile-time<span class="_"> </span>interpositioning<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span>C<span class="_"> </span>preprocessor<span class="_ _1"></span>.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
