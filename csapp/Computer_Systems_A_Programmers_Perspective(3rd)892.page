<div id="pf37c" class="pf w2 h11" data-page-no="37c"><div class="pc pc37c w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg37c.png"/><div class="t m5 x1c9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.9<span class="_ _60"> </span>Dynamic<span class="_ _10"> </span>Memor<span class="_"> </span>y<span class="_ _10"> </span>Allocation<span class="_ _3e"> </span><span class="ffe fs1e">891</span></div><div class="t m5 x11d h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/vm/malloc/memlib<span class="_ _1"></span>.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Private<span class="_ _e"> </span>global<span class="_ _1f"> </span>variables<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">static<span class="_ _1f"> </span>char<span class="_ _e"> </span>*mem_heap;<span class="_ _8c"> </span>/*<span class="_ _1f"> </span>Points<span class="_ _1f"> </span>to<span class="_ _e"> </span>first<span class="_ _1f"> </span>byte<span class="_ _e"> </span>of<span class="_ _1f"> </span>heap<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">static<span class="_ _1f"> </span>char<span class="_ _e"> </span>*mem_brk;<span class="_ _b9"> </span>/*<span class="_ _e"> </span>Points<span class="_ _1f"> </span>to<span class="_ _e"> </span>last<span class="_ _1f"> </span>byte<span class="_ _1f"> </span>of<span class="_ _e"> </span>heap<span class="_ _1f"> </span>plus<span class="_ _e"> </span>1<span class="_ _1f"> </span>*/</span></div><div class="t m5 x2c h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">static<span class="_ _1f"> </span>char<span class="_ _e"> </span>*mem_max_addr;<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>Max<span class="_ _e"> </span>legal<span class="_ _1f"> </span>heap<span class="_ _e"> </span>addr<span class="_ _1f"> </span>plus<span class="_ _1f"> </span>1*/</span></div><div class="t m5 x2c h2e y285 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y65f1 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2d h2d y286 ffd fs1e fc2 sc0 ls0 ws0">/*</div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _1f"> </span>mem_init<span class="_ _e"> </span>-<span class="_ _1f"> </span>Initialize<span class="_ _1f"> </span>the<span class="_ _e"> </span>memory<span class="_ _1f"> </span>system<span class="_ _e"> </span>model</span></div><div class="t m5 x2c h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _73"> </span><span class="ffd fs1e fc2">*/</span></div><div class="t m5 x2c h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>mem_init(void)</span></div><div class="t m5 x17 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">mem_heap<span class="_ _e"> </span>=<span class="_ _1f"> </span>(char<span class="_ _1f"> </span>*)Malloc(MAX_HEAP);</span></div><div class="t m5 x17 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">mem_brk<span class="_ _e"> </span>=<span class="_ _1f"> </span>(char<span class="_ _1f"> </span>*)mem_heap;</span></div><div class="t m5 x17 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">mem_max_addr<span class="_ _e"> </span>=<span class="_ _1f"> </span>(char<span class="_ _1f"> </span>*)(mem_heap<span class="_ _e"> </span>+<span class="_ _1f"> </span>MAX_HEAP);</span></div><div class="t m5 x17 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x17 h2e y6a28 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x2d h2d y417 ffd fs1e fc2 sc0 ls0 ws0">/*</div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _1f"> </span>mem_sbrk<span class="_ _e"> </span>-<span class="_ _1f"> </span>Simple<span class="_ _1f"> </span>model<span class="_ _e"> </span>of<span class="_ _1f"> </span>the<span class="_ _e"> </span>sbrk<span class="_ _1f"> </span>function.<span class="_ _1f"> </span>Extends<span class="_ _e"> </span>the<span class="_ _1f"> </span>heap</span></div><div class="t m5 x17 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _46"> </span>by<span class="_ _1f"> </span>incr<span class="_ _e"> </span>bytes<span class="_ _1f"> </span>and<span class="_ _1f"> </span>returns<span class="_ _e"> </span>the<span class="_ _1f"> </span>start<span class="_ _e"> </span>address<span class="_ _1f"> </span>of<span class="_ _1f"> </span>the<span class="_ _e"> </span>new<span class="_ _1f"> </span>area.<span class="_ _e"> </span>In</span></div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _73"> </span><span class="ffd fs1e fc2">*<span class="_ _46"> </span>this<span class="_ _1f"> </span>model,<span class="_ _e"> </span>the<span class="_ _1f"> </span>heap<span class="_ _1f"> </span>cannot<span class="_ _e"> </span>be<span class="_ _1f"> </span>shrunk.</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _73"> </span><span class="ffd fs1e fc2">*/</span></div><div class="t m5 x17 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x2d h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*mem_sbrk(int<span class="_ _1f"> </span>incr)</div><div class="t m5 x17 h2d y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*old_brk<span class="_ _1f"> </span>=<span class="_ _1f"> </span>mem_brk;</span></div><div class="t m5 x17 h2e y35d ff6 fs20 fc6 sc0 ls0 ws0">24</div><div class="t m5 x17 h2e y6a29 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x142 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(<span class="_ _1f"> </span>(incr<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>0)<span class="_ _1f"> </span>||<span class="_ _e"> </span>((mem_brk<span class="_ _1f"> </span>+<span class="_ _1f"> </span>incr)<span class="_ _e"> </span>&gt;<span class="_ _1f"> </span>mem_max_addr))<span class="_ _e"> </span>{</div><div class="t m5 x17 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _70"> </span><span class="ffd fs1e fc2">errno<span class="_ _e"> </span>=<span class="_ _1f"> </span>ENOMEM;</span></div><div class="t m5 x17 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _70"> </span><span class="ffd fs1e fc2">fprintf(stderr,<span class="_ _e"> </span>&quot;ERROR:<span class="_ _1f"> </span>mem_sbrk<span class="_ _1f"> </span>failed.<span class="_ _e"> </span>Ran<span class="_ _1f"> </span>out<span class="_ _e"> </span>of<span class="_ _1f"> </span>memory...\n&quot;);</span></div><div class="t m5 x17 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>(void<span class="_ _1f"> </span>*)-1;</span></div><div class="t m5 x17 h2d y441 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _20"> </span><span class="ffd fs1e fc2">mem_brk<span class="_ _e"> </span>+=<span class="_ _1f"> </span>incr;</span></div><div class="t m5 x17 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>(void<span class="_ _1f"> </span>*)old_brk;</span></div><div class="t m5 x17 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x11d h2c y73bf ffa fs16 fc2 sc0 ls0 ws0">code/vm/malloc/memlib<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y73c0 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.41</div><div class="t m5 x156 h3a y3027 ffd fs19 fc1 sc0 ls0 ws0">memlib.c<span class="ffe fs16">:<span class="_"> </span>Memory<span class="_"> </span>system<span class="_"> </span>model.</span></div><div class="t m5 x17 h26 y561 ff7 fs19 fc1 sc0 ls0 ws0">shown<span class="_ _13"> </span>in<span class="_ _6"> </span>Figure<span class="_ _6"> </span>9.39.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>minimum<span class="_ _13"> </span>block<span class="_ _6"> </span>size<span class="_ _13"> </span>is<span class="_ _13"> </span>16<span class="_ _13"> </span>bytes<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>free<span class="_ _13"> </span>list<span class="_ _6"> </span>is<span class="_ _13"> </span>organized</div><div class="t m5 x17 h26 y562 ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_"> </span>an<span class="_"> </span>implicit<span class="_"> </span>free<span class="_"> </span>list,<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span>invariant<span class="_"> </span>form<span class="_"> </span>shown<span class="_"> </span>in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>9.42.</div><div class="t m5 x26 h26 y563 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>Ô¨Årst<span class="_ _13"> </span>word<span class="_ _13"> </span>is<span class="_"> </span>an<span class="_ _13"> </span>unused<span class="_ _13"> </span>padding<span class="_ _13"> </span>word<span class="_ _13"> </span>aligned<span class="_ _13"> </span>to<span class="_ _13"> </span>a<span class="_ _13"> </span>double-word<span class="_ _13"> </span>boundary<span class="_ _7"></span>.</div><div class="t m5 x17 h26 y564 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>padding<span class="_"> </span>is<span class="_"> </span>followed<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>special<span class="_"> </span><span class="ffa">prologue<span class="_"> </span>block</span>,<span class="_"> </span>which<span class="_"> </span>is<span class="_"> </span>an<span class="_"> </span>8-byte<span class="_"> </span>allocated</div><div class="t m5 x17 h26 y565 ff7 fs19 fc1 sc0 ls0 ws0">block<span class="_ _15"> </span>consisting<span class="_ _15"> </span>of<span class="_ _21"> </span>only<span class="_ _15"> </span>a<span class="_ _15"> </span>header<span class="_ _21"> </span>and<span class="_ _15"> </span>a<span class="_ _21"> </span>footer.<span class="_ _14"> </span>The<span class="_ _14"> </span>prologue<span class="_ _21"> </span>block<span class="_ _15"> </span>is<span class="_ _15"> </span>created</div><div class="t m5 x17 h26 y566 ff7 fs19 fc1 sc0 ls0 ws0">during<span class="_ _14"> </span>initialization<span class="_ _15"> </span>and<span class="_ _15"> </span>is<span class="_ _15"> </span>never<span class="_ _14"> </span>freed.<span class="_ _15"> </span>F<span class="_ _1"></span>ollowing<span class="_ _15"> </span>the<span class="_ _15"> </span>prologue<span class="_ _14"> </span>block<span class="_ _15"> </span>are<span class="_ _15"> </span>zero</div><div class="t m5 x17 h26 y567 ff7 fs19 fc1 sc0 ls0 ws0">or<span class="_ _15"> </span>more<span class="_ _15"> </span>regular<span class="_ _15"> </span>blocks<span class="_ _15"> </span>that<span class="_ _15"> </span>are<span class="_ _15"> </span>created<span class="_ _15"> </span>by<span class="_ _15"> </span>calls<span class="_ _15"> </span>to<span class="_ _21"> </span><span class="ffd">malloc<span class="_ _15"> </span></span>or<span class="_ _15"> </span><span class="ffd">free</span>.<span class="_ _15"> </span>T<span class="_ _0"></span>he<span class="_ _15"> </span>heap</div><div class="t m5 x17 h26 y216d ff7 fs19 fc1 sc0 ls0 ws0">always<span class="_ _14"> </span>ends<span class="_ _15"> </span>with<span class="_ _15"> </span>a<span class="_ _15"> </span>special<span class="_ _14"> </span><span class="ffa">epilogue<span class="_ _15"> </span>block</span>,<span class="_ _21"> </span>which<span class="_ _15"> </span>is<span class="_ _15"> </span>a<span class="_ _14"> </span>zero-size<span class="_ _15"> </span>allocated<span class="_ _15"> </span>block</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
