<div id="pf1aa" class="pf w2 h11" data-page-no="1aa"><div class="pc pc1aa w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1aa.png"/><div class="t m5 x99 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>4.3<span class="_ _60"> </span>Sequential<span class="_ _10"> </span>Y86-64<span class="_ _10"> </span>Implementations<span class="_ _3e"> </span><span class="ffe fs1e">425</span></div><div class="t m5 x17 h31 y390 ff7 fs21 fc2 sc0 ls0 ws0">Stage<span class="_ _55"> </span><span class="ffd fs1e">rmmovq<span class="_ _11"> </span></span><span class="ff6">rA<span class="ffd fs1e">,<span class="_ _11"> </span></span>D<span class="ffd fs1e">(</span>rB<span class="ffd fs1e">)<span class="_ _53"> </span>mrmovq<span class="_ _11"> </span></span>D<span class="ffd fs1e">(</span>rB<span class="ffd fs1e">),<span class="_ _11"> </span></span>rA</span></div><div class="t m5 x17 h32 yc94 ff7 fs21 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>etch<span class="_ _55"> </span><span class="ff6">icode<span class="_ _a"> </span></span>:<span class="_ _be"></span><span class="ff6">ifun<span class="_ _23"> </span><span class="ff12">←<span class="_ _25"> </span></span>M</span></div><div class="t m5 x183 h33 yc95 ff7 fs20 fc2 sc0 ls0 ws0">1</div><div class="t m5 x10e h32 yc94 ff7 fs21 fc2 sc0 ls0 ws0">[<span class="ff6">PC</span>]<span class="_ _74"> </span><span class="ff6">icode<span class="_ _a"> </span></span>:<span class="_ _be"></span><span class="ff6">ifun<span class="_ _23"> </span><span class="ff12">←<span class="_ _25"> </span></span>M</span></div><div class="t m5 x1ad h33 yc95 ff7 fs20 fc2 sc0 ls0 ws0">1</div><div class="t m5 xb0 h31 yc94 ff7 fs21 fc2 sc0 ls0 ws0">[<span class="ff6">PC</span>]</div><div class="t m5 x75 h32 yc96 ff6 fs21 fc2 sc0 ls0 ws0">rA<span class="_ _6"> </span><span class="ff7">:<span class="_ _be"></span></span>rB<span class="_ _25"> </span><span class="ff12">←<span class="_ _23"> </span></span>M</div><div class="t m5 x7a h33 yc97 ff7 fs20 fc2 sc0 ls0 ws0">1</div><div class="t m5 x1a5 h32 yc98 ff7 fs21 fc2 sc0 ls0 ws0">[<span class="ff6">PC<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"> </span></span></span>1]<span class="_ _5c"> </span><span class="ff6">rA<span class="_ _6"> </span></span>:<span class="_ _a"> </span><span class="ff6">rB<span class="_ _23"> </span><span class="ff12">←<span class="_ _25"> </span></span>M</span></div><div class="t m5 x7e h33 yc97 ff7 fs20 fc2 sc0 ls0 ws0">1</div><div class="t m5 x36 h32 yc98 ff7 fs21 fc2 sc0 ls0 ws0">[<span class="ff6">PC<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"> </span></span></span>1]</div><div class="t m5 x75 h32 yc99 ff6 fs21 fc2 sc0 ls0 ws0">valC<span class="_ _25"> </span><span class="ff12">←<span class="_ _23"> </span></span>M</div><div class="t m5 xc1 h33 yc9a ff7 fs20 fc2 sc0 ls0 ws0">8</div><div class="t m5 x20 h32 yc9b ff7 fs21 fc2 sc0 ls0 ws0">[<span class="ff6">PC<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"> </span></span></span>2]<span class="_ _2c"> </span><span class="ff6">valC<span class="_ _25"> </span><span class="ff12">←<span class="_ _23"> </span></span>M</span></div><div class="t m5 x5e h33 yc9a ff7 fs20 fc2 sc0 ls0 ws0">8</div><div class="t m5 x1e2 h32 yc9b ff7 fs21 fc2 sc0 ls0 ws0">[<span class="ff6">PC<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"> </span></span></span>2]</div><div class="t m5 x75 h32 yc9c ff6 fs21 fc2 sc0 ls0 ws0">valP<span class="_ _23"> </span><span class="ff12">←<span class="_ _25"> </span></span>PC<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"> </span><span class="ff7">10<span class="_ _54"> </span></span></span>valP<span class="_ _25"> </span><span class="ff12">←<span class="_ _23"> </span></span>PC<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"> </span><span class="ff7">10</span></span></div><div class="t m5 x17 h32 y3ab1 ff7 fs21 fc2 sc0 ls0 ws0">Decode<span class="_ _bd"> </span><span class="ff6">valA<span class="_ _25"> </span><span class="ff12">←<span class="_ _25"> </span></span>R</span>[<span class="ff6">rA<span class="_ _2"></span></span>]</div><div class="t m5 x75 h32 y3ab2 ff6 fs21 fc2 sc0 ls0 ws0">valB<span class="_ _23"> </span><span class="ff12">←<span class="_ _25"> </span></span>R<span class="ff7">[</span>rB<span class="ff7">]<span class="_ _12b"> </span></span>valB<span class="_ _23"> </span><span class="ff12">←<span class="_ _25"> </span></span>R<span class="ff7">[</span>rB<span class="ff7">]</span></div><div class="t m5 x17 h32 y3ab3 ff7 fs21 fc2 sc0 ls0 ws0">Execute<span class="_ _f4"> </span><span class="ff6">valE<span class="_ _25"> </span><span class="ff12">←<span class="_ _23"> </span></span>valB<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"> </span></span>valC<span class="_ _63"> </span>valE<span class="_ _25"> </span><span class="ff12">←<span class="_ _25"> </span></span>valB<span class="_ _13"> </span><span class="ff12">+<span class="_ _13"></span></span>valC</span></div><div class="t m5 x17 h31 y3aee ff7 fs21 fc2 sc0 ls0 ws0">Memory<span class="_ _88"> </span><span class="ff6">M</span></div><div class="t m5 x178 h33 y3aef ff7 fs20 fc2 sc0 ls0 ws0">8</div><div class="t m5 x13 h32 y298f ff7 fs21 fc2 sc0 ls0 ws0">[<span class="ff6">valE</span>]<span class="_ _22"> </span><span class="ff12">←<span class="_ _25"> </span><span class="ff6">valA<span class="_ _5d"> </span>valM<span class="_ _23"> </span></span>←<span class="_ _25"> </span><span class="ff6">M</span></span></div><div class="t m5 x120 h33 y3aef ff7 fs20 fc2 sc0 ls0 ws0">8</div><div class="t m5 x13c h31 y3af0 ff7 fs21 fc2 sc0 ls0 ws0">[<span class="ff6">valE</span>]</div><div class="t m5 x17 h31 y3af1 ff7 fs21 fc2 sc0 ls0 ws0">Write<span class="_"> </span>back</div><div class="t m5 x186 h32 y3af2 ff6 fs21 fc2 sc0 ls0 ws0">R<span class="ff7">[</span>rA<span class="_ _2"></span><span class="ff7">]<span class="_ _22"> </span><span class="ff12">←<span class="_ _25"> </span></span></span>valM</div><div class="t m5 x17 h32 y3af3 ff7 fs21 fc2 sc0 ls0 ws0">PC<span class="_"> </span>update<span class="_ _45"> </span><span class="ff6">PC<span class="_ _25"> </span><span class="ff12">←<span class="_ _23"> </span></span>valP<span class="_ _158"> </span>PC<span class="_ _23"> </span><span class="ff12">←<span class="_ _25"> </span></span>valP</span></div><div class="t m5 x17 h2f y3ab8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>4.19<span class="_ _c"> </span><span class="fc1">Computations<span class="_ _14"> </span>in<span class="_ _14"> </span>sequential<span class="_ _16"> </span>implementation<span class="_ _14"> </span>of<span class="_ _14"> </span>Y86-64<span class="_ _16"> </span>instructions</span></div><div class="t m5 x17 h3a y3af4 ffd fs19 fc1 sc0 ls0 ws0">rmmovq<span class="_ _10"> </span><span class="ffe fs16">and<span class="_"> </span></span>mrmovq<span class="ffe fs16">.<span class="_"> </span><span class="ff6">These<span class="_ _11"> </span>instructions<span class="_ _10"> </span>read<span class="_ _10"> </span>or<span class="_ _11"> </span>write<span class="_ _10"> </span>memor<span class="_ _2"></span>y<span class="_ _3"></span>.</span></span></div><div class="t m5 x26 h26 y3af5 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _11"> </span>4.20<span class="_"> </span>shows<span class="_"> </span>the<span class="_ _11"> </span>steps<span class="_"> </span>required<span class="_ _11"> </span>to<span class="_"> </span>process<span class="_"> </span><span class="ffd">pushq<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ffd">popq<span class="_ _11"> </span></span>instructions<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y3af6 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>hese<span class="_ _15"> </span>are<span class="_ _14"> </span>among<span class="_ _15"> </span>the<span class="_ _14"> </span>most<span class="_ _15"> </span>difﬁcult<span class="_ _15"> </span>Y86-64<span class="_ _14"> </span>instructions<span class="_ _15"> </span>to<span class="_ _14"> </span>implement,<span class="_ _21"> </span>because</div><div class="t m5 x17 h26 y3af7 ff7 fs19 fc1 sc0 ls0 ws0">they<span class="_"> </span>involve<span class="_ _13"> </span>both<span class="_"> </span>accessing<span class="_ _13"> </span>memory<span class="_"> </span>and<span class="_ _13"> </span>incrementing<span class="_"> </span>or<span class="_"> </span>decrementing<span class="_ _13"> </span>the<span class="_"> </span>stack</div><div class="t m5 x17 h26 y3af8 ff7 fs19 fc1 sc0 ls0 ws0">pointer.<span class="_ _16"> </span>Although<span class="_ _14"> </span>the<span class="_ _14"> </span>two<span class="_ _14"> </span>instructions<span class="_ _14"> </span>have<span class="_ _14"> </span>similar<span class="_ _14"> </span>ﬂows<span class="_ _1"></span>,<span class="_ _15"> </span>they<span class="_ _14"> </span>have<span class="_ _14"> </span>important</div><div class="t m5 x17 h26 y3af9 ff7 fs19 fc1 sc0 ls0 ws0">differences<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y3afa ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _14"> </span><span class="ffd ls0">pushq<span class="_ _16"> </span><span class="ff7">instruction<span class="_ _14"> </span>starts<span class="_ _16"> </span>much<span class="_ _16"> </span>like<span class="_ _16"> </span>our<span class="_ _16"> </span>previous<span class="_ _14"> </span>instructions<span class="_ _1"></span>,<span class="_ _14"> </span>but<span class="_ _16"> </span>in<span class="_ _16"> </span>the</span></span></div><div class="t m5 x17 h26 y3afb ff7 fs19 fc1 sc0 ls0 ws0">decode<span class="_"> </span>stage<span class="_ _13"> </span>we<span class="_"> </span>use<span class="_"> </span><span class="ffd">%rsp<span class="_ _13"> </span></span>as<span class="_"> </span>the<span class="_"> </span>identiﬁer<span class="_"> </span>for<span class="_ _13"> </span>the<span class="_"> </span>second<span class="_"> </span>register<span class="_ _13"> </span>operand,<span class="_"> </span>giving</div><div class="t m5 x17 h26 y3afc ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>stack<span class="_ _6"> </span>pointer<span class="_ _13"> </span>as<span class="_ _13"> </span>value<span class="_ _6"> </span><span class="ff6">valB</span>.<span class="_ _13"> </span>In<span class="_ _6"> </span>the<span class="_ _13"> </span>execute<span class="_ _13"> </span>stage<span class="_ _1"></span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>use<span class="_ _6"> </span>the<span class="_ _13"> </span>ALU<span class="_ _13"> </span>to<span class="_ _6"> </span>decrement</div><div class="t m5 x17 h26 y3afd ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _21"> </span>stack<span class="_ _21"> </span>pointer<span class="_ _21"> </span>by<span class="_ _21"> </span>8.<span class="_ _21"> </span>T<span class="_ _1"></span>his<span class="_ _21"> </span>decremented<span class="_ _21"> </span>value<span class="_ _21"> </span>is<span class="_ _21"> </span>used<span class="_ _21"> </span>for<span class="_ _21"> </span>the<span class="_ _21"> </span>memory<span class="_ _21"> </span>write</div><div class="t m5 x17 h26 y3afe ff7 fs19 fc1 sc0 ls0 ws0">address<span class="_ _15"> </span>and<span class="_ _15"> </span>is<span class="_ _15"> </span>also<span class="_ _15"> </span>stored<span class="_ _15"> </span>back<span class="_ _15"> </span>to<span class="_ _15"> </span><span class="ffd">%rsp<span class="_ _15"> </span></span>in<span class="_ _15"> </span>the<span class="_ _15"> </span>write-back<span class="_ _15"> </span>stage<span class="_ _0"></span>.<span class="_ _15"> </span>By<span class="_ _15"> </span>using<span class="_ _15"> </span><span class="ff6">valE</span></div><div class="t m5 x17 h26 y3aff ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_ _15"> </span>the<span class="_ _15"> </span>address<span class="_ _21"> </span>for<span class="_ _15"> </span>the<span class="_ _21"> </span>write<span class="_ _15"> </span>operation,<span class="_ _f"> </span>we<span class="_ _15"> </span>adhere<span class="_ _21"> </span>to<span class="_ _15"> </span>the<span class="_ _15"> </span>Y86-64<span class="_ _21"> </span>(and<span class="_ _15"> </span>x86-64)</div><div class="t m5 x17 h26 y3b00 ff7 fs19 fc1 sc0 ls0 ws0">convention<span class="_ _16"> </span>that<span class="_ _16"> </span><span class="ffd">pushq<span class="_ _16"> </span></span>should<span class="_ _16"> </span>decrement<span class="_ _16"> </span>the<span class="_ _16"> </span>stack<span class="_ _16"> </span>pointer<span class="_ _16"> </span>before<span class="_ _16"> </span>writing<span class="_ _0"></span>,<span class="_ _16"> </span>even</div><div class="t m5 x17 h26 y3b01 ff7 fs19 fc1 sc0 ls0 ws0">though<span class="_ _15"> </span>the<span class="_ _15"> </span>actual<span class="_ _15"> </span>updating<span class="_ _21"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>stack<span class="_ _15"> </span>pointer<span class="_ _21"> </span>does<span class="_ _15"> </span>not<span class="_ _15"> </span>occur<span class="_ _15"> </span>until<span class="_ _21"> </span>after<span class="_ _15"> </span>the</div><div class="t m5 x17 h26 y3b02 ff7 fs19 fc1 sc0 ls0 ws0">memory<span class="_"> </span>operation<span class="_"> </span>has<span class="_"> </span>completed.</div><div class="t m5 x26 h26 y3b03 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _f"> </span><span class="ffd ls0">popq<span class="_ _21"> </span><span class="ff7">instruction<span class="_ _21"> </span>proceeds<span class="_ _21"> </span>much<span class="_ _21"> </span>like<span class="_ _21"> </span></span>pushq<span class="ff7">,<span class="_ _e"> </span>except<span class="_ _15"> </span>that<span class="_ _21"> </span>we<span class="_ _21"> </span>read<span class="_ _21"> </span>two</span></span></div><div class="t m5 x17 h26 y3b04 ff7 fs19 fc1 sc0 ls0 ws0">copies<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>stack<span class="_ _11"> </span>pointer<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_"> </span>decode<span class="_ _11"> </span>stage.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_ _11"> </span>is<span class="_ _11"> </span>clearly<span class="_ _11"> </span>redundant,<span class="_ _11"> </span>but<span class="_ _11"> </span>we</div><div class="t m5 x17 h26 y3b05 ff7 fs19 fc1 sc0 ls0 ws0">will<span class="_"> </span>see<span class="_ _13"> </span>that<span class="_"> </span>having<span class="_"> </span>the<span class="_ _13"> </span>stack<span class="_"> </span>pointer<span class="_"> </span>as<span class="_ _13"> </span>both<span class="_"> </span><span class="ff6">valA<span class="_ _10"> </span></span>and<span class="_ _13"> </span><span class="ff6">valB<span class="_ _10"> </span></span>makes<span class="_"> </span>the<span class="_ _13"> </span>subsequent</div><div class="t m5 x17 h26 y3b06 ff7 fs19 fc1 sc0 ls0 ws0">ﬂow<span class="_ _11"> </span>more<span class="_ _16"> </span>similar<span class="_ _11"> </span>to<span class="_ _11"> </span>that<span class="_ _16"> </span>of<span class="_ _11"> </span>other<span class="_ _16"> </span>instructions<span class="_ _3"></span>,<span class="_ _16"> </span>enhancing<span class="_ _11"> </span>the<span class="_ _16"> </span>overall<span class="_ _11"> </span>uniformity</div><div class="t m5 x17 h26 y3b07 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_ _13"> </span>design.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>use<span class="_"> </span>the<span class="_ _13"> </span>ALU<span class="_"> </span>to<span class="_"> </span>increment<span class="_ _13"> </span>the<span class="_"> </span>stack<span class="_"> </span>pointer<span class="_ _13"> </span>by<span class="_"> </span>8<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>execute</div><div class="t m5 x17 h26 y3b08 ff7 fs19 fc1 sc0 ls0 ws0">stage<span class="_ _1"></span>,<span class="_"> </span>but<span class="_"> </span>use<span class="_"> </span>the<span class="_"> </span>unincremented<span class="_ _13"> </span>value<span class="_"> </span>as<span class="_"> </span>the<span class="_"> </span>address<span class="_"> </span>for<span class="_ _13"> </span>the<span class="_"> </span>memory<span class="_"> </span>operation.</div><div class="t m5 x17 h26 y3b09 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_"> </span>the<span class="_"> </span>write-back<span class="_"> </span>stage,<span class="_"> </span>we<span class="_"> </span>update<span class="_"> </span>both<span class="_"> </span>the<span class="_ _11"> </span>stack<span class="_"> </span>pointer<span class="_"> </span>register<span class="_ _11"> </span>with<span class="_"> </span>the<span class="_"> </span>incre-</div><div class="t m5 x17 h26 y3b0a ff7 fs19 fc1 sc0 ls0 ws0">mented<span class="_ _13"> </span>stack<span class="_"> </span>pointer<span class="_ _13"> </span>and<span class="_"> </span>register<span class="_ _13"> </span><span class="ff6">rA<span class="_ _10"> </span></span>with<span class="_ _13"> </span>the<span class="_"> </span>value<span class="_ _13"> </span>read<span class="_"> </span>from<span class="_ _13"> </span>memory<span class="_ _3"></span>.<span class="_"> </span>Using<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y3b0b ff7 fs19 fc1 sc0 ls0 ws0">unincremented<span class="_ _16"> </span>stack<span class="_ _16"> </span>pointer<span class="_ _16"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span>memory<span class="_ _16"> </span>read<span class="_ _11"> </span>address<span class="_ _16"> </span>preserves<span class="_ _16"> </span>the<span class="_ _16"> </span>Y86-64</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
