<div id="pf1ee" class="pf w2 h11" data-page-no="1ee"><div class="pc pc1ee w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1ee.png"/><div class="t m5 x13d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>4.5<span class="_ _60"> </span>Pipelined<span class="_ _10"> </span>Y86-64<span class="_ _10"> </span>Implementations<span class="_ _3e"> </span><span class="ffe fs1e">493</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>4.55,<span class="_ _11"> </span>we<span class="_"> </span>see<span class="_"> </span>that<span class="_"> </span>our<span class="_"> </span>implementation<span class="_"> </span>achieves<span class="_"> </span>the<span class="_"> </span>desired<span class="_"> </span>effect,<span class="_"> </span>but<span class="_"> </span>with</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _13"> </span>slightly<span class="_"> </span>peculiar<span class="_ _13"> </span>fetching<span class="_ _13"> </span>of<span class="_ _13"> </span>an<span class="_"> </span>incorrect<span class="_ _13"> </span>instruction<span class="_ _13"> </span>for<span class="_ _13"> </span>three<span class="_"> </span>consecutive<span class="_ _13"> </span>cycles<span class="_ _3"></span>.</div><div class="t m5 x26 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_"> </span>a<span class="_ _11"> </span>mispredicted<span class="_ _11"> </span>branch<span class="_ _16"> </span>occurs<span class="_ _3"></span>,<span class="_ _16"> </span>we<span class="_"> </span>have<span class="_ _16"> </span>described<span class="_"> </span>the<span class="_ _16"> </span>desired<span class="_"> </span>pipeline</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">operation<span class="_"> </span>in<span class="_"> </span>Section<span class="_"> </span>4.5.5<span class="_ _11"> </span>and<span class="_"> </span>illustrated<span class="_"> </span>it<span class="_"> </span>in<span class="_ _11"> </span>F<span class="_ _1"></span>igure<span class="_ _11"> </span>4.56.<span class="_"> </span>T<span class="_ _0"></span>he<span class="_"> </span>misprediction<span class="_"> </span>will</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_ _11"> </span>detected<span class="_ _16"> </span>as<span class="_ _11"> </span>the<span class="_ _16"> </span>jump<span class="_ _16"> </span>instruction<span class="_ _11"> </span>reaches<span class="_ _16"> </span>the<span class="_ _11"> </span>execute<span class="_ _16"> </span>stage<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>control<span class="_ _11"> </span>logic</div><div class="t m5 x17 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_"> </span>injects<span class="_ _13"> </span>bubbles<span class="_"> </span>into<span class="_ _13"> </span>the<span class="_"> </span>decode<span class="_ _13"> </span>and<span class="_"> </span>execute<span class="_ _13"> </span>stages<span class="_"> </span>on<span class="_ _13"> </span>the<span class="_"> </span>next<span class="_ _13"> </span>cycle<span class="_ _1"></span>,<span class="_"> </span>causing</div><div class="t m5 x17 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>two<span class="_ _16"> </span>incorrectly<span class="_ _14"> </span>fetched<span class="_ _14"> </span>instructions<span class="_ _14"> </span>to<span class="_ _14"> </span>be<span class="_ _14"> </span>canceled.<span class="_ _14"> </span>On<span class="_ _14"> </span>the<span class="_ _14"> </span>same<span class="_ _14"> </span>cycle<span class="_ _1"></span>,<span class="_ _14"> </span>the</div><div class="t m5 x17 h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">pipeline<span class="_"> </span>reads<span class="_"> </span>the<span class="_"> </span>correct<span class="_"> </span>instruction<span class="_"> </span>into<span class="_"> </span>the<span class="_"> </span>fetch<span class="_"> </span>stage<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_"> </span>an<span class="_"> </span>instruction<span class="_ _11"> </span>that<span class="_"> </span>causes<span class="_ _11"> </span>an<span class="_"> </span>exception,<span class="_ _11"> </span>we<span class="_"> </span>must<span class="_ _11"> </span>make<span class="_"> </span>the<span class="_"> </span>pipelined<span class="_ _11"> </span>im-</div><div class="t m5 x17 h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">plementation<span class="_ _13"> </span>match<span class="_ _13"> </span>the<span class="_ _13"> </span>desired<span class="_ _6"> </span>ISA<span class="_ _13"> </span>behavior,<span class="_ _13"> </span>with<span class="_ _13"> </span>all<span class="_ _13"> </span>prior<span class="_ _13"> </span>instructions<span class="_ _6"> </span>complet-</div><div class="t m5 x17 h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">ing<span class="_"> </span>and<span class="_"> </span>with<span class="_"> </span>none<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>instructions<span class="_"> </span>having<span class="_ _11"> </span>any<span class="_"> </span>effect<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>program</div><div class="t m5 x17 h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">state<span class="_ _1"></span>.<span class="_ _16"> </span>Achieving<span class="_ _16"> </span>these<span class="_ _11"> </span>effects<span class="_ _16"> </span>is<span class="_ _11"> </span>complicated<span class="_ _16"> </span>by<span class="_ _11"> </span>the<span class="_ _16"> </span>facts<span class="_ _11"> </span>that<span class="_ _16"> </span>(1)<span class="_ _16"> </span>exceptions<span class="_ _11"> </span>are</div><div class="t m5 x17 h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">detected<span class="_ _11"> </span>during<span class="_ _16"> </span>two<span class="_ _16"> </span>different<span class="_ _11"> </span>stages<span class="_ _16"> </span>(fetch<span class="_ _11"> </span>and<span class="_ _16"> </span>memory)<span class="_ _16"> </span>of<span class="_ _11"> </span>program<span class="_ _16"> </span>execution,</div><div class="t m5 x17 h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _11"> </span>(2)<span class="_ _11"> </span>the<span class="_ _11"> </span>program<span class="_"> </span>state<span class="_ _11"> </span>is<span class="_ _11"> </span>updated<span class="_ _11"> </span>in<span class="_ _11"> </span>three<span class="_ _11"> </span>different<span class="_ _11"> </span>stages<span class="_ _11"> </span>(execute,<span class="_"> </span>memory<span class="_ _3"></span>,</div><div class="t m5 x17 h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span>write-back).</div><div class="t m5 x26 h26 y451 ff7 fs19 fc2 sc0 ls0 ws0">Our<span class="_"> </span>stage<span class="_"> </span>designs<span class="_"> </span>include<span class="_"> </span>a<span class="_"> </span>status<span class="_"> </span>code<span class="_ _11"> </span><span class="ff6">stat<span class="_ _10"> </span></span>in<span class="_"> </span>each<span class="_"> </span>pipeline<span class="_"> </span>register<span class="_ _11"> </span>to<span class="_"> </span>track</div><div class="t m5 x17 h26 y452 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>status<span class="_ _14"> </span>of<span class="_ _14"> </span>each<span class="_ _16"> </span>instruction<span class="_ _14"> </span>as<span class="_ _16"> </span>it<span class="_ _14"> </span>passes<span class="_ _14"> </span>through<span class="_ _16"> </span>the<span class="_ _14"> </span>pipeline<span class="_ _14"> </span>stages<span class="_ _1"></span>.<span class="_ _16"> </span>When<span class="_ _16"> </span>an</div><div class="t m5 x17 h26 y453 ff7 fs19 fc2 sc0 ls0 ws0">exception<span class="_ _13"> </span>occurs<span class="_ _3"></span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>record<span class="_ _13"> </span>that<span class="_ _13"> </span>information<span class="_ _13"> </span>as<span class="_ _6"> </span>part<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>instruction’<span class="_ _1"></span>s<span class="_ _13"> </span>status<span class="_ _13"> </span>and</div><div class="t m5 x17 h26 y454 ff7 fs19 fc2 sc0 ls0 ws0">continue<span class="_"> </span>fetching,<span class="_ _11"> </span>decoding,<span class="_"> </span>and<span class="_ _11"> </span>executing<span class="_ _11"> </span>instructions<span class="_ _11"> </span>as<span class="_ _11"> </span>if<span class="_ _11"> </span>nothing<span class="_"> </span>were<span class="_ _11"> </span>amiss<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y455 ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_"> </span>the<span class="_"> </span>excepting<span class="_ _11"> </span>instruction<span class="_"> </span>reaches<span class="_ _11"> </span>the<span class="_"> </span>memory<span class="_"> </span>stage,<span class="_"> </span>we<span class="_"> </span>take<span class="_"> </span>steps<span class="_ _11"> </span>to<span class="_"> </span>prevent</div><div class="t m5 x17 h26 y456 ff7 fs19 fc2 sc0 ls0 ws0">later<span class="_ _14"> </span>instructions<span class="_ _16"> </span>from<span class="_ _14"> </span>modifying<span class="_ _14"> </span>the<span class="_ _14"> </span>programmer<span class="_ _1"></span>-visible<span class="_ _14"> </span>state<span class="_ _14"> </span>by<span class="_ _14"> </span>(1)<span class="_ _14"> </span>disabling</div><div class="t m5 x17 h26 y457 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>setting<span class="_ _14"> </span>of<span class="_ _16"> </span>condition<span class="_ _14"> </span>codes<span class="_ _16"> </span>by<span class="_ _16"> </span>instructions<span class="_ _14"> </span>in<span class="_ _16"> </span>the<span class="_ _14"> </span>execute<span class="_ _16"> </span>stage,<span class="_ _16"> </span>(2)<span class="_ _14"> </span>injecting</div><div class="t m5 x17 h26 y458 ff7 fs19 fc2 sc0 ls0 ws0">bubbles<span class="_ _13"> </span>into<span class="_"> </span>the<span class="_ _13"> </span>memory<span class="_"> </span>stage<span class="_ _13"> </span>to<span class="_ _13"> </span>disable<span class="_"> </span>any<span class="_ _13"> </span>writing<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>data<span class="_"> </span>memory<span class="_ _7"></span>,<span class="_"> </span>and<span class="_ _13"> </span>(3)</div><div class="t m5 x17 h26 y459 ff7 fs19 fc2 sc0 ls0 ws0">stalling<span class="_ _16"> </span>the<span class="_ _16"> </span>write-back<span class="_ _16"> </span>stage<span class="_ _16"> </span>when<span class="_ _16"> </span>it<span class="_ _16"> </span>has<span class="_ _16"> </span>an<span class="_ _16"> </span>excepting<span class="_ _16"> </span>instruction,<span class="_ _14"> </span>thus<span class="_ _16"> </span>bringing</div><div class="t m5 x17 h26 y45a ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>pipeline<span class="_"> </span>to<span class="_"> </span>a<span class="_"> </span>halt.</div><div class="t m5 x26 h26 y45b ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>pipeline<span class="_"> </span>diagram<span class="_"> </span>in<span class="_"> </span>Figure<span class="_"> </span>4.63<span class="_"> </span>illustrates<span class="_"> </span>how<span class="_"> </span>our<span class="_"> </span>pipeline<span class="_"> </span>control<span class="_"> </span>han-</div><div class="t m5 x17 h26 y45c ff7 fs19 fc2 sc0 ls0 ws0">dles<span class="_ _6"> </span>the<span class="_ _13"> </span>situation<span class="_ _6"> </span>where<span class="_ _6"> </span>an<span class="_ _13"> </span>instruction<span class="_ _6"> </span>causing<span class="_ _6"> </span>an<span class="_ _13"> </span>exception<span class="_ _6"> </span>is<span class="_ _6"> </span>followed<span class="_ _13"> </span>by<span class="_ _6"> </span>one<span class="_ _13"> </span>that</div><div class="t m5 x17 h26 y227 ff7 fs19 fc2 sc0 ls0 ws0">would<span class="_"> </span>change<span class="_ _11"> </span>the<span class="_ _11"> </span>condition<span class="_ _11"> </span>codes<span class="_ _1"></span>.<span class="_ _11"> </span>On<span class="_ _11"> </span>cycle<span class="_"> </span>6,<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffd">pushq<span class="_ _10"> </span></span>instruction<span class="_ _11"> </span>reaches<span class="_ _11"> </span>the</div><div class="t m5 x17 h26 y45d ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_ _13"> </span>stage<span class="_ _13"> </span>and<span class="_ _6"> </span>generates<span class="_ _13"> </span>a<span class="_ _13"> </span>memory<span class="_ _13"> </span>error.<span class="_ _6"> </span>On<span class="_ _13"> </span>the<span class="_ _13"> </span>same<span class="_ _13"> </span>c<span class="_ _0"></span>ycle<span class="_ _1"></span>,<span class="_"> </span>the<span class="_ _6"> </span><span class="ffd">addq<span class="_ _13"> </span></span>instruc-</div><div class="t m5 x17 h26 y45e ff7 fs19 fc2 sc0 ls0 ws0">tion<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>execute<span class="_ _13"> </span>stage<span class="_ _13"> </span>generates<span class="_ _13"> </span>new<span class="_ _13"> </span>values<span class="_"> </span>for<span class="_ _13"> </span>the<span class="_ _13"> </span>condition<span class="_ _13"> </span>codes<span class="_ _1"></span>.<span class="_ _13"> </span>W<span class="_ _1"></span>e<span class="_ _13"> </span>disable</div><div class="t m5 x17 h26 y4ad ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>setting<span class="_"> </span>of<span class="_ _11"> </span>condition<span class="_"> </span>codes<span class="_ _11"> </span>when<span class="_"> </span>an<span class="_ _11"> </span>excepting<span class="_"> </span>instruction<span class="_ _11"> </span>is<span class="_"> </span>in<span class="_ _11"> </span>the<span class="_"> </span>memory<span class="_"> </span>or</div><div class="t m5 x17 h26 y45f ff7 fs19 fc2 sc0 ls0 ws0">write-back<span class="_ _13"> </span>stage<span class="_ _13"> </span>(by<span class="_ _13"> </span>examining<span class="_ _6"> </span>the<span class="_ _13"> </span>signals<span class="_ _13"> </span><span class="ff6">m_stat<span class="_ _13"> </span></span>and<span class="_ _13"> </span><span class="ff6">W_stat<span class="_ _13"> </span></span>and<span class="_ _13"> </span>then<span class="_ _6"> </span>setting<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y460 ff7 fs19 fc2 sc0 ls0 ws0">signal<span class="_ _6"> </span><span class="ff6">set_cc<span class="_ _6"> </span></span>to<span class="_ _6"> </span>zero).<span class="_ _6"> </span>W<span class="_ _1"></span>e<span class="_ _6"> </span>can<span class="_ _6"> </span>also<span class="_ _6"> </span>see<span class="_ _13"> </span>the<span class="_ _a"> </span>combination<span class="_ _6"> </span>of<span class="_ _6"> </span>injecting<span class="_ _13"> </span>bubbles<span class="_ _a"> </span>into<span class="_ _6"> </span>the</div><div class="t m5 x17 h26 y461 ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_"> </span>stage<span class="_ _13"> </span>and<span class="_"> </span>stalling<span class="_ _13"> </span>the<span class="_"> </span>excepting<span class="_ _13"> </span>instruction<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>write-back<span class="_"> </span>stage<span class="_ _13"> </span>in<span class="_"> </span>the</div><div class="t m5 x17 h26 y322 ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_ _11"> </span>of<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _11"> </span>4.63—the<span class="_ _16"> </span><span class="ffd">pushq<span class="_ _11"> </span></span>instruction<span class="_ _16"> </span>remains<span class="_ _11"> </span>stalled<span class="_ _11"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>write-back</div><div class="t m5 x17 h26 y323 ff7 fs19 fc2 sc0 ls0 ws0">stage<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>none<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>subsequent<span class="_"> </span>instructions<span class="_"> </span>get<span class="_"> </span>past<span class="_"> </span>the<span class="_"> </span>execute<span class="_"> </span>stage.</div><div class="t m5 x26 h26 y324 ff7 fs19 fc2 sc0 ls0 ws0">By<span class="_"> </span>this<span class="_"> </span>combination<span class="_"> </span>of<span class="_"> </span>pipelining<span class="_ _13"> </span>the<span class="_"> </span>status<span class="_"> </span>signals<span class="_ _1"></span>,<span class="_"> </span>controlling<span class="_"> </span>the<span class="_"> </span>setting<span class="_"> </span>of</div><div class="t m5 x17 h26 y325 ff7 fs19 fc2 sc0 ls0 ws0">condition<span class="_ _13"> </span>codes<span class="_ _3"></span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>controlling<span class="_ _6"> </span>the<span class="_ _13"> </span>pipeline<span class="_ _6"> </span>stages<span class="_ _0"></span>,<span class="_ _13"> </span>we<span class="_ _6"> </span>achieve<span class="_ _13"> </span>the<span class="_ _13"> </span>desired<span class="_ _6"> </span>behav-</div><div class="t m5 x17 h26 y326 ff7 fs19 fc2 sc0 ls0 ws0">ior<span class="_ _6"> </span>for<span class="_ _13"> </span>exceptions:<span class="_ _6"> </span>all<span class="_ _6"> </span>instructions<span class="_ _13"> </span>prior<span class="_ _6"> </span>to<span class="_ _6"> </span>the<span class="_ _13"> </span>excepting<span class="_ _6"> </span>instruction<span class="_ _6"> </span>are<span class="_ _13"> </span>completed,</div><div class="t m5 x17 h26 y319 ff7 fs19 fc2 sc0 ls0 ws0">while<span class="_ _13"> </span>none<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>following<span class="_ _13"> </span>instructions<span class="_"> </span>has<span class="_ _13"> </span>any<span class="_"> </span>effect<span class="_ _13"> </span>on<span class="_"> </span>the<span class="_ _13"> </span>programmer<span class="_ _1"></span>-visible</div><div class="t m5 x17 h26 y31a ff7 fs19 fc2 sc0 ls0 ws0">state<span class="_ _1"></span>.</div><div class="t m5 x17 h42 y1a57 ff6 fs29 fc6 sc0 ls0 ws0">Detecting<span class="_ _11"> </span>Special<span class="_ _16"> </span>Control<span class="_ _16"> </span>Conditions</div><div class="t m5 x17 h26 y15bf ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _11"> </span>4.64<span class="_"> </span>summarizes<span class="_"> </span>the<span class="_"> </span>conditions<span class="_"> </span>requiring<span class="_"> </span>special<span class="_ _11"> </span>pipeline<span class="_"> </span>control.<span class="_"> </span>It<span class="_"> </span>gives</div><div class="t m5 x17 h26 y15c0 ff7 fs19 fc1 sc0 ls0 ws0">expressions<span class="_ _16"> </span>describing<span class="_ _16"> </span>the<span class="_ _14"> </span>conditions<span class="_ _16"> </span>under<span class="_ _16"> </span>which<span class="_ _16"> </span>the<span class="_ _14"> </span>three<span class="_ _16"> </span>special<span class="_ _16"> </span>cases<span class="_ _14"> </span>arise<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
