<div id="pf23b" class="pf w2 h11" data-page-no="23b"><div class="pc pc23b w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg23b.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">570<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 xc5 h85 y4d57 ff59 fs4a fc1 sc0 ls0 ws0">%rax<span class="_ _3d"> </span>%rbp<span class="_ _60"> </span>%rdx<span class="_ _48"> </span>%xmm0</div><div class="t m5 x24 h85 y4d58 ff59 fs4a fc1 sc0 ls0 ws0">vmulsd (%rax,%rdx,8), %xmm0, %xmm0</div><div class="t m5 x24 h85 y4d59 ff59 fs4a fc1 sc0 ls0 ws0">vmulsd 8(%rax,%rdx,8), %xmm0, %xmm0</div><div class="t m5 x24 h85 y4d5a ff59 fs4a fc1 sc0 ls0 ws0">addq $2,%rdx</div><div class="t m5 x24 h85 y4d5b ff59 fs4a fc1 sc0 ls0 ws0">cmpq %rdx,%rbp</div><div class="t m5 x24 h85 y4d5c ff59 fs4a fc1 sc0 ls0 ws0">jg loop </div><div class="t m5 xc5 h85 y4d5d ff59 fs4a fc1 sc0 ls0 ws0">%rax<span class="_ _3d"> </span>%rbp<span class="_ _60"> </span>%rdx<span class="_ _48"> </span>%xmm0</div><div class="t m5 x9e h84 y4d5e ff58 fs49 fc1 sc0 ls206 ws0">load</div><div class="t m5 xd9 h84 y4d5f ff58 fs49 fc1 sc0 ls206 ws0">mul</div><div class="t m5 x9e h84 y4d60 ff58 fs49 fc1 sc0 ls206 ws0">load</div><div class="t m5 xd9 h84 y4d61 ff58 fs49 fc1 sc0 ls206 ws0">mul</div><div class="t m5 xd9 h84 y4d62 ff58 fs49 fc1 sc0 ls206 ws0">add</div><div class="t m5 x67 h84 y4d63 ff58 fs49 fc1 sc0 ls206 ws0">cmp</div><div class="t m5 x197 h84 y4d64 ff58 fs49 fc1 sc0 ls21a ws0">jg</div><div class="t m5 x1d h3a y4d65 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _21"> </span>5.18<span class="_ _c"> </span><span class="fc1">Graphical<span class="_ _21"> </span>representation<span class="_ _f"> </span>of<span class="_ _21"> </span>inner-loop<span class="_ _21"> </span>code<span class="_ _f"> </span>for<span class="_ _21"> </span><span class="ffd fs19">combine5</span>.<span class="_ _21"> </span><span class="ff6">Each</span></span></div><div class="t m5 x1d h34 y4d66 ff6 fs16 fc1 sc0 ls0 ws0">iteration<span class="_ _14"> </span>has<span class="_ _16"> </span>two</div><div class="t m5 x1af h3a y4d67 ffd fs19 fc1 sc0 ls0 ws0">vmulsd<span class="_ _14"> </span><span class="ff6 fs16">instructions,<span class="_ _14"> </span>each<span class="_ _14"> </span>of<span class="_ _14"> </span>which<span class="_ _14"> </span>is<span class="_ _16"> </span>translated<span class="_ _14"> </span>into<span class="_ _14"> </span>a<span class="_ _14"> </span>load<span class="_ _14"> </span>and<span class="_ _14"> </span>a</span></div><div class="t m5 x1d h34 y4d68 ff6 fs16 fc1 sc0 ls0 ws0">mul<span class="_ _10"> </span>operation.</div><div class="t m5 x14 h2f y4d69 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>5.19</div><div class="t m5 x14 h2f y4d6a ffe fs16 fc1 sc0 ls0 ws0">Abstracting</div><div class="t m5 x1fe h3a y4d6b ffd fs19 fc1 sc0 ls0 ws0">combine5</div><div class="t m5 x14 h2f y4d6c ffe fs16 fc1 sc0 ls0 ws0">operations<span class="_ _16"> </span>as<span class="_ _14"> </span>a<span class="_ _14"> </span>data-</div><div class="t m5 x14 h34 y4d6d ffe fs16 fc1 sc0 ls0 ws0">ï¬‚ow<span class="_"> </span>graph.<span class="_"> </span><span class="ff6">W<span class="_ _0"></span>e<span class="_ _10"> </span>rearrange,</span></div><div class="t m5 x14 h34 y4d6e ff6 fs16 fc1 sc0 ls0 ws0">simplify<span class="_ _3"></span>,<span class="_ _16"> </span>and<span class="_ _11"> </span>abstract<span class="_ _16"> </span>the</div><div class="t m5 x14 h34 y4d6f ff6 fs16 fc1 sc0 ls0 ws0">representation<span class="_ _16"> </span>of<span class="_ _16"> </span>Figure</div><div class="t m5 x14 h34 y4d70 ff6 fs16 fc1 sc0 ls0 ws0">5.18<span class="_ _16"> </span>to<span class="_ _14"> </span>show<span class="_ _14"> </span>the<span class="_ _16"> </span>data</div><div class="t m5 x14 h34 y4d71 ff6 fs16 fc1 sc0 ls0 ws0">dependencies<span class="_ _16"> </span>between</div><div class="t m5 x14 h34 y4d72 ff6 fs16 fc1 sc0 ls0 ws0">successive<span class="_ _15"> </span>iterations</div><div class="t m5 x14 h34 y4d73 ff6 fs16 fc1 sc0 ls0 ws0">(a).<span class="_ _14"> </span>W<span class="_ _0"></span>e<span class="_ _14"> </span>see<span class="_ _14"> </span>that<span class="_ _15"> </span>each</div><div class="t m5 x14 h34 y4d74 ff6 fs16 fc1 sc0 ls0 ws0">iteration<span class="_ _16"> </span>must<span class="_ _14"> </span>perform</div><div class="t m5 x14 h34 y4d75 ff6 fs16 fc1 sc0 ls0 ws0">two<span class="_ _14"> </span>multiplications<span class="_ _14"> </span>in</div><div class="t m5 x14 h34 y4d76 ff6 fs16 fc1 sc0 ls0 ws0">sequence<span class="_ _10"> </span>(b).</div><div class="t m5 x89 h85 y4d77 ff5c fs4a fc1 sc0 ls0 ws0">%rax<span class="_ _3d"> </span>%rbp<span class="_ _60"> </span>%rdx<span class="_ _1cb"></span>%xmm0</div><div class="t m5 x69 h85 y4d78 ff5c fs4a fc1 sc0 ls0 ws0">%rdx<span class="_ _1cb"></span>%xmm0</div><div class="t m5 x7e h85 y4d79 ff5c fs4a fc1 sc0 ls0 ws0">data[</div><div class="t m5 x19a h85 y4d7a ff5d fs49 fc1 sc0 ls0 ws0">i<span class="_ _a"> </span><span class="ff5c fs4a">]</span></div><div class="t m5 x7e h85 y4d7b ff5c fs4a fc1 sc0 ls0 ws0">data[</div><div class="t m5 x19a h85 y4d7c ff5d fs49 fc1 sc0 ls0 ws0">i<span class="_ _a"> </span><span class="ff5c fs4a">+1]</span></div><div class="t m5 x7c h84 y4d7d ff5e fs49 fc1 sc0 ls206 ws0">load</div><div class="t m5 x79 h84 y4d7e ff5e fs49 fc1 sc0 ls206 ws0">load</div><div class="t m5 x1f7 h84 y4d7f ff5e fs49 fc1 sc0 ls206 ws0">mul</div><div class="t m5 x1f7 h84 y4d80 ff5e fs49 fc1 sc0 ls206 ws0">mul<span class="_ _1e1"> </span>add</div><div class="t m5 xec h84 y4d81 ff5e fs49 fc1 sc0 ls206 ws0">cmp</div><div class="t m5 x167 h84 y4d82 ff5e fs49 fc1 sc0 ls206 ws0">(a)<span class="_ _8d"> </span>(b)</div><div class="t m5 xbe h84 y4d83 ff5e fs49 fc1 sc0 ls206 ws0">jg</div><div class="t m5 x1dc h85 y4d84 ff5c fs4a fc1 sc0 ls0 ws0">%rdx<span class="_ _153"></span>%xmm0</div><div class="t m5 x1dc h85 y4d85 ff5c fs4a fc1 sc0 ls0 ws0">%rdx<span class="_ _153"></span>%xmm0</div><div class="t m5 x100 h84 y4d86 ff5e fs49 fc1 sc0 ls206 ws0">load</div><div class="t m5 x12f h84 y4d87 ff5e fs49 fc1 sc0 ls206 ws0">mul<span class="_ _128"> </span>add</div><div class="t m5 x100 h84 y4d88 ff5e fs49 fc1 sc0 ls206 ws0">load</div><div class="t m5 x12f h84 y4d89 ff5e fs49 fc1 sc0 ls206 ws0">mul</div><div class="t m5 x1d h26 yc8c ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>second<span class="_ _13"> </span>to<span class="_ _13"> </span>add<span class="_"> </span><span class="ffd">data[i+1]<span class="_ _13"> </span></span>to<span class="_ _13"> </span><span class="ffd">acc</span>.<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>5.18<span class="_"> </span>shows<span class="_ _13"> </span>a<span class="_ _13"> </span>graphical<span class="_ _13"> </span>representation</div><div class="t m5 x1d h26 yc8d ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _15"> </span>this<span class="_ _21"> </span>code.<span class="_ _15"> </span>T<span class="_ _1"></span>he<span class="_ _21"> </span><span class="ffd">vmulsd<span class="_ _21"> </span></span>instructions<span class="_ _15"> </span>each<span class="_ _21"> </span>get<span class="_ _21"> </span>translated<span class="_ _21"> </span>into<span class="_ _15"> </span>two<span class="_ _21"> </span>operations:</div><div class="t m5 x1d h26 yc8e ff7 fs19 fc1 sc0 ls0 ws0">one<span class="_ _14"> </span>to<span class="_ _15"> </span>load<span class="_ _15"> </span>an<span class="_ _15"> </span>array<span class="_ _15"> </span>element<span class="_ _15"> </span>from<span class="_ _15"> </span>memory<span class="_ _14"> </span>and<span class="_ _15"> </span>one<span class="_ _15"> </span>to<span class="_ _15"> </span>multiply<span class="_ _15"> </span>this<span class="_ _15"> </span>value<span class="_ _15"> </span>by</div><div class="t m5 x1d h26 yc8f ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _15"> </span>accumulated<span class="_ _15"> </span>value.<span class="_ _14"> </span>W<span class="_ _1"></span>e<span class="_ _15"> </span>see<span class="_ _15"> </span>here<span class="_ _15"> </span>that<span class="_ _21"> </span>register<span class="_ _15"> </span><span class="ffd">%xmm0<span class="_ _15"> </span></span>gets<span class="_ _21"> </span>read<span class="_ _15"> </span>and<span class="_ _15"> </span>written</div><div class="t m5 x1d h26 yc90 ff7 fs19 fc1 sc0 ls0 ws0">twice<span class="_ _21"> </span>in<span class="_ _21"> </span>each<span class="_ _f"> </span>execution<span class="_ _21"> </span>of<span class="_ _f"> </span>the<span class="_ _21"> </span>loop.<span class="_ _15"> </span>W<span class="_ _1"></span>e<span class="_ _21"> </span>can<span class="_ _21"> </span>rearrange,<span class="_ _f"> </span>simplify<span class="_ _3"></span>,<span class="_ _e"> </span>and<span class="_ _15"> </span>abstract</div><div class="t m5 x1d h26 yc91 ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>graph,<span class="_ _11"> </span>following<span class="_ _11"> </span>the<span class="_ _11"> </span>process<span class="_ _11"> </span>shown<span class="_"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>5.19(a),<span class="_"> </span>to<span class="_ _11"> </span>obtain<span class="_ _11"> </span>the<span class="_ _11"> </span>template</div><div class="t m5 x1d h26 yc92 ff7 fs19 fc1 sc0 ls0 ws0">shown<span class="_ _16"> </span>in<span class="_ _16"> </span>F<span class="_ _0"></span>igure<span class="_ _16"> </span>5.19(b).<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _14"> </span>then<span class="_ _16"> </span>replicate<span class="_ _16"> </span>this<span class="_ _16"> </span>template<span class="_ _16"> </span><span class="ff11">n/</span>2<span class="_ _14"> </span>times<span class="_ _16"> </span>to<span class="_ _16"> </span>show<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 yc93 ff7 fs19 fc1 sc0 ls0 ws0">computation<span class="_ _f"> </span>for<span class="_ _e"> </span>a<span class="_ _f"> </span>vector<span class="_ _e"> </span>of<span class="_ _f"> </span>length<span class="_ _f"> </span><span class="ff11">n</span>,<span class="_ _1f"> </span>obtaining<span class="_ _f"> </span>the<span class="_ _e"> </span>data-ï¬‚ow<span class="_ _f"> </span>representation</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
