<div id="pf389" class="pf w2 h11" data-page-no="389"><div class="pc pc389 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg389.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">904<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x14 h3a ye7 ff6 fs16 fc2 sc0 ls0 ws0">(a)<span class="_ _10"> </span><span class="ffd fs19">mark<span class="_ _11"> </span></span>function</div><div class="t m5 x14 h2d y2283 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>mark(ptr<span class="_ _1f"> </span>p)<span class="_ _1f"> </span>{</div><div class="t m5 xc7 h2d y2284 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>((b<span class="_ _1f"> </span>=<span class="_ _1f"> </span>isPtr(p))<span class="_ _e"> </span>==<span class="_ _1f"> </span>NULL)</div><div class="t m5 x288 h2d y2285 ffd fs1e fc2 sc0 ls0 ws0">return;</div><div class="t m5 xc7 h2d y2286 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(blockMarked(b))</div><div class="t m5 x288 h2d y2287 ffd fs1e fc2 sc0 ls0 ws0">return;</div><div class="t m5 xc7 h2d y2288 ffd fs1e fc2 sc0 ls0 ws0">markBlock(b);</div><div class="t m5 xc7 h2d y23a1 ffd fs1e fc2 sc0 ls0 ws0">len<span class="_ _e"> </span>=<span class="_ _1f"> </span>length(b);</div><div class="t m5 xc7 h2d y23a2 ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i=0;<span class="_ _1f"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>len;<span class="_ _1f"> </span>i++)</div><div class="t m5 x288 h2d y2554 ffd fs1e fc2 sc0 ls0 ws0">mark(b[i]);</div><div class="t m5 xc7 h2d y2555 ffd fs1e fc2 sc0 ls0 ws0">return;</div><div class="t m5 x14 h2d y2556 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1d1 h3a y2771 ff6 fs16 fc2 sc0 ls0 ws0">(b)<span class="_ _10"> </span><span class="ffd fs19">sweep<span class="_ _11"> </span></span>function</div><div class="t m5 x1d1 h2d y26f8 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>sweep(ptr<span class="_ _1f"> </span>b,<span class="_ _1f"> </span>ptr<span class="_ _e"> </span>end)<span class="_ _1f"> </span>{</div><div class="t m5 x88 h2d y26f9 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(b<span class="_ _1f"> </span>&lt;<span class="_ _1f"> </span>end)<span class="_ _e"> </span>{</div><div class="t m5 xd5 h2d y26fa ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(blockMarked(b))</div><div class="t m5 x191 h2d y26fb ffd fs1e fc2 sc0 ls0 ws0">unmarkBlock(b);</div><div class="t m5 xd5 h2d y26fc ffd fs1e fc2 sc0 ls0 ws0">else<span class="_ _e"> </span>if<span class="_ _1f"> </span>(blockAllocated(b))</div><div class="t m5 x191 h2d y26fd ffd fs1e fc2 sc0 ls0 ws0">free(b);</div><div class="t m5 xd5 h2d y26fe ffd fs1e fc2 sc0 ls0 ws0">b<span class="_ _e"> </span>=<span class="_ _1f"> </span>nextBlock(b);</div><div class="t m5 x88 h2d y26ff ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x88 h2d y2700 ffd fs1e fc2 sc0 ls0 ws0">return;</div><div class="t m5 x1d1 h2d y2701 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x14 h3a y74e9 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.51<span class="_ _66"> </span><span class="fc1">Pseudocode<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span><span class="ffd fs19">mark<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ffd fs19">sweep<span class="_ _10"> </span></span>functions.</span></div><div class="t m5 x29 h26 y74ea ff7 fs19 fc1 sc0 ls0 ws0">Our<span class="_"> </span>description<span class="_ _11"> </span>of<span class="_"> </span>Mark&amp;Sweep<span class="_ _11"> </span>will<span class="_ _11"> </span>assume<span class="_"> </span>the<span class="_ _11"> </span>following<span class="_ _11"> </span>functions<span class="_ _1"></span>,<span class="_ _11"> </span>where</div><div class="t m5 x1d h26 y74eb ffd fs19 fc1 sc0 ls0 ws0">ptr<span class="_ _10"> </span><span class="ff7">is<span class="_"> </span>deÔ¨Åned<span class="_"> </span>as<span class="_"> </span></span>typedef<span class="_ _16"> </span>void<span class="_ _11"> </span>*ptr<span class="ff7">:</span></div><div class="t m5 x75 h26 y74ec ffd fs19 fc1 sc0 ls0 ws0">ptr<span class="_ _11"> </span>isPtr(ptr<span class="_ _16"> </span>p)<span class="ff7 ls2c6">.I<span class="_ _41"></span>f<span class="_ _4a"></span><span class="ffd ls0">p<span class="_ _11"> </span><span class="ff7">points<span class="_"> </span>to<span class="_"> </span>some<span class="_"> </span>word<span class="_ _11"> </span>in<span class="_"> </span>an<span class="_"> </span>allocated<span class="_ _11"> </span>block,<span class="_"> </span>it<span class="_"> </span>returns<span class="_ _11"> </span>a</span></span></span></div><div class="t m5 xcd h26 y74ed ff7 fs19 fc1 sc0 ls0 ws0">pointer<span class="_"> </span><span class="ffd">b<span class="_ _10"> </span></span>to<span class="_"> </span>the<span class="_"> </span>beginning<span class="_"> </span>of<span class="_"> </span>that<span class="_"> </span>block.<span class="_"> </span>Returns<span class="_"> </span>NULL<span class="_"> </span>otherwise<span class="_ _0"></span>.</div><div class="t m5 x75 h26 y74ee ffd fs19 fc1 sc0 ls0 ws0">int<span class="_ _11"> </span>blockMarked(ptr<span class="_ _16"> </span>b)<span class="ff7">.<span class="_ _1f"> </span>Returns<span class="_"> </span></span>true<span class="_ _10"> </span><span class="ff7">if<span class="_"> </span>block<span class="_"> </span></span>b<span class="_ _10"> </span><span class="ff7">is<span class="_"> </span>already<span class="_"> </span>marked.</span></div><div class="t m5 x75 h26 y74ef ffd fs19 fc1 sc0 ls0 ws0">int<span class="_ _11"> </span>blockAllocated(ptr<span class="_ _16"> </span>b)<span class="ff7">.<span class="_ _1f"> </span>Returns<span class="_"> </span></span>true<span class="_ _10"> </span><span class="ff7">if<span class="_"> </span>block<span class="_"> </span></span>b<span class="_ _10"> </span><span class="ff7">is<span class="_"> </span>allocated.</span></div><div class="t m5 x75 h26 y74f0 ffd fs19 fc1 sc0 ls0 ws0">void<span class="_ _11"> </span>markBlock(ptr<span class="_ _16"> </span>b)<span class="ff7">.<span class="_ _1f"> </span>Marks<span class="_"> </span>block<span class="_"> </span></span>b<span class="ff7">.</span></div><div class="t m5 x75 h26 y74f1 ffd fs19 fc1 sc0 ls0 ws0">int<span class="_ _11"> </span>length(ptr<span class="_ _16"> </span>b)<span class="ff7">.<span class="_ _1f"> </span>Returns<span class="_ _21"> </span>the<span class="_ _21"> </span>length<span class="_ _f"> </span>in<span class="_ _21"> </span>words<span class="_ _21"> </span>(excluding<span class="_ _f"> </span>the<span class="_ _21"> </span>header)<span class="_ _f"> </span>of</span></div><div class="t m5 xcd h26 y74f2 ff7 fs19 fc1 sc0 ls0 ws0">block<span class="_"> </span><span class="ffd">b</span>.</div><div class="t m5 x75 h26 y74f3 ffd fs19 fc1 sc0 ls0 ws0">void<span class="_ _11"> </span>unmarkBlock(ptr<span class="_ _16"> </span>b)<span class="ff7">.<span class="_ _1f"> </span>Changes<span class="_"> </span>the<span class="_"> </span>status<span class="_"> </span>of<span class="_"> </span>block<span class="_"> </span></span>b<span class="_ _10"> </span><span class="ff7">from<span class="_"> </span>marked<span class="_"> </span>to<span class="_"> </span>un-</span></div><div class="t m5 xcd h26 y74f4 ff7 fs19 fc1 sc0 ls0 ws0">marked.</div><div class="t m5 x75 h26 y74f5 ffd fs19 fc1 sc0 ls0 ws0">ptr<span class="_ _11"> </span>nextBlock(ptr<span class="_ _16"> </span>b)<span class="ff7">.<span class="_ _1f"> </span>Returns<span class="_"> </span>the<span class="_"> </span>successor<span class="_"> </span>of<span class="_"> </span>block<span class="_"> </span><span class="ff11">b<span class="_ _10"> </span></span>in<span class="_"> </span>the<span class="_"> </span>heap.</span></div><div class="t m5 x29 h26 y74f6 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _21"> </span>mark<span class="_ _21"> </span>phase<span class="_ _21"> </span>calls<span class="_ _21"> </span>the<span class="_ _21"> </span><span class="ffd">mark<span class="_ _21"> </span></span>function<span class="_ _21"> </span>shown<span class="_ _21"> </span>in<span class="_ _21"> </span>F<span class="_ _1"></span>igure<span class="_ _21"> </span>9.51(a)<span class="_ _21"> </span>once<span class="_ _21"> </span>for</div><div class="t m5 x1d h26 y74f7 ff7 fs19 fc1 sc0 ls0 ws0">each<span class="_ _15"> </span>root<span class="_ _15"> </span>node<span class="_ _0"></span>.<span class="_ _15"> </span>T<span class="_ _0"></span>he<span class="_ _15"> </span><span class="ffd">mark<span class="_ _15"> </span></span>function<span class="_ _15"> </span>returns<span class="_ _15"> </span>immediately<span class="_ _21"> </span>if<span class="_ _15"> </span><span class="ffd">p<span class="_ _15"> </span></span>does<span class="_ _15"> </span>not<span class="_ _15"> </span>point<span class="_ _21"> </span>to</div><div class="t m5 x1d h26 y74f8 ff7 fs19 fc1 sc0 ls0 ws0">an<span class="_ _16"> </span>allocated<span class="_ _16"> </span>and<span class="_ _11"> </span>unmarked<span class="_ _16"> </span>heap<span class="_ _16"> </span>block.<span class="_ _16"> </span>Otherwise<span class="_ _1"></span>,<span class="_ _14"> </span>it<span class="_ _16"> </span>marks<span class="_ _16"> </span>the<span class="_ _11"> </span>block<span class="_ _16"> </span>and<span class="_ _16"> </span>calls</div><div class="t m5 x1d h26 y74f9 ff7 fs19 fc1 sc0 ls0 ws0">itself<span class="_"> </span>recursively<span class="_ _13"> </span>on<span class="_"> </span>each<span class="_ _13"> </span>word<span class="_"> </span>in<span class="_"> </span>block.<span class="_ _13"> </span>Each<span class="_"> </span>call<span class="_ _13"> </span>to<span class="_"> </span>the<span class="_"> </span><span class="ffd">mark<span class="_ _13"> </span></span>function<span class="_"> </span>marks<span class="_ _13"> </span>any</div><div class="t m5 x1d h26 y74fa ff7 fs19 fc1 sc0 ls0 ws0">unmarked<span class="_"> </span>and<span class="_"> </span>reachable<span class="_ _13"> </span>descendants<span class="_"> </span>of<span class="_"> </span>some<span class="_"> </span>root<span class="_"> </span>node<span class="_ _1"></span>.<span class="_"> </span>At<span class="_"> </span>the<span class="_"> </span>end<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>mark</div><div class="t m5 x1d h26 y74fb ff7 fs19 fc1 sc0 ls0 ws0">phase<span class="_ _1"></span>,<span class="_ _13"> </span>any<span class="_ _13"> </span>allocated<span class="_ _6"> </span>block<span class="_ _13"> </span>that<span class="_ _6"> </span>is<span class="_ _13"> </span>not<span class="_ _13"> </span>marked<span class="_ _6"> </span>is<span class="_ _13"> </span>guaranteed<span class="_ _6"> </span>to<span class="_ _13"> </span>be<span class="_ _6"> </span>unreachable<span class="_ _13"> </span>and,</div><div class="t m5 x1d h26 y74fc ff7 fs19 fc1 sc0 ls0 ws0">hence<span class="_ _1"></span>,<span class="_"> </span>garbage<span class="_"> </span>that<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>reclaimed<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>sweep<span class="_"> </span>phase.</div><div class="t m5 x29 h26 y74fd ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>sweep<span class="_ _13"> </span>phase<span class="_ _13"> </span>is<span class="_ _13"> </span>a<span class="_ _13"> </span>single<span class="_ _13"> </span>call<span class="_ _13"> </span>to<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">sweep<span class="_ _13"> </span></span>function<span class="_ _13"> </span>shown<span class="_ _13"> </span>in<span class="_ _13"> </span>F<span class="_ _1"></span>igure<span class="_ _13"> </span>9.51(b).</div><div class="t m5 x1d h26 y74fe ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _14"> </span><span class="ffd ls0">sweep<span class="_ _16"> </span><span class="ff7">function<span class="_ _16"> </span>iterates<span class="_ _16"> </span>over<span class="_ _11"> </span>each<span class="_ _16"> </span>block<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span>heap<span class="_ _1"></span>,<span class="_ _16"> </span>freeing<span class="_ _16"> </span>any<span class="_ _16"> </span>unmarked</span></span></div><div class="t m5 x1d h26 y74ff ff7 fs19 fc1 sc0 ls0 ws0">allocated<span class="_"> </span>blocks<span class="_"> </span>(i.e<span class="_ _1"></span>.,<span class="_"> </span>garbage)<span class="_"> </span>that<span class="_"> </span>it<span class="_"> </span>encounters<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y7500 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _13"> </span>9.52<span class="_ _13"> </span>shows<span class="_ _6"> </span>a<span class="_ _13"> </span>graphical<span class="_ _6"> </span>interpretation<span class="_ _13"> </span>of<span class="_ _6"> </span>Mark&amp;Sweep<span class="_ _13"> </span>for<span class="_ _6"> </span>a<span class="_ _13"> </span>small<span class="_ _13"> </span>heap<span class="_ _3"></span>.</div><div class="t m5 x1d h26 y7501 ff7 fs19 fc1 sc0 ls0 ws0">Block<span class="_ _21"> </span>boundaries<span class="_ _21"> </span>are<span class="_ _21"> </span>indicated<span class="_ _21"> </span>by<span class="_ _21"> </span>heavy<span class="_ _21"> </span>lines<span class="_ _1"></span>.<span class="_ _f"> </span>Each<span class="_ _21"> </span>square<span class="_ _21"> </span>corresponds<span class="_ _21"> </span>to<span class="_ _21"> </span>a</div><div class="t m5 x1d h26 y7502 ff7 fs19 fc1 sc0 ls0 ws0">word<span class="_ _11"> </span>of<span class="_ _16"> </span>memory<span class="_ _3"></span>.<span class="_ _11"> </span>Each<span class="_ _16"> </span>block<span class="_ _16"> </span>has<span class="_ _11"> </span>a<span class="_ _16"> </span>one-word<span class="_ _11"> </span>header,<span class="_ _16"> </span>which<span class="_ _11"> </span>is<span class="_ _16"> </span>either<span class="_ _16"> </span>marked<span class="_ _11"> </span>or</div><div class="t m5 x1d h26 y7503 ff7 fs19 fc1 sc0 ls0 ws0">unmarked.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
