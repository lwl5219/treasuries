<div id="pf2e0" class="pf w2 h11" data-page-no="2e0"><div class="pc pc2e0 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2e0.png"/><div class="t m5 x17c h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>7.10<span class="_ _60"> </span>Dynamic<span class="_ _10"> </span>Linking<span class="_ _10"> </span>with<span class="_ _10"> </span>Shared<span class="_ _10"> </span>Libraries<span class="_ _3e"> </span><span class="ffe fs1e">735</span></div><div class="t m5 x34 h2a y548 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">How<span class="_ _11"> </span>do<span class="_ _11"> </span>loaders<span class="_ _11"> </span>really<span class="_ _16"> </span>work?</span></div><div class="t m5 x34 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">Our<span class="_ _6"> </span>description<span class="_ _6"> </span>of<span class="_ _13"> </span>loading<span class="_ _a"> </span>is<span class="_ _13"> </span>conceptually<span class="_ _6"> </span>correct<span class="_ _6"> </span>but<span class="_ _6"> </span>intentionally<span class="_ _13"> </span>not<span class="_ _a"> </span>entirely<span class="_ _13"> </span>accurate<span class="_ _1"></span>.<span class="_ _6"> </span>T<span class="_ _3"></span>o<span class="_ _6"> </span>understand</div><div class="t m5 x34 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">how<span class="_ _13"> </span>loading<span class="_ _13"> </span>really<span class="_ _6"> </span>works<span class="_ _1"></span>,<span class="_"> </span>you<span class="_ _6"> </span>must<span class="_ _13"> </span>understand<span class="_ _13"> </span>the<span class="_ _13"> </span>concepts<span class="_ _13"> </span>of<span class="_ _6"> </span><span class="ffa">processes</span>,<span class="_"> </span><span class="ffa">virtual<span class="_ _6"> </span>memory</span>,<span class="_ _13"> </span>and<span class="_ _13"> </span><span class="ffa">memory</span></div><div class="t m5 x34 h2b y2d2 ffa fs1e fc2 sc0 ls0 ws0">mapping<span class="_ _2"></span><span class="ff7">,<span class="_ _11"> </span>which<span class="_ _10"> </span>we<span class="_ _11"> </span>haven’t<span class="_ _10"> </span>discussed<span class="_ _11"> </span>yet.<span class="_ _11"> </span>As<span class="_ _11"> </span>we<span class="_ _11"> </span>encounter<span class="_ _11"> </span>these<span class="_ _10"> </span>concepts<span class="_ _11"> </span>later<span class="_ _11"> </span>in<span class="_ _11"> </span>Chapters<span class="_ _11"> </span>8<span class="_ _10"> </span>and<span class="_ _11"> </span>9,</span></div><div class="t m5 x34 h2b y2d3 ff7 fs1e fc2 sc0 ls0 ws0">we<span class="_"> </span>will<span class="_"> </span>revisit<span class="_"> </span>loading<span class="_"> </span>and<span class="_"> </span>gradually<span class="_"> </span>reveal<span class="_"> </span>the<span class="_"> </span>mystery<span class="_"> </span>to<span class="_"> </span>you.</div><div class="t m5 x35 h2b y2d4 ff7 fs1e fc2 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_"> </span>the<span class="_"> </span>impatient<span class="_"> </span>reader<span class="_ _0"></span>,<span class="_"> </span>here<span class="_"> </span>is<span class="_"> </span>a<span class="_ _13"> </span>preview<span class="_"> </span>of<span class="_"> </span>how<span class="_"> </span>loading<span class="_"> </span>really<span class="_"> </span>works:<span class="_ _13"> </span>Each<span class="_"> </span>program<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>Linux</div><div class="t m5 x34 h2b y2d5 ff7 fs1e fc2 sc0 ls0 ws0">system<span class="_ _6"> </span>runs<span class="_ _6"> </span>in<span class="_ _6"> </span>the<span class="_ _6"> </span>context<span class="_ _13"> </span>of<span class="_ _a"> </span>a<span class="_ _6"> </span>process<span class="_ _6"> </span>with<span class="_ _6"> </span>its<span class="_ _13"> </span>own<span class="_ _a"> </span>virtual<span class="_ _6"> </span>address<span class="_ _6"> </span>space.<span class="_ _a"> </span>When<span class="_ _6"> </span>the<span class="_ _6"> </span>shell<span class="_ _6"> </span>runs<span class="_ _6"> </span>a<span class="_ _13"> </span>program,</div><div class="t m5 x34 h2b y2d6 ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>parent<span class="_ _13"> </span>shell<span class="_ _13"> </span>process<span class="_ _6"> </span>forks<span class="_"> </span>a<span class="_ _6"> </span>child<span class="_"> </span>process<span class="_ _6"> </span>that<span class="_"> </span>is<span class="_ _6"> </span>a<span class="_"> </span>duplicate<span class="_ _6"> </span>of<span class="_"> </span>the<span class="_ _6"> </span>parent.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>child<span class="_ _13"> </span>process<span class="_ _13"> </span>invokes</div><div class="t m5 x34 h2b y549 ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_"> </span>loader<span class="_"> </span>via<span class="_"> </span>the<span class="_"> </span><span class="ffd">execve<span class="_ _13"> </span></span>system<span class="_"> </span>call.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>loader<span class="_"> </span>deletes<span class="_"> </span>the<span class="_"> </span>child’s<span class="_ _13"> </span>existing<span class="_"> </span>virtual<span class="_"> </span>memory<span class="_"> </span>segments</div><div class="t m5 x34 h2b y54a ff7 fs1e fc2 sc0 ls0 ws0">and<span class="_ _11"> </span>creates<span class="_ _10"> </span>a<span class="_ _11"> </span>new<span class="_ _11"> </span>set<span class="_ _11"> </span>of<span class="_ _11"> </span>code<span class="_ _0"></span>,<span class="_ _11"> </span>data,<span class="_ _11"> </span>heap<span class="_ _1"></span>,<span class="_ _16"> </span>and<span class="_"> </span>stack<span class="_ _11"> </span>segments<span class="_ _0"></span>.<span class="_ _10"> </span>The<span class="_"> </span>new<span class="_ _11"> </span>stack<span class="_ _11"> </span>and<span class="_ _11"> </span>heap<span class="_ _11"> </span>segments<span class="_ _11"> </span>are</div><div class="t m5 x34 h2b y54b ff7 fs1e fc2 sc0 ls0 ws0">initialized<span class="_ _11"> </span>to<span class="_ _16"> </span>zero<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>new<span class="_ _11"> </span>code<span class="_ _16"> </span>and<span class="_ _11"> </span>data<span class="_ _11"> </span>segments<span class="_ _16"> </span>are<span class="_ _11"> </span>initialized<span class="_ _16"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>contents<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>executable</div><div class="t m5 x34 h2b y54c ff7 fs1e fc2 sc0 ls0 ws0">ﬁle<span class="_ _11"> </span>by<span class="_ _16"> </span>mapping<span class="_ _11"> </span>pages<span class="_ _11"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>virtual<span class="_ _11"> </span>address<span class="_ _16"> </span>space<span class="_ _11"> </span>to<span class="_ _16"> </span>page-size<span class="_ _11"> </span>chunks<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>executable<span class="_ _11"> </span>ﬁle.<span class="_ _11"> </span>F<span class="_ _1"></span>inally<span class="_ _3"></span>,</div><div class="t m5 x34 h2b y54d ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>loader<span class="_ _11"> </span>jumps<span class="_ _16"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span><span class="ffd">_start<span class="_ _16"> </span></span>address<span class="_ _3"></span>,<span class="_ _16"> </span>which<span class="_ _11"> </span>eventually<span class="_ _16"> </span>calls<span class="_ _11"> </span>the<span class="_ _11"> </span>application’s<span class="_ _11"> </span><span class="ffd">main<span class="_ _11"> </span></span>routine.<span class="_ _10"> </span>Aside</div><div class="t m5 x34 h2b y54e ff7 fs1e fc2 sc0 ls0 ws0">from<span class="_"> </span>some<span class="_ _11"> </span>header<span class="_ _10"> </span>information,<span class="_ _11"> </span>there<span class="_ _11"> </span>is<span class="_"> </span>no<span class="_ _11"> </span>copying<span class="_"> </span>of<span class="_ _11"> </span>data<span class="_ _10"> </span>from<span class="_ _11"> </span>disk<span class="_ _10"> </span>to<span class="_ _11"> </span>memory<span class="_ _10"> </span>during<span class="_ _11"> </span>loading.<span class="_"> </span>T<span class="_ _0"></span>he</div><div class="t m5 x34 h2b y70b ff7 fs1e fc2 sc0 ls0 ws0">copying<span class="_ _6"> </span>is<span class="_ _6"> </span>deferred<span class="_ _6"> </span>until<span class="_ _13"> </span>the<span class="_ _a"> </span>CPU<span class="_ _6"> </span>references<span class="_ _13"> </span>a<span class="_ _a"> </span>mapped<span class="_ _6"> </span>virtual<span class="_ _13"> </span>page<span class="_ _1"></span>,<span class="_ _6"> </span>at<span class="_ _13"> </span>which<span class="_ _a"> </span>point<span class="_ _6"> </span>the<span class="_ _13"> </span>operating<span class="_ _a"> </span>system</div><div class="t m5 x34 h2b y70c ff7 fs1e fc2 sc0 ls0 ws0">automatically<span class="_"> </span>transfers<span class="_"> </span>the<span class="_"> </span>page<span class="_"> </span>from<span class="_"> </span>disk<span class="_"> </span>to<span class="_"> </span>memory<span class="_"> </span>using<span class="_"> </span>its<span class="_"> </span>paging<span class="_"> </span>mechanism.</div><div class="t m5 x17 h26 y613a ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _6"> </span>how<span class="_ _13"> </span>much<span class="_ _6"> </span>there<span class="_ _13"> </span>is<span class="_ _6"> </span>in<span class="_ _13"> </span>a<span class="_ _6"> </span>system.<span class="_ _13"> </span>Disk<span class="_ _6"> </span>space<span class="_ _13"> </span>and<span class="_ _6"> </span>kitchen<span class="_ _6"> </span>trash<span class="_ _13"> </span>cans<span class="_ _6"> </span>share<span class="_ _13"> </span>this<span class="_ _6"> </span>same</div><div class="t m5 x17 h26 y613b ff7 fs19 fc2 sc0 ls0 ws0">property<span class="_ _3"></span>.)</div><div class="t m5 x26 h26 y613c ffa fs19 fc2 sc0 ls0 ws0">Shared<span class="_ _14"> </span>libraries<span class="_ _15"> </span><span class="ff7">are<span class="_ _15"> </span>modern<span class="_ _15"> </span>innovations<span class="_ _15"> </span>that<span class="_ _15"> </span>address<span class="_ _14"> </span>the<span class="_ _15"> </span>disadvantages<span class="_ _15"> </span>of</span></div><div class="t m5 x17 h26 y613d ff7 fs19 fc2 sc0 ls0 ws0">static<span class="_ _13"> </span>libraries<span class="_ _3"></span>.<span class="_ _13"> </span>A<span class="_ _13"> </span>shared<span class="_ _13"> </span>library<span class="_ _13"> </span>is<span class="_ _6"> </span>an<span class="_ _13"> </span>object<span class="_ _13"> </span>module<span class="_ _13"> </span>that,<span class="_ _13"> </span>at<span class="_ _6"> </span>either<span class="_ _13"> </span>run<span class="_ _13"> </span>time<span class="_ _13"> </span>or<span class="_ _13"> </span>load</div><div class="t m5 x17 h26 y613e ff7 fs19 fc2 sc0 ls0 ws0">time<span class="_ _1"></span>,<span class="_"> </span>can<span class="_"> </span>be<span class="_ _13"> </span>loaded<span class="_"> </span>at<span class="_"> </span>an<span class="_ _13"> </span>arbitrary<span class="_"> </span>memory<span class="_"> </span>address<span class="_ _13"> </span>and<span class="_"> </span>linked<span class="_"> </span>with<span class="_ _13"> </span>a<span class="_"> </span>program<span class="_ _13"> </span>in</div><div class="t m5 x17 h26 y613f ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>his<span class="_ _13"> </span>process<span class="_ _13"> </span>is<span class="_ _13"> </span>known<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ffa">dynamic<span class="_ _13"> </span>linking<span class="_"> </span></span>and<span class="_ _13"> </span>is<span class="_ _13"> </span>performed<span class="_ _13"> </span>by<span class="_ _13"> </span>a<span class="_ _13"> </span>program</div><div class="t m5 x17 h26 y6140 ff7 fs19 fc2 sc0 ls0 ws0">called<span class="_ _13"> </span>a<span class="_ _13"> </span><span class="ffa">dynamic<span class="_ _13"> </span>linker<span class="_ _2"></span></span>.<span class="_ _13"> </span>Shared<span class="_ _13"> </span>libraries<span class="_ _13"> </span>are<span class="_ _13"> </span>also<span class="_ _13"> </span>referred<span class="_ _13"> </span>to<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ffa">shared<span class="_ _13"> </span>objects</span>,<span class="_ _13"> </span>and</div><div class="t m5 x17 h26 y6141 ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_ _13"> </span>Linux<span class="_ _6"> </span>systems<span class="_ _13"> </span>they<span class="_ _13"> </span>are<span class="_ _6"> </span>indicated<span class="_ _13"> </span>by<span class="_ _13"> </span>the<span class="_ _6"> </span><span class="ffd">.so<span class="_ _13"> </span></span>sufﬁx.<span class="_ _6"> </span>Microsoft<span class="_ _13"> </span>operating<span class="_ _13"> </span>systems</div><div class="t m5 x17 h26 y6142 ff7 fs19 fc2 sc0 ls0 ws0">make<span class="_ _16"> </span>heavy<span class="_ _16"> </span>use<span class="_ _14"> </span>of<span class="_ _16"> </span>shared<span class="_ _14"> </span>libraries<span class="_ _1"></span>,<span class="_ _14"> </span>which<span class="_ _16"> </span>they<span class="_ _14"> </span>refer<span class="_ _16"> </span>to<span class="_ _16"> </span>as<span class="_ _14"> </span>DLLs<span class="_ _16"> </span>(dynamic<span class="_ _14"> </span>link</div><div class="t m5 x17 h26 y6143 ff7 fs19 fc2 sc0 ls0 ws0">libraries).</div><div class="t m5 x26 h26 y6144 ff7 fs19 fc2 sc0 ls0 ws0">Shared<span class="_ _14"> </span>libraries<span class="_ _14"> </span>are<span class="_ _15"> </span>“shared”<span class="_ _14"> </span>in<span class="_ _15"> </span>two<span class="_ _14"> </span>different<span class="_ _15"> </span>ways<span class="_ _1"></span>.<span class="_ _14"> </span>F<span class="_ _0"></span>irst,<span class="_ _15"> </span>in<span class="_ _14"> </span>any<span class="_ _15"> </span>given<span class="_ _14"> </span>ﬁle</div><div class="t m5 x17 h26 y6145 ff7 fs19 fc2 sc0 ls0 ws0">system,<span class="_"> </span>there<span class="_ _11"> </span>is<span class="_"> </span>exactly<span class="_ _11"> </span>one<span class="_"> </span><span class="ffd">.so<span class="_ _11"> </span></span>ﬁle<span class="_"> </span>for<span class="_ _11"> </span>a<span class="_"> </span>particular<span class="_ _11"> </span>library<span class="_ _3"></span>.<span class="_"> </span>The<span class="_"> </span>code<span class="_"> </span>and<span class="_"> </span>data<span class="_ _11"> </span>in</div><div class="t m5 x17 h26 y6146 ff7 fs19 fc2 sc0 ls0 ws0">this<span class="_ _6"> </span><span class="ffd">.so<span class="_ _6"> </span></span>ﬁle<span class="_ _6"> </span>are<span class="_ _6"> </span>shared<span class="_ _13"> </span>by<span class="_ _a"> </span>all<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _13"> </span>executable<span class="_ _a"> </span>object<span class="_ _6"> </span>ﬁles<span class="_ _6"> </span>that<span class="_ _6"> </span>reference<span class="_ _13"> </span>the<span class="_ _a"> </span>library<span class="_ _3"></span>,</div><div class="t m5 x17 h26 y6147 ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_"> </span>opposed<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span>contents<span class="_ _11"> </span>of<span class="_ _11"> </span>static<span class="_"> </span>libraries<span class="_ _0"></span>,<span class="_"> </span>which<span class="_ _11"> </span>are<span class="_ _11"> </span>copied<span class="_ _11"> </span>and<span class="_ _11"> </span>embedded<span class="_ _11"> </span>in</div><div class="t m5 x17 h26 y6148 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>executables<span class="_ _13"> </span>that<span class="_"> </span>reference<span class="_ _13"> </span>them.<span class="_ _13"> </span>Second,<span class="_ _13"> </span>a<span class="_ _13"> </span>single<span class="_"> </span>copy<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">.text<span class="_ _13"> </span></span>section<span class="_"> </span>of</div><div class="t m5 x17 h26 y6149 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>shared<span class="_"> </span>library<span class="_ _13"> </span>in<span class="_"> </span>memory<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>shared<span class="_ _13"> </span>by<span class="_"> </span>different<span class="_"> </span>running<span class="_"> </span>processes<span class="_ _3"></span>.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>will</div><div class="t m5 x17 h26 y614a ff7 fs19 fc2 sc0 ls0 ws0">explore<span class="_"> </span>this<span class="_"> </span>in<span class="_"> </span>more<span class="_"> </span>detail<span class="_"> </span>when<span class="_"> </span>we<span class="_"> </span>study<span class="_"> </span>virtual<span class="_"> </span>memory<span class="_"> </span>in<span class="_"> </span>Chapter<span class="_"> </span>9.</div><div class="t m5 x26 h26 y614b ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _13"> </span>7.16<span class="_ _13"> </span>summarizes<span class="_ _13"> </span>the<span class="_ _13"> </span>dynamic<span class="_ _13"> </span>linking<span class="_ _13"> </span>process<span class="_ _13"> </span>for<span class="_ _13"> </span>the<span class="_ _13"> </span>example<span class="_ _13"> </span>program</div><div class="t m5 x17 h26 y614c ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _21"> </span>Figure<span class="_ _15"> </span>7.7.<span class="_ _f"> </span>T<span class="_ _3"></span>o<span class="_ _21"> </span>build<span class="_ _21"> </span>a<span class="_ _f"> </span>shared<span class="_ _21"> </span>library<span class="_ _f"> </span><span class="ffd">libvector.so<span class="_ _21"> </span></span>of<span class="_ _f"> </span>our<span class="_ _f"> </span>example<span class="_ _21"> </span>vector</div><div class="t m5 x17 h26 y614d ff7 fs19 fc2 sc0 ls0 ws0">routines<span class="_"> </span>in<span class="_ _13"> </span>Figure<span class="_ _13"> </span>7.6,<span class="_"> </span>we<span class="_"> </span>invoke<span class="_"> </span>the<span class="_ _13"> </span>compiler<span class="_"> </span>driver<span class="_"> </span>with<span class="_"> </span>some<span class="_ _13"> </span>special<span class="_"> </span>directives</div><div class="t m5 x17 h26 y614e ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>the<span class="_"> </span>compiler<span class="_"> </span>and<span class="_"> </span>linker:</div><div class="t m5 x17 h2d y614f ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-shared<span class="_ _1f"> </span>-fpic<span class="_ _e"> </span>-o<span class="_ _1f"> </span>libvector.so<span class="_ _e"> </span>addvec.c<span class="_ _1f"> </span>multvec.c</span></div><div class="t m5 x17 h26 y8d6 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _11"> </span><span class="ffd ls0">-fpic<span class="_ _10"> </span><span class="ff7">ﬂag<span class="_"> </span>directs<span class="_"> </span>the<span class="_"> </span>compiler<span class="_"> </span>to<span class="_"> </span>generate<span class="_"> </span><span class="ffa">position-independent<span class="_"> </span>code<span class="_"> </span></span>(more</span></span></div><div class="t m5 x17 h26 y8d7 ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_"> </span>this<span class="_"> </span>in<span class="_"> </span>the<span class="_ _13"> </span>next<span class="_"> </span>section).<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span><span class="ffd">-shared<span class="_ _10"> </span></span>ﬂag<span class="_"> </span>directs<span class="_"> </span>the<span class="_"> </span>linker<span class="_"> </span>to<span class="_ _13"> </span>create<span class="_"> </span>a<span class="_"> </span>shared</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
