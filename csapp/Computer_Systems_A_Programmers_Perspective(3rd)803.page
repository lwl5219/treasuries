<div id="pf323" class="pf w2 h11" data-page-no="323"><div class="pc pc323 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg323.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">802<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 x1d h41 ye7 ffe fs29 fc2 sc0 ls0 ws0">8.5.5<span class="_ _48"> </span><span class="fs19">W<span class="_ _0"></span>riting<span class="_"> </span>Signal<span class="_"> </span>Handlers</span></div><div class="t m5 x1d h26 ybbe ff7 fs19 fc2 sc0 ls0 ws0">Signal<span class="_ _13"> </span>handling<span class="_ _13"> </span>is<span class="_ _13"> </span>one<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>thornier<span class="_ _13"> </span>aspects<span class="_ _13"> </span>of<span class="_ _13"> </span>Linux<span class="_ _13"> </span>system-level<span class="_ _13"> </span>programming.</div><div class="t m5 x1d h26 ybbf ff7 fs19 fc2 sc0 ls0 ws0">Handlers<span class="_ _6"> </span>have<span class="_ _6"> </span>several<span class="_ _6"> </span>attributes<span class="_ _6"> </span>that<span class="_ _6"> </span>make<span class="_ _6"> </span>them<span class="_ _6"> </span>difﬁcult<span class="_ _6"> </span>to<span class="_ _6"> </span>reason<span class="_ _6"> </span>about:<span class="_ _6"> </span>(1)<span class="_ _6"> </span>Han-</div><div class="t m5 x1d h26 ybc0 ff7 fs19 fc2 sc0 ls0 ws0">dlers<span class="_ _13"> </span>run<span class="_ _6"> </span>concurrently<span class="_ _13"> </span>with<span class="_ _13"> </span>the<span class="_ _6"> </span>main<span class="_ _13"> </span>program<span class="_ _13"> </span>and<span class="_ _6"> </span>share<span class="_ _13"> </span>the<span class="_ _13"> </span>same<span class="_ _6"> </span>global<span class="_ _13"> </span>variables<span class="_ _1"></span>,</div><div class="t m5 x1d h26 ybc1 ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _16"> </span>thus<span class="_ _16"> </span>can<span class="_ _16"> </span>interfere<span class="_ _14"> </span>with<span class="_ _16"> </span>the<span class="_ _16"> </span>main<span class="_ _16"> </span>program<span class="_ _14"> </span>and<span class="_ _16"> </span>with<span class="_ _16"> </span>other<span class="_ _16"> </span>handlers<span class="_ _1"></span>.<span class="_ _14"> </span>(2)<span class="_ _16"> </span>T<span class="_ _1"></span>he</div><div class="t m5 x1d h26 ybc2 ff7 fs19 fc2 sc0 ls0 ws0">rules<span class="_ _13"> </span>for<span class="_ _6"> </span>how<span class="_ _13"> </span>and<span class="_ _13"> </span>when<span class="_ _13"> </span>signals<span class="_ _6"> </span>are<span class="_ _13"> </span>received<span class="_ _13"> </span>is<span class="_ _13"> </span>often<span class="_ _6"> </span>counterintuitive.<span class="_ _6"> </span>(3)<span class="_ _13"> </span>Different</div><div class="t m5 x1d h26 y119b ff7 fs19 fc2 sc0 ls0 ws0">systems<span class="_"> </span>can<span class="_"> </span>have<span class="_"> </span>different<span class="_"> </span>signal-handling<span class="_"> </span>semantics<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y119c ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _13"> </span>this<span class="_"> </span>section,<span class="_ _13"> </span>we<span class="_ _13"> </span>address<span class="_"> </span>these<span class="_ _13"> </span>issues<span class="_ _13"> </span>and<span class="_"> </span>give<span class="_ _13"> </span>you<span class="_ _13"> </span>some<span class="_ _13"> </span>basic<span class="_"> </span>guidelines<span class="_ _13"> </span>for</div><div class="t m5 x1d h26 y216 ff7 fs19 fc2 sc0 ls0 ws0">writing<span class="_"> </span>safe<span class="_ _1"></span>,<span class="_"> </span>correct,<span class="_"> </span>and<span class="_"> </span>portable<span class="_"> </span>signal<span class="_"> </span>handlers<span class="_ _1"></span>.</div><div class="t m5 x1d h42 y4951 ff6 fs29 fc6 sc0 ls0 ws0">Safe<span class="_ _11"> </span>Signal<span class="_ _16"> </span>Handling</div><div class="t m5 x1d h26 y27e7 ff7 fs19 fc1 sc0 ls0 ws0">Signal<span class="_ _11"> </span>handlers<span class="_ _11"> </span>are<span class="_ _11"> </span>tricky<span class="_ _16"> </span>because<span class="_ _11"> </span>they<span class="_ _11"> </span>can<span class="_ _11"> </span>run<span class="_ _11"> </span>concurrently<span class="_ _16"> </span>with<span class="_ _11"> </span>the<span class="_ _11"> </span>main<span class="_ _11"> </span>pro-</div><div class="t m5 x1d h26 y6907 ff7 fs19 fc1 sc0 ls0 ws0">gram<span class="_ _16"> </span>and<span class="_ _14"> </span>with<span class="_ _14"> </span>each<span class="_ _14"> </span>other,<span class="_ _14"> </span>as<span class="_ _16"> </span>we<span class="_ _14"> </span>saw<span class="_ _14"> </span>in<span class="_ _14"> </span>F<span class="_ _1"></span>igure<span class="_ _14"> </span>8.31.<span class="_ _14"> </span>If<span class="_ _14"> </span>a<span class="_ _16"> </span>handler<span class="_ _14"> </span>and<span class="_ _14"> </span>the<span class="_ _14"> </span>main</div><div class="t m5 x1d h26 y6908 ff7 fs19 fc1 sc0 ls0 ws0">program<span class="_"> </span>access<span class="_ _11"> </span>the<span class="_ _11"> </span>same<span class="_ _11"> </span>global<span class="_ _11"> </span>data<span class="_ _11"> </span>structure<span class="_ _11"> </span>concurrently<span class="_ _3"></span>,<span class="_ _11"> </span>then<span class="_ _11"> </span>the<span class="_ _11"> </span>results<span class="_ _11"> </span>can</div><div class="t m5 x1d h26 y6909 ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_"> </span>unpredictable<span class="_"> </span>and<span class="_"> </span>often<span class="_"> </span>fatal.</div><div class="t m5 x29 h26 y690a ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _14"> </span>will<span class="_ _14"> </span>explore<span class="_ _14"> </span>concurrent<span class="_ _14"> </span>programming<span class="_ _14"> </span>in<span class="_ _15"> </span>detail<span class="_ _14"> </span>in<span class="_ _14"> </span>Chapter<span class="_ _14"> </span>12.<span class="_ _14"> </span>Our<span class="_ _14"> </span>aim</div><div class="t m5 x1d h26 y690b ff7 fs19 fc1 sc0 ls0 ws0">here<span class="_ _15"> </span>is<span class="_ _15"> </span>to<span class="_ _21"> </span>give<span class="_ _15"> </span>you<span class="_ _21"> </span>some<span class="_ _15"> </span>conservative<span class="_ _15"> </span>guidelines<span class="_ _21"> </span>for<span class="_ _15"> </span>writing<span class="_ _21"> </span>handlers<span class="_ _15"> </span>that<span class="_ _21"> </span>are</div><div class="t m5 x1d h26 y690c ff7 fs19 fc1 sc0 ls0 ws0">safe<span class="_ _14"> </span>to<span class="_ _14"> </span>run<span class="_ _14"> </span>concurrently<span class="_ _3"></span>.<span class="_ _14"> </span>If<span class="_ _14"> </span>you<span class="_ _14"> </span>ignore<span class="_ _14"> </span>these<span class="_ _14"> </span>guidelines<span class="_ _1"></span>,<span class="_ _15"> </span>you<span class="_ _14"> </span>run<span class="_ _14"> </span>the<span class="_ _14"> </span>risk<span class="_ _14"> </span>of<span class="_ _14"> </span>in-</div><div class="t m5 x1d h26 y690d ff7 fs19 fc1 sc0 ls0 ws0">troducing<span class="_ _11"> </span>subtle<span class="_ _16"> </span>concurrency<span class="_ _11"> </span>errors<span class="_ _1"></span>.<span class="_ _16"> </span>W<span class="_ _1"></span>ith<span class="_ _16"> </span>such<span class="_ _16"> </span>errors<span class="_ _1"></span>,<span class="_ _16"> </span>your<span class="_ _11"> </span>program<span class="_ _16"> </span>works<span class="_ _16"> </span>cor<span class="_ _3"></span>-</div><div class="t m5 x1d h26 y690e ff7 fs19 fc1 sc0 ls0 ws0">rectly<span class="_ _f"> </span>most<span class="_ _e"> </span>of<span class="_ _21"> </span>the<span class="_ _e"> </span>time<span class="_ _1"></span>.<span class="_ _e"> </span>However<span class="_ _1"></span>,<span class="_ _1f"> </span>when<span class="_ _f"> </span>it<span class="_ _f"> </span>fails<span class="_ _1"></span>,<span class="_ _1f"> </span>it<span class="_ _f"> </span>fails<span class="_ _e"> </span>in<span class="_ _21"> </span>unpredictable<span class="_ _e"> </span>and</div><div class="t m5 x1d h26 y690f ff7 fs19 fc1 sc0 ls0 ws0">unrepeatable<span class="_ _11"> </span>ways<span class="_ _16"> </span>that<span class="_ _11"> </span>are<span class="_ _16"> </span>horrendously<span class="_ _11"> </span>difﬁcult<span class="_ _16"> </span>to<span class="_ _11"> </span>debug.<span class="_ _11"> </span>F<span class="_ _1"></span>orewarned<span class="_ _16"> </span>is<span class="_ _11"> </span>fore-</div><div class="t m5 x1d h26 y6910 ff7 fs19 fc1 sc0 ls0 ws0">armed!</div><div class="t m5 x75 h26 y6911 ffa fs19 fc1 sc0 ls0 ws0">G0.<span class="_ _6"> </span>K<span class="_ _0"></span>eep<span class="_ _6"> </span>handlers<span class="_ _13"> </span>as<span class="_ _6"> </span>simple<span class="_ _13"> </span>as<span class="_ _6"> </span>possible.<span class="_ _21"> </span><span class="ff7">T<span class="_ _1"></span>he<span class="_ _13"> </span>best<span class="_ _6"> </span>way<span class="_ _13"> </span>to<span class="_ _6"> </span>avoid<span class="_ _13"> </span>trouble<span class="_ _6"> </span>is<span class="_ _13"> </span>to<span class="_ _6"> </span>keep</span></div><div class="t m5 xcd h26 y6912 ff7 fs19 fc1 sc0 ls0 ws0">your<span class="_ _11"> </span>handlers<span class="_ _11"> </span>as<span class="_ _16"> </span>small<span class="_ _11"> </span>and<span class="_ _11"> </span>simple<span class="_ _11"> </span>as<span class="_ _16"> </span>possible<span class="_ _1"></span>.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>handler</div><div class="t m5 xcd h26 y6913 ff7 fs19 fc1 sc0 ls0 ws0">might<span class="_ _f"> </span>simply<span class="_ _f"> </span>set<span class="_ _f"> </span>a<span class="_ _f"> </span>global<span class="_ _f"> </span>ﬂag<span class="_ _f"> </span>and<span class="_ _f"> </span>return<span class="_ _f"> </span>immediately;<span class="_ _1f"> </span>all<span class="_ _21"> </span>processing</div><div class="t m5 xcd h26 y6914 ff7 fs19 fc1 sc0 ls0 ws0">associated<span class="_ _6"> </span>with<span class="_ _6"> </span>the<span class="_ _6"> </span>receipt<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _6"> </span>signal<span class="_ _6"> </span>is<span class="_ _6"> </span>performed<span class="_ _6"> </span>by<span class="_ _6"> </span>the<span class="_ _6"> </span>main<span class="_ _13"> </span>program,</div><div class="t m5 xcd h26 y6915 ff7 fs19 fc1 sc0 ls0 ws0">which<span class="_"> </span>periodically<span class="_"> </span>checks<span class="_"> </span>(and<span class="_"> </span>resets)<span class="_"> </span>the<span class="_"> </span>ﬂag.</div><div class="t m5 x75 h26 y6916 ffa fs19 fc1 sc0 ls0 ws0">G1.<span class="_ _14"> </span>Call<span class="_ _14"> </span>only<span class="_ _14"> </span>async-signal-safe<span class="_ _14"> </span>functions<span class="_ _16"> </span>in<span class="_ _14"> </span>your<span class="_ _14"> </span>handlers<span class="_ _0"></span>.<span class="_ _21"> </span><span class="ff7">A<span class="_ _14"> </span>function<span class="_ _14"> </span>that<span class="_ _14"> </span>is</span></div><div class="t m5 xcd h26 y6917 ffa fs19 fc1 sc0 ls0 ws0">async-signal-safe<span class="ff7">,<span class="_ _15"> </span>or<span class="_ _15"> </span>simply<span class="_ _14"> </span></span>safe<span class="_ _2"></span><span class="ff7">,<span class="_ _15"> </span>has<span class="_ _14"> </span>the<span class="_ _15"> </span>property<span class="_ _14"> </span>that<span class="_ _15"> </span>it<span class="_ _14"> </span>can<span class="_ _15"> </span>be<span class="_ _14"> </span>safely</span></div><div class="t m5 xcd h26 y6918 ff7 fs19 fc1 sc0 ls0 ws0">called<span class="_ _e"> </span>from<span class="_ _e"> </span>a<span class="_ _1f"> </span>signal<span class="_ _e"> </span>handler,<span class="_ _1f"> </span>either<span class="_ _e"> </span>because<span class="_ _e"> </span>it<span class="_ _1f"> </span>is<span class="_ _e"> </span><span class="ffa">reentrant<span class="_ _1f"> </span></span>(e.g<span class="_ _0"></span>.,<span class="_ _1f"> </span>ac-</div><div class="t m5 xcd h26 y6919 ff7 fs19 fc1 sc0 ls0 ws0">cesses<span class="_ _e"> </span>only<span class="_ _e"> </span>local<span class="_ _f"> </span>variables;<span class="_ _23"> </span>see<span class="_ _e"> </span>Section<span class="_ _e"> </span>12.7.2),<span class="_ _e"> </span>or<span class="_ _e"> </span>because<span class="_ _e"> </span>it<span class="_ _e"> </span>cannot</div><div class="t m5 xcd h26 y691a ff7 fs19 fc1 sc0 ls0 ws0">be<span class="_ _e"> </span>interrupted<span class="_ _e"> </span>by<span class="_ _f"> </span>a<span class="_ _e"> </span>signal<span class="_ _e"> </span>handler.<span class="_ _f"> </span>Figure<span class="_ _f"> </span>8.33<span class="_ _e"> </span>lists<span class="_ _e"> </span>the<span class="_ _e"> </span>system-level</div><div class="t m5 xcd h26 y691b ff7 fs19 fc1 sc0 ls0 ws0">functions<span class="_ _e"> </span>that<span class="_ _e"> </span>Linux<span class="_ _e"> </span>guarantees<span class="_ _e"> </span>to<span class="_ _e"> </span>be<span class="_ _e"> </span>safe<span class="_ _0"></span>.<span class="_ _e"> </span>Notice<span class="_ _e"> </span>that<span class="_ _e"> </span>many<span class="_ _e"> </span>popu-</div><div class="t m5 xcd h26 y691c ff7 fs19 fc1 sc0 ls0 ws0">lar<span class="_ _15"> </span>functions<span class="_ _1"></span>,<span class="_ _f"> </span>such<span class="_ _15"> </span>as<span class="_ _15"> </span><span class="ffd">printf</span>,<span class="_ _f"> </span><span class="ffd">sprintf</span>,<span class="_ _f"> </span><span class="ffd">malloc</span>,<span class="_ _21"> </span>and<span class="_ _15"> </span><span class="ffd">exit</span>,<span class="_ _f"> </span>are<span class="_ _15"> </span><span class="ffa">not<span class="_ _e"> </span></span>on</div><div class="t m5 xcd h26 y691d ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>list.</div><div class="t m5 x1c6 h26 y691e ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>only<span class="_"> </span>safe<span class="_"> </span>way<span class="_ _11"> </span>to<span class="_"> </span>generate<span class="_ _11"> </span>output<span class="_"> </span>from<span class="_"> </span>a<span class="_ _11"> </span>signal<span class="_"> </span>handler<span class="_"> </span>is<span class="_ _11"> </span>to<span class="_"> </span>use</div><div class="t m5 xcd h26 y691f ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _15"> </span><span class="ffd">write<span class="_ _15"> </span></span>function<span class="_ _15"> </span>(see<span class="_ _21"> </span>Section<span class="_ _15"> </span>10.1).<span class="_ _15"> </span>In<span class="_ _21"> </span>particular,<span class="_ _15"> </span>calling<span class="_ _21"> </span><span class="ffd">printf<span class="_ _15"> </span></span>or</div><div class="t m5 xcd h26 y6920 ffd fs19 fc1 sc0 ls0 ws0">sprintf<span class="_ _10"> </span><span class="ff7">is<span class="_ _11"> </span>unsafe<span class="_ _0"></span>.<span class="_"> </span>T<span class="_ _3"></span>o<span class="_"> </span>work<span class="_ _11"> </span>around<span class="_"> </span>this<span class="_ _11"> </span>unfortunate<span class="_"> </span>restriction,<span class="_ _11"> </span>we<span class="_ _11"> </span>have</span></div><div class="t m5 xcd h26 y6921 ff7 fs19 fc1 sc0 ls0 ws0">developed<span class="_ _14"> </span>some<span class="_ _14"> </span>safe<span class="_ _14"> </span>functions<span class="_ _1"></span>,<span class="_ _15"> </span>called<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ff9">Sio<span class="_ _14"> </span></span>(Safe<span class="_ _14"> </span>I/O)<span class="_ _14"> </span>package<span class="_ _0"></span>,<span class="_ _14"> </span>that</div><div class="t m5 xcd h26 y6922 ff7 fs19 fc1 sc0 ls0 ws0">you<span class="_"> </span>can<span class="_"> </span>use<span class="_"> </span>to<span class="_"> </span>print<span class="_"> </span>simple<span class="_"> </span>messages<span class="_"> </span>from<span class="_"> </span>signal<span class="_"> </span>handlers<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
