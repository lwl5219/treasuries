<div id="pf38c" class="pf w2 h11" data-page-no="38c"><div class="pc pc38c w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg38c.png"/><div class="t m5 x16d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.11<span class="_ _60"> </span>Common<span class="_ _10"> </span>Memor<span class="_"> </span>y-Related<span class="_ _10"> </span>Bugs<span class="_ _10"> </span>in<span class="_ _10"> </span>C<span class="_ _10"> </span>Programs<span class="_ _3e"> </span><span class="ffe fs1e">907</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_"> </span>this<span class="_"> </span>case<span class="_ _1"></span>,<span class="_"> </span><span class="ffd">scanf<span class="_ _10"> </span></span>will<span class="_"> </span>interpret<span class="_ _13"> </span>the<span class="_"> </span>contents<span class="_"> </span>of<span class="_"> </span><span class="ffd">val<span class="_ _10"> </span></span>as<span class="_"> </span>an<span class="_ _13"> </span>address<span class="_"> </span>and<span class="_"> </span>attempt<span class="_"> </span>to</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">write<span class="_ _6"> </span>a<span class="_ _13"> </span>word<span class="_ _6"> </span>to<span class="_ _13"> </span>that<span class="_ _6"> </span>location.<span class="_ _6"> </span>In<span class="_ _13"> </span>the<span class="_ _6"> </span>best<span class="_ _13"> </span>case<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _6"> </span>program<span class="_ _6"> </span>terminates<span class="_ _13"> </span>immediately</div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_ _15"> </span>an<span class="_ _15"> </span>exception.<span class="_ _21"> </span>In<span class="_ _15"> </span>the<span class="_ _21"> </span>worst<span class="_ _15"> </span>case,<span class="_ _15"> </span>the<span class="_ _21"> </span>contents<span class="_ _15"> </span>of<span class="_ _15"> </span><span class="ffd">val<span class="_ _21"> </span></span>correspond<span class="_ _15"> </span>to<span class="_ _21"> </span>some</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">valid<span class="_ _11"> </span>read/write<span class="_ _11"> </span>area<span class="_ _11"> </span>of<span class="_ _16"> </span>virtual<span class="_ _11"> </span>memory<span class="_ _3"></span>,<span class="_ _11"> </span>and<span class="_ _11"> </span>we<span class="_ _16"> </span>overwrite<span class="_"> </span>memory<span class="_ _3"></span>,<span class="_ _16"> </span>usually<span class="_ _11"> </span>with</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">disastrous<span class="_"> </span>and<span class="_"> </span>bafﬂing<span class="_"> </span>consequences<span class="_"> </span>much<span class="_"> </span>later.</div><div class="t m5 x17 h41 y7532 ffe fs29 fc2 sc0 ls0 ws0">9.11.2<span class="_ _48"> </span><span class="fs19">Reading<span class="_"> </span>Uninitialized<span class="_"> </span>Memory</span></div><div class="t m5 x17 h26 y7533 ff7 fs19 fc2 sc0 ls0 ws0">While<span class="_"> </span>bss<span class="_"> </span>memory<span class="_"> </span>locations<span class="_"> </span>(such<span class="_"> </span>as<span class="_"> </span>uninitialized<span class="_"> </span>global<span class="_"> </span>C<span class="_ _11"> </span>variables)<span class="_"> </span>are<span class="_"> </span>always</div><div class="t m5 x17 h26 y7534 ff7 fs19 fc2 sc0 ls0 ws0">initialized<span class="_ _16"> </span>to<span class="_ _14"> </span>zeros<span class="_ _16"> </span>by<span class="_ _14"> </span>the<span class="_ _14"> </span>loader,<span class="_ _16"> </span>this<span class="_ _14"> </span>is<span class="_ _14"> </span>not<span class="_ _16"> </span>true<span class="_ _14"> </span>for<span class="_ _16"> </span>heap<span class="_ _14"> </span>memory<span class="_ _3"></span>.<span class="_ _16"> </span>A<span class="_ _14"> </span>common</div><div class="t m5 x17 h26 y7535 ff7 fs19 fc2 sc0 ls0 ws0">error<span class="_"> </span>is<span class="_"> </span>to<span class="_"> </span>assume<span class="_"> </span>that<span class="_"> </span>heap<span class="_"> </span>memory<span class="_"> </span>is<span class="_"> </span>initialized<span class="_"> </span>to<span class="_"> </span>zero:</div><div class="t m5 x2c h2d y7536 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Retur<span class="ls33">ny=A<span class="_ _41"></span>x*<span class="_ _41"></span>/</span></span></div><div class="t m5 x2c h2e y7537 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x2d h2d y7538 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>*matvec(int<span class="_ _1f"> </span>**A,<span class="_ _1f"> </span>int<span class="_ _e"> </span>*x,<span class="_ _1f"> </span>int<span class="_ _e"> </span>n)</div><div class="t m5 x2c h2d y7539 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y753a ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i,<span class="_ _1f"> </span>j;</span></div><div class="t m5 x2c h2e y753b ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y753c ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x142 h2d y753d ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>*y<span class="_ _1f"> </span>=<span class="_ _1f"> </span>(int<span class="_ _e"> </span>*)Malloc(n<span class="_ _1f"> </span>*<span class="_ _e"> </span>sizeof(int));</div><div class="t m5 x2c h2e y753e ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x2c h2e y753f ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x142 h2d y7540 ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;n<span class="_ _41"></span>;<span class="ls0">i++)</span></div><div class="t m5 x2c h2d y7541 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2 ls33">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>j=0<span class="_ _41"></span>;j&lt;n<span class="_ _41"></span>;<span class="ls0">j++)</span></span></div><div class="t m5 x17 h2d y7542 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _d1"> </span><span class="ffd fs1e fc2">y[i]<span class="_ _1f"> </span>+=<span class="_ _e"> </span>A[i][j]<span class="_ _1f"> </span>*<span class="_ _e"> </span>x[j];</span></div><div class="t m5 x17 h2e y7543 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x142 h2d y7544 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>y;</div><div class="t m5 x17 h2d y7545 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h26 y7546 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_"> </span>this<span class="_ _11"> </span>example<span class="_ _0"></span>,<span class="_"> </span>the<span class="_ _11"> </span>programmer<span class="_ _11"> </span>has<span class="_ _11"> </span>incorrectly<span class="_"> </span>assumed<span class="_ _11"> </span>that<span class="_ _11"> </span>vector<span class="_"> </span><span class="ffd">y<span class="_ _11"> </span></span>has<span class="_ _11"> </span>been</div><div class="t m5 x17 h26 y7547 ff7 fs19 fc2 sc0 ls0 ws0">initialized<span class="_ _14"> </span>to<span class="_ _16"> </span>zero.<span class="_ _16"> </span>A<span class="_ _14"> </span>correct<span class="_ _14"> </span>implementation<span class="_ _14"> </span>would<span class="_ _14"> </span>explicitly<span class="_ _14"> </span>zero<span class="_ _16"> </span><span class="ffd">y[i]<span class="_ _14"> </span></span>or<span class="_ _14"> </span>use</div><div class="t m5 x17 h26 y7548 ffd fs19 fc2 sc0 ls0 ws0">calloc<span class="ff7">.</span></div><div class="t m5 x17 h41 y7549 ffe fs29 fc2 sc0 ls0 ws0">9.11.3<span class="_ _48"> </span><span class="fs19">Allowing<span class="_"> </span>Stack<span class="_"> </span>Buffer<span class="_"> </span>Overﬂows</span></div><div class="t m5 x17 h26 y754a ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _15"> </span>we<span class="_ _21"> </span>saw<span class="_ _21"> </span>in<span class="_ _21"> </span>Section<span class="_ _21"> </span>3.10.3,<span class="_ _f"> </span>a<span class="_ _21"> </span>program<span class="_ _21"> </span>has<span class="_ _21"> </span>a<span class="_ _21"> </span><span class="ffa">buffer<span class="_ _21"> </span>overﬂo<span class="_ _0"></span>w<span class="_ _15"> </span>bug<span class="_ _f"> </span><span class="ff7">if<span class="_ _21"> </span>it<span class="_ _21"> </span>writes</span></span></div><div class="t m5 x17 h26 y754b ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _15"> </span>a<span class="_ _15"> </span>target<span class="_ _21"> </span>buffer<span class="_ _15"> </span>on<span class="_ _21"> </span>the<span class="_ _15"> </span>stack<span class="_ _15"> </span>without<span class="_ _21"> </span>examining<span class="_ _15"> </span>the<span class="_ _21"> </span>size<span class="_ _15"> </span>of<span class="_ _21"> </span>the<span class="_ _15"> </span>input<span class="_ _15"> </span>string.</div><div class="t m5 x17 h26 y754c ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_ _11"> </span>example<span class="_ _0"></span>,<span class="_ _11"> </span>the<span class="_ _16"> </span>following<span class="_ _11"> </span>function<span class="_ _11"> </span>has<span class="_ _11"> </span>a<span class="_ _11"> </span>buffer<span class="_ _16"> </span>overﬂow<span class="_ _11"> </span>bug<span class="_ _11"> </span>because<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffd">gets</span></div><div class="t m5 x17 h26 y754d ff7 fs19 fc2 sc0 ls0 ws0">function<span class="_"> </span>copies<span class="_ _13"> </span>an<span class="_"> </span>arbitrary-length<span class="_ _13"> </span>string<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>buffer.<span class="_ _13"> </span>T<span class="_ _3"></span>o<span class="_ _13"> </span>ﬁx<span class="_"> </span>this<span class="_ _1"></span>,<span class="_"> </span>we<span class="_ _13"> </span>would<span class="_"> </span>need</div><div class="t m5 x17 h26 y754e ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>use<span class="_"> </span>the<span class="_"> </span><span class="ffd">fgets<span class="_ _10"> </span></span>function,<span class="_"> </span>which<span class="_"> </span>limits<span class="_"> </span>the<span class="_"> </span>size<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>input<span class="_"> </span>string.</div><div class="t m5 x2c h2d yc21 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>bufoverflow()</span></div><div class="t m5 x2c h2d y107b ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y13c0 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>buf[64];</span></div><div class="t m5 x2c h2e y587 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y5f68 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x142 h2d y8d6 ffd fs1e fc2 sc0 ls0 ws0">gets(buf);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Here<span class="_ _1f"> </span>is<span class="_ _e"> </span>the<span class="_ _1f"> </span>stack<span class="_ _e"> </span>buffer<span class="_ _1f"> </span>overflow<span class="_ _1f"> </span>bug<span class="_ _e"> </span>*/</div><div class="t m5 x2c h2d y77e ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">return;</span></div><div class="t m5 x2c h2d ye95 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
