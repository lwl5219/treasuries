<div id="pf180" class="pf w2 h11" data-page-no="180"><div class="pc pc180 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg180.png"/><div class="t m5 x107 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Solutions<span class="_ _10"> </span>to<span class="_ _10"> </span>Practice<span class="_ _10"> </span>Problems<span class="_ _1b"> </span><span class="ffe fs1e">383</span></div><div class="t m5 x34 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">E.<span class="_ _25"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>call<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">malloc<span class="_ _13"> </span></span>should<span class="_ _13"> </span>have<span class="_ _13"> </span>had<span class="_ _13"> </span><span class="ffd">strlen(buf)+1<span class="_ _13"> </span></span>as<span class="_ _13"> </span>its<span class="_"> </span>argument,<span class="_ _13"> </span>and<span class="_ _13"> </span>the</div><div class="t m5 x2d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_"> </span>should<span class="_"> </span>also<span class="_"> </span>check<span class="_"> </span>that<span class="_"> </span>the<span class="_"> </span>returned<span class="_"> </span>value<span class="_"> </span>is<span class="_"> </span>not<span class="_"> </span>equal<span class="_"> </span>to<span class="_"> </span><span class="ffd">NULL</span>.</div><div class="t m5 x17 h28 y35be ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>3.47<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>322)</span></div><div class="t m5 x34 h26 y35bf ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>T<span class="_ _1"></span>his<span class="_"> </span>corresponds<span class="_"> </span>to<span class="_"> </span>a<span class="_"> </span>range<span class="_"> </span>of<span class="_"> </span>around<span class="_"> </span>2</div><div class="t m5 x24e h3c y35c0 ff7 fs25 fc1 sc0 ls0 ws0">13</div><div class="t m5 x121 h26 y35bf ff7 fs19 fc1 sc0 ls0 ws0">addresses<span class="_ _1"></span>.</div><div class="t m5 x34 h26 y35c1 ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>A<span class="_ _6"> </span>128-byte<span class="_ _6"> </span>nop<span class="_ _6"> </span>sled<span class="_ _13"> </span>would<span class="_ _a"> </span>cover<span class="_ _6"> </span>2</div><div class="t m5 xbe h3c y35c2 ff7 fs25 fc1 sc0 ls0 ws0">7</div><div class="t m5 x143 h26 y35c3 ff7 fs19 fc1 sc0 ls0 ws0">addresses<span class="_ _6"> </span>with<span class="_ _6"> </span>each<span class="_ _6"> </span>test,<span class="_ _13"> </span>and<span class="_ _a"> </span>so<span class="_ _6"> </span>we<span class="_ _6"> </span>would</div><div class="t m5 x2d h26 y35c4 ff7 fs19 fc1 sc0 ls0 ws0">only<span class="_"> </span>require<span class="_"> </span>around<span class="_"> </span>2</div><div class="t m5 x218 h3c y35c5 ff7 fs25 fc1 sc0 ls0 ws0">6</div><div class="t m5 x15c h46 y35c6 ff12 fs19 fc1 sc0 ls0 ws0">=<span class="_ _13"> </span><span class="ff7">64<span class="_"> </span>attempts<span class="_ _0"></span>.</span></div><div class="t m5 x26 h26 y35c7 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _16"> </span>example<span class="_"> </span>clearly<span class="_ _16"> </span>shows<span class="_ _11"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>degree<span class="_ _16"> </span>of<span class="_ _11"> </span>randomization<span class="_ _11"> </span>in<span class="_ _11"> </span>this<span class="_ _16"> </span>version</div><div class="t m5 x17 h26 y35c8 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span>Linux<span class="_"> </span>would<span class="_"> </span>provide<span class="_"> </span>only<span class="_"> </span>minimal<span class="_"> </span>deterrence<span class="_"> </span>against<span class="_"> </span>an<span class="_"> </span>overﬂow<span class="_"> </span>attack.</div><div class="t m5 x17 h28 y35c9 ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>3.48<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>324)</span></div><div class="t m5 x17 h26 y35ca ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _13"> </span>problem<span class="_ _13"> </span>gives<span class="_ _13"> </span>you<span class="_ _13"> </span>another<span class="_ _6"> </span>chance<span class="_ _13"> </span>to<span class="_ _13"> </span>see<span class="_ _13"> </span>how<span class="_ _13"> </span>x86-64<span class="_ _6"> </span>code<span class="_ _13"> </span>manages<span class="_ _13"> </span>the<span class="_ _13"> </span>stack,</div><div class="t m5 x17 h26 y35cb ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>to<span class="_"> </span>also<span class="_"> </span>better<span class="_"> </span>understand<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>defend<span class="_"> </span>against<span class="_"> </span>buffer<span class="_"> </span>overﬂow<span class="_"> </span>attacks<span class="_ _1"></span>.</div><div class="t m5 x34 h26 y35cc ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>F<span class="_ _1"></span>or<span class="_ _6"> </span>the<span class="_ _13"> </span>unprotected<span class="_ _6"> </span>code,<span class="_ _6"> </span>we<span class="_ _13"> </span>can<span class="_ _6"> </span>see<span class="_ _13"> </span>that<span class="_ _6"> </span>lines<span class="_ _13"> </span>4<span class="_ _6"> </span>and<span class="_ _13"> </span>5<span class="_ _6"> </span>compute<span class="_ _13"> </span>the<span class="_ _6"> </span>positions</div><div class="t m5 x2d h26 y35cd ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _13"> </span><span class="ffd">v<span class="_ _10"> </span></span>and<span class="_ _13"> </span><span class="ffd">buf<span class="_ _10"> </span></span>to<span class="_"> </span>be<span class="_ _13"> </span>at<span class="_ _13"> </span>offsets<span class="_"> </span>24<span class="_ _13"> </span>and<span class="_"> </span>0<span class="_ _13"> </span>relative<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">%rsp</span>.<span class="_"> </span>In<span class="_ _13"> </span>the<span class="_"> </span>protected<span class="_ _13"> </span>code<span class="_ _1"></span>,</div><div class="t m5 x2d h26 y35ce ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>canary<span class="_"> </span>is<span class="_ _13"> </span>stored<span class="_"> </span>at<span class="_"> </span>offset<span class="_"> </span>40<span class="_"> </span>(line<span class="_"> </span>4),<span class="_ _13"> </span>while<span class="_"> </span><span class="ffd">v<span class="_ _10"> </span></span>and<span class="_"> </span><span class="ffd">buf<span class="_ _10"> </span></span>are<span class="_"> </span>at<span class="_"> </span>offsets<span class="_ _13"> </span>8<span class="_"> </span>and</div><div class="t m5 x2d h26 y35cf ff7 fs19 fc1 sc0 ls0 ws0">16<span class="_"> </span>(lines<span class="_"> </span>7<span class="_"> </span>and<span class="_"> </span>8).</div><div class="t m5 x34 h26 y35d0 ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>In<span class="_ _11"> </span>the<span class="_ _11"> </span>protected<span class="_"> </span>code,<span class="_"> </span>local<span class="_"> </span>variable<span class="_ _11"> </span><span class="ffd">v<span class="_ _11"> </span></span>is<span class="_ _11"> </span>positioned<span class="_"> </span>closer<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_"> </span>top<span class="_ _11"> </span>of<span class="_ _11"> </span>the</div><div class="t m5 x2d h26 y35d1 ff7 fs19 fc1 sc0 ls0 ws0">stack<span class="_"> </span>than<span class="_"> </span><span class="ffd">buf</span>,<span class="_"> </span>and<span class="_"> </span>so<span class="_"> </span>an<span class="_"> </span>overrun<span class="_"> </span>of<span class="_"> </span><span class="ffd">buf<span class="_ _10"> </span></span>will<span class="_"> </span>not<span class="_"> </span>corrupt<span class="_"> </span>the<span class="_"> </span>value<span class="_"> </span>of<span class="_"> </span><span class="ffd">v</span>.</div><div class="t m5 x17 h28 y35d2 ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>3.49<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>329)</span></div><div class="t m5 x17 h26 y35d3 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _21"> </span>code<span class="_ _21"> </span>combines<span class="_ _21"> </span>many<span class="_ _21"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span>tricks<span class="_ _21"> </span>we<span class="_ _21"> </span>have<span class="_ _21"> </span>seen<span class="_ _15"> </span>for<span class="_ _21"> </span>performing<span class="_ _21"> </span>bit-level</div><div class="t m5 x17 h26 y35d4 ff7 fs19 fc1 sc0 ls0 ws0">arithmetic.<span class="_"> </span>It<span class="_"> </span>requires<span class="_"> </span>careful<span class="_"> </span>study<span class="_"> </span>to<span class="_"> </span>make<span class="_"> </span>any<span class="_"> </span>sense<span class="_"> </span>of<span class="_"> </span>it.</div><div class="t m5 x34 h46 y35d5 ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>T<span class="_ _1"></span>he<span class="_ _15"> </span><span class="ffd">leaq<span class="_ _14"> </span></span>instruction<span class="_ _15"> </span>of<span class="_ _14"> </span>line<span class="_ _15"> </span>5<span class="_ _14"> </span>computes<span class="_ _15"> </span>the<span class="_ _14"> </span>value<span class="_ _15"> </span>8<span class="ff11">n<span class="_ _10"> </span><span class="ff12">+<span class="_ _13"> </span></span></span>22<span class="_ _2"></span>,<span class="_ _15"> </span>which<span class="_ _14"> </span>is<span class="_ _15"> </span>then</div><div class="t m5 x2d h26 y35d6 ff7 fs19 fc1 sc0 ls0 ws0">rounded<span class="_ _13"> </span>down<span class="_ _13"> </span>to<span class="_"> </span>the<span class="_ _13"> </span>nearest<span class="_ _13"> </span>multiple<span class="_ _13"> </span>of<span class="_ _13"> </span>16<span class="_ _13"> </span>by<span class="_"> </span>the<span class="_ _13"> </span><span class="ffd">andq<span class="_ _13"> </span></span>instruction<span class="_ _13"> </span>of<span class="_ _13"> </span>line<span class="_"> </span>6.</div><div class="t m5 x2d h46 y35d7 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>resulting<span class="_ _13"> </span>value<span class="_"> </span>will<span class="_ _13"> </span>be<span class="_ _13"> </span>8<span class="ff11">n<span class="_ _10"> </span><span class="ff12">+<span class="_ _13"></span></span></span>8<span class="_ _13"> </span>when<span class="_"> </span><span class="ff11">n<span class="_ _13"> </span></span>is<span class="_"> </span>odd<span class="_ _13"> </span>and<span class="_"> </span>8<span class="_ _0"></span><span class="ff11">n<span class="_ _13"> </span><span class="ff12">+<span class="_ _10"> </span><span class="ff7">16<span class="_ _13"> </span>when<span class="_"> </span></span></span>n<span class="_ _13"> </span><span class="ff7">is<span class="_ _13"> </span>even,</span></span></div><div class="t m5 x2d h26 y35d8 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>this<span class="_"> </span>value<span class="_"> </span>is<span class="_"> </span>subtracted<span class="_"> </span>from<span class="_"> </span><span class="ff11">s</span></div><div class="t m5 x1e6 h3c y35d9 ff7 fs25 fc1 sc0 ls0 ws0">1</div><div class="t m5 x241 h26 y35da ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>give<span class="_"> </span><span class="ff11">s</span></div><div class="t m5 x130 h3c y35d9 ff7 fs25 fc1 sc0 ls0 ws0">2</div><div class="t m5 x179 h26 y35da ff7 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 x34 h26 y35db ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>The<span class="_"> </span>three<span class="_ _11"> </span>instructions<span class="_ _16"> </span>in<span class="_"> </span>this<span class="_ _16"> </span>sequence<span class="_ _11"> </span>round<span class="_ _11"> </span><span class="ff11">s</span></div><div class="t m5 x114 h3c y35dc ff7 fs25 fc1 sc0 ls0 ws0">2</div><div class="t m5 xa1 h26 y35dd ff7 fs19 fc1 sc0 ls0 ws0">up<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>nearest<span class="_"> </span>multiple</div><div class="t m5 x2d h26 y35de ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span>8.<span class="_ _11"> </span>T<span class="_ _1"></span>hey<span class="_ _11"> </span>make<span class="_"> </span>use<span class="_ _11"> </span>of<span class="_"> </span>the<span class="_ _11"> </span>combination<span class="_"> </span>of<span class="_ _11"> </span>biasing<span class="_"> </span>and<span class="_ _11"> </span>shifting<span class="_"> </span>that<span class="_ _11"> </span>we<span class="_"> </span>saw</div><div class="t m5 x2d h26 y35df ff7 fs19 fc1 sc0 ls0 ws0">for<span class="_"> </span>dividing<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>power<span class="_"> </span>of<span class="_"> </span>2<span class="_"> </span>in<span class="_"> </span>Section<span class="_"> </span>2.3.7.</div><div class="t m5 x34 h26 y35e0 ff7 fs19 fc1 sc0 ls0 ws0">C.<span class="_ _25"> </span>T<span class="_ _1"></span>hese<span class="_ _16"> </span>two<span class="_ _16"> </span>examples<span class="_ _11"> </span>can<span class="_ _16"> </span>be<span class="_ _16"> </span>seen<span class="_ _16"> </span>as<span class="_ _11"> </span>the<span class="_ _16"> </span>cases<span class="_ _16"> </span>that<span class="_ _16"> </span>minimize<span class="_ _11"> </span>and<span class="_ _16"> </span>maximize</div><div class="t m5 x2d h26 y35e1 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>values<span class="_"> </span>of<span class="_"> </span><span class="ff11">e</span></div><div class="t m5 x207 h3c y35e2 ff7 fs25 fc1 sc0 ls0 ws0">1</div><div class="t m5 x10d h26 y35e3 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span><span class="ff11">e</span></div><div class="t m5 x59 h3c y35e2 ff7 fs25 fc1 sc0 ls0 ws0">2</div><div class="t m5 x25 h26 y35e3 ff7 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 x2d h55 y35e4 ff11 fs21 fc2 sc0 ls186 ws0">ns</div><div class="t m5 x5c h33 y35e5 ff7 fs20 fc2 sc0 ls0 ws0">1</div><div class="t m5 x10d h55 y35e4 ff11 fs21 fc2 sc0 ls0 ws0">s</div><div class="t m5 x4b h33 y35e5 ff7 fs20 fc2 sc0 ls0 ws0">2</div><div class="t m5 x8f h55 y35e4 ff11 fs21 fc2 sc0 ls1a7 ws0">pe</div><div class="t m5 x1ed h33 y35e5 ff7 fs20 fc2 sc0 ls0 ws0">1</div><div class="t m5 x200 h55 y35e4 ff11 fs21 fc2 sc0 ls0 ws0">e</div><div class="t m5 xd3 h33 y35e5 ff7 fs20 fc2 sc0 ls0 ws0">2</div><div class="t m5 x2d h31 y35e6 ff7 fs21 fc2 sc0 ls0 ws0">5<span class="_ _26"> </span>2,065<span class="_ _26"> </span>2,017<span class="_ _26"> </span>2,024<span class="_ _74"> </span>1<span class="_ _7b"> </span>7</div><div class="t m5 x2d h31 y35e7 ff7 fs21 fc2 sc0 ls0 ws0">6<span class="_ _26"> </span>2,064<span class="_ _26"> </span>2,000<span class="_ _26"> </span>2,000<span class="_ _f1"> </span>16<span class="_ _7b"> </span>0</div><div class="t m5 x34 h26 y35e8 ff7 fs19 fc2 sc0 ls0 ws0">D<span class="_ _3"></span>.<span class="_ _23"> </span>W<span class="_ _1"></span>e<span class="_ _13"> </span>can<span class="_ _13"> </span>see<span class="_ _13"> </span>that<span class="_ _13"> </span><span class="ff11">s</span></div><div class="t m5 x4b h3c y35e9 ff7 fs25 fc2 sc0 ls0 ws0">2</div><div class="t m5 x33 h26 y35ea ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _13"> </span>computed<span class="_ _13"> </span>in<span class="_ _13"> </span>a<span class="_ _13"> </span>way<span class="_ _13"> </span>that<span class="_ _13"> </span>preserves<span class="_ _13"> </span>whatever<span class="_ _13"> </span>offset<span class="_ _13"> </span><span class="ff11">s</span></div><div class="t m5 x111 h3c y35eb ff7 fs25 fc2 sc0 ls0 ws0">1</div><div class="t m5 x11d h26 y35ea ff7 fs19 fc2 sc0 ls0 ws0">has</div><div class="t m5 x2d h26 y35ec ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_"> </span>the<span class="_ _11"> </span>nearest<span class="_ _11"> </span>multiple<span class="_ _11"> </span>of<span class="_ _11"> </span>16.<span class="_ _11"> </span>W<span class="_ _1"></span>e<span class="_ _11"> </span>can<span class="_ _11"> </span>also<span class="_"> </span>see<span class="_ _11"> </span>that<span class="_ _16"> </span><span class="ff11">p<span class="_ _11"> </span></span>will<span class="_ _11"> </span>be<span class="_ _11"> </span>aligned<span class="_ _11"> </span>on<span class="_ _11"> </span>a</div><div class="t m5 x2d h26 y35ed ff7 fs19 fc2 sc0 ls0 ws0">multiple<span class="_"> </span>of<span class="_"> </span>8,<span class="_"> </span>as<span class="_"> </span>is<span class="_"> </span>recommended<span class="_"> </span>for<span class="_"> </span>an<span class="_"> </span>array<span class="_"> </span>of<span class="_"> </span>8-byte<span class="_"> </span>elements<span class="_ _1"></span>.</div><div class="t m5 x17 h28 y1d3d ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>3.50<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>336)</span></div><div class="t m5 x17 h26 yc2 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>exercise<span class="_"> </span>requires<span class="_"> </span>that<span class="_"> </span>you<span class="_"> </span>step<span class="_"> </span>through<span class="_"> </span>the<span class="_"> </span>code<span class="_ _1"></span>,<span class="_"> </span>paying<span class="_"> </span>careful<span class="_"> </span>attention<span class="_"> </span>to</div><div class="t m5 x17 h26 y35ee ff7 fs19 fc1 sc0 ls0 ws0">which<span class="_ _13"> </span>conversion<span class="_ _13"> </span>and<span class="_ _6"> </span>data<span class="_ _13"> </span>movement<span class="_ _13"> </span>instructions<span class="_ _13"> </span>are<span class="_ _13"> </span>used.<span class="_ _6"> </span>W<span class="_ _1"></span>e<span class="_ _13"> </span>can<span class="_ _13"> </span>see<span class="_ _6"> </span>the<span class="_ _13"> </span>values</div><div class="t m5 x17 h26 y35ef ff7 fs19 fc1 sc0 ls0 ws0">being<span class="_"> </span>retrieved<span class="_"> </span>and<span class="_"> </span>converted<span class="_"> </span>as<span class="_"> </span>follows:</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
