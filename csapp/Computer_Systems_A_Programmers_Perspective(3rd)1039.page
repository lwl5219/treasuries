<div id="pf40f" class="pf w2 h11" data-page-no="40f"><div class="pc pc40f w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg40f.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1038<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x28 h2a y257 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Origin<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>names<span class="_ _16"> </span><span class="ff11">P<span class="_ _f"> </span></span>and<span class="_ _11"> </span><span class="ff11">V</span></span></div><div class="t m5 x28 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">Edsger<span class="_"> </span>Dijkstra<span class="_"> </span>(1930–2002)<span class="_"> </span>was<span class="_"> </span>originally<span class="_ _13"> </span>from<span class="_"> </span>the<span class="_"> </span>Netherlands<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>names<span class="_"> </span><span class="ff11">P<span class="_ _15"> </span></span>and<span class="_"> </span><span class="ff11">V<span class="_ _21"> </span></span>come<span class="_"> </span>from<span class="_"> </span>the</div><div class="t m5 x28 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">Dutch<span class="_"> </span>words<span class="_"> </span><span class="ffa">proberen<span class="_"> </span></span>(to<span class="_"> </span>test)<span class="_"> </span>and<span class="_"> </span><span class="ffa">verhogen<span class="_"> </span></span>(to<span class="_"> </span>increment).</div><div class="t m5 x29 h26 y81f0 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>test<span class="_ _14"> </span>and<span class="_ _16"> </span>decrement<span class="_ _14"> </span>operations<span class="_ _14"> </span>in<span class="_ _16"> </span><span class="ff11">P<span class="_ _1f"> </span></span>occur<span class="_ _16"> </span>indivisibly<span class="_ _3"></span>,<span class="_ _14"> </span>in<span class="_ _14"> </span>the<span class="_ _16"> </span>sense<span class="_ _14"> </span>that</div><div class="t m5 x1d h26 y81f1 ff7 fs19 fc2 sc0 ls0 ws0">once<span class="_ _16"> </span>the<span class="_ _14"> </span>semaphore<span class="_ _16"> </span><span class="ff11">s<span class="_ _21"> </span></span>becomes<span class="_ _16"> </span>nonzero<span class="_ _0"></span>,<span class="_ _14"> </span>the<span class="_ _16"> </span>decrement<span class="_ _14"> </span>of<span class="_ _16"> </span><span class="ff11">s<span class="_ _21"> </span></span>occurs<span class="_ _16"> </span>without<span class="_ _14"> </span>in-</div><div class="t m5 x1d h26 y81f2 ff7 fs19 fc2 sc0 ls0 ws0">terruption.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_ _11"> </span>increment<span class="_ _11"> </span>operation<span class="_ _16"> </span>in<span class="_"> </span><span class="ff11">V<span class="_ _e"> </span></span>also<span class="_ _11"> </span>occurs<span class="_ _16"> </span>indivisibly<span class="_ _7"></span>,<span class="_ _16"> </span>in<span class="_ _11"> </span>that<span class="_ _11"> </span>it<span class="_ _16"> </span>loads<span class="_ _3"></span>,</div><div class="t m5 x1d h26 y81f3 ff7 fs19 fc2 sc0 ls0 ws0">increments<span class="_ _1"></span>,<span class="_"> </span>and<span class="_ _11"> </span>stores<span class="_ _11"> </span>the<span class="_ _11"> </span>semaphore<span class="_"> </span>without<span class="_ _11"> </span>interruption.<span class="_ _11"> </span>Notice<span class="_"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>deﬁ-</div><div class="t m5 x1d h26 y81f4 ff7 fs19 fc2 sc0 ls0 ws0">nition<span class="_"> </span>of<span class="_ _11"> </span><span class="ff11">V<span class="_ _f"> </span></span>does<span class="_ _11"> </span><span class="ffa">not<span class="_ _16"> </span></span>deﬁne<span class="_"> </span>the<span class="_ _11"> </span>order<span class="_"> </span>in<span class="_ _11"> </span>which<span class="_"> </span>waiting<span class="_ _11"> </span>threads<span class="_"> </span>are<span class="_ _11"> </span>restarted.<span class="_"> </span>T<span class="_ _0"></span>he</div><div class="t m5 x1d h26 y81f5 ff7 fs19 fc2 sc0 ls0 ws0">only<span class="_ _13"> </span>requirement<span class="_ _6"> </span>is<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ff11">V<span class="_"> </span></span>must<span class="_ _13"> </span>restart<span class="_ _13"> </span>exactly<span class="_ _13"> </span>one<span class="_ _6"> </span>waiting<span class="_ _13"> </span>thread.<span class="_ _13"> </span><span class="ffa">Thus<span class="_ _1"></span>,<span class="_ _13"> </span>when</span></div><div class="t m5 x1d h30 y81f6 ffa fs19 fc2 sc0 ls0 ws0">several<span class="_ _16"> </span>threads<span class="_ _16"> </span>are<span class="_ _11"> </span>waiting<span class="_ _16"> </span>at<span class="_ _16"> </span>a<span class="_ _16"> </span>semaphore,<span class="_ _11"> </span>you<span class="_ _16"> </span>cannot<span class="_ _16"> </span>predict<span class="_ _16"> </span>which<span class="_ _16"> </span>one<span class="_ _11"> </span>will<span class="_ _16"> </span>be</div><div class="t m5 x1d h30 y81f7 ffa fs19 fc2 sc0 ls0 ws0">restarted<span class="_"> </span>as<span class="_"> </span>a<span class="_"> </span>result<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span><span class="ff11">V<span class="_ _13"> </span></span>.</div><div class="t m5 x29 h26 y81f8 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>deﬁnitions<span class="_ _11"> </span>of<span class="_"> </span><span class="ff11">P<span class="_ _f"> </span></span>and<span class="_ _11"> </span><span class="ff11">V<span class="_ _f"> </span></span>ensure<span class="_ _11"> </span>that<span class="_ _11"> </span>a<span class="_"> </span>running<span class="_ _11"> </span>program<span class="_ _11"> </span>can<span class="_"> </span>never<span class="_ _11"> </span>enter<span class="_"> </span>a</div><div class="t m5 x1d h26 y81f9 ff7 fs19 fc2 sc0 ls0 ws0">state<span class="_"> </span>where<span class="_"> </span>a<span class="_ _11"> </span>properly<span class="_"> </span>initialized<span class="_"> </span>semaphore<span class="_ _11"> </span>has<span class="_"> </span>a<span class="_"> </span>negative<span class="_ _11"> </span>value<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _1"></span>his<span class="_ _11"> </span>property<span class="_ _3"></span>,</div><div class="t m5 x1d h26 y81fa ff7 fs19 fc2 sc0 ls0 ws0">known<span class="_ _16"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffa">semaphore<span class="_ _16"> </span>invariant<span class="_ _5"></span></span>,<span class="_ _14"> </span>provides<span class="_ _16"> </span>a<span class="_ _16"> </span>powerful<span class="_ _16"> </span>tool<span class="_ _16"> </span>for<span class="_ _14"> </span>controlling<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y81fb ff7 fs19 fc2 sc0 ls0 ws0">trajectories<span class="_"> </span>of<span class="_"> </span>concurrent<span class="_"> </span>programs<span class="_ _1"></span>,<span class="_"> </span>as<span class="_"> </span>we<span class="_"> </span>shall<span class="_"> </span>see<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>next<span class="_"> </span>section.</div><div class="t m5 x29 h26 y81fc ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _f"> </span>P<span class="_ _0"></span>osix<span class="_ _f"> </span>standard<span class="_ _f"> </span>deﬁnes<span class="_ _f"> </span>a<span class="_ _f"> </span>variety<span class="_ _f"> </span>of<span class="_ _f"> </span>functions<span class="_ _f"> </span>for<span class="_ _f"> </span>manipulating<span class="_ _f"> </span>sema-</div><div class="t m5 x1d h26 y81fd ff7 fs19 fc2 sc0 ls0 ws0">phores<span class="_ _1"></span>.</div><div class="t m5 x126 h2d y81fe ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;semaphore.h&gt;</div><div class="t m5 x126 h2d y81ff ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>sem_init(sem_t<span class="_ _1f"> </span>*sem,<span class="_ _1f"> </span>0,<span class="_ _e"> </span>unsigned<span class="_ _1f"> </span>int<span class="_ _e"> </span>value);</div><div class="t m5 x126 h2d y8200 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>sem_wait(sem_t<span class="_ _1f"> </span>*s);<span class="_ _3f"> </span>/*<span class="_ _1f"> </span>P(s)<span class="_ _e"> </span>*/</div><div class="t m5 x126 h2d y8201 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>sem_post(sem_t<span class="_ _1f"> </span>*s);<span class="_ _3f"> </span>/*<span class="_ _1f"> </span>V(s)<span class="_ _e"> </span>*/</div><div class="t m5 x107 hf2 y8202 ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>0<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span><span class="ff12">−</span>1<span class="_ _13"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y8203 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _10"> </span><span class="ffd ls0">sem_init<span class="_ _13"> </span><span class="ff7">function<span class="_ _13"> </span>initializes<span class="_ _13"> </span>semaphore<span class="_ _13"> </span></span>sem<span class="_ _6"> </span><span class="ff7">to<span class="_ _13"> </span></span>value<span class="ff7">.<span class="_ _13"> </span>Each<span class="_ _13"> </span>semaphore<span class="_ _13"> </span>must</span></span></div><div class="t m5 x1d h26 y8204 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_ _15"> </span>initialized<span class="_ _15"> </span>before<span class="_ _15"> </span>it<span class="_ _15"> </span>can<span class="_ _15"> </span>be<span class="_ _15"> </span>used.<span class="_ _15"> </span>F<span class="_ _1"></span>or<span class="_ _15"> </span>our<span class="_ _15"> </span>purposes<span class="_ _1"></span>,<span class="_ _21"> </span>the<span class="_ _15"> </span>middle<span class="_ _15"> </span>argument<span class="_ _15"> </span>is</div><div class="t m5 x1d h26 y8205 ff7 fs19 fc2 sc0 ls0 ws0">always<span class="_ _15"> </span>0.<span class="_ _15"> </span>Programs<span class="_ _15"> </span>perform<span class="_ _15"> </span><span class="ff11">P<span class="_ _22"> </span></span>and<span class="_ _15"> </span><span class="ff11">V<span class="_ _22"> </span></span>operations<span class="_ _15"> </span>by<span class="_ _15"> </span>calling<span class="_ _15"> </span>the<span class="_ _21"> </span><span class="ffd">sem_wait<span class="_ _15"> </span></span>and</div><div class="t m5 x1d h26 y8206 ffd fs19 fc2 sc0 ls0 ws0">sem_post<span class="_ _10"> </span><span class="ff7">functions<span class="_ _0"></span>,<span class="_"> </span>respectively<span class="_ _3"></span>.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>conciseness<span class="_ _1"></span>,<span class="_ _11"> </span>we<span class="_ _11"> </span>prefer<span class="_"> </span>to<span class="_ _11"> </span>use<span class="_ _11"> </span>the<span class="_ _11"> </span>following</span></div><div class="t m5 x1d h26 y8207 ff7 fs19 fc2 sc0 ls0 ws0">equivalent<span class="_"> </span><span class="ff11">P<span class="_ _21"> </span></span>and<span class="_"> </span><span class="ff11">V<span class="_ _f"> </span></span>wrapper<span class="_"> </span>functions<span class="_"> </span>instead:</div><div class="t m5 x126 h2d y8208 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</div><div class="t m5 x126 h2d y8209 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>P(sem_t<span class="_ _1f"> </span>*s);<span class="_ _3f"> </span>/*<span class="_ _1f"> </span>Wrapper<span class="_ _e"> </span>function<span class="_ _1f"> </span>for<span class="_ _e"> </span>sem_wait<span class="_ _1f"> </span>*/</div><div class="t m5 x126 h2d y820a ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>V(sem_t<span class="_ _1f"> </span>*s);<span class="_ _3f"> </span>/*<span class="_ _1f"> </span>Wrapper<span class="_ _e"> </span>function<span class="_ _1f"> </span>for<span class="_ _e"> </span>sem_post<span class="_ _1f"> </span>*/</div><div class="t m5 x46 hf1 y820b ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>nothing</div><div class="t m5 x1d h41 y1672 ffe fs29 fc2 sc0 ls0 ws0">12.5.3<span class="_ _48"> </span><span class="fs19">Using<span class="_"> </span>Semaphores<span class="_"> </span>for<span class="_"> </span>Mutual<span class="_"> </span>Exclusion</span></div><div class="t m5 x1d h26 y6e1 ff7 fs19 fc2 sc0 ls0 ws0">Semaphores<span class="_ _21"> </span>provide<span class="_ _21"> </span>a<span class="_ _21"> </span>convenient<span class="_ _21"> </span>way<span class="_ _21"> </span>to<span class="_ _21"> </span>ensure<span class="_ _21"> </span>mutually<span class="_ _21"> </span>exclusive<span class="_ _21"> </span>access<span class="_ _21"> </span>to</div><div class="t m5 x1d h26 y6e2 ff7 fs19 fc2 sc0 ls0 ws0">shared<span class="_ _14"> </span>variables<span class="_ _1"></span>.<span class="_ _15"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>basic<span class="_ _15"> </span>idea<span class="_ _15"> </span>is<span class="_ _14"> </span>to<span class="_ _15"> </span>associate<span class="_ _15"> </span>a<span class="_ _14"> </span>semaphore<span class="_ _15"> </span><span class="ff11">s<span class="_ _5"></span></span>,<span class="_ _21"> </span>initially<span class="_ _14"> </span>1,<span class="_ _21"> </span>with</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
