<div id="pf3fa" class="pf w2 h11" data-page-no="3fa"><div class="pc pc3fa w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3fa.png"/><div class="t m5 x125 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.2<span class="_ _60"> </span>Concurrent<span class="_ _10"> </span>Programming<span class="_ _10"> </span>with<span class="_ _10"> </span>I/O<span class="_ _10"> </span>Multiplexing<span class="_ _3e"> </span><span class="ffe fs1e">1017</span></div><div class="t m5 x17 h2f y9c ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.7</div><div class="t m5 x17 h2f y676 ffe fs16 fc1 sc0 ls0 ws0">State<span class="_ _15"> </span>machine<span class="_ _21"> </span>for</div><div class="t m5 x17 h2f y7cb ffe fs16 fc1 sc0 ls0 ws0">a<span class="_ _15"> </span>logical<span class="_ _21"> </span>ﬂow<span class="_ _21"> </span>in<span class="_ _15"> </span>a</div><div class="t m5 x17 h2f yd19 ffe fs16 fc1 sc0 ls0 ws0">concurrent<span class="_ _11"> </span>event-driven</div><div class="t m5 x17 h2f yd1a ffe fs16 fc1 sc0 ls0 ws0">echo<span class="_"> </span>server<span class="_ _1"></span>.</div><div class="t m5 xab h3f y7f9a ffea fs27 fc1 sc0 ls0 ws0">Input event:</div><div class="t m5 x5d h3f y7f9b ffea fs27 fc1 sc0 ls0 ws0">“descriptor <span class="ffde">d</span></div><div class="t m5 x18 h65 y7f9c ffde fs38 fc1 sc0 ls0 ws0">k</div><div class="t m5 xb3 h3f y7f9d ffea fs27 fc1 sc0 ls0 ws0">is ready for reading”</div><div class="t m5 xdf h3f y7f9e ffea fs27 fc1 sc0 ls0 ws0">T<span class="_ _0"></span>ransition:</div><div class="t m5 x170 h3f y7f9f ffea fs27 fc1 sc0 ls0 ws0">“read a text line from</div><div class="t m5 x93 h3f y7fa0 ffea fs27 fc1 sc0 ls0 ws0">descriptor <span class="ffde">d</span></div><div class="t m5 x169 h65 y7fa1 ffde fs38 fc1 sc0 ls0 ws0">k</div><div class="t m5 x8b h3f y7fa2 ffea fs27 fc1 sc0 ls0 ws0">”</div><div class="t m5 x39 h3f y7fa3 ffea fs27 fc1 sc0 ls0 ws0">State:</div><div class="t m5 x176 h3f y7fa4 ffea fs27 fc1 sc0 ls0 ws0">“waiting for descriptor <span class="ffde">d</span></div><div class="t m5 x93 h65 y7fa5 ffde fs38 fc1 sc0 ls0 ws0">k </div><div class="t m5 x1f8 h3f y7fa6 ffea fs27 fc1 sc0 ls0 ws0">to</div><div class="t m5 xa7 h3f y7fa7 ffea fs27 fc1 sc0 ls0 ws0">be ready for reading”</div><div class="t m5 x26 h26 y1ab0 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _21"> </span>server<span class="_ _21"> </span>uses<span class="_ _21"> </span>the<span class="_ _15"> </span>I/O<span class="_ _21"> </span>multiplexing,<span class="_ _f"> </span>courtesy<span class="_ _15"> </span>of<span class="_ _21"> </span>the<span class="_ _21"> </span><span class="ffd">select<span class="_ _21"> </span></span>function,<span class="_ _f"> </span>to</div><div class="t m5 x17 h26 y1ab1 ff7 fs19 fc1 sc0 ls0 ws0">detect<span class="_ _15"> </span>the<span class="_ _21"> </span>occurrence<span class="_ _21"> </span>of<span class="_ _21"> </span>input<span class="_ _21"> </span>events<span class="_ _1"></span>.<span class="_ _21"> </span>As<span class="_ _21"> </span>each<span class="_ _21"> </span>connected<span class="_ _21"> </span>descriptor<span class="_ _21"> </span>becomes</div><div class="t m5 x17 h26 y7fa8 ff7 fs19 fc1 sc0 ls0 ws0">ready<span class="_ _11"> </span>for<span class="_ _16"> </span>reading,<span class="_ _11"> </span>the<span class="_ _16"> </span>server<span class="_ _11"> </span>executes<span class="_ _16"> </span>the<span class="_ _11"> </span>transition<span class="_ _16"> </span>for<span class="_ _16"> </span>the<span class="_ _11"> </span>corresponding<span class="_ _16"> </span>state</div><div class="t m5 x17 h26 y7fa9 ff7 fs19 fc1 sc0 ls0 ws0">machine—in<span class="_"> </span>this<span class="_"> </span>case<span class="_ _1"></span>,<span class="_"> </span>reading<span class="_"> </span>and<span class="_"> </span>echoing<span class="_"> </span>a<span class="_"> </span>text<span class="_"> </span>line<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>descriptor.</div><div class="t m5 x26 h26 y7faa ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _11"> </span>12.8<span class="_ _11"> </span>shows<span class="_ _11"> </span>the<span class="_ _11"> </span>complete<span class="_ _11"> </span>example<span class="_ _11"> </span>code<span class="_"> </span>for<span class="_ _11"> </span>a<span class="_ _11"> </span>concurrent<span class="_ _11"> </span>event-driven</div><div class="t m5 x17 h26 y7fab ff7 fs19 fc1 sc0 ls0 ws0">server<span class="_"> </span>based<span class="_ _13"> </span>on<span class="_"> </span>I/O<span class="_ _13"> </span>multiplexing.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>set<span class="_ _13"> </span>of<span class="_"> </span>active<span class="_ _13"> </span>clients<span class="_"> </span>is<span class="_"> </span>maintained<span class="_ _13"> </span>in<span class="_"> </span>a<span class="_ _13"> </span><span class="ffd">pool</span></div><div class="t m5 x17 h26 y7fac ff7 fs19 fc1 sc0 ls0 ws0">structure<span class="_ _16"> </span>(lines<span class="_ _11"> </span>3–11).<span class="_ _16"> </span>After<span class="_ _16"> </span>initializing<span class="_ _11"> </span>the<span class="_ _16"> </span>pool<span class="_ _16"> </span>by<span class="_ _16"> </span>calling<span class="_ _11"> </span><span class="ffd">init_pool<span class="_ _16"> </span></span>(line<span class="_ _16"> </span>27),</div><div class="t m5 x17 h26 y7fad ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _6"> </span>server<span class="_ _13"> </span>enters<span class="_ _6"> </span>an<span class="_ _13"> </span>inﬁnite<span class="_ _6"> </span>loop<span class="_ _0"></span>.<span class="_ _6"> </span>During<span class="_ _13"> </span>each<span class="_ _6"> </span>iteration<span class="_ _13"> </span>of<span class="_ _6"> </span>this<span class="_ _13"> </span>loop<span class="_ _3"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>server<span class="_ _6"> </span>calls</div><div class="t m5 x17 h26 y7fae ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span><span class="ffd">select<span class="_ _13"> </span></span>function<span class="_ _13"> </span>to<span class="_ _13"> </span>detect<span class="_ _13"> </span>two<span class="_ _13"> </span>different<span class="_ _13"> </span>kinds<span class="_ _13"> </span>of<span class="_ _13"> </span>input<span class="_ _13"> </span>events:<span class="_ _13"> </span>(1)<span class="_ _13"> </span>a<span class="_ _13"> </span>connection</div><div class="t m5 x17 h26 y7faf ff7 fs19 fc1 sc0 ls0 ws0">request<span class="_"> </span>arriving<span class="_"> </span>from<span class="_"> </span>a<span class="_"> </span>new<span class="_"> </span>client,<span class="_"> </span>and<span class="_"> </span>(2)<span class="_"> </span>a<span class="_"> </span>connected<span class="_"> </span>descriptor<span class="_"> </span>for<span class="_"> </span>an<span class="_"> </span>existing</div><div class="t m5 x17 h26 y7fb0 ff7 fs19 fc1 sc0 ls0 ws0">client<span class="_ _16"> </span>being<span class="_ _11"> </span>ready<span class="_ _16"> </span>for<span class="_ _16"> </span>reading.<span class="_ _11"> </span>When<span class="_ _16"> </span>a<span class="_ _16"> </span>connection<span class="_ _11"> </span>request<span class="_ _16"> </span>arrives<span class="_ _16"> </span>(line<span class="_ _16"> </span>35),<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y7fb1 ff7 fs19 fc1 sc0 ls0 ws0">server<span class="_ _13"> </span>opens<span class="_ _6"> </span>the<span class="_ _13"> </span>connection<span class="_ _13"> </span>(line<span class="_ _6"> </span>37)<span class="_ _13"> </span>and<span class="_ _13"> </span>calls<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">add_client<span class="_ _6"> </span></span>function<span class="_ _13"> </span>to<span class="_ _13"> </span>add<span class="_ _6"> </span>the</div><div class="t m5 x17 h26 y7fb2 ff7 fs19 fc1 sc0 ls0 ws0">client<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>pool<span class="_ _13"> </span>(line<span class="_ _13"> </span>38).<span class="_ _13"> </span>Finally<span class="_ _7"></span>,<span class="_"> </span>the<span class="_ _13"> </span>server<span class="_ _13"> </span>calls<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">check_clients<span class="_ _13"> </span></span>function<span class="_ _13"> </span>to</div><div class="t m5 x17 h26 y7fb3 ff7 fs19 fc1 sc0 ls0 ws0">echo<span class="_"> </span>a<span class="_"> </span>single<span class="_"> </span>text<span class="_"> </span>line<span class="_"> </span>from<span class="_"> </span>each<span class="_"> </span>ready<span class="_"> </span>connected<span class="_"> </span>descriptor<span class="_"> </span>(line<span class="_"> </span>42).</div><div class="t m5 x26 h26 y7fb4 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_"> </span><span class="ffd ls0">init_pool<span class="_ _6"> </span><span class="ff7">function<span class="_ _13"> </span>(F<span class="_ _1"></span>igure<span class="_ _13"> </span>12.9)<span class="_ _a"> </span>initializes<span class="_ _13"> </span>the<span class="_ _6"> </span>client<span class="_ _13"> </span>pool.<span class="_ _6"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span><span class="ffd">clientfd</span></span></span></div><div class="t m5 x17 h46 y7fb5 ff7 fs19 fc1 sc0 ls0 ws0">array<span class="_ _11"> </span>represents<span class="_ _16"> </span>a<span class="_ _11"> </span>set<span class="_ _16"> </span>of<span class="_ _11"> </span>connected<span class="_ _16"> </span>descriptors<span class="_ _3"></span>,<span class="_ _16"> </span>with<span class="_ _16"> </span>the<span class="_ _11"> </span>integer<span class="_ _11"> </span><span class="ff12">−</span>1<span class="_"> </span>denoting<span class="_ _16"> </span>an</div><div class="t m5 x17 h26 y7fb6 ff7 fs19 fc1 sc0 ls0 ws0">available<span class="_"> </span>slot.<span class="_ _11"> </span>Initially<span class="_ _3"></span>,<span class="_ _11"> </span>the<span class="_ _11"> </span>set<span class="_ _11"> </span>of<span class="_ _11"> </span>connected<span class="_ _11"> </span>descriptors<span class="_ _11"> </span>is<span class="_ _11"> </span>empty<span class="_ _11"> </span>(lines<span class="_ _11"> </span>5–7),<span class="_ _11"> </span>and</div><div class="t m5 x17 h26 y7fb7 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>listening<span class="_ _13"> </span>descriptor<span class="_"> </span>is<span class="_ _13"> </span>the<span class="_"> </span>only<span class="_ _13"> </span>descriptor<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">select<span class="_ _13"> </span></span>read<span class="_"> </span>set<span class="_ _13"> </span>(lines<span class="_"> </span>10–12).</div><div class="t m5 x26 h26 y7fb8 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_"> </span><span class="ffd ls0">add_client<span class="_ _13"> </span><span class="ff7">function<span class="_ _6"> </span>(F<span class="_ _0"></span>igure<span class="_ _13"> </span>12.10)<span class="_ _6"> </span>adds<span class="_ _13"> </span>a<span class="_ _6"> </span>new<span class="_ _13"> </span>client<span class="_ _6"> </span>to<span class="_ _13"> </span>the<span class="_ _6"> </span>pool<span class="_ _13"> </span>of<span class="_ _6"> </span>active</span></span></div><div class="t m5 x17 h26 y7fb9 ff7 fs19 fc1 sc0 ls0 ws0">clients<span class="_ _1"></span>.<span class="_ _14"> </span>After<span class="_ _15"> </span>ﬁnding<span class="_ _15"> </span>an<span class="_ _15"> </span>empty<span class="_ _14"> </span>slot<span class="_ _15"> </span>in<span class="_ _15"> </span>the<span class="_ _15"> </span><span class="ffd">clientfd<span class="_ _14"> </span></span>array<span class="_ _3"></span>,<span class="_ _21"> </span>the<span class="_ _15"> </span>server<span class="_ _14"> </span>adds<span class="_ _15"> </span>the</div><div class="t m5 x17 h26 y6916 ff7 fs19 fc1 sc0 ls0 ws0">connected<span class="_"> </span>descriptor<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>array<span class="_"> </span>and<span class="_"> </span>initializes<span class="_"> </span>a<span class="_"> </span>corresponding<span class="_"> </span><span class="ff9">Rio<span class="_ _10"> </span></span>read<span class="_"> </span>buffer</div><div class="t m5 x17 h26 y6917 ff7 fs19 fc1 sc0 ls0 ws0">so<span class="_ _14"> </span>that<span class="_ _15"> </span>we<span class="_ _14"> </span>can<span class="_ _15"> </span>call<span class="_ _14"> </span><span class="ffd">rio_readlineb<span class="_ _15"> </span></span>on<span class="_ _14"> </span>the<span class="_ _15"> </span>descriptor<span class="_ _14"> </span>(lines<span class="_ _15"> </span>8–9).<span class="_ _14"> </span>W<span class="_ _1"></span>e<span class="_ _14"> </span>then<span class="_ _15"> </span>add</div><div class="t m5 x17 h26 y6918 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span>connected<span class="_ _16"> </span>descriptor<span class="_ _14"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">select<span class="_ _16"> </span></span>read<span class="_ _14"> </span>set<span class="_ _16"> </span>(line<span class="_ _16"> </span>12),<span class="_ _14"> </span>and<span class="_ _14"> </span>we<span class="_ _16"> </span>update<span class="_ _16"> </span>some</div><div class="t m5 x17 h26 y6919 ff7 fs19 fc1 sc0 ls0 ws0">global<span class="_"> </span>properties<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>pool.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span><span class="ffd">maxfd<span class="_ _10"> </span></span>variable<span class="_"> </span>(lines<span class="_"> </span>15–16)<span class="_"> </span>keeps<span class="_ _13"> </span>track<span class="_"> </span>of<span class="_"> </span>the</div><div class="t m5 x17 h26 y691a ff7 fs19 fc1 sc0 ls0 ws0">largest<span class="_ _11"> </span>ﬁle<span class="_ _11"> </span>descriptor<span class="_ _11"> </span>for<span class="_ _11"> </span><span class="ffd">select</span><span class="ls2e8">.T<span class="_ _42"></span>h<span class="_ _4a"></span>e<span class="ffd ls0">maxi<span class="_ _11"> </span><span class="ff7">variable<span class="_"> </span>(lines<span class="_ _16"> </span>17–18)<span class="_"> </span>keeps<span class="_ _11"> </span>track<span class="_ _11"> </span>of</span></span></span></div><div class="t m5 x17 h26 y691b ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _6"> </span>largest<span class="_ _13"> </span>index<span class="_ _6"> </span>into<span class="_ _13"> </span>the<span class="_ _6"> </span><span class="ffd">clientfd<span class="_ _6"> </span></span>array<span class="_ _13"> </span>so<span class="_ _6"> </span>that<span class="_ _13"> </span>the<span class="_ _6"> </span><span class="ffd">check_clients<span class="_ _6"> </span></span>function<span class="_ _13"> </span>does</div><div class="t m5 x17 h26 y691c ff7 fs19 fc1 sc0 ls0 ws0">not<span class="_"> </span>have<span class="_"> </span>to<span class="_"> </span>search<span class="_"> </span>the<span class="_"> </span>entire<span class="_"> </span>array<span class="_ _3"></span>.</div><div class="t m5 x26 h26 y691d ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _21"> </span><span class="ffd ls0">check_clients<span class="_ _15"> </span><span class="ff7">function<span class="_ _21"> </span>in<span class="_ _15"> </span>F<span class="_ _0"></span>igure<span class="_ _15"> </span>12.11<span class="_ _15"> </span>echoes<span class="_ _15"> </span>a<span class="_ _15"> </span>text<span class="_ _15"> </span>line<span class="_ _21"> </span>from<span class="_ _15"> </span>each</span></span></div><div class="t m5 x17 h26 y691e ff7 fs19 fc1 sc0 ls0 ws0">ready<span class="_ _16"> </span>connected<span class="_ _14"> </span>descriptor.<span class="_ _16"> </span>If<span class="_ _16"> </span>we<span class="_ _14"> </span>are<span class="_ _16"> </span>successful<span class="_ _14"> </span>in<span class="_ _16"> </span>reading<span class="_ _14"> </span>a<span class="_ _16"> </span>text<span class="_ _14"> </span>line<span class="_ _16"> </span>from<span class="_ _14"> </span>the</div><div class="t m5 x17 h26 y691f ff7 fs19 fc1 sc0 ls0 ws0">descriptor,<span class="_"> </span>then<span class="_ _11"> </span>we<span class="_ _16"> </span>echo<span class="_"> </span>that<span class="_ _11"> </span>line<span class="_ _11"> </span>back<span class="_ _16"> </span>to<span class="_"> </span>the<span class="_ _11"> </span>client<span class="_ _16"> </span>(lines<span class="_"> </span>15–18).<span class="_ _11"> </span>Notice<span class="_ _16"> </span>that<span class="_"> </span>in</div><div class="t m5 x17 h26 y6920 ff7 fs19 fc1 sc0 ls0 ws0">line<span class="_ _16"> </span>15,<span class="_ _15"> </span>we<span class="_ _14"> </span>are<span class="_ _14"> </span>maintaining<span class="_ _16"> </span>a<span class="_ _14"> </span>cumulative<span class="_ _14"> </span>count<span class="_ _14"> </span>of<span class="_ _14"> </span>total<span class="_ _16"> </span>bytes<span class="_ _14"> </span>received<span class="_ _14"> </span>from<span class="_ _14"> </span>all</div><div class="t m5 x17 h26 y6921 ff7 fs19 fc1 sc0 ls0 ws0">clients<span class="_ _1"></span>.<span class="_"> </span>If<span class="_ _11"> </span>we<span class="_ _11"> </span>detect<span class="_"> </span>EOF<span class="_ _11"> </span>because<span class="_ _11"> </span>the<span class="_"> </span>client<span class="_ _11"> </span>has<span class="_"> </span>closed<span class="_ _11"> </span>its<span class="_ _11"> </span>end<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>connection,</div><div class="t m5 x17 h26 y6922 ff7 fs19 fc1 sc0 ls0 ws0">then<span class="_ _13"> </span>we<span class="_"> </span>close<span class="_ _13"> </span>our<span class="_"> </span>end<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>connection<span class="_"> </span>(line<span class="_ _13"> </span>23)<span class="_"> </span>and<span class="_ _13"> </span>remove<span class="_"> </span>the<span class="_ _13"> </span>descriptor<span class="_ _13"> </span>from</div><div class="t m5 x17 h26 y7fba ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>pool<span class="_"> </span>(lines<span class="_"> </span>24–25).</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
