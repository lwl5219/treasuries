<div id="pfec" class="pf w2 h11" data-page-no="ec"><div class="pc pcec w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bgec.png"/><div class="t m5 x191 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.5<span class="_ _60"> </span>Arithmetic<span class="_ _10"> </span>and<span class="_ _10"> </span>Logical<span class="_ _10"> </span>Operations<span class="_ _3e"> </span><span class="ffe fs1e">235</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">we<span class="_"> </span>rely<span class="_"> </span>on<span class="_"> </span>support<span class="_"> </span>provided<span class="_"> </span>by<span class="_"> </span><span class="ff9">gcc<span class="_ _10"> </span></span>for<span class="_"> </span>128-bit<span class="_"> </span>integers<span class="_ _1"></span>,<span class="_"> </span>declared<span class="_"> </span>using<span class="_"> </span>the<span class="_"> </span>name</div><div class="t m5 x17 h26 y2a7 ffd fs19 fc2 sc0 ls0 ws0">__int128<span class="ff7">.<span class="_ _11"> </span>Our<span class="_ _16"> </span>code<span class="_ _16"> </span>uses<span class="_ _11"> </span>a<span class="_ _16"> </span></span>typedef<span class="_ _16"> </span><span class="ff7">declaration<span class="_ _11"> </span>to<span class="_ _16"> </span>deﬁne<span class="_ _16"> </span>data<span class="_ _11"> </span>type<span class="_ _16"> </span></span>uint128_t<span class="ff7">,</span></div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">following<span class="_ _13"> </span>the<span class="_"> </span>naming<span class="_ _13"> </span>pattern<span class="_ _13"> </span>for<span class="_ _13"> </span>other<span class="_"> </span>data<span class="_ _13"> </span>types<span class="_ _13"> </span>found<span class="_ _13"> </span>in<span class="_"> </span><span class="ffd">inttypes.h</span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>code</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">speciﬁes<span class="_"> </span>that<span class="_ _13"> </span>the<span class="_"> </span>resulting<span class="_"> </span>product<span class="_ _13"> </span>should<span class="_"> </span>be<span class="_ _13"> </span>stored<span class="_"> </span>at<span class="_"> </span>the<span class="_ _13"> </span>16<span class="_"> </span>bytes<span class="_"> </span>designated<span class="_ _13"> </span>by</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">pointer<span class="_"> </span><span class="ffd">dest</span>.</div><div class="t m5 x26 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>assembly<span class="_"> </span>code<span class="_"> </span>generated<span class="_"> </span>by<span class="_"> </span><span class="ff9">gcc<span class="_ _10"> </span></span>for<span class="_"> </span>this<span class="_"> </span>function<span class="_"> </span>is<span class="_"> </span>as<span class="_"> </span>follows:</div><div class="t m5 x2e h61 y23ff ff13 fs35 fc6 sc0 ls0 ws0">void<span class="_ _f"> </span>store_uprod(uint128_t<span class="_ _f"> </span>*dest,<span class="_ _f"> </span>uint64_t<span class="_ _e"> </span>x,<span class="_ _21"> </span>uint64_t<span class="_ _f"> </span>y)</div><div class="t m5 x2e h61 y2400 ff13 fs35 fc6 sc0 ls0 ws0">dest<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>x<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi,<span class="_ _f"> </span>y<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx</div><div class="t m5 x2c h2d y2401 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">store_uprod:</span></div><div class="t m5 x2c h2d y2402 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rsi,<span class="_ _e"> </span>%rax<span class="_ _88"> </span></span><span class="ff13 fs35">Copy<span class="_ _21"> </span>x<span class="_ _e"> </span>to<span class="_ _21"> </span>multiplicand</span></div><div class="t m5 x2c h2d y2403 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">mulq<span class="_ _46"> </span>%rdx<span class="_ _107"> </span></span><span class="ff13 fs35">Multiply<span class="_ _21"> </span>by<span class="_ _e"> </span>y</span></div><div class="t m5 x2c h2d y2404 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rax,<span class="_ _e"> </span>(%rdi)<span class="_ _93"> </span></span><span class="ff13 fs35">Store<span class="_ _e"> </span>lower<span class="_ _21"> </span>8<span class="_ _f"> </span>bytes<span class="_ _f"> </span>at<span class="_ _e"> </span>dest</span></div><div class="t m5 x2c h2d y2405 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rdx,<span class="_ _e"> </span>8(%rdi)<span class="_ _f1"> </span></span><span class="ff13 fs35">Store<span class="_ _f"> </span>upper<span class="_ _f"> </span>8<span class="_ _f"> </span>bytes<span class="_ _e"> </span>at<span class="_ _21"> </span>dest+8</span></div><div class="t m5 x2c h2d y2406 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">ret</span></div><div class="t m5 x26 h26 y2407 ff7 fs19 fc2 sc0 ls0 ws0">Observe<span class="_"> </span>that<span class="_ _11"> </span>storing<span class="_ _11"> </span>the<span class="_ _11"> </span>product<span class="_ _11"> </span>requires<span class="_"> </span>two<span class="_ _11"> </span><span class="ffd">movq<span class="_ _11"> </span></span>instructions:<span class="_ _11"> </span>one<span class="_"> </span>for<span class="_ _11"> </span>the</div><div class="t m5 x17 h26 y2408 ff7 fs19 fc2 sc0 ls0 ws0">low-order<span class="_ _11"> </span>8<span class="_ _16"> </span>bytes<span class="_ _11"> </span>(line<span class="_ _16"> </span>4),<span class="_ _16"> </span>and<span class="_ _11"> </span>one<span class="_ _16"> </span>for<span class="_ _11"> </span>the<span class="_ _16"> </span>high-order<span class="_ _11"> </span>8<span class="_ _16"> </span>bytes<span class="_ _11"> </span>(line<span class="_ _16"> </span>5).<span class="_ _11"> </span>Since<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y2409 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _11"> </span>is<span class="_ _16"> </span>generated<span class="_ _11"> </span>for<span class="_ _16"> </span>a<span class="_ _16"> </span>little-endian<span class="_ _11"> </span>machine<span class="_ _0"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>high-order<span class="_ _16"> </span>bytes<span class="_ _11"> </span>are<span class="_ _16"> </span>stored<span class="_ _11"> </span>at</div><div class="t m5 x17 h26 y240a ff7 fs19 fc2 sc0 ls0 ws0">higher<span class="_"> </span>addresses<span class="_ _1"></span>,<span class="_"> </span>as<span class="_"> </span>indicated<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>address<span class="_"> </span>speciﬁcation<span class="_"> </span><span class="ffd">8(%rdi)</span>.</div><div class="t m5 x26 h26 y240b ff7 fs19 fc2 sc0 ls0 ws0">Our<span class="_ _f"> </span>earlier<span class="_ _f"> </span>table<span class="_ _f"> </span>of<span class="_ _21"> </span>arithmetic<span class="_ _f"> </span>operations<span class="_ _f"> </span>(Figure<span class="_ _21"> </span>3.10)<span class="_ _f"> </span>does<span class="_ _f"> </span>not<span class="_ _f"> </span>list<span class="_ _f"> </span>any</div><div class="t m5 x17 h26 y240c ff7 fs19 fc2 sc0 ls0 ws0">division<span class="_ _21"> </span>or<span class="_ _f"> </span>modulus<span class="_ _f"> </span>operations<span class="_ _1"></span>.<span class="_ _f"> </span>T<span class="_ _1"></span>hese<span class="_ _f"> </span>operations<span class="_ _f"> </span>are<span class="_ _f"> </span>provided<span class="_ _21"> </span>by<span class="_ _f"> </span>the<span class="_ _f"> </span>single-</div><div class="t m5 x17 h26 y240d ff7 fs19 fc2 sc0 ls0 ws0">operand<span class="_ _14"> </span>divide<span class="_ _15"> </span>instructions<span class="_ _15"> </span>similar<span class="_ _15"> </span>to<span class="_ _14"> </span>the<span class="_ _15"> </span>single-operand<span class="_ _15"> </span>multiply<span class="_ _14"> </span>instructions<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y240e ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>signed<span class="_ _14"> </span>division<span class="_ _16"> </span>instruction<span class="_ _14"> </span><span class="ffd">idivl<span class="_ _14"> </span></span>takes<span class="_ _14"> </span>as<span class="_ _16"> </span>its<span class="_ _14"> </span>dividend<span class="_ _14"> </span>the<span class="_ _14"> </span>128-bit<span class="_ _16"> </span>quantity</div><div class="t m5 x17 h26 y240f ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_"> </span>registers<span class="_"> </span><span class="ffd">%rdx<span class="_ _11"> </span></span>(high-order<span class="_"> </span>64<span class="_"> </span>bits)<span class="_ _11"> </span>and<span class="_"> </span><span class="ffd">%rax<span class="_ _11"> </span></span>(low-order<span class="_"> </span>64<span class="_"> </span>bits).<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>divisor<span class="_"> </span>is</div><div class="t m5 x17 h26 y2410 ff7 fs19 fc2 sc0 ls0 ws0">given<span class="_ _16"> </span>as<span class="_ _16"> </span>the<span class="_ _14"> </span>instruction<span class="_ _16"> </span>operand.<span class="_ _16"> </span>The<span class="_ _16"> </span>instruction<span class="_ _16"> </span>stores<span class="_ _16"> </span>the<span class="_ _14"> </span>quotient<span class="_ _16"> </span>in<span class="_ _16"> </span>register</div><div class="t m5 x17 h26 y2411 ffd fs19 fc2 sc0 ls0 ws0">%rax<span class="_ _10"> </span><span class="ff7">and<span class="_"> </span>the<span class="_"> </span>remainder<span class="_"> </span>in<span class="_"> </span>register<span class="_"> </span></span>%rdx<span class="ff7">.</span></div><div class="t m5 x26 h26 y2412 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_ _13"> </span>most<span class="_ _6"> </span>applications<span class="_ _13"> </span>of<span class="_ _6"> </span>64-bit<span class="_ _13"> </span>addition,<span class="_ _6"> </span>the<span class="_ _13"> </span>dividend<span class="_ _6"> </span>is<span class="_ _13"> </span>given<span class="_ _6"> </span>as<span class="_ _13"> </span>a<span class="_ _13"> </span>64-bit<span class="_ _6"> </span>value<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y2413 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _13"> </span>value<span class="_ _13"> </span>should<span class="_"> </span>be<span class="_ _13"> </span>stored<span class="_ _13"> </span>in<span class="_ _13"> </span>register<span class="_ _13"> </span><span class="ffd">%rax</span>.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>bits<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ffd">%rdx<span class="_ _13"> </span></span>should<span class="_"> </span>then<span class="_ _13"> </span>be<span class="_ _13"> </span>set<span class="_ _13"> </span>to</div><div class="t m5 x17 h26 y2414 ff7 fs19 fc2 sc0 ls0 ws0">either<span class="_ _11"> </span>all<span class="_ _11"> </span>zeros<span class="_ _11"> </span>(unsigned<span class="_ _11"> </span>arithmetic)<span class="_ _11"> </span>or<span class="_ _11"> </span>the<span class="_ _11"> </span>sign<span class="_ _11"> </span>bit<span class="_ _11"> </span>of<span class="_ _11"> </span><span class="ffd">%rax<span class="_ _11"> </span></span>(signed<span class="_ _11"> </span>arithmetic).</div><div class="t m5 x17 h26 y2415 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>latter<span class="_ _a"> </span>operation<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _6"> </span>performed<span class="_ _13"> </span>using<span class="_ _a"> </span>the<span class="_ _13"> </span>instruction<span class="_ _6"> </span><span class="ffd">cqto</span>.</div><div class="t m5 x163 h3c y2416 ff7 fs25 fc2 sc0 ls0 ws0">2</div><div class="t m5 x12f h26 y2417 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _13"> </span>instruction</div><div class="t m5 x17 h26 y2418 ff7 fs19 fc2 sc0 ls0 ws0">takes<span class="_"> </span>no<span class="_"> </span>operands—it<span class="_"> </span>implicitly<span class="_"> </span>reads<span class="_"> </span>the<span class="_"> </span>sign<span class="_ _11"> </span>bit<span class="_"> </span>from<span class="_"> </span><span class="ffd">%rax<span class="_ _10"> </span></span>and<span class="_"> </span>copies<span class="_ _11"> </span>it<span class="_"> </span>across</div><div class="t m5 x17 h26 y2419 ff7 fs19 fc2 sc0 ls0 ws0">all<span class="_"> </span>of<span class="_"> </span><span class="ffd">%rdx</span>.</div><div class="t m5 x26 h26 y241a ff7 fs19 fc2 sc0 ls0 ws0">As<span class="_ _13"> </span>an<span class="_ _13"> </span>illustration<span class="_ _13"> </span>of<span class="_ _6"> </span>the<span class="_ _13"> </span>implementation<span class="_ _13"> </span>of<span class="_ _13"> </span>division<span class="_ _13"> </span>with<span class="_ _13"> </span>x86-64,<span class="_ _13"> </span>the<span class="_ _6"> </span>following</div><div class="t m5 x17 h26 y241b ff7 fs19 fc2 sc0 ls0 ws0">C<span class="_"> </span>function<span class="_"> </span>computes<span class="_"> </span>the<span class="_"> </span>quotient<span class="_"> </span>and<span class="_"> </span>remainder<span class="_"> </span>of<span class="_"> </span>two<span class="_"> </span>64-bit,<span class="_"> </span>signed<span class="_"> </span>numbers:</div><div class="t m5 x17 h2d y241c ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>remdiv(long<span class="_ _1f"> </span>x,<span class="_ _1f"> </span>long<span class="_ _e"> </span>y,</div><div class="t m5 x155 h2d y241d ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>*qp,<span class="_ _1f"> </span>long<span class="_ _1f"> </span>*rp)<span class="_ _e"> </span>{</div><div class="t m5 x1b6 h2d y241e ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>q<span class="_ _1f"> </span>=<span class="_ _1f"> </span>x/y;</div><div class="t m5 x1b6 h2d y241f ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>r<span class="_ _1f"> </span>=<span class="_ _1f"> </span>x%y;</div><div class="t m5 x1b6 h2d y2420 ffd fs1e fc2 sc0 ls33 ws0">*<span class="_ _41"></span>q<span class="_ _41"></span>p=q<span class="_ _41"></span>;</div><div class="t m5 x1b6 h2d y2421 ffd fs1e fc2 sc0 ls33 ws0">*<span class="_ _41"></span>r<span class="_ _41"></span>p=r<span class="_ _41"></span>;</div><div class="t m5 x17 h2d y2422 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h1d y2423 ff7 fs17 fc2 sc0 ls0 ws0">2.<span class="_ _6"> </span>T<span class="_ _0"></span>his<span class="_ _6"> </span>instruction<span class="_ _6"> </span>is<span class="_ _6"> </span>called<span class="_ _6"> </span><span class="ffd fs35">cqo<span class="_ _6"> </span></span>in<span class="_ _6"> </span>the<span class="_"> </span>Intel<span class="_ _a"> </span>documentation,<span class="_ _6"> </span>one<span class="_"> </span>of<span class="_ _a"> </span>the<span class="_ _6"> </span>few<span class="_ _6"> </span>cases<span class="_ _6"> </span>where<span class="_ _6"> </span>the<span class="_"> </span>A<span class="_ _3"></span>TT<span class="_ _3"></span>-format</div><div class="t m5 x17 h1d y2424 ff7 fs17 fc2 sc0 ls0 ws0">name<span class="_"> </span>for<span class="_"> </span>an<span class="_"> </span>instruction<span class="_"> </span>does<span class="_"> </span>not<span class="_"> </span>match<span class="_"> </span>the<span class="_"> </span>Intel<span class="_"> </span>name<span class="_ _0"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
