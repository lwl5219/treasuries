<div id="pf305" class="pf w2 h11" data-page-no="305"><div class="pc pc305 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg305.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">772<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>8<span class="_ _3d"> </span>Exceptional<span class="_ _10"> </span>Control<span class="_ _10"> </span>Flow</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">ﬁles<span class="_ _13"> </span>that<span class="_ _6"> </span>can<span class="_ _13"> </span>be<span class="_ _13"> </span>read<span class="_ _6"> </span>by<span class="_ _13"> </span>user<span class="_ _13"> </span>programs<span class="_ _3"></span>.<span class="_ _13"> </span>F<span class="_ _1"></span>or<span class="_ _13"> </span>example<span class="_ _1"></span>,<span class="_ _13"> </span>you<span class="_ _13"> </span>can<span class="_ _6"> </span>use<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">/proc<span class="_ _6"> </span></span>ﬁlesys-</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">tem<span class="_"> </span>to<span class="_"> </span>ﬁnd<span class="_ _11"> </span>out<span class="_"> </span>general<span class="_"> </span>system<span class="_ _11"> </span>attributes<span class="_"> </span>such<span class="_"> </span>as<span class="_ _11"> </span>CPU<span class="_"> </span>type<span class="_"> </span>(<span class="ffd">/proc/cpuinfo</span>),<span class="_ _11"> </span>or</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>memory<span class="_"> </span>segments<span class="_ _13"> </span>used<span class="_ _13"> </span>by<span class="_"> </span>a<span class="_ _13"> </span>particular<span class="_ _13"> </span>process<span class="_"> </span>(<span class="ffd">/proc/<span class="ffa">process-id</span>/maps</span>).<span class="_"> </span>T<span class="_ _3"></span>he</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">2.6<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>Linux<span class="_"> </span>kernel<span class="_"> </span>introduced<span class="_"> </span>a<span class="_"> </span><span class="ffd">/sys<span class="_ _10"> </span></span>ﬁlesystem,<span class="_"> </span>which<span class="_"> </span>exports<span class="_ _13"> </span>addi-</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">tional<span class="_"> </span>low-level<span class="_"> </span>information<span class="_"> </span>about<span class="_"> </span>system<span class="_"> </span>buses<span class="_"> </span>and<span class="_"> </span>devices<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y287 ffe fs29 fc2 sc0 ls0 ws0">8.2.5<span class="_ _48"> </span><span class="fs19">Context<span class="_"> </span>Switches</span></div><div class="t m5 x1d h26 y3232 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>operating<span class="_ _16"> </span>system<span class="_ _16"> </span>kernel<span class="_ _16"> </span>implements<span class="_ _16"> </span>multitasking<span class="_ _11"> </span>using<span class="_ _16"> </span>a<span class="_ _16"> </span>higher<span class="_ _1"></span>-level<span class="_ _16"> </span>form</div><div class="t m5 x1d h26 y6546 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>exceptional<span class="_"> </span>control<span class="_ _13"> </span>ﬂow<span class="_"> </span>known<span class="_"> </span>as<span class="_"> </span>a<span class="_"> </span><span class="ffa">context<span class="_"> </span>s<span class="_ _0"></span>witch<span class="ff7">.<span class="_ _13"> </span>The<span class="_ _13"> </span>context<span class="_"> </span>switch<span class="_"> </span>mecha-</span></span></div><div class="t m5 x1d h26 y6547 ff7 fs19 fc2 sc0 ls0 ws0">nism<span class="_"> </span>is<span class="_ _11"> </span>built<span class="_ _11"> </span>on<span class="_ _11"> </span>top<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>lower<span class="_ _1"></span>-level<span class="_ _11"> </span>exception<span class="_"> </span>mechanism<span class="_ _11"> </span>that<span class="_ _11"> </span>we<span class="_ _11"> </span>discussed<span class="_ _11"> </span>in</div><div class="t m5 x1d h26 y6548 ff7 fs19 fc2 sc0 ls0 ws0">Section<span class="_"> </span>8.1.</div><div class="t m5 x29 h26 y3235 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _f"> </span>kernel<span class="_ _f"> </span>maintains<span class="_ _21"> </span>a<span class="_ _f"> </span><span class="ffa">context<span class="_ _e"> </span></span>for<span class="_ _21"> </span>each<span class="_ _f"> </span>process<span class="_ _1"></span>.<span class="_ _f"> </span>T<span class="_ _1"></span>he<span class="_ _f"> </span>context<span class="_ _f"> </span>is<span class="_ _21"> </span>the<span class="_ _f"> </span>state</div><div class="t m5 x1d h26 y3236 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _15"> </span>the<span class="_ _15"> </span>kernel<span class="_ _21"> </span>needs<span class="_ _15"> </span>to<span class="_ _15"> </span>restart<span class="_ _21"> </span>a<span class="_ _15"> </span>preempted<span class="_ _21"> </span>process<span class="_ _1"></span>.<span class="_ _15"> </span>It<span class="_ _15"> </span>consists<span class="_ _21"> </span>of<span class="_ _15"> </span>the<span class="_ _21"> </span>values</div><div class="t m5 x1d h26 y6549 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _16"> </span>objects<span class="_ _16"> </span>such<span class="_ _16"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span>general-purpose<span class="_ _16"> </span>registers<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>ﬂoating-point<span class="_ _16"> </span>registers<span class="_ _1"></span>,<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 y654a ff7 fs19 fc2 sc0 ls0 ws0">program<span class="_"> </span>counter,<span class="_ _11"> </span>user’s<span class="_"> </span>stack,<span class="_ _11"> </span>status<span class="_ _11"> </span>registers<span class="_ _1"></span>,<span class="_ _11"> </span>kernel’s<span class="_"> </span>stack,<span class="_ _11"> </span>and<span class="_ _11"> </span>various<span class="_"> </span>kernel</div><div class="t m5 x1d h26 y654b ff7 fs19 fc2 sc0 ls0 ws0">data<span class="_ _13"> </span>structures<span class="_"> </span>such<span class="_ _13"> </span>as<span class="_"> </span>a<span class="_ _13"> </span><span class="ffa">page<span class="_"> </span>table<span class="_ _13"> </span></span>that<span class="_"> </span>characterizes<span class="_ _13"> </span>the<span class="_"> </span>address<span class="_ _13"> </span>space,<span class="_ _13"> </span>a<span class="_"> </span><span class="ffa">process</span></div><div class="t m5 x1d h26 y654c ffa fs19 fc2 sc0 ls0 ws0">table<span class="_ _15"> </span><span class="ff7">that<span class="_ _15"> </span>contains<span class="_ _15"> </span>information<span class="_ _21"> </span>about<span class="_ _15"> </span>the<span class="_ _15"> </span>current<span class="_ _15"> </span>process<span class="_ _1"></span>,<span class="_ _f"> </span>and<span class="_ _15"> </span>a<span class="_ _15"> </span><span class="ffa">ﬁle<span class="_ _15"> </span>table<span class="_ _21"> </span></span>that</span></div><div class="t m5 x1d h26 y654d ff7 fs19 fc2 sc0 ls0 ws0">contains<span class="_"> </span>information<span class="_"> </span>about<span class="_"> </span>the<span class="_"> </span>ﬁles<span class="_"> </span>that<span class="_"> </span>the<span class="_"> </span>process<span class="_"> </span>has<span class="_"> </span>opened.</div><div class="t m5 x29 h26 y654e ff7 fs19 fc2 sc0 ls0 ws0">At<span class="_ _14"> </span>certain<span class="_ _15"> </span>points<span class="_ _15"> </span>during<span class="_ _14"> </span>the<span class="_ _15"> </span>execution<span class="_ _15"> </span>of<span class="_ _14"> </span>a<span class="_ _15"> </span>process<span class="_ _1"></span>,<span class="_ _21"> </span>the<span class="_ _15"> </span>kernel<span class="_ _14"> </span>can<span class="_ _15"> </span>decide</div><div class="t m5 x1d h26 y654f ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>preempt<span class="_ _11"> </span>the<span class="_ _11"> </span>current<span class="_ _11"> </span>process<span class="_ _11"> </span>and<span class="_ _11"> </span>restart<span class="_ _11"> </span>a<span class="_ _11"> </span>previously<span class="_ _11"> </span>preempted<span class="_ _11"> </span>process<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _0"></span>his</div><div class="t m5 x1d h26 y6550 ff7 fs19 fc2 sc0 ls0 ws0">decision<span class="_ _11"> </span>is<span class="_ _16"> </span>known<span class="_ _11"> </span>as<span class="_ _11"> </span><span class="ffa">scheduling<span class="_ _16"> </span></span>and<span class="_ _16"> </span>is<span class="_ _11"> </span>handled<span class="_ _11"> </span>by<span class="_ _16"> </span>code<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _16"> </span>kernel,<span class="_ _11"> </span>called<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y6551 ffa fs19 fc2 sc0 ls0 ws0">scheduler<span class="_ _2"></span><span class="ff7">.<span class="_ _11"> </span>When<span class="_ _11"> </span>the<span class="_ _16"> </span>kernel<span class="_ _16"> </span>selects<span class="_ _11"> </span>a<span class="_ _16"> </span>new<span class="_ _16"> </span>process<span class="_ _11"> </span>to<span class="_ _16"> </span>run,<span class="_ _16"> </span>we<span class="_ _11"> </span>say<span class="_ _16"> </span>that<span class="_ _16"> </span>the<span class="_ _11"> </span>kernel</span></div><div class="t m5 x1d h26 y6552 ff7 fs19 fc2 sc0 ls0 ws0">has<span class="_"> </span><span class="ffa">scheduled<span class="_ _11"> </span></span>that<span class="_ _11"> </span>process<span class="_ _1"></span>.<span class="_ _11"> </span>After<span class="_ _11"> </span>the<span class="_"> </span>kernel<span class="_ _11"> </span>has<span class="_ _11"> </span>scheduled<span class="_ _11"> </span>a<span class="_"> </span>new<span class="_ _11"> </span>process<span class="_ _11"> </span>to<span class="_"> </span>run,</div><div class="t m5 x1d h26 y6553 ff7 fs19 fc2 sc0 ls0 ws0">it<span class="_ _11"> </span>preempts<span class="_ _16"> </span>the<span class="_ _11"> </span>current<span class="_ _11"> </span>process<span class="_ _16"> </span>and<span class="_ _11"> </span>transfers<span class="_ _16"> </span>control<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>new<span class="_ _11"> </span>process<span class="_ _16"> </span>using<span class="_ _11"> </span>a</div><div class="t m5 x1d h26 y6554 ff7 fs19 fc2 sc0 ls0 ws0">mechanism<span class="_ _13"> </span>called<span class="_ _6"> </span>a<span class="_ _13"> </span><span class="ffa">context<span class="_ _13"> </span>switc<span class="_ _0"></span>h<span class="_ _6"> </span><span class="ff7">that<span class="_ _13"> </span>(1)<span class="_ _13"> </span>saves<span class="_ _13"> </span>the<span class="_ _6"> </span>context<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>current<span class="_ _13"> </span>process<span class="_ _1"></span>,</span></span></div><div class="t m5 x1d h26 y6555 ff7 fs19 fc2 sc0 ls0 ws0">(2)<span class="_ _15"> </span>restores<span class="_ _21"> </span>the<span class="_ _15"> </span>saved<span class="_ _21"> </span>context<span class="_ _21"> </span>of<span class="_ _15"> </span>some<span class="_ _21"> </span>previously<span class="_ _15"> </span>preempted<span class="_ _21"> </span>process<span class="_ _1"></span>,<span class="_ _f"> </span>and<span class="_ _21"> </span>(3)</div><div class="t m5 x1d h26 y6556 ff7 fs19 fc2 sc0 ls0 ws0">passes<span class="_"> </span>control<span class="_"> </span>to<span class="_"> </span>this<span class="_"> </span>newly<span class="_"> </span>restored<span class="_"> </span>process<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y6557 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _6"> </span>context<span class="_ _6"> </span>switch<span class="_ _6"> </span>can<span class="_ _13"> </span>occur<span class="_ _a"> </span>while<span class="_ _6"> </span>the<span class="_ _13"> </span>kernel<span class="_ _a"> </span>is<span class="_ _6"> </span>executing<span class="_ _13"> </span>a<span class="_ _a"> </span>system<span class="_ _6"> </span>call<span class="_ _13"> </span>on<span class="_ _a"> </span>behalf</div><div class="t m5 x1d h26 y6558 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_ _13"> </span>user.<span class="_"> </span>If<span class="_"> </span>the<span class="_ _13"> </span>system<span class="_"> </span>call<span class="_"> </span>blocks<span class="_ _13"> </span>because<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>waiting<span class="_ _13"> </span>for<span class="_"> </span>some<span class="_"> </span>event<span class="_ _13"> </span>to<span class="_"> </span>occur,</div><div class="t m5 x1d h26 y6559 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_ _13"> </span>the<span class="_ _13"> </span>kernel<span class="_ _13"> </span>can<span class="_ _13"> </span>put<span class="_ _13"> </span>the<span class="_ _13"> </span>current<span class="_ _13"> </span>process<span class="_ _13"> </span>to<span class="_ _13"> </span>sleep<span class="_ _13"> </span>and<span class="_ _13"> </span>switch<span class="_ _13"> </span>to<span class="_ _13"> </span>another<span class="_ _13"> </span>process<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y655a ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_ _16"> </span>example,<span class="_ _14"> </span>if<span class="_ _16"> </span>a<span class="_ _14"> </span><span class="ffd">read<span class="_ _14"> </span></span>system<span class="_ _16"> </span>call<span class="_ _14"> </span>requires<span class="_ _14"> </span>a<span class="_ _16"> </span>disk<span class="_ _14"> </span>access<span class="_ _1"></span>,<span class="_ _14"> </span>the<span class="_ _14"> </span>kernel<span class="_ _14"> </span>can<span class="_ _16"> </span>opt<span class="_ _14"> </span>to</div><div class="t m5 x1d h26 y655b ff7 fs19 fc2 sc0 ls0 ws0">perform<span class="_"> </span>a<span class="_"> </span>context<span class="_"> </span>switch<span class="_ _11"> </span>and<span class="_"> </span>run<span class="_"> </span>another<span class="_ _11"> </span>process<span class="_"> </span>instead<span class="_"> </span>of<span class="_ _11"> </span>waiting<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>data</div><div class="t m5 x1d h26 y655c ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _16"> </span>arrive<span class="_ _14"> </span>from<span class="_ _14"> </span>the<span class="_ _14"> </span>disk.<span class="_ _14"> </span>Another<span class="_ _14"> </span>example<span class="_ _14"> </span>is<span class="_ _16"> </span>the<span class="_ _14"> </span><span class="ffd">sleep<span class="_ _14"> </span></span>system<span class="_ _14"> </span>call,<span class="_ _14"> </span>which<span class="_ _14"> </span>is<span class="_ _14"> </span>an</div><div class="t m5 x1d h26 y655d ff7 fs19 fc2 sc0 ls0 ws0">explicit<span class="_ _16"> </span>request<span class="_ _14"> </span>to<span class="_ _14"> </span>put<span class="_ _14"> </span>the<span class="_ _14"> </span>calling<span class="_ _14"> </span>process<span class="_ _14"> </span>to<span class="_ _16"> </span>sleep.<span class="_ _16"> </span>In<span class="_ _14"> </span>general,<span class="_ _14"> </span>even<span class="_ _14"> </span>if<span class="_ _14"> </span>a<span class="_ _14"> </span>system</div><div class="t m5 x1d h26 y655e ff7 fs19 fc2 sc0 ls0 ws0">call<span class="_"> </span>does<span class="_ _13"> </span>not<span class="_"> </span>block,<span class="_ _13"> </span>the<span class="_"> </span>kernel<span class="_"> </span>can<span class="_ _13"> </span>decide<span class="_"> </span>to<span class="_ _13"> </span>perform<span class="_"> </span>a<span class="_ _13"> </span>context<span class="_"> </span>switch<span class="_"> </span>rather<span class="_ _13"> </span>than</div><div class="t m5 x1d h26 y655f ff7 fs19 fc2 sc0 ls0 ws0">return<span class="_"> </span>control<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>calling<span class="_"> </span>process<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y6560 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _16"> </span>context<span class="_ _11"> </span>switch<span class="_ _16"> </span>can<span class="_ _16"> </span>also<span class="_ _11"> </span>occur<span class="_ _16"> </span>as<span class="_ _16"> </span>a<span class="_ _11"> </span>result<span class="_ _16"> </span>of<span class="_ _16"> </span>an<span class="_ _11"> </span>interrupt.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _16"> </span>all</div><div class="t m5 x1d h26 y6561 ff7 fs19 fc2 sc0 ls0 ws0">systems<span class="_"> </span>have<span class="_"> </span>some<span class="_"> </span>mechanism<span class="_ _11"> </span>for<span class="_"> </span>generating<span class="_"> </span>periodic<span class="_ _11"> </span>timer<span class="_"> </span>interrupts<span class="_ _1"></span>,<span class="_"> </span>typically</div><div class="t m5 x1d h26 y6562 ff7 fs19 fc2 sc0 ls0 ws0">every<span class="_ _13"> </span>1<span class="_ _13"> </span>ms<span class="_ _13"> </span>or<span class="_ _13"> </span>10<span class="_ _13"> </span>ms<span class="_ _1"></span>.<span class="_ _13"> </span>Each<span class="_ _13"> </span>time<span class="_ _13"> </span>a<span class="_ _13"> </span>timer<span class="_ _13"> </span>interrupt<span class="_"> </span>occurs<span class="_ _3"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>kernel<span class="_ _13"> </span>can<span class="_"> </span>decide<span class="_ _13"> </span>that</div><div class="t m5 x1d h26 y6563 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>current<span class="_"> </span>process<span class="_"> </span>has<span class="_"> </span>run<span class="_"> </span>long<span class="_"> </span>enough<span class="_"> </span>and<span class="_"> </span>switch<span class="_"> </span>to<span class="_"> </span>a<span class="_"> </span>new<span class="_"> </span>process<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y6564 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _13"> </span>8.14<span class="_ _6"> </span>shows<span class="_ _13"> </span>an<span class="_ _6"> </span>example<span class="_ _13"> </span>of<span class="_ _6"> </span>context<span class="_ _6"> </span>switching<span class="_ _13"> </span>between<span class="_ _6"> </span>a<span class="_ _13"> </span>pair<span class="_ _6"> </span>of<span class="_ _13"> </span>processes</div><div class="t m5 x1d h26 y6565 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _6"> </span>and<span class="_ _13"> </span>B<span class="_ _3"></span>.<span class="_ _6"> </span>In<span class="_ _13"> </span>this<span class="_ _6"> </span>example<span class="_ _0"></span>,<span class="_ _13"> </span>initially<span class="_ _6"> </span>process<span class="_ _6"> </span>A<span class="_ _13"> </span>is<span class="_ _6"> </span>running<span class="_ _6"> </span>in<span class="_ _13"> </span>user<span class="_ _6"> </span>mode<span class="_ _13"> </span>until<span class="_ _6"> </span>it<span class="_ _6"> </span>traps<span class="_ _13"> </span>to</div><div class="t m5 x1d h26 y6566 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>kernel<span class="_ _13"> </span>by<span class="_ _13"> </span>executing<span class="_ _6"> </span>a<span class="_ _13"> </span><span class="ffd">read<span class="_ _13"> </span></span>system<span class="_ _13"> </span>call.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>trap<span class="_ _13"> </span>handler<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>kernel<span class="_ _6"> </span>requests</div><div class="t m5 x1d h26 y6567 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _13"> </span>DMA<span class="_ _13"> </span>transfer<span class="_ _13"> </span>from<span class="_ _13"> </span>the<span class="_ _13"> </span>disk<span class="_ _13"> </span>controller<span class="_ _13"> </span>and<span class="_ _13"> </span>arranges<span class="_ _13"> </span>for<span class="_ _13"> </span>the<span class="_ _13"> </span>disk<span class="_ _13"> </span>to<span class="_ _13"> </span>interrupt<span class="_ _13"> </span>the</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
