<div id="pf370" class="pf w2 h11" data-page-no="370"><div class="pc pc370 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg370.png"/><div class="t m5 x1c9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.9<span class="_ _60"> </span>Dynamic<span class="_ _10"> </span>Memor<span class="_"> </span>y<span class="_ _10"> </span>Allocation<span class="_ _3e"> </span><span class="ffe fs1e">879</span></div><div class="t m5 x30 h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">still<span class="_ _13"> </span>points<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>freed<span class="_ _13"> </span>block.<span class="_ _13"> </span>It<span class="_ _13"> </span>is<span class="_ _13"> </span>the<span class="_ _13"> </span>responsibility<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>application<span class="_ _13"> </span>not</div><div class="t m5 x30 h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>use<span class="_"> </span><span class="ffd">p2<span class="_ _10"> </span></span>again<span class="_"> </span>until<span class="_"> </span>it<span class="_"> </span>is<span class="_"> </span>reinitialized<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>new<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">malloc</span>.</div><div class="t m5 x72 h26 y2033 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>9.34(e).<span class="_ _1f"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span>program<span class="_ _16"> </span>requests<span class="_ _16"> </span>a<span class="_ _16"> </span>two-word<span class="_ _16"> </span>block.<span class="_ _16"> </span>In<span class="_ _14"> </span>this<span class="_ _16"> </span>case<span class="_ _1"></span>,<span class="_ _14"> </span><span class="ffd">malloc</span></div><div class="t m5 x30 h26 y2034 ff7 fs19 fc2 sc0 ls0 ws0">allocates<span class="_ _16"> </span>a<span class="_ _16"> </span>portion<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>block<span class="_ _16"> </span>that<span class="_ _16"> </span>was<span class="_ _16"> </span>freed<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span>previous<span class="_ _16"> </span>step<span class="_ _16"> </span>and</div><div class="t m5 x30 h26 y2035 ff7 fs19 fc2 sc0 ls0 ws0">returns<span class="_"> </span>a<span class="_"> </span>pointer<span class="_"> </span>to<span class="_"> </span>this<span class="_"> </span>new<span class="_"> </span>block.</div><div class="t m5 x17 h41 y7212 ffe fs29 fc2 sc0 ls0 ws0">9.9.2</div><div class="t m5 x182 h43 y7213 ffe fs19 fc2 sc0 ls0 ws0">Why<span class="_"> </span>Dynamic<span class="_"> </span>Memory<span class="_"> </span>Allocation?</div><div class="t m5 x17 h26 y7214 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>most<span class="_"> </span>important<span class="_ _13"> </span>reason<span class="_"> </span>that<span class="_"> </span>programs<span class="_ _13"> </span>use<span class="_"> </span>dynamic<span class="_ _13"> </span>memory<span class="_"> </span>allocation<span class="_"> </span>is<span class="_ _13"> </span>that</div><div class="t m5 x17 h26 y7215 ff7 fs19 fc2 sc0 ls0 ws0">often<span class="_ _15"> </span>they<span class="_ _21"> </span>do<span class="_ _21"> </span>not<span class="_ _21"> </span>know<span class="_ _15"> </span>the<span class="_ _21"> </span>sizes<span class="_ _21"> </span>of<span class="_ _21"> </span>certain<span class="_ _15"> </span>data<span class="_ _21"> </span>structures<span class="_ _21"> </span>until<span class="_ _21"> </span>the<span class="_ _21"> </span>program</div><div class="t m5 x17 h26 y7216 ff7 fs19 fc2 sc0 ls0 ws0">actually<span class="_"> </span>runs<span class="_ _3"></span>.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_"> </span>example<span class="_ _1"></span>,<span class="_"> </span>suppose<span class="_"> </span>we<span class="_ _13"> </span>are<span class="_"> </span>asked<span class="_"> </span>to<span class="_ _13"> </span>write<span class="_"> </span>a<span class="_ _13"> </span>C<span class="_"> </span>program<span class="_"> </span>that<span class="_ _13"> </span>reads</div><div class="t m5 x17 h26 y7217 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _16"> </span>list<span class="_ _14"> </span>of<span class="_ _16"> </span><span class="ff11">n<span class="_"> </span></span>ASCII<span class="_ _14"> </span>integers<span class="_ _1"></span>,<span class="_ _14"> </span>one<span class="_ _16"> </span>integer<span class="_ _14"> </span>per<span class="_ _16"> </span>line,<span class="_ _16"> </span>from<span class="_ _14"> </span><span class="ffd">stdin<span class="_ _16"> </span></span>into<span class="_ _14"> </span>a<span class="_ _16"> </span>C<span class="_ _14"> </span>array<span class="_ _3"></span>.<span class="_ _16"> </span>T<span class="_ _0"></span>he</div><div class="t m5 x17 h26 y7218 ff7 fs19 fc2 sc0 ls0 ws0">input<span class="_ _16"> </span>consists<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>integer<span class="_ _16"> </span><span class="ff11">n</span>,<span class="_ _16"> </span>followed<span class="_ _16"> </span>by<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ff11">n<span class="_"> </span></span>integers<span class="_ _11"> </span>to<span class="_ _16"> </span>be<span class="_ _16"> </span>read<span class="_ _16"> </span>and<span class="_ _16"> </span>stored</div><div class="t m5 x17 h26 y7219 ff7 fs19 fc2 sc0 ls0 ws0">into<span class="_ _16"> </span>the<span class="_ _16"> </span>array<span class="_ _7"></span>.<span class="_ _16"> </span>The<span class="_ _11"> </span>simplest<span class="_ _16"> </span>approach<span class="_ _16"> </span>is<span class="_ _16"> </span>to<span class="_ _16"> </span>deﬁne<span class="_ _16"> </span>the<span class="_ _16"> </span>array<span class="_ _16"> </span>statically<span class="_ _16"> </span>with<span class="_ _16"> </span>some</div><div class="t m5 x17 h26 y721a ff7 fs19 fc2 sc0 ls0 ws0">hard-coded<span class="_"> </span>maximum<span class="_"> </span>array<span class="_"> </span>size:</div><div class="t m5 x2c h2d y721b ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h2d y721c ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#define<span class="_ _1f"> </span>MAXN<span class="_ _e"> </span>15213</span></div><div class="t m5 x2c h2e y721d ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2c h2e y721e ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2d h2d y721f ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>array[MAXN];</div><div class="t m5 x2c h2e y7220 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y7221 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2d h2d y7222 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x2c h2d y7223 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y7224 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i,<span class="_ _1f"> </span>n;</span></div><div class="t m5 x2c h2e y7225 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x17 h2e y7226 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x142 h2d y7227 ffd fs1e fc2 sc0 ls0 ws0">scanf(&quot;%d&quot;,<span class="_ _e"> </span>&amp;n);</div><div class="t m5 x17 h2d y7228 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(n<span class="_ _1f"> </span>&gt;<span class="_ _1f"> </span>MAXN)</span></div><div class="t m5 x17 h2d y7229 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">app_error(&quot;Input<span class="_ _e"> </span>file<span class="_ _1f"> </span>too<span class="_ _1f"> </span>big&quot;);</span></div><div class="t m5 x17 h2d y722a ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2 ls33">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;n<span class="_ _41"></span>;<span class="ls0">i++)</span></span></div><div class="t m5 x17 h2d y722b ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">scanf(&quot;%d&quot;,<span class="_ _e"> </span>&amp;array[i]);</span></div><div class="t m5 x17 h2d y722c ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x17 h2e y722d ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x2d h2d y722e ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x26 h26 y722f ff7 fs19 fc2 sc0 ls0 ws0">Allocating<span class="_ _13"> </span>arrays<span class="_ _13"> </span>with<span class="_ _13"> </span>hard-coded<span class="_ _13"> </span>sizes<span class="_ _13"> </span>like<span class="_ _13"> </span>this<span class="_ _13"> </span>is<span class="_ _13"> </span>often<span class="_ _13"> </span>a<span class="_ _13"> </span>bad<span class="_ _13"> </span>idea.<span class="_ _13"> </span>T<span class="_ _0"></span>he<span class="_ _13"> </span>value</div><div class="t m5 x17 h26 y7230 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _13"> </span>MAXN<span class="_ _13"> </span>is<span class="_ _6"> </span>arbitrary<span class="_ _13"> </span>and<span class="_ _13"> </span>has<span class="_ _13"> </span>no<span class="_ _13"> </span>relation<span class="_ _13"> </span>to<span class="_ _6"> </span>the<span class="_ _13"> </span>actual<span class="_ _13"> </span>amount<span class="_ _13"> </span>of<span class="_ _13"> </span>available<span class="_ _6"> </span>virtual</div><div class="t m5 x17 h26 y7231 ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_"> </span>on<span class="_ _13"> </span>the<span class="_"> </span>machine<span class="_ _1"></span>.<span class="_"> </span>Further<span class="_ _1"></span>,<span class="_"> </span>if<span class="_"> </span>the<span class="_ _13"> </span>user<span class="_"> </span>of<span class="_ _13"> </span>this<span class="_"> </span>program<span class="_ _13"> </span>wanted<span class="_"> </span>to<span class="_ _13"> </span>read<span class="_"> </span>a<span class="_ _13"> </span>ﬁle</div><div class="t m5 x17 h26 y7232 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _13"> </span>was<span class="_ _6"> </span>larger<span class="_ _13"> </span>than<span class="_ _13"> </span>MAXN<span class="_ _3"></span>,<span class="_ _13"> </span>the<span class="_ _6"> </span>only<span class="_ _13"> </span>recourse<span class="_ _13"> </span>would<span class="_ _6"> </span>be<span class="_ _13"> </span>to<span class="_ _13"> </span>recompile<span class="_ _6"> </span>the<span class="_ _13"> </span>program</div><div class="t m5 x17 h26 y7233 ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_ _11"> </span>a<span class="_ _11"> </span>larger<span class="_ _11"> </span>value<span class="_ _16"> </span>of<span class="_"> </span>MAXN<span class="_ _1"></span>.<span class="_ _11"> </span>While<span class="_ _11"> </span>not<span class="_ _11"> </span>a<span class="_ _11"> </span>problem<span class="_ _11"> </span>for<span class="_ _16"> </span>this<span class="_"> </span>simple<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y1204 ff7 fs19 fc2 sc0 ls0 ws0">presence<span class="_ _16"> </span>of<span class="_ _11"> </span>hard-coded<span class="_ _16"> </span>array<span class="_ _16"> </span>bounds<span class="_ _11"> </span>can<span class="_ _16"> </span>become<span class="_ _11"> </span>a<span class="_ _16"> </span>maintenance<span class="_ _16"> </span>nightmare<span class="_ _11"> </span>for</div><div class="t m5 x17 h26 y1205 ff7 fs19 fc2 sc0 ls0 ws0">large<span class="_"> </span>software<span class="_"> </span>products<span class="_"> </span>with<span class="_"> </span>millions<span class="_"> </span>of<span class="_"> </span>lines<span class="_"> </span>of<span class="_"> </span>code<span class="_"> </span>and<span class="_"> </span>numerous<span class="_"> </span>users<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y1206 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_"> </span>better<span class="_ _11"> </span>approach<span class="_ _11"> </span>is<span class="_ _11"> </span>to<span class="_ _11"> </span>allocate<span class="_ _11"> </span>the<span class="_ _11"> </span>array<span class="_ _11"> </span>dynamically<span class="_ _3"></span>,<span class="_"> </span>at<span class="_ _11"> </span>run<span class="_ _11"> </span>time,<span class="_"> </span>after<span class="_ _11"> </span>the</div><div class="t m5 x17 h26 y1207 ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_"> </span>of<span class="_"> </span><span class="ff11">n<span class="_ _10"> </span></span>becomes<span class="_"> </span>known.<span class="_"> </span>W<span class="_ _0"></span>ith<span class="_"> </span>this<span class="_"> </span>approach,<span class="_"> </span>the<span class="_"> </span>maximum<span class="_"> </span>size<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>array<span class="_"> </span>is</div><div class="t m5 x17 h26 y1208 ff7 fs19 fc2 sc0 ls0 ws0">limited<span class="_"> </span>only<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>amount<span class="_"> </span>of<span class="_"> </span>available<span class="_"> </span>virtual<span class="_"> </span>memory<span class="_ _3"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
