<div id="pf243" class="pf w2 h11" data-page-no="243"><div class="pc pc243 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg243.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">578<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1f h2d y4a2c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2 ls33">/<span class="_ _41"></span>*2x1<span class="_ _41"></span>a<span class="ls0">loop<span class="_ _1f"> </span>unrolling<span class="_ _e"> </span>*/</span></span></div><div class="t m5 x1f h2d y4a2d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>combine7(vec_ptr<span class="_ _e"> </span>v,<span class="_ _1f"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x1f h2d y4a2e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2e y4a2f ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x33 h2d y4a30 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>i;</div><div class="t m5 x1f h2d y4a31 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>length<span class="_ _1f"> </span>=<span class="_ _1f"> </span>vec_length(v);</span></div><div class="t m5 x1f h2d y4a32 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>limit<span class="_ _1f"> </span>=<span class="_ _1f"> </span>length-1;</span></div><div class="t m5 x1f h2d y4a33 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>*data<span class="_ _1f"> </span>=<span class="_ _1f"> </span>get_vec_start(v);</span></div><div class="t m5 x1f h2d y4a34 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>acc<span class="_ _1f"> </span>=<span class="_ _1f"> </span>IDENT;</span></div><div class="t m5 x1f h2e y4a35 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1b0 h2e y4a36 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x33 h2d y4a37 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Combine<span class="_ _1f"> </span>2<span class="_ _1f"> </span>elements<span class="_ _e"> </span>at<span class="_ _1f"> </span>a<span class="_ _e"> </span>time<span class="_ _1f"> </span>*/</div><div class="t m5 x1b0 h2d y4a38 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>limit;<span class="_ _1f"> </span>i+=2)<span class="_ _1f"> </span>{</span></div><div class="t m5 x1b0 h2d y4a39 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">acc<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc<span class="_ _1f"> </span>OP<span class="_ _e"> </span>(data[i]<span class="_ _1f"> </span>OP<span class="_ _e"> </span>data[i+1]);</span></div><div class="t m5 x1b0 h2d y4a3a ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2e y4a3b ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x1b0 h2e y4d14 ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x33 h2d y4a3c ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Finish<span class="_ _1f"> </span>any<span class="_ _1f"> </span>remaining<span class="_ _e"> </span>elements<span class="_ _1f"> </span>*/</div><div class="t m5 x1b0 h2d y4a3d ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(;<span class="_ _1f"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>length;<span class="_ _1f"> </span>i++)<span class="_ _e"> </span>{</span></div><div class="t m5 x1b0 h2d y4a3e ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _70"> </span><span class="ffd fs1e fc2">acc<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc<span class="_ _1f"> </span>OP<span class="_ _e"> </span>data[i];</span></div><div class="t m5 x1b0 h2d y4a3f ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d y4a40 ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc;</span></div><div class="t m5 x1b0 h2d y4a41 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1d h35 y4d15 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>5.26<span class="_ _c"> </span><span class="fc1">Applying<span class="_"> </span><span class="ff7">2<span class="_"> </span><span class="ff12">×<span class="_ _13"></span></span>1<span class="_ _1"></span><span class="ff11">a<span class="_"> </span><span class="ffe">unrolling.<span class="_"> </span><span class="ff6">By<span class="_ _10"> </span>reassociating<span class="_ _11"> </span>the<span class="_ _10"> </span>arithmetic,<span class="_ _11"> </span>this<span class="_ _10"> </span>approach</span></span></span></span></span></div><div class="t m5 x1d h34 y4d16 ff6 fs16 fc1 sc0 ls0 ws0">increases<span class="_ _10"> </span>the<span class="_ _11"> </span>number<span class="_ _10"> </span>of<span class="_ _10"> </span>operations<span class="_ _11"> </span>that<span class="_ _10"> </span>can<span class="_ _11"> </span>be<span class="_ _10"> </span>performed<span class="_ _11"> </span>in<span class="_ _10"> </span>parallel.</div><div class="t m5 x29 h46 ya89 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _23"> </span>integer<span class="_ _23"> </span>addition<span class="_ _23"> </span>case<span class="_ _22"> </span>matches<span class="_ _23"> </span>the<span class="_ _23"> </span>performance<span class="_ _23"> </span>of<span class="_ _23"> </span><span class="ff11">k<span class="_ _11"> </span><span class="ff12">×<span class="_ _11"> </span></span></span>1<span class="_ _1f"> </span>unrolling</div><div class="t m5 x1d h26 ya8a ff7 fs19 fc1 sc0 ls0 ws0">(<span class="ffd">combine5</span>),<span class="_ _16"> </span>while<span class="_ _16"> </span>the<span class="_ _14"> </span>other<span class="_ _16"> </span>three<span class="_ _16"> </span>cases<span class="_ _16"> </span>match<span class="_ _14"> </span>the<span class="_ _16"> </span>performance<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _16"> </span>versions</div><div class="t m5 x1d h46 ya8b ff7 fs19 fc1 sc0 ls0 ws0">with<span class="_ _6"> </span>parallel<span class="_ _13"> </span>accumulators<span class="_ _6"> </span>(<span class="ffd">combine6</span>),<span class="_ _13"> </span>doubling<span class="_ _6"> </span>the<span class="_ _13"> </span>performance<span class="_ _a"> </span>relative<span class="_ _13"> </span>to<span class="_ _6"> </span><span class="ff11">k<span class="_ _10"> </span><span class="ff12">×<span class="_ _13"></span></span></span>1</div><div class="t m5 x1d h26 ya8c ff7 fs19 fc1 sc0 ls0 ws0">unrolling.<span class="_ _16"> </span>T<span class="_ _1"></span>hese<span class="_ _14"> </span>cases<span class="_ _16"> </span>have<span class="_ _14"> </span>broken<span class="_ _16"> </span>through<span class="_ _16"> </span>the<span class="_ _14"> </span>barrier<span class="_ _16"> </span>imposed<span class="_ _14"> </span>by<span class="_ _16"> </span>the<span class="_ _14"> </span>latency</div><div class="t m5 x1d h26 ya8d ff7 fs19 fc1 sc0 ls0 ws0">bound.</div><div class="t m5 x29 h26 ya8e ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _16"> </span>5.27<span class="_ _16"> </span>illustrates<span class="_ _11"> </span>how<span class="_ _16"> </span>the<span class="_ _16"> </span>code<span class="_ _11"> </span>for<span class="_ _16"> </span>the<span class="_ _11"> </span>inner<span class="_ _16"> </span>loop<span class="_ _16"> </span>of<span class="_ _11"> </span><span class="ffd">combine7<span class="_ _16"> </span></span>(for<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 ya8f ff7 fs19 fc1 sc0 ls0 ws0">case<span class="_ _11"> </span>of<span class="_ _11"> </span>multiplication<span class="_ _16"> </span>as<span class="_"> </span>the<span class="_ _16"> </span>combining<span class="_ _11"> </span>operation<span class="_ _11"> </span>and<span class="_ _11"> </span><span class="ffd">double<span class="_ _16"> </span></span>as<span class="_ _11"> </span>data<span class="_ _11"> </span>type)<span class="_ _11"> </span>gets</div><div class="t m5 x1d h26 ya90 ff7 fs19 fc1 sc0 ls0 ws0">decoded<span class="_ _13"> </span>into<span class="_ _6"> </span>operations<span class="_ _13"> </span>and<span class="_ _13"> </span>the<span class="_ _6"> </span>resulting<span class="_ _13"> </span>data<span class="_ _13"> </span>dependencies<span class="_ _3"></span>.<span class="_ _13"> </span>W<span class="_ _3"></span>e<span class="_ _13"> </span>see<span class="_ _13"> </span>that<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ff6">load</span></div><div class="t m5 x1d h26 ya91 ff7 fs19 fc1 sc0 ls0 ws0">operations<span class="_ _13"> </span>resulting<span class="_ _13"> </span>from<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">vmovsd<span class="_ _13"> </span></span>and<span class="_ _13"> </span>the<span class="_ _13"> </span>ﬁrst<span class="_ _13"> </span><span class="ffd">vmulsd<span class="_ _13"> </span></span>instructions<span class="_ _13"> </span>load<span class="_ _13"> </span>vector</div><div class="t m5 x1d h46 ya92 ff7 fs19 fc1 sc0 ls0 ws0">elements<span class="_ _16"> </span><span class="ff11">i<span class="_ _15"> </span></span>and<span class="_ _16"> </span><span class="ff11">i<span class="_"> </span><span class="ff12">+<span class="_ _13"></span></span></span>1<span class="_ _11"> </span>from<span class="_ _16"> </span>memory<span class="_ _3"></span>,<span class="_ _14"> </span>and<span class="_ _16"> </span>the<span class="_ _14"> </span>ﬁrst<span class="_ _16"> </span><span class="ff6">mul<span class="_ _16"> </span></span>operation<span class="_ _16"> </span>multiplies<span class="_ _14"> </span>them</div><div class="t m5 x1d h26 ya93 ff7 fs19 fc1 sc0 ls0 ws0">together.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_"> </span>second<span class="_ _13"> </span><span class="ff6">mul<span class="_ _13"> </span></span>operation<span class="_"> </span>then<span class="_ _13"> </span>multiples<span class="_"> </span>this<span class="_ _13"> </span>result<span class="_ _13"> </span>by<span class="_"> </span>the<span class="_ _13"> </span>accumulated</div><div class="t m5 x1d h26 ya94 ff7 fs19 fc1 sc0 ls0 ws0">value<span class="_ _16"> </span><span class="ffd">acc</span>.<span class="_ _14"> </span>Figure<span class="_ _16"> </span>5.28(a)<span class="_ _14"> </span>shows<span class="_ _16"> </span>how<span class="_ _14"> </span>we<span class="_ _14"> </span>rearrange<span class="_ _0"></span>,<span class="_ _14"> </span>reﬁne,<span class="_ _14"> </span>and<span class="_ _16"> </span>abstract<span class="_ _14"> </span>the<span class="_ _14"> </span>op-</div><div class="t m5 x1d h26 ya95 ff7 fs19 fc1 sc0 ls0 ws0">erations<span class="_ _11"> </span>of<span class="_ _11"> </span>Figure<span class="_"> </span>5.27<span class="_ _11"> </span>to<span class="_ _16"> </span>get<span class="_ _11"> </span>a<span class="_ _11"> </span>template<span class="_ _11"> </span>representing<span class="_ _16"> </span>the<span class="_"> </span>data<span class="_ _16"> </span>dependencies<span class="_ _11"> </span>for</div><div class="t m5 x1d h26 ya96 ff7 fs19 fc1 sc0 ls0 ws0">one<span class="_ _13"> </span>iteration<span class="_ _13"> </span>(Figure<span class="_ _13"> </span>5.28(b)).<span class="_ _13"> </span>As<span class="_ _13"> </span>with<span class="_ _13"> </span>the<span class="_ _13"> </span>templates<span class="_"> </span>for<span class="_ _13"> </span><span class="ffd">combine5<span class="_ _13"> </span></span>and<span class="_ _13"> </span><span class="ffd">combine7</span>,</div><div class="t m5 x1d h26 ya97 ff7 fs19 fc1 sc0 ls0 ws0">we<span class="_ _16"> </span>have<span class="_ _14"> </span>two<span class="_ _14"> </span><span class="ff6">load<span class="_ _16"> </span></span>and<span class="_ _14"> </span>two<span class="_ _14"> </span><span class="ff6">mul<span class="_ _14"> </span></span>operations<span class="_ _1"></span>,<span class="_ _14"> </span>but<span class="_ _14"> </span>only<span class="_ _14"> </span>one<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ff6">mul<span class="_ _16"> </span></span>operations</div><div class="t m5 x1d h26 ya98 ff7 fs19 fc1 sc0 ls0 ws0">forms<span class="_ _16"> </span>a<span class="_ _11"> </span>data-dependency<span class="_ _11"> </span>chain<span class="_ _16"> </span>between<span class="_ _16"> </span>loop<span class="_ _11"> </span>registers<span class="_ _1"></span>.<span class="_ _16"> </span>When<span class="_ _11"> </span>we<span class="_ _16"> </span>then<span class="_ _16"> </span>replicate</div><div class="t m5 x1d h26 ya99 ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_ _13"> </span>template<span class="_ _13"> </span><span class="ff11">n/</span>2<span class="_ _13"> </span>times<span class="_ _13"> </span>to<span class="_"> </span>show<span class="_ _13"> </span>the<span class="_ _13"> </span>computations<span class="_ _13"> </span>performed<span class="_ _13"> </span>in<span class="_ _13"> </span>multiplying<span class="_ _13"> </span><span class="ff11">n<span class="_ _13"> </span></span>vec-</div><div class="t m5 x1d h26 ya9a ff7 fs19 fc1 sc0 ls0 ws0">tor<span class="_ _14"> </span>elements<span class="_ _14"> </span>(Figure<span class="_ _16"> </span>5.29),<span class="_ _21"> </span>we<span class="_ _14"> </span>see<span class="_ _14"> </span>that<span class="_ _15"> </span>we<span class="_ _14"> </span>only<span class="_ _14"> </span>have<span class="_ _15"> </span><span class="ff11">n/</span>2<span class="_ _14"> </span>operations<span class="_ _15"> </span>along<span class="_ _14"> </span>the</div><div class="t m5 x1d h26 ya9b ff7 fs19 fc1 sc0 ls0 ws0">critical<span class="_ _13"> </span>path.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>ﬁrst<span class="_ _13"> </span>multiplication<span class="_ _13"> </span>within<span class="_"> </span>each<span class="_ _13"> </span>iteration<span class="_"> </span>can<span class="_ _13"> </span>be<span class="_ _13"> </span>performed<span class="_"> </span>with-</div><div class="t m5 x1d h26 ya9c ff7 fs19 fc1 sc0 ls0 ws0">out<span class="_ _6"> </span>waiting<span class="_ _13"> </span>for<span class="_ _a"> </span>the<span class="_ _13"> </span>accumulated<span class="_ _6"> </span>value<span class="_ _6"> </span>from<span class="_ _13"> </span>the<span class="_ _a"> </span>previous<span class="_ _13"> </span>iteration.<span class="_ _6"> </span>T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_ _13"> </span>we<span class="_ _6"> </span>reduce</div><div class="t m5 x1d h26 ya9d ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>minimum<span class="_"> </span>possible<span class="_"> </span>CPE<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>factor<span class="_"> </span>of<span class="_"> </span>around<span class="_"> </span>2.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
