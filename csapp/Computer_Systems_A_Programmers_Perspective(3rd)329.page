<div id="pf149" class="pf w2 h11" data-page-no="149"><div class="pc pc149 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg149.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">328<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x14 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>3.44</div><div class="t m5 x14 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Stack<span class="_ _16"> </span>frame<span class="_ _14"> </span>structure</div><div class="t m5 x14 h2f y58b ffe fs16 fc1 sc0 ls0 ws0">for<span class="_ _14"> </span>function</div><div class="t m5 x239 h3a y609 ffd fs19 fc1 sc0 ls0 ws0">vframe<span class="ffe fs16">.</span></div><div class="t m5 x14 h34 y60a ff6 fs16 fc1 sc0 ls0 ws0">The<span class="_ _11"> </span>function<span class="_ _11"> </span>uses<span class="_ _11"> </span>register</div><div class="t m5 x14 h3a y1323 ffd fs19 fc1 sc0 ls0 ws0">%rbp<span class="_ _11"> </span><span class="ff6 fs16">as<span class="_ _16"> </span>a<span class="_ _16"> </span>frame<span class="_ _11"> </span>pointer<span class="_ _1"></span>.</span></div><div class="t m5 x14 h34 y1324 ff6 fs16 fc1 sc0 ls0 ws0">The<span class="_ _16"> </span>annotations<span class="_ _14"> </span>along</div><div class="t m5 x14 h34 y1325 ff6 fs16 fc1 sc0 ls0 ws0">the<span class="_ _16"> </span>right-hand<span class="_ _14"> </span>side<span class="_ _16"> </span>are</div><div class="t m5 x14 h34 y1326 ff6 fs16 fc1 sc0 ls0 ws0">in<span class="_ _16"> </span>reference<span class="_ _16"> </span>to<span class="_ _14"> </span>Practice</div><div class="t m5 x14 h34 y2ed2 ff6 fs16 fc1 sc0 ls0 ws0">Problem<span class="_ _10"> </span>3.49.</div><div class="t m5 x167 h3f y2ed3 ff30 fs27 fc1 sc0 ls0 ws0">8<span class="ff1f">n</span> bytes</div><div class="t m5 x1c8 h3f y2ed4 ff30 fs27 fc1 sc0 ls0 ws0">8</div><div class="t m5 x1c8 h3f y2ed5 ff30 fs27 fc1 sc0 ls0 ws0">0</div><div class="t m5 x68 h3f y2ed6 ff30 fs27 fc1 sc0 ls0 ws0">–8</div><div class="t m5 x9f h3f y2ed7 ff30 fs27 fc1 sc0 ls0 ws0">–16</div><div class="t m5 x215 h3f y2ed8 ff30 fs27 fc1 sc0 ls0 ws0">(Unused)</div><div class="t m5 x184 h3f y2ed9 ff30 fs27 fc1 sc0 ls0 ws0">Return address</div><div class="t m5 xd2 h3f y2eda ff30 fs27 fc1 sc0 ls0 ws0">Saved </div><div class="t m5 x1e2 h40 y2edb ff31 fs28 fc1 sc0 ls0 ws0">%rbp</div><div class="t m5 x199 h40 y2edc ff31 fs28 fc1 sc0 ls0 ws0">i</div><div class="t m5 x199 h40 y2edd ff31 fs28 fc1 sc0 ls0 ws0">p</div><div class="t m5 xc1 h3f y2ede ff30 fs27 fc1 sc0 ls0 ws0">Stack pointer</div><div class="t m5 xab h40 y2edf ff31 fs28 fc1 sc0 ls0 ws0">%rsp</div><div class="t m5 xe0 h3f y2ee0 ff30 fs27 fc1 sc0 ls0 ws0">Frame pointer</div><div class="t m5 x89 h40 y2ee1 ff31 fs28 fc1 sc0 ls0 ws0">%rbp</div><div class="t m5 x2b h3f y2ee2 ff1f fs27 fc1 sc0 ls0 ws0">e</div><div class="t m5 x144 h59 y2ee3 ff30 fs33 fc1 sc0 ls0 ws0">2</div><div class="t m5 x2b h3f y2ee4 ff1f fs27 fc1 sc0 ls0 ws0">e</div><div class="t m5 x144 h59 y2ee5 ff30 fs33 fc1 sc0 ls0 ws0">1</div><div class="t m5 x196 h3f y2ee6 ff1f fs27 fc1 sc0 ls0 ws0">p</div><div class="t m5 x196 h3f y2ee7 ff1f fs27 fc1 sc0 ls0 ws0">s</div><div class="t m5 x166 h59 y2ee8 ff30 fs33 fc1 sc0 ls0 ws0">2</div><div class="t m5 x196 h3f y2ee9 ff1f fs27 fc1 sc0 ls0 ws0">s</div><div class="t m5 x166 h59 y2eea ff30 fs33 fc1 sc0 ls0 ws0">1</div><div class="t m5 x29 h26 y2eeb ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>3.43(b)<span class="_"> </span>shows<span class="_ _13"> </span>portions<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>code<span class="_"> </span><span class="ff9">gcc<span class="_ _13"> </span></span>generates<span class="_"> </span>for<span class="_"> </span>function<span class="_ _13"> </span><span class="ffd">vframe</span>.</div><div class="t m5 x1d h26 y2eec ff7 fs19 fc1 sc0 ls0 ws0">At<span class="_ _16"> </span>the<span class="_ _16"> </span>beginning<span class="_ _14"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>function,<span class="_ _14"> </span>we<span class="_ _16"> </span>see<span class="_ _14"> </span>code<span class="_ _16"> </span>that<span class="_ _16"> </span>sets<span class="_ _14"> </span>up<span class="_ _16"> </span>the<span class="_ _14"> </span>stack<span class="_ _16"> </span>frame<span class="_ _16"> </span>and</div><div class="t m5 x1d h26 y2eed ff7 fs19 fc1 sc0 ls0 ws0">allocates<span class="_ _11"> </span>space<span class="_ _11"> </span>for<span class="_ _11"> </span>array<span class="_ _11"> </span><span class="ffd">p</span>.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_ _11"> </span>code<span class="_ _11"> </span>starts<span class="_ _11"> </span>by<span class="_ _11"> </span>pushing<span class="_ _11"> </span>the<span class="_ _11"> </span>current<span class="_ _11"> </span>value<span class="_ _11"> </span>of<span class="_ _11"> </span><span class="ffd">%rbp</span></div><div class="t m5 x1d h26 y2eee ff7 fs19 fc1 sc0 ls0 ws0">onto<span class="_"> </span>the<span class="_"> </span>stack<span class="_"> </span>and<span class="_"> </span>setting<span class="_"> </span><span class="ffd">%rbp<span class="_ _10"> </span></span>to<span class="_"> </span>point<span class="_"> </span>to<span class="_"> </span>this<span class="_"> </span>stack<span class="_"> </span>position<span class="_"> </span>(lines<span class="_"> </span>2–3).<span class="_"> </span>Next,<span class="_"> </span>it</div><div class="t m5 x1d h26 y2eef ff7 fs19 fc1 sc0 ls0 ws0">allocates<span class="_"> </span>16<span class="_ _13"> </span>bytes<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>stack,<span class="_ _13"> </span>the<span class="_"> </span>ﬁrst<span class="_"> </span>8<span class="_ _13"> </span>of<span class="_"> </span>which<span class="_"> </span>are<span class="_ _13"> </span>used<span class="_"> </span>to<span class="_"> </span>store<span class="_"> </span>local<span class="_ _13"> </span>variable</div><div class="t m5 x1d h26 y2ef0 ffd fs19 fc1 sc0 ls0 ws0">i<span class="ff7">,<span class="_"> </span>and<span class="_"> </span>the<span class="_ _13"> </span>second<span class="_"> </span>8<span class="_"> </span>of<span class="_"> </span>which<span class="_"> </span>are<span class="_ _13"> </span>unused.<span class="_"> </span>T<span class="_ _0"></span>hen<span class="_"> </span>it<span class="_"> </span>allocates<span class="_ _13"> </span>space<span class="_"> </span>for<span class="_"> </span>array<span class="_"> </span><span class="ffd">p<span class="_ _10"> </span></span>(lines</span></div><div class="t m5 x1d h26 y2ef1 ff7 fs19 fc1 sc0 ls0 ws0">5–11).<span class="_"> </span>The<span class="_"> </span>details<span class="_"> </span>of<span class="_"> </span>how<span class="_ _11"> </span>much<span class="_ _11"> </span>space<span class="_"> </span>it<span class="_ _11"> </span>allocates<span class="_"> </span>and<span class="_ _11"> </span>where<span class="_ _11"> </span>it<span class="_"> </span>positions<span class="_ _11"> </span><span class="ffd">p<span class="_ _11"> </span></span>within</div><div class="t m5 x1d h26 y2ef2 ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>space<span class="_"> </span>are<span class="_"> </span>explored<span class="_ _13"> </span>in<span class="_"> </span>Practice<span class="_"> </span>Problem<span class="_"> </span>3.49.<span class="_"> </span>Sufﬁce<span class="_"> </span>it<span class="_ _13"> </span>to<span class="_"> </span>say<span class="_"> </span>that<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>time</div><div class="t m5 x1d h26 y2ef3 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>program<span class="_ _13"> </span>reaches<span class="_"> </span>line<span class="_"> </span>11,<span class="_"> </span>it<span class="_ _13"> </span>has<span class="_"> </span>(1)<span class="_"> </span>allocated<span class="_"> </span>at<span class="_ _13"> </span>least<span class="_"> </span>8<span class="ff11">n<span class="_ _10"> </span></span>bytes<span class="_ _13"> </span>on<span class="_"> </span>the<span class="_"> </span>stack<span class="_"> </span>and</div><div class="t m5 x1d h26 y2ef4 ff7 fs19 fc1 sc0 ls0 ws0">(2)<span class="_ _11"> </span>positioned<span class="_ _16"> </span>array<span class="_ _11"> </span><span class="ffd">p<span class="_ _16"> </span></span>within<span class="_ _11"> </span>the<span class="_ _16"> </span>allocated<span class="_ _11"> </span>region<span class="_ _16"> </span>such<span class="_ _11"> </span>that<span class="_ _11"> </span>at<span class="_ _16"> </span>least<span class="_ _11"> </span>8<span class="ff11">n<span class="_"> </span></span>bytes<span class="_"> </span>are</div><div class="t m5 x1d h26 y2ef5 ff7 fs19 fc1 sc0 ls0 ws0">available<span class="_"> </span>for<span class="_"> </span>its<span class="_"> </span>use<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2ef6 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>code<span class="_ _15"> </span>for<span class="_ _14"> </span>the<span class="_ _14"> </span>initialization<span class="_ _14"> </span>loop<span class="_ _14"> </span>shows<span class="_ _15"> </span>examples<span class="_ _14"> </span>of<span class="_ _14"> </span>how<span class="_ _14"> </span>local<span class="_ _15"> </span>variables</div><div class="t m5 x1d h26 y2ef7 ffd fs19 fc1 sc0 ls0 ws0">i<span class="_ _14"> </span><span class="ff7">and<span class="_ _14"> </span></span>p<span class="_ _14"> </span><span class="ff7">are<span class="_ _14"> </span>referenced.<span class="_ _14"> </span>Line<span class="_ _14"> </span>13<span class="_ _14"> </span>shows<span class="_ _14"> </span>array<span class="_ _15"> </span>element<span class="_ _14"> </span></span>p[i]<span class="_ _14"> </span><span class="ff7">being<span class="_ _14"> </span>set<span class="_ _14"> </span>to<span class="_ _14"> </span></span>q<span class="ff7">.<span class="_ _14"> </span>T<span class="_ _0"></span>his</span></div><div class="t m5 x1d h26 y2ef8 ff7 fs19 fc1 sc0 ls0 ws0">instruction<span class="_"> </span>uses<span class="_ _13"> </span>the<span class="_"> </span>value<span class="_ _13"> </span>in<span class="_"> </span>register<span class="_ _13"> </span><span class="ffd">%rcx<span class="_ _10"> </span></span>as<span class="_ _13"> </span>the<span class="_"> </span>address<span class="_ _13"> </span>for<span class="_"> </span>the<span class="_ _13"> </span>start<span class="_"> </span>of<span class="_ _13"> </span><span class="ffd">p</span><span class="ls185">.W<span class="_ _49"></span>ec<span class="_ _4a"></span>a<span class="_ _80"></span>n</span></div><div class="t m5 x1d h26 y2ef9 ff7 fs19 fc1 sc0 ls0 ws0">see<span class="_ _16"> </span>instances<span class="_ _11"> </span>where<span class="_ _16"> </span>local<span class="_ _16"> </span>variable<span class="_ _11"> </span><span class="ffd">i<span class="_ _16"> </span></span>is<span class="_ _11"> </span>updated<span class="_ _16"> </span>(line<span class="_ _16"> </span>15)<span class="_ _11"> </span>and<span class="_ _16"> </span>read<span class="_ _16"> </span>(line<span class="_ _11"> </span>17).<span class="_ _16"> </span>T<span class="_ _0"></span>he</div><div class="t m5 x1d h46 y2efa ff7 fs19 fc1 sc0 ls0 ws0">address<span class="_ _11"> </span>of<span class="_ _11"> </span><span class="ffd">i<span class="_ _16"> </span></span>is<span class="_ _11"> </span>given<span class="_ _11"> </span>by<span class="_ _16"> </span>reference<span class="_ _11"> </span><span class="ffd">-8(%rbp)</span>—that<span class="_ _11"> </span>is<span class="_ _1"></span>,<span class="_ _16"> </span>at<span class="_ _11"> </span>offset<span class="_ _16"> </span><span class="ff12">−</span>8<span class="_"> </span>relative<span class="_ _16"> </span>to<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y2efb ff7 fs19 fc1 sc0 ls0 ws0">frame<span class="_"> </span>pointer.</div><div class="t m5 x29 h26 y2efc ff7 fs19 fc1 sc0 ls0 ws0">At<span class="_"> </span>the<span class="_"> </span>end<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>function,<span class="_"> </span>the<span class="_"> </span>frame<span class="_ _13"> </span>pointer<span class="_"> </span>is<span class="_"> </span>restored<span class="_"> </span>to<span class="_ _13"> </span>its<span class="_"> </span>previous<span class="_"> </span>value</div><div class="t m5 x1d h26 y2efd ff7 fs19 fc1 sc0 ls0 ws0">using<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">leave<span class="_ _14"> </span></span>instruction<span class="_ _14"> </span>(line<span class="_ _14"> </span>20).<span class="_ _14"> </span>T<span class="_ _1"></span>his<span class="_ _15"> </span>instruction<span class="_ _14"> </span>takes<span class="_ _14"> </span>no<span class="_ _14"> </span>arguments<span class="_ _1"></span>.<span class="_ _14"> </span>It<span class="_ _14"> </span>is</div><div class="t m5 x1d h26 y2efe ff7 fs19 fc1 sc0 ls0 ws0">equivalent<span class="_"> </span>to<span class="_"> </span>executing<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>two<span class="_"> </span>instructions:</div><div class="t m5 xa4 h2d y2eff ffd fs1e fc2 sc0 ls0 ws0">movq<span class="_ _e"> </span>%rbp,<span class="_ _1f"> </span>%rsp<span class="_ _46"> </span><span class="ff13 fs35 fc6">Set<span class="_ _f"> </span>stack<span class="_ _f"> </span>pointer<span class="_ _e"> </span>to<span class="_ _21"> </span>beginning<span class="_ _f"> </span>of<span class="_ _e"> </span>frame</span></div><div class="t m5 xa4 h2d y2f00 ffd fs1e fc2 sc0 ls0 ws0">popq<span class="_ _e"> </span>%rbp<span class="_ _86"> </span><span class="ff13 fs35 fc6">Restore<span class="_ _e"> </span>saved<span class="_ _21"> </span>%rbp<span class="_ _f"> </span>and<span class="_ _e"> </span>set<span class="_ _21"> </span>stack<span class="_ _f"> </span>ptr</span></div><div class="t m5 x136 h61 y2f01 ff13 fs35 fc6 sc0 ls0 ws0">to<span class="_ _f"> </span>end<span class="_ _f"> </span>of<span class="_ _f"> </span>caller’s<span class="_ _e"> </span>frame</div><div class="t m5 x1d h26 y8d6 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hat<span class="_"> </span>is<span class="_ _1"></span>,<span class="_"> </span>the<span class="_ _13"> </span>stack<span class="_"> </span>pointer<span class="_ _13"> </span>is<span class="_"> </span>ﬁrst<span class="_"> </span>set<span class="_ _13"> </span>to<span class="_"> </span>the<span class="_ _13"> </span>position<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>saved<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_"> </span><span class="ffd">%rbp</span>,<span class="_ _13"> </span>and</div><div class="t m5 x1d h26 y8d7 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_"> </span>this<span class="_ _11"> </span>value<span class="_ _11"> </span>is<span class="_ _11"> </span>popped<span class="_ _11"> </span>from<span class="_ _11"> </span>the<span class="_"> </span>stack<span class="_ _11"> </span>into<span class="_ _11"> </span><span class="ffd">%rbp</span>.<span class="_ _11"> </span>T<span class="_ _1"></span>his<span class="_ _11"> </span>instruction<span class="_ _11"> </span>combination</div><div class="t m5 x1d h26 y8d8 ff7 fs19 fc2 sc0 ls0 ws0">has<span class="_"> </span>the<span class="_"> </span>effect<span class="_"> </span>of<span class="_"> </span>deallocating<span class="_"> </span>the<span class="_"> </span>entire<span class="_"> </span>stack<span class="_"> </span>frame<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
