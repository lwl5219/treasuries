<div id="pf2ec" class="pf w2 h11" data-page-no="2ec"><div class="pc pc2ec w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2ec.png"/><div class="t m5 x175 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>7.13<span class="_ _60"> </span>Librar<span class="_ _2"></span>y<span class="_ _10"> </span>Interpositioning<span class="_ _1b"> </span><span class="ffe fs1e">747</span></div><div class="t m5 x26 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">If<span class="_ _f"> </span>the<span class="_ _e"> </span><span class="ffd">LD_PRELOAD<span class="_ _f"> </span></span>environment<span class="_ _e"> </span>variable<span class="_ _f"> </span>is<span class="_ _e"> </span>set<span class="_ _21"> </span>to<span class="_ _e"> </span>a<span class="_ _f"> </span>list<span class="_ _e"> </span>of<span class="_ _f"> </span>shared<span class="_ _e"> </span>library</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">pathnames<span class="_ _16"> </span>(separated<span class="_ _14"> </span>by<span class="_ _14"> </span>spaces<span class="_ _16"> </span>or<span class="_ _14"> </span>colons),<span class="_ _14"> </span>then<span class="_ _14"> </span>when<span class="_ _14"> </span>you<span class="_ _16"> </span>load<span class="_ _14"> </span>and<span class="_ _14"> </span>execute<span class="_ _16"> </span>a</div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">program,<span class="_ _16"> </span>the<span class="_ _11"> </span>dynamic<span class="_ _16"> </span>linker<span class="_ _11"> </span>(<span class="ff9">ld-linux.so</span>)<span class="_ _11"> </span>will<span class="_ _16"> </span>search<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffd">LD_PRELOAD<span class="_ _11"> </span></span>libraries</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">ﬁrst,<span class="_ _13"> </span>before<span class="_ _6"> </span>any<span class="_ _13"> </span>other<span class="_ _6"> </span>shared<span class="_ _6"> </span>libraries<span class="_ _1"></span>,<span class="_ _13"> </span>when<span class="_ _13"> </span>it<span class="_ _6"> </span>resolves<span class="_ _6"> </span>undeﬁned<span class="_ _13"> </span>references<span class="_ _3"></span>.<span class="_ _13"> </span>W<span class="_ _1"></span>ith</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">this<span class="_ _13"> </span>mechanism,<span class="_ _13"> </span>you<span class="_ _13"> </span>can<span class="_ _13"> </span>interpose<span class="_ _6"> </span>on<span class="_ _13"> </span>any<span class="_ _13"> </span>function<span class="_ _13"> </span>in<span class="_ _13"> </span>any<span class="_ _13"> </span>shared<span class="_ _6"> </span>library<span class="_ _3"></span>,<span class="_ _13"> </span>including</div><div class="t m5 x17 h26 y2f9 ffd fs19 fc2 sc0 ls0 ws0">libc.so<span class="ff7">,<span class="_"> </span>when<span class="_"> </span>you<span class="_"> </span>load<span class="_"> </span>and<span class="_"> </span>execute<span class="_"> </span>any<span class="_"> </span>executable<span class="_ _1"></span>.</span></div><div class="t m5 x26 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _14"> </span>7.22<span class="_ _16"> </span>shows<span class="_ _16"> </span>the<span class="_ _16"> </span>wrappers<span class="_ _14"> </span>for<span class="_ _16"> </span><span class="ffd">malloc<span class="_ _16"> </span></span>and<span class="_ _16"> </span><span class="ffd">free</span>.<span class="_ _16"> </span>In<span class="_ _14"> </span>each<span class="_ _16"> </span>wrapper,<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">call<span class="_ _16"> </span>to<span class="_ _16"> </span><span class="ffd">dlsym<span class="_ _16"> </span></span>returns<span class="_ _16"> </span>the<span class="_ _16"> </span>pointer<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>target<span class="_ _16"> </span><span class="ffd">libc<span class="_ _16"> </span></span>function.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>wrapper<span class="_ _16"> </span>then</div><div class="t m5 x17 h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">calls<span class="_"> </span>the<span class="_"> </span>target<span class="_"> </span>function,<span class="_"> </span>prints<span class="_"> </span>a<span class="_"> </span>trace<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>returns<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">Here<span class="_"> </span>is<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>build<span class="_"> </span>the<span class="_"> </span>shared<span class="_"> </span>library<span class="_"> </span>that<span class="_"> </span>contains<span class="_"> </span>the<span class="_"> </span>wrapper<span class="_"> </span>functions:</div><div class="t m5 x17 h2d y62a5 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-DRUNTIME<span class="_ _1f"> </span>-shared<span class="_ _e"> </span>-fpic<span class="_ _1f"> </span>-o<span class="_ _e"> </span>mymalloc.so<span class="_ _1f"> </span>mymalloc.c<span class="_ _1f"> </span>-ldl</span></div><div class="t m5 x17 h26 y62a6 ff7 fs19 fc2 sc0 ls0 ws0">Here<span class="_"> </span>is<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>compile<span class="_"> </span>the<span class="_"> </span>main<span class="_"> </span>program:</div><div class="t m5 x17 h2d y62a7 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">gcc<span class="_ _1f"> </span>-o<span class="_ _1f"> </span>intr<span class="_ _e"> </span>int.c</span></div><div class="t m5 x17 h26 y62a8 ff7 fs19 fc2 sc0 ls0 ws0">Here<span class="_"> </span>is<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>run<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span><span class="ffd">bash<span class="_ _10"> </span></span>shell:</div><div class="t m5 x1ae h3c y62a9 ff7 fs25 fc2 sc0 ls0 ws0">3</div><div class="t m5 x17 h2d y62aa ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">LD_PRELOAD=&quot;./mymalloc.so&quot;<span class="_ _1f"> </span>./intr</span></div><div class="t m5 x17 h2d y62ab ffd fs1e fc2 sc0 ls0 ws0">malloc(32)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x1bf7010</div><div class="t m5 x17 h2d y62ac ffd fs1e fc2 sc0 ls0 ws0">free(0x1bf7010)</div><div class="t m5 x17 h26 y62ad ff7 fs19 fc2 sc0 ls0 ws0">And<span class="_"> </span>here<span class="_"> </span>is<span class="_"> </span>how<span class="_"> </span>to<span class="_"> </span>run<span class="_"> </span>it<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span><span class="ffd">csh<span class="_ _10"> </span></span>or<span class="_"> </span><span class="ffd">tcsh<span class="_ _10"> </span></span>shells:</div><div class="t m5 x17 h2d y62ae ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">(setenv<span class="_ _1f"> </span>LD_PRELOAD<span class="_ _1f"> </span>&quot;./mymalloc.so&quot;;<span class="_ _e"> </span>./intr;<span class="_ _1f"> </span>unsetenv<span class="_ _e"> </span>LD_PRELOAD)</span></div><div class="t m5 x17 h2d y62af ffd fs1e fc2 sc0 ls0 ws0">malloc(32)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x2157010</div><div class="t m5 x17 h2d y62b0 ffd fs1e fc2 sc0 ls0 ws0">free(0x2157010)</div><div class="t m5 x26 h26 y62b1 ff7 fs19 fc2 sc0 ls0 ws0">Notice<span class="_ _11"> </span>that<span class="_ _16"> </span>you<span class="_ _16"> </span>can<span class="_ _11"> </span>use<span class="_ _16"> </span><span class="ffd">LD_PRELOAD<span class="_ _16"> </span></span>to<span class="_ _11"> </span>interpose<span class="_ _16"> </span>on<span class="_ _16"> </span>the<span class="_ _11"> </span>library<span class="_ _16"> </span>calls<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffa">any</span></div><div class="t m5 x17 h26 y62b2 ff7 fs19 fc2 sc0 ls0 ws0">executable<span class="_"> </span>program!</div><div class="t m5 x17 h2d y62b3 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">LD_PRELOAD=&quot;./mymalloc.so&quot;<span class="_ _1f"> </span>/usr/bin/uptime</span></div><div class="t m5 x17 h2d y62b4 ffd fs1e fc2 sc0 ls0 ws0">malloc(568)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb010</div><div class="t m5 x17 h2d y62b5 ffd fs1e fc2 sc0 ls0 ws0">free(0x21bb010)</div><div class="t m5 x17 h2d y62b6 ffd fs1e fc2 sc0 ls0 ws0">malloc(15)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb010</div><div class="t m5 x17 h2d y62b7 ffd fs1e fc2 sc0 ls0 ws0">malloc(568)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb030</div><div class="t m5 x17 h2d y62b8 ffd fs1e fc2 sc0 ls0 ws0">malloc(2255)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb270</div><div class="t m5 x17 h2d y62b9 ffd fs1e fc2 sc0 ls0 ws0">free(0x21bb030)</div><div class="t m5 x17 h2d y62ba ffd fs1e fc2 sc0 ls0 ws0">malloc(20)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb030</div><div class="t m5 x17 h2d y62bb ffd fs1e fc2 sc0 ls0 ws0">malloc(20)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb050</div><div class="t m5 x17 h2d y62bc ffd fs1e fc2 sc0 ls0 ws0">malloc(20)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb070</div><div class="t m5 x17 h2d y62bd ffd fs1e fc2 sc0 ls0 ws0">malloc(20)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb090</div><div class="t m5 x17 h2d y62be ffd fs1e fc2 sc0 ls0 ws0">malloc(20)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb0b0</div><div class="t m5 x17 h2d y62bf ffd fs1e fc2 sc0 ls0 ws0">malloc(384)<span class="_ _e"> </span>=<span class="_ _1f"> </span>0x21bb0d0</div><div class="t m5 x52 h2d y62c0 ffd fs1e fc2 sc0 ls0 ws0">20:47:36<span class="_ _e"> </span>up<span class="_ _1f"> </span>85<span class="_ _1f"> </span>days,<span class="_ _3b"> </span>6:04,<span class="_ _1a"> </span>1<span class="_ _1f"> </span>user,<span class="_ _1a"> </span>load<span class="_ _1f"> </span>average:<span class="_ _e"> </span>0.10,<span class="_ _1f"> </span>0.04,<span class="_ _e"> </span>0.05</div><div class="t m5 x17 h1d y1152 ff7 fs17 fc2 sc0 ls0 ws0">3.<span class="_"> </span>If<span class="_"> </span>you<span class="_"> </span>don’t<span class="_"> </span>know<span class="_"> </span>what<span class="_"> </span>shell<span class="_"> </span>you<span class="_"> </span>are<span class="_"> </span>running<span class="_ _0"></span>,<span class="_"> </span>type<span class="_"> </span><span class="ffd fs35">printenv<span class="_ _10"> </span>SHELL<span class="_ _13"> </span></span>at<span class="_"> </span>the<span class="_"> </span>command<span class="_"> </span>line<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
