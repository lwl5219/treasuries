<div id="pf36a" class="pf w2 h11" data-page-no="36a"><div class="pc pc36a w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg36a.png"/><div class="t m5 xa9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>9.8<span class="_ _60"> </span>Memor<span class="_ _2"></span>y<span class="_ _10"> </span>Mapping<span class="_ _1b"> </span><span class="ffe fs1e">873</span></div><div class="t m5 x17 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.31</div><div class="t m5 x17 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">How<span class="_"> </span>the<span class="_"> </span>loader<span class="_"> </span>maps<span class="_"> </span>the</div><div class="t m5 x17 h2f y58b ffe fs16 fc1 sc0 ls0 ws0">areas<span class="_"> </span>of<span class="_"> </span>the<span class="_ _11"> </span>user<span class="_ _11"> </span>address</div><div class="t m5 x17 h2f y58c ffe fs16 fc1 sc0 ls0 ws0">space.</div><div class="t m5 x121 h3f y7134 ffbf fs27 fc1 sc0 ls2ae wsa">Memor<span class="_ _2"></span>y-mapped re<span class="_ _2"></span>gion</div><div class="t m5 x139 h3f y7135 ffbf fs27 fc1 sc0 ls2af ws11">for shared librar<span class="_ _2"></span>ies</div><div class="t m5 xbf h3f y7136 ffbf fs27 fc1 sc0 ls2b0 ws12">User<span class="_ _1"></span> stack</div><div class="t m5 x69 h40 y7137 ffc0 fs28 fc1 sc0 ls0 ws0">0</div><div class="t m5 x198 h3f y7138 ffbf fs27 fc1 sc0 ls2b1 ws13">Run-time<span class="_ _2"></span> heap (via <span class="ffc0 ls2b2 ws0">malloc<span class="ffbf ls0">)</span></span></div><div class="t m5 x1b3 h3f y7139 ffbf fs27 fc1 sc0 ls2b3 ws14">Uninitialized data (</div><div class="t m5 x3a h40 y713a ffc0 fs28 fc1 sc0 ls2b4 ws0">.bss<span class="ffbf fs27 ls0">)</span></div><div class="t m5 x184 h3f y713b ffbf fs27 fc1 sc0 ls2b5 ws15">Initialized data (</div><div class="t m5 x19c h40 y713c ffc0 fs28 fc1 sc0 ls2b6 ws0">.data<span class="ffbf fs27 ls0">)</span></div><div class="t m5 x39 h3f y713d ffbf fs27 fc1 sc0 ls2b7 ws16">Code (</div><div class="t m5 x1c2 h40 y713e ffc0 fs28 fc1 sc0 ls2b8 ws0">.te<span class="_ _0"></span>xt<span class="_ _0"></span><span class="ffbf fs27 ls0">)</span></div><div class="t m5 x1bd h3f y713f ffba fs27 fc1 sc0 ls2b7 ws17">Pri<span class="_ _2"></span>v<span class="_ _0"></span>ate, demand<span class="_ _2"></span>-zer</div><div class="c xb3 y7140 w32 h10d"><div class="t m5 x18d h3f y7141 ffba fs27 fc1 sc0 ls0 ws0">o</div></div><div class="t m5 xae h3f y7142 ffba fs27 fc1 sc0 ls2b9 ws18">Shared, fi<span class="_ _2"></span>le-backed</div><div class="t m5 x1bd h3f y7143 ffba fs27 fc1 sc0 ls2b7 ws17">Pri<span class="_ _2"></span>v<span class="_ _0"></span>ate, demand<span class="_ _2"></span>-zer</div><div class="c xb3 y7140 w32 h10d"><div class="t m5 x18d h3f y7144 ffba fs27 fc1 sc0 ls0 ws0">o</div></div><div class="t m5 x1bd h3f y7145 ffba fs27 fc1 sc0 ls2b7 ws17">Pri<span class="_ _2"></span>v<span class="_ _0"></span>ate, demand<span class="_ _2"></span>-zer</div><div class="c xb3 y7140 w32 h10d"><div class="t m5 x18d h3f y7146 ffba fs27 fc1 sc0 ls0 ws0">o</div></div><div class="t m5 x1bd h3f y7147 ffba fs27 fc1 sc0 ls2ba ws19">Pri<span class="_ _2"></span>v<span class="_ _0"></span>ate, file-backed</div><div class="t m5 x183 h40 y7148 ffc0 fs28 fc1 sc0 ls2bb ws0">.data</div><div class="t m5 x183 h40 y7149 ffc0 fs28 fc1 sc0 ls2bc ws0">.text</div><div class="t m5 xb7 h3f y714a ffc1 fs27 fc1 sc0 ls2bd ws0">libc.so</div><div class="t m5 x183 h40 y714b ffc0 fs28 fc1 sc0 ls2bb ws0">.data</div><div class="t m5 x183 h40 y714c ffc0 fs28 fc1 sc0 ls2bc ws0">.text</div><div class="t m5 x47 h3f y714d ffc1 fs27 fc1 sc0 ls2be ws0">a.out</div><div class="t m5 x1cd h26 y714e ffc fs19 fc1 sc0 ls0 ws0">1.<span class="_ _e"> </span><span class="ffa">Delete<span class="_ _11"> </span>existing<span class="_ _11"> </span>user<span class="_ _11"> </span>areas<span class="_ _1"></span>.<span class="_ _13"> </span><span class="ff7">Delete<span class="_ _11"> </span>the<span class="_"> </span>existing<span class="_ _11"> </span>area<span class="_ _11"> </span>structs<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>user<span class="_ _11"> </span>portion</span></span></div><div class="t m5 x26 h26 y714f ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_"> </span>current<span class="_"> </span>process’s<span class="_"> </span>virtual<span class="_"> </span>address<span class="_ _3"></span>.</div><div class="t m5 x1cd h26 y7150 ffc fs19 fc1 sc0 ls0 ws0">2.<span class="_ _e"> </span><span class="ffa">Map<span class="_ _16"> </span>private<span class="_ _11"> </span>areas<span class="_ _1"></span>.<span class="_"> </span><span class="ff7">Create<span class="_"> </span>new<span class="_ _16"> </span>area<span class="_ _11"> </span>structs<span class="_ _16"> </span>for<span class="_ _11"> </span>the<span class="_ _11"> </span>code,<span class="_ _11"> </span>data,<span class="_ _16"> </span>bss<span class="_ _1"></span>,<span class="_ _16"> </span>and<span class="_ _11"> </span>stack</span></span></div><div class="t m5 x26 h26 y7151 ff7 fs19 fc1 sc0 ls0 ws0">areas<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>new<span class="_ _11"> </span>program.<span class="_ _11"> </span>All<span class="_ _11"> </span>of<span class="_ _16"> </span>these<span class="_"> </span>new<span class="_ _11"> </span>areas<span class="_ _11"> </span>are<span class="_ _16"> </span>private<span class="_"> </span>copy-on-write.</div><div class="t m5 x26 h26 y7152 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>code<span class="_"> </span>and<span class="_ _11"> </span>data<span class="_ _11"> </span>areas<span class="_"> </span>are<span class="_ _11"> </span>mapped<span class="_"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span><span class="ffd">.text<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ffd">.data<span class="_ _11"> </span></span>sections<span class="_"> </span>of<span class="_ _11"> </span>the</div><div class="t m5 x26 h26 y7153 ffd fs19 fc1 sc0 ls0 ws0">a.out<span class="_ _10"> </span><span class="ff7">ﬁle<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>bss<span class="_"> </span>area<span class="_ _13"> </span>is<span class="_"> </span>demand-zero<span class="_ _1"></span>,<span class="_"> </span>mapped<span class="_"> </span>to<span class="_ _13"> </span>an<span class="_"> </span>anonymous<span class="_"> </span>ﬁle<span class="_"> </span>whose</span></div><div class="t m5 x26 h26 y7154 ff7 fs19 fc1 sc0 ls0 ws0">size<span class="_ _14"> </span>is<span class="_ _14"> </span>contained<span class="_ _14"> </span>in<span class="_ _14"> </span><span class="ffd">a.out</span>.<span class="_ _14"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>stack<span class="_ _14"> </span>and<span class="_ _14"> </span>heap<span class="_ _14"> </span>area<span class="_ _14"> </span>are<span class="_ _14"> </span>also<span class="_ _14"> </span>demand-zero,</div><div class="t m5 x26 h26 y7155 ff7 fs19 fc1 sc0 ls0 ws0">initially<span class="_"> </span>of<span class="_"> </span>zero<span class="_"> </span>length.<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>9.31<span class="_"> </span>summarizes<span class="_"> </span>the<span class="_"> </span>different<span class="_"> </span>mappings<span class="_ _13"> </span>of<span class="_"> </span>the</div><div class="t m5 x26 h26 y7156 ff7 fs19 fc1 sc0 ls0 ws0">private<span class="_"> </span>areas<span class="_ _1"></span>.</div><div class="t m5 x52 h26 y7157 ffc fs19 fc1 sc0 ls0 ws0">3.<span class="_ _e"> </span><span class="ffa">Map<span class="_ _11"> </span>shared<span class="_"> </span>areas<span class="_ _1"></span>.<span class="_ _13"> </span><span class="ff7">If<span class="_"> </span>the<span class="_"> </span><span class="ffd">a.out<span class="_ _10"> </span></span>program<span class="_"> </span>was<span class="_"> </span>linked<span class="_"> </span>with<span class="_"> </span>shared<span class="_ _11"> </span>objects<span class="_ _1"></span>,<span class="_"> </span>such</span></span></div><div class="t m5 x26 h26 y7158 ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_"> </span>the<span class="_"> </span>standard<span class="_"> </span>C<span class="_"> </span>library<span class="_"> </span><span class="ffd">libc.so</span>,<span class="_"> </span>then<span class="_ _11"> </span>these<span class="_"> </span>objects<span class="_"> </span>are<span class="_"> </span>dynamically<span class="_"> </span>linked</div><div class="t m5 x26 h26 y7159 ff7 fs19 fc1 sc0 ls0 ws0">into<span class="_ _13"> </span>the<span class="_ _13"> </span>program,<span class="_ _13"> </span>and<span class="_ _6"> </span>then<span class="_ _13"> </span>mapped<span class="_ _13"> </span>into<span class="_ _13"> </span>the<span class="_ _13"> </span>shared<span class="_ _6"> </span>region<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>user’<span class="_ _0"></span>s<span class="_ _13"> </span>virtual</div><div class="t m5 x26 h26 y715a ff7 fs19 fc1 sc0 ls0 ws0">address<span class="_"> </span>space<span class="_ _1"></span>.</div><div class="t m5 x52 h26 y715b ffc fs19 fc1 sc0 ls0 ws0">4.<span class="_ _e"> </span><span class="ffa">Set<span class="_ _14"> </span>the<span class="_ _14"> </span>program<span class="_ _14"> </span>counter<span class="_ _14"> </span>(PC).<span class="_"> </span><span class="ff7">T<span class="_ _1"></span>he<span class="_ _14"> </span>last<span class="_ _14"> </span>thing<span class="_ _16"> </span>that<span class="_ _14"> </span><span class="ffd">execve<span class="_ _14"> </span></span>does<span class="_ _14"> </span>is<span class="_ _16"> </span>to<span class="_ _14"> </span>set<span class="_ _14"> </span>the</span></span></div><div class="t m5 x26 h26 y715c ff7 fs19 fc1 sc0 ls0 ws0">program<span class="_ _11"> </span>counter<span class="_ _11"> </span>in<span class="_ _16"> </span>the<span class="_ _11"> </span>current<span class="_ _11"> </span>process’s<span class="_ _11"> </span>context<span class="_ _11"> </span>to<span class="_ _16"> </span>point<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _16"> </span>entry<span class="_ _11"> </span>point</div><div class="t m5 x26 h26 y715d ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>area.</div><div class="t m5 x26 h26 y715e ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>next<span class="_ _13"> </span>time<span class="_"> </span>this<span class="_ _13"> </span>process<span class="_"> </span>is<span class="_ _13"> </span>scheduled,<span class="_"> </span>it<span class="_ _13"> </span>will<span class="_ _13"> </span>begin<span class="_"> </span>execution<span class="_ _13"> </span>from<span class="_"> </span>the<span class="_ _13"> </span>entry</div><div class="t m5 x17 h26 y715f ff7 fs19 fc1 sc0 ls0 ws0">point.<span class="_"> </span>Linux<span class="_"> </span>will<span class="_"> </span>swap<span class="_"> </span>in<span class="_"> </span>code<span class="_"> </span>and<span class="_"> </span>data<span class="_"> </span>pages<span class="_"> </span>as<span class="_"> </span>needed.</div><div class="t m5 x17 h41 y1672 ffe fs29 fc1 sc0 ls0 ws0">9.8.4<span class="_ _48"> </span><span class="fs19">User-Level<span class="_"> </span>Memory<span class="_"> </span>Mapping<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span><span class="ffd fs1c">mmap<span class="_ _11"> </span></span>Function</span></div><div class="t m5 x17 h26 y6e1 ff7 fs19 fc1 sc0 ls0 ws0">Linux<span class="_"> </span>processes<span class="_"> </span>can<span class="_ _13"> </span>use<span class="_"> </span>the<span class="_"> </span><span class="ffd">mmap<span class="_ _10"> </span></span>function<span class="_"> </span>to<span class="_"> </span>create<span class="_"> </span>new<span class="_ _13"> </span>areas<span class="_"> </span>of<span class="_"> </span>virtual<span class="_"> </span>memory</div><div class="t m5 x17 h26 y6e2 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>to<span class="_"> </span>map<span class="_"> </span>objects<span class="_"> </span>into<span class="_"> </span>these<span class="_"> </span>areas<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
