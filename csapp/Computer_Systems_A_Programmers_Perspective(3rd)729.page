<div id="pf2d9" class="pf w2 h11" data-page-no="2d9"><div class="pc pc2d9 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2d9.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">728<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x1dc h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/link/main-relo<span class="_ _1"></span>.d</div><div class="t m5 xb h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">0000000000000000<span class="_ _1f"> </span>&lt;main&gt;:</span></div><div class="t m5 xb h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _5b"> </span><span class="ffd fs1e fc2">0:<span class="_ _3f"> </span>48<span class="_ _1f"> </span>83<span class="_ _e"> </span>ec<span class="_ _1f"> </span>08<span class="_ _35"> </span>sub<span class="_ _46"> </span>$0x8,%rsp</span></div><div class="t m5 xb h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _5b"> </span><span class="ffd fs1e fc2">4:<span class="_ _3f"> </span>be<span class="_ _1f"> </span>02<span class="_ _e"> </span>00<span class="_ _1f"> </span>00<span class="_ _e"> </span>00<span class="_ _86"> </span>mov<span class="_ _46"> </span>$0x2,%esi</span></div><div class="t m5 xb h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _5b"> </span><span class="ffd fs1e fc2">9:<span class="_ _3f"> </span>bf<span class="_ _1f"> </span>00<span class="_ _e"> </span>00<span class="_ _1f"> </span>00<span class="_ _e"> </span>00<span class="_ _86"> </span>mov<span class="_ _46"> </span>$0x0,%edi<span class="_ _2a"> </span></span><span class="ff13 fs35">%edi<span class="_ _f"> </span>=<span class="_ _f"> </span>&amp;array</span></div><div class="t m5 xb h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _209"> </span><span class="ffd fs1e fc2">a:<span class="_ _e"> </span>R_X86_64_32<span class="_ _1f"> </span>array<span class="_ _12b"> </span></span><span class="ff13 fs35">Relocation<span class="_ _f"> </span>entry</span></div><div class="t m5 xb h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _5b"> </span><span class="ffd fs1e fc2">e:<span class="_ _3f"> </span>e8<span class="_ _1f"> </span>00<span class="_ _e"> </span>00<span class="_ _1f"> </span>00<span class="_ _e"> </span>00<span class="_ _86"> </span>callq<span class="_ _1a"> </span>13<span class="_ _1f"> </span>&lt;main+0x13&gt;<span class="_ _b2"> </span></span><span class="ff13 fs35">sum()</span></div><div class="t m5 xb h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _209"> </span><span class="ffd fs1e fc2">f:<span class="_ _e"> </span>R_X86_64_PC32<span class="_ _1f"> </span>sum-0x4<span class="_ _2a"> </span></span><span class="ff13 fs35">Relocation<span class="_ _21"> </span>entry</span></div><div class="t m5 xb h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _45"> </span><span class="ffd fs1e fc2">13:<span class="_ _3f"> </span>48<span class="_ _e"> </span>83<span class="_ _1f"> </span>c4<span class="_ _1f"> </span>08<span class="_ _35"> </span>add<span class="_ _46"> </span>$0x8,%rsp</span></div><div class="t m5 xb h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _45"> </span><span class="ffd fs1e fc2">17:<span class="_ _3f"> </span>c3<span class="_ _129"> </span>retq</span></div><div class="t m5 x1dc h2c y6067 ffa fs16 fc2 sc0 ls0 ws0">code/link/main-relo<span class="_ _1"></span>.d</div><div class="t m5 x14 h2f y6068 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>7.11<span class="_ _66"> </span><span class="fc1">Code<span class="_"> </span>and<span class="_"> </span>relocation<span class="_"> </span>entries<span class="_"> </span>from</span></div><div class="t m5 x49 h3a y6069 ffd fs19 fc1 sc0 ls0 ws0">main.o<span class="ffe fs16">.<span class="_"> </span><span class="ff6">The<span class="_ _10"> </span>original<span class="_ _11"> </span>C<span class="_ _10"> </span>code<span class="_ _10"> </span>is<span class="_ _11"> </span>in<span class="_ _10"> </span>Figure<span class="_ _11"> </span>7.1.</span></span></div><div class="t m5 x29 h26 y606a ff7 fs19 fc1 sc0 ls0 ws0">Let’s<span class="_"> </span>see<span class="_"> </span>how<span class="_ _11"> </span>the<span class="_"> </span>linker<span class="_ _11"> </span>uses<span class="_ _11"> </span>this<span class="_"> </span>algorithm<span class="_ _11"> </span>to<span class="_"> </span>relocate<span class="_ _11"> </span>the<span class="_ _11"> </span>references<span class="_"> </span>in<span class="_ _11"> </span>our</div><div class="t m5 x1d h26 y606b ff7 fs19 fc1 sc0 ls0 ws0">example<span class="_ _14"> </span>program<span class="_ _14"> </span>in<span class="_ _14"> </span>Figure<span class="_ _16"> </span>7.1.<span class="_ _14"> </span>Figure<span class="_ _16"> </span>7.11<span class="_ _14"> </span>shows<span class="_ _14"> </span>the<span class="_ _14"> </span>disassembled<span class="_ _15"> </span>code<span class="_ _14"> </span>from</div><div class="t m5 x1d h26 y606c ffd fs19 fc1 sc0 ls0 ws0">main.o<span class="ff7">,<span class="_"> </span>as<span class="_"> </span>generated<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>GNU<span class="_"> </span><span class="ff9">objd<span class="_ _1"></span>ump<span class="_ _11"> </span><span class="ff7">tool<span class="_"> </span>(<span class="ffd">objdump<span class="_ _11"> </span>-dx<span class="_ _16"> </span>main.o</span>).</span></span></span></div><div class="t m5 x29 h26 y606d ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _14"> </span><span class="ffd ls0">main<span class="_ _14"> </span><span class="ff7">function<span class="_ _16"> </span>references<span class="_ _16"> </span>two<span class="_ _16"> </span>global<span class="_ _14"> </span>symbols<span class="_ _1"></span>,<span class="_ _14"> </span><span class="ffd">array<span class="_ _16"> </span></span>and<span class="_ _16"> </span><span class="ffd">sum</span>.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>each</span></span></div><div class="t m5 x1d h26 y606e ff7 fs19 fc1 sc0 ls0 ws0">reference<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _11"> </span>assembler<span class="_ _16"> </span>has<span class="_ _11"> </span>generated<span class="_ _11"> </span>a<span class="_ _16"> </span>relocation<span class="_ _11"> </span>entry<span class="_ _3"></span>,<span class="_ _11"> </span>which<span class="_ _16"> </span>is<span class="_ _11"> </span>displayed<span class="_ _11"> </span>on</div><div class="t m5 x1d h26 y606f ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>following<span class="_"> </span>line<span class="_ _1"></span>.</div><div class="t m5 xf1 h3c y6070 ff7 fs25 fc1 sc0 ls0 ws0">2</div><div class="t m5 x48 h26 y6071 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>relocation<span class="_"> </span>entries<span class="_"> </span>tell<span class="_"> </span>the<span class="_ _13"> </span>linker<span class="_"> </span>that<span class="_"> </span>the<span class="_"> </span>reference<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">sum</span></div><div class="t m5 x1d h26 y6072 ff7 fs19 fc1 sc0 ls0 ws0">should<span class="_ _13"> </span>be<span class="_ _13"> </span>relocated<span class="_ _13"> </span>using<span class="_ _13"> </span>a<span class="_"> </span>32-bit<span class="_ _13"> </span>PC-relative<span class="_ _13"> </span>address<span class="_ _3"></span>,<span class="_"> </span>and<span class="_ _13"> </span>the<span class="_ _13"> </span>reference<span class="_ _13"> </span>to<span class="_ _13"> </span><span class="ffd">array</span></div><div class="t m5 x1d h26 y6073 ff7 fs19 fc1 sc0 ls0 ws0">should<span class="_"> </span>be<span class="_ _11"> </span>relocated<span class="_ _11"> </span>using<span class="_ _11"> </span>a<span class="_ _11"> </span>32-bit<span class="_ _11"> </span>absolute<span class="_ _11"> </span>address<span class="_ _1"></span>.<span class="_ _11"> </span>The<span class="_"> </span>next<span class="_ _11"> </span>two<span class="_ _11"> </span>sections<span class="_ _11"> </span>detail</div><div class="t m5 x1d h26 y6074 ff7 fs19 fc1 sc0 ls0 ws0">how<span class="_"> </span>the<span class="_"> </span>linker<span class="_"> </span>relocates<span class="_"> </span>these<span class="_"> </span>references<span class="_ _1"></span>.</div><div class="t m5 x1d h42 y6075 ff6 fs29 fc6 sc0 ls0 ws0">Relocating<span class="_ _11"> </span>PC-Relative<span class="_ _16"> </span>References</div><div class="t m5 x1d h26 y6076 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _11"> </span>line<span class="_ _16"> </span>6<span class="_ _11"> </span>in<span class="_ _11"> </span>Figure<span class="_ _11"> </span>7.11,<span class="_ _16"> </span>function<span class="_ _11"> </span><span class="ffd">main<span class="_ _11"> </span></span>calls<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ffd">sum<span class="_ _16"> </span></span>function,<span class="_ _11"> </span>which<span class="_ _16"> </span>is<span class="_ _11"> </span>deﬁned<span class="_ _16"> </span>in</div><div class="t m5 x1d h26 y6077 ff7 fs19 fc1 sc0 ls0 ws0">module<span class="_ _13"> </span><span class="ffd">sum.o</span><span class="ls275">.T<span class="_ _4a"></span>h<span class="_ _8"></span>e<span class="ffd ls0">call<span class="_ _13"> </span><span class="ff7">instruction<span class="_ _6"> </span>begins<span class="_ _13"> </span>at<span class="_ _6"> </span>section<span class="_ _13"> </span>offset<span class="_ _6"> </span></span>0xe<span class="_ _13"> </span><span class="ff7">and<span class="_ _6"> </span>consists<span class="_ _13"> </span>of<span class="_ _6"> </span>the</span></span></span></div><div class="t m5 x1d h26 y6078 ff7 fs19 fc1 sc0 ls0 ws0">1-byte<span class="_ _6"> </span>opcode<span class="_ _13"> </span><span class="ffd">0xe8</span>,<span class="_ _13"> </span>followed<span class="_ _a"> </span>by<span class="_ _13"> </span>a<span class="_ _6"> </span>placeholder<span class="_ _13"> </span>for<span class="_ _6"> </span>the<span class="_ _6"> </span>32-bit<span class="_ _13"> </span>PC-relative<span class="_ _6"> </span>reference</div><div class="t m5 x1d h26 y6079 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>the<span class="_"> </span>target<span class="_"> </span><span class="ffd">sum</span>.</div><div class="t m5 x29 h26 y607a ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>corresponding<span class="_"> </span>relocation<span class="_"> </span>entry<span class="_"> </span><span class="ffd">r<span class="_ _10"> </span></span>consists<span class="_"> </span>of<span class="_"> </span>four<span class="_"> </span>ﬁelds:</div><div class="t m5 x1d h2d y607b ffd fs1e fc2 sc0 ls0 ws0">r.offset<span class="_ _e"> </span>=<span class="_ _1f"> </span>0xf</div><div class="t m5 x1d h2d y607c ffd fs1e fc2 sc0 ls0 ws0">r.symbol<span class="_ _e"> </span>=<span class="_ _1f"> </span>sum</div><div class="t m5 x1d h2d y607d ffd fs1e fc2 sc0 ls0 ws0">r.type<span class="_ _3f"> </span>=<span class="_ _e"> </span>R_X86_64_PC32</div><div class="t m5 x1d h2d y607e ffd fs1e fc2 sc0 ls0 ws0">r.addend<span class="_ _e"> </span>=<span class="_ _1f"> </span>-4</div><div class="t m5 x1d h26 y607f ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hese<span class="_ _16"> </span>ﬁelds<span class="_ _16"> </span>tell<span class="_ _11"> </span>the<span class="_ _16"> </span>linker<span class="_ _16"> </span>to<span class="_ _11"> </span>modify<span class="_ _16"> </span>the<span class="_ _11"> </span>32-bit<span class="_ _16"> </span>PC-relative<span class="_ _16"> </span>reference<span class="_ _11"> </span>starting<span class="_ _16"> </span>at</div><div class="t m5 x1d h26 y6080 ff7 fs19 fc2 sc0 ls0 ws0">offset<span class="_ _11"> </span><span class="ffd">0xf<span class="_ _16"> </span></span>so<span class="_ _11"> </span>that<span class="_ _16"> </span>it<span class="_ _11"> </span>will<span class="_ _16"> </span>point<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ffd">sum<span class="_ _11"> </span></span>routine<span class="_ _16"> </span>at<span class="_ _11"> </span>run<span class="_ _16"> </span>time<span class="_ _1"></span>.<span class="_ _16"> </span>Now<span class="_ _3"></span>,<span class="_ _11"> </span>suppose<span class="_ _16"> </span>that</div><div class="t m5 x1d h26 y6081 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>linker<span class="_"> </span>has<span class="_"> </span>determined<span class="_"> </span>that</div><div class="t m5 x1d h2d y6082 ffd fs1e fc2 sc0 ls0 ws0">ADDR(s)<span class="_ _e"> </span>=<span class="_ _1f"> </span>ADDR(.text)<span class="_ _1f"> </span>=<span class="_ _e"> </span>0x4004d0</div><div class="t m5 x1d h1d y5e3 ff7 fs17 fc2 sc0 ls0 ws0">2.<span class="_"> </span>Recall<span class="_"> </span>that<span class="_"> </span>relocation<span class="_"> </span>entries<span class="_"> </span>and<span class="_"> </span>instructions<span class="_"> </span>are<span class="_"> </span>actually<span class="_"> </span>stored<span class="_"> </span>in<span class="_"> </span>different<span class="_"> </span>sections<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>object</div><div class="t m5 x1d h1d y5e4 ff7 fs17 fc2 sc0 ls0 ws0">ﬁle<span class="_ _0"></span>.<span class="_"> </span>T<span class="_ _0"></span>he<span class="_"> </span><span class="ff9">objd<span class="_ _1"></span>ump<span class="_ _13"> </span><span class="ff7">tool<span class="_"> </span>displays<span class="_"> </span>them<span class="_"> </span>together<span class="_"> </span>for<span class="_"> </span>convenience.</span></span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
