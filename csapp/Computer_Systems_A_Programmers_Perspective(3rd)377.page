<div id="pf179" class="pf w2 h11" data-page-no="179"><div class="pc pc179 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg179.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">376<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">6,<span class="_ _11"> </span>computed<span class="_ _16"> </span>as<span class="_ _11"> </span>the<span class="_ _16"> </span>sum<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>sizes<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffd">a<span class="_ _11"> </span></span>and<span class="_ _11"> </span><span class="ffd">b</span>.<span class="_ _16"> </span>Since<span class="_ _11"> </span>we<span class="_ _11"> </span>know<span class="_ _16"> </span><span class="ffd">a<span class="_ _11"> </span></span>is<span class="_ _16"> </span>4<span class="_ _11"> </span>bytes<span class="_ _11"> </span>long,</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">we<span class="_"> </span>can<span class="_"> </span>deduce<span class="_"> </span>that<span class="_"> </span><span class="ffd">b<span class="_ _10"> </span></span>must<span class="_"> </span>be<span class="_"> </span>2.</div><div class="t m5 x29 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">An<span class="_"> </span>annotated<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>this<span class="_"> </span>function<span class="_"> </span>explains<span class="_"> </span>these<span class="_"> </span>details:</div><div class="t m5 xad h61 y34c2 ff13 fs35 fc6 sc0 ls0 ws0">int<span class="_ _f"> </span>procprobl(int<span class="_ _f"> </span>a,<span class="_ _f"> </span>short<span class="_ _e"> </span>b,<span class="_ _21"> </span>long<span class="_ _f"> </span>*u,<span class="_ _e"> </span>char<span class="_ _21"> </span>*v)</div><div class="t m5 xad h61 y34c3 ff13 fs35 fc6 sc0 ls0 ws0">a<span class="_ _f"> </span>in<span class="_ _f"> </span>%edi,<span class="_ _f"> </span>b<span class="_ _e"> </span>in<span class="_ _21"> </span>%si,<span class="_ _f"> </span>u<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>v<span class="_ _e"> </span>in<span class="_ _21"> </span>%rcx</div><div class="t m5 x1f h2d y34c4 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">procprob:</span></div><div class="t m5 x1f h2d y34c5 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">movslq<span class="_ _1a"> </span>%edi,<span class="_ _e"> </span>%rdi<span class="_ _2a"> </span></span><span class="ff13 fs35">Convert<span class="_ _f"> </span>a<span class="_ _f"> </span>to<span class="_ _e"> </span>long</span></div><div class="t m5 x1f h2d y34c6 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>%rdi,<span class="_ _e"> </span>(%rdx)<span class="_ _59"> </span></span><span class="ff13 fs35">Add<span class="_ _f"> </span>to<span class="_ _e"> </span>*u<span class="_ _21"> </span>(long)</span></div><div class="t m5 x1f h2d y34c7 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">addb<span class="_ _46"> </span>%sil,<span class="_ _e"> </span>(%rcx)<span class="_ _59"> </span></span><span class="ff13 fs35">Add<span class="_ _f"> </span>low-order<span class="_ _e"> </span>byte<span class="_ _21"> </span>of<span class="_ _f"> </span>b<span class="_ _e"> </span>to<span class="_ _21"> </span>*v</span></div><div class="t m5 x1f h2d y34c8 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">movl<span class="_ _46"> </span>$6,<span class="_ _e"> </span>%eax<span class="_ _9a"> </span></span><span class="ff13 fs35">Return<span class="_ _f"> </span>4+2</span></div><div class="t m5 x1f h2d y34c9 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">ret</span></div><div class="t m5 x29 h26 y34ca ff7 fs19 fc2 sc0 ls0 ws0">Alternatively<span class="_ _3"></span>,<span class="_ _11"> </span>we<span class="_ _16"> </span>can<span class="_ _11"> </span>see<span class="_ _11"> </span>that<span class="_ _16"> </span>the<span class="_ _11"> </span>same<span class="_ _11"> </span>assembly<span class="_ _16"> </span>code<span class="_ _11"> </span>would<span class="_ _16"> </span>be<span class="_ _11"> </span>valid<span class="_ _11"> </span>if<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y34cb ff7 fs19 fc2 sc0 ls0 ws0">two<span class="_ _13"> </span>sums<span class="_ _6"> </span>were<span class="_ _13"> </span>computed<span class="_ _6"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>assembly<span class="_ _6"> </span>code<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>opposite<span class="_ _13"> </span>ordering<span class="_ _6"> </span>as<span class="_ _13"> </span>they<span class="_ _6"> </span>are</div><div class="t m5 x1d h26 y34cc ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _6"> </span>the<span class="_ _13"> </span>C<span class="_ _6"> </span>code.<span class="_ _6"> </span>T<span class="_ _0"></span>his<span class="_ _6"> </span>would<span class="_ _13"> </span>result<span class="_ _6"> </span>in<span class="_ _13"> </span>interchanging<span class="_ _6"> </span>arguments<span class="_ _13"> </span><span class="ffd">a<span class="_ _13"> </span></span>and<span class="_ _6"> </span><span class="ffd">b<span class="_ _13"> </span></span>and<span class="_ _6"> </span>arguments</div><div class="t m5 x1d h26 y34cd ffd fs19 fc2 sc0 ls0 ws0">u<span class="_ _10"> </span><span class="ff7">and<span class="_"> </span></span>v<span class="ff7">,<span class="_"> </span>yielding<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>prototype:</span></div><div class="t m5 x1d h2d y2a68 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>procprob(int<span class="_ _1f"> </span>b,<span class="_ _1f"> </span>short<span class="_ _e"> </span>a,<span class="_ _1f"> </span>long<span class="_ _e"> </span>*v,<span class="_ _1f"> </span>char<span class="_ _1f"> </span>*u);</div><div class="t m5 x1d h28 y34ce ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>3.34</div><div class="t m5 xe1 h2f y34cf ffe fs16 fc6 sc0 ls0 ws0">(page<span class="_"> </span>288)</div><div class="t m5 x1d h26 y34d0 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _16"> </span>example<span class="_ _16"> </span>demonstrates<span class="_ _11"> </span>the<span class="_ _16"> </span>use<span class="_ _16"> </span>of<span class="_ _11"> </span>callee-saved<span class="_ _16"> </span>registers<span class="_ _11"> </span>as<span class="_ _16"> </span>well<span class="_ _16"> </span>as<span class="_ _11"> </span>the<span class="_ _16"> </span>stack</div><div class="t m5 x1d h26 y34d1 ff7 fs19 fc1 sc0 ls0 ws0">for<span class="_"> </span>holding<span class="_"> </span>local<span class="_"> </span>data.</div><div class="t m5 x124 h26 y34d2 ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>W<span class="_ _3"></span>e<span class="_ _13"> </span>can<span class="_ _13"> </span>see<span class="_ _13"> </span>that<span class="_ _13"> </span>lines<span class="_ _13"> </span>9–14<span class="_ _13"> </span>save<span class="_ _13"> </span>local<span class="_"> </span>values<span class="_ _13"> </span><span class="ffd">a0</span>–<span class="ffd">a5<span class="_ _13"> </span></span>into<span class="_ _13"> </span>callee-saved<span class="_ _13"> </span>registers</div><div class="t m5 x4f h26 y34d3 ffd fs19 fc1 sc0 ls0 ws0">%rbx<span class="ff7">,<span class="_"> </span></span>%r15<span class="ff7">,<span class="_"> </span></span>%r14<span class="ff7">,<span class="_"> </span></span>%r13<span class="ff7">,<span class="_"> </span></span>%r12<span class="ff7">,<span class="_"> </span>and<span class="_"> </span></span>%rbp<span class="ff7">,<span class="_"> </span>respectively<span class="_ _3"></span>.</span></div><div class="t m5 x124 h26 y34d4 ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>Local<span class="_ _11"> </span>values<span class="_"> </span><span class="ffd">a6<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ffd">a7<span class="_ _11"> </span></span>are<span class="_ _11"> </span>stored<span class="_"> </span>on<span class="_ _11"> </span>the<span class="_"> </span>stack<span class="_ _11"> </span>at<span class="_"> </span>offsets<span class="_ _11"> </span>0<span class="_ _11"> </span>and<span class="_"> </span>8<span class="_ _11"> </span>relative<span class="_"> </span>to</div><div class="t m5 x4f h26 y34d5 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>stack<span class="_"> </span>pointer<span class="_"> </span>(lines<span class="_"> </span>16<span class="_"> </span>and<span class="_"> </span>18).</div><div class="t m5 x124 h26 y34d6 ff7 fs19 fc1 sc0 ls0 ws0">C.<span class="_ _25"> </span>After<span class="_ _6"> </span>storing<span class="_ _6"> </span>six<span class="_ _6"> </span>local<span class="_ _13"> </span>variables<span class="_ _3"></span>,<span class="_ _13"> </span>the<span class="_ _6"> </span>program<span class="_ _6"> </span>has<span class="_ _6"> </span>used<span class="_ _6"> </span>up<span class="_ _13"> </span>the<span class="_ _a"> </span>supply<span class="_ _13"> </span>of<span class="_ _a"> </span>callee-</div><div class="t m5 x4f h26 y34d7 ff7 fs19 fc1 sc0 ls0 ws0">saved<span class="_"> </span>registers<span class="_ _1"></span>.<span class="_"> </span>It<span class="_"> </span>stores<span class="_"> </span>the<span class="_"> </span>remaining<span class="_"> </span>two<span class="_"> </span>local<span class="_"> </span>values<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>stack.</div><div class="t m5 x1d h28 y34d8 ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>3.35<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>290)</span></div><div class="t m5 x1d h26 y34d9 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>problem<span class="_"> </span>provides<span class="_"> </span>a<span class="_ _13"> </span>chance<span class="_"> </span>to<span class="_"> </span>examine<span class="_"> </span>the<span class="_ _13"> </span>code<span class="_"> </span>for<span class="_"> </span>a<span class="_"> </span>recursive<span class="_ _13"> </span>function.<span class="_"> </span>An</div><div class="t m5 x1d h26 y34da ff7 fs19 fc1 sc0 ls0 ws0">important<span class="_ _13"> </span>lesson<span class="_ _13"> </span>to<span class="_ _13"> </span>learn<span class="_ _13"> </span>is<span class="_ _13"> </span>that<span class="_ _13"> </span>recursive<span class="_ _13"> </span>code<span class="_ _13"> </span>has<span class="_ _13"> </span>the<span class="_ _13"> </span>exact<span class="_ _13"> </span>same<span class="_ _13"> </span>structure<span class="_ _13"> </span>as<span class="_ _13"> </span>the</div><div class="t m5 x1d h26 y34db ff7 fs19 fc1 sc0 ls0 ws0">other<span class="_"> </span>functions<span class="_ _11"> </span>we<span class="_ _11"> </span>have<span class="_ _11"> </span>seen.<span class="_ _11"> </span>The<span class="_"> </span>stack<span class="_ _11"> </span>and<span class="_ _11"> </span>register<span class="_ _1"></span>-saving<span class="_ _11"> </span>disciplines<span class="_ _11"> </span>sufﬁce<span class="_ _11"> </span>to</div><div class="t m5 x1d h26 y34dc ff7 fs19 fc1 sc0 ls0 ws0">make<span class="_"> </span>recursive<span class="_"> </span>functions<span class="_"> </span>operate<span class="_"> </span>correctly<span class="_ _3"></span>.</div><div class="t m5 x124 h26 y34dd ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>Register<span class="_ _21"> </span><span class="ffd">%rbx<span class="_ _21"> </span></span>holds<span class="_ _21"> </span>the<span class="_ _21"> </span>value<span class="_ _21"> </span>of<span class="_ _21"> </span>parameter<span class="_ _21"> </span><span class="ffd">x</span>,<span class="_ _e"> </span>so<span class="_ _15"> </span>that<span class="_ _21"> </span>it<span class="_ _21"> </span>can<span class="_ _f"> </span>be<span class="_ _21"> </span>used<span class="_ _21"> </span>to</div><div class="t m5 x4f h26 y34de ff7 fs19 fc1 sc0 ls0 ws0">compute<span class="_"> </span>the<span class="_"> </span>result<span class="_"> </span>expression.</div><div class="t m5 x124 h26 y34df ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>The<span class="_"> </span>assembly<span class="_"> </span>code<span class="_"> </span>was<span class="_"> </span>generated<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>C<span class="_"> </span>code:</div><div class="t m5 x4f h2d yc21 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>rfun(unsigned<span class="_ _1f"> </span>long<span class="_ _1f"> </span>x)<span class="_ _e"> </span>{</div><div class="t m5 x33 h2d y34e0 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(x<span class="_ _1f"> </span>==<span class="_ _1f"> </span>0)</div><div class="t m5 xf7 h2d y34e1 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>0;</div><div class="t m5 x33 h2d y34e2 ffd fs1e fc2 sc0 ls0 ws0">unsigned<span class="_ _e"> </span>long<span class="_ _1f"> </span>nx<span class="_ _1f"> </span>=<span class="_ _e"> </span>x&gt;&gt;2;</div><div class="t m5 x33 h2d y34e3 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>rv<span class="_ _1f"> </span>=<span class="_ _1f"> </span>rfun(nx);</div><div class="t m5 x33 h2d y34e4 ffd fs1e fc2 sc0 ls0 ws0">retur<span class="ls33">nx+r<span class="_ _41"></span>v<span class="_ _41"></span>;</span></div><div class="t m5 x4f h2d y34e5 ffd fs1e fc2 sc0 ls0 ws0">}</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
