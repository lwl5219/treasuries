<div id="pf3fd" class="pf w2 h11" data-page-no="3fd"><div class="pc pc3fd w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3fd.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1020<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x8b h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoservers<span class="_ _1"></span>.c</div><div class="t m5 xb h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>check_clients(pool<span class="_ _e"> </span>*p)</span></div><div class="t m5 xb h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 xb h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i,<span class="_ _1f"> </span>connfd,<span class="_ _1f"> </span>n;</span></div><div class="t m5 xb h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>buf[MAXLINE];</span></div><div class="t m5 xb h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">rio_t<span class="_ _e"> </span>rio;</span></div><div class="t m5 xb h2e y286 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 xb h2e y6298 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x26 h2d y287 ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>(i<span class="_ _1f"> </span>&lt;=<span class="_ _e"> </span>p-&gt;maxi)<span class="_ _1f"> </span>&amp;&amp;<span class="_ _1f"> </span>(p-&gt;nready<span class="_ _e"> </span>&gt;<span class="_ _1f"> </span>0);<span class="_ _e"> </span>i++)<span class="_ _1f"> </span>{</div><div class="t m5 xb h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">connfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>p-&gt;clientfd[i];</span></div><div class="t m5 xb h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2">rio<span class="_ _e"> </span>=<span class="_ _1f"> </span>p-&gt;clientrio[i];</span></div><div class="t m5 x14 h2e y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x14 h2e y7428 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x249 h2d y4a9c ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>If<span class="_ _1f"> </span>the<span class="_ _1f"> </span>descriptor<span class="_ _e"> </span>is<span class="_ _1f"> </span>ready,<span class="_ _e"> </span>echo<span class="_ _1f"> </span>a<span class="_ _1f"> </span>text<span class="_ _e"> </span>line<span class="_ _1f"> </span>from<span class="_ _e"> </span>it<span class="_ _1f"> </span>*/</div><div class="t m5 x14 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((connfd<span class="_ _1f"> </span>&gt;<span class="_ _1f"> </span>0)<span class="_ _e"> </span>&amp;&amp;<span class="_ _1f"> </span>(FD_ISSET(connfd,<span class="_ _e"> </span>&amp;p-&gt;ready_set)))<span class="_ _1f"> </span>{</span></div><div class="t m5 x14 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _d1"> </span><span class="ffd fs1e fc2">p-&gt;nready--;</span></div><div class="t m5 x14 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _d1"> </span><span class="ffd fs1e fc2">if<span class="_ _1f"> </span>((n<span class="_ _e"> </span>=<span class="_ _1f"> </span>Rio_readlineb(&amp;rio,<span class="_ _e"> </span>buf,<span class="_ _1f"> </span>MAXLINE))<span class="_ _1f"> </span>!=<span class="_ _e"> </span>0)<span class="_ _1f"> </span>{</span></div><div class="t m5 x14 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _143"> </span><span class="ffd fs1e fc2">byte_cnt<span class="_ _e"> </span>+=<span class="_ _1f"> </span>n;</span></div><div class="t m5 x14 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _143"> </span><span class="ffd fs1e fc2">printf(&quot;Server<span class="_ _e"> </span>received<span class="_ _1f"> </span>%d<span class="_ _1f"> </span>(%d<span class="_ _e"> </span>total)<span class="_ _1f"> </span>bytes<span class="_ _e"> </span>on<span class="_ _1f"> </span>fd<span class="_ _1f"> </span>%d\n&quot;,</span></div><div class="t m5 x14 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _23b"> </span><span class="ffd fs1e fc2">n,<span class="_ _e"> </span>byte_cnt,<span class="_ _1f"> </span>connfd);</span></div><div class="t m5 x14 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _143"> </span><span class="ffd fs1e fc2">Rio_writen(connfd,<span class="_ _e"> </span>buf,<span class="_ _1f"> </span>n);</span></div><div class="t m5 x14 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _d1"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2e y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 x14 h2e y7fdd ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x1b0 h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>EOF<span class="_ _1f"> </span>detected,<span class="_ _1f"> </span>remove<span class="_ _e"> </span>descriptor<span class="_ _1f"> </span>from<span class="_ _e"> </span>pool<span class="_ _1f"> </span>*/</div><div class="t m5 x14 h2d y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _d1"> </span><span class="ffd fs1e fc2">else<span class="_ _1f"> </span>{</span></div><div class="t m5 x14 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _143"> </span><span class="ffd fs1e fc2">Close(connfd);</span></div><div class="t m5 x14 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _143"> </span><span class="ffd fs1e fc2">FD_CLR(connfd,<span class="_ _e"> </span>&amp;p-&gt;read_set);</span></div><div class="t m5 x14 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x177 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">p-&gt;clientfd[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>-1;</div><div class="t m5 x14 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _d1"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d y441 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x8b h2c y66e3 ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoservers<span class="_ _1"></span>.c</div><div class="t m5 x14 h2f y66e4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.11</div><div class="t m5 x182 h3a y5165 ffd fs19 fc1 sc0 ls0 ws0">check_clients<span class="_ _10"> </span><span class="ffe fs16">services<span class="_"> </span>ready<span class="_"> </span>client<span class="_"> </span>connections.</span></div><div class="t m5 x29 h26 y7fde ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_"> </span>terms<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>ﬁnite<span class="_ _11"> </span>state<span class="_ _11"> </span>model<span class="_"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>12.7,<span class="_"> </span>the<span class="_ _11"> </span><span class="ffd">select<span class="_ _11"> </span></span>function<span class="_"> </span>detects</div><div class="t m5 x1d h26 y7fdf ff7 fs19 fc1 sc0 ls0 ws0">input<span class="_ _11"> </span>events<span class="_ _1"></span>,<span class="_ _16"> </span>and<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ffd">add_client<span class="_ _16"> </span></span>function<span class="_ _11"> </span>creates<span class="_ _16"> </span>a<span class="_ _11"> </span>new<span class="_ _16"> </span>logical<span class="_ _16"> </span>ﬂow<span class="_ _11"> </span>(state<span class="_ _16"> </span>ma-</div><div class="t m5 x1d h26 y7fe0 ff7 fs19 fc1 sc0 ls0 ws0">chine).<span class="_"> </span>The<span class="_"> </span><span class="ffd">check_clients<span class="_ _10"> </span></span>function<span class="_ _11"> </span>performs<span class="_ _11"> </span>state<span class="_ _11"> </span>transitions<span class="_"> </span>by<span class="_ _11"> </span>echoing<span class="_ _11"> </span>input</div><div class="t m5 x1d h26 y7fe1 ff7 fs19 fc1 sc0 ls0 ws0">lines<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _16"> </span>it<span class="_ _16"> </span>also<span class="_ _16"> </span>deletes<span class="_ _14"> </span>the<span class="_ _16"> </span>state<span class="_ _16"> </span>machine<span class="_ _16"> </span>when<span class="_ _16"> </span>the<span class="_ _14"> </span>client<span class="_ _16"> </span>has<span class="_ _16"> </span>ﬁnished<span class="_ _16"> </span>sending</div><div class="t m5 x1d h26 y1fe0 ff7 fs19 fc1 sc0 ls0 ws0">text<span class="_"> </span>lines<span class="_ _1"></span>.</div><div class="t m5 x1d h47 y6e5b ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>12.4<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>1072)</span></div><div class="t m5 x1d h26 y7fe2 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_"> </span>the<span class="_"> </span>server<span class="_ _11"> </span>in<span class="_"> </span>F<span class="_ _0"></span>igure<span class="_"> </span>12.8,<span class="_"> </span><span class="ffd">pool.nready<span class="_ _11"> </span></span>is<span class="_"> </span>reinitialized<span class="_"> </span>with<span class="_ _11"> </span>the<span class="_"> </span>value<span class="_"> </span>obtained</div><div class="t m5 x1d h26 y7fe3 ff7 fs19 fc1 sc0 ls0 ws0">from<span class="_"> </span>the<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">select</span>.<span class="_"> </span>Why?</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
