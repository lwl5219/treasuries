<div id="pf40a" class="pf w2 h11" data-page-no="40a"><div class="pc pc40a w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg40a.png"/><div class="t m5 x69 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.5<span class="_ _60"> </span>Synchronizing<span class="_ _10"> </span>Threads<span class="_ _10"> </span>with<span class="_ _10"> </span>Semaphores<span class="_ _3e"> </span><span class="ffe fs1e">1033</span></div><div class="t m5 x17 h2d y140c ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _1a"> </span><span class="ff13">./badcnt<span class="_ _e"> </span>1000000</span></div><div class="t m5 x17 h2d y140d ffd fs1e fc2 sc0 ls0 ws0">BOOM!<span class="_ _e"> </span>cnt=1445085</div><div class="t m5 x17 h2d y80f1 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _1a"> </span><span class="ff13">./badcnt<span class="_ _e"> </span>1000000</span></div><div class="t m5 x17 h2d y80f2 ffd fs1e fc2 sc0 ls0 ws0">BOOM!<span class="_ _e"> </span>cnt=1915220</div><div class="t m5 x17 h2d y80f3 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _1a"> </span><span class="ff13">./badcnt<span class="_ _e"> </span>1000000</span></div><div class="t m5 x17 h2d y80f4 ffd fs1e fc2 sc0 ls0 ws0">BOOM!<span class="_ _e"> </span>cnt=1404746</div><div class="t m5 x26 h26 y80f5 ff7 fs19 fc2 sc0 ls0 ws0">So<span class="_ _16"> </span>what<span class="_ _16"> </span>went<span class="_ _16"> </span>wrong?<span class="_ _16"> </span>T<span class="_ _7"></span>o<span class="_ _16"> </span>understand<span class="_ _16"> </span>the<span class="_ _16"> </span>problem<span class="_ _16"> </span>clearly<span class="_ _3"></span>,<span class="_ _16"> </span>we<span class="_ _16"> </span>need<span class="_ _16"> </span>to<span class="_ _16"> </span>study</div><div class="t m5 x17 h26 y80f6 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>assembly<span class="_ _16"> </span>code<span class="_ _16"> </span>for<span class="_ _16"> </span>the<span class="_ _16"> </span>counter<span class="_ _16"> </span>loop<span class="_ _16"> </span>(lines<span class="_ _16"> </span>40–41),<span class="_ _14"> </span>as<span class="_ _16"> </span>shown<span class="_ _16"> </span>in<span class="_ _16"> </span>F<span class="_ _0"></span>igure<span class="_ _16"> </span>12.17.</div><div class="t m5 x17 h26 y80f7 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_"> </span>will<span class="_"> </span>ﬁnd<span class="_"> </span>it<span class="_"> </span>helpful<span class="_"> </span>to<span class="_"> </span>partition<span class="_"> </span>the<span class="_"> </span>loop<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span>thread<span class="_"> </span><span class="ff11">i<span class="_"> </span></span>into<span class="_"> </span>ﬁve<span class="_"> </span>parts:</div><div class="t m5 x72 h45 y80f8 ff11 fs19 fc2 sc0 ls0 ws0">H</div><div class="t m5 x253 h50 y80f9 ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x15d h26 y80fa ff7 fs19 fc2 sc0 ls0 ws0">:<span class="_ _e"> </span>The<span class="_"> </span>block<span class="_"> </span>of<span class="_"> </span>instructions<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>head<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>loop</div><div class="t m5 x72 h45 y80fb ff11 fs19 fc2 sc0 ls0 ws0">L</div><div class="t m5 x37 h50 y80fc ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x1b6 h26 y80fd ff7 fs19 fc2 sc0 ls0 ws0">:<span class="_ _e"> </span>The<span class="_ _14"> </span>instruction<span class="_ _21"> </span>that<span class="_ _15"> </span>loads<span class="_ _21"> </span>the<span class="_ _15"> </span>shared<span class="_ _21"> </span>variable<span class="_ _15"> </span><span class="ffd">cnt<span class="_ _15"> </span></span>into<span class="_ _21"> </span>the<span class="_ _15"> </span>accumulator</div><div class="t m5 x30 h26 y80fe ff7 fs19 fc2 sc0 ls0 ws0">register<span class="_"> </span><span class="ffd">%rdx</span></div><div class="t m5 x10d h50 y80ff ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x209 h26 y8100 ff7 fs19 fc2 sc0 ls0 ws0">,<span class="_"> </span>where<span class="_ _13"> </span><span class="ffd">%rdx</span></div><div class="t m5 x18d h50 y80ff ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 xed h26 y8100 ff7 fs19 fc2 sc0 ls0 ws0">denotes<span class="_"> </span>the<span class="_ _13"> </span>value<span class="_"> </span>of<span class="_"> </span>register<span class="_ _13"> </span><span class="ffd">%rdx<span class="_ _10"> </span></span>in<span class="_"> </span>thread<span class="_ _13"> </span><span class="ff11">i</span></div><div class="t m5 x62 h45 y8101 ff11 fs19 fc2 sc0 ls0 ws0">U</div><div class="t m5 x37 h50 y8102 ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x1b6 h26 y8103 ff7 fs19 fc2 sc0 ls0 ws0">:<span class="_ _e"> </span>The<span class="_"> </span>instruction<span class="_"> </span>that<span class="_"> </span>updates<span class="_"> </span>(increments)<span class="_"> </span><span class="ffd">%rdx</span></div><div class="t m5 x40 h50 y8104 ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x72 h45 y8105 ff11 fs19 fc2 sc0 ls0 ws0">S</div><div class="t m5 x2f h50 y8106 ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x26 h26 y8107 ff7 fs19 fc2 sc0 ls0 ws0">:<span class="_ _e"> </span>The<span class="_ _11"> </span>instruction<span class="_ _14"> </span>that<span class="_ _16"> </span>stores<span class="_ _16"> </span>the<span class="_ _16"> </span>updated<span class="_ _16"> </span>value<span class="_ _16"> </span>of<span class="_ _16"> </span><span class="ffd">%rdx</span></div><div class="t m5 x19a h50 y8108 ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 xff h26 y8107 ff7 fs19 fc2 sc0 ls0 ws0">back<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>shared</div><div class="t m5 x30 h26 y8109 ff7 fs19 fc2 sc0 ls0 ws0">variable<span class="_"> </span><span class="ffd">cnt</span></div><div class="t m5 x72 h45 y810a ff11 fs19 fc2 sc0 ls0 ws0">T</div><div class="t m5 x2f h50 y1a90 ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x26 h26 y810b ff7 fs19 fc2 sc0 ls0 ws0">:<span class="_ _e"> </span>The<span class="_"> </span>block<span class="_"> </span>of<span class="_"> </span>instructions<span class="_"> </span>at<span class="_"> </span>the<span class="_"> </span>tail<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>loop</div><div class="t m5 x17 h26 y810c ff7 fs19 fc2 sc0 ls0 ws0">Notice<span class="_ _11"> </span>that<span class="_ _11"> </span>the<span class="_ _11"> </span>head<span class="_ _16"> </span>and<span class="_ _11"> </span>tail<span class="_ _11"> </span>manipulate<span class="_ _11"> </span>only<span class="_ _11"> </span>local<span class="_ _16"> </span>stack<span class="_ _11"> </span>variables<span class="_ _1"></span>,<span class="_ _11"> </span>while<span class="_ _16"> </span><span class="ff11">L</span></div><div class="t m5 x44 h50 y810d ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x172 h26 y810e ff7 fs19 fc2 sc0 ls0 ws0">,<span class="_ _11"> </span><span class="ff11">U</span></div><div class="t m5 x1c1 h50 y810d ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 x173 h26 y810e ff7 fs19 fc2 sc0 ls0 ws0">,</div><div class="t m5 x17 h26 y810f ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_"> </span><span class="ff11">S</span></div><div class="t m5 x2d h50 y8110 ff11 fs25 fc2 sc0 ls0 ws0">i</div><div class="t m5 xe h26 y8111 ff7 fs19 fc2 sc0 ls0 ws0">manipulate<span class="_"> </span>the<span class="_"> </span>contents<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>shared<span class="_"> </span>counter<span class="_"> </span>variable<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y8112 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_"> </span>the<span class="_"> </span>two<span class="_"> </span>peer<span class="_"> </span>threads<span class="_"> </span>in<span class="_"> </span><span class="ffd">badcnt.c<span class="_ _10"> </span></span>run<span class="_"> </span>concurrently<span class="_ _11"> </span>on<span class="_"> </span>a<span class="_"> </span>uniprocessor,</div><div class="t m5 x17 h26 y8113 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>machine<span class="_ _11"> </span>instructions<span class="_ _11"> </span>are<span class="_ _11"> </span>completed<span class="_ _11"> </span>one<span class="_ _11"> </span>after<span class="_ _11"> </span>the<span class="_ _11"> </span>other<span class="_ _11"> </span>in<span class="_ _11"> </span>some<span class="_ _11"> </span>order.<span class="_"> </span>Thus<span class="_ _3"></span>,</div><div class="t m5 x17 h26 y8114 ff7 fs19 fc2 sc0 ls0 ws0">each<span class="_ _13"> </span>concurrent<span class="_"> </span>execution<span class="_ _13"> </span>deﬁnes<span class="_"> </span>some<span class="_ _13"> </span>total<span class="_"> </span>ordering<span class="_ _13"> </span>(or<span class="_"> </span>interleaving)<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>in-</div><div class="t m5 x17 h26 y8115 ff7 fs19 fc2 sc0 ls0 ws0">structions<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>two<span class="_ _13"> </span>threads<span class="_ _0"></span>.<span class="_ _13"> </span>Unfortunately<span class="_ _3"></span>,<span class="_ _13"> </span>some<span class="_ _13"> </span>of<span class="_"> </span>these<span class="_ _13"> </span>orderings<span class="_ _13"> </span>will<span class="_ _13"> </span>produce</div><div class="t m5 x17 h26 y8116 ff7 fs19 fc2 sc0 ls0 ws0">correct<span class="_"> </span>results<span class="_ _1"></span>,<span class="_"> </span>but<span class="_"> </span>others<span class="_"> </span>will<span class="_"> </span>not.</div><div class="t m5 x239 h3f y8117 ffeb fs27 fc1 sc0 ls0 ws0">C code for thread i</div><div class="t m5 xba h3f y8118 ffeb fs27 fc1 sc0 ls0 ws0">Asm code for thread i</div><div class="t m5 x22d h70 y8119 ffe7 fs27 fc1 sc0 ls0 ws0">for (i = 0; i &lt; niters; i++)</div><div class="t m5 x22d h70 y811a ffe7 fs27 fc1 sc0 ls0 ws1d">     cnt++;</div><div class="t m5 x1b2 h70 y811b ffe7 fs27 fc1 sc0 ls0 ws0">    movq  (%rdi), %rcx</div><div class="t m5 x1b2 h70 y811c ffe7 fs27 fc1 sc0 ls0 ws0">    testq %rcx, %rcx</div><div class="t m5 x1b2 h70 y811d ffe7 fs27 fc1 sc0 ls0 ws0">    jle   .L2</div><div class="t m5 x1b2 h70 y811e ffe7 fs27 fc1 sc0 ls0 ws0">    movl  $0, %eax</div><div class="t m5 x1b2 h70 y811f ffe7 fs27 fc1 sc0 ls0 ws0">.L3:</div><div class="t m5 x1b2 h70 y8120 ffe7 fs27 fc1 sc0 ls0 ws0">    movq  cnt(%rip),%rdx</div><div class="t m5 x1b2 h70 y3ced ffe7 fs27 fc1 sc0 ls0 ws0">    addq  %eax</div><div class="t m5 x1b2 h70 y8121 ffe7 fs27 fc1 sc0 ls0 ws0">    movq  %eax,cnt(%rip)</div><div class="t m5 x1b2 h70 y8122 ffe7 fs27 fc1 sc0 ls0 ws0">    addq  $1, %rax</div><div class="t m5 x1b2 h70 y8123 ffe7 fs27 fc1 sc0 ls0 ws0">    cmpq  %rcx, %rax</div><div class="t m5 x1b2 h70 y8124 ffe7 fs27 fc1 sc0 ls0 ws0">    jne   .L3</div><div class="t m5 x1b2 h70 y8125 ffe7 fs27 fc1 sc0 ls0 ws0">.L2:</div><div class="t m5 x93 h3f y8126 ffeb fs27 fc1 sc0 ls0 ws0">H</div><div class="t m5 xdf h65 y8127 ffeb fs38 fc1 sc0 ls0 ws0">i<span class="ffec"> </span></div><div class="t m5 xda h3f y8126 ffec fs27 fc1 sc0 ls0 ws0">: Head</div><div class="t m5 x6a h3f y8128 ffeb fs27 fc1 sc0 ls0 ws0">T</div><div class="t m5 x85 h65 y8129 ffeb fs38 fc1 sc0 ls0 ws0">i<span class="ffec"> </span></div><div class="t m5 x237 h3f y812a ffec fs27 fc1 sc0 ls0 ws1e">: T<span class="_ _3"></span>ail</div><div class="t m5 x93 h3f y812b ffeb fs27 fc1 sc0 ls0 ws0">L</div><div class="t m5 x1f8 h65 y812c ffeb fs38 fc1 sc0 ls0 ws0">i<span class="ffec"> </span></div><div class="t m5 x17b h40 y812d ffec fs27 fc1 sc0 ls0 ws0">: Load <span class="ffe7 fs28">cnt</span></div><div class="t m5 x93 h3f y812e ffeb fs27 fc1 sc0 ls0 ws0">U</div><div class="t m5 xdf h65 y812f ffeb fs38 fc1 sc0 ls0 ws0">i<span class="ffec"> </span></div><div class="t m5 xda h40 y812e ffec fs27 fc1 sc0 ls0 ws0">: Update <span class="ffe7 fs28">cnt</span></div><div class="t m5 x93 h3f y8130 ffeb fs27 fc1 sc0 ls0 ws0">S</div><div class="t m5 xdf h65 y8131 ffeb fs38 fc1 sc0 ls0 ws0">i<span class="ffec"> </span></div><div class="t m5 x1e8 h40 y8130 ffec fs27 fc1 sc0 ls0 ws0">: Store <span class="ffe7 fs28">cnt</span></div><div class="t m5 x17 h3a y7956 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.17<span class="_ _66"> </span><span class="fc1">Assembly<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>counter<span class="_"> </span>loop<span class="_"> </span>(lines<span class="_"> </span>40–41)<span class="_"> </span>in<span class="_"> </span><span class="ffd fs19">badcnt.c</span>.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
