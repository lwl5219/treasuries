<div id="pf425" class="pf w2 h11" data-page-no="425"><div class="pc pc425 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg425.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1060<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>nonshared<span class="_"> </span>data.<span class="_"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>example<span class="_ _1"></span>,<span class="_ _11"> </span>the<span class="_"> </span><span class="ffd">rand_r<span class="_ _10"> </span></span>function<span class="_ _11"> </span>in<span class="_"> </span>F<span class="_ _0"></span>igure<span class="_"> </span>12.40<span class="_"> </span>is<span class="_"> </span>implicitly</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">reentrant.</div><div class="t m5 x29 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _15"> </span>always<span class="_ _21"> </span>use<span class="_ _15"> </span>the<span class="_ _15"> </span>term<span class="_ _15"> </span><span class="ffa">reentrant<span class="_ _e"> </span></span>to<span class="_ _14"> </span>include<span class="_ _15"> </span>both<span class="_ _21"> </span>explicit<span class="_ _15"> </span>and<span class="_ _15"> </span>implicit<span class="_ _15"> </span>re-</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">entrant<span class="_ _13"> </span>functions<span class="_ _1"></span>.<span class="_ _13"> </span>However,<span class="_ _13"> </span>it<span class="_ _13"> </span>is<span class="_ _13"> </span>important<span class="_ _6"> </span>to<span class="_ _13"> </span>realize<span class="_ _13"> </span>that<span class="_ _13"> </span>reentrancy<span class="_ _13"> </span>is<span class="_ _13"> </span>sometimes</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>property<span class="_"> </span>of<span class="_"> </span>both<span class="_"> </span>the<span class="_"> </span>caller<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>callee<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>not<span class="_"> </span>just<span class="_"> </span>the<span class="_"> </span>callee<span class="_"> </span>alone.</div><div class="t m5 x1d h47 y83f3 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>12.12<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>1074)</span></div><div class="t m5 x1d h26 y83f4 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _11"> </span><span class="ffd ls0">rand_r<span class="_ _10"> </span><span class="ff7">function<span class="_"> </span>in<span class="_"> </span>Figure<span class="_"> </span>12.40<span class="_"> </span>is<span class="_"> </span>implicitly<span class="_"> </span>reentrant.<span class="_"> </span>Explain.</span></span></div><div class="t m5 x1d h41 y83f5 ffe fs29 fc1 sc0 ls0 ws0">12.7.3<span class="_ _48"> </span><span class="fs19">Using<span class="_"> </span>Existing<span class="_"> </span>Library<span class="_"> </span>Functions<span class="_"> </span>in<span class="_"> </span>Threaded<span class="_"> </span>Programs</span></div><div class="t m5 x1d h26 y83f6 ff7 fs19 fc1 sc0 ls0 ws0">Most<span class="_ _16"> </span>Linux<span class="_ _16"> </span>functions<span class="_ _1"></span>,<span class="_ _14"> </span>including<span class="_ _14"> </span>the<span class="_ _16"> </span>functions<span class="_ _16"> </span>deÔ¨Åned<span class="_ _14"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span>standard<span class="_ _14"> </span>C<span class="_ _16"> </span>library</div><div class="t m5 x1d h26 y83f7 ff7 fs19 fc1 sc0 ls0 ws0">(such<span class="_ _11"> </span>as<span class="_ _16"> </span><span class="ffd">malloc</span>,<span class="_ _16"> </span><span class="ffd">free</span>,<span class="_ _16"> </span><span class="ffd">realloc</span>,<span class="_ _16"> </span><span class="ffd">printf</span>,<span class="_ _16"> </span>and<span class="_ _11"> </span><span class="ffd">scanf</span>),<span class="_ _16"> </span>are<span class="_ _16"> </span>thread-safe<span class="_ _1"></span>,<span class="_ _16"> </span>with<span class="_ _16"> </span>only</div><div class="t m5 x1d h26 y83f8 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _15"> </span>few<span class="_ _15"> </span>exceptions<span class="_ _1"></span>.<span class="_ _15"> </span>F<span class="_ _1"></span>igure<span class="_ _15"> </span>12.41<span class="_ _15"> </span>lists<span class="_ _15"> </span>some<span class="_ _15"> </span>common<span class="_ _15"> </span>exceptions<span class="_ _1"></span>.<span class="_ _15"> </span>(See<span class="_ _15"> </span>[110]<span class="_ _15"> </span>for<span class="_ _15"> </span>a</div><div class="t m5 x1d h26 y83f9 ff7 fs19 fc1 sc0 ls0 ws0">complete<span class="_ _16"> </span>list.)<span class="_ _14"> </span>T<span class="_ _1"></span>he<span class="_ _14"> </span><span class="ffd">strtok<span class="_ _14"> </span></span>function<span class="_ _16"> </span>is<span class="_ _14"> </span>a<span class="_ _16"> </span>deprecated<span class="_ _14"> </span>function<span class="_ _16"> </span>(one<span class="_ _14"> </span>whose<span class="_ _14"> </span>use<span class="_ _16"> </span>is</div><div class="t m5 x1d h26 y83fa ff7 fs19 fc1 sc0 ls0 ws0">discouraged)<span class="_ _16"> </span>for<span class="_ _16"> </span>parsing<span class="_ _16"> </span>strings<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span><span class="ffd">asctime</span>,<span class="_ _16"> </span><span class="ffd">ctime</span>,<span class="_ _14"> </span>and<span class="_ _16"> </span><span class="ffd">localtime<span class="_ _16"> </span></span>functions</div><div class="t m5 x1d h26 y83fb ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_ _11"> </span>popular<span class="_ _16"> </span>functions<span class="_ _16"> </span>for<span class="_ _11"> </span>converting<span class="_ _16"> </span>back<span class="_ _11"> </span>and<span class="_ _16"> </span>forth<span class="_ _16"> </span>between<span class="_ _11"> </span>different<span class="_ _16"> </span>time<span class="_ _11"> </span>and</div><div class="t m5 x1d h26 y83fc ff7 fs19 fc1 sc0 ls0 ws0">date<span class="_ _f"> </span>formats<span class="_ _1"></span>.<span class="_ _e"> </span>T<span class="_ _1"></span>he<span class="_ _e"> </span><span class="ffd">gethostbyaddr</span>,<span class="_ _e"> </span><span class="ffd">gethostbyname</span>,<span class="_ _e"> </span>and<span class="_ _e"> </span><span class="ffd">inet_ntoa<span class="_ _f"> </span></span>functions</div><div class="t m5 x1d h26 y83fd ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_ _21"> </span>obsolete<span class="_ _f"> </span>network<span class="_ _f"> </span>programming<span class="_ _21"> </span>functions<span class="_ _f"> </span>that<span class="_ _f"> </span>have<span class="_ _f"> </span>been<span class="_ _21"> </span>replaced<span class="_ _f"> </span>by<span class="_ _f"> </span>the</div><div class="t m5 x1d h26 y83fe ff7 fs19 fc1 sc0 ls0 ws0">reentrant<span class="_ _6"> </span><span class="ffd">getaddrinfo</span>,<span class="_ _13"> </span><span class="ffd">getnameinfo</span>,<span class="_ _13"> </span>and<span class="_ _6"> </span><span class="ffd">inet_ntop<span class="_ _6"> </span></span>functions<span class="_ _1"></span>,<span class="_ _13"> </span>respectively<span class="_ _6"> </span>(see</div><div class="t m5 x1d h26 y83ff ff7 fs19 fc1 sc0 ls0 ws0">Chapter<span class="_ _6"> </span>11).<span class="_ _6"> </span>With<span class="_ _a"> </span>the<span class="_ _13"> </span>exceptions<span class="_ _a"> </span>of<span class="_ _6"> </span><span class="ffd">rand<span class="_ _13"> </span></span>and<span class="_ _a"> </span><span class="ffd">strtok</span>,<span class="_ _13"> </span>they<span class="_ _6"> </span>are<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _a"> </span>class<span class="_ _6"> </span>3<span class="_ _13"> </span>variety</div><div class="t m5 x1d h26 y8400 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _13"> </span>return<span class="_ _13"> </span>a<span class="_ _6"> </span>pointer<span class="_ _13"> </span>to<span class="_ _13"> </span>a<span class="_ _13"> </span>static<span class="_ _13"> </span>variable<span class="_ _1"></span>.<span class="_ _13"> </span>If<span class="_ _13"> </span>we<span class="_ _13"> </span>need<span class="_ _6"> </span>to<span class="_ _13"> </span>call<span class="_ _13"> </span>one<span class="_ _13"> </span>of<span class="_ _13"> </span>these<span class="_ _6"> </span>functions<span class="_ _13"> </span>in</div><div class="t m5 x1d h26 y8401 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _13"> </span>threaded<span class="_ _13"> </span>program,<span class="_ _13"> </span>the<span class="_ _13"> </span>least<span class="_ _13"> </span>disruptive<span class="_ _13"> </span>approach<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>caller<span class="_ _13"> </span>is<span class="_ _13"> </span>to<span class="_ _6"> </span>lock<span class="_ _13"> </span>and<span class="_ _13"> </span>copy<span class="_ _3"></span>.</div><div class="t m5 x1d h26 y8402 ff7 fs19 fc1 sc0 ls0 ws0">However,<span class="_ _11"> </span>the<span class="_ _11"> </span>lock-and-copy<span class="_ _11"> </span>approach<span class="_ _16"> </span>has<span class="_ _11"> </span>a<span class="_ _11"> </span>number<span class="_ _11"> </span>of<span class="_ _16"> </span>disadvantages<span class="_ _3"></span>.<span class="_ _16"> </span>F<span class="_ _1"></span>irst,<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y8403 ff7 fs19 fc1 sc0 ls0 ws0">additional<span class="_ _6"> </span>synchronization<span class="_ _13"> </span>slows<span class="_ _6"> </span>down<span class="_ _13"> </span>the<span class="_ _6"> </span>program.<span class="_ _13"> </span>Second,<span class="_ _6"> </span>functions<span class="_ _13"> </span>that<span class="_ _6"> </span>return</div><div class="t m5 x1d h26 y8404 ff7 fs19 fc1 sc0 ls0 ws0">pointers<span class="_"> </span>to<span class="_"> </span>complex<span class="_"> </span>structures<span class="_"> </span>of<span class="_"> </span>structures<span class="_"> </span>require<span class="_"> </span>a<span class="_"> </span><span class="ffa">deep<span class="_"> </span>cop<span class="_ _0"></span>y<span class="_"> </span><span class="ff7">of<span class="_"> </span>the<span class="_"> </span>structures</span></span></div><div class="t m5 x1d h26 y8405 ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_ _13"> </span>order<span class="_ _13"> </span>to<span class="_ _13"> </span>copy<span class="_ _13"> </span>the<span class="_ _13"> </span>entire<span class="_ _13"> </span>structure<span class="_"> </span>hierarchy<span class="_ _7"></span>.<span class="_ _13"> </span>T<span class="_ _0"></span>hird,<span class="_ _13"> </span>the<span class="_ _13"> </span>lock-and-copy<span class="_ _13"> </span>approach</div><div class="t m5 x1d h26 y8406 ff7 fs19 fc1 sc0 ls0 ws0">will<span class="_ _13"> </span>not<span class="_"> </span>work<span class="_ _13"> </span>for<span class="_"> </span>a<span class="_ _13"> </span>class<span class="_ _13"> </span>2<span class="_"> </span>thread-unsafe<span class="_ _13"> </span>function<span class="_"> </span>such<span class="_ _13"> </span>as<span class="_"> </span><span class="ffd">rand<span class="_ _13"> </span></span>that<span class="_ _13"> </span>relies<span class="_"> </span>on<span class="_ _13"> </span>static</div><div class="t m5 x1d h26 y8407 ff7 fs19 fc1 sc0 ls0 ws0">state<span class="_"> </span>across<span class="_"> </span>calls<span class="_ _1"></span>.</div><div class="t m5 x1d h31 y8408 ff7 fs21 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hread-unsafe<span class="_"> </span>function<span class="_ _26"> </span>Thread-unsafe<span class="_"> </span>class<span class="_ _26"> </span>Linux<span class="_"> </span>thread-safe<span class="_"> </span>version</div><div class="t m5 x1d h2d y8409 ffd fs1e fc2 sc0 ls0 ws0">rand</div><div class="t m5 x184 h31 y2605 ff7 fs21 fc2 sc0 ls0 ws0">2<span class="_ _6b"> </span><span class="ffd fs1e">rand_r</span></div><div class="t m5 x1d h2d y840a ffd fs1e fc2 sc0 ls0 ws0">strtok</div><div class="t m5 x184 h31 y840b ff7 fs21 fc2 sc0 ls0 ws0">2<span class="_ _6b"> </span><span class="ffd fs1e">strtok_r</span></div><div class="t m5 x1d h2d y840c ffd fs1e fc2 sc0 ls0 ws0">asctime</div><div class="t m5 x184 h31 y840d ff7 fs21 fc2 sc0 ls0 ws0">3<span class="_ _6b"> </span><span class="ffd fs1e">asctime_r</span></div><div class="t m5 x1d h2d y840e ffd fs1e fc2 sc0 ls0 ws0">ctime</div><div class="t m5 x184 h31 y840f ff7 fs21 fc2 sc0 ls0 ws0">3<span class="_ _6b"> </span><span class="ffd fs1e">ctime_r</span></div><div class="t m5 x1d h2d y8410 ffd fs1e fc2 sc0 ls0 ws0">gethostbyaddr</div><div class="t m5 x184 h31 y8411 ff7 fs21 fc2 sc0 ls0 ws0">3<span class="_ _6b"> </span><span class="ffd fs1e">gethostbyaddr_r</span></div><div class="t m5 x1d h2d y8412 ffd fs1e fc2 sc0 ls0 ws0">gethostbyname</div><div class="t m5 x184 h31 y8413 ff7 fs21 fc2 sc0 ls0 ws0">3<span class="_ _6b"> </span><span class="ffd fs1e">gethostbyname_r</span></div><div class="t m5 x1d h2d y8414 ffd fs1e fc2 sc0 ls0 ws0">inet_ntoa</div><div class="t m5 x184 h31 y68a6 ff7 fs21 fc2 sc0 ls0 ws0">3<span class="_ _6b"> </span>(none)</div><div class="t m5 x1d h31 y18e1 ffd fs1e fc2 sc0 ls0 ws0">localtime<span class="_ _233"> </span><span class="ff7 fs21">3<span class="_ _6b"> </span></span>localtime_r</div><div class="t m5 x1d h2f y18e2 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.41<span class="_ _66"> </span><span class="fc1">Common<span class="_"> </span>thread-unsafe<span class="_"> </span>librar<span class="_ _2"></span>y<span class="_"> </span>functions.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
