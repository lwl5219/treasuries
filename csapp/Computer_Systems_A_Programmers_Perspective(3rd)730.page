<div id="pf2da" class="pf w2 h11" data-page-no="2da"><div class="pc pc2da w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2da.png"/><div class="t m5 x1bd h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>7.7<span class="_ _60"> </span>Relocation<span class="_ _3e"> </span><span class="ffe fs1e">729</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">and</div><div class="t m5 x17 h2d y6083 ffd fs1e fc2 sc0 ls0 ws0">ADDR(r.symbol)<span class="_ _e"> </span>=<span class="_ _1f"> </span>ADDR(sum)<span class="_ _1f"> </span>=<span class="_ _e"> </span>0x4004e8</div><div class="t m5 x26 h26 y6084 ff7 fs19 fc2 sc0 ls0 ws0">Using<span class="_ _15"> </span>the<span class="_ _15"> </span>algorithm<span class="_ _21"> </span>in<span class="_ _15"> </span>Figure<span class="_ _14"> </span>7.10,<span class="_ _f"> </span>the<span class="_ _15"> </span>linker<span class="_ _21"> </span>ﬁrst<span class="_ _15"> </span>computes<span class="_ _15"> </span>the<span class="_ _21"> </span>run-time</div><div class="t m5 x17 h26 y6085 ff7 fs19 fc2 sc0 ls0 ws0">address<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>reference<span class="_"> </span>(line<span class="_"> </span>7):</div><div class="t m5 x17 h2d y6086 ffd fs1e fc2 sc0 ls0 ws0">refaddr<span class="_ _e"> </span>=<span class="_ _1f"> </span>ADDR(s)<span class="_ _1a"> </span>+<span class="_ _1f"> </span>r.offset</div><div class="t m5 x21e h2d y6087 ffd fs1e fc2 sc0 ls0 ws0">=<span class="_ _e"> </span>0x4004d0<span class="_ _1f"> </span>+<span class="_ _1f"> </span>0xf</div><div class="t m5 x21e h2d y6088 ffd fs1e fc2 sc0 ls0 ws0">=<span class="_ _e"> </span>0x4004df</div><div class="t m5 x17 h26 y6089 ff7 fs19 fc2 sc0 ls0 ws0">It<span class="_ _16"> </span>then<span class="_ _11"> </span>updates<span class="_ _16"> </span>the<span class="_ _16"> </span>reference<span class="_ _11"> </span>so<span class="_ _16"> </span>that<span class="_ _11"> </span>it<span class="_ _16"> </span>will<span class="_ _16"> </span>point<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">sum<span class="_ _11"> </span></span>routine<span class="_ _16"> </span>at<span class="_ _16"> </span>run<span class="_ _11"> </span>time</div><div class="t m5 x17 h26 y608a ff7 fs19 fc2 sc0 ls0 ws0">(line<span class="_"> </span>8):</div><div class="t m5 x17 h2d y608b ffd fs1e fc2 sc0 ls0 ws0">*refptr<span class="_ _e"> </span>=<span class="_ _1f"> </span>(unsigned)<span class="_ _1f"> </span>(ADDR(r.symbol)<span class="_ _e"> </span>+<span class="_ _1f"> </span>r.addend<span class="_ _e"> </span>-<span class="_ _1f"> </span>refaddr)</div><div class="t m5 x21e h2d y608c ffd fs1e fc2 sc0 ls0 ws0">=<span class="_ _e"> </span>(unsigned)<span class="_ _1f"> </span>(0x4004e8<span class="_ _6f"> </span>+<span class="_ _1f"> </span>(-4)<span class="_ _58"> </span>-<span class="_ _1f"> </span>0x4004df)</div><div class="t m5 x21e h2d y608d ffd fs1e fc2 sc0 ls0 ws0">=<span class="_ _e"> </span>(unsigned)<span class="_ _1f"> </span>(0x5)</div><div class="t m5 x17 h26 y608e ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _f"> </span>the<span class="_ _f"> </span>resulting<span class="_ _f"> </span>executable<span class="_ _f"> </span>object<span class="_ _f"> </span>ﬁle,<span class="_ _e"> </span>the<span class="_ _21"> </span><span class="ffd">call<span class="_ _f"> </span></span>instruction<span class="_ _f"> </span>has<span class="_ _f"> </span>the<span class="_ _f"> </span>following</div><div class="t m5 x17 h26 y608f ff7 fs19 fc2 sc0 ls0 ws0">relocated<span class="_"> </span>form:</div><div class="t m5 x72 h2d y6090 ffd fs1e fc2 sc0 ls0 ws0">4004de:<span class="_ _1a"> </span>e8<span class="_ _e"> </span>05<span class="_ _1f"> </span>00<span class="_ _1f"> </span>00<span class="_ _e"> </span>00<span class="_ _86"> </span>callq<span class="_ _1a"> </span>4004e8<span class="_ _1f"> </span>&lt;sum&gt;<span class="_ _62"> </span><span class="ff13 fs35 fc6">sum()</span></div><div class="t m5 x26 h26 y6091 ff7 fs19 fc2 sc0 ls0 ws0">At<span class="_"> </span>run<span class="_"> </span>time,<span class="_"> </span>the<span class="_"> </span><span class="ffd">call<span class="_ _10"> </span></span>instruction<span class="_"> </span>will<span class="_"> </span>be<span class="_"> </span>located<span class="_ _11"> </span>at<span class="_"> </span>address<span class="_"> </span><span class="ffd">0x4004de</span>.<span class="_"> </span>When</div><div class="t m5 x17 h26 y6092 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>CPU<span class="_ _16"> </span>executes<span class="_ _16"> </span>the<span class="_ _14"> </span><span class="ffd">call<span class="_ _16"> </span></span>instruction,<span class="_ _14"> </span>the<span class="_ _16"> </span>PC<span class="_ _16"> </span>has<span class="_ _16"> </span>a<span class="_ _14"> </span>value<span class="_ _16"> </span>of<span class="_ _16"> </span><span class="ffd">0x4004e3</span>,<span class="_ _14"> </span>which</div><div class="t m5 x17 h26 y6093 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _16"> </span>the<span class="_ _16"> </span>address<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _16"> </span>instruction<span class="_ _16"> </span>immediately<span class="_ _16"> </span>following<span class="_ _14"> </span>the<span class="_ _16"> </span><span class="ffd">call<span class="_ _16"> </span></span>instruction.<span class="_ _16"> </span>T<span class="_ _3"></span>o</div><div class="t m5 x17 h26 y6094 ff7 fs19 fc2 sc0 ls0 ws0">execute<span class="_"> </span>the<span class="_"> </span>call<span class="_"> </span>instruction,<span class="_"> </span>the<span class="_"> </span>CPU<span class="_"> </span>performs<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>steps:</div><div class="t m5 x1cd h26 y6095 ffc fs19 fc2 sc0 ls0 ws0">1.<span class="_ _e"> </span><span class="ff7">Push<span class="_"> </span>PC<span class="_"> </span>onto<span class="_"> </span>stack</span></div><div class="t m5 x1cd h46 y6096 ffc fs19 fc2 sc0 ls0 ws0">2.<span class="_ _e"> </span><span class="ff7">PC<span class="_ _1d"> </span><span class="ff12">←<span class="_ _24"> </span></span>PC<span class="_"> </span><span class="ff12">+<span class="_ _13"> </span><span class="ffd">0x5<span class="_ _13"> </span></span>=<span class="_ _10"> </span><span class="ffd">0x4004e3<span class="_ _13"> </span></span>+<span class="_ _10"> </span><span class="ffd">0x5<span class="_ _13"> </span></span>=<span class="_ _13"></span><span class="ffd">0x4004e8</span></span></span></div><div class="t m5 x17 h26 y6097 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_ _21"> </span>the<span class="_ _14"> </span>next<span class="_ _15"> </span>instruction<span class="_ _14"> </span>to<span class="_ _15"> </span>execute<span class="_ _14"> </span>is<span class="_ _15"> </span>the<span class="_ _14"> </span>ﬁrst<span class="_ _14"> </span>instruction<span class="_ _15"> </span>of<span class="_ _14"> </span>the<span class="_ _15"> </span><span class="ffd">sum<span class="_ _14"> </span></span>routine,</div><div class="t m5 x17 h26 y6098 ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_"> </span>of<span class="_"> </span>course<span class="_"> </span>is<span class="_"> </span>what<span class="_"> </span>we<span class="_"> </span>want!</div><div class="t m5 x17 h42 y6099 ff6 fs29 fc6 sc0 ls0 ws0">Relocating<span class="_ _11"> </span>Absolute<span class="_ _16"> </span>References</div><div class="t m5 x17 h26 y609a ff7 fs19 fc1 sc0 ls0 ws0">Relocating<span class="_ _16"> </span>absolute<span class="_ _16"> </span>references<span class="_ _11"> </span>is<span class="_ _16"> </span>straightforward.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _16"> </span>example<span class="_ _0"></span>,<span class="_ _16"> </span>in<span class="_ _16"> </span>line<span class="_ _16"> </span>4<span class="_ _16"> </span>in<span class="_ _16"> </span>F<span class="_ _1"></span>ig-</div><div class="t m5 x17 h26 y609b ff7 fs19 fc1 sc0 ls0 ws0">ure<span class="_ _6"> </span>7.11,<span class="_ _13"> </span>the<span class="_ _a"> </span><span class="ffd">mov<span class="_ _13"> </span></span>instruction<span class="_ _a"> </span>copies<span class="_ _13"> </span>the<span class="_ _a"> </span>address<span class="_ _13"> </span>of<span class="_ _a"> </span><span class="ffd">array<span class="_ _6"> </span></span>(a<span class="_ _13"> </span>32-bit<span class="_ _a"> </span>immediate<span class="_ _13"> </span>value)</div><div class="t m5 x17 h26 y609c ff7 fs19 fc1 sc0 ls0 ws0">into<span class="_"> </span>register<span class="_ _13"> </span><span class="ffd">%edi</span><span class="ls276">.T<span class="_ _4a"></span>h<span class="_ _4a"></span>e<span class="ffd ls0">mov<span class="_ _10"> </span><span class="ff7">instruction<span class="_"> </span>begins<span class="_ _13"> </span>at<span class="_"> </span>section<span class="_ _13"> </span>offset<span class="_"> </span></span>0x9<span class="_ _10"> </span><span class="ff7">and<span class="_ _13"> </span>consists<span class="_"> </span>of</span></span></span></div><div class="t m5 x17 h26 y609d ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _11"> </span>1-byte<span class="_ _16"> </span>opcode<span class="_ _11"> </span><span class="ffd">0xbf</span>,<span class="_ _16"> </span>followed<span class="_ _11"> </span>by<span class="_ _11"> </span>a<span class="_ _16"> </span>placeholder<span class="_ _11"> </span>for<span class="_ _11"> </span>the<span class="_ _16"> </span>32-bit<span class="_ _11"> </span>absolute<span class="_ _16"> </span>refer<span class="_ _3"></span>-</div><div class="t m5 x17 h26 y609e ff7 fs19 fc1 sc0 ls0 ws0">ence<span class="_"> </span>to<span class="_"> </span><span class="ffd">array</span>.</div><div class="t m5 x26 h26 y609f ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>corresponding<span class="_"> </span>relocation<span class="_"> </span>entry<span class="_"> </span><span class="ffd">r<span class="_ _10"> </span></span>consists<span class="_"> </span>of<span class="_"> </span>four<span class="_"> </span>ﬁelds:</div><div class="t m5 x17 h2d y60a0 ffd fs1e fc2 sc0 ls0 ws0">r.offset<span class="_ _e"> </span>=<span class="_ _1f"> </span>0xa</div><div class="t m5 x17 h2d y60a1 ffd fs1e fc2 sc0 ls0 ws0">r.symbol<span class="_ _e"> </span>=<span class="_ _1f"> </span>array</div><div class="t m5 x17 h2d y60a2 ffd fs1e fc2 sc0 ls0 ws0">r.type<span class="_ _3f"> </span>=<span class="_ _e"> </span>R_X86_64_32</div><div class="t m5 x17 h2d y60a3 ffd fs1e fc2 sc0 ls0 ws0">r.addend<span class="_ _e"> </span>=<span class="_ _1f"> </span>0</div><div class="t m5 x17 h26 y8d6 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hese<span class="_ _11"> </span>ﬁelds<span class="_"> </span>tell<span class="_"> </span>the<span class="_ _11"> </span>linker<span class="_"> </span>to<span class="_"> </span>modify<span class="_ _11"> </span>the<span class="_"> </span>absolute<span class="_"> </span>reference<span class="_ _11"> </span>starting<span class="_"> </span>at<span class="_"> </span>offset<span class="_ _11"> </span><span class="ffd">0xa</span></div><div class="t m5 x17 h26 y8d7 ff7 fs19 fc2 sc0 ls0 ws0">so<span class="_ _11"> </span>that<span class="_ _16"> </span>it<span class="_ _11"> </span>will<span class="_ _16"> </span>point<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span>ﬁrst<span class="_ _16"> </span>byte<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffd">array<span class="_ _11"> </span></span>at<span class="_ _16"> </span>run<span class="_ _11"> </span>time<span class="_ _0"></span>.<span class="_ _11"> </span>Now<span class="_ _3"></span>,<span class="_ _16"> </span>suppose<span class="_ _11"> </span>that<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y8d8 ff7 fs19 fc2 sc0 ls0 ws0">linker<span class="_"> </span>has<span class="_"> </span>determined<span class="_"> </span>that</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
