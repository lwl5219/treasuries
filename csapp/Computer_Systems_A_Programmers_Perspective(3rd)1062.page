<div id="pf426" class="pf w2 h11" data-page-no="426"><div class="pc pc426 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg426.png"/><div class="t m5 x13a h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.7<span class="_ _60"> </span>Other<span class="_ _10"> </span>Concurrency<span class="_ _10"> </span>Issues<span class="_ _3e"> </span><span class="ffe fs1e">1061</span></div><div class="t m5 x26 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>herefore,<span class="_ _16"> </span>Linux<span class="_ _16"> </span>systems<span class="_ _16"> </span>provide<span class="_ _14"> </span>reentrant<span class="_ _16"> </span>versions<span class="_ _16"> </span>of<span class="_ _16"> </span>most<span class="_ _14"> </span>thread-unsafe</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">functions<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _0"></span>he<span class="_"> </span>names<span class="_"> </span>of<span class="_"> </span>the<span class="_ _11"> </span>reentrant<span class="_"> </span>versions<span class="_"> </span>always<span class="_"> </span>end<span class="_ _11"> </span>with<span class="_"> </span>the<span class="_"> </span><span class="ffd">_r<span class="_ _11"> </span></span>sufﬁx.<span class="_"> </span>F<span class="_ _1"></span>or</div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">example<span class="_ _1"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>reentrant<span class="_ _11"> </span>version<span class="_ _16"> </span>of<span class="_ _11"> </span><span class="ffd">asctime<span class="_ _11"> </span></span>is<span class="_ _16"> </span>called<span class="_ _11"> </span><span class="ffd">asctime_r</span>.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>recommend</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">using<span class="_"> </span>these<span class="_"> </span>functions<span class="_"> </span>whenever<span class="_"> </span>possible<span class="_ _1"></span>.</div><div class="t m5 x17 h41 y8415 ffe fs29 fc2 sc0 ls0 ws0">12.7.4<span class="_ _48"> </span><span class="fs19">Races</span></div><div class="t m5 x17 h26 y8416 ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_ _13"> </span><span class="ffa">race<span class="_"> </span></span>occurs<span class="_ _13"> </span>when<span class="_ _13"> </span>the<span class="_"> </span>correctness<span class="_ _13"> </span>of<span class="_ _13"> </span>a<span class="_ _13"> </span>program<span class="_"> </span>depends<span class="_ _13"> </span>on<span class="_ _13"> </span>one<span class="_ _13"> </span>thread<span class="_"> </span>reaching</div><div class="t m5 x17 h26 y8417 ff7 fs19 fc2 sc0 ls0 ws0">point<span class="_ _16"> </span><span class="ff11">x<span class="_ _15"> </span></span>in<span class="_ _16"> </span>its<span class="_ _16"> </span>control<span class="_ _16"> </span>ﬂow<span class="_ _16"> </span>before<span class="_ _16"> </span>another<span class="_ _16"> </span>thread<span class="_ _16"> </span>reaches<span class="_ _16"> </span>point<span class="_ _16"> </span><span class="ff11">y<span class="_ _2"></span></span>.<span class="_ _16"> </span>Races<span class="_ _16"> </span>usually</div><div class="t m5 x17 h26 y8418 ff7 fs19 fc2 sc0 ls0 ws0">occur<span class="_"> </span>because<span class="_ _13"> </span>programmers<span class="_"> </span>assume<span class="_ _13"> </span>that<span class="_"> </span>threads<span class="_"> </span>will<span class="_ _13"> </span>take<span class="_"> </span>some<span class="_ _13"> </span>particular<span class="_"> </span>trajec-</div><div class="t m5 x17 h26 y8419 ff7 fs19 fc2 sc0 ls0 ws0">tory<span class="_ _16"> </span>through<span class="_ _11"> </span>the<span class="_ _16"> </span>execution<span class="_ _16"> </span>state<span class="_ _11"> </span>space,<span class="_ _16"> </span>forgetting<span class="_ _11"> </span>the<span class="_ _16"> </span>golden<span class="_ _16"> </span>rule<span class="_ _11"> </span>that<span class="_ _16"> </span>threaded</div><div class="t m5 x17 h26 y841a ff7 fs19 fc2 sc0 ls0 ws0">programs<span class="_"> </span>must<span class="_"> </span>work<span class="_"> </span>correctly<span class="_"> </span>for<span class="_"> </span>any<span class="_"> </span>feasible<span class="_"> </span>trajectory<span class="_ _3"></span>.</div><div class="t m5 x26 h26 y841b ff7 fs19 fc2 sc0 ls0 ws0">An<span class="_ _13"> </span>example<span class="_ _13"> </span>is<span class="_ _13"> </span>the<span class="_ _13"> </span>easiest<span class="_ _13"> </span>way<span class="_ _13"> </span>to<span class="_ _13"> </span>understand<span class="_ _13"> </span>the<span class="_ _13"> </span>nature<span class="_ _13"> </span>of<span class="_ _13"> </span>races<span class="_ _1"></span>.<span class="_"> </span>Consider<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y841c ff7 fs19 fc2 sc0 ls0 ws0">simple<span class="_ _16"> </span>program<span class="_ _16"> </span>in<span class="_ _16"> </span>F<span class="_ _1"></span>igure<span class="_ _16"> </span>12.42.<span class="_ _16"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span>main<span class="_ _16"> </span>thread<span class="_ _16"> </span>creates<span class="_ _16"> </span>four<span class="_ _16"> </span>peer<span class="_ _16"> </span>threads<span class="_ _11"> </span>and</div><div class="t m5 x17 h26 y841d ff7 fs19 fc2 sc0 ls0 ws0">passes<span class="_"> </span>a<span class="_"> </span>pointer<span class="_ _11"> </span>to<span class="_"> </span>a<span class="_ _11"> </span>unique<span class="_"> </span>integer<span class="_"> </span>ID<span class="_ _11"> </span>to<span class="_"> </span>each<span class="_ _11"> </span>one<span class="_ _0"></span>.<span class="_"> </span>Each<span class="_"> </span>peer<span class="_ _11"> </span>thread<span class="_"> </span>copies<span class="_ _11"> </span>the</div><div class="t m5 xde h2c y841e ffa fs16 fc2 sc0 ls0 ws0">code/conc/race.c</div><div class="t m5 x2c h2e y841f ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x2d h2d y8420 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>WARNING:<span class="_ _1f"> </span>This<span class="_ _1f"> </span>code<span class="_ _e"> </span>is<span class="_ _1f"> </span>buggy!<span class="_ _e"> </span>*/</div><div class="t m5 x2c h2d y8421 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h2d y8422 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">#define<span class="_ _1f"> </span>N<span class="_ _e"> </span>4</span></div><div class="t m5 x2c h2e y8423 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y8424 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2d h2d y8425 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*thread(void<span class="_ _1f"> </span>*vargp);</div><div class="t m5 x2c h2e y8426 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2c h2e y8427 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x2d h2d y8428 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x2c h2d y6891 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y8429 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">pthread_t<span class="_ _e"> </span>tid[N];</span></div><div class="t m5 x17 h2d y842a ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i;</span></div><div class="t m5 x17 h2e y6894 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x17 h2e y842b ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x142 h2d y6895 ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;N<span class="_ _41"></span>;<span class="ls0">i++)</span></div><div class="t m5 x17 h2d y6896 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _70"> </span><span class="ffd fs1e fc2">Pthread_create(&amp;tid[i],<span class="_ _e"> </span>NULL,<span class="_ _1f"> </span>thread,<span class="_ _1f"> </span>&amp;i);</span></div><div class="t m5 x17 h2d y6897 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2 ls33">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;N<span class="_ _41"></span>;<span class="ls0">i++)</span></span></div><div class="t m5 x17 h2d y6898 ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _70"> </span><span class="ffd fs1e fc2">Pthread_join(tid[i],<span class="_ _e"> </span>NULL);</span></div><div class="t m5 x17 h2d y689a ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x17 h2d y689b ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y689c ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x17 h2e y842c ff6 fs20 fc6 sc0 ls0 ws0">19</div><div class="t m5 x2d h2d y689e ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Thread<span class="_ _1f"> </span>routine<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y689f ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>*thread(void<span class="_ _e"> </span>*vargp)</span></div><div class="t m5 x17 h2d y68a0 ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y68a2 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>myid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>*((int<span class="_ _e"> </span>*)vargp);</span></div><div class="t m5 x17 h2d y68a3 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>%d\n&quot;,<span class="_ _e"> </span>myid);</span></div><div class="t m5 x17 h2d y68a5 ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>NULL;</span></div><div class="t m5 x17 h2d y68a6 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 xde h2c y68a7 ffa fs16 fc2 sc0 ls0 ws0">code/conc/race.c</div><div class="t m5 x17 h2f y68a8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.42<span class="_ _66"> </span><span class="fc1">A<span class="_"> </span>program<span class="_"> </span>with<span class="_"> </span>a<span class="_"> </span>race.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
