<div id="pf116" class="pf w2 h11" data-page-no="116"><div class="pc pc116 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg116.png"/><div class="t m5 xb5 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>3.7<span class="_ _60"> </span>Procedures<span class="_ _3e"> </span><span class="ffe fs1e">277</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">space<span class="_ _14"> </span>for<span class="_ _14"> </span>local<span class="_ _14"> </span>variables<span class="_ _0"></span>,<span class="_ _15"> </span>and<span class="_ _14"> </span>set<span class="_ _14"> </span>up<span class="_ _15"> </span>arguments<span class="_ _14"> </span>for<span class="_ _14"> </span>the<span class="_ _14"> </span>procedures<span class="_ _15"> </span>it<span class="_ _14"> </span>calls<span class="_ _1"></span>.<span class="_ _14"> </span>The</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">stack<span class="_ _11"> </span>frames<span class="_ _16"> </span>for<span class="_ _11"> </span>most<span class="_ _16"> </span>procedures<span class="_ _11"> </span>are<span class="_ _16"> </span>of<span class="_ _11"> </span>ﬁxed<span class="_ _16"> </span>size<span class="_ _1"></span>,<span class="_ _16"> </span>allocated<span class="_ _16"> </span>at<span class="_ _11"> </span>the<span class="_ _16"> </span>beginning<span class="_ _11"> </span>of</div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _6"> </span>procedure.<span class="_ _6"> </span>Some<span class="_ _13"> </span>procedures<span class="_ _3"></span>,<span class="_ _13"> </span>however,<span class="_ _13"> </span>require<span class="_ _6"> </span>variable-size<span class="_ _13"> </span>frames<span class="_ _3"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>his<span class="_ _13"> </span>issue</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_"> </span>discussed<span class="_ _11"> </span>in<span class="_ _11"> </span>Section<span class="_ _11"> </span>3.10.5.<span class="_ _11"> </span>Procedure<span class="_ _11"> </span><span class="ffd">P<span class="_ _11"> </span></span>can<span class="_"> </span>pass<span class="_ _11"> </span>up<span class="_ _11"> </span>to<span class="_ _11"> </span>six<span class="_ _11"> </span>integral<span class="_"> </span>values<span class="_ _11"> </span>(i.e.,</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">pointers<span class="_ _11"> </span>and<span class="_ _16"> </span>integers)<span class="_ _11"> </span>on<span class="_ _16"> </span>the<span class="_ _16"> </span>stack,<span class="_ _11"> </span>but<span class="_ _16"> </span>if<span class="_ _11"> </span><span class="ffd">Q<span class="_ _16"> </span></span>requires<span class="_ _11"> </span>more<span class="_ _16"> </span>arguments<span class="_ _1"></span>,<span class="_ _16"> </span>these<span class="_ _11"> </span>can</div><div class="t m5 x17 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_"> </span>stored<span class="_"> </span>by<span class="_"> </span><span class="ffd">P<span class="_ _10"> </span></span>within<span class="_"> </span>its<span class="_"> </span>stack<span class="_"> </span>frame<span class="_"> </span>prior<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>call.</div><div class="t m5 x26 h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _16"> </span>the<span class="_ _11"> </span>interest<span class="_ _16"> </span>of<span class="_ _16"> </span>space<span class="_ _11"> </span>and<span class="_ _16"> </span>time<span class="_ _16"> </span>efﬁciency<span class="_ _7"></span>,<span class="_ _16"> </span>x86-64<span class="_ _16"> </span>procedures<span class="_ _16"> </span>allocate<span class="_ _11"> </span>only</div><div class="t m5 x17 h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>portions<span class="_ _14"> </span>of<span class="_ _14"> </span>stack<span class="_ _14"> </span>frames<span class="_ _16"> </span>they<span class="_ _14"> </span>require.<span class="_ _16"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>example,<span class="_ _14"> </span>many<span class="_ _14"> </span>procedures<span class="_ _14"> </span>have</div><div class="t m5 x17 h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">six<span class="_ _11"> </span>or<span class="_ _11"> </span>fewer<span class="_ _11"> </span>arguments<span class="_ _1"></span>,<span class="_ _11"> </span>and<span class="_ _11"> </span>so<span class="_ _11"> </span>all<span class="_ _11"> </span>of<span class="_ _11"> </span>their<span class="_ _11"> </span>parameters<span class="_ _16"> </span>can<span class="_"> </span>be<span class="_ _11"> </span>passed<span class="_ _11"> </span>in<span class="_ _11"> </span>registers<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_"> </span>parts<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>stack<span class="_ _13"> </span>frame<span class="_ _6"> </span>diagrammed<span class="_ _13"> </span>in<span class="_ _13"> </span>Figure<span class="_ _13"> </span>3.25<span class="_ _13"> </span>may<span class="_ _13"> </span>be<span class="_ _13"> </span>omitted.<span class="_ _13"> </span>Indeed,</div><div class="t m5 x17 h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">many<span class="_ _13"> </span>functions<span class="_ _6"> </span>do<span class="_ _13"> </span>not<span class="_ _13"> </span>even<span class="_ _13"> </span>require<span class="_ _6"> </span>a<span class="_ _13"> </span>stack<span class="_ _13"> </span>frame<span class="_ _1"></span>.<span class="_ _13"> </span>T<span class="_ _1"></span>his<span class="_ _13"> </span>occurs<span class="_ _13"> </span>when<span class="_ _6"> </span>all<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>local</div><div class="t m5 x17 h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">variables<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _13"> </span>held<span class="_ _6"> </span>in<span class="_ _13"> </span>registers<span class="_ _6"> </span>and<span class="_ _13"> </span>the<span class="_ _13"> </span>function<span class="_ _6"> </span>does<span class="_ _13"> </span>not<span class="_ _6"> </span>call<span class="_ _13"> </span>any<span class="_ _6"> </span>other<span class="_ _13"> </span>functions</div><div class="t m5 x17 h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">(sometimes<span class="_ _16"> </span>referred<span class="_ _16"> </span>to<span class="_ _16"> </span>as<span class="_ _16"> </span>a<span class="_ _16"> </span><span class="ffa">leaf<span class="_ _16"> </span>procedure</span>,<span class="_ _16"> </span>in<span class="_ _16"> </span>reference<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>tree<span class="_ _16"> </span>structure<span class="_ _16"> </span>of</div><div class="t m5 x17 h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">procedure<span class="_ _11"> </span>calls).<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _16"> </span>none<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>functions<span class="_ _16"> </span>we<span class="_ _11"> </span>have<span class="_ _11"> </span>examined<span class="_ _11"> </span>thus<span class="_ _16"> </span>far</div><div class="t m5 x17 h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">required<span class="_"> </span>stack<span class="_"> </span>frames<span class="_ _1"></span>.</div><div class="t m5 x17 h41 y293a ffe fs29 fc2 sc0 ls0 ws0">3.7.2<span class="_ _48"> </span><span class="fs19">Control<span class="_"> </span>T<span class="_ _3"></span>ransfer</span></div><div class="t m5 x17 h26 y293b ff7 fs19 fc2 sc0 ls0 ws0">Passing<span class="_"> </span>control<span class="_ _13"> </span>from<span class="_"> </span>function<span class="_"> </span><span class="ffd">P<span class="_ _13"> </span></span>to<span class="_"> </span>function<span class="_"> </span><span class="ffd">Q<span class="_ _13"> </span></span>involves<span class="_"> </span>simply<span class="_"> </span>setting<span class="_ _13"> </span>the<span class="_"> </span>program</div><div class="t m5 x17 h26 y293c ff7 fs19 fc2 sc0 ls0 ws0">counter<span class="_ _14"> </span>(PC)<span class="_ _14"> </span>to<span class="_ _14"> </span>the<span class="_ _15"> </span>starting<span class="_ _14"> </span>address<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _15"> </span>code<span class="_ _14"> </span>for<span class="_ _14"> </span><span class="ffd">Q</span>.<span class="_ _14"> </span>However,<span class="_ _15"> </span>when<span class="_ _14"> </span>it<span class="_ _14"> </span>later</div><div class="t m5 x17 h26 y293d ff7 fs19 fc2 sc0 ls0 ws0">comes<span class="_ _15"> </span>time<span class="_ _15"> </span>for<span class="_ _15"> </span><span class="ffd">Q<span class="_ _15"> </span></span>to<span class="_ _15"> </span>return,<span class="_ _21"> </span>the<span class="_ _15"> </span>processor<span class="_ _15"> </span>must<span class="_ _15"> </span>have<span class="_ _15"> </span>some<span class="_ _15"> </span>record<span class="_ _21"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>code</div><div class="t m5 x17 h26 y293e ff7 fs19 fc2 sc0 ls0 ws0">location<span class="_"> </span>where<span class="_"> </span>it<span class="_ _11"> </span>should<span class="_"> </span>resume<span class="_"> </span>the<span class="_ _11"> </span>execution<span class="_"> </span>of<span class="_"> </span><span class="ffd">P</span>.<span class="_ _11"> </span>T<span class="_ _1"></span>his<span class="_ _11"> </span>information<span class="_"> </span>is<span class="_"> </span>recorded</div><div class="t m5 x17 h26 y293f ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _15"> </span>x86-64<span class="_ _21"> </span>machines<span class="_ _15"> </span>by<span class="_ _21"> </span>invoking<span class="_ _21"> </span>procedure<span class="_ _15"> </span><span class="ffd">Q<span class="_ _21"> </span></span>with<span class="_ _21"> </span>the<span class="_ _15"> </span>instruction<span class="_ _21"> </span><span class="ffd">call<span class="_ _16"> </span>Q</span>.<span class="_ _15"> </span>T<span class="_ _0"></span>his</div><div class="t m5 x17 h26 y2940 ff7 fs19 fc2 sc0 ls0 ws0">instruction<span class="_ _11"> </span>pushes<span class="_ _11"> </span>an<span class="_ _16"> </span>address<span class="_ _11"> </span><span class="ff11">A<span class="_ _11"> </span></span>onto<span class="_ _11"> </span>the<span class="_ _16"> </span>stack<span class="_ _11"> </span>and<span class="_ _11"> </span>sets<span class="_ _11"> </span>the<span class="_ _16"> </span>PC<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span>beginning</div><div class="t m5 x17 h26 y2941 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _11"> </span><span class="ffd">Q</span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>pushed<span class="_ _16"> </span>address<span class="_ _11"> </span><span class="ff11">A<span class="_"> </span></span>is<span class="_ _11"> </span>referred<span class="_ _16"> </span>to<span class="_ _11"> </span>as<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ffa">return<span class="_ _16"> </span>address<span class="_ _16"> </span></span>and<span class="_ _11"> </span>is<span class="_ _16"> </span>computed</div><div class="t m5 x17 h26 y2942 ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_"> </span>the<span class="_"> </span>address<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>instruction<span class="_"> </span>immediately<span class="_"> </span>following<span class="_"> </span>the<span class="_"> </span><span class="ffd">call<span class="_ _10"> </span></span>instruction.<span class="_"> </span>The</div><div class="t m5 x17 h26 y2943 ff7 fs19 fc2 sc0 ls0 ws0">counterpart<span class="_"> </span>instruction<span class="_"> </span><span class="ffd">ret<span class="_ _10"> </span></span>pops<span class="_"> </span>an<span class="_"> </span>address<span class="_"> </span><span class="ff11">A<span class="_ _13"> </span></span>off<span class="_"> </span>the<span class="_"> </span>stack<span class="_"> </span>and<span class="_"> </span>sets<span class="_"> </span>the<span class="_"> </span>PC<span class="_"> </span>to<span class="_"> </span><span class="ff11">A</span>.</div><div class="t m5 x26 h26 y2944 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>general<span class="_"> </span>forms<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span><span class="ffd">call<span class="_ _10"> </span></span>and<span class="_"> </span><span class="ffd">ret<span class="_ _11"> </span></span>instructions<span class="_"> </span>are<span class="_"> </span>described<span class="_"> </span>as<span class="_"> </span>follows:</div><div class="t m5 x17 h31 y2945 ff7 fs21 fc2 sc0 ls0 ws0">Instruction<span class="_ _5d"> </span>Description</div><div class="t m5 x17 h31 y2946 ffd fs1e fc2 sc0 ls0 ws0">call<span class="_ _ea"> </span><span class="ffa fs21">Label<span class="_ _f4"> </span><span class="ff7">Procedure<span class="_"> </span>call</span></span></div><div class="t m5 x17 h31 y2947 ffd fs1e fc2 sc0 ls0 ws0">call<span class="_ _13d"> </span>*<span class="ffa fs21">Operand<span class="_ _26"> </span><span class="ff7">Procedure<span class="_"> </span>call</span></span></div><div class="t m5 x17 h2d y2948 ffd fs1e fc2 sc0 ls0 ws0">ret</div><div class="t m5 xc2 h31 y2949 ff7 fs21 fc2 sc0 ls0 ws0">Return<span class="_"> </span>from<span class="_"> </span>call</div><div class="t m5 x17 h26 y211a ff7 fs19 fc2 sc0 ls0 ws0">(T<span class="_ _1"></span>hese<span class="_"> </span>instructions<span class="_ _11"> </span>are<span class="_"> </span>referred<span class="_"> </span>to<span class="_"> </span>as<span class="_"> </span><span class="ffd">callq<span class="_ _11"> </span></span>and<span class="_"> </span><span class="ffd">retq<span class="_ _10"> </span></span>in<span class="_"> </span>the<span class="_"> </span>disassembly<span class="_"> </span>outputs</div><div class="t m5 x17 h26 y2237 ff7 fs19 fc2 sc0 ls0 ws0">generated<span class="_ _11"> </span>by<span class="_ _11"> </span>the<span class="_ _11"> </span>program<span class="_ _11"> </span><span class="ff9">objdump</span>.<span class="_"> </span>T<span class="_ _0"></span>he<span class="_ _11"> </span>added<span class="_ _11"> </span>sufﬁx<span class="_ _11"> </span>‘<span class="ffd">q</span>’<span class="_ _11"> </span>simply<span class="_ _16"> </span>emphasizes<span class="_"> </span>that</div><div class="t m5 x17 h26 y2238 ff7 fs19 fc2 sc0 ls0 ws0">these<span class="_ _21"> </span>are<span class="_ _f"> </span>x86-64<span class="_ _f"> </span>versions<span class="_ _f"> </span>of<span class="_ _21"> </span>call<span class="_ _f"> </span>and<span class="_ _f"> </span>return<span class="_ _f"> </span>instructions<span class="_ _1"></span>,<span class="_ _e"> </span>not<span class="_ _21"> </span>IA32.<span class="_ _f"> </span>In<span class="_ _21"> </span>x86-64</div><div class="t m5 x17 h26 y2239 ff7 fs19 fc2 sc0 ls0 ws0">assembly<span class="_"> </span>code<span class="_ _1"></span>,<span class="_"> </span>both<span class="_"> </span>versions<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>used<span class="_"> </span>interchangeably<span class="_ _3"></span>.)</div><div class="t m5 x26 h26 y223a ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _21"> </span><span class="ffd ls0">call<span class="_ _15"> </span><span class="ff7">instruction<span class="_ _21"> </span>has<span class="_ _15"> </span>a<span class="_ _15"> </span>target<span class="_ _15"> </span>indicating<span class="_ _15"> </span>the<span class="_ _15"> </span>address<span class="_ _15"> </span>of<span class="_ _21"> </span>the<span class="_ _15"> </span>instruction</span></span></div><div class="t m5 x17 h26 yd16 ff7 fs19 fc2 sc0 ls0 ws0">where<span class="_ _6"> </span>the<span class="_ _6"> </span>called<span class="_ _13"> </span>procedure<span class="_ _a"> </span>starts<span class="_ _1"></span>.<span class="_ _13"> </span>Like<span class="_ _a"> </span>jumps<span class="_ _1"></span>,<span class="_ _13"> </span>a<span class="_ _6"> </span>call<span class="_ _6"> </span>can<span class="_ _6"> </span>be<span class="_ _13"> </span>either<span class="_ _a"> </span>direct<span class="_ _13"> </span>or<span class="_ _a"> </span>indirect.</div><div class="t m5 x17 h26 yd17 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_"> </span>assembly<span class="_"> </span>code,<span class="_"> </span>the<span class="_"> </span>target<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>direct<span class="_ _11"> </span>call<span class="_"> </span>is<span class="_"> </span>given<span class="_ _11"> </span>as<span class="_"> </span>a<span class="_"> </span>label,<span class="_ _11"> </span>while<span class="_"> </span>the<span class="_"> </span>target<span class="_"> </span>of</div><div class="t m5 x17 h26 y223b ff7 fs19 fc2 sc0 ls0 ws0">an<span class="_ _11"> </span>indirect<span class="_ _16"> </span>call<span class="_ _16"> </span>is<span class="_ _11"> </span>given<span class="_ _16"> </span>by<span class="_ _11"> </span>‘<span class="ffd">*</span>’<span class="_ _16"> </span>followed<span class="_ _16"> </span>by<span class="_ _11"> </span>an<span class="_ _16"> </span>operand<span class="_ _11"> </span>speciﬁer<span class="_ _16"> </span>using<span class="_ _11"> </span>one<span class="_ _16"> </span>of<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y223c ff7 fs19 fc2 sc0 ls0 ws0">formats<span class="_"> </span>described<span class="_"> </span>in<span class="_"> </span>F<span class="_ _1"></span>igure<span class="_"> </span>3.3.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
