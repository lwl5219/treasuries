<div id="pf2ed" class="pf w2 h11" data-page-no="2ed"><div class="pc pc2ed w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2ed.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">748<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x53 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/mymalloc.c</div><div class="t m5 xb h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#ifdef<span class="_ _1f"> </span>RUNTIME</span></div><div class="t m5 xb h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#define<span class="_ _1f"> </span>_GNU_SOURCE</span></div><div class="t m5 xb h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&lt;stdio.h&gt;</span></div><div class="t m5 xb h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&lt;stdlib.h&gt;</span></div><div class="t m5 xb h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&lt;dlfcn.h&gt;</span></div><div class="t m5 xb h2e y286 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 xb h2e y6298 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x244 h2d y287 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>malloc<span class="_ _1f"> </span>wrapper<span class="_ _1f"> </span>function<span class="_ _e"> </span>*/</div><div class="t m5 xb h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>*malloc(size_t<span class="_ _e"> </span>size)</span></div><div class="t m5 xb h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x14 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">void<span class="_ _e"> </span>*(*mallocp)(size_t<span class="_ _1f"> </span>size);</span></div><div class="t m5 x14 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*error;</span></div><div class="t m5 x14 h2e y906 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x14 h2e y62c1 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x26 h2d y4a9d ffd fs1e fc2 sc0 ls0 ws0">mallocp<span class="_ _e"> </span>=<span class="_ _1f"> </span>dlsym(RTLD_NEXT,<span class="_ _1f"> </span>&quot;malloc&quot;);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Get<span class="_ _e"> </span>address<span class="_ _1f"> </span>of<span class="_ _1f"> </span>libc<span class="_ _e"> </span>malloc<span class="_ _1f"> </span>*/</div><div class="t m5 x14 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((error<span class="_ _1f"> </span>=<span class="_ _1f"> </span>dlerror())<span class="_ _e"> </span>!=<span class="_ _1f"> </span>NULL)<span class="_ _e"> </span>{</span></div><div class="t m5 x14 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _70"> </span><span class="ffd fs1e fc2">fputs(error,<span class="_ _e"> </span>stderr);</span></div><div class="t m5 x14 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _70"> </span><span class="ffd fs1e fc2">exit(1);</span></div><div class="t m5 x14 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*ptr<span class="_ _1f"> </span>=<span class="_ _1f"> </span>mallocp(size);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Call<span class="_ _e"> </span>libc<span class="_ _1f"> </span>malloc<span class="_ _1f"> </span>*/</span></div><div class="t m5 x14 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;malloc(%d)<span class="_ _e"> </span>=<span class="_ _1f"> </span>%p\n&quot;,<span class="_ _1f"> </span>(int)size,<span class="_ _e"> </span>ptr);</span></div><div class="t m5 x14 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>ptr;</span></div><div class="t m5 x14 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x244 h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x14 h2e y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x14 h2e y4aa2 ff6 fs20 fc6 sc0 ls0 ws0">23</div><div class="t m5 x244 h2d y3228 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>free<span class="_ _1f"> </span>wrapper<span class="_ _1f"> </span>function<span class="_ _e"> </span>*/</div><div class="t m5 x14 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>free(void<span class="_ _e"> </span>*ptr)</span></div><div class="t m5 x14 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x244 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">{</div><div class="t m5 x14 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _20"> </span><span class="ffd fs1e fc2">void<span class="_ _e"> </span>(*freep)(void<span class="_ _1f"> </span>*)<span class="_ _1f"> </span>=<span class="_ _e"> </span>NULL;</span></div><div class="t m5 x14 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*error;</span></div><div class="t m5 x14 h2e y322c ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x14 h2e y61ba ff6 fs20 fc6 sc0 ls0 ws0">29</div><div class="t m5 x26 h2d y441 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(!ptr)</div><div class="t m5 x14 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _70"> </span><span class="ffd fs1e fc2">return;</span></div><div class="t m5 x14 h2e y322d ff6 fs20 fc6 sc0 ls0 ws0">31</div><div class="t m5 x14 h2e y62c2 ff6 fs20 fc6 sc0 ls0 ws0">32</div><div class="t m5 x26 h2d y24a ffd fs1e fc2 sc0 ls0 ws0">freep<span class="_ _e"> </span>=<span class="_ _1f"> </span>dlsym(RTLD_NEXT,<span class="_ _1f"> </span>&quot;free&quot;);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Get<span class="_ _e"> </span>address<span class="_ _1f"> </span>of<span class="_ _1f"> </span>libc<span class="_ _e"> </span>free<span class="_ _1f"> </span>*/</div><div class="t m5 x14 h2d y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((error<span class="_ _1f"> </span>=<span class="_ _1f"> </span>dlerror())<span class="_ _e"> </span>!=<span class="_ _1f"> </span>NULL)<span class="_ _e"> </span>{</span></div><div class="t m5 x14 h2d y5fd ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _70"> </span><span class="ffd fs1e fc2">fputs(error,<span class="_ _e"> </span>stderr);</span></div><div class="t m5 x14 h2d y4aa5 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _70"> </span><span class="ffd fs1e fc2">exit(1);</span></div><div class="t m5 x14 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 x26 h2d y74d ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x14 h2d y277 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _20"> </span><span class="ffd fs1e fc2">freep(ptr);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Call<span class="_ _1f"> </span>libc<span class="_ _e"> </span>free<span class="_ _1f"> </span>*/</span></div><div class="t m5 x14 h2d y2269 ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;free(%p)\n&quot;,<span class="_ _e"> </span>ptr);</span></div><div class="t m5 x14 h2d y226b ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d y226d ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _1c"> </span><span class="ffd fs1e fc2">#endif</span></div><div class="t m5 x53 h2c y62c3 ffa fs16 fc2 sc0 ls0 ws0">code/link/interpose/mymalloc.c</div><div class="t m5 x14 h2f y62c4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>7.22<span class="_ _66"> </span><span class="fc1">Run-time<span class="_"> </span>interpositioning<span class="_"> </span>with</span></div><div class="t m5 xe2 h3a y62c5 ffd fs19 fc1 sc0 ls0 ws0">LD_PRELOAD<span class="ffe fs16">.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
