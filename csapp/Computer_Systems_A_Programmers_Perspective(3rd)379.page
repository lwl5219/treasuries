<div id="pf17b" class="pf w2 h11" data-page-no="17b"><div class="pc pc17b w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg17b.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">378<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1d h28 ye7 ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>3.39<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>298)</span></div><div class="t m5 x1d h26 y1d16 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>hese<span class="_"> </span>computations<span class="_"> </span>are<span class="_"> </span>direct<span class="_"> </span>applications<span class="_"> </span>of<span class="_"> </span>Equation<span class="_"> </span>3.1:</div><div class="t m5 x75 h3d y351a ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h46 y351b ff7 fs19 fc1 sc0 ls73 ws0">Fo<span class="_ _2"></span>r<span class="_ _11"> </span><span class="ff11 ls0">L<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"></span></span></span><span class="lsb1">4,<span class="_ _13"> </span><span class="ff11 ls0">C<span class="_ _11"> </span><span class="ff12">=<span class="_ _10"> </span></span></span><span class="ls9b">16,<span class="_ _13"> </span>and<span class="_"> </span><span class="ff11 ls0">j<span class="_"> </span><span class="ff12">=<span class="_ _13"></span></span></span><span class="lsce">0,<span class="_ _13"> </span>pointer<span class="_"> </span><span class="ffd ls0">Aptr<span class="_ _13"> </span><span class="ff7">is<span class="_ _13"> </span>computed<span class="_"> </span>as<span class="_ _13"> </span><span class="ff11">x</span></span></span></span></span></span></div><div class="t m5 x172 h6e y351c ffd fs25 fc1 sc0 ls0 ws0">A</div><div class="t m5 x1c0 h46 y351b ff12 fs19 fc1 sc0 ls0 ws0">+<span class="_ _13"></span><span class="ff7">4</span></div><div class="t m5 x148 h45 y351d ff11 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 x220 h46 y351b ff11 fs19 fc1 sc0 ls0 ws0">(<span class="ff7">16</span>i<span class="_ _11"> </span><span class="ff12">+<span class="_ _13"></span><span class="ff7">0</span></span>)<span class="_ _10"> </span><span class="ff12">=</span></div><div class="t m5 x29 h45 y351e ff11 fs19 fc1 sc0 ls0 ws0">x</div><div class="t m5 x23 h6e y351f ffd fs25 fc1 sc0 ls0 ws0">A</div><div class="t m5 xc2 h46 y3520 ff12 fs19 fc1 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">64<span class="ff11">i<span class="_ _5"></span></span>.</span></div><div class="t m5 x75 h3d y3521 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h46 y3522 ff7 fs19 fc1 sc0 ls73 ws0">Fo<span class="_ _2"></span>r<span class="_ _11"> </span><span class="ff11 ls0">L<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"></span></span></span><span class="lsb1">4,<span class="_ _13"> </span><span class="ff11 ls0">C<span class="_ _11"> </span><span class="ff12">=<span class="_ _10"> </span></span></span><span class="ls9e">16,<span class="_ _13"> </span><span class="ff11 ls0">i<span class="_ _11"> </span><span class="ff12">=<span class="_ _10"> </span></span></span></span>0,<span class="_ _13"> </span>and<span class="_ _10"> </span><span class="ff11 ls0">j<span class="_ _16"> </span><span class="ff12">=<span class="_ _13"></span></span>k<span class="_ _2"></span><span class="ff7">,<span class="_"> </span><span class="ffd">Bptr<span class="_ _13"> </span></span>is<span class="_ _13"> </span>computed<span class="_"> </span>as<span class="_ _13"> </span></span>x</span></span></div><div class="t m5 x83 h6e y3523 ffd fs25 fc1 sc0 ls0 ws0">B</div><div class="t m5 x111 h46 y3522 ff12 fs19 fc1 sc0 ls0 ws0">+<span class="_ _13"></span><span class="ff7">4</span></div><div class="t m5 x16b h45 y3524 ff11 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 x96 h26 y3522 ff11 fs19 fc1 sc0 ls0 ws0">(<span class="ff7">16</span></div><div class="t m5 x20f h45 y3524 ff11 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 x6f h46 y3522 ff7 fs19 fc1 sc0 ls0 ws0">0<span class="_ _13"> </span><span class="ff12">+<span class="_ _10"> </span><span class="ff11 ls10">k)<span class="_ _6"> </span></span>=</span></div><div class="t m5 x29 h45 y3525 ff11 fs19 fc1 sc0 ls0 ws0">x</div><div class="t m5 x23 h6e y3526 ffd fs25 fc1 sc0 ls0 ws0">B</div><div class="t m5 xc2 h46 y3527 ff12 fs19 fc1 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">4<span class="ff11">k<span class="_ _5"></span></span>.</span></div><div class="t m5 x75 h3d y3528 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h46 y3529 ff7 fs19 fc1 sc0 ls73 ws0">Fo<span class="_ _2"></span>r<span class="_ _1e"> </span><span class="ff11 ls0">L<span class="_ _10"> </span><span class="ff12">=<span class="_ _11"> </span></span></span><span class="lsb1">4,<span class="_ _1e"> </span><span class="ff11 ls0">C<span class="_"> </span><span class="ff12">=<span class="_ _11"> </span></span></span><span class="ls9e">16,<span class="_ _1e"> </span><span class="ff11 ls0">i<span class="_"> </span><span class="ff12">=<span class="_ _11"> </span></span></span><span class="ls9b">16,<span class="_ _1e"> </span>and<span class="_ _24"> </span><span class="ff11 ls0">j<span class="_ _15"> </span><span class="ff12">=<span class="_ _11"> </span></span>k<span class="_ _2"></span><span class="ff7">,<span class="_ _1e"> </span><span class="ffd">Bend<span class="_ _24"> </span></span>is<span class="_ _24"> </span>computed<span class="_ _25"> </span>as<span class="_ _24"> </span></span>x</span></span></span></span></div><div class="t m5 x14e h6e y352a ffd fs25 fc1 sc0 ls0 ws0">B</div><div class="t m5 xdb h46 y3529 ff12 fs19 fc1 sc0 ls0 ws0">+<span class="_ _10"> </span><span class="ff7">4</span></div><div class="t m5 x12c h45 y352b ff11 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 y352c ff11 fs19 fc1 sc0 ls0 ws0">(<span class="ff7">16</span></div><div class="t m5 x10d h45 y352d ff11 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 x1c4 h46 y352c ff7 fs19 fc1 sc0 ls0 ws0">16<span class="_ _13"> </span><span class="ff12">+<span class="_ _10"> </span><span class="ff11 ls10">k)<span class="_ _13"> </span></span>=<span class="_ _13"></span><span class="ff11">x</span></span></div><div class="t m5 xac h6e y352e ffd fs25 fc1 sc0 ls0 ws0">B</div><div class="t m5 x1d7 h46 y352f ff12 fs19 fc1 sc0 ls0 ws0">+<span class="_ _13"> </span><span class="ff7">1<span class="_ _0"></span><span class="ff11">,<span class="ff7">024<span class="_"> </span><span class="ff12">+<span class="_ _13"></span></span>4</span>k<span class="_ _2"></span><span class="ff7">.</span></span></span></div><div class="t m5 x1d h28 y3530 ffe fs1e fc6 sc0 ls0 ws0">Solution<span class="_"> </span>to<span class="_"> </span>Problem<span class="_"> </span>3.40<span class="_ _e"> </span><span class="fs16">(page<span class="_"> </span>298)</span></div><div class="t m5 x1d h26 y3531 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _13"> </span>exercise<span class="_ _13"> </span>requires<span class="_ _6"> </span>that<span class="_ _13"> </span>you<span class="_ _13"> </span>be<span class="_ _6"> </span>able<span class="_ _13"> </span>to<span class="_ _6"> </span>study<span class="_ _13"> </span>compiler<span class="_ _1"></span>-generated<span class="_ _13"> </span>assembly<span class="_ _6"> </span>code</div><div class="t m5 x1d h26 y3532 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _13"> </span>understand<span class="_ _13"> </span>what<span class="_ _13"> </span>optimizations<span class="_ _13"> </span>have<span class="_ _13"> </span>been<span class="_ _13"> </span>performed.<span class="_ _13"> </span>In<span class="_ _13"> </span>this<span class="_ _13"> </span>case<span class="_ _0"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>compiler</div><div class="t m5 x1d h26 y3533 ff7 fs19 fc1 sc0 ls0 ws0">was<span class="_"> </span>clever<span class="_"> </span>in<span class="_"> </span>its<span class="_"> </span>optimizations<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y3534 ff7 fs19 fc1 sc0 ls0 ws0">Let<span class="_ _13"> </span>us<span class="_ _13"> </span>Ô¨Årst<span class="_ _13"> </span>study<span class="_ _13"> </span>the<span class="_ _13"> </span>following<span class="_ _13"> </span>C<span class="_"> </span>code<span class="_ _1"></span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>then<span class="_ _13"> </span>see<span class="_ _13"> </span>how<span class="_"> </span>it<span class="_ _13"> </span>is<span class="_ _13"> </span>derived<span class="_ _13"> </span>from<span class="_ _13"> </span>the</div><div class="t m5 x1d h26 y3535 ff7 fs19 fc1 sc0 ls0 ws0">assembly<span class="_"> </span>code<span class="_"> </span>generated<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>original<span class="_"> </span>function.</div><div class="t m5 x1d h2d y3536 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Set<span class="_ _1f"> </span>all<span class="_ _1f"> </span>diagonal<span class="_ _e"> </span>elements<span class="_ _1f"> </span>to<span class="_ _e"> </span>val<span class="_ _1f"> </span>*/</div><div class="t m5 x1d h2d y3537 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>fix_set_diag_opt(fix_matrix<span class="_ _1f"> </span>A,<span class="_ _1f"> </span>int<span class="_ _e"> </span>val)<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y3538 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>*Abase<span class="_ _1f"> </span>=<span class="_ _1f"> </span>&amp;A[0][0];</div><div class="t m5 x10c h2d y3539 ffd fs1e fc2 sc0 ls33 ws0">l<span class="_ _41"></span>o<span class="_ _41"></span>n<span class="_ _41"></span>gi=0<span class="_ _41"></span>;</div><div class="t m5 x10c h2d y353a ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>iend<span class="_ _1f"> </span>=<span class="_ _1f"> </span>N*(N+1);</div><div class="t m5 x10c h2d y353b ffd fs1e fc2 sc0 ls0 ws0">do<span class="_ _e"> </span>{</div><div class="t m5 x22b h2d y353c ffd fs1e fc2 sc0 ls0 ws0">Abase[i]<span class="_ _e"> </span>=<span class="_ _1f"> </span>val;</div><div class="t m5 x22b h2d y353d ffd fs1e fc2 sc0 ls0 ws0">i<span class="_ _e"> </span>+=<span class="_ _1f"> </span>(N+1);</div><div class="t m5 x10c h2d y353e ffd fs1e fc2 sc0 ls0 ws0">}<span class="_ _e"> </span>while<span class="_ _1f"> </span>(i<span class="_ _1f"> </span>!=<span class="_ _e"> </span>iend);</div><div class="t m5 x1d h2d y353f ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1d h26 y3540 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _15"> </span>function<span class="_ _21"> </span>introduces<span class="_ _15"> </span>a<span class="_ _15"> </span>variable<span class="_ _21"> </span><span class="ffd">Abase</span>,<span class="_ _21"> </span>of<span class="_ _15"> </span>type<span class="_ _21"> </span><span class="ffd">int<span class="_ _16"> </span>*</span>,<span class="_ _21"> </span>pointing<span class="_ _15"> </span>to<span class="_ _15"> </span>the<span class="_ _15"> </span>start</div><div class="t m5 x1d h26 y3541 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _15"> </span>array<span class="_ _15"> </span><span class="ffd">A</span>.<span class="_ _21"> </span>T<span class="_ _1"></span>his<span class="_ _21"> </span>pointer<span class="_ _15"> </span>designates<span class="_ _21"> </span>a<span class="_ _15"> </span>sequence<span class="_ _15"> </span>of<span class="_ _21"> </span>4-byte<span class="_ _15"> </span>integers<span class="_ _15"> </span>consisting<span class="_ _21"> </span>of</div><div class="t m5 x1d h26 y3542 ff7 fs19 fc2 sc0 ls0 ws0">elements<span class="_ _16"> </span>of<span class="_ _16"> </span><span class="ffd">A<span class="_ _14"> </span></span>in<span class="_ _16"> </span>row-major<span class="_ _14"> </span>order.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>introduce<span class="_ _14"> </span>an<span class="_ _16"> </span>integer<span class="_ _14"> </span>variable<span class="_ _16"> </span><span class="ffd">index<span class="_ _14"> </span></span>that</div><div class="t m5 x1d h26 y3543 ff7 fs19 fc2 sc0 ls0 ws0">steps<span class="_ _13"> </span>through<span class="_ _6"> </span>the<span class="_ _13"> </span>diagonal<span class="_ _6"> </span>elements<span class="_ _13"> </span>of<span class="_ _6"> </span><span class="ffd">A</span>,<span class="_ _13"> </span>with<span class="_ _6"> </span>the<span class="_ _13"> </span>property<span class="_ _6"> </span>that<span class="_ _13"> </span>diagonal<span class="_ _6"> </span>elements</div><div class="t m5 x1d h46 y3544 ff11 fs19 fc2 sc0 ls0 ws0">i<span class="_ _13"> </span><span class="ff7">and<span class="_ _13"> </span></span>i<span class="_ _10"> </span><span class="ff12">+<span class="_ _13"></span><span class="ff7">1<span class="_ _be"></span>are<span class="_ _6"> </span>spaced<span class="_ _6"> </span></span></span>N<span class="_"> </span><span class="ff12">+<span class="_ _13"></span><span class="ff7">1<span class="_ _be"></span>elements<span class="_ _6"> </span>apart<span class="_ _6"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>sequence<span class="_ _1"></span>,<span class="_ _13"> </span>and<span class="_ _a"> </span>that<span class="_ _13"> </span>once<span class="_ _a"> </span>we<span class="_ _6"> </span>reach</span></span></div><div class="t m5 x1d h46 y3545 ff7 fs19 fc2 sc0 ls0 ws0">diagonal<span class="_"> </span>element<span class="_"> </span><span class="ff11">N<span class="_"> </span></span>(index<span class="_"> </span>value<span class="_"> </span><span class="ff11 ls1a1">N(<span class="_ _3"></span>N<span class="_ _10"> </span><span class="ff12 ls0">+<span class="_ _13"></span><span class="ff7">1<span class="_ _1"></span><span class="ff11">)<span class="ff7">),<span class="_"> </span>we<span class="_"> </span>have<span class="_"> </span>gone<span class="_"> </span>beyond<span class="_"> </span>the<span class="_"> </span>end.</span></span></span></span></span></div><div class="t m5 x29 h26 y3546 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _f"> </span>actual<span class="_ _f"> </span>assembly<span class="_ _21"> </span>code<span class="_ _f"> </span>follows<span class="_ _21"> </span>this<span class="_ _f"> </span>general<span class="_ _f"> </span>form,<span class="_ _e"> </span>but<span class="_ _21"> </span>now<span class="_ _21"> </span>the<span class="_ _f"> </span>pointer</div><div class="t m5 x1d h26 y3547 ff7 fs19 fc2 sc0 ls0 ws0">increments<span class="_ _6"> </span>must<span class="_ _6"> </span>be<span class="_ _6"> </span>scaled<span class="_ _6"> </span>by<span class="_ _13"> </span>a<span class="_ _a"> </span>factor<span class="_ _6"> </span>of<span class="_ _13"> </span>4.<span class="_ _a"> </span>W<span class="_ _1"></span>e<span class="_ _6"> </span>label<span class="_ _6"> </span>register<span class="_ _6"> </span><span class="ffd">%rax<span class="_ _13"> </span></span>as<span class="_ _a"> </span>holding<span class="_ _6"> </span>a<span class="_ _6"> </span>value</div><div class="t m5 x1d h46 y3548 ffd fs19 fc2 sc0 ls0 ws0">index4<span class="_ _13"> </span><span class="ff7">equal<span class="_"> </span>to<span class="_ _13"> </span></span>index<span class="_ _13"> </span><span class="ff7">in<span class="_ _13"> </span>our<span class="_"> </span>C<span class="_ _13"> </span>version<span class="_ _13"> </span>but<span class="_ _13"> </span>scaled<span class="_"> </span>by<span class="_ _13"> </span>a<span class="_ _13"> </span>factor<span class="_ _13"> </span>of<span class="_"> </span>4.<span class="_ _13"> </span>F<span class="_ _1"></span>or<span class="_ _13"> </span><span class="ff11">N<span class="_"> </span><span class="ff12">=<span class="_ _13"></span></span></span><span class="ls9e">16,<span class="_"> </span>we</span></span></div><div class="t m5 x1d h26 y3549 ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_"> </span>see<span class="_"> </span>that<span class="_"> </span>our<span class="_"> </span>stopping<span class="_"> </span>point<span class="_"> </span>for<span class="_"> </span><span class="ffd">index4<span class="_ _10"> </span></span>will<span class="_"> </span>be<span class="_"> </span>4</div><div class="t m5 x84 h45 y354a ff11 fs19 fc2 sc0 ls0 ws0">.</div><div class="t m5 x53 h46 y3549 ff7 fs19 fc2 sc0 ls0 ws0">16<span class="ff11">(</span>16<span class="_ _13"> </span><span class="ff12">+<span class="_ _10"> </span></span>1<span class="_ _1"></span><span class="ff11">)<span class="_ _13"> </span><span class="ff12">=<span class="_ _10"> </span><span class="ff7">1<span class="_ _1"></span><span class="ff11">,<span class="ff7 lsb2">088.</span></span></span></span></span></div><div class="t m5 x1f h2d y278 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">fix_set_diag:</span></div><div class="t m5 xad h61 y24e1 ff13 fs35 fc6 sc0 ls0 ws0">void<span class="_ _f"> </span>fix_set_diag(fix_matrix<span class="_ _f"> </span>A,<span class="_ _f"> </span>int<span class="_ _e"> </span>val)</div><div class="t m5 xad h61 y3245 ff13 fs35 fc6 sc0 ls0 ws0">A<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>val<span class="_ _e"> </span>in<span class="_ _21"> </span>%rsi</div><div class="t m5 x1f h2e y587 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x10d h2d ye14 ffd fs1e fc2 sc0 ls0 ws0">movl<span class="_ _46"> </span>$0,<span class="_ _e"> </span>%eax<span class="_ _171"> </span><span class="ff13 fs35 fc6">Set<span class="_ _f"> </span>index4<span class="_ _f"> </span>=<span class="_ _f"> </span>0</span></div><div class="t m5 x1f h2d yeef ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">.L13:<span class="_ _195"> </span></span><span class="ff2d fs35">loop:</span></div><div class="t m5 x1f h2d yd7a ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">movl<span class="_ _46"> </span>%esi,<span class="_ _e"> </span>(%rdi,%rax)<span class="_ _10d"> </span></span><span class="ff13 fs35">Set<span class="_ _e"> </span>Abase[index4/4]<span class="_ _21"> </span>to<span class="_ _f"> </span>val</span></div><div class="t m5 x1f h2d y1db4 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$68,<span class="_ _e"> </span>%rax<span class="_ _d5"> </span></span><span class="ff13 fs35">Increment<span class="_ _f"> </span>index4<span class="_ _e"> </span>+=<span class="_ _21"> </span>4(N+1)</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
