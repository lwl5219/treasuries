<div id="pf36b" class="pf w2 h11" data-page-no="36b"><div class="pc pc36b w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg36b.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">874<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>9<span class="_ _3d"> </span>Virtual<span class="_ _10"> </span>Memory</span></div><div class="t m5 x14 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>9.32</div><div class="t m5 x14 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">Visual<span class="_ _11"> </span>interpretation<span class="_ _16"> </span>of</div><div class="t m5 x14 h3a y609 ffd fs19 fc1 sc0 ls0 ws0">mmap<span class="_ _10"> </span><span class="ffe fs16">arguments.</span></div><div class="t m5 xe0 h40 y7160 ffc2 fs28 fc1 sc0 ls0 ws0">length<span class="ffc3 fs27"> (bytes)</span></div><div class="t m5 x22f h40 y7161 ffc2 fs28 fc1 sc0 ls0 ws0">length<span class="ffc3 fs27"> (bytes)</span></div><div class="t m5 x7a h40 y7162 ffc2 fs28 fc1 sc0 ls0 ws0">offset</div><div class="t m5 x7c h3f y7163 ffc3 fs27 fc1 sc0 ls0 ws0">(bytes)</div><div class="t m5 x10e h3f y7164 ffc3 fs27 fc1 sc0 ls0 ws0">Disk file specified by</div><div class="t m5 xdc h3f y7165 ffc3 fs27 fc1 sc0 ls0 ws0">file descriptor </div><div class="t m5 x185 h40 y7166 ffc2 fs28 fc1 sc0 ls0 ws0">fd</div><div class="t m5 xbd h3f y7167 ffc3 fs27 fc1 sc0 ls0 ws0">Process</div><div class="t m5 x1b4 h3f y7166 ffc3 fs27 fc1 sc0 ls0 ws0">virtual memory</div><div class="t m5 x1c3 h40 y7168 ffc2 fs28 fc1 sc0 ls0 ws0">start</div><div class="t m5 x22f h3f y7169 ffc3 fs27 fc1 sc0 ls0 ws0">(or address</div><div class="t m5 x53 h3f y716a ffc3 fs27 fc1 sc0 ls0 ws0">chosen by the</div><div class="t m5 x98 h3f y716b ffc3 fs27 fc1 sc0 ls0 ws0">kernel)</div><div class="t m5 xba h65 y716c ffc3 fs38 fc1 sc0 ls0 ws0">0</div><div class="t m5 x205 h65 y716d ffc3 fs38 fc1 sc0 ls0 ws0">0</div><div class="t m5 x126 h2d y716e ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;unistd.h&gt;</div><div class="t m5 x126 h2d y716f ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;sys/mman.h&gt;</div><div class="t m5 x126 h2d y7170 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _1a"> </span>*mmap(void<span class="_ _e"> </span>*start,<span class="_ _1f"> </span>size_t<span class="_ _1f"> </span>length,<span class="_ _e"> </span>int<span class="_ _1f"> </span>prot,<span class="_ _e"> </span>int<span class="_ _1f"> </span>flags,</div><div class="t m5 x150 h2d y7171 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>fd,<span class="_ _1f"> </span>off_t<span class="_ _1f"> </span>offset);</div><div class="t m5 xd hf2 y7172 ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>pointer<span class="_"> </span>to<span class="_"> </span>mapped<span class="_"> </span>area<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span>MAP_F<span class="_ _1"></span>AILED<span class="_"> </span>(<span class="ff12">−</span>1<span class="_ _1"></span>)<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y7173 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_"> </span><span class="ffd ls0">mmap<span class="_ _13"> </span><span class="ff7">function<span class="_ _13"> </span>asks<span class="_ _13"> </span>the<span class="_ _13"> </span>kernel<span class="_ _6"> </span>to<span class="_ _13"> </span>create<span class="_ _13"> </span>a<span class="_ _13"> </span>new<span class="_ _13"> </span>virtual<span class="_ _6"> </span>memory<span class="_ _13"> </span>area,<span class="_ _13"> </span>preferably</span></span></div><div class="t m5 x1d h26 y7174 ff7 fs19 fc2 sc0 ls0 ws0">one<span class="_ _14"> </span>that<span class="_ _14"> </span>starts<span class="_ _14"> </span>at<span class="_ _14"> </span>address<span class="_ _14"> </span><span class="ffd">start</span>,<span class="_ _15"> </span>and<span class="_ _15"> </span>to<span class="_ _14"> </span>map<span class="_ _14"> </span>a<span class="_ _14"> </span>contiguous<span class="_ _14"> </span>chunk<span class="_ _14"> </span>of<span class="_ _15"> </span>the<span class="_ _14"> </span>object</div><div class="t m5 x1d h26 y7175 ff7 fs19 fc2 sc0 ls0 ws0">speciﬁed<span class="_"> </span>by<span class="_ _13"> </span>ﬁle<span class="_"> </span>descriptor<span class="_"> </span><span class="ffd">fd<span class="_ _10"> </span></span>to<span class="_ _13"> </span>the<span class="_"> </span>new<span class="_"> </span>area.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>contiguous<span class="_ _13"> </span>object<span class="_"> </span>chunk<span class="_"> </span>has<span class="_"> </span>a</div><div class="t m5 x1d h26 y7176 ff7 fs19 fc2 sc0 ls0 ws0">size<span class="_"> </span>of<span class="_"> </span><span class="ffd">length<span class="_ _13"> </span></span>bytes<span class="_"> </span>and<span class="_"> </span>starts<span class="_"> </span>at<span class="_"> </span>an<span class="_ _13"> </span>offset<span class="_"> </span>of<span class="_"> </span><span class="ffd">offset<span class="_ _10"> </span></span>bytes<span class="_"> </span>from<span class="_"> </span>the<span class="_ _13"> </span>beginning<span class="_"> </span>of</div><div class="t m5 x1d h26 y7177 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>ﬁle<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span><span class="ffd">start<span class="_ _13"> </span></span>address<span class="_"> </span>is<span class="_ _13"> </span>merely<span class="_"> </span>a<span class="_ _13"> </span>hint,<span class="_"> </span>and<span class="_"> </span>is<span class="_ _13"> </span>usually<span class="_"> </span>speciﬁed<span class="_ _13"> </span>as<span class="_"> </span>NULL.<span class="_"> </span>F<span class="_ _3"></span>or</div><div class="t m5 x1d h26 y7178 ff7 fs19 fc2 sc0 ls0 ws0">our<span class="_ _13"> </span>purposes<span class="_ _3"></span>,<span class="_"> </span>we<span class="_ _6"> </span>will<span class="_ _13"> </span>always<span class="_ _13"> </span>assume<span class="_ _13"> </span>a<span class="_ _13"> </span>NULL<span class="_ _13"> </span>start<span class="_ _13"> </span>address<span class="_ _3"></span>.<span class="_ _13"> </span>F<span class="_ _0"></span>igure<span class="_ _13"> </span>9.32<span class="_ _13"> </span>depicts<span class="_ _13"> </span>the</div><div class="t m5 x1d h26 y7179 ff7 fs19 fc2 sc0 ls0 ws0">meaning<span class="_"> </span>of<span class="_"> </span>these<span class="_"> </span>arguments<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y717a ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">prot<span class="_ _11"> </span><span class="ff7">argument<span class="_ _11"> </span>contains<span class="_ _16"> </span>bits<span class="_"> </span>that<span class="_ _11"> </span>describe<span class="_ _16"> </span>the<span class="_"> </span>access<span class="_ _16"> </span>permissions<span class="_"> </span>of<span class="_ _16"> </span>the</span></span></div><div class="t m5 x1d h26 y717b ff7 fs19 fc2 sc0 ls0 ws0">newly<span class="_ _16"> </span>mapped<span class="_ _16"> </span>virtual<span class="_ _16"> </span>memory<span class="_ _16"> </span>area<span class="_ _16"> </span>(i.e<span class="_ _1"></span>.,<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">vm_prot<span class="_ _16"> </span></span>bits<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span>corresponding</div><div class="t m5 x1d h26 y717c ff7 fs19 fc2 sc0 ls0 ws0">area<span class="_"> </span>struct).</div><div class="t m5 x75 h26 y717d ff7 fs19 fc2 sc0 ls0 ws0">PRO<span class="_ _1"></span>T_EXEC.<span class="_ _e"> </span>Pages<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>area<span class="_ _16"> </span>consist<span class="_"> </span>of<span class="_ _11"> </span>instructions<span class="_ _11"> </span>that<span class="_ _11"> </span>may<span class="_ _11"> </span>be<span class="_ _11"> </span>executed</div><div class="t m5 xcd h26 y717e ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_"> </span>the<span class="_"> </span>CPU<span class="_ _3"></span>.</div><div class="t m5 x75 h26 y717f ff7 fs19 fc2 sc0 ls0 ws0">PRO<span class="_ _1"></span>T_READ<span class="_ _1"></span>.<span class="_ _1f"> </span>Pages<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>area<span class="_"> </span>may<span class="_"> </span>be<span class="_"> </span>read.</div><div class="t m5 x75 h26 y7180 ff7 fs19 fc2 sc0 ls0 ws0">PRO<span class="_ _1"></span>T_WRITE.<span class="_ _1f"> </span>Pages<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>area<span class="_"> </span>may<span class="_"> </span>be<span class="_"> </span>written.</div><div class="t m5 x75 h26 y7181 ff7 fs19 fc2 sc0 ls0 ws0">PRO<span class="_ _1"></span>T_NONE.<span class="_ _1f"> </span>Pages<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>area<span class="_"> </span>cannot<span class="_"> </span>be<span class="_"> </span>accessed.</div><div class="t m5 x29 h26 y7182 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _21"> </span><span class="ffd ls0">flags<span class="_ _14"> </span><span class="ff7">argument<span class="_ _15"> </span>consists<span class="_ _15"> </span>of<span class="_ _14"> </span>bits<span class="_ _15"> </span>that<span class="_ _14"> </span>describe<span class="_ _15"> </span>the<span class="_ _15"> </span>type<span class="_ _14"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>mapped</span></span></div><div class="t m5 x1d h26 y7183 ff7 fs19 fc2 sc0 ls0 ws0">object.<span class="_"> </span>If<span class="_ _13"> </span>the<span class="_"> </span>MAP_ANON<span class="_ _13"> </span>ﬂag<span class="_"> </span>bit<span class="_ _13"> </span>is<span class="_"> </span>set,<span class="_ _13"> </span>then<span class="_"> </span>the<span class="_ _13"> </span>backing<span class="_"> </span>store<span class="_ _13"> </span>is<span class="_"> </span>an<span class="_ _13"> </span>anonymous</div><div class="t m5 x1d h26 y7184 ff7 fs19 fc2 sc0 ls0 ws0">object<span class="_ _14"> </span>and<span class="_ _14"> </span>the<span class="_ _14"> </span>corresponding<span class="_ _15"> </span>virtual<span class="_ _14"> </span>pages<span class="_ _14"> </span>are<span class="_ _14"> </span>demand-zero.<span class="_ _16"> </span>MAP_PRIV<span class="_ _3"></span>A<span class="_ _3"></span>TE</div><div class="t m5 x1d h26 y7185 ff7 fs19 fc2 sc0 ls0 ws0">indicates<span class="_"> </span>a<span class="_"> </span>private<span class="_ _13"> </span>copy-on-write<span class="_"> </span>object,<span class="_"> </span>and<span class="_"> </span>MAP_SHARED<span class="_ _13"> </span>indicates<span class="_"> </span>a<span class="_"> </span>shared</div><div class="t m5 x1d h26 y7186 ff7 fs19 fc2 sc0 ls0 ws0">object.<span class="_"> </span>F<span class="_ _1"></span>or<span class="_"> </span>example<span class="_ _1"></span>,</div><div class="t m5 x10c h2d ye95 ffd fs1e fc2 sc0 ls0 ws0">bufp<span class="_ _e"> </span>=<span class="_ _1f"> </span>Mmap(NULL,<span class="_ _1f"> </span>size,<span class="_ _e"> </span>PROT_READ,<span class="_ _1f"> </span>MAP_PRIVATE|MAP_ANON,<span class="_ _e"> </span>0,<span class="_ _1f"> </span>0);</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
