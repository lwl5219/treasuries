<div id="pf267" class="pf w2 h11" data-page-no="267"><div class="pc pc267 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg267.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">614<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _16"> </span>introduce<span class="_ _16"> </span>a<span class="_ _16"> </span>local<span class="_ _16"> </span>variable<span class="_ _14"> </span><span class="ffd">last_val</span>.<span class="_ _16"> </span>At<span class="_ _16"> </span>the<span class="_ _16"> </span>start<span class="_ _16"> </span>of<span class="_ _16"> </span>iteration<span class="_ _16"> </span><span class="ffd">i</span>,<span class="_ _14"> </span>it<span class="_ _16"> </span>holds<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_"> </span>of<span class="_"> </span><span class="ffd">p[i-1]</span>.<span class="_ _13"> </span>W<span class="_ _1"></span>e<span class="_"> </span>then<span class="_"> </span>compute<span class="_ _13"> </span><span class="ffd">val<span class="_ _10"> </span></span>to<span class="_"> </span>be<span class="_"> </span>the<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_"> </span><span class="ffd">p[i]<span class="_ _10"> </span></span>and<span class="_"> </span>to<span class="_"> </span>be<span class="_"> </span>the<span class="_ _13"> </span>new</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_"> </span>for<span class="_"> </span><span class="ffd">last_val</span>.</div><div class="t m5 x29 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>version<span class="_"> </span>compiles<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>assembly<span class="_"> </span>code:</div><div class="t m5 x74 h61 y3483 ff13 fs35 fc6 sc0 ls0 ws0">Inner<span class="_ _f"> </span>loop<span class="_ _f"> </span>of<span class="_ _f"> </span>psum1a</div><div class="t m5 x74 h61 y521e ff13 fs35 fc6 sc0 ls0 ws0">a<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi,<span class="_ _f"> </span>i<span class="_ _e"> </span>in<span class="_ _21"> </span>%rax,<span class="_ _f"> </span>cnt<span class="_ _e"> </span>in<span class="_ _21"> </span>%rdx,<span class="_ _f"> </span>last_val<span class="_ _e"> </span>in<span class="_ _21"> </span>%xmm0</div><div class="t m5 x19f h2d y35f7 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">.L16:<span class="_ _1f1"> </span></span><span class="ff2d fs35">loop:</span></div><div class="t m5 x19f h2d y4f4e ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">vaddss<span class="_ _1a"> </span>(%rdi,%rax,4),<span class="_ _e"> </span>%xmm0,<span class="_ _1f"> </span>%xmm0<span class="_ _68"> </span></span><span class="ff13 fs35">last_val<span class="_ _f"> </span>=<span class="_ _e"> </span>val<span class="_ _21"> </span>=<span class="_ _f"> </span>last_val<span class="_ _e"> </span>+<span class="_ _21"> </span>a[i]</span></div><div class="t m5 x19f h2d y4f4f ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">vmovss<span class="_ _1a"> </span>%xmm0,<span class="_ _e"> </span>(%rsi,%rax,4)<span class="_ _29"> </span></span><span class="ff13 fs35">Store<span class="_ _e"> </span>val<span class="_ _21"> </span>in<span class="_ _f"> </span>p[i]</span></div><div class="t m5 x19f h2d y4f50 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _45"> </span><span class="ffd fs1e fc2">addq<span class="_ _46"> </span>$1,<span class="_ _e"> </span>%rax<span class="_ _a3"> </span></span><span class="ff13 fs35">Increment<span class="_ _f"> </span>i</span></div><div class="t m5 x19f h2d yea5 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _45"> </span><span class="ffd fs1e fc2">cmpq<span class="_ _46"> </span>%rdx,<span class="_ _e"> </span>%rax<span class="_ _d2"> </span></span><span class="ff13 fs35">Compare<span class="_ _f"> </span>i:cnt</span></div><div class="t m5 x19f h2d y4f51 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _45"> </span><span class="ffd fs1e fc2">jne<span class="_ _8c"> </span>.L16<span class="_ _1f2"> </span></span><span class="ff13 fs35">If<span class="_ _f"> </span>!=,<span class="_ _f"> </span>goto<span class="_ _f"> </span><span class="ff2d">loop</span></span></div><div class="t m5 x1d h26 y2b56 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _e"> </span>code<span class="_ _21"> </span>holds<span class="_ _e"> </span><span class="ffd">last_val<span class="_ _f"> </span></span>in<span class="_ _f"> </span><span class="ffd">%xmm0</span>,<span class="_ _1f"> </span>avoiding<span class="_ _f"> </span>the<span class="_ _f"> </span>need<span class="_ _e"> </span>to<span class="_ _f"> </span>read<span class="_ _f"> </span><span class="ffd">p[i-1]<span class="_ _e"> </span></span>from</div><div class="t m5 x1d h26 y521f ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_"> </span>and<span class="_"> </span>thus<span class="_"> </span>eliminating<span class="_"> </span>the<span class="_"> </span>write/read<span class="_"> </span>dependency<span class="_"> </span>seen<span class="_"> </span>in<span class="_"> </span><span class="ffd">psum1</span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
