<div id="pf330" class="pf w2 h11" data-page-no="330"><div class="pc pc330 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg330.png"/><div class="t m5 x1e0 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>8.5<span class="_ _60"> </span>Signals<span class="_ _3e"> </span><span class="ffe fs1e">815</span></div><div class="t m5 x25f h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/ecf/procmask2.c</div><div class="t m5 x2c h2e y280 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x2d h2d yad1 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>handler(int<span class="_ _1f"> </span>sig)</div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d yad2 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>olderrno<span class="_ _1f"> </span>=<span class="_ _1f"> </span>errno;</span></div><div class="t m5 x2c h2d yad3 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">sigset_t<span class="_ _e"> </span>mask_all,<span class="_ _1f"> </span>prev_all;</span></div><div class="t m5 x2c h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">pid_t<span class="_ _e"> </span>pid;</span></div><div class="t m5 x2c h2e yad4 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2c h2e y6a24 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x142 h2d yad5 ffd fs1e fc2 sc0 ls0 ws0">Sigfillset(&amp;mask_all);</div><div class="t m5 x2c h2d yad6 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">while<span class="_ _e"> </span>((pid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>waitpid(-1,<span class="_ _e"> </span>NULL,<span class="_ _1f"> </span>0))<span class="_ _e"> </span>&gt;<span class="_ _1f"> </span>0)<span class="_ _1f"> </span>{<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Reap<span class="_ _e"> </span>a<span class="_ _1f"> </span>zombie<span class="_ _1f"> </span>child<span class="_ _e"> </span>*/</span></div><div class="t m5 x2c h2d y496b ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2">Sigprocmask(SIG_BLOCK,<span class="_ _e"> </span>&amp;mask_all,<span class="_ _1f"> </span>&amp;prev_all);</span></div><div class="t m5 x17 h2d y50d4 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">deletejob(pid);<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Delete<span class="_ _1f"> </span>the<span class="_ _e"> </span>child<span class="_ _1f"> </span>from<span class="_ _e"> </span>the<span class="_ _1f"> </span>job<span class="_ _1f"> </span>list<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _70"> </span><span class="ffd fs1e fc2">Sigprocmask(SIG_SETMASK,<span class="_ _e"> </span>&amp;prev_all,<span class="_ _1f"> </span>NULL);</span></div><div class="t m5 x17 h2d y61b6 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y2181 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(errno<span class="_ _1f"> </span>!=<span class="_ _1f"> </span>ECHILD)</span></div><div class="t m5 x17 h2d y554b ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">Sio_error(&quot;waitpid<span class="_ _e"> </span>error&quot;);</span></div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">errno<span class="_ _e"> </span>=<span class="_ _1f"> </span>olderrno;</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x17 h2e y6a25 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x2d h2d y3ec ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _1f"> </span>argc,<span class="_ _1f"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>pid;</span></div><div class="t m5 x17 h2d y1ada ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _20"> </span><span class="ffd fs1e fc2">sigset_t<span class="_ _e"> </span>mask_all,<span class="_ _1f"> </span>mask_one,<span class="_ _1f"> </span>prev_one;</span></div><div class="t m5 x17 h2e y61b9 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x17 h2e y6a26 ff6 fs20 fc6 sc0 ls0 ws0">23</div><div class="t m5 x142 h2d y3228 ffd fs1e fc2 sc0 ls0 ws0">Sigfillset(&amp;mask_all);</div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">Sigemptyset(&amp;mask_one);</span></div><div class="t m5 x17 h2d y3229 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _20"> </span><span class="ffd fs1e fc2">Sigaddset(&amp;mask_one,<span class="_ _e"> </span>SIGCHLD);</span></div><div class="t m5 x17 h2d y322a ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _20"> </span><span class="ffd fs1e fc2">Signal(SIGCHLD,<span class="_ _e"> </span>handler);</span></div><div class="t m5 x17 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _20"> </span><span class="ffd fs1e fc2">initjobs();<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Initialize<span class="_ _1f"> </span>the<span class="_ _e"> </span>job<span class="_ _1f"> </span>list<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2e y322c ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x17 h2e y61ba ff6 fs20 fc6 sc0 ls0 ws0">29</div><div class="t m5 x142 h2d y441 ffd fs1e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(1)<span class="_ _1f"> </span>{</div><div class="t m5 x17 h2d y2c5c ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _70"> </span><span class="ffd fs1e fc2">Sigprocmask(SIG_BLOCK,<span class="_ _e"> </span>&amp;mask_one,<span class="_ _1f"> </span>&amp;prev_one);<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Block<span class="_ _1f"> </span>SIGCHLD<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y322d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((pid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>Fork())<span class="_ _e"> </span>==<span class="_ _1f"> </span>0)<span class="_ _e"> </span>{<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>Child<span class="_ _e"> </span>process<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y24a ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _d1"> </span><span class="ffd fs1e fc2">Sigprocmask(SIG_SETMASK,<span class="_ _1f"> </span>&amp;prev_one,<span class="_ _e"> </span>NULL);<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Unblock<span class="_ _1f"> </span>SIGCHLD<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y8f9 ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _d1"> </span><span class="ffd fs1e fc2">Execve(&quot;/bin/date&quot;,<span class="_ _1f"> </span>argv,<span class="_ _e"> </span>NULL);</span></div><div class="t m5 x17 h2d y5fd ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y4aa5 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _70"> </span><span class="ffd fs1e fc2">Sigprocmask(SIG_BLOCK,<span class="_ _e"> </span>&amp;mask_all,<span class="_ _1f"> </span>NULL);<span class="_ _1f"> </span>/*<span class="_ _e"> </span>Parent<span class="_ _1f"> </span>process<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2e y22d4 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 xc5 h2d y74d ffd fs1e fc2 sc0 ls0 ws0">addjob(pid);<span class="_ _1a"> </span>/*<span class="_ _e"> </span>Add<span class="_ _1f"> </span>the<span class="_ _1f"> </span>child<span class="_ _e"> </span>to<span class="_ _1f"> </span>the<span class="_ _e"> </span>job<span class="_ _1f"> </span>list<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y277 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _70"> </span><span class="ffd fs1e fc2">Sigprocmask(SIG_SETMASK,<span class="_ _e"> </span>&amp;prev_one,<span class="_ _1f"> </span>NULL);<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Unblock<span class="_ _e"> </span>SIGCHLD<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y2269 ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y226b ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _20"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x17 h2d y226d ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x25f h2c y62c3 ffa fs16 fc2 sc0 ls0 ws0">code/ecf/procmask2.c</div><div class="t m5 x17 h2f y62c4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _14"> </span>8.40<span class="_ _c"> </span><span class="fc1">Using</span></div><div class="t m5 xc4 h3a y62c5 ffd fs19 fc1 sc0 ls0 ws0">sigprocmask<span class="_ _14"> </span><span class="ffe fs16">to<span class="_ _15"> </span>synchronize<span class="_ _14"> </span>processes.<span class="_ _15"> </span><span class="ff6">In<span class="_ _14"> </span>this<span class="_ _15"> </span>example,<span class="_ _15"> </span>the<span class="_ _14"> </span>parent<span class="_ _15"> </span>ensures<span class="_ _14"> </span>that</span></span></div><div class="t m5 x17 h3a y6a27 ffd fs19 fc1 sc0 ls0 ws0">addjob<span class="_ _10"> </span><span class="ff6 fs16">executes<span class="_ _11"> </span>before<span class="_ _10"> </span>the<span class="_ _10"> </span>corresponding<span class="_ _11"> </span></span>deletejob<span class="ff6 fs16">.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
