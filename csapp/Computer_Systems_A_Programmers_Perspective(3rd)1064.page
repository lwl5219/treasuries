<div id="pf428" class="pf w2 h11" data-page-no="428"><div class="pc pc428 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg428.png"/><div class="t m5 x13a h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.7<span class="_ _60"> </span>Other<span class="_ _10"> </span>Concurrency<span class="_ _10"> </span>Issues<span class="_ _3e"> </span><span class="ffe fs1e">1063</span></div><div class="t m5 x1f8 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/norace.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#define<span class="_ _1f"> </span>N<span class="_ _e"> </span>4</span></div><div class="t m5 x2c h2e y283 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2c h2e y5fd0 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2d h2d y284 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*thread(void<span class="_ _1f"> </span>*vargp);</div><div class="t m5 x2c h2e y285 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y65f1 ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2d h2d y286 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">pthread_t<span class="_ _e"> </span>tid[N];</span></div><div class="t m5 x2c h2d y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i,<span class="_ _1f"> </span>*ptr;</span></div><div class="t m5 x17 h2e y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x17 h2e y7428 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x142 h2d y4a9c ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;N<span class="_ _41"></span>;<span class="ls0">i++)<span class="_ _e"> </span>{</span></div><div class="t m5 x17 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">ptr<span class="_ _e"> </span>=<span class="_ _1f"> </span>Malloc(sizeof(int));</span></div><div class="t m5 x17 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _70"> </span><span class="ffd fs1e fc2">*ptr<span class="_ _e"> </span>=<span class="_ _1f"> </span>i;</span></div><div class="t m5 x17 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">Pthread_create(&amp;tid[i],<span class="_ _e"> </span>NULL,<span class="_ _1f"> </span>thread,<span class="_ _1f"> </span>ptr);</span></div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2 ls33">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;N<span class="_ _41"></span>;<span class="ls0">i++)</span></span></div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _70"> </span><span class="ffd fs1e fc2">Pthread_join(tid[i],<span class="_ _e"> </span>NULL);</span></div><div class="t m5 x17 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2e y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 x17 h2e y7fdd ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x2d h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Thread<span class="_ _1f"> </span>routine<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>*thread(void<span class="_ _e"> </span>*vargp)</span></div><div class="t m5 x17 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>myid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>*((int<span class="_ _e"> </span>*)vargp);</span></div><div class="t m5 x17 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x142 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">Free(vargp);</div><div class="t m5 x17 h2d y2467 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _20"> </span><span class="ffd fs1e fc2">printf(&quot;Hello<span class="_ _e"> </span>from<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>%d\n&quot;,<span class="_ _e"> </span>myid);</span></div><div class="t m5 x17 h2d y322b ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>NULL;</span></div><div class="t m5 x17 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1f8 h2c y66b7 ffa fs16 fc2 sc0 ls0 ws0">code/conc/norace.c</div><div class="t m5 x17 h2f y66b8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.43<span class="_ _66"> </span><span class="fc1">A<span class="_"> </span>correct<span class="_"> </span>version<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>program<span class="_"> </span>in<span class="_"> </span>Figure<span class="_"> </span>12.42<span class="_"> </span>without<span class="_"> </span>a<span class="_"> </span>race.</span></div><div class="t m5 x17 h41 y844b ffe fs29 fc1 sc0 ls0 ws0">12.7.5<span class="_ _48"> </span><span class="fs19">Deadlocks</span></div><div class="t m5 x17 h26 y21f9 ff7 fs19 fc1 sc0 ls0 ws0">Semaphores<span class="_ _15"> </span>introduce<span class="_ _21"> </span>the<span class="_ _15"> </span>potential<span class="_ _21"> </span>for<span class="_ _21"> </span>a<span class="_ _15"> </span>nasty<span class="_ _21"> </span>kind<span class="_ _21"> </span>of<span class="_ _15"> </span>run-time<span class="_ _21"> </span>error,<span class="_ _21"> </span>called</div><div class="t m5 x17 h26 y2214 ffa fs19 fc1 sc0 ls0 ws0">deadlock<span class="ff7">,<span class="_ _14"> </span>where<span class="_ _14"> </span>a<span class="_ _16"> </span>collection<span class="_ _14"> </span>of<span class="_ _16"> </span>threads<span class="_ _14"> </span>is<span class="_ _16"> </span>blocked,<span class="_ _14"> </span>waiting<span class="_ _14"> </span>for<span class="_ _16"> </span>a<span class="_ _14"> </span>condition<span class="_ _16"> </span>that</span></div><div class="t m5 x17 h26 y2215 ff7 fs19 fc1 sc0 ls0 ws0">will<span class="_ _15"> </span>never<span class="_ _14"> </span>be<span class="_ _15"> </span>true.<span class="_ _14"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>progress<span class="_ _15"> </span>graph<span class="_ _15"> </span>is<span class="_ _15"> </span>an<span class="_ _15"> </span>invaluable<span class="_ _15"> </span>tool<span class="_ _15"> </span>for<span class="_ _15"> </span>understanding</div><div class="t m5 x17 h26 y2216 ff7 fs19 fc1 sc0 ls0 ws0">deadlock.<span class="_ _13"> </span>F<span class="_ _3"></span>or<span class="_ _13"> </span>example<span class="_ _1"></span>,<span class="_ _13"> </span>Figure<span class="_ _6"> </span>12.44<span class="_ _13"> </span>shows<span class="_ _13"> </span>the<span class="_ _6"> </span>progress<span class="_ _13"> </span>graph<span class="_ _6"> </span>for<span class="_ _13"> </span>a<span class="_ _13"> </span>pair<span class="_ _6"> </span>of<span class="_ _13"> </span>threads</div><div class="t m5 x17 h26 y2217 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _6"> </span>use<span class="_ _13"> </span>two<span class="_ _6"> </span>semaphores<span class="_ _6"> </span>for<span class="_ _13"> </span>mutual<span class="_ _6"> </span>exclusion.<span class="_ _13"> </span>F<span class="_ _1"></span>rom<span class="_ _6"> </span>this<span class="_ _13"> </span>graph,<span class="_ _6"> </span>we<span class="_ _13"> </span>can<span class="_ _6"> </span>glean<span class="_ _13"> </span>some</div><div class="t m5 x17 h26 y2218 ff7 fs19 fc1 sc0 ls0 ws0">important<span class="_"> </span>insights<span class="_"> </span>about<span class="_"> </span>deadlock:</div><div class="t m5 x72 h3d y3701 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x26 h26 yb04 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>programmer<span class="_ _16"> </span>has<span class="_ _16"> </span>incorrectly<span class="_ _16"> </span>ordered<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ff11">P<span class="_ _e"> </span></span>and<span class="_ _16"> </span><span class="ff11">V<span class="_ _1f"> </span></span>operations<span class="_ _11"> </span>such<span class="_ _16"> </span>that</div><div class="t m5 x26 h26 yb05 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _21"> </span>forbidden<span class="_ _21"> </span>regions<span class="_ _21"> </span>for<span class="_ _21"> </span>the<span class="_ _21"> </span>two<span class="_ _21"> </span>semaphores<span class="_ _21"> </span>overlap<span class="_ _1"></span>.<span class="_ _21"> </span>If<span class="_ _21"> </span>some<span class="_ _21"> </span>execution</div><div class="t m5 x26 h26 y1868 ff7 fs19 fc1 sc0 ls0 ws0">trajectory<span class="_ _11"> </span>happens<span class="_ _11"> </span>to<span class="_ _16"> </span>reach<span class="_ _11"> </span>the<span class="_ _11"> </span><span class="ffa">deadlock<span class="_ _11"> </span>state<span class="_ _16"> </span><span class="ff11">d<span class="_ _5"></span></span></span>,<span class="_ _11"> </span>then<span class="_ _16"> </span>no<span class="_ _11"> </span>further<span class="_ _11"> </span>progress<span class="_ _11"> </span>is</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
