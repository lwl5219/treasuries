<div id="pf8a" class="pf w2 h11" data-page-no="8a"><div class="pc pc8a w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg8a.png"/><div class="t m5 xa9 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>2.3<span class="_ _60"> </span>Integer<span class="_ _10"> </span>Arithmetic<span class="_ _3e"> </span><span class="ffe fs1e">137</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>original<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">malloc<span class="_ _10"> </span></span>(line<span class="_"> </span>9)<span class="_"> </span>as<span class="_"> </span>follows:</div><div class="t m5 x1b6 h2d y153e ffd fs1e fc2 sc0 ls0 ws0">uint64_t<span class="_ _e"> </span>asize<span class="_ _1f"> </span>=</div><div class="t m5 x21e h2d y153f ffd fs1e fc2 sc0 ls0 ws0">ele_cnt<span class="_ _e"> </span>*<span class="_ _1f"> </span>(uint64_t)<span class="_ _1f"> </span>ele_size;</div><div class="t m5 x1b6 h2d y1540 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*result<span class="_ _1f"> </span>=<span class="_ _1f"> </span>malloc(asize);</div><div class="t m5 x26 h26 y1541 ff7 fs19 fc2 sc0 ls0 ws0">Recall<span class="_"> </span>that<span class="_"> </span>the<span class="_"> </span>argument<span class="_"> </span>to<span class="_"> </span><span class="ffd">malloc<span class="_ _10"> </span></span>has<span class="_"> </span>type<span class="_"> </span><span class="ffd">size_t</span>.</div><div class="t m5 x34 h26 y1542 ff7 fs19 fc2 sc0 ls0 ws0">A.<span class="_ _1f"> </span>Does<span class="_"> </span>your<span class="_"> </span>code<span class="_"> </span>provide<span class="_"> </span>any<span class="_"> </span>improvement<span class="_"> </span>over<span class="_"> </span>the<span class="_"> </span>original?</div><div class="t m5 x34 h26 y1543 ff7 fs19 fc2 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>How<span class="_"> </span>would<span class="_"> </span>you<span class="_"> </span>change<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>to<span class="_"> </span>eliminate<span class="_"> </span>the<span class="_"> </span>vulnerability?</div><div class="t m5 x17 h41 y1544 ffe fs29 fc1 sc0 ls0 ws0">2.3.6<span class="_ _48"> </span><span class="fs19">Multiplying<span class="_"> </span>by<span class="_"> </span>Constants</span></div><div class="t m5 x17 h26 y1545 ff7 fs19 fc1 sc0 ls0 ws0">Historically<span class="_ _3"></span>,<span class="_ _14"> </span>the<span class="_ _16"> </span>integer<span class="_ _14"> </span>multiply<span class="_ _16"> </span>instruction<span class="_ _16"> </span>on<span class="_ _14"> </span>many<span class="_ _16"> </span>machines<span class="_ _14"> </span>was<span class="_ _16"> </span>fairly<span class="_ _14"> </span>slow<span class="_ _3"></span>,</div><div class="t m5 x17 h26 y1546 ff7 fs19 fc1 sc0 ls0 ws0">requiring<span class="_ _21"> </span>10<span class="_ _f"> </span>or<span class="_ _21"> </span>more<span class="_ _f"> </span>clock<span class="_ _21"> </span>cycles<span class="_ _1"></span>,<span class="_ _e"> </span>whereas<span class="_ _15"> </span>other<span class="_ _f"> </span>integer<span class="_ _21"> </span>operations—such<span class="_ _f"> </span>as</div><div class="t m5 x17 h26 y1547 ff7 fs19 fc1 sc0 ls0 ws0">addition,<span class="_ _21"> </span>subtraction,<span class="_ _f"> </span>bit-level<span class="_ _21"> </span>operations<span class="_ _1"></span>,<span class="_ _f"> </span>and<span class="_ _15"> </span>shifting—required<span class="_ _21"> </span>only<span class="_ _15"> </span>1<span class="_ _21"> </span>clock</div><div class="t m5 x17 h26 y1548 ff7 fs19 fc1 sc0 ls0 ws0">cycle<span class="_ _1"></span>.<span class="_ _13"> </span>Even<span class="_"> </span>on<span class="_ _13"> </span>the<span class="_"> </span>Intel<span class="_ _13"> </span>Core<span class="_ _13"> </span>i7<span class="_"> </span>Haswell<span class="_ _13"> </span>we<span class="_ _13"> </span>use<span class="_"> </span>as<span class="_ _13"> </span>our<span class="_ _13"> </span>reference<span class="_"> </span>machine<span class="_ _1"></span>,<span class="_"> </span>integer</div><div class="t m5 x17 h26 y1549 ff7 fs19 fc1 sc0 ls0 ws0">multiply<span class="_ _16"> </span>requires<span class="_ _16"> </span>3<span class="_ _16"> </span>clock<span class="_ _16"> </span>cycles<span class="_ _3"></span>.<span class="_ _16"> </span>As<span class="_ _16"> </span>a<span class="_ _16"> </span>consequence,<span class="_ _16"> </span>one<span class="_ _16"> </span>important<span class="_ _16"> </span>optimization</div><div class="t m5 x17 h26 y154a ff7 fs19 fc1 sc0 ls0 ws0">used<span class="_ _13"> </span>by<span class="_ _13"> </span>compilers<span class="_"> </span>is<span class="_ _13"> </span>to<span class="_ _13"> </span>attempt<span class="_ _13"> </span>to<span class="_ _13"> </span>replace<span class="_"> </span>multiplications<span class="_ _13"> </span>by<span class="_ _13"> </span>constant<span class="_ _13"> </span>factors<span class="_ _13"> </span>with</div><div class="t m5 x17 h26 y154b ff7 fs19 fc1 sc0 ls0 ws0">combinations<span class="_ _16"> </span>of<span class="_ _16"> </span>shift<span class="_ _11"> </span>and<span class="_ _16"> </span>addition<span class="_ _16"> </span>operations<span class="_ _1"></span>.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>will<span class="_ _16"> </span>ﬁrst<span class="_ _16"> </span>consider<span class="_ _16"> </span>the<span class="_ _16"> </span>case<span class="_ _16"> </span>of</div><div class="t m5 x17 h26 y154c ff7 fs19 fc1 sc0 ls0 ws0">multiplying<span class="_ _13"> </span>by<span class="_ _6"> </span>a<span class="_ _13"> </span>power<span class="_ _13"> </span>of<span class="_ _13"> </span>2,<span class="_ _13"> </span>and<span class="_ _6"> </span>then<span class="_ _13"> </span>we<span class="_ _13"> </span>will<span class="_ _13"> </span>generalize<span class="_ _6"> </span>this<span class="_ _13"> </span>to<span class="_ _13"> </span>arbitrary<span class="_ _13"> </span>constants<span class="_ _3"></span>.</div><div class="t m5 x17 h5b y154d ff1b fs14 fc6 sc0 ls0 ws0">principle:<span class="_ _e"> </span><span class="ff7 fs19 fc1">Multiplication<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>power<span class="_"> </span>of<span class="_"> </span>2</span></div><div class="t m5 x17 h26 y154e ff7 fs19 fc1 sc0 ls0 ws0">Let<span class="_ _15"> </span><span class="ff11">x<span class="_ _f"> </span></span>be<span class="_ _15"> </span>the<span class="_ _15"> </span>unsigned<span class="_ _15"> </span>integer<span class="_ _15"> </span>represented<span class="_ _15"> </span>by<span class="_ _15"> </span>bit<span class="_ _15"> </span>pattern<span class="_ _14"> </span>[<span class="ff11">x</span></div><div class="t m5 xe8 h4b y154f ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−<span class="ff7">1</span></span></div><div class="t m5 x12f h45 y1550 ff11 fs19 fc1 sc0 lsab ws0">,x</div><div class="t m5 x18a h4b y1551 ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−<span class="ff7">2</span></span></div><div class="t m5 x1fd h45 y1550 ff11 fs19 fc1 sc0 lsab ws0">,..<span class="_ _0"></span>.,x</div><div class="t m5 x158 h3c y1551 ff7 fs25 fc1 sc0 ls0 ws0">0</div><div class="t m5 x159 h26 y1550 ff7 fs19 fc1 sc0 ls2d ws0">].</div><div class="t m5 x17 h46 y1552 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>hen<span class="_ _f"> </span>for<span class="_ _f"> </span>any<span class="_ _f"> </span><span class="ff11">k<span class="_ _16"> </span><span class="ff12">≥<span class="_ _10"> </span></span></span><span class="lsb1">0,<span class="_ _e"> </span>the<span class="_ _21"> </span></span><span class="ff11">w<span class="_ _11"> </span><span class="ff12">+<span class="_ _10"> </span></span>k<span class="_ _2"></span></span>-bit<span class="_ _f"> </span>unsigned<span class="_ _f"> </span>representation<span class="_ _f"> </span>of<span class="_ _f"> </span><span class="ff11">x<span class="_ _5"></span></span>2</div><div class="t m5 xa h50 y1553 ff11 fs25 fc1 sc0 ls0 ws0">k</div><div class="t m5 x3b h26 y1554 ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _f"> </span>given<span class="_ _f"> </span>by</div><div class="t m5 x17 h26 y1555 ff7 fs19 fc1 sc0 ls0 ws0">[<span class="ff11">x</span></div><div class="t m5 x34 h4b y1556 ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−<span class="ff7">1</span></span></div><div class="t m5 x2e h45 y1557 ff11 fs19 fc1 sc0 ls42 ws0">,x</div><div class="t m5 xd1 h4b y1556 ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−<span class="ff7">2</span></span></div><div class="t m5 x160 h45 y1557 ff11 fs19 fc1 sc0 ls42 ws0">,...,x</div><div class="t m5 x13 h3c y1556 ff7 fs25 fc1 sc0 ls0 ws0">0</div><div class="t m5 x32 h26 y1557 ff11 fs19 fc1 sc0 ls0 ws0">,<span class="_ _13"> </span><span class="ff7 fc6">0<span class="_ _2"></span></span><span class="ls42">,...,</span><span class="ff7 fc6">0<span class="fc1">]<span class="_ _3"></span>,<span class="_"> </span>where<span class="_"> </span><span class="ff11">k<span class="_"> </span></span>zeros<span class="_"> </span>have<span class="_"> </span>been<span class="_"> </span>added<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>right.</span></span></div><div class="t m5 x26 h46 y1558 ff7 fs19 fc1 sc0 ls0 ws0">So<span class="_ _1"></span>,<span class="_ _16"> </span>for<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _16"> </span>11<span class="_ _16"> </span>can<span class="_ _11"> </span>be<span class="_ _16"> </span>represented<span class="_ _11"> </span>for<span class="_ _16"> </span><span class="ff11">w<span class="_ _10"> </span><span class="ff12">=<span class="_ _10"> </span></span></span>4<span class="_ _11"> </span>as<span class="_ _16"> </span>[1011]<span class="_ _3"></span>.<span class="_ _16"> </span>Shifting<span class="_ _11"> </span>this<span class="_ _16"> </span>left</div><div class="t m5 x17 h46 y1559 ff7 fs19 fc1 sc0 ls0 ws0">by<span class="_ _15"> </span><span class="ff11">k<span class="_ _11"> </span><span class="ff12">=<span class="_ _10"> </span></span></span>2<span class="_ _15"> </span>yields<span class="_ _21"> </span>the<span class="_ _15"> </span>6-bit<span class="_ _21"> </span>vector<span class="_ _15"> </span>[101100]<span class="_ _1"></span>,<span class="_ _f"> </span>which<span class="_ _15"> </span>encodes<span class="_ _21"> </span>the<span class="_ _15"> </span>unsigned<span class="_ _21"> </span>number</div><div class="t m5 x17 h26 y155a ff7 fs19 fc1 sc0 ls0 ws0">11</div><div class="t m5 x1f5 h45 y155b ff11 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 x37 h46 y155a ff7 fs19 fc1 sc0 ls0 ws0">4<span class="_ _13"> </span><span class="ff12">=<span class="_ _10"> </span></span><span class="lsa0">44.</span></div><div class="t m5 x17 h5b y155c ff1b fs14 fc6 sc0 ls0 ws0">derivation:<span class="_ _e"> </span><span class="ff7 fs19 fc1">Multiplication<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>power<span class="_"> </span>of<span class="_"> </span>2</span></div><div class="t m5 x17 h26 y155d ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>property<span class="_"> </span>can<span class="_"> </span>be<span class="_"> </span>derived<span class="_"> </span>using<span class="_"> </span>Equation<span class="_"> </span>2.1:</div><div class="t m5 x5b h30 y155e ffa fs19 fc1 sc0 ls0 ws0">B2U</div><div class="t m5 x1cb h4b y155f ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">+</span>k</div><div class="t m5 x134 h26 y1560 ff11 fs19 fc1 sc0 ls0 ws0">(<span class="ff7">[</span>x</div><div class="t m5 x65 h4b y155f ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−<span class="ff7">1</span></span></div><div class="t m5 x15e h45 y1560 ff11 fs19 fc1 sc0 ls42 ws0">,x</div><div class="t m5 x15c h4b y155f ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−<span class="ff7">2</span></span></div><div class="t m5 xb7 h45 y1560 ff11 fs19 fc1 sc0 ls42 ws0">,...,x</div><div class="t m5 x1e6 h3c y155f ff7 fs25 fc1 sc0 ls0 ws0">0</div><div class="t m5 xdd h46 y1560 ff11 fs19 fc1 sc0 ls0 ws0">,<span class="_ _13"> </span><span class="ff7 fc6">0<span class="_ _2"></span></span><span class="ls42">,...,</span><span class="ff7 fc6">0<span class="fc1">]<span class="_ _3"></span><span class="ff11">)<span class="_ _10"> </span><span class="ff12">=</span></span></span></span></div><div class="t m5 x1d9 h4b y1561 ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−<span class="ff7">1</span></span></div><div class="t m5 x120 h5c y1562 ff1e fs19 fc1 sc0 ls0 ws0"></div><div class="t m5 x19d h4b y1563 ff11 fs25 fc1 sc0 ls0 ws0">i<span class="_ _2"></span><span class="ff12">=<span class="ff7">0</span></span></div><div class="t m5 x1fc h45 y1560 ff11 fs19 fc1 sc0 ls0 ws0">x</div><div class="t m5 x170 h50 y155f ff11 fs25 fc1 sc0 ls0 ws0">i</div><div class="t m5 xf9 h26 y1560 ff7 fs19 fc1 sc0 ls0 ws0">2</div><div class="t m5 xe8 h4b y1564 ff11 fs25 fc1 sc0 ls0 ws0">i<span class="_ _2"></span><span class="ff12">+</span>k</div><div class="t m5 xb1 h46 y1565 ff12 fs19 fc1 sc0 ls0 ws0">=</div><div class="t m5 x1d9 h5c y1566 ff1e fs19 fc1 sc0 ls0 ws0"></div><div class="t m5 x1b4 h4b y1567 ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−<span class="ff7">1</span></span></div><div class="t m5 x1b4 h5c y1568 ff1e fs19 fc1 sc0 ls0 ws0"></div><div class="t m5 x19b h4b y1569 ff11 fs25 fc1 sc0 ls0 ws0">i<span class="_ _2"></span><span class="ff12">=<span class="ff7">0</span></span></div><div class="t m5 x1ad h45 y1565 ff11 fs19 fc1 sc0 ls0 ws0">x</div><div class="t m5 x1a3 h50 y156a ff11 fs25 fc1 sc0 ls0 ws0">i</div><div class="t m5 x1df h26 y1565 ff7 fs19 fc1 sc0 ls0 ws0">2</div><div class="t m5 x195 h50 y156b ff11 fs25 fc1 sc0 ls0 ws0">i</div><div class="t m5 x163 h5c y156c ff1e fs19 fc1 sc0 ls0 ws0"></div><div class="t m5 xa9 h45 y156d ff11 fs19 fc1 sc0 ls0 ws0">.</div><div class="t m5 xf2 h26 y156e ff7 fs19 fc1 sc0 ls0 ws0">2</div><div class="t m5 x100 h50 y156b ff11 fs25 fc1 sc0 ls0 ws0">k</div><div class="t m5 xb1 h46 y156f ff12 fs19 fc1 sc0 ls0 ws0">=<span class="_ _13"> </span><span class="ff11">x<span class="_ _5"></span><span class="ff7">2</span></span></div><div class="t m5 x1c7 h50 y1570 ff11 fs25 fc1 sc0 ls0 ws0">k</div><div class="t m5 x26 h26 y1571 ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _a"> </span>shifting<span class="_ _6"> </span>left<span class="_ _13"> </span>by<span class="_ _a"> </span><span class="ff11">k<span class="_ _13"> </span></span>for<span class="_ _6"> </span>a<span class="_ _6"> </span>ﬁxed<span class="_ _13"> </span>word<span class="_ _a"> </span>size,<span class="_ _6"> </span>the<span class="_ _6"> </span>high-order<span class="_ _6"> </span><span class="ff11">k<span class="_ _13"> </span></span>bits<span class="_ _6"> </span>are<span class="_ _6"> </span>discarded,</div><div class="t m5 x17 h26 y1572 ff7 fs19 fc1 sc0 ls0 ws0">yielding</div><div class="t m5 x21f h26 y1573 ff7 fs19 fc1 sc0 ls0 ws0">[<span class="ff11">x</span></div><div class="t m5 x4d h4b y1574 ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−</span>k<span class="_ _2"></span><span class="ff12">−<span class="ff7">1</span></span></div><div class="t m5 x8f h45 y1152 ff11 fs19 fc1 sc0 ls42 ws0">,x</div><div class="t m5 x47 h4b y1574 ff11 fs25 fc1 sc0 ls0 ws0">w<span class="ff12">−</span>k<span class="_ _2"></span><span class="ff12">−<span class="ff7">2</span></span></div><div class="t m5 x1ed h45 y1152 ff11 fs19 fc1 sc0 ls42 ws0">,...,x</div><div class="t m5 x198 h3c y1574 ff7 fs25 fc1 sc0 ls0 ws0">0</div><div class="t m5 x17c h26 y1152 ff11 fs19 fc1 sc0 ls0 ws0">,<span class="_ _13"> </span><span class="ff7 fc6">0<span class="_ _2"></span></span><span class="ls42">,...,</span><span class="ff7 fc6">0<span class="fc1">]</span></span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
