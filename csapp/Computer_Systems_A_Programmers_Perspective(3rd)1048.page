<div id="pf418" class="pf w2 h11" data-page-no="418"><div class="pc pc418 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg418.png"/><div class="t m5 x69 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.5<span class="_ _60"> </span>Synchronizing<span class="_ _10"> </span>Threads<span class="_ _10"> </span>with<span class="_ _10"> </span>Semaphores<span class="_ _3e"> </span><span class="ffe fs1e">1047</span></div><div class="t m5 x1e0 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoservert-pre<span class="_ _1"></span>.c</div><div class="t m5 x2c h88 y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h88 y35f1 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&quot;sbuf.h&quot;</span></div><div class="t m5 x2c h88 ye97 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs4e fc2">#define<span class="_ _e"> </span>NTHREADS<span class="_ _ea"> </span>4</span></div><div class="t m5 x2c h88 y59ed ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs4e fc2">#define<span class="_ _e"> </span>SBUFSIZE<span class="_ _ea"> </span>16</span></div><div class="t m5 x2c h2e y2827 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2c h2e y80ea ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x2d h88 y59ee ffd fs4e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>echo_cnt(int<span class="_ _f"> </span>connfd);</div><div class="t m5 x2c h88 y180c ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>*thread(void<span class="_ _e"> </span>*vargp);</span></div><div class="t m5 x2c h2e y59ef ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x2c h2e y7cbc ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x2d h88 y59f0 ffd fs4e fc2 sc0 ls0 ws0">sbuf_t<span class="_ _e"> </span>sbuf;<span class="_ _f"> </span>/*<span class="_ _e"> </span>Shared<span class="_ _e"> </span>buffer<span class="_ _f"> </span>of<span class="_ _e"> </span>connected<span class="_ _e"> </span>descriptors<span class="_ _f"> </span>*/</div><div class="t m5 x17 h2e y59f1 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x17 h2e y82e7 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x2d h88 y59f3 ffd fs4e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _f"> </span>argc,<span class="_ _e"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x17 h88 y59f4 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x17 h88 y59f6 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>i,<span class="_ _e"> </span>listenfd,<span class="_ _f"> </span>connfd;</span></div><div class="t m5 x17 h88 y59f7 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _e2"> </span><span class="ffd fs4e fc2">socklen_t<span class="_ _e"> </span>clientlen;</span></div><div class="t m5 x17 h88 y37bd ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _e2"> </span><span class="ffd fs4e fc2">struct<span class="_ _e"> </span>sockaddr_storage<span class="_ _e"> </span>clientaddr;</span></div><div class="t m5 x17 h88 y59f8 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _e2"> </span><span class="ffd fs4e fc2">pthread_t<span class="_ _e"> </span>tid;</span></div><div class="t m5 x17 h2e y4b5d ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x17 h2e y82e8 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x1a0 h88 y59f9 ffd fs4e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(argc<span class="_ _f"> </span>!=<span class="_ _e"> </span>2)<span class="_ _e"> </span>{</div><div class="t m5 x17 h88 y59fa ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _18b"> </span><span class="ffd fs4e fc2">fprintf(stderr,<span class="_ _e"> </span>&quot;usage:<span class="_ _f"> </span>%s<span class="_ _e"> </span>&lt;port&gt;\n&quot;,<span class="_ _e"> </span>argv[0]);</span></div><div class="t m5 x17 h88 y59fb ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _18b"> </span><span class="ffd fs4e fc2">exit(0);</span></div><div class="t m5 x17 h88 y59fd ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h88 y59fe ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _e2"> </span><span class="ffd fs4e fc2">listenfd<span class="_ _e"> </span>=<span class="_ _e"> </span>Open_listenfd(argv[1]);</span></div><div class="t m5 x17 h2e y59ff ff6 fs20 fc6 sc0 ls0 ws0">23</div><div class="t m5 x17 h2e y82e9 ff6 fs20 fc6 sc0 ls0 ws0">24</div><div class="t m5 x1a0 h88 y2568 ffd fs4e fc2 sc0 ls0 ws0">sbuf_init(&amp;sbuf,<span class="_ _e"> </span>SBUFSIZE);</div><div class="t m5 x17 h88 y5a00 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _e2"> </span><span class="ffd fs4e fc2">for<span class="_ _e"> </span>(i<span class="_ _e"> </span>=<span class="_ _f"> </span>0;<span class="_ _e"> </span>i<span class="_ _e"> </span>&lt;<span class="_ _f"> </span>NTHREADS;<span class="_ _e"> </span>i++)<span class="_ _ea"> </span>/*<span class="_ _e"> </span>Create<span class="_ _e"> </span>worker<span class="_ _f"> </span>threads<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y5a01 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _18b"> </span><span class="ffd fs4e fc2">Pthread_create(&amp;tid,<span class="_ _e"> </span>NULL,<span class="_ _f"> </span>thread,<span class="_ _e"> </span>NULL);</span></div><div class="t m5 x17 h2e y301c ff6 fs20 fc6 sc0 ls0 ws0">27</div><div class="t m5 x17 h2e y5a02 ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x1a0 h88 y5a03 ffd fs4e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(1)<span class="_ _f"> </span>{</div><div class="t m5 x17 h88 y5a04 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _18b"> </span><span class="ffd fs4e fc2">clientlen<span class="_ _e"> </span>=<span class="_ _f"> </span>sizeof(struct<span class="_ _e"> </span>sockaddr_storage);</span></div><div class="t m5 x17 h88 y5a05 ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _18b"> </span><span class="ffd fs4e fc2">connfd<span class="_ _e"> </span>=<span class="_ _f"> </span>Accept(listenfd,<span class="_ _e"> </span>(SA<span class="_ _e"> </span>*)<span class="_ _f"> </span>&amp;clientaddr,<span class="_ _e"> </span>&amp;clientlen);</span></div><div class="t m5 x17 h88 y5a06 ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _18b"> </span><span class="ffd fs4e fc2">sbuf_insert(&amp;sbuf,<span class="_ _e"> </span>connfd);<span class="_ _f"> </span>/*<span class="_ _e"> </span>Insert<span class="_ _e"> </span>connfd<span class="_ _f"> </span>in<span class="_ _e"> </span>buffer<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y1dd5 ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h88 y1abf ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h2e y296f ff6 fs20 fc6 sc0 ls0 ws0">34</div><div class="t m5 x17 h2e y80ed ff6 fs20 fc6 sc0 ls0 ws0">35</div><div class="t m5 x2d h88 y5a07 ffd fs4e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*thread(void<span class="_ _f"> </span>*vargp)</div><div class="t m5 x17 h88 y5a08 ff6 fs20 fc6 sc0 ls0 ws0">36<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x17 h88 y5a0a ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _e2"> </span><span class="ffd fs4e fc2">Pthread_detach(pthread_self());</span></div><div class="t m5 x17 h88 y55cc ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _e2"> </span><span class="ffd fs4e fc2">while<span class="_ _e"> </span>(1)<span class="_ _e"> </span>{</span></div><div class="t m5 x17 h88 y3028 ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _18b"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>connfd<span class="_ _f"> </span>=<span class="_ _e"> </span>sbuf_remove(&amp;sbuf);<span class="_ _e"> </span>/*<span class="_ _f"> </span>Remove<span class="_ _e"> </span>connfd<span class="_ _e"> </span>from<span class="_ _e"> </span>buffer<span class="_ _f"> </span>*/</span></div><div class="t m5 x17 h88 y55cd ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _18b"> </span><span class="ffd fs4e fc2">echo_cnt(connfd);<span class="_ _1c2"> </span>/*<span class="_ _e"> </span>Service<span class="_ _e"> </span>client<span class="_ _f"> </span>*/</span></div><div class="t m5 x17 h88 yc47 ff6 fs20 fc6 sc0 ls0 ws0">41<span class="_ _18b"> </span><span class="ffd fs4e fc2">Close(connfd);</span></div><div class="t m5 x17 h88 y6294 ff6 fs20 fc6 sc0 ls0 ws0">42<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h88 y6295 ff6 fs20 fc6 sc0 ls0 ws0">43<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1e0 h2c y82ea ffa fs16 fc2 sc0 ls0 ws0">code/conc/echoservert-pre<span class="_ _1"></span>.c</div><div class="t m5 x17 h34 y82eb ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>12.28<span class="_ _66"> </span><span class="fc1">A<span class="_ _16"> </span>prethreaded<span class="_ _16"> </span>concurrent<span class="_ _11"> </span>echo<span class="_ _16"> </span>server<span class="_ _1"></span>.<span class="_ _16"> </span><span class="ff6">The<span class="_ _16"> </span>server<span class="_ _16"> </span>uses<span class="_ _16"> </span>a<span class="_ _11"> </span>producer-consumer<span class="_ _16"> </span>model<span class="_ _16"> </span>with</span></span></div><div class="t m5 x17 h34 y82ec ff6 fs16 fc1 sc0 ls0 ws0">one<span class="_ _10"> </span>producer<span class="_ _11"> </span>and<span class="_ _10"> </span>multiple<span class="_ _10"> </span>consumers.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
