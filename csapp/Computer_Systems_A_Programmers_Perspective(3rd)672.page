<div id="pf2a0" class="pf w2 h11" data-page-no="2a0"><div class="pc pc2a0 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2a0.png"/><div class="t m5 xf5 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>6.5<span class="_ _60"> </span>Writing<span class="_ _10"> </span>Cache-Friendly<span class="_ _10"> </span>Code<span class="_ _1b"> </span><span class="ffe fs1e">671</span></div><div class="t m5 x17 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">stride-<span class="ff11">k<span class="_ _10"> </span></span>reference<span class="_"> </span>pattern<span class="_ _13"> </span>(where<span class="_"> </span><span class="ff11">k<span class="_ _10"> </span></span>is<span class="_"> </span>expressed<span class="_ _13"> </span>in<span class="_ _13"> </span>words)<span class="_"> </span>results<span class="_ _13"> </span>in<span class="_"> </span>an<span class="_ _13"> </span>average<span class="_"> </span>of</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">min</div><div class="t m5 x1a4 h45 y5941 ff11 fs19 fc2 sc0 ls0 ws0">(</div><div class="t m5 x1a2 h46 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">1<span class="_ _1"></span><span class="ff11 ls42">,(<span class="_ _80"></span><span class="ffa ls0">word<span class="_"> </span>siz<span class="_ _0"></span>e<span class="_"> </span><span class="ff12">×<span class="_ _13"></span></span>k<span class="ff11">)/</span>B</span></span></div><div class="t m5 xc3 h45 y5941 ff11 fs19 fc2 sc0 ls0 ws0">)</div><div class="t m5 x1f7 h46 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">misses<span class="_"> </span>per<span class="_ _11"> </span>loop<span class="_ _11"> </span>iteration.<span class="_ _11"> </span>T<span class="_ _1"></span>his<span class="_ _11"> </span>is<span class="_ _11"> </span>minimized<span class="_ _11"> </span>for<span class="_ _11"> </span><span class="ff11">k<span class="_ _10"> </span><span class="ff12">=<span class="_ _10"> </span></span></span><span class="ls25">1,</span></div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">so<span class="_ _16"> </span>the<span class="_ _14"> </span>stride-1<span class="_ _14"> </span>references<span class="_ _14"> </span>to<span class="_ _16"> </span><span class="ffd">v<span class="_ _14"> </span></span>are<span class="_ _14"> </span>indeed<span class="_ _14"> </span>cache<span class="_ _16"> </span>friendly<span class="_ _3"></span>.<span class="_ _14"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>example<span class="_ _1"></span>,<span class="_ _15"> </span>suppose</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_"> </span><span class="ffd">v<span class="_ _13"> </span></span>is<span class="_"> </span>block<span class="_"> </span>aligned,<span class="_ _13"> </span>words<span class="_"> </span>are<span class="_"> </span>4<span class="_ _13"> </span>bytes<span class="_ _1"></span>,<span class="_"> </span>cache<span class="_"> </span>blocks<span class="_ _13"> </span>are<span class="_"> </span>4<span class="_"> </span>words<span class="_ _3"></span>,<span class="_"> </span>and<span class="_"> </span>the<span class="_ _13"> </span>cache</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _11"> </span>initially<span class="_ _16"> </span>empty<span class="_ _16"> </span>(a<span class="_ _11"> </span>cold<span class="_ _16"> </span>cache).<span class="_ _16"> </span>T<span class="_ _1"></span>hen,<span class="_ _16"> </span>regardless<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>cache<span class="_ _16"> </span>organization,<span class="_ _16"> </span>the</div><div class="t m5 x17 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">references<span class="_"> </span>to<span class="_"> </span><span class="ffd">v<span class="_ _10"> </span></span>will<span class="_"> </span>result<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>pattern<span class="_"> </span>of<span class="_"> </span>hits<span class="_"> </span>and<span class="_"> </span>misses:</div><div class="t m5 x17 h32 y5942 ffd fs1e fc2 sc0 ls0 ws0">v[i]<span class="_ _129"> </span><span class="ff11 fs21">i<span class="_ _11"> </span><span class="ff12">=<span class="_ _13"></span><span class="ff7">0<span class="_ _79"> </span></span></span>i<span class="_ _10"> </span><span class="ff12">=<span class="_ _10"> </span><span class="ff7">1<span class="_ _13c"> </span></span></span>i<span class="_ _11"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">2<span class="_ _26"> </span></span></span>i<span class="_ _11"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">3<span class="_ _f1"> </span></span></span>i<span class="_ _11"> </span><span class="ff12">=<span class="_ _13"></span><span class="ff7">4<span class="_ _79"> </span></span></span>i<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">5<span class="_ _26"> </span></span></span>i<span class="_ _10"> </span><span class="ff12">=<span class="_ _10"> </span><span class="ff7">6<span class="_ _26"> </span></span></span>i<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"></span><span class="ff7">7</span></span></span></div><div class="t m5 x17 h31 y5943 ff7 fs21 fc2 sc0 ls0 ws0">Access<span class="_"> </span>order,<span class="_"> </span>[h]it<span class="_"> </span>or<span class="_"> </span>[m]iss<span class="_ _26"> </span>1<span class="_"> </span><span class="ffc">[m]<span class="_ _26"> </span></span>2<span class="_"> </span>[h]<span class="_ _f1"> </span>3<span class="_"> </span>[h]<span class="_ _f1"> </span>4<span class="_"> </span>[h]<span class="_ _95"> </span>5<span class="_"> </span><span class="ffc">[m]<span class="_ _95"> </span></span>6<span class="_"> </span>[h]<span class="_ _f1"> </span>7<span class="_"> </span>[h]<span class="_ _f1"> </span>8<span class="_"> </span>[h]</div><div class="t m5 x26 h26 y5944 ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _16"> </span>this<span class="_ _16"> </span>example<span class="_ _1"></span>,<span class="_ _14"> </span>the<span class="_ _16"> </span>reference<span class="_ _16"> </span>to<span class="_ _16"> </span><span class="ffd">v[0]<span class="_ _16"> </span></span>misses<span class="_ _16"> </span>and<span class="_ _16"> </span>the<span class="_ _16"> </span>corresponding<span class="_ _16"> </span>block,</div><div class="t m5 x17 h26 y5945 ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_"> </span>contains<span class="_"> </span><span class="ffd">v[0]</span>–<span class="ffd">v[3]</span>,<span class="_"> </span>is<span class="_"> </span>loaded<span class="_"> </span>into<span class="_"> </span>the<span class="_"> </span>cache<span class="_"> </span>from<span class="_ _11"> </span>memory<span class="_ _3"></span>.<span class="_"> </span>T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>next</div><div class="t m5 x17 h26 y5946 ff7 fs19 fc2 sc0 ls0 ws0">three<span class="_"> </span>references<span class="_ _11"> </span>are<span class="_ _11"> </span>all<span class="_ _11"> </span>hits<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_"> </span>reference<span class="_ _11"> </span>to<span class="_ _11"> </span><span class="ffd">v[4]<span class="_ _11"> </span></span>causes<span class="_ _11"> </span>another<span class="_ _11"> </span>miss<span class="_ _11"> </span>as<span class="_ _11"> </span>a<span class="_"> </span>new</div><div class="t m5 x17 h26 y5947 ff7 fs19 fc2 sc0 ls0 ws0">block<span class="_ _16"> </span>is<span class="_ _14"> </span>loaded<span class="_ _16"> </span>into<span class="_ _14"> </span>the<span class="_ _16"> </span>cache<span class="_ _0"></span>,<span class="_ _14"> </span>the<span class="_ _16"> </span>next<span class="_ _14"> </span>three<span class="_ _16"> </span>references<span class="_ _14"> </span>are<span class="_ _16"> </span>hits<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _14"> </span>so<span class="_ _16"> </span>on.<span class="_ _14"> </span>In</div><div class="t m5 x17 h26 y5948 ff7 fs19 fc2 sc0 ls0 ws0">general,<span class="_ _16"> </span>three<span class="_ _11"> </span>out<span class="_ _16"> </span>of<span class="_ _11"> </span>four<span class="_ _16"> </span>references<span class="_ _16"> </span>will<span class="_ _11"> </span>hit,<span class="_ _16"> </span>which<span class="_ _16"> </span>is<span class="_ _11"> </span>the<span class="_ _16"> </span>best<span class="_ _11"> </span>we<span class="_ _16"> </span>can<span class="_ _11"> </span>do<span class="_ _16"> </span>in<span class="_ _11"> </span>this</div><div class="t m5 x17 h26 y5949 ff7 fs19 fc2 sc0 ls0 ws0">case<span class="_"> </span>with<span class="_"> </span>a<span class="_"> </span>cold<span class="_"> </span>cache<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y594a ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _14"> </span>summarize<span class="_ _1"></span>,<span class="_ _14"> </span>our<span class="_ _14"> </span>simple<span class="_ _16"> </span><span class="ffd">sumvec<span class="_ _14"> </span></span>example<span class="_ _16"> </span>illustrates<span class="_ _16"> </span>two<span class="_ _14"> </span>important<span class="_ _16"> </span>points</div><div class="t m5 x17 h26 y594b ff7 fs19 fc2 sc0 ls0 ws0">about<span class="_"> </span>writing<span class="_"> </span>cache-friendly<span class="_"> </span>code:</div><div class="t m5 x72 h3d y594c ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x26 h26 y594d ff7 fs19 fc1 sc0 ls0 ws0">Repeated<span class="_ _15"> </span>references<span class="_ _14"> </span>to<span class="_ _15"> </span>local<span class="_ _15"> </span>variables<span class="_ _15"> </span>are<span class="_ _15"> </span>good<span class="_ _15"> </span>because<span class="_ _15"> </span>the<span class="_ _15"> </span>compiler<span class="_ _15"> </span>can</div><div class="t m5 x26 h26 y594e ff7 fs19 fc1 sc0 ls0 ws0">cache<span class="_"> </span>them<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>register<span class="_"> </span>ﬁle<span class="_"> </span>(temporal<span class="_"> </span>locality).</div><div class="t m5 x72 h3d y594f ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x26 h26 y5950 ff7 fs19 fc1 sc0 ls0 ws0">Stride-1<span class="_ _6"> </span>reference<span class="_ _6"> </span>patterns<span class="_ _6"> </span>are<span class="_ _6"> </span>good<span class="_ _6"> </span>because<span class="_ _6"> </span>caches<span class="_ _6"> </span>at<span class="_ _6"> </span>all<span class="_ _6"> </span>levels<span class="_ _6"> </span>of<span class="_ _6"> </span>the<span class="_ _6"> </span>memory</div><div class="t m5 x26 h26 y5951 ff7 fs19 fc1 sc0 ls0 ws0">hierarchy<span class="_"> </span>store<span class="_"> </span>data<span class="_"> </span>as<span class="_"> </span>contiguous<span class="_"> </span>blocks<span class="_"> </span>(spatial<span class="_"> </span>locality).</div><div class="t m5 x26 h26 y5952 ff7 fs19 fc1 sc0 ls0 ws0">Spatial<span class="_ _15"> </span>locality<span class="_ _21"> </span>is<span class="_ _15"> </span>especially<span class="_ _21"> </span>important<span class="_ _15"> </span>in<span class="_ _21"> </span>programs<span class="_ _15"> </span>that<span class="_ _21"> </span>operate<span class="_ _15"> </span>on<span class="_ _21"> </span>multi-</div><div class="t m5 x17 h26 y5953 ff7 fs19 fc1 sc0 ls0 ws0">dimensional<span class="_"> </span>arrays<span class="_ _1"></span>.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_"> </span>example,<span class="_"> </span>consider<span class="_"> </span>the<span class="_"> </span><span class="ffd">sumarrayrows<span class="_ _11"> </span></span>function<span class="_"> </span>from<span class="_ _11"> </span>Sec-</div><div class="t m5 x17 h26 y5954 ff7 fs19 fc1 sc0 ls0 ws0">tion<span class="_ _13"> </span>6.2,<span class="_"> </span>which<span class="_ _13"> </span>sums<span class="_"> </span>the<span class="_ _13"> </span>elements<span class="_"> </span>of<span class="_ _13"> </span>a<span class="_ _13"> </span>two-dimensional<span class="_"> </span>array<span class="_ _13"> </span>in<span class="_"> </span>row-major<span class="_ _13"> </span>order:</div><div class="t m5 x2c h2e y5955 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x2d h2d y5956 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>sumarrayrows(int<span class="_ _1f"> </span>a[M][N])</div><div class="t m5 x2c h2d y5957 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y5958 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>i,<span class="_ _1f"> </span>j,<span class="_ _1f"> </span>sum<span class="_ _e"> </span>=<span class="_ _1f"> </span>0;</span></div><div class="t m5 x2c h2e y5959 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y595a ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x142 h2d y595b ffd fs1e fc2 sc0 ls33 ws0">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;M<span class="_ _41"></span>;<span class="ls0">i++)</span></div><div class="t m5 x2c h2d y595c ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _70"> </span><span class="ffd fs1e fc2 ls33">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>j=0<span class="_ _41"></span>;j&lt;N<span class="_ _41"></span>;<span class="ls0">j++)</span></span></div><div class="t m5 x2c h2d y595d ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _d1"> </span><span class="ffd fs1e fc2">sum<span class="_ _1f"> </span>+=<span class="_ _e"> </span>a[i][j];</span></div><div class="t m5 x2c h2d y595e ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>sum;</span></div><div class="t m5 x2c h2d y595f ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x26 h26 y5960 ff7 fs19 fc2 sc0 ls0 ws0">Since<span class="_ _11"> </span>C<span class="_ _11"> </span>stores<span class="_ _11"> </span>arrays<span class="_"> </span>in<span class="_ _11"> </span>row-major<span class="_ _11"> </span>order,<span class="_ _11"> </span>the<span class="_ _11"> </span>inner<span class="_ _11"> </span>loop<span class="_ _11"> </span>of<span class="_ _11"> </span>this<span class="_ _11"> </span>function<span class="_ _11"> </span>has</div><div class="t m5 x17 h26 y5961 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>same<span class="_ _14"> </span>desirable<span class="_ _14"> </span>stride-1<span class="_ _14"> </span>access<span class="_ _16"> </span>pattern<span class="_ _14"> </span>as<span class="_ _14"> </span><span class="ffd">sumvec</span>.<span class="_ _14"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>example<span class="_ _1"></span>,<span class="_ _15"> </span>suppose<span class="_ _14"> </span>we</div><div class="t m5 x17 h26 y5962 ff7 fs19 fc2 sc0 ls0 ws0">make<span class="_ _11"> </span>the<span class="_ _11"> </span>same<span class="_ _16"> </span>assumptions<span class="_ _11"> </span>about<span class="_ _11"> </span>the<span class="_ _11"> </span>cache<span class="_ _16"> </span>as<span class="_ _11"> </span>for<span class="_ _11"> </span><span class="ffd">sumvec</span>.<span class="_ _11"> </span>Then<span class="_"> </span>the<span class="_ _16"> </span>references</div><div class="t m5 x17 h26 y5963 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_"> </span>the<span class="_"> </span>array<span class="_"> </span><span class="ffd">a<span class="_ _10"> </span></span>will<span class="_"> </span>result<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>pattern<span class="_"> </span>of<span class="_"> </span>hits<span class="_"> </span>and<span class="_"> </span>misses:</div><div class="t m5 x17 h32 y5964 ffd fs1e fc2 sc0 ls0 ws0">a[i][j]<span class="_ _61"> </span><span class="ff11 fs21">j<span class="_"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">0<span class="_ _4c"> </span></span></span>j<span class="_"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">1<span class="_ _7b"> </span></span></span>j<span class="_"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">2<span class="_ _1f9"> </span></span></span>j<span class="_"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">3<span class="_ _76"> </span></span></span>j<span class="_"> </span><span class="ff12">=<span class="_ _13"></span><span class="ff7">4<span class="_ _76"> </span></span></span>j<span class="_"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">5<span class="_ _46"> </span></span></span>j<span class="_"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">6<span class="_ _46"> </span></span></span>j<span class="_"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7">7</span></span></span></div><div class="t m5 x17 h32 y189e ff11 fs21 fc2 sc0 ls0 ws0">i<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7 ls251">01<span class="_ _1b7"></span><span class="ffc ls0">[m]<span class="_ _3a"> </span><span class="ff7">2<span class="_"> </span>[h]<span class="_ _ab"> </span>3<span class="_"> </span>[h]<span class="_ _ab"> </span>4<span class="_"> </span>[h]<span class="_ _ab"> </span>5<span class="_"> </span></span>[m]<span class="_ _ab"> </span><span class="ff7">6<span class="_"> </span>[h]<span class="_ _ab"> </span>7<span class="_"> </span>[h]<span class="_ _ab"> </span>8<span class="_"> </span>[h]</span></span></span></span></div><div class="t m5 x17 h32 y5965 ff11 fs21 fc2 sc0 ls0 ws0">i<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7 ls251">19<span class="_ _1b7"></span><span class="ffc ls0">[m]<span class="_ _1f9"> </span><span class="ff7">10<span class="_"> </span>[h]<span class="_ _26"> </span>11<span class="_"> </span>[h]<span class="_ _26"> </span>12<span class="_"> </span>[h]<span class="_ _26"> </span>13<span class="_"> </span></span>[m]<span class="_ _26"> </span><span class="ff7">14<span class="_"> </span>[h]<span class="_ _26"> </span>15<span class="_"> </span>[h]<span class="_ _26"> </span>16<span class="_"> </span>[h]</span></span></span></span></div><div class="t m5 x17 h32 y5966 ff11 fs21 fc2 sc0 ls0 ws0">i<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7 ls252">21<span class="_ _1b7"></span>7<span class="_ _ee"></span><span class="ffc ls0">[m]<span class="_ _26"> </span><span class="ff7">18<span class="_"> </span>[h]<span class="_ _26"> </span>19<span class="_"> </span>[h]<span class="_ _26"> </span>20<span class="_"> </span>[h]<span class="_ _26"> </span>21<span class="_"> </span></span>[m]<span class="_ _26"> </span><span class="ff7">22<span class="_"> </span>[h]<span class="_ _26"> </span>23<span class="_"> </span>[h]<span class="_ _26"> </span>24<span class="_"> </span>[h]</span></span></span></span></div><div class="t m5 x17 h32 y5967 ff11 fs21 fc2 sc0 ls0 ws0">i<span class="_ _10"> </span><span class="ff12">=<span class="_ _13"> </span><span class="ff7 ls252">32<span class="_ _1b7"></span>5<span class="_ _ee"></span><span class="ffc ls0">[m]<span class="_ _26"> </span><span class="ff7">26<span class="_"> </span>[h]<span class="_ _26"> </span>27<span class="_"> </span>[h]<span class="_ _26"> </span>28<span class="_"> </span>[h]<span class="_ _26"> </span>29<span class="_"> </span></span>[m]<span class="_ _26"> </span><span class="ff7">30<span class="_"> </span>[h]<span class="_ _26"> </span>31<span class="_"> </span>[h]<span class="_ _26"> </span>32<span class="_"> </span>[h]</span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
