<div id="pf3a9" class="pf w2 h11" data-page-no="3a9"><div class="pc pc3a9 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3a9.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">936<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>10<span class="_ _3d"> </span>System-Level<span class="_ _10"> </span>I/O</span></div><div class="t m5 x25f h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/io/cpﬁle.c</div><div class="t m5 xb h2e y280 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x244 h2d yad1 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</div><div class="t m5 xb h2e y281 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 xb h2e y282 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x244 h2d yad2 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _1f"> </span>argc,<span class="_ _1f"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 xb h2d yad3 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 xb h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>n;</span></div><div class="t m5 xb h2d yad4 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">rio_t<span class="_ _e"> </span>rio;</span></div><div class="t m5 xb h2d yad5 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>buf[MAXLINE];</span></div><div class="t m5 xb h2e yad6 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 xb h2e y61b5 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x26 h2d y496b ffd fs1e fc2 sc0 ls0 ws0">Rio_readinitb(&amp;rio,<span class="_ _e"> </span>STDIN_FILENO);</div><div class="t m5 x14 h2d y50d4 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2">while((n<span class="_ _e"> </span>=<span class="_ _1f"> </span>Rio_readlineb(&amp;rio,<span class="_ _1f"> </span>buf,<span class="_ _e"> </span>MAXLINE))<span class="_ _1f"> </span>!=<span class="_ _e"> </span>0)</span></div><div class="t m5 x14 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _70"> </span><span class="ffd fs1e fc2">Rio_writen(STDOUT_FILENO,<span class="_ _e"> </span>buf,<span class="_ _1f"> </span>n);</span></div><div class="t m5 x14 h2d y61b6 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x25f h2c y69c4 ffa fs16 fc2 sc0 ls0 ws0">code/io/cpﬁle.c</div><div class="t m5 x14 h2f y69c5 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>10.5<span class="_ _66"> </span><span class="fc1">Copying<span class="_"> </span>a<span class="_"> </span>text<span class="_"> </span>ﬁle<span class="_"> </span>from<span class="_"> </span>standard<span class="_"> </span>input<span class="_"> </span>to<span class="_"> </span>standard<span class="_"> </span>output.</span></div><div class="t m5 x1e0 h2c y77e1 ffa fs16 fc1 sc0 ls0 ws0">code/include/csapp<span class="_ _1"></span>.h</div><div class="t m5 xb h2d y77e2 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#define<span class="_ _1f"> </span>RIO_BUFSIZE<span class="_ _e"> </span>8192</span></div><div class="t m5 xb h2d y77e3 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">typedef<span class="_ _1f"> </span>struct<span class="_ _e"> </span>{</span></div><div class="t m5 xb h2d y77e4 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>rio_fd;<span class="_ _12a"> </span>/*<span class="_ _1f"> </span>Descriptor<span class="_ _e"> </span>for<span class="_ _1f"> </span>this<span class="_ _e"> </span>internal<span class="_ _1f"> </span>buf<span class="_ _1f"> </span>*/</span></div><div class="t m5 xb h2d y77e5 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>rio_cnt;<span class="_ _d4"> </span>/*<span class="_ _1f"> </span>Unread<span class="_ _1f"> </span>bytes<span class="_ _e"> </span>in<span class="_ _1f"> </span>internal<span class="_ _e"> </span>buf<span class="_ _1f"> </span>*/</span></div><div class="t m5 xb h2d y77e6 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*rio_bufptr;<span class="_ _86"> </span>/*<span class="_ _1f"> </span>Next<span class="_ _1f"> </span>unread<span class="_ _e"> </span>byte<span class="_ _1f"> </span>in<span class="_ _e"> </span>internal<span class="_ _1f"> </span>buf<span class="_ _1f"> </span>*/</span></div><div class="t m5 xb h2d y77e7 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>rio_buf[RIO_BUFSIZE];<span class="_ _1f"> </span>/*<span class="_ _1f"> </span>Internal<span class="_ _e"> </span>buffer<span class="_ _1f"> </span>*/</span></div><div class="t m5 xb h2e y77e8 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x244 h2d y77e9 ffd fs1e fc2 sc0 ls0 ws0">}<span class="_ _e"> </span>rio_t;</div><div class="t m5 x1e0 h2c y77ea ffa fs16 fc2 sc0 ls0 ws0">code/include/csapp<span class="_ _1"></span>.h</div><div class="t m5 x16b h2c y77eb ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 xb h2d y77ec ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>rio_readinitb(rio_t<span class="_ _e"> </span>*rp,<span class="_ _1f"> </span>int<span class="_ _1f"> </span>fd)</span></div><div class="t m5 xb h2d y77ed ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 xb h2e y77ee ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x26 h2d y77ef ffd fs1e fc2 sc0 ls0 ws0">rp-&gt;rio_fd<span class="_ _e"> </span>=<span class="_ _1f"> </span>fd;</div><div class="t m5 xb h2d y77f0 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">rp-&gt;rio_cnt<span class="_ _e"> </span>=<span class="_ _1f"> </span>0;</span></div><div class="t m5 xb h2d y77f1 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">rp-&gt;rio_bufptr<span class="_ _e"> </span>=<span class="_ _1f"> </span>rp-&gt;rio_buf;</span></div><div class="t m5 xb h2d y77f2 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x16b h2c y77f3 ffa fs16 fc2 sc0 ls0 ws0">code/src/csapp<span class="_ _1"></span>.c</div><div class="t m5 x14 h2f y77f4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>10.6<span class="_ _66"> </span><span class="fc1">A<span class="_"> </span>read<span class="_"> </span>buffer<span class="_"> </span>of<span class="_"> </span>type</span></div><div class="t m5 x20 h3a y77f5 ffd fs19 fc1 sc0 ls0 ws0">rio_t<span class="_ _10"> </span><span class="ffe fs16">and<span class="_"> </span>the<span class="_"> </span></span>rio_readinitb<span class="_ _11"> </span><span class="ffe fs16">function<span class="_"> </span>that<span class="_"> </span>initializes<span class="_"> </span>it.</span></div><div class="t m5 x29 h26 y77f6 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>heart<span class="_ _14"> </span>of<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ff9">Rio<span class="_ _14"> </span></span>read<span class="_ _14"> </span>routines<span class="_ _14"> </span>is<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">rio_read<span class="_ _14"> </span></span>function<span class="_ _14"> </span>shown<span class="_ _14"> </span>in<span class="_ _14"> </span>Fig-</div><div class="t m5 x1d h26 y77f7 ff7 fs19 fc1 sc0 ls0 ws0">ure<span class="_"> </span>10.7.<span class="_ _13"> </span>T<span class="_ _0"></span>he<span class="_"> </span><span class="ffd">rio_read<span class="_ _13"> </span></span>function<span class="_"> </span>is<span class="_"> </span>a<span class="_ _13"> </span>buffered<span class="_"> </span>version<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>Linux<span class="_ _13"> </span><span class="ffd">read<span class="_ _10"> </span></span>function.</div><div class="t m5 x1d h26 y77f8 ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _11"> </span><span class="ffd">rio_read<span class="_ _16"> </span></span>is<span class="_ _11"> </span>called<span class="_ _16"> </span>with<span class="_ _11"> </span>a<span class="_ _16"> </span>request<span class="_ _11"> </span>to<span class="_ _16"> </span>read<span class="_ _16"> </span><span class="ffd">n<span class="_ _11"> </span></span>bytes<span class="_ _1"></span>,<span class="_ _16"> </span>there<span class="_ _16"> </span>are<span class="_ _11"> </span><span class="ffd">rp-&gt;rio_cnt</span></div><div class="t m5 x1d h26 y77f9 ff7 fs19 fc1 sc0 ls0 ws0">unread<span class="_"> </span>bytes<span class="_"> </span>in<span class="_ _11"> </span>the<span class="_"> </span>read<span class="_"> </span>buffer.<span class="_"> </span>If<span class="_ _11"> </span>the<span class="_"> </span>buffer<span class="_"> </span>is<span class="_ _11"> </span>empty<span class="_ _3"></span>,<span class="_"> </span>then<span class="_"> </span>it<span class="_ _11"> </span>is<span class="_"> </span>replenished<span class="_"> </span>with</div><div class="t m5 x1d h26 y77fa ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _11"> </span>call<span class="_ _11"> </span>to<span class="_ _11"> </span><span class="ffd">read</span>.<span class="_ _11"> </span>Receiving<span class="_ _16"> </span>a<span class="_"> </span>short<span class="_ _16"> </span>count<span class="_"> </span>from<span class="_ _16"> </span>this<span class="_"> </span>invocation<span class="_ _16"> </span>of<span class="_"> </span><span class="ffd">read<span class="_ _11"> </span></span>is<span class="_ _16"> </span>not<span class="_"> </span>an<span class="_ _16"> </span>er<span class="_ _3"></span>-</div><div class="t m5 x1d h26 y77fb ff7 fs19 fc1 sc0 ls0 ws0">ror;<span class="_ _11"> </span>it<span class="_ _16"> </span>simply<span class="_"> </span>has<span class="_ _16"> </span>the<span class="_"> </span>effect<span class="_ _16"> </span>of<span class="_ _11"> </span>partially<span class="_ _11"> </span>ﬁlling<span class="_ _11"> </span>the<span class="_ _11"> </span>read<span class="_ _16"> </span>buffer<span class="_ _0"></span>.<span class="_ _11"> </span>Once<span class="_ _11"> </span>the<span class="_ _11"> </span>buffer<span class="_ _11"> </span>is</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
