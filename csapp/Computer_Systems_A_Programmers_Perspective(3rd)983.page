<div id="pf3d7" class="pf w2 h11" data-page-no="3d7"><div class="pc pc3d7 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3d7.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">982<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>11<span class="_ _3d"> </span>Network<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1f0 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/netp/echoclient.c</div><div class="t m5 x1f h88 yad1 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x1f h2e y626e ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x1f h2e y7cbb ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x4f h88 ye98 ffd fs4e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _f"> </span>argc,<span class="_ _e"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x1f h88 y626f ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x1f h88 y2827 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>clientfd;</span></div><div class="t m5 x1f h88 y6271 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _e2"> </span><span class="ffd fs4e fc2">char<span class="_ _e"> </span>*host,<span class="_ _e"> </span>*port,<span class="_ _f"> </span>buf[MAXLINE];</span></div><div class="t m5 x1f h88 y6272 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _e2"> </span><span class="ffd fs4e fc2">rio_t<span class="_ _e"> </span>rio;</span></div><div class="t m5 x1f h2e y59ef ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x1f h2e y7cbc ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1b7 h88 y22c1 ffd fs4e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(argc<span class="_ _f"> </span>!=<span class="_ _e"> </span>3)<span class="_ _e"> </span>{</div><div class="t m5 x1b0 h88 y59f2 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _18b"> </span><span class="ffd fs4e fc2">fprintf(stderr,<span class="_ _e"> </span>&quot;usage:<span class="_ _f"> </span>%s<span class="_ _e"> </span>&lt;host&gt;<span class="_ _e"> </span>&lt;port&gt;\n&quot;,<span class="_ _f"> </span>argv[0]);</span></div><div class="t m5 x1b0 h88 y59f3 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _18b"> </span><span class="ffd fs4e fc2">exit(0);</span></div><div class="t m5 x1b0 h88 y59f4 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1b0 h2e y59f6 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x1b7 h88 y7cbd ffd fs4e fc2 sc0 ls0 ws0">host<span class="_ _e"> </span>=<span class="_ _f"> </span>argv[1];</div><div class="t m5 x1b0 h88 y7cbe ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _e2"> </span><span class="ffd fs4e fc2">port<span class="_ _e"> </span>=<span class="_ _e"> </span>argv[2];</span></div><div class="t m5 x1b0 h2e y37bd ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x1b0 h2e y7cbf ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x1b7 h88 y7cc0 ffd fs4e fc2 sc0 ls0 ws0">clientfd<span class="_ _e"> </span>=<span class="_ _f"> </span>Open_clientfd(host,<span class="_ _e"> </span>port);</div><div class="t m5 x1b0 h88 y7cc1 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _e2"> </span><span class="ffd fs4e fc2">Rio_readinitb(&amp;rio,<span class="_ _e"> </span>clientfd);</span></div><div class="t m5 x1b0 h2e y59f9 ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x1b0 h2e y7cc2 ff6 fs20 fc6 sc0 ls0 ws0">19</div><div class="t m5 x1b7 h88 y59fa ffd fs4e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(Fgets(buf,<span class="_ _f"> </span>MAXLINE,<span class="_ _e"> </span>stdin)<span class="_ _e"> </span>!=<span class="_ _f"> </span>NULL)<span class="_ _e"> </span>{</div><div class="t m5 x1b0 h88 y4f74 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _18b"> </span><span class="ffd fs4e fc2">Rio_writen(clientfd,<span class="_ _e"> </span>buf,<span class="_ _f"> </span>strlen(buf));</span></div><div class="t m5 x1b0 h88 y7cc3 ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _18b"> </span><span class="ffd fs4e fc2">Rio_readlineb(&amp;rio,<span class="_ _e"> </span>buf,<span class="_ _f"> </span>MAXLINE);</span></div><div class="t m5 x1b0 h2e y59fe ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x25 h88 y7cc4 ffd fs4e fc2 sc0 ls0 ws0">Fputs(buf,<span class="_ _e"> </span>stdout);</div><div class="t m5 x1b0 h88 y7cc5 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1b0 h88 y7cc6 ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _e2"> </span><span class="ffd fs4e fc2">Close(clientfd);</span></div><div class="t m5 x1b0 h88 y6281 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _e2"> </span><span class="ffd fs4e fc2">exit(0);</span></div><div class="t m5 x1b0 h88 y6282 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x1f0 h2c y7cc7 ffa fs16 fc2 sc0 ls0 ws0">code/netp/echoclient.c</div><div class="t m5 x1d h2f y7cc8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>11.20<span class="_ _66"> </span><span class="fc1">Echo<span class="_"> </span>client<span class="_"> </span>main<span class="_"> </span>routine.</span></div><div class="t m5 x1d h26 y7cc9 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>main<span class="_"> </span>routine<span class="_ _13"> </span>closes<span class="_ _13"> </span>the<span class="_"> </span>connected<span class="_ _13"> </span>descriptor.<span class="_ _13"> </span>Once<span class="_"> </span>the<span class="_ _13"> </span>client<span class="_ _13"> </span>and<span class="_"> </span>server<span class="_ _13"> </span>have</div><div class="t m5 x1d h26 y7cca ff7 fs19 fc1 sc0 ls0 ws0">closed<span class="_"> </span>their<span class="_"> </span>respective<span class="_"> </span>descriptors<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>connection<span class="_"> </span>is<span class="_"> </span>terminated.</div><div class="t m5 x29 h26 y7ccb ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _11"> </span><span class="ffd ls0">clientaddr<span class="_ _10"> </span><span class="ff7">variable<span class="_"> </span>in<span class="_"> </span>line<span class="_"> </span>9<span class="_"> </span>is<span class="_"> </span>a<span class="_"> </span>socket<span class="_"> </span>address<span class="_"> </span>structure<span class="_"> </span>that<span class="_"> </span>is<span class="_"> </span>passed</span></span></div><div class="t m5 x1d h26 y7ccc ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _13"> </span><span class="ffd">accept</span>.<span class="_ _13"> </span>Before<span class="_ _13"> </span><span class="ffd">accept<span class="_ _13"> </span></span>returns<span class="_ _1"></span>,<span class="_ _13"> </span>it<span class="_ _13"> </span>ﬁlls<span class="_"> </span>in<span class="_ _13"> </span><span class="ffd">clientaddr<span class="_ _13"> </span></span>with<span class="_ _13"> </span>the<span class="_ _13"> </span>socket<span class="_ _13"> </span>address<span class="_ _13"> </span>of</div><div class="t m5 x1d h26 y7ccd ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>client<span class="_"> </span>on<span class="_ _13"> </span>the<span class="_"> </span>other<span class="_ _13"> </span>end<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>connection.<span class="_ _13"> </span>Notice<span class="_"> </span>how<span class="_ _13"> </span>we<span class="_"> </span>declare<span class="_ _13"> </span><span class="ffd">clientaddr</span></div><div class="t m5 x1d h26 y7cce ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_ _11"> </span>type<span class="_ _16"> </span><span class="ffd">struct<span class="_ _16"> </span>sockaddr_storage<span class="_ _11"> </span></span>rather<span class="_ _16"> </span>than<span class="_ _11"> </span><span class="ffd">struct<span class="_ _16"> </span>sockaddr_in</span>.<span class="_ _11"> </span>By<span class="_ _16"> </span>deﬁni-</div><div class="t m5 x1d h26 y7ccf ff7 fs19 fc1 sc0 ls0 ws0">tion,<span class="_"> </span>the<span class="_ _11"> </span><span class="ffd">sockaddr_storage<span class="_ _10"> </span></span>structure<span class="_ _11"> </span>is<span class="_"> </span>large<span class="_ _11"> </span>enough<span class="_"> </span>to<span class="_"> </span>hold<span class="_ _11"> </span>any<span class="_"> </span>type<span class="_ _11"> </span>of<span class="_"> </span>socket</div><div class="t m5 x1d h26 y7cd0 ff7 fs19 fc1 sc0 ls0 ws0">address<span class="_ _1"></span>,<span class="_"> </span>which<span class="_"> </span>keeps<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>protocol-independent.</div><div class="t m5 x29 h26 y7cd1 ff7 fs19 fc1 sc0 ls0 ws0">Notice<span class="_ _21"> </span>that<span class="_ _f"> </span>our<span class="_ _f"> </span>simple<span class="_ _f"> </span>echo<span class="_ _f"> </span>server<span class="_ _f"> </span>can<span class="_ _f"> </span>only<span class="_ _f"> </span>handle<span class="_ _f"> </span>one<span class="_ _f"> </span>client<span class="_ _f"> </span>at<span class="_ _f"> </span>a<span class="_ _21"> </span>time.</div><div class="t m5 x1d h26 y7cd2 ff7 fs19 fc1 sc0 ls0 ws0">A<span class="_ _6"> </span>server<span class="_ _13"> </span>of<span class="_ _6"> </span>this<span class="_ _13"> </span>type<span class="_ _6"> </span>that<span class="_ _13"> </span>iterates<span class="_ _6"> </span>through<span class="_ _13"> </span>clients<span class="_ _1"></span>,<span class="_ _13"> </span>one<span class="_ _6"> </span>at<span class="_ _13"> </span>a<span class="_ _6"> </span>time,<span class="_ _6"> </span>is<span class="_ _13"> </span>called<span class="_ _6"> </span>an<span class="_ _13"> </span><span class="ffa">iterative</span></div><div class="t m5 x1d h26 y7cd3 ffa fs19 fc1 sc0 ls0 ws0">server<span class="_ _2"></span><span class="ff7">.<span class="_ _16"> </span>In<span class="_ _11"> </span>Chapter<span class="_ _16"> </span>12,<span class="_ _16"> </span>we<span class="_ _16"> </span>will<span class="_ _16"> </span>learn<span class="_ _16"> </span>how<span class="_ _16"> </span>to<span class="_ _11"> </span>build<span class="_ _16"> </span>more<span class="_ _16"> </span>sophisticated<span class="_ _16"> </span></span>concurrent</div><div class="t m5 x1d h26 y7cd4 ffa fs19 fc1 sc0 ls0 ws0">servers<span class="_"> </span><span class="ff7">that<span class="_"> </span>can<span class="_"> </span>handle<span class="_"> </span>multiple<span class="_"> </span>clients<span class="_"> </span>simultaneously<span class="_ _3"></span>.</span></div><div class="t m5 x29 h26 y7cd5 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>inally<span class="_ _3"></span>,<span class="_ _14"> </span>F<span class="_ _1"></span>igure<span class="_ _16"> </span>11.22<span class="_ _16"> </span>shows<span class="_ _16"> </span>the<span class="_ _16"> </span>code<span class="_ _16"> </span>for<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffd">echo<span class="_ _16"> </span></span>routine<span class="_ _1"></span>,<span class="_ _16"> </span>which<span class="_ _16"> </span>repeatedly</div><div class="t m5 x1d h26 y7cd6 ff7 fs19 fc1 sc0 ls0 ws0">reads<span class="_"> </span>and<span class="_ _11"> </span>writes<span class="_"> </span>lines<span class="_ _11"> </span>of<span class="_"> </span>text<span class="_ _11"> </span>until<span class="_ _11"> </span>the<span class="_"> </span><span class="ffd">rio_readlineb<span class="_ _11"> </span></span>function<span class="_"> </span>encounters<span class="_ _11"> </span>EOF</div><div class="t m5 x1d h26 y7cd7 ff7 fs19 fc1 sc0 ls0 ws0">in<span class="_"> </span>line<span class="_"> </span>10.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
