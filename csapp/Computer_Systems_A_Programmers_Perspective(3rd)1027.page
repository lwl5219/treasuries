<div id="pf403" class="pf w2 h11" data-page-no="403"><div class="pc pc403 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg403.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1026<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_ _13"> </span>reaped<span class="_ _6"> </span>or<span class="_ _13"> </span>killed<span class="_ _6"> </span>by<span class="_ _13"> </span>other<span class="_ _6"> </span>threads<span class="_ _1"></span>.<span class="_ _13"> </span>Its<span class="_ _13"> </span>memory<span class="_ _6"> </span>resources<span class="_ _13"> </span>are<span class="_ _6"> </span>freed<span class="_ _13"> </span>automatically</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_"> </span>the<span class="_"> </span>system<span class="_"> </span>when<span class="_"> </span>it<span class="_"> </span>terminates<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">By<span class="_ _13"> </span>default,<span class="_ _13"> </span>threads<span class="_ _13"> </span>are<span class="_ _6"> </span>created<span class="_ _13"> </span>joinable<span class="_ _1"></span>.<span class="_ _13"> </span>In<span class="_ _13"> </span>order<span class="_ _13"> </span>to<span class="_ _6"> </span>avoid<span class="_ _13"> </span>memory<span class="_ _13"> </span>leaks<span class="_ _1"></span>,<span class="_ _13"> </span>each</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">joinable<span class="_"> </span>thread<span class="_"> </span>should<span class="_ _11"> </span>be<span class="_"> </span>either<span class="_"> </span>explicitly<span class="_ _11"> </span>reaped<span class="_"> </span>by<span class="_"> </span>another<span class="_ _11"> </span>thread<span class="_"> </span>or<span class="_"> </span>detached</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_"> </span>a<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span><span class="ffd">pthread_detach<span class="_ _10"> </span></span>function.</div><div class="t m5 x126 h2d y8059 ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;pthread.h&gt;</div><div class="t m5 x126 h2d y805a ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>pthread_detach(pthread_t<span class="_ _1f"> </span>tid);</div><div class="t m5 x6a hf1 y805b ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>0<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span>nonzero<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y805c ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _e"> </span><span class="ffd ls0">pthread_detach<span class="_ _21"> </span><span class="ff7">function<span class="_ _f"> </span>detaches<span class="_ _f"> </span>the<span class="_ _f"> </span>joinable<span class="_ _f"> </span>thread<span class="_ _f"> </span></span>tid<span class="ff7">.<span class="_ _f"> </span>T<span class="_ _1"></span>hreads<span class="_ _f"> </span>can</span></span></div><div class="t m5 x1d h26 y805d ff7 fs19 fc2 sc0 ls0 ws0">detach<span class="_ _21"> </span>themselves<span class="_ _21"> </span>by<span class="_ _f"> </span>calling<span class="_ _21"> </span><span class="ffd">pthread_detach<span class="_ _f"> </span></span>with<span class="_ _21"> </span>an<span class="_ _21"> </span>argument<span class="_ _f"> </span>of<span class="_ _21"> </span><span class="ffd">pthread_</span></div><div class="t m5 x1d h26 y805e ffd fs19 fc2 sc0 ls0 ws0">self()<span class="ff7">.</span></div><div class="t m5 x29 h26 y805f ff7 fs19 fc2 sc0 ls0 ws0">Although<span class="_ _13"> </span>some<span class="_"> </span>of<span class="_ _13"> </span>our<span class="_ _13"> </span>examples<span class="_"> </span>will<span class="_ _13"> </span>use<span class="_"> </span>joinable<span class="_ _13"> </span>threads<span class="_ _1"></span>,<span class="_ _13"> </span>there<span class="_"> </span>are<span class="_ _13"> </span>good<span class="_"> </span>rea-</div><div class="t m5 x1d h26 y8060 ff7 fs19 fc2 sc0 ls0 ws0">sons<span class="_"> </span>to<span class="_ _11"> </span>use<span class="_"> </span>detached<span class="_ _11"> </span>threads<span class="_ _11"> </span>in<span class="_"> </span>real<span class="_ _11"> </span>programs<span class="_ _1"></span>.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>example<span class="_ _1"></span>,<span class="_ _11"> </span>a<span class="_ _11"> </span>high-performance</div><div class="t m5 x1d h26 y8061 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>eb<span class="_"> </span>server<span class="_"> </span>might<span class="_"> </span>create<span class="_"> </span>a<span class="_ _13"> </span>new<span class="_"> </span>peer<span class="_"> </span>thread<span class="_"> </span>each<span class="_"> </span>time<span class="_ _13"> </span>it<span class="_"> </span>receives<span class="_"> </span>a<span class="_"> </span>connection<span class="_"> </span>re-</div><div class="t m5 x1d h26 y8062 ff7 fs19 fc2 sc0 ls0 ws0">quest<span class="_"> </span>from<span class="_"> </span>a<span class="_"> </span>W<span class="_ _1"></span>eb<span class="_"> </span>browser.<span class="_"> </span>Since<span class="_"> </span>each<span class="_"> </span>connection<span class="_"> </span>is<span class="_"> </span>handled<span class="_ _11"> </span>independently<span class="_"> </span>by<span class="_"> </span>a</div><div class="t m5 x1d h26 y8063 ff7 fs19 fc2 sc0 ls0 ws0">separate<span class="_"> </span>thread,<span class="_ _13"> </span>it<span class="_"> </span>is<span class="_"> </span>unnecessary—and<span class="_ _13"> </span>indeed<span class="_"> </span>undesirable—for<span class="_"> </span>the<span class="_ _13"> </span>server<span class="_"> </span>to<span class="_ _13"> </span>ex-</div><div class="t m5 x1d h26 y8064 ff7 fs19 fc2 sc0 ls0 ws0">plicitly<span class="_ _6"> </span>wait<span class="_ _13"> </span>for<span class="_ _6"> </span>each<span class="_ _13"> </span>peer<span class="_ _6"> </span>thread<span class="_ _13"> </span>to<span class="_ _6"> </span>terminate<span class="_ _1"></span>.<span class="_ _13"> </span>In<span class="_ _6"> </span>this<span class="_ _13"> </span>case<span class="_ _1"></span>,<span class="_ _13"> </span>each<span class="_ _6"> </span>peer<span class="_ _13"> </span>thread<span class="_ _6"> </span>should</div><div class="t m5 x1d h26 y8065 ff7 fs19 fc2 sc0 ls0 ws0">detach<span class="_"> </span>itself<span class="_"> </span>before<span class="_"> </span>it<span class="_"> </span>begins<span class="_"> </span>processing<span class="_"> </span>the<span class="_"> </span>request<span class="_"> </span>so<span class="_"> </span>that<span class="_"> </span>its<span class="_"> </span>memory<span class="_"> </span>resources</div><div class="t m5 x1d h26 y8066 ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_"> </span>be<span class="_"> </span>reclaimed<span class="_"> </span>after<span class="_"> </span>it<span class="_"> </span>terminates<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y8067 ffe fs29 fc2 sc0 ls0 ws0">12.3.7<span class="_ _48"> </span><span class="fs19">Initializing<span class="_"> </span>Threads</span></div><div class="t m5 x1d h26 y8068 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _21"> </span><span class="ffd ls0">pthread_once<span class="_ _14"> </span><span class="ff7">function<span class="_ _15"> </span>allows<span class="_ _15"> </span>you<span class="_ _14"> </span>to<span class="_ _15"> </span>initialize<span class="_ _14"> </span>the<span class="_ _15"> </span>state<span class="_ _14"> </span>associated<span class="_ _15"> </span>with<span class="_ _15"> </span>a</span></span></div><div class="t m5 x1d h26 y8069 ff7 fs19 fc2 sc0 ls0 ws0">thread<span class="_"> </span>routine<span class="_ _1"></span>.</div><div class="t m5 x126 h2d y806a ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;pthread.h&gt;</div><div class="t m5 x126 h2d y806b ffd fs1e fc2 sc0 ls0 ws0">pthread_once_t<span class="_ _e"> </span>once_control<span class="_ _1f"> </span>=<span class="_ _1f"> </span>PTHREAD_ONCE_INIT;</div><div class="t m5 x126 h2d y806c ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>pthread_once(pthread_once_t<span class="_ _1f"> </span>*once_control,</div><div class="t m5 x189 h2d y806d ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>(*init_routine)(void));</div><div class="t m5 x46 hf1 y806e ff7 fs1f fc2 sc0 ls0 ws0">Always<span class="_"> </span>returns<span class="_"> </span>0</div><div class="t m5 x1d h26 yc21 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">once_control<span class="_ _10"> </span><span class="ff7">variable<span class="_ _11"> </span>is<span class="_"> </span>a<span class="_ _11"> </span>global<span class="_ _11"> </span>or<span class="_"> </span>static<span class="_ _11"> </span>variable<span class="_ _11"> </span>that<span class="_"> </span>is<span class="_ _11"> </span>always<span class="_ _11"> </span>initialized</span></span></div><div class="t m5 x1d h26 yc22 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _16"> </span>PTHREAD_ONCE_INIT<span class="_ _3"></span>.<span class="_ _14"> </span>T<span class="_ _0"></span>he<span class="_ _16"> </span>ﬁrst<span class="_ _14"> </span>time<span class="_ _14"> </span>you<span class="_ _14"> </span>call<span class="_ _16"> </span><span class="ffd">pthread_once<span class="_ _14"> </span></span>with<span class="_ _14"> </span>an<span class="_ _14"> </span>ar<span class="_ _1"></span>-</div><div class="t m5 x1d h26 yc23 ff7 fs19 fc2 sc0 ls0 ws0">gument<span class="_ _11"> </span>of<span class="_ _16"> </span><span class="ffd">once_control</span>,<span class="_ _11"> </span>it<span class="_ _16"> </span>invokes<span class="_ _11"> </span><span class="ffd">init_routine</span>,<span class="_ _16"> </span>which<span class="_ _16"> </span>is<span class="_ _11"> </span>a<span class="_ _11"> </span>function<span class="_ _16"> </span>with<span class="_ _11"> </span>no</div><div class="t m5 x1d h26 yc24 ff7 fs19 fc2 sc0 ls0 ws0">input<span class="_ _13"> </span>arguments<span class="_"> </span>that<span class="_ _13"> </span>returns<span class="_ _13"> </span>nothing.<span class="_ _13"> </span>Subsequent<span class="_ _13"> </span>calls<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">pthread_once<span class="_ _13"> </span></span>with<span class="_"> </span>the</div><div class="t m5 x1d h26 yc25 ff7 fs19 fc2 sc0 ls0 ws0">same<span class="_ _14"> </span><span class="ffd">once_control<span class="_ _15"> </span></span>variable<span class="_ _14"> </span>do<span class="_ _14"> </span>nothing.<span class="_ _14"> </span>The<span class="_ _16"> </span><span class="ffd">pthread_once<span class="_ _15"> </span></span>function<span class="_ _14"> </span>is<span class="_ _15"> </span>useful</div><div class="t m5 x1d h26 yc26 ff7 fs19 fc2 sc0 ls0 ws0">whenever<span class="_ _16"> </span>you<span class="_ _16"> </span>need<span class="_ _11"> </span>to<span class="_ _16"> </span>dynamically<span class="_ _16"> </span>initialize<span class="_ _16"> </span>global<span class="_ _16"> </span>variables<span class="_ _16"> </span>that<span class="_ _11"> </span>are<span class="_ _16"> </span>shared<span class="_ _16"> </span>by</div><div class="t m5 x1d h26 y14b5 ff7 fs19 fc2 sc0 ls0 ws0">multiple<span class="_"> </span>threads<span class="_ _1"></span>.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>will<span class="_"> </span>look<span class="_"> </span>at<span class="_"> </span>an<span class="_"> </span>example<span class="_"> </span>in<span class="_"> </span>Section<span class="_"> </span>12.5.5.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
