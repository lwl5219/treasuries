<div id="pf2e7" class="pf w2 h11" data-page-no="2e7"><div class="pc pc2e7 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2e7.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">742<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>dynamic<span class="_ _16"> </span>linker<span class="_ _11"> </span>could<span class="_ _16"> </span>then<span class="_ _11"> </span>resolve<span class="_ _16"> </span>when<span class="_ _11"> </span>the<span class="_ _16"> </span>program<span class="_ _11"> </span>was<span class="_ _16"> </span>loaded.<span class="_ _11"> </span>However,</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">this<span class="_ _11"> </span>approach<span class="_ _16"> </span>would<span class="_ _11"> </span>not<span class="_ _16"> </span>be<span class="_ _16"> </span>PIC<span class="_ _1"></span>,<span class="_ _16"> </span>since<span class="_ _16"> </span>it<span class="_ _11"> </span>would<span class="_ _16"> </span>require<span class="_ _11"> </span>the<span class="_ _16"> </span>linker<span class="_ _11"> </span>to<span class="_ _16"> </span>modify<span class="_ _11"> </span>the</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">code<span class="_ _13"> </span>segment<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>calling<span class="_ _6"> </span>module.<span class="_ _13"> </span>GNU<span class="_ _6"> </span>compilation<span class="_ _13"> </span>systems<span class="_ _13"> </span>solve<span class="_ _13"> </span>this<span class="_ _13"> </span>problem</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">using<span class="_ _13"> </span>an<span class="_ _13"> </span>interesting<span class="_ _13"> </span>technique,<span class="_ _13"> </span>called<span class="_ _13"> </span><span class="ffa">lazy<span class="_ _13"> </span>binding<span class="_ _2"></span></span>,<span class="_"> </span>that<span class="_ _13"> </span>defers<span class="_ _13"> </span>the<span class="_ _13"> </span>binding<span class="_ _13"> </span>of<span class="_ _13"> </span>each</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">procedure<span class="_"> </span>address<span class="_"> </span>until<span class="_"> </span>the<span class="_"> </span><span class="ffa">ﬁrst<span class="_"> </span>time<span class="_"> </span></span>the<span class="_"> </span>procedure<span class="_"> </span>is<span class="_"> </span>called.</div><div class="t m5 x29 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _21"> </span>motivation<span class="_ _21"> </span>for<span class="_ _21"> </span>lazy<span class="_ _f"> </span>binding<span class="_ _21"> </span>is<span class="_ _21"> </span>that<span class="_ _21"> </span>a<span class="_ _21"> </span>typical<span class="_ _21"> </span>application<span class="_ _21"> </span>program<span class="_ _21"> </span>will</div><div class="t m5 x1d h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">call<span class="_ _f"> </span>only<span class="_ _f"> </span>a<span class="_ _f"> </span>handful<span class="_ _f"> </span>of<span class="_ _f"> </span>the<span class="_ _f"> </span>hundreds<span class="_ _f"> </span>or<span class="_ _f"> </span>thousands<span class="_ _e"> </span>of<span class="_ _21"> </span>functions<span class="_ _f"> </span>exported<span class="_ _f"> </span>by<span class="_ _f"> </span>a</div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">shared<span class="_ _13"> </span>library<span class="_ _13"> </span>such<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ffd">libc.so</span>.<span class="_ _6"> </span>By<span class="_ _13"> </span>deferring<span class="_ _13"> </span>the<span class="_ _13"> </span>resolution<span class="_ _13"> </span>of<span class="_ _13"> </span>a<span class="_ _13"> </span>function’<span class="_ _1"></span>s<span class="_ _13"> </span>address</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">until<span class="_ _14"> </span>it<span class="_ _15"> </span>is<span class="_ _15"> </span>actually<span class="_ _15"> </span>called,<span class="_ _15"> </span>the<span class="_ _15"> </span>dynamic<span class="_ _15"> </span>linker<span class="_ _15"> </span>can<span class="_ _14"> </span>avoid<span class="_ _15"> </span>hundreds<span class="_ _15"> </span>or<span class="_ _15"> </span>thousands</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _11"> </span>unnecessary<span class="_ _16"> </span>relocations<span class="_ _11"> </span>at<span class="_ _11"> </span>load<span class="_ _11"> </span>time.<span class="_ _11"> </span>T<span class="_ _1"></span>here<span class="_ _16"> </span>is<span class="_ _11"> </span>a<span class="_ _11"> </span>nontrivial<span class="_ _16"> </span>run-time<span class="_ _11"> </span>overhead</div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _14"> </span>ﬁrst<span class="_ _15"> </span>time<span class="_ _14"> </span>the<span class="_ _14"> </span>function<span class="_ _15"> </span>is<span class="_ _14"> </span>called,<span class="_ _21"> </span>but<span class="_ _14"> </span>each<span class="_ _15"> </span>call<span class="_ _14"> </span>thereafter<span class="_ _15"> </span>costs<span class="_ _14"> </span>only<span class="_ _14"> </span>a<span class="_ _15"> </span>single</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">instruction<span class="_"> </span>and<span class="_"> </span>a<span class="_"> </span>memory<span class="_"> </span>reference<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>indirection.</div><div class="t m5 x29 h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">Lazy<span class="_"> </span>binding<span class="_"> </span>is<span class="_"> </span>implemented<span class="_"> </span>with<span class="_ _13"> </span>a<span class="_"> </span>compact<span class="_"> </span>yet<span class="_"> </span>somewhat<span class="_"> </span>complex<span class="_"> </span>interac-</div><div class="t m5 x1d h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">tion<span class="_ _13"> </span>between<span class="_ _6"> </span>two<span class="_ _13"> </span>data<span class="_ _13"> </span>structures:<span class="_ _13"> </span>the<span class="_ _6"> </span>GOT<span class="_ _13"> </span>and<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffa">procedure<span class="_ _13"> </span>linkage<span class="_ _13"> </span>table<span class="_ _13"> </span>(PL<span class="_ _7"></span>T)<span class="_ _1"></span><span class="ff7">.</span></span></div><div class="t m5 x1d h26 y450 ff7 fs19 fc2 sc0 ls0 ws0">If<span class="_"> </span>an<span class="_ _13"> </span>object<span class="_"> </span>module<span class="_"> </span>calls<span class="_ _13"> </span>any<span class="_"> </span>functions<span class="_"> </span>that<span class="_ _13"> </span>are<span class="_"> </span>deﬁned<span class="_"> </span>in<span class="_ _13"> </span>shared<span class="_"> </span>libraries<span class="_ _1"></span>,<span class="_"> </span>then<span class="_ _13"> </span>it</div><div class="t m5 x1d h26 y451 ff7 fs19 fc2 sc0 ls0 ws0">has<span class="_"> </span>its<span class="_"> </span>own<span class="_"> </span>GO<span class="_ _1"></span>T<span class="_"> </span>and<span class="_"> </span>PL<span class="_ _3"></span>T<span class="_ _3"></span>.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>GOT<span class="_ _13"> </span>is<span class="_"> </span>part<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>data<span class="_"> </span>segment.<span class="_"> </span>T<span class="_ _3"></span>he<span class="_"> </span>PL<span class="_ _3"></span>T<span class="_"> </span>is<span class="_"> </span>part</div><div class="t m5 x1d h26 y452 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>segment.</div><div class="t m5 x29 h26 y453 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _13"> </span>7.19<span class="_ _6"> </span>shows<span class="_ _13"> </span>how<span class="_ _6"> </span>the<span class="_ _13"> </span>PL<span class="_ _7"></span>T<span class="_ _13"> </span>and<span class="_ _6"> </span>GOT<span class="_ _13"> </span>work<span class="_ _6"> </span>together<span class="_ _13"> </span>to<span class="_ _6"> </span>resolve<span class="_ _13"> </span>the<span class="_ _6"> </span>address</div><div class="t m5 x1d h26 y454 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>a<span class="_"> </span>function<span class="_"> </span>at<span class="_"> </span>run<span class="_"> </span>time<span class="_ _1"></span>.<span class="_"> </span>First,<span class="_"> </span>let’<span class="_ _1"></span>s<span class="_"> </span>examine<span class="_"> </span>the<span class="_"> </span>contents<span class="_"> </span>of<span class="_"> </span>each<span class="_"> </span>of<span class="_"> </span>these<span class="_"> </span>tables<span class="_ _0"></span>.</div><div class="t m5 x75 h26 y6207 ffa fs19 fc2 sc0 ls0 ws0">Procedure<span class="_ _14"> </span>linkage<span class="_ _15"> </span>table<span class="_ _14"> </span>(PL<span class="_ _3"></span>T).<span class="_ _21"> </span><span class="ff7">T<span class="_ _0"></span>he<span class="_ _14"> </span>PL<span class="_ _3"></span>T<span class="_ _14"> </span>is<span class="_ _15"> </span>an<span class="_ _14"> </span>array<span class="_ _15"> </span>of<span class="_ _14"> </span>16-byte<span class="_ _15"> </span>code<span class="_ _14"> </span>entries<span class="_ _1"></span>.</span></div><div class="t m5 xcd h26 y6208 ffd fs19 fc2 sc0 ls0 ws0">PLT[0]<span class="_ _13"> </span><span class="ff7">is<span class="_"> </span>a<span class="_ _13"> </span>special<span class="_"> </span>entry<span class="_ _13"> </span>that<span class="_ _13"> </span>jumps<span class="_"> </span>into<span class="_ _13"> </span>the<span class="_"> </span>dynamic<span class="_ _13"> </span>linker.<span class="_ _13"> </span>Each<span class="_ _13"> </span>shared</span></div><div class="t m5 xcd h26 y6209 ff7 fs19 fc2 sc0 ls0 ws0">library<span class="_ _11"> </span>function<span class="_ _11"> </span>called<span class="_ _11"> </span>by<span class="_ _11"> </span>the<span class="_ _11"> </span>executable<span class="_ _11"> </span>has<span class="_ _11"> </span>its<span class="_ _11"> </span>own<span class="_ _11"> </span>PL<span class="_ _3"></span>T<span class="_ _11"> </span>entry<span class="_ _3"></span>.<span class="_ _11"> </span>Each<span class="_ _11"> </span>of</div><div class="t m5 x15b h4c y620a ff8e fs2d fc1 sc0 ls0 ws0">Global offset table (GOT) </div><div class="t m5 x15b h4c y620b ff80 fs2d fc1 sc0 ls0 ws0">Data segment </div><div class="t m5 x2f hcb y620c ff8d fs7f fc1 sc0 ls0 ws0">GOT[0]: </div><div class="t m5 x2f hcb y620d ff8d fs7f fc1 sc0 ls0 ws0">GOT[1]: </div><div class="t m5 x2f hcb y620e ff8d fs7f fc1 sc0 ls0 ws0">GOT[2]: </div><div class="t m5 x2f hcb y620f ff8d fs7f fc1 sc0 ls0 ws0">GOT[3]: 0x4005b6</div><div class="t m5 x2f hcb y6210 ff8d fs7f fc1 sc0 ls0 ws0">GOT[4]: 0x4005c6</div><div class="t m5 x2f hcb y6211 ff8d fs7f fc1 sc0 ls0 ws0">GOT[5]: 0x4005d6</div><div class="t m11 xd0 hf3 y6212 ff8d fs97 fc1 sc0 ls0 ws0">addr of .dynamic</div><div class="t m11 xd0 hf3 y6213 ff8d fs97 fc1 sc0 ls0 ws0">addr of reloc entries</div><div class="t m11 xd0 hf3 y6214 ff8d fs97 fc1 sc0 ls0 ws0">addr of dynamic linker</div><div class="t m11 xa3 hf3 y6215 ff8d fs97 fc1 sc0 ls0 ws0"># sys startup</div><div class="t m11 xa3 hf3 y6216 ff8d fs97 fc1 sc0 ls0 ws0"># addvec()</div><div class="t m11 xa3 hf3 y6217 ff8d fs97 fc1 sc0 ls0 ws0"># printf()  </div><div class="t m11 x1c9 hf3 y6218 ff8d fs97 fc1 sc0 ls0 ws0">addr of .dynamic</div><div class="t m11 x1c9 hf3 y6219 ff8d fs97 fc1 sc0 ls0 ws0">addr of reloc entries</div><div class="t m11 x1c9 hf3 y621a ff8d fs97 fc1 sc0 ls0 ws0">addr of dynamic linker</div><div class="t m11 xde hf3 y621b ff8d fs97 fc1 sc0 ls0 ws0"># sys startup</div><div class="t m11 xf5 hf3 y621c ff8d fs97 fc1 sc0 ls0 ws0">&amp;addvec()</div><div class="c x14 y621d w25 hf4"><div class="t m11 x206 hf3 y621e ff8d fs97 fc3 sc1 ls0 ws0">&amp;addvec()</div></div><div class="t m11 xde hf3 y621f ff8d fs97 fc1 sc0 ls0 ws0"># printf()  </div><div class="t m5 xce hf5 y6220 ff8d fs2d fc1 sc0 ls0 ws0"> </div><div class="t m5 x15b h4c y6221 ff8e fs2d fc1 sc0 ls0 ws0">Procedure linkage table (PLT) </div><div class="t m5 x15b h4c y6222 ff80 fs2d fc1 sc0 ls0 ws0">Code segment</div><div class="t m5 x15b hcb y6223 ff8d fs7f fc1 sc0 ls0 ws0">  callq 0x4005c0</div><div class="t m11 x127 hf3 y6224 ff8d fs97 fc1 sc0 ls0 ws0"># call addvec()</div><div class="t mf x91 hdd y6224 ff80 fs8d fc1 sc0 ls0 ws0"> </div><div class="t m11 x2f hf3 y6225 ff8d fs97 fc1 sc0 ls0 ws0"># PLT[0]: call dynamic linker</div><div class="t m5 x2f hcb y6226 ff8d fs7f fc1 sc0 ls0 ws0">4005a0: pushq *GOT[1]</div><div class="t m5 x2f hcb y6227 ff8d fs7f fc1 sc0 ls0 ws0">4005a6: jmpq  *GOT[2]</div><div class="t m5 x2f hf6 y6228 ff90 fs7f fc1 sc0 ls0 ws0">…<span class="ff8d">  </span></div><div class="t m11 x20b hf3 y6229 ff8d fs97 fc1 sc0 ls0 ws0"># PLT[2]: call addvec()</div><div class="t m5 x2f hcb y622a ff8d fs7f fc1 sc0 ls0 ws0">4005c0: jmpq  *GOT[4]</div><div class="t m5 x2f hcb y622b ff8d fs7f fc1 sc0 ls0 ws0">4005c6: pushq $0x1</div><div class="t m5 x2f hcb y622c ff8d fs7f fc1 sc0 ls0 ws0">4005cb: jmpq  4005a0  </div><div class="t m5 xce hf5 y622d ff8d fs2d fc1 sc0 ls0 ws0"> </div><div class="t m5 x187 h4c y622e ff8e fs2d fc1 sc0 ls0 ws0">Procedure linkage table (PLT) </div><div class="t m5 x187 h4c y622f ff80 fs2d fc1 sc0 ls0 ws0">Code segment</div><div class="t m5 x187 hcb y6223 ff8d fs7f fc1 sc0 ls0 ws0">  callq 0x4005c0</div><div class="t m11 x12f hf3 y6224 ff8d fs97 fc1 sc0 ls0 ws0"># call addvec()</div><div class="t mf x159 hdd y6224 ff80 fs8d fc1 sc0 ls0 ws0"> </div><div class="t m11 x138 hf3 y6225 ff8d fs97 fc1 sc0 ls0 ws0"># PLT[0]: call dynamic linker</div><div class="t m5 x138 hcb y6226 ff8d fs7f fc1 sc0 ls0 ws0">4005a0: pushq *GOT[1]</div><div class="t m5 x138 hcb y6227 ff8d fs7f fc1 sc0 ls0 ws0">4005a6: jmpq  *GOT[2]</div><div class="t m5 x138 hf6 y6228 ff90 fs7f fc1 sc0 ls0 ws0">…<span class="ff8d">  </span></div><div class="t m11 x101 hf3 y6229 ff8d fs97 fc1 sc0 ls0 ws0"># PLT[2]: call addvec()</div><div class="t m5 x138 hcb y622a ff8d fs7f fc1 sc0 ls0 ws0">4005c0: jmpq  *GOT[4]</div><div class="t m5 x138 hcb y622b ff8d fs7f fc1 sc0 ls0 ws0">4005c6: pushq $0x1</div><div class="t m5 x138 hcb y622c ff8d fs7f fc1 sc0 ls0 ws0">4005cb: jmpq  4005a0  </div><div class="t m5 x1f8 hf5 y622d ff8d fs2d fc1 sc0 ls0 ws0"> </div><div class="t m5 x187 h4c y6230 ff8e fs2d fc1 sc0 ls0 ws0">Global offset table (GOT) </div><div class="t m5 x187 h4c y6231 ff80 fs2d fc1 sc0 ls0 ws0">Data segment </div><div class="t m5 x138 hcb y620c ff8d fs7f fc1 sc0 ls0 ws0">GOT[0]: </div><div class="t m5 x138 hcb y620d ff8d fs7f fc1 sc0 ls0 ws0">GOT[1]: </div><div class="t m5 x138 hcb y620e ff8d fs7f fc1 sc0 ls0 ws0">GOT[2]: </div><div class="t m5 x138 hcb y620f ff8d fs7f fc1 sc0 ls0 ws0">GOT[3]: 0x4005b6  </div><div class="t m5 x138 hcb y6210 ff8d fs7f fc1 sc0 ls0 ws0">GOT[4]: </div><div class="c x14 y621d w25 hf4"><div class="t m5 x8f hcb y6232 ff8d fs7f fc3 sc1 ls0 ws0">GOT[4]: </div></div><div class="t m5 x138 hcb y6233 ff8d fs7f fc1 sc0 ls0 ws0">GOT[5]: 0x4005d6  </div><div class="t m5 x1f8 hf5 y6220 ff8d fs2d fc1 sc0 ls0 ws0"> </div><div class="t m5 x1f8 hf5 y6234 ff8d fs2d fc1 sc0 ls0 ws0"> </div><div class="t m5 xc8 hf7 y6235 ff8e fs98 fc1 sc0 ls0 ws0">1</div><div class="t m5 x69 hf7 y6236 ff8e fs98 fc1 sc0 ls0 ws0">1</div><div class="t m5 xcb hf7 y6237 ff8e fs98 fc1 sc0 ls0 ws0">2</div><div class="t m5 x190 hf7 y6238 ff8e fs98 fc1 sc0 ls0 ws0">2</div><div class="t m5 xec hf7 y6239 ff8e fs98 fc1 sc0 ls0 ws0">4</div><div class="t m5 x265 hf7 y623a ff8e fs98 fc1 sc0 ls0 ws0">3</div><div class="t m5 xee hcb y623b ff8e fs2d fc1 sc0 ls21b wsb">(a) First invocation of <span class="ff8d fs7f ls0 ws0">addvec<span class="_ _bc"> </span></span>(b) Subsequent invocations of <span class="ff8d fs7f ls0 ws0">addvec</span></div><div class="t m5 x14 h34 y623c ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>7.19<span class="_ _66"> </span><span class="fc1">Using<span class="_"> </span>the<span class="_"> </span>PL<span class="_ _1"></span>T<span class="_"> </span>and<span class="_"> </span>GOT<span class="_"> </span>to<span class="_"> </span>call<span class="_ _10"> </span>external<span class="_"> </span>functions.<span class="_ _10"> </span><span class="ff6">The<span class="_ _10"> </span>dynamic<span class="_ _10"> </span>linker<span class="_ _10"> </span>resolves<span class="_ _10"> </span>the<span class="_ _10"> </span>address<span class="_ _10"> </span>of</span></span></div><div class="t m5 x14 h3a y623d ffd fs19 fc1 sc0 ls0 ws0">addvec<span class="_ _10"> </span><span class="ff6 fs16">the<span class="_ _11"> </span>ﬁrst<span class="_ _10"> </span>time<span class="_ _10"> </span>it<span class="_ _11"> </span>is<span class="_ _10"> </span>called.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
