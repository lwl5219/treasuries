<div id="pf1d2" class="pf w2 h11" data-page-no="1d2"><div class="pc pc1d2 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1d2.png"/><div class="t m5 x13d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>4.5<span class="_ _60"> </span>Pipelined<span class="_ _10"> </span>Y86-64<span class="_ _10"> </span>Implementations<span class="_ _3e"> </span><span class="ffe fs1e">465</span></div><div class="t m5 x34 h2a y548 fff fs1c fc2 sc0 ls0 ws0">Aside<span class="_ _1b"> </span><span class="ff6 fs19">Return<span class="_ _11"> </span>address<span class="_ _11"> </span>prediction<span class="_ _11"> </span>with<span class="_ _16"> </span>a<span class="_ _11"> </span>stack</span></div><div class="t m5 x34 h2b y2d0 ff7 fs1e fc2 sc0 ls0 ws0">W<span class="_ _1"></span>ith<span class="_"> </span>most<span class="_ _13"> </span>programs<span class="_ _1"></span>,<span class="_"> </span>it<span class="_ _13"> </span>is<span class="_ _13"> </span>very<span class="_"> </span>easy<span class="_ _13"> </span>to<span class="_ _13"> </span>predict<span class="_ _13"> </span>return<span class="_ _13"> </span>addresses<span class="_ _1"></span>,<span class="_"> </span>since<span class="_ _13"> </span>procedure<span class="_"> </span>calls<span class="_ _13"> </span>and<span class="_ _13"> </span>returns<span class="_ _13"> </span>occur</div><div class="t m5 x34 h2b y2d1 ff7 fs1e fc2 sc0 ls0 ws0">in<span class="_"> </span>matched<span class="_ _13"> </span>pairs<span class="_ _1"></span>.<span class="_"> </span>Most<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>time<span class="_"> </span>that<span class="_ _13"> </span>a<span class="_"> </span>procedure<span class="_"> </span>is<span class="_ _13"> </span>called,<span class="_"> </span>it<span class="_ _13"> </span>returns<span class="_"> </span>to<span class="_"> </span>the<span class="_ _13"> </span>instruction<span class="_"> </span>following<span class="_"> </span>the</div><div class="t m5 x34 h2b y2d2 ff7 fs1e fc2 sc0 ls0 ws0">call.<span class="_ _11"> </span>T<span class="_ _0"></span>his<span class="_ _11"> </span>property<span class="_ _11"> </span>is<span class="_ _16"> </span>exploited<span class="_ _11"> </span>in<span class="_ _11"> </span>high-performance<span class="_ _11"> </span>processors<span class="_ _11"> </span>by<span class="_ _16"> </span>including<span class="_ _11"> </span>a<span class="_ _11"> </span>hardware<span class="_ _11"> </span>stack<span class="_ _16"> </span>within</div><div class="t m5 x34 h2b y2d3 ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_"> </span>instruction<span class="_ _13"> </span>fetch<span class="_ _13"> </span>unit<span class="_"> </span>that<span class="_ _13"> </span>holds<span class="_"> </span>the<span class="_ _13"> </span>return<span class="_"> </span>address<span class="_ _13"> </span>generated<span class="_"> </span>by<span class="_ _13"> </span>procedure<span class="_ _13"> </span>call<span class="_"> </span>instructions<span class="_ _1"></span>.<span class="_"> </span>Every</div><div class="t m5 x34 h2b y2d4 ff7 fs1e fc2 sc0 ls0 ws0">time<span class="_ _13"> </span>a<span class="_ _13"> </span>procedure<span class="_ _13"> </span>call<span class="_ _6"> </span>instruction<span class="_"> </span>is<span class="_ _6"> </span>executed,<span class="_"> </span>its<span class="_ _6"> </span>return<span class="_"> </span>address<span class="_ _6"> </span>is<span class="_"> </span>pushed<span class="_ _6"> </span>onto<span class="_"> </span>the<span class="_ _6"> </span>stack.<span class="_ _13"> </span>When<span class="_ _13"> </span>a<span class="_ _13"> </span>return</div><div class="t m5 x34 h2b y2d5 ff7 fs1e fc2 sc0 ls0 ws0">instruction<span class="_ _13"> </span>is<span class="_"> </span>fetched,<span class="_ _13"> </span>the<span class="_ _13"> </span>top<span class="_"> </span>value<span class="_ _13"> </span>is<span class="_ _13"> </span>popped<span class="_"> </span>from<span class="_ _13"> </span>this<span class="_ _13"> </span>stack<span class="_"> </span>and<span class="_ _13"> </span>used<span class="_ _13"> </span>as<span class="_ _13"> </span>the<span class="_"> </span>predicted<span class="_ _13"> </span>return<span class="_ _13"> </span>address<span class="_ _1"></span>.</div><div class="t m5 x34 h2b y2d6 ff7 fs1e fc2 sc0 ls0 ws0">Like<span class="_"> </span>branch<span class="_"> </span>prediction,<span class="_"> </span>a<span class="_"> </span>mechanism<span class="_"> </span>must<span class="_"> </span>be<span class="_ _10"> </span>provided<span class="_"> </span>to<span class="_ _10"> </span>recover<span class="_"> </span>when<span class="_ _10"> </span>the<span class="_"> </span>prediction<span class="_ _10"> </span>was<span class="_"> </span>incorrect,</div><div class="t m5 x34 h2b y549 ff7 fs1e fc2 sc0 ls0 ws0">since<span class="_"> </span>there<span class="_"> </span>are<span class="_"> </span>times<span class="_ _13"> </span>when<span class="_"> </span>calls<span class="_"> </span>and<span class="_"> </span>returns<span class="_"> </span>do<span class="_ _13"> </span>not<span class="_"> </span>match.<span class="_"> </span>In<span class="_"> </span>general,<span class="_"> </span>the<span class="_ _13"> </span>prediction<span class="_"> </span>is<span class="_"> </span>highly<span class="_"> </span>reliable<span class="_ _1"></span>.</div><div class="t m5 x34 h2b y54a ff7 fs1e fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_"> </span>hardware<span class="_"> </span>stack<span class="_"> </span>is<span class="_"> </span>not<span class="_"> </span>part<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>programmer<span class="_ _0"></span>-visible<span class="_"> </span>state<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y406e ff7 fs19 fc2 sc0 ls0 ws0">results<span class="_ _1"></span>,<span class="_"> </span>since<span class="_ _11"> </span>the<span class="_ _11"> </span>return<span class="_"> </span>address<span class="_ _11"> </span>will<span class="_ _11"> </span>be<span class="_"> </span>whatever<span class="_ _11"> </span>word<span class="_ _11"> </span>is<span class="_"> </span>on<span class="_ _11"> </span>the<span class="_ _11"> </span>top<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>stack.</div><div class="t m5 x17 h26 y406f ff7 fs19 fc2 sc0 ls0 ws0">In<span class="_ _14"> </span>our<span class="_ _14"> </span>design,<span class="_ _21"> </span>we<span class="_ _14"> </span>will<span class="_ _15"> </span>not<span class="_ _14"> </span>attempt<span class="_ _14"> </span>to<span class="_ _15"> </span>predict<span class="_ _14"> </span>any<span class="_ _14"> </span>value<span class="_ _15"> </span>for<span class="_ _14"> </span>the<span class="_ _15"> </span>return<span class="_ _14"> </span>address<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y4070 ff7 fs19 fc2 sc0 ls0 ws0">Instead,<span class="_ _14"> </span>we<span class="_ _14"> </span>will<span class="_ _14"> </span>simply<span class="_ _14"> </span>hold<span class="_ _14"> </span>off<span class="_ _14"> </span>processing<span class="_ _14"> </span>any<span class="_ _14"> </span>more<span class="_ _14"> </span>instructions<span class="_ _14"> </span>until<span class="_ _14"> </span>the<span class="_ _16"> </span><span class="ffd">ret</span></div><div class="t m5 x17 h26 y4071 ff7 fs19 fc2 sc0 ls0 ws0">instruction<span class="_"> </span>passes<span class="_"> </span>through<span class="_"> </span>the<span class="_"> </span>write-back<span class="_ _11"> </span>stage<span class="_ _1"></span>.<span class="_ _11"> </span>W<span class="_ _3"></span>e<span class="_"> </span>will<span class="_"> </span>return<span class="_ _11"> </span>to<span class="_"> </span>this<span class="_"> </span>part<span class="_"> </span>of<span class="_"> </span>the</div><div class="t m5 x17 h26 y4072 ff7 fs19 fc2 sc0 ls0 ws0">implementation<span class="_"> </span>in<span class="_"> </span>Section<span class="_"> </span>4.5.8.</div><div class="t m5 x26 h46 y4073 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>PIPE<span class="ff12">−<span class="_ _10"> </span></span>fetch<span class="_ _11"> </span>stage<span class="_ _1"></span>,<span class="_ _11"> </span>diagrammed<span class="_"> </span>at<span class="_ _11"> </span>the<span class="_"> </span>bottom<span class="_ _11"> </span>of<span class="_"> </span>Figure<span class="_"> </span>4.41,<span class="_"> </span>is<span class="_"> </span>respon-</div><div class="t m5 x17 h26 y4074 ff7 fs19 fc2 sc0 ls0 ws0">sible<span class="_"> </span>for<span class="_"> </span>both<span class="_ _11"> </span>predicting<span class="_"> </span>the<span class="_"> </span>next<span class="_ _11"> </span>value<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>PC<span class="_"> </span>and<span class="_ _11"> </span>selecting<span class="_"> </span>the<span class="_"> </span>actual<span class="_ _11"> </span>PC<span class="_"> </span>for</div><div class="t m5 x17 h26 y4075 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>instruction<span class="_ _13"> </span>fetch.<span class="_ _13"> </span>W<span class="_ _3"></span>e<span class="_ _13"> </span>can<span class="_ _13"> </span>see<span class="_ _13"> </span>the<span class="_ _13"> </span>block<span class="_ _13"> </span>labeled<span class="_ _13"> </span>“Predict<span class="_ _13"> </span>PC”<span class="_ _13"> </span>can<span class="_ _13"> </span>choose<span class="_ _6"> </span>either</div><div class="t m5 x17 h26 y4076 ff6 fs19 fc2 sc0 ls0 ws0">valP<span class="_ _13"> </span><span class="ff7">(as<span class="_"> </span>computed<span class="_"> </span>by<span class="_ _13"> </span>the<span class="_"> </span>PC<span class="_ _13"> </span>incrementer)<span class="_"> </span>or<span class="_ _13"> </span></span>valC<span class="_ _10"> </span><span class="ff7">(from<span class="_ _13"> </span>the<span class="_"> </span>fetched<span class="_ _13"> </span>instruction).</span></div><div class="t m5 x17 h26 y4077 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _16"> </span>value<span class="_ _16"> </span>is<span class="_ _16"> </span>stored<span class="_ _16"> </span>in<span class="_ _16"> </span>pipeline<span class="_ _16"> </span>register<span class="_ _16"> </span>F<span class="_ _14"> </span>as<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ffa">predicted<span class="_ _16"> </span></span>value<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>program</div><div class="t m5 x17 h26 y4078 ff7 fs19 fc2 sc0 ls0 ws0">counter.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_"> </span>block<span class="_ _13"> </span>labeled<span class="_ _13"> </span>“Select<span class="_"> </span>PC”<span class="_ _13"> </span>is<span class="_ _13"> </span>similar<span class="_"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>block<span class="_"> </span>labeled<span class="_ _13"> </span>“PC”<span class="_ _13"> </span>in<span class="_"> </span>the</div><div class="t m5 x17 h26 y4079 ff7 fs19 fc2 sc0 ls0 ws0">SEQ+<span class="_"> </span>PC<span class="_"> </span>selection<span class="_"> </span>stage<span class="_"> </span>(F<span class="_ _1"></span>igure<span class="_"> </span>4.40).<span class="_"> </span>It<span class="_"> </span>chooses<span class="_"> </span>one<span class="_"> </span>of<span class="_"> </span>three<span class="_"> </span>values<span class="_"> </span>to<span class="_"> </span>serve<span class="_"> </span>as</div><div class="t m5 x17 h26 y407a ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>address<span class="_ _16"> </span>for<span class="_ _16"> </span>the<span class="_ _14"> </span>instruction<span class="_ _16"> </span>memory:<span class="_ _16"> </span>the<span class="_ _14"> </span>predicted<span class="_ _16"> </span>PC,<span class="_ _16"> </span>the<span class="_ _16"> </span>value<span class="_ _16"> </span>of<span class="_ _14"> </span><span class="ff6">valP<span class="_ _16"> </span></span>for</div><div class="t m5 x17 h26 y407b ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_ _16"> </span>not-taken<span class="_ _11"> </span>branch<span class="_ _16"> </span>instruction<span class="_ _16"> </span>that<span class="_ _11"> </span>reaches<span class="_ _16"> </span>pipeline<span class="_ _16"> </span>register<span class="_ _16"> </span>M<span class="_ _11"> </span>(stored<span class="_ _16"> </span>in<span class="_ _16"> </span>regis-</div><div class="t m5 x17 h26 y407c ff7 fs19 fc2 sc0 ls0 ws0">ter<span class="_ _16"> </span><span class="ff6">M_valA</span>),<span class="_ _15"> </span>or<span class="_ _16"> </span>the<span class="_ _14"> </span>value<span class="_ _14"> </span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>return<span class="_ _16"> </span>address<span class="_ _14"> </span>when<span class="_ _14"> </span>a<span class="_ _16"> </span><span class="ffd">ret<span class="_ _14"> </span></span>instruction<span class="_ _14"> </span>reaches</div><div class="t m5 x17 h26 y407d ff7 fs19 fc2 sc0 ls0 ws0">pipeline<span class="_"> </span>register<span class="_"> </span>W<span class="_"> </span>(stored<span class="_"> </span>in<span class="_"> </span><span class="ff6">W_valM</span>).</div><div class="t m5 x17 h41 y322d ffe fs29 fc2 sc0 ls0 ws0">4.5.5<span class="_ _48"> </span><span class="fs19">Pipeline<span class="_"> </span>Hazards</span></div><div class="t m5 x17 h46 y2455 ff7 fs19 fc2 sc0 ls0 ws0">Our<span class="_ _14"> </span>structure<span class="_ _15"> </span>PIPE<span class="ff12">−<span class="_ _14"> </span></span>is<span class="_ _15"> </span>a<span class="_ _15"> </span>good<span class="_ _14"> </span>start<span class="_ _15"> </span>at<span class="_ _14"> </span>creating<span class="_ _15"> </span>a<span class="_ _14"> </span>pipelined<span class="_ _15"> </span>Y86-64<span class="_ _15"> </span>processor.</div><div class="t m5 x17 h26 y2456 ff7 fs19 fc2 sc0 ls0 ws0">Recall<span class="_"> </span>from<span class="_ _11"> </span>our<span class="_ _11"> </span>discussion<span class="_"> </span>in<span class="_ _11"> </span>Section<span class="_ _11"> </span>4.4.4,<span class="_ _11"> </span>however,<span class="_"> </span>that<span class="_ _11"> </span>introducing<span class="_"> </span>pipelining</div><div class="t m5 x17 h26 y2457 ff7 fs19 fc2 sc0 ls0 ws0">into<span class="_ _16"> </span>a<span class="_ _11"> </span>system<span class="_ _16"> </span>with<span class="_ _16"> </span>feedback<span class="_ _11"> </span>can<span class="_ _16"> </span>lead<span class="_ _11"> </span>to<span class="_ _16"> </span>problems<span class="_ _16"> </span>when<span class="_ _11"> </span>there<span class="_ _16"> </span>are<span class="_ _16"> </span>dependencies</div><div class="t m5 x17 h26 y2458 ff7 fs19 fc2 sc0 ls0 ws0">between<span class="_ _16"> </span>successive<span class="_ _16"> </span>instructions<span class="_ _1"></span>.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>must<span class="_ _16"> </span>resolve<span class="_ _16"> </span>this<span class="_ _16"> </span>issue<span class="_ _16"> </span>before<span class="_ _16"> </span>we<span class="_ _16"> </span>can<span class="_ _16"> </span>com-</div><div class="t m5 x17 h26 y2459 ff7 fs19 fc2 sc0 ls0 ws0">plete<span class="_"> </span>our<span class="_"> </span>design.<span class="_"> </span>T<span class="_ _1"></span>hese<span class="_"> </span>dependencies<span class="_"> </span>can<span class="_"> </span>take<span class="_"> </span>two<span class="_"> </span>forms:<span class="_ _13"> </span>(1)<span class="_"> </span><span class="ffa">data<span class="_"> </span></span>dependencies<span class="_ _1"></span>,</div><div class="t m5 x17 h26 y4fe ff7 fs19 fc2 sc0 ls0 ws0">where<span class="_"> </span>the<span class="_ _11"> </span>results<span class="_ _11"> </span>computed<span class="_ _11"> </span>by<span class="_ _11"> </span>one<span class="_ _11"> </span>instruction<span class="_ _11"> </span>are<span class="_ _11"> </span>used<span class="_ _11"> </span>as<span class="_ _11"> </span>the<span class="_ _11"> </span>data<span class="_ _11"> </span>for<span class="_ _11"> </span>a<span class="_ _11"> </span>follow-</div><div class="t m5 x17 h26 y4ff ff7 fs19 fc2 sc0 ls0 ws0">ing<span class="_ _11"> </span>instruction,<span class="_ _16"> </span>and<span class="_ _16"> </span>(2)<span class="_ _11"> </span><span class="ffa">control<span class="_ _14"> </span></span>dependencies<span class="_ _1"></span>,<span class="_ _16"> </span>where<span class="_ _11"> </span>one<span class="_ _16"> </span>instruction<span class="_ _16"> </span>determines</div><div class="t m5 x17 h26 y500 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>location<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>following<span class="_ _16"> </span>instruction,<span class="_ _11"> </span>such<span class="_ _11"> </span>as<span class="_ _11"> </span>when<span class="_ _11"> </span>executing<span class="_ _16"> </span>a<span class="_"> </span>jump,<span class="_"> </span>call,<span class="_ _16"> </span>or</div><div class="t m5 x17 h26 y501 ff7 fs19 fc2 sc0 ls0 ws0">return.<span class="_ _11"> </span>When<span class="_ _11"> </span>such<span class="_ _11"> </span>dependencies<span class="_ _16"> </span>have<span class="_ _11"> </span>the<span class="_ _11"> </span>potential<span class="_ _11"> </span>to<span class="_ _16"> </span>cause<span class="_ _11"> </span>an<span class="_ _11"> </span>erroneous<span class="_ _16"> </span>com-</div><div class="t m5 x17 h26 y502 ff7 fs19 fc2 sc0 ls0 ws0">putation<span class="_"> </span>by<span class="_ _13"> </span>the<span class="_"> </span>pipeline<span class="_ _0"></span>,<span class="_"> </span>they<span class="_ _13"> </span>are<span class="_"> </span>called<span class="_"> </span><span class="ffa">hazar<span class="_ _0"></span>ds<span class="ff7">.<span class="_"> </span>Like<span class="_ _13"> </span>dependencies<span class="_ _0"></span>,<span class="_"> </span>hazards<span class="_ _13"> </span>can</span></span></div><div class="t m5 x17 h26 y503 ff7 fs19 fc2 sc0 ls0 ws0">be<span class="_"> </span>classiﬁed<span class="_"> </span>as<span class="_"> </span>either<span class="_"> </span><span class="ffa">data<span class="_"> </span>hazar<span class="_ _0"></span>ds<span class="_"> </span><span class="ff7">or<span class="_"> </span></span>control<span class="_"> </span>hazards<span class="ff7">.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>ﬁrst<span class="_"> </span>concern<span class="_"> </span>ourselves</span></span></div><div class="t m5 x17 h26 y504 ff7 fs19 fc2 sc0 ls0 ws0">with<span class="_"> </span>data<span class="_"> </span>hazards<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>consider<span class="_"> </span>control<span class="_"> </span>hazards<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
