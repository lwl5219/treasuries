<div id="pf408" class="pf w2 h11" data-page-no="408"><div class="pc pc408 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg408.png"/><div class="t m5 x69 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.5<span class="_ _60"> </span>Synchronizing<span class="_ _10"> </span>Threads<span class="_ _10"> </span>with<span class="_ _10"> </span>Semaphores<span class="_ _3e"> </span><span class="ffe fs1e">1031</span></div><div class="t m5 x30 h26 y9c ff7 fs19 fc2 sc0 ls0 ws0">variable<span class="_ _21"> </span>declared<span class="_ _f"> </span>in<span class="_ _f"> </span>a<span class="_ _f"> </span>program.<span class="_ _21"> </span>F<span class="_ _1"></span>or<span class="_ _f"> </span>example,<span class="_ _f"> </span>even<span class="_ _f"> </span>though<span class="_ _f"> </span>each<span class="_ _21"> </span>peer</div><div class="t m5 x30 h26 y409 ff7 fs19 fc2 sc0 ls0 ws0">thread<span class="_ _13"> </span>in<span class="_ _6"> </span>our<span class="_ _13"> </span>example<span class="_ _13"> </span>program<span class="_ _6"> </span>declares<span class="_ _13"> </span><span class="ffd">cnt<span class="_ _13"> </span></span>in<span class="_ _6"> </span>line<span class="_ _13"> </span>25,<span class="_ _13"> </span>at<span class="_ _13"> </span>run<span class="_ _6"> </span>time<span class="_ _13"> </span>there<span class="_ _13"> </span>is</div><div class="t m5 x30 h26 y40a ff7 fs19 fc2 sc0 ls0 ws0">only<span class="_ _13"> </span>one<span class="_ _6"> </span>instance<span class="_ _13"> </span>of<span class="_ _13"> </span><span class="ffd">cnt<span class="_ _6"> </span></span>residing<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>read/write<span class="_ _13"> </span>area<span class="_ _6"> </span>of<span class="_ _13"> </span>virtual<span class="_ _13"> </span>memory<span class="_ _7"></span>.</div><div class="t m5 x30 h26 y40b ff7 fs19 fc2 sc0 ls0 ws0">Each<span class="_"> </span>peer<span class="_"> </span>thread<span class="_"> </span>reads<span class="_"> </span>and<span class="_"> </span>writes<span class="_"> </span>this<span class="_"> </span>instance<span class="_ _1"></span>.</div><div class="t m5 x17 h41 y80d1 ffe fs29 fc2 sc0 ls0 ws0">12.4.3<span class="_ _48"> </span><span class="fs19">Shared<span class="_"> </span>V<span class="_ _1"></span>ariables</span></div><div class="t m5 x17 h26 y80d2 ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _11"> </span>say<span class="_ _11"> </span>that<span class="_ _11"> </span>a<span class="_ _11"> </span>variable<span class="_ _11"> </span><span class="ff11">v<span class="_"> </span></span>is<span class="_ _11"> </span><span class="ffa">shared<span class="_ _11"> </span></span>if<span class="_ _11"> </span>and<span class="_ _16"> </span>only<span class="_"> </span>if<span class="_ _11"> </span>one<span class="_ _11"> </span>of<span class="_ _11"> </span>its<span class="_ _11"> </span>instances<span class="_ _11"> </span>is<span class="_ _11"> </span>referenced</div><div class="t m5 x17 h26 y80d3 ff7 fs19 fc2 sc0 ls0 ws0">by<span class="_ _16"> </span>more<span class="_ _11"> </span>than<span class="_ _16"> </span>one<span class="_ _16"> </span>thread.<span class="_ _16"> </span>F<span class="_ _3"></span>or<span class="_ _16"> </span>example<span class="_ _0"></span>,<span class="_ _16"> </span>variable<span class="_ _16"> </span><span class="ffd">cnt<span class="_ _11"> </span></span>in<span class="_ _16"> </span>our<span class="_ _16"> </span>example<span class="_ _16"> </span>program<span class="_ _11"> </span>is</div><div class="t m5 x17 h26 y80d4 ff7 fs19 fc2 sc0 ls0 ws0">shared<span class="_ _13"> </span>because<span class="_ _13"> </span>it<span class="_ _6"> </span>has<span class="_ _13"> </span>only<span class="_ _13"> </span>one<span class="_ _13"> </span>run-time<span class="_ _6"> </span>instance<span class="_ _13"> </span>and<span class="_ _13"> </span>this<span class="_ _13"> </span>instance<span class="_ _13"> </span>is<span class="_ _6"> </span>referenced<span class="_ _13"> </span>by</div><div class="t m5 x17 h26 y80d5 ff7 fs19 fc2 sc0 ls0 ws0">both<span class="_"> </span>peer<span class="_"> </span>threads<span class="_ _3"></span>.<span class="_"> </span>On<span class="_"> </span>the<span class="_"> </span>other<span class="_ _13"> </span>hand,<span class="_"> </span><span class="ffd">myid<span class="_ _10"> </span></span>is<span class="_"> </span>not<span class="_"> </span>shared,<span class="_"> </span>because<span class="_ _13"> </span>each<span class="_"> </span>of<span class="_"> </span>its<span class="_"> </span>two</div><div class="t m5 x17 h26 y80d6 ff7 fs19 fc2 sc0 ls0 ws0">instances<span class="_"> </span>is<span class="_"> </span>referenced<span class="_"> </span>by<span class="_ _11"> </span>exactly<span class="_"> </span>one<span class="_"> </span>thread.<span class="_"> </span>However,<span class="_"> </span>it<span class="_"> </span>is<span class="_ _11"> </span>important<span class="_"> </span>to<span class="_"> </span>realize</div><div class="t m5 x17 h26 y80d7 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_"> </span>local<span class="_"> </span>automatic<span class="_"> </span>variables<span class="_"> </span>such<span class="_"> </span>as<span class="_"> </span><span class="ffd">msgs<span class="_ _10"> </span></span>can<span class="_"> </span>also<span class="_"> </span>be<span class="_"> </span>shared.</div><div class="t m5 x17 h47 y80d8 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>12.6<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>1072)</span></div><div class="t m5 x34 h26 y80d9 ff7 fs19 fc1 sc0 ls0 ws0">A.<span class="_ _1f"> </span>Using<span class="_ _16"> </span>the<span class="_ _16"> </span>analysis<span class="_ _16"> </span>from<span class="_ _14"> </span>Section<span class="_ _16"> </span>12.4,<span class="_ _14"> </span>ﬁll<span class="_ _16"> </span>each<span class="_ _16"> </span>entry<span class="_ _14"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span>following<span class="_ _16"> </span>table</div><div class="t m5 x2d h26 y80da ff7 fs19 fc1 sc0 ls0 ws0">with<span class="_ _14"> </span>“Y<span class="_ _3"></span>es”<span class="_ _16"> </span>or<span class="_ _14"> </span>“No”<span class="_ _14"> </span>for<span class="_ _14"> </span>the<span class="_ _14"> </span>example<span class="_ _14"> </span>program<span class="_ _14"> </span>in<span class="_ _14"> </span>Figure<span class="_ _16"> </span>12.15.<span class="_ _14"> </span>In<span class="_ _14"> </span>the<span class="_ _14"> </span>ﬁrst</div><div class="t m5 x2d h26 y80db ff7 fs19 fc1 sc0 ls0 ws0">column,<span class="_ _16"> </span>the<span class="_ _16"> </span>notation<span class="_ _14"> </span><span class="ff11 ls10">v.<span class="_ _1"></span>t<span class="_"> </span><span class="ff7 ls0">denotes<span class="_ _16"> </span>an<span class="_ _16"> </span>instance<span class="_ _16"> </span>of<span class="_ _16"> </span>variable<span class="_ _16"> </span><span class="ff11">v<span class="_ _15"> </span></span>residing<span class="_ _16"> </span>on<span class="_ _16"> </span>the</span></span></div><div class="t m5 x2d h26 y80dc ff7 fs19 fc1 sc0 ls0 ws0">local<span class="_ _13"> </span>stack<span class="_"> </span>for<span class="_ _13"> </span>thread<span class="_ _13"> </span><span class="ff11">t<span class="_ _be"></span></span>,<span class="_ _13"> </span>where<span class="_"> </span><span class="ff11">t<span class="_ _11"> </span></span>is<span class="_"> </span>either<span class="_ _13"> </span><span class="ffd">m<span class="_ _13"> </span></span>(main<span class="_ _13"> </span>thread),<span class="_"> </span><span class="ffd">p0<span class="_ _13"> </span></span>(peer<span class="_ _13"> </span>thread<span class="_"> </span>0),</div><div class="t m5 x2d h26 y80dd ff7 fs19 fc1 sc0 ls0 ws0">or<span class="_"> </span><span class="ffd">p1<span class="_ _10"> </span></span>(peer<span class="_"> </span>thread<span class="_"> </span>1).</div><div class="t m5 x18d h31 y80de ff7 fs21 fc2 sc0 ls0 ws0">Referenced<span class="_"> </span>by</div><div class="t m5 x2d h31 y80df ff7 fs21 fc2 sc0 ls0 ws0">V<span class="_ _7"></span>ariable</div><div class="t m5 x2d h31 y80e0 ff7 fs21 fc2 sc0 ls0 ws0">instance<span class="_ _46"> </span>main<span class="_"> </span>thread?<span class="_ _26"> </span>peer<span class="_"> </span>thread<span class="_"> </span>0?<span class="_ _26"> </span>peer<span class="_"> </span>thread<span class="_"> </span>1?</div><div class="t m5 x2d h2d y80e1 ffd fs1e fc2 sc0 ls0 ws0">ptr</div><div class="t m5 x2d h2d y80e2 ffd fs1e fc1 sc0 ls0 ws0">cnt</div><div class="t m5 x2d h2d y80e3 ffd fs1e fc1 sc0 ls0 ws0">i.m</div><div class="t m5 x2d h2d y80e4 ffd fs1e fc1 sc0 ls0 ws0">msgs.m</div><div class="t m5 x2d h2d y80e5 ffd fs1e fc1 sc0 ls0 ws0">myid.p0</div><div class="t m5 x2d h2d y80e6 ffd fs1e fc1 sc0 ls0 ws0">myid.p1</div><div class="t m5 x34 h26 y80e7 ff7 fs19 fc1 sc0 ls0 ws0">B<span class="_ _3"></span>.<span class="_ _1d"> </span>Given<span class="_ _16"> </span>the<span class="_ _11"> </span>analysis<span class="_ _11"> </span>in<span class="_ _16"> </span>part<span class="_ _11"> </span>A,<span class="_ _16"> </span>which<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>variables<span class="_ _16"> </span><span class="ffd">ptr</span>,<span class="_ _11"> </span><span class="ffd">cnt</span>,<span class="_ _16"> </span><span class="ffd">i</span>,<span class="_ _16"> </span><span class="ffd">msgs</span>,<span class="_ _11"> </span>and</div><div class="t m5 x2d h26 y80e8 ffd fs19 fc1 sc0 ls0 ws0">myid<span class="_ _10"> </span><span class="ff7">are<span class="_"> </span>shared?</span></div><div class="t m5 x17 h3b y4aa5 fff fs24 fc6 sc0 ls0 ws0">12.5<span class="_ _17"> </span><span class="ffe fs18">Synchronizing<span class="_"> </span>Threads<span class="_"> </span>with<span class="_"> </span>Semaphores</span></div><div class="t m5 x17 h26 y211a ff7 fs19 fc1 sc0 ls0 ws0">Shared<span class="_ _14"> </span>variables<span class="_ _14"> </span>can<span class="_ _14"> </span>be<span class="_ _14"> </span>convenient,<span class="_ _14"> </span>but<span class="_ _14"> </span>they<span class="_ _14"> </span>introduce<span class="_ _14"> </span>the<span class="_ _14"> </span>possibility<span class="_ _14"> </span>of<span class="_ _14"> </span>nasty</div><div class="t m5 x17 h26 y2237 ffa fs19 fc1 sc0 ls0 ws0">synchronization<span class="_ _16"> </span>errors<span class="ff7">.<span class="_ _15"> </span>Consider<span class="_ _14"> </span>the<span class="_ _14"> </span><span class="ffd">badcnt.c<span class="_ _14"> </span></span>program<span class="_ _14"> </span>in<span class="_ _14"> </span>Figure<span class="_ _16"> </span>12.16,<span class="_ _15"> </span>which</span></div><div class="t m5 x17 h26 y2238 ff7 fs19 fc1 sc0 ls0 ws0">creates<span class="_ _16"> </span>two<span class="_ _16"> </span>threads<span class="_ _1"></span>,<span class="_ _14"> </span>each<span class="_ _14"> </span>of<span class="_ _16"> </span>which<span class="_ _14"> </span>increments<span class="_ _16"> </span>a<span class="_ _16"> </span>global<span class="_ _14"> </span>shared<span class="_ _16"> </span>counter<span class="_ _16"> </span>variable</div><div class="t m5 x17 h26 y2239 ff7 fs19 fc1 sc0 ls0 ws0">called<span class="_"> </span><span class="ffd">cnt</span>.</div><div class="t m5 x26 h26 y223a ff7 fs19 fc1 sc0 ls0 ws0">Since<span class="_ _16"> </span>each<span class="_ _14"> </span>thread<span class="_ _14"> </span>increments<span class="_ _16"> </span>the<span class="_ _14"> </span>counter<span class="_ _14"> </span><span class="ffd">niters<span class="_ _16"> </span></span>times<span class="_ _1"></span>,<span class="_ _15"> </span>we<span class="_ _14"> </span>expect<span class="_ _16"> </span>its<span class="_ _14"> </span>ﬁnal</div><div class="t m5 x17 h46 yd16 ff7 fs19 fc1 sc0 ls0 ws0">value<span class="_ _16"> </span>to<span class="_ _11"> </span>be<span class="_ _16"> </span>2<span class="_"> </span><span class="ff12">×<span class="_ _10"> </span><span class="ffd">niters<span class="_ _1"></span><span class="ff7">.<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>seems<span class="_ _16"> </span>quite<span class="_ _16"> </span>simple<span class="_ _11"> </span>and<span class="_ _16"> </span>straightforward.<span class="_ _16"> </span>However,</span></span></span></div><div class="t m5 x17 h26 yd17 ff7 fs19 fc1 sc0 ls0 ws0">when<span class="_"> </span>we<span class="_ _11"> </span>run<span class="_"> </span><span class="ffd">badcnt.c<span class="_ _11"> </span></span>on<span class="_"> </span>our<span class="_ _11"> </span>Linux<span class="_"> </span>system,<span class="_ _11"> </span>we<span class="_"> </span>not<span class="_ _11"> </span>only<span class="_ _11"> </span>get<span class="_"> </span>wrong<span class="_ _11"> </span>answers<span class="_ _1"></span>,<span class="_"> </span>we</div><div class="t m5 x17 h26 y223b ff7 fs19 fc1 sc0 ls0 ws0">get<span class="_"> </span>different<span class="_"> </span>answers<span class="_"> </span>each<span class="_"> </span>time!</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
