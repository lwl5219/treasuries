<div id="pf3f8" class="pf w2 h11" data-page-no="3f8"><div class="pc pc3f8 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3f8.png"/><div class="t m5 x125 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.2<span class="_ _60"> </span>Concurrent<span class="_ _10"> </span>Programming<span class="_ _10"> </span>with<span class="_ _10"> </span>I/O<span class="_ _10"> </span>Multiplexing<span class="_ _3e"> </span><span class="ffe fs1e">1015</span></div><div class="t m5 x12f h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/select.c</div><div class="t m5 x2c h88 yad1 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h88 y626e ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>echo(int<span class="_ _e"> </span>connfd);</span></div><div class="t m5 x2c h88 ye98 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>command(void);</span></div><div class="t m5 x2c h2e y626f ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y6270 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x2d h88 y2827 ffd fs4e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _f"> </span>argc,<span class="_ _e"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x2c h88 y6271 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x2c h88 y6272 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>listenfd,<span class="_ _e"> </span>connfd;</span></div><div class="t m5 x2c h88 y59ef ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _e2"> </span><span class="ffd fs4e fc2">socklen_t<span class="_ _e"> </span>clientlen;</span></div><div class="t m5 x2c h88 y22c1 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _e2"> </span><span class="ffd fs4e fc2">struct<span class="_ _e"> </span>sockaddr_storage<span class="_ _e"> </span>clientaddr;</span></div><div class="t m5 x17 h88 y59f2 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _e2"> </span><span class="ffd fs4e fc2">fd_set<span class="_ _e"> </span>read_set,<span class="_ _e"> </span>ready_set;</span></div><div class="t m5 x17 h2e y59f3 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x17 h2e y7f79 ff6 fs20 fc6 sc0 ls0 ws0">12</div><div class="t m5 x1a0 h88 y59f4 ffd fs4e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(argc<span class="_ _f"> </span>!=<span class="_ _e"> </span>2)<span class="_ _e"> </span>{</div><div class="t m5 x17 h2e y59f6 ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x5a h88 y7cbd ffd fs4e fc2 sc0 ls0 ws0">fprintf(stderr,<span class="_ _e"> </span>&quot;usage:<span class="_ _f"> </span>%s<span class="_ _e"> </span>&lt;port&gt;\n&quot;,<span class="_ _e"> </span>argv[0]);</div><div class="t m5 x17 h88 y7cbe ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _18b"> </span><span class="ffd fs4e fc2">exit(0);</span></div><div class="t m5 x17 h2e y37bd ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x1a0 h88 y7f7a ffd fs4e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h88 y7cc0 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _e2"> </span><span class="ffd fs4e fc2">listenfd<span class="_ _e"> </span>=<span class="_ _e"> </span>Open_listenfd(argv[1]);</span></div><div class="t m5 x17 h2e y7cc1 ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x17 h2e y7f7b ff6 fs20 fc6 sc0 ls0 ws0">18</div><div class="t m5 x1a0 h88 y59f9 ffd fs4e fc2 sc0 ls0 ws0">FD_ZERO(&amp;read_set);<span class="_ _ce"> </span>/*<span class="_ _e"> </span>Clear<span class="_ _f"> </span>read<span class="_ _e"> </span>set<span class="_ _e"> </span>*/</div><div class="t m5 x17 h88 y59fa ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _e2"> </span><span class="ffd fs4e fc2">FD_SET(STDIN_FILENO,<span class="_ _e"> </span>&amp;read_set);<span class="_ _e"> </span>/*<span class="_ _f"> </span>Add<span class="_ _e"> </span>stdin<span class="_ _e"> </span>to<span class="_ _f"> </span>read<span class="_ _e"> </span>set<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y4f74 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _e2"> </span><span class="ffd fs4e fc2">FD_SET(listenfd,<span class="_ _e"> </span>&amp;read_set);<span class="_ _75"> </span>/*<span class="_ _e"> </span>Add<span class="_ _f"> </span>listenfd<span class="_ _e"> </span>to<span class="_ _e"> </span>read<span class="_ _f"> </span>set<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2e y7cc3 ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x17 h2e y7f7c ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x1a0 h88 y7cc4 ffd fs4e fc2 sc0 ls0 ws0">while<span class="_ _e"> </span>(1)<span class="_ _f"> </span>{</div><div class="t m5 x17 h88 y7cc5 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _18b"> </span><span class="ffd fs4e fc2">ready_set<span class="_ _e"> </span>=<span class="_ _f"> </span>read_set;</span></div><div class="t m5 x17 h88 y7cc6 ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _18b"> </span><span class="ffd fs4e fc2">Select(listenfd+1,<span class="_ _e"> </span>&amp;ready_set,<span class="_ _f"> </span>NULL,<span class="_ _e"> </span>NULL,<span class="_ _e"> </span>NULL);</span></div><div class="t m5 x17 h88 y6281 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _18b"> </span><span class="ffd fs4e fc2">if<span class="_ _e"> </span>(FD_ISSET(STDIN_FILENO,<span class="_ _f"> </span>&amp;ready_set))</span></div><div class="t m5 x17 h88 y6282 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _1eb"> </span><span class="ffd fs4e fc2">command();<span class="_ _e"> </span>/*<span class="_ _e"> </span>Read<span class="_ _f"> </span>command<span class="_ _e"> </span>line<span class="_ _e"> </span>from<span class="_ _e"> </span>stdin<span class="_ _f"> </span>*/</span></div><div class="t m5 x17 h88 y6283 ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _18b"> </span><span class="ffd fs4e fc2">if<span class="_ _e"> </span>(FD_ISSET(listenfd,<span class="_ _f"> </span>&amp;ready_set))<span class="_ _e"> </span>{</span></div><div class="t m5 x17 h88 y5a03 ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _1eb"> </span><span class="ffd fs4e fc2">clientlen<span class="_ _e"> </span>=<span class="_ _e"> </span>sizeof(struct<span class="_ _f"> </span>sockaddr_storage);</span></div><div class="t m5 x17 h88 y6287 ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _1eb"> </span><span class="ffd fs4e fc2">connfd<span class="_ _e"> </span>=<span class="_ _e"> </span>Accept(listenfd,<span class="_ _f"> </span>(SA<span class="_ _e"> </span>*)&amp;clientaddr,<span class="_ _e"> </span>&amp;clientlen);</span></div><div class="t m5 x17 h88 y6288 ff6 fs20 fc6 sc0 ls0 ws0">30<span class="_ _1eb"> </span><span class="ffd fs4e fc2">echo(connfd);<span class="_ _e"> </span>/*<span class="_ _e"> </span>Echo<span class="_ _f"> </span>client<span class="_ _e"> </span>input<span class="_ _e"> </span>until<span class="_ _e"> </span>EOF<span class="_ _f"> </span>*/</span></div><div class="t m5 x17 h88 y7f7d ff6 fs20 fc6 sc0 ls0 ws0">31<span class="_ _1eb"> </span><span class="ffd fs4e fc2">Close(connfd);</span></div><div class="t m5 x17 h88 y7f7e ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _18b"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h88 y628b ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _e2"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h88 y7f7f ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h2e y5a07 ff6 fs20 fc6 sc0 ls0 ws0">35</div><div class="t m5 x17 h2e y7f80 ff6 fs20 fc6 sc0 ls0 ws0">36</div><div class="t m5 x2d h88 y628e ffd fs4e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>command(void)<span class="_ _f"> </span>{</div><div class="t m5 x17 h88 yc3f ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _e2"> </span><span class="ffd fs4e fc2">char<span class="_ _e"> </span>buf[MAXLINE];</span></div><div class="t m5 x17 h88 y6290 ff6 fs20 fc6 sc0 ls0 ws0">38<span class="_ _e2"> </span><span class="ffd fs4e fc2">if<span class="_ _e"> </span>(!Fgets(buf,<span class="_ _e"> </span>MAXLINE,<span class="_ _f"> </span>stdin))</span></div><div class="t m5 x17 h88 y6291 ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _18b"> </span><span class="ffd fs4e fc2">exit(0);<span class="_ _e"> </span>/*<span class="_ _f"> </span>EOF<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y6292 ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _e2"> </span><span class="ffd fs4e fc2">printf(&quot;%s&quot;,<span class="_ _e"> </span>buf);<span class="_ _e"> </span>/*<span class="_ _f"> </span>Process<span class="_ _e"> </span>the<span class="_ _e"> </span>input<span class="_ _f"> </span>command<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y6293 ff6 fs20 fc6 sc0 ls0 ws0">41<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x12f h2c y7f81 ffa fs16 fc2 sc0 ls0 ws0">code/conc/select.c</div><div class="t m5 x17 h34 y7f82 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _16"> </span>12.6<span class="_ _c"> </span><span class="fc1">An<span class="_ _14"> </span>iterative<span class="_ _14"> </span>echo<span class="_ _16"> </span>ser<span class="_ _2"></span>ver<span class="_ _16"> </span>that<span class="_ _14"> </span>uses<span class="_ _14"> </span>I/O<span class="_ _16"> </span>multiplexing.<span class="_ _14"> </span><span class="ff6">The<span class="_ _14"> </span>server<span class="_ _14"> </span>uses</span></span></div><div class="t m5 x17 h3a y7f83 ffd fs19 fc1 sc0 ls0 ws0">select<span class="_ _16"> </span><span class="ff6 fs16">to<span class="_ _14"> </span>wait<span class="_ _16"> </span>for<span class="_ _14"> </span>connection<span class="_ _16"> </span>requests<span class="_ _14"> </span>on<span class="_ _16"> </span>a<span class="_ _14"> </span>listening<span class="_ _16"> </span>descriptor<span class="_ _14"> </span>and<span class="_ _16"> </span>commands<span class="_ _14"> </span>on</span></div><div class="t m5 x17 h34 y7f84 ff6 fs16 fc1 sc0 ls0 ws0">standard<span class="_ _10"> </span>input.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
