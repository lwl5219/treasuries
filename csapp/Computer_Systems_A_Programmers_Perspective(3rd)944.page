<div id="pf3b0" class="pf w2 h11" data-page-no="3b0"><div class="pc pc3b0 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3b0.png"/><div class="t m5 x18c h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>10.8<span class="_ _60"> </span>Sharing<span class="_ _10"> </span>Files<span class="_ _3e"> </span><span class="ffe fs1e">943</span></div><div class="t m5 x17 h2f ye7 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>10.12</div><div class="t m5 x17 h2f y58a ffe fs16 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>ypical<span class="_ _21"> </span>kernel<span class="_ _15"> </span>data</div><div class="t m5 x17 h2f y58b ffe fs16 fc1 sc0 ls0 ws0">structures<span class="_ _15"> </span>for<span class="_ _15"> </span>open</div><div class="t m5 x17 h34 y58c ffe fs16 fc1 sc0 ls0 ws0">ﬁles.<span class="_ _14"> </span><span class="ff6">In<span class="_ _14"> </span>this<span class="_ _14"> </span>example,</span></div><div class="t m5 x17 h34 y58d ff6 fs16 fc1 sc0 ls0 ws0">two<span class="_ _11"> </span>descriptors<span class="_ _16"> </span>reference</div><div class="t m5 x17 h34 y58e ff6 fs16 fc1 sc0 ls0 ws0">distinct<span class="_ _16"> </span>ﬁles.<span class="_ _11"> </span>There<span class="_ _16"> </span>is<span class="_ _16"> </span>no</div><div class="t m5 x17 h34 y58f ff6 fs16 fc1 sc0 ls0 ws0">sharing.</div><div class="t m5 xe5 h3f y7877 ffd0 fs27 fc1 sc0 ls0 ws0">Descriptor table</div><div class="t m5 x228 h3f y7878 ffd0 fs27 fc1 sc0 ls0 ws0">(one table</div><div class="t m5 xa8 h3f y7879 ffd0 fs27 fc1 sc0 ls0 ws0">per process)</div><div class="t m5 x3a h3f y787a ffd0 fs27 fc1 sc0 ls0 ws0">Open file table</div><div class="t m5 x17b h3f y787b ffd0 fs27 fc1 sc0 ls0 ws0">(shared by</div><div class="t m5 x195 h3f y787c ffd0 fs27 fc1 sc0 ls0 ws0">all processes)</div><div class="t m5 x61 h3f y787d ffd0 fs27 fc1 sc0 ls0 ws0">v-node table</div><div class="t m5 x236 h3f y787e ffd0 fs27 fc1 sc0 ls0 ws0">(shared by</div><div class="t m5 x71 h3f y787f ffd0 fs27 fc1 sc0 ls0 ws0">all processes)</div><div class="t m5 xf0 h40 y7880 ffd1 fs28 fc1 sc0 ls0 ws0">stdin<span class="ffd0 fs27">   fd 0</span></div><div class="t m5 xb3 h40 y7881 ffd1 fs28 fc1 sc0 ls0 ws0">stdout<span class="ffd0 fs27">   fd 1</span></div><div class="t m5 xb3 h40 y7882 ffd1 fs28 fc1 sc0 ls0 ws0">stderr<span class="ffd0 fs27">   fd 2</span></div><div class="t m5 x90 h3f y7883 ffd0 fs27 fc1 sc0 ls0 ws0"> fd 3</div><div class="t m5 x206 h3f y7884 ffd0 fs27 fc1 sc0 ls0 ws0">fd 4</div><div class="t m5 x201 h3f y7885 ffd0 fs27 fc1 sc0 ls0 ws0">File size</div><div class="t m5 x174 h3f y7886 ffd0 fs27 fc1 sc0 ls0 ws0">File access</div><div class="t m5 x216 h3f y7887 ffd0 fs27 fc1 sc0 ls0 ws0">File type</div><div class="t m5 x152 h3f y7888 ffd0 fs27 fc1 sc0 ls0 ws0">File B</div><div class="t m5 x1a1 h3f y7889 ffd0 fs27 fc1 sc0 ls0 ws0">File pos</div><div class="t m5 xda h40 y788a ffd1 fs28 fc1 sc0 ls0 ws0">refcnt<span class="ff24"></span>1</div><div class="t m8 x9 h3f y788b ffd0 fs27 fc1 sc0 ls0 ws0">…</div><div class="t m5 xf2 h3f y788c ffd0 fs27 fc1 sc0 ls0 ws5">File A</div><div class="t m5 x1a1 h3f y788d ffd0 fs27 fc1 sc0 ls0 ws0">File pos</div><div class="t m5 xda h40 y788e ffd1 fs28 fc1 sc0 ls0 ws0">refcnt<span class="ff24"></span>1</div><div class="t m8 x9 h3f y788f ffd0 fs27 fc1 sc0 ls0 ws0">…</div><div class="t m8 x229 h3f y7890 ffd0 fs27 fc1 sc0 ls0 ws0">…</div><div class="t m5 x201 h3f y7891 ffd0 fs27 fc1 sc0 ls0 ws0">File size</div><div class="t m5 x174 h3f y7892 ffd0 fs27 fc1 sc0 ls0 ws0">File access</div><div class="t m5 x216 h3f y7893 ffd0 fs27 fc1 sc0 ls0 ws0">File type</div><div class="t m8 x229 h3f y7894 ffd0 fs27 fc1 sc0 ls0 ws0">…</div><div class="t m5 x17 h2f y7895 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>10.13</div><div class="t m5 x17 h34 y7896 ffe fs16 fc1 sc0 ls0 ws0">File<span class="_"> </span>sharing.<span class="_"> </span><span class="ff6">This<span class="_ _11"> </span>example</span></div><div class="t m5 x17 h34 y7897 ff6 fs16 fc1 sc0 ls0 ws0">shows<span class="_ _14"> </span>two<span class="_ _16"> </span>descriptors</div><div class="t m5 x17 h34 y7898 ff6 fs16 fc1 sc0 ls0 ws0">sharing<span class="_ _11"> </span>the<span class="_ _16"> </span>same<span class="_ _11"> </span>disk<span class="_ _11"> </span>ﬁle</div><div class="t m5 x17 h34 y7899 ff6 fs16 fc1 sc0 ls0 ws0">through<span class="_ _13"> </span>two<span class="_ _10"> </span>open<span class="_ _13"> </span>ﬁle<span class="_ _10"> </span>table</div><div class="t m5 x17 h34 y789a ff6 fs16 fc1 sc0 ls0 ws0">entries.</div><div class="t m5 x21d h3f y789b ffd0 fs27 fc1 sc0 ls0 ws0">Descriptor table</div><div class="t m5 x10e h3f y789c ffd0 fs27 fc1 sc0 ls0 ws0">(one table</div><div class="t m5 xb7 h3f y789d ffd0 fs27 fc1 sc0 ls0 ws0">per process)</div><div class="t m5 x7e h3f y789e ffd0 fs27 fc1 sc0 ls0 ws0">Open file table</div><div class="t m5 x1c7 h3f y789f ffd0 fs27 fc1 sc0 ls0 ws0">(shared by</div><div class="t m5 xf4 h3f y78a0 ffd0 fs27 fc1 sc0 ls0 ws0">all processes)</div><div class="t m5 x158 h3f y78a1 ffd0 fs27 fc1 sc0 ls0 ws0">v-node table</div><div class="t m5 x1c1 h3f y78a2 ffd0 fs27 fc1 sc0 ls0 ws0">(shared by</div><div class="t m5 x1c0 h3f y78a3 ffd0 fs27 fc1 sc0 ls0 ws0">all processes)</div><div class="t m5 xe6 h3f y78a4 ffd0 fs27 fc1 sc0 ls0 ws0">fd 0</div><div class="t m5 xe6 h3f y78a5 ffd0 fs27 fc1 sc0 ls0 ws0">fd 1</div><div class="t m5 xe6 h3f y78a6 ffd0 fs27 fc1 sc0 ls0 ws0">fd 2</div><div class="t m5 xe6 h3f y78a7 ffd0 fs27 fc1 sc0 ls0 ws0">fd 3</div><div class="t m5 xe6 h3f y78a8 ffd0 fs27 fc1 sc0 ls0 ws0">fd 4</div><div class="t m5 x270 h3f y78a9 ffd0 fs27 fc1 sc0 ls0 ws0">File size</div><div class="t m5 x4e h3f y78aa ffd0 fs27 fc1 sc0 ls0 ws0">File access</div><div class="t m5 x173 h3f y78ab ffd0 fs27 fc1 sc0 ls0 ws0">File type</div><div class="t m5 x1fb h3f y78ac ffd0 fs27 fc1 sc0 ls0 ws0">File B</div><div class="t m5 x1fc h3f y78ad ffd0 fs27 fc1 sc0 ls0 ws0">File pos</div><div class="t m5 xfb h40 y78ae ffd1 fs28 fc1 sc0 ls0 ws0">refcnt<span class="ff24"></span>1</div><div class="t m8 xff h3f y78af ffd0 fs27 fc1 sc0 ls0 ws0">…</div><div class="t m5 x12e h3f y78b0 ffd0 fs27 fc1 sc0 ls0 ws5">File A</div><div class="t m5 x1fc h3f y78b1 ffd0 fs27 fc1 sc0 ls0 ws0">File pos</div><div class="t m5 xfb h40 y78b2 ffd1 fs28 fc1 sc0 ls0 ws0">refcnt<span class="ff24"></span>1</div><div class="t m8 xff h3f y78b3 ffd0 fs27 fc1 sc0 ls0 ws0">…</div><div class="t m8 x22e h3f y78b4 ffd0 fs27 fc1 sc0 ls0 ws0">…</div><div class="t m5 x26 h26 ycc7 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _e"> </span>10.12<span class="_ _f"> </span>shows<span class="_ _f"> </span>an<span class="_ _e"> </span>example<span class="_ _21"> </span>where<span class="_ _e"> </span>descriptors<span class="_ _f"> </span>1<span class="_ _f"> </span>and<span class="_ _e"> </span>4<span class="_ _21"> </span>reference<span class="_ _e"> </span>two</div><div class="t m5 x17 h26 ycc8 ff7 fs19 fc1 sc0 ls0 ws0">different<span class="_"> </span>ﬁles<span class="_"> </span>through<span class="_"> </span>distinct<span class="_"> </span>open<span class="_"> </span>ﬁle<span class="_"> </span>table<span class="_ _11"> </span>entries<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _0"></span>his<span class="_"> </span>is<span class="_"> </span>the<span class="_"> </span>typical<span class="_"> </span>situation,</div><div class="t m5 x17 h26 ycc9 ff7 fs19 fc1 sc0 ls0 ws0">where<span class="_ _13"> </span>ﬁles<span class="_ _13"> </span>are<span class="_ _13"> </span>not<span class="_ _13"> </span>shared<span class="_ _13"> </span>and<span class="_ _13"> </span>where<span class="_ _13"> </span>each<span class="_ _13"> </span>descriptor<span class="_"> </span>corresponds<span class="_ _13"> </span>to<span class="_ _13"> </span>a<span class="_ _13"> </span>distinct<span class="_ _13"> </span>ﬁle<span class="_ _1"></span>.</div><div class="t m5 x26 h26 ycca ff7 fs19 fc1 sc0 ls0 ws0">Multiple<span class="_ _14"> </span>descriptors<span class="_ _15"> </span>can<span class="_ _15"> </span>also<span class="_ _15"> </span>reference<span class="_ _14"> </span>the<span class="_ _15"> </span>same<span class="_ _15"> </span>ﬁle<span class="_ _14"> </span>through<span class="_ _15"> </span>different<span class="_ _15"> </span>ﬁle</div><div class="t m5 x17 h26 yccb ff7 fs19 fc1 sc0 ls0 ws0">table<span class="_ _16"> </span>entries<span class="_ _0"></span>,<span class="_ _14"> </span>as<span class="_ _14"> </span>shown<span class="_ _14"> </span>in<span class="_ _14"> </span>F<span class="_ _1"></span>igure<span class="_ _14"> </span>10.13.<span class="_ _14"> </span>T<span class="_ _0"></span>his<span class="_ _14"> </span>might<span class="_ _16"> </span>happen,<span class="_ _15"> </span>for<span class="_ _14"> </span>example<span class="_ _0"></span>,<span class="_ _14"> </span>if<span class="_ _14"> </span>you</div><div class="t m5 x17 h26 yccc ff7 fs19 fc1 sc0 ls0 ws0">were<span class="_"> </span>to<span class="_ _11"> </span>call<span class="_ _11"> </span>the<span class="_"> </span><span class="ffd">open<span class="_ _11"> </span></span>function<span class="_ _11"> </span>twice<span class="_"> </span>with<span class="_ _11"> </span>the<span class="_ _11"> </span>same<span class="_"> </span>ﬁlename.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>key<span class="_ _11"> </span>idea<span class="_"> </span>is<span class="_ _11"> </span>that</div><div class="t m5 x17 h26 yccd ff7 fs19 fc1 sc0 ls0 ws0">each<span class="_ _16"> </span>descriptor<span class="_ _16"> </span>has<span class="_ _14"> </span>its<span class="_ _16"> </span>own<span class="_ _16"> </span>distinct<span class="_ _14"> </span>ﬁle<span class="_ _16"> </span>position,<span class="_ _14"> </span>so<span class="_ _14"> </span>different<span class="_ _16"> </span>reads<span class="_ _16"> </span>on<span class="_ _14"> </span>different</div><div class="t m5 x17 h26 ycce ff7 fs19 fc1 sc0 ls0 ws0">descriptors<span class="_"> </span>can<span class="_"> </span>fetch<span class="_"> </span>data<span class="_"> </span>from<span class="_"> </span>different<span class="_"> </span>locations<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>ﬁle<span class="_ _1"></span>.</div><div class="t m5 x26 h26 yccf ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _11"> </span>can<span class="_ _11"> </span>also<span class="_ _11"> </span>understand<span class="_ _11"> </span>how<span class="_ _11"> </span>parent<span class="_ _11"> </span>and<span class="_ _11"> </span>child<span class="_ _11"> </span>processes<span class="_ _11"> </span>share<span class="_ _11"> </span>ﬁles<span class="_ _1"></span>.<span class="_ _11"> </span>Suppose</div><div class="t m5 x17 h26 ycd0 ff7 fs19 fc1 sc0 ls0 ws0">that<span class="_ _14"> </span>before<span class="_ _15"> </span>a<span class="_ _15"> </span>call<span class="_ _15"> </span>to<span class="_ _14"> </span><span class="ffd">fork</span>,<span class="_ _21"> </span>the<span class="_ _15"> </span>parent<span class="_ _15"> </span>process<span class="_ _15"> </span>has<span class="_ _14"> </span>the<span class="_ _15"> </span>open<span class="_ _15"> </span>ﬁles<span class="_ _15"> </span>shown<span class="_ _14"> </span>in<span class="_ _15"> </span>F<span class="_ _0"></span>ig-</div><div class="t m5 x17 h26 ycd1 ff7 fs19 fc1 sc0 ls0 ws0">ure<span class="_"> </span>10.12.<span class="_"> </span>T<span class="_ _1"></span>hen<span class="_"> </span>Figure<span class="_"> </span>10.14<span class="_"> </span>shows<span class="_"> </span>the<span class="_"> </span>situation<span class="_"> </span>after<span class="_"> </span>the<span class="_"> </span>call<span class="_"> </span>to<span class="_"> </span><span class="ffd">fork</span>.</div><div class="t m5 x26 h26 ycd2 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _11"> </span>child<span class="_"> </span>gets<span class="_ _11"> </span>its<span class="_"> </span>own<span class="_ _11"> </span>duplicate<span class="_"> </span>copy<span class="_ _11"> </span>of<span class="_"> </span>the<span class="_ _11"> </span>parent’s<span class="_"> </span>descriptor<span class="_"> </span>table.<span class="_"> </span>Parent</div><div class="t m5 x17 h26 ycd3 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>child<span class="_ _11"> </span>share<span class="_ _11"> </span>the<span class="_ _11"> </span>same<span class="_ _11"> </span>set<span class="_ _11"> </span>of<span class="_ _11"> </span>open<span class="_ _11"> </span>ﬁle<span class="_ _11"> </span>tables<span class="_ _11"> </span>and<span class="_ _11"> </span>thus<span class="_ _11"> </span>share<span class="_ _11"> </span>the<span class="_ _11"> </span>same<span class="_ _11"> </span>ﬁle<span class="_ _11"> </span>pos-</div><div class="t m5 x17 h26 ycd4 ff7 fs19 fc1 sc0 ls0 ws0">ition.<span class="_ _13"> </span>An<span class="_ _13"> </span>important<span class="_ _13"> </span>consequence<span class="_ _13"> </span>is<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_ _13"> </span>parent<span class="_ _13"> </span>and<span class="_ _13"> </span>child<span class="_ _13"> </span>must<span class="_ _13"> </span>both<span class="_ _13"> </span>close<span class="_ _13"> </span>their</div><div class="t m5 x17 h26 ycd5 ff7 fs19 fc1 sc0 ls0 ws0">descriptors<span class="_"> </span>before<span class="_"> </span>the<span class="_"> </span>kernel<span class="_"> </span>will<span class="_"> </span>delete<span class="_"> </span>the<span class="_"> </span>corresponding<span class="_"> </span>ﬁle<span class="_"> </span>table<span class="_"> </span>entry<span class="_ _3"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
