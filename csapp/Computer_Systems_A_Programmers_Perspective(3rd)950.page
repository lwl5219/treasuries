<div id="pf3b6" class="pf w2 h11" data-page-no="3b6"><div class="pc pc3b6 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3b6.png"/><div class="t m5 x166 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>10.12<span class="_ _60"> </span>Summar<span class="_ _2"></span>y<span class="_ _1b"> </span><span class="ffe fs1e">949</span></div><div class="t m5 x26 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hese<span class="_ _13"> </span>restrictions<span class="_ _13"> </span>pose<span class="_ _6"> </span>a<span class="_ _13"> </span>problem<span class="_ _6"> </span>for<span class="_ _13"> </span>network<span class="_ _13"> </span>applications<span class="_ _6"> </span>because<span class="_ _13"> </span>it<span class="_ _6"> </span>is<span class="_ _13"> </span>illegal</div><div class="t m5 x17 h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">to<span class="_ _11"> </span>use<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffd">lseek<span class="_ _11"> </span></span>function<span class="_ _11"> </span>on<span class="_ _11"> </span>a<span class="_ _16"> </span>socket.<span class="_ _11"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>ﬁrst<span class="_ _11"> </span>restriction<span class="_ _11"> </span>on<span class="_ _11"> </span>stream<span class="_ _16"> </span>I/O<span class="_ _11"> </span>can<span class="_ _11"> </span>be</div><div class="t m5 x17 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">worked<span class="_"> </span>around<span class="_"> </span>by<span class="_"> </span>adopting<span class="_"> </span>a<span class="_"> </span>discipline<span class="_ _11"> </span>of<span class="_"> </span>ﬂushing<span class="_"> </span>the<span class="_"> </span>buffer<span class="_"> </span>before<span class="_ _11"> </span>every<span class="_"> </span>input</div><div class="t m5 x17 h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">operation.<span class="_ _15"> </span>However,<span class="_ _15"> </span>the<span class="_ _15"> </span>only<span class="_ _15"> </span>way<span class="_ _14"> </span>to<span class="_ _15"> </span>work<span class="_ _15"> </span>around<span class="_ _15"> </span>the<span class="_ _15"> </span>second<span class="_ _15"> </span>restriction<span class="_ _15"> </span>is<span class="_ _15"> </span>to</div><div class="t m5 x17 h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">open<span class="_ _16"> </span>two<span class="_ _11"> </span>streams<span class="_ _16"> </span>on<span class="_ _16"> </span>the<span class="_ _16"> </span>same<span class="_ _16"> </span>open<span class="_ _11"> </span>socket<span class="_ _16"> </span>descriptor,<span class="_ _16"> </span>one<span class="_ _16"> </span>for<span class="_ _11"> </span>reading<span class="_ _16"> </span>and<span class="_ _16"> </span>one</div><div class="t m5 x17 h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_"> </span>writing:</div><div class="t m5 x1b6 h2d y795e ffd fs1e fc2 sc0 ls0 ws0">FILE<span class="_ _e"> </span>*fpin,<span class="_ _1f"> </span>*fpout;</div><div class="t m5 x1b6 h2d y795f ffd fs1e fc2 sc0 ls0 ws0">fpin<span class="_ _e"> </span>=<span class="_ _1f"> </span>fdopen(sockfd,<span class="_ _1f"> </span>&quot;r&quot;);</div><div class="t m5 x1b6 h2d y7960 ffd fs1e fc2 sc0 ls0 ws0">fpout<span class="_ _e"> </span>=<span class="_ _1f"> </span>fdopen(sockfd,<span class="_ _1f"> </span>&quot;w&quot;);</div><div class="t m5 x17 h26 y7961 ff7 fs19 fc2 sc0 ls0 ws0">But<span class="_"> </span>this<span class="_ _13"> </span>approach<span class="_"> </span>has<span class="_ _13"> </span>problems<span class="_"> </span>as<span class="_ _13"> </span>well,<span class="_"> </span>because<span class="_ _13"> </span>it<span class="_"> </span>requires<span class="_ _13"> </span>the<span class="_"> </span>application<span class="_ _13"> </span>to<span class="_"> </span>call</div><div class="t m5 x17 h26 y7962 ffd fs19 fc2 sc0 ls0 ws0">fclose<span class="_ _16"> </span><span class="ff7">on<span class="_ _16"> </span>both<span class="_ _14"> </span>streams<span class="_ _16"> </span>in<span class="_ _14"> </span>order<span class="_ _16"> </span>to<span class="_ _16"> </span>free<span class="_ _14"> </span>the<span class="_ _16"> </span>memory<span class="_ _14"> </span>resources<span class="_ _16"> </span>associated<span class="_ _16"> </span>with</span></div><div class="t m5 x17 h26 y7963 ff7 fs19 fc2 sc0 ls0 ws0">each<span class="_"> </span>stream<span class="_"> </span>and<span class="_"> </span>avoid<span class="_"> </span>a<span class="_"> </span>memory<span class="_"> </span>leak:</div><div class="t m5 x1b6 h2d y7964 ffd fs1e fc2 sc0 ls0 ws0">fclose(fpin);</div><div class="t m5 x1b6 h2d y7965 ffd fs1e fc2 sc0 ls0 ws0">fclose(fpout);</div><div class="t m5 x17 h26 y7966 ff7 fs19 fc2 sc0 ls0 ws0">Each<span class="_ _13"> </span>of<span class="_ _13"> </span>these<span class="_ _13"> </span>operations<span class="_"> </span>attempts<span class="_ _13"> </span>to<span class="_ _13"> </span>close<span class="_ _13"> </span>the<span class="_ _13"> </span>same<span class="_ _13"> </span>underlying<span class="_"> </span>socket<span class="_ _13"> </span>descriptor<span class="_ _0"></span>,</div><div class="t m5 x17 h26 y7967 ff7 fs19 fc2 sc0 ls0 ws0">so<span class="_ _f"> </span>the<span class="_ _f"> </span>second<span class="_ _f"> </span><span class="ffd">close<span class="_ _f"> </span></span>operation<span class="_ _f"> </span>will<span class="_ _f"> </span>fail.<span class="_ _f"> </span>This<span class="_ _21"> </span>is<span class="_ _f"> </span>not<span class="_ _f"> </span>a<span class="_ _f"> </span>problem<span class="_ _f"> </span>for<span class="_ _e"> </span>sequential</div><div class="t m5 x17 h26 y7968 ff7 fs19 fc2 sc0 ls0 ws0">programs<span class="_ _1"></span>,<span class="_ _21"> </span>but<span class="_ _15"> </span>closing<span class="_ _15"> </span>an<span class="_ _15"> </span>already<span class="_ _15"> </span>closed<span class="_ _15"> </span>descriptor<span class="_ _15"> </span>in<span class="_ _15"> </span>a<span class="_ _15"> </span>threaded<span class="_ _15"> </span>program<span class="_ _21"> </span>is<span class="_ _15"> </span>a</div><div class="t m5 x17 h26 y7969 ff7 fs19 fc2 sc0 ls0 ws0">recipe<span class="_"> </span>for<span class="_"> </span>disaster<span class="_"> </span>(see<span class="_"> </span>Section<span class="_"> </span>12.7.4).</div><div class="t m5 x26 h26 y796a ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_ _14"> </span>we<span class="_ _16"> </span>recommend<span class="_ _16"> </span>that<span class="_ _16"> </span>you<span class="_ _16"> </span>not<span class="_ _14"> </span>use<span class="_ _16"> </span>the<span class="_ _16"> </span>standard<span class="_ _16"> </span>I/O<span class="_ _16"> </span>functions<span class="_ _16"> </span>for<span class="_ _16"> </span>input</div><div class="t m5 x17 h26 y796b ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _13"> </span>output<span class="_"> </span>on<span class="_ _13"> </span>network<span class="_"> </span>sockets<span class="_ _3"></span>.<span class="_"> </span>Use<span class="_ _13"> </span>the<span class="_"> </span>robust<span class="_ _13"> </span><span class="ff9">Rio<span class="_ _10"> </span></span>functions<span class="_ _13"> </span>instead.<span class="_"> </span>If<span class="_ _13"> </span>you<span class="_"> </span>need</div><div class="t m5 x17 h26 y796c ff7 fs19 fc2 sc0 ls0 ws0">formatted<span class="_ _6"> </span>output,<span class="_ _13"> </span>use<span class="_ _13"> </span>the<span class="_ _6"> </span><span class="ffd">sprintf<span class="_ _6"> </span></span>function<span class="_ _13"> </span>to<span class="_ _6"> </span>format<span class="_ _13"> </span>a<span class="_ _6"> </span>string<span class="_ _13"> </span>in<span class="_ _6"> </span>memory<span class="_ _3"></span>,<span class="_ _13"> </span>and<span class="_ _6"> </span>then</div><div class="t m5 x17 h26 y796d ff7 fs19 fc2 sc0 ls0 ws0">send<span class="_ _14"> </span>it<span class="_ _14"> </span>to<span class="_ _14"> </span>the<span class="_ _14"> </span>socket<span class="_ _16"> </span>using<span class="_ _15"> </span><span class="ffd">rio_writen</span>.<span class="_ _14"> </span>If<span class="_ _16"> </span>you<span class="_ _14"> </span>need<span class="_ _14"> </span>formatted<span class="_ _14"> </span>input,<span class="_ _15"> </span>use<span class="_ _14"> </span><span class="ffd">rio_</span></div><div class="t m5 x17 h26 y796e ffd fs19 fc2 sc0 ls0 ws0">readlineb<span class="_ _16"> </span><span class="ff7">to<span class="_ _14"> </span>read<span class="_ _16"> </span>an<span class="_ _14"> </span>entire<span class="_ _16"> </span>text<span class="_ _14"> </span>line<span class="_ _0"></span>,<span class="_ _14"> </span>and<span class="_ _16"> </span>then<span class="_ _14"> </span>use<span class="_ _16"> </span><span class="ffd">sscanf<span class="_ _14"> </span></span>to<span class="_ _16"> </span>extract<span class="_ _14"> </span>different</span></div><div class="t m5 x17 h26 y796f ff7 fs19 fc2 sc0 ls0 ws0">ﬁelds<span class="_"> </span>from<span class="_"> </span>the<span class="_"> </span>text<span class="_"> </span>line<span class="_ _1"></span>.</div><div class="t m5 x17 h3b ycc6 fff fs24 fc6 sc0 ls0 ws0">10.12</div><div class="t m5 x26f h3e y441 ffe fs18 fc6 sc0 ls0 ws0">Summary</div><div class="t m5 x17 h26 y21f4 ff7 fs19 fc1 sc0 ls0 ws0">Linux<span class="_"> </span>provides<span class="_ _11"> </span>a<span class="_ _11"> </span>small<span class="_ _11"> </span>number<span class="_ _11"> </span>of<span class="_ _11"> </span>system-level<span class="_"> </span>functions<span class="_ _0"></span>,<span class="_"> </span>based<span class="_ _11"> </span>on<span class="_ _11"> </span>the<span class="_ _11"> </span>Unix<span class="_ _11"> </span>I/O</div><div class="t m5 x17 h26 y21f5 ff7 fs19 fc1 sc0 ls0 ws0">model,<span class="_ _14"> </span>that<span class="_ _14"> </span>allow<span class="_ _14"> </span>applications<span class="_ _14"> </span>to<span class="_ _16"> </span>open,<span class="_ _15"> </span>close<span class="_ _0"></span>,<span class="_ _14"> </span>read,<span class="_ _15"> </span>and<span class="_ _14"> </span>write<span class="_ _14"> </span>ﬁles<span class="_ _1"></span>,<span class="_ _14"> </span>to<span class="_ _14"> </span>fetch<span class="_ _14"> </span>ﬁle</div><div class="t m5 x17 h26 y21f6 ff7 fs19 fc1 sc0 ls0 ws0">metadata,<span class="_ _14"> </span>and<span class="_ _16"> </span>to<span class="_ _16"> </span>perform<span class="_ _16"> </span>I/O<span class="_ _14"> </span>redirection.<span class="_ _16"> </span>Linux<span class="_ _16"> </span>read<span class="_ _16"> </span>and<span class="_ _14"> </span>write<span class="_ _16"> </span>operations<span class="_ _16"> </span>are</div><div class="t m5 x17 h26 y21f7 ff7 fs19 fc1 sc0 ls0 ws0">subject<span class="_ _15"> </span>to<span class="_ _21"> </span>short<span class="_ _15"> </span>counts<span class="_ _21"> </span>that<span class="_ _21"> </span>applications<span class="_ _15"> </span>must<span class="_ _21"> </span>anticipate<span class="_ _21"> </span>and<span class="_ _15"> </span>handle<span class="_ _21"> </span>correctly<span class="_ _3"></span>.</div><div class="t m5 x17 h26 y21f8 ff7 fs19 fc1 sc0 ls0 ws0">Instead<span class="_"> </span>of<span class="_ _13"> </span>calling<span class="_"> </span>the<span class="_"> </span>Unix<span class="_ _13"> </span>I/O<span class="_"> </span>functions<span class="_"> </span>directly<span class="_ _7"></span>,<span class="_"> </span>applications<span class="_"> </span>should<span class="_ _13"> </span>use<span class="_"> </span>the<span class="_"> </span><span class="ff9">Rio</span></div><div class="t m5 x17 h26 y21f9 ff7 fs19 fc1 sc0 ls0 ws0">package<span class="_ _1"></span>,<span class="_ _14"> </span>which<span class="_ _16"> </span>deals<span class="_ _16"> </span>with<span class="_ _16"> </span>short<span class="_ _16"> </span>counts<span class="_ _16"> </span>automatically<span class="_ _16"> </span>by<span class="_ _16"> </span>repeatedly<span class="_ _16"> </span>performing</div><div class="t m5 x17 h26 y2214 ff7 fs19 fc1 sc0 ls0 ws0">read<span class="_"> </span>and<span class="_"> </span>write<span class="_"> </span>operations<span class="_"> </span>until<span class="_"> </span>all<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>requested<span class="_"> </span>data<span class="_"> </span>have<span class="_"> </span>been<span class="_"> </span>transferred.</div><div class="t m5 x26 h26 y2215 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _14"> </span>Linux<span class="_ _16"> </span>kernel<span class="_ _16"> </span>uses<span class="_ _16"> </span>three<span class="_ _14"> </span>related<span class="_ _16"> </span>data<span class="_ _16"> </span>structures<span class="_ _14"> </span>to<span class="_ _16"> </span>represent<span class="_ _16"> </span>open<span class="_ _14"> </span>ﬁles<span class="_ _1"></span>.</div><div class="t m5 x17 h26 y2216 ff7 fs19 fc1 sc0 ls0 ws0">Entries<span class="_ _16"> </span>in<span class="_ _14"> </span>a<span class="_ _16"> </span>descriptor<span class="_ _14"> </span>table<span class="_ _14"> </span>point<span class="_ _16"> </span>to<span class="_ _14"> </span>entries<span class="_ _16"> </span>in<span class="_ _14"> </span>the<span class="_ _14"> </span>open<span class="_ _16"> </span>ﬁle<span class="_ _14"> </span>table<span class="_ _0"></span>,<span class="_ _14"> </span>which<span class="_ _14"> </span>point</div><div class="t m5 x17 h26 y2217 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _11"> </span>entries<span class="_ _11"> </span>in<span class="_ _16"> </span>the<span class="_"> </span>v-node<span class="_ _16"> </span>table<span class="_ _1"></span>.<span class="_ _11"> </span>Each<span class="_ _16"> </span>process<span class="_ _11"> </span>has<span class="_ _11"> </span>its<span class="_ _11"> </span>own<span class="_ _16"> </span>distinct<span class="_"> </span>descriptor<span class="_ _16"> </span>table<span class="_ _1"></span>,</div><div class="t m5 x17 h26 y2218 ff7 fs19 fc1 sc0 ls0 ws0">while<span class="_ _13"> </span>all<span class="_"> </span>processes<span class="_ _13"> </span>share<span class="_ _13"> </span>the<span class="_"> </span>same<span class="_ _13"> </span>open<span class="_ _13"> </span>ﬁle<span class="_"> </span>and<span class="_ _13"> </span>v-node<span class="_ _13"> </span>tables<span class="_ _1"></span>.<span class="_"> </span>Understanding<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y2219 ff7 fs19 fc1 sc0 ls0 ws0">general<span class="_ _16"> </span>organization<span class="_ _14"> </span>of<span class="_ _14"> </span>these<span class="_ _14"> </span>structures<span class="_ _14"> </span>clariﬁes<span class="_ _14"> </span>our<span class="_ _14"> </span>understanding<span class="_ _16"> </span>of<span class="_ _14"> </span>both<span class="_ _14"> </span>ﬁle</div><div class="t m5 x17 h26 y221a ff7 fs19 fc1 sc0 ls0 ws0">sharing<span class="_"> </span>and<span class="_"> </span>I/O<span class="_"> </span>redirection.</div><div class="t m5 x26 h26 y221b ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>standard<span class="_ _11"> </span>I/O<span class="_ _16"> </span>library<span class="_ _11"> </span>is<span class="_ _11"> </span>implemented<span class="_ _16"> </span>on<span class="_ _11"> </span>top<span class="_ _16"> </span>of<span class="_ _11"> </span>Unix<span class="_ _16"> </span>I/O<span class="_ _11"> </span>and<span class="_ _11"> </span>provides<span class="_ _16"> </span>a</div><div class="t m5 x17 h26 y221c ff7 fs19 fc1 sc0 ls0 ws0">powerful<span class="_ _6"> </span>set<span class="_ _13"> </span>of<span class="_ _6"> </span>higher<span class="_ _1"></span>-level<span class="_ _13"> </span>I/O<span class="_ _6"> </span>routines<span class="_ _1"></span>.<span class="_ _13"> </span>F<span class="_ _3"></span>or<span class="_ _13"> </span>most<span class="_ _6"> </span>applications<span class="_ _1"></span>,<span class="_ _13"> </span>standard<span class="_ _6"> </span>I/O<span class="_ _13"> </span>is<span class="_ _6"> </span>the</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
