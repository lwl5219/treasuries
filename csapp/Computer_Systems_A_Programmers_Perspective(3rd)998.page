<div id="pf3e6" class="pf w2 h11" data-page-no="3e6"><div class="pc pc3e6 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3e6.png"/><div class="t m5 x23d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>11.6<span class="_ _60"> </span>Putting<span class="_ _10"> </span>It<span class="_ _10"> </span>T<span class="_ _1"></span>ogether:<span class="_ _10"> </span>The<span class="_ _10"> </span><span class="ff1b ls2e5">Ti<span class="_ _2"></span>n<span class="_ _5"> </span>y<span class="_ _16"> </span></span>W<span class="_ _1"></span>eb<span class="_ _10"> </span>Server<span class="_ _3e"> </span><span class="ffe fs1e">997</span></div><div class="t m5 x3a h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x2c h2e y280 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x2d h2d yad1 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>parse_uri(char<span class="_ _1f"> </span>*uri,<span class="_ _1f"> </span>char<span class="_ _e"> </span>*filename,<span class="_ _1f"> </span>char<span class="_ _e"> </span>*cgiargs)</div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d yad2 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _20"> </span><span class="ffd fs1e fc2">char<span class="_ _e"> </span>*ptr;</span></div><div class="t m5 x2c h2e yad3 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2c h2e y61b4 ff6 fs20 fc6 sc0 ls0 ws0">5</div><div class="t m5 x142 h2d y285 ffd fs1e fc2 sc0 ls0 ws0">if<span class="_ _e"> </span>(!strstr(uri,<span class="_ _1f"> </span>&quot;cgi-bin&quot;))<span class="_ _1f"> </span>{<span class="_ _3b"> </span>/*<span class="_ _1f"> </span>Static<span class="_ _1f"> </span>content<span class="_ _e"> </span>*/</div><div class="t m5 x2c h2d yad4 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _70"> </span><span class="ffd fs1e fc2">strcpy(cgiargs,<span class="_ _e"> </span>&quot;&quot;);</span></div><div class="t m5 x2c h2d yad5 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _70"> </span><span class="ffd fs1e fc2">strcpy(filename,<span class="_ _e"> </span>&quot;.&quot;);</span></div><div class="t m5 x2c h2d yad6 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _70"> </span><span class="ffd fs1e fc2">strcat(filename,<span class="_ _e"> </span>uri);</span></div><div class="t m5 x2c h2d y496b ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(uri[strlen(uri)-1]<span class="_ _1f"> </span>==<span class="_ _1f"> </span>’/’)</span></div><div class="t m5 x17 h2d y50d4 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _d1"> </span><span class="ffd fs1e fc2">strcat(filename,<span class="_ _1f"> </span>&quot;home.html&quot;);</span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>1;</span></div><div class="t m5 x17 h2d y61b6 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y2181 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">else<span class="_ _e"> </span>{<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Dynamic<span class="_ _1f"> </span>content<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2d y554b ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _70"> </span><span class="ffd fs1e fc2">ptr<span class="_ _e"> </span>=<span class="_ _1f"> </span>index(uri,<span class="_ _1f"> </span>’?’);</span></div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(ptr)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _d1"> </span><span class="ffd fs1e fc2">strcpy(cgiargs,<span class="_ _1f"> </span>ptr+1);</span></div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _d1"> </span><span class="ffd fs1e fc2">*ptr<span class="_ _1f"> </span>=<span class="_ _e"> </span>’\0’;</span></div><div class="t m5 x17 h2d y3ec ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _70"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _70"> </span><span class="ffd fs1e fc2">else</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _d1"> </span><span class="ffd fs1e fc2">strcpy(cgiargs,<span class="_ _1f"> </span>&quot;&quot;);</span></div><div class="t m5 x17 h2d y1ada ff6 fs20 fc6 sc0 ls0 ws0">21<span class="_ _70"> </span><span class="ffd fs1e fc2">strcpy(filename,<span class="_ _e"> </span>&quot;.&quot;);</span></div><div class="t m5 x17 h2d y61b9 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _70"> </span><span class="ffd fs1e fc2">strcat(filename,<span class="_ _e"> </span>uri);</span></div><div class="t m5 x17 h2d y3228 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _70"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>0;</span></div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x17 h2d y3229 ff6 fs20 fc6 sc0 ls0 ws0">25<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x3a h2c y73ed ffa fs16 fc2 sc0 ls0 ws0">code/netp/tiny/tiny<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y73ee ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>11.33<span class="_ _66"> </span><span class="ff1b fc1 ls2e6">Ti<span class="_ _5"></span>n<span class="_ _5"></span>y</span></div><div class="t m5 x13 h3a y5eb5 ffd fs19 fc1 sc0 ls0 ws0">parse_uri<span class="_ _10"> </span><span class="ffe fs16">parses<span class="_"> </span>an<span class="_"> </span>HTTP<span class="_"> </span>URI.</span></div><div class="t m5 x17 h42 y646e ff6 fs29 fc6 sc0 ls0 ws0">The<span class="_ _11"> </span><span class="ffd fs2b">serve_static<span class="_ _16"> </span></span>Function</div><div class="t m5 x17 h26 y6fe ff9 fs19 fc1 sc0 ls0 ws0">T<span class="_ _3"></span>iny<span class="_ _14"> </span><span class="ff7">serves<span class="_ _16"> </span>ﬁve<span class="_ _14"> </span>common<span class="_ _14"> </span>types<span class="_ _16"> </span>of<span class="_ _14"> </span>static<span class="_ _14"> </span>content:<span class="_ _16"> </span>HTML<span class="_ _14"> </span>ﬁles<span class="_ _1"></span>,<span class="_ _15"> </span>unformatted<span class="_ _16"> </span>text</span></div><div class="t m5 x17 h26 y6ff ff7 fs19 fc1 sc0 ls0 ws0">ﬁles<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>images<span class="_"> </span>encoded<span class="_"> </span>in<span class="_"> </span>GIF<span class="_ _7"></span>,<span class="_"> </span>PNG<span class="_ _1"></span>,<span class="_"> </span>and<span class="_"> </span>JPEG<span class="_"> </span>formats<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y700 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">serve_static<span class="_ _11"> </span><span class="ff7">function<span class="_"> </span>in<span class="_ _11"> </span>Figure<span class="_"> </span>11.34<span class="_ _11"> </span>sends<span class="_ _11"> </span>an<span class="_ _11"> </span>HTTP<span class="_"> </span>response<span class="_ _11"> </span>whose</span></span></div><div class="t m5 x17 h26 y701 ff7 fs19 fc1 sc0 ls0 ws0">body<span class="_ _15"> </span>contains<span class="_ _15"> </span>the<span class="_ _21"> </span>contents<span class="_ _15"> </span>of<span class="_ _21"> </span>a<span class="_ _15"> </span>local<span class="_ _15"> </span>ﬁle.<span class="_ _15"> </span>F<span class="_ _1"></span>irst,<span class="_ _f"> </span>we<span class="_ _15"> </span>determine<span class="_ _21"> </span>the<span class="_ _15"> </span>ﬁle<span class="_ _21"> </span>type<span class="_ _15"> </span>by</div><div class="t m5 x17 h26 y702 ff7 fs19 fc1 sc0 ls0 ws0">inspecting<span class="_"> </span>the<span class="_ _11"> </span>sufﬁx<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>ﬁlename<span class="_ _11"> </span>(line<span class="_ _11"> </span>7)<span class="_ _11"> </span>and<span class="_ _11"> </span>then<span class="_ _11"> </span>send<span class="_ _11"> </span>the<span class="_ _11"> </span>response<span class="_ _11"> </span>line<span class="_ _11"> </span>and</div><div class="t m5 x17 h26 y703 ff7 fs19 fc1 sc0 ls0 ws0">response<span class="_ _13"> </span>headers<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_"> </span>client<span class="_ _13"> </span>(lines<span class="_ _13"> </span>8–13).<span class="_ _13"> </span>Notice<span class="_ _13"> </span>that<span class="_ _13"> </span>a<span class="_"> </span>blank<span class="_ _13"> </span>line<span class="_ _13"> </span>terminates<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y704 ff7 fs19 fc1 sc0 ls0 ws0">headers<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y705 ff7 fs19 fc1 sc0 ls0 ws0">Next,<span class="_ _13"> </span>we<span class="_ _13"> </span>send<span class="_ _13"> </span>the<span class="_ _13"> </span>response<span class="_ _13"> </span>body<span class="_ _13"> </span>by<span class="_ _13"> </span>copying<span class="_"> </span>the<span class="_ _13"> </span>contents<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>requested<span class="_ _13"> </span>ﬁle</div><div class="t m5 x17 h26 y706 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _13"> </span>the<span class="_"> </span>connected<span class="_ _13"> </span>descriptor<span class="_ _13"> </span><span class="ffd">fd</span>.<span class="_ _13"> </span>T<span class="_ _0"></span>he<span class="_ _13"> </span>code<span class="_"> </span>here<span class="_ _13"> </span>is<span class="_ _13"> </span>somewhat<span class="_ _13"> </span>subtle<span class="_"> </span>and<span class="_ _13"> </span>needs<span class="_ _13"> </span>to<span class="_ _13"> </span>be</div><div class="t m5 x17 h26 y707 ff7 fs19 fc1 sc0 ls0 ws0">studied<span class="_ _11"> </span>carefully<span class="_ _3"></span>.<span class="_ _11"> </span>Line<span class="_ _16"> </span>18<span class="_ _11"> </span>opens<span class="_ _11"> </span><span class="ffd">filename<span class="_ _16"> </span></span>for<span class="_ _11"> </span>reading<span class="_ _16"> </span>and<span class="_ _11"> </span>gets<span class="_ _11"> </span>its<span class="_ _16"> </span>descriptor<span class="_ _0"></span>.<span class="_ _11"> </span>In</div><div class="t m5 x17 h26 y708 ff7 fs19 fc1 sc0 ls0 ws0">line<span class="_ _13"> </span>19,<span class="_"> </span>the<span class="_ _13"> </span>Linux<span class="_ _13"> </span><span class="ffd">mmap<span class="_ _10"> </span></span>function<span class="_ _13"> </span>maps<span class="_ _13"> </span>the<span class="_"> </span>requested<span class="_ _13"> </span>ﬁle<span class="_ _13"> </span>to<span class="_"> </span>a<span class="_ _13"> </span>virtual<span class="_ _13"> </span>memory<span class="_"> </span>area.</div><div class="t m5 x17 h26 y709 ff7 fs19 fc1 sc0 ls0 ws0">Recall<span class="_ _11"> </span>from<span class="_ _16"> </span>our<span class="_ _11"> </span>discussion<span class="_ _16"> </span>of<span class="_ _16"> </span><span class="ffd">mmap<span class="_ _11"> </span></span>in<span class="_ _16"> </span>Section<span class="_ _11"> </span>9.8<span class="_ _16"> </span>that<span class="_ _11"> </span>the<span class="_ _16"> </span>call<span class="_ _11"> </span>to<span class="_ _16"> </span><span class="ffd">mmap<span class="_ _11"> </span></span>maps<span class="_ _16"> </span>the</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
