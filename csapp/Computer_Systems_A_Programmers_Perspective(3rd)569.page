<div id="pf239" class="pf w2 h11" data-page-no="239"><div class="pc pc239 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg239.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">568<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x1f h2d y4a2c ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2 ls33">/<span class="_ _41"></span>*2x1<span class="ls0">loop<span class="_ _1f"> </span>unrolling<span class="_ _e"> </span>*/</span></span></div><div class="t m5 x1f h2d y4a2d ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>combine5(vec_ptr<span class="_ _e"> </span>v,<span class="_ _1f"> </span>data_t<span class="_ _1f"> </span>*dest)</span></div><div class="t m5 x1f h2d y4a2e ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2e y4a2f ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x33 h2d y4a30 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>i;</div><div class="t m5 x1f h2d y4a31 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>length<span class="_ _1f"> </span>=<span class="_ _1f"> </span>vec_length(v);</span></div><div class="t m5 x1f h2d y4a32 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>limit<span class="_ _1f"> </span>=<span class="_ _1f"> </span>length-1;</span></div><div class="t m5 x1f h2d y4a33 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>*data<span class="_ _1f"> </span>=<span class="_ _1f"> </span>get_vec_start(v);</span></div><div class="t m5 x1f h2d y4a34 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _20"> </span><span class="ffd fs1e fc2">data_t<span class="_ _e"> </span>acc<span class="_ _1f"> </span>=<span class="_ _1f"> </span>IDENT;</span></div><div class="t m5 x1f h2e y4a35 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1b0 h2e y4a36 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x33 h2d y4a37 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Combine<span class="_ _1f"> </span>2<span class="_ _1f"> </span>elements<span class="_ _e"> </span>at<span class="_ _1f"> </span>a<span class="_ _e"> </span>time<span class="_ _1f"> </span>*/</div><div class="t m5 x1b0 h2d y4a38 ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>0;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>limit;<span class="_ _1f"> </span>i+=2)<span class="_ _1f"> </span>{</span></div><div class="t m5 x1b0 h2d y4a39 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">acc<span class="_ _e"> </span>=<span class="_ _1f"> </span>(acc<span class="_ _1f"> </span>OP<span class="_ _e"> </span>data[i])<span class="_ _1f"> </span>OP<span class="_ _e"> </span>data[i+1];</span></div><div class="t m5 x1b0 h2d y4a3a ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2e y4a3b ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x1b0 h2e y4d14 ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x33 h2d y4a3c ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Finish<span class="_ _1f"> </span>any<span class="_ _1f"> </span>remaining<span class="_ _e"> </span>elements<span class="_ _1f"> </span>*/</div><div class="t m5 x1b0 h2d y4a3d ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _20"> </span><span class="ffd fs1e fc2">for<span class="_ _e"> </span>(;<span class="_ _1f"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>length;<span class="_ _1f"> </span>i++)<span class="_ _e"> </span>{</span></div><div class="t m5 x1b0 h2d y4a3e ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _70"> </span><span class="ffd fs1e fc2">acc<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc<span class="_ _1f"> </span>OP<span class="_ _e"> </span>data[i];</span></div><div class="t m5 x1b0 h2d y4a3f ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d y4a40 ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _20"> </span><span class="ffd fs1e fc2">*dest<span class="_ _e"> </span>=<span class="_ _1f"> </span>acc;</span></div><div class="t m5 x1b0 h2d y4a41 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1d h35 y4d15 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>5.16<span class="_ _c"> </span><span class="fc1">Applying<span class="_"> </span><span class="ff7">2<span class="_"> </span><span class="ff12">×<span class="_ _13"></span></span>1<span class="_"> </span></span>loop<span class="_"> </span>unrolling.<span class="_"> </span><span class="ff6">This<span class="_ _11"> </span>transformation<span class="_ _11"> </span>can<span class="_ _10"> </span>reduce<span class="_ _11"> </span>the<span class="_ _11"> </span>effect</span></span></div><div class="t m5 x1d h34 y4d16 ff6 fs16 fc1 sc0 ls0 ws0">of<span class="_ _10"> </span>loop<span class="_ _11"> </span>overhead.</div><div class="t m5 x1d h26 y4d17 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>optionally<span class="_"> </span>add<span class="_"> </span>a<span class="_"> </span>ﬁnal<span class="_"> </span>iteration,<span class="_"> </span>as<span class="_"> </span>we<span class="_"> </span>did<span class="_ _13"> </span>with<span class="_"> </span>the<span class="_"> </span>function<span class="_"> </span><span class="ffd">psum2<span class="_ _10"> </span></span>(Figure<span class="_ _13"> </span>5.1).</div><div class="t m5 x1d h26 y4d18 ff7 fs19 fc1 sc0 ls73 ws0">Fo<span class="_ _2"></span>r<span class="_ _15"> </span><span class="ff11 ls217">k&gt;<span class="_ _0"></span><span class="ff7 ls0">2,<span class="_ _16"> </span>the<span class="_ _16"> </span>ﬁnishing<span class="_ _16"> </span>cases<span class="_ _16"> </span>are<span class="_ _16"> </span>better<span class="_ _16"> </span>expressed<span class="_ _16"> </span>with<span class="_ _16"> </span>a<span class="_ _16"> </span>loop<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _16"> </span>so<span class="_ _16"> </span>we<span class="_ _16"> </span>adopt</span></span></div><div class="t m5 x1d h46 y4d19 ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>programming<span class="_ _13"> </span>convention<span class="_"> </span>for<span class="_ _13"> </span><span class="ff11">k<span class="_ _10"> </span><span class="ff12">=<span class="_ _10"> </span></span></span>2<span class="_"> </span>as<span class="_ _13"> </span>well.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_ _13"> </span>refer<span class="_"> </span>to<span class="_ _13"> </span>this<span class="_"> </span>transformation<span class="_"> </span>as</div><div class="t m5 x1d h46 y4d1a ff7 fs19 fc1 sc0 ls0 ws0">“<span class="ff11">k<span class="_ _10"> </span><span class="ff12">×<span class="_ _10"> </span></span></span>1<span class="_ _13"> </span>loop<span class="_ _13"> </span>unrolling,<span class="_ _1"></span>”<span class="_"> </span>since<span class="_"> </span>we<span class="_"> </span>unroll<span class="_ _13"> </span>by<span class="_"> </span>a<span class="_"> </span>factor<span class="_"> </span>of<span class="_"> </span><span class="ff11">k<span class="_ _10"> </span></span>but<span class="_"> </span>accumulate<span class="_"> </span>values<span class="_"> </span>in<span class="_ _13"> </span>a</div><div class="t m5 x1d h26 y4d1b ff7 fs19 fc1 sc0 ls0 ws0">single<span class="_"> </span>variable<span class="_"> </span><span class="ffd">acc</span>.</div><div class="t m5 x1d h47 y4d1c ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>5.7<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>611)</span></div><div class="t m5 x1d h46 y4d1d ff7 fs19 fc1 sc0 ls0 ws0">Modify<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span><span class="ffd">combine5<span class="_ _10"> </span></span>to<span class="_"> </span>unroll<span class="_"> </span>the<span class="_"> </span>loop<span class="_"> </span>by<span class="_"> </span>a<span class="_"> </span>factor<span class="_"> </span><span class="ff11">k<span class="_ _10"> </span><span class="ff12">=<span class="_ _10"> </span></span></span><span class="ls97">5.</span></div><div class="t m5 x29 h26 y4d1e ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _14"> </span>we<span class="_ _15"> </span>measure<span class="_ _21"> </span>the<span class="_ _15"> </span>performance<span class="_ _15"> </span>of<span class="_ _15"> </span>unrolled<span class="_ _15"> </span>code<span class="_ _15"> </span>for<span class="_ _21"> </span>unrolling<span class="_ _15"> </span>factors</div><div class="t m5 x1d h46 y4d1f ff11 fs19 fc1 sc0 ls0 ws0">k<span class="_ _10"> </span><span class="ff12">=<span class="_ _10"> </span><span class="ff7 ls218">2(<span class="_ _49"></span><span class="ffd ls0">combine5<span class="ff7">)<span class="_"> </span>and<span class="_"> </span><span class="ff11">k<span class="_ _11"> </span><span class="ff12">=<span class="_ _10"> </span></span></span>3<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>get<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>results:</span></span></span></span></div><div class="t m5 xfb h31 y4d20 ff7 fs21 fc2 sc0 ls0 ws0">Integer<span class="_ _ba"> </span>Floating<span class="_"> </span>point</div><div class="t m5 x1d h31 y4d21 ff7 fs21 fc2 sc0 ls0 ws0">Function<span class="_ _76"> </span>Page<span class="_ _26"> </span>Method<span class="_ _1d5"> </span><span class="ffd fs1e ls20c">+*+*</span></div><div class="t m5 x1d h31 y4d22 ffd fs1e fc2 sc0 ls0 ws0">combine4<span class="_ _73"> </span><span class="ff7 fs21">551<span class="_ _61"> </span>No<span class="_"> </span>unrolling<span class="_ _2c"> </span>1.27<span class="_ _4f"> </span>3.01<span class="_ _14a"> </span>3.01<span class="_ _14a"> </span>5.01</span></div><div class="t m5 x1d h32 y4d23 ffd fs1e fc2 sc0 ls0 ws0">combine5<span class="_ _73"> </span><span class="ff7 fs21">568<span class="_ _61"> </span>2<span class="_"> </span><span class="ff12">×<span class="_ _13"> </span></span>1<span class="_ _13"> </span>unrolling<span class="_ _74"> </span>1.01<span class="_ _4f"> </span>3.01<span class="_ _14a"> </span>3.01<span class="_ _14a"> </span>5.01</span></div><div class="t m5 x167 h32 y4d24 ff7 fs21 fc2 sc0 ls0 ws0">3<span class="_ _13"> </span><span class="ff12">×<span class="_ _13"></span></span>1<span class="_ _6"> </span>unrolling<span class="_ _93"> </span>1.01<span class="_ _14a"> </span>3.01<span class="_ _14a"> </span>3.01<span class="_ _14a"> </span>5.01</div><div class="t m5 x1d h31 y4d25 ff7 fs21 fc2 sc0 ls0 ws0">Latency<span class="_"> </span>bound<span class="_ _d2"> </span>1.00<span class="_ _14a"> </span>3.00<span class="_ _14a"> </span>3.00<span class="_ _14a"> </span>5.00</div><div class="t m5 x1d h31 y4d26 ff7 fs21 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hroughput<span class="_"> </span>bound<span class="_ _136"> </span>0.50<span class="_ _4f"> </span>1.00<span class="_ _14a"> </span>1.00<span class="_ _14a"> </span>0.50</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
