<div id="pf1e8" class="pf w2 h11" data-page-no="1e8"><div class="pc pc1e8 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg1e8.png"/><div class="t m5 x13d h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>4.5<span class="_ _60"> </span>Pipelined<span class="_ _10"> </span>Y86-64<span class="_ _10"> </span>Implementations<span class="_ _3e"> </span><span class="ffe fs1e">487</span></div><div class="t m5 x17 h31 y9c ff7 fs21 fc2 sc0 ls0 ws0">Data<span class="_"> </span>word<span class="_ _26"> </span>Register<span class="_"> </span>ID<span class="_ _26"> </span>Source<span class="_"> </span>description</div><div class="t m5 x17 h31 y9ba ff6 fs21 fc2 sc0 ls0 ws0">e_valE<span class="_ _f4"> </span>e_dstE<span class="_ _148"> </span><span class="ff7">ALU<span class="_"> </span>output</span></div><div class="t m5 x17 h31 y43ee ff6 fs21 fc2 sc0 ls0 ws0">m_valM<span class="_ _2e"> </span>M_dstM<span class="_ _2c"> </span><span class="ff7">Memory<span class="_"> </span>output</span></div><div class="t m5 x17 h31 y43ef ff6 fs21 fc2 sc0 ls0 ws0">M_valE<span class="_ _2c"> </span>M_dstE<span class="_ _f4"> </span><span class="ff7">Pending<span class="_"> </span>write<span class="_"> </span>to<span class="_"> </span>port<span class="_"> </span>E<span class="_"> </span>in<span class="_"> </span>memory<span class="_"> </span>stage</span></div><div class="t m5 x17 h31 y43f0 ff6 fs21 fc2 sc0 ls0 ws0">W_valM<span class="_ _119"> </span>W_dstM<span class="_ _2c"> </span><span class="ff7">Pending<span class="_"> </span>write<span class="_"> </span>to<span class="_"> </span>port<span class="_"> </span>M<span class="_"> </span>in<span class="_"> </span>write-back<span class="_"> </span>stage</span></div><div class="t m5 x17 h31 y43f1 ff6 fs21 fc2 sc0 ls0 ws0">W_valE<span class="_ _2c"> </span>W_dstE<span class="_ _f4"> </span><span class="ff7">Pending<span class="_"> </span>write<span class="_"> </span>to<span class="_"> </span>port<span class="_"> </span>E<span class="_"> </span>in<span class="_"> </span>write-back<span class="_"> </span>stage</span></div><div class="t m5 x26 h26 y43f2 ff7 fs19 fc2 sc0 ls0 ws0">If<span class="_ _13"> </span>none<span class="_ _13"> </span>of<span class="_ _6"> </span>the<span class="_ _13"> </span>forwarding<span class="_ _13"> </span>conditions<span class="_ _13"> </span>hold,<span class="_ _13"> </span>the<span class="_ _13"> </span>block<span class="_ _6"> </span>should<span class="_ _13"> </span>select<span class="_ _13"> </span><span class="ff6">d_rvalA</span>,<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 y43f3 ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_"> </span>read<span class="_"> </span>from<span class="_"> </span>register<span class="_"> </span>port<span class="_"> </span>A,<span class="_"> </span>as<span class="_"> </span>its<span class="_"> </span>output.</div><div class="t m5 x26 h26 y43f4 ff7 fs19 fc2 sc0 ls0 ws0">Putting<span class="_"> </span>all<span class="_ _13"> </span>of<span class="_"> </span>this<span class="_ _13"> </span>together,<span class="_ _13"> </span>we<span class="_"> </span>get<span class="_ _13"> </span>the<span class="_"> </span>following<span class="_ _13"> </span>HCL<span class="_"> </span>description<span class="_ _13"> </span>for<span class="_"> </span>the<span class="_ _13"> </span>new</div><div class="t m5 x17 h26 y43f5 ff7 fs19 fc2 sc0 ls0 ws0">value<span class="_"> </span>of<span class="_"> </span><span class="ff6">valA<span class="_ _10"> </span></span>for<span class="_"> </span>pipeline<span class="_"> </span>register<span class="_"> </span>E:</div><div class="t m5 x17 h2d y43f6 ffd fs1e fc2 sc0 ls0 ws0">word<span class="_ _e"> </span>d_valA<span class="_ _1f"> </span>=<span class="_ _1f"> </span>[</div><div class="t m5 x21e h2d y43f7 ffd fs1e fc2 sc0 ls0 ws0">D_icode<span class="_ _e"> </span>in<span class="_ _1f"> </span>{<span class="_ _1f"> </span>ICALL,<span class="_ _e"> </span>IJXX<span class="_ _1f"> </span>}<span class="_ _e"> </span>:<span class="_ _1f"> </span>D_valP;<span class="_ _1f"> </span>#<span class="_ _e"> </span>Use<span class="_ _1f"> </span>incremented<span class="_ _e"> </span>PC</div><div class="t m5 x21e h2d y43f8 ffd fs1e fc2 sc0 ls0 ws0">d_srcA<span class="_ _e"> </span>==<span class="_ _1f"> </span>e_dstE<span class="_ _1f"> </span>:<span class="_ _e"> </span>e_valE;<span class="_ _46"> </span>#<span class="_ _1f"> </span>Forward<span class="_ _e"> </span>valE<span class="_ _1f"> </span>from<span class="_ _1f"> </span>execute</div><div class="t m5 x21e h2d y43f9 ffd fs1e fc2 sc0 ls0 ws0">d_srcA<span class="_ _e"> </span>==<span class="_ _1f"> </span>M_dstM<span class="_ _1f"> </span>:<span class="_ _e"> </span>m_valM;<span class="_ _46"> </span>#<span class="_ _1f"> </span>Forward<span class="_ _e"> </span>valM<span class="_ _1f"> </span>from<span class="_ _1f"> </span>memory</div><div class="t m5 x21e h2d y43fa ffd fs1e fc2 sc0 ls0 ws0">d_srcA<span class="_ _e"> </span>==<span class="_ _1f"> </span>M_dstE<span class="_ _1f"> </span>:<span class="_ _e"> </span>M_valE;<span class="_ _46"> </span>#<span class="_ _1f"> </span>Forward<span class="_ _e"> </span>valE<span class="_ _1f"> </span>from<span class="_ _1f"> </span>memory</div><div class="t m5 x21e h2d y43fb ffd fs1e fc2 sc0 ls0 ws0">d_srcA<span class="_ _e"> </span>==<span class="_ _1f"> </span>W_dstM<span class="_ _1f"> </span>:<span class="_ _e"> </span>W_valM;<span class="_ _46"> </span>#<span class="_ _1f"> </span>Forward<span class="_ _e"> </span>valM<span class="_ _1f"> </span>from<span class="_ _1f"> </span>write<span class="_ _e"> </span>back</div><div class="t m5 x21e h2d y43fc ffd fs1e fc2 sc0 ls0 ws0">d_srcA<span class="_ _e"> </span>==<span class="_ _1f"> </span>W_dstE<span class="_ _1f"> </span>:<span class="_ _e"> </span>W_valE;<span class="_ _46"> </span>#<span class="_ _1f"> </span>Forward<span class="_ _e"> </span>valE<span class="_ _1f"> </span>from<span class="_ _1f"> </span>write<span class="_ _e"> </span>back</div><div class="t m5 x21e h2d y43fd ffd fs1e fc2 sc0 ls0 ws0">1<span class="_ _e"> </span>:<span class="_ _1f"> </span>d_rvalA;<span class="_ _1a"> </span>#<span class="_ _1f"> </span>Use<span class="_ _e"> </span>value<span class="_ _1f"> </span>read<span class="_ _e"> </span>from<span class="_ _1f"> </span>register<span class="_ _1f"> </span>file</div><div class="t m5 x17 h2d y43fe ffd fs1e fc2 sc0 ls0 ws0">];</div><div class="t m5 x26 h26 y2658 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _16"> </span>priority<span class="_ _16"> </span>given<span class="_ _16"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>ﬁve<span class="_ _16"> </span>forwarding<span class="_ _16"> </span>sources<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span>above<span class="_ _16"> </span>HCL<span class="_ _16"> </span>code<span class="_ _16"> </span>is</div><div class="t m5 x17 h26 y43ff ff7 fs19 fc2 sc0 ls0 ws0">very<span class="_ _13"> </span>important.<span class="_ _14"> </span>This<span class="_ _6"> </span>priority<span class="_ _13"> </span>is<span class="_ _13"> </span>determined<span class="_ _6"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>HCL<span class="_ _13"> </span>code<span class="_ _6"> </span>by<span class="_ _13"> </span>the<span class="_ _13"> </span>order<span class="_ _13"> </span>in<span class="_ _6"> </span>which</div><div class="t m5 x17 h26 y4400 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>ﬁve<span class="_ _13"> </span>destination<span class="_"> </span>register<span class="_ _13"> </span>IDs<span class="_"> </span>are<span class="_ _13"> </span>tested.<span class="_"> </span>If<span class="_ _13"> </span>any<span class="_"> </span>order<span class="_ _13"> </span>other<span class="_"> </span>than<span class="_ _13"> </span>the<span class="_"> </span>one<span class="_ _13"> </span>shown</div><div class="t m5 x17 h26 y4401 ff7 fs19 fc2 sc0 ls0 ws0">were<span class="_ _6"> </span>chosen,<span class="_ _6"> </span>the<span class="_ _6"> </span>pipeline<span class="_ _6"> </span>would<span class="_ _13"> </span>behave<span class="_ _a"> </span>incorrectly<span class="_ _6"> </span>for<span class="_ _6"> </span>some<span class="_ _6"> </span>programs<span class="_ _1"></span>.<span class="_ _6"> </span>Figure<span class="_ _a"> </span>4.59</div><div class="t m5 x17 h26 y4402 ff7 fs19 fc2 sc0 ls0 ws0">shows<span class="_"> </span>an<span class="_ _11"> </span>example<span class="_ _11"> </span>of<span class="_ _11"> </span>a<span class="_"> </span>program<span class="_ _11"> </span>that<span class="_ _11"> </span>requires<span class="_ _11"> </span>a<span class="_"> </span>correct<span class="_ _11"> </span>setting<span class="_ _11"> </span>of<span class="_ _11"> </span>priority<span class="_"> </span>among</div><div class="t m5 x17 h26 y4403 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>forwarding<span class="_ _14"> </span>sources<span class="_ _16"> </span>in<span class="_ _16"> </span>the<span class="_ _14"> </span>execute<span class="_ _16"> </span>and<span class="_ _14"> </span>memory<span class="_ _16"> </span>stages<span class="_ _1"></span>.<span class="_ _14"> </span>In<span class="_ _16"> </span>this<span class="_ _14"> </span>program,<span class="_ _14"> </span>the</div><div class="t m5 x17 h26 y4404 ff7 fs19 fc2 sc0 ls0 ws0">ﬁrst<span class="_"> </span>two<span class="_"> </span>instructions<span class="_ _13"> </span>write<span class="_"> </span>to<span class="_"> </span>register<span class="_"> </span><span class="ffd">%rdx</span>,<span class="_ _13"> </span>while<span class="_"> </span>the<span class="_"> </span>third<span class="_"> </span>uses<span class="_ _13"> </span>this<span class="_"> </span>register<span class="_"> </span>as<span class="_"> </span>its</div><div class="t m5 x17 h26 y4405 ff7 fs19 fc2 sc0 ls0 ws0">source<span class="_ _16"> </span>operand.<span class="_ _11"> </span>When<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffd">rrmovq<span class="_ _16"> </span></span>instruction<span class="_ _11"> </span>reaches<span class="_ _16"> </span>the<span class="_ _16"> </span>decode<span class="_ _11"> </span>stage<span class="_ _16"> </span>in<span class="_ _16"> </span>c<span class="_ _0"></span>ycle</div><div class="t m5 x17 h26 y4406 ff7 fs19 fc2 sc0 ls0 ws0">4,<span class="_ _14"> </span>the<span class="_ _16"> </span>forwarding<span class="_ _16"> </span>logic<span class="_ _14"> </span>must<span class="_ _16"> </span>choose<span class="_ _16"> </span>between<span class="_ _14"> </span>two<span class="_ _16"> </span>values<span class="_ _14"> </span>destined<span class="_ _16"> </span>for<span class="_ _16"> </span>its<span class="_ _14"> </span>source</div><div class="t m5 x17 h26 y4407 ff7 fs19 fc2 sc0 ls0 ws0">register.<span class="_ _16"> </span>Which<span class="_ _16"> </span>one<span class="_ _16"> </span>should<span class="_ _16"> </span>it<span class="_ _14"> </span>choose?<span class="_ _16"> </span>T<span class="_ _3"></span>o<span class="_ _16"> </span>set<span class="_ _14"> </span>the<span class="_ _16"> </span>priority<span class="_ _3"></span>,<span class="_ _14"> </span>we<span class="_ _14"> </span>must<span class="_ _16"> </span>consider<span class="_ _14"> </span>the</div><div class="t m5 x17 h26 y4408 ff7 fs19 fc2 sc0 ls0 ws0">behavior<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _16"> </span>machine-language<span class="_ _14"> </span>program<span class="_ _16"> </span>when<span class="_ _16"> </span>it<span class="_ _14"> </span>is<span class="_ _16"> </span>executed<span class="_ _14"> </span>one<span class="_ _16"> </span>instruction</div><div class="t m5 x17 h26 y4409 ff7 fs19 fc2 sc0 ls0 ws0">at<span class="_ _16"> </span>a<span class="_ _16"> </span>time<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>ﬁrst<span class="_ _16"> </span><span class="ffd">irmovq<span class="_ _16"> </span></span>instruction<span class="_ _16"> </span>would<span class="_ _16"> </span>set<span class="_ _16"> </span>register<span class="_ _11"> </span><span class="ffd">%rdx<span class="_ _16"> </span></span>to<span class="_ _16"> </span>10,<span class="_ _16"> </span>the<span class="_ _16"> </span>second</div><div class="t m5 x17 h26 y440a ff7 fs19 fc2 sc0 ls0 ws0">would<span class="_ _16"> </span>set<span class="_ _14"> </span>the<span class="_ _16"> </span>register<span class="_ _16"> </span>to<span class="_ _14"> </span>3,<span class="_ _14"> </span>and<span class="_ _16"> </span>then<span class="_ _14"> </span>the<span class="_ _16"> </span><span class="ffd">rrmovq<span class="_ _14"> </span></span>instruction<span class="_ _16"> </span>would<span class="_ _14"> </span>read<span class="_ _16"> </span>3<span class="_ _14"> </span>from</div><div class="t m5 x17 h26 y440b ffd fs19 fc2 sc0 ls0 ws0">%rdx<span class="ff7">.<span class="_"> </span>T<span class="_ _3"></span>o<span class="_"> </span>imitate<span class="_ _11"> </span>this<span class="_"> </span>behavior,<span class="_"> </span>our<span class="_ _11"> </span>pipelined<span class="_"> </span>implementation<span class="_ _11"> </span>should<span class="_"> </span>always<span class="_ _11"> </span>give</span></div><div class="t m5 x17 h26 y440c ff7 fs19 fc2 sc0 ls0 ws0">priority<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _11"> </span>forwarding<span class="_ _11"> </span>source<span class="_ _16"> </span>in<span class="_ _11"> </span>the<span class="_ _16"> </span>earliest<span class="_ _11"> </span>pipeline<span class="_ _11"> </span>stage,<span class="_ _11"> </span>since<span class="_ _16"> </span>it<span class="_ _11"> </span>holds<span class="_ _11"> </span>the</div><div class="t m5 x17 h26 y440d ff7 fs19 fc2 sc0 ls0 ws0">latest<span class="_ _6"> </span>instruction<span class="_ _6"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>program<span class="_ _a"> </span>sequence<span class="_ _6"> </span>setting<span class="_ _13"> </span>the<span class="_ _a"> </span>register.<span class="_ _6"> </span>T<span class="_ _1"></span>hus<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _6"> </span>logic<span class="_ _6"> </span>in<span class="_ _6"> </span>the</div><div class="t m5 x17 h26 y440e ff7 fs19 fc2 sc0 ls0 ws0">HCL<span class="_ _6"> </span>code<span class="_ _6"> </span>above<span class="_ _6"> </span>ﬁrst<span class="_ _6"> </span>tests<span class="_ _6"> </span>the<span class="_ _13"> </span>forwarding<span class="_ _a"> </span>source<span class="_ _6"> </span>in<span class="_ _6"> </span>the<span class="_ _6"> </span>execute<span class="_ _6"> </span>stage,<span class="_ _6"> </span>then<span class="_ _6"> </span>those<span class="_ _6"> </span>in</div><div class="t m5 x17 h26 y440f ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>memory<span class="_ _13"> </span>stage<span class="_ _0"></span>,<span class="_"> </span>and<span class="_ _13"> </span>ﬁnally<span class="_"> </span>the<span class="_ _13"> </span>sources<span class="_"> </span>in<span class="_ _13"> </span>the<span class="_"> </span>write-back<span class="_"> </span>stage<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _3"></span>he<span class="_"> </span>forwarding</div><div class="t m5 x17 h26 y4410 ff7 fs19 fc2 sc0 ls0 ws0">priority<span class="_ _16"> </span>between<span class="_ _11"> </span>the<span class="_ _16"> </span>two<span class="_ _16"> </span>sources<span class="_ _16"> </span>in<span class="_ _16"> </span>either<span class="_ _11"> </span>the<span class="_ _16"> </span>memory<span class="_ _16"> </span>or<span class="_ _16"> </span>the<span class="_ _16"> </span>write-back<span class="_ _11"> </span>stages</div><div class="t m5 x17 h26 y4411 ff7 fs19 fc2 sc0 ls0 ws0">is<span class="_ _14"> </span>only<span class="_ _15"> </span>a<span class="_ _14"> </span>concern<span class="_ _15"> </span>for<span class="_ _15"> </span>the<span class="_ _14"> </span>instruction<span class="_ _15"> </span><span class="ffd">popq<span class="_ _14"> </span>%rsp</span>,<span class="_ _21"> </span>since<span class="_ _14"> </span>only<span class="_ _15"> </span>this<span class="_ _15"> </span>instruction<span class="_ _14"> </span>can</div><div class="t m5 x17 h26 y4412 ff7 fs19 fc2 sc0 ls0 ws0">attempt<span class="_"> </span>two<span class="_"> </span>simultaneous<span class="_"> </span>writes<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>same<span class="_"> </span>register.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
