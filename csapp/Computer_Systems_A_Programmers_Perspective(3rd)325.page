<div id="pf145" class="pf w2 h11" data-page-no="145"><div class="pc pc145 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg145.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">324<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">back<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span>80286<span class="_ _11"> </span>and<span class="_ _11"> </span>is<span class="_ _16"> </span>seldom<span class="_"> </span>found<span class="_ _11"> </span>in<span class="_ _16"> </span>programs<span class="_"> </span>running<span class="_ _16"> </span>on<span class="_"> </span>modern<span class="_ _11"> </span>systems<span class="_ _0"></span>.</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">By<span class="_ _16"> </span>storing<span class="_ _16"> </span>the<span class="_ _16"> </span>canary<span class="_ _14"> </span>in<span class="_ _16"> </span>a<span class="_ _16"> </span>special<span class="_ _14"> </span>segment,<span class="_ _16"> </span>it<span class="_ _14"> </span>can<span class="_ _16"> </span>be<span class="_ _16"> </span>marked<span class="_ _16"> </span>as<span class="_ _14"> </span>“read<span class="_ _16"> </span>only<span class="_ _3"></span>,<span class="_ _1"></span>”<span class="_ _14"> </span>so</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_ _16"> </span>an<span class="_ _16"> </span>attacker<span class="_ _16"> </span>cannot<span class="_ _16"> </span>overwrite<span class="_ _14"> </span>the<span class="_ _16"> </span>stored<span class="_ _16"> </span>canary<span class="_ _16"> </span>value.<span class="_ _16"> </span>Before<span class="_ _16"> </span>restoring<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">register<span class="_ _11"> </span>state<span class="_ _16"> </span>and<span class="_ _11"> </span>returning,<span class="_ _11"> </span>the<span class="_ _16"> </span>function<span class="_ _11"> </span>compares<span class="_ _11"> </span>the<span class="_ _16"> </span>value<span class="_ _11"> </span>stored<span class="_ _11"> </span>at<span class="_ _16"> </span>the<span class="_ _11"> </span>stack</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">location<span class="_"> </span>with<span class="_ _13"> </span>the<span class="_"> </span>canary<span class="_"> </span>value<span class="_ _13"> </span>(via<span class="_"> </span>the<span class="_"> </span><span class="ffd">xorq<span class="_ _13"> </span></span>instruction<span class="_"> </span>on<span class="_"> </span>line<span class="_ _13"> </span>11).<span class="_"> </span>If<span class="_"> </span>the<span class="_ _13"> </span>two<span class="_"> </span>are</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">identical,<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">xorq<span class="_ _13"> </span></span>instruction<span class="_ _13"> </span>will<span class="_ _6"> </span>yield<span class="_ _13"> </span>zero<span class="_ _0"></span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>the<span class="_ _13"> </span>function<span class="_ _6"> </span>will<span class="_ _13"> </span>complete<span class="_ _13"> </span>in<span class="_ _13"> </span>the</div><div class="t m5 x1d h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">normal<span class="_"> </span>fashion.<span class="_ _11"> </span>A<span class="_"> </span>nonzero<span class="_ _11"> </span>value<span class="_"> </span>indicates<span class="_ _11"> </span>that<span class="_"> </span>the<span class="_ _11"> </span>canary<span class="_"> </span>on<span class="_ _11"> </span>the<span class="_"> </span>stack<span class="_ _11"> </span>has<span class="_"> </span>been</div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">modiﬁed,<span class="_"> </span>and<span class="_"> </span>so<span class="_"> </span>the<span class="_"> </span>code<span class="_"> </span>will<span class="_"> </span>call<span class="_"> </span>an<span class="_"> </span>error<span class="_"> </span>routine<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">Stack<span class="_"> </span>protection<span class="_ _13"> </span>does<span class="_"> </span>a<span class="_ _13"> </span>good<span class="_"> </span>job<span class="_"> </span>of<span class="_ _13"> </span>preventing<span class="_"> </span>a<span class="_"> </span>buffer<span class="_ _13"> </span>overﬂow<span class="_"> </span>attack<span class="_ _13"> </span>from</div><div class="t m5 x1d h26 y2fd ff7 fs19 fc2 sc0 ls0 ws0">corrupting<span class="_"> </span>state<span class="_ _11"> </span>stored<span class="_ _11"> </span>on<span class="_"> </span>the<span class="_ _11"> </span>program<span class="_ _11"> </span>stack.<span class="_"> </span>It<span class="_ _11"> </span>incurs<span class="_ _11"> </span>only<span class="_"> </span>a<span class="_ _11"> </span>small<span class="_ _11"> </span>performance</div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">penalty<span class="_ _3"></span>,<span class="_ _e"> </span>especially<span class="_ _15"> </span>because<span class="_ _f"> </span><span class="ff9">gcc<span class="_ _f"> </span></span>only<span class="_ _21"> </span>inserts<span class="_ _f"> </span>it<span class="_ _f"> </span>when<span class="_ _f"> </span>there<span class="_ _21"> </span>is<span class="_ _f"> </span>a<span class="_ _f"> </span>local<span class="_ _21"> </span>buffer<span class="_ _f"> </span>of</div><div class="t m5 x1d h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">type<span class="_ _14"> </span><span class="ffd">char<span class="_ _14"> </span></span>in<span class="_ _14"> </span>the<span class="_ _14"> </span>function.<span class="_ _16"> </span>Of<span class="_ _14"> </span>course,<span class="_ _14"> </span>there<span class="_ _14"> </span>are<span class="_ _14"> </span>other<span class="_ _14"> </span>ways<span class="_ _14"> </span>to<span class="_ _14"> </span>corrupt<span class="_ _14"> </span>the<span class="_ _14"> </span>state</div><div class="t m5 x1d h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _13"> </span>an<span class="_ _13"> </span>executing<span class="_ _13"> </span>program,<span class="_"> </span>but<span class="_ _13"> </span>reducing<span class="_ _13"> </span>the<span class="_ _13"> </span>vulnerability<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>stack<span class="_ _13"> </span>thwarts<span class="_ _13"> </span>many</div><div class="t m5 x1d h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">common<span class="_"> </span>attack<span class="_"> </span>strategies<span class="_ _1"></span>.</div><div class="t m5 x1d h47 y2e67 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>3.48<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>383)</span></div><div class="t m5 x1d h26 y2e68 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>functions<span class="_ _13"> </span><span class="ffd">intlen</span>,<span class="_"> </span><span class="ffd">len</span>,<span class="_"> </span>and<span class="_ _13"> </span><span class="ffd">iptoa<span class="_ _10"> </span></span>provide<span class="_ _13"> </span>a<span class="_"> </span>very<span class="_ _13"> </span>convoluted<span class="_"> </span>way<span class="_ _13"> </span>to<span class="_"> </span>compute</div><div class="t m5 x1d h26 y2e69 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>number<span class="_"> </span>of<span class="_"> </span>decimal<span class="_"> </span>digits<span class="_"> </span>required<span class="_"> </span>to<span class="_"> </span>represent<span class="_"> </span>an<span class="_"> </span>integer<span class="_ _1"></span>.<span class="_"> </span>W<span class="_ _1"></span>e<span class="_"> </span>will<span class="_"> </span>use<span class="_"> </span>this<span class="_"> </span>as</div><div class="t m5 x1d h26 y2e6a ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_"> </span>way<span class="_"> </span>to<span class="_"> </span>study<span class="_"> </span>some<span class="_"> </span>aspects<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span><span class="ff9">gcc<span class="_ _10"> </span></span>stack<span class="_"> </span>protector<span class="_"> </span>facility<span class="_ _3"></span>.</div><div class="t m5 x1d h2d y2e6b ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>len(char<span class="_ _1f"> </span>*s)<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y2e6c ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>strlen(s);</div><div class="t m5 x1d h2d y2e6d ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1d h2d y2e6e ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>iptoa(char<span class="_ _1f"> </span>*s,<span class="_ _1f"> </span>long<span class="_ _e"> </span>*p)<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y2e6f ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>val<span class="_ _1f"> </span>=<span class="_ _1f"> </span>*p;</div><div class="t m5 x10c h2d y2e70 ffd fs1e fc2 sc0 ls0 ws0">sprintf(s,<span class="_ _e"> </span>&quot;%ld&quot;,<span class="_ _1f"> </span>val);</div><div class="t m5 x1d h2d y2e71 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1d h2d y2e72 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>intlen(long<span class="_ _1f"> </span>x)<span class="_ _1f"> </span>{</div><div class="t m5 x10c h2d y2e73 ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>v;</div><div class="t m5 x10c h2d y2e74 ffd fs1e fc2 sc0 ls0 ws0">char<span class="_ _e"> </span>buf[12];</div><div class="t m5 x10c h2d y2e75 ffd fs1e fc2 sc0 ls33 ws0">v=x<span class="_ _41"></span>;</div><div class="t m5 x10c h2d y2e76 ffd fs1e fc2 sc0 ls0 ws0">iptoa(buf,<span class="_ _e"> </span>&amp;v);</div><div class="t m5 x10c h2d y2e77 ffd fs1e fc2 sc0 ls0 ws0">return<span class="_ _e"> </span>len(buf);</div><div class="t m5 x1d h2d y2e78 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x29 h26 y2e79 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>following<span class="_"> </span>show<span class="_"> </span>portions<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>code<span class="_"> </span>for<span class="_"> </span><span class="ffd">intlen</span>,<span class="_"> </span>compiled<span class="_"> </span>both<span class="_"> </span>with<span class="_"> </span>and</div><div class="t m5 x1d h26 y2e7a ff7 fs19 fc2 sc0 ls0 ws0">without<span class="_"> </span>stack<span class="_"> </span>protector:</div><div class="t m5 x1d h34 y2e7b ff6 fs16 fc2 sc0 ls0 ws0">(a)<span class="_ _10"> </span>Without<span class="_ _10"> </span>protector</div><div class="t m5 xad h61 y13c0 ff13 fs35 fc6 sc0 ls0 ws0">int<span class="_ _f"> </span>intlen(long<span class="_ _f"> </span>x)</div><div class="t m5 xad h61 y2e7c ff13 fs35 fc6 sc0 ls0 ws0">x<span class="_ _f"> </span>in<span class="_ _f"> </span>%rdi</div><div class="t m5 x1f h2d y8d6 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">intlen:</span></div><div class="t m5 x1f h2d y77e ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _45"> </span><span class="ffd fs1e fc2">subq<span class="_ _46"> </span>$40,<span class="_ _e"> </span>%rsp</span></div><div class="t m5 x1f h2d ye95 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _45"> </span><span class="ffd fs1e fc2">movq<span class="_ _46"> </span>%rdi,<span class="_ _e"> </span>24(%rsp)</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
