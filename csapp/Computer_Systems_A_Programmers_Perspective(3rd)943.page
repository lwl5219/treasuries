<div id="pf3af" class="pf w2 h11" data-page-no="3af"><div class="pc pc3af w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3af.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">942<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>10<span class="_ _3d"> </span>System-Level<span class="_ _10"> </span>I/O</span></div><div class="t m5 x1c1 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/io/readdir<span class="_ _3"></span>.c</div><div class="t m5 x1f h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x1f h2e y281 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x1f h2e y282 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x4f h2d y283 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main(int<span class="_ _1f"> </span>argc,<span class="_ _1f"> </span>char<span class="_ _e"> </span>**argv)</div><div class="t m5 x1f h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x1f h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">DIR<span class="_ _e"> </span>*streamp;</span></div><div class="t m5 x1f h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">struct<span class="_ _e"> </span>dirent<span class="_ _1f"> </span>*dep;</span></div><div class="t m5 x1f h2e y287 ff6 fs20 fc6 sc0 ls0 ws0">7</div><div class="t m5 x1f h2e y5fd1 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x33 h2d y4493 ffd fs1e fc2 sc0 ls0 ws0">streamp<span class="_ _e"> </span>=<span class="_ _1f"> </span>Opendir(argv[1]);</div><div class="t m5 x1f h2e y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x1b0 h2e y6a52 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x33 h2d y4a9b ffd fs1e fc2 sc0 ls0 ws0">errno<span class="_ _e"> </span>=<span class="_ _1f"> </span>0;</div><div class="t m5 x1b0 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _20"> </span><span class="ffd fs1e fc2">while<span class="_ _e"> </span>((dep<span class="_ _1f"> </span>=<span class="_ _1f"> </span>readdir(streamp))<span class="_ _e"> </span>!=<span class="_ _1f"> </span>NULL)<span class="_ _e"> </span>{</span></div><div class="t m5 x1b0 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">printf(&quot;Found<span class="_ _e"> </span>file:<span class="_ _1f"> </span>%s\n&quot;,<span class="_ _1f"> </span>dep-&gt;d_name);</span></div><div class="t m5 x1b0 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1b0 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(errno<span class="_ _1f"> </span>!=<span class="_ _1f"> </span>0)</span></div><div class="t m5 x1b0 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _70"> </span><span class="ffd fs1e fc2">unix_error(&quot;readdir<span class="_ _e"> </span>error&quot;);</span></div><div class="t m5 x1b0 h2e y417 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x1b0 h2e y7429 ff6 fs20 fc6 sc0 ls0 ws0">17</div><div class="t m5 x33 h2d y4aa0 ffd fs1e fc2 sc0 ls0 ws0">Closedir(streamp);</div><div class="t m5 x1b0 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20"> </span><span class="ffd fs1e fc2">exit(0);</span></div><div class="t m5 x1b0 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x1c1 h2c y7864 ffa fs16 fc2 sc0 ls0 ws0">code/io/readdir<span class="_ _3"></span>.c</div><div class="t m5 x1d h2f y7865 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>10.11<span class="_ _66"> </span><span class="fc1">Reading<span class="_"> </span>the<span class="_"> </span>contents<span class="_"> </span>of<span class="_"> </span>a<span class="_"> </span>director<span class="_ _2"></span>y<span class="_ _3"></span>.</span></div><div class="t m5 x1d h3b y7866 fff fs24 fc6 sc0 ls0 ws0">10.8<span class="_ _17"> </span><span class="ffe fs18">Sharing<span class="_"> </span>Files</span></div><div class="t m5 x1d h26 y7867 ff7 fs19 fc1 sc0 ls0 ws0">Linux<span class="_ _11"> </span>ﬁles<span class="_ _11"> </span>can<span class="_ _11"> </span>be<span class="_ _11"> </span>shared<span class="_ _11"> </span>in<span class="_ _11"> </span>a<span class="_ _11"> </span>number<span class="_ _11"> </span>of<span class="_ _11"> </span>different<span class="_ _11"> </span>ways<span class="_ _1"></span>.<span class="_ _11"> </span>Unless<span class="_ _11"> </span>you<span class="_ _11"> </span>have<span class="_ _11"> </span>a<span class="_ _11"> </span>clear</div><div class="t m5 x1d h26 y7868 ff7 fs19 fc1 sc0 ls0 ws0">picture<span class="_ _13"> </span>of<span class="_ _13"> </span>how<span class="_ _6"> </span>the<span class="_ _13"> </span>kernel<span class="_ _13"> </span>represents<span class="_ _13"> </span>open<span class="_ _13"> </span>ﬁles<span class="_ _3"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>idea<span class="_ _13"> </span>of<span class="_ _13"> </span>ﬁle<span class="_ _13"> </span>sharing<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _13"> </span>quite</div><div class="t m5 x1d h26 y7869 ff7 fs19 fc1 sc0 ls0 ws0">confusing.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>kernel<span class="_"> </span>represents<span class="_"> </span>open<span class="_"> </span>ﬁles<span class="_"> </span>using<span class="_"> </span>three<span class="_"> </span>related<span class="_"> </span>data<span class="_"> </span>structures:</div><div class="t m5 x75 h26 y786a ffa fs19 fc1 sc0 ls0 ws0">Descriptor<span class="_"> </span>table.<span class="_ _21"> </span><span class="ff7">Each<span class="_ _11"> </span>process<span class="_"> </span>has<span class="_ _11"> </span>its<span class="_ _11"> </span>own<span class="_ _11"> </span>separate<span class="_ _11"> </span></span>descriptor<span class="_"> </span>table<span class="_ _11"> </span><span class="ff7">whose<span class="_ _11"> </span>en-</span></div><div class="t m5 xcd h26 y786b ff7 fs19 fc1 sc0 ls0 ws0">tries<span class="_ _6"> </span>are<span class="_ _13"> </span>indexed<span class="_ _6"> </span>by<span class="_ _6"> </span>the<span class="_ _13"> </span>process’<span class="_ _0"></span>s<span class="_ _6"> </span>open<span class="_ _13"> </span>ﬁle<span class="_ _6"> </span>descriptors<span class="_ _1"></span>.<span class="_ _6"> </span>Each<span class="_ _13"> </span>open<span class="_ _6"> </span>descrip-</div><div class="t m5 xcd h26 y786c ff7 fs19 fc1 sc0 ls0 ws0">tor<span class="_"> </span>entry<span class="_"> </span>points<span class="_"> </span>to<span class="_"> </span>an<span class="_"> </span>entry<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span><span class="ffa">ﬁle<span class="_"> </span>table.</span></div><div class="t m5 x75 h26 y786d ffa fs19 fc1 sc0 ls0 ws0">File<span class="_ _13"> </span>table.<span class="_ _21"> </span><span class="ff7">T<span class="_ _1"></span>he<span class="_"> </span>set<span class="_ _13"> </span>of<span class="_"> </span>open<span class="_ _13"> </span>ﬁles<span class="_"> </span>is<span class="_ _13"> </span>represented<span class="_ _13"> </span>by<span class="_"> </span>a<span class="_ _13"> </span>ﬁle<span class="_"> </span>table<span class="_ _13"> </span>that<span class="_ _13"> </span>is<span class="_"> </span>shared<span class="_ _13"> </span>by<span class="_"> </span>all</span></div><div class="t m5 xcd h26 y786e ff7 fs19 fc1 sc0 ls0 ws0">processes<span class="_ _1"></span>.<span class="_"> </span>Each<span class="_"> </span>ﬁle<span class="_"> </span>table<span class="_ _13"> </span>entry<span class="_"> </span>consists<span class="_"> </span>of<span class="_"> </span>(for<span class="_"> </span>our<span class="_"> </span>purposes)<span class="_ _13"> </span>the<span class="_"> </span>current</div><div class="t m5 xcd h26 y786f ff7 fs19 fc1 sc0 ls0 ws0">ﬁle<span class="_ _16"> </span>position,<span class="_ _14"> </span>a<span class="_ _14"> </span><span class="ffa">reference<span class="_ _14"> </span>count<span class="_ _15"> </span></span>of<span class="_ _16"> </span>the<span class="_ _14"> </span>number<span class="_ _14"> </span>of<span class="_ _16"> </span>descriptor<span class="_ _14"> </span>entries<span class="_ _16"> </span>that</div><div class="t m5 xcd h26 y7870 ff7 fs19 fc1 sc0 ls0 ws0">currently<span class="_ _13"> </span>point<span class="_ _13"> </span>to<span class="_"> </span>it,<span class="_ _13"> </span>and<span class="_ _13"> </span>a<span class="_ _13"> </span>pointer<span class="_"> </span>to<span class="_ _13"> </span>an<span class="_ _13"> </span>entry<span class="_ _13"> </span>in<span class="_"> </span>the<span class="_ _13"> </span><span class="ffa">v-node<span class="_ _13"> </span>table</span>.<span class="_ _13"> </span>Closing</div><div class="t m5 xcd h26 y7871 ff7 fs19 fc1 sc0 ls0 ws0">a<span class="_ _16"> </span>descriptor<span class="_ _16"> </span>decrements<span class="_ _16"> </span>the<span class="_ _16"> </span>reference<span class="_ _16"> </span>count<span class="_ _14"> </span>in<span class="_ _16"> </span>the<span class="_ _16"> </span>associated<span class="_ _16"> </span>ﬁle<span class="_ _16"> </span>table</div><div class="t m5 xcd h26 y7872 ff7 fs19 fc1 sc0 ls0 ws0">entry<span class="_ _3"></span>.<span class="_ _14"> </span>T<span class="_ _0"></span>he<span class="_ _14"> </span>kernel<span class="_ _15"> </span>will<span class="_ _15"> </span>not<span class="_ _14"> </span>delete<span class="_ _15"> </span>the<span class="_ _14"> </span>ﬁle<span class="_ _15"> </span>table<span class="_ _15"> </span>entry<span class="_ _14"> </span>until<span class="_ _15"> </span>its<span class="_ _14"> </span>reference</div><div class="t m5 xcd h26 y7873 ff7 fs19 fc1 sc0 ls0 ws0">count<span class="_"> </span>is<span class="_"> </span>zero<span class="_ _1"></span>.</div><div class="t m5 x75 h26 y7874 ffa fs19 fc1 sc0 ls0 ws0">v-node<span class="_ _13"> </span>table<span class="_ _1"></span>.<span class="_ _21"> </span><span class="ff7">Like<span class="_ _13"> </span>the<span class="_ _6"> </span>ﬁle<span class="_ _13"> </span>table<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>v-node<span class="_ _6"> </span>table<span class="_ _13"> </span>is<span class="_ _6"> </span>shared<span class="_ _13"> </span>by<span class="_ _6"> </span>all<span class="_ _13"> </span>processes<span class="_ _3"></span>.<span class="_ _13"> </span>Each</span></div><div class="t m5 xcd h26 y7875 ff7 fs19 fc1 sc0 ls0 ws0">entry<span class="_ _6"> </span>contains<span class="_ _13"> </span>most<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>information<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span><span class="ffd">stat<span class="_ _6"> </span></span>structure,<span class="_ _6"> </span>including<span class="_ _13"> </span>the</div><div class="t m5 xcd h26 y7876 ffd fs19 fc1 sc0 ls0 ws0">st_mode<span class="_ _10"> </span><span class="ff7">and<span class="_"> </span></span>st_size<span class="_ _10"> </span><span class="ff7">members<span class="_ _1"></span>.</span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
