<div id="pf2df" class="pf w2 h11" data-page-no="2df"><div class="pc pc2df w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg2df.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">734<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>7<span class="_ _3d"> </span>Linking</span></div><div class="t m5 x14 h2f y9c ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>7.15</div><div class="t m5 x14 h2f y676 ffe fs16 fc1 sc0 ls0 ws0">Linux<span class="_ _16"> </span>x86-64<span class="_ _16"> </span>run-time</div><div class="t m5 x14 h34 y7cb ffe fs16 fc1 sc0 ls0 ws0">memory<span class="_ _14"> </span>image.<span class="_ _14"> </span><span class="ff6">Gaps</span></div><div class="t m5 x14 h34 yd19 ff6 fs16 fc1 sc0 ls0 ws0">due<span class="_ _10"> </span>to<span class="_ _11"> </span>segment<span class="_ _11"> </span>alignment</div><div class="t m5 x14 h34 yd1a ff6 fs16 fc1 sc0 ls0 ws0">requirements<span class="_ _10"> </span>and<span class="_ _11"> </span>address-</div><div class="t m5 x14 h34 yd1b ff6 fs16 fc1 sc0 ls0 ws0">space<span class="_ _6"> </span>layout<span class="_ _13"> </span>randomization</div><div class="t m5 x14 h34 yf75 ff6 fs16 fc1 sc0 ls0 ws0">(ASLR)<span class="_ _10"> </span>are<span class="_ _11"> </span>not<span class="_ _11"> </span>shown.<span class="_ _10"> </span>Not</div><div class="t m5 x14 h34 yf76 ff6 fs16 fc1 sc0 ls0 ws0">to<span class="_ _10"> </span>scale.</div><div class="t m5 xe0 h40 y6119 ff8d fs28 fc1 sc0 ls0 ws0">0x400000</div><div class="t m5 x7c h40 y611a ff8d fs28 fc1 sc0 ls0 ws0">2</div><div class="t m5 x235 hef y611b ff8d fs96 fc1 sc0 ls0 ws0">48</div><div class="t m5 xf8 h40 y611c ff8d fs28 fc1 sc0 ls0 ws0">-1</div><div class="t m5 x79 h40 y611d ff8d fs28 fc1 sc0 ls0 ws0">0</div><div class="t m5 x1f8 h3f y611e ff8e fs27 fc1 sc0 ls0 ws0">Memory</div><div class="t m5 x1f8 h3f y611f ff8e fs27 fc1 sc0 ls0 ws0">invisible to</div><div class="t m5 x1f8 h3f y6120 ff8e fs27 fc1 sc0 ls0 ws0">user code</div><div class="t m5 x1f8 h40 y6121 ff8d fs28 fc1 sc0 ls0 ws0">%esp<span class="fs2a"> <span class="ff8e fs27">(stack pointer)</span></span></div><div class="t m5 x1f8 h40 y6122 ff8d fs28 fc1 sc0 ls0 ws0">brk</div><div class="t m5 x85 h3f y6123 ff8e fs27 fc1 sc0 ls0 ws0">Loaded from the</div><div class="t m5 x85 h3f y6124 ff8e fs27 fc1 sc0 ls0 ws0">executable file</div><div class="t m5 x68 h3f y6125 ff8e fs27 fc1 sc0 ls0 ws0">User stack</div><div class="t m5 xba h3f y6126 ff8e fs27 fc1 sc0 ls0 ws0">(created at run time)</div><div class="t m5 x167 h3f y6127 ff8e fs27 fc1 sc0 ls0 ws0">Memory-mapped region for</div><div class="t m5 xdd h3f y6128 ff8e fs27 fc1 sc0 ls0 ws0">shared libraries</div><div class="t m5 x228 h3f y6129 ff8e fs27 fc1 sc0 ls0 ws0">Run-time heap</div><div class="t m5 xba h3f y612a ff8e fs27 fc1 sc0 ls0 ws0">(created by </div><div class="t m5 xd5 h40 y612b ff8d fs28 fc1 sc0 ls0 ws0">malloc<span class="ff8e fs27">)</span></div><div class="t m5 xba h3f y612c ff8e fs27 fc1 sc0 ls0 ws0">Read/write segment</div><div class="t m5 xa0 h3f y612d ff8e fs27 fc1 sc0 ls0 ws0">(</div><div class="t m5 x9e h40 y612e ff8d fs28 fc1 sc0 ls0 ws0">.data,.bss<span class="ff8e fs27">)</span></div><div class="t m5 x117 h3f y612f ff8e fs27 fc1 sc0 ls0 ws0">Read-only code segment</div><div class="t m5 x157 h3f y6130 ff8e fs27 fc1 sc0 ls0 ws0">(</div><div class="t m5 x16c h40 y6131 ff8d fs28 fc1 sc0 ls0 ws0">.init,.text,.rodata<span class="ff8e fs27">)</span></div><div class="t m5 xdd h3f y6132 ff8e fs27 fc1 sc0 ls0 ws0">Kernel memory</div><div class="t m5 x1d h26 y6133 ff7 fs19 fc1 sc0 ls0 ws0">executable<span class="_ _14"> </span>object<span class="_ _16"> </span>ﬁle<span class="_ _14"> </span>into<span class="_ _14"> </span>the<span class="_ _14"> </span>code<span class="_ _14"> </span>and<span class="_ _14"> </span>data<span class="_ _14"> </span>segments<span class="_ _1"></span>.<span class="_ _14"> </span>Next,<span class="_ _15"> </span>the<span class="_ _16"> </span>loader<span class="_ _14"> </span>jumps</div><div class="t m5 x1d h26 y6134 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>the<span class="_"> </span>program’s<span class="_"> </span>entry<span class="_"> </span>point,<span class="_"> </span>which<span class="_"> </span>is<span class="_"> </span>always<span class="_"> </span>the<span class="_"> </span>address<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span><span class="ffd">_start<span class="_ _10"> </span></span>function.</div><div class="t m5 x1d h26 y6135 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _11"> </span>function<span class="_"> </span>is<span class="_"> </span>deﬁned<span class="_ _11"> </span>in<span class="_"> </span>the<span class="_ _11"> </span>system<span class="_"> </span>object<span class="_ _11"> </span>ﬁle<span class="_"> </span><span class="ffd">crt1.o<span class="_ _11"> </span></span>and<span class="_"> </span>is<span class="_"> </span>the<span class="_ _11"> </span>same<span class="_"> </span>for<span class="_ _11"> </span>all<span class="_"> </span>C</div><div class="t m5 x1d h26 y6136 ff7 fs19 fc1 sc0 ls0 ws0">programs<span class="_ _1"></span>.<span class="_"> </span>The<span class="_"> </span><span class="ffd">_start<span class="_ _10"> </span></span>function<span class="_"> </span>calls<span class="_ _11"> </span>the<span class="_"> </span><span class="ffa">system<span class="_ _11"> </span>startup<span class="_"> </span>function</span>,<span class="_ _11"> </span><span class="ffd">__libc_start_</span></div><div class="t m5 x1d h26 y6137 ffd fs19 fc1 sc0 ls0 ws0">main<span class="ff7">,<span class="_ _11"> </span>which<span class="_ _11"> </span>is<span class="_ _11"> </span>deﬁned<span class="_ _16"> </span>in<span class="_"> </span></span>libc.so<span class="ff7">.<span class="_ _11"> </span>It<span class="_ _16"> </span>initializes<span class="_"> </span>the<span class="_ _11"> </span>execution<span class="_ _16"> </span>environment,<span class="_ _11"> </span>calls</span></div><div class="t m5 x1d h26 y6138 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _15"> </span>user<span class="_ _1"></span>-level<span class="_ _15"> </span><span class="ffd">main<span class="_ _15"> </span></span>function,<span class="_ _21"> </span>handles<span class="_ _15"> </span>its<span class="_ _15"> </span>return<span class="_ _15"> </span>value<span class="_ _0"></span>,<span class="_ _21"> </span>and<span class="_ _15"> </span>if<span class="_ _15"> </span>necessary<span class="_ _15"> </span>returns</div><div class="t m5 x1d h26 y6139 ff7 fs19 fc1 sc0 ls0 ws0">control<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>kernel.</div><div class="t m5 x1d h3b y6fd fff fs24 fc6 sc0 ls0 ws0">7.10<span class="_ _17"> </span><span class="ffe fs18">Dynamic<span class="_"> </span>Linking<span class="_"> </span>with<span class="_"> </span>Shared<span class="_"> </span>Libraries</span></div><div class="t m5 x1d h26 y6fe ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>static<span class="_"> </span>libraries<span class="_"> </span>that<span class="_"> </span>we<span class="_"> </span>studied<span class="_"> </span>in<span class="_"> </span>Section<span class="_"> </span>7.6.2<span class="_"> </span>address<span class="_"> </span>many<span class="_ _13"> </span>of<span class="_"> </span>the<span class="_"> </span>issues<span class="_"> </span>as-</div><div class="t m5 x1d h26 y6ff ff7 fs19 fc1 sc0 ls0 ws0">sociated<span class="_ _13"> </span>with<span class="_ _6"> </span>making<span class="_ _13"> </span>large<span class="_ _6"> </span>collections<span class="_ _13"> </span>of<span class="_ _6"> </span>related<span class="_ _13"> </span>functions<span class="_ _13"> </span>available<span class="_ _6"> </span>to<span class="_ _13"> </span>application</div><div class="t m5 x1d h26 y700 ff7 fs19 fc1 sc0 ls0 ws0">programs<span class="_ _1"></span>.<span class="_ _6"> </span>However,<span class="_ _6"> </span>static<span class="_ _13"> </span>libraries<span class="_ _a"> </span>still<span class="_ _6"> </span>have<span class="_ _13"> </span>some<span class="_ _a"> </span>signiﬁcant<span class="_ _13"> </span>disadvantages<span class="_ _3"></span>.<span class="_ _6"> </span>Static</div><div class="t m5 x1d h26 y701 ff7 fs19 fc1 sc0 ls0 ws0">libraries<span class="_ _1"></span>,<span class="_"> </span>like<span class="_"> </span>all<span class="_"> </span>software<span class="_ _1"></span>,<span class="_"> </span>need<span class="_"> </span>to<span class="_"> </span>be<span class="_"> </span>maintained<span class="_"> </span>and<span class="_"> </span>updated<span class="_"> </span>periodically<span class="_ _7"></span>.<span class="_"> </span>If<span class="_"> </span>ap-</div><div class="t m5 x1d h26 y702 ff7 fs19 fc1 sc0 ls0 ws0">plication<span class="_ _13"> </span>programmers<span class="_"> </span>want<span class="_ _13"> </span>to<span class="_"> </span>use<span class="_ _13"> </span>the<span class="_"> </span>most<span class="_ _13"> </span>recent<span class="_"> </span>version<span class="_ _13"> </span>of<span class="_"> </span>a<span class="_ _13"> </span>library<span class="_ _3"></span>,<span class="_"> </span>they<span class="_ _13"> </span>must</div><div class="t m5 x1d h26 y703 ff7 fs19 fc1 sc0 ls0 ws0">somehow<span class="_ _16"> </span>become<span class="_ _16"> </span>aware<span class="_ _14"> </span>that<span class="_ _16"> </span>the<span class="_ _16"> </span>library<span class="_ _14"> </span>has<span class="_ _16"> </span>changed<span class="_ _16"> </span>and<span class="_ _14"> </span>then<span class="_ _16"> </span>explicitly<span class="_ _16"> </span>relink</div><div class="t m5 x1d h26 y704 ff7 fs19 fc1 sc0 ls0 ws0">their<span class="_"> </span>programs<span class="_"> </span>against<span class="_"> </span>the<span class="_"> </span>updated<span class="_"> </span>library<span class="_ _3"></span>.</div><div class="t m5 x29 h26 y705 ff7 fs19 fc1 sc0 ls0 ws0">Another<span class="_ _6"> </span>issue<span class="_ _13"> </span>is<span class="_ _a"> </span>that<span class="_ _13"> </span>almost<span class="_ _6"> </span>every<span class="_ _6"> </span>C<span class="_ _13"> </span>program<span class="_ _6"> </span>uses<span class="_ _6"> </span>standard<span class="_ _13"> </span>I/O<span class="_ _6"> </span>functions<span class="_ _6"> </span>such</div><div class="t m5 x1d h26 y706 ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_ _13"> </span><span class="ffd">printf<span class="_ _13"> </span></span>and<span class="_ _13"> </span><span class="ffd">scanf</span>.<span class="_ _13"> </span>At<span class="_ _13"> </span>run<span class="_ _13"> </span>time<span class="_ _1"></span>,<span class="_ _13"> </span>the<span class="_ _13"> </span>code<span class="_ _13"> </span>for<span class="_ _13"> </span>these<span class="_ _13"> </span>functions<span class="_ _13"> </span>is<span class="_ _13"> </span>duplicated<span class="_ _13"> </span>in<span class="_ _13"> </span>the</div><div class="t m5 x1d h26 y707 ff7 fs19 fc1 sc0 ls0 ws0">text<span class="_ _6"> </span>segment<span class="_ _13"> </span>of<span class="_ _6"> </span>each<span class="_ _13"> </span>running<span class="_ _6"> </span>process<span class="_ _1"></span>.<span class="_ _13"> </span>On<span class="_ _6"> </span>a<span class="_ _13"> </span>typical<span class="_ _6"> </span>system<span class="_ _13"> </span>that<span class="_ _6"> </span>is<span class="_ _13"> </span>running<span class="_ _6"> </span>hundreds</div><div class="t m5 x1d h26 y708 ff7 fs19 fc1 sc0 ls0 ws0">of<span class="_ _16"> </span>processes<span class="_ _1"></span>,<span class="_ _16"> </span>this<span class="_ _16"> </span>can<span class="_ _16"> </span>be<span class="_ _16"> </span>a<span class="_ _16"> </span>signiﬁcant<span class="_ _11"> </span>waste<span class="_ _16"> </span>of<span class="_ _16"> </span>scarce<span class="_ _16"> </span>memory<span class="_ _16"> </span>system<span class="_ _16"> </span>resources<span class="_ _1"></span>.</div><div class="t m5 x1d h26 y709 ff7 fs19 fc1 sc0 ls0 ws0">(An<span class="_ _6"> </span>interesting<span class="_ _6"> </span>property<span class="_ _13"> </span>of<span class="_ _a"> </span>memory<span class="_ _6"> </span>is<span class="_ _13"> </span>that<span class="_ _a"> </span>it<span class="_ _13"> </span>is<span class="_ _a"> </span><span class="ffa">always<span class="_ _6"> </span></span>a<span class="_ _6"> </span>scarce<span class="_ _13"> </span>resource<span class="_ _1"></span>,<span class="_ _13"> </span>regardless</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
