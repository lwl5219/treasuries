<div id="pf3e1" class="pf w2 h11" data-page-no="3e1"><div class="pc pc3e1 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg3e1.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">992<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>11<span class="_ _3d"> </span>Network<span class="_ _10"> </span>Programming</span></div><div class="t m5 xb h2e y7d41 ff6 fs20 fc6 sc0 ls0 ws0">1</div><div class="t m5 x244 h2d y37f6 ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _e"> </span><span class="ff13">telnet<span class="_ _1f"> </span>kittyhawk.cmcl.cs.cmu.edu<span class="_ _1f"> </span>8000<span class="_ _ea"> </span><span class="fs35 fc6">Client:<span class="_ _e"> </span>open<span class="_ _21"> </span>connection</span></span></div><div class="t m5 xb h2d y37f7 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">Trying<span class="_ _1f"> </span>128.2.194.242...</span></div><div class="t m5 xb h2d y37f9 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">Connected<span class="_ _1f"> </span>to<span class="_ _e"> </span>kittyhawk.cmcl.cs.cmu.edu.</span></div><div class="t m5 xb h2d y37fa ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">Escape<span class="_ _1f"> </span>character<span class="_ _e"> </span>is<span class="_ _1f"> </span>’^]’.</span></div><div class="t m5 xb h2d y7d42 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ff13 fs1e fc2">GET<span class="_ _1f"> </span>/cgi-bin/adder?15000&amp;213<span class="_ _e"> </span>HTTP/1.0<span class="_ _3b"> </span><span class="fs35 fc6">Client:<span class="_ _21"> </span>request<span class="_ _e"> </span>line</span></span></div><div class="t m5 xb h61 y37fc ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _134"> </span><span class="ff13 fs35">Client:<span class="_ _21"> </span>empty<span class="_ _e"> </span>line<span class="_ _21"> </span>terminates<span class="_ _f"> </span>headers</span></div><div class="t m5 xb h2d y7d43 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _1c"> </span><span class="ffd fs1e fc2">HTTP/1.0<span class="_ _1f"> </span>200<span class="_ _e"> </span>OK<span class="_ _a6"> </span></span><span class="ff13 fs35">Server:<span class="_ _f"> </span>response<span class="_ _f"> </span>line</span></div><div class="t m5 xb h2d y37ff ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">Server:<span class="_ _1f"> </span>Tiny<span class="_ _e"> </span>Web<span class="_ _1f"> </span>Server<span class="_ _138"> </span></span><span class="ff13 fs35">Server:<span class="_ _e"> </span>identify<span class="_ _21"> </span>server</span></div><div class="t m5 xb h2d y3801 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _1c"> </span><span class="ffd fs1e fc2">Content-length:<span class="_ _1f"> </span>115<span class="_ _aa"> </span></span><span class="ff13 fs35">Adder:<span class="_ _21"> </span>expect<span class="_ _f"> </span>115<span class="_ _e"> </span>bytes<span class="_ _21"> </span>in<span class="_ _f"> </span>response<span class="_ _e"> </span>body</span></div><div class="t m5 x14 h2d y3802 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _1c"> </span><span class="ffd fs1e fc2">Content-type:<span class="_ _1f"> </span>text/html<span class="_ _138"> </span></span><span class="ff13 fs35">Adder:<span class="_ _f"> </span>expect<span class="_ _e"> </span>HTML<span class="_ _21"> </span>in<span class="_ _f"> </span>response<span class="_ _e"> </span>body</span></div><div class="t m5 x14 h2e y7d44 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x7b h61 y3803 ff13 fs35 fc6 sc0 ls0 ws0">Adder:<span class="_ _f"> </span>empty<span class="_ _f"> </span>line<span class="_ _f"> </span>terminates<span class="_ _e"> </span>headers</div><div class="t m5 x14 h2d y3804 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">Welcome<span class="_ _1f"> </span>to<span class="_ _e"> </span>add.com:<span class="_ _1f"> </span>THE<span class="_ _1f"> </span>Internet<span class="_ _e"> </span>addition<span class="_ _1f"> </span>portal.<span class="_ _f"> </span></span><span class="ff13 fs35">Adder:<span class="_ _f"> </span>first<span class="_ _f"> </span>HTML<span class="_ _e"> </span>line</span></div><div class="t m5 x14 h2d y3805 ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">&lt;p&gt;The<span class="_ _1f"> </span>answer<span class="_ _e"> </span>is:<span class="_ _1f"> </span>15000<span class="_ _1f"> </span>+<span class="_ _e"> </span>213<span class="_ _1f"> </span>=<span class="_ _e"> </span>15213<span class="_ _3b"> </span></span><span class="ff13 fs35">Adder:<span class="_ _21"> </span>second<span class="_ _e"> </span>HTML<span class="_ _21"> </span>line<span class="_ _f"> </span>in<span class="_ _e"> </span>response<span class="_ _21"> </span>body</span></div><div class="t m5 x14 h2d y3806 ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _1c"> </span><span class="ffd fs1e fc2">&lt;p&gt;Thanks<span class="_ _1f"> </span>for<span class="_ _e"> </span>visiting!<span class="_ _11b"> </span></span><span class="ff13 fs35">Adder:<span class="_ _21"> </span>third<span class="_ _e"> </span>HTML<span class="_ _21"> </span>line<span class="_ _f"> </span>in<span class="_ _e"> </span>response<span class="_ _21"> </span>body</span></div><div class="t m5 x14 h2e y7d45 ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x244 h2d y3808 ffd fs1e fc2 sc0 ls0 ws0">Connection<span class="_ _e"> </span>closed<span class="_ _1f"> </span>by<span class="_ _1f"> </span>foreign<span class="_ _e"> </span>host.<span class="_ _14a"> </span><span class="ff13 fs35 fc6">Server:<span class="_ _f"> </span>closes<span class="_ _f"> </span>connection</span></div><div class="t m5 x14 h2e y3809 ff6 fs20 fc6 sc0 ls0 ws0">16</div><div class="t m5 x244 h2d y380a ffd fs1e fc2 sc0 ls0 ws0">linux&gt;<span class="_ _239"> </span><span class="ff13 fs35 fc6">Client:<span class="_ _f"> </span>closes<span class="_ _f"> </span>connection<span class="_ _f"> </span>and<span class="_ _e"> </span>terminates</span></div><div class="t m5 x14 h2f y7ddf ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>11.28<span class="_ _66"> </span><span class="fc1">An<span class="_"> </span>HTTP<span class="_"> </span>transaction<span class="_"> </span>that<span class="_"> </span>ser<span class="_ _2"></span>ves<span class="_"> </span>dynamic<span class="_"> </span>HTML<span class="_"> </span>content.</span></div><div class="t m5 x1d h3b y7de0 fff fs24 fc6 sc0 ls0 ws0">11.6<span class="_ _17"> </span><span class="ffe fs18">Putting<span class="_"> </span>It<span class="_"> </span>T<span class="_ _1"></span>ogether:<span class="_"> </span>The<span class="_"> </span><span class="ff1b ls2e3">Ti<span class="_ _5"></span>n<span class="_ _5"></span>y<span class="_ _f"> </span></span>W<span class="_ _1"></span>eb<span class="_"> </span>Ser<span class="_ _2"></span>ver</span></div><div class="t m5 x1d h26 y7de1 ff7 fs19 fc1 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _11"> </span>conclude<span class="_ _16"> </span>our<span class="_ _11"> </span>discussion<span class="_ _11"> </span>of<span class="_ _11"> </span>network<span class="_ _16"> </span>programming<span class="_ _11"> </span>by<span class="_ _11"> </span>developing<span class="_ _11"> </span>a<span class="_ _16"> </span>small<span class="_ _11"> </span>but</div><div class="t m5 x1d h26 y7de2 ff7 fs19 fc1 sc0 ls0 ws0">functioning<span class="_ _11"> </span>W<span class="_ _1"></span>eb<span class="_ _16"> </span>server<span class="_ _11"> </span>called<span class="_ _16"> </span><span class="ff9">T<span class="_ _3"></span>iny<span class="ff7">.<span class="_ _16"> </span></span>T<span class="_ _3"></span>iny<span class="_ _16"> </span><span class="ff7">is<span class="_ _11"> </span>an<span class="_ _16"> </span>interesting<span class="_ _11"> </span>program.<span class="_ _16"> </span>It<span class="_ _16"> </span>combines</span></span></div><div class="t m5 x1d h26 y7de3 ff7 fs19 fc1 sc0 ls0 ws0">many<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>ideas<span class="_ _11"> </span>that<span class="_"> </span>we<span class="_"> </span>have<span class="_ _11"> </span>learned<span class="_"> </span>about,<span class="_"> </span>such<span class="_ _11"> </span>as<span class="_"> </span>process<span class="_"> </span>control,<span class="_ _11"> </span>Unix<span class="_"> </span>I/O<span class="_ _3"></span>,</div><div class="t m5 x1d h26 y7de4 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _15"> </span>sockets<span class="_ _21"> </span>interface<span class="_ _0"></span>,<span class="_ _f"> </span>and<span class="_ _15"> </span>HTTP<span class="_ _7"></span>,<span class="_ _21"> </span>in<span class="_ _21"> </span>only<span class="_ _21"> </span>250<span class="_ _15"> </span>lines<span class="_ _21"> </span>of<span class="_ _21"> </span>code<span class="_ _0"></span>.<span class="_ _15"> </span>While<span class="_ _15"> </span>it<span class="_ _21"> </span>lacks<span class="_ _21"> </span>the</div><div class="t m5 x1d h26 y7de5 ff7 fs19 fc1 sc0 ls0 ws0">functionality<span class="_ _3"></span>,<span class="_ _14"> </span>robustness<span class="_ _1"></span>,<span class="_ _14"> </span>and<span class="_ _14"> </span>security<span class="_ _14"> </span>of<span class="_ _16"> </span>a<span class="_ _14"> </span>real<span class="_ _14"> </span>server,<span class="_ _14"> </span>it<span class="_ _16"> </span>is<span class="_ _14"> </span>powerful<span class="_ _14"> </span>enough<span class="_ _14"> </span>to</div><div class="t m5 x1d h26 y7de6 ff7 fs19 fc1 sc0 ls0 ws0">serve<span class="_ _11"> </span>both<span class="_ _16"> </span>static<span class="_ _11"> </span>and<span class="_ _16"> </span>dynamic<span class="_ _11"> </span>content<span class="_ _16"> </span>to<span class="_ _11"> </span>real<span class="_ _16"> </span>W<span class="_ _3"></span>eb<span class="_ _11"> </span>browsers<span class="_ _1"></span>.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>encourage<span class="_ _11"> </span>you</div><div class="t m5 x1d h26 y7de7 ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_"> </span>study<span class="_ _13"> </span>it<span class="_"> </span>and<span class="_ _13"> </span>implement<span class="_"> </span>it<span class="_ _13"> </span>yourself<span class="_ _1"></span>.<span class="_"> </span>It<span class="_ _13"> </span>is<span class="_"> </span>quite<span class="_ _13"> </span>exciting<span class="_"> </span>(even<span class="_ _13"> </span>for<span class="_"> </span>the<span class="_ _13"> </span>authors!)<span class="_"> </span>to</div><div class="t m5 x1d h26 y7de8 ff7 fs19 fc1 sc0 ls0 ws0">point<span class="_ _11"> </span>a<span class="_ _11"> </span>real<span class="_ _11"> </span>browser<span class="_ _11"> </span>at<span class="_ _11"> </span>your<span class="_ _11"> </span>own<span class="_ _16"> </span>server<span class="_"> </span>and<span class="_ _11"> </span>watch<span class="_ _11"> </span>it<span class="_ _16"> </span>display<span class="_"> </span>a<span class="_ _11"> </span>complicated<span class="_ _16"> </span>W<span class="_ _3"></span>eb</div><div class="t m5 x1d h26 y7de9 ff7 fs19 fc1 sc0 ls0 ws0">page<span class="_"> </span>with<span class="_"> </span>text<span class="_"> </span>and<span class="_"> </span>graphics<span class="_ _1"></span>.</div><div class="t m5 x1d h42 y7dea ff6 fs29 fc6 sc0 ls0 ws0">The<span class="_ _11"> </span><span class="ff1b ls2e4">Ti<span class="_ _5"></span>n<span class="_ _be"></span>y<span class="_ _14"> </span></span><span class="ffd fs2b">main<span class="_ _16"> </span></span>Routine</div><div class="t m5 x1d h26 y7deb ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_ _15"> </span>11.29<span class="_ _21"> </span>shows<span class="_ _15"> </span><span class="ff9">T<span class="_ _3"></span>iny<span class="ff7">’s<span class="_ _15"> </span>main<span class="_ _15"> </span>routine<span class="_ _0"></span>.<span class="_ _15"> </span><span class="ff9">T<span class="_ _3"></span>iny<span class="_ _15"> </span><span class="ff7">is<span class="_ _15"> </span>an<span class="_ _21"> </span>iterative<span class="_ _15"> </span>server<span class="_ _15"> </span>that<span class="_ _15"> </span>listens</span></span></span></span></div><div class="t m5 x1d h26 y7dec ff7 fs19 fc1 sc0 ls0 ws0">for<span class="_ _14"> </span>connection<span class="_ _15"> </span>requests<span class="_ _15"> </span>on<span class="_ _15"> </span>the<span class="_ _15"> </span>port<span class="_ _15"> </span>that<span class="_ _14"> </span>is<span class="_ _15"> </span>passed<span class="_ _15"> </span>in<span class="_ _15"> </span>the<span class="_ _15"> </span>command<span class="_ _14"> </span>line.<span class="_ _14"> </span>After</div><div class="t m5 x1d h26 y7ded ff7 fs19 fc1 sc0 ls0 ws0">opening<span class="_"> </span>a<span class="_ _11"> </span>listening<span class="_ _11"> </span>socket<span class="_"> </span>by<span class="_ _11"> </span>calling<span class="_ _11"> </span>the<span class="_"> </span><span class="ffd">open_listenfd<span class="_ _11"> </span></span>function,<span class="_ _11"> </span><span class="ff9">T<span class="_ _3"></span>iny<span class="_ _11"> </span><span class="ff7">executes</span></span></div><div class="t m5 x1d h26 y7dee ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _6"> </span>typical<span class="_ _6"> </span>inﬁnite<span class="_ _13"> </span>server<span class="_ _a"> </span>loop,<span class="_ _6"> </span>repeatedly<span class="_ _6"> </span>accepting<span class="_ _6"> </span>a<span class="_ _13"> </span>connection<span class="_ _a"> </span>request<span class="_ _13"> </span>(line<span class="_ _a"> </span>32),</div><div class="t m5 x1d h26 y7def ff7 fs19 fc1 sc0 ls0 ws0">performing<span class="_"> </span>a<span class="_ _13"> </span>transaction<span class="_"> </span>(line<span class="_"> </span>36),<span class="_ _13"> </span>and<span class="_"> </span>closing<span class="_"> </span>its<span class="_ _13"> </span>end<span class="_"> </span>of<span class="_ _13"> </span>the<span class="_"> </span>connection<span class="_"> </span>(line<span class="_ _13"> </span>37).</div><div class="t m5 x1d h42 y4c74 ff6 fs29 fc6 sc0 ls0 ws0">The<span class="_ _11"> </span><span class="ffd fs2b">doit<span class="_ _16"> </span></span>Function</div><div class="t m5 x1d h26 ye93 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _1f"> </span><span class="ffd ls0">doit<span class="_ _e"> </span><span class="ff7">function<span class="_ _e"> </span>in<span class="_ _e"> </span>F<span class="_ _1"></span>igure<span class="_ _e"> </span>11.30<span class="_ _e"> </span>handles<span class="_ _e"> </span>one<span class="_ _e"> </span>HTTP<span class="_ _e"> </span>transaction.<span class="_ _e"> </span>First,<span class="_ _1f"> </span>we</span></span></div><div class="t m5 x1d h26 y2532 ff7 fs19 fc1 sc0 ls0 ws0">read<span class="_ _11"> </span>and<span class="_ _16"> </span>parse<span class="_ _16"> </span>the<span class="_ _11"> </span>request<span class="_ _16"> </span>line<span class="_ _11"> </span>(lines<span class="_ _16"> </span>11–14).<span class="_ _11"> </span>Notice<span class="_ _16"> </span>that<span class="_ _11"> </span>we<span class="_ _16"> </span>are<span class="_ _16"> </span>using<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffd">rio_</span></div><div class="t m5 x1d h26 y2533 ffd fs19 fc1 sc0 ls0 ws0">readlineb<span class="_ _10"> </span><span class="ff7">function<span class="_"> </span>from<span class="_"> </span>F<span class="_ _0"></span>igure<span class="_"> </span>10.8<span class="_"> </span>to<span class="_"> </span>read<span class="_"> </span>the<span class="_"> </span>request<span class="_"> </span>line<span class="_ _1"></span>.</span></div><div class="t m5 x29 h26 y2534 ff9 fs19 fc1 sc0 ls0 ws0">T<span class="_ _3"></span>iny<span class="_ _16"> </span><span class="ff7">supports<span class="_ _16"> </span>only<span class="_ _16"> </span>the<span class="_ _11"> </span>GET<span class="_ _16"> </span>method.<span class="_ _16"> </span>If<span class="_ _16"> </span>the<span class="_ _16"> </span>client<span class="_ _11"> </span>requests<span class="_ _16"> </span>another<span class="_ _16"> </span>method</span></div><div class="t m5 x1d h26 y2535 ff7 fs19 fc1 sc0 ls0 ws0">(such<span class="_ _15"> </span>as<span class="_ _21"> </span>POST),<span class="_ _e"> </span>we<span class="_ _15"> </span>send<span class="_ _15"> </span>it<span class="_ _21"> </span>an<span class="_ _21"> </span>error<span class="_ _21"> </span>message<span class="_ _21"> </span>and<span class="_ _21"> </span>return<span class="_ _21"> </span>to<span class="_ _21"> </span>the<span class="_ _21"> </span>main<span class="_ _15"> </span>routine</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
