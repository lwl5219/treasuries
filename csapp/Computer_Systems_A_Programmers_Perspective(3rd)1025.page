<div id="pf401" class="pf w2 h11" data-page-no="401"><div class="pc pc401 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg401.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1024<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">want<span class="_"> </span>the<span class="_ _13"> </span>thread<span class="_"> </span>routine<span class="_ _13"> </span>to<span class="_"> </span>return<span class="_ _13"> </span>multiple<span class="_"> </span>arguments<span class="_ _3"></span>,<span class="_"> </span>you<span class="_ _13"> </span>can<span class="_"> </span>return<span class="_ _13"> </span>a<span class="_"> </span>pointer<span class="_ _13"> </span>to</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>structure<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">Line<span class="_"> </span>4<span class="_ _13"> </span>marks<span class="_"> </span>the<span class="_ _13"> </span>beginning<span class="_"> </span>of<span class="_"> </span>the<span class="_ _13"> </span>code<span class="_"> </span>for<span class="_ _13"> </span>the<span class="_"> </span>main<span class="_"> </span>thread.<span class="_ _13"> </span>T<span class="_ _0"></span>he<span class="_"> </span>main<span class="_ _13"> </span>thread</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">declares<span class="_ _11"> </span>a<span class="_ _11"> </span>single<span class="_ _16"> </span>local<span class="_ _11"> </span>variable<span class="_ _11"> </span><span class="ffd">tid</span>,<span class="_ _16"> </span>which<span class="_ _11"> </span>will<span class="_ _11"> </span>be<span class="_ _11"> </span>used<span class="_ _16"> </span>to<span class="_ _11"> </span>store<span class="_ _11"> </span>the<span class="_ _11"> </span>thread<span class="_ _16"> </span>ID<span class="_ _11"> </span>of</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_"> </span>peer<span class="_ _13"> </span>thread<span class="_"> </span>(line<span class="_ _13"> </span>6).<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>main<span class="_ _13"> </span>thread<span class="_"> </span>creates<span class="_ _13"> </span>a<span class="_"> </span>new<span class="_"> </span>peer<span class="_ _13"> </span>thread<span class="_"> </span>by<span class="_ _13"> </span>calling<span class="_"> </span>the</div><div class="t m5 x1d h26 y2f9 ffd fs19 fc2 sc0 ls0 ws0">pthread_create<span class="_ _10"> </span><span class="ff7">function<span class="_ _13"> </span>(line<span class="_"> </span>7).<span class="_ _13"> </span>When<span class="_"> </span>the<span class="_ _13"> </span>call<span class="_"> </span>to<span class="_ _13"> </span></span>pthread_create<span class="_ _10"> </span><span class="ff7">returns<span class="_ _3"></span>,<span class="_"> </span>the</span></div><div class="t m5 x1d h26 y2fa ff7 fs19 fc2 sc0 ls0 ws0">main<span class="_ _13"> </span>thread<span class="_"> </span>and<span class="_ _13"> </span>the<span class="_ _13"> </span>newly<span class="_"> </span>created<span class="_ _13"> </span>peer<span class="_ _13"> </span>thread<span class="_"> </span>are<span class="_ _13"> </span>running<span class="_ _13"> </span>concurrently<span class="_ _3"></span>,<span class="_"> </span>and<span class="_ _13"> </span><span class="ffd">tid</span></div><div class="t m5 x1d h26 y2fb ff7 fs19 fc2 sc0 ls0 ws0">contains<span class="_ _11"> </span>the<span class="_ _11"> </span>ID<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>new<span class="_ _11"> </span>thread.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>main<span class="_ _11"> </span>thread<span class="_ _11"> </span>waits<span class="_ _11"> </span>for<span class="_ _11"> </span>the<span class="_ _16"> </span>peer<span class="_"> </span>thread<span class="_ _11"> </span>to</div><div class="t m5 x1d h26 y2fc ff7 fs19 fc2 sc0 ls0 ws0">terminate<span class="_ _16"> </span>with<span class="_ _11"> </span>the<span class="_ _16"> </span>call<span class="_ _16"> </span>to<span class="_ _16"> </span><span class="ffd">pthread_join<span class="_ _16"> </span></span>in<span class="_ _16"> </span>line<span class="_ _11"> </span>8.<span class="_ _16"> </span>Finally<span class="_ _7"></span>,<span class="_ _16"> </span>the<span class="_ _16"> </span>main<span class="_ _16"> </span>thread<span class="_ _16"> </span>calls</div><div class="t m5 x1d h26 y2fd ffd fs19 fc2 sc0 ls0 ws0">exit<span class="_ _15"> </span><span class="ff7">(line<span class="_ _15"> </span>9),<span class="_ _21"> </span>which<span class="_ _15"> </span>terminates<span class="_ _15"> </span>all<span class="_ _15"> </span>threads<span class="_ _15"> </span>(in<span class="_ _15"> </span>this<span class="_ _15"> </span>case,<span class="_ _15"> </span>just<span class="_ _15"> </span>the<span class="_ _15"> </span>main<span class="_ _15"> </span>thread)</span></div><div class="t m5 x1d h26 y2fe ff7 fs19 fc2 sc0 ls0 ws0">currently<span class="_"> </span>running<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>process<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2ff ff7 fs19 fc2 sc0 ls0 ws0">Lines<span class="_ _11"> </span>12–16<span class="_ _16"> </span>deﬁne<span class="_ _11"> </span>the<span class="_ _11"> </span>thread<span class="_ _16"> </span>routine<span class="_ _11"> </span>for<span class="_ _16"> </span>the<span class="_ _11"> </span>peer<span class="_ _11"> </span>thread.<span class="_ _16"> </span>It<span class="_ _11"> </span>simply<span class="_ _16"> </span>prints<span class="_ _11"> </span>a</div><div class="t m5 x1d h26 y300 ff7 fs19 fc2 sc0 ls0 ws0">string<span class="_"> </span>and<span class="_"> </span>then<span class="_ _11"> </span>terminates<span class="_"> </span>the<span class="_ _11"> </span>peer<span class="_"> </span>thread<span class="_ _11"> </span>by<span class="_"> </span>executing<span class="_ _11"> </span>the<span class="_"> </span><span class="ffd">return<span class="_ _11"> </span></span>statement<span class="_"> </span>in</div><div class="t m5 x1d h26 y21a ff7 fs19 fc2 sc0 ls0 ws0">line<span class="_"> </span>15.</div><div class="t m5 x1d h41 y802b ffe fs29 fc2 sc0 ls0 ws0">12.3.3<span class="_ _48"> </span><span class="fs19">Creating<span class="_"> </span>Threads</span></div><div class="t m5 x1d h26 y802c ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hreads<span class="_"> </span>create<span class="_"> </span>other<span class="_"> </span>threads<span class="_"> </span>by<span class="_"> </span>calling<span class="_"> </span>the<span class="_"> </span><span class="ffd">pthread_create<span class="_ _10"> </span></span>function.</div><div class="t m5 x126 h2d y802d ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;pthread.h&gt;</div><div class="t m5 x126 h2d y802e ffd fs1e fc2 sc0 ls0 ws0">typedef<span class="_ _e"> </span>void<span class="_ _1f"> </span>*(func)(void<span class="_ _1f"> </span>*);</div><div class="t m5 x126 h2d y802f ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>pthread_create(pthread_t<span class="_ _1f"> </span>*tid,<span class="_ _1f"> </span>pthread_attr_t<span class="_ _e"> </span>*attr,</div><div class="t m5 x110 h2d y8030 ffd fs1e fc2 sc0 ls0 ws0">func<span class="_ _e"> </span>*f,<span class="_ _1f"> </span>void<span class="_ _1f"> </span>*arg);</div><div class="t m5 x6a hf1 y8031 ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>0<span class="_"> </span>if<span class="_"> </span>OK,<span class="_"> </span>nonzero<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m5 x1d h26 y8032 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _11"> </span><span class="ffd ls0">pthread_create<span class="_ _10"> </span><span class="ff7">function<span class="_ _13"> </span>creates<span class="_"> </span>a<span class="_"> </span>new<span class="_ _13"> </span>thread<span class="_"> </span>and<span class="_"> </span>runs<span class="_ _13"> </span>the<span class="_"> </span><span class="ffa">thread<span class="_ _13"> </span>routine<span class="_"> </span></span></span>f</span></div><div class="t m5 x1d h26 y8033 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_ _16"> </span>the<span class="_ _14"> </span>context<span class="_ _16"> </span>of<span class="_ _14"> </span>the<span class="_ _16"> </span>new<span class="_ _14"> </span>thread<span class="_ _16"> </span>and<span class="_ _14"> </span>with<span class="_ _16"> </span>an<span class="_ _14"> </span>input<span class="_ _14"> </span>argument<span class="_ _16"> </span>of<span class="_ _14"> </span><span class="ffd">arg</span><span class="ls2e9">.T<span class="_ _9"></span>h<span class="_ _42"></span>e<span class="ffd ls0">attr</span></span></div><div class="t m5 x1d h26 y8034 ff7 fs19 fc2 sc0 ls0 ws0">argument<span class="_ _13"> </span>can<span class="_ _6"> </span>be<span class="_ _13"> </span>used<span class="_ _13"> </span>to<span class="_ _6"> </span>change<span class="_ _13"> </span>the<span class="_ _13"> </span>default<span class="_ _6"> </span>attributes<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>newly<span class="_ _13"> </span>created<span class="_ _13"> </span>thread.</div><div class="t m5 x1d h26 y8035 ff7 fs19 fc2 sc0 ls0 ws0">Changing<span class="_ _6"> </span>these<span class="_ _13"> </span>attributes<span class="_ _6"> </span>is<span class="_ _13"> </span>beyond<span class="_ _6"> </span>our<span class="_ _13"> </span>scope<span class="_ _1"></span>,<span class="_ _13"> </span>and<span class="_ _6"> </span>in<span class="_ _13"> </span>our<span class="_ _6"> </span>examples<span class="_ _1"></span>,<span class="_ _13"> </span>we<span class="_ _6"> </span>will<span class="_ _13"> </span>always</div><div class="t m5 x1d h26 y8036 ff7 fs19 fc2 sc0 ls0 ws0">call<span class="_"> </span><span class="ffd">pthread_create<span class="_ _10"> </span></span>with<span class="_"> </span>a<span class="_"> </span>NULL<span class="_"> </span><span class="ffd">attr<span class="_ _10"> </span></span>argument.</div><div class="t m5 x29 h26 y8037 ff7 fs19 fc2 sc0 ls0 ws0">When<span class="_ _11"> </span><span class="ffd">pthread_create<span class="_ _11"> </span></span>returns<span class="_ _1"></span>,<span class="_ _16"> </span>argument<span class="_ _16"> </span><span class="ffd">tid<span class="_ _11"> </span></span>contains<span class="_ _11"> </span>the<span class="_ _16"> </span>ID<span class="_ _11"> </span>of<span class="_ _16"> </span>the<span class="_ _11"> </span>newly</div><div class="t m5 x1d h26 y8038 ff7 fs19 fc2 sc0 ls0 ws0">created<span class="_ _16"> </span>thread.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>new<span class="_ _16"> </span>thread<span class="_ _16"> </span>can<span class="_ _16"> </span>determine<span class="_ _16"> </span>its<span class="_ _16"> </span>own<span class="_ _16"> </span>thread<span class="_ _16"> </span>ID<span class="_ _16"> </span>by<span class="_ _16"> </span>calling<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 y8039 ffd fs19 fc2 sc0 ls0 ws0">pthread_self<span class="_ _10"> </span><span class="ff7">function.</span></div><div class="t m5 x126 h2d y803a ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;pthread.h&gt;</div><div class="t m5 x126 h2d y803b ffd fs1e fc2 sc0 ls0 ws0">pthread_t<span class="_ _e"> </span>pthread_self(void);</div><div class="t m5 x11a hf1 y803c ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>thread<span class="_"> </span>ID<span class="_"> </span>of<span class="_"> </span>caller</div><div class="t m5 x1d h41 y803d ffe fs29 fc2 sc0 ls0 ws0">12.3.4<span class="_ _48"> </span><span class="fs19">T<span class="_ _3"></span>erminating<span class="_"> </span>Threads</span></div><div class="t m5 x1d h26 y803e ff7 fs19 fc2 sc0 ls0 ws0">A<span class="_"> </span>thread<span class="_"> </span>terminates<span class="_"> </span>in<span class="_"> </span>one<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>ways:</div><div class="t m5 x75 h3d y5b56 ff14 fs26 fc6 sc0 ls0 ws0">.</div><div class="t m5 x29 h26 ye95 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>thread<span class="_"> </span>terminates<span class="_"> </span><span class="ffa">implicitly<span class="_"> </span></span>when<span class="_"> </span>its<span class="_"> </span>top-level<span class="_"> </span>thread<span class="_"> </span>routine<span class="_"> </span>returns<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
