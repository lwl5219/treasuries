<div id="pf247" class="pf w2 h11" data-page-no="247"><div class="pc pc247 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg247.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">582<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>5<span class="_ _3d"> </span>Optimizing<span class="_ _10"> </span>Program<span class="_ _10"> </span>Performance</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>or<span class="_"> </span>the<span class="_"> </span>line<span class="_"> </span>labeled<span class="_"> </span>“<span class="ffd">Product<span class="_ _11"> </span>computation</span>,<span class="_ _0"></span>”<span class="_"> </span>we<span class="_"> </span>can<span class="_"> </span>use<span class="_"> </span>parentheses<span class="_"> </span>to<span class="_"> </span>cre-</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">ate<span class="_"> </span>ﬁve<span class="_"> </span>different<span class="_"> </span>associations<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>computation,<span class="_"> </span>as<span class="_"> </span>follows:</div><div class="t m5 x22b h2d y4eac ffd fs1e fc2 sc0 ls33 ws0">r=(<span class="_ _41"></span>(<span class="_ _41"></span>r*x<span class="_ _41"></span>)*y<span class="_ _41"></span>)*z<span class="_ _41"></span>;/<span class="_ _41"></span>*A<span class="_ _41"></span>1*<span class="_ _41"></span>/</div><div class="t m5 x22b h2d y4ead ffd fs1e fc2 sc0 ls33 ws0">r=(<span class="_ _41"></span>r*(<span class="_ _41"></span>x*y<span class="_ _41"></span>)<span class="_ _41"></span>)*z<span class="_ _41"></span>;/<span class="_ _41"></span>*A<span class="_ _41"></span>2*<span class="_ _41"></span>/</div><div class="t m5 x22b h2d y4eae ffd fs1e fc2 sc0 ls33 ws0">r=r*(<span class="_ _41"></span>(<span class="_ _41"></span>x*y<span class="_ _41"></span>)*z<span class="_ _41"></span>)<span class="_ _41"></span>;/<span class="_ _41"></span>*A<span class="_ _41"></span>3*<span class="_ _41"></span>/</div><div class="t m5 x22b h2d y4eaf ffd fs1e fc2 sc0 ls33 ws0">r=r*(<span class="_ _41"></span>x*(<span class="_ _41"></span>y*<span class="ls0">z));<span class="_ _e"> </span>/*<span class="_ _1f"> </span>A4<span class="_ _1f"> </span>*/</span></div><div class="t m5 x22b h2d y4eb0 ffd fs1e fc2 sc0 ls33 ws0">r=(<span class="_ _41"></span>r*x<span class="_ _41"></span>)*(<span class="_ _41"></span>y*z<span class="_ _41"></span>)<span class="_ _41"></span>;/<span class="_ _41"></span>*A<span class="_ _41"></span>5*<span class="_ _41"></span>/</div><div class="t m5 x1d h26 y4eb1 ff7 fs19 fc2 sc0 ls0 ws0">Assume<span class="_"> </span>we<span class="_"> </span>run<span class="_ _13"> </span>these<span class="_"> </span>functions<span class="_"> </span>on<span class="_"> </span>a<span class="_"> </span>machine<span class="_ _13"> </span>where<span class="_"> </span>ﬂoating-point<span class="_"> </span>multiplication</div><div class="t m5 x1d h26 y4eb2 ff7 fs19 fc2 sc0 ls0 ws0">has<span class="_ _14"> </span>a<span class="_ _14"> </span>latency<span class="_ _16"> </span>of<span class="_ _14"> </span>5<span class="_ _14"> </span>clock<span class="_ _14"> </span>cycles<span class="_ _1"></span>.<span class="_ _14"> </span>Determine<span class="_ _14"> </span>the<span class="_ _14"> </span>lower<span class="_ _14"> </span>bound<span class="_ _14"> </span>on<span class="_ _14"> </span>the<span class="_ _14"> </span>CPE<span class="_ _14"> </span>set<span class="_ _14"> </span>by</div><div class="t m5 x1d h26 y4eb3 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>data<span class="_ _16"> </span>dependencies<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>multiplication.<span class="_ _14"> </span>(<span class="ffa">Hint:<span class="_ _16"> </span></span>It<span class="_ _16"> </span>helps<span class="_ _16"> </span>to<span class="_ _14"> </span>draw<span class="_ _16"> </span>a<span class="_ _16"> </span>data-ﬂow</div><div class="t m5 x1d h26 y4eb4 ff7 fs19 fc2 sc0 ls0 ws0">representation<span class="_"> </span>of<span class="_"> </span>how<span class="_"> </span><span class="ffd">r<span class="_ _10"> </span></span>is<span class="_"> </span>computed<span class="_"> </span>on<span class="_"> </span>every<span class="_"> </span>iteration.)</div><div class="t m5 x28 h2a y4eb5 fff fs1c fc2 sc0 ls0 ws0">W<span class="_ _1"></span>eb<span class="_ _16"> </span>Aside<span class="_ _14"> </span>OPT:SIMD<span class="_ _1b"> </span><span class="ff6 fs19">Achieving<span class="_ _11"> </span>greater<span class="_ _11"> </span>parallelism<span class="_ _11"> </span>with<span class="_ _16"> </span>vector<span class="_ _11"> </span>instructions</span></div><div class="t m5 x28 h2b y4eb6 ff7 fs1e fc2 sc0 ls0 ws0">As<span class="_ _6"> </span>described<span class="_ _13"> </span>in<span class="_ _6"> </span>Section<span class="_ _13"> </span>3.1,<span class="_ _6"> </span>Intel<span class="_ _13"> </span>introduced<span class="_ _6"> </span>the<span class="_ _13"> </span>SSE<span class="_ _6"> </span>instructions<span class="_ _6"> </span>in<span class="_ _13"> </span>1999,<span class="_ _6"> </span>where<span class="_ _13"> </span>SSE<span class="_ _6"> </span>is<span class="_ _13"> </span>the<span class="_ _6"> </span>acronym<span class="_ _13"> </span>for</div><div class="t m5 x28 h2b y4eb7 ff7 fs1e fc2 sc0 ls0 ws0">“streaming<span class="_"> </span>SIMD<span class="_"> </span>extensions”<span class="_"> </span>and,<span class="_"> </span>in<span class="_"> </span>turn,<span class="_"> </span>SIMD<span class="_"> </span>(pronounced<span class="_"> </span>“sim-dee”)<span class="_"> </span>is<span class="_"> </span>the<span class="_"> </span>acronym<span class="_"> </span>for<span class="_"> </span>“single</div><div class="t m5 x28 h2b y4eb8 ff7 fs1e fc2 sc0 ls0 ws0">instruction,<span class="_ _21"> </span>multiple<span class="_ _21"> </span>data.<span class="_ _1"></span>”<span class="_ _15"> </span>The<span class="_ _14"> </span>SSE<span class="_ _15"> </span>capability<span class="_ _21"> </span>has<span class="_ _15"> </span>gone<span class="_ _15"> </span>through<span class="_ _15"> </span>multiple<span class="_ _21"> </span>generations<span class="_ _1"></span>,<span class="_ _f"> </span>with<span class="_ _15"> </span>more</div><div class="t m5 x28 h2b y4eb9 ff7 fs1e fc2 sc0 ls0 ws0">recent<span class="_ _13"> </span>versions<span class="_ _6"> </span>being<span class="_ _13"> </span>named<span class="_ _13"> </span><span class="ffa">advanced<span class="_ _6"> </span>vector<span class="_ _13"> </span>extensions</span>,<span class="_ _13"> </span>or<span class="_ _6"> </span>A<span class="_ _7"></span>VX.<span class="_ _13"> </span>T<span class="_ _1"></span>he<span class="_ _13"> </span>SIMD<span class="_ _13"> </span>execution<span class="_ _6"> </span>model<span class="_ _13"> </span>involves</div><div class="t m5 x28 h2b y4eba ff7 fs1e fc2 sc0 ls0 ws0">operating<span class="_"> </span>on<span class="_"> </span>entire<span class="_"> </span>vectors<span class="_"> </span>of<span class="_"> </span>data<span class="_"> </span>within<span class="_"> </span>single<span class="_"> </span>instructions<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>hese<span class="_"> </span>vectors<span class="_"> </span>are<span class="_"> </span>held<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>special<span class="_"> </span>set<span class="_"> </span>of</div><div class="t m5 x28 h2b y4ebb ffa fs1e fc2 sc0 ls0 ws0">vector<span class="_"> </span>registers<span class="ff7">,<span class="_ _10"> </span>named<span class="_ _10"> </span><span class="ffd">%ymm0</span>–<span class="ffd">%ymm15</span>.<span class="_ _10"> </span>Current<span class="_ _11"> </span>A<span class="_ _7"></span>VX<span class="_"> </span>vector<span class="_"> </span>registers<span class="_ _10"> </span>are<span class="_ _10"> </span>32<span class="_ _10"> </span>bytes<span class="_ _11"> </span>long,<span class="_"> </span>and<span class="_"> </span>therefore</span></div><div class="t m5 x28 h2b y4ebc ff7 fs1e fc2 sc0 ls0 ws0">each<span class="_ _11"> </span>can<span class="_ _11"> </span>hold<span class="_ _11"> </span>eight<span class="_ _10"> </span>32-bit<span class="_ _11"> </span>numbers<span class="_ _11"> </span>or<span class="_ _11"> </span>four<span class="_ _11"> </span>64-bit<span class="_ _11"> </span>numbers<span class="_ _1"></span>,<span class="_ _16"> </span>where<span class="_ _10"> </span>the<span class="_ _11"> </span>numbers<span class="_ _11"> </span>can<span class="_ _11"> </span>be<span class="_ _11"> </span>either<span class="_ _11"> </span>integer</div><div class="t m5 x28 h2b y4ebd ff7 fs1e fc2 sc0 ls0 ws0">or<span class="_"> </span>ﬂoating-point<span class="_"> </span>values<span class="_ _1"></span>.<span class="_"> </span>A<span class="_ _7"></span>VX<span class="_"> </span>instructions<span class="_"> </span>can<span class="_"> </span>then<span class="_ _13"> </span>perform<span class="_"> </span>vector<span class="_"> </span>operations<span class="_"> </span>on<span class="_"> </span>these<span class="_"> </span>registers<span class="_ _3"></span>,<span class="_"> </span>such</div><div class="t m5 x28 h2b y4ebe ff7 fs1e fc2 sc0 ls0 ws0">as<span class="_ _11"> </span>adding<span class="_ _11"> </span>or<span class="_ _11"> </span>multiplying<span class="_ _11"> </span>eight<span class="_ _11"> </span>or<span class="_ _11"> </span>four<span class="_ _11"> </span>sets<span class="_ _11"> </span>of<span class="_ _11"> </span>values<span class="_ _11"> </span>in<span class="_ _11"> </span>parallel.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>example,<span class="_ _11"> </span>if<span class="_ _11"> </span>YMM<span class="_ _11"> </span>register<span class="_ _11"> </span><span class="ffd">%ymm0</span></div><div class="t m5 x28 h2b y4ebf ff7 fs1e fc2 sc0 ls0 ws0">contains<span class="_"> </span>eight<span class="_"> </span>single-precision<span class="_ _13"> </span>ﬂoating-point<span class="_"> </span>numbers<span class="_ _3"></span>,<span class="_"> </span>which<span class="_"> </span>we<span class="_"> </span>denote<span class="_ _13"> </span><span class="ff11">a</span></div><div class="t m5 x84 h48 y4ec0 ff7 fs2c fc2 sc0 ls0 ws0">0</div><div class="t m5 x144 h49 y4ec1 ff11 fs1e fc2 sc0 ls220 ws0">,...,a</div><div class="t m5 x1e1 h48 y4ec0 ff7 fs2c fc2 sc0 ls0 ws0">7</div><div class="t m5 x24b h2b y4ec1 ff7 fs1e fc2 sc0 ls0 ws0">,<span class="_"> </span>and<span class="_"> </span><span class="ffd">%rcx<span class="_ _13"> </span></span>contains</div><div class="t m5 x28 h2b y4ec2 ff7 fs1e fc2 sc0 ls0 ws0">the<span class="_ _10"> </span>memory<span class="_ _11"> </span>address<span class="_ _11"> </span>of<span class="_"> </span>a<span class="_ _11"> </span>sequence<span class="_ _11"> </span>of<span class="_ _10"> </span>eight<span class="_ _11"> </span>single-precision<span class="_ _11"> </span>ﬂoating-point<span class="_ _10"> </span>numbers<span class="_ _0"></span>,<span class="_ _10"> </span>which<span class="_ _11"> </span>we<span class="_ _11"> </span>denote</div><div class="t m5 x28 h49 y4ec3 ff11 fs1e fc2 sc0 ls0 ws0">b</div><div class="t m5 xca h48 y4ec4 ff7 fs2c fc2 sc0 ls0 ws0">0</div><div class="t m5 x21c h49 y4ec5 ff11 fs1e fc2 sc0 ls6e ws0">,...,b</div><div class="t m5 x15d h48 y4ec4 ff7 fs2c fc2 sc0 ls0 ws0">7</div><div class="t m5 x2d h2b y4ec5 ff7 fs1e fc2 sc0 ls0 ws0">,<span class="_"> </span>then<span class="_"> </span>the<span class="_"> </span>instruction</div><div class="t m5 x243 h2d y4ec6 ffd fs1e fc2 sc0 ls0 ws0">vmulps<span class="_ _1a"> </span>(%rcs),<span class="_ _e"> </span>%ymm0,<span class="_ _1f"> </span>%ymm1</div><div class="t m5 x28 h2b y4ec7 ff7 fs1e fc2 sc0 ls0 ws0">will<span class="_ _21"> </span>read<span class="_ _21"> </span>the<span class="_ _21"> </span>eight<span class="_ _21"> </span>values<span class="_ _21"> </span>from<span class="_ _21"> </span>memory<span class="_ _21"> </span>and<span class="_ _21"> </span>perform<span class="_ _21"> </span>eight<span class="_ _21"> </span>multiplications<span class="_ _21"> </span>in<span class="_ _21"> </span>parallel,<span class="_ _e"> </span>computing</div><div class="t m5 x28 h49 y4ec8 ff11 fs1e fc2 sc0 ls0 ws0">a</div><div class="t m5 xca h54 y4ec9 ff11 fs2c fc2 sc0 ls0 ws0">i</div><div class="t m5 x25a h4a y4eca ff12 fs1e fc2 sc0 ls0 ws0">←<span class="_ _25"> </span><span class="ff11">a</span></div><div class="t m5 x26 h54 y4ec9 ff11 fs2c fc2 sc0 ls0 ws0">i</div><div class="t m5 x2e h49 y4ecb ff11 fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x146 h49 y4ecc ff11 fs1e fc2 sc0 ls0 ws0">b</div><div class="t m5 x19f h54 y4ec9 ff11 fs2c fc2 sc0 ls0 ws0">i</div><div class="t m5 x30 h4a y4eca ff7 fs1e fc2 sc0 ls0 ws0">,<span class="_ _16"> </span>for<span class="_ _16"> </span>0<span class="_"> </span><span class="ff12">≤<span class="_ _13"> </span><span class="ff11">i<span class="_"> </span></span>≤<span class="_ _13"></span></span>7<span class="_ _16"> </span>and<span class="_ _11"> </span>storing<span class="_ _16"> </span>the<span class="_ _16"> </span>resulting<span class="_ _16"> </span>eight<span class="_ _16"> </span>products<span class="_ _16"> </span>in<span class="_ _16"> </span>vector<span class="_ _16"> </span>register<span class="_ _16"> </span><span class="ffd">%ymm1</span>.<span class="_ _16"> </span>W<span class="_ _3"></span>e<span class="_ _16"> </span>see</div><div class="t m5 x28 h2b y4ecd ff7 fs1e fc2 sc0 ls0 ws0">that<span class="_ _11"> </span>a<span class="_ _11"> </span>single<span class="_ _16"> </span>instruction<span class="_ _11"> </span>is<span class="_ _11"> </span>able<span class="_ _16"> </span>to<span class="_ _11"> </span>generate<span class="_ _11"> </span>a<span class="_ _16"> </span>computation<span class="_ _11"> </span>over<span class="_ _11"> </span>multiple<span class="_ _11"> </span>data<span class="_ _16"> </span>values<span class="_ _1"></span>,<span class="_ _16"> </span>hence<span class="_ _11"> </span>the<span class="_ _11"> </span>term</div><div class="t m5 x28 h2b y4ece ff7 fs1e fc2 sc0 ls0 ws0">“SIMD<span class="_ _3"></span>.<span class="_ _1"></span>”</div><div class="t m5 x57 h2b y4ecf ff9 fs1e fc2 sc0 ls0 ws0">gcc<span class="_ _16"> </span><span class="ff7">supports<span class="_ _16"> </span>extensions<span class="_ _11"> </span>to<span class="_ _16"> </span>the<span class="_ _16"> </span>C<span class="_ _16"> </span>language<span class="_ _16"> </span>that<span class="_ _16"> </span>let<span class="_ _16"> </span>programmers<span class="_ _11"> </span>express<span class="_ _16"> </span>a<span class="_ _16"> </span>program<span class="_ _16"> </span>in<span class="_ _16"> </span>terms<span class="_ _16"> </span>of</span></div><div class="t m5 x28 h2b y4ed0 ff7 fs1e fc2 sc0 ls0 ws0">vector<span class="_ _16"> </span>operations<span class="_ _14"> </span>that<span class="_ _14"> </span>can<span class="_ _16"> </span>be<span class="_ _14"> </span>compiled<span class="_ _14"> </span>into<span class="_ _16"> </span>the<span class="_ _14"> </span>vector<span class="_ _16"> </span>instructions<span class="_ _14"> </span>of<span class="_ _14"> </span>A<span class="_ _7"></span>VX<span class="_ _16"> </span>(as<span class="_ _14"> </span>well<span class="_ _14"> </span>as<span class="_ _16"> </span>code<span class="_ _14"> </span>based</div><div class="t m5 x28 h2b y4ed1 ff7 fs1e fc2 sc0 ls0 ws0">on<span class="_ _16"> </span>the<span class="_ _16"> </span>earlier<span class="_ _16"> </span>SSE<span class="_ _16"> </span>instructions).<span class="_ _16"> </span>T<span class="_ _1"></span>his<span class="_ _16"> </span>coding<span class="_ _16"> </span>style<span class="_ _16"> </span>is<span class="_ _16"> </span>preferable<span class="_ _16"> </span>to<span class="_ _16"> </span>writing<span class="_ _16"> </span>code<span class="_ _16"> </span>directly<span class="_ _16"> </span>in<span class="_ _16"> </span>assembly</div><div class="t m5 x28 h2b y4ed2 ff7 fs1e fc2 sc0 ls0 ws0">language<span class="_ _1"></span>,<span class="_"> </span>since<span class="_"> </span><span class="ff9">gcc<span class="_ _10"> </span></span>can<span class="_"> </span>also<span class="_"> </span>generate<span class="_"> </span>code<span class="_"> </span>for<span class="_"> </span>the<span class="_"> </span>vector<span class="_"> </span>instructions<span class="_"> </span>found<span class="_"> </span>on<span class="_"> </span>other<span class="_"> </span>processors<span class="_ _1"></span>.</div><div class="t m5 x57 h2b y4ed3 ff7 fs1e fc2 sc0 ls0 ws0">Using<span class="_ _13"> </span>a<span class="_ _13"> </span>combination<span class="_"> </span>of<span class="_ _13"> </span><span class="ff9">gcc<span class="_ _13"> </span></span>instructions<span class="_ _3"></span>,<span class="_"> </span>loop<span class="_ _13"> </span>unrolling,<span class="_ _13"> </span>and<span class="_ _13"> </span>multiple<span class="_ _13"> </span>accumulators<span class="_ _1"></span>,<span class="_"> </span>we<span class="_ _13"> </span>are<span class="_ _13"> </span>able<span class="_ _13"> </span>to</div><div class="t m5 x28 h2b y4ed4 ff7 fs1e fc2 sc0 ls0 ws0">achieve<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>performance<span class="_"> </span>for<span class="_"> </span>our<span class="_"> </span>combining<span class="_"> </span>functions:</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
