<div id="pf310" class="pf w2 h11" data-page-no="310"><div class="pc pc310 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg310.png"/><div class="t m5 x100 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>8.4<span class="_ _60"> </span>Process<span class="_ _10"> </span>Control<span class="_ _3e"> </span><span class="ffe fs1e">783</span></div><div class="t m5 x220 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/ecf/waitpid1.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">#include<span class="_ _1f"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">#define<span class="_ _1f"> </span>N<span class="_ _e"> </span>2</span></div><div class="t m5 x2c h2e y283 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2c h2e y5fd0 ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2d h2d y284 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>main()</div><div class="t m5 x2c h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">int<span class="_ _e"> </span>status,<span class="_ _1f"> </span>i;</span></div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">pid_t<span class="_ _e"> </span>pid;</span></div><div class="t m5 x2c h2e y4493 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 x2c h2e y66b4 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x142 h2d y4a9a ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Parent<span class="_ _1f"> </span>creates<span class="_ _1f"> </span>N<span class="_ _e"> </span>children<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _20"> </span><span class="ffd fs1e fc2 ls33">f<span class="_ _41"></span>o<span class="_ _41"></span>r(<span class="_ _41"></span>i=0<span class="_ _41"></span>;i&lt;N<span class="_ _41"></span>;<span class="ls0">i++)</span></span></div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>((pid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>Fork())<span class="_ _e"> </span>==<span class="_ _1f"> </span>0)<span class="_ _1a"> </span>/*<span class="_ _e"> </span>Child<span class="_ _1f"> </span>*/</span></div><div class="t m5 x17 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _d1"> </span><span class="ffd fs1e fc2">exit(100+i);</span></div><div class="t m5 x17 h2e y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13</div><div class="t m5 x17 h2e y66b5 ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x142 h2d y4a9e ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Parent<span class="_ _1f"> </span>reaps<span class="_ _1f"> </span>N<span class="_ _e"> </span>children<span class="_ _1f"> </span>in<span class="_ _e"> </span>no<span class="_ _1f"> </span>particular<span class="_ _1f"> </span>order<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _20"> </span><span class="ffd fs1e fc2">while<span class="_ _e"> </span>((pid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>waitpid(-1,<span class="_ _e"> </span>&amp;status,<span class="_ _1f"> </span>0))<span class="_ _e"> </span>&gt;<span class="_ _1f"> </span>0)<span class="_ _1f"> </span>{</span></div><div class="t m5 x17 h2d y417 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _70"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(WIFEXITED(status))</span></div><div class="t m5 x17 h2d y4aa0 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _d1"> </span><span class="ffd fs1e fc2">printf(&quot;child<span class="_ _1f"> </span>%d<span class="_ _e"> </span>terminated<span class="_ _1f"> </span>normally<span class="_ _e"> </span>with<span class="_ _1f"> </span>exit<span class="_ _1f"> </span>status=%d\n&quot;,</span></div><div class="t m5 x17 h2d yeb4 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _20e"> </span><span class="ffd fs1e fc2">pid,<span class="_ _e"> </span>WEXITSTATUS(status));</span></div><div class="t m5 x17 h2d y2a2b ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _70"> </span><span class="ffd fs1e fc2">else</span></div><div class="t m5 x17 h2d y1ab8 ff6 fs20 fc6 sc0 ls0 ws0">20<span class="_ _d1"> </span><span class="ffd fs1e fc2">printf(&quot;child<span class="_ _1f"> </span>%d<span class="_ _e"> </span>terminated<span class="_ _1f"> </span>abnormally\n&quot;,<span class="_ _e"> </span>pid);</span></div><div class="t m5 x17 h2e y94f ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x142 h2d y1ada ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x17 h2e y4aa1 ff6 fs20 fc6 sc0 ls0 ws0">22</div><div class="t m5 x17 h2e y4aa2 ff6 fs20 fc6 sc0 ls0 ws0">23</div><div class="t m5 x142 h2d y3228 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>The<span class="_ _1f"> </span>only<span class="_ _1f"> </span>normal<span class="_ _e"> </span>termination<span class="_ _1f"> </span>is<span class="_ _e"> </span>if<span class="_ _1f"> </span>there<span class="_ _1f"> </span>are<span class="_ _e"> </span>no<span class="_ _1f"> </span>more<span class="_ _e"> </span>children<span class="_ _1f"> </span>*/</div><div class="t m5 x17 h2d y35d ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _20"> </span><span class="ffd fs1e fc2">if<span class="_ _e"> </span>(errno<span class="_ _1f"> </span>!=<span class="_ _1f"> </span>ECHILD)</span></div><div class="t m5 x17 h2e y4aa3 ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 xc5 h2d y3229 ffd fs1e fc2 sc0 ls0 ws0">unix_error(&quot;waitpid<span class="_ _e"> </span>error&quot;);</div><div class="t m5 x17 h2e y2467 ff6 fs20 fc6 sc0 ls0 ws0">26</div><div class="t m5 x17 h2e y66b6 ff6 fs20 fc6 sc0 ls0 ws0">27</div><div class="t m5 x142 h2d y322b ffd fs1e fc2 sc0 ls0 ws0">exit(0);</div><div class="t m5 x17 h2d y322c ff6 fs20 fc6 sc0 ls0 ws0">28<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x220 h2c y66b7 ffa fs16 fc2 sc0 ls0 ws0">code/ecf/waitpid1.c</div><div class="t m5 x17 h2f y66b8 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>8.18<span class="_ _66"> </span><span class="fc1">Using<span class="_"> </span>the</span></div><div class="t m5 x22b h3a y1fd9 ffd fs19 fc1 sc0 ls0 ws0">waitpid<span class="_ _10"> </span><span class="ffe fs16">function<span class="_"> </span>to<span class="_"> </span>reap<span class="_"> </span>zombie<span class="_"> </span>children<span class="_"> </span>in<span class="_"> </span>no<span class="_"> </span>particular<span class="_"> </span>order<span class="_ _1"></span>.</span></div><div class="t m5 x17 h26 ye4e ff7 fs19 fc1 sc0 ls0 ws0">Before<span class="_"> </span>moving<span class="_"> </span>on,<span class="_"> </span>make<span class="_ _11"> </span>sure<span class="_"> </span>you<span class="_"> </span>understand<span class="_"> </span>why<span class="_ _11"> </span>line<span class="_"> </span>12<span class="_"> </span>is<span class="_ _11"> </span>executed<span class="_"> </span>by<span class="_"> </span>each<span class="_"> </span>of</div><div class="t m5 x17 h26 ye4f ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_"> </span>children,<span class="_"> </span>but<span class="_"> </span>not<span class="_"> </span>the<span class="_"> </span>parent.</div><div class="t m5 x26 h26 ye50 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_ _13"> </span>line<span class="_ _13"> </span>15,<span class="_ _13"> </span>the<span class="_ _6"> </span>parent<span class="_ _13"> </span>waits<span class="_ _13"> </span>for<span class="_ _13"> </span>all<span class="_ _6"> </span>of<span class="_ _13"> </span>its<span class="_ _13"> </span>children<span class="_ _13"> </span>to<span class="_ _13"> </span>terminate<span class="_ _6"> </span>by<span class="_ _13"> </span>using<span class="_ _13"> </span><span class="ffd">waitpid</span></div><div class="t m5 x17 h46 ye51 ff7 fs19 fc1 sc0 ls0 ws0">as<span class="_"> </span>the<span class="_"> </span>test<span class="_"> </span>condition<span class="_"> </span>of<span class="_"> </span>a<span class="_ _13"> </span><span class="ffd">while<span class="_ _10"> </span></span>loop.<span class="_"> </span>Because<span class="_ _13"> </span>the<span class="_"> </span>ﬁrst<span class="_"> </span>argument<span class="_"> </span>is<span class="_"> </span><span class="ff12">−</span>1<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>call<span class="_"> </span>to</div><div class="t m5 x17 h26 ye52 ffd fs19 fc1 sc0 ls0 ws0">waitpid<span class="_ _10"> </span><span class="ff7">blocks<span class="_"> </span>until<span class="_"> </span>an<span class="_"> </span>arbitrary<span class="_"> </span>child<span class="_"> </span>has<span class="_"> </span>terminated.<span class="_"> </span>As<span class="_"> </span>each<span class="_"> </span>child<span class="_"> </span>terminates<span class="_ _3"></span>,</span></div><div class="t m5 x17 h26 ye53 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span>call<span class="_"> </span>to<span class="_ _13"> </span><span class="ffd">waitpid<span class="_ _10"> </span></span>returns<span class="_ _13"> </span>with<span class="_"> </span>the<span class="_ _13"> </span>nonzero<span class="_ _13"> </span>PID<span class="_"> </span>of<span class="_ _13"> </span>that<span class="_"> </span>child.<span class="_ _13"> </span>Line<span class="_"> </span>16<span class="_ _13"> </span>checks<span class="_ _13"> </span>the</div><div class="t m5 x17 h26 ye54 ff7 fs19 fc1 sc0 ls0 ws0">exit<span class="_ _11"> </span>status<span class="_ _16"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span>child.<span class="_ _11"> </span>If<span class="_ _16"> </span>the<span class="_ _11"> </span>child<span class="_ _16"> </span>terminated<span class="_ _11"> </span>normally—in<span class="_ _11"> </span>this<span class="_ _16"> </span>case<span class="_ _1"></span>,<span class="_ _16"> </span>by<span class="_ _16"> </span>calling</div><div class="t m5 x17 h26 ye55 ff7 fs19 fc1 sc0 ls0 ws0">the<span class="_ _13"> </span><span class="ffd">exit<span class="_ _6"> </span></span>function—then<span class="_ _13"> </span>the<span class="_ _13"> </span>parent<span class="_ _6"> </span>extracts<span class="_ _13"> </span>the<span class="_ _13"> </span>exit<span class="_ _13"> </span>status<span class="_ _6"> </span>and<span class="_ _13"> </span>prints<span class="_ _13"> </span>it<span class="_ _6"> </span>on<span class="_ _13"> </span><span class="ffd">stdout</span>.</div><div class="t m5 x26 h46 ye56 ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _6"> </span>all<span class="_ _6"> </span>of<span class="_ _13"> </span>the<span class="_ _6"> </span>children<span class="_ _13"> </span>have<span class="_ _6"> </span>been<span class="_ _13"> </span>reaped,<span class="_ _6"> </span>the<span class="_ _13"> </span>next<span class="_ _6"> </span>call<span class="_ _6"> </span>to<span class="_ _13"> </span><span class="ffd">waitpid<span class="_ _6"> </span></span>returns<span class="_ _13"> </span><span class="ff12">−</span>1</div><div class="t m5 x17 h26 ye57 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_ _13"> </span>sets<span class="_"> </span><span class="ffd">errno<span class="_ _13"> </span></span>to<span class="_"> </span>ECHILD<span class="_ _3"></span>.<span class="_ _13"> </span>Line<span class="_"> </span>24<span class="_ _13"> </span>checks<span class="_"> </span>that<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">waitpid<span class="_ _13"> </span></span>function<span class="_ _13"> </span>terminated</div><div class="t m5 x17 h26 ye58 ff7 fs19 fc1 sc0 ls0 ws0">normally<span class="_ _3"></span>,<span class="_ _16"> </span>and<span class="_ _16"> </span>prints<span class="_ _16"> </span>an<span class="_ _16"> </span>error<span class="_ _16"> </span>message<span class="_ _16"> </span>otherwise<span class="_ _1"></span>.<span class="_ _16"> </span>When<span class="_ _16"> </span>we<span class="_ _16"> </span>run<span class="_ _16"> </span>the<span class="_ _16"> </span>program<span class="_ _16"> </span>on</div><div class="t m5 x17 h26 ye59 ff7 fs19 fc1 sc0 ls0 ws0">our<span class="_"> </span>Linux<span class="_"> </span>system,<span class="_"> </span>it<span class="_"> </span>produces<span class="_"> </span>the<span class="_"> </span>following<span class="_"> </span>output:</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
