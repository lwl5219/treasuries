<div id="pf405" class="pf w2 h11" data-page-no="405"><div class="pc pc405 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg405.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1028<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x1d h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _11"> </span>connected<span class="_ _16"> </span>descriptor<span class="_ _11"> </span>to<span class="_ _11"> </span>the<span class="_ _11"> </span>peer<span class="_ _16"> </span>thread<span class="_ _11"> </span>when<span class="_ _11"> </span>we<span class="_ _16"> </span>call<span class="_ _11"> </span><span class="ffd">pthread_create</span><span class="ls2ea">.T<span class="_ _42"></span>h<span class="_ _49"></span>e</span></div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">obvious<span class="_"> </span>approach<span class="_"> </span>is<span class="_"> </span>to<span class="_"> </span>pass<span class="_"> </span>a<span class="_"> </span>pointer<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>descriptor,<span class="_"> </span>as<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>following:</div><div class="t m5 x10c h2d y8090 ffd fs1e fc2 sc0 ls0 ws0">connfd<span class="_ _e"> </span>=<span class="_ _1f"> </span>Accept(listenfd,<span class="_ _1f"> </span>(SA<span class="_ _e"> </span>*)<span class="_ _1f"> </span>&amp;clientaddr,<span class="_ _e"> </span>&amp;clientlen);</div><div class="t m5 x10c h2d y8091 ffd fs1e fc2 sc0 ls0 ws0">Pthread_create(&amp;tid,<span class="_ _e"> </span>NULL,<span class="_ _1f"> </span>thread,<span class="_ _1f"> </span>&amp;connfd);</div><div class="t m5 x1d h26 y8092 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>hen<span class="_ _15"> </span>we<span class="_ _15"> </span>have<span class="_ _14"> </span>the<span class="_ _15"> </span>peer<span class="_ _15"> </span>thread<span class="_ _14"> </span>dereference<span class="_ _15"> </span>the<span class="_ _15"> </span>pointer<span class="_ _14"> </span>and<span class="_ _15"> </span>assign<span class="_ _15"> </span>it<span class="_ _14"> </span>to<span class="_ _15"> </span>a<span class="_ _15"> </span>local</div><div class="t m5 x1d h26 y8093 ff7 fs19 fc2 sc0 ls0 ws0">variable<span class="_ _1"></span>,<span class="_"> </span>as<span class="_"> </span>follows:</div><div class="t m5 x10c h2d y8094 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>*thread(void<span class="_ _1f"> </span>*vargp)<span class="_ _1f"> </span>{</div><div class="t m5 x22b h2d y8095 ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>connfd<span class="_ _1f"> </span>=<span class="_ _1f"> </span>*((int<span class="_ _e"> </span>*)vargp);</div><div class="t m5 x22b h2d y8096 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x22b h2d y8097 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x22b h2d y8098 ffd fs1e fc2 sc0 ls0 ws0">.</div><div class="t m5 x10c h2d y8099 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x1d h26 y809a ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>his<span class="_ _16"> </span>would<span class="_"> </span>be<span class="_ _16"> </span>wrong<span class="_ _0"></span>,<span class="_ _11"> </span>however,<span class="_ _11"> </span>because<span class="_ _11"> </span>it<span class="_ _16"> </span>introduces<span class="_"> </span>a<span class="_ _16"> </span><span class="ffa">race<span class="_ _11"> </span></span>between<span class="_ _11"> </span>the<span class="_ _11"> </span>assign-</div><div class="t m5 x1d h26 y809b ff7 fs19 fc2 sc0 ls0 ws0">ment<span class="_ _13"> </span>statement<span class="_ _13"> </span>in<span class="_ _6"> </span>the<span class="_ _13"> </span>peer<span class="_ _13"> </span>thread<span class="_ _13"> </span>and<span class="_ _13"> </span>the<span class="_ _13"> </span><span class="ffd">accept<span class="_ _6"> </span></span>statement<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>main<span class="_ _13"> </span>thread.<span class="_ _6"> </span>If</div><div class="t m5 x1d h26 y809c ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _6"> </span>assignment<span class="_ _13"> </span>statement<span class="_ _6"> </span>completes<span class="_ _6"> </span>before<span class="_ _13"> </span>the<span class="_ _6"> </span>next<span class="_ _6"> </span><span class="ffd">accept</span>,<span class="_ _13"> </span>then<span class="_ _6"> </span>the<span class="_ _13"> </span>local<span class="_ _6"> </span><span class="ffd">connfd</span></div><div class="t m5 x1d h26 y809d ff7 fs19 fc2 sc0 ls0 ws0">variable<span class="_ _11"> </span>in<span class="_ _11"> </span>the<span class="_ _16"> </span>peer<span class="_ _11"> </span>thread<span class="_ _11"> </span>gets<span class="_ _16"> </span>the<span class="_"> </span>correct<span class="_ _16"> </span>descriptor<span class="_ _11"> </span>value<span class="_ _0"></span>.<span class="_ _11"> </span>However,<span class="_ _11"> </span>if<span class="_ _11"> </span>the<span class="_ _16"> </span>as-</div><div class="t m5 x1d h26 y809e ff7 fs19 fc2 sc0 ls0 ws0">signment<span class="_ _11"> </span>completes<span class="_ _16"> </span><span class="ffa">after<span class="_ _16"> </span></span>the<span class="_ _11"> </span><span class="ffd">accept</span>,<span class="_ _16"> </span>then<span class="_ _11"> </span>the<span class="_ _16"> </span>local<span class="_ _11"> </span><span class="ffd">connfd<span class="_ _11"> </span></span>variable<span class="_ _16"> </span>in<span class="_ _11"> </span>the<span class="_ _11"> </span>peer</div><div class="t m5 x1d h26 y809f ff7 fs19 fc2 sc0 ls0 ws0">thread<span class="_ _11"> </span>gets<span class="_ _11"> </span>the<span class="_ _11"> </span>descriptor<span class="_ _11"> </span>number<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _16"> </span><span class="ffa">next<span class="_ _16"> </span></span>connection.<span class="_ _11"> </span>T<span class="_ _0"></span>he<span class="_ _11"> </span>unhappy<span class="_ _11"> </span>result<span class="_ _11"> </span>is</div><div class="t m5 x1d h26 y80a0 ff7 fs19 fc2 sc0 ls0 ws0">that<span class="_"> </span>two<span class="_ _13"> </span>threads<span class="_"> </span>are<span class="_"> </span>now<span class="_"> </span>performing<span class="_ _13"> </span>input<span class="_"> </span>and<span class="_"> </span>output<span class="_ _13"> </span>on<span class="_"> </span>the<span class="_"> </span>same<span class="_ _13"> </span>descriptor.<span class="_"> </span>In</div><div class="t m5 x1d h26 y80a1 ff7 fs19 fc2 sc0 ls0 ws0">order<span class="_ _13"> </span>to<span class="_ _13"> </span>avoid<span class="_ _6"> </span>the<span class="_ _13"> </span>potentially<span class="_ _13"> </span>deadly<span class="_ _13"> </span>race<span class="_ _1"></span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>must<span class="_ _13"> </span>assign<span class="_ _13"> </span>each<span class="_ _13"> </span>connected<span class="_ _6"> </span>descrip-</div><div class="t m5 x1d h26 y80a2 ff7 fs19 fc2 sc0 ls0 ws0">tor<span class="_"> </span>returned<span class="_ _13"> </span>by<span class="_"> </span><span class="ffd">accept<span class="_ _13"> </span></span>to<span class="_"> </span>its<span class="_ _13"> </span>own<span class="_"> </span>dynamically<span class="_ _13"> </span>allocated<span class="_"> </span>memory<span class="_ _13"> </span>block,<span class="_"> </span>as<span class="_"> </span>shown</div><div class="t m5 x1d h26 y80a3 ff7 fs19 fc2 sc0 ls0 ws0">in<span class="_"> </span>lines<span class="_"> </span>21–22.<span class="_"> </span>W<span class="_ _3"></span>e<span class="_"> </span>will<span class="_"> </span>return<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>issue<span class="_"> </span>of<span class="_"> </span>races<span class="_"> </span>in<span class="_"> </span>Section<span class="_"> </span>12.7.4.</div><div class="t m5 x29 h26 y80a4 ff7 fs19 fc2 sc0 ls0 ws0">Another<span class="_ _11"> </span>issue<span class="_ _16"> </span>is<span class="_ _11"> </span>avoiding<span class="_ _16"> </span>memory<span class="_ _11"> </span>leaks<span class="_ _16"> </span>in<span class="_ _11"> </span>the<span class="_ _16"> </span>thread<span class="_ _11"> </span>routine.<span class="_ _11"> </span>Since<span class="_ _11"> </span>we<span class="_ _16"> </span>are</div><div class="t m5 x1d h26 y80a5 ff7 fs19 fc2 sc0 ls0 ws0">not<span class="_ _14"> </span>explicitly<span class="_ _15"> </span>reaping<span class="_ _14"> </span>threads<span class="_ _0"></span>,<span class="_ _15"> </span>we<span class="_ _15"> </span>must<span class="_ _14"> </span>detach<span class="_ _15"> </span>each<span class="_ _15"> </span>thread<span class="_ _14"> </span>so<span class="_ _15"> </span>that<span class="_ _14"> </span>its<span class="_ _15"> </span>memory</div><div class="t m5 x1d h26 y80a6 ff7 fs19 fc2 sc0 ls0 ws0">resources<span class="_ _15"> </span>will<span class="_ _15"> </span>be<span class="_ _21"> </span>reclaimed<span class="_ _15"> </span>when<span class="_ _15"> </span>it<span class="_ _21"> </span>terminates<span class="_ _15"> </span>(line<span class="_ _21"> </span>31).<span class="_ _15"> </span>Further,<span class="_ _21"> </span>we<span class="_ _15"> </span>must<span class="_ _21"> </span>be</div><div class="t m5 x1d h26 y80a7 ff7 fs19 fc2 sc0 ls0 ws0">careful<span class="_"> </span>to<span class="_"> </span>free<span class="_"> </span>the<span class="_"> </span>memory<span class="_"> </span>block<span class="_ _13"> </span>that<span class="_"> </span>was<span class="_"> </span>allocated<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>main<span class="_"> </span>thread<span class="_"> </span>(line<span class="_"> </span>32).</div><div class="t m5 x1d h47 y80a8 ffe fs2b fc1 sc0 ls0 ws0">Practice<span class="_"> </span>Problem<span class="_"> </span>12.5<span class="_ _1f"> </span><span class="fs16">(solution<span class="_"> </span>page<span class="_"> </span>1072)</span></div><div class="t m5 x1d h26 y80a9 ff7 fs19 fc1 sc0 ls0 ws0">In<span class="_"> </span>the<span class="_ _11"> </span>process-based<span class="_ _11"> </span>server<span class="_ _11"> </span>in<span class="_ _11"> </span>F<span class="_ _0"></span>igure<span class="_"> </span>12.5,<span class="_ _16"> </span>we<span class="_"> </span>observed<span class="_ _11"> </span>that<span class="_ _11"> </span>there<span class="_ _11"> </span>is<span class="_"> </span>no<span class="_ _11"> </span>memory</div><div class="t m5 x1d h26 y80aa ff7 fs19 fc1 sc0 ls0 ws0">leak<span class="_ _16"> </span>and<span class="_ _16"> </span>the<span class="_ _16"> </span>code<span class="_ _16"> </span>remains<span class="_ _16"> </span>correct<span class="_ _16"> </span>even<span class="_ _11"> </span>when<span class="_ _16"> </span>line<span class="_ _16"> </span>33<span class="_ _16"> </span>is<span class="_ _16"> </span>deleted.<span class="_ _16"> </span>In<span class="_ _16"> </span>the<span class="_ _16"> </span>threads-</div><div class="t m5 x1d h26 y80ab ff7 fs19 fc1 sc0 ls0 ws0">based<span class="_ _13"> </span>server<span class="_ _6"> </span>in<span class="_ _13"> </span>F<span class="_ _0"></span>igure<span class="_ _13"> </span>12.14,<span class="_ _13"> </span>are<span class="_ _6"> </span>there<span class="_ _13"> </span>any<span class="_ _13"> </span>chances<span class="_ _13"> </span>of<span class="_ _6"> </span>memory<span class="_ _13"> </span>leak<span class="_ _13"> </span>if<span class="_ _13"> </span>lines<span class="_ _6"> </span>31<span class="_ _13"> </span>or<span class="_ _13"> </span>32</div><div class="t m5 x1d h26 y80ac ff7 fs19 fc1 sc0 ls0 ws0">are<span class="_"> </span>deleted.<span class="_"> </span>Why?</div><div class="t m5 x1d h3b y74d fff fs24 fc6 sc0 ls0 ws0">12.4<span class="_ _17"> </span><span class="ffe fs18">Shared<span class="_"> </span>V<span class="_ _1"></span>ariables<span class="_"> </span>in<span class="_"> </span>Threaded<span class="_"> </span>Programs</span></div><div class="t m5 x1d h26 yc47 ff7 fs19 fc1 sc0 ls0 ws0">F<span class="_ _1"></span>rom<span class="_ _16"> </span>a<span class="_"> </span>programmer’s<span class="_ _11"> </span>perspective,<span class="_"> </span>one<span class="_ _16"> </span>of<span class="_"> </span>the<span class="_ _16"> </span>attractive<span class="_ _11"> </span>aspects<span class="_ _11"> </span>of<span class="_ _11"> </span>threads<span class="_ _11"> </span>is<span class="_ _16"> </span>the</div><div class="t m5 x1d h26 yc48 ff7 fs19 fc1 sc0 ls0 ws0">ease<span class="_ _13"> </span>with<span class="_ _13"> </span>which<span class="_ _13"> </span>multiple<span class="_ _13"> </span>threads<span class="_ _6"> </span>can<span class="_ _13"> </span>share<span class="_ _13"> </span>the<span class="_ _13"> </span>same<span class="_ _13"> </span>program<span class="_ _13"> </span>variables<span class="_ _1"></span>.<span class="_ _13"> </span>However,</div><div class="t m5 x1d h26 yc49 ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>sharing<span class="_ _13"> </span>can<span class="_"> </span>be<span class="_"> </span>tricky<span class="_ _7"></span>.<span class="_"> </span>In<span class="_"> </span>order<span class="_ _13"> </span>to<span class="_"> </span>write<span class="_"> </span>correctly<span class="_"> </span>threaded<span class="_ _13"> </span>programs<span class="_ _1"></span>,<span class="_"> </span>we<span class="_"> </span>must</div><div class="t m5 x1d h26 yc4a ff7 fs19 fc1 sc0 ls0 ws0">have<span class="_"> </span>a<span class="_"> </span>clear<span class="_"> </span>understanding<span class="_"> </span>of<span class="_"> </span>what<span class="_"> </span>we<span class="_"> </span>mean<span class="_"> </span>by<span class="_"> </span>sharing<span class="_"> </span>and<span class="_"> </span>how<span class="_"> </span>it<span class="_"> </span>works<span class="_ _1"></span>.</div><div class="t m5 x29 h26 yc4b ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>here<span class="_ _e"> </span>are<span class="_ _f"> </span>some<span class="_ _e"> </span>basic<span class="_ _f"> </span>questions<span class="_ _e"> </span>to<span class="_ _f"> </span>work<span class="_ _f"> </span>through<span class="_ _e"> </span>in<span class="_ _f"> </span>order<span class="_ _e"> </span>to<span class="_ _f"> </span>understand</div><div class="t m5 x1d h26 yb04 ff7 fs19 fc1 sc0 ls0 ws0">whether<span class="_ _16"> </span>a<span class="_ _16"> </span>variable<span class="_ _14"> </span>in<span class="_ _16"> </span>a<span class="_ _16"> </span>C<span class="_ _14"> </span>program<span class="_ _16"> </span>is<span class="_ _14"> </span>shared<span class="_ _16"> </span>or<span class="_ _16"> </span>not:<span class="_ _14"> </span>(1)<span class="_ _16"> </span>What<span class="_ _16"> </span>is<span class="_ _16"> </span>the<span class="_ _14"> </span>underlying</div><div class="t m5 x1d h26 yb05 ff7 fs19 fc1 sc0 ls0 ws0">memory<span class="_"> </span>model<span class="_ _11"> </span>for<span class="_ _11"> </span>threads?<span class="_ _11"> </span>(2)<span class="_ _11"> </span>Given<span class="_ _11"> </span>this<span class="_"> </span>model,<span class="_ _11"> </span>how<span class="_ _11"> </span>are<span class="_ _11"> </span>instances<span class="_ _11"> </span>of<span class="_ _11"> </span>the<span class="_ _11"> </span>vari-</div><div class="t m5 x1d h26 y1868 ff7 fs19 fc1 sc0 ls0 ws0">able<span class="_ _11"> </span>mapped<span class="_ _11"> </span>to<span class="_ _11"> </span>memory?<span class="_ _11"> </span>(3)<span class="_ _11"> </span>F<span class="_ _0"></span>inally<span class="_ _3"></span>,<span class="_ _11"> </span>how<span class="_ _11"> </span>many<span class="_ _11"> </span>threads<span class="_ _11"> </span>reference<span class="_ _11"> </span>each<span class="_ _11"> </span>of<span class="_ _11"> </span>these</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
