<div id="pf414" class="pf w2 h11" data-page-no="414"><div class="pc pc414 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg414.png"/><div class="t m5 x69 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.5<span class="_ _60"> </span>Synchronizing<span class="_ _10"> </span>Threads<span class="_ _10"> </span>with<span class="_ _10"> </span>Semaphores<span class="_ _3e"> </span><span class="ffe fs1e">1043</span></div><div class="t m5 x230 h2c y6781 ffa fs16 fc2 sc0 ls0 ws0">code/conc/sbuf<span class="_ _1"></span>.c</div><div class="t m5 x2c h88 yb20 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&quot;csapp.h&quot;</span></div><div class="t m5 x2c h88 y739c ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs4e fc2">#include<span class="_ _e"> </span>&quot;sbuf.h&quot;</span></div><div class="t m5 x2c h2e y58cd ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2c h2e y828a ff6 fs20 fc6 sc0 ls0 ws0">4</div><div class="t m5 x2d h88 y828b ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Create<span class="_ _f"> </span>an<span class="_ _e"> </span>empty,<span class="_ _e"> </span>bounded,<span class="_ _f"> </span>shared<span class="_ _e"> </span>FIFO<span class="_ _e"> </span>buffer<span class="_ _f"> </span>with<span class="_ _e"> </span>n<span class="_ _e"> </span>slots<span class="_ _e"> </span>*/</div><div class="t m5 x2c h88 y56fa ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>sbuf_init(sbuf_t<span class="_ _e"> </span>*sp,<span class="_ _f"> </span>int<span class="_ _e"> </span>n)</span></div><div class="t m5 x2c h88 y21d7 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x2c h88 y454a ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _e2"> </span><span class="ffd fs4e fc2">sp-&gt;buf<span class="_ _e"> </span>=<span class="_ _e"> </span>Calloc(n,<span class="_ _f"> </span>sizeof(int));</span></div><div class="t m5 x2c h88 y13f3 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _e2"> </span><span class="ffd fs4e fc2">sp-&gt;n<span class="_ _e"> </span>=<span class="_ _e"> </span>n;<span class="_ _12d"> </span>/*<span class="_ _e"> </span>Buffer<span class="_ _e"> </span>holds<span class="_ _f"> </span>max<span class="_ _e"> </span>of<span class="_ _e"> </span>n<span class="_ _e"> </span>items<span class="_ _f"> </span>*/</span></div><div class="t m5 x2c h88 yca7 ff6 fs20 fc6 sc0 ls0 ws0">9<span class="_ _e2"> </span><span class="ffd fs4e fc2">sp-&gt;front<span class="_ _e"> </span>=<span class="_ _e"> </span>sp-&gt;rear<span class="_ _f"> </span>=<span class="_ _e"> </span>0;<span class="_ _7f"> </span>/*<span class="_ _e"> </span>Empty<span class="_ _f"> </span>buffer<span class="_ _e"> </span>iff<span class="_ _e"> </span>front<span class="_ _f"> </span>==<span class="_ _e"> </span>rear<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y828c ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _e2"> </span><span class="ffd fs4e fc2">Sem_init(&amp;sp-&gt;mutex,<span class="_ _e"> </span>0,<span class="_ _e"> </span>1);<span class="_ _5c"> </span>/*<span class="_ _e"> </span>Binary<span class="_ _e"> </span>semaphore<span class="_ _f"> </span>for<span class="_ _e"> </span>locking<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y828d ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _e2"> </span><span class="ffd fs4e fc2">Sem_init(&amp;sp-&gt;slots,<span class="_ _e"> </span>0,<span class="_ _e"> </span>n);<span class="_ _5c"> </span>/*<span class="_ _e"> </span>Initially,<span class="_ _e"> </span>buf<span class="_ _f"> </span>has<span class="_ _e"> </span>n<span class="_ _e"> </span>empty<span class="_ _f"> </span>slots<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y23e0 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _e2"> </span><span class="ffd fs4e fc2">Sem_init(&amp;sp-&gt;items,<span class="_ _e"> </span>0,<span class="_ _e"> </span>0);<span class="_ _5c"> </span>/*<span class="_ _e"> </span>Initially,<span class="_ _e"> </span>buf<span class="_ _f"> </span>has<span class="_ _e"> </span>zero<span class="_ _e"> </span>data<span class="_ _f"> </span>items<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 ycdc ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h2e y58ba ff6 fs20 fc6 sc0 ls0 ws0">14</div><div class="t m5 x17 h2e y828e ff6 fs20 fc6 sc0 ls0 ws0">15</div><div class="t m5 x2d h88 y828f ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Clean<span class="_ _f"> </span>up<span class="_ _e"> </span>buffer<span class="_ _e"> </span>sp<span class="_ _f"> </span>*/</div><div class="t m5 x17 h88 y2480 ff6 fs20 fc6 sc0 ls0 ws0">16<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>sbuf_deinit(sbuf_t<span class="_ _e"> </span>*sp)</span></div><div class="t m5 x17 h88 y8290 ff6 fs20 fc6 sc0 ls0 ws0">17<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x17 h88 y8291 ff6 fs20 fc6 sc0 ls0 ws0">18<span class="_ _e2"> </span><span class="ffd fs4e fc2">Free(sp-&gt;buf);</span></div><div class="t m5 x17 h88 yce1 ff6 fs20 fc6 sc0 ls0 ws0">19<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h2e y8292 ff6 fs20 fc6 sc0 ls0 ws0">20</div><div class="t m5 x17 h2e y8293 ff6 fs20 fc6 sc0 ls0 ws0">21</div><div class="t m5 x2d h88 y8294 ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Insert<span class="_ _f"> </span>item<span class="_ _e"> </span>onto<span class="_ _e"> </span>the<span class="_ _f"> </span>rear<span class="_ _e"> </span>of<span class="_ _e"> </span>shared<span class="_ _f"> </span>buffer<span class="_ _e"> </span>sp<span class="_ _e"> </span>*/</div><div class="t m5 x17 h88 y8295 ff6 fs20 fc6 sc0 ls0 ws0">22<span class="_ _1c"> </span><span class="ffd fs4e fc2">void<span class="_ _e"> </span>sbuf_insert(sbuf_t<span class="_ _e"> </span>*sp,<span class="_ _f"> </span>int<span class="_ _e"> </span>item)</span></div><div class="t m5 x17 h88 y8296 ff6 fs20 fc6 sc0 ls0 ws0">23<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x17 h88 y8297 ff6 fs20 fc6 sc0 ls0 ws0">24<span class="_ _e2"> </span><span class="ffd fs4e fc2">P(&amp;sp-&gt;slots);<span class="_ _8e"> </span>/*<span class="_ _e"> </span>Wait<span class="_ _f"> </span>for<span class="_ _e"> </span>available<span class="_ _e"> </span>slot<span class="_ _f"> </span>*/</span></div><div class="t m5 x17 h2e y1e6c ff6 fs20 fc6 sc0 ls0 ws0">25</div><div class="t m5 x1a0 h88 y8298 ffd fs4e fc2 sc0 ls0 ws0">P(&amp;sp-&gt;mutex);<span class="_ _a6"> </span>/*<span class="_ _e"> </span>Lock<span class="_ _e"> </span>the<span class="_ _e"> </span>buffer<span class="_ _f"> </span>*/</div><div class="t m5 x17 h88 y8299 ff6 fs20 fc6 sc0 ls0 ws0">26<span class="_ _e2"> </span><span class="ffd fs4e fc2">sp-&gt;buf[(++sp-&gt;rear)%(sp-&gt;n)]<span class="_ _e"> </span>=<span class="_ _e"> </span>item;<span class="_ _b3"> </span>/*<span class="_ _e"> </span>Insert<span class="_ _e"> </span>the<span class="_ _e"> </span>item<span class="_ _f"> </span>*/</span></div><div class="t m5 x17 h88 y28f6 ff6 fs20 fc6 sc0 ls0 ws0">27<span class="_ _e2"> </span><span class="ffd fs4e fc2">V(&amp;sp-&gt;mutex);<span class="_ _8e"> </span>/*<span class="_ _e"> </span>Unlock<span class="_ _f"> </span>the<span class="_ _e"> </span>buffer<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h2e y829a ff6 fs20 fc6 sc0 ls0 ws0">28</div><div class="t m5 x1a0 h88 y829b ffd fs4e fc2 sc0 ls0 ws0">V(&amp;sp-&gt;items);<span class="_ _a6"> </span>/*<span class="_ _e"> </span>Announce<span class="_ _e"> </span>available<span class="_ _e"> </span>item<span class="_ _f"> </span>*/</div><div class="t m5 x17 h88 y829c ff6 fs20 fc6 sc0 ls0 ws0">29<span class="_ _1c"> </span><span class="ffd fs4e fc2">}</span></div><div class="t m5 x17 h2e y829d ff6 fs20 fc6 sc0 ls0 ws0">30</div><div class="t m5 x17 h2e y829e ff6 fs20 fc6 sc0 ls0 ws0">31</div><div class="t m5 x2d h88 y829f ffd fs4e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>Remove<span class="_ _f"> </span>and<span class="_ _e"> </span>return<span class="_ _e"> </span>the<span class="_ _f"> </span>first<span class="_ _e"> </span>item<span class="_ _e"> </span>from<span class="_ _f"> </span>buffer<span class="_ _e"> </span>sp<span class="_ _e"> </span>*/</div><div class="t m5 x17 h88 y82a0 ff6 fs20 fc6 sc0 ls0 ws0">32<span class="_ _1c"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>sbuf_remove(sbuf_t<span class="_ _e"> </span>*sp)</span></div><div class="t m5 x17 h88 y82a1 ff6 fs20 fc6 sc0 ls0 ws0">33<span class="_ _1c"> </span><span class="ffd fs4e fc2">{</span></div><div class="t m5 x17 h88 y29c1 ff6 fs20 fc6 sc0 ls0 ws0">34<span class="_ _e2"> </span><span class="ffd fs4e fc2">int<span class="_ _e"> </span>item;</span></div><div class="t m5 x17 h88 y82a2 ff6 fs20 fc6 sc0 ls0 ws0">35<span class="_ _e2"> </span><span class="ffd fs4e fc2">P(&amp;sp-&gt;items);<span class="_ _8e"> </span>/*<span class="_ _e"> </span>Wait<span class="_ _f"> </span>for<span class="_ _e"> </span>available<span class="_ _e"> </span>item<span class="_ _f"> </span>*/</span></div><div class="t m5 x17 h88 y82a3 ff6 fs20 fc6 sc0 ls0 ws0">36<span class="_ _e2"> </span><span class="ffd fs4e fc2">P(&amp;sp-&gt;mutex);<span class="_ _8e"> </span>/*<span class="_ _e"> </span>Lock<span class="_ _f"> </span>the<span class="_ _e"> </span>buffer<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y82a4 ff6 fs20 fc6 sc0 ls0 ws0">37<span class="_ _e2"> </span><span class="ffd fs4e fc2">item<span class="_ _e"> </span>=<span class="_ _e"> </span>sp-&gt;buf[(++sp-&gt;front)%(sp-&gt;n)];<span class="_ _3d"> </span>/*<span class="_ _e"> </span>Remove<span class="_ _e"> </span>the<span class="_ _e"> </span>item<span class="_ _f"> </span>*/</span></div><div class="t m5 x17 h2e y82a5 ff6 fs20 fc6 sc0 ls0 ws0">38</div><div class="t m5 x1a0 h88 y82a6 ffd fs4e fc2 sc0 ls0 ws0">V(&amp;sp-&gt;mutex);<span class="_ _a6"> </span>/*<span class="_ _e"> </span>Unlock<span class="_ _e"> </span>the<span class="_ _e"> </span>buffer<span class="_ _f"> </span>*/</div><div class="t m5 x17 h88 y82a7 ff6 fs20 fc6 sc0 ls0 ws0">39<span class="_ _e2"> </span><span class="ffd fs4e fc2">V(&amp;sp-&gt;slots);<span class="_ _8e"> </span>/*<span class="_ _e"> </span>Announce<span class="_ _f"> </span>available<span class="_ _e"> </span>slot<span class="_ _e"> </span>*/</span></div><div class="t m5 x17 h88 y82a8 ff6 fs20 fc6 sc0 ls0 ws0">40<span class="_ _e2"> </span><span class="ffd fs4e fc2">return<span class="_ _e"> </span>item;</span></div><div class="t m5 x17 h2e y82a9 ff6 fs20 fc6 sc0 ls0 ws0">41</div><div class="t m5 x2d h88 y82aa ffd fs4e fc2 sc0 ls0 ws0">}</div><div class="t m5 x230 h2c y82ab ffa fs16 fc2 sc0 ls0 ws0">code/conc/sbuf<span class="_ _1"></span>.c</div><div class="t m5 x17 h2f y82ac ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.25<span class="_ _66"> </span><span class="ff1b fc1">Sbuf<span class="ffe">:<span class="_"> </span>A<span class="_"> </span>package<span class="_"> </span>for<span class="_"> </span>synchronizing<span class="_"> </span>concurrent<span class="_"> </span>access<span class="_"> </span>to<span class="_"> </span>bounded<span class="_"> </span>buffers.</span></span></div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
