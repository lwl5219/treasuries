<div id="pf147" class="pf w2 h11" data-page-no="147"><div class="pc pc147 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg147.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">326<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>3<span class="_ _3d"> </span>Machine-Level<span class="_ _10"> </span>Representation<span class="_ _10"> </span>of<span class="_ _10"> </span>Programs</span></div><div class="t m5 x29 h26 ye7 ff7 fs19 fc2 sc0 ls0 ws0">Some<span class="_ _11"> </span>types<span class="_ _11"> </span>of<span class="_ _16"> </span>programs<span class="_ _11"> </span>require<span class="_ _11"> </span>the<span class="_ _16"> </span>ability<span class="_"> </span>to<span class="_ _16"> </span>dynamically<span class="_ _11"> </span>generate<span class="_ _11"> </span>and<span class="_ _16"> </span>ex-</div><div class="t m5 x1d h26 y2a7 ff7 fs19 fc2 sc0 ls0 ws0">ecute<span class="_"> </span>code<span class="_ _1"></span>.<span class="_"> </span>F<span class="_ _3"></span>or<span class="_"> </span>example<span class="_ _1"></span>,<span class="_"> </span>“just-in-time”<span class="_"> </span>compilation<span class="_"> </span>techniques<span class="_ _13"> </span>dynamically<span class="_"> </span>gen-</div><div class="t m5 x1d h26 y2a8 ff7 fs19 fc2 sc0 ls0 ws0">erate<span class="_ _13"> </span>code<span class="_ _13"> </span>for<span class="_ _13"> </span>programs<span class="_ _13"> </span>written<span class="_ _6"> </span>in<span class="_ _13"> </span>interpreted<span class="_ _13"> </span>languages<span class="_ _1"></span>,<span class="_ _13"> </span>such<span class="_ _13"> </span>as<span class="_ _13"> </span>J<span class="_ _1"></span>ava,<span class="_ _13"> </span>to<span class="_ _13"> </span>improve</div><div class="t m5 x1d h26 y2f7 ff7 fs19 fc2 sc0 ls0 ws0">execution<span class="_ _11"> </span>performance.<span class="_"> </span>Whether<span class="_ _11"> </span>or<span class="_ _16"> </span>not<span class="_ _11"> </span>the<span class="_ _16"> </span>run-time<span class="_ _11"> </span>system<span class="_ _11"> </span>can<span class="_ _16"> </span>restrict<span class="_ _11"> </span>the<span class="_ _16"> </span>ex-</div><div class="t m5 x1d h26 y2f8 ff7 fs19 fc2 sc0 ls0 ws0">ecutable<span class="_"> </span>code<span class="_ _11"> </span>to<span class="_"> </span>just<span class="_ _11"> </span>that<span class="_ _11"> </span>part<span class="_"> </span>generated<span class="_ _11"> </span>by<span class="_"> </span>the<span class="_ _11"> </span>compiler<span class="_ _11"> </span>in<span class="_"> </span>creating<span class="_ _11"> </span>the<span class="_"> </span>original</div><div class="t m5 x1d h26 y2f9 ff7 fs19 fc2 sc0 ls0 ws0">program<span class="_"> </span>depends<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>language<span class="_"> </span>and<span class="_"> </span>the<span class="_"> </span>operating<span class="_"> </span>system.</div><div class="t m5 x29 h26 y1a4 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>techniques<span class="_"> </span>we<span class="_ _13"> </span>have<span class="_"> </span>outlined—randomization,<span class="_"> </span>stack<span class="_ _13"> </span>protection,<span class="_"> </span>and<span class="_"> </span>lim-</div><div class="t m5 x1d h26 y2ea2 ff7 fs19 fc2 sc0 ls0 ws0">iting<span class="_"> </span>which<span class="_"> </span>portions<span class="_"> </span>of<span class="_"> </span>memory<span class="_"> </span>can<span class="_"> </span>hold<span class="_"> </span>executable<span class="_"> </span>code—are<span class="_ _13"> </span>three<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>most</div><div class="t m5 x1d h26 y2ea3 ff7 fs19 fc2 sc0 ls0 ws0">common<span class="_ _14"> </span>mechanisms<span class="_ _16"> </span>used<span class="_ _14"> </span>to<span class="_ _14"> </span>minimize<span class="_ _14"> </span>the<span class="_ _14"> </span>vulnerability<span class="_ _14"> </span>of<span class="_ _14"> </span>programs<span class="_ _16"> </span>to<span class="_ _14"> </span>buffer</div><div class="t m5 x1d h26 y2ea4 ff7 fs19 fc2 sc0 ls0 ws0">overﬂow<span class="_ _11"> </span>attacks<span class="_ _1"></span>.<span class="_ _11"> </span>T<span class="_ _0"></span>hey<span class="_ _11"> </span>all<span class="_ _11"> </span>have<span class="_ _11"> </span>the<span class="_ _11"> </span>properties<span class="_ _11"> </span>that<span class="_ _11"> </span>they<span class="_ _11"> </span>require<span class="_ _16"> </span>no<span class="_"> </span>special<span class="_ _11"> </span>effort</div><div class="t m5 x1d h26 y2ea5 ff7 fs19 fc2 sc0 ls0 ws0">on<span class="_ _16"> </span>the<span class="_ _16"> </span>part<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>programmer<span class="_ _16"> </span>and<span class="_ _16"> </span>incur<span class="_ _16"> </span>very<span class="_ _16"> </span>little<span class="_ _16"> </span>or<span class="_ _16"> </span>no<span class="_ _16"> </span>performance<span class="_ _16"> </span>penalty<span class="_ _7"></span>.</div><div class="t m5 x1d h26 y2ea6 ff7 fs19 fc2 sc0 ls0 ws0">Each<span class="_ _16"> </span>separately<span class="_ _14"> </span>reduces<span class="_ _16"> </span>the<span class="_ _14"> </span>level<span class="_ _16"> </span>of<span class="_ _16"> </span>vulnerability<span class="_ _3"></span>,<span class="_ _14"> </span>and<span class="_ _14"> </span>in<span class="_ _16"> </span>combination<span class="_ _14"> </span>they<span class="_ _16"> </span>be-</div><div class="t m5 x1d h26 y2ea7 ff7 fs19 fc2 sc0 ls0 ws0">come<span class="_ _13"> </span>even<span class="_"> </span>more<span class="_ _13"> </span>effective<span class="_ _1"></span>.<span class="_"> </span>Unfortunately<span class="_ _7"></span>,<span class="_"> </span>there<span class="_ _13"> </span>are<span class="_ _13"> </span>still<span class="_"> </span>ways<span class="_ _13"> </span>to<span class="_ _13"> </span>attack<span class="_ _13"> </span>computers</div><div class="t m5 x1d h26 y2ea8 ff7 fs19 fc2 sc0 ls0 ws0">[85,<span class="_"> </span>97],<span class="_"> </span>and<span class="_"> </span>so<span class="_"> </span>worms<span class="_"> </span>and<span class="_"> </span>viruses<span class="_"> </span>continue<span class="_"> </span>to<span class="_"> </span>compromise<span class="_"> </span>the<span class="_"> </span>integrity<span class="_"> </span>of<span class="_"> </span>many</div><div class="t m5 x1d h26 y2ea9 ff7 fs19 fc2 sc0 ls0 ws0">machines<span class="_ _1"></span>.</div><div class="t m5 x1d h41 y2eaa ffe fs29 fc2 sc0 ls0 ws0">3.10.5<span class="_ _48"> </span><span class="fs19">Supporting<span class="_"> </span>V<span class="_ _1"></span>ariable-Size<span class="_"> </span>Stack<span class="_"> </span>Frames</span></div><div class="t m5 x1d h26 y2eab ff7 fs19 fc2 sc0 ls0 ws0">W<span class="_ _3"></span>e<span class="_ _16"> </span>have<span class="_ _16"> </span>examined<span class="_ _16"> </span>the<span class="_ _16"> </span>machine-level<span class="_ _16"> </span>code<span class="_ _16"> </span>for<span class="_ _16"> </span>a<span class="_ _16"> </span>variety<span class="_ _16"> </span>of<span class="_ _16"> </span>functions<span class="_ _16"> </span>so<span class="_ _16"> </span>far<span class="_ _0"></span>,<span class="_ _16"> </span>but</div><div class="t m5 x1d h26 y2eac ff7 fs19 fc2 sc0 ls0 ws0">they<span class="_ _13"> </span>all<span class="_ _13"> </span>have<span class="_ _13"> </span>the<span class="_ _13"> </span>property<span class="_ _13"> </span>that<span class="_ _13"> </span>the<span class="_ _13"> </span>compiler<span class="_ _13"> </span>can<span class="_ _13"> </span>determine<span class="_ _13"> </span>in<span class="_ _13"> </span>advance<span class="_ _13"> </span>the<span class="_"> </span>amount</div><div class="t m5 x1d h26 y2ead ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_ _11"> </span>space<span class="_ _11"> </span>that<span class="_ _11"> </span>must<span class="_ _11"> </span>be<span class="_ _16"> </span>allocated<span class="_"> </span>for<span class="_ _16"> </span>their<span class="_"> </span>stack<span class="_ _16"> </span>frames<span class="_ _3"></span>.<span class="_ _11"> </span>Some<span class="_ _16"> </span>functions<span class="_ _3"></span>,<span class="_ _16"> </span>however,</div><div class="t m5 x1d h26 y2eae ff7 fs19 fc2 sc0 ls0 ws0">require<span class="_"> </span>a<span class="_"> </span>variable<span class="_ _13"> </span>amount<span class="_"> </span>of<span class="_"> </span>local<span class="_"> </span>storage<span class="_ _1"></span>.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_"> </span>can<span class="_"> </span>occur,<span class="_ _13"> </span>for<span class="_"> </span>example,<span class="_ _13"> </span>when<span class="_"> </span>the</div><div class="t m5 x1d h26 y2eaf ff7 fs19 fc2 sc0 ls0 ws0">function<span class="_ _16"> </span>calls<span class="_ _16"> </span><span class="ffd">alloca</span>,<span class="_ _14"> </span>a<span class="_ _14"> </span>standard<span class="_ _16"> </span>library<span class="_ _14"> </span>function<span class="_ _16"> </span>that<span class="_ _16"> </span>can<span class="_ _14"> </span>allocate<span class="_ _16"> </span>an<span class="_ _14"> </span>arbitrary</div><div class="t m5 x1d h26 y2eb0 ff7 fs19 fc2 sc0 ls0 ws0">number<span class="_"> </span>of<span class="_ _13"> </span>bytes<span class="_"> </span>of<span class="_"> </span>storage<span class="_"> </span>on<span class="_ _13"> </span>the<span class="_"> </span>stack.<span class="_"> </span>It<span class="_ _13"> </span>can<span class="_"> </span>also<span class="_"> </span>occur<span class="_"> </span>when<span class="_ _13"> </span>the<span class="_"> </span>code<span class="_"> </span>declares</div><div class="t m5 x1d h26 y2eb1 ff7 fs19 fc2 sc0 ls0 ws0">a<span class="_"> </span>local<span class="_"> </span>array<span class="_"> </span>of<span class="_"> </span>variable<span class="_"> </span>size<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2eb2 ff7 fs19 fc2 sc0 ls0 ws0">Although<span class="_"> </span>the<span class="_ _11"> </span>information<span class="_ _11"> </span>presented<span class="_ _11"> </span>in<span class="_ _11"> </span>this<span class="_"> </span>section<span class="_ _11"> </span>should<span class="_ _11"> </span>rightfully<span class="_ _11"> </span>be<span class="_ _11"> </span>con-</div><div class="t m5 x1d h26 y2eb3 ff7 fs19 fc2 sc0 ls0 ws0">sidered<span class="_ _21"> </span>an<span class="_ _21"> </span>aspect<span class="_ _f"> </span>of<span class="_ _21"> </span>how<span class="_ _21"> </span>procedures<span class="_ _f"> </span>are<span class="_ _21"> </span>implemented,<span class="_ _e"> </span>we<span class="_ _15"> </span>have<span class="_ _f"> </span>deferred<span class="_ _21"> </span>the</div><div class="t m5 x1d h26 y2eb4 ff7 fs19 fc2 sc0 ls0 ws0">presentation<span class="_"> </span>to<span class="_"> </span>this<span class="_ _11"> </span>point,<span class="_"> </span>since<span class="_ _11"> </span>it<span class="_"> </span>requires<span class="_ _11"> </span>an<span class="_"> </span>understanding<span class="_ _11"> </span>of<span class="_"> </span>arrays<span class="_ _11"> </span>and<span class="_"> </span>align-</div><div class="t m5 x1d h26 y2eb5 ff7 fs19 fc2 sc0 ls0 ws0">ment.</div><div class="t m5 x29 h26 y2eb6 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _e"> </span>code<span class="_ _e"> </span>of<span class="_ _e"> </span>F<span class="_ _1"></span>igure<span class="_ _e"> </span>3.43(a)<span class="_ _e"> </span>gives<span class="_ _e"> </span>an<span class="_ _e"> </span>example<span class="_ _f"> </span>of<span class="_ _e"> </span>a<span class="_ _e"> </span>function<span class="_ _e"> </span>containing<span class="_ _e"> </span>a</div><div class="t m5 x1d h26 y2eb7 ff7 fs19 fc2 sc0 ls0 ws0">variable-size<span class="_ _16"> </span>array<span class="_ _3"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>function<span class="_ _16"> </span>declares<span class="_ _16"> </span>local<span class="_ _16"> </span>array<span class="_ _14"> </span><span class="ffd">p<span class="_ _16"> </span></span>of<span class="_ _16"> </span><span class="ff11">n<span class="_"> </span></span>pointers<span class="_ _3"></span>,<span class="_ _14"> </span>where<span class="_ _16"> </span><span class="ff11">n<span class="_"> </span></span>is</div><div class="t m5 x1d h26 y2eb8 ff7 fs19 fc2 sc0 ls0 ws0">given<span class="_"> </span>by<span class="_"> </span>the<span class="_"> </span>ﬁrst<span class="_ _11"> </span>argument.<span class="_"> </span>T<span class="_ _0"></span>his<span class="_"> </span>requires<span class="_"> </span>allocating<span class="_"> </span>8<span class="ff11">n<span class="_ _11"> </span></span>bytes<span class="_"> </span>on<span class="_"> </span>the<span class="_"> </span>stack,<span class="_ _11"> </span>where</div><div class="t m5 x1b0 h26 y2eb9 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _16"> </span>value<span class="_ _16"> </span>of<span class="_ _16"> </span><span class="ff11">n<span class="_"> </span></span>may<span class="_ _16"> </span>vary<span class="_ _16"> </span>from<span class="_ _16"> </span>one<span class="_ _16"> </span>call<span class="_ _16"> </span>of<span class="_ _16"> </span>the<span class="_ _16"> </span>function<span class="_ _14"> </span>to<span class="_ _16"> </span>another.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _16"> </span>compiler</div><div class="t m5 x1b0 h26 y2eba ff7 fs19 fc2 sc0 ls0 ws0">therefore<span class="_ _16"> </span>cannot<span class="_ _14"> </span>determine<span class="_ _14"> </span>how<span class="_ _14"> </span>much<span class="_ _16"> </span>space<span class="_ _14"> </span>it<span class="_ _14"> </span>must<span class="_ _14"> </span>allocate<span class="_ _16"> </span>for<span class="_ _14"> </span>the<span class="_ _14"> </span>function’s</div><div class="t m5 x1b0 h26 y2ebb ff7 fs19 fc2 sc0 ls0 ws0">stack<span class="_ _13"> </span>frame<span class="_ _1"></span>.<span class="_ _13"> </span>In<span class="_ _13"> </span>addition,<span class="_"> </span>the<span class="_ _13"> </span>program<span class="_ _13"> </span>generates<span class="_ _13"> </span>a<span class="_ _13"> </span>reference<span class="_ _13"> </span>to<span class="_ _13"> </span>the<span class="_ _13"> </span>address<span class="_ _13"> </span>of<span class="_ _13"> </span>local</div><div class="t m5 x1b0 h26 y2ebc ff7 fs19 fc2 sc0 ls0 ws0">variable<span class="_ _13"> </span><span class="ffd">i</span>,<span class="_ _13"> </span>and<span class="_ _13"> </span>so<span class="_ _13"> </span>this<span class="_ _13"> </span>variable<span class="_ _13"> </span>must<span class="_ _13"> </span>also<span class="_ _6"> </span>be<span class="_ _13"> </span>stored<span class="_ _13"> </span>on<span class="_ _13"> </span>the<span class="_ _13"> </span>stack.<span class="_ _13"> </span>During<span class="_ _13"> </span>execution,</div><div class="t m5 x1b0 h26 y2ebd ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>program<span class="_ _13"> </span>must<span class="_ _13"> </span>be<span class="_ _13"> </span>able<span class="_ _13"> </span>to<span class="_ _13"> </span>access<span class="_ _13"> </span>both<span class="_ _13"> </span>local<span class="_ _13"> </span>variable<span class="_ _13"> </span><span class="ffd">i<span class="_ _13"> </span></span>and<span class="_ _13"> </span>the<span class="_ _13"> </span>elements<span class="_ _13"> </span>of<span class="_ _13"> </span>array</div><div class="t m5 x1d h26 y2ebe ffd fs19 fc2 sc0 ls0 ws0">p<span class="ff7">.<span class="_ _16"> </span>On<span class="_ _16"> </span>returning,<span class="_ _16"> </span>the<span class="_ _16"> </span>function<span class="_ _16"> </span>must<span class="_ _14"> </span>deallocate<span class="_ _16"> </span>the<span class="_ _16"> </span>stack<span class="_ _16"> </span>frame<span class="_ _16"> </span>and<span class="_ _16"> </span>set<span class="_ _14"> </span>the<span class="_ _16"> </span>stack</span></div><div class="t m5 x1d h26 y2ebf ff7 fs19 fc2 sc0 ls0 ws0">pointer<span class="_"> </span>to<span class="_"> </span>the<span class="_"> </span>position<span class="_"> </span>of<span class="_"> </span>the<span class="_"> </span>stored<span class="_"> </span>return<span class="_"> </span>address<span class="_ _1"></span>.</div><div class="t m5 x29 h26 y2ec0 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _7"></span>o<span class="_ _13"> </span>manage<span class="_ _13"> </span>a<span class="_ _13"> </span>variable-size<span class="_ _13"> </span>stack<span class="_ _6"> </span>frame,<span class="_ _13"> </span>x86-64<span class="_ _6"> </span>code<span class="_ _13"> </span>uses<span class="_ _13"> </span>register<span class="_ _13"> </span><span class="ffd">%rbp<span class="_ _13"> </span></span>to<span class="_ _6"> </span>serve</div><div class="t m5 x1d h26 y2ec1 ff7 fs19 fc2 sc0 ls0 ws0">as<span class="_"> </span>a<span class="_"> </span><span class="ffa">frame<span class="_"> </span>pointer<span class="_ _11"> </span></span>(sometimes<span class="_"> </span>referred<span class="_"> </span>to<span class="_"> </span>as<span class="_"> </span>a<span class="_"> </span><span class="ffa">base<span class="_"> </span>pointer<span class="_ _2"></span></span>,<span class="_"> </span>and<span class="_"> </span>hence<span class="_"> </span>the<span class="_"> </span>letters</div><div class="t m5 x1d h26 y2ec2 ffd fs19 fc2 sc0 ls0 ws0">bp<span class="_ _11"> </span><span class="ff7">in<span class="_ _16"> </span></span>%rbp<span class="ff7">).<span class="_ _11"> </span>When<span class="_"> </span>using<span class="_ _16"> </span>a<span class="_ _11"> </span>frame<span class="_ _16"> </span>pointer<span class="_ _0"></span>,<span class="_ _11"> </span>the<span class="_ _16"> </span>stack<span class="_ _11"> </span>frame<span class="_ _11"> </span>is<span class="_ _16"> </span>organized<span class="_ _11"> </span>as<span class="_ _16"> </span>shown</span></div><div class="t m5 x1d h26 y2ec3 ff7 fs19 fc2 sc0 ls0 ws0">for<span class="_ _16"> </span>the<span class="_ _14"> </span>case<span class="_ _14"> </span>of<span class="_ _16"> </span>function<span class="_ _14"> </span><span class="ffd">vframe<span class="_ _14"> </span></span>in<span class="_ _14"> </span>F<span class="_ _1"></span>igure<span class="_ _14"> </span>3.44.<span class="_ _14"> </span>W<span class="_ _3"></span>e<span class="_ _14"> </span>see<span class="_ _16"> </span>that<span class="_ _14"> </span>the<span class="_ _14"> </span>code<span class="_ _14"> </span>must<span class="_ _16"> </span>save</div><div class="t m5 x1d h26 y2ec4 ff7 fs19 fc2 sc0 ls0 ws0">the<span class="_ _13"> </span>previous<span class="_ _13"> </span>version<span class="_"> </span>of<span class="_ _13"> </span><span class="ffd">%rbp<span class="_ _13"> </span></span>on<span class="_ _13"> </span>the<span class="_ _13"> </span>stack,<span class="_"> </span>since<span class="_ _13"> </span>it<span class="_ _13"> </span>is<span class="_ _13"> </span>a<span class="_"> </span>callee-saved<span class="_ _13"> </span>register<span class="_ _0"></span>.<span class="_ _13"> </span>It<span class="_ _13"> </span>then</div><div class="t m5 x1d h26 y2ec5 ff7 fs19 fc2 sc0 ls0 ws0">keeps<span class="_ _13"> </span><span class="ffd">%rbp<span class="_ _13"> </span></span>pointing<span class="_ _13"> </span>to<span class="_ _13"> </span>this<span class="_ _13"> </span>position<span class="_ _13"> </span>throughout<span class="_ _13"> </span>the<span class="_ _13"> </span>execution<span class="_ _13"> </span>of<span class="_ _13"> </span>the<span class="_ _13"> </span>function,<span class="_ _13"> </span>and</div><div class="t m5 x1d h26 y2ec6 ff7 fs19 fc2 sc0 ls0 ws0">it<span class="_"> </span>references<span class="_"> </span>ﬁxed-length<span class="_"> </span>local<span class="_"> </span>variables<span class="_ _1"></span>,<span class="_"> </span>such<span class="_"> </span>as<span class="_"> </span><span class="ffd">i</span>,<span class="_"> </span>at<span class="_"> </span>offsets<span class="_"> </span>relative<span class="_"> </span>to<span class="_"> </span><span class="ffd">%rbp</span>.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
