<div id="pf422" class="pf w2 h11" data-page-no="422"><div class="pc pc422 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg422.png"/><div class="t m5 x13a h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>12.7<span class="_ _60"> </span>Other<span class="_ _10"> </span>Concurrency<span class="_ _10"> </span>Issues<span class="_ _3e"> </span><span class="ffe fs1e">1057</span></div><div class="t m5 x84 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/rand.c</div><div class="t m5 x2c h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">unsigned<span class="_ _1f"> </span>next_seed<span class="_ _e"> </span>=<span class="_ _1f"> </span>1;</span></div><div class="t m5 x2c h2e y281 ff6 fs20 fc6 sc0 ls0 ws0">2</div><div class="t m5 x2c h2e y282 ff6 fs20 fc6 sc0 ls0 ws0">3</div><div class="t m5 x2d h2d y283 ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>rand<span class="_ _1f"> </span>-<span class="_ _1f"> </span>return<span class="_ _e"> </span>pseudorandom<span class="_ _1f"> </span>integer<span class="_ _e"> </span>in<span class="_ _1f"> </span>the<span class="_ _1f"> </span>range<span class="_ _e"> </span>0..32767<span class="_ _1f"> </span>*/</div><div class="t m5 x2c h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _1c"> </span><span class="ffd fs1e fc2">unsigned<span class="_ _1f"> </span>rand(void)</span></div><div class="t m5 x2c h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x2c h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">next_seed<span class="_ _e"> </span>=<span class="_ _1f"> </span>next_seed*1103515245<span class="_ _1f"> </span>+<span class="_ _e"> </span>12543;</span></div><div class="t m5 x2c h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>(unsigned)(next_seed&gt;&gt;16)<span class="_ _1f"> </span>%<span class="_ _1f"> </span>32768;</span></div><div class="t m5 x2c h2d y4493 ff6 fs20 fc6 sc0 ls0 ws0">8<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x2c h2e y4a9a ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x17 h2e y6a52 ff6 fs20 fc6 sc0 ls0 ws0">10</div><div class="t m5 x2d h2d y4a9b ffd fs1e fc2 sc0 ls0 ws0">/*<span class="_ _e"> </span>srand<span class="_ _1f"> </span>-<span class="_ _1f"> </span>set<span class="_ _e"> </span>the<span class="_ _1f"> </span>initial<span class="_ _e"> </span>seed<span class="_ _1f"> </span>for<span class="_ _1f"> </span>rand()<span class="_ _e"> </span>*/</div><div class="t m5 x17 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>srand(unsigned<span class="_ _e"> </span>new_seed)</span></div><div class="t m5 x17 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 x17 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">next_seed<span class="_ _e"> </span>=<span class="_ _1f"> </span>new_seed;</span></div><div class="t m5 x17 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x84 h2c y83a8 ffa fs16 fc2 sc0 ls0 ws0">code/conc/rand.c</div><div class="t m5 x17 h34 y83a9 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_"> </span>12.37<span class="_ _66"> </span><span class="fc1">A<span class="_"> </span>thread-unsafe<span class="_"> </span>pseudorandom<span class="_"> </span>number<span class="_"> </span>generator<span class="_ _1"></span>.<span class="_"> </span><span class="ff6">(Based<span class="_ _11"> </span>on<span class="_ _10"> </span>[61])</span></span></div><div class="t m5 x30 h26 y83aa ff7 fs19 fc1 sc0 ls0 ws0">increments<span class="_"> </span>an<span class="_ _11"> </span>unprotected<span class="_ _11"> </span>global<span class="_ _11"> </span>counter<span class="_ _11"> </span>variable.<span class="_"> </span>T<span class="_ _1"></span>his<span class="_ _11"> </span>class<span class="_ _11"> </span>of<span class="_ _11"> </span>thread-</div><div class="t m5 x30 h26 y83ab ff7 fs19 fc1 sc0 ls0 ws0">unsafe<span class="_ _13"> </span>functions<span class="_ _13"> </span>is<span class="_ _13"> </span>relatively<span class="_ _13"> </span>easy<span class="_ _6"> </span>to<span class="_ _13"> </span>make<span class="_ _13"> </span>thread-safe:<span class="_ _13"> </span>protect<span class="_ _13"> </span>the<span class="_ _13"> </span>shared</div><div class="t m5 x30 h26 y83ac ff7 fs19 fc1 sc0 ls0 ws0">variables<span class="_ _13"> </span>with<span class="_ _6"> </span>synchronization<span class="_ _13"> </span>operations<span class="_ _6"> </span>such<span class="_ _13"> </span>as<span class="_ _13"> </span><span class="ff11">P<span class="_"> </span></span>and<span class="_ _6"> </span><span class="ff11">V<span class="_ _13"> </span></span>.<span class="_ _6"> </span>An<span class="_ _13"> </span>advantage</div><div class="t m5 x30 h26 y83ad ff7 fs19 fc1 sc0 ls0 ws0">is<span class="_ _13"> </span>that<span class="_ _13"> </span>it<span class="_ _13"> </span>does<span class="_ _13"> </span>not<span class="_ _13"> </span>require<span class="_ _13"> </span>any<span class="_ _6"> </span>changes<span class="_ _13"> </span>in<span class="_ _13"> </span>the<span class="_ _13"> </span>calling<span class="_ _13"> </span>program.<span class="_ _13"> </span>A<span class="_ _13"> </span>disadvan-</div><div class="t m5 x30 h26 y83ae ff7 fs19 fc1 sc0 ls0 ws0">tage<span class="_"> </span>is<span class="_"> </span>that<span class="_"> </span>the<span class="_"> </span>synchronization<span class="_"> </span>operations<span class="_"> </span>slow<span class="_"> </span>down<span class="_"> </span>the<span class="_"> </span>function.</div><div class="t m5 x72 h26 y83af ff7 fs19 fc1 sc0 ls0 ws0">Class<span class="_"> </span>2:<span class="_ _e"> </span><span class="ffa">Functions<span class="_"> </span>that<span class="_ _13"> </span>keep<span class="_"> </span>state<span class="_ _13"> </span>across<span class="_"> </span>multiple<span class="_ _13"> </span>invocations<span class="_ _1"></span>.<span class="_ _6"> </span><span class="ff7">A<span class="_"> </span>pseudorandom</span></span></div><div class="t m5 x30 h26 y83b0 ff7 fs19 fc1 sc0 ls0 ws0">number<span class="_ _13"> </span>generator<span class="_"> </span>is<span class="_ _13"> </span>a<span class="_ _13"> </span>simple<span class="_"> </span>example<span class="_ _13"> </span>of<span class="_ _13"> </span>this<span class="_ _13"> </span>class<span class="_"> </span>of<span class="_ _13"> </span>thread-unsafe<span class="_ _13"> </span>func-</div><div class="t m5 x30 h26 y83b1 ff7 fs19 fc1 sc0 ls0 ws0">tions<span class="_ _1"></span>.<span class="_ _21"> </span>Consider<span class="_ _f"> </span>the<span class="_ _f"> </span>pseudorandom<span class="_ _f"> </span>number<span class="_ _f"> </span>generator<span class="_ _f"> </span>package<span class="_ _f"> </span>in<span class="_ _21"> </span>Fig-</div><div class="t m5 x30 h26 y83b2 ff7 fs19 fc1 sc0 ls0 ws0">ure<span class="_"> </span>12.37.</div><div class="t m5 x20a h26 y83b3 ff7 fs19 fc1 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">rand<span class="_ _10"> </span><span class="ff7">function<span class="_"> </span>is<span class="_ _11"> </span>thread-unsafe<span class="_"> </span>because<span class="_"> </span>the<span class="_ _11"> </span>result<span class="_"> </span>of<span class="_ _11"> </span>the<span class="_"> </span>current</span></span></div><div class="t m5 x30 h26 y83b4 ff7 fs19 fc1 sc0 ls0 ws0">invocation<span class="_ _13"> </span>depends<span class="_ _6"> </span>on<span class="_ _13"> </span>an<span class="_ _13"> </span>intermediate<span class="_ _6"> </span>result<span class="_ _13"> </span>from<span class="_ _13"> </span>the<span class="_ _13"> </span>previous<span class="_ _6"> </span>iteration.</div><div class="t m5 x30 h26 y83b5 ff7 fs19 fc1 sc0 ls0 ws0">When<span class="_ _13"> </span>we<span class="_"> </span>call<span class="_ _13"> </span><span class="ffd">rand<span class="_ _13"> </span></span>repeatedly<span class="_"> </span>from<span class="_ _13"> </span>a<span class="_"> </span>single<span class="_ _13"> </span>thread<span class="_"> </span>after<span class="_ _13"> </span>seeding<span class="_"> </span>it<span class="_ _13"> </span>with<span class="_ _13"> </span>a</div><div class="t m5 x30 h26 y83b6 ff7 fs19 fc1 sc0 ls0 ws0">call<span class="_ _13"> </span>to<span class="_ _13"> </span><span class="ffd">srand</span>,<span class="_ _13"> </span>we<span class="_ _13"> </span>can<span class="_ _13"> </span>expect<span class="_ _13"> </span>a<span class="_ _13"> </span>repeatable<span class="_ _13"> </span>sequence<span class="_ _13"> </span>of<span class="_ _13"> </span>numbers<span class="_ _3"></span>.<span class="_ _13"> </span>However,</div><div class="t m5 x30 h26 y83b7 ff7 fs19 fc1 sc0 ls0 ws0">this<span class="_"> </span>assumption<span class="_"> </span>no<span class="_"> </span>longer<span class="_"> </span>holds<span class="_"> </span>if<span class="_"> </span>multiple<span class="_"> </span>threads<span class="_"> </span>are<span class="_"> </span>calling<span class="_"> </span><span class="ffd">rand</span>.</div><div class="t m5 x20a h26 y83b8 ff7 fs19 fc1 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>only<span class="_ _6"> </span>way<span class="_ _13"> </span>to<span class="_ _6"> </span>make<span class="_ _6"> </span>a<span class="_ _13"> </span>function<span class="_ _6"> </span>such<span class="_ _13"> </span>as<span class="_ _6"> </span><span class="ffd">rand<span class="_ _13"> </span></span>thread-safe<span class="_ _a"> </span>is<span class="_ _13"> </span>to<span class="_ _6"> </span>rewrite</div><div class="t m5 x30 h26 y83b9 ff7 fs19 fc1 sc0 ls0 ws0">it<span class="_ _16"> </span>so<span class="_ _16"> </span>that<span class="_ _14"> </span>it<span class="_ _16"> </span>does<span class="_ _16"> </span>not<span class="_ _14"> </span>use<span class="_ _16"> </span>any<span class="_ _16"> </span><span class="ffd">static<span class="_ _14"> </span></span>data,<span class="_ _14"> </span>relying<span class="_ _16"> </span>instead<span class="_ _16"> </span>on<span class="_ _14"> </span>the<span class="_ _16"> </span>caller</div><div class="t m5 x30 h26 y83ba ff7 fs19 fc1 sc0 ls0 ws0">to<span class="_ _11"> </span>pass<span class="_ _11"> </span>the<span class="_ _16"> </span>state<span class="_ _11"> </span>information<span class="_ _11"> </span>in<span class="_ _11"> </span>arguments<span class="_ _1"></span>.<span class="_ _16"> </span>T<span class="_ _1"></span>he<span class="_ _11"> </span>disadvantage<span class="_ _16"> </span>is<span class="_ _11"> </span>that<span class="_ _11"> </span>the</div><div class="t m5 x30 h26 y83bb ff7 fs19 fc1 sc0 ls0 ws0">programmer<span class="_ _16"> </span>is<span class="_ _14"> </span>now<span class="_ _16"> </span>forced<span class="_ _14"> </span>to<span class="_ _16"> </span>change<span class="_ _14"> </span>the<span class="_ _16"> </span>code<span class="_ _14"> </span>in<span class="_ _16"> </span>the<span class="_ _14"> </span>calling<span class="_ _14"> </span>routine<span class="_ _16"> </span>as</div><div class="t m5 x30 h26 y83bc ff7 fs19 fc1 sc0 ls0 ws0">well.<span class="_ _13"> </span>In<span class="_ _13"> </span>a<span class="_ _13"> </span>large<span class="_ _6"> </span>program<span class="_ _13"> </span>where<span class="_ _13"> </span>there<span class="_ _13"> </span>are<span class="_ _13"> </span>potentially<span class="_ _13"> </span>hundreds<span class="_ _6"> </span>of<span class="_ _13"> </span>different</div><div class="t m5 x30 h26 y83bd ff7 fs19 fc1 sc0 ls0 ws0">call<span class="_ _15"> </span>sites<span class="_ _1"></span>,<span class="_ _f"> </span>making<span class="_ _15"> </span>such<span class="_ _21"> </span>modiÔ¨Åcations<span class="_ _15"> </span>could<span class="_ _15"> </span>be<span class="_ _21"> </span>nontrivial<span class="_ _15"> </span>and<span class="_ _21"> </span>prone<span class="_ _15"> </span>to</div><div class="t m5 x30 h26 y83be ff7 fs19 fc1 sc0 ls0 ws0">error.</div><div class="t m5 x72 h26 y83bf ff7 fs19 fc1 sc0 ls0 ws0">Class<span class="_ _21"> </span>3:<span class="_ _1f"> </span><span class="ffa">Functions<span class="_ _21"> </span>that<span class="_ _21"> </span>return<span class="_ _f"> </span>a<span class="_ _f"> </span>pointer<span class="_ _21"> </span>to<span class="_ _f"> </span>a<span class="_ _21"> </span>static<span class="_ _f"> </span>variable.<span class="_ _16"> </span></span>Some<span class="_ _21"> </span>functions<span class="_ _1"></span>,</div><div class="t m5 x30 h26 y83c0 ff7 fs19 fc1 sc0 ls0 ws0">such<span class="_ _13"> </span>as<span class="_"> </span><span class="ffd">ctime<span class="_ _13"> </span></span>and<span class="_ _13"> </span><span class="ffd">gethostbyname</span>,<span class="_ _13"> </span>compute<span class="_"> </span>a<span class="_ _13"> </span>result<span class="_ _13"> </span>in<span class="_ _13"> </span>a<span class="_"> </span><span class="ffd">static<span class="_ _13"> </span></span>variable</div><div class="t m5 x30 h26 y83c1 ff7 fs19 fc1 sc0 ls0 ws0">and<span class="_"> </span>then<span class="_ _11"> </span>return<span class="_"> </span>a<span class="_ _11"> </span>pointer<span class="_"> </span>to<span class="_ _11"> </span>that<span class="_"> </span>variable<span class="_ _0"></span>.<span class="_"> </span>If<span class="_ _11"> </span>we<span class="_"> </span>call<span class="_ _11"> </span>such<span class="_"> </span>functions<span class="_ _11"> </span>from</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
