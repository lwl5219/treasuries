<div id="pf41d" class="pf w2 h11" data-page-no="41d"><div class="pc pc41d w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg41d.png"/><div class="t m5 x14 h28 y9b ffe fs1e fc2 sc0 ls0 ws0">1052<span class="_ _1b"> </span><span class="ff6 fs1f">Chapter<span class="_ _10"> </span>12<span class="_ _3d"> </span>Concurrent<span class="_ _10"> </span>Programming</span></div><div class="t m5 x147 h2c y27f ffa fs16 fc2 sc0 ls0 ws0">code/conc/psum-mutex.c</div><div class="t m5 xb h2d y280 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Thread<span class="_ _e"> </span>routine<span class="_ _1f"> </span>for<span class="_ _1f"> </span>psum-mutex.c<span class="_ _e"> </span>*/</span></div><div class="t m5 xb h2d y281 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>*sum_mutex(void<span class="_ _e"> </span>*vargp)</span></div><div class="t m5 xb h2d y283 ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 xb h2d y284 ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>myid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>*((long<span class="_ _e"> </span>*)vargp);<span class="_ _86"> </span>/*<span class="_ _1f"> </span>Extract<span class="_ _e"> </span>the<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>ID<span class="_ _e"> </span>*/</span></div><div class="t m5 xb h2d y285 ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>start<span class="_ _1f"> </span>=<span class="_ _1f"> </span>myid<span class="_ _e"> </span>*<span class="_ _1f"> </span>nelems_per_thread;<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Start<span class="_ _1f"> </span>element<span class="_ _e"> </span>index<span class="_ _1f"> </span>*/</span></div><div class="t m5 xb h2d y286 ff6 fs20 fc6 sc0 ls0 ws0">6<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>end<span class="_ _1f"> </span>=<span class="_ _1f"> </span>start<span class="_ _e"> </span>+<span class="_ _1f"> </span>nelems_per_thread;<span class="_ _1a"> </span>/*<span class="_ _e"> </span>End<span class="_ _1f"> </span>element<span class="_ _1f"> </span>index<span class="_ _e"> </span>*/</span></div><div class="t m5 xb h2d y287 ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>i;</span></div><div class="t m5 xb h2e y4493 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 xb h2e y66b4 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x26 h2d y4a9a ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>start;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>end;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</div><div class="t m5 x14 h2d y4a9b ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">P(&amp;mutex);</span></div><div class="t m5 x14 h2d y4a9c ff6 fs20 fc6 sc0 ls0 ws0">11<span class="_ _70"> </span><span class="ffd fs1e fc2">gsum<span class="_ _e"> </span>+=<span class="_ _1f"> </span>i;</span></div><div class="t m5 x14 h2d y906 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _70"> </span><span class="ffd fs1e fc2">V(&amp;mutex);</span></div><div class="t m5 x14 h2d y4a9d ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _20"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x14 h2d y4a9e ff6 fs20 fc6 sc0 ls0 ws0">14<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>NULL;</span></div><div class="t m5 x14 h2d y4a9f ff6 fs20 fc6 sc0 ls0 ws0">15<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x147 h2c y65f3 ffa fs16 fc2 sc0 ls0 ws0">code/conc/psum-mutex.c</div><div class="t m5 x14 h2f y65f4 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _6"> </span>12.32<span class="_ _c"> </span><span class="fc1">Thread<span class="_ _13"> </span>routine<span class="_ _a"> </span>for</span></div><div class="t m5 x18e h3a y65f5 ffd fs19 fc1 sc0 ls0 ws0">psum-mutex<span class="ffe fs16">.<span class="_ _6"> </span><span class="ff6">Each<span class="_ _13"> </span>peer<span class="_ _6"> </span>thread<span class="_ _6"> </span>sums<span class="_ _13"> </span>into<span class="_ _6"> </span>a<span class="_ _6"> </span>shared<span class="_ _13"> </span>global<span class="_ _6"> </span>variable<span class="_ _6"> </span>protected</span></span></div><div class="t m5 x14 h34 y8306 ff6 fs16 fc1 sc0 ls0 ws0">by<span class="_ _10"> </span>a<span class="_ _11"> </span>mutex.</div><div class="t m5 x8b h2c y8307 ffa fs16 fc1 sc0 ls0 ws0">code/conc/psum-array<span class="_ _3"></span>.c</div><div class="t m5 xb h2d y8308 ff6 fs20 fc6 sc0 ls0 ws0">1<span class="_ _1c"> </span><span class="ffd fs1e fc2">/*<span class="_ _1f"> </span>Thread<span class="_ _e"> </span>routine<span class="_ _1f"> </span>for<span class="_ _1f"> </span>psum-array.c<span class="_ _e"> </span>*/</span></div><div class="t m5 xb h2d y8309 ff6 fs20 fc6 sc0 ls0 ws0">2<span class="_ _1c"> </span><span class="ffd fs1e fc2">void<span class="_ _1f"> </span>*sum_array(void<span class="_ _e"> </span>*vargp)</span></div><div class="t m5 xb h2d y830a ff6 fs20 fc6 sc0 ls0 ws0">3<span class="_ _1c"> </span><span class="ffd fs1e fc2">{</span></div><div class="t m5 xb h2d y830b ff6 fs20 fc6 sc0 ls0 ws0">4<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>myid<span class="_ _1f"> </span>=<span class="_ _1f"> </span>*((long<span class="_ _e"> </span>*)vargp);<span class="_ _86"> </span>/*<span class="_ _1f"> </span>Extract<span class="_ _e"> </span>the<span class="_ _1f"> </span>thread<span class="_ _1f"> </span>ID<span class="_ _e"> </span>*/</span></div><div class="t m5 xb h2d y830c ff6 fs20 fc6 sc0 ls0 ws0">5<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>start<span class="_ _1f"> </span>=<span class="_ _1f"> </span>myid<span class="_ _e"> </span>*<span class="_ _1f"> </span>nelems_per_thread;<span class="_ _e"> </span>/*<span class="_ _1f"> </span>Start<span class="_ _1f"> </span>element<span class="_ _e"> </span>index<span class="_ _1f"> </span>*/</span></div><div class="t m5 xb h2e y830d ff6 fs20 fc6 sc0 ls0 ws0">6</div><div class="t m5 x26 h2d y830e ffd fs1e fc2 sc0 ls0 ws0">long<span class="_ _e"> </span>end<span class="_ _1f"> </span>=<span class="_ _1f"> </span>start<span class="_ _e"> </span>+<span class="_ _1f"> </span>nelems_per_thread;<span class="_ _1a"> </span>/*<span class="_ _e"> </span>End<span class="_ _1f"> </span>element<span class="_ _1f"> </span>index<span class="_ _e"> </span>*/</div><div class="t m5 xb h2d y830f ff6 fs20 fc6 sc0 ls0 ws0">7<span class="_ _20"> </span><span class="ffd fs1e fc2">long<span class="_ _e"> </span>i;</span></div><div class="t m5 xb h2e y8310 ff6 fs20 fc6 sc0 ls0 ws0">8</div><div class="t m5 xb h2e y8311 ff6 fs20 fc6 sc0 ls0 ws0">9</div><div class="t m5 x26 h2d y8312 ffd fs1e fc2 sc0 ls0 ws0">for<span class="_ _e"> </span>(i<span class="_ _1f"> </span>=<span class="_ _1f"> </span>start;<span class="_ _e"> </span>i<span class="_ _1f"> </span>&lt;<span class="_ _e"> </span>end;<span class="_ _1f"> </span>i++)<span class="_ _1f"> </span>{</div><div class="t m5 x14 h2d y8313 ff6 fs20 fc6 sc0 ls0 ws0">10<span class="_ _70"> </span><span class="ffd fs1e fc2">psum[myid]<span class="_ _e"> </span>+=<span class="_ _1f"> </span>i;</span></div><div class="t m5 x14 h2e y8314 ff6 fs20 fc6 sc0 ls0 ws0">11</div><div class="t m5 x26 h2d y8315 ffd fs1e fc2 sc0 ls0 ws0">}</div><div class="t m5 x14 h2d y8316 ff6 fs20 fc6 sc0 ls0 ws0">12<span class="_ _20"> </span><span class="ffd fs1e fc2">return<span class="_ _e"> </span>NULL;</span></div><div class="t m5 x14 h2d y37cc ff6 fs20 fc6 sc0 ls0 ws0">13<span class="_ _1c"> </span><span class="ffd fs1e fc2">}</span></div><div class="t m5 x8b h2c y8317 ffa fs16 fc2 sc0 ls0 ws0">code/conc/psum-array<span class="_ _3"></span>.c</div><div class="t m5 x14 h2f y8318 ffe fs16 fc6 sc0 ls0 ws0">Figure<span class="_ _11"> </span>12.33<span class="_ _c"> </span><span class="fc1">Thread<span class="_ _16"> </span>routine<span class="_ _11"> </span>for</span></div><div class="t m5 x1f7 h3a y8319 ffd fs19 fc1 sc0 ls0 ws0">psum-array<span class="ffe fs16">.<span class="_ _11"> </span><span class="ff6">Each<span class="_ _16"> </span>peer<span class="_ _16"> </span>thread<span class="_ _11"> </span>accumulates<span class="_ _16"> </span>its<span class="_ _11"> </span>partial<span class="_ _16"> </span>sum<span class="_ _11"> </span>in<span class="_ _16"> </span>a<span class="_ _11"> </span>private</span></span></div><div class="t m5 x14 h34 y831a ff6 fs16 fc1 sc0 ls0 ws0">array<span class="_ _10"> </span>element<span class="_ _11"> </span>that<span class="_ _10"> </span>is<span class="_ _10"> </span>not<span class="_ _11"> </span>shared<span class="_ _10"> </span>with<span class="_ _11"> </span>any<span class="_ _10"> </span>other<span class="_ _11"> </span>peer<span class="_ _10"> </span>thread.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
