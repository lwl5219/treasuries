<div id="pf334" class="pf w2 h11" data-page-no="334"><div class="pc pc334 w2 h11"><img class="bi x0 y0 w1 h1" alt="" src="csapp/bg334.png"/><div class="t m5 x54 h28 y9b ff6 fs1f fc2 sc0 ls0 ws0">Section<span class="_ _10"> </span>8.6<span class="_ _60"> </span>Nonlocal<span class="_ _10"> </span>Jumps<span class="_ _3e"> </span><span class="ffe fs1e">819</span></div><div class="t m5 x31 h2d y68db ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;setjmp.h&gt;</div><div class="t m5 x31 h2d y68dc ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>setjmp(jmp_buf<span class="_ _1f"> </span>env);</div><div class="t m5 x31 h2d y68dd ffd fs1e fc2 sc0 ls0 ws0">int<span class="_ _e"> </span>sigsetjmp(sigjmp_buf<span class="_ _1f"> </span>env,<span class="_ _1f"> </span>int<span class="_ _e"> </span>savesigs);</div><div class="t m5 x24c hf1 y6a47 ff7 fs1f fc2 sc0 ls0 ws0">Returns:<span class="_"> </span>0<span class="_"> </span>from<span class="_"> </span><span class="ffd fs4e">setjmp</span>,<span class="_"> </span>nonzero<span class="_"> </span>from<span class="_"> </span><span class="ffd fs4e">longjmp</span>s</div><div class="t m5 x17 h26 y6a48 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">setjmp<span class="_ _11"> </span><span class="ff7">function<span class="_"> </span>saves<span class="_ _11"> </span>the<span class="_ _11"> </span>current<span class="_ _11"> </span><span class="ffa">calling<span class="_ _11"> </span>environment<span class="_ _16"> </span></span>in<span class="_ _11"> </span>the<span class="_"> </span></span>env<span class="_ _11"> </span><span class="ff7">buffer,<span class="_ _11"> </span>for</span></span></div><div class="t m5 x17 h26 y6a49 ff7 fs19 fc2 sc0 ls0 ws0">later<span class="_ _13"> </span>use<span class="_ _6"> </span>by<span class="_ _13"> </span><span class="ffd">longjmp</span>,<span class="_ _13"> </span>and<span class="_ _6"> </span>returns<span class="_ _13"> </span>0.<span class="_ _6"> </span>T<span class="_ _0"></span>he<span class="_ _13"> </span>calling<span class="_ _6"> </span>environment<span class="_ _13"> </span>includes<span class="_ _6"> </span>the<span class="_ _13"> </span>program</div><div class="t m5 x17 h26 y6a4a ff7 fs19 fc2 sc0 ls0 ws0">counter,<span class="_"> </span>stack<span class="_ _11"> </span>pointer,<span class="_"> </span>and<span class="_ _11"> </span>general-purpose<span class="_ _11"> </span>registers<span class="_ _1"></span>.<span class="_ _11"> </span>F<span class="_ _1"></span>or<span class="_ _11"> </span>subtle<span class="_ _11"> </span>reasons<span class="_"> </span>beyond</div><div class="t m5 x17 h26 y6a4b ff7 fs19 fc2 sc0 ls0 ws0">our<span class="_"> </span>scope<span class="_ _1"></span>,<span class="_"> </span>the<span class="_"> </span>value<span class="_"> </span>that<span class="_"> </span><span class="ffd">setjmp<span class="_ _11"> </span></span>returns<span class="_"> </span>should<span class="_"> </span>not<span class="_"> </span>be<span class="_"> </span>assigned<span class="_"> </span>to<span class="_"> </span>a<span class="_"> </span>variable:</div><div class="t m5 x1b6 h2d y6a4c ffd fs1e fc2 sc0 ls0 ws0">rc<span class="_ _e"> </span>=<span class="_ _1f"> </span>setjmp(env);<span class="_ _1a"> </span>/*<span class="_ _1f"> </span>Wrong!<span class="_ _e"> </span>*/</div><div class="t m5 x17 h26 y6a4d ff7 fs19 fc2 sc0 ls0 ws0">However,<span class="_ _13"> </span>it<span class="_"> </span>can<span class="_ _13"> </span>be<span class="_"> </span>safely<span class="_"> </span>used<span class="_ _13"> </span>as<span class="_"> </span>a<span class="_ _13"> </span>test<span class="_"> </span>in<span class="_"> </span>a<span class="_ _13"> </span><span class="ffd">switch<span class="_ _10"> </span></span>or<span class="_ _13"> </span>conditional<span class="_"> </span>statement<span class="_"> </span>[62].</div><div class="t m5 x31 h2d y6a4e ffd fs1e fc2 sc0 ls0 ws0">#include<span class="_ _e"> </span>&lt;setjmp.h&gt;</div><div class="t m5 x31 h2d y6a4f ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>longjmp(jmp_buf<span class="_ _1f"> </span>env,<span class="_ _1f"> </span>int<span class="_ _e"> </span>retval);</div><div class="t m5 x31 h2d y6a50 ffd fs1e fc2 sc0 ls0 ws0">void<span class="_ _e"> </span>siglongjmp(sigjmp_buf<span class="_ _1f"> </span>env,<span class="_ _1f"> </span>int<span class="_ _e"> </span>retval);</div><div class="t m5 x152 hf1 y6a51 ff7 fs1f fc2 sc0 ls0 ws0">Never<span class="_"> </span>returns</div><div class="t m5 x17 h26 y4026 ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _16"> </span><span class="ffd ls0">longjmp<span class="_ _16"> </span><span class="ff7">function<span class="_ _11"> </span>restores<span class="_ _16"> </span>the<span class="_ _11"> </span>calling<span class="_ _16"> </span>environment<span class="_ _11"> </span>from<span class="_ _16"> </span>the<span class="_ _11"> </span></span>env<span class="_ _16"> </span><span class="ff7">buffer<span class="_ _11"> </span>and</span></span></div><div class="t m5 x17 h26 y4027 ff7 fs19 fc2 sc0 ls0 ws0">then<span class="_ _11"> </span>triggers<span class="_ _16"> </span>a<span class="_ _11"> </span>return<span class="_ _16"> </span>from<span class="_ _16"> </span>the<span class="_ _11"> </span>most<span class="_ _16"> </span>recent<span class="_ _11"> </span><span class="ffd">setjmp<span class="_ _16"> </span></span>call<span class="_ _11"> </span>that<span class="_ _16"> </span>initialized<span class="_ _11"> </span><span class="ffd">env</span><span class="ls28d">.T<span class="_ _42"></span>h<span class="_ _49"></span>e</span></div><div class="t m5 x17 h26 y4028 ffd fs19 fc2 sc0 ls0 ws0">setjmp<span class="_ _10"> </span><span class="ff7">then<span class="_"> </span>returns<span class="_"> </span>with<span class="_"> </span>the<span class="_"> </span>nonzero<span class="_"> </span>return<span class="_"> </span>value<span class="_"> </span></span>retval<span class="ff7">.</span></div><div class="t m5 x26 h26 y4029 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_ _13"> </span>interactions<span class="_ _6"> </span>between<span class="_ _13"> </span><span class="ffd">setjmp<span class="_ _6"> </span></span>and<span class="_ _6"> </span><span class="ffd">longjmp<span class="_ _13"> </span></span>can<span class="_ _6"> </span>be<span class="_ _13"> </span>confusing<span class="_ _6"> </span>at<span class="_ _13"> </span>ﬁrst<span class="_ _a"> </span>glance.</div><div class="t m5 x17 h26 y402a ff7 fs19 fc2 sc0 lsd ws0">Th<span class="_ _2"></span>e<span class="_ _f"> </span><span class="ffd ls0">setjmp<span class="_ _21"> </span><span class="ff7">function<span class="_ _21"> </span>is<span class="_ _21"> </span>called<span class="_ _21"> </span>once<span class="_ _15"> </span>but<span class="_ _21"> </span>returns<span class="_ _21"> </span><span class="ffa">multiple<span class="_ _21"> </span>times:<span class="_ _21"> </span></span>once<span class="_ _21"> </span>when<span class="_ _21"> </span>the</span></span></div><div class="t m5 x17 h26 y402b ffd fs19 fc2 sc0 ls0 ws0">setjmp<span class="_ _21"> </span><span class="ff7">is<span class="_ _21"> </span>ﬁrst<span class="_ _21"> </span>called<span class="_ _21"> </span>and<span class="_ _f"> </span>the<span class="_ _21"> </span>calling<span class="_ _21"> </span>environment<span class="_ _21"> </span>is<span class="_ _f"> </span>stored<span class="_ _21"> </span>in<span class="_ _21"> </span>the<span class="_ _f"> </span></span>env<span class="_ _21"> </span><span class="ff7">buffer,</span></div><div class="t m5 x17 h26 y402c ff7 fs19 fc2 sc0 ls0 ws0">and<span class="_ _11"> </span>once<span class="_ _16"> </span>for<span class="_ _16"> </span>each<span class="_ _11"> </span>corresponding<span class="_ _16"> </span><span class="ffd">longjmp<span class="_ _11"> </span></span>call.<span class="_ _16"> </span>On<span class="_ _16"> </span>the<span class="_ _11"> </span>other<span class="_ _16"> </span>hand,<span class="_ _16"> </span>the<span class="_ _11"> </span><span class="ffd">longjmp</span></div><div class="t m5 x17 h26 y402d ff7 fs19 fc2 sc0 ls0 ws0">function<span class="_"> </span>is<span class="_"> </span>called<span class="_"> </span>once<span class="_"> </span>but<span class="_"> </span>never<span class="_"> </span>returns<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y402e ff7 fs19 fc2 sc0 ls0 ws0">An<span class="_ _13"> </span>important<span class="_"> </span>application<span class="_ _13"> </span>of<span class="_ _13"> </span>nonlocal<span class="_"> </span>jumps<span class="_ _13"> </span>is<span class="_ _13"> </span>to<span class="_"> </span>permit<span class="_ _13"> </span>an<span class="_ _13"> </span>immediate<span class="_"> </span>return</div><div class="t m5 x17 h26 y402f ff7 fs19 fc2 sc0 ls0 ws0">from<span class="_ _14"> </span>a<span class="_ _15"> </span>deeply<span class="_ _15"> </span>nested<span class="_ _15"> </span>function<span class="_ _15"> </span>call,<span class="_ _21"> </span>usually<span class="_ _14"> </span>as<span class="_ _15"> </span>a<span class="_ _15"> </span>result<span class="_ _15"> </span>of<span class="_ _15"> </span>detecting<span class="_ _15"> </span>some<span class="_ _14"> </span>error</div><div class="t m5 x17 h26 y4030 ff7 fs19 fc2 sc0 ls0 ws0">condition.<span class="_"> </span>If<span class="_"> </span>an<span class="_"> </span>error<span class="_"> </span>condition<span class="_"> </span>is<span class="_ _11"> </span>detected<span class="_"> </span>deep<span class="_"> </span>in<span class="_"> </span>a<span class="_"> </span>nested<span class="_ _11"> </span>function<span class="_"> </span>call,<span class="_"> </span>we<span class="_"> </span>can</div><div class="t m5 x17 h26 y4031 ff7 fs19 fc2 sc0 ls0 ws0">use<span class="_ _13"> </span>a<span class="_ _6"> </span>nonlocal<span class="_ _13"> </span>jump<span class="_ _6"> </span>to<span class="_ _13"> </span>return<span class="_ _13"> </span>directly<span class="_ _6"> </span>to<span class="_ _13"> </span>a<span class="_ _6"> </span>common<span class="_ _13"> </span>localized<span class="_ _13"> </span>error<span class="_ _6"> </span>handler<span class="_ _13"> </span>instead</div><div class="t m5 x17 h26 y4032 ff7 fs19 fc2 sc0 ls0 ws0">of<span class="_"> </span>laboriously<span class="_"> </span>unwinding<span class="_"> </span>the<span class="_"> </span>call<span class="_"> </span>stack.</div><div class="t m5 x26 h26 y4033 ff7 fs19 fc2 sc0 ls0 ws0">F<span class="_ _1"></span>igure<span class="_"> </span>8.43<span class="_"> </span>shows<span class="_"> </span>an<span class="_"> </span>example<span class="_"> </span>of<span class="_"> </span>how<span class="_"> </span>this<span class="_"> </span>might<span class="_"> </span>work.<span class="_"> </span>The<span class="_"> </span><span class="ffd">main<span class="_ _10"> </span></span>routine<span class="_"> </span>ﬁrst</div><div class="t m5 x17 h26 y4034 ff7 fs19 fc2 sc0 ls0 ws0">calls<span class="_"> </span><span class="ffd">setjmp<span class="_ _10"> </span></span>to<span class="_"> </span>save<span class="_ _13"> </span>the<span class="_"> </span>current<span class="_"> </span>calling<span class="_"> </span>environment,<span class="_"> </span>and<span class="_"> </span>then<span class="_"> </span>calls<span class="_ _13"> </span>function<span class="_"> </span><span class="ffd">foo</span>,</div><div class="t m5 x17 h26 y4035 ff7 fs19 fc2 sc0 ls0 ws0">which<span class="_ _14"> </span>in<span class="_ _14"> </span>turn<span class="_ _14"> </span>calls<span class="_ _14"> </span>function<span class="_ _14"> </span><span class="ffd">bar</span><span class="ls28e">.I<span class="_ _42"></span>f<span class="ffd ls0">foo<span class="_ _14"> </span><span class="ff7">or<span class="_ _14"> </span></span>bar<span class="_ _14"> </span><span class="ff7">encounter<span class="_ _15"> </span>an<span class="_ _14"> </span>error,<span class="_ _14"> </span>they<span class="_ _14"> </span>return</span></span></span></div><div class="t m5 x17 h26 y4036 ff7 fs19 fc2 sc0 ls0 ws0">immediately<span class="_"> </span>from<span class="_ _13"> </span>the<span class="_"> </span><span class="ffd">setjmp<span class="_ _13"> </span></span>via<span class="_"> </span>a<span class="_"> </span><span class="ffd">longjmp<span class="_ _13"> </span></span>call.<span class="_"> </span>T<span class="_ _1"></span>he<span class="_"> </span>nonzero<span class="_ _13"> </span>return<span class="_"> </span>value<span class="_ _13"> </span>of<span class="_"> </span>the</div><div class="t m5 x17 h26 y4037 ffd fs19 fc2 sc0 ls0 ws0">setjmp<span class="_ _11"> </span><span class="ff7">indicates<span class="_ _16"> </span>the<span class="_ _11"> </span>error<span class="_ _16"> </span>type<span class="_ _1"></span>,<span class="_ _16"> </span>which<span class="_ _11"> </span>can<span class="_ _16"> </span>then<span class="_ _11"> </span>be<span class="_ _16"> </span>decoded<span class="_ _11"> </span>and<span class="_ _11"> </span>handled<span class="_ _16"> </span>in<span class="_ _11"> </span>one</span></div><div class="t m5 x17 h26 y4038 ff7 fs19 fc2 sc0 ls0 ws0">place<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>code<span class="_ _1"></span>.</div><div class="t m5 x26 h26 y4039 ff7 fs19 fc2 sc0 ls0 ws0">T<span class="_ _1"></span>he<span class="_"> </span>feature<span class="_ _13"> </span>of<span class="_"> </span><span class="ffd">longjmp<span class="_ _13"> </span></span>that<span class="_ _13"> </span>allows<span class="_"> </span>it<span class="_ _13"> </span>to<span class="_"> </span>skip<span class="_ _13"> </span>up<span class="_ _13"> </span>through<span class="_"> </span>all<span class="_ _13"> </span>intermediate<span class="_"> </span>calls</div><div class="t m5 x17 h26 y403a ff7 fs19 fc2 sc0 ls0 ws0">can<span class="_ _14"> </span>have<span class="_ _15"> </span>unintended<span class="_ _14"> </span>consequences<span class="_ _1"></span>.<span class="_ _15"> </span>F<span class="_ _1"></span>or<span class="_ _14"> </span>example,<span class="_ _14"> </span>if<span class="_ _15"> </span>some<span class="_ _14"> </span>data<span class="_ _14"> </span>structures<span class="_ _15"> </span>were</div><div class="t m5 x17 h26 y403b ff7 fs19 fc2 sc0 ls0 ws0">allocated<span class="_"> </span>in<span class="_"> </span>the<span class="_"> </span>intermediate<span class="_"> </span>function<span class="_"> </span>calls<span class="_"> </span>with<span class="_ _11"> </span>the<span class="_"> </span>intention<span class="_"> </span>to<span class="_"> </span>deallocate<span class="_"> </span>them</div><div class="t m5 x17 h26 y403c ff7 fs19 fc2 sc0 ls0 ws0">at<span class="_ _14"> </span>the<span class="_ _15"> </span>end<span class="_ _15"> </span>of<span class="_ _15"> </span>the<span class="_ _15"> </span>function,<span class="_ _15"> </span>the<span class="_ _15"> </span>deallocation<span class="_ _15"> </span>code<span class="_ _15"> </span>gets<span class="_ _14"> </span>skipped,<span class="_ _21"> </span>thus<span class="_ _15"> </span>creating<span class="_ _15"> </span>a</div><div class="t m5 x17 h26 y403d ff7 fs19 fc2 sc0 ls0 ws0">memory<span class="_"> </span>leak.</div></div><div class="pi" data-data='{"ctm":[2.000000,0.000000,0.000000,2.000000,0.000000,0.000000]}'></div></div>
