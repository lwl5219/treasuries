<div id="pf194" class="pf w4 h1f" data-page-no="194"><div class="pc pc194 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg194.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">370<span class="_ _1b"> </span><span class="ff19">Signals <span class="_ _24b"> </span>Chapter<span class="_ _21"> </span>10</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">if (sigaction(SIGINT, &amp;ignore, &amp;saveintr) &lt; 0)</div><div class="t m0 x9d h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">if (sigaction(SIGQUIT, &amp;ignore, &amp;savequit) &lt; 0)</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">sigemptyset(&amp;chldmask); <span class="_ _186"> </span>/*<span class="_"> </span>now block SIGCHLD */</div><div class="t m0 x8a h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">sigaddset(&amp;chldmask, SIGCHLD);</div><div class="t m0 x8a h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">if (sigprocmask(SIG_BLOCK, &amp;chldmask, &amp;savemask) &lt; 0)</div><div class="t m0 x9d h57 y805 ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">if ((pid = fork()) &lt; 0) {</div><div class="t m0 x9d h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">status = -1;<span class="_ _15"> </span>/* probably out of processes */</div><div class="t m0 x8a h57 y8d8 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pid == 0) {<span class="_ _74"> </span>/* child */</span></div><div class="t m0 x9d h57 y8d9 ff1a fs2d fc0 sc0 ls0 ws0">/* restore previous signal actions &amp; reset signal mask */</div><div class="t m0 x9d h57 y8da ff1a fs2d fc0 sc0 ls0 ws0">sigaction(SIGINT, &amp;saveintr, NULL);</div><div class="t m0 x9d h57 y8db ff1a fs2d fc0 sc0 ls0 ws0">sigaction(SIGQUIT, &amp;savequit, NULL);</div><div class="t m0 x9d h57 y8dc ff1a fs2d fc0 sc0 ls0 ws0">sigprocmask(SIG_SETMASK, &amp;savemask, NULL);</div><div class="t m0 x9d h57 y2f71 ff1a fs2d fc0 sc0 ls0 ws0">execl(&quot;/bin/sh&quot;, &quot;sh&quot;, &quot;-c&quot;, cmdstring, (char *)0);</div><div class="t m0 x9d h57 y2f72 ff1a fs2d fc0 sc0 ls0 ws0">_exit(127); <span class="_ _15"> </span>/*<span class="_"> </span>exec error */</div><div class="t m0 x8a h57 y2f73 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {<span class="_ _1e6"> </span>/* parent */</span></div><div class="t m0 x9d h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">while (waitpid(pid, &amp;status, 0) &lt; 0)</div><div class="t m0 x1f h57 y8e1 ff1a fs2d fc0 sc0 ls0 ws0">if (errno != EINTR) {</div><div class="t m0 x1ca h57 y2f74 ff1a fs2d fc0 sc0 ls0 ws0">status = -1; /* error other than EINTR from waitpid() */</div><div class="t m0 x1ca h57 y2f75 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x1f h57 y2f76 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y2f77 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y2f78 ff1a fs2d fc0 sc0 ls0 ws0">/* restore previous signal actions &amp; reset signal mask */</div><div class="t m0 x8a h57 y2f79 ff1a fs2d fc0 sc0 ls0 ws0">if (sigaction(SIGINT, &amp;saveintr, NULL) &lt; 0)</div><div class="t m0 x9d h57 y2f7a ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y2f7b ff1a fs2d fc0 sc0 ls0 ws0">if (sigaction(SIGQUIT, &amp;savequit, NULL) &lt; 0)</div><div class="t m0 x9d h57 y2f7c ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y2f7d ff1a fs2d fc0 sc0 ls0 ws0">if (sigprocmask(SIG_SETMASK, &amp;savemask, NULL) &lt; 0)</div><div class="t m0 x9d h57 y2f7e ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y2f7f ff1a fs2d fc0 sc0 ls0 ws0">return(status);</div><div class="t m0 x32 h57 y2f80 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x143 h5e y2f81 ff18 fs10 fc0 sc0 ls0 ws0">Figure 10.28<span class="_ _5a"> </span><span class="ff19">Correct POSIX.1 implementation of<span class="_"> </span><span class="ff1a">system<span class="_ _53"> </span></span>function</span></div><div class="t m0 x32 h4d y2f82 ff19 fs26 fc0 sc0 ls0 ws0">If we link the program in Figur<span class="lsd17">e1<span class="_ _4f"></span><span class="ls0">0.26 with this implementation of the<span class="_"> </span><span class="ff1a">system<span class="_ _66"> </span></span>function,</span></span></div><div class="t m0 x32 h49 y2f83 ff19 fs26 fc0 sc0 ls0 ws0">the resulting binary dif<span class="_ _0"></span>fers fr<span class="_ _0"></span>om the last (ﬂawed) one in the following ways.</div><div class="t m0 x3f h49 y2f84 ff19 fs26 fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>No<span class="_ _59"> </span>signal <span class="_"> </span>is <span class="_ _e"> </span>sent <span class="_"> </span>to <span class="_ _53"> </span>the <span class="_"> </span>calling <span class="_ _e"> </span>process <span class="_"> </span>when <span class="_ _53"> </span>we <span class="_"> </span>type <span class="_ _e"> </span>the <span class="_"> </span>interrupt <span class="_ _e"> </span>or <span class="_"> </span>quit</div><div class="t m0 x41 h49 y2f85 ff19 fs26 fc0 sc0 ls0 ws0">character<span class="_ _6"></span>.</div><div class="t m0 x3f h4d y2f86 ff19 fs26 fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>When<span class="_ _16"> </span>the<span class="_ _16"> </span><span class="ff1a">ed<span class="_ _16"> </span></span>command <span class="_ _47"> </span>exits,<span class="_ _16"> </span><span class="ff1a">SIGCHLD<span class="_ _16"> </span></span>is <span class="_ _47"> </span>not <span class="_ _47"> </span>sent <span class="_ _45"> </span>to <span class="_ _47"> </span>the <span class="_ _47"> </span>calling <span class="_ _47"> </span>process.</div><div class="t m0 x41 h4d y2f87 ff19 fs26 fc0 sc0 ls0 ws0">Instead, <span class="_ _3"></span>it <span class="_ _9"></span>is <span class="_ _9"></span>blocked <span class="_ _9"></span>until <span class="_ _3"></span>we <span class="_ _9"></span>unblock <span class="_ _9"></span>it <span class="_ _9"></span>in <span class="_ _3"></span>the <span class="_ _9"></span>last <span class="_ _9"></span>call <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">sigprocmask</span><span class="ls93b">,a<span class="_ _b"></span><span class="ls0">fter</span></span></div><div class="t m0 x41 h4d y2f88 ff19 fs26 fc0 sc0 ls0 ws0">the<span class="_ _60"> </span><span class="ff1a">system<span class="_ _50"> </span></span>function <span class="_ _46"> </span>retrieves <span class="_ _46"> </span>the <span class="_ _46"> </span>child’s <span class="_ _46"> </span>termination <span class="_ _61"> </span>status <span class="_ _46"> </span>by <span class="_ _61"> </span>calling</div><div class="t m0 x41 h4d y2f89 ff1a fs26 fc0 sc0 ls0 ws0">waitpid<span class="ff19">.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
