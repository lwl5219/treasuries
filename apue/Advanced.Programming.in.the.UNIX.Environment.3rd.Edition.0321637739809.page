<div id="pf329" class="pf w4 h1f" data-page-no="329"><div class="pc pc329 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg329.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">775</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">597 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">598 <span class="_ _176"> </span>*<span class="_"> </span>_db_find_and_lock locked the hash chain for us; read</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">599 <span class="_ _176"> </span>*<span class="_"> </span>the chain ptr to the first index record on hash chain.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">600 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">601 <span class="_ _186"> </span>ptrval<span class="_"> </span><span class="ls15c">=_<span class="_ _1d"></span><span class="ls0">db_readptr(db, db-&gt;chainoff);</span></span></div><div class="t m0 x32 h57 y2015 ff1a fs2d fc0 sc0 ls0 ws0">602 <span class="_ _186"> </span>if<span class="_"> </span>(_db_findfree(db, keylen, datlen) &lt; 0) {</div><div class="t m0 x32 h57 y33ad ff1a fs2d fc0 sc0 ls0 ws0">603 <span class="_ _82"> </span>/*</div><div class="t m0 x32 h57 y33ae ff1a fs2d fc0 sc0 ls0 ws0">604 <span class="_ _166"> </span>*<span class="_"> </span>Can’t find an empty record big enough. Append the</div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">605 <span class="_ _166"> </span>*<span class="_"> </span>new record to the ends of the index and data files.</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">606 <span class="_ _166"> </span>*/</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">607 <span class="_ _82"> </span>_db_writedat(db,<span class="_"> </span>data, 0, SEEK_END);</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">608 <span class="_ _82"> </span>_db_writeidx(db,<span class="_"> </span>key, 0, SEEK_END, ptrval);</div><div class="t m0 x32 h57 y2018 ff1a fs2d fc0 sc0 ls0 ws0">609 <span class="_ _82"> </span>/*</div><div class="t m0 x32 h57 y2ad4 ff1a fs2d fc0 sc0 ls0 ws0">610 <span class="_ _166"> </span>*<span class="_"> </span>db-&gt;idxoff was set by _db_writeidx.<span class="_ _3a"> </span>The new</div><div class="t m0 x32 h57 y2ad5 ff1a fs2d fc0 sc0 ls0 ws0">611 <span class="_ _166"> </span>*<span class="_"> </span>record goes to the front of the hash chain.</div><div class="t m0 x32 h57 y2ad6 ff1a fs2d fc0 sc0 ls0 ws0">612 <span class="_ _166"> </span>*/</div><div class="t m0 x32 h57 y33b1 ff1a fs2d fc0 sc0 ls0 ws0">613 <span class="_ _82"> </span>_db_writeptr(db,<span class="_"> </span>db-&gt;chainoff, db-&gt;idxoff);</div><div class="t m0 x32 h57 y33b2 ff1a fs2d fc0 sc0 ls0 ws0">614 <span class="_ _82"> </span>db-&gt;cnt_stor1++;</div><div class="t m0 x32 h57 y33b3 ff1a fs2d fc0 sc0 ls0 ws0">615 <span class="_ _186"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y33b4 ff1a fs2d fc0 sc0 ls0 ws0">616 <span class="_ _82"> </span>/*</div><div class="t m0 x32 h57 y33b5 ff1a fs2d fc0 sc0 ls0 ws0">617 <span class="_ _166"> </span>*<span class="_"> </span>Reuse an empty record. _db_findfree removed it from</div><div class="t m0 x32 h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">618 <span class="_ _166"> </span>*<span class="_"> </span>the free list and set both db-&gt;datoff and db-&gt;idxoff.</div><div class="t m0 x32 h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">619 <span class="_ _166"> </span>*<span class="_"> </span>Reused record goes to the front of the hash chain.</div><div class="t m0 x32 h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">620 <span class="_ _166"> </span>*/</div><div class="t m0 x32 h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">621 <span class="_ _82"> </span>_db_writedat(db,<span class="_"> </span>data, db-&gt;datoff, SEEK_SET);</div><div class="t m0 x32 h57 y33b9 ff1a fs2d fc0 sc0 ls0 ws0">622 <span class="_ _82"> </span>_db_writeidx(db,<span class="_"> </span>key, db-&gt;idxoff, SEEK_SET, ptrval);</div><div class="t m0 x32 h57 y33ba ff1a fs2d fc0 sc0 ls0 ws0">623 <span class="_ _82"> </span>_db_writeptr(db,<span class="_"> </span>db-&gt;chainoff, db-&gt;idxoff);</div><div class="t m0 x32 h57 y33bb ff1a fs2d fc0 sc0 ls0 ws0">624 <span class="_ _82"> </span>db-&gt;cnt_stor2++;</div><div class="t m0 x32 h57 y33bc ff1a fs2d fc0 sc0 ls0 ws0">625 <span class="_ _186"> </span>}</div><div class="t m0 x32 h4d y5801 ff19 fs26 fc0 sc0 ls0 ws0">[597 <span class="_ _a"></span>– <span class="_ _a"></span>601]<span class="_ _65"> </span>After we <span class="_ _2"></span>call<span class="_ _66"> </span><span class="ff1a">_db_find_and_lock</span><span class="ls52f">,t<span class="_ _d"></span><span class="ls0">he <span class="_ _2"></span>code divides <span class="_ _2"></span>into <span class="_ _2"></span>four cases.<span class="_ _61"> </span>In <span class="_ _2"></span>the</span></span></div><div class="t m0 x11a h49 y5802 ff19 fs26 fc0 sc0 ls0 ws0">ﬁrst <span class="_ _2"></span>two, <span class="_ _3"></span>no <span class="_ _2"></span>recor<span class="ls16b5">dw<span class="_ _8"></span><span class="ls0">as <span class="_ _2"></span>found, <span class="_ _3"></span>so <span class="_ _3"></span>we <span class="_ _2"></span>ar<span class="ls16b5">ea<span class="_ _8"></span><span class="ls0">dding <span class="_ _3"></span>a <span class="_ _3"></span>new <span class="_ _2"></span>record. <span class="_"> </span>W<span class="_ _6"></span><span class="ls16b5">er<span class="_ _4f"></span><span class="ls0">ead <span class="_ _2"></span>the</span></span></span></span></span></span></div><div class="t m0 x11a h49 y5803 ff19 fs26 fc0 sc0 ls0 ws0">offset of the ﬁrst entry on the hash list.</div><div class="t m0 x32 h4d y5804 ff19 fs26 fc0 sc0 ls0 ws0">[602 <span class="_ _a"></span>– <span class="_ _a"></span>614]<span class="_ _65"> </span>Case <span class="_ _42"> </span>1: <span class="_ _23"> </span>we <span class="_ _42"> </span>call<span class="_ _44"> </span><span class="ff1a">_db_findfree<span class="_ _35"> </span></span>to <span class="_ _42"> </span>search <span class="_ _23"> </span>the <span class="_ _42"> </span>free <span class="_ _23"> </span>list <span class="_ _42"> </span>for <span class="_ _42"> </span>a <span class="_ _23"> </span>deleted <span class="_ _42"> </span>record</div><div class="t m0 x11a h49 y5805 ff19 fs26 fc0 sc0 ls0 ws0">with <span class="_ _9"></span>the <span class="_ _23"></span>same <span class="_ _9"></span>size <span class="_ _23"></span>key <span class="_ _9"></span>and <span class="_ _23"></span>same <span class="_ _9"></span>size <span class="_ _23"></span>data.<span class="_ _5a"> </span>If <span class="_ _9"></span>no <span class="_ _23"></span>such <span class="_ _9"></span>record<span class="_ _45"> </span>is<span class="_ _45"> </span>found, <span class="_ _9"></span>we</div><div class="t m0 x11a h49 y5806 ff19 fs26 fc0 sc0 ls0 ws0">have <span class="_ _9"></span>to <span class="_ _9"></span>append <span class="_ _9"></span>the <span class="_ _23"></span>new <span class="_ _9"></span>recor<span class="_ _1"></span>d<span class="_ _45"> </span>to<span class="_ _45"> </span>the <span class="_ _23"></span>ends <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>index <span class="_ _9"></span>and <span class="_ _9"></span>data <span class="_ _23"></span>ﬁles.<span class="_ _16"> </span><span class="ls164">We</span></div><div class="t m0 x11a h4d y5807 ff19 fs26 fc0 sc0 ls0 ws0">call<span class="_ _59"> </span><span class="ff1a">_db_writedat<span class="_ _59"> </span></span>to <span class="_"> </span>write <span class="_"> </span>the <span class="_"> </span>data <span class="_"> </span>part,<span class="_ _59"> </span><span class="ff1a">_db_writeidx<span class="_ _59"> </span></span>to <span class="_"> </span>write <span class="_"> </span>the</div><div class="t m0 x11a h4d y5808 ff19 fs26 fc0 sc0 ls0 ws0">index <span class="_ _9"></span>part, <span class="_ _9"></span>and<span class="_ _45"> </span><span class="ff1a">_db_writeptr<span class="_ _47"> </span></span>to <span class="_ _9"></span>place <span class="_ _9"></span>the <span class="_ _9"></span>new <span class="_ _9"></span>recor<span class="_ _0"></span>d<span class="_ _45"> </span>on<span class="_ _45"> </span>the <span class="_ _3"></span>front <span class="_ _3"></span>of <span class="_ _9"></span>the</div><div class="t m0 x11a h4d y5809 ff19 fs26 fc0 sc0 ls0 ws0">hash <span class="_ _3"></span>chain.<span class="_ _16"> </span><span class="ls164">We <span class="_ _66"> </span>i<span class="_ _9"></span></span>ncrement <span class="_ _3"></span>a <span class="_ _3"></span>count <span class="_ _3"></span>(<span class="ff1a">cnt_stor1</span>)<span class="_ _45"> </span>of<span class="_ _47"> </span>the <span class="_ _3"></span>number <span class="_ _9"></span>of <span class="_ _3"></span>times <span class="_ _3"></span>we</div><div class="t m0 x11a h49 y580a ff19 fs26 fc0 sc0 ls0 ws0">executed this case to allow us to characterize the behavior of the database.</div><div class="t m0 x32 h4d y580b ff19 fs26 fc0 sc0 ls0 ws0">[615 <span class="_ _a"></span>– <span class="_ _a"></span>625]<span class="_ _65"> </span>Case <span class="_ _23"> </span>2:<span class="_ _44"> </span><span class="ff1a">_db_findfree<span class="_ _35"> </span></span>found <span class="_ _23"> </span>an <span class="_ _42"> </span>empty <span class="_ _23"> </span>recor<span class="ls394">dw<span class="_ _43"></span><span class="ls0">ith <span class="_ _23"></span>the <span class="_ _23"> </span>correct <span class="_ _23"> </span>sizes <span class="_ _42"> </span>and</span></span></div><div class="t m0 x11a h49 y580c ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">moved <span class="_ _48"> </span>it <span class="_ _60"> </span>from <span class="_ _65"> </span>the <span class="_ _48"> </span>free <span class="_ _48"> </span>list <span class="_ _48"> </span>(we’ll <span class="_ _48"> </span>see <span class="_ _60"> </span>the <span class="_ _65"> </span>implementation <span class="_ _60"> </span>of</span></div><div class="t m0 x11a h4d y580d ff1a fs26 fc0 sc0 ls0 ws0">_db_findfree<span class="_ _45"> </span><span class="ff19">shortly). <span class="_ _45"> </span>W<span class="_ _6"></span><span class="ls944">ew<span class="_ _b"></span><span class="ls0">rite <span class="_ _9"></span>the <span class="_ _9"></span>data <span class="_ _23"></span>and <span class="_ _9"></span>index <span class="_ _9"></span>portions <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>new</span></span></span></div><div class="t m0 x11a h49 y580e ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cor<span class="ls16b6">da<span class="_ _8"></span><span class="ls0">nd <span class="_ _3"></span>add <span class="_ _3"></span>the <span class="_ _3"></span>recor<span class="_ _0"></span>d<span class="_ _47"> </span>to<span class="_ _47"> </span>the <span class="_ _3"></span>front <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>hash <span class="_ _3"></span>chain <span class="_ _3"></span>as <span class="_ _3"></span>we <span class="_ _3"></span>did <span class="_ _3"></span>in <span class="_ _3"></span>case <span class="_ _3"></span>1.</span></span></span></div><div class="t m0 x11a h4d y580f ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1a">cnt_stor2<span class="_ _80"> </span></span>ﬁeld counts how many times we’ve executed this case.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
