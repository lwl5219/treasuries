<div id="pf36c" class="pf w4 h1f" data-page-no="36c"><div class="pc pc36c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg36c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">842<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">923 <span class="_ _1e7"> </span>}</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">924 <span class="_ _82"> </span>}</div><div class="t m0 x32 h57 y2012 ff1a fs2d fc0 sc0 ls0 ws0">925 <span class="_ _82"> </span>hp<span class="_"> </span><span class="ls15c">=(<span class="_ _1d"></span><span class="ls0">struct ipp_hdr *)cp;</span></span></div><div class="t m0 x32 h57 y2013 ff1a fs2d fc0 sc0 ls0 ws0">926 <span class="_ _82"> </span>i<span class="_"> </span><span class="ls15c">=n<span class="_ _1d"></span><span class="ls0">tohs(hp-&gt;status);</span></span></div><div class="t m0 x32 h57 y2014 ff1a fs2d fc0 sc0 ls0 ws0">927 <span class="_ _82"> </span>jobid<span class="_"> </span><span class="ls15c">=n<span class="_ _1d"></span><span class="ls0">tohl(hp-&gt;request_id);</span></span></div><div class="t m0 x32 h57 y27e6 ff1a fs2d fc0 sc0 ls0 ws0">928 <span class="_ _82"> </span>if<span class="_"> </span>(jobid != jp-&gt;jobid) {</div><div class="t m0 x32 h57 y1cc2 ff1a fs2d fc0 sc0 ls0 ws0">929 <span class="_ _1e7"> </span>/*</div><div class="t m0 x32 h57 y1cc3 ff1a fs2d fc0 sc0 ls0 ws0">930 <span class="_ _ce"> </span>*<span class="_"> </span>Different jobs.<span class="_ _d9"> </span>Ignore it.</div><div class="t m0 x32 h57 y1cc4 ff1a fs2d fc0 sc0 ls0 ws0">931 <span class="_ _ce"> </span>*/</div><div class="t m0 x32 h57 y1cc5 ff1a fs2d fc0 sc0 ls0 ws0">932 <span class="_ _1e7"> </span>log_msg(&quot;jobid<span class="_"> </span>%d status code %d&quot;, jobid, i);</div><div class="t m0 x32 h57 y2016 ff1a fs2d fc0 sc0 ls0 ws0">933 <span class="_ _1e7"> </span>break;</div><div class="t m0 x32 h57 y2017 ff1a fs2d fc0 sc0 ls0 ws0">934 <span class="_ _82"> </span>}</div><div class="t m0 x32 h57 y4c7c ff1a fs2d fc0 sc0 ls0 ws0">935 <span class="_ _82"> </span>if<span class="_"> </span>(STATCLASS_OK(i))</div><div class="t m0 x32 h57 y2019 ff1a fs2d fc0 sc0 ls0 ws0">936 <span class="_ _1e7"> </span>success<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y201a ff1a fs2d fc0 sc0 ls0 ws0">937 <span class="_ _82"> </span>break;</div><div class="t m0 x32 h57 y201b ff1a fs2d fc0 sc0 ls0 ws0">938 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y201c ff1a fs2d fc0 sc0 ls0 ws0">939 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y3d1 ff1a fs2d fc0 sc0 ls0 ws0">940 <span class="_ _d9"> </span>out:</div><div class="t m0 x32 h57 y1cca ff1a fs2d fc0 sc0 ls0 ws0">941 <span class="_ _15"> </span>free(bp);</div><div class="t m0 x32 h57 y1ccb ff1a fs2d fc0 sc0 ls0 ws0">942 <span class="_ _15"> </span>if<span class="_"> </span>(nr &lt; 0) {</div><div class="t m0 x32 h57 y2315 ff1a fs2d fc0 sc0 ls0 ws0">943 <span class="_ _186"> </span>log_msg(&quot;jobid<span class="_"> </span>%d: error reading printer response: %s&quot;,</div><div class="t m0 x32 h57 y2316 ff1a fs2d fc0 sc0 ls0 ws0">944 <span class="_ _74"> </span>jobid,<span class="_"> </span>strerror(errno));</div><div class="t m0 x32 h57 y458d ff1a fs2d fc0 sc0 ls0 ws0">945 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y2023 ff1a fs2d fc0 sc0 ls0 ws0">946 <span class="_ _15"> </span>return(success);</div><div class="t m0 x32 h57 y2024 ff1a fs2d fc0 sc0 ls0 ws0">947 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h49 y5ae7 ff19 fs26 fc0 sc0 ls0 ws0">[923 <span class="_ _a"></span>– <span class="_ _a"></span>927]<span class="_ _65"> </span><span class="ls164">We <span class="_ _66"> </span>g<span class="_ _9"></span></span>et <span class="_ _9"></span>the <span class="_ _23"></span>status <span class="_ _9"></span>and <span class="_ _9"></span>job <span class="_ _9"></span>ID <span class="_ _9"></span>from <span class="_ _9"></span>the <span class="_ _9"></span>IPP <span class="_ _9"></span>header <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _23"></span>message.<span class="_ _16"> </span>Both <span class="_ _23"></span>ar<span class="_ _0"></span>e</div><div class="t m0 x11a h49 y5ae8 ff19 fs26 fc0 sc0 ls0 ws0">stored <span class="_ _3"></span>as <span class="_ _3"></span>integers <span class="_ _9"></span>in <span class="_ _9"></span>network <span class="_ _3"></span>byte <span class="_ _9"></span>order<span class="_ _6"></span>,<span class="_ _45"> </span>so<span class="_ _47"> </span>w<span class="ls1226">en<span class="_ _8"></span><span class="ls0">eed <span class="_ _9"></span>to <span class="_ _3"></span>convert <span class="_ _9"></span>them <span class="_ _9"></span>to <span class="_ _3"></span>the</span></span></div><div class="t m0 x11a h4d y5ae9 ff19 fs26 fc0 sc0 ls0 ws0">host byte order by calling<span class="_"> </span><span class="ff1a">ntohs<span class="_ _80"> </span></span>and<span class="_"> </span><span class="ff1a">ntohl</span><span class="lsd3">,r<span class="_ _4f"></span><span class="ls0">espectively<span class="_ _6"></span>.</span></span></div><div class="t m0 x32 h49 y5cd4 ff19 fs26 fc0 sc0 ls0 ws0">[928 <span class="_ _a"></span>– <span class="_ _a"></span>939]<span class="_ _65"> </span>If the <span class="_ _2"></span>job <span class="_ _2"></span>IDs <span class="_ _2"></span>don’t <span class="_ _2"></span>match, <span class="_ _2"></span>then this <span class="_ _2"></span>is <span class="_ _2"></span>not <span class="_ _2"></span>our <span class="_ _2"></span>response, so <span class="_ _2"></span>we <span class="_ _2"></span>log <span class="_ _2"></span>a message</div><div class="t m0 x11a h4d y5cd5 ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _9"></span>break <span class="_ _23"></span>out <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>outer<span class="_ _35"> </span><span class="ff1a">while<span class="_ _45"> </span></span>loop. <span class="_ _35"> </span>If<span class="_ _45"> </span>the <span class="_ _9"></span>IPP <span class="_ _23"> </span>status <span class="_ _23"></span>indicates <span class="_ _9"></span>success,</div><div class="t m0 x11a h49 y5cd6 ff19 fs26 fc0 sc0 ls0 ws0">then we save the return value and br<span class="_ _0"></span>eak out of the loop.</div><div class="t m0 x32 h49 y5cd7 ff19 fs26 fc0 sc0 ls0 ws0">[940 <span class="_ _a"></span>– <span class="_ _a"></span>947]<span class="_ _65"> </span>Before<span class="_ _47"> </span>we<span class="_ _45"> </span>r<span class="_ _0"></span>eturn, <span class="_ _3"></span>we <span class="_ _9"></span>free <span class="_ _3"></span>the <span class="_ _3"></span>buffer <span class="_ _3"></span>we <span class="_ _9"></span>used <span class="_ _9"></span>to <span class="_ _3"></span>hold <span class="_ _9"></span>the <span class="_ _3"></span>response <span class="_ _3"></span>message.</div><div class="t m0 x11a h49 y5cd8 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _53"> </span>r<span class="_ _3"></span><span class="ls0">eturn 1 if the print request was successful and 0 if it failed.</span></div><div class="t m0 x3f h49 y5cd9 ff19 fs26 fc0 sc0 ls0 ws0">This <span class="_ _9"></span>concludes <span class="_ _3"></span>our <span class="_ _9"></span>look <span class="_ _9"></span>at <span class="_ _9"></span>the <span class="_ _9"></span>extended <span class="_ _3"></span>example <span class="_ _9"></span>in <span class="_ _9"></span>this <span class="_ _9"></span>chapter<span class="_ _6"></span><span class="ls17e0">.T<span class="_ _1d"></span><span class="ls0">he <span class="_ _3"></span>programs <span class="_ _9"></span>in</span></span></div><div class="t m0 x32 h49 y5cda ff19 fs26 fc0 sc0 ls0 ws0">this <span class="_ _3"></span>chapter <span class="_ _9"></span>wer<span class="ls93b">et<span class="_ _b"></span><span class="ls0">ested <span class="_ _9"></span>with <span class="_ _9"></span>a <span class="_ _3"></span>Xerox <span class="_ _3"></span>Phaser <span class="_ _9"></span>8560 <span class="_ _9"></span>network-attached <span class="_ _9"></span>PostScript <span class="_ _3"></span>printer<span class="_ _1"></span>.</span></span></div><div class="t m0 x32 h49 y5cdb ff19 fs26 fc0 sc0 ls0 ws0">Unfortunately<span class="_ _4"></span><span class="ls17e1">,t<span class="_ _62"></span><span class="ls0">his <span class="_ _45"> </span>printer <span class="_ _45"> </span>doesn’t <span class="_ _45"> </span>disable <span class="_ _35"> </span>its <span class="_ _45"> </span>autosense <span class="_ _45"> </span>featur<span class="ls17e1">ew<span class="_ _26"></span><span class="ls0">hen <span class="_ _45"> </span>we <span class="_ _45"> </span>set <span class="_ _45"> </span>the</span></span></span></span></div><div class="t m0 x32 h4d y5cdc ff19 fs26 fc0 sc0 ls0 ws0">document <span class="_ _3"></span>format <span class="_ _3"></span>to<span class="_ _47"> </span><span class="ff1a">text/plain</span><span class="ls17e2">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _3"></span>led <span class="_ _3"></span>us <span class="_ _3"></span>to <span class="_ _3"></span>use <span class="_ _3"></span>a <span class="_ _3"></span>hack <span class="_ _3"></span>to <span class="_ _3"></span>trick <span class="_ _3"></span>the <span class="_ _3"></span>printer <span class="_ _3"></span>so <span class="_ _3"></span>that</span></span></div><div class="t m0 x32 h49 y5cdd ff19 fs26 fc0 sc0 ls0 ws0">it <span class="_ _42"> </span>wouldn’t <span class="_ _42"> </span>autosense <span class="_ _23"> </span>the <span class="_ _42"> </span>document <span class="_ _42"> </span>format <span class="_ _42"> </span>when <span class="_ _42"> </span>we <span class="_ _42"> </span>wanted <span class="_ _42"> </span>to <span class="_ _42"> </span>treat <span class="_ _23"> </span>a <span class="_ _42"> </span>document <span class="_ _42"> </span>as</div><div class="t m0 x32 h49 y5cde ff19 fs26 fc0 sc0 ls0 ws0">plaintext. <span class="_ _45"> </span>An<span class="_ _35"> </span>alternative <span class="_ _23"></span>is <span class="_ _23"></span>to <span class="_ _23"></span>print <span class="_ _9"></span>the <span class="_ _23"> </span>source <span class="_ _23"></span>to <span class="_ _9"></span>a <span class="_ _23"> </span>PostScript <span class="_ _23"> </span>program <span class="_ _9"></span>using <span class="_ _23"> </span>a <span class="_ _23"> </span>utility</div><div class="t m0 x32 h4d y5cdf ff19 fs26 fc0 sc0 ls0 ws0">such as<span class="_"> </span><span class="ff1a">a2ps</span></div><div class="t m0 x1b0 h49 y5ce0 ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x159 h49 y5cdf ff19 fs26 fc0 sc0 ls0 ws0">1</div><div class="t m0 xb0 h49 y5ce0 ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 xb1 h49 y5cdf ff19 fs26 fc0 sc0 lsd3 ws0">,w<span class="_ _d"></span><span class="ls0">hich encapsulates the PostScript program befor<span class="lsd3">ep<span class="_ _4f"></span><span class="ls0">rinting.</span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
