<div id="pf2a7" class="pf w4 h1f" data-page-no="2a7"><div class="pc pc2a7 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2a7.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.4<span class="_ _284"> </span>Passing <span class="_"> </span>File <span class="_"> </span>Descriptors<span class="_ _1fb"> </span><span class="ff18">645</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 lsbc ws0">Tw<span class="_ _9"></span><span class="ls12c9">oe<span class="_ _62"></span><span class="ls0">lements <span class="_ _45"> </span>deal <span class="_ _47"> </span>with <span class="_ _45"> </span>the <span class="_ _47"> </span>passing <span class="_ _45"> </span>or <span class="_ _47"> </span>receiving <span class="_ _47"> </span>of <span class="_ _47"> </span>control <span class="_ _47"> </span>information.<span class="_ _1a3"> </span>The</span></span></div><div class="t m0 x32 h26 y130 ff1a fsf fc0 sc0 ls0 ws0">msg_control<span class="_ _35"> </span><span class="ff19">ﬁeld <span class="_ _23"> </span>points <span class="_ _42"> </span>to <span class="_ _23"></span>a<span class="_ _35"> </span></span>cmsghdr<span class="_ _35"> </span><span class="ff19">(control <span class="_ _23"></span>message <span class="_ _23"> </span>header) <span class="_ _42"> </span>structur<span class="_ _0"></span>e, <span class="_ _23"> </span>and <span class="_ _23"> </span>the</span></div><div class="t m0 x32 h26 y131 ff1a fsf fc0 sc0 ls0 ws0">msg_controllen<span class="_ _80"> </span><span class="ff19">ﬁeld contains the number of bytes of control information.</span></div><div class="t m0 x3f h57 y4c55 ff1a fs2d fc0 sc0 ls0 ws0">struct cmsghdr {</div><div class="t m0 xc2 h57 y4c56 ff1a fs2d fc0 sc0 ls0 ws0">socklen_t <span class="_"> </span>cmsg_len;<span class="_ _15"> </span>/* data byte count, including header */</div><div class="t m0 xc2 h57 y4c57 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _b7"> </span>cmsg_level;<span class="_ _3a"> </span>/* originating protocol */</div><div class="t m0 xc2 h57 y4c58 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _b7"> </span>cmsg_type;<span class="_ _87"> </span>/* protocol-specific type */</div><div class="t m0 xc2 h57 y4c59 ff1a fs2d fc0 sc0 ls0 ws0">/* followed by the actual control message data */</div><div class="t m0 x3f h57 y4c5a ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x3f h26 y4c5b ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _45"> </span>s<span class="_ _9"></span><span class="ls0">end <span class="_ _23"> </span>a <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>descriptor<span class="_ _6"></span>,<span class="_ _35"> </span>we<span class="_ _44"> </span>set<span class="_ _35"> </span><span class="ff1a">cmsg_len<span class="_ _35"> </span></span>to <span class="_ _42"> </span>the <span class="_ _42"> </span>size <span class="_ _23"> </span>of <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">cmsghdr<span class="_ _35"> </span></span>structure,</span></div><div class="t m0 x32 h26 y4c5c ff19 fsf fc0 sc0 ls0 ws0">plus <span class="_ _59"> </span>the <span class="_ _4b"> </span>size <span class="_ _59"> </span>of <span class="_ _59"> </span>an <span class="_ _59"> </span>integer <span class="_ _59"> </span>(the <span class="_ _4b"> </span>descriptor).<span class="_ _5e"> </span>The<span class="_ _65"> </span><span class="ff1a">cmsg_level<span class="_ _60"> </span></span>ﬁeld <span class="_ _4b"> </span>is <span class="_ _59"> </span>set <span class="_ _59"> </span>to</div><div class="t m0 x32 h26 y4c5d ff1a fsf fc0 sc0 ls0 ws0">SOL_SOCKET<span class="ff19 ls13da">,a<span class="_ _43"></span><span class="ls0">nd<span class="_ _35"> </span><span class="ff1a">cmsg_type<span class="_ _35"> </span></span>is <span class="_ _23"></span>set <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">SCM_RIGHTS</span>,<span class="_ _35"> </span>to<span class="_ _35"> </span>indicate <span class="_ _23"></span>that <span class="_ _23"></span>we <span class="_ _23"></span>ar<span class="_ _0"></span><span class="ls13db">ep<span class="_ _43"></span><span class="ls0">assing</span></span></span></span></div><div class="t m0 x32 h26 y4c5e ff19 fsf fc0 sc0 ls0 ws0">access <span class="_ _9"></span>rights.<span class="_ _51"> </span>(<span class="ff1a">SCM<span class="_ _45"> </span></span>stands <span class="_ _23"></span>for<span class="_ _45"> </span><span class="ff1b">socket-level <span class="_ _23"></span>control <span class="_ _9"></span>message</span>.) <span class="_ _45"> </span>Access<span class="_ _35"> </span>rights <span class="_ _9"></span>can <span class="_ _23"></span>be <span class="_ _9"></span>passed</div><div class="t m0 x32 h26 y4c5f ff19 fsf fc0 sc0 ls0 ws0">only <span class="_ _2"></span>across <span class="_ _3"></span>a <span class="_ _2"></span>UNIX <span class="_ _3"></span>domain <span class="_ _3"></span>socket.<span class="_ _16"> </span>The <span class="_ _2"></span>descriptor <span class="_ _3"></span>is <span class="_ _3"></span>stored <span class="_ _2"></span>right <span class="_ _3"></span>after <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">cmsg_type</span></div><div class="t m0 x32 h26 y4c60 ff19 fsf fc0 sc0 ls0 ws0">ﬁeld, using the macro<span class="_"> </span><span class="ff1a">CMSG_DATA<span class="_ _80"> </span></span>to obtain the pointer to this integer<span class="_ _6"></span>.</div><div class="t m0 x3f h2a y4c61 ff19 fsf fc0 sc0 ls0 ws0">Three <span class="_ _23"> </span>macros <span class="_ _42"> </span>ar<span class="ls13dc">eu<span class="_ _c"></span><span class="ls0">sed <span class="_ _42"> </span>to <span class="_ _42"> </span>access <span class="_ _42"> </span>the <span class="_ _42"> </span>control <span class="_ _23"> </span>data, <span class="_ _42"> </span>and <span class="_ _42"> </span>one <span class="_ _42"> </span>macro<span class="_ _35"> </span>is<span class="_ _44"> </span>used <span class="_ _42"> </span>to <span class="_ _42"> </span>help</span></span></div><div class="t m0 x32 h26 y4c62 ff19 fsf fc0 sc0 ls0 ws0">calculate the value to be used for<span class="_"> </span><span class="ff1a">cmsg_len</span>.</div><div class="t m0 x3f h57 y4c63 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x3f h57 y4c64 ff1a fs2d fc0 sc0 ls0 ws0">unsigned char *CMSG_DATA(struct cmsghdr *<span class="ff1b">cp</span>);</div><div class="t m0 x11b h57 y4c65 ff19 fs2d fc0 sc0 ls0 ws0">Returns: pointer to data associated with<span class="_"> </span><span class="ff1a">cmsghdr<span class="_ _e"> </span></span>structure</div><div class="t m0 x3f h57 y4c66 ff1a fs2d fc0 sc0 ls0 ws0">struct cmsghdr *CMSG_FIRSTHDR(struct msghdr *<span class="ff1b">mp</span>);</div><div class="t m0 xe0 h57 y4c67 ff19 fs2d fc0 sc0 ls0 ws0">Returns: pointer to ﬁrst<span class="_"> </span><span class="ff1a">cmsghdr<span class="_ _e"> </span></span>structur<span class="ls110">ea<span class="_ _5"></span><span class="ls0">ssociated</span></span></div><div class="t m0 xc5 h57 y4c68 ff19 fs2d fc0 sc0 ls0 ws0">with the<span class="_"> </span><span class="ff1a">msghdr<span class="_ _e"> </span></span>structure, or<span class="_"> </span><span class="ff1a">NULL<span class="_ _e"> </span></span>if none exists</div><div class="t m0 x3f h57 y4c69 ff1a fs2d fc0 sc0 ls0 ws0">struct cmsghdr *CMSG_NXTHDR(struct msghdr *<span class="ff1b">mp</span>,</div><div class="t m0 x10f h57 y4c6a ff1a fs2d fc0 sc0 ls0 ws0">struct cmsghdr *<span class="ff1b">cp</span>);</div><div class="t m0 x11b h57 y4c6b ff19 fs2d fc0 sc0 ls0 ws0">Returns: pointer to next<span class="_"> </span><span class="ff1a">cmsghdr<span class="_ _e"> </span></span>structur<span class="ls110">ea<span class="_ _5"></span><span class="ls0">ssociated with</span></span></div><div class="t m0 x6c h57 y4c6c ff19 fs2d fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">msghdr<span class="_ _e"> </span></span>structur<span class="ls110">eg<span class="_ _5"></span><span class="ls0">iven the current<span class="_"> </span><span class="ff1a">cmsghdr</span></span></span></div><div class="t m0 x78 h57 y4c6d ff19 fs2d fc0 sc0 ls0 ws0">structure, or<span class="_"> </span><span class="ff1a">NULL<span class="_ _53"> </span></span>if we’re<span class="_"> </span>at<span class="_"> </span>the last one</div><div class="t m0 x3f h57 y4c6e ff1a fs2d fc0 sc0 ls0 ws0">unsigned int CMSG_LEN(unsigned int<span class="_"> </span><span class="ff1b">nbytes</span>);</div><div class="t m0 x1f2 h58 y4c6f ff19 fs2d fc0 sc0 ls0 ws0">Returns: size to allocate for data object<span class="_"> </span><span class="ff1b">nbytes<span class="_"> </span></span>large</div><div class="t m0 x76 h5e y4c70 ff19 fs10 fc0 sc0 ls0 ws0">The Single UNIX Speciﬁcation deﬁnes the ﬁrst three macr<span class="_ _0"></span>os, but omits<span class="_"> </span><span class="ff1a">CMSG_LEN</span>.</div><div class="t m0 x32 h4d y4c71 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _47"> </span><span class="ff1a">CMSG_LEN<span class="_ _47"> </span></span>macr<span class="ls13dd">or<span class="_ _b"></span><span class="ls0">eturns <span class="_ _3"></span>the <span class="_ _9"></span>number <span class="_ _3"></span>of <span class="_ _3"></span>bytes <span class="_ _3"></span>needed <span class="_ _3"></span>to <span class="_ _9"></span>stor<span class="ls13de">ead<span class="_ _b"></span><span class="ls0">ata <span class="_ _3"></span>object <span class="_ _3"></span>of <span class="_ _9"></span>size</span></span></span></span></div><div class="t m0 x32 h4d y4c72 ff1b fs26 fc0 sc0 ls0 ws0">nbytes<span class="ff19 ls13df">,a<span class="_ _4a"></span><span class="ls0">fter <span class="_"> </span>adding <span class="_ _e"> </span>the <span class="_"> </span>size <span class="_ _53"> </span>of <span class="_"> </span>the<span class="_ _4b"> </span><span class="ff1a">cmsghdr<span class="_ _59"> </span></span>structure, <span class="_ _53"> </span>adjusting <span class="_"> </span>for <span class="_ _e"> </span>any <span class="_ _e"> </span>alignment</span></span></div><div class="t m0 x32 h49 y4c73 ff19 fs26 fc0 sc0 ls0 ws0">constraints requir<span class="_ _0"></span>ed by the pr<span class="_ _0"></span>ocessor architectur<span class="_ _0"></span>e, and rounding up.</div><div class="t m0 x3f h4d y4c74 ff19 fs26 fc0 sc0 ls0 ws0">The program in <span class="_ _2"></span>Figur<span class="lse05">e1<span class="_ _4f"></span><span class="ls0">7.13 is <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">send_fd<span class="_ _47"> </span></span>function, which passes <span class="_ _2"></span>a <span class="_ _2"></span>ﬁle descriptor</span></span></div><div class="t m0 x32 h4d y4c75 ff19 fs26 fc0 sc0 ls0 ws0">over <span class="_ _3"></span>a <span class="_ _9"></span>UNIX <span class="_ _3"></span>domain <span class="_ _9"></span>socket.<span class="_ _16"> </span>In <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">sendmsg<span class="_ _47"> </span></span>call, <span class="_ _3"></span>we <span class="_ _9"></span>send <span class="_ _9"></span>both <span class="_ _3"></span>the <span class="_ _9"></span>protocol <span class="_ _3"></span>data <span class="_ _3"></span>(the</div><div class="t m0 x32 h49 y4c76 ff19 fs26 fc0 sc0 ls0 ws0">null and the status byte) and the descriptor<span class="_ _6"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
