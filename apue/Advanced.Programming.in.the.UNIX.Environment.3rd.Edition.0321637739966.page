<div id="pf3c6" class="pf w4 h1f" data-page-no="3c6"><div class="pc pc3c6 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg3c6.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">932<span class="_ _1b"> </span><span class="ff19">Solutions <span class="_"> </span>to <span class="_"> </span>Selected <span class="_"> </span>Exercises <span class="_ _2eb"> </span>Appendix<span class="_ _4b"> </span>C</span></div><div class="t m0 x1b h57 y425 ff1a fs2d fc0 sc0 ls15c ws0">&quot;w<span class="_ _1d"></span><span class="ls0">rite lock is pending\n&quot;);</span></div><div class="t m0 x60 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;killing child 1...\n&quot;);</div><div class="t m0 x60 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">kill(pid1, SIGINT);</div><div class="t m0 x60 h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;killing child 2...\n&quot;);</div><div class="t m0 x60 h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">kill(pid2, SIGINT);</div><div class="t m0 x60 h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;killing child 3...\n&quot;);</div><div class="t m0 x60 h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">kill(pid3, SIGINT);</div><div class="t m0 x60 h57 y805 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 xe2 h57 y806 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x13c h2d y61e5 ff18 fs10 fc0 sc0 ls0 ws0">Figure C.15<span class="_ _5a"> </span><span class="ff19">Determine record</span></div><div class="t m0 x1d9 h2d y61e6 ff19 fs10 fc0 sc0 ls0 ws0">-</div><div class="t m0 x203 h2d y61e5 ff19 fs10 fc0 sc0 ls0 ws0">locking behavior</div><div class="t m0 xe2 h49 y61e7 ff19 fs26 fc0 sc0 ls0 ws0">On <span class="_ _53"> </span>FreeBSD <span class="_ _53"> </span>8.0, <span class="_ _53"> </span>Linux <span class="_ _53"> </span>3.2.0, <span class="_ _e"> </span>and <span class="_ _53"> </span>Mac <span class="_ _53"> </span>OS <span class="_ _e"> </span>X <span class="_ _53"> </span>10.6.8, <span class="_ _e"> </span>the <span class="_ _53"> </span>behavior <span class="_ _53"> </span>is <span class="_ _e"> </span>the <span class="_ _53"> </span>same:</div><div class="t m0 xe2 h49 y61e8 ff19 fs26 fc0 sc0 ls0 ws0">additional readers can starve pending writers.<span class="_ _59"> </span>Running the program gives us</div><div class="t m0 x79 h4e y61e9 ff1a fs28 fc0 sc0 ls0 ws0">child 1: obtained read lock on file</div><div class="t m0 x79 h4e y61ea ff1a fs28 fc0 sc0 ls0 ws0">child 2: obtained read lock on file</div><div class="t m0 x79 h4e y61eb ff1a fs28 fc0 sc0 ls0 ws0">child 3: can’t set write lock: Resource temporarily unavailable</div><div class="t m0 x79 h4e y61ec ff1a fs28 fc0 sc0 ls0 ws0">child 3 about to block in write-lock...</div><div class="t m0 x79 h4e y61ed ff1a fs28 fc0 sc0 ls0 ws0">parent: obtained additional read lock while write lock is pending</div><div class="t m0 x79 h4e y61ee ff1a fs28 fc0 sc0 ls0 ws0">killing child 1...</div><div class="t m0 x79 h4e y61ef ff1a fs28 fc0 sc0 ls0 ws0">child 1: exit after pause</div><div class="t m0 x79 h4e y61f0 ff1a fs28 fc0 sc0 ls0 ws0">killing child 2...</div><div class="t m0 x79 h4e y61f1 ff1a fs28 fc0 sc0 ls0 ws0">child 2: exit after pause</div><div class="t m0 x79 h4e y61f2 ff1a fs28 fc0 sc0 ls0 ws0">killing child 3...</div><div class="t m0 x79 h4e y61f3 ff1a fs28 fc0 sc0 ls0 ws0">child 3: can’t write-lock file: Interrupted system call</div><div class="t m0 xe2 h49 y61f4 ff19 fs26 fc0 sc0 ls0 ws0">On <span class="_ _42"> </span>Solaris <span class="_ _53"> </span>10, <span class="_ _42"> </span>readers <span class="_ _42"> </span>don’t <span class="_ _42"> </span>starve <span class="_ _53"> </span>waiting <span class="_ _42"> </span>writers.<span class="_ _65"> </span>In <span class="_ _42"> </span>this <span class="_ _53"> </span>case, <span class="_ _42"> </span>the <span class="_ _53"> </span>parent <span class="_ _42"> </span>is</div><div class="t m0 xe2 h49 y61f5 ff19 fs26 fc0 sc0 ls0 ws0">unable to obtain a read lock because ther<span class="_ _0"></span>e<span class="_"> </span>is<span class="_"> </span>a<span class="_"> </span>p<span class="lscc">ro</span>cess waiting for a write lock.</div><div class="t m0 x32 h4d y61f6 ff18 fs26 fc0 sc0 ls0 ws0">14.2<span class="_ _210"> </span><span class="ff19">Most <span class="_ _2"></span>systems deﬁne the<span class="_ _66"> </span><span class="ff1a">fd_set<span class="_ _66"> </span></span>data type to <span class="_ _2"></span>be a structur<span class="ls185e">et<span class="_ _4f"></span><span class="ls0">hat <span class="_ _2"></span>contains a single</span></span></span></div><div class="t m0 xe2 h49 y61f7 ff19 fs26 fc0 sc0 ls0 ws0">member: <span class="_ _42"> </span>an <span class="_ _53"> </span>array <span class="_ _53"> </span>of <span class="_ _53"> </span>long <span class="_ _53"> </span>integers.<span class="_ _54"> </span>One <span class="_ _53"> </span>bit <span class="_ _53"> </span>in <span class="_ _53"> </span>this <span class="_ _53"> </span>array <span class="_ _42"> </span>corresponds <span class="_ _53"> </span>to <span class="_ _42"> </span>each</div><div class="t m0 xe2 h4d y61f8 ff19 fs26 fc0 sc0 ls0 ws0">descriptor<span class="_ _6"></span><span class="ls185f">.T<span class="_ _52"></span><span class="ls0">he <span class="_ _53"> </span>four<span class="_ _44"> </span><span class="ff1a">FD_<span class="_ _44"> </span></span>macros <span class="_ _42"> </span>then <span class="_ _53"> </span>manipulate <span class="_ _42"> </span>this <span class="_ _53"> </span>array <span class="_ _42"> </span>of <span class="_ _53"> </span>longs, <span class="_ _42"> </span>turning</span></span></div><div class="t m0 xe2 h49 y61f9 ff19 fs26 fc0 sc0 ls0 ws0">speciﬁc bits on and of<span class="lsd3">fa<span class="_ _4f"></span><span class="ls0">nd testing speciﬁc bits.</span></span></div><div class="t m0 xe2 h49 y61fa ff19 fs26 fc0 sc0 ls0 ws0">One reason that the data <span class="_ _2"></span>type is deﬁned <span class="_ _2"></span>to be a <span class="_ _2"></span>structur<span class="_ _0"></span><span class="ls8f3">ec<span class="_ _d"></span><span class="ls0">ontaining an array <span class="_ _2"></span>and</span></span></div><div class="t m0 xe2 h4d y61fb ff19 fs26 fc0 sc0 ls0 ws0">not <span class="_ _9"></span>simply <span class="_ _23"></span>an <span class="_ _9"></span>array <span class="_ _23"></span>is <span class="_ _9"></span>to <span class="_ _23"></span>allow <span class="_ _9"></span>variables <span class="_ _23"></span>of <span class="_ _9"></span>type<span class="_ _35"> </span><span class="ff1a">fd_set<span class="_ _45"> </span></span>to <span class="_ _9"></span>be <span class="_ _23"></span>assigned <span class="_ _9"></span>to <span class="_ _23"></span>one</div><div class="t m0 xe2 h49 y61fc ff19 fs26 fc0 sc0 ls0 ws0">another with the C assignment statement.</div><div class="t m0 x32 h49 y61fd ff18 fs26 fc0 sc0 ls0 ws0">14.3<span class="_ _210"> </span><span class="ff19">In <span class="_ _46"> </span>the <span class="_ _59"> </span>good <span class="_ _46"> </span>ol’ <span class="_ _59"> </span>days, <span class="_ _46"> </span>most <span class="_ _59"> </span>systems <span class="_ _46"> </span>allowed <span class="_ _59"> </span>us <span class="_ _46"> </span>to <span class="_ _59"> </span>deﬁne <span class="_ _46"> </span>the <span class="_ _59"> </span>constant</span></div><div class="t m0 xe2 h4d y61fe ff1a fs26 fc0 sc0 ls0 ws0">FD_SETSIZE<span class="_ _45"> </span><span class="ff19">befor<span class="ls10e5">ei<span class="_ _b"></span><span class="ls0">ncluding <span class="_ _9"></span>the <span class="_ _9"></span>header<span class="_ _45"> </span><span class="ff1a">&lt;sys/select.h&gt;</span><span class="ls1860">.F<span class="_ _62"></span><span class="ls0">or <span class="_ _9"></span>example, <span class="_ _23"></span>we</span></span></span></span></span></div><div class="t m0 xe2 h49 y61ff ff19 fs26 fc0 sc0 ls0 ws0">could write</div><div class="t m0 xd8 h4e y6200 ff1a fs28 fc0 sc0 ls0 ws0">#define FD_SETSIZE<span class="_ _d9"> </span>2048</div><div class="t m0 xd8 h4e y6201 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/select.h&gt;</div><div class="t m0 xe2 h4d y6202 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _60"> </span>deﬁne <span class="_ _60"> </span>the<span class="_ _7f"> </span><span class="ff1a">fd_set<span class="_ _5e"> </span></span>data <span class="_ _60"> </span>type <span class="_ _60"> </span>to <span class="_ _48"> </span>accommodate <span class="_ _60"> </span>2,048 <span class="_ _60"> </span>descriptors.</div><div class="t m0 xe2 h49 y6203 ff19 fs26 fc0 sc0 ls0 ws0">Unfortunately<span class="_ _4"></span><span class="ls1861">,t<span class="_ _c"></span><span class="ls0">hings <span class="_ _53"> </span>aren’t <span class="_ _53"> </span>that <span class="_ _e"> </span>simple <span class="_ _e"> </span>anymore. <span class="_ _4b"> </span>T<span class="_ _6"></span><span class="ls1861">ou<span class="_ _55"></span><span class="ls0">se <span class="_ _e"> </span>this <span class="_ _53"> </span>technique <span class="_ _e"> </span>with</span></span></span></span></div><div class="t m0 xe2 h49 y6204 ff19 fs26 fc0 sc0 ls0 ws0">contemporary systems, we need to do several things:</div><div class="t m0 xe2 h49 y6205 ff19 fs26 fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>Before<span class="_ _59"> </span>we<span class="_ _61"> </span>include <span class="_"> </span>any <span class="_"> </span>header <span class="_ _66"> </span>ﬁles, <span class="_ _66"> </span>we <span class="_ _66"> </span>need <span class="_"> </span>to <span class="_ _66"> </span>deﬁne <span class="_ _66"> </span>whatever <span class="_ _66"> </span>symbol</div><div class="t m0 x7c h4d y6206 ff19 fs26 fc0 sc0 ls0 ws0">prevents <span class="_ _2"></span>us <span class="_ _3"></span>from <span class="_ _3"></span>including<span class="_ _47"> </span><span class="ff1a">&lt;sys/select.h&gt;</span><span class="ls1862">.S<span class="_ _1d"></span><span class="ls0">ome <span class="_ _3"></span>systems <span class="_ _3"></span>might <span class="_ _9"></span>protect</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
