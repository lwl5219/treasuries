<div id="pf261" class="pf w4 h1f" data-page-no="261"><div class="pc pc261 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg261.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>15.9<span class="_ _24c"> </span>Shar<span class="_ _0"></span>ed <span class="_"> </span>Memory<span class="_ _1b"> </span><span class="ff18">575</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/shm.h&gt;</div><div class="t m0 x32 h57 y1d78 ff1a fs2d fc0 sc0 ls0 ws0">#define ARRAY_SIZE<span class="_ _d9"> </span>40000</div><div class="t m0 x32 h57 y1d79 ff1a fs2d fc0 sc0 ls0 ws0">#define MALLOC_SIZE 100000</div><div class="t m0 x32 h57 y1d7a ff1a fs2d fc0 sc0 ls0 ws0">#define SHM_SIZE<span class="_ _15"> </span>100000</div><div class="t m0 x32 h57 y1d7b ff1a fs2d fc0 sc0 ls0 ws0">#define SHM_MODE<span class="_ _15"> </span>0600 <span class="_ _68"> </span>/*<span class="_"> </span>user read/write */</div><div class="t m0 x32 h57 y3c6 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>array[ARRAY_SIZE];<span class="_ _3a"> </span>/* uninitialized data = bss */</div><div class="t m0 x32 h57 y1cc4 ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y1cc5 ff1a fs2d fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h57 y2016 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y2017 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>shmid;</div><div class="t m0 x8a h57 y2018 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>*ptr,<span class="_"> </span>*shmptr;</div><div class="t m0 x8a h57 y1cc8 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;array[] from %p to %p\n&quot;, (void *)&amp;array[0],</div><div class="t m0 x194 h57 y4588 ff1a fs2d fc0 sc0 ls0 ws0">(void *)&amp;array[ARRAY_SIZE]);</div><div class="t m0 x8a h57 y4589 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;stack around %p\n&quot;, (void *)&amp;shmid);</div><div class="t m0 x8a h57 y458a ff1a fs2d fc0 sc0 ls0 ws0">if ((ptr = malloc(MALLOC_SIZE)) == NULL)</div><div class="t m0 x9d h57 y458b ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;malloc error&quot;);</div><div class="t m0 x8a h57 y458c ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;malloced from %p to %p\n&quot;, (void *)ptr,</div><div class="t m0 x194 h57 y2ada ff1a fs2d fc0 sc0 ls0 ws0">(void *)ptr+MALLOC_SIZE);</div><div class="t m0 x8a h57 y2316 ff1a fs2d fc0 sc0 ls0 ws0">if ((shmid = shmget(IPC_PRIVATE, SHM_SIZE, SHM_MODE)) &lt; 0)</div><div class="t m0 x9d h57 y458d ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;shmget error&quot;);</div><div class="t m0 x8a h57 y2023 ff1a fs2d fc0 sc0 ls0 ws0">if ((shmptr = shmat(shmid, 0, 0)) == (void *)-1)</div><div class="t m0 x9d h57 y2024 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;shmat error&quot;);</div><div class="t m0 x8a h57 y2adf ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;shared memory attached from %p to %p\n&quot;, (void *)shmptr,</div><div class="t m0 x194 h57 y458e ff1a fs2d fc0 sc0 ls0 ws0">(void *)shmptr+SHM_SIZE);</div><div class="t m0 x8a h57 y1cd3 ff1a fs2d fc0 sc0 ls0 ws0">if (shmctl(shmid, IPC_RMID, 0) &lt; 0)</div><div class="t m0 x9d h57 y1cd4 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;shmctl error&quot;);</div><div class="t m0 x8a h57 y1cd5 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y1cd6 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x161 h2d y458f ff18 fs10 fc0 sc0 ls0 ws0">Figure 15.31<span class="_ _5a"> </span><span class="ff19">Print wher<span class="ls136">ev<span class="_ _84"></span><span class="ls0">arious types of data ar<span class="ls136">es<span class="_ _5"></span><span class="ls0">tored</span></span></span></span></span></div><div class="t m0 x32 h49 y4590 ff19 fs26 fc0 sc0 ls0 ws0">Running <span class="_"> </span>this <span class="_"> </span>pr<span class="_ _0"></span>ogram <span class="_"> </span>on <span class="_"> </span>a <span class="_"> </span>64</div><div class="t m0 x4b h49 y4591 ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x1f6 h49 y4590 ff19 fs26 fc0 sc0 ls0 ws0">bit <span class="_"> </span>Intel-based <span class="_"> </span>Linux <span class="_"> </span>system <span class="_ _e"> </span>gives <span class="_"> </span>us <span class="_"> </span>the <span class="_"> </span>following</div><div class="t m0 x32 h49 y4592 ff19 fs26 fc0 sc0 ls0 ws0">output:</div><div class="t m0 x3f h4e y4593 ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h4e y4594 ff1a fs28 fc0 sc0 ls0 ws0">array[] from 0x6020c0 to 0x60bd00</div><div class="t m0 x3f h4e y4595 ff1a fs28 fc0 sc0 ls0 ws0">stack around 0x7fff957b146c</div><div class="t m0 x3f h4e y4596 ff1a fs28 fc0 sc0 ls0 ws0">malloced from 0x9e3010 to 0x9fb6b0</div><div class="t m0 x3f h4e y4597 ff1a fs28 fc0 sc0 ls0 ws0">shared memory attached from 0x7fba578ab000 to 0x7fba578c36a0</div><div class="t m0 x32 h49 y4598 ff19 fs26 fc0 sc0 ls0 ws0">Figur<span class="ls127b">e1<span class="_ _55"></span><span class="ls0">5.32 <span class="_ _53"> </span>shows <span class="_ _53"> </span>a <span class="_ _53"> </span>pictur<span class="ls127b">eo<span class="_ _c"></span><span class="ls127c">ft<span class="_ _c"></span><span class="ls0">his, <span class="_ _53"> </span>similar <span class="_ _42"> </span>to <span class="_ _53"> </span>what <span class="_ _53"> </span>we <span class="_ _53"> </span>said <span class="_ _42"> </span>was <span class="_ _53"> </span>a <span class="_ _53"> </span>typical <span class="_ _53"> </span>memory</span></span></span></span></span></div><div class="t m0 x32 h49 y4599 ff19 fs26 fc0 sc0 ls0 ws0">layout <span class="_ _23"> </span>in <span class="_ _23"> </span>Figur<span class="ls127d">e7<span class="_ _43"></span><span class="ls0">.6. <span class="_ _35"> </span>Note<span class="_ _35"> </span>that <span class="_ _23"> </span>the <span class="_ _42"> </span>shared <span class="_ _23"></span>memory <span class="_ _23"></span>segment <span class="_ _23"> </span>is <span class="_ _23"> </span>placed <span class="_ _42"> </span>well <span class="_ _23"> </span>below <span class="_ _23"> </span>the</span></span></div><div class="t m0 x32 h49 y459a ff19 fs26 fc0 sc0 ls0 ws0">stack.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
