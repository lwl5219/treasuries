<div id="pfa8" class="pf w4 h1f" data-page-no="a8"><div class="pc pca8 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bga8.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">134<span class="_ _1b"> </span><span class="ff19">Files <span class="_"> </span>and <span class="_"> </span>Directories <span class="_ _18d"> </span>Chapter<span class="_ _4b"> </span>4</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">fullpath[n] = 0;</div><div class="t m0 x8a h57 y1334 ff1a fs2d fc0 sc0 ls0 ws0">if ((dp = opendir(fullpath)) == NULL)<span class="_ _68"> </span>/* can’t read directory */</div><div class="t m0 x9d h57 y1307 ff1a fs2d fc0 sc0 ls0 ws0">return(func(fullpath, &amp;statbuf, FTW_DNR));</div><div class="t m0 x8a h57 y1335 ff1a fs2d fc0 sc0 ls0 ws0">while ((dirp = readdir(dp)) != NULL) {</div><div class="t m0 x9d h57 y1309 ff1a fs2d fc0 sc0 ls0 ws0">if (strcmp(dirp-&gt;d_name, &quot;.&quot;) == 0<span class="_ _d9"> </span>||</div><div class="t m0 x1f h57 y130a ff1a fs2d fc0 sc0 ls0 ws0">strcmp(dirp-&gt;d_name, &quot;..&quot;) == 0)</div><div class="t m0 x126 h57 y130b ff1a fs2d fc0 sc0 ls0 ws0">continue; <span class="_ _189"> </span>/*<span class="_"> </span>ignore dot and dot-dot */</div><div class="t m0 x9d h57 y130c ff1a fs2d fc0 sc0 ls0 ws0">strcpy(&amp;fullpath[n], dirp-&gt;d_name); /* append name after &quot;/&quot; */</div><div class="t m0 x9d h57 y130d ff1a fs2d fc0 sc0 ls0 ws0">if ((ret = dopath(func)) != 0)<span class="_ _189"> </span>/* recursive */</div><div class="t m0 x1f h57 y130e ff1a fs2d fc0 sc0 ls0 ws0">break; <span class="_"> </span>/*<span class="_"> </span>time to leave */</div><div class="t m0 x8a h57 y130f ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y1310 ff1a fs2d fc0 sc0 ls0 ws0">fullpath[n-1] = 0;<span class="_ _d9"> </span>/* erase everything from slash onward */</div><div class="t m0 x8a h57 y1336 ff1a fs2d fc0 sc0 ls0 ws0">if (closedir(dp) &lt; 0)</div><div class="t m0 x9d h57 y1337 ff1a fs2d fc0 sc0 ls0 ws0">err_ret(&quot;can’t close directory %s&quot;, fullpath);</div><div class="t m0 x8a h57 y1338 ff1a fs2d fc0 sc0 ls0 ws0">return(ret);</div><div class="t m0 x32 h57 y1339 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y133a ff1a fs2d fc0 sc0 ls0 ws0">static int</div><div class="t m0 x32 h57 y133b ff1a fs2d fc0 sc0 ls0 ws0">myfunc(const char *pathname, const struct stat *statptr, int type)</div><div class="t m0 x32 h57 y133c ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y133d ff1a fs2d fc0 sc0 ls0 ws0">switch (type) {</div><div class="t m0 x8a h57 y133e ff1a fs2d fc0 sc0 ls0 ws0">case FTW_F:</div><div class="t m0 x9d h57 y133f ff1a fs2d fc0 sc0 ls0 ws0">switch (statptr-&gt;st_mode &amp; S_IFMT) {</div><div class="t m0 x9d h57 y1340 ff1a fs2d fc0 sc0 ls0 ws0">case S_IFREG:<span class="_ _68"> </span>nreg++; <span class="_ _15"> </span>break;</div><div class="t m0 x9d h57 y1341 ff1a fs2d fc0 sc0 ls0 ws0">case S_IFBLK:<span class="_ _68"> </span>nblk++; <span class="_ _15"> </span>break;</div><div class="t m0 x9d h57 y1342 ff1a fs2d fc0 sc0 ls0 ws0">case S_IFCHR:<span class="_ _68"> </span>nchr++; <span class="_ _15"> </span>break;</div><div class="t m0 x9d h57 y1343 ff1a fs2d fc0 sc0 ls0 ws0">case S_IFIFO:<span class="_ _68"> </span>nfifo++; <span class="_ _87"> </span>break;</div><div class="t m0 x9d h57 y1344 ff1a fs2d fc0 sc0 ls0 ws0">case S_IFLNK:<span class="_ _68"> </span>nslink++; <span class="_ _3a"> </span>break;</div><div class="t m0 x9d h57 y1345 ff1a fs2d fc0 sc0 ls0 ws0">case S_IFSOCK:<span class="_ _d9"> </span>nsock++; <span class="_ _87"> </span>break;</div><div class="t m0 x9d h57 y1346 ff1a fs2d fc0 sc0 ls0 ws0">case S_IFDIR:<span class="_ _68"> </span>/* directories should have type = FTW_D */</div><div class="t m0 x1f h57 y1347 ff1a fs2d fc0 sc0 ls0 ws0">err_dump(&quot;for S_IFDIR for %s&quot;, pathname);</div><div class="t m0 x9d h57 y1323 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y1324 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x8a h57 y1325 ff1a fs2d fc0 sc0 ls0 ws0">case FTW_D:</div><div class="t m0 x9d h57 y1326 ff1a fs2d fc0 sc0 ls0 ws0">ndir++;</div><div class="t m0 x9d h57 y1348 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x8a h57 y1349 ff1a fs2d fc0 sc0 ls0 ws0">case FTW_DNR:</div><div class="t m0 x9d h57 y134a ff1a fs2d fc0 sc0 ls0 ws0">err_ret(&quot;can’t read directory %s&quot;, pathname);</div><div class="t m0 x9d h57 y134b ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x8a h57 y134c ff1a fs2d fc0 sc0 ls0 ws0">case FTW_NS:</div><div class="t m0 x9d h57 y134d ff1a fs2d fc0 sc0 ls0 ws0">err_ret(&quot;stat error for %s&quot;, pathname);</div><div class="t m0 x9d h57 y134e ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x8a h57 y134f ff1a fs2d fc0 sc0 ls0 ws0">default:</div><div class="t m0 x9d h57 y1350 ff1a fs2d fc0 sc0 ls0 ws0">err_dump(&quot;unknown type %d for pathname %s&quot;, type, pathname);</div><div class="t m0 x8a h57 y1351 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y1352 ff1a fs2d fc0 sc0 ls0 ws0">return(0);</div><div class="t m0 x32 h57 y1353 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x125 h2d y1354 ff18 fs10 fc0 sc0 ls0 ws0">Figure 4.22<span class="_ _5a"> </span><span class="ff19">Recursively descend a directory hierarchy<span class="_ _4"></span><span class="ls136">,c<span class="_ _84"></span><span class="ls0">ounting ﬁle types</span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
