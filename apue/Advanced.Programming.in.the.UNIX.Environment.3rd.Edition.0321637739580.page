<div id="pf244" class="pf w4 h1f" data-page-no="244"><div class="pc pc244 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg244.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">546<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">Note <span class="_ _66"> </span>that <span class="_ _47"> </span>our<span class="_ _61"> </span><span class="ff1a">open_max<span class="_ _61"> </span></span>function <span class="_ _47"> </span>from <span class="_"> </span>Figur<span class="ls118e">e2<span class="_ _1d"></span><span class="ls0">.17 <span class="_ _47"> </span>can <span class="_ _66"> </span>return <span class="_ _66"> </span>a <span class="_ _47"> </span>guess <span class="_ _66"> </span>of <span class="_ _47"> </span>the</span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">maximum number of open ﬁles if this value is indeterminate for the system.<span class="_ _46"> </span><span class="ls5f">We <span class="_ _53"> </span>n<span class="_ _23"></span></span>eed to</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">be <span class="_ _2"></span>careful <span class="_ _2"></span>not <span class="_ _3"></span>to <span class="_ _2"></span>use <span class="_ _3"></span>a <span class="_ _3"></span>pipe <span class="_ _2"></span>ﬁle <span class="_ _3"></span>descriptor <span class="_ _3"></span>whose <span class="_ _2"></span>value <span class="_ _3"></span>is <span class="_ _2"></span>larger <span class="_ _3"></span>than <span class="_ _2"></span>(or <span class="_ _3"></span>equal <span class="_ _3"></span>to) <span class="_ _2"></span>what</div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">open_max<span class="_ _47"> </span></span>function returns. <span class="_"> </span>In<span class="_ _47"> </span><span class="ff1a">popen</span>,<span class="_"> </span>if<span class="_ _47"> </span>the value <span class="_ _2"></span>returned by<span class="_ _47"> </span><span class="ff1a">open_max<span class="_ _66"> </span></span>happens</div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _3"></span>be <span class="_ _9"></span>too <span class="_ _3"></span>small, <span class="_ _9"></span>we <span class="_ _3"></span>close <span class="_ _9"></span>the <span class="_ _3"></span>pipe <span class="_ _9"></span>ﬁle <span class="_ _3"></span>descriptors, <span class="_ _9"></span>set<span class="_ _45"> </span><span class="ff1a">errno<span class="_ _47"> </span></span>to<span class="_ _45"> </span><span class="ff1a">EMFILE<span class="_ _47"> </span></span>to <span class="_ _3"></span>indicate <span class="_ _9"></span>too</div><div class="t m0 x32 h26 y134 ff19 fsf fc0 sc0 ls0 ws0">many <span class="_ _45"> </span>ﬁle <span class="_ _45"> </span>descriptors <span class="_ _45"> </span>ar<span class="ls118f">eo<span class="_ _26"></span><span class="ls0">pen, <span class="_ _45"> </span>and <span class="_ _45"> </span>return<span class="_ _16"> </span><span class="ff20">−</span>1. <span class="_ _51"> </span>In<span class="_ _16"> </span><span class="ff1a">pclose</span>,<span class="_ _51"> </span>if<span class="_ _16"> </span>the <span class="_ _45"> </span>ﬁle <span class="_ _35"> </span>descriptor</span></span></div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls0 ws0">corresponding <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _53"> </span>ﬁle <span class="_ _53"> </span>pointer <span class="_ _42"> </span>argument <span class="_ _53"> </span>is <span class="_ _42"> </span>larger <span class="_ _42"> </span>than <span class="_ _53"> </span>expected, <span class="_ _53"> </span>we <span class="_ _42"> </span>set<span class="_ _4b"> </span><span class="ff1a">errno<span class="_ _44"> </span></span>to</div><div class="t m0 x32 h26 y136 ff1a fsf fc0 sc0 ls0 ws0">EINVAL<span class="_ _80"> </span><span class="ff19">and return<span class="_"> </span><span class="ff20">−</span>1.</span></div><div class="t m0 x3f h26 y137 ff19 fsf fc0 sc0 ls0 ws0">Calling<span class="_ _45"> </span><span class="ff1a">pipe<span class="_ _35"> </span></span>and<span class="_ _45"> </span><span class="ff1a">fork<span class="_ _45"> </span></span>and <span class="_ _23"> </span>then <span class="_ _23"></span>duplicating <span class="_ _9"></span>the <span class="_ _23"></span>appropriate <span class="_ _9"></span>descriptors <span class="_ _23"></span>for <span class="_ _9"></span>each</div><div class="t m0 x32 h26 y138 ff19 fsf fc0 sc0 ls0 ws0">process in the<span class="_"> </span><span class="ff1a">popen<span class="_ _80"> </span></span>function is similar to what we did earlier in this chapter<span class="_ _6"></span>.</div><div class="t m0 x3f h26 y139 ff19 fsf fc0 sc0 ls0 ws0">POSIX.1 <span class="_ _3"></span>requires <span class="_ _2"></span>that<span class="_ _45"> </span><span class="ff1a">popen<span class="_ _47"> </span></span>close <span class="_ _9"></span>any <span class="_ _3"></span>streams <span class="_ _3"></span>that <span class="_ _3"></span>ar<span class="ls2f3">es<span class="_ _b"></span><span class="ls0">till <span class="_ _9"></span>open <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _3"></span>child <span class="_ _9"></span>from</span></span></div><div class="t m0 x32 h26 y13a ff19 fsf fc0 sc0 ls0 ws0">previous <span class="_ _9"></span>calls <span class="_ _23"></span>to<span class="_ _35"> </span><span class="ff1a">popen</span><span class="ls1190">.T<span class="_ _64"></span><span class="ls0">o<span class="_ _45"> </span>do<span class="_ _35"> </span>this, <span class="_ _23"></span>we <span class="_ _9"></span>go <span class="_ _23"> </span>through <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">childpid<span class="_ _35"> </span></span>array <span class="_ _23"></span>in <span class="_ _9"></span>the <span class="_ _23"> </span>child,</span></span></div><div class="t m0 x32 h2a y254 ff19 fsf fc0 sc0 ls0 ws0">closing any descriptors that ar<span class="ls44">es<span class="_ _4f"></span><span class="ls0">till open.</span></span></div><div class="t m0 x3f h26 y255 ff19 fsf fc0 sc0 ls0 ws0">What <span class="_ _35"> </span>happens <span class="_ _44"> </span>if <span class="_ _44"> </span>the <span class="_ _35"> </span>caller <span class="_ _44"> </span>of<span class="_ _51"> </span><span class="ff1a">pclose<span class="_ _54"> </span></span>has <span class="_ _44"> </span>established <span class="_ _35"> </span>a <span class="_ _44"> </span>signal <span class="_ _35"> </span>handler <span class="_ _44"> </span>for</div><div class="t m0 x32 h26 y13b ff1a fsf fc0 sc0 ls0 ws0">SIGCHLD<span class="ff19 ls1191">?T<span class="_ _26"></span><span class="ls0">he <span class="_ _23"></span>call <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">waitpid<span class="_ _45"> </span></span>from<span class="_ _45"> </span><span class="ff1a">pclose<span class="_ _45"> </span></span>would <span class="_ _9"></span>return <span class="_ _9"></span>an <span class="_ _9"></span>error <span class="_ _9"></span>of<span class="_ _45"> </span><span class="ff1a">EINTR</span><span class="ls1192">.S<span class="_ _62"></span><span class="ls0">ince</span></span></span></span></div><div class="t m0 x32 h2a y13c ff19 fsf fc0 sc0 ls0 ws0">the caller <span class="_ _2"></span>is <span class="_ _2"></span>allowed <span class="_ _2"></span>to <span class="_ _2"></span>catch <span class="_ _2"></span>this signal <span class="_ _2"></span>(or <span class="_ _2"></span>any <span class="_ _2"></span>other <span class="_ _2"></span>signal <span class="_ _2"></span>that might <span class="_ _2"></span>interrupt <span class="_ _2"></span>the <span class="_ _2"></span>call</div><div class="t m0 x32 h26 y256 ff19 fsf fc0 sc0 ls0 ws0">to<span class="_"> </span><span class="ff1a">waitpid</span>), we simply call<span class="_"> </span><span class="ff1a">waitpid<span class="_ _80"> </span></span>again if it is interrupted by a caught signal.</div><div class="t m0 x3f h26 y257 ff19 fsf fc0 sc0 ls0 ws0">Note <span class="_ _23"></span>that <span class="_ _23"></span>if <span class="_ _23"></span>the <span class="_ _23"></span>application <span class="_ _23"></span>calls<span class="_ _45"> </span><span class="ff1a">waitpid<span class="_ _35"> </span></span>and <span class="_ _23"></span>obtains <span class="_ _23"></span>the <span class="_ _23"></span>exit <span class="_ _23"></span>status <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>child</div><div class="t m0 x32 h26 y258 ff19 fsf fc0 sc0 ls0 ws0">created <span class="_ _9"></span>by<span class="_ _45"> </span><span class="ff1a">popen</span>,<span class="_ _45"> </span>we<span class="_ _45"> </span>will <span class="_ _23"></span>call<span class="_ _45"> </span><span class="ff1a">waitpid<span class="_ _45"> </span></span>when <span class="_ _9"></span>the <span class="_ _23"></span>application <span class="_ _9"></span>calls<span class="_ _45"> </span><span class="ff1a">pclose</span><span class="ls1193">,ﬁ<span class="_ _b"></span><span class="ls0">nd <span class="_ _9"></span>that</span></span></div><div class="t m0 x32 h26 y161 ff19 fsf fc0 sc0 ls0 ws0">the child no longer exists, and return<span class="_"> </span><span class="ff20">−</span><span class="ls9c3">1w<span class="_ _d"></span><span class="ls0">ith<span class="_"> </span><span class="ff1a">errno<span class="_ _66"> </span></span>set to<span class="_"> </span><span class="ff1a">ECHILD</span><span class="ls1194">.T<span class="_ _4a"></span><span class="ls0">his is the behavior</span></span></span></span></div><div class="t m0 x32 h2a y162 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">quired by POSIX.1 in this situation.</span></div><div class="t m0 x76 h52 y1d98 ff19 fs2a fc0 sc0 ls0 ws0">Some <span class="_ _9"></span>early <span class="_ _9"></span>versions <span class="_ _3"></span>of<span class="_ _47"> </span><span class="ff1a">pclose<span class="_ _66"> </span></span><span class="ls34e">re<span class="_ _2"></span></span>turned <span class="_ _9"></span>an <span class="_ _9"></span>error <span class="_ _3"></span>of<span class="_ _47"> </span><span class="ff1a">EINTR<span class="_ _66"> </span></span>if <span class="_ _9"></span>a <span class="_ _9"></span>signal <span class="_ _9"></span>interrupted <span class="_ _9"></span>the<span class="_ _66"> </span><span class="ff1a">wait</span>.</div><div class="t m0 x76 h52 y4237 ff19 fs2a fc0 sc0 ls0 ws0">Also, <span class="_ _9"></span>some <span class="_ _9"></span>early <span class="_ _9"></span>versions <span class="_ _9"></span>of<span class="_ _47"> </span><span class="ff1a">pclose<span class="_ _66"> </span></span>blocked <span class="_ _23"> </span>or <span class="_ _3"></span>ignored <span class="_ _9"></span>the <span class="_ _9"> </span>signals<span class="_ _47"> </span><span class="ff1a">SIGINT</span>,<span class="_ _47"> </span><span class="ff1a">SIGQUIT</span><span class="ls1195">,a<span class="_ _8"></span><span class="ls0">nd</span></span></div><div class="t m0 x76 h52 y4238 ff1a fs2a fc0 sc0 ls0 ws0">SIGHUP<span class="_ _53"> </span><span class="ff19">during the<span class="_"> </span></span>wait<span class="ff19 ls10f">.T<span class="_ _43"></span><span class="ls0">his is not allowed by POSIX.1.</span></span></div><div class="t m0 x3f h4d y4239 ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _3"></span>that<span class="_ _45"> </span><span class="ff1a">popen<span class="_ _47"> </span></span>should <span class="_ _9"></span>never <span class="_ _3"></span>be <span class="_ _9"></span>called <span class="_ _9"></span>by <span class="_ _3"></span>a <span class="_ _9"></span>set-user-ID <span class="_ _3"></span>or <span class="_ _3"></span>set-group-ID <span class="_ _3"></span>program.</div><div class="t m0 x32 h4d y423a ff19 fs26 fc0 sc0 ls0 ws0">When it executes the command,<span class="_"> </span><span class="ff1a">popen<span class="_ _80"> </span></span>does the equivalent of</div><div class="t m0 x3f h4e y423b ff1a fs28 fc0 sc0 ls0 ws0">execl(&quot;/bin/sh&quot;, &quot;sh&quot;, &quot;-c&quot;,<span class="_"> </span><span class="ff1b">command</span><span class="ls1b6">,N<span class="_ _1d"></span><span class="ls0">ULL);</span></span></div><div class="t m0 x32 h4a y423c ff19 fs26 fc0 sc0 ls0 ws0">which <span class="_ _3"></span>executes <span class="_ _9"></span>the <span class="_ _9"></span>shell <span class="_ _3"></span>and<span class="_ _45"> </span><span class="ff1b">command<span class="_ _45"> </span></span>with <span class="_ _3"></span>the <span class="_ _9"></span>environment <span class="_ _3"></span>inherited <span class="_ _9"></span>by <span class="_ _3"></span>the <span class="_ _9"></span>caller<span class="_ _1"></span><span class="ls1196">.A</span></div><div class="t m0 x32 h49 y423d ff19 fs26 fc0 sc0 ls0 ws0">malicious <span class="_ _42"> </span>user <span class="_ _23"> </span>can <span class="_ _42"> </span>manipulate <span class="_ _42"> </span>the <span class="_ _42"> </span>environment <span class="_ _23"> </span>so <span class="_ _42"> </span>that <span class="_ _42"> </span>the <span class="_ _42"> </span>shell <span class="_ _42"> </span>executes <span class="_ _23"> </span>commands</div><div class="t m0 x32 h49 y423e ff19 fs26 fc0 sc0 ls0 ws0">other <span class="_ _e"> </span>than <span class="_"> </span>those <span class="_ _53"> </span>intended, <span class="_"> </span>with <span class="_ _e"> </span>the <span class="_ _e"> </span>elevated <span class="_"> </span>permissions <span class="_ _53"> </span>granted <span class="_"> </span>by <span class="_ _e"> </span>the <span class="_"> </span>set-ID <span class="_ _53"> </span>ﬁle</div><div class="t m0 x32 h49 y423f ff19 fs26 fc0 sc0 ls0 ws0">mode.</div><div class="t m0 x3f h4d y4240 ff19 fs26 fc0 sc0 ls0 ws0">One <span class="_ _e"> </span>thing <span class="_ _e"> </span>that<span class="_ _4b"> </span><span class="ff1a">popen<span class="_ _59"> </span></span>is <span class="_ _53"> </span>especially <span class="_"> </span>well <span class="_ _53"> </span>suited <span class="_ _e"> </span>for <span class="_ _e"> </span>is <span class="_ _e"> </span>executing <span class="_"> </span>simple <span class="_ _53"> </span>ﬁlters <span class="_ _e"> </span>to</div><div class="t m0 x32 h49 y4241 ff19 fs26 fc0 sc0 ls0 ws0">transform <span class="_"> </span>the <span class="_"> </span>input <span class="_"> </span>or <span class="_"> </span>output <span class="_"> </span>of <span class="_"> </span>the <span class="_"> </span>running <span class="_"> </span>command.<span class="_ _60"> </span>Such <span class="_"> </span>is <span class="_"> </span>the <span class="_"> </span>case <span class="_"> </span>when <span class="_"> </span>a</div><div class="t m0 x32 h49 y4242 ff19 fs26 fc0 sc0 ls0 ws0">command wants to build its own pipeline.</div><div class="t m0 x35 h4c y4243 ff16 fs26 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h49 y4244 ff19 fs26 fc0 sc0 ls0 ws0">Consider <span class="_ _3"></span>an <span class="_ _3"></span>application <span class="_ _9"></span>that <span class="_ _3"></span>writes <span class="_ _9"></span>a <span class="_ _3"></span>prompt <span class="_ _3"></span>to <span class="_ _3"></span>standar<span class="ls1078">do<span class="_ _8"></span><span class="ls0">utput <span class="_ _3"></span>and <span class="_ _9"></span>reads <span class="_ _2"></span>a <span class="_ _9"></span>line <span class="_ _3"></span>from</span></span></div><div class="t m0 x32 h4d y4245 ff19 fs26 fc0 sc0 ls0 ws0">standar<span class="ls1197">di<span class="_ _55"></span><span class="ls0">nput. <span class="_ _4b"> </span>W<span class="_ _1"></span>ith <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">popen<span class="_ _44"> </span></span>function, <span class="_ _e"> </span>we <span class="_ _53"> </span>can <span class="_ _53"> </span>interpose <span class="_ _e"> </span>a <span class="_ _53"> </span>program <span class="_ _42"> </span>between <span class="_ _e"> </span>the</span></span></div><div class="t m0 x32 h49 y4246 ff19 fs26 fc0 sc0 ls0 ws0">application and <span class="_ _2"></span>its <span class="_ _2"></span>input to <span class="_ _2"></span>transform <span class="_ _2"></span>the input.<span class="_ _61"> </span>Figur<span class="ls141">e1<span class="_ _4f"></span><span class="ls0">5.13 shows <span class="_ _2"></span>the <span class="_ _2"></span>arrangement of</span></span></div><div class="t m0 x32 h49 y4247 ff19 fs26 fc0 sc0 ls0 ws0">processes in this situation.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
