<div id="pf366" class="pf w4 h1f" data-page-no="366"><div class="pc pc366 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg366.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">836<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">725 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">726 <span class="_ _176"> </span>*<span class="_"> </span>Write the headers first.<span class="_ _d9"> </span>Then send the file.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">727 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">728 <span class="_ _186"> </span>iov[0].iov_base<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">buf;</span></span></div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">729 <span class="_ _186"> </span>iov[0].iov_len<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">len;</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">730 <span class="_ _186"> </span>iov[1].iov_base<span class="_"> </span><span class="ls15c">=i<span class="_ _1d"></span><span class="ls0">buf;</span></span></div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">731 <span class="_ _186"> </span>iov[1].iov_len<span class="_"> </span><span class="ls15c">=i<span class="_ _1d"></span><span class="ls0">len;</span></span></div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">732 <span class="_ _186"> </span>if<span class="_"> </span>(writev(sockfd, iov, 2) != hlen + ilen) {</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">733 <span class="_ _82"> </span>log_ret(&quot;can’t<span class="_"> </span>write to printer&quot;);</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">734 <span class="_ _82"> </span>goto<span class="_"> </span>defer;</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">735 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y1d7f ff1a fs2d fc0 sc0 ls0 ws0">736 <span class="_ _186"> </span>if<span class="_"> </span>(jp-&gt;req.flags &amp; PR_TEXT) {</div><div class="t m0 x32 h57 y1d80 ff1a fs2d fc0 sc0 ls0 ws0">737 <span class="_ _82"> </span>/*</div><div class="t m0 x32 h57 y2c5b ff1a fs2d fc0 sc0 ls0 ws0">738 <span class="_ _166"> </span>*<span class="_"> </span>Hack: allow PostScript to be printed as plain text.</div><div class="t m0 x32 h57 y2c5c ff1a fs2d fc0 sc0 ls0 ws0">739 <span class="_ _166"> </span>*/</div><div class="t m0 x32 h57 y2c5d ff1a fs2d fc0 sc0 ls0 ws0">740 <span class="_ _82"> </span>if<span class="_"> </span>(write(sockfd, &quot;\b&quot;, 1) != 1) {</div><div class="t m0 x32 h57 y2c5e ff1a fs2d fc0 sc0 ls0 ws0">741 <span class="_ _1e7"> </span>log_ret(&quot;can’t<span class="_"> </span>write to printer&quot;);</div><div class="t m0 x32 h57 y2c5f ff1a fs2d fc0 sc0 ls0 ws0">742 <span class="_ _1e7"> </span>goto<span class="_"> </span>defer;</div><div class="t m0 x32 h57 y2c60 ff1a fs2d fc0 sc0 ls0 ws0">743 <span class="_ _82"> </span>}</div><div class="t m0 x32 h57 y2c61 ff1a fs2d fc0 sc0 ls0 ws0">744 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y4d71 ff1a fs2d fc0 sc0 ls0 ws0">745 <span class="_ _186"> </span>while<span class="_"> </span>((nr = read(fd, buf, IOBUFSZ)) &gt; 0) {</div><div class="t m0 x32 h57 y4d72 ff1a fs2d fc0 sc0 ls0 ws0">746 <span class="_ _82"> </span>if<span class="_"> </span>((nw = writen(sockfd, buf, nr)) != nr) {</div><div class="t m0 x32 h57 y4d73 ff1a fs2d fc0 sc0 ls0 ws0">747 <span class="_ _1e7"> </span>if<span class="_"> </span>(nw &lt; 0)</div><div class="t m0 x32 h57 y2c64 ff1a fs2d fc0 sc0 ls0 ws0">748 <span class="_ _cb"> </span>log_ret(&quot;can’t<span class="_"> </span>write to printer&quot;);</div><div class="t m0 x32 h57 y2c65 ff1a fs2d fc0 sc0 ls0 ws0">749 <span class="_ _1e7"> </span>else</div><div class="t m0 x32 h57 y4d74 ff1a fs2d fc0 sc0 ls0 ws0">750 <span class="_ _cb"> </span>log_msg(&quot;short<span class="_"> </span>write (%d/%d) to printer&quot;, nw, nr);</div><div class="t m0 x32 h57 y5abe ff1a fs2d fc0 sc0 ls0 ws0">751 <span class="_ _1e7"> </span>goto<span class="_"> </span>defer;</div><div class="t m0 x32 h57 y5abf ff1a fs2d fc0 sc0 ls0 ws0">752 <span class="_ _82"> </span>}</div><div class="t m0 x32 h57 y5ac0 ff1a fs2d fc0 sc0 ls0 ws0">753 <span class="_ _186"> </span>}</div><div class="t m0 x32 h4d y5a6c ff19 fs26 fc0 sc0 ls0 ws0">[725 <span class="_ _a"></span>– <span class="_ _a"></span>735]<span class="_ _65"> </span><span class="ls164">We <span class="_ _80"> </span>s<span class="_ _9"></span></span>et <span class="_ _3"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _3"></span>element <span class="_ _3"></span>of <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">iovec<span class="_ _47"> </span></span>array <span class="_ _3"></span>to <span class="_ _3"></span>refer <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>HTTP <span class="_ _3"></span>header <span class="_ _3"></span>and</div><div class="t m0 x11a h4d y5a6d ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>second <span class="_ _3"></span>element <span class="_ _3"></span>to <span class="_ _3"></span>refer <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _2"></span>IPP <span class="_ _3"></span>header<span class="_ _1"></span><span class="ls17cf">.T<span class="_ _1d"></span><span class="ls0">hen <span class="_ _3"></span>we <span class="_ _3"></span>use<span class="_ _47"> </span><span class="ff1a">writev<span class="_ _47"> </span></span>to <span class="_ _2"></span>send</span></span></div><div class="t m0 x11a h49 y5a6e ff19 fs26 fc0 sc0 ls0 ws0">both <span class="_"> </span>headers <span class="_"> </span>to <span class="_"> </span>the <span class="_"> </span>printer<span class="_ _1"></span><span class="ls17d0">.I<span class="_ _49"></span><span class="ls17d1">ft<span class="_ _4a"></span><span class="ls0">he <span class="_"> </span>write <span class="_"> </span>fails <span class="_"> </span>or <span class="_"> </span>we <span class="_ _66"> </span>write <span class="_"> </span>less <span class="_"> </span>than <span class="_"> </span>we</span></span></span></div><div class="t m0 x11a h4d y5a6f ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">quested, <span class="_ _42"> </span>we <span class="_ _23"> </span>log <span class="_ _42"> </span>a <span class="_ _42"> </span>message <span class="_ _23"> </span>and <span class="_ _42"> </span>jump <span class="_ _23"> </span>to<span class="_ _35"> </span><span class="ff1a">defer</span><span class="ls17d2">,w<span class="_ _43"></span><span class="ls0">here<span class="_ _35"> </span>we<span class="_ _35"> </span>will <span class="_ _42"> </span>clean <span class="_ _42"> </span>up</span></span></span></div><div class="t m0 x11a h49 y5a70 ff19 fs26 fc0 sc0 ls0 ws0">and delay befor<span class="lsd3">et<span class="_ _4f"></span><span class="ls0">rying again.</span></span></div><div class="t m0 x32 h49 y5c94 ff19 fs26 fc0 sc0 ls0 ws0">[736 <span class="_ _a"></span>– <span class="_ _a"></span>744]<span class="_ _65"> </span>Even <span class="_ _47"> </span>if <span class="_ _47"> </span>we <span class="_ _47"> </span>specify <span class="_ _47"> </span>plaintext, <span class="_ _66"> </span>the <span class="_ _47"> </span>Phaser <span class="_ _47"> </span>8560 <span class="_ _47"> </span>will <span class="_ _47"> </span>try <span class="_ _47"> </span>to <span class="_ _47"> </span>autosense <span class="_ _47"> </span>the</div><div class="t m0 x11a h49 y5c95 ff19 fs26 fc0 sc0 ls0 ws0">document <span class="_ _3"></span>format.<span class="_ _16"> </span><span class="ls164">To <span class="_ _80"> </span>p<span class="_ _9"></span><span class="lscc">re<span class="_ _2"></span></span></span>vent <span class="_ _3"></span>it <span class="_ _3"></span>from <span class="_ _3"></span>recognizing <span class="_ _2"></span>the <span class="_ _3"></span>beginning <span class="_ _3"></span>of <span class="_ _9"></span>a <span class="_ _3"></span>ﬁle <span class="_ _3"></span>we</div><div class="t m0 x11a h49 y5c96 ff19 fs26 fc0 sc0 ls0 ws0">want <span class="_ _23"></span>to <span class="_ _23"> </span>print <span class="_ _23"> </span>as <span class="_ _23"> </span>plaintext, <span class="_ _23"> </span>the <span class="_ _42"> </span>ﬁrst <span class="_ _23"></span>character <span class="_ _23"></span>we <span class="_ _23"></span>send <span class="_ _23"> </span>is <span class="_ _23"> </span>a <span class="_ _23"> </span>backspace.<span class="_ _51"> </span>This</div><div class="t m0 x11a h49 y5c97 ff19 fs26 fc0 sc0 ls0 ws0">character <span class="_ _2"></span>doesn’t <span class="_ _2"></span>show <span class="_ _2"></span>up <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _2"></span>printout <span class="_ _3"></span>and <span class="_ _2"></span>defeats <span class="_ _2"></span>the <span class="_ _2"></span>printer<span class="_ _9"></span>’s <span class="_ _2"></span>ability <span class="_ _3"></span>to</div><div class="t m0 x11a h49 y5c98 ff19 fs26 fc0 sc0 ls0 ws0">autosense <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>format.<span class="_ _5a"> </span>This <span class="_ _9"></span>allows <span class="_ _9"></span>us <span class="_ _9"></span>to <span class="_ _9"></span>print <span class="_ _23"></span>the <span class="_ _9"></span>source <span class="_ _3"></span>to <span class="_ _9"></span>a <span class="_ _9"></span>PostScript</div><div class="t m0 x11a h49 y5c99 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle instead of printing the image resulting fr<span class="_ _0"></span>om the PostScript ﬁle.</div><div class="t m0 x32 h4d y5c9a ff19 fs26 fc0 sc0 ls0 ws0">[745 <span class="_ _a"></span>– <span class="_ _a"></span>753]<span class="_ _65"> </span><span class="ls164">We <span class="_ _45"> </span>s<span class="_ _9"></span></span>end <span class="_ _23"> </span>the <span class="_ _42"> </span>data <span class="_ _42"> </span>ﬁle <span class="_ _23"> </span>to <span class="_ _42"> </span>the <span class="_ _42"> </span>printer <span class="_ _23"> </span>in<span class="_ _44"> </span><span class="ff1a">IOBUFSZ<span class="_ _35"> </span></span>chunks.<span class="_ _54"> </span><span class="ff1a">write<span class="_ _35"> </span></span>can <span class="_ _42"> </span>send</div><div class="t m0 x11a h4d y5c9b ff19 fs26 fc0 sc0 ls0 ws0">less than we requested when the <span class="_ _2"></span>socket buffers ar<span class="ls129f">ef<span class="_ _4f"></span><span class="ls0">ull, so <span class="_ _2"></span>we use<span class="_"> </span><span class="ff1a">writen<span class="_ _66"> </span></span>to</span></span></div><div class="t m0 x11a h49 y5c9c ff19 fs26 fc0 sc0 ls0 ws0">handle <span class="_ _23"> </span>this <span class="_ _42"> </span>case.<span class="_ _51"> </span><span class="ls164">We <span class="_ _45"> </span>d<span class="_ _9"></span></span>on’t <span class="_ _23"> </span>worry <span class="_ _42"> </span>about <span class="_ _42"> </span>this <span class="_ _23"> </span>condition <span class="_ _42"> </span>when <span class="_ _23"> </span>we <span class="_ _42"> </span>write <span class="_ _23"> </span>the</div><div class="t m0 x11a h49 y5c9d ff19 fs26 fc0 sc0 ls0 ws0">headers, because they ar<span class="lsd3">es<span class="_ _4f"></span><span class="ls0">mall. <span class="_"> </span>However<span class="_ _1"></span><span class="lsd3">,t<span class="_ _d"></span><span class="ls0">he ﬁle to print could be large.</span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
