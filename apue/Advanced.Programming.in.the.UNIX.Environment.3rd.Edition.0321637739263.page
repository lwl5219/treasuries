<div id="pf107" class="pf w4 h1f" data-page-no="107"><div class="pc pc107 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg107.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>8.3<span class="_ _e8"> </span><span class="ff1a">fork<span class="_ _4b"> </span></span>Function<span class="_ _1b"> </span><span class="ff18">229</span></div><div class="t m0 x35 h75 y12f ff16 fs2b fc0 sc0 ls0 ws0">8.3<span class="_ _72"> </span><span class="ff1f">fork<span class="_ _54"> </span></span>Function</div><div class="t m0 x32 h26 y4de ff19 fsf fc0 sc0 ls0 ws0">An existing process can cr<span class="_ _0"></span>eate a new one by calling the<span class="_"> </span><span class="ff1a">fork<span class="_ _80"> </span></span>function.</div><div class="t m0 x3f h57 y1e69 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h57 y1e6a ff1a fs2d fc0 sc0 ls0 ws0">pid_t fork(void);</div><div class="t m0 x128 h5f y1e6b ff19 fs2d fc0 sc0 ls0 ws0">Returns: 0 in child, process ID of child in par<span class="_ _0"></span>ent,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h4d y1e6c ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _2"></span>new <span class="_ _3"></span>process created <span class="_ _2"></span>by<span class="_ _47"> </span><span class="ff1a">fork<span class="_ _47"> </span></span>is <span class="_ _2"></span>called <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1b">child <span class="_ _3"></span>process</span><span class="ls91a">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _2"></span>function <span class="_ _2"></span>is <span class="_ _3"></span>called <span class="_ _2"></span>once</span></span></div><div class="t m0 x32 h49 y1e6d ff19 fs26 fc0 sc0 ls0 ws0">but <span class="_ _2"></span>returns twice.<span class="_ _61"> </span>The <span class="_ _2"></span>only <span class="_ _2"></span>difference in <span class="_ _2"></span>the <span class="_ _2"></span>returns is <span class="_ _3"></span>that <span class="_ _2"></span>the <span class="_ _2"></span>return value <span class="_ _2"></span>in <span class="_ _2"></span>the <span class="_ _2"></span>child</div><div class="t m0 x32 h49 y1e6e ff19 fs26 fc0 sc0 ls0 ws0">is <span class="_ _42"> </span>0, <span class="_ _53"> </span>whereas <span class="_ _42"> </span>the <span class="_ _42"> </span>return <span class="_ _42"> </span>value <span class="_ _42"> </span>in <span class="_ _53"> </span>the <span class="_ _42"> </span>parent <span class="_ _42"> </span>is <span class="_ _42"> </span>the <span class="_ _53"> </span>process <span class="_ _42"> </span>ID <span class="_ _42"> </span>of <span class="_ _53"> </span>the <span class="_ _42"> </span>new <span class="_ _53"> </span>child.<span class="_ _54"> </span>The</div><div class="t m0 x32 h49 y1e6f ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ason <span class="_ _23"></span>the <span class="_ _9"></span>child’s <span class="_ _9"></span>process <span class="_ _9"></span>ID <span class="_ _9"></span>is <span class="_ _23"></span>r<span class="_ _0"></span>eturned <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _23"></span>parent <span class="_ _3"></span>is <span class="_ _23"></span>that <span class="_ _9"></span>a <span class="_ _9"></span>process <span class="_ _9"></span>can <span class="_ _9"></span>have <span class="_ _23"></span>mor<span class="_ _0"></span>e</span></div><div class="t m0 x32 h49 y1e70 ff19 fs26 fc0 sc0 ls0 ws0">than one child, and there<span class="_"> </span>is<span class="_"> </span>no<span class="_"> </span>function that allows a process to obtain the pr<span class="_ _1"></span>ocess IDs <span class="_ _2"></span>of</div><div class="t m0 x32 h4d y1e71 ff19 fs26 fc0 sc0 ls0 ws0">its <span class="_ _23"></span>children. <span class="_ _45"> </span>The<span class="_ _35"> </span><span class="lscc">re</span>ason<span class="_ _35"> </span><span class="ff1a">fork<span class="_ _35"> </span></span><span class="lscc">re</span>turns <span class="_ _23"> </span>0 <span class="_ _23"> </span>to <span class="_ _23"> </span>the <span class="_ _23"> </span>child <span class="_ _23"> </span>is <span class="_ _23"> </span>that <span class="_ _23"> </span>a <span class="_ _23"> </span>process <span class="_ _23"></span>can <span class="_ _23"></span>have <span class="_ _23"></span>only <span class="_ _23"></span>a</div><div class="t m0 x32 h4d y1e72 ff19 fs26 fc0 sc0 ls0 ws0">single <span class="_ _42"> </span>parent, <span class="_ _42"> </span>and <span class="_ _42"> </span>the <span class="_ _53"> </span>child <span class="_ _42"> </span>can <span class="_ _42"> </span>always <span class="_ _53"> </span>call<span class="_ _44"> </span><span class="ff1a">getppid<span class="_ _44"> </span></span>to <span class="_ _42"> </span>obtain <span class="_ _53"> </span>the <span class="_ _42"> </span>process <span class="_ _42"> </span>ID <span class="_ _42"> </span>of <span class="_ _53"> </span>its</div><div class="t m0 x32 h49 y1e73 ff19 fs26 fc0 sc0 ls0 ws0">parent. <span class="_"> </span>(Process ID <span class="_ _2"></span>0 is <span class="_ _2"></span>reserved for <span class="_ _2"></span>use <span class="_ _2"></span>by <span class="_ _2"></span>the kernel, <span class="_ _2"></span>so <span class="_ _2"></span>it’s <span class="_ _2"></span>not <span class="_ _2"></span>possible for <span class="_ _2"></span>0 <span class="_ _2"></span>to <span class="_ _2"></span>be <span class="_ _2"></span>the</div><div class="t m0 x32 h49 y1e74 ff19 fs26 fc0 sc0 ls0 ws0">process ID of a child.)</div><div class="t m0 x3f h49 y1e75 ff19 fs26 fc0 sc0 ls0 ws0">Both <span class="_ _9"></span>the <span class="_ _23"></span>child <span class="_ _9"></span>and <span class="_ _23"></span>the <span class="_ _9"></span>parent <span class="_ _9"></span>continue <span class="_ _23"> </span>executing <span class="_ _23"></span>with <span class="_ _9"></span>the <span class="_ _23"></span>instruction <span class="_ _9"></span>that <span class="_ _9"></span>follows</div><div class="t m0 x32 h4d y1e76 ff19 fs26 fc0 sc0 ls0 ws0">the call <span class="_ _2"></span>to<span class="_"> </span><span class="ff1a">fork</span><span class="ls91b">.T<span class="_ _4a"></span><span class="ls0">he child is <span class="_ _2"></span>a <span class="_ _2"></span>copy of <span class="_ _2"></span>the parent. <span class="_"> </span>For<span class="_ _66"> </span>example, the <span class="_ _2"></span>child <span class="_ _2"></span>gets a <span class="_ _2"></span>copy of</span></span></div><div class="t m0 x32 h49 y1e77 ff19 fs26 fc0 sc0 ls0 ws0">the parent’s data space, heap, and stack.<span class="_ _59"> </span>Note that this is a copy for the child; the parent</div><div class="t m0 x32 h49 y1e78 ff19 fs26 fc0 sc0 ls0 ws0">and the <span class="_ _2"></span>child <span class="_ _2"></span>do <span class="_ _2"></span>not <span class="_ _2"></span>shar<span class="ls91c">et<span class="_ _4f"></span><span class="ls0">hese portions <span class="_ _2"></span>of <span class="_ _2"></span>memory<span class="_ _6"></span><span class="ls91d">.T<span class="_ _5b"></span><span class="ls0">he <span class="_ _2"></span>parent and <span class="_ _2"></span>the child <span class="_ _2"></span>do <span class="_ _2"></span>share</span></span></span></span></div><div class="t m0 x32 h49 y1e79 ff19 fs26 fc0 sc0 ls0 ws0">the text segment, however (Section 7.6).</div><div class="t m0 x3f h49 y1e7a ff19 fs26 fc0 sc0 ls0 ws0">Modern implementations <span class="_ _2"></span>don’t <span class="_ _2"></span>perform <span class="_ _2"></span>a complete <span class="_ _2"></span>copy <span class="_ _2"></span>of <span class="_ _2"></span>the parent’s data, <span class="_ _2"></span>stack,</div><div class="t m0 x32 h4d y1e7b ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_"> </span>heap, <span class="_ _e"> </span>since <span class="_"> </span>a<span class="_ _59"> </span><span class="ff1a">fork<span class="_ _59"> </span></span>is <span class="_"> </span>often <span class="_"> </span>followed <span class="_"> </span>by <span class="_ _e"> </span>an<span class="_ _59"> </span><span class="ff1a">exec</span><span class="ls91e">.I<span class="_ _5d"></span><span class="ls0">nstead, <span class="_"> </span>a <span class="_"> </span>technique <span class="_"> </span>called</span></span></div><div class="t m0 x32 h4a y1e7c ff1b fs26 fc0 sc0 ls0 ws0">copy-on-write</div><div class="t m0 xaa h49 y1e7d ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x1d h49 y1e7c ff19 fs26 fc0 sc0 ls0 ws0">COW</div><div class="t m0 xe8 h49 y1e7d ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 xea h49 y1e7c ff19 fs26 fc0 sc0 ls0 ws0">is <span class="_ _3"></span>used.<span class="_ _16"> </span>These <span class="_ _3"></span>regions <span class="_ _3"></span>ar<span class="ls91f">es<span class="_ _8"></span><span class="ls0">hared <span class="_ _2"></span>by <span class="_ _3"></span>the <span class="_ _9"></span>parent <span class="_ _2"></span>and <span class="_ _9"></span>the <span class="_ _3"></span>child <span class="_ _3"></span>and</span></span></div><div class="t m0 x32 h49 y1e7e ff19 fs26 fc0 sc0 ls0 ws0">have <span class="_"> </span>their <span class="_"> </span>pr<span class="_ _0"></span>otection <span class="_"> </span>changed <span class="_"> </span>by <span class="_"> </span>the <span class="_ _e"> </span>kernel <span class="_"> </span>to <span class="_"> </span>read-only<span class="_ _4"></span><span class="ls920">.I<span class="_ _5d"></span><span class="ls921">fe<span class="_ _4a"></span><span class="ls0">ither <span class="_"> </span>process <span class="_ _e"> </span>tries <span class="_"> </span>to</span></span></span></div><div class="t m0 x32 h49 y1e7f ff19 fs26 fc0 sc0 ls0 ws0">modify <span class="_"> </span>these <span class="_ _e"> </span>regions, <span class="_ _e"> </span>the <span class="_"> </span>kernel <span class="_ _e"> </span>then <span class="_"> </span>makes <span class="_"> </span>a <span class="_ _53"> </span>copy <span class="_"> </span>of <span class="_"> </span>that <span class="_ _e"> </span>piece <span class="_"> </span>of <span class="_ _e"> </span>memory <span class="_"> </span>only<span class="_ _4"></span>,</div><div class="t m0 x32 h49 y1e80 ff19 fs26 fc0 sc0 ls0 ws0">typically <span class="_ _3"></span>a <span class="_ _3"></span>‘‘page’<span class="_ _1"></span>’<span class="_ _47"> </span>in<span class="_ _45"> </span>a<span class="_ _47"> </span>virtual <span class="_ _3"></span>memory <span class="_ _3"></span>system.<span class="_ _16"> </span>Section <span class="_ _9"></span>9.2 <span class="_ _3"></span>of <span class="_ _3"></span>Bach</div><div class="t m0 xd4 h49 y1e81 ff19 fs26 fc0 sc0 ls0 ws0">[</div><div class="t m0 xbc h49 y1e80 ff19 fs26 fc0 sc0 ls0 ws0">1986</div><div class="t m0 x1cc h49 y1e81 ff19 fs26 fc0 sc0 ls0 ws0">]</div><div class="t m0 x189 h49 y1e80 ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _3"></span>Sections</div><div class="t m0 x32 h49 y1e82 ff19 fs26 fc0 sc0 ls0 ws0">5.6 and 5.7 of McKusick et al.</div><div class="t m0 x127 h49 y1e83 ff19 fs26 fc0 sc0 ls0 ws0">[</div><div class="t m0 x128 h49 y1e82 ff19 fs26 fc0 sc0 ls0 ws0">1996</div><div class="t m0 x1e0 h49 y1e83 ff19 fs26 fc0 sc0 ls0 ws0">]</div><div class="t m0 x16 h49 y1e82 ff19 fs26 fc0 sc0 ls0 ws0">provide mor<span class="_ _0"></span><span class="lsd3">ed<span class="_ _d"></span><span class="ls0">etail on this feature.</span></span></div><div class="t m0 x76 h5e y1e84 ff19 fs10 fc0 sc0 ls292 ws0">Va<span class="_ _3"></span><span class="ls0">riations <span class="_ _2"></span>of <span class="_ _2"></span>the<span class="_ _80"> </span><span class="ff1a">fork<span class="_ _e"> </span></span>function <span class="_ _2"></span>ar<span class="ls922">ep<span class="_ _5"></span><span class="ls21d">ro<span class="ls0">vided <span class="_ _2"></span>by <span class="_ _2"></span>some <span class="_ _2"></span>platforms.<span class="_ _44"> </span>All <span class="_ _2"></span>four <span class="_ _2"></span>platforms <span class="_ _2"></span>discussed</span></span></span></span></div><div class="t m0 x76 h5e y1e85 ff19 fs10 fc0 sc0 ls0 ws0">in this book support the<span class="_"> </span><span class="ff1a">vfork</span></div><div class="t m0 xb6 h2d y1e86 ff19 fs10 fc0 sc0 ls0 ws0">(</div><div class="t m0 x9a h2d y1e85 ff19 fs10 fc0 sc0 ls0 ws0">2</div><div class="t m0 x1f2 h2d y1e86 ff19 fs10 fc0 sc0 ls0 ws0">)</div><div class="t m0 xdd h2d y1e85 ff19 fs10 fc0 sc0 ls0 ws0">variant discussed in the next section.</div><div class="t m0 x76 h5e y1e87 ff19 fs10 fc0 sc0 ls0 ws0">Linux <span class="_ _23"> </span>3.2.0 <span class="_ _23"> </span>also <span class="_ _23"> </span>provides <span class="_ _23"> </span>new <span class="_ _23"> </span>process <span class="_ _9"> </span>creation <span class="_ _23"> </span>through <span class="_ _23"> </span>the<span class="_ _47"> </span><span class="ff1a">clone</span></div><div class="t m0 x13b h2d y1e88 ff19 fs10 fc0 sc0 ls0 ws0">(</div><div class="t m0 x1ea h2d y1e87 ff19 fs10 fc0 sc0 ls0 ws0">2</div><div class="t m0 x1b1 h2d y1e88 ff19 fs10 fc0 sc0 ls0 ws0">)</div><div class="t m0 x152 h2d y1e87 ff19 fs10 fc0 sc0 ls0 ws0">system <span class="_ _23"> </span>call.<span class="_ _46"> </span>This <span class="_ _23"> </span>is <span class="_ _42"> </span>a</div><div class="t m0 x76 h5e y1e89 ff19 fs10 fc0 sc0 ls0 ws0">generalized <span class="_ _3"></span>form <span class="_ _3"></span>of<span class="_ _66"> </span><span class="ff1a">fork<span class="_ _80"> </span></span>that <span class="_ _3"></span>allows <span class="_ _3"></span>the <span class="_ _3"></span>caller <span class="_ _9"></span>to <span class="_ _2"></span>control <span class="_ _3"></span>what <span class="_ _3"></span>is <span class="_ _3"></span>shared <span class="_ _3"></span>between <span class="_ _3"></span>parent <span class="_ _2"></span>and</div><div class="t m0 x76 h2d y1e8a ff19 fs10 fc0 sc0 ls0 ws0">child.</div><div class="t m0 x76 h5e y1e8b ff19 fs10 fc0 sc0 ls0 ws0">FreeBSD <span class="_ _9"></span>8.0 <span class="_ _9"></span>provides <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">rfork</span></div><div class="t m0 x87 h2d y1e8c ff19 fs10 fc0 sc0 ls0 ws0">(</div><div class="t m0 xc5 h2d y1e8b ff19 fs10 fc0 sc0 ls0 ws0">2</div><div class="t m0 xde h2d y1e8c ff19 fs10 fc0 sc0 ls0 ws0">)</div><div class="t m0 x1f3 h5e y1e8b ff19 fs10 fc0 sc0 ls0 ws0">system <span class="_ _9"></span>call, <span class="_ _9"> </span>which <span class="_ _23"> </span>is <span class="_ _9"></span>similar <span class="_ _9"> </span>to <span class="_ _23"> </span>the <span class="_ _9"></span>Linux<span class="_ _47"> </span><span class="ff1a">clone<span class="_ _47"> </span></span>system</div><div class="t m0 x76 h5e y1e8d ff19 fs10 fc0 sc0 ls0 ws0">call. <span class="_"> </span>The<span class="_"> </span><span class="ff1a">rfork<span class="_ _53"> </span></span>call is derived from the Plan 9 operating system (Pike et al.</div><div class="t m0 x3a h2d y1e8e ff19 fs10 fc0 sc0 ls0 ws0">[</div><div class="t m0 x51 h2d y1e8d ff19 fs10 fc0 sc0 ls0 ws0">1995</div><div class="t m0 x70 h2d y1e8e ff19 fs10 fc0 sc0 ls0 ws0">]</div><div class="t m0 x18a h2d y1e8d ff19 fs10 fc0 sc0 ls0 ws0">).</div><div class="t m0 x76 h2d y1e8f ff19 fs10 fc0 sc0 ls0 ws0">Solaris <span class="_ _2"></span>10 <span class="_ _2"></span>provides <span class="_ _2"></span>two <span class="_ _2"></span>threads libraries: <span class="_ _3"></span>one <span class="_ _2"></span>for <span class="_ _2"></span>POSIX <span class="_ _2"></span>threads <span class="_ _2"></span>(pthreads) and <span class="_ _3"></span>one <span class="_ _2"></span>for <span class="_ _2"></span>Solaris</div><div class="t m0 x76 h5e y1e90 ff19 fs10 fc0 sc0 ls0 ws0">threads. <span class="_ _80"> </span>In<span class="_ _80"> </span>previous <span class="_ _2"></span>releases, <span class="_ _3"></span>the <span class="_ _3"></span>behavior <span class="_ _2"></span>of<span class="_ _66"> </span><span class="ff1a">fork<span class="_ _80"> </span></span>differed <span class="_ _2"></span>between <span class="_ _3"></span>the <span class="_ _3"></span>two <span class="_ _3"></span>thread <span class="_ _2"></span>libraries.</div><div class="t m0 x76 h5e y1e91 ff19 fs10 fc0 sc0 ls0 ws0">For <span class="_ _3"></span>POSIX <span class="_ _9"></span>threads,<span class="_ _66"> </span><span class="ff1a">fork<span class="_ _66"> </span></span>created <span class="_ _3"></span>a <span class="_ _9"></span>process <span class="_ _3"></span>containing <span class="_ _3"></span>only <span class="_ _9"></span>the <span class="_ _9"></span>calling <span class="_ _3"></span>thread, <span class="_ _3"></span>but <span class="_ _9"></span>for <span class="_ _3"></span>Solaris</div><div class="t m0 x76 h5e y1e92 ff19 fs10 fc0 sc0 ls0 ws0">threads,<span class="_"> </span><span class="ff1a">fork<span class="_ _80"> </span></span>created a <span class="_ _2"></span>process <span class="_ _2"></span>containing <span class="_ _2"></span>copies <span class="_ _2"></span>of <span class="_ _2"></span>all <span class="_ _2"></span>threads from <span class="_ _2"></span>the <span class="_ _2"></span>process of <span class="_ _2"></span>the <span class="_ _2"></span>calling</div><div class="t m0 x76 h5e y1e93 ff19 fs10 fc0 sc0 ls0 ws0">thread. <span class="_"> </span>In<span class="_ _80"> </span>Solaris <span class="_ _3"></span>10, <span class="_ _2"></span>this <span class="_ _2"></span>behavior <span class="_ _2"></span>has <span class="_ _3"></span>changed;<span class="_ _80"> </span><span class="ff1a">fork<span class="_ _80"> </span></span>creates a <span class="_ _3"></span>child <span class="_ _2"></span>containing <span class="_ _2"></span>a <span class="_ _2"></span>copy <span class="_ _3"></span>of <span class="_ _2"></span>the</div><div class="t m0 x76 h5e y1e94 ff19 fs10 fc0 sc0 ls0 ws0">calling thread only<span class="_ _6"></span><span class="ls923">,r<span class="_ _5"></span><span class="ls0">egardless of <span class="_ _2"></span>which thread library is <span class="_ _2"></span>used.<span class="_ _44"> </span>Solaris also <span class="_ _2"></span>provides the<span class="_"> </span><span class="ff1a">fork1</span></span></span></div><div class="t m0 x76 h2d y1e95 ff19 fs10 fc0 sc0 ls0 ws0">function, <span class="_ _2"></span>which <span class="_ _2"></span>can <span class="_ _2"></span>be <span class="_ _2"></span>used <span class="_ _2"></span>to <span class="_ _2"></span>create a <span class="_ _2"></span>process <span class="_ _2"></span>that <span class="_ _2"></span>duplicates <span class="_ _2"></span>only <span class="_ _2"></span>the <span class="_ _2"></span>calling <span class="_ _2"></span>thread, and <span class="_ _2"></span>the</div><div class="t m0 x76 h5e y1e96 ff1a fs10 fc0 sc0 ls0 ws0">forkall<span class="_ _80"> </span><span class="ff19">function, <span class="_ _2"></span>which <span class="_ _3"></span>can <span class="_ _3"></span>be <span class="_ _2"></span>used <span class="_ _3"></span>to <span class="_ _2"></span>create <span class="_ _2"></span>a <span class="_ _3"></span>process <span class="_ _2"></span>that <span class="_ _2"></span>duplicates <span class="_ _3"></span>all <span class="_ _3"></span>the <span class="_ _2"></span>threads <span class="_ _2"></span>in <span class="_ _3"></span>the</span></div><div class="t m0 x76 h2d y1e97 ff19 fs10 fc0 sc0 ls0 ws0">process. <span class="_"> </span>Thr<span class="_ _0"></span>eads ar<span class="ls136">ed<span class="_ _5"></span><span class="ls0">iscussed in detail in Chapters 1<span class="_ _0"></span><span class="ls136">1a<span class="_ _84"></span><span class="ls0">nd 12.</span></span></span></span></div><a class="l" href="#pff" data-dest-detail='[15,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1236.288916px;width:122.135795px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
