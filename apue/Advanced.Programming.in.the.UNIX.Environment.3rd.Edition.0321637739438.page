<div id="pf1b6" class="pf w4 h1f" data-page-no="1b6"><div class="pc pc1b6 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg1b6.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">404<span class="_ _1b"> </span><span class="ff19">Threads <span class="_ _24b"> </span>Chapter<span class="_ _78"> </span><span class="ls7ed">11</span></span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">struct foo<span class="_ _d9"> </span>*fp;</div><div class="t m0 x8a h57 y3357 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_lock(&amp;hashlock);</div><div class="t m0 x8a h57 y2db3 ff1a fs2d fc0 sc0 ls0 ws0">for (fp = fh[HASH(id)]; fp != NULL; fp = fp-&gt;f_next) {</div><div class="t m0 x9d h57 y2db4 ff1a fs2d fc0 sc0 ls0 ws0">if (fp-&gt;f_id == id) {</div><div class="t m0 x1f h57 y23c8 ff1a fs2d fc0 sc0 ls0 ws0">foo_hold(fp);</div><div class="t m0 x1f h57 y23c9 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x9d h57 y23ca ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y23cb ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y86e ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;hashlock);</div><div class="t m0 x8a h57 y86f ff1a fs2d fc0 sc0 ls0 ws0">return(fp);</div><div class="t m0 x32 h57 y870 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y23cd ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h57 y872 ff1a fs2d fc0 sc0 ls0 ws0">foo_rele(struct foo *fp) /* release a reference to the object */</div><div class="t m0 x32 h57 y873 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y874 ff1a fs2d fc0 sc0 ls0 ws0">struct foo<span class="_ _d9"> </span>*tfp;</div><div class="t m0 x8a h57 y875 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _186"> </span>idx;</div><div class="t m0 x8a h57 y23ce ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_lock(&amp;fp-&gt;f_lock);</div><div class="t m0 x8a h57 y23cf ff1a fs2d fc0 sc0 ls0 ws0">if (fp-&gt;f_count == 1) { /* last reference */</div><div class="t m0 x9d h57 y23d0 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;fp-&gt;f_lock);</div><div class="t m0 x9d h57 y23d1 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_lock(&amp;hashlock);</div><div class="t m0 x9d h57 y23d2 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_lock(&amp;fp-&gt;f_lock);</div><div class="t m0 x9d h57 y23d3 ff1a fs2d fc0 sc0 ls0 ws0">/* need to recheck the condition */</div><div class="t m0 x9d h57 y3358 ff1a fs2d fc0 sc0 ls0 ws0">if (fp-&gt;f_count != 1) {</div><div class="t m0 x1f h57 y1700 ff1a fs2d fc0 sc0 ls0 ws0">fp-&gt;f_count--;</div><div class="t m0 x1f h57 y1701 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;fp-&gt;f_lock);</div><div class="t m0 x1f h57 y1702 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;hashlock);</div><div class="t m0 x1f h57 y1703 ff1a fs2d fc0 sc0 ls0 ws0">return;</div><div class="t m0 x9d h57 y1704 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y3359 ff1a fs2d fc0 sc0 ls0 ws0">/* remove from list */</div><div class="t m0 x9d h57 y335a ff1a fs2d fc0 sc0 ls0 ws0">idx = HASH(fp-&gt;f_id);</div><div class="t m0 x9d h57 y16ee ff1a fs2d fc0 sc0 ls0 ws0">tfp = fh[idx];</div><div class="t m0 x9d h57 y16ef ff1a fs2d fc0 sc0 ls0 ws0">if (tfp == fp) {</div><div class="t m0 x1f h57 y16f0 ff1a fs2d fc0 sc0 ls0 ws0">fh[idx] = fp-&gt;f_next;</div><div class="t m0 x9d h57 y16f1 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x1f h57 y16f2 ff1a fs2d fc0 sc0 ls0 ws0">while (tfp-&gt;f_next != fp)</div><div class="t m0 x1ca h57 y335b ff1a fs2d fc0 sc0 ls0 ws0">tfp = tfp-&gt;f_next;</div><div class="t m0 x1f h57 y335c ff1a fs2d fc0 sc0 ls0 ws0">tfp-&gt;f_next = fp-&gt;f_next;</div><div class="t m0 x9d h57 y335d ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y335e ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;hashlock);</div><div class="t m0 x9d h57 y335f ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;fp-&gt;f_lock);</div><div class="t m0 x9d h57 y3360 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_destroy(&amp;fp-&gt;f_lock);</div><div class="t m0 x9d h57 y3361 ff1a fs2d fc0 sc0 ls0 ws0">free(fp);</div><div class="t m0 x8a h57 y3362 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x9d h57 y3363 ff1a fs2d fc0 sc0 ls0 ws0">fp-&gt;f_count--;</div><div class="t m0 x9d h57 y3364 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;fp-&gt;f_lock);</div><div class="t m0 x8a h57 y3365 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y3366 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x11b h2d y3367 ff18 fs10 fc0 sc0 ls0 ws0">Figure 1<span class="_ _0"></span>1.1<span class="_ _0"></span>1<span class="_ _65"> </span><span class="ff19">Using two mutexes</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
