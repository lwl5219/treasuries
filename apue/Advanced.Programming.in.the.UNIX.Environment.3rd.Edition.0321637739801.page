<div id="pf321" class="pf w4 h1f" data-page-no="321"><div class="pc pc321 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg321.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">767</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">348 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">349 <span class="_ _8a"> </span>*<span class="_"> </span>Now read the actual index record.<span class="_ _d9"> </span>We read it into the key</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">350 <span class="_ _8a"> </span>*<span class="_"> </span>buffer that we malloced when we opened the database.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">351 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">352 <span class="_ _15"> </span>if<span class="_"> </span>((i = read(db-&gt;idxfd, db-&gt;idxbuf, db-&gt;idxlen)) != db-&gt;idxlen)</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">353 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>read error of index record&quot;);</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">354 <span class="_ _15"> </span>if<span class="_"> </span>(db-&gt;idxbuf[db-&gt;idxlen-1] != NEWLINE)<span class="_ _15"> </span>/* sanity check */</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">355 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>missing newline&quot;);</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">356 <span class="_ _15"> </span>db-&gt;idxbuf[db-&gt;idxlen-1]<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="lsa74">;/<span class="_ _19"></span><span class="ls15c">*r<span class="_ _5b"></span><span class="ls0">eplace newline with null */</span></span></span></span></div><div class="t m0 x32 h57 y1fbb ff1a fs2d fc0 sc0 ls0 ws0">357 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y1fbc ff1a fs2d fc0 sc0 ls0 ws0">358 <span class="_ _8a"> </span>*<span class="_"> </span>Find the separators in the index record.</div><div class="t m0 x32 h57 y1fbd ff1a fs2d fc0 sc0 ls0 ws0">359 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y1fbe ff1a fs2d fc0 sc0 ls0 ws0">360 <span class="_ _15"> </span>if<span class="_"> </span>((ptr1 = strchr(db-&gt;idxbuf, SEP)) == NULL)</div><div class="t m0 x32 h57 y1fbf ff1a fs2d fc0 sc0 ls0 ws0">361 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>missing first separator&quot;);</div><div class="t m0 x32 h57 y1fc0 ff1a fs2d fc0 sc0 ls0 ws0">362 <span class="_ _15"> </span>*ptr1++<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls1692">;/<span class="_ _287"></span><span class="ls15c">*r<span class="_ _1d"></span><span class="ls0">eplace SEP with null */</span></span></span></span></div><div class="t m0 x32 h57 y57a3 ff1a fs2d fc0 sc0 ls0 ws0">363 <span class="_ _15"> </span>if<span class="_"> </span>((ptr2 = strchr(ptr1, SEP)) == NULL)</div><div class="t m0 x32 h57 y1cc9 ff1a fs2d fc0 sc0 ls0 ws0">364 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>missing second separator&quot;);</div><div class="t m0 x32 h57 y57a4 ff1a fs2d fc0 sc0 ls0 ws0">365 <span class="_ _15"> </span>*ptr2++<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls1692">;/<span class="_ _287"></span><span class="ls15c">*r<span class="_ _1d"></span><span class="ls0">eplace SEP with null */</span></span></span></span></div><div class="t m0 x32 h57 y853 ff1a fs2d fc0 sc0 ls0 ws0">366 <span class="_ _15"> </span>if<span class="_"> </span>(strchr(ptr2, SEP) != NULL)</div><div class="t m0 x32 h57 y854 ff1a fs2d fc0 sc0 ls0 ws0">367 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>too many separators&quot;);</div><div class="t m0 x32 h57 y855 ff1a fs2d fc0 sc0 ls0 ws0">368 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y1d3f ff1a fs2d fc0 sc0 ls0 ws0">369 <span class="_ _8a"> </span>*<span class="_"> </span>Get the starting offset and length of the data record.</div><div class="t m0 x32 h57 y2aad ff1a fs2d fc0 sc0 ls0 ws0">370 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2aae ff1a fs2d fc0 sc0 ls0 ws0">371 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;datoff = atol(ptr1)) &lt; 0)</div><div class="t m0 x32 h57 y2aaf ff1a fs2d fc0 sc0 ls0 ws0">372 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>starting offset &lt; 0&quot;);</div><div class="t m0 x32 h57 y2ba7 ff1a fs2d fc0 sc0 ls0 ws0">373 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;datlen = atol(ptr2)) &lt;= 0 || db-&gt;datlen &gt; DATLEN_MAX)</div><div class="t m0 x32 h57 y2ba8 ff1a fs2d fc0 sc0 ls0 ws0">374 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>invalid length&quot;);</div><div class="t m0 x32 h57 y2ba9 ff1a fs2d fc0 sc0 ls0 ws0">375 <span class="_ _15"> </span>return(db-&gt;ptrval); <span class="_ _15"> </span>/*<span class="_"> </span>return offset of next key in chain */</div><div class="t m0 x32 h57 y2baa ff1a fs2d fc0 sc0 ls0 ws0">376 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y57a5 ff19 fs26 fc0 sc0 ls0 ws0">[348 <span class="_ _a"></span>– <span class="_ _a"></span>356]<span class="_ _65"> </span><span class="ls164">We <span class="_ _45"> </span>r<span class="_ _9"></span></span>ead <span class="_ _42"> </span>the <span class="_ _53"> </span>variable-length <span class="_ _53"> </span>index <span class="_ _42"> </span>recor<span class="ls1693">di<span class="_ _55"></span><span class="ls0">nto <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1a">idxbuf<span class="_ _44"> </span></span>ﬁeld <span class="_ _53"> </span>in <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1a">DB</span></span></span></div><div class="t m0 x11a h49 y57a6 ff19 fs26 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>e. <span class="_ _16"> </span>The<span class="_ _5a"> </span><span class="lscc">re</span>cor<span class="ls4cd">ds<span class="_ _62"></span><span class="ls0">hould <span class="_ _45"> </span>be <span class="_ _47"> </span>terminated <span class="_ _45"> </span>with <span class="_ _47"> </span>a <span class="_ _45"> </span>newline, <span class="_ _47"> </span>which <span class="_ _45"> </span>we</span></span></div><div class="t m0 x11a h49 y57a7 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">place <span class="_ _9"></span>with <span class="_ _9"></span>a <span class="_ _3"></span>null <span class="_ _9"></span>byte.<span class="_ _5a"> </span>If <span class="_ _3"></span>the <span class="_ _9"></span>index <span class="_ _9"></span>ﬁle <span class="_ _3"></span>is <span class="_ _9"></span>corrupt, <span class="_ _3"></span>we <span class="_ _9"></span>terminate <span class="_ _9"></span>and <span class="_ _3"></span>drop</span></div><div class="t m0 x11a h4d y57a8 ff19 fs26 fc0 sc0 ls0 ws0">core<span class="_"> </span>by<span class="_"> </span>calling<span class="_"> </span><span class="ff1a">err_dump</span>.</div><div class="t m0 x32 h49 y57a9 ff19 fs26 fc0 sc0 ls0 ws0">[357 <span class="_ _a"></span>– <span class="_ _a"></span>367]<span class="_ _65"> </span><span class="ls164">We <span class="_ _44"> </span>s<span class="_ _9"></span></span>eparate <span class="_"> </span>the <span class="_"> </span>index <span class="_"> </span>r<span class="_ _0"></span>ecor<span class="ls1694">di<span class="_ _5b"></span><span class="ls0">nto <span class="_"> </span>three <span class="_"> </span>ﬁelds: <span class="_ _e"> </span>the <span class="_"> </span>key<span class="_ _4"></span><span class="ls1695">,t<span class="_ _55"></span><span class="ls0">he <span class="_"> </span>of<span class="_ _0"></span>fset <span class="_"> </span>of <span class="_"> </span>the</span></span></span></span></div><div class="t m0 x11a h4d y57aa ff19 fs26 fc0 sc0 ls0 ws0">corresponding <span class="_ _9"></span>data <span class="_ _9"></span>record, <span class="_ _3"></span>and <span class="_ _23"></span>the <span class="_ _9"></span>length <span class="_ _23"></span>of <span class="_ _9"></span>the <span class="_ _23"></span>data <span class="_ _9"></span>recor<span class="_ _0"></span>d. <span class="_ _45"> </span>The<span class="_ _45"> </span><span class="ff1a">strchr</span></div><div class="t m0 x11a h49 y57ab ff19 fs26 fc0 sc0 ls0 ws0">function <span class="_ _e"> </span>ﬁnds <span class="_"> </span>the <span class="_ _53"> </span>ﬁrst <span class="_"> </span>occurr<span class="_ _0"></span>ence <span class="_ _e"> </span>of <span class="_ _e"> </span>the <span class="_"> </span>speciﬁed <span class="_ _53"> </span>character <span class="_"> </span>in <span class="_ _53"> </span>the <span class="_"> </span>given</div><div class="t m0 x11a h49 y57ac ff19 fs26 fc0 sc0 ls0 ws0">string. <span class="_ _4b"> </span>Here<span class="_ _44"> </span>we<span class="_ _59"> </span>look <span class="_ _53"> </span>for <span class="_ _e"> </span>the <span class="_ _e"> </span>character <span class="_ _e"> </span>that <span class="_ _53"> </span>separates <span class="_ _e"> </span>ﬁelds <span class="_ _e"> </span>in <span class="_ _e"> </span>the <span class="_ _e"> </span>recor<span class="_ _0"></span>d</div><div class="t m0 x11a h4d y57ad ff19 fs26 fc0 sc0 ls0 ws0">(<span class="ff1a">SEP</span><span class="lsd3">,w<span class="_ _d"></span><span class="ls0">hich we deﬁne to be a colon).</span></span></div><div class="t m0 x32 h49 y57ae ff19 fs26 fc0 sc0 ls0 ws0">[368 <span class="_ _a"></span>– <span class="_ _a"></span>376]<span class="_ _65"> </span><span class="ls164">We <span class="_ _80"> </span>c<span class="_ _9"></span></span>onvert <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _3"></span>recor<span class="_ _0"></span><span class="ls1696">do<span class="_ _8"></span><span class="lscc">ff<span class="_ _2"></span><span class="ls0">set <span class="_ _3"></span>and <span class="_ _3"></span>length <span class="_ _3"></span>into <span class="_ _3"></span>integers <span class="_ _2"></span>and <span class="_ _3"></span>stor<span class="ls1696">et<span class="_ _8"></span><span class="ls0">hem <span class="_ _3"></span>in</span></span></span></span></span></div><div class="t m0 x11a h4d y57af ff19 fs26 fc0 sc0 ls0 ws0">the<span class="_ _35"> </span><span class="ff1a">DB<span class="_ _35"> </span></span>structure. <span class="_ _35"> </span>Then<span class="_ _35"> </span>we <span class="_ _42"> </span>return <span class="_ _23"></span>the <span class="_ _23"> </span>offset <span class="_ _23"> </span>of <span class="_ _42"> </span>the <span class="_ _23"> </span>next <span class="_ _42"> </span>recor<span class="_ _0"></span>d<span class="_ _35"> </span>in<span class="_ _35"> </span>the <span class="_ _42"> </span>hash</div><div class="t m0 x11a h49 y57b0 ff19 fs26 fc0 sc0 ls0 ws0">chain. <span class="_"> </span>Note<span class="_ _47"> </span>that we <span class="_ _2"></span>do <span class="_ _2"></span>not <span class="_ _2"></span>read the <span class="_ _2"></span>data <span class="_ _2"></span>recor<span class="_ _0"></span>d; that <span class="_ _2"></span>task <span class="_ _2"></span>is <span class="_ _2"></span>left <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>caller<span class="_ _6"></span>.</div><div class="t m0 x11a h4d y57b1 ff19 fs26 fc0 sc0 ls0 ws0">In <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">db_fetch<span class="_ _47"> </span></span>function, <span class="_ _3"></span>for <span class="_ _9"></span>example, <span class="_ _3"></span>we <span class="_ _9"></span>don’t <span class="_ _3"></span>read <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _9"></span>recor<span class="_ _0"></span><span class="ls164c">du<span class="_ _b"></span><span class="ls0">ntil</span></span></div><div class="t m0 x11a h4d y57b2 ff1a fs26 fc0 sc0 ls0 ws0">_db_find_and_lock<span class="_ _45"> </span><span class="ff19">has <span class="_ _23"></span>read <span class="_ _9"></span>the <span class="_ _9"></span>index <span class="_ _23"></span>recor<span class="_ _0"></span><span class="ls1697">dt<span class="_ _b"></span><span class="ls0">hat <span class="_ _9"></span>matches <span class="_ _23"></span>the <span class="_ _9"></span>key <span class="_ _23"></span>that</span></span></span></div><div class="t m0 x11a h49 y57b3 ff19 fs26 fc0 sc0 ls0 ws0">we’r<span class="lsd3">el<span class="_ _4f"></span><span class="ls0">ooking for<span class="_ _1"></span>.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
