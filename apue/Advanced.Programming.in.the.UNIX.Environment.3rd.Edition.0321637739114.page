<div id="pf72" class="pf w4 h1f" data-page-no="72"><div class="pc pc72 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg72.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">80<span class="_ _1b"> </span><span class="ff19">File <span class="_"> </span>I/O<span class="_ _169"> </span>Chapter <span class="_"> </span>3</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls0 ws0">The new ﬁle descriptor that <span class="_ _2"></span>is returned as the value of the <span class="_ _2"></span>functions shares the same</div><div class="t m0 x32 h2b y130 ff19 fsf fc0 sc0 ls0 ws0">ﬁle table entry as the<span class="_"> </span><span class="ff1b">fd<span class="_"> </span></span>argument. <span class="_"> </span>W<span class="_ _4"></span><span class="ls44">es<span class="_ _5"></span><span class="ls0">how this in Figur<span class="ls44">e3<span class="_ _4f"></span><span class="ls0">.9.</span></span></span></span></div><div class="t m0 x8a h2d yc57 ff19 fs10 fc0 sc0 ls0 ws0">process table entry</div><div class="t m0 x139 h80 yc58 ff19 fs3e fc0 sc0 ls3cf ws0">...</div><div class="t m0 x3f h81 yc59 ff19 fs3f fc0 sc0 ls0 ws0">fd 0:</div><div class="t m0 x3f h81 yc5a ff19 fs3f fc0 sc0 ls0 ws0">fd 1:</div><div class="t m0 x3f h81 yc5b ff19 fs3f fc0 sc0 ls0 ws0">fd 2:</div><div class="t m0 x3f h81 yc5c ff19 fs3f fc0 sc0 ls0 ws0">fd 3:</div><div class="t m0 x167 h82 yc5d ff19 fs40 fc0 sc0 ls0 ws0">fd</div><div class="t m0 x135 h82 yc5e ff19 fs40 fc0 sc0 ls0 ws0">ﬂags</div><div class="t m0 x137 h82 yc5d ff19 fs40 fc0 sc0 ls0 ws0">ﬁle</div><div class="t m0 x16e h82 yc5e ff19 fs40 fc0 sc0 ls0 ws0">pointer</div><div class="t m0 x87 h30 yc5f ff19 fs13 fc0 sc0 ls0 ws0">ﬁle status ﬂags</div><div class="t m0 x10f h31 yc60 ff19 fs14 fc0 sc0 ls0 ws0">current ﬁle of<span class="_ _0"></span>fset</div><div class="t m0 x87 h32 yc61 ff19 fs15 fc0 sc0 ls0 ws0">v-node pointer</div><div class="t m0 x88 h32 yc62 ff19 fs15 fc0 sc0 ls0 ws0">ﬁle table</div><div class="t m0 x168 h7f yc63 ff19 fs3d fc0 sc0 ls0 ws0">v-node information</div><div class="t m0 x11f h8c yc64 ff1a fs3d fc0 sc0 ls0 ws0">v_data</div><div class="t m0 x12 h7f yc65 ff19 fs3d fc0 sc0 ls0 ws0">i-node information</div><div class="t m0 xd4 h7f yc66 ff19 fs3d fc0 sc0 ls0 ws0">current ﬁle size</div><div class="t m0 x169 h8c yc67 ff1a fs3d fc0 sc0 ls0 ws0">i_vnode</div><div class="t m0 x16f h34 yc68 ff19 fs17 fc0 sc0 ls0 ws0">v-node table</div><div class="t m0 xbe h8d yc69 ff18 fs1a fc0 sc0 ls0 ws0">Figure 3.9<span class="_ _5a"> </span><span class="ff19">Kernel data structures after<span class="_"> </span><span class="ff1a">dup</span></span></div><div class="t m0 x170 h8d yc6a ff1a fs1a fc0 sc0 ls0 ws0">(</div><div class="t m0 x12c h8d yc69 ff1a fs1a fc0 sc0 ls0 ws0">1</div><div class="t m0 x98 h8d yc6a ff1a fs1a fc0 sc0 ls0 ws0">)</div><div class="t m0 x32 h8e yc6b ff19 fs47 fc0 sc0 ls0 ws0">In this ﬁgure, we assume that when it’s started, the pr<span class="_ _0"></span>ocess executes</div><div class="t m0 x3f h8f yc6c ff1a fs48 fc0 sc0 ls0 ws0">newfd = dup(1);</div><div class="t m0 x32 h8e yc6d ff19 fs47 fc0 sc0 ls3f8 ws0">We <span class="_ _80"> </span>a<span class="_ _9"></span><span class="ls0">ssume <span class="_ _2"></span>that <span class="_ _3"></span>the <span class="_ _3"></span>next <span class="_ _3"></span>available <span class="_ _2"></span>descriptor <span class="_ _3"></span>is <span class="_ _3"></span>3 <span class="_ _3"></span>(which <span class="_ _2"></span>it <span class="_ _3"></span>probably <span class="_ _2"></span>is, <span class="_ _3"></span>since <span class="_ _3"></span>0, <span class="_ _3"></span>1, <span class="_ _3"></span>and <span class="_ _2"></span>2</span></div><div class="t m0 x32 h8e yc6e ff19 fs47 fc0 sc0 ls0 ws0">ar<span class="ls3f9">eo<span class="_ _c"></span><span class="ls0">pened <span class="_ _42"> </span>by <span class="_ _42"> </span>the <span class="_ _42"> </span>shell).<span class="_ _51"> </span>Because <span class="_ _42"> </span>both <span class="_ _42"> </span>descriptors <span class="_ _42"> </span>point <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _23"> </span>same <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>table <span class="_ _42"> </span>entry<span class="_ _4"></span>,</span></span></div><div class="t m0 x32 h8e yc6f ff19 fs47 fc0 sc0 ls0 ws0">they <span class="_ _23"> </span>shar<span class="ls3fa">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>same <span class="_ _42"> </span>ﬁle <span class="_ _23"> </span>status <span class="_ _42"> </span>ﬂags<span class="_ _9"></span><span class="ls3fb">—r<span class="_ _6"></span><span class="ls0">ead, <span class="_ _23"> </span>write, <span class="_ _42"> </span>append, <span class="_ _23"> </span>and <span class="_ _42"> </span>so <span class="_ _23"> </span>on<span class="_ _9"></span><span class="ls3fb">—a<span class="_ _1"></span><span class="ls0">nd <span class="_ _23"> </span>the <span class="_ _42"> </span>same</span></span></span></span></span></span></div><div class="t m0 x32 h8e yc70 ff19 fs47 fc0 sc0 ls0 ws0">current ﬁle of<span class="_ _0"></span>fset.</div><div class="t m0 x3f h8e yc71 ff19 fs47 fc0 sc0 ls0 ws0">Each <span class="_ _35"> </span>descriptor <span class="_ _44"> </span>has <span class="_ _35"> </span>its <span class="_ _44"> </span>own <span class="_ _35"> </span>set <span class="_ _35"> </span>of <span class="_ _44"> </span>ﬁle <span class="_ _35"> </span>descriptor <span class="_ _44"> </span>ﬂags.<span class="_ _98"> </span>As <span class="_ _35"> </span>we <span class="_ _35"> </span>describe <span class="_ _44"> </span>in</div><div class="t m0 x32 h8e yc72 ff19 fs47 fc0 sc0 ls0 ws0">Section <span class="_"> </span>3.14, <span class="_"> </span>the <span class="_"> </span>close-on-exec <span class="_ _66"> </span>ﬁle <span class="_"> </span>descriptor <span class="_ _66"> </span>ﬂag <span class="_"> </span>for <span class="_ _66"> </span>the <span class="_"> </span>new <span class="_"> </span>descriptor <span class="_ _66"> </span>is <span class="_"> </span>always</div><div class="t m0 x32 h90 yc73 ff19 fs47 fc0 sc0 ls0 ws0">cleared by the<span class="_"> </span><span class="ff1a">dup<span class="_ _80"> </span></span>functions.</div><div class="t m0 x3f h90 yc74 ff19 fs47 fc0 sc0 ls0 ws0">Another <span class="_ _66"> </span>way <span class="_ _47"> </span>to <span class="_ _47"> </span>duplicate <span class="_ _66"> </span>a <span class="_ _47"> </span>descriptor <span class="_ _47"> </span>is <span class="_ _66"> </span>with <span class="_ _47"> </span>the<span class="_ _61"> </span><span class="ff1a">fcntl<span class="_ _61"> </span></span>function, <span class="_ _47"> </span>which <span class="_ _47"> </span>we</div><div class="t m0 x32 h8e yc75 ff19 fs47 fc0 sc0 ls0 ws0">describe in Section 3.14.<span class="_ _59"> </span>Indeed, the call</div><div class="t m0 x3f h8f yc76 ff1a fs48 fc0 sc0 ls0 ws0">dup(fd);</div><div class="t m0 x32 h8e yc77 ff19 fs47 fc0 sc0 ls0 ws0">is equivalent to</div><div class="t m0 x3f h8f yc78 ff1a fs48 fc0 sc0 ls0 ws0">fcntl(fd, F_DUPFD, 0);</div><div class="t m0 x32 h8e yc79 ff19 fs47 fc0 sc0 ls0 ws0">Similarly<span class="_ _4"></span><span class="ls3fc">,t<span class="_ _5"></span><span class="ls0">he call</span></span></div><div class="t m0 x3f h8f yc7a ff1a fs48 fc0 sc0 ls0 ws0">dup2(fd, fd2);</div><div class="t m0 x32 h8e yc7b ff19 fs47 fc0 sc0 ls0 ws0">is equivalent to</div><div class="t m0 x3f h8f yc7c ff1a fs48 fc0 sc0 ls0 ws0">close(fd2);</div><div class="t m0 x3f h8f yc7d ff1a fs48 fc0 sc0 ls0 ws0">fcntl(fd, F_DUPFD, fd2);</div><div class="t m0 x32 h90 yc7e ff19 fs47 fc0 sc0 ls0 ws0">In <span class="_ _23"></span>this <span class="_ _23"></span>last <span class="_ _23"></span>case, <span class="_ _23"></span>the<span class="_ _35"> </span><span class="ff1a">dup2<span class="_ _45"> </span></span>is <span class="_ _23"> </span>not <span class="_ _23"> </span>exactly <span class="_ _23"> </span>the <span class="_ _23"> </span>same <span class="_ _23"> </span>as <span class="_ _23"> </span>a<span class="_ _35"> </span><span class="ff1a">close<span class="_ _35"> </span></span>followed <span class="_ _23"></span>by <span class="_ _23"></span>an<span class="_ _45"> </span><span class="ff1a">fcntl</span>.</div><div class="t m0 x32 h8e yc7f ff19 fs47 fc0 sc0 ls0 ws0">The differ<span class="_ _0"></span>ences ar<span class="_ _0"></span>e<span class="_"> </span>as<span class="_"> </span>follows:</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
