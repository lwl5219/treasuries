<div id="pf2f3" class="pf w4 h1f" data-page-no="2f3"><div class="pc pc2f3 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg2f3.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>19.2<span class="_ _2e2"> </span>Overview<span class="_ _1b"> </span><span class="ff18">721</span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Running Coprocesses</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _3"></span>the <span class="_ _3"></span>coprocess <span class="_ _3"></span>example <span class="_ _3"></span>in <span class="_ _9"></span>Figur<span class="ls23c">e1<span class="_ _b"></span><span class="ls0">5.19, <span class="_ _3"></span>we <span class="_ _9"></span>couldn’t <span class="_ _3"></span>invoke <span class="_ _3"></span>a <span class="_ _9"></span>coprocess <span class="_ _2"></span>that <span class="_ _9"></span>used <span class="_ _3"></span>the</span></span></div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">standar<span class="ls479">dI<span class="_ _8"></span><span class="ls0">/O <span class="_ _2"></span>library <span class="_ _3"></span>for <span class="_ _3"></span>its <span class="_ _2"></span>input <span class="_ _3"></span>and <span class="_ _3"></span>output, <span class="_ _2"></span>because <span class="_ _3"></span>when <span class="_ _3"></span>we <span class="_ _2"></span>talked <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _2"></span>coprocess</span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">across <span class="_ _3"></span>a <span class="_ _9"></span>pipe, <span class="_ _9"></span>the <span class="_ _9"></span>standar<span class="ls2a0">dI<span class="_ _b"></span><span class="ls0">/O <span class="_ _9"></span>library <span class="_ _9"></span>fully <span class="_ _9"></span>buffered <span class="_ _3"></span>the <span class="_ _9"></span>standar<span class="lseed">di<span class="_ _b"></span><span class="ls0">nput <span class="_ _9"></span>and <span class="_ _9"></span>standard</span></span></span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">output, <span class="_ _42"> </span>leading <span class="_ _42"> </span>to <span class="_ _42"> </span>a <span class="_ _42"> </span>deadlock.<span class="_ _51"> </span>If <span class="_ _42"> </span>the <span class="_ _42"> </span>coprocess <span class="_ _42"> </span>is <span class="_ _42"> </span>a <span class="_ _42"> </span>compiled <span class="_ _42"> </span>program <span class="_ _23"> </span>for <span class="_ _42"> </span>which <span class="_ _42"> </span>we</div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls0 ws0">don’t <span class="_ _53"> </span>have <span class="_ _53"> </span>the <span class="_ _53"> </span>source <span class="_ _42"> </span>code, <span class="_ _e"> </span>we <span class="_ _53"> </span>can’t <span class="_ _53"> </span>add<span class="_ _4b"> </span><span class="ff1a">fflush<span class="_ _44"> </span></span>statements <span class="_ _53"> </span>to <span class="_ _53"> </span>solve <span class="_ _e"> </span>this <span class="_ _53"> </span>problem.</div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls157a">e1<span class="_ _55"></span><span class="ls0">5.16 <span class="_ _53"> </span>showed <span class="_ _e"> </span>a <span class="_ _53"> </span>process <span class="_ _53"> </span>driving <span class="_ _53"> </span>a <span class="_ _53"> </span>coprocess. <span class="_ _4b"> </span>What<span class="_ _44"> </span>we <span class="_ _e"> </span>need <span class="_ _53"> </span>to <span class="_ _e"> </span>do <span class="_ _53"> </span>is <span class="_ _e"> </span>place <span class="_ _53"> </span>a</span></span></div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">pseudo <span class="_"> </span>terminal <span class="_ _47"> </span>between <span class="_"> </span>the <span class="_ _47"> </span>two <span class="_"> </span>processes, <span class="_ _66"> </span>as <span class="_ _66"> </span>shown <span class="_ _47"> </span>in <span class="_"> </span>Figur<span class="ls157b">e1<span class="_ _5b"></span><span class="ls0">9.6, <span class="_ _66"> </span>to <span class="_ _47"> </span>trick <span class="_"> </span>the</span></span></div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">coprocess <span class="_ _3"></span>into <span class="_ _9"></span>thinking <span class="_ _23"></span>that <span class="_ _3"></span>it <span class="_ _23"></span>is <span class="_ _9"></span>being <span class="_ _9"></span>driven <span class="_ _9"></span>from <span class="_ _3"></span>a <span class="_ _9"></span>terminal <span class="_ _23"></span>instead <span class="_ _9"></span>of <span class="_ _9"></span>from <span class="_ _3"></span>another</div><div class="t m0 x32 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">process.</div><div class="t m0 xb9 h2d y534b ff19 fs10 fc0 sc0 ls0 ws0">driving</div><div class="t m0 x6 h2d y534c ff19 fs10 fc0 sc0 ls0 ws0">program</div><div class="t m0 x19a h2e y534d ff19 fs11 fc0 sc0 ls0 ws0">pseudo</div><div class="t m0 x18c h2e y534e ff19 fs11 fc0 sc0 ls0 ws0">terminal</div><div class="t m0 xbb h2f y534f ff19 fs12 fc0 sc0 ls0 ws0">coprocess</div><div class="t m0 xfd hd1 y5350 ff1b fs12 fc0 sc0 ls0 ws0">stdin</div><div class="t m0 xfd hd1 y5351 ff1b fs12 fc0 sc0 ls0 ws0">stdout</div><div class="t m0 x127 h30 y5352 ff19 fs13 fc0 sc0 ls0 ws0">pipe1</div><div class="t m0 x127 h31 y5353 ff19 fs14 fc0 sc0 ls0 ws0">pipe2</div><div class="t m0 x161 h33 y5354 ff18 fs16 fc0 sc0 ls0 ws0">Figure 19.6<span class="_ _5a"> </span><span class="ff19">Driving a coprocess using a pseudo terminal</span></div><div class="t m0 x32 hc5 y5355 ff19 fs6a fc0 sc0 ls0 ws0">Now <span class="_ _e"> </span>the <span class="_"> </span>standar<span class="_ _1"></span><span class="ls157c">di<span class="_ _55"></span><span class="ls0">nput <span class="_"> </span>and <span class="_ _e"> </span>standar<span class="ls157c">do<span class="_ _4a"></span><span class="ls0">utput <span class="_"> </span>of <span class="_ _53"> </span>the <span class="_"> </span>copr<span class="_ _0"></span>ocess <span class="_ _e"> </span>look <span class="_ _e"> </span>like <span class="_"> </span>a <span class="_ _53"> </span>terminal</span></span></span></span></div><div class="t m0 x32 hc5 y5356 ff19 fs6a fc0 sc0 ls0 ws0">device, so the standar<span class="ls117f">dI<span class="_ _4f"></span><span class="ls0">/O library will set these two streams to be line buffer<span class="_ _0"></span>ed.</span></span></div><div class="t m0 x3f hc5 y5357 ff19 fs6a fc0 sc0 ls0 ws0">The <span class="_ _23"> </span>parent <span class="_ _23"> </span>can <span class="_ _42"> </span>obtain <span class="_ _23"> </span>a <span class="_ _23"> </span>pseudo <span class="_ _42"> </span>terminal <span class="_ _23"> </span>between <span class="_ _42"> </span>itself <span class="_ _23"> </span>and <span class="_ _42"> </span>the <span class="_ _23"> </span>coprocess <span class="_ _23"> </span>in <span class="_ _23"> </span>two</div><div class="t m0 x32 hc5 y5358 ff19 fs6a fc0 sc0 ls0 ws0">ways. <span class="_ _45"> </span>(The<span class="_ _35"> </span>parent <span class="_ _9"></span>in <span class="_ _23"></span>this <span class="_ _23"></span>case <span class="_ _9"></span>could <span class="_ _23"></span>be <span class="_ _23"></span>the <span class="_ _9"></span>program <span class="_ _23"></span>in <span class="_ _9"></span>Figur<span class="ls157d">e1<span class="_ _b"></span><span class="ls0">5.18, <span class="_ _9"></span>which <span class="_ _23"></span>used <span class="_ _23"></span>two</span></span></div><div class="t m0 x32 hc5 y5359 ff19 fs6a fc0 sc0 ls0 ws0">pipes <span class="_ _66"> </span>to <span class="_ _47"> </span>communicate <span class="_ _66"> </span>with <span class="_ _47"> </span>the <span class="_ _66"> </span>coprocess.) <span class="_ _61"> </span>One<span class="_ _61"> </span>way <span class="_ _66"> </span>is <span class="_ _47"> </span>for <span class="_ _66"> </span>the <span class="_ _47"> </span>parent <span class="_"> </span>to <span class="_ _47"> </span>call <span class="_ _66"> </span>the</div><div class="t m0 x32 hc8 y535a ff1a fs6a fc0 sc0 ls0 ws0">pty_fork<span class="_ _47"> </span><span class="ff19">function <span class="_ _9"></span>directly <span class="_ _3"></span>(Section <span class="_ _9"></span>19.4) <span class="_ _9"></span>instead <span class="_ _3"></span>of <span class="_ _9"></span>calling<span class="_ _45"> </span></span>fork<span class="ff19 ls157e">.A<span class="_ _62"></span><span class="ls0">nother <span class="_ _3"></span>is <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">exec</span></span></span></div><div class="t m0 x32 hc8 y535b ff19 fs6a fc0 sc0 ls0 ws0">the<span class="_ _45"> </span><span class="ff1a">pty<span class="_ _47"> </span></span>program <span class="_ _3"></span>(Section <span class="_ _9"></span>19.5) <span class="_ _9"></span>with <span class="_ _9"></span>the <span class="_ _3"></span>coprocess <span class="_ _3"></span>as <span class="_ _9"></span>its <span class="_ _9"></span>argument. <span class="_ _47"> </span>W<span class="_ _6"></span>e’ll <span class="_ _9"></span>look <span class="_ _9"></span>at <span class="_ _9"></span>these</div><div class="t m0 x32 hc8 y535c ff19 fs6a fc0 sc0 ls0 ws0">two solutions after showing the<span class="_"> </span><span class="ff1a">pty<span class="_ _80"> </span></span>program.</div><div class="t m0 x35 h184 y535d ff16 fs6a fc0 sc0 ls157f ws0">Wa<span class="_ _2"></span><span class="ls0">tching the Output of Long-Running Programs</span></div><div class="t m0 x32 hc5 y535e ff19 fs6a fc0 sc0 ls0 ws0">If <span class="_ _3"></span>we <span class="_ _3"></span>have <span class="_ _9"></span>a <span class="_ _3"></span>program <span class="_ _3"></span>that <span class="_ _3"></span>runs <span class="_ _9"></span>for <span class="_ _3"></span>a <span class="_ _3"></span>long <span class="_ _9"></span>time, <span class="_ _3"></span>we <span class="_ _9"></span>can <span class="_ _3"></span>easily <span class="_ _3"></span>run <span class="_ _9"></span>it <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _9"></span>background</div><div class="t m0 x32 hc5 y535f ff19 fs6a fc0 sc0 ls0 ws0">using <span class="_ _9"></span>any <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>standar<span class="ls1580">ds<span class="_ _b"></span><span class="ls0">hells. <span class="_ _45"> </span>Unfortunately<span class="_ _4"></span>,<span class="_ _45"> </span>if<span class="_ _45"> </span>we<span class="_ _47"> </span>redirect <span class="_ _3"></span>its <span class="_ _9"></span>standar<span class="ls1581">do<span class="_ _b"></span><span class="ls0">utput <span class="_ _9"></span>to <span class="_ _3"></span>a</span></span></span></span></div><div class="t m0 x32 hc5 y5360 ff19 fs6a fc0 sc0 ls0 ws0">ﬁle, and if it doesn’t generate much output, we can’t easily monitor its <span class="_ _2"></span>progr<span class="_ _1"></span>ess, because</div><div class="t m0 x32 hc5 y5361 ff19 fs6a fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>standar<span class="ls1582">dI<span class="_ _55"></span><span class="ls0">/O <span class="_ _53"> </span>library <span class="_ _53"> </span>will <span class="_ _53"> </span>fully <span class="_ _53"> </span>buffer <span class="_ _53"> </span>its <span class="_ _53"> </span>standar<span class="ls1583">do<span class="_ _55"></span><span class="ls0">utput. <span class="_ _4b"> </span>All<span class="_ _44"> </span>that <span class="_ _53"> </span>we’ll <span class="_ _53"> </span>see <span class="_ _53"> </span>are</span></span></span></span></div><div class="t m0 x32 hc5 y5362 ff19 fs6a fc0 sc0 ls0 ws0">blocks <span class="_ _e"> </span>of <span class="_ _e"> </span>output <span class="_"> </span>written <span class="_ _53"> </span>by <span class="_ _e"> </span>the <span class="_"> </span>standar<span class="_ _0"></span><span class="ls1584">dI<span class="_ _4a"></span><span class="ls0">/O <span class="_"> </span>library <span class="_ _53"> </span>to <span class="_"> </span>the <span class="_ _53"> </span>output <span class="_"> </span>ﬁle, <span class="_ _53"> </span>possibly <span class="_ _e"> </span>in</span></span></div><div class="t m0 x32 hc5 y5363 ff19 fs6a fc0 sc0 ls0 ws0">chunks as large as 8,192 bytes.</div><div class="t m0 x3f hc8 y5364 ff19 fs6a fc0 sc0 ls0 ws0">If <span class="_ _2"></span>we <span class="_ _3"></span>have <span class="_ _2"></span>the <span class="_ _3"></span>source code, <span class="_ _3"></span>we <span class="_ _2"></span>can <span class="_ _3"></span>insert <span class="_ _3"></span>calls <span class="_ _2"></span>to<span class="_ _47"> </span><span class="ff1a">fflush<span class="_ _47"> </span></span>to <span class="_ _2"></span>force <span class="_ _2"></span>the <span class="_ _2"></span>standar<span class="ls1585">dI<span class="_ _4f"></span><span class="ls0">/O</span></span></div><div class="t m0 x32 hc5 y5365 ff19 fs6a fc0 sc0 ls0 ws0">buffers to be ﬂushed at select points or change <span class="_ _2"></span>the buffering mode to line buffered using</div><div class="t m0 x32 hc8 y5366 ff1a fs6a fc0 sc0 ls0 ws0">setvbuf<span class="ff19 ls1586">.I<span class="_ _26"></span><span class="ls1587">fw<span class="_ _b"></span><span class="ls1588">ed<span class="_ _b"></span><span class="ls0">on’t <span class="_ _9"></span>have <span class="_ _23"></span>the <span class="_ _9"></span>source <span class="_ _9"></span>code, <span class="_ _9"></span>however<span class="_ _1"></span>,<span class="_ _45"> </span>we<span class="_ _45"> </span>can <span class="_ _23"></span>run <span class="_ _9"></span>the <span class="_ _9"></span>program <span class="_ _9"></span>under</span></span></span></span></div><div class="t m0 x32 hc8 y5367 ff19 fs6a fc0 sc0 ls0 ws0">the<span class="_ _35"> </span><span class="ff1a">pty<span class="_ _35"> </span></span>program, <span class="_ _23"> </span>making <span class="_ _23"> </span>its <span class="_ _42"> </span>standar<span class="ls1589">dI<span class="_ _43"></span><span class="ls0">/O <span class="_ _23"></span>library <span class="_ _23"> </span>think <span class="_ _42"> </span>that <span class="_ _23"> </span>its <span class="_ _42"> </span>standar<span class="ls158a">do<span class="_ _43"></span><span class="ls0">utput <span class="_ _23"></span>is <span class="_ _23"> </span>a</span></span></span></span></div><div class="t m0 x32 hc5 y5368 ff19 fs6a fc0 sc0 ls0 ws0">terminal. <span class="_ _35"> </span>Figur<span class="ls158b">e1<span class="_ _43"></span><span class="ls0">9.7 <span class="_ _23"></span>shows <span class="_ _23"></span>this <span class="_ _23"></span>arrangement, <span class="_ _23"> </span>where<span class="_ _45"> </span>we<span class="_ _35"> </span>have <span class="_ _23"> </span>called <span class="_ _42"> </span>the <span class="_ _23"></span>slow <span class="_ _23"></span>output</span></span></div><div class="t m0 x32 hc8 y5369 ff19 fs6a fc0 sc0 ls0 ws0">program<span class="_ _45"> </span><span class="ff1a">slowout</span><span class="ls158c">.T<span class="_ _26"></span><span class="ls0">he<span class="_ _35"> </span><span class="ff1a">fork/exec<span class="_ _45"> </span></span>arrow <span class="_ _23"></span>from <span class="_ _9"></span>the <span class="_ _23"> </span>login <span class="_ _23"> </span>shell <span class="_ _23"> </span>to <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">pty<span class="_ _35"> </span></span>pr<span class="_ _0"></span>ocess <span class="_ _23"></span>is</span></span></div><div class="t m0 x32 hc8 y536a ff19 fs6a fc0 sc0 ls0 ws0">shown as a dashed <span class="_ _2"></span>arrow to emphasize that the<span class="_ _66"> </span><span class="ff1a">pty<span class="_ _66"> </span></span>process is running as a background</div><div class="t m0 x32 hc5 y536b ff19 fs6a fc0 sc0 ls0 ws0">job.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
