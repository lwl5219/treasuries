<div id="pf3cb" class="pf w4 h1f" data-page-no="3cb"><div class="pc pc3cb w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg3cb.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Appendix <span class="_"> </span>C<span class="_ _89"> </span>Chapter <span class="_"> </span>15<span class="_ _54"> </span>Solutions<span class="_ _1b"> </span><span class="ff18">937</span></div><div class="t m0 xe2 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">signal <span class="_ _9"></span>handler<span class="_ _6"></span>,<span class="_ _45"> </span><span class="ff1a">write<span class="_ _45"> </span></span>fails <span class="_ _3"></span>with<span class="_ _45"> </span><span class="ff1a">errno<span class="_ _45"> </span></span>set <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">EPIPE</span><span class="ls5c4">.W<span class="_ _52"></span><span class="ls0">ith<span class="_ _45"> </span><span class="ff1a">poll</span><span class="ls1874">,h<span class="_ _b"></span><span class="ls0">owever<span class="_ _1"></span><span class="ls1874">,t<span class="_ _b"></span><span class="ls0">he</span></span></span></span></span></span></div><div class="t m0 xe2 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">behavior varies by platform.</div><div class="t m0 x32 h2a y114d ff18 fsf fc0 sc0 ls0 ws0">15.8<span class="_ _210"> </span><span class="ff19">Anything <span class="_ _23"> </span>written <span class="_ _42"> </span>by <span class="_ _23"></span>the <span class="_ _23"></span>child <span class="_ _23"></span>to <span class="_ _23"></span>standar<span class="ls1218">de<span class="_ _43"></span><span class="ls0">rror <span class="_ _9"></span>appears <span class="_ _23"> </span>wherever <span class="_ _23"> </span>the <span class="_ _23"> </span>parent’s</span></span></span></div><div class="t m0 xe2 h2a y114e ff19 fsf fc0 sc0 ls0 ws0">standar<span class="ls1219">de<span class="_ _8"></span><span class="ls0">rror <span class="_ _2"></span>would <span class="_ _2"></span>appear<span class="_ _1"></span><span class="ls121a">.T<span class="_ _7"></span><span class="ls1219">os<span class="_ _4f"></span><span class="ls0">end <span class="_ _2"></span>standar<span class="ls1875">de<span class="_ _4f"></span><span class="ls0">rror back <span class="_ _3"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>parent, <span class="_ _2"></span>include</span></span></span></span></span></span></span></div><div class="t m0 xe2 h26 y2936 ff19 fsf fc0 sc0 ls0 ws0">the shell redir<span class="_ _0"></span>ection<span class="_"> </span><span class="ff1a">2&gt;&amp;1<span class="_ _80"> </span></span>in the<span class="_"> </span><span class="ff1b">cmdstring</span>.</div><div class="t m0 x32 h26 y1150 ff18 fsf fc0 sc0 ls0 ws0">15.9<span class="_ _210"> </span><span class="ff19">The<span class="_ _47"> </span><span class="ff1a">popen<span class="_ _47"> </span></span>function<span class="_ _47"> </span><span class="ff1a">fork</span><span class="ls52b">sac<span class="_ _4f"></span><span class="ls0">hild, <span class="_ _2"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>child <span class="_ _3"></span>executes <span class="_ _2"></span>the <span class="_ _3"></span>shell.<span class="_ _16"> </span>The <span class="_ _2"></span>shell <span class="_ _3"></span>in</span></span></span></div><div class="t m0 xe2 h26 y296d ff19 fsf fc0 sc0 ls0 ws0">turn <span class="_ _9"></span>calls<span class="_ _45"> </span><span class="ff1a">fork</span><span class="ls1876">,a<span class="_ _b"></span><span class="ls0">nd <span class="_ _9"></span>the <span class="_ _23"></span>child <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>shell <span class="_ _9"></span>executes <span class="_ _23"></span>the <span class="_ _9"></span>command <span class="_ _9"></span>string.<span class="_ _5a"> </span>When</span></span></div><div class="t m0 xe2 h2b y1151 ff1b fsf fc0 sc0 ls0 ws0">cmdstring<span class="_ _66"> </span><span class="ff19">terminates, <span class="_ _3"></span>the <span class="_ _2"></span>shell <span class="_ _2"></span>is <span class="_ _3"></span>waiting <span class="_ _2"></span>for <span class="_ _2"></span>this <span class="_ _3"></span>to <span class="_ _2"></span>happen.<span class="_ _61"> </span>The <span class="_ _3"></span>shell <span class="_ _2"></span>then <span class="_ _2"></span>exits,</span></div><div class="t m0 xe2 h26 y1152 ff19 fsf fc0 sc0 ls0 ws0">which is what the<span class="_"> </span><span class="ff1a">waitpid<span class="_ _80"> </span></span>in<span class="_"> </span><span class="ff1a">pclose<span class="_ _66"> </span></span>is waiting for<span class="_ _6"></span>.</div><div class="t m0 x32 h26 y1d3 ff18 fsf fc0 sc0 ls0 ws0">15.10<span class="_ _5f"> </span><span class="ff19">The <span class="_ _9"></span>trick <span class="_ _9"></span>is <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">open<span class="_ _45"> </span></span>the <span class="_ _9"></span>FIFO <span class="_ _9"></span>twice: <span class="_ _9"></span>once <span class="_ _9"></span>for <span class="_ _23"></span>reading <span class="_ _3"></span>and <span class="_ _9"></span>once <span class="_ _23"></span>for <span class="_ _9"></span>writing.<span class="_ _5a"> </span><span class="ls5f">We</span></span></div><div class="t m0 xe2 h2a y1d4 ff19 fsf fc0 sc0 ls0 ws0">never <span class="_ _23"></span>use <span class="_ _23"> </span>the <span class="_ _23"> </span>descriptor <span class="_ _23"> </span>that <span class="_ _23"> </span>is <span class="_ _42"> </span>opened <span class="_ _23"></span>for <span class="_ _23"></span>writing, <span class="_ _23"></span>but <span class="_ _23"> </span>leaving <span class="_ _23"> </span>that <span class="_ _23"> </span>descriptor</div><div class="t m0 xe2 h2a y38a ff19 fsf fc0 sc0 ls0 ws0">open <span class="_ _23"></span>prevents <span class="_ _9"></span>an <span class="_ _23"> </span>end <span class="_ _23"> </span>of <span class="_ _23"> </span>ﬁle <span class="_ _23"> </span>from <span class="_ _23"></span>being <span class="_ _23"></span>generated <span class="_ _23"></span>when <span class="_ _23"></span>the <span class="_ _23"></span>number <span class="_ _23"></span>of <span class="_ _23"></span>clients</div><div class="t m0 xe2 h2a y3550 ff19 fsf fc0 sc0 ls0 ws0">goes <span class="_ _9"></span>from <span class="_ _3"></span>1 <span class="_ _9"></span>to <span class="_ _9"></span>0.<span class="_ _16"> </span>Opening <span class="_ _9"></span>the <span class="_ _9"></span>FIFO <span class="_ _9"></span>twice <span class="_ _9"></span>requir<span class="_ _0"></span>es <span class="_ _9"></span>some <span class="_ _3"></span>care, <span class="_ _9"></span>as <span class="_ _9"></span>a <span class="_ _9"></span>nonblocking</div><div class="t m0 xe2 h26 y3551 ff1a fsf fc0 sc0 ls0 ws0">open<span class="_ _45"> </span><span class="ff19">is <span class="_ _9"></span>required. <span class="_ _47"> </span>W<span class="_ _6"></span><span class="ls6a9">eh<span class="_ _b"></span><span class="ls0">ave <span class="_ _23"></span>to <span class="_ _9"></span>do <span class="_ _9"></span>a <span class="_ _9"></span>nonblocking, <span class="_ _23"></span>r<span class="_ _0"></span>ead-only<span class="_ _45"> </span><span class="ff1a">open<span class="_ _45"> </span></span>ﬁrst, <span class="_ _9"></span>followed</span></span></span></div><div class="t m0 xe2 h26 y3552 ff19 fsf fc0 sc0 ls0 ws0">by <span class="_ _23"> </span>a <span class="_ _42"> </span>blocking<span class="_ _35"> </span><span class="ff1a">open<span class="_ _35"> </span></span>for <span class="_ _42"> </span>write-only<span class="_ _4"></span><span class="ls1877">.(<span class="_ _7"></span><span class="ls0">If <span class="_ _42"> </span>we <span class="_ _23"> </span>tried <span class="_ _42"> </span>a <span class="_ _23"> </span>nonblocking<span class="_ _44"> </span><span class="ff1a">open<span class="_ _35"> </span></span>for <span class="_ _23"> </span>write-</span></span></div><div class="t m0 xe2 h2a y3553 ff19 fsf fc0 sc0 ls0 ws0">only <span class="_ _23"></span>ﬁrst, <span class="_ _9"></span>it <span class="_ _23"> </span>would <span class="_ _23"></span>return <span class="_ _9"></span>an <span class="_ _23"></span>error<span class="_ _6"></span>.) <span class="_ _45"> </span>W<span class="_ _6"></span><span class="ls13b4">et<span class="_ _b"></span><span class="ls0">hen <span class="_ _23"></span>turn <span class="_ _9"></span>of<span class="ls13b4">fn<span class="_ _b"></span><span class="ls0">onblocking <span class="_ _9"></span>for <span class="_ _23"></span>the <span class="_ _23"></span>r<span class="_ _0"></span>ead</span></span></span></span></div><div class="t m0 xe2 h2a y1d9 ff19 fsf fc0 sc0 ls0 ws0">descriptor<span class="_ _6"></span><span class="ls86">.F<span class="_ _4a"></span><span class="ls0">igur<span class="ls44">eC<span class="_ _d"></span><span class="ls0">.20 shows the code for this.</span></span></span></span></div><div class="t m0 xe2 h4e y6288 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 xe2 h4e y6289 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 xe2 h4e y628a ff1a fs28 fc0 sc0 ls0 ws0">#define FIFO<span class="_ _15"> </span>&quot;temp.fifo&quot;</div><div class="t m0 xe2 h4e y628b ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 xe2 h4e y628c ff1a fs28 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 xe2 h4e y628d ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x60 h4e y628e ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>fdread,<span class="_"> </span>fdwrite;</div><div class="t m0 x60 h4e y628f ff1a fs28 fc0 sc0 ls0 ws0">unlink(FIFO);</div><div class="t m0 x60 h4e y6290 ff1a fs28 fc0 sc0 ls0 ws0">if (mkfifo(FIFO, FILE_MODE) &lt; 0)</div><div class="t m0 xb9 h4e y6291 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;mkfifo error&quot;);</div><div class="t m0 x60 h4e y6292 ff1a fs28 fc0 sc0 ls0 ws0">if ((fdread = open(FIFO, O_RDONLY | O_NONBLOCK)) &lt; 0)</div><div class="t m0 xb9 h4e y6293 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;open error for reading&quot;);</div><div class="t m0 x60 h4e y6294 ff1a fs28 fc0 sc0 ls0 ws0">if ((fdwrite = open(FIFO, O_WRONLY)) &lt; 0)</div><div class="t m0 xb9 h4e y6295 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;open error for writing&quot;);</div><div class="t m0 x60 h4e y6296 ff1a fs28 fc0 sc0 ls0 ws0">clr_fl(fdread, O_NONBLOCK);</div><div class="t m0 x60 h4e y6297 ff1a fs28 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 xe2 h4e y6298 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 xda h2e y6299 ff18 fs11 fc0 sc0 ls0 ws0">Figure C.20<span class="_ _5a"> </span><span class="ff19">Opening a FIFO for reading and writing, without blocking</span></div><div class="t m0 x32 h55 y629a ff18 fs2c fc0 sc0 ls0 ws0">15.1<span class="_ _0"></span>1<span class="_ _1a3"> </span><span class="ff19">Randomly <span class="_ _e"> </span>reading <span class="_ _53"> </span>a <span class="_"> </span>message <span class="_ _53"> </span>from <span class="_ _e"> </span>an <span class="_ _e"> </span>active <span class="_ _e"> </span>queue <span class="_ _e"> </span>would <span class="_ _e"> </span>interfer<span class="ls1878">ew<span class="_ _55"></span><span class="ls0">ith <span class="_ _e"> </span>the</span></span></span></div><div class="t m0 xe2 h55 y629b ff19 fs2c fc0 sc0 ls0 ws0">client–server <span class="_ _9"></span>protocol, <span class="_ _3"></span>as <span class="_ _9"></span>either <span class="_ _3"></span>a <span class="_ _9"></span>client <span class="_ _9"></span>request <span class="_ _3"></span>or <span class="_ _9"></span>a <span class="_ _9"></span>server<span class="_ _9"></span>’s <span class="_ _3"></span>response <span class="_ _9"></span>would <span class="_ _3"></span>be</div><div class="t m0 xe2 h55 y629c ff19 fs2c fc0 sc0 ls0 ws0">lost. <span class="_"> </span>T<span class="_ _6"></span><span class="ls1879">or<span class="_ _4f"></span><span class="ls0">ead <span class="_ _2"></span>the queue, <span class="_ _2"></span>all that is <span class="_ _2"></span>needed is <span class="_ _2"></span>for the process to <span class="_ _2"></span>know the identiﬁer</span></span></div><div class="t m0 xe2 h55 y629d ff19 fs2c fc0 sc0 ls0 ws0">for the queue and for the queue to allow world-read access.</div><div class="t m0 x32 h55 y629e ff18 fs2c fc0 sc0 ls0 ws0">15.13<span class="_ _5f"> </span><span class="ff19 ls155">We <span class="_ _80"> </span>n<span class="_ _9"></span><span class="ls0">ever <span class="_ _3"></span>stor<span class="lsf26">ea<span class="_ _8"></span><span class="ls0">ctual <span class="_ _3"></span>addresses <span class="_ _3"></span>in <span class="_ _3"></span>a <span class="_ _3"></span>shared <span class="_ _2"></span>memory <span class="_ _9"></span>segment, <span class="_ _3"></span>since <span class="_ _3"></span>it’s <span class="_ _3"></span>possible</span></span></span></span></div><div class="t m0 xe2 h55 y629f ff19 fs2c fc0 sc0 ls0 ws0">for <span class="_ _53"> </span>the <span class="_ _53"> </span>server <span class="_ _53"> </span>and <span class="_ _53"> </span>all <span class="_ _e"> </span>the <span class="_ _53"> </span>clients <span class="_ _53"> </span>to <span class="_ _53"> </span>attach <span class="_ _53"> </span>the <span class="_ _e"> </span>segment <span class="_ _53"> </span>at <span class="_ _53"> </span>different <span class="_ _42"> </span>addresses.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
