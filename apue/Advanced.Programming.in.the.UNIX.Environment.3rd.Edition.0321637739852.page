<div id="pf354" class="pf w4 h1f" data-page-no="354"><div class="pc pc354 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg354.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">818<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">168 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">169 <span class="_ _68"> </span>*<span class="_"> </span>Initialize the job ID file.<span class="_ _3a"> </span>Use a record lock to prevent</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">170 <span class="_ _68"> </span>*<span class="_"> </span>more than one printer daemon from running at a time.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">171 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">172 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none, except for record-lock on job ID file.</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">173 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">174 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">175 <span class="_ _d9"> </span>init_request(void)</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">176 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">177 <span class="_ _15"> </span>int <span class="_ _15"> </span>n;</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">178 <span class="_ _15"> </span>char<span class="_ _15"> </span>name[FILENMSZ];</div><div class="t m0 x32 h57 y1d7f ff1a fs2d fc0 sc0 ls0 ws0">179 <span class="_ _15"> </span>sprintf(name,<span class="_"> </span>&quot;%s/%s&quot;, SPOOLDIR, JOBFILE);</div><div class="t m0 x32 h57 y1d80 ff1a fs2d fc0 sc0 ls0 ws0">180 <span class="_ _15"> </span>jobfd<span class="_"> </span><span class="ls15c">=o<span class="_ _1d"></span><span class="ls0">pen(name, O_CREAT|O_RDWR, S_IRUSR|S_IWUSR);</span></span></div><div class="t m0 x32 h57 y2c5b ff1a fs2d fc0 sc0 ls0 ws0">181 <span class="_ _15"> </span>if<span class="_"> </span>(write_lock(jobfd, 0, SEEK_SET, 0) &lt; 0)</div><div class="t m0 x32 h57 y2c5c ff1a fs2d fc0 sc0 ls0 ws0">182 <span class="_ _186"> </span>log_quit(&quot;daemon<span class="_"> </span>already running&quot;);</div><div class="t m0 x32 h57 y4588 ff1a fs2d fc0 sc0 ls0 ws0">183 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y4589 ff1a fs2d fc0 sc0 ls0 ws0">184 <span class="_ _8a"> </span>*<span class="_"> </span>Reuse the name buffer for the job counter.</div><div class="t m0 x32 h57 y2ad7 ff1a fs2d fc0 sc0 ls0 ws0">185 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2ad8 ff1a fs2d fc0 sc0 ls0 ws0">186 <span class="_ _15"> </span>if<span class="_"> </span>((n = read(jobfd, name, FILENMSZ)) &lt; 0)</div><div class="t m0 x32 h57 y2ad9 ff1a fs2d fc0 sc0 ls0 ws0">187 <span class="_ _186"> </span>log_sys(&quot;can’t<span class="_"> </span>read job file&quot;);</div><div class="t m0 x32 h57 y4d71 ff1a fs2d fc0 sc0 ls0 ws0">188 <span class="_ _15"> </span>if<span class="_"> </span>(n == 0)</div><div class="t m0 x32 h57 y4d72 ff1a fs2d fc0 sc0 ls0 ws0">189 <span class="_ _186"> </span>nextjob<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y4d73 ff1a fs2d fc0 sc0 ls0 ws0">190 <span class="_ _15"> </span>else</div><div class="t m0 x32 h57 y2c64 ff1a fs2d fc0 sc0 ls0 ws0">191 <span class="_ _186"> </span>nextjob<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">tol(name);</span></span></div><div class="t m0 x32 h57 y2c65 ff1a fs2d fc0 sc0 ls0 ws0">192 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y5bb2 ff19 fs26 fc0 sc0 ls0 ws0">[168 <span class="_ _a"></span>– <span class="_ _a"></span>182]<span class="_ _65"> </span>The<span class="_ _47"> </span><span class="ff1a">init_request<span class="_ _47"> </span></span>function <span class="_ _3"></span>does <span class="_ _2"></span>two <span class="_ _3"></span>things: <span class="_ _3"></span>it <span class="_ _3"></span>places <span class="_ _3"></span>a <span class="_ _3"></span>recor<span class="_ _0"></span><span class="ls178a">dl<span class="_ _8"></span><span class="ls0">ock <span class="_ _3"></span>on <span class="_ _3"></span>the</span></span></div><div class="t m0 x11a h4d y5bb3 ff19 fs26 fc0 sc0 ls0 ws0">job <span class="_ _23"> </span>ﬁle,<span class="_ _44"> </span><span class="ff1a">/var/spool/printer/jobno</span><span class="ls5e2">,a<span class="_ _43"></span><span class="ls0">nd <span class="_ _23"> </span>it <span class="_ _42"> </span>reads <span class="_ _23"> </span>the <span class="_ _42"> </span>ﬁle <span class="_ _23"> </span>to <span class="_ _42"> </span>determine</span></span></div><div class="t m0 x11a h49 y5bb4 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _42"> </span>next <span class="_ _42"> </span>job <span class="_ _42"> </span>number <span class="_ _42"> </span>to <span class="_ _42"> </span>assign.<span class="_ _54"> </span><span class="ls164">We <span class="_ _45"> </span>p<span class="_ _9"></span></span>lace <span class="_ _42"> </span>a <span class="_ _42"> </span>write <span class="_ _42"> </span>lock <span class="_ _42"> </span>on <span class="_ _42"> </span>the <span class="_ _42"> </span>entir<span class="ls178b">eﬁ<span class="_ _c"></span><span class="ls0">le <span class="_ _53"> </span>to</span></span></div><div class="t m0 x11a h49 y5bb5 ff19 fs26 fc0 sc0 ls0 ws0">indicate <span class="_ _e"> </span>that <span class="_ _e"> </span>the <span class="_ _e"> </span>daemon <span class="_ _e"> </span>is <span class="_ _e"> </span>running. <span class="_ _4b"> </span>If<span class="_ _59"> </span>someone <span class="_ _53"> </span>tries <span class="_"> </span>to <span class="_ _53"> </span>start <span class="_ _e"> </span>additional</div><div class="t m0 x11a h49 y5bb6 ff19 fs26 fc0 sc0 ls0 ws0">copies <span class="_ _23"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>printer <span class="_ _23"> </span>spooling <span class="_ _42"> </span>daemon <span class="_ _23"></span>while <span class="_ _23"> </span>one <span class="_ _42"> </span>is <span class="_ _23"> </span>already <span class="_ _23"></span>running, <span class="_ _23"></span>these</div><div class="t m0 x11a h49 y5bb7 ff19 fs26 fc0 sc0 ls0 ws0">additional <span class="_ _42"> </span>daemons <span class="_ _53"> </span>will <span class="_ _53"> </span>fail <span class="_ _53"> </span>to <span class="_ _53"> </span>obtain <span class="_ _42"> </span>the <span class="_ _53"> </span>write <span class="_ _53"> </span>lock <span class="_ _53"> </span>and <span class="_ _42"> </span>will <span class="_ _53"> </span>exit.<span class="_ _65"> </span>Thus,</div><div class="t m0 x11a h49 y5bb8 ff19 fs26 fc0 sc0 ls0 ws0">only <span class="_ _2"></span>one <span class="_ _2"></span>copy <span class="_ _3"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>daemon <span class="_ _3"></span>can <span class="_ _2"></span>be <span class="_ _2"></span>running <span class="_ _2"></span>at <span class="_ _3"></span>a <span class="_ _2"></span>time.<span class="_ _61"> </span>(Recall <span class="_ _3"></span>that <span class="_ _2"></span>we <span class="_ _2"></span>used</div><div class="t m0 x11a h4d y5bb9 ff19 fs26 fc0 sc0 ls0 ws0">this <span class="_ _47"> </span>technique <span class="_ _45"> </span>in <span class="_ _47"> </span>Figur<span class="ls178c">e1<span class="_ _62"></span><span class="ls0">3.6; <span class="_ _45"> </span>we <span class="_ _47"> </span>discussed <span class="_ _47"> </span>the<span class="_ _5a"> </span><span class="ff1a">write_lock<span class="_ _16"> </span></span>macr<span class="ls178c">oi<span class="_ _62"></span><span class="ls0">n</span></span></span></span></div><div class="t m0 x11a h49 y5bc5 ff19 fs26 fc0 sc0 ls0 ws0">Section 14.3.)</div><div class="t m0 x32 h49 y5bbb ff19 fs26 fc0 sc0 ls0 ws0">[183 <span class="_ _a"></span>– <span class="_ _a"></span>192]<span class="_ _65"> </span>The <span class="_ _47"> </span>job <span class="_ _45"> </span>ﬁle <span class="_ _45"> </span>contains <span class="_ _47"> </span>an <span class="_ _45"> </span>ASCII <span class="_ _47"> </span>integer <span class="_ _45"> </span>string <span class="_ _47"> </span>representing <span class="_ _47"> </span>the <span class="_ _45"> </span>next <span class="_ _47"> </span>job</div><div class="t m0 x11a h4d y5bbc ff19 fs26 fc0 sc0 ls0 ws0">number<span class="_ _6"></span><span class="ls4dd">.I<span class="_ _1d"></span><span class="lsd85">ft<span class="_ _4f"></span><span class="ls0">he <span class="_ _3"></span>ﬁle <span class="_ _3"></span>was <span class="_ _3"></span>just <span class="_ _3"></span>created <span class="_ _2"></span>and <span class="_ _9"></span>therefor<span class="_ _1"></span>e<span class="_ _45"> </span>is<span class="_ _47"> </span>empty<span class="_ _4"></span>,<span class="_ _47"> </span>we<span class="_ _47"> </span>set<span class="_ _45"> </span><span class="ff1a">nextjob</span></span></span></span></div><div class="t m0 x11a h4d y5bbd ff19 fs26 fc0 sc0 ls0 ws0">to 1.<span class="_ _61"> </span>Otherwise, we <span class="_ _2"></span>use<span class="_ _66"> </span><span class="ff1a">atol<span class="_ _66"> </span></span>to <span class="_ _2"></span>convert the <span class="_ _2"></span>string <span class="_ _2"></span>to an <span class="_ _2"></span>integer <span class="_ _2"></span>and use <span class="_ _2"></span>this</div><div class="t m0 x11a h4d y5bbe ff19 fs26 fc0 sc0 ls0 ws0">value as <span class="_ _2"></span>the next <span class="_ _2"></span>job number<span class="_ _1"></span><span class="ls178d">.W<span class="_ _26"></span><span class="ls1075">el<span class="_ _d"></span><span class="ls0">eave<span class="_"> </span><span class="ff1a">jobfd<span class="_ _66"> </span></span>open <span class="_ _2"></span>to the <span class="_ _2"></span>job ﬁle so <span class="_ _2"></span>that we</span></span></span></div><div class="t m0 x11a h49 y5bbf ff19 fs26 fc0 sc0 ls0 ws0">can <span class="_"> </span>update <span class="_ _66"> </span>the <span class="_"> </span>job <span class="_ _66"> </span>number <span class="_ _66"> </span>as <span class="_ _66"> </span>jobs <span class="_ _66"> </span>ar<span class="ls178e">ec<span class="_ _5b"></span><span class="lscc">re<span class="_ _2"></span><span class="ls0">ated. <span class="_ _46"> </span>W<span class="_ _6"></span><span class="ls178e">ec<span class="_ _4a"></span><span class="ls0">an’t <span class="_"> </span>close <span class="_"> </span>the <span class="_ _66"> </span>ﬁle,</span></span></span></span></span></div><div class="t m0 x11a h49 y5bc0 ff19 fs26 fc0 sc0 ls0 ws0">because this would release the write lock that we’ve placed on it.</div><div class="t m0 x11a h49 y5bc6 ff19 fs26 fc0 sc0 ls0 ws0">On a system <span class="_ _2"></span>wher<span class="ls140c">eal<span class="_ _4f"></span><span class="ls0">ong <span class="_ _2"></span>integer is 64 <span class="_ _2"></span>bits wide, <span class="_ _2"></span>we need a <span class="_ _2"></span>buffer at least 21</span></span></div><div class="t m0 x11a h49 y5bc7 ff19 fs26 fc0 sc0 ls0 ws0">bytes <span class="_ _2"></span>in <span class="_ _3"></span>size <span class="_ _3"></span>to <span class="_ _2"></span>ﬁt <span class="_ _3"></span>a <span class="_ _3"></span>string <span class="_ _2"></span>representing the <span class="_ _3"></span>largest <span class="_ _2"></span>possible <span class="_ _3"></span>long <span class="_ _2"></span>integer<span class="_ _1"></span><span class="ls178f">.W<span class="_ _7"></span><span class="ls0">e</span></span></div><div class="t m0 x11a h4d y5bc8 ff19 fs26 fc0 sc0 ls0 ws0">can safely reuse the ﬁlename buffer<span class="_ _6"></span><span class="ls1790">,b<span class="_ _d"></span><span class="ls0">ecause<span class="_"> </span><span class="ff1a">FILENMSZ<span class="_ _66"> </span></span>is deﬁned <span class="_ _2"></span>to be 64 in</span></span></div><div class="t m0 x11a h4d y5bc9 ff1a fs26 fc0 sc0 ls0 ws0">print.h<span class="ff19">.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
