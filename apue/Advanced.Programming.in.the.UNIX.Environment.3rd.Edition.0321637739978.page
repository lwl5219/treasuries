<div id="pf3d2" class="pf w4 h1f" data-page-no="3d2"><div class="pc pc3d2 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg3d2.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">944<span class="_ _1b"> </span><span class="ff19">Solutions <span class="_"> </span>to <span class="_"> </span>Selected <span class="_"> </span>Exercises <span class="_ _2eb"> </span>Appendix<span class="_ _4b"> </span>C</span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Chapter <span class="_"> </span>19</div><div class="t m0 x32 h26 y3eb ff18 fsf fc0 sc0 ls0 ws0">19.1<span class="_ _210"> </span><span class="ff19">Both <span class="_ _e"> </span>servers,<span class="_ _4b"> </span><span class="ff1a">telnetd<span class="_ _4b"> </span></span>and<span class="_ _4b"> </span><span class="ff1a">rlogind</span><span class="ls1346">,r<span class="_ _55"></span><span class="ls0">un <span class="_ _e"> </span>with <span class="_ _53"> </span>superuser <span class="_ _e"> </span>privileges, <span class="_ _53"> </span>so <span class="_ _e"> </span>their</span></span></span></div><div class="t m0 xe2 h26 y3ec ff19 fsf fc0 sc0 ls0 ws0">calls to<span class="_"> </span><span class="ff1a">chown<span class="_ _80"> </span></span>and<span class="_"> </span><span class="ff1a">chmod<span class="_ _66"> </span></span>succeed.</div><div class="t m0 x32 h26 y5070 ff18 fsf fc0 sc0 ls0 ws0">19.2<span class="_ _210"> </span><span class="ff19">Execute<span class="_ _5f"> </span><span class="ff1a">pty <span class="_ _d"></span>-n <span class="_ _4f"></span>stty <span class="_ _d"></span>-a<span class="_ _5f"> </span><span class="ff19">to <span class="_ _16"> </span>prevent <span class="_ _61"> </span>the <span class="_ _61"> </span>slave’s<span class="_ _5f"> </span></span>termios<span class="_ _5f"> </span><span class="ff19">structur<span class="_ _0"></span><span class="ls1886">ea<span class="_ _56"></span><span class="ls0">nd</span></span></span></span></span></div><div class="t m0 xe2 h26 y5071 ff1a fsf fc0 sc0 ls0 ws0">winsize<span class="_ _80"> </span><span class="ff19">structur<span class="ls44">ef<span class="_ _4f"></span><span class="ls45">ro<span class="_ _2"></span><span class="ls44">mb<span class="_ _5"></span><span class="ls0">eing initialized.</span></span></span></span></span></div><div class="t m0 x32 h26 yc38 ff18 fsf fc0 sc0 ls0 ws0">19.4<span class="_ _210"> </span><span class="ff19">Unfortunately<span class="_ _6"></span><span class="ls1887">,t<span class="_ _43"></span><span class="ls0">he<span class="_ _35"> </span><span class="ff1a">F_SETFL<span class="_ _44"> </span></span>command <span class="_ _42"> </span>of<span class="_ _44"> </span><span class="ff1a">fcntl<span class="_ _44"> </span></span>doesn’t <span class="_ _42"> </span>allow <span class="_ _42"> </span>the <span class="_ _53"> </span>read–write</span></span></span></div><div class="t m0 xe2 h2a yc39 ff19 fsf fc0 sc0 ls0 ws0">status to be changed.</div><div class="t m0 x32 h2a y633b ff18 fsf fc0 sc0 ls0 ws0">19.5<span class="_ _210"> </span><span class="ff19">Ther<span class="ls148a">ea<span class="_ _b"></span><span class="ls45">re <span class="_ _23"> </span>t<span class="_ _2"></span><span class="ls0">hree <span class="_ _3"></span>process <span class="_ _3"></span>groups:</span></span></span></span></div><div class="t m0 xc5 h2a ye9d ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x1df h2a y633b ff19 fsf fc0 sc0 ls0 ws0">1</div><div class="t m0 x207 h2a ye9d ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x12e h2a y633b ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _9"></span>login <span class="_ _9"></span>shell,</div><div class="t m0 x153 h2a ye9d ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x1da h2a y633b ff19 fsf fc0 sc0 ls0 ws0">2</div><div class="t m0 x196 h2a ye9d ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x14c h26 y633b ff19 fsf fc0 sc0 ls0 ws0">the<span class="_ _45"> </span><span class="ff1a">pty<span class="_ _47"> </span></span>parent <span class="_ _9"></span>and <span class="_ _9"></span>child,</div><div class="t m0 xe2 h2a y633c ff19 fsf fc0 sc0 ls0 ws0">and</div><div class="t m0 x1aa h2a ye9e ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x20c h2a y633c ff19 fsf fc0 sc0 ls0 ws0">3</div><div class="t m0 xaa h2a ye9e ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x53 h26 y633c ff19 fsf fc0 sc0 ls0 ws0">the<span class="_ _45"> </span><span class="ff1a">cat<span class="_ _45"> </span></span>process. <span class="_ _45"> </span>The<span class="_ _45"> </span>ﬁrst <span class="_ _9"></span>two <span class="_ _23"></span>process <span class="_ _9"></span>groups <span class="_ _3"></span>constitute <span class="_ _23"></span>a <span class="_ _9"></span>session <span class="_ _23"></span>with</div><div class="t m0 xe2 h26 y633d ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _23"></span>login <span class="_ _23"></span>shell <span class="_ _23"></span>as <span class="_ _9"></span>the <span class="_ _23"> </span>session <span class="_ _23"> </span>leader<span class="_ _1"></span><span class="ls1888">.T<span class="_ _26"></span><span class="ls0">he <span class="_ _23"></span>second <span class="_ _23"></span>session <span class="_ _23"></span>contains <span class="_ _23"></span>only <span class="_ _9"></span>the<span class="_ _35"> </span><span class="ff1a">cat</span></span></span></div><div class="t m0 xe2 h2a y1d5 ff19 fsf fc0 sc0 ls0 ws0">process. <span class="_ _66"> </span>The<span class="_ _47"> </span>ﬁrst <span class="_ _3"></span>process <span class="_ _2"></span>group <span class="_ _2"></span>(the <span class="_ _3"></span>login <span class="_ _3"></span>shell) <span class="_ _3"></span>is <span class="_ _2"></span>a <span class="_ _3"></span>background <span class="_ _3"></span>process <span class="_ _2"></span>group,</div><div class="t m0 xe2 h2a y1d7 ff19 fsf fc0 sc0 ls0 ws0">and the other two ar<span class="ls44">ef<span class="_ _4f"></span><span class="ls0">oreground pr<span class="_ _0"></span>ocess gr<span class="_ _0"></span>oups.</span></span></div><div class="t m0 x32 h26 y633e ff18 fsf fc0 sc0 ls0 ws0">19.6<span class="_ _210"> </span><span class="ff19">First,<span class="_ _66"> </span><span class="ff1a">cat<span class="_ _66"> </span></span>terminates <span class="_ _2"></span>when <span class="_ _2"></span>it receives the <span class="_ _2"></span>end of <span class="_ _2"></span>ﬁle <span class="_ _2"></span>from its line <span class="_ _2"></span>discipline.<span class="_ _46"> </span>This</span></div><div class="t m0 xe2 h2a y633f ff19 fsf fc0 sc0 ls0 ws0">causes <span class="_ _42"> </span>the <span class="_ _42"> </span>PTY <span class="_ _42"> </span>slave <span class="_ _42"> </span>to <span class="_ _42"> </span>terminate, <span class="_ _42"> </span>which <span class="_ _42"> </span>causes <span class="_ _53"> </span>the <span class="_ _42"> </span>PTY <span class="_ _42"> </span>master <span class="_ _42"> </span>to <span class="_ _42"> </span>terminate.</div><div class="t m0 xe2 h26 ya6a ff19 fsf fc0 sc0 ls0 ws0">This <span class="_ _9"></span>in <span class="_ _23"> </span>turn <span class="_ _23"></span>generates <span class="_ _9"></span>an <span class="_ _23"></span>end <span class="_ _23"></span>of <span class="_ _9"></span>ﬁle <span class="_ _23"></span>for <span class="_ _9"></span>the<span class="_ _35"> </span><span class="ff1a">pty<span class="_ _45"> </span></span>parent <span class="_ _9"></span>that’s <span class="_ _23"></span>reading <span class="_ _9"></span>from <span class="_ _9"></span>the</div><div class="t m0 xe2 h26 yfd2 ff19 fsf fc0 sc0 ls0 ws0">PTY <span class="_ _53"> </span>master<span class="_ _1"></span><span class="ls1889">.T<span class="_ _64"></span><span class="ls0">he <span class="_ _e"> </span>parent <span class="_ _53"> </span>sends<span class="_ _4b"> </span><span class="ff1a">SIGTERM<span class="_ _4b"> </span></span>to <span class="_ _e"> </span>the <span class="_ _53"> </span>child, <span class="_ _e"> </span>so <span class="_ _e"> </span>the <span class="_ _53"> </span>child <span class="_ _e"> </span>terminates</span></span></div><div class="t m0 xe2 h26 y94b ff19 fsf fc0 sc0 ls0 ws0">next. <span class="_ _45"> </span>(The<span class="_ _45"> </span>child <span class="_ _23"> </span>doesn’t <span class="_ _23"></span>catch <span class="_ _9"></span>this <span class="_ _23"></span>signal.)<span class="_ _5a"> </span>Finally<span class="_ _4"></span><span class="ls188a">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _23"></span>parent <span class="_ _3"></span>calls<span class="_ _35"> </span><span class="ff1a">exit(0)<span class="_ _45"> </span></span>at</span></span></div><div class="t m0 xe2 h26 y94c ff19 fsf fc0 sc0 ls0 ws0">the end of the<span class="_"> </span><span class="ff1a">main<span class="_ _80"> </span></span>function.</div><div class="t m0 xe2 h2a y14b3 ff19 fsf fc0 sc0 ls0 ws0">The relevant output fr<span class="_ _0"></span>om the pr<span class="_ _0"></span>ogram shown in Figur<span class="ls44">e8<span class="_ _4f"></span><span class="ls0">.29 is</span></span></div><div class="t m0 xd8 h57 y6340 ff1a fs2d fc0 sc0 ls0 ws0">cat <span class="_ _189"> </span>e<span class="_"> </span><span class="lsa74">=2<span class="_ _19"></span><span class="ls0">70, chars =<span class="_ _8a"> </span>274, stat =<span class="_ _87"> </span>0:</span></span></div><div class="t m0 xd8 h57 y6341 ff1a fs2d fc0 sc0 ls0 ws0">pty <span class="_ _189"> </span>e<span class="_"> </span><span class="lsa74">=2<span class="_ _19"></span><span class="ls0">62, chars =<span class="_ _189"> </span>40, stat =<span class="_ _3a"> </span>15: F<span class="_ _8a"> </span>X</span></span></div><div class="t m0 xd8 h57 y6342 ff1a fs2d fc0 sc0 ls0 ws0">pty <span class="_ _189"> </span>e<span class="_"> </span><span class="lsa74">=2<span class="_ _19"></span><span class="ls0">88, chars =<span class="_ _8a"> </span>188, stat =<span class="_ _87"> </span>0:</span></span></div><div class="t m0 x32 h26 y6343 ff18 fsf fc0 sc0 ls0 ws0">19.7<span class="_ _210"> </span><span class="ff19">This <span class="_ _3"></span>can <span class="_ _3"></span>be <span class="_ _2"></span>done <span class="_ _3"></span>with <span class="_ _2"></span>the <span class="_ _3"></span>shell’s<span class="_ _47"> </span><span class="ff1a">echo<span class="_ _66"> </span></span>command <span class="_ _3"></span>and <span class="_ _3"></span>the<span class="_ _66"> </span><span class="ff1a">date</span></span></div><div class="t m0 x11d h2a y6344 ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x11e h2a y6343 ff19 fsf fc0 sc0 ls0 ws0">1</div><div class="t m0 x3a h2a y6344 ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x1e6 h2a y6343 ff19 fsf fc0 sc0 ls0 ws0">command, <span class="_ _2"></span>all</div><div class="t m0 xe2 h2a y6345 ff19 fsf fc0 sc0 ls0 ws0">in a subshell:</div><div class="t m0 xd8 h57 y6346 ff1a fs2d fc0 sc0 ls0 ws0">#!/bin/sh</div><div class="t m0 xd8 h57 y6347 ff1a fs2d fc0 sc0 ls15c ws0">(e<span class="_ _1d"></span><span class="ls0">cho &quot;Script started on &quot; `date`;</span></div><div class="t m0 xaa h57 y6348 ff1a fs2d fc0 sc0 ls0 ws0">pty &quot;${SHELL:-/bin/sh}&quot;;</div><div class="t m0 xaa h57 y6349 ff1a fs2d fc0 sc0 ls0 ws0">echo &quot;Script done on &quot; `date` ) | tee typescript</div><div class="t m0 x32 h26 y634a ff18 fsf fc0 sc0 ls0 ws0">19.8<span class="_ _210"> </span><span class="ff19">The <span class="_ _2"></span>line <span class="_ _2"></span>discipline <span class="_ _2"></span>above the <span class="_ _2"></span>PTY <span class="_ _2"></span>slave <span class="_ _2"></span>has echo <span class="_ _2"></span>enabled, <span class="_ _2"></span>so <span class="_ _2"></span>whatever<span class="_ _66"> </span><span class="ff1a">pty<span class="_ _66"> </span></span><span class="ls45">re<span class="_ _2"></span></span>ads</span></div><div class="t m0 xe2 h2a y634b ff19 fsf fc0 sc0 ls0 ws0">on <span class="_ _3"></span>its <span class="_ _3"></span>standar<span class="ls97f">di<span class="_ _b"></span><span class="ls0">nput <span class="_ _3"></span>and <span class="_ _3"></span>writes <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>PTY <span class="_ _2"></span>master <span class="_ _3"></span>gets <span class="_ _9"></span>echoed <span class="_ _2"></span>by <span class="_ _3"></span>default.<span class="_ _16"> </span>This</span></span></div><div class="t m0 xe2 h2a y634c ff19 fsf fc0 sc0 ls0 ws0">echoing <span class="_ _23"></span>is <span class="_ _9"></span>done <span class="_ _23"> </span>by <span class="_ _23"></span>the <span class="_ _23"></span>line <span class="_ _9"></span>discipline <span class="_ _23"> </span>module <span class="_ _23"></span>above <span class="_ _23"></span>the <span class="_ _9"></span>slave <span class="_ _23"> </span>even <span class="_ _23"></span>though <span class="_ _23"></span>the</div><div class="t m0 xe2 h26 y634d ff19 fsf fc0 sc0 ls0 ws0">program (<span class="ff1a">ttyname</span><span class="ls44">)n<span class="_ _4f"></span><span class="ls0">ever reads the data.</span></span></div><div class="t m0 x35 h27 y634e ff16 fsf fc0 sc0 ls0 ws0">Chapter <span class="_"> </span>20</div><div class="t m0 x32 h26 y634f ff18 fsf fc0 sc0 ls0 ws0">20.1<span class="_ _210"> </span><span class="ff19">Our <span class="_ _42"> </span>conservative <span class="_ _23"> </span>locking <span class="_ _42"> </span>in<span class="_ _35"> </span><span class="ff1a">_db_dodelete<span class="_ _44"> </span></span>is <span class="_ _23"> </span>meant <span class="_ _42"> </span>to <span class="_ _23"> </span>avoid <span class="_ _42"> </span>race <span class="_ _23"> </span>conditions</span></div><div class="t m0 xe2 h26 y6350 ff19 fsf fc0 sc0 ls0 ws0">with<span class="_"> </span><span class="ff1a">db_nextrec</span><span class="ls16f0">.I<span class="_ _4a"></span><span class="ls150e">ft<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>call to<span class="_"> </span><span class="ff1a">_db_writedat<span class="_ _66"> </span></span>wer<span class="ls150e">en<span class="_ _4f"></span><span class="ls0">ot <span class="_ _2"></span>protected with a write</span></span></span></span></span></div><div class="t m0 xe2 h26 y6351 ff19 fsf fc0 sc0 ls0 ws0">lock, <span class="_"> </span>it <span class="_ _66"> </span>would <span class="_ _66"> </span>be <span class="_ _66"> </span>possible <span class="_"> </span>to <span class="_ _66"> </span>erase <span class="_ _66"> </span>the <span class="_ _66"> </span>data <span class="_ _66"> </span>recor<span class="ls188b">dw<span class="_ _1d"></span><span class="ls0">hile<span class="_ _61"> </span><span class="ff1a">db_nextrec<span class="_ _46"> </span></span>was</span></span></div><div class="t m0 xe2 h26 y6352 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ading <span class="_ _23"> </span>that <span class="_ _42"> </span>data <span class="_ _23"></span>recor<span class="_ _0"></span>d:<span class="_ _35"> </span><span class="ff1a">db_nextrec<span class="_ _35"> </span></span>would <span class="_ _23"></span>read <span class="_ _9"></span>an <span class="_ _42"> </span>index <span class="_ _23"></span>recor<span class="_ _1"></span>d, <span class="_ _42"> </span>determine</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
