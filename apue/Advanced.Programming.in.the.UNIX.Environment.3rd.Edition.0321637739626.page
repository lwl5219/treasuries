<div id="pf272" class="pf w4 h1f" data-page-no="272"><div class="pc pc272 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg272.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">592<span class="_ _1b"> </span><span class="ff19">Network <span class="_"> </span>IPC: <span class="_"> </span>Sockets<span class="_ _2c6"> </span>Chapter <span class="_"> </span>16</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">to <span class="_"> </span>cr<span class="_ _0"></span>eate <span class="_"> </span>a <span class="_ _e"> </span>raw <span class="_"> </span>socket <span class="_"> </span>to <span class="_ _e"> </span>prevent <span class="_ _e"> </span>malicious <span class="_"> </span>applications <span class="_"> </span>fr<span class="_ _0"></span>om <span class="_"> </span>cr<span class="_ _1"></span>eating <span class="_"> </span>packets <span class="_"> </span>that</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">might bypass established security mechanisms.</div><div class="t m0 x3f h26 y131 ff19 fsf fc0 sc0 ls0 ws0">Calling<span class="_ _45"> </span><span class="ff1a">socket<span class="_ _35"> </span></span>is <span class="_ _9"></span>similar <span class="_ _23"></span>to <span class="_ _9"></span>calling<span class="_ _35"> </span><span class="ff1a">open</span><span class="ls1306">.I<span class="_ _7"></span><span class="ls12ee">nb<span class="_ _b"></span><span class="ls0">oth <span class="_ _23"></span>cases, <span class="_ _9"></span>you <span class="_ _23"></span>get <span class="_ _9"></span>a <span class="_ _23"></span>ﬁle <span class="_ _9"></span>descriptor</span></span></span></div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _3"></span>can <span class="_ _3"></span>be <span class="_ _9"></span>used <span class="_ _3"></span>for <span class="_ _9"></span>I/O.<span class="_ _16"> </span>When <span class="_ _3"></span>you <span class="_ _3"></span>ar<span class="ls888">ed<span class="_ _8"></span><span class="ls0">one <span class="_ _3"></span>using <span class="_ _9"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>descriptor<span class="_ _1"></span><span class="ls888">,y<span class="_ _8"></span><span class="ls0">ou <span class="_ _3"></span>call<span class="_ _45"> </span><span class="ff1a">close</span></span></span></span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">to relinquish access to the ﬁle or socket and fr<span class="_ _0"></span>ee up the ﬁle descriptor for r<span class="_ _0"></span>euse.</div><div class="t m0 x3f h2a y134 ff19 fsf fc0 sc0 ls0 ws0">Although <span class="_ _53"> </span>a <span class="_ _53"> </span>socket <span class="_ _e"> </span>descriptor <span class="_ _53"> </span>is <span class="_ _e"> </span>actually <span class="_ _53"> </span>a <span class="_ _e"> </span>ﬁle <span class="_ _53"> </span>descriptor<span class="_ _1"></span><span class="ls12d5">,y<span class="_ _c"></span><span class="ls0">ou <span class="_ _53"> </span>can’t <span class="_ _53"> </span>use <span class="_ _e"> </span>a <span class="_ _53"> </span>socket</span></span></div><div class="t m0 x32 h2a y135 ff19 fsf fc0 sc0 ls0 ws0">descriptor <span class="_"> </span>with <span class="_"> </span>every <span class="_"> </span>function <span class="_"> </span>that <span class="_"> </span>accepts <span class="_"> </span>a <span class="_"> </span>ﬁle <span class="_"> </span>descriptor <span class="_"> </span>argument. <span class="_ _59"> </span>Figur<span class="ls1307">e1<span class="_ _4a"></span><span class="ls0">6.4</span></span></div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">summarizes <span class="_ _47"> </span>most <span class="_ _45"> </span>of <span class="_ _47"> </span>the <span class="_ _47"> </span>functions <span class="_ _47"> </span>we’ve <span class="_ _45"> </span>described <span class="_ _47"> </span>so <span class="_ _47"> </span>far <span class="_ _45"> </span>that <span class="_ _47"> </span>ar<span class="ls1308">eu<span class="_ _62"></span><span class="ls0">sed <span class="_ _47"> </span>with <span class="_ _45"> </span>ﬁle</span></span></div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">descriptors <span class="_ _44"> </span>and <span class="_ _44"> </span>describes <span class="_ _35"> </span>how <span class="_ _44"> </span>they <span class="_ _44"> </span>behave <span class="_ _44"> </span>when <span class="_ _44"> </span>used <span class="_ _44"> </span>with <span class="_ _44"> </span>socket <span class="_ _44"> </span>descriptors.</div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">Unspeciﬁed <span class="_ _47"> </span>and <span class="_ _47"> </span>implementation-deﬁned <span class="_ _47"> </span>behavior <span class="_ _47"> </span>usually <span class="_ _66"> </span>means <span class="_ _47"> </span>that <span class="_ _47"> </span>the <span class="_ _47"> </span>function</div><div class="t m0 x32 h26 y139 ff19 fsf fc0 sc0 ls0 ws0">doesn’t <span class="_ _9"></span>work <span class="_ _3"></span>with <span class="_ _9"></span>socket <span class="_ _9"></span>descriptors.<span class="_ _5a"> </span>For <span class="_ _9"></span>example,<span class="_ _45"> </span><span class="ff1a">lseek<span class="_ _47"> </span></span>doesn’t <span class="_ _9"></span>work <span class="_ _9"></span>with <span class="_ _9"></span>sockets,</div><div class="t m0 x32 h2a y13a ff19 fsf fc0 sc0 ls0 ws0">since sockets don’t support the concept of a ﬁle offset.</div><div class="t m0 x20c h2d y4708 ff19 fs10 fc0 sc0 ls0 ws0">Function <span class="_ _24d"> </span>Behavior<span class="_"> </span>with socket</div><div class="t m0 x1f0 h4f y4709 ff1a fs11 fc0 sc0 ls0 ws0">close<span class="_ _53"> </span><span class="ff19">(Section 3.3)<span class="_ _d6"> </span>deallocates the socket</span></div><div class="t m0 x1f0 h4f y470a ff1a fs11 fc0 sc0 ls0 ws0">dup<span class="ff19">,<span class="_"> </span></span>dup2<span class="_ _53"> </span><span class="ff19">(Section 3.12)<span class="_ _a1"> </span>duplicates the ﬁle descriptor as normal</span></div><div class="t m0 x1f0 h4f y470b ff1a fs11 fc0 sc0 ls0 ws0">fchdir<span class="_ _53"> </span><span class="ff19">(Section 4.23)<span class="_ _bb"> </span>fails with<span class="_"> </span></span>errno<span class="_ _e"> </span><span class="ff19">set to<span class="_"> </span></span>ENOTDIR</div><div class="t m0 x1f0 h4f y470c ff1a fs11 fc0 sc0 ls0 ws0">fchmod<span class="_ _53"> </span><span class="ff19">(Section 4.9)<span class="_ _b6"> </span>unspeciﬁed</span></div><div class="t m0 x1f0 h4f y470d ff1a fs11 fc0 sc0 ls0 ws0">fchown<span class="_ _53"> </span><span class="ff19">(Section 4.11)<span class="_ _bb"> </span>implementation deﬁned</span></div><div class="t m0 x1f0 h4f y470e ff1a fs11 fc0 sc0 ls0 ws0">fcntl<span class="_ _53"> </span><span class="ff19">(Section 3.14)<span class="_ _bd"> </span>some commands supported, including<span class="_"> </span></span>F_DUPFD<span class="ff19">,</span></div><div class="t m0 x10 h4f y470f ff1a fs11 fc0 sc0 ls0 ws0">F_DUPFD_CLOEXEC<span class="ff19">,<span class="_"> </span></span>F_GETFD<span class="ff19">,<span class="_"> </span></span>F_GETFL<span class="ff19">,<span class="_"> </span></span>F_GETOWN<span class="ff19">,</span></div><div class="t m0 x10 h4f y4710 ff1a fs11 fc0 sc0 ls0 ws0">F_SETFD<span class="ff19">,<span class="_"> </span></span>F_SETFL<span class="ff19 lsdb">,a<span class="_ _84"></span><span class="ls0">nd<span class="_"> </span><span class="ff1a">F_SETOWN</span></span></span></div><div class="t m0 x1f0 h4f y4711 ff1a fs11 fc0 sc0 ls0 ws0">fdatasync<span class="ff19">,<span class="_"> </span></span>fsync<span class="_ _53"> </span><span class="ff19">(Section 3.13)<span class="_ _6e"> </span>implementation deﬁned</span></div><div class="t m0 x1f0 h4f y4712 ff1a fs11 fc0 sc0 ls0 ws0">fstat<span class="_ _53"> </span><span class="ff19">(Section 4.2)<span class="_ _d6"> </span>some<span class="_"> </span></span>stat<span class="_ _e"> </span><span class="ff19">structur<span class="lsdb">em<span class="_ _5"></span><span class="ls0">embers supported, but how left up to the</span></span></span></div><div class="t m0 x10 h2e y4713 ff19 fs11 fc0 sc0 ls0 ws0">implementation</div><div class="t m0 x1f0 h4f y4714 ff1a fs11 fc0 sc0 ls0 ws0">ftruncate<span class="_ _53"> </span><span class="ff19">(Section 4.13)<span class="_ _13a"> </span>unspeciﬁed</span></div><div class="t m0 x1f0 h4f y4715 ff1a fs11 fc0 sc0 ls0 ws0">ioctl<span class="_ _53"> </span><span class="ff19">(Section 3.15)<span class="_ _bd"> </span>some commands work, depending on underlying device driver</span></div><div class="t m0 x1f0 h4f y4716 ff1a fs11 fc0 sc0 ls0 ws0">lseek<span class="_ _53"> </span><span class="ff19">(Section 3.6)<span class="_ _d6"> </span>implementation deﬁned (usually fails with<span class="_"> </span></span>errno<span class="_ _e"> </span><span class="ff19">set to<span class="_"> </span></span>ESPIPE<span class="ff19">)</span></div><div class="t m0 x1f0 h4f y4717 ff1a fs11 fc0 sc0 ls0 ws0">mmap<span class="_ _53"> </span><span class="ff19">(Section 14.8)<span class="_ _1f8"> </span>unspeciﬁed</span></div><div class="t m0 x1f0 h4f y4718 ff1a fs11 fc0 sc0 ls0 ws0">poll<span class="_ _53"> </span><span class="ff19">(Section 14.4.2)<span class="_ _b8"> </span>works as expected</span></div><div class="t m0 x1f0 h4f y4719 ff1a fs11 fc0 sc0 ls0 ws0">pread<span class="_ _53"> </span><span class="ff19">and<span class="_"> </span></span>pwrite<span class="_ _e"> </span><span class="ff19">(Section 3.1<span class="_ _0"></span>1)<span class="_ _41"> </span>fails with<span class="_"> </span><span class="ff1a">errno<span class="_ _53"> </span></span>set to<span class="_"> </span><span class="ff1a">ESPIPE</span></span></div><div class="t m0 x1f0 h4f y471a ff1a fs11 fc0 sc0 ls0 ws0">read<span class="_ _53"> </span><span class="ff19">(Section 3.7) and<span class="_"> </span></span>readv</div><div class="t m0 x1f8 h2e y471b ff19 fs11 fc0 sc0 ls0 ws0">(Section 14.6)</div><div class="t m0 x17c h4f y471a ff19 fs11 fc0 sc0 ls0 ws0">equivalent to<span class="_"> </span><span class="ff1a">recv<span class="_ _53"> </span></span>(Section 16.5) without any ﬂags</div><div class="t m0 x1f0 h4f y471c ff1a fs11 fc0 sc0 ls0 ws0">select<span class="_ _53"> </span><span class="ff19">(Section 14.4.1)<span class="_ _176"> </span>works as expected</span></div><div class="t m0 x1f0 h4f y471d ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">(Section 3.8) and<span class="_"> </span></span>writev</div><div class="t m0 x1f8 h2e y471e ff19 fs11 fc0 sc0 ls0 ws0">(Section 14.6)</div><div class="t m0 x17c h4f y471d ff19 fs11 fc0 sc0 ls0 ws0">equivalent to<span class="_"> </span><span class="ff1a">send<span class="_ _53"> </span></span>(Section 16.5) without any ﬂags</div><div class="t m0 x4 h2f y471f ff18 fs12 fc0 sc0 ls0 ws0">Figure 16.4<span class="_ _5a"> </span><span class="ff19">How ﬁle descriptor functions act with sockets</span></div><div class="t m0 x3f h50 y4720 ff19 fs29 fc0 sc0 ls0 ws0">Communication <span class="_ _9"></span>on <span class="_ _23"></span>a <span class="_ _9"></span>socket <span class="_ _23"></span>is <span class="_ _9"></span>bidirectional. <span class="_ _45"> </span>W<span class="_ _6"></span><span class="ls1309">ec<span class="_ _b"></span><span class="ls0">an <span class="_ _23"></span>disable <span class="_ _9"></span>I/O <span class="_ _23"></span>on <span class="_ _9"></span>a <span class="_ _23"></span>socket <span class="_ _9"></span>with</span></span></div><div class="t m0 x32 h5c y4721 ff19 fs29 fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">shutdown<span class="_ _80"> </span></span>function.</div><div class="t m0 x3f h62 y4722 ff1a fs30 fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x3f h62 y4723 ff1a fs30 fc0 sc0 ls0 ws0">int shutdown(int<span class="_"> </span><span class="ff1b">sockfd</span><span class="ls1185">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">how</span>);</span></span></div><div class="t m0 x153 hff y4724 ff19 fs30 fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h64 y4725 ff19 fs31 fc0 sc0 ls0 ws0">If<span class="_"> </span><span class="ff1b">how<span class="_"> </span></span>is<span class="_"> </span><span class="ff1a">SHUT_RD</span><span class="ls130a">,t<span class="_ _d"></span><span class="ls0">hen <span class="_ _2"></span>reading fr<span class="_ _0"></span>om the socket is disabled.<span class="_ _46"> </span>If<span class="_"> </span><span class="ff1b">how<span class="_ _66"> </span></span>is<span class="_"> </span><span class="ff1a">SHUT_WR</span><span class="ls130a">,t<span class="_ _d"></span><span class="ls0">hen <span class="_ _2"></span>we</span></span></span></span></div><div class="t m0 x32 h64 y4726 ff19 fs31 fc0 sc0 ls0 ws0">can’t <span class="_ _3"></span>use <span class="_ _2"></span>the <span class="_ _3"></span>socket <span class="_ _3"></span>for <span class="_ _3"></span>transmitting <span class="_ _3"></span>data.<span class="_ _16"> </span><span class="ls43f">We <span class="_ _80"> </span>c<span class="_ _23"></span></span>an <span class="_ _2"></span>use<span class="_ _47"> </span><span class="ff1a">SHUT_RDWR<span class="_ _47"> </span></span>to <span class="_ _3"></span>disable <span class="_ _3"></span>both <span class="_ _3"></span>data</div><div class="t m0 x32 h6e y4727 ff19 fs31 fc0 sc0 ls0 ws0">transmission and reception.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
