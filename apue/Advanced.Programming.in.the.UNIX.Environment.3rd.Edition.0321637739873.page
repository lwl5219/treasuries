<div id="pf369" class="pf w4 h1f" data-page-no="369"><div class="pc pc369 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg369.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">839</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">821 <span class="_ _15"> </span>success<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">822 <span class="_ _15"> </span>bufsz<span class="_"> </span><span class="ls15c">=I<span class="_ _1d"></span><span class="ls0">OBUFSZ;</span></span></div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">823 <span class="_ _15"> </span>if<span class="_"> </span>((bp = malloc(IOBUFSZ)) == NULL)</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">824 <span class="_ _186"> </span>log_sys(&quot;printer_status:<span class="_"> </span>can’t allocate read buffer&quot;);</div><div class="t m0 x32 h57 y2014 ff1a fs2d fc0 sc0 ls0 ws0">825 <span class="_ _15"> </span>while<span class="_"> </span>((nr = tread(sfd, bp, bufsz, 5)) &gt; 0) {</div><div class="t m0 x32 h57 y2015 ff1a fs2d fc0 sc0 ls0 ws0">826 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y33ad ff1a fs2d fc0 sc0 ls0 ws0">827 <span class="_ _176"> </span>*<span class="_"> </span>Find the status.<span class="_ _d9"> </span>Response starts with &quot;HTTP/x.y&quot;</div><div class="t m0 x32 h57 y33ae ff1a fs2d fc0 sc0 ls0 ws0">828 <span class="_ _176"> </span>*<span class="_"> </span>so we can skip the first 8 characters.</div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">829 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">830 <span class="_ _186"> </span>cp<span class="_"> </span>=<span class="_"> </span>bp<span class="_"> </span>+<span class="_"> </span>8;</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">831 <span class="_ _186"> </span>datsz<span class="_"> </span><span class="ls15c">=n<span class="_ _1d"></span><span class="ls0">r;</span></span></div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">832 <span class="_ _186"> </span>while<span class="_"> </span>(isspace((int)*cp))</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">833 <span class="_ _82"> </span>cp++;</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">834 <span class="_ _186"> </span>statcode<span class="_"> </span><span class="ls15c">=c<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">835 <span class="_ _186"> </span>while<span class="_"> </span>(isdigit((int)*cp))</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">836 <span class="_ _82"> </span>cp++;</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">837 <span class="_ _186"> </span>if<span class="_"> </span>(cp == statcode) { /* Bad format; log it and move on */</div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">838 <span class="_ _82"> </span>log_msg(bp);</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">839 <span class="_ _186"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">840 <span class="_ _82"> </span>*cp++<span class="_"> </span><span class="ls15c">=’<span class="_ _1d"></span><span class="ls0">\0’;</span></span></div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">841 <span class="_ _82"> </span>reason<span class="_"> </span><span class="ls15c">=c<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">842 <span class="_ _82"> </span>while<span class="_"> </span>(*cp != ’\r’ &amp;&amp; *cp != ’\n’)</div><div class="t m0 x32 h57 y2f2f ff1a fs2d fc0 sc0 ls0 ws0">843 <span class="_ _1e7"> </span>cp++;</div><div class="t m0 x32 h57 y2f30 ff1a fs2d fc0 sc0 ls0 ws0">844 <span class="_ _82"> </span>*cp<span class="_"> </span><span class="ls15c">=’<span class="_ _1d"></span><span class="ls0">\0’;</span></span></div><div class="t m0 x32 h57 y56fd ff1a fs2d fc0 sc0 ls0 ws0">845 <span class="_ _82"> </span>code<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">toi(statcode);</span></span></div><div class="t m0 x32 h57 y5848 ff1a fs2d fc0 sc0 ls0 ws0">846 <span class="_ _82"> </span>if<span class="_"> </span>(HTTP_INFO(code))</div><div class="t m0 x32 h57 y5849 ff1a fs2d fc0 sc0 ls0 ws0">847 <span class="_ _1e7"> </span>continue;</div><div class="t m0 x32 h57 y5a25 ff1a fs2d fc0 sc0 ls0 ws0">848 <span class="_ _82"> </span>if<span class="_"> </span>(!HTTP_SUCCESS(code)) { /* probable error: log it */</div><div class="t m0 x32 h57 y5a26 ff1a fs2d fc0 sc0 ls0 ws0">849 <span class="_ _1e7"> </span>bp[datsz]<span class="_"> </span><span class="ls15c">=’<span class="_ _1d"></span><span class="ls0">\0’;</span></span></div><div class="t m0 x32 h57 y5a36 ff1a fs2d fc0 sc0 ls0 ws0">850 <span class="_ _1e7"> </span>log_msg(&quot;error:<span class="_"> </span>%s&quot;, reason);</div><div class="t m0 x32 h57 y5a37 ff1a fs2d fc0 sc0 ls0 ws0">851 <span class="_ _1e7"> </span>break;</div><div class="t m0 x32 h57 y5a38 ff1a fs2d fc0 sc0 ls0 ws0">852 <span class="_ _82"> </span>}</div><div class="t m0 x32 h49 y5cb1 ff19 fs26 fc0 sc0 ls0 ws0">[821 <span class="_ _a"></span>– <span class="_ _a"></span>838]<span class="_ _65"> </span><span class="ls164">We <span class="_ _47"> </span>a<span class="_ _23"></span></span>llocate <span class="_ _23"> </span>a <span class="_ _42"> </span>buffer <span class="_ _23"></span>and <span class="_ _23"> </span>read <span class="_ _23"> </span>from <span class="_ _23"> </span>the <span class="_ _42"> </span>printer<span class="_ _6"></span><span class="lsf44">,e<span class="_ _43"></span><span class="ls0">xpecting <span class="_ _42"> </span>a <span class="_ _23"> </span>response <span class="_ _23"> </span>to <span class="_ _42"> </span>be</span></span></div><div class="t m0 x11a h4d y5cb2 ff19 fs26 fc0 sc0 ls0 ws0">available <span class="_ _53"> </span>within <span class="_ _53"> </span>about <span class="_ _53"> </span>5 <span class="_ _42"> </span>seconds.<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>s<span class="_ _9"></span></span>kip <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">HTTP/1.1<span class="_ _44"> </span></span>string <span class="_ _53"> </span>and <span class="_ _53"> </span>any</div><div class="t m0 x11a h49 y5cb3 ff19 fs26 fc0 sc0 ls0 ws0">white <span class="_ _2"></span>space <span class="_ _3"></span>that <span class="_ _2"></span>starts <span class="_ _3"></span>the <span class="_ _2"></span>message.<span class="_ _61"> </span>The <span class="_ _3"></span>numeric <span class="_ _3"></span>status <span class="_ _2"></span>code <span class="_ _3"></span>should <span class="_ _2"></span>follow<span class="_ _6"></span>.</div><div class="t m0 x11a h49 y5cb4 ff19 fs26 fc0 sc0 ls0 ws0">If it doesn’t, we log the contents of the message.</div><div class="t m0 x32 h49 y5cb5 ff19 fs26 fc0 sc0 ls0 ws0">[839 <span class="_ _a"></span>– <span class="_ _a"></span>844]<span class="_ _65"> </span>If <span class="_ _2"></span>we <span class="_ _3"></span>have <span class="_ _3"></span>found <span class="_ _3"></span>a <span class="_ _2"></span>numeric <span class="_ _3"></span>status <span class="_ _3"></span>code <span class="_ _2"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>response, <span class="_ _2"></span>we <span class="_ _3"></span>convert <span class="_ _3"></span>the <span class="_ _2"></span>ﬁrst</div><div class="t m0 x11a h49 y5cb6 ff19 fs26 fc0 sc0 ls0 ws0">nondigit <span class="_ _53"> </span>character <span class="_ _53"> </span>following <span class="_ _53"> </span>the <span class="_ _42"> </span>status <span class="_ _53"> </span>code <span class="_ _53"> </span>to <span class="_ _53"> </span>a <span class="_ _53"> </span>null <span class="_ _53"> </span>byte <span class="_ _53"> </span>(this <span class="_ _53"> </span>character</div><div class="t m0 x11a h49 y5cb7 ff19 fs26 fc0 sc0 ls0 ws0">should <span class="_ _42"> </span>be <span class="_ _53"> </span>some <span class="_ _42"> </span>form <span class="_ _53"> </span>of <span class="_ _53"> </span>white <span class="_ _42"> </span>space).<span class="_ _65"> </span>The <span class="_ _42"> </span>reason <span class="_ _42"> </span>string <span class="_ _53"> </span>(a <span class="_ _42"> </span>text <span class="_ _53"> </span>message)</div><div class="t m0 x11a h49 y5cb8 ff19 fs26 fc0 sc0 ls0 ws0">should <span class="_ _42"> </span>follow<span class="_ _6"></span><span class="ls17db">.W<span class="_ _5d"></span><span class="ls17dc">es<span class="_ _c"></span><span class="ls0">earch <span class="_ _42"> </span>for <span class="_ _42"> </span>the <span class="_ _53"> </span>terminating <span class="_ _42"> </span>carriage <span class="_ _53"> </span>return <span class="_ _42"> </span>or <span class="_ _42"> </span>line <span class="_ _42"> </span>feed,</span></span></span></div><div class="t m0 x11a h49 y5cb9 ff19 fs26 fc0 sc0 ls0 ws0">also terminating the text string with a null byte.</div><div class="t m0 x32 h4d y5cba ff19 fs26 fc0 sc0 ls0 ws0">[845 <span class="_ _a"></span>– <span class="_ _a"></span>852]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>c<span class="_ _23"></span></span>all the<span class="_"> </span><span class="ff1a">atoi<span class="_ _66"> </span></span>function <span class="_ _2"></span>to convert <span class="_ _2"></span>the <span class="_ _2"></span>status code <span class="_ _2"></span>string into <span class="_ _2"></span>an integer<span class="_ _1"></span><span class="ls17dd">.I<span class="_ _4a"></span><span class="ls0">f</span></span></div><div class="t m0 x11a h49 y5cbb ff19 fs26 fc0 sc0 ls0 ws0">this <span class="_ _3"></span>is <span class="_ _9"></span>an <span class="_ _3"></span>informational <span class="_ _3"></span>message <span class="_ _9"></span>only<span class="_ _4"></span>,<span class="_ _45"> </span>we<span class="_ _47"> </span>ignore<span class="_ _47"> </span>it<span class="_ _45"> </span>and <span class="_ _3"></span>continue <span class="_ _3"></span>the <span class="_ _9"></span>loop <span class="_ _3"></span>to</div><div class="t m0 x11a h49 y5cbc ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ad more. <span class="_"> </span>W<span class="_ _6"></span><span class="ls17de">ee<span class="_ _d"></span><span class="ls0">xpect to <span class="_ _2"></span>see either a <span class="_ _2"></span>success message or an <span class="_ _2"></span>error message.<span class="_ _59"> </span>If</span></span></span></div><div class="t m0 x11a h49 y5cbd ff19 fs26 fc0 sc0 ls0 ws0">we get an error message, we log the err<span class="_ _0"></span>or and br<span class="_ _0"></span>eak out of the loop.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
