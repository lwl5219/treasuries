<div id="pfa5" class="pf w4 h1f" data-page-no="a5"><div class="pc pca5 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bga5.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>4.22<span class="_ _1c1"> </span>Reading <span class="_"> </span>Directories<span class="_ _1b"> </span><span class="ff18">131</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _60"> </span><span class="ff1a">fdopendir<span class="_ _60"> </span></span>function <span class="_ _46"> </span>ﬁrst <span class="_ _59"> </span>appeared <span class="_ _46"> </span>in <span class="_ _59"> </span>version <span class="_ _46"> </span>4 <span class="_ _46"> </span>of <span class="_ _46"> </span>the <span class="_ _46"> </span>Single <span class="_ _46"> </span>UNIX</div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">Speciﬁcation. <span class="_ _47"> </span>It<span class="_ _45"> </span>provides <span class="_ _3"></span>a <span class="_ _9"></span>way <span class="_ _3"></span>to <span class="_ _9"></span>convert <span class="_ _9"></span>an <span class="_ _3"></span>open <span class="_ _9"></span>ﬁle <span class="_ _9"></span>descriptor <span class="_ _3"></span>into <span class="_ _9"></span>a<span class="_ _45"> </span><span class="ff1a">DIR<span class="_ _47"> </span></span>structure</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">for use by the directory handling functions.</div><div class="t m0 x3f h26 y132 ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _35"> </span><span class="ff1a">telldir<span class="_ _35"> </span></span>and<span class="_ _35"> </span><span class="ff1a">seekdir<span class="_ _35"> </span></span>functions <span class="_ _42"> </span>ar<span class="_ _0"></span><span class="ls5bd">en<span class="_ _43"></span><span class="ls0">ot <span class="_ _23"> </span>part <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>base <span class="_ _23"></span>POSIX.1 <span class="_ _23"> </span>standard.</span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">They <span class="_ _2"></span>ar<span class="ls5be">ei<span class="_ _8"></span><span class="ls0">ncluded <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _2"></span>XSI <span class="_ _3"></span>option <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>Single <span class="_ _3"></span>UNIX <span class="_ _3"></span>Speciﬁcation, <span class="_ _2"></span>so <span class="_ _3"></span>all <span class="_ _3"></span>conforming</span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">UNIX System implementations ar<span class="ls44">ee<span class="_ _4f"></span><span class="ls0">xpected to provide them.</span></span></div><div class="t m0 x3f h2a y135 ff19 fsf fc0 sc0 ls0 ws0">Recall <span class="_ _2"></span>our <span class="_ _2"></span>use <span class="_ _3"></span>of <span class="_ _2"></span>several <span class="_ _3"></span>of <span class="_ _2"></span>these <span class="_ _2"></span>functions <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>program shown <span class="_ _3"></span>in <span class="_ _2"></span>Figur<span class="ls146">e1<span class="_ _8"></span><span class="ls0">.3, <span class="_ _3"></span>our</span></span></div><div class="t m0 x32 h26 y136 ff19 fsf fc0 sc0 ls0 ws0">bare-bones implementation of the<span class="_"> </span><span class="ff1a">ls<span class="_ _80"> </span></span>command.</div><div class="t m0 x3f h26 y137 ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _51"> </span><span class="ff1a">dirent<span class="_"> </span></span>structur<span class="ls5bf">ed<span class="_ _7"></span><span class="ls0">eﬁned <span class="_ _35"> </span>in<span class="_ _5a"> </span><span class="ff1a">&lt;dirent.h&gt;<span class="_ _51"> </span></span>is <span class="_ _35"> </span>implementation <span class="_ _35"> </span>dependent.</span></span></div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">Implementations deﬁne the structur<span class="_ _0"></span>e<span class="_"> </span>to<span class="_"> </span>contain at least the following two members:</div><div class="t m0 xf4 h57 y12bb ff1a fs2d fc0 sc0 ls0 ws0">ino_t <span class="_"> </span>d_ino;<span class="_ _ce"> </span>/* i-node number */</div><div class="t m0 xf4 h57 y12bc ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _d9"> </span>d_name[];<span class="_ _b9"> </span>/* null-terminated filename */</div><div class="t m0 x76 h52 y12bd ff19 fs2a fc0 sc0 ls0 ws0">The<span class="_ _66"> </span><span class="ff1a">d_ino<span class="_ _66"> </span></span>entry <span class="_ _3"></span>is <span class="_ _9"></span>not <span class="_ _3"></span>deﬁned <span class="_ _3"></span>by <span class="_ _9"></span>POSIX.1, <span class="_ _3"></span>because <span class="_ _9"></span>it <span class="_ _3"></span>is <span class="_ _3"></span>an <span class="_ _9"></span>implementation <span class="_ _3"></span>feature, <span class="_ _3"></span>but <span class="_ _9"></span>it <span class="_ _3"></span>is</div><div class="t m0 x76 h52 y12be ff19 fs2a fc0 sc0 ls0 ws0">deﬁned <span class="_ _3"></span>as <span class="_ _9"></span>part <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _3"></span>XSI <span class="_ _9"></span>option <span class="_ _9"></span>in <span class="_ _3"></span>POSIX.1.<span class="_ _46"> </span>POSIX.1 <span class="_ _3"></span>deﬁnes <span class="_ _9"></span>only <span class="_ _9"></span>the<span class="_ _66"> </span><span class="ff1a">d_name<span class="_ _47"> </span></span>entry <span class="_ _3"></span>in <span class="_ _9"></span>this</div><div class="t m0 x76 h51 y12bf ff19 fs2a fc0 sc0 ls0 ws0">structure.</div><div class="t m0 x3f h26 y12c0 ff19 fsf fc0 sc0 ls0 ws0">Note that <span class="_ _2"></span>the <span class="_ _2"></span>size <span class="_ _2"></span>of <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">d_name<span class="_ _47"> </span></span>entry isn’t <span class="_ _2"></span>speciﬁed, <span class="_ _2"></span>but <span class="_ _2"></span>it is <span class="_ _2"></span>guaranteed <span class="_ _2"></span>to <span class="_ _2"></span>hold at</div><div class="t m0 x32 h26 y12c1 ff19 fsf fc0 sc0 ls0 ws0">least<span class="_ _47"> </span><span class="ff1a">NAME_MAX<span class="_ _45"> </span></span>characters, <span class="_ _3"></span>not <span class="_ _9"></span>including <span class="_ _9"></span>the <span class="_ _3"></span>terminating <span class="_ _9"></span>null <span class="_ _9"></span>byte <span class="_ _3"></span>(recall <span class="_ _3"></span>Figur<span class="ls5c0">e2<span class="_ _b"></span><span class="ls0">.15.)</span></span></div><div class="t m0 x32 h26 y12c2 ff19 fsf fc0 sc0 ls0 ws0">Since the ﬁlename <span class="_ _2"></span>is null <span class="_ _2"></span>terminated, however<span class="_ _1"></span>,<span class="_"> </span>it<span class="_ _66"> </span>doesn’t matter <span class="_ _2"></span>how<span class="_"> </span><span class="ff1a">d_name<span class="_ _66"> </span></span>is <span class="_ _2"></span>deﬁned</div><div class="t m0 x32 h2a y12c3 ff19 fsf fc0 sc0 ls0 ws0">in the header<span class="_ _6"></span><span class="ls44">,b<span class="_ _5"></span><span class="ls0">ecause the array size doesn’t indicate the length of the ﬁlename.</span></span></div><div class="t m0 x3f h26 y12c4 ff19 fsf fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1a">DIR<span class="_ _47"> </span></span>structur<span class="_ _0"></span>e<span class="_"> </span>is<span class="_ _47"> </span>an<span class="_"> </span>internal <span class="_ _2"></span>structur<span class="ls5c1">eu<span class="_ _4f"></span><span class="ls0">sed by <span class="_ _2"></span>these <span class="_ _2"></span>seven <span class="_ _2"></span>functions <span class="_ _2"></span>to <span class="_ _2"></span>maintain</span></span></div><div class="t m0 x32 h26 y12c5 ff19 fsf fc0 sc0 ls0 ws0">information <span class="_ _2"></span>about <span class="_ _2"></span>the <span class="_ _3"></span>directory being <span class="_ _2"></span>read. <span class="_ _47"> </span>The<span class="_ _66"> </span>purpose <span class="_ _2"></span>of <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">DIR<span class="_ _66"> </span></span>structure<span class="_"> </span>is<span class="_ _47"> </span>similar</div><div class="t m0 x32 h26 y12c6 ff19 fsf fc0 sc0 ls0 ws0">to that <span class="_ _2"></span>of the<span class="_ _66"> </span><span class="ff1a">FILE<span class="_ _66"> </span></span>structur<span class="ls2a7">em<span class="_ _4f"></span><span class="ls0">aintained <span class="_ _2"></span>by the <span class="_ _2"></span>standar<span class="ls2a7">dI<span class="_ _4f"></span><span class="ls0">/O <span class="_ _2"></span>library<span class="_ _4"></span><span class="ls5c2">,w<span class="_ _d"></span><span class="ls0">hich <span class="_ _2"></span>we describe</span></span></span></span></span></span></div><div class="t m0 x32 h2a y12c7 ff19 fsf fc0 sc0 ls0 ws0">in Chapter 5.</div><div class="t m0 x3f h26 y12c8 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _3"></span>pointer <span class="_ _9"></span>to <span class="_ _3"></span>a<span class="_ _45"> </span><span class="ff1a">DIR<span class="_ _47"> </span></span>structur<span class="ls5c3">er<span class="_ _b"></span><span class="ls0">eturned <span class="_ _2"></span>by<span class="_ _45"> </span><span class="ff1a">opendir<span class="_ _47"> </span></span>and<span class="_ _45"> </span><span class="ff1a">fdopendir<span class="_ _47"> </span></span>is <span class="_ _3"></span>then <span class="_ _9"></span>used</span></span></div><div class="t m0 x32 h26 y12c9 ff19 fsf fc0 sc0 ls0 ws0">with <span class="_ _9"></span>the <span class="_ _23"></span>other <span class="_ _9"></span>ﬁve <span class="_ _9"></span>functions.<span class="_ _51"> </span>The<span class="_ _45"> </span><span class="ff1a">opendir<span class="_ _45"> </span></span>function <span class="_ _9"></span>initializes <span class="_ _23"></span>things <span class="_ _9"></span>so <span class="_ _23"></span>that <span class="_ _9"></span>the <span class="_ _9"></span>ﬁrst</div><div class="t m0 x32 h26 y12ca ff1a fsf fc0 sc0 ls0 ws0">readdir<span class="_ _45"> </span><span class="ff19 ls45">re<span class="ls0">turns <span class="_ _9"></span>the <span class="_ _9"></span>ﬁrst <span class="_ _9"></span>entry <span class="_ _9"></span>in <span class="_ _3"></span>the <span class="_ _9"></span>directory<span class="_ _4"></span><span class="ls5c4">.W<span class="_ _62"></span><span class="ls0">hen <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">DIR<span class="_ _45"> </span></span>structur<span class="_ _0"></span>e<span class="_ _45"> </span>is<span class="_ _47"> </span>c<span class="ls45">re<span class="_ _2"></span></span>ated <span class="_ _9"></span>by</span></span></span></span></div><div class="t m0 x32 h26 y12cb ff1a fsf fc0 sc0 ls0 ws0">fdopendir<span class="ff19 ls5c5">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>ﬁrst <span class="_ _9"></span>entry <span class="_ _9"></span>returned <span class="_ _9"></span>by<span class="_ _45"> </span><span class="ff1a">readdir<span class="_ _45"> </span></span>depends <span class="_ _9"></span>on <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>offset <span class="_ _9"></span>associated</span></span></div><div class="t m0 x32 h26 y12cc ff19 fsf fc0 sc0 ls0 ws0">with <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>descriptor <span class="_ _3"></span>passed <span class="_ _3"></span>to<span class="_ _47"> </span><span class="ff1a">fdopendir</span><span class="ls5c6">.N<span class="_ _1d"></span><span class="ls0">ote <span class="_ _9"></span>that <span class="_ _3"></span>the <span class="_ _3"></span>ordering <span class="_ _2"></span>of <span class="_ _3"></span>entries <span class="_ _3"></span>within</span></span></div><div class="t m0 x32 h2a y12cd ff19 fsf fc0 sc0 ls0 ws0">the directory is implementation dependent and is usually not alphabetical.</div><div class="t m0 x35 h27 y12ce ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y12cf ff19 fsf fc0 sc0 ls5f ws0">We<span class="_ _9"></span><span class="ls0">’ll <span class="_ _2"></span>use <span class="_ _2"></span>these <span class="_ _2"></span>directory routines <span class="_ _2"></span>to <span class="_ _2"></span>write <span class="_ _2"></span>a <span class="_ _2"></span>program that <span class="_ _2"></span>traverses <span class="_ _2"></span>a <span class="_ _2"></span>ﬁle <span class="_ _2"></span>hierarchy<span class="_ _4"></span><span class="ls5c7">.T<span class="_ _5b"></span><span class="ls0">he</span></span></span></div><div class="t m0 x32 h2a y12d0 ff19 fsf fc0 sc0 ls0 ws0">goal <span class="_"> </span>is <span class="_"> </span>to <span class="_"> </span>produce <span class="_"> </span>a <span class="_"> </span>count <span class="_"> </span>of <span class="_"> </span>the <span class="_"> </span>various <span class="_ _66"> </span>types <span class="_"> </span>of <span class="_"> </span>ﬁles <span class="_ _66"> </span>shown <span class="_"> </span>in <span class="_"> </span>Figur<span class="ls447">e4<span class="_ _4a"></span><span class="ls0">.4. <span class="_ _59"> </span>The</span></span></div><div class="t m0 x32 h2a y12d1 ff19 fsf fc0 sc0 ls0 ws0">program <span class="_ _9"></span>shown <span class="_ _23"> </span>in <span class="_ _23"> </span>Figur<span class="ls5c8">e4<span class="_ _43"></span><span class="ls0">.22 <span class="_ _23"> </span>takes <span class="_ _23"> </span>a <span class="_ _42"> </span>single <span class="_ _23"></span>ar<span class="_ _0"></span>gument <span class="_ _a"></span>— <span class="_ _a"></span>the<span class="_ _35"> </span>starting <span class="_ _23"> </span>pathname<span class="_ _9"></span><span class="ls9d">—a<span class="_ _6"></span><span class="ls0">nd</span></span></span></span></div><div class="t m0 x32 h26 y12d2 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">cursively <span class="_ _3"></span>descends <span class="_ _2"></span>the <span class="_ _3"></span>hierarchy <span class="_ _2"></span>from that <span class="_ _3"></span>point.<span class="_ _61"> </span>Solaris <span class="_ _3"></span>provides <span class="_ _2"></span>a <span class="_ _2"></span>function,<span class="_ _47"> </span><span class="ff1a">ftw</span></span></div><div class="t m0 x55 h2a y12d3 ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x1b8 h2a y12d2 ff19 fsf fc0 sc0 ls0 ws0">3</div><div class="t m0 x191 h2a y12d3 ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x163 h2a y12d2 ff19 fsf fc0 sc0 ls0 ws0">,</div><div class="t m0 x32 h2a y12d4 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _23"> </span>performs <span class="_ _42"> </span>the <span class="_ _23"> </span>actual <span class="_ _42"> </span>traversal <span class="_ _23"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>hierar<span class="_ _0"></span>chy<span class="_ _4"></span><span class="ls5c9">,c<span class="_ _43"></span><span class="ls0">alling <span class="_ _42"> </span>a <span class="_ _23"> </span>user-deﬁned <span class="_ _23"> </span>function <span class="_ _42"> </span>for</span></span></div><div class="t m0 x32 h26 y12d5 ff19 fsf fc0 sc0 ls0 ws0">each <span class="_ _3"></span>ﬁle.<span class="_ _16"> </span>The <span class="_ _3"></span>problem <span class="_ _3"></span>with <span class="_ _3"></span>this <span class="_ _3"></span>function <span class="_ _3"></span>is <span class="_ _9"></span>that <span class="_ _3"></span>it <span class="_ _3"></span>calls <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">stat<span class="_ _45"> </span></span>function <span class="_ _2"></span>for <span class="_ _9"></span>each <span class="_ _3"></span>ﬁle,</div><div class="t m0 x32 h2a y12d6 ff19 fsf fc0 sc0 ls0 ws0">which <span class="_ _2"></span>causes <span class="_ _3"></span>the <span class="_ _2"></span>program <span class="_ _2"></span>to <span class="_ _3"></span>follow <span class="_ _3"></span>symbolic <span class="_ _2"></span>links.<span class="_ _16"> </span>For <span class="_ _2"></span>example, <span class="_ _3"></span>if <span class="_ _3"></span>we <span class="_ _2"></span>start <span class="_ _3"></span>at <span class="_ _2"></span>the <span class="_ _3"></span>root</div><div class="t m0 x32 h26 y12d7 ff19 fsf fc0 sc0 ls0 ws0">and <span class="_ _53"> </span>have <span class="_ _53"> </span>a <span class="_ _53"> </span>symbolic <span class="_ _e"> </span>link <span class="_ _53"> </span>named<span class="_ _4b"> </span><span class="ff1a">/lib<span class="_ _44"> </span></span>that <span class="_ _e"> </span>points <span class="_ _53"> </span>to<span class="_ _4b"> </span><span class="ff1a">/usr/lib</span><span class="ls5ca">,a<span class="_ _c"></span><span class="ls0">ll <span class="_ _53"> </span>the <span class="_ _53"> </span>ﬁles <span class="_ _e"> </span>in <span class="_ _53"> </span>the</span></span></div><div class="t m0 x32 h26 y12d8 ff19 fsf fc0 sc0 ls0 ws0">directory<span class="_ _44"> </span><span class="ff1a">/usr/lib<span class="_ _44"> </span></span>ar<span class="ls5cb">ec<span class="_ _55"></span><span class="ls0">ounted <span class="_ _53"> </span>twice.<span class="_ _65"> </span><span class="ls5f">To <span class="_ _35"> </span>c<span class="_ _9"></span></span>orrect <span class="_ _42"> </span>this <span class="_ _53"> </span>problem, <span class="_ _42"> </span>Solaris <span class="_ _53"> </span>provides <span class="_ _53"> </span>an</span></span></div><div class="t m0 x32 h26 y12d9 ff19 fsf fc0 sc0 ls0 ws0">additional function,<span class="_ _66"> </span><span class="ff1a">nftw</span></div><div class="t m0 xbf h2a y12da ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x1e h2a y12d9 ff19 fsf fc0 sc0 ls0 ws0">3</div><div class="t m0 x7 h2a y12da ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 xa8 h2a y12d9 ff19 fsf fc0 sc0 ls5cc ws0">,w<span class="_ _4f"></span><span class="ls0">ith <span class="_ _2"></span>an <span class="_ _2"></span>option that <span class="_ _2"></span>stops it <span class="_ _2"></span>from following <span class="_ _2"></span>symbolic links.</span></div><div class="t m0 x32 h26 y12db ff19 fsf fc0 sc0 ls0 ws0">Although we <span class="_ _2"></span>could <span class="_ _2"></span>use<span class="_ _66"> </span><span class="ff1a">nftw</span><span class="ls5cd">,w<span class="_ _d"></span><span class="ls0">e’ll <span class="_ _2"></span>write our <span class="_ _2"></span>own <span class="_ _2"></span>simple <span class="_ _2"></span>ﬁle <span class="_ _2"></span>walker to <span class="_ _2"></span>show <span class="_ _2"></span>the <span class="_ _2"></span>use <span class="_ _2"></span>of</span></span></div><div class="t m0 x32 h2a y12dc ff19 fsf fc0 sc0 ls0 ws0">the directory r<span class="_ _0"></span>outines.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
