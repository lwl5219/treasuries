<div id="pf214" class="pf w4 h1f" data-page-no="214"><div class="pc pc214 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg214.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">498<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">pid_t <span class="_ _74"> </span>pid;</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _bd"> </span>buf[5];</div><div class="t m0 x8a h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">struct stat<span class="_ _8a"> </span>statbuf;</div><div class="t m0 x8a h57 y2db4 ff1a fs2d fc0 sc0 ls0 ws0">if (argc != 2) {</div><div class="t m0 x9d h57 y23c8 ff1a fs2d fc0 sc0 ls0 ws0">fprintf(stderr, &quot;usage: %s filename\n&quot;, argv[0]);</div><div class="t m0 x9d h57 y23c9 ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y23ca ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y23cb ff1a fs2d fc0 sc0 ls0 ws0">if ((fd = open(argv[1], O_RDWR | O_CREAT | O_TRUNC, FILE_MODE)) &lt; 0)</div><div class="t m0 x9d h57 y86e ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;open error&quot;);</div><div class="t m0 x8a h57 y86f ff1a fs2d fc0 sc0 ls0 ws0">if (write(fd, &quot;abcdef&quot;, 6) != 6)</div><div class="t m0 x9d h57 y870 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><div class="t m0 x8a h57 y23cd ff1a fs2d fc0 sc0 ls0 ws0">/* turn on set-group-ID and turn off group-execute */</div><div class="t m0 x8a h57 y872 ff1a fs2d fc0 sc0 ls0 ws0">if (fstat(fd, &amp;statbuf) &lt; 0)</div><div class="t m0 x9d h57 y873 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fstat error&quot;);</div><div class="t m0 x8a h57 y874 ff1a fs2d fc0 sc0 ls0 ws0">if (fchmod(fd, (statbuf.st_mode &amp; ˜S_IXGRP) | S_ISGID) &lt; 0)</div><div class="t m0 x9d h57 y875 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fchmod error&quot;);</div><div class="t m0 x8a h57 y23ce ff1a fs2d fc0 sc0 ls0 ws0">TELL_WAIT();</div><div class="t m0 x8a h57 y2e78 ff1a fs2d fc0 sc0 ls0 ws0">if ((pid = fork()) &lt; 0) {</div><div class="t m0 x9d h57 y2e79 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fork error&quot;);</div><div class="t m0 x8a h57 y2e7a ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pid &gt; 0) {<span class="_ _87"> </span>/* parent */</span></div><div class="t m0 x9d h57 y2e7b ff1a fs2d fc0 sc0 ls0 ws0">/* write lock entire file */</div><div class="t m0 x9d h57 y3d21 ff1a fs2d fc0 sc0 ls0 ws0">if (write_lock(fd, 0, SEEK_SET, 0) &lt; 0)</div><div class="t m0 x1f h57 y23d4 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write_lock error&quot;);</div><div class="t m0 x9d h57 y368b ff1a fs2d fc0 sc0 ls0 ws0">TELL_CHILD(pid);</div><div class="t m0 x9d h57 y368c ff1a fs2d fc0 sc0 ls0 ws0">if (waitpid(pid, NULL, 0) &lt; 0)</div><div class="t m0 x1f h57 y368d ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;waitpid error&quot;);</div><div class="t m0 x8a h57 y368e ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {<span class="_ _1e7"> </span>/* child */</span></div><div class="t m0 x9d h57 y368f ff1a fs2d fc0 sc0 ls0 ws0">WAIT_PARENT(); <span class="_ _8a"> </span>/*<span class="_"> </span>wait for parent to set lock */</div><div class="t m0 x9d h57 y3d22 ff1a fs2d fc0 sc0 ls0 ws0">set_fl(fd, O_NONBLOCK);</div><div class="t m0 x9d h57 y3d23 ff1a fs2d fc0 sc0 ls0 ws0">/* first let’s see what error we get if region is locked */</div><div class="t m0 x9d h57 y3d24 ff1a fs2d fc0 sc0 ls0 ws0">if (read_lock(fd, 0, SEEK_SET, 0) != -1)<span class="_ _15"> </span>/* no wait */</div><div class="t m0 x1f h57 y3d25 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;child: read_lock succeeded&quot;);</div><div class="t m0 x9d h57 y3d26 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;read_lock of already-locked region returns %d\n&quot;,</div><div class="t m0 x76 h57 y3d27 ff1a fs2d fc0 sc0 ls0 ws0">errno);</div><div class="t m0 x9d h57 y3d28 ff1a fs2d fc0 sc0 ls0 ws0">/* now try to read the mandatory locked file */</div><div class="t m0 x9d h57 y3d29 ff1a fs2d fc0 sc0 ls0 ws0">if (lseek(fd, 0, SEEK_SET) == -1)</div><div class="t m0 x1f h57 y3d2a ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;lseek error&quot;);</div><div class="t m0 x9d h57 y3d2b ff1a fs2d fc0 sc0 ls0 ws0">if (read(fd, buf, 2) &lt; 0)</div><div class="t m0 x1f h57 y3d2c ff1a fs2d fc0 sc0 ls0 ws0">err_ret(&quot;read failed (mandatory locking works)&quot;);</div><div class="t m0 x9d h57 y36ad ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 x1f h57 y3d2d ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;read OK (no mandatory locking), buf = %2.2s\n&quot;,</div><div class="t m0 xae h57 y3d2e ff1a fs2d fc0 sc0 ls0 ws0">buf);</div><div class="t m0 x8a h57 y3d2f ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y3d30 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y3d31 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1e5 h2d y3d32 ff18 fs10 fc0 sc0 ls0 ws0">Figure 14.12<span class="_ _5a"> </span><span class="ff19">Determine whether mandatory locking is supported</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
