<div id="pf353" class="pf w4 h1f" data-page-no="353"><div class="pc pc353 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg353.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">817</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">143 <span class="_ _15"> </span>err<span class="_"> </span><span class="ls15c">=p<span class="_ _1d"></span><span class="ls0">thread_create(&amp;tid, NULL, printer_thread, NULL);</span></span></div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">144 <span class="_ _15"> </span>if<span class="_"> </span>(err == 0)</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">145 <span class="_ _186"> </span>err<span class="_"> </span><span class="ls15c">=p<span class="_ _1d"></span><span class="ls0">thread_create(&amp;tid, NULL, signal_thread, NULL);</span></span></div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">146 <span class="_ _15"> </span>if<span class="_"> </span>(err != 0)</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">147 <span class="_ _186"> </span>log_exit(err,<span class="_"> </span>&quot;can’t create thread&quot;);</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">148 <span class="_ _15"> </span>build_qonstart();</div><div class="t m0 x32 h57 y3c5 ff1a fs2d fc0 sc0 ls0 ws0">149 <span class="_ _15"> </span>log_msg(&quot;daemon<span class="_"> </span>initialized&quot;);</div><div class="t m0 x32 h57 y158f ff1a fs2d fc0 sc0 ls0 ws0">150 <span class="_ _15"> </span>for<span class="_"> </span>(;;) {</div><div class="t m0 x32 h57 y3c7 ff1a fs2d fc0 sc0 ls0 ws0">151 <span class="_ _186"> </span>rset<span class="_"> </span><span class="ls15c">=r<span class="_ _1d"></span><span class="ls0">endezvous;</span></span></div><div class="t m0 x32 h57 y3c8 ff1a fs2d fc0 sc0 ls0 ws0">152 <span class="_ _186"> </span>if<span class="_"> </span>(select(maxfd+1, &amp;rset, NULL, NULL, NULL) &lt; 0)</div><div class="t m0 x32 h57 y3c9 ff1a fs2d fc0 sc0 ls0 ws0">153 <span class="_ _82"> </span>log_sys(&quot;select<span class="_"> </span>failed&quot;);</div><div class="t m0 x32 h57 y3ca ff1a fs2d fc0 sc0 ls0 ws0">154 <span class="_ _186"> </span>for<span class="_"> </span>(i = 0; i &lt;= maxfd; i++) {</div><div class="t m0 x32 h57 y1cc6 ff1a fs2d fc0 sc0 ls0 ws0">155 <span class="_ _82"> </span>if<span class="_"> </span>(FD_ISSET(i, &amp;rset)) {</div><div class="t m0 x32 h57 y1cc7 ff1a fs2d fc0 sc0 ls0 ws0">156 <span class="_ _1e7"> </span>/*</div><div class="t m0 x32 h57 y1cc8 ff1a fs2d fc0 sc0 ls0 ws0">157 <span class="_ _ce"> </span>*<span class="_"> </span>Accept the connection and handle the request.</div><div class="t m0 x32 h57 y4588 ff1a fs2d fc0 sc0 ls0 ws0">158 <span class="_ _ce"> </span>*/</div><div class="t m0 x32 h57 y4589 ff1a fs2d fc0 sc0 ls0 ws0">159 <span class="_ _1e7"> </span>if<span class="_"> </span>((sockfd = accept(i, NULL, NULL)) &lt; 0)</div><div class="t m0 x32 h57 y2ad7 ff1a fs2d fc0 sc0 ls0 ws0">160 <span class="_ _296"> </span>log_ret(&quot;accept<span class="_"> </span>failed&quot;);</div><div class="t m0 x32 h57 y2ad8 ff1a fs2d fc0 sc0 ls0 ws0">161 <span class="_ _1e7"> </span>pthread_create(&amp;tid,<span class="_"> </span>NULL, client_thread,</div><div class="t m0 x32 h57 y2ad9 ff1a fs2d fc0 sc0 ls0 ws0">162 <span class="_ _cb"> </span>(void<span class="_"> </span>*)((long)sockfd));</div><div class="t m0 x32 h57 y4d71 ff1a fs2d fc0 sc0 ls0 ws0">163 <span class="_ _82"> </span>}</div><div class="t m0 x32 h57 y4d72 ff1a fs2d fc0 sc0 ls0 ws0">164 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y4d73 ff1a fs2d fc0 sc0 ls0 ws0">165 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y2c64 ff1a fs2d fc0 sc0 ls0 ws0">166 <span class="_ _15"> </span>exit(1);</div><div class="t m0 x32 h57 y2c65 ff1a fs2d fc0 sc0 ls0 ws0">167 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h49 y5bb2 ff19 fs26 fc0 sc0 ls0 ws0">[143 <span class="_ _a"></span>– <span class="_ _a"></span>149]<span class="_ _65"> </span><span class="ls164">We <span class="_ _e"> </span>c<span class="_ _23"></span><span class="lscc">re</span></span>ate <span class="_ _2"></span>one <span class="_ _3"></span>thread <span class="_ _2"></span>to <span class="_ _2"></span>handle <span class="_ _3"></span>signals <span class="_ _2"></span>and <span class="_ _3"></span>one <span class="_ _2"></span>thread <span class="_ _2"></span>to <span class="_ _3"></span>communicate <span class="_ _2"></span>with</div><div class="t m0 x11a h49 y5bb3 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _e"> </span>printer<span class="_ _1"></span><span class="ls1784">.(<span class="_ _64"></span><span class="ls0">By <span class="_ _e"> </span>restricting <span class="_ _e"> </span>printer <span class="_ _e"> </span>communication <span class="_"> </span>to <span class="_ _53"> </span>one <span class="_"> </span>thr<span class="_ _0"></span>ead, <span class="_ _e"> </span>we <span class="_"> </span>can</span></span></div><div class="t m0 x11a h49 y5bb4 ff19 fs26 fc0 sc0 ls0 ws0">simplify <span class="_ _e"> </span>the <span class="_"> </span>locking <span class="_ _e"> </span>of <span class="_ _e"> </span>the <span class="_"> </span>printer<span class="_ _0"></span>-related <span class="_ _53"> </span>data <span class="_"> </span>structur<span class="_ _0"></span>es.) <span class="_ _4b"> </span>Then<span class="_ _59"> </span>we <span class="_"> </span>call</div><div class="t m0 x11a h4d y5bb5 ff1a fs26 fc0 sc0 ls0 ws0">build_qonstart<span class="_ _44"> </span><span class="ff19">to <span class="_ _42"> </span>search <span class="_ _42"> </span>the <span class="_ _53"> </span>directories <span class="_ _42"> </span>in<span class="_ _44"> </span></span>/var/spool/printer<span class="_ _44"> </span><span class="ff19">for</span></div><div class="t m0 x11a h49 y5bb6 ff19 fs26 fc0 sc0 ls0 ws0">any <span class="_"> </span>pending <span class="_ _47"> </span>jobs.<span class="_ _60"> </span>For <span class="_ _47"> </span>each <span class="_"> </span>job <span class="_ _47"> </span>that <span class="_"> </span>we <span class="_ _47"> </span>ﬁnd <span class="_"> </span>on <span class="_ _47"> </span>disk, <span class="_"> </span>we <span class="_ _47"> </span>will <span class="_"> </span>create <span class="_"> </span>a</div><div class="t m0 x11a h49 y5bb7 ff19 fs26 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>e<span class="_ _44"> </span>to<span class="_ _35"> </span>let <span class="_ _42"> </span>the <span class="_ _42"> </span>printer <span class="_ _53"> </span>thread <span class="_ _23"> </span>know <span class="_ _42"> </span>that <span class="_ _42"> </span>it <span class="_ _53"> </span>should <span class="_ _42"> </span>send <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>to <span class="_ _42"> </span>the</div><div class="t m0 x11a h49 y5bb8 ff19 fs26 fc0 sc0 ls0 ws0">printer<span class="_ _6"></span><span class="ls1785">.A<span class="_ _64"></span><span class="ls1786">tt<span class="_ _4a"></span><span class="ls0">his <span class="_"> </span>point, <span class="_ _e"> </span>we <span class="_"> </span>ar<span class="ls1786">ed<span class="_ _4a"></span><span class="ls0">one <span class="_ _e"> </span>setting <span class="_"> </span>up <span class="_ _e"> </span>the <span class="_"> </span>daemon, <span class="_ _e"> </span>so <span class="_"> </span>we <span class="_ _e"> </span>log <span class="_"> </span>a</span></span></span></span></span></div><div class="t m0 x11a h49 y5bb9 ff19 fs26 fc0 sc0 ls0 ws0">message to indicate that the daemon has initialized successfully<span class="_ _4"></span>.</div><div class="t m0 x32 h4d y5bba ff19 fs26 fc0 sc0 ls0 ws0">[150 <span class="_ _a"></span>– <span class="_ _a"></span>167]<span class="_ _65"> </span><span class="ls164">We <span class="_ _45"> </span>c<span class="_ _9"></span></span>opy <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">rendezvous <span class="_ _a"></span>fd_set<span class="_ _44"> </span><span class="ff19">structur<span class="ls1787">et<span class="_ _c"></span><span class="ls0">o<span class="_ _44"> </span><span class="ff1a">rset<span class="_ _44"> </span></span>and <span class="_ _42"> </span>call<span class="_ _44"> </span><span class="ff1a">select<span class="_ _44"> </span></span>to</span></span></span></span></div><div class="t m0 x11a h49 y5bbb ff19 fs26 fc0 sc0 ls0 ws0">wait <span class="_ _42"> </span>for <span class="_ _53"> </span>one <span class="_ _53"> </span>of <span class="_ _53"> </span>the <span class="_ _42"> </span>ﬁle <span class="_ _53"> </span>descriptors <span class="_ _53"> </span>to <span class="_ _53"> </span>become <span class="_ _42"> </span>readable. <span class="_ _44"> </span>W<span class="_ _6"></span><span class="ls5a0">eh<span class="_ _c"></span><span class="ls0">ave <span class="_ _53"> </span>to <span class="_ _53"> </span>copy</span></span></div><div class="t m0 x11a h4d y5bbc ff1a fs26 fc0 sc0 ls0 ws0">rendezvous<span class="ff19 ls10a6">,b<span class="_ _c"></span><span class="ls0">ecause<span class="_ _44"> </span><span class="ff1a">select<span class="_ _44"> </span></span>will <span class="_ _53"> </span>modify <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">fd_set<span class="_ _44"> </span></span>structur<span class="ls1788">et<span class="_ _c"></span><span class="ls0">hat <span class="_ _42"> </span>we</span></span></span></span></div><div class="t m0 x11a h49 y5bbd ff19 fs26 fc0 sc0 ls0 ws0">pass <span class="_ _9"></span>to <span class="_ _23"></span>it <span class="_ _9"></span>to <span class="_ _9"></span>include <span class="_ _23"></span>only <span class="_ _9"></span>those <span class="_ _23"></span>ﬁle <span class="_ _9"></span>descriptors <span class="_ _9"></span>that <span class="_ _23"></span>satisfy <span class="_ _9"></span>the <span class="_ _23"></span>event.<span class="_ _5a"> </span>Since</div><div class="t m0 x11a h49 y5bbe ff19 fs26 fc0 sc0 ls0 ws0">the sockets have been initialized for use by a server<span class="_ _1"></span><span class="ls166e">,ar<span class="_ _4f"></span><span class="ls0">eadable ﬁle descriptor</span></span></div><div class="t m0 x11a h4d y5bbf ff19 fs26 fc0 sc0 ls0 ws0">means <span class="_ _23"> </span>that <span class="_ _23"> </span>a <span class="_ _42"> </span>connect <span class="_ _23"></span>request <span class="_ _23"></span>is <span class="_ _23"></span>pending.<span class="_ _51"> </span>After<span class="_ _35"> </span><span class="ff1a">select<span class="_ _35"> </span></span><span class="lscc">re</span>turns, <span class="_ _42"> </span>we <span class="_ _23"></span>check</div><div class="t m0 x11a h4d y5bc0 ff1a fs26 fc0 sc0 ls0 ws0">rset<span class="_ _66"> </span><span class="ff19">for <span class="_ _3"></span>a <span class="_ _2"></span>readable ﬁle <span class="_ _3"></span>descriptor<span class="_ _6"></span><span class="ls1789">.I<span class="_ _5b"></span><span class="ls0">f<span class="_ _47"> </span>we<span class="_ _66"> </span>ﬁnd <span class="_ _3"></span>one, <span class="_ _2"></span>we <span class="_ _2"></span>call<span class="_ _47"> </span><span class="ff1a">accept<span class="_ _47"> </span></span>to <span class="_ _2"></span>accept</span></span></span></div><div class="t m0 x11a h49 y5bc1 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>connection.<span class="_ _16"> </span>If <span class="_ _3"></span>this <span class="_ _3"></span>fails, <span class="_ _9"></span>we <span class="_ _3"></span>log <span class="_ _3"></span>an <span class="_ _3"></span>error <span class="_ _3"></span>message <span class="_ _3"></span>and <span class="_ _3"></span>continue <span class="_ _3"></span>checking</div><div class="t m0 x11a h49 y5bc2 ff19 fs26 fc0 sc0 ls0 ws0">for <span class="_ _9"></span>mor<span class="ls18c">er<span class="_ _43"></span><span class="ls0">eadable <span class="_ _23"></span>ﬁle <span class="_ _9"></span>descriptors.<span class="_ _5a"> </span>Otherwise, <span class="_ _9"></span>we <span class="_ _23"></span>create <span class="_ _3"></span>a <span class="_ _23"></span>thread <span class="_ _3"></span>to <span class="_ _23"></span>handle</span></span></div><div class="t m0 x11a h4d y5bc3 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>client <span class="_ _3"></span>connection.<span class="_ _16"> </span>The<span class="_ _47"> </span><span class="ff1a">main<span class="_ _45"> </span></span>thr<span class="_ _0"></span>ead <span class="_ _3"></span>loops, <span class="_ _3"></span>farming <span class="_ _3"></span>requests <span class="_ _3"></span>out <span class="_ _3"></span>to <span class="_ _3"></span>other</div><div class="t m0 x11a h4d y5bc4 ff19 fs26 fc0 sc0 ls0 ws0">threads for pr<span class="_ _0"></span>ocessing, and should never r<span class="_ _0"></span>each the<span class="_"> </span><span class="ff1a">exit<span class="_ _80"> </span></span>statement.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
