<div id="pf122" class="pf w4 h1f" data-page-no="122"><div class="pc pc122 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg122.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">256<span class="_ _1b"> </span><span class="ff19">Process <span class="_"> </span>Contr<span class="_ _0"></span>ol <span class="_ _222"> </span>Chapter<span class="_ _4b"> </span>8</span></div><div class="t m0 x3f h2b y12f ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _3"></span>general, <span class="_ _3"></span>we <span class="_ _3"></span>try <span class="_ _3"></span>to <span class="_ _3"></span>use <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1b">least-privilege<span class="_ _47"> </span></span>model <span class="_ _3"></span>when <span class="_ _3"></span>we <span class="_ _3"></span>design <span class="_ _9"></span>our <span class="_ _3"></span>applications.</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">According <span class="_"> </span>to <span class="_ _e"> </span>this <span class="_"> </span>model, <span class="_"> </span>our <span class="_"> </span>pr<span class="_ _0"></span>ograms <span class="_"> </span>should <span class="_"> </span>use <span class="_"> </span>the <span class="_ _e"> </span>least <span class="_"> </span>privilege <span class="_"> </span>necessary <span class="_"> </span>to</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">accomplish <span class="_ _9"></span>any <span class="_ _23"></span>given <span class="_ _9"></span>task.<span class="_ _5a"> </span>This <span class="_ _23"></span>reduces <span class="_ _9"></span>the <span class="_ _9"></span>risk <span class="_ _23"></span>that <span class="_ _9"></span>security <span class="_ _9"></span>might <span class="_ _23"></span>be <span class="_ _9"></span>compromised</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">by <span class="_ _35"> </span>a <span class="_ _35"> </span>malicious <span class="_ _35"> </span>user <span class="_ _44"> </span>trying <span class="_ _35"> </span>to <span class="_ _35"> </span>trick <span class="_ _35"> </span>our <span class="_ _35"> </span>programs <span class="_ _35"> </span>into <span class="_ _35"> </span>using <span class="_ _35"> </span>their <span class="_ _44"> </span>privileges <span class="_ _35"> </span>in</div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">unintended ways.</div><div class="t m0 x3f h26 y134 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _59"> </span>c<span class="_ _9"></span><span class="ls0">an <span class="_ _47"> </span>set <span class="_ _47"> </span>the <span class="_ _47"> </span>real <span class="_"> </span>user <span class="_ _47"> </span>ID <span class="_ _47"> </span>and <span class="_ _47"> </span>effective <span class="_ _66"> </span>user <span class="_ _47"> </span>ID <span class="_ _47"> </span>with <span class="_ _47"> </span>the<span class="_ _61"> </span><span class="ff1a">setuid<span class="_ _16"> </span></span>function.</span></div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls0 ws0">Similarly<span class="_ _4"></span>,<span class="_ _44"> </span>we<span class="_ _4b"> </span>can <span class="_ _42"> </span>set <span class="_ _53"> </span>the <span class="_ _53"> </span>real <span class="_ _42"> </span>group <span class="_ _42"> </span>ID <span class="_ _42"> </span>and <span class="_ _53"> </span>the <span class="_ _53"> </span>effective <span class="_ _42"> </span>group <span class="_ _42"> </span>ID <span class="_ _42"> </span>with <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1a">setgid</span></div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">function.</div><div class="t m0 x3f h57 y21b3 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h57 y21b4 ff1a fs2d fc0 sc0 ls0 ws0">int setuid(uid_t<span class="_"> </span><span class="ff1b">uid</span>);</div><div class="t m0 x3f h57 y21b5 ff1a fs2d fc0 sc0 ls0 ws0">int setgid(gid_t<span class="_"> </span><span class="ff1b">gid</span>);</div><div class="t m0 x1af h5f y21b6 ff19 fs2d fc0 sc0 ls0 ws0">Both return: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x32 h49 y21b7 ff19 fs26 fc0 sc0 ls0 ws0">Ther<span class="lsa0a">ea<span class="_ _43"></span><span class="lscc">re <span class="_ _42"> </span>r<span class="ls0">ules <span class="_ _23"> </span>for <span class="_ _23"> </span>who <span class="_ _23"> </span>can <span class="_ _23"> </span>change <span class="_ _23"> </span>the <span class="_ _23"> </span>IDs.<span class="_ _51"> </span>Let’s <span class="_ _23"> </span>consider <span class="_ _23"> </span>only <span class="_ _42"> </span>the <span class="_ _23"></span>user <span class="_ _23"></span>ID <span class="_ _23"></span>for <span class="_ _23"></span>now<span class="_ _6"></span>.</span></span></span></div><div class="t m0 x32 h49 y21b8 ff19 fs26 fc0 sc0 ls0 ws0">(Everything we describe for the user ID also applies to the group ID.)</div><div class="t m0 x3f h4d y21b9 ff19 fs26 fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>If<span class="_ _35"> </span>the <span class="_ _23"></span>pr<span class="_ _0"></span>ocess <span class="_ _23"></span>has <span class="_ _23"></span>superuser <span class="_ _9"></span>privileges, <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">setuid<span class="_ _35"> </span></span>function <span class="_ _23"></span>sets <span class="_ _23"></span>the <span class="_ _9"></span>real <span class="_ _23"></span>user</div><div class="t m0 x41 h4a y21ba ff19 fs26 fc0 sc0 ls0 ws0">ID, effective user ID, and saved set-user<span class="_ _0"></span>-ID to<span class="_"> </span><span class="ff1b">uid</span>.</div><div class="t m0 x3f h4a y21bb ff19 fs26 fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>If<span class="_ _45"> </span>the <span class="_ _9"></span>process <span class="_ _3"></span>does <span class="_ _9"></span>not <span class="_ _9"></span>have <span class="_ _9"></span>superuser <span class="_ _3"></span>privileges, <span class="_ _9"></span>but<span class="_ _45"> </span><span class="ff1b">uid<span class="_ _45"> </span></span>equals <span class="_ _3"></span>either <span class="_ _9"></span>the <span class="_ _9"></span>real</div><div class="t m0 x41 h4d y21bc ff19 fs26 fc0 sc0 ls0 ws0">user <span class="_ _9"></span>ID <span class="_ _9"></span>or <span class="_ _9"></span>the <span class="_ _9"></span>saved <span class="_ _9"></span>set-user-ID,<span class="_ _45"> </span><span class="ff1a">setuid<span class="_ _45"> </span></span>sets <span class="_ _9"></span>only <span class="_ _9"></span>the <span class="_ _9"></span>effective <span class="_ _3"></span>user <span class="_ _9"></span>ID <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1b">uid</span>.</div><div class="t m0 x41 h49 y21bd ff19 fs26 fc0 sc0 ls0 ws0">The real user ID and the saved set-user<span class="_ _0"></span>-ID ar<span class="_ _0"></span><span class="lsd3">en<span class="_ _d"></span><span class="ls0">ot changed.</span></span></div><div class="t m0 x3f h4d y21be ff19 fs26 fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>If<span class="_ _59"> </span>neither <span class="_"> </span>of <span class="_ _e"> </span>these <span class="_"> </span>two <span class="_"> </span>conditions <span class="_ _e"> </span>is <span class="_"> </span>true,<span class="_ _4b"> </span><span class="ff1a">errno<span class="_ _59"> </span></span>is <span class="_"> </span>set <span class="_ _e"> </span>to<span class="_ _59"> </span><span class="ff1a">EPERM<span class="_ _59"> </span></span>and<span class="_ _46"> </span><span class="ff20">−</span><span class="lsa0b">1i<span class="_ _4a"></span><span class="ls0">s</span></span></div><div class="t m0 x41 h49 y21bf ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turned.</span></div><div class="t m0 x32 h4d y21c0 ff19 fs26 fc0 sc0 ls0 ws0">Here, <span class="_ _2"></span>we <span class="_ _3"></span>ar<span class="ls37e">ea<span class="_ _8"></span><span class="ls0">ssuming <span class="_ _3"></span>that<span class="_ _47"> </span><span class="ff1a">_POSIX_SAVED_IDS<span class="_ _47"> </span></span>is <span class="_ _9"></span>true. <span class="_ _47"> </span>If<span class="_ _47"> </span>this <span class="_ _3"></span>featur<span class="ls7b4">ei<span class="_ _8"></span><span class="ls0">sn’t <span class="_ _3"></span>provided,</span></span></span></span></div><div class="t m0 x32 h49 y21c1 ff19 fs26 fc0 sc0 ls0 ws0">then delete all preceding r<span class="_ _0"></span>efer<span class="_ _0"></span>ences to the saved set-user-ID.</div><div class="t m0 x76 h2d y21c2 ff19 fs10 fc0 sc0 ls0 ws0">The <span class="_ _2"></span>saved <span class="_ _3"></span>IDs <span class="_ _2"></span>ar<span class="ls5ae">eam<span class="_ _d"></span><span class="ls0">andatory <span class="_ _3"></span>feature<span class="_ _80"> </span>in<span class="_ _80"> </span>the <span class="_ _2"></span>2001 <span class="_ _3"></span>version <span class="_ _2"></span>of <span class="_ _3"></span>POSIX.1.<span class="_ _4b"> </span>They <span class="_ _2"></span>wer<span class="lsa0c">eo<span class="_ _5"></span><span class="ls0">ptional <span class="_ _2"></span>in</span></span></span></span></div><div class="t m0 x76 h2d y21c3 ff19 fs10 fc0 sc0 ls0 ws0">older <span class="_ _47"> </span>versions <span class="_ _47"> </span>of <span class="_ _66"> </span>POSIX.<span class="_ _48"> </span><span class="ls292">To <span class="_ _4b"> </span>s<span class="_ _3"></span></span>ee <span class="_ _47"> </span>whether <span class="_ _47"> </span>an <span class="_ _47"> </span>implementation <span class="_ _47"> </span>supports <span class="_ _47"> </span>this <span class="_ _47"> </span>feature, <span class="_ _66"> </span>an</div><div class="t m0 x76 h5e y21c4 ff19 fs10 fc0 sc0 ls0 ws0">application <span class="_ _23"> </span>can <span class="_ _23"> </span>test <span class="_ _42"> </span>for <span class="_ _23"> </span>the <span class="_ _23"> </span>constant<span class="_ _45"> </span><span class="ff1a">_POSIX_SAVED_IDS<span class="_ _45"> </span></span>at <span class="_ _23"> </span>compile <span class="_ _23"> </span>time <span class="_ _42"> </span>or <span class="_ _23"> </span>call<span class="_ _45"> </span><span class="ff1a">sysconf</span></div><div class="t m0 x76 h5e y21c5 ff19 fs10 fc0 sc0 ls0 ws0">with the<span class="_"> </span><span class="ff1a">_SC_SAVED_IDS<span class="_ _53"> </span></span>argument at runtime.</div><div class="t m0 x3f h49 y21c6 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _53"> </span>c<span class="_ _9"></span><span class="ls0">an make a few statements about the three user IDs that the kernel maintains.</span></div><div class="t m0 x3f h49 y21c7 ff19 fs26 fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>Only<span class="_ _45"> </span><span class="lsa0d">as<span class="_ _b"></span><span class="ls0">uperuser <span class="_ _9"></span>process <span class="_ _9"></span>can <span class="_ _23"></span>change <span class="_ _9"></span>the <span class="_ _23"></span>real <span class="_ _9"></span>user <span class="_ _9"></span>ID.<span class="_ _51"> </span>Normally<span class="_ _4"></span><span class="lsa0d">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>real <span class="_ _9"></span>user</span></span></span></span></div><div class="t m0 x41 h4d y21c8 ff19 fs26 fc0 sc0 ls0 ws0">ID <span class="_ _2"></span>is <span class="_ _3"></span>set <span class="_ _3"></span>by <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">login</span></div><div class="t m0 x5a h49 y21c9 ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x1cf h49 y21c8 ff19 fs26 fc0 sc0 ls0 ws0">1</div><div class="t m0 x15e h49 y21c9 ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 x1b7 h49 y21c8 ff19 fs26 fc0 sc0 ls0 ws0">program <span class="_ _2"></span>when <span class="_ _2"></span>we <span class="_ _3"></span>log <span class="_ _3"></span>in <span class="_ _2"></span>and <span class="_ _3"></span>never <span class="_ _3"></span>changes.<span class="_ _61"> </span>Because</div><div class="t m0 x41 h4d y21ca ff1a fs26 fc0 sc0 ls0 ws0">login<span class="_ _80"> </span><span class="ff19">is a superuser process, it sets all thr<span class="_ _0"></span>ee user IDs when it calls<span class="_"> </span><span class="ff1a">setuid</span>.</span></div><div class="t m0 x3f h4d y21cb ff19 fs26 fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>The<span class="_"> </span>effective user <span class="_ _2"></span>ID is <span class="_ _2"></span>set by <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">exec<span class="_ _66"> </span></span>functions <span class="_ _2"></span>only if <span class="_ _2"></span>the set-user-ID bit is <span class="_ _2"></span>set</div><div class="t m0 x41 h4d y21cc ff19 fs26 fc0 sc0 ls0 ws0">for the program ﬁle.<span class="_ _59"> </span>If the set-user-ID bit is not set, the<span class="_"> </span><span class="ff1a">exec<span class="_ _66"> </span></span>functions leave the</div><div class="t m0 x41 h4d y21cd ff19 fs26 fc0 sc0 ls0 ws0">effective <span class="_ _2"></span>user <span class="_ _3"></span>ID <span class="_ _2"></span>as <span class="_ _3"></span>its <span class="_ _3"></span>current <span class="_ _2"></span>value.<span class="_ _16"> </span><span class="ls164">We <span class="_ _80"> </span>c<span class="_ _9"></span></span>an <span class="_ _3"></span>call<span class="_ _47"> </span><span class="ff1a">setuid<span class="_ _47"> </span></span>at <span class="_ _3"></span>any <span class="_ _2"></span>time <span class="_ _3"></span>to <span class="_ _3"></span>set <span class="_ _3"></span>the</div><div class="t m0 x41 h49 y21ce ff19 fs26 fc0 sc0 ls0 ws0">effective <span class="_ _9"></span>user <span class="_ _23"></span>ID <span class="_ _9"></span>to <span class="_ _23"></span>either <span class="_ _23"></span>the <span class="_ _9"></span>real <span class="_ _9"></span>user <span class="_ _23"></span>ID <span class="_ _23"></span>or <span class="_ _9"></span>the <span class="_ _23"></span>saved <span class="_ _23"></span>set-user-ID. <span class="_ _45"> </span>Naturally<span class="_ _4"></span>,</div><div class="t m0 x41 h49 y21cf ff19 fs26 fc0 sc0 ls0 ws0">we can’t set the effective user ID to any random value.</div><div class="t m0 x3f h4d y21d0 ff19 fs26 fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>The<span class="_ _47"> </span>saved <span class="_ _9"></span>set-user-ID <span class="_ _2"></span>is <span class="_ _3"></span>copied <span class="_ _3"></span>from <span class="_ _3"></span>the <span class="_ _3"></span>effective <span class="_ _3"></span>user <span class="_ _3"></span>ID <span class="_ _9"></span>by<span class="_ _47"> </span><span class="ff1a">exec</span><span class="lsa0e">.I<span class="_ _1d"></span><span class="lsa0f">ft<span class="_ _8"></span><span class="ls0">he <span class="_ _3"></span>ﬁle’s</span></span></span></div><div class="t m0 x41 h4d y21d1 ff19 fs26 fc0 sc0 ls0 ws0">set-user-ID <span class="_ _9"></span>bit <span class="_ _23"> </span>is <span class="_ _23"> </span>set, <span class="_ _23"></span>this <span class="_ _23"></span>copy <span class="_ _23"></span>is <span class="_ _23"></span>saved <span class="_ _9"></span>after<span class="_ _35"> </span><span class="ff1a">exec<span class="_ _35"> </span></span>stores <span class="_ _9"></span>the <span class="_ _23"> </span>effective <span class="_ _9"></span>user <span class="_ _23"> </span>ID</div><div class="t m0 x41 h49 y21d2 ff19 fs26 fc0 sc0 ls0 ws0">from the ﬁle’s user ID.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
