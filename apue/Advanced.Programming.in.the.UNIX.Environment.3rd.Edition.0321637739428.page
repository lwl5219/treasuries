<div id="pf1ac" class="pf w4 h1f" data-page-no="1ac"><div class="pc pc1ac w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg1ac.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">394<span class="_ _1b"> </span><span class="ff19">Threads <span class="_ _24b"> </span>Chapter<span class="_ _78"> </span><span class="ls7ed">11</span></span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 lsdb1 ws0">At<span class="_ _4f"></span><span class="ls0">hread can <span class="_ _2"></span>arrange <span class="_ _2"></span>for <span class="_ _2"></span>functions <span class="_ _2"></span>to be <span class="_ _2"></span>called <span class="_ _2"></span>when <span class="_ _2"></span>it <span class="_ _2"></span>exits, <span class="_ _2"></span>similar to <span class="_ _2"></span>the <span class="_ _2"></span>way <span class="_ _2"></span>that</span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">atexit<span class="_ _47"> </span></span>function (Section <span class="_ _2"></span>7.3) <span class="_ _2"></span>can <span class="_ _2"></span>be <span class="_ _2"></span>used <span class="_ _2"></span>by <span class="_ _2"></span>a <span class="_ _2"></span>process to <span class="_ _2"></span>arrange <span class="_ _2"></span>that <span class="_ _2"></span>functions <span class="_ _2"></span>are</div><div class="t m0 x32 h2b y131 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _3"></span>be <span class="_ _3"></span>called <span class="_ _3"></span>when <span class="_ _3"></span>the <span class="_ _3"></span>process <span class="_ _2"></span>exits.<span class="_ _16"> </span>The <span class="_ _3"></span>functions <span class="_ _3"></span>ar<span class="ls19d">ek<span class="_ _b"></span><span class="ls0">nown <span class="_ _3"></span>as<span class="_ _45"> </span><span class="ff1b">thr<span class="_ _0"></span>ead <span class="_ _2"></span>cleanup <span class="_ _3"></span>handlers<span class="ff19">.</span></span></span></span></div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">Mor<span class="lsdb2">et<span class="_ _5b"></span><span class="ls0">han <span class="_"> </span>one <span class="_"> </span>cleanup <span class="_"> </span>handler <span class="_"> </span>can <span class="_ _66"> </span>be <span class="_"> </span>established <span class="_"> </span>for <span class="_"> </span>a <span class="_ _66"> </span>thread. <span class="_ _59"> </span>The<span class="_ _46"> </span>handlers <span class="_ _66"> </span>are</span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">corded <span class="_ _3"></span>in <span class="_ _9"></span>a <span class="_ _9"></span>stack, <span class="_ _9"></span>which <span class="_ _3"></span>means <span class="_ _9"></span>that <span class="_ _9"></span>they <span class="_ _9"></span>ar<span class="lsdb3">ee<span class="_ _b"></span><span class="ls0">xecuted <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>reverse <span class="_ _3"></span>order <span class="_ _3"></span>from <span class="_ _3"></span>that</span></span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">with which they wer<span class="ls44">er<span class="_ _4f"></span><span class="ls0">egistered.</span></span></div><div class="t m0 x3f h57 y3242 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;pthread.h&gt;</div><div class="t m0 x3f h57 y3243 ff1a fs2d fc0 sc0 ls0 ws0">void pthread_cleanup_push(void (*<span class="ff1b">rtn</span>)(void *), void *<span class="ff1b">arg</span>);</div><div class="t m0 x3f h57 y3244 ff1a fs2d fc0 sc0 ls0 ws0">void pthread_cleanup_pop(int<span class="_"> </span><span class="ff1b">execute</span>);</div><div class="t m0 x32 h4d y3245 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _16"> </span><span class="ff1a">pthread_cleanup_push<span class="_ _61"> </span></span>function <span class="_ _45"> </span>schedules <span class="_ _47"> </span>the <span class="_ _47"> </span>cleanup <span class="_ _47"> </span>function,<span class="_ _16"> </span><span class="ff1b">rtn</span>,<span class="_ _16"> </span>to<span class="_ _16"> </span>be</div><div class="t m0 x32 h4a y3246 ff19 fs26 fc0 sc0 ls0 ws0">called <span class="_ _42"> </span>with <span class="_ _42"> </span>the <span class="_ _42"> </span>single <span class="_ _42"> </span>argument,<span class="_ _35"> </span><span class="ff1b">arg</span><span class="lsdb4">,w<span class="_ _43"></span><span class="ls0">hen <span class="_ _23"> </span>the <span class="_ _42"> </span>thread <span class="_ _42"> </span>performs <span class="_ _42"> </span>one <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>following</span></span></div><div class="t m0 x32 h49 y3247 ff19 fs26 fc0 sc0 ls0 ws0">actions:</div><div class="t m0 x3f h4d y3248 ff19 fs26 fc0 sc0 ls15d ws0">•M<span class="_ _4d"></span><span class="ls0">akes a call to<span class="_"> </span><span class="ff1a">pthread_exit</span></span></div><div class="t m0 x3f h49 y3249 ff19 fs26 fc0 sc0 ls15d ws0">•R<span class="_ _4d"></span><span class="ls0">esponds to a cancellation request</span></div><div class="t m0 x3f h4d y324a ff19 fs26 fc0 sc0 ls15d ws0">•M<span class="_ _4d"></span><span class="ls0">akes a call to<span class="_"> </span><span class="ff1a">pthread_cleanup_pop<span class="_ _80"> </span></span>with a nonzero<span class="_"> </span><span class="ff1b">execute<span class="_"> </span></span>argument</span></div><div class="t m0 x3f h4a y324b ff19 fs26 fc0 sc0 ls0 ws0">If <span class="_ _23"></span>the<span class="_ _35"> </span><span class="ff1b">execute<span class="_ _45"> </span></span>argument <span class="_ _23"></span>is <span class="_ _23"></span>set <span class="_ _23"></span>to <span class="_ _23"></span>zero, <span class="_ _9"></span>the <span class="_ _23"> </span>cleanup <span class="_ _23"> </span>function <span class="_ _23"> </span>is <span class="_ _23"> </span>not <span class="_ _23"> </span>called.<span class="_ _51"> </span>In <span class="_ _23"> </span>either</div><div class="t m0 x32 h4d y324c ff19 fs26 fc0 sc0 ls0 ws0">case,<span class="_ _66"> </span><span class="ff1a">pthread_cleanup_pop<span class="_ _47"> </span></span><span class="lscc">re<span class="_ _2"></span></span>moves <span class="_ _2"></span>the <span class="_ _3"></span>cleanup <span class="_ _2"></span>handler <span class="_ _3"></span>established <span class="_ _2"></span>by <span class="_ _3"></span>the <span class="_ _2"></span>last <span class="_ _3"></span>call</div><div class="t m0 x32 h4d y324d ff19 fs26 fc0 sc0 ls0 ws0">to<span class="_"> </span><span class="ff1a">pthread_cleanup_push</span>.</div><div class="t m0 x3f h49 y324e ff19 fs26 fc0 sc0 lsdb5 ws0">Ar<span class="_ _5b"></span><span class="ls0">estriction <span class="_"> </span>with <span class="_"> </span>these <span class="_"> </span>functions <span class="_"> </span>is <span class="_"> </span>that, <span class="_"> </span>because <span class="_"> </span>they <span class="_"> </span>can <span class="_"> </span>be <span class="_"> </span>implemented <span class="_"> </span>as</span></div><div class="t m0 x32 h49 y324f ff19 fs26 fc0 sc0 ls0 ws0">macros, <span class="_ _23"></span>they <span class="_ _23"> </span>must <span class="_ _42"> </span>be <span class="_ _42"> </span>used <span class="_ _23"> </span>in <span class="_ _42"> </span>matched <span class="_ _23"> </span>pairs <span class="_ _42"> </span>within <span class="_ _42"> </span>the <span class="_ _23"> </span>same <span class="_ _42"> </span>scope <span class="_ _23"> </span>in <span class="_ _42"> </span>a <span class="_ _42"> </span>thr<span class="_ _0"></span>ead. <span class="_ _35"> </span>The</div><div class="t m0 x32 h4d y3250 ff19 fs26 fc0 sc0 ls0 ws0">macr<span class="lsdb6">od<span class="_ _b"></span><span class="ls0">eﬁnition <span class="_ _3"></span>of<span class="_ _45"> </span><span class="ff1a">pthread_cleanup_push<span class="_ _47"> </span></span>can <span class="_ _3"></span>include <span class="_ _3"></span>a<span class="_ _45"> </span><span class="ff1a">{<span class="_ _47"> </span></span>character<span class="_ _1"></span>,<span class="_ _47"> </span>in<span class="_ _47"> </span>which <span class="_ _9"></span>case</span></span></div><div class="t m0 x32 h4d y3251 ff19 fs26 fc0 sc0 ls0 ws0">the matching<span class="_"> </span><span class="ff1a">}<span class="_ _80"> </span></span>character is in the<span class="_"> </span><span class="ff1a">pthread_cleanup_pop<span class="_ _66"> </span></span>deﬁnition.</div><div class="t m0 x35 h4c y3252 ff16 fs26 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h49 y3253 ff19 fs26 fc0 sc0 ls0 ws0">Figur<span class="lsdb7">e1<span class="_ _26"></span><span class="ls0">1.5 <span class="_ _66"> </span>shows <span class="_ _47"> </span>how <span class="_ _47"> </span>to <span class="_ _66"> </span>use <span class="_ _47"> </span>thread <span class="_ _66"> </span>cleanup <span class="_ _47"> </span>handlers.<span class="_ _50"> </span>Although <span class="_ _47"> </span>the <span class="_ _66"> </span>example <span class="_ _47"> </span>is</span></span></div><div class="t m0 x32 h49 y3254 ff19 fs26 fc0 sc0 ls0 ws0">somewhat contrived, it illustrates the mechanics <span class="_ _2"></span>involved.<span class="_ _46"> </span>Note that although we <span class="_ _2"></span>never</div><div class="t m0 x32 h49 y3255 ff19 fs26 fc0 sc0 ls0 ws0">intend <span class="_ _53"> </span>to <span class="_ _53"> </span>pass <span class="_ _e"> </span>zero<span class="_ _44"> </span>as<span class="_ _4b"> </span>an<span class="_ _4b"> </span>a<span class="lscc">rg</span>ument <span class="_ _e"> </span>to <span class="_ _53"> </span>the <span class="_ _e"> </span>thread <span class="_ _42"> </span>start-up <span class="_ _e"> </span>routines, <span class="_ _53"> </span>we <span class="_ _53"> </span>still <span class="_ _53"> </span>need <span class="_ _e"> </span>to</div><div class="t m0 x32 h4d y3256 ff19 fs26 fc0 sc0 ls0 ws0">match <span class="_ _53"> </span>calls <span class="_ _e"> </span>to<span class="_ _4b"> </span><span class="ff1a">pthread_cleanup_pop<span class="_ _4b"> </span></span>with <span class="_ _53"> </span>the <span class="_ _53"> </span>calls <span class="_ _e"> </span>to<span class="_ _4b"> </span><span class="ff1a">pthread_cleanup_push</span>;</div><div class="t m0 x32 h49 y3257 ff19 fs26 fc0 sc0 ls0 ws0">otherwise, the program might not compile.</div><div class="t m0 x32 h5d y3258 ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h5d y3259 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;pthread.h&gt;</div><div class="t m0 x32 h5d y325a ff1a fs2f fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h5d y325b ff1a fs2f fc0 sc0 ls0 ws0">cleanup(void *arg)</div><div class="t m0 x32 h5d y325c ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y325d ff1a fs2f fc0 sc0 ls0 ws0">printf(&quot;cleanup: %s\n&quot;, (char *)arg);</div><div class="t m0 x32 h5d y325e ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h5d y325f ff1a fs2f fc0 sc0 ls0 ws0">void *</div><div class="t m0 x32 h5d y3260 ff1a fs2f fc0 sc0 ls0 ws0">thr_fn1(void *arg)</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
