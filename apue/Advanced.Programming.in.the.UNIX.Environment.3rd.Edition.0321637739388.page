<div id="pf184" class="pf w4 h1f" data-page-no="184"><div class="pc pc184 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg184.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">354<span class="_ _1b"> </span><span class="ff19">Signals <span class="_ _24b"> </span>Chapter<span class="_ _21"> </span>10</span></div><div class="t m0 x35 h26 y12f ff16 fsf fc0 sc0 ls0 ws0">Example <span class="_ _84"></span>—<span class="_ _9"></span><span class="ff1f">signal<span class="_ _66"> </span></span>Function</div><div class="t m0 x32 h26 y404 ff19 fsf fc0 sc0 ls0 ws0">Let’s <span class="_"> </span>now <span class="_ _66"> </span>implement <span class="_ _66"> </span>the<span class="_ _46"> </span><span class="ff1a">signal<span class="_ _61"> </span></span>function <span class="_"> </span>using<span class="_ _61"> </span><span class="ff1a">sigaction</span><span class="lscbb">.T<span class="_ _49"></span><span class="ls0">his <span class="_ _66"> </span>is <span class="_ _66"> </span>what <span class="_ _66"> </span>many</span></span></div><div class="t m0 x32 h2a y405 ff19 fsf fc0 sc0 ls0 ws0">platforms <span class="_ _2"></span>do <span class="_ _2"></span>(and <span class="_ _2"></span>what a <span class="_ _2"></span>note <span class="_ _2"></span>in <span class="_ _2"></span>the <span class="_ _2"></span>POSIX.1 <span class="_ _2"></span>Rationale <span class="_ _2"></span>states <span class="_ _2"></span>was <span class="_ _2"></span>the <span class="_ _2"></span>intent <span class="_ _2"></span>of <span class="_ _2"></span>POSIX).</div><div class="t m0 x32 h2a y1fb ff19 fsf fc0 sc0 ls0 ws0">Systems <span class="_"> </span>with <span class="_"> </span>binary <span class="_"> </span>compatibility <span class="_"> </span>constraints, <span class="_"> </span>on <span class="_"> </span>the <span class="_"> </span>other <span class="_"> </span>hand, <span class="_"> </span>might <span class="_"> </span>provide <span class="_"> </span>a</div><div class="t m0 x32 h26 y1fc ff1a fsf fc0 sc0 ls0 ws0">signal<span class="_"> </span><span class="ff19">function <span class="_ _47"> </span>that <span class="_ _45"> </span>supports <span class="_ _47"> </span>the <span class="_ _45"> </span>older<span class="_ _1"></span><span class="ls560">,u<span class="_ _62"></span><span class="ls0">nreliable-signal <span class="_ _47"> </span>semantics.<span class="_ _1a3"> </span>Unless <span class="_ _45"> </span>you</span></span></span></div><div class="t m0 x32 h2a y1fd ff19 fsf fc0 sc0 ls0 ws0">speciﬁcally <span class="_ _9"></span>requir<span class="lsaf1">et<span class="_ _43"></span><span class="ls0">hese <span class="_ _23"></span>older<span class="_ _6"></span><span class="lsaf1">,u<span class="_ _b"></span><span class="ls0">nreliable <span class="_ _9"></span>semantics <span class="_ _9"></span>(for <span class="_ _23"></span>backwar<span class="ls7f4">dc<span class="_ _b"></span><span class="ls0">ompatibility), <span class="_ _3"></span>you</span></span></span></span></span></span></div><div class="t m0 x32 h26 y406 ff19 fsf fc0 sc0 ls0 ws0">should <span class="_ _23"></span>use <span class="_ _23"></span>the <span class="_ _23"></span>following <span class="_ _23"></span>implementation <span class="_ _23"></span>of<span class="_ _35"> </span><span class="ff1a">signal<span class="_ _45"> </span></span>or <span class="_ _23"> </span>call<span class="_ _35"> </span><span class="ff1a">sigaction<span class="_ _35"> </span></span>directly<span class="_ _4"></span><span class="lscbc">.(<span class="_ _7"></span><span class="ls0">As</span></span></div><div class="t m0 x32 h26 y407 ff19 fsf fc0 sc0 ls0 ws0">you <span class="_"> </span>might <span class="_"> </span>guess, <span class="_"> </span>an <span class="_"> </span>implementation <span class="_"> </span>of<span class="_ _46"> </span><span class="ff1a">signal<span class="_ _46"> </span></span>with <span class="_ _66"> </span>the <span class="_"> </span>old <span class="_"> </span>semantics <span class="_ _66"> </span>could <span class="_"> </span>call</div><div class="t m0 x32 h26 y408 ff1a fsf fc0 sc0 ls0 ws0">sigaction<span class="_ _44"> </span><span class="ff19">specifying<span class="_ _4b"> </span></span>SA_RESETHAND<span class="_ _44"> </span><span class="ff19">and<span class="_ _4b"> </span></span>SA_NODEFER<span class="ff19">.) <span class="_ _4b"> </span>All<span class="_ _44"> </span>the <span class="_ _53"> </span>examples <span class="_ _53"> </span>in <span class="_ _53"> </span>this</span></div><div class="t m0 x32 h26 y409 ff19 fsf fc0 sc0 ls0 ws0">text that call<span class="_"> </span><span class="ff1a">signal<span class="_ _80"> </span></span>call the function shown in Figur<span class="ls44">e1<span class="_ _d"></span><span class="ls0">0.18.</span></span></div><div class="t m0 x32 h4e y2d4f ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y2d50 ff1a fs28 fc0 sc0 ls0 ws0">/* Reliable version of signal(), using POSIX sigaction().<span class="_ _d9"> </span>*/</div><div class="t m0 x32 h4e y2d51 ff1a fs28 fc0 sc0 ls0 ws0">Sigfunc *</div><div class="t m0 x32 h4e y2d52 ff1a fs28 fc0 sc0 ls0 ws0">signal(int signo, Sigfunc *func)</div><div class="t m0 x32 h4e y2d53 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y2d54 ff1a fs28 fc0 sc0 ls0 ws0">struct sigaction<span class="_ _15"> </span>act, oact;</div><div class="t m0 x8a h4e y2d55 ff1a fs28 fc0 sc0 ls0 ws0">act.sa_handler = func;</div><div class="t m0 x8a h4e y2d56 ff1a fs28 fc0 sc0 ls0 ws0">sigemptyset(&amp;act.sa_mask);</div><div class="t m0 x8a h4e y2d57 ff1a fs28 fc0 sc0 ls0 ws0">act.sa_flags = 0;</div><div class="t m0 x8a h4e y2d58 ff1a fs28 fc0 sc0 ls0 ws0">if (signo == SIGALRM) {</div><div class="t m0 x32 h4e y2d59 ff1a fs28 fc0 sc0 ls0 ws0">#ifdef <span class="_"> </span>SA_INTERRUPT</div><div class="t m0 x9d h4e y2d5a ff1a fs28 fc0 sc0 ls0 ws0">act.sa_flags |= SA_INTERRUPT;</div><div class="t m0 x32 h4e y2d5b ff1a fs28 fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x8a h4e y2d5c ff1a fs28 fc0 sc0 ls1b6 ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x9d h4e y2d5d ff1a fs28 fc0 sc0 ls0 ws0">act.sa_flags |= SA_RESTART;</div><div class="t m0 x8a h4e y2d5e ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h4e y2d5f ff1a fs28 fc0 sc0 ls0 ws0">if (sigaction(signo, &amp;act, &amp;oact) &lt; 0)</div><div class="t m0 x9d h4e y2d60 ff1a fs28 fc0 sc0 ls0 ws0">return(SIG_ERR);</div><div class="t m0 x8a h4e y2d61 ff1a fs28 fc0 sc0 ls0 ws0">return(oact.sa_handler);</div><div class="t m0 x32 h4e y2d62 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 xd0 h4f y2d63 ff18 fs11 fc0 sc0 ls0 ws0">Figure 10.18<span class="_ _5a"> </span><span class="ff19">An implementation of<span class="_"> </span><span class="ff1a">signal<span class="_ _e"> </span></span>using<span class="_"> </span><span class="ff1a">sigaction</span></span></div><div class="t m0 x32 h54 y2d64 ff19 fs2c fc0 sc0 ls0 ws0">Note <span class="_ _45"> </span>that <span class="_ _45"> </span>we <span class="_ _35"> </span>must <span class="_ _45"> </span>use<span class="_ _5a"> </span><span class="ff1a">sigemptyset<span class="_"> </span></span>to <span class="_ _45"> </span>initialize <span class="_ _45"> </span>the<span class="_ _51"> </span><span class="ff1a">sa_mask<span class="_"> </span></span>member <span class="_ _45"> </span>of <span class="_ _45"> </span>the</div><div class="t m0 x32 h54 y2d65 ff19 fs2c fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>e. <span class="_"> </span>W<span class="_ _6"></span>e’r<span class="ls142">en<span class="_ _4f"></span><span class="ls0">ot guaranteed that<span class="_ _5e"> </span><span class="ff1a">act.sa_mask = 0<span class="_ _5e"> </span></span>does the same thing.</span></span></div><div class="t m0 x3f h54 y2d66 ff19 fs2c fc0 sc0 ls155 ws0">We <span class="_ _45"> </span>i<span class="_ _9"></span><span class="ls0">ntentionally <span class="_ _23"> </span>set <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">SA_RESTART<span class="_ _44"> </span></span>ﬂag <span class="_ _42"> </span>for <span class="_ _23"> </span>all <span class="_ _42"> </span>signals <span class="_ _42"> </span>other <span class="_ _23"> </span>than<span class="_ _44"> </span><span class="ff1a">SIGALRM</span><span class="lscbd">,s<span class="_ _43"></span><span class="ls0">o</span></span></span></div><div class="t m0 x32 h55 y2d67 ff19 fs2c fc0 sc0 ls0 ws0">that <span class="_ _9"></span>any <span class="_ _23"></span>system <span class="_ _9"></span>call <span class="_ _9"></span>interrupted <span class="_ _23"></span>by <span class="_ _9"></span>these <span class="_ _9"></span>other <span class="_ _23"></span>signals <span class="_ _9"></span>will <span class="_ _9"></span>be <span class="_ _23"></span>automatically <span class="_ _9"></span>restarted.</div><div class="t m0 x32 h54 y2d68 ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _23"> </span>reason <span class="_ _42"> </span>we <span class="_ _23"> </span>don’t <span class="_ _42"> </span>want<span class="_ _35"> </span><span class="ff1a">SIGALRM<span class="_ _44"> </span></span><span class="ls150">re</span>started <span class="_ _42"> </span>is <span class="_ _23"> </span>to <span class="_ _42"> </span>allow <span class="_ _42"> </span>us <span class="_ _23"> </span>to <span class="_ _42"> </span>set <span class="_ _42"> </span>a <span class="_ _23"> </span>timeout <span class="_ _42"> </span>for <span class="_ _42"> </span>I/O</div><div class="t m0 x32 h55 y2d69 ff19 fs2c fc0 sc0 ls0 ws0">operations. <span class="_"> </span>(Recall<span class="_"> </span>the discussion of Figur<span class="ls142">e1<span class="_ _4f"></span><span class="ls0">0.10.)</span></span></div><div class="t m0 x3f h54 y2d6a ff19 fs2c fc0 sc0 ls0 ws0">Some older systems, such <span class="_ _2"></span>as SunOS, deﬁne the<span class="_ _66"> </span><span class="ff1a">SA_INTERRUPT<span class="_ _66"> </span></span>ﬂag. <span class="_"> </span>These<span class="_"> </span>systems</div><div class="t m0 x32 h55 y2d6b ff19 fs2c fc0 sc0 ls150 ws0">re<span class="ls0">start <span class="_ _3"></span>interrupted <span class="_ _3"></span>system <span class="_ _3"></span>calls <span class="_ _3"></span>by <span class="_ _3"></span>default, <span class="_ _3"></span>so <span class="_ _3"></span>specifying <span class="_ _3"></span>this <span class="_ _3"></span>ﬂag <span class="_ _3"></span>causes <span class="_ _3"></span>system <span class="_ _3"></span>calls <span class="_ _9"></span>to</span></div><div class="t m0 x32 h54 y2d6c ff19 fs2c fc0 sc0 ls0 ws0">be <span class="_ _61"> </span>interrupted. <span class="_ _50"> </span>Linux<span class="_ _5f"> </span>deﬁnes <span class="_ _61"> </span>the<span class="_ _5f"> </span><span class="ff1a">SA_INTERRUPT<span class="_ _50"> </span></span>ﬂag <span class="_ _16"> </span>for <span class="_ _61"> </span>compatibility <span class="_ _16"> </span>with</div><div class="t m0 x32 h55 y2d6d ff19 fs2c fc0 sc0 ls0 ws0">applications <span class="_ _42"> </span>that <span class="_ _53"> </span>use <span class="_ _42"> </span>it, <span class="_ _53"> </span>but <span class="_ _42"> </span>by <span class="_ _53"> </span>default <span class="_ _53"> </span>does <span class="_ _42"> </span>not <span class="_ _53"> </span>restart <span class="_ _42"> </span>system <span class="_ _42"> </span>calls <span class="_ _53"> </span>when <span class="_ _42"> </span>the <span class="_ _53"> </span>signal</div><div class="t m0 x32 h54 y2d6e ff19 fs2c fc0 sc0 ls0 ws0">handler <span class="_ _9"></span>is <span class="_ _3"></span>installed <span class="_ _9"></span>with<span class="_ _45"> </span><span class="ff1a">sigaction</span><span class="lscbe">.T<span class="_ _62"></span><span class="ls0">he <span class="_ _9"></span>Single <span class="_ _3"></span>UNIX <span class="_ _9"></span>Speciﬁcation <span class="_ _9"></span>speciﬁes <span class="_ _9"></span>that <span class="_ _9"></span>the</span></span></div><div class="t m0 x32 h54 y2d6f ff1a fs2c fc0 sc0 ls0 ws0">sigaction<span class="_ _66"> </span><span class="ff19">function not <span class="_ _2"></span>restart interrupted system <span class="_ _2"></span>calls unless <span class="_ _2"></span>the<span class="_"> </span></span>SA_RESTART<span class="_ _66"> </span><span class="ff19">ﬂag <span class="_ _2"></span>is</span></div><div class="t m0 x32 h55 y2d70 ff19 fs2c fc0 sc0 ls0 ws0">speciﬁed.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
