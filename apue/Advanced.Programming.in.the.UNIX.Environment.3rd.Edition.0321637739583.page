<div id="pf247" class="pf w4 h1f" data-page-no="247"><div class="pc pc247 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg247.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>15.4<span class="_ _ec"> </span>Coprocesses<span class="_ _1b"> </span><span class="ff18">549</span></div><div class="t m0 x199 h51 y428c ff19 fs2a fc0 sc0 ls0 ws0">parent<span class="_ _b0"> </span>child (coprocess)</div><div class="t m0 x7 h52 y428d ff1a fs2a fc0 sc0 ls0 ws0">fd1[1]</div><div class="t m0 x7 h52 y428e ff1a fs2a fc0 sc0 ls0 ws0">fd2[0]</div><div class="t m0 x73 h76 y428d ff1b fs2a fc0 sc0 ls0 ws0">stdin</div><div class="t m0 x73 h76 y428e ff1b fs2a fc0 sc0 ls0 ws0">stdout</div><div class="t m0 x1f3 h2d y428f ff19 fs10 fc0 sc0 ls0 ws0">pipe1</div><div class="t m0 x1f3 h2e y4290 ff19 fs11 fc0 sc0 ls0 ws0">pipe2</div><div class="t m0 x215 h2e y4291 ff18 fs11 fc0 sc0 ls0 ws0">Figure 15.16<span class="_ _5a"> </span><span class="ff19">Driving a coprocess by writing its standar<span class="lsdb">di<span class="_ _5"></span><span class="ls0">nput and reading its standar<span class="lsdb">do<span class="_ _5"></span><span class="ls0">utput</span></span></span></span></span></div><div class="t m0 x3f h55 y4292 ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _3"></span>program <span class="_ _2"></span>in <span class="_ _3"></span>Figur<span class="ls11a8">e1<span class="_ _8"></span><span class="ls0">5.17 <span class="_ _3"></span>is <span class="_ _3"></span>a <span class="_ _3"></span>simple <span class="_ _3"></span>coprocess <span class="_ _3"></span>that <span class="_ _3"></span>reads <span class="_ _2"></span>two <span class="_ _3"></span>numbers <span class="_ _9"></span>from <span class="_ _2"></span>its</span></span></div><div class="t m0 x32 h55 y4293 ff19 fs2c fc0 sc0 ls0 ws0">standar<span class="ls11a9">di<span class="_ _26"></span><span class="ls0">nput, <span class="_ _45"> </span>computes <span class="_ _45"> </span>their <span class="_ _45"> </span>sum, <span class="_ _45"> </span>and <span class="_ _45"> </span>writes <span class="_ _45"> </span>the <span class="_ _45"> </span>sum <span class="_ _47"> </span>to <span class="_ _45"> </span>its <span class="_ _45"> </span>standar<span class="ls11aa">do<span class="_ _26"></span><span class="ls0">utput.</span></span></span></span></div><div class="t m0 x32 h55 y4294 ff19 fs2c fc0 sc0 ls0 ws0">(Coprocesses usually <span class="_ _3"></span>do <span class="_ _2"></span>mor<span class="ls11ab">ei<span class="_ _8"></span><span class="ls0">nteresting <span class="_ _2"></span>work <span class="_ _2"></span>than <span class="_ _3"></span>we <span class="_ _2"></span>illustrate <span class="_ _3"></span>here. <span class="_"> </span>This<span class="_ _47"> </span>example <span class="_ _2"></span>is</span></span></div><div class="t m0 x32 h55 y4295 ff19 fs2c fc0 sc0 ls0 ws0">admittedly <span class="_ _45"> </span>contrived <span class="_ _45"> </span>so <span class="_ _45"> </span>that <span class="_ _35"> </span>we <span class="_ _45"> </span>can <span class="_ _45"> </span>study <span class="_ _45"> </span>the <span class="_ _45"> </span>plumbing <span class="_ _35"> </span>needed <span class="_ _45"> </span>to <span class="_ _45"> </span>connect <span class="_ _45"> </span>the</div><div class="t m0 x32 h55 y4296 ff19 fs2c fc0 sc0 ls0 ws0">processes.)</div><div class="t m0 x32 h62 y4297 ff1a fs30 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h62 y4298 ff1a fs30 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h62 y4299 ff1a fs30 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h62 y429a ff1a fs30 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h62 y429b ff1a fs30 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>n,<span class="_"> </span>int1, int2;</div><div class="t m0 x8a h62 y429c ff1a fs30 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>line[MAXLINE];</div><div class="t m0 x8a h62 y429d ff1a fs30 fc0 sc0 ls0 ws0">while ((n = read(STDIN_FILENO, line, MAXLINE)) &gt; 0) {</div><div class="t m0 x9d h62 y429e ff1a fs30 fc0 sc0 ls0 ws0">line[n] = 0;<span class="_ _186"> </span>/* null terminate */</div><div class="t m0 x9d h62 y429f ff1a fs30 fc0 sc0 ls0 ws0">if (sscanf(line, &quot;%d%d&quot;, &amp;int1, &amp;int2) == 2) {</div><div class="t m0 x1f h62 y42a0 ff1a fs30 fc0 sc0 ls0 ws0">sprintf(line, &quot;%d\n&quot;, int1 + int2);</div><div class="t m0 x1f h62 y42a1 ff1a fs30 fc0 sc0 ls1185 ws0">n=s<span class="_ _1d"></span><span class="ls0">trlen(line);</span></div><div class="t m0 x1f h62 y42a2 ff1a fs30 fc0 sc0 ls0 ws0">if (write(STDOUT_FILENO, line, n) != n)</div><div class="t m0 x1ca h62 y42a3 ff1a fs30 fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><div class="t m0 x9d h62 y42a4 ff1a fs30 fc0 sc0 ls1185 ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x1f h62 y42a5 ff1a fs30 fc0 sc0 ls0 ws0">if (write(STDOUT_FILENO, &quot;invalid args\n&quot;, 13) != 13)</div><div class="t m0 x1ca h62 y42a6 ff1a fs30 fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><div class="t m0 x9d h62 y42a7 ff1a fs30 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h62 y42a8 ff1a fs30 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h62 y42a9 ff1a fs30 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h62 y42aa ff1a fs30 fc0 sc0 ls0 ws0">}</div><div class="t m0 x2f h30 y42ab ff18 fs13 fc0 sc0 ls0 ws0">Figure 15.17<span class="_ _5a"> </span><span class="ff19">Simple ﬁlter to add two numbers</span></div><div class="t m0 x32 h64 y42ac ff19 fs31 fc0 sc0 ls43f ws0">We <span class="_ _53"> </span>c<span class="_ _9"></span><span class="ls0">ompile this program and leave the executable in the ﬁle<span class="_"> </span><span class="ff1a">add2</span>.</span></div><div class="t m0 x3f h64 y42ad ff19 fs31 fc0 sc0 ls0 ws0">The program in Figur<span class="ls11ac">e1<span class="_ _4f"></span><span class="ls0">5.18 <span class="_ _2"></span>invokes the<span class="_"> </span><span class="ff1a">add2<span class="_ _66"> </span></span>coprocess after reading two numbers</span></span></div><div class="t m0 x32 h6e y42ae ff19 fs31 fc0 sc0 ls0 ws0">from its standar<span class="_ _0"></span><span class="ls229">di<span class="_ _d"></span><span class="ls0">nput. <span class="_"> </span>The<span class="_"> </span>value from the copr<span class="_ _0"></span>ocess is written to its standar<span class="ls229">do<span class="_ _4f"></span><span class="ls0">utput.</span></span></span></span></div><div class="t m0 x32 hc1 y42af ff1a fs69 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 hc1 y42b0 ff1a fs69 fc0 sc0 ls0 ws0">static void sig_pipe(int);<span class="_ _189"> </span>/* our signal handler */</div><div class="t m0 x32 hc1 y42b1 ff1a fs69 fc0 sc0 ls0 ws0">int</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
