<div id="pf345" class="pf w4 h1f" data-page-no="345"><div class="pc pc345 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg345.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">803</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">33 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">34 <span class="_ _68"> </span>*<span class="_"> </span>Given a keyword, scan the configuration file for a match</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">35 <span class="_ _68"> </span>*<span class="_"> </span>and return the string value corresponding to the keyword.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">36 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">37 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">38 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">39 <span class="_ _d9"> </span>static<span class="_"> </span>char *</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">40 <span class="_ _d9"> </span>scan_configfile(char<span class="_"> </span>*keyword)</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">41 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">42 <span class="_ _8a"> </span>int<span class="_ _166"> </span>n, match;</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">43 <span class="_ _8a"> </span>FILE<span class="_ _82"> </span>*fp;</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">44 <span class="_ _8a"> </span>char<span class="_ _82"> </span>keybuf[MAXKWLEN], pattern[MAXFMTLEN];</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">45 <span class="_ _8a"> </span>char<span class="_ _82"> </span>line[MAXCFGLINE];</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">46 <span class="_ _8a"> </span>static<span class="_"> </span>char <span class="_ _15"> </span>valbuf[MAXCFGLINE];</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">47 <span class="_ _8a"> </span>if<span class="_"> </span>((fp = fopen(CONFIG_FILE, &quot;r&quot;)) == NULL)</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">48 <span class="_ _176"> </span>log_sys(&quot;can’t<span class="_"> </span>open %s&quot;, CONFIG_FILE);</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">49 <span class="_ _8a"> </span>sprintf(pattern,<span class="_"> </span>&quot;%%%ds %%%ds&quot;, MAXKWLEN-1, MAXCFGLINE-1);</div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">50 <span class="_ _8a"> </span>match<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">51 <span class="_ _8a"> </span>while<span class="_"> </span>(fgets(line, MAXCFGLINE, fp) != NULL) {</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">52 <span class="_ _176"> </span>n<span class="_"> </span><span class="ls15c">=s<span class="_ _1d"></span><span class="ls0">scanf(line, pattern, keybuf, valbuf);</span></span></div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">53 <span class="_ _176"> </span>if<span class="_"> </span>(n == 2 &amp;&amp; strcmp(keyword, keybuf) == 0) {</div><div class="t m0 x32 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">54 <span class="_ _166"> </span>match<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y2f2f ff1a fs2d fc0 sc0 ls0 ws0">55 <span class="_ _166"> </span>break;</div><div class="t m0 x32 h57 y2f30 ff1a fs2d fc0 sc0 ls0 ws0">56 <span class="_ _176"> </span>}</div><div class="t m0 x32 h57 y56fd ff1a fs2d fc0 sc0 ls0 ws0">57 <span class="_ _8a"> </span>}</div><div class="t m0 x32 h57 y5848 ff1a fs2d fc0 sc0 ls0 ws0">58 <span class="_ _8a"> </span>fclose(fp);</div><div class="t m0 x32 h57 y5849 ff1a fs2d fc0 sc0 ls0 ws0">59 <span class="_ _8a"> </span>if<span class="_"> </span>(match != 0)</div><div class="t m0 x32 h57 y5a25 ff1a fs2d fc0 sc0 ls0 ws0">60 <span class="_ _176"> </span>return(valbuf);</div><div class="t m0 x32 h57 y5a26 ff1a fs2d fc0 sc0 ls0 ws0">61 <span class="_ _8a"> </span>else</div><div class="t m0 x32 h57 y5a36 ff1a fs2d fc0 sc0 ls0 ws0">62 <span class="_ _176"> </span>return(NULL);</div><div class="t m0 x32 h57 y5a37 ff1a fs2d fc0 sc0 ls0 ws0">63 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y5ab0 ff19 fs26 fc0 sc0 ls0 ws0">[33 <span class="_ _a"></span>– <span class="_ _a"></span>46]<span class="_ _65"> </span>The<span class="_ _44"> </span><span class="ff1a">scan_configfile<span class="_ _44"> </span></span>function <span class="_ _42"> </span>searches <span class="_ _42"> </span>through <span class="_ _42"> </span>the <span class="_ _42"> </span>printer <span class="_ _42"> </span>conﬁguration</div><div class="t m0 x2d h49 y5ab1 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle for the speciﬁed keyword.</div><div class="t m0 x32 h49 y5ab2 ff19 fs26 fc0 sc0 ls0 ws0">[47 <span class="_ _a"></span>– <span class="_ _a"></span>63]<span class="_ _65"> </span><span class="ls164">We <span class="_ _16"> </span>o<span class="_ _9"></span></span>pen <span class="_ _44"> </span>the <span class="_ _35"> </span>conﬁguration <span class="_ _35"> </span>ﬁle <span class="_ _35"> </span>for <span class="_ _35"> </span>reading <span class="_ _35"> </span>and <span class="_ _35"> </span>build <span class="_ _44"> </span>the <span class="_ _35"> </span>format <span class="_ _35"> </span>string</div><div class="t m0 x2d h4d y5ab3 ff19 fs26 fc0 sc0 ls0 ws0">corresponding <span class="_"> </span>to <span class="_"> </span>the <span class="_ _66"> </span>search <span class="_"> </span>pattern.<span class="_ _50"> </span>The <span class="_"> </span>notation<span class="_ _61"> </span><span class="ff1a">%%%ds<span class="_ _46"> </span></span>builds <span class="_ _66"> </span>a <span class="_ _66"> </span>format</div><div class="t m0 x2d h49 y5ab4 ff19 fs26 fc0 sc0 ls0 ws0">speciﬁer that limits the string size <span class="_ _2"></span>so we don’t overrun the buffers used to store</div><div class="t m0 x2d h49 y5ab5 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>strings <span class="_ _23"> </span>on <span class="_ _23"></span>the <span class="_ _9"></span>stack.<span class="_ _51"> </span><span class="ls164">We <span class="_ _66"> </span>r<span class="_ _9"></span></span>ead <span class="_ _23"></span>the <span class="_ _9"></span>ﬁle <span class="_ _23"> </span>one <span class="_ _23"></span>line <span class="_ _9"></span>at <span class="_ _23"></span>a <span class="_ _23"></span>time <span class="_ _9"></span>and <span class="_ _23"></span>scan <span class="_ _9"></span>for <span class="_ _23"> </span>two</div><div class="t m0 x2d h49 y5ab6 ff19 fs26 fc0 sc0 ls0 ws0">strings <span class="_ _9"></span>separated <span class="_ _3"></span>by <span class="_ _9"></span>white <span class="_ _9"></span>space; <span class="_ _9"></span>if <span class="_ _9"></span>we <span class="_ _3"></span>ﬁnd <span class="_ _9"></span>them, <span class="_ _9"></span>we <span class="_ _9"></span>compar<span class="ls174d">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>ﬁrst <span class="_ _9"></span>string</span></span></div><div class="t m0 x2d h49 y5ab7 ff19 fs26 fc0 sc0 ls0 ws0">with <span class="_ _3"></span>the <span class="_ _3"></span>keyword. <span class="_ _66"> </span>If<span class="_ _47"> </span>we <span class="_ _3"></span>ﬁnd <span class="_ _3"></span>a <span class="_ _3"></span>match <span class="_ _9"></span>or <span class="_ _2"></span>we <span class="_ _3"></span>reach <span class="_ _3"></span>the <span class="_ _3"></span>end <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle, <span class="_ _3"></span>the <span class="_ _3"></span>loop</div><div class="t m0 x2d h49 y5ab8 ff19 fs26 fc0 sc0 ls0 ws0">ends <span class="_ _2"></span>and <span class="_ _3"></span>we <span class="_ _3"></span>close <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle.<span class="_ _16"> </span>If <span class="_ _3"></span>the <span class="_ _3"></span>keywor<span class="ls174e">dm<span class="_ _b"></span><span class="ls0">atches, <span class="_ _3"></span>we <span class="_ _3"></span>return <span class="_ _2"></span>a <span class="_ _3"></span>pointer <span class="_ _3"></span>to <span class="_ _3"></span>the</span></span></div><div class="t m0 x2d h4d y5ab9 ff19 fs26 fc0 sc0 ls0 ws0">buffer containing the string after the keywor<span class="_ _0"></span>d; otherwise, we r<span class="_ _0"></span>eturn<span class="_"> </span><span class="ff1a">NULL</span>.</div><div class="t m0 x2d h4d y5aba ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _45"> </span>string <span class="_ _35"> </span>r<span class="_ _0"></span>eturned <span class="_ _45"> </span>is <span class="_ _35"> </span>stor<span class="_ _0"></span>ed <span class="_ _45"> </span>in <span class="_ _35"> </span>a <span class="_ _45"> </span>static <span class="_ _45"> </span>buffer <span class="_ _45"> </span>(<span class="ff1a">valbuf</span>), <span class="_ _35"> </span>which <span class="_ _45"> </span>can <span class="_ _45"> </span>be</div><div class="t m0 x2d h4d y5abb ff19 fs26 fc0 sc0 ls0 ws0">overwritten <span class="_ _2"></span>on <span class="_ _2"></span>successive <span class="_ _2"></span>calls.<span class="_ _46"> </span>Thus,<span class="_ _47"> </span><span class="ff1a">scan_configfile<span class="_ _66"> </span></span>can’t <span class="_ _2"></span>be <span class="_ _2"></span>called <span class="_ _2"></span>by <span class="_ _2"></span>a</div><div class="t m0 x2d h49 y5abc ff19 fs26 fc0 sc0 ls0 ws0">multithreaded application <span class="_ _2"></span>unless <span class="_ _2"></span>we <span class="_ _2"></span>take <span class="_ _2"></span>car<span class="ls140f">et<span class="_ _8"></span><span class="lsf45">oa<span class="_ _d"></span><span class="ls0">void <span class="_ _2"></span>calling <span class="_ _2"></span>it <span class="_ _2"></span>from multiple</span></span></span></div><div class="t m0 x2d h49 y5abd ff19 fs26 fc0 sc0 ls0 ws0">threads at the same time.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
