<div id="pf223" class="pf w4 h1f" data-page-no="223"><div class="pc pc223 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg223.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.5<span class="_ _20d"> </span>Asynchronous <span class="_"> </span>I/O<span class="_ _1b"> </span><span class="ff18">513</span></div><div class="t m0 x3f h57 y1295 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;aio.h&gt;</div><div class="t m0 x3f h57 y19f8 ff1a fs2d fc0 sc0 ls0 ws0">int aio_fsync(int<span class="_"> </span><span class="ff1b">op</span><span class="ls15c">,s<span class="_ _1d"></span><span class="ls0">truct aiocb *<span class="ff1b">aiocb</span>);</span></span></div><div class="t m0 x153 h5f y19f9 ff19 fs2d fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h4d y3ee1 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _45"> </span><span class="ff1a">aio_fildes<span class="_ _47"> </span></span>ﬁeld <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>AIO <span class="_ _9"></span>control <span class="_ _3"></span>block <span class="_ _9"></span>indicates <span class="_ _3"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>whose <span class="_ _9"></span>asynchronous</div><div class="t m0 x32 h4d y3ee2 ff19 fs26 fc0 sc0 ls0 ws0">writes <span class="_ _9"></span>ar<span class="ls10a7">es<span class="_ _b"></span><span class="ls0">ynched. <span class="_ _45"> </span>If<span class="_ _45"> </span>the<span class="_ _35"> </span><span class="ff1b">op<span class="_ _45"> </span></span>argument <span class="_ _9"></span>is <span class="_ _9"></span>set <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">O_DSYNC</span><span class="ls10a8">,t<span class="_ _b"></span><span class="ls0">hen <span class="_ _9"></span>the <span class="_ _23"></span>operation <span class="_ _23"></span>behaves</span></span></span></span></div><div class="t m0 x32 h4d y3ee3 ff19 fs26 fc0 sc0 ls0 ws0">like a call <span class="_ _2"></span>to<span class="_"> </span><span class="ff1a">fdatasync</span><span class="lsbe5">.O<span class="_ _4a"></span><span class="ls0">therwise, if<span class="_"> </span><span class="ff1b">op<span class="_ _66"> </span></span>is set <span class="_ _2"></span>to<span class="_"> </span><span class="ff1a">O_SYNC</span><span class="ls10a9">,t<span class="_ _d"></span><span class="ls0">he <span class="_ _2"></span>operation behaves like <span class="_ _2"></span>a</span></span></span></span></div><div class="t m0 x32 h4d y3ee4 ff19 fs26 fc0 sc0 ls0 ws0">call to<span class="_"> </span><span class="ff1a">fsync</span>.</div><div class="t m0 x3f h4d y3ee5 ff19 fs26 fc0 sc0 ls0 ws0">Like <span class="_ _23"></span>the<span class="_ _35"> </span><span class="ff1a">aio_read<span class="_ _35"> </span></span>and<span class="_ _35"> </span><span class="ff1a">aio_write<span class="_ _45"> </span></span>functions, <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">aio_fsync<span class="_ _35"> </span></span>operation <span class="_ _23"> </span>returns</div><div class="t m0 x32 h49 y3ee6 ff19 fs26 fc0 sc0 ls0 ws0">when <span class="_ _e"> </span>the <span class="_"> </span>synch <span class="_ _53"> </span>is <span class="_"> </span>scheduled.<span class="_ _65"> </span>The <span class="_"> </span>data <span class="_ _e"> </span>won’t <span class="_ _e"> </span>be <span class="_"> </span>persistent <span class="_ _53"> </span>until <span class="_"> </span>the <span class="_ _e"> </span>asynchronous</div><div class="t m0 x32 h49 y3ee7 ff19 fs26 fc0 sc0 ls0 ws0">synch <span class="_ _3"></span>completes.<span class="_ _5a"> </span>The <span class="_ _9"></span>AIO <span class="_ _9"></span>control <span class="_ _3"></span>block <span class="_ _9"></span>controls <span class="_ _3"></span>how <span class="_ _9"></span>we <span class="_ _3"></span>ar<span class="ls10aa">en<span class="_ _b"></span><span class="ls0">otiﬁed, <span class="_ _9"></span>just <span class="_ _9"></span>as <span class="_ _9"></span>with <span class="_ _3"></span>the</span></span></div><div class="t m0 x32 h4d y3ee8 ff1a fs26 fc0 sc0 ls0 ws0">aio_read<span class="_ _80"> </span><span class="ff19">and<span class="_"> </span></span>aio_write<span class="_ _66"> </span><span class="ff19">functions.</span></div><div class="t m0 x3f h49 y3ee9 ff19 fs26 fc0 sc0 ls164 ws0">To <span class="_ _59"> </span>d<span class="_ _23"></span><span class="ls0">etermine <span class="_ _47"> </span>the <span class="_ _47"> </span>completion <span class="_ _45"> </span>status <span class="_ _47"> </span>of <span class="_ _47"> </span>an <span class="_ _45"> </span>asynchr<span class="_ _0"></span>onous <span class="_ _47"> </span>read, <span class="_ _47"> </span>write, <span class="_ _47"> </span>or <span class="_ _45"> </span>synch</span></div><div class="t m0 x32 h4d y3eea ff19 fs26 fc0 sc0 ls0 ws0">operation, we need to call the<span class="_"> </span><span class="ff1a">aio_error<span class="_ _80"> </span></span>function.</div><div class="t m0 x3f h4e y3eeb ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;aio.h&gt;</div><div class="t m0 x3f h4e y3eec ff1a fs28 fc0 sc0 ls0 ws0">int aio_error(const struct aiocb *<span class="ff1b">aiocb</span>);</div><div class="t m0 x195 h7c y3eed ff19 fs28 fc0 sc0 ls0 ws0">Returns: (see following)</div><div class="t m0 x32 h55 y3eee ff19 fs2c fc0 sc0 ls0 ws0">The return value tells us one of four things.</div><div class="t m0 x3f h54 y3eef ff1a fs2c fc0 sc0 ls0 ws0">0<span class="_ _1f2"> </span><span class="ff19">The <span class="_ _42"> </span>asynchronous <span class="_ _23"> </span>operation <span class="_ _42"> </span>completed <span class="_ _42"> </span>successfully<span class="_ _6"></span><span class="ls10ab">.W<span class="_ _5d"></span><span class="ls10ac">en<span class="_ _43"></span><span class="ls0">eed <span class="_ _23"> </span>to</span></span></span></span></div><div class="t m0 x161 h54 y3ef0 ff19 fs2c fc0 sc0 ls0 ws0">call <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">aio_return<span class="_ _47"> </span></span>function <span class="_ _9"></span>to <span class="_ _9"></span>obtain <span class="_ _9"></span>the <span class="_ _9"></span>return <span class="_ _3"></span>value <span class="_ _9"></span>from <span class="_ _9"></span>the</div><div class="t m0 x161 h55 y3ef1 ff19 fs2c fc0 sc0 ls0 ws0">operation.</div><div class="t m0 x3f h54 y3ef2 ff20 fs2c fc0 sc0 ls0 ws0">−<span class="ff19 ls10ad">1T<span class="_ _2a7"></span><span class="ls0">he call to<span class="_"> </span><span class="ff1a">aio_error<span class="_ _80"> </span></span>failed. <span class="_"> </span>In<span class="_"> </span>this case,<span class="_"> </span><span class="ff1a">errno<span class="_ _66"> </span></span>tells us why<span class="_ _4"></span>.</span></span></div><div class="t m0 x3f h54 y3ef3 ff1a fs2c fc0 sc0 ls0 ws0">EINPROGRESS<span class="_ _5c"> </span><span class="ff19">The asynchronous read, write, or synch is still pending.</span></div><div class="t m0 x3f h60 y3ef4 ff1b fs2c fc0 sc0 ls0 ws0">anything <span class="_ _23"> </span>else<span class="_ _2a8"> </span><span class="ff19">Any <span class="_ _23"> </span>other <span class="_ _42"> </span>r<span class="_ _0"></span>eturn <span class="_ _23"> </span>value <span class="_ _42"> </span>gives <span class="_ _23"> </span>us <span class="_ _23"> </span>the <span class="_ _42"> </span>error <span class="_ _23"></span>code <span class="_ _23"> </span>corresponding <span class="_ _23"></span>to</span></div><div class="t m0 x161 h55 y3ef5 ff19 fs2c fc0 sc0 ls0 ws0">the failed asynchronous operation.</div><div class="t m0 x3f h54 y3ef6 ff19 fs2c fc0 sc0 ls0 ws0">If <span class="_ _3"></span>the <span class="_ _9"></span>asynchronous <span class="_ _3"></span>operation <span class="_ _9"></span>succeeded, <span class="_ _3"></span>we <span class="_ _9"></span>can <span class="_ _9"></span>call <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">aio_return<span class="_ _45"> </span></span>function <span class="_ _3"></span>to</div><div class="t m0 x32 h55 y3ef7 ff19 fs2c fc0 sc0 ls0 ws0">get the asynchronous operation’s r<span class="_ _0"></span>eturn value.</div><div class="t m0 x3f h5d y3ef8 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;aio.h&gt;</div><div class="t m0 x3f h5d y3ef9 ff1a fs2f fc0 sc0 ls0 ws0">ssize_t aio_return(const struct aiocb *<span class="ff1b">aiocb</span>);</div><div class="t m0 x195 hc2 y3efa ff19 fs2f fc0 sc0 ls0 ws0">Returns: (see following)</div><div class="t m0 x32 h50 y3efb ff19 fs29 fc0 sc0 ls0 ws0">Until <span class="_ _3"></span>the <span class="_ _3"></span>asynchronous <span class="_ _3"></span>operation <span class="_ _3"></span>completes, <span class="_ _9"></span>we <span class="_ _3"></span>need <span class="_ _3"></span>to <span class="_ _9"></span>be <span class="_ _3"></span>careful <span class="_ _3"></span>to <span class="_ _3"></span>avoid <span class="_ _3"></span>calling <span class="_ _9"></span>the</div><div class="t m0 x32 h5c y3efc ff1a fs29 fc0 sc0 ls0 ws0">aio_return<span class="_ _44"> </span><span class="ff19">function. <span class="_ _44"> </span>The<span class="_ _44"> </span><span class="lsdf">re</span>sults <span class="_ _53"> </span>ar<span class="ls10ae">eu<span class="_ _c"></span><span class="ls0">ndeﬁned <span class="_ _42"> </span>until <span class="_ _53"> </span>the <span class="_ _53"> </span>operation <span class="_ _42"> </span>completes.<span class="_ _54"> </span><span class="lse2">We</span></span></span></span></div><div class="t m0 x32 h5c y3efd ff19 fs29 fc0 sc0 ls0 ws0">also <span class="_"> </span>need <span class="_ _47"> </span>to <span class="_ _66"> </span>be <span class="_ _66"> </span>careful <span class="_ _66"> </span>to <span class="_ _66"> </span>call<span class="_ _61"> </span><span class="ff1a">aio_return<span class="_ _61"> </span></span>only <span class="_ _66"> </span>one <span class="_ _47"> </span>time <span class="_"> </span>per <span class="_ _47"> </span>asynchronous <span class="_"> </span>I/O</div><div class="t m0 x32 h50 y3efe ff19 fs29 fc0 sc0 ls0 ws0">operation. <span class="_ _44"> </span>Once<span class="_ _4b"> </span>we <span class="_ _53"> </span>call <span class="_ _53"> </span>this <span class="_ _53"> </span>function, <span class="_ _e"> </span>the <span class="_ _53"> </span>operating <span class="_ _53"> </span>system <span class="_ _53"> </span>is <span class="_ _53"> </span>free <span class="_ _53"> </span>to <span class="_ _53"> </span>deallocate <span class="_ _53"> </span>the</div><div class="t m0 x32 h50 y3eff ff19 fs29 fc0 sc0 lsdf ws0">re<span class="ls0">cor<span class="lsdd">dc<span class="_ _d"></span><span class="ls0">ontaining the I/O operation’s return value.</span></span></span></div><div class="t m0 x3f h5c y3f00 ff19 fs29 fc0 sc0 ls0 ws0">The<span class="_ _47"> </span><span class="ff1a">aio_return<span class="_ _66"> </span></span>function <span class="_ _3"></span>will <span class="_ _3"></span>return<span class="_ _66"> </span><span class="ff20">−</span><span class="ls10af">1a<span class="_ _4f"></span><span class="ls0">nd <span class="_ _2"></span>set<span class="_ _47"> </span><span class="ff1a">errno<span class="_ _47"> </span></span>if<span class="_ _47"> </span><span class="ff1a">aio_return<span class="_ _47"> </span></span>itself <span class="_ _2"></span>fails.</span></span></div><div class="t m0 x32 h50 y3f01 ff19 fs29 fc0 sc0 ls0 ws0">Otherwise, <span class="_ _9"></span>it <span class="_ _3"></span>will <span class="_ _9"></span>return <span class="_ _3"></span>the <span class="_ _9"></span>results <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>asynchronous <span class="_ _3"></span>operation.<span class="_ _5a"> </span>In <span class="_ _9"></span>this <span class="_ _9"></span>case, <span class="_ _3"></span>it <span class="_ _9"></span>will</div><div class="t m0 x32 h5c y3f02 ff19 fs29 fc0 sc0 lsdf ws0">re<span class="ls0">turn whatever<span class="_"> </span><span class="ff1a">read</span>,<span class="_ _66"> </span><span class="ff1a">write</span><span class="ls10b0">,o<span class="_ _d"></span><span class="ls0">r<span class="_"> </span><span class="ff1a">fsync<span class="_ _66"> </span></span>would have returned on success if one of those</span></span></span></div><div class="t m0 x32 h50 y3f03 ff19 fs29 fc0 sc0 ls0 ws0">functions had been called.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
