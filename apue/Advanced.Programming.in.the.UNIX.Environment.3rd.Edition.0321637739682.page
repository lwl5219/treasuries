<div id="pf2aa" class="pf w4 h1f" data-page-no="2aa"><div class="pc pc2aa w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg2aa.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">648<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>IPC<span class="_ _e8"> </span>Chapter <span class="_"> </span>17</span></div><div class="t m0 x9d h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">for (ptr = buf; ptr &lt; &amp;buf[nr]; ) {</div><div class="t m0 x1f h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">if (*ptr++ == 0) {</div><div class="t m0 x1ca h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">if (ptr != &amp;buf[nr-1])</div><div class="t m0 x36 h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">err_dump(&quot;message format error&quot;);</div><div class="t m0 x1ca h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">status = *ptr &amp; 0xFF;<span class="_ _68"> </span>/* prevent sign extension */</div><div class="t m0 x1ca h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">if (status == 0) {</div><div class="t m0 x36 h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">if (msg.msg_controllen != CONTROLLEN)</div><div class="t m0 xee h57 y805 ff1a fs2d fc0 sc0 ls0 ws0">err_dump(&quot;status = 0 but no fd&quot;);</div><div class="t m0 x36 h57 y806 ff1a fs2d fc0 sc0 ls0 ws0">newfd = *(int *)CMSG_DATA(cmptr);</div><div class="t m0 x1ca h57 y807 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x36 h57 y808 ff1a fs2d fc0 sc0 ls0 ws0">newfd = -status;</div><div class="t m0 x1ca h57 y809 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1ca h57 y80a ff1a fs2d fc0 sc0 ls0 ws0">nr -= 2;</div><div class="t m0 x1f h57 y80b ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y80c ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y80d ff1a fs2d fc0 sc0 ls0 ws0">if (nr &gt; 0 &amp;&amp; (*userfunc)(STDERR_FILENO, buf, nr) != nr)</div><div class="t m0 x1f h57 y80e ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x9d h57 y80f ff1a fs2d fc0 sc0 ls0 ws0">if (status &gt;= 0)<span class="_ _15"> </span>/* final data has arrived */</div><div class="t m0 x1f h57 y810 ff1a fs2d fc0 sc0 ls0 ws0">return(newfd); <span class="_"> </span>/*<span class="_"> </span>descriptor, or -status */</div><div class="t m0 x8a h57 y811 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y812 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xb9 h2d y4cb1 ff18 fs10 fc0 sc0 ls0 ws0">Figure 17.14<span class="_ _5a"> </span><span class="ff19">Receiving a ﬁle descriptor over a UNIX domain socket</span></div><div class="t m0 x32 h4d y4cb2 ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _23"> </span>that <span class="_ _42"> </span>we <span class="_ _42"> </span>ar<span class="ls13e1">ea<span class="_ _43"></span><span class="ls0">lways <span class="_ _23"></span>prepar<span class="_ _0"></span>ed <span class="_ _23"> </span>to <span class="_ _42"> </span>receive <span class="_ _23"> </span>a <span class="_ _42"> </span>descriptor <span class="_ _42"> </span>(we <span class="_ _23"> </span>set<span class="_ _44"> </span><span class="ff1a">msg_control<span class="_ _35"> </span></span>and</span></span></div><div class="t m0 x32 h4d y4cb3 ff1a fs26 fc0 sc0 ls0 ws0">msg_controllen<span class="_ _61"> </span><span class="ff19">befor<span class="ls13e2">ee<span class="_ _1d"></span><span class="ls0">ach <span class="_ _47"> </span>call <span class="_ _47"> </span>to<span class="_ _61"> </span><span class="ff1a">recvmsg</span>), <span class="_ _47"> </span>but <span class="_ _47"> </span>only <span class="_ _47"> </span>if<span class="_ _61"> </span><span class="ff1a">msg_controllen<span class="_ _16"> </span></span>is</span></span></span></div><div class="t m0 x32 h49 y4cb4 ff19 fs26 fc0 sc0 ls0 ws0">nonzero<span class="_"> </span>on<span class="_"> </span>r<span class="_ _0"></span>eturn did we actually r<span class="_ _0"></span>eceive a descriptor<span class="_ _6"></span>.</div><div class="t m0 x3f h49 y4cb5 ff19 fs26 fc0 sc0 ls0 ws0">Recall <span class="_ _2"></span>the <span class="_ _3"></span>hoops <span class="_ _3"></span>we <span class="_ _3"></span>needed <span class="_ _3"></span>to <span class="_ _3"></span>jump <span class="_ _3"></span>through <span class="_ _2"></span>to <span class="_ _3"></span>determine <span class="_ _3"></span>the <span class="_ _3"></span>identity <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>caller</div><div class="t m0 x32 h4d y4cb6 ff19 fs26 fc0 sc0 ls0 ws0">in <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">serv_accept<span class="_ _66"> </span></span>function <span class="_ _3"></span>(Figur<span class="ls13e3">e1<span class="_ _8"></span><span class="ls0">7.9). <span class="_ _47"> </span>It<span class="_ _66"> </span>would <span class="_ _3"></span>have <span class="_ _2"></span>been <span class="_ _3"></span>better <span class="_ _2"></span>for <span class="_ _2"></span>the <span class="_ _3"></span>kernel <span class="_ _2"></span>to</span></span></div><div class="t m0 x32 h4d y4cb7 ff19 fs26 fc0 sc0 ls0 ws0">pass <span class="_ _42"> </span>us <span class="_ _42"> </span>the <span class="_ _53"> </span>credentials <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>caller <span class="_ _53"> </span>on <span class="_ _42"> </span>return <span class="_ _42"> </span>from <span class="_ _42"> </span>the <span class="_ _42"> </span>call <span class="_ _42"> </span>to<span class="_ _44"> </span><span class="ff1a">accept</span><span class="ls13e4">.S<span class="_ _52"></span><span class="ls0">ome <span class="_ _53"> </span>UNIX</span></span></div><div class="t m0 x32 h49 y4cb8 ff19 fs26 fc0 sc0 ls0 ws0">domain <span class="_ _61"> </span>socket <span class="_ _61"> </span>implementations <span class="_ _16"> </span>provide <span class="_ _61"> </span>similar <span class="_ _61"> </span>functionality <span class="_ _61"> </span>when <span class="_ _16"> </span>exchanging</div><div class="t m0 x32 h49 y4cb9 ff19 fs26 fc0 sc0 ls0 ws0">messages, but their interfaces differ<span class="_ _6"></span>.</div><div class="t m0 x76 h2d y4cba ff19 fs10 fc0 sc0 ls0 ws0">FreeBSD <span class="_"> </span>8.0 <span class="_"> </span>and <span class="_"> </span>Linux <span class="_"> </span>3.2.0 <span class="_"> </span>provide <span class="_"> </span>support <span class="_"> </span>for <span class="_"> </span>sending <span class="_"> </span>credentials <span class="_"> </span>over <span class="_"> </span>UNIX <span class="_"> </span>domain</div><div class="t m0 x76 h2d y4cbb ff19 fs10 fc0 sc0 ls0 ws0">sockets, <span class="_ _9"></span>but <span class="_ _3"></span>they <span class="_ _9"> </span>do <span class="_ _9"></span>it <span class="_ _9"></span>differently<span class="_ _4"></span><span class="ls13e5">.M<span class="_ _55"></span><span class="ls0">ac <span class="_ _9"></span>OS <span class="_ _3"></span>X <span class="_ _9"> </span>10.6.8 <span class="_ _9"></span>is <span class="_ _9"></span>derived <span class="_ _9"></span>in <span class="_ _9"></span>part <span class="_ _9"></span>from <span class="_ _3"></span>FreeBSD, <span class="_ _3"></span>but <span class="_ _9"> </span>has</span></span></div><div class="t m0 x76 h2d y4cbc ff19 fs10 fc0 sc0 ls0 ws0">credential passing disabled.<span class="_ _44"> </span>Solaris 10 <span class="_ _2"></span>doesn’t support <span class="_ _2"></span>sending credentials over <span class="_ _2"></span>UNIX domain</div><div class="t m0 x76 h2d y4cbd ff19 fs10 fc0 sc0 ls0 ws0">sockets. <span class="_ _47"> </span>However<span class="_ _1"></span>,<span class="_ _66"> </span>it<span class="_ _47"> </span>supports <span class="_ _9"> </span>the <span class="_ _23"> </span>ability <span class="_ _9"></span>to <span class="_ _9"></span>obtain <span class="_ _9"> </span>the <span class="_ _23"> </span>credentials <span class="_ _3"></span>of <span class="_ _23"> </span>a <span class="_ _9"></span>process <span class="_ _3"></span>passing <span class="_ _23"> </span>a <span class="_ _9"></span>ﬁle</div><div class="t m0 x76 h2d y4cbe ff19 fs10 fc0 sc0 ls0 ws0">descriptor over a STREAMS pipe, although we do not discuss the details here.</div><div class="t m0 x3f h4d y4cbf ff19 fs26 fc0 sc0 ls3aa ws0">Wi<span class="_ _3"></span><span class="ls0">th FreeBSD, cr<span class="_ _0"></span>edentials ar<span class="lsd3">et<span class="_ _4f"></span><span class="ls0">ransmitted as a<span class="_"> </span><span class="ff1a">cmsgcred<span class="_ _66"> </span></span>structur<span class="_ _0"></span>e:</span></span></span></div><div class="t m0 x3f h4e y4cc0 ff1a fs28 fc0 sc0 ls0 ws0">#define CMGROUP_MAX 16</div><div class="t m0 x3f h4e y4cc1 ff1a fs28 fc0 sc0 ls0 ws0">struct cmsgcred {</div><div class="t m0 xc2 h4e y4cc2 ff1a fs28 fc0 sc0 ls0 ws0">pid_t <span class="_"> </span>cmcred_pid;<span class="_ _cb"> </span>/* sender’s process ID */</div><div class="t m0 xc2 h4e y4cc3 ff1a fs28 fc0 sc0 ls0 ws0">uid_t <span class="_"> </span>cmcred_uid;<span class="_ _cb"> </span>/* sender’s real UID */</div><div class="t m0 xc2 h4e y4cc4 ff1a fs28 fc0 sc0 ls0 ws0">uid_t <span class="_"> </span>cmcred_euid;<span class="_ _ce"> </span>/* sender’s effective UID */</div><div class="t m0 xc2 h4e y4cc5 ff1a fs28 fc0 sc0 ls0 ws0">gid_t <span class="_"> </span>cmcred_gid;<span class="_ _cb"> </span>/* sender’s real GID */</div><div class="t m0 xc2 h4e y4cc6 ff1a fs28 fc0 sc0 ls0 ws0">short <span class="_"> </span>cmcred_ngroups;<span class="_ _12d"> </span>/* number of groups */</div><div class="t m0 xc2 h4e y4cc7 ff1a fs28 fc0 sc0 ls0 ws0">gid_t <span class="_"> </span>cmcred_groups[CMGROUP_MAX]; <span class="_"> </span>/*<span class="_"> </span>groups */</div><div class="t m0 x3f h4e y4cc8 ff1a fs28 fc0 sc0 ls0 ws0">};</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
