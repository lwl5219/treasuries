<div id="pf363" class="pf w4 h1f" data-page-no="363"><div class="pc pc363 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg363.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">833</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">641 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">642 <span class="_ _176"> </span>*<span class="_"> </span>Check for a change in the config file.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">643 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">644 <span class="_ _186"> </span>pthread_mutex_lock(&amp;configlock);</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">645 <span class="_ _186"> </span>if<span class="_"> </span>(reread) {</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">646 <span class="_ _82"> </span>freeaddrinfo(printer);</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">647 <span class="_ _82"> </span>printer<span class="_"> </span><span class="ls15c">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">648 <span class="_ _82"> </span>printer_name<span class="_"> </span><span class="ls15c">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">649 <span class="_ _82"> </span>reread<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">650 <span class="_ _82"> </span>pthread_mutex_unlock(&amp;configlock);</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">651 <span class="_ _82"> </span>init_printer();</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">652 <span class="_ _186"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">653 <span class="_ _82"> </span>pthread_mutex_unlock(&amp;configlock);</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">654 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y2c5c ff1a fs2d fc0 sc0 ls0 ws0">655 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y2c5d ff1a fs2d fc0 sc0 ls0 ws0">656 <span class="_ _176"> </span>*<span class="_"> </span>Send job to printer.</div><div class="t m0 x32 h57 y2c5e ff1a fs2d fc0 sc0 ls0 ws0">657 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y2c5f ff1a fs2d fc0 sc0 ls0 ws0">658 <span class="_ _186"> </span>sprintf(name,<span class="_"> </span>&quot;%s/%s/%d&quot;, SPOOLDIR, DATADIR, jp-&gt;jobid);</div><div class="t m0 x32 h57 y2c60 ff1a fs2d fc0 sc0 ls0 ws0">659 <span class="_ _186"> </span>if<span class="_"> </span>((fd = open(name, O_RDONLY)) &lt; 0) {</div><div class="t m0 x32 h57 y2c61 ff1a fs2d fc0 sc0 ls0 ws0">660 <span class="_ _82"> </span>log_msg(&quot;job<span class="_"> </span>%d canceled - can’t open %s: %s&quot;,</div><div class="t m0 x32 h57 y2c62 ff1a fs2d fc0 sc0 ls0 ws0">661 <span class="_ _12d"> </span>jp-&gt;jobid,<span class="_"> </span>name, strerror(errno));</div><div class="t m0 x32 h57 y5689 ff1a fs2d fc0 sc0 ls0 ws0">662 <span class="_ _82"> </span>free(jp);</div><div class="t m0 x32 h57 y568a ff1a fs2d fc0 sc0 ls0 ws0">663 <span class="_ _82"> </span>continue;</div><div class="t m0 x32 h57 y568b ff1a fs2d fc0 sc0 ls0 ws0">664 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y568c ff1a fs2d fc0 sc0 ls0 ws0">665 <span class="_ _186"> </span>if<span class="_"> </span>(fstat(fd, &amp;sbuf) &lt; 0) {</div><div class="t m0 x32 h57 y568d ff1a fs2d fc0 sc0 ls0 ws0">666 <span class="_ _82"> </span>log_msg(&quot;job<span class="_"> </span>%d canceled - can’t fstat %s: %s&quot;,</div><div class="t m0 x32 h57 y56fe ff1a fs2d fc0 sc0 ls0 ws0">667 <span class="_ _12d"> </span>jp-&gt;jobid,<span class="_"> </span>name, strerror(errno));</div><div class="t m0 x32 h57 y56ff ff1a fs2d fc0 sc0 ls0 ws0">668 <span class="_ _82"> </span>free(jp);</div><div class="t m0 x32 h57 y5700 ff1a fs2d fc0 sc0 ls0 ws0">669 <span class="_ _82"> </span>close(fd);</div><div class="t m0 x32 h57 y5701 ff1a fs2d fc0 sc0 ls0 ws0">670 <span class="_ _82"> </span>continue;</div><div class="t m0 x32 h57 y584a ff1a fs2d fc0 sc0 ls0 ws0">671 <span class="_ _186"> </span>}</div><div class="t m0 x32 h49 y5c66 ff19 fs26 fc0 sc0 ls0 ws0">[641 <span class="_ _a"></span>– <span class="_ _a"></span>654]<span class="_ _65"> </span>Now <span class="_ _2"></span>that <span class="_ _3"></span>we <span class="_ _3"></span>have <span class="_ _3"></span>a <span class="_ _3"></span>job <span class="_ _3"></span>to <span class="_ _3"></span>print, <span class="_ _3"></span>we <span class="_ _3"></span>check <span class="_ _2"></span>for <span class="_ _3"></span>a <span class="_ _3"></span>change <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>conﬁguration</div><div class="t m0 x11a h4d y5c67 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle. <span class="_"> </span>W<span class="_ _6"></span><span class="ls17bf">el<span class="_ _d"></span><span class="ls0">ock <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">configlock<span class="_ _66"> </span></span>mutex <span class="_ _2"></span>and check <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">reread<span class="_ _66"> </span></span>variable. <span class="_ _66"> </span>If<span class="_ _66"> </span>it <span class="_ _2"></span>is</span></span></div><div class="t m0 x11a h4d y5c68 ff19 fs26 fc0 sc0 ls0 ws0">nonzero, <span class="_"> </span>then <span class="_"> </span>we <span class="_"> </span>fr<span class="_ _0"></span>ee <span class="_"> </span>the <span class="_"> </span>old <span class="_"> </span>printer<span class="_ _59"> </span><span class="ff1a">addrinfo<span class="_ _46"> </span></span>list, <span class="_"> </span>clear <span class="_"> </span>the <span class="_"> </span>pointers,</div><div class="t m0 x11a h4d y5c69 ff19 fs26 fc0 sc0 ls0 ws0">unlock <span class="_ _44"> </span>the <span class="_ _44"> </span>mutex, <span class="_ _4b"> </span>and <span class="_ _44"> </span>call<span class="_ _65"> </span><span class="ff1a">init_printer<span class="_ _54"> </span></span>to <span class="_ _4b"> </span>reinitialize <span class="_ _44"> </span>the <span class="_ _44"> </span>printer</div><div class="t m0 x11a h49 y5c6a ff19 fs26 fc0 sc0 ls0 ws0">information. <span class="_ _4b"> </span>Since<span class="_ _4b"> </span>only <span class="_ _53"> </span>this <span class="_ _e"> </span>context <span class="_ _53"> </span>looks <span class="_ _e"> </span>at <span class="_ _e"> </span>and <span class="_ _53"> </span>potentially <span class="_ _e"> </span>changes <span class="_ _53"> </span>the</div><div class="t m0 x11a h4d y5c6b ff19 fs26 fc0 sc0 ls0 ws0">printer <span class="_ _23"> </span>information <span class="_ _23"> </span>after <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">main<span class="_ _35"> </span></span>thread <span class="_ _23"></span>initialized <span class="_ _23"> </span>it, <span class="_ _23"> </span>we <span class="_ _42"> </span>don’t <span class="_ _23"> </span>need <span class="_ _23"> </span>any</div><div class="t m0 x11a h4d y5c6c ff19 fs26 fc0 sc0 ls0 ws0">synchronization <span class="_"> </span>other <span class="_"> </span>than <span class="_"> </span>using <span class="_"> </span>the<span class="_ _46"> </span><span class="ff1a">configlock<span class="_ _46"> </span></span>mutex <span class="_"> </span>to <span class="_"> </span>protect <span class="_"> </span>the</div><div class="t m0 x11a h4d y5c6d ff19 fs26 fc0 sc0 ls0 ws0">state of the<span class="_"> </span><span class="ff1a">reread<span class="_ _80"> </span></span>ﬂag.</div><div class="t m0 x11a h49 y5c6e ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _3"></span>that <span class="_ _3"></span>although <span class="_ _9"></span>we <span class="_ _3"></span>acquir<span class="ls17c0">ea<span class="_ _b"></span><span class="ls0">nd <span class="_ _3"></span>release <span class="_ _3"></span>two <span class="_ _9"></span>differ<span class="_ _1"></span>ent <span class="_ _9"></span>mutex <span class="_ _3"></span>locks <span class="_ _3"></span>in <span class="_ _9"></span>this</span></span></div><div class="t m0 x11a h49 y5c6f ff19 fs26 fc0 sc0 ls0 ws0">function, <span class="_ _2"></span>we <span class="_ _2"></span>never <span class="_ _2"></span>hold <span class="_ _2"></span>both <span class="_ _3"></span>at <span class="_ _2"></span>the <span class="_ _2"></span>same <span class="_ _2"></span>time, <span class="_ _2"></span>so <span class="_ _3"></span>we <span class="_ _2"></span>don’t <span class="_ _2"></span>need <span class="_ _2"></span>to <span class="_ _3"></span>establish</div><div class="t m0 x11a h49 y5c70 ff19 fs26 fc0 sc0 lsd3 ws0">al<span class="_ _d"></span><span class="ls0">ock hierarchy (Section 1<span class="_ _1"></span>1.6.2).</span></div><div class="t m0 x32 h4d y5c71 ff19 fs26 fc0 sc0 ls0 ws0">[655 <span class="_ _a"></span>– <span class="_ _a"></span>671]<span class="_ _65"> </span>If <span class="_ _47"> </span>we <span class="_ _45"> </span>can’t <span class="_ _47"> </span>open <span class="_ _47"> </span>the <span class="_ _45"> </span>data <span class="_ _47"> </span>ﬁle, <span class="_ _47"> </span>we <span class="_ _45"> </span>log <span class="_ _47"> </span>an <span class="_ _45"> </span>err<span class="_ _0"></span>or <span class="_ _47"> </span>message, <span class="_ _45"> </span>fr<span class="_ _0"></span>ee <span class="_ _47"> </span>the<span class="_ _16"> </span><span class="ff1a">job</span></div><div class="t m0 x11a h4d y5c72 ff19 fs26 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>e, <span class="_ _42"> </span>and <span class="_ _42"> </span>continue.<span class="_ _54"> </span>After <span class="_ _42"> </span>opening <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle, <span class="_ _42"> </span>we <span class="_ _42"> </span>call<span class="_ _44"> </span><span class="ff1a">fstat<span class="_ _44"> </span></span>to <span class="_ _42"> </span>ﬁnd <span class="_ _42"> </span>the</div><div class="t m0 x11a h49 y5c73 ff19 fs26 fc0 sc0 ls0 ws0">size of the ﬁle.<span class="_ _59"> </span>If this fails, we log an error message, clean up, and continue.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
