<div id="pf29b" class="pf w4 h1f" data-page-no="29b"><div class="pc pc29b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg29b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.2<span class="_ _2e1"> </span>UNIX <span class="_"> </span>Domain <span class="_"> </span>Sockets<span class="_ _1b"> </span><span class="ff18">633</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/msg.h&gt;</div><div class="t m0 x32 h57 y3c1 ff1a fs2d fc0 sc0 ls0 ws0">#define MAXMSZ 512</div><div class="t m0 x32 h57 y1f3b ff1a fs2d fc0 sc0 ls0 ws0">struct mymesg {</div><div class="t m0 x8a h57 y1d34 ff1a fs2d fc0 sc0 ls0 ws0">long mtype;</div><div class="t m0 x8a h57 y158d ff1a fs2d fc0 sc0 ls0 ws0">char mtext[MAXMSZ];</div><div class="t m0 x32 h57 y158e ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h57 y1d36 ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y1590 ff1a fs2d fc0 sc0 ls0 ws0">main(int argc, char *argv[])</div><div class="t m0 x32 h57 y1591 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y1d37 ff1a fs2d fc0 sc0 ls0 ws0">key_t key;</div><div class="t m0 x8a h57 y1d38 ff1a fs2d fc0 sc0 ls0 ws0">long qid;</div><div class="t m0 x8a h57 y3cb ff1a fs2d fc0 sc0 ls0 ws0">size_t nbytes;</div><div class="t m0 x8a h57 y3cc ff1a fs2d fc0 sc0 ls0 ws0">struct mymesg m;</div><div class="t m0 x8a h57 y24c6 ff1a fs2d fc0 sc0 ls0 ws0">if (argc != 3) {</div><div class="t m0 x9d h57 y24c7 ff1a fs2d fc0 sc0 ls0 ws0">fprintf(stderr, &quot;usage: sendmsg KEY message\n&quot;);</div><div class="t m0 x9d h57 y1f3c ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y1f3d ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y1f3e ff1a fs2d fc0 sc0 ls0 ws0">key = strtol(argv[1], NULL, 0);</div><div class="t m0 x8a h57 y3d2 ff1a fs2d fc0 sc0 ls0 ws0">if ((qid = msgget(key, 0)) &lt; 0)</div><div class="t m0 x9d h57 y3d3 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;can’t open queue key %s&quot;, argv[1]);</div><div class="t m0 x8a h57 y3d4 ff1a fs2d fc0 sc0 ls0 ws0">memset(&amp;m, 0, sizeof(m));</div><div class="t m0 x8a h57 y3d5 ff1a fs2d fc0 sc0 ls0 ws0">strncpy(m.mtext, argv[2], MAXMSZ-1);</div><div class="t m0 x8a h57 y3d6 ff1a fs2d fc0 sc0 ls0 ws0">nbytes = strlen(m.mtext);</div><div class="t m0 x8a h57 y3d7 ff1a fs2d fc0 sc0 ls0 ws0">m.mtype = 1;</div><div class="t m0 x8a h57 y3d8 ff1a fs2d fc0 sc0 ls0 ws0">if (msgsnd(qid, &amp;m, nbytes, 0) &lt; 0)</div><div class="t m0 x9d h57 y4b3f ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;can’t send message&quot;);</div><div class="t m0 x8a h57 y4b40 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y4b41 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x108 h2d y4b42 ff18 fs10 fc0 sc0 ls0 ws0">Figure 17.4<span class="_ _5a"> </span><span class="ff19">Post a message to an XSI message queue</span></div><div class="t m0 x3f h49 y4b43 ff19 fs26 fc0 sc0 ls0 ws0">This <span class="_ _3"></span>program <span class="_ _2"></span>takes <span class="_ _9"></span>two <span class="_ _3"></span>arguments: <span class="_ _2"></span>the <span class="_ _9"></span>key <span class="_ _3"></span>associated <span class="_ _3"></span>with <span class="_ _3"></span>the <span class="_ _9"></span>queue <span class="_ _3"></span>and <span class="_ _3"></span>a <span class="_ _3"></span>string</div><div class="t m0 x32 h49 y4b44 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _3"></span>be <span class="_ _9"></span>sent <span class="_ _9"></span>as <span class="_ _9"></span>the <span class="_ _9"></span>body <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>message.<span class="_ _5a"> </span>When <span class="_ _3"></span>we <span class="_ _9"></span>send <span class="_ _9"></span>messages <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>server<span class="_ _1"></span>,<span class="_ _45"> </span>it<span class="_ _45"> </span>prints</div><div class="t m0 x32 h49 y4b45 ff19 fs26 fc0 sc0 ls0 ws0">them as shown below<span class="_ _6"></span>.</div><div class="t m0 x3f h4e y4b46 ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./pollmsg &amp;<span class="_ _23c"> </span><span class="ff1b">run the server in the background</span></span></div><div class="t m0 x3f h4e y4b47 ff1a fs28 fc0 sc0 ls0 ws0">[1] 12814</div><div class="t m0 x3f h4e y4b48 ff1a fs28 fc0 sc0 ls1b6 ws0">$q<span class="_ _1d"></span><span class="ls0">ueue ID 0 is 196608</span></div><div class="t m0 x3f h4e y4b49 ff1a fs28 fc0 sc0 ls0 ws0">queue ID 1 is 196609</div><div class="t m0 x3f h4e y4b4a ff1a fs28 fc0 sc0 ls0 ws0">queue ID 2 is 196610</div><div class="t m0 x3f h4e y4b4b ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./sendmsg 0x123 &quot;hello, world&quot;<span class="_ _a0"> </span><span class="ff1b">send a message to the ﬁrst queue</span></span></div><div class="t m0 x3f h4e y4b4c ff1a fs28 fc0 sc0 ls0 ws0">queue id 196608, message hello, world</div><div class="t m0 x3f h4e y4b4d ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./sendmsg 0x124 &quot;just a test&quot;<span class="_ _131"> </span><span class="ff1b">send a message to the second queue</span></span></div><div class="t m0 x3f h4e y4b4e ff1a fs28 fc0 sc0 ls0 ws0">queue id 196609, message just a test</div><div class="t m0 x3f h4e y4b4f ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./sendmsg 0x125 &quot;bye&quot;<span class="_ _195"> </span><span class="ff1b">send a message to the third queue</span></span></div><div class="t m0 x3f h4e y4b50 ff1a fs28 fc0 sc0 ls0 ws0">queue id 196610, message bye</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
