<div id="pf34b" class="pf w4 h1f" data-page-no="34b"><div class="pc pc34b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg34b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">809</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">53 <span class="_ _176"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">54 <span class="_ _166"> </span>submit_file(fd,<span class="_"> </span>sfd, argv[optind], sbuf.st_size, text);</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">55 <span class="_ _166"> </span>exit(0);</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">56 <span class="_ _176"> </span>}</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">57 <span class="_ _8a"> </span>}</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">58 <span class="_ _8a"> </span>err_exit(err,<span class="_"> </span>&quot;print: can’t contact %s&quot;, host);</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">59 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y2f21 ff1a fs2d fc0 sc0 ls0 ws0">60 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y2f22 ff1a fs2d fc0 sc0 ls0 ws0">61 <span class="_ _68"> </span>*<span class="_"> </span>Send a file to the printer daemon.</div><div class="t m0 x32 h57 y2f23 ff1a fs2d fc0 sc0 ls0 ws0">62 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y2f24 ff1a fs2d fc0 sc0 ls0 ws0">63 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y2f25 ff1a fs2d fc0 sc0 ls0 ws0">64 <span class="_ _d9"> </span>submit_file(int<span class="_"> </span>fd, int sockfd, const char *fname, size_t nbytes,</div><div class="t m0 x32 h57 y5712 ff1a fs2d fc0 sc0 ls0 ws0">65 <span class="_ _12d"> </span>int<span class="_"> </span>text)</div><div class="t m0 x32 h57 y5713 ff1a fs2d fc0 sc0 ls0 ws0">66 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y5714 ff1a fs2d fc0 sc0 ls0 ws0">67 <span class="_ _8a"> </span>int<span class="_ _ce"> </span>nr, nw, len;</div><div class="t m0 x32 h57 y5715 ff1a fs2d fc0 sc0 ls0 ws0">68 <span class="_ _8a"> </span>struct<span class="_"> </span>passwd <span class="_ _189"> </span>*pwd;</div><div class="t m0 x32 h57 y5716 ff1a fs2d fc0 sc0 ls0 ws0">69 <span class="_ _8a"> </span>struct<span class="_"> </span>printreq <span class="_ _15"> </span>req;</div><div class="t m0 x32 h57 y5717 ff1a fs2d fc0 sc0 ls0 ws0">70 <span class="_ _8a"> </span>struct<span class="_"> </span>printresp <span class="_ _68"> </span>res;</div><div class="t m0 x32 h57 y5844 ff1a fs2d fc0 sc0 ls0 ws0">71 <span class="_ _8a"> </span>char<span class="_ _1e7"> </span>buf[IOBUFSZ];</div><div class="t m0 x32 h57 y2c62 ff1a fs2d fc0 sc0 ls0 ws0">72 <span class="_ _8a"> </span>/*</div><div class="t m0 x32 h57 y5689 ff1a fs2d fc0 sc0 ls0 ws0">73 <span class="_ _189"> </span>*<span class="_"> </span>First build the header.</div><div class="t m0 x32 h57 y568a ff1a fs2d fc0 sc0 ls0 ws0">74 <span class="_ _189"> </span>*/</div><div class="t m0 x32 h57 y568b ff1a fs2d fc0 sc0 ls0 ws0">75 <span class="_ _8a"> </span>if<span class="_"> </span>((pwd = getpwuid(geteuid())) == NULL) {</div><div class="t m0 x32 h57 y568c ff1a fs2d fc0 sc0 ls0 ws0">76 <span class="_ _176"> </span>strcpy(req.usernm,<span class="_"> </span>&quot;unknown&quot;);</div><div class="t m0 x32 h57 y568d ff1a fs2d fc0 sc0 ls0 ws0">77 <span class="_ _8a"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y56fe ff1a fs2d fc0 sc0 ls0 ws0">78 <span class="_ _176"> </span>strncpy(req.usernm,<span class="_"> </span>pwd-&gt;pw_name, USERNM_MAX-1);</div><div class="t m0 x32 h57 y56ff ff1a fs2d fc0 sc0 ls0 ws0">79 <span class="_ _176"> </span>req.usernm[USERNM_MAX-1]<span class="_"> </span><span class="ls15c">=’<span class="_ _1d"></span><span class="ls0">\0’;</span></span></div><div class="t m0 x32 h57 y5700 ff1a fs2d fc0 sc0 ls0 ws0">80 <span class="_ _8a"> </span>}</div><div class="t m0 x32 h49 y5b2f ff19 fs26 fc0 sc0 ls0 ws0">[53 <span class="_ _a"></span>– <span class="_ _a"></span>59]<span class="_ _65"> </span>If <span class="_ _16"> </span>we <span class="_ _16"> </span>ar<span class="ls1765">ea<span class="_ _56"></span><span class="ls0">ble <span class="_ _16"> </span>to <span class="_ _16"> </span>connect <span class="_ _16"> </span>to <span class="_ _16"> </span>the <span class="_ _16"> </span>printer <span class="_ _16"> </span>spooling <span class="_ _16"> </span>daemon, <span class="_ _16"> </span>we <span class="_ _5a"> </span>call</span></span></div><div class="t m0 x2d h4d y5b30 ff1a fs26 fc0 sc0 ls0 ws0">submit_file<span class="_ _45"> </span><span class="ff19">to <span class="_ _9"></span>transmit <span class="_ _23"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>we <span class="_ _23"></span>want <span class="_ _9"></span>to <span class="_ _9"></span>print <span class="_ _9"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>daemon.<span class="_ _5a"> </span>Then <span class="_ _23"></span>we</span></div><div class="t m0 x2d h49 y5b31 ff19 fs26 fc0 sc0 ls0 ws0">exit <span class="_ _42"> </span>with <span class="_ _42"> </span>a <span class="_ _53"> </span>value <span class="_ _42"> </span>of <span class="_ _42"> </span>0 <span class="_ _53"> </span>to <span class="_ _42"> </span>indicate <span class="_ _42"> </span>success.<span class="_ _54"> </span>If <span class="_ _53"> </span>we <span class="_ _42"> </span>can’t <span class="_ _42"> </span>connect <span class="_ _53"> </span>to <span class="_ _42"> </span>any <span class="_ _42"> </span>of <span class="_ _53"> </span>the</div><div class="t m0 x2d h4d y5b32 ff19 fs26 fc0 sc0 ls0 ws0">addresses, we call<span class="_"> </span><span class="ff1a">err_exit<span class="_ _80"> </span></span>to print an error message and exit with a value of</div><div class="t m0 x2d h4d y5b33 ff19 fs26 fc0 sc0 ls0 ws0">1<span class="_ _47"> </span>to<span class="_ _66"> </span>indicate <span class="_ _3"></span>failure. <span class="_ _47"> </span>(Appendix<span class="_ _66"> </span><span class="ls16a7">Bc<span class="_ _4f"></span><span class="ls0">ontains <span class="_ _3"></span>the <span class="_ _2"></span>source <span class="_ _2"></span>code <span class="_ _3"></span>for<span class="_ _47"> </span><span class="ff1a">err_exit<span class="_ _47"> </span></span>and</span></span></div><div class="t m0 x2d h49 y5b34 ff19 fs26 fc0 sc0 ls0 ws0">the other error r<span class="_ _0"></span>outines.)</div><div class="t m0 x32 h4d y5b35 ff19 fs26 fc0 sc0 ls0 ws0">[60 <span class="_ _a"></span>– <span class="_ _a"></span>80]<span class="_ _65"> </span>The<span class="_"> </span><span class="ff1a">submit_file<span class="_ _66"> </span></span>function <span class="_ _2"></span>sends <span class="_ _2"></span>a <span class="_ _2"></span>print request to <span class="_ _2"></span>the <span class="_ _2"></span>daemon and <span class="_ _2"></span>reads the</div><div class="t m0 x2d h4d y5b36 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">sponse. <span class="_ _45"> </span>First,<span class="_ _35"> </span>we <span class="_ _9"></span>build <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">printreq<span class="_ _35"> </span></span></span>re<span class="ls0">quest <span class="_ _9"></span>header<span class="_ _1"></span><span class="lsc2f">.W<span class="_ _52"></span><span class="lsc30">eu<span class="_ _b"></span><span class="ls0">se<span class="_ _45"> </span><span class="ff1a">geteuid<span class="_ _45"> </span></span>to</span></span></span></span></div><div class="t m0 x2d h4d y5b37 ff19 fs26 fc0 sc0 ls0 ws0">get the <span class="_ _2"></span>caller<span class="_ _9"></span>’s effective user <span class="_ _2"></span>ID <span class="_ _2"></span>and <span class="_ _2"></span>pass this <span class="_ _2"></span>to<span class="_ _66"> </span><span class="ff1a">getpwuid<span class="_ _66"> </span></span>to <span class="_ _2"></span>look <span class="_ _2"></span>for <span class="_ _2"></span>the user</div><div class="t m0 x2d h49 y5b38 ff19 fs26 fc0 sc0 ls0 ws0">in <span class="_ _3"></span>the <span class="_ _9"></span>system’s <span class="_ _3"></span>passwor<span class="ls6e3">dﬁ<span class="_ _b"></span><span class="ls0">le. <span class="_ _45"> </span>W<span class="_ _6"></span><span class="ls6e3">ec<span class="_ _b"></span><span class="ls0">opy <span class="_ _9"></span>the <span class="_ _9"></span>user<span class="_ _3"></span>’s <span class="_ _9"></span>name <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>request <span class="_ _3"></span>header</span></span></span></span></div><div class="t m0 x2d h4d y5b39 ff19 fs26 fc0 sc0 ls0 ws0">or use the string<span class="_"> </span><span class="ff1a">unknown<span class="_ _66"> </span></span>if we can’t <span class="_ _2"></span>identify the user<span class="_ _1"></span><span class="ls118b">.W<span class="_ _26"></span><span class="ls1766">eu<span class="_ _d"></span><span class="ls0">se<span class="_"> </span><span class="ff1a">strncpy<span class="_ _66"> </span></span>when</span></span></span></div><div class="t m0 x2d h49 y5b3a ff19 fs26 fc0 sc0 ls0 ws0">copying <span class="_ _3"></span>the <span class="_ _9"></span>name <span class="_ _9"></span>from <span class="_ _3"></span>the <span class="_ _9"></span>passwor<span class="ls1767">dﬁ<span class="_ _b"></span><span class="ls0">le <span class="_ _3"></span>to <span class="_ _9"></span>avoid <span class="_ _9"></span>writing <span class="_ _3"></span>past <span class="_ _9"></span>the <span class="_ _9"></span>end <span class="_ _3"></span>of <span class="_ _9"></span>the</span></span></div><div class="t m0 x2d h49 y5b3b ff19 fs26 fc0 sc0 ls0 ws0">user <span class="_ _9"></span>name <span class="_ _9"></span>buffer <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>request <span class="_ _3"></span>header<span class="_ _1"></span><span class="ls1768">.I<span class="_ _62"></span><span class="ls1769">ft<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>name <span class="_ _9"></span>is <span class="_ _9"></span>longer <span class="_ _9"></span>than <span class="_ _9"></span>the <span class="_ _9"></span>size <span class="_ _9"></span>of</span></span></span></div><div class="t m0 x2d h4d y5b3c ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _23"> </span>buffer<span class="_ _6"></span>,<span class="_ _44"> </span><span class="ff1a">strncpy<span class="_ _35"> </span></span>won’t <span class="_ _23"> </span>stor<span class="ls176a">eat<span class="_ _43"></span><span class="ls0">erminating <span class="_ _23"> </span>null <span class="_ _42"> </span>byte <span class="_ _42"> </span>in <span class="_ _23"> </span>the <span class="_ _42"> </span>buffer<span class="_ _6"></span>,<span class="_ _35"> </span>so<span class="_ _35"> </span>we</span></span></div><div class="t m0 x2d h49 y5b3d ff19 fs26 fc0 sc0 ls0 ws0">need to do it ourselves.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
