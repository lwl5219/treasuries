<div id="pf212" class="pf w4 h1f" data-page-no="212"><div class="pc pc212 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg212.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">496<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x76 h51 y2a3 ff19 fs2a fc0 sc0 lsed ws0">We <span class="_ _e"> </span>s<span class="_ _9"></span><span class="ls0">aw <span class="_ _9"></span>in <span class="_ _3"></span>Figur<span class="ls100d">e1<span class="_ _4f"></span><span class="ls0">4.2 <span class="_ _9"></span>that <span class="_ _9"></span>Linux <span class="_ _3"></span>3.2.0 <span class="_ _9"></span>and <span class="_ _9"></span>Solaris <span class="_ _9"></span>10 <span class="_ _3"></span>provide <span class="_ _9"></span>mandatory <span class="_ _3"></span>recor<span class="ls100e">dl<span class="_ _4f"></span><span class="ls0">ocking, <span class="_ _9"></span>but</span></span></span></span></span></div><div class="t m0 x76 h51 y2a4 ff19 fs2a fc0 sc0 ls0 ws0">FreeBSD <span class="_ _3"></span>8.0 <span class="_ _3"></span>and <span class="_ _9"></span>Mac <span class="_ _3"></span>OS <span class="_ _9"></span>X <span class="_ _3"></span>10.6.8 <span class="_ _9"></span>do <span class="_ _9"></span>not.<span class="_ _4b"> </span>Mandatory <span class="_ _9"></span>recor<span class="lsc08">dl<span class="_ _8"></span><span class="ls0">ocking <span class="_ _9"></span>is <span class="_ _9"></span>not <span class="_ _3"></span>part <span class="_ _9"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>Single</span></span></div><div class="t m0 x76 h51 y2a5 ff19 fs2a fc0 sc0 ls0 ws0">UNIX <span class="_ _2"></span>Speciﬁcation.<span class="_ _4b"> </span>On <span class="_ _2"></span>Linux, <span class="_ _2"></span>if <span class="_ _3"></span>you <span class="_ _2"></span>want <span class="_ _2"></span>mandatory <span class="_ _3"></span>locking, <span class="_ _2"></span>you <span class="_ _2"></span>need <span class="_ _3"></span>to <span class="_ _2"></span>enable <span class="_ _3"></span>it <span class="_ _2"></span>on <span class="_ _2"></span>a <span class="_ _3"></span>per</div><div class="t m0 x76 h52 y2a6 ff19 fs2a fc0 sc0 ls0 ws0">ﬁle system basis by using the<span class="_"> </span><span class="ff1a">-o mand<span class="_ _53"> </span></span>option to the<span class="_"> </span><span class="ff1a">mount<span class="_ _e"> </span></span>command.</div><div class="t m0 x3f h2a y2f3 ff19 fsf fc0 sc0 ls0 ws0">Mandatory locking <span class="_ _2"></span>is enabled <span class="_ _2"></span>for a <span class="_ _2"></span>particular <span class="_ _2"></span>ﬁle by <span class="_ _2"></span>turning on <span class="_ _2"></span>the set-group-ID bit</div><div class="t m0 x32 h2a y2f4 ff19 fsf fc0 sc0 ls0 ws0">and <span class="_ _23"></span>turning <span class="_ _9"></span>of<span class="ls100f">ft<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>group-execute <span class="_ _9"></span>bit.<span class="_ _51"> </span>(Recall <span class="_ _23"></span>Figur<span class="ls100f">e4<span class="_ _43"></span><span class="ls0">.12.) <span class="_ _35"> </span>Since<span class="_ _45"> </span>the <span class="_ _23"> </span>set-group-ID <span class="_ _9"></span>bit</span></span></span></span></div><div class="t m0 x32 h2a y3cda ff19 fsf fc0 sc0 ls0 ws0">makes <span class="_ _2"></span>no <span class="_ _2"></span>sense <span class="_ _2"></span>when <span class="_ _2"></span>the <span class="_ _2"></span>group-execute <span class="_ _2"></span>bit <span class="_ _2"></span>is <span class="_ _2"></span>off, the <span class="_ _3"></span>designers <span class="_ _2"></span>of <span class="_ _2"></span>SVR3 <span class="_ _2"></span>chose <span class="_ _2"></span>this <span class="_ _2"></span>way</div><div class="t m0 x32 h2a y3cdb ff19 fsf fc0 sc0 ls0 ws0">to specify that the <span class="_ _2"></span>locking for a <span class="_ _2"></span>ﬁle is to <span class="_ _2"></span>be mandatory locking and <span class="_ _2"></span>not advisory locking.</div><div class="t m0 x3f h26 y3cdc ff19 fsf fc0 sc0 ls0 ws0">What <span class="_ _23"></span>happens <span class="_ _23"></span>to <span class="_ _9"></span>a <span class="_ _23"> </span>process <span class="_ _23"></span>that <span class="_ _23"></span>tries <span class="_ _9"></span>to<span class="_ _35"> </span><span class="ff1a">read<span class="_ _35"> </span></span>or<span class="_ _45"> </span><span class="ff1a">write<span class="_ _35"> </span></span><span class="ls1010">aﬁ<span class="_ _b"></span><span class="ls0">le <span class="_ _9"></span>that <span class="_ _23"></span>has <span class="_ _23"></span>mandatory</span></span></div><div class="t m0 x32 h2a y3cdd ff19 fsf fc0 sc0 ls0 ws0">locking <span class="_ _23"> </span>enabled <span class="_ _42"> </span>and <span class="_ _42"> </span>that <span class="_ _23"> </span>part <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>is <span class="_ _23"> </span>currently <span class="_ _23"> </span>locked <span class="_ _42"> </span>by <span class="_ _42"> </span>another <span class="_ _23"> </span>process? <span class="_ _35"> </span>The</div><div class="t m0 x32 h26 y3cde ff19 fsf fc0 sc0 ls0 ws0">answer <span class="_ _2"></span>depends <span class="_ _2"></span>on <span class="_ _3"></span>the <span class="_ _2"></span>type <span class="_ _3"></span>of <span class="_ _2"></span>operation <span class="_ _2"></span>(<span class="ff1a">read<span class="_ _47"> </span></span>or<span class="_ _47"> </span><span class="ff1a">write</span>), <span class="_ _2"></span>the <span class="_ _2"></span>type <span class="_ _3"></span>of <span class="_ _2"></span>lock <span class="_ _3"></span>held <span class="_ _2"></span>by <span class="_ _2"></span>the</div><div class="t m0 x32 h26 y3cdf ff19 fsf fc0 sc0 ls0 ws0">other <span class="_ _53"> </span>process <span class="_ _53"> </span>(read <span class="_ _53"> </span>lock <span class="_ _e"> </span>or <span class="_ _e"> </span>write <span class="_ _53"> </span>lock), <span class="_ _e"> </span>and <span class="_ _e"> </span>whether <span class="_ _e"> </span>the <span class="_ _53"> </span>descriptor <span class="_ _e"> </span>for <span class="_ _e"> </span>the<span class="_ _4b"> </span><span class="ff1a">read<span class="_ _4b"> </span></span>or</div><div class="t m0 x32 h26 y3ce0 ff1a fsf fc0 sc0 ls0 ws0">write<span class="_ _80"> </span><span class="ff19">is nonblocking.<span class="_ _46"> </span>Figur<span class="ls44">e1<span class="_ _d"></span><span class="ls0">4.1<span class="_ _1"></span><span class="ls44">1s<span class="_ _d"></span><span class="ls0">hows the eight possibilities.</span></span></span></span></span></div><div class="t m0 x206 h2d y3ce1 ff19 fs10 fc0 sc0 ls277 ws0">Ty<span class="_ _3"></span><span class="ls0">pe of existing<span class="_ _171"> </span>Blocking descriptor<span class="_ _1"></span><span class="ls1011">,N<span class="_ _164"></span><span class="ls0">onblocking descriptor<span class="_ _1"></span>,</span></span></span></div><div class="t m0 x9c h2d y3ce2 ff19 fs10 fc0 sc0 ls0 ws0">tries to<span class="_ _2a4"> </span>tries to</div><div class="t m0 x125 h2e y3ce3 ff19 fs11 fc0 sc0 ls0 ws0">lock on region held</div><div class="t m0 x21c h4f y3ce4 ff19 fs11 fc0 sc0 ls0 ws0">by other process<span class="_ _171"> </span><span class="ff1a">read <span class="_ _129"> </span>write <span class="_ _12b"> </span>read <span class="_ _129"> </span>write</span></div><div class="t m0 x184 h6d y3ce5 ff19 fs12 fc0 sc0 ls222 ws0">re<span class="ls0">ad lock<span class="_ _137"> </span>OK <span class="_ _171"> </span>blocks <span class="_ _1ad"> </span>OK<span class="_ _e0"> </span><span class="ff1a">EAGAIN</span></span></div><div class="t m0 x1e4 h6d y3ce6 ff19 fs12 fc0 sc0 ls0 ws0">write lock<span class="_ _16e"> </span>blocks <span class="_ _18"> </span>blocks<span class="_ _bf"> </span><span class="ff1a">EAGAIN <span class="_ _1c3"> </span>EAGAIN</span></div><div class="t m0 xc4 h63 y3ce7 ff18 fs13 fc0 sc0 ls0 ws0">Figure 14.1<span class="_ _0"></span>1<span class="_ _5a"> </span><span class="ff19">Effect of mandatory locking on<span class="_"> </span><span class="ff1a">read</span><span class="ls673">sa<span class="_ _5"></span><span class="ls0">nd<span class="_"> </span><span class="ff1a">write</span>s<span class="_"> </span>by<span class="_"> </span>other processes</span></span></span></div><div class="t m0 x3f h64 y3ce8 ff19 fs31 fc0 sc0 ls0 ws0">In addition <span class="_ _2"></span>to <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">read<span class="_ _66"> </span></span>and<span class="_ _66"> </span><span class="ff1a">write<span class="_ _66"> </span></span>functions <span class="_ _2"></span>in <span class="_ _2"></span>Figur<span class="ls1012">e1<span class="_ _4f"></span><span class="ls0">4.1<span class="_ _1"></span>1, <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">open<span class="_ _66"> </span></span>function <span class="_ _2"></span>can</span></span></div><div class="t m0 x32 h64 y3ce9 ff19 fs31 fc0 sc0 ls0 ws0">be <span class="_ _47"> </span>affected <span class="_ _47"> </span>by <span class="_ _45"> </span>mandatory <span class="_ _47"> </span>recor<span class="ls1013">dl<span class="_ _62"></span><span class="ls0">ocks <span class="_ _47"> </span>held <span class="_ _45"> </span>by <span class="_ _47"> </span>another <span class="_ _45"> </span>process. <span class="_ _61"> </span>Normally<span class="_ _6"></span>,<span class="_ _16"> </span><span class="ff1a">open</span></span></span></div><div class="t m0 x32 h6e y3cea ff19 fs31 fc0 sc0 ls0 ws0">succeeds, <span class="_ _23"> </span>even <span class="_ _23"> </span>if <span class="_ _42"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _23"> </span>being <span class="_ _42"> </span>opened <span class="_ _23"> </span>has <span class="_ _23"> </span>outstanding <span class="_ _42"> </span>mandatory <span class="_ _23"> </span>recor<span class="_ _0"></span><span class="ls1014">dl<span class="_ _43"></span><span class="ls0">ocks. <span class="_ _35"> </span>The</span></span></div><div class="t m0 x32 h64 y3ceb ff19 fs31 fc0 sc0 ls0 ws0">next<span class="_"> </span><span class="ff1a">read<span class="_ _47"> </span></span>or<span class="_"> </span><span class="ff1a">write<span class="_ _47"> </span></span>follows the <span class="_ _2"></span>rules <span class="_ _2"></span>listed <span class="_ _2"></span>in <span class="_ _2"></span>Figur<span class="ls1015">e1<span class="_ _4f"></span><span class="ls0">4.1<span class="_ _1"></span>1. <span class="_ _66"> </span>But<span class="_ _66"> </span>if <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>being <span class="_ _2"></span>opened</span></span></div><div class="t m0 x32 h6e y3cec ff19 fs31 fc0 sc0 ls0 ws0">has <span class="_ _42"> </span>outstanding <span class="_ _42"> </span>mandatory <span class="_ _42"> </span>recor<span class="_ _1"></span><span class="ls1016">dl<span class="_ _43"></span><span class="ls0">ocks <span class="_ _42"> </span>(either <span class="_ _42"> </span>read <span class="_ _23"> </span>locks <span class="_ _42"> </span>or <span class="_ _42"> </span>write <span class="_ _42"> </span>locks), <span class="_ _42"> </span>and <span class="_ _42"> </span>if <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h64 y3ced ff19 fs31 fc0 sc0 ls0 ws0">ﬂags in the call to<span class="_"> </span><span class="ff1a">open<span class="_ _80"> </span></span>specify either<span class="_"> </span><span class="ff1a">O_TRUNC<span class="_ _66"> </span></span>or<span class="_"> </span><span class="ff1a">O_CREAT</span><span class="ls1017">,t<span class="_ _d"></span><span class="ls0">hen<span class="_"> </span><span class="ff1a">open<span class="_ _66"> </span></span><span class="ls225">re</span>turns an error</span></span></div><div class="t m0 x32 h64 y3cee ff19 fs31 fc0 sc0 ls0 ws0">of<span class="_"> </span><span class="ff1a">EAGAIN<span class="_ _80"> </span></span>immediately<span class="_ _6"></span><span class="ls229">,r<span class="_ _4f"></span><span class="ls0">egardless of whether<span class="_"> </span><span class="ff1a">O_NONBLOCK<span class="_ _80"> </span></span>is speciﬁed.</span></span></div><div class="t m0 x76 h63 y3cef ff19 fs13 fc0 sc0 ls0 ws0">Only <span class="_ _9"></span>Solaris <span class="_ _23"> </span>treats <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">O_CREAT<span class="_ _47"> </span></span>ﬂag <span class="_ _23"> </span>as <span class="_ _9"></span>an <span class="_ _9"> </span>error <span class="_ _9"> </span>case.<span class="_ _46"> </span>Linux <span class="_ _9"> </span>allows <span class="_ _23"> </span>the<span class="_ _47"> </span><span class="ff1a">O_CREAT<span class="_ _47"> </span></span>ﬂag <span class="_ _9"></span>to <span class="_ _9"> </span>be</div><div class="t m0 x76 h63 y3cf0 ff19 fs13 fc0 sc0 ls0 ws0">speciﬁed when opening <span class="_ _2"></span>a ﬁle <span class="_ _2"></span>with an <span class="_ _2"></span>outstanding mandatory <span class="_ _2"></span>lock.<span class="_ _44"> </span>Generating the<span class="_"> </span><span class="ff1a">open<span class="_ _80"> </span></span>error</div><div class="t m0 x76 h63 y3cf1 ff19 fs13 fc0 sc0 ls0 ws0">for<span class="_ _47"> </span><span class="ff1a">O_TRUNC<span class="_ _45"> </span></span>makes <span class="_ _23"> </span>sense, <span class="_ _23"> </span>because <span class="_ _23"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _23"> </span>cannot <span class="_ _23"> </span>be <span class="_ _23"> </span>truncated <span class="_ _23"> </span>if <span class="_ _23"> </span>it <span class="_ _23"> </span>is <span class="_ _23"> </span>read <span class="_ _23"> </span>locked <span class="_ _23"> </span>or <span class="_ _23"> </span>write</div><div class="t m0 x76 h63 y3cf2 ff19 fs13 fc0 sc0 ls0 ws0">locked by another process. <span class="_"> </span>Generating<span class="_"> </span>the error for<span class="_"> </span><span class="ff1a">O_CREAT</span><span class="ls1018">,h<span class="_ _84"></span><span class="ls0">owever<span class="_ _1"></span><span class="ls1018">,m<span class="_ _84"></span><span class="ls0">akes little sense; <span class="_ _2"></span>this</span></span></span></span></div><div class="t m0 x76 h30 y3cf3 ff19 fs13 fc0 sc0 ls0 ws0">ﬂag <span class="_ _2"></span>says <span class="_ _2"></span>to <span class="_ _3"></span>create <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _3"></span>only <span class="_ _2"></span>if <span class="_ _3"></span>it <span class="_ _2"></span>doesn’t <span class="_ _3"></span>already exist, <span class="_ _3"></span>but <span class="_ _2"></span>it <span class="_ _3"></span>has <span class="_ _2"></span>to <span class="_ _3"></span>exist <span class="_ _2"></span>to <span class="_ _3"></span>be <span class="_ _2"></span>recor<span class="ls1019">dl<span class="_ _d"></span><span class="ls0">ocked</span></span></div><div class="t m0 x76 h30 y3cf4 ff19 fs13 fc0 sc0 ls0 ws0">by another process.</div><div class="t m0 x3f h64 y3cf5 ff19 fs31 fc0 sc0 ls0 ws0">This <span class="_ _9"></span>handling <span class="_ _9"></span>of <span class="_ _23"></span>locking <span class="_ _9"></span>conﬂicts <span class="_ _9"></span>with<span class="_ _35"> </span><span class="ff1a">open<span class="_ _45"> </span></span>can <span class="_ _9"></span>lead <span class="_ _9"></span>to <span class="_ _23"></span>surprising <span class="_ _9"></span>results. <span class="_ _45"> </span>While</div><div class="t m0 x32 h6e y3cf6 ff19 fs31 fc0 sc0 ls0 ws0">developing <span class="_"> </span>the <span class="_ _e"> </span>exercises <span class="_ _e"> </span>in <span class="_"> </span>this <span class="_ _e"> </span>section, <span class="_"> </span>a <span class="_ _e"> </span>test <span class="_"> </span>program <span class="_ _e"> </span>was <span class="_"> </span>r<span class="_ _0"></span>un <span class="_"> </span>that <span class="_ _e"> </span>opened <span class="_"> </span>a <span class="_ _e"> </span>ﬁle</div><div class="t m0 x32 h6e y3cf7 ff19 fs31 fc0 sc0 ls0 ws0">(whose mode speciﬁed mandatory locking), established a read lock on an entir<span class="ls101a">eﬁ<span class="_ _4f"></span><span class="ls0">le, and</span></span></div><div class="t m0 x32 h6e y3cf8 ff19 fs31 fc0 sc0 ls0 ws0">then went <span class="_ _2"></span>to sleep <span class="_ _2"></span>for a <span class="_ _2"></span>while.<span class="_ _46"> </span>(Recall from Figur<span class="ls101b">e1<span class="_ _4f"></span><span class="ls0">4.1<span class="_ _0"></span><span class="ls101b">1t<span class="_ _4f"></span><span class="ls0">hat <span class="_ _2"></span>a read lock should <span class="_ _2"></span>prevent</span></span></span></span></div><div class="t m0 x32 h6e y3cf9 ff19 fs31 fc0 sc0 ls0 ws0">writing <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _2"></span>ﬁle <span class="_ _3"></span>by <span class="_ _2"></span>other <span class="_ _3"></span>processes.) <span class="_ _66"> </span>During<span class="_ _47"> </span>this <span class="_ _2"></span>sleep <span class="_ _3"></span>period, <span class="_ _3"></span>the <span class="_ _2"></span>following <span class="_ _3"></span>behavior</div><div class="t m0 x32 h6e y3cfa ff19 fs31 fc0 sc0 ls0 ws0">was seen in other typical UNIX System programs.</div><div class="t m0 x3f h64 y3cfb ff19 fs31 fc0 sc0 ls101c ws0">•T<span class="_ _4d"></span><span class="ls0">he <span class="_ _2"></span>same <span class="_ _3"></span>ﬁle <span class="_ _3"></span>could <span class="_ _3"></span>be <span class="_ _2"></span>edited <span class="_ _3"></span>with <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">ed<span class="_ _47"> </span></span>editor<span class="_ _6"></span><span class="ls101d">,a<span class="_ _4f"></span><span class="ls0">nd <span class="_ _3"></span>the <span class="_ _2"></span>results <span class="_ _2"></span>written <span class="_ _3"></span>back <span class="_ _3"></span>to</span></span></span></div><div class="t m0 x15 h6e y3cfc ff19 fs31 fc0 sc0 ls0 ws0">disk! <span class="_ _45"> </span>The<span class="_ _45"> </span>mandatory <span class="_ _9"></span>recor<span class="_ _1"></span><span class="ls101e">dl<span class="_ _8"></span><span class="ls0">ocking <span class="_ _9"></span>had <span class="_ _9"></span>no <span class="_ _9"></span>effect <span class="_ _9"></span>at <span class="_ _9"></span>all.<span class="_ _5a"> </span>Using <span class="_ _9"></span>the <span class="_ _9"></span>system <span class="_ _9"></span>call</span></span></div><div class="t m0 x15 h64 y3cfd ff19 fs31 fc0 sc0 ls0 ws0">trace featur<span class="ls101f">ep<span class="_ _4f"></span><span class="ls225">ro<span class="_ _2"></span><span class="ls0">vided by <span class="_ _2"></span>some versions of <span class="_ _2"></span>the UNIX <span class="_ _2"></span>System, it was <span class="_ _2"></span>seen that<span class="_ _66"> </span><span class="ff1a">ed</span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
