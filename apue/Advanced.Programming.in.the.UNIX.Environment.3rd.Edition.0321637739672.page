<div id="pf2a0" class="pf w4 h1f" data-page-no="2a0"><div class="pc pc2a0 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg2a0.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">638<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>IPC<span class="_ _e8"> </span>Chapter <span class="_"> </span>17</span></div><div class="t m0 x9d h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y8f7 ff1a fs2d fc0 sc0 ls0 ws0">if (listen(fd, QLEN) &lt; 0) { /* tell kernel we’re a server */</div><div class="t m0 x9d h57 yae9 ff1a fs2d fc0 sc0 ls0 ws0">rval = -4;</div><div class="t m0 x9d h57 yaea ff1a fs2d fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h57 yaeb ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y16f9 ff1a fs2d fc0 sc0 ls0 ws0">return(fd);</div><div class="t m0 x32 h57 yaed ff1a fs2d fc0 sc0 ls0 ws0">errout:</div><div class="t m0 x8a h57 y340d ff1a fs2d fc0 sc0 ls0 ws0">err = errno;</div><div class="t m0 x8a h57 y340e ff1a fs2d fc0 sc0 ls0 ws0">close(fd);</div><div class="t m0 x8a h57 y16fa ff1a fs2d fc0 sc0 ls0 ws0">errno = err;</div><div class="t m0 x8a h57 y340f ff1a fs2d fc0 sc0 ls0 ws0">return(rval);</div><div class="t m0 x32 h57 y3410 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x209 h5e y4bb7 ff18 fs10 fc0 sc0 ls0 ws0">Figure 17.8<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">serv_listen<span class="_ _e"> </span></span>function</span></div><div class="t m0 x32 h4d y4bb8 ff19 fs26 fc0 sc0 ls0 ws0">First, <span class="_ _e"> </span>we <span class="_ _e"> </span>create <span class="_ _53"> </span>a <span class="_ _e"> </span>single <span class="_ _e"> </span>UNIX <span class="_ _e"> </span>domain <span class="_ _e"> </span>socket <span class="_ _e"> </span>by <span class="_ _e"> </span>calling<span class="_ _4b"> </span><span class="ff1a">socket</span><span class="lscac">.W<span class="_ _49"></span><span class="ls13b8">et<span class="_ _55"></span><span class="ls0">hen <span class="_ _e"> </span>ﬁll <span class="_ _e"> </span>in <span class="_ _e"> </span>a</span></span></span></div><div class="t m0 x32 h4d y4bb9 ff1a fs26 fc0 sc0 ls0 ws0">sockaddr_un<span class="_ _35"> </span><span class="ff19">structur<span class="_ _0"></span><span class="ls13b9">ew<span class="_ _43"></span><span class="ls0">ith <span class="_ _23"> </span>the <span class="_ _42"> </span>well-known <span class="_ _23"> </span>pathname <span class="_ _23"> </span>to <span class="_ _42"> </span>be <span class="_ _23"></span>assigned <span class="_ _23"> </span>to <span class="_ _42"> </span>the <span class="_ _23"></span>socket.</span></span></span></div><div class="t m0 x32 h4d y4bba ff19 fs26 fc0 sc0 ls0 ws0">This <span class="_ _23"></span>structur<span class="_ _0"></span>e<span class="_ _35"> </span>is<span class="_ _45"> </span>the <span class="_ _23"> </span>argument <span class="_ _23"></span>to<span class="_ _35"> </span><span class="ff1a">bind</span><span class="ls13ba">.N<span class="_ _7"></span><span class="ls0">ote <span class="_ _23"> </span>that <span class="_ _23"> </span>we <span class="_ _23"> </span>don’t <span class="_ _23"></span>need <span class="_ _23"></span>to <span class="_ _23"></span>set <span class="_ _23"></span>the<span class="_ _35"> </span><span class="ff1a">sun_len</span></span></span></div><div class="t m0 x32 h49 y4bbb ff19 fs26 fc0 sc0 ls0 ws0">ﬁeld <span class="_ _2"></span>present <span class="_ _3"></span>on <span class="_ _3"></span>some <span class="_ _2"></span>platforms, <span class="_ _3"></span>because <span class="_ _3"></span>the <span class="_ _3"></span>operating <span class="_ _3"></span>system <span class="_ _3"></span>sets <span class="_ _3"></span>this <span class="_ _3"></span>for <span class="_ _3"></span>us, <span class="_ _2"></span>deriving</div><div class="t m0 x32 h4d y4bbc ff19 fs26 fc0 sc0 ls0 ws0">it from the addr<span class="_ _0"></span>ess length we pass to the<span class="_"> </span><span class="ff1a">bind<span class="_ _80"> </span></span>function.</div><div class="t m0 x3f h4d y4bbd ff19 fs26 fc0 sc0 ls0 ws0">Finally<span class="_ _4"></span>,<span class="_ _4b"> </span>we<span class="_ _59"> </span>call<span class="_ _4b"> </span><span class="ff1a">listen<span class="_ _4b"> </span></span>(Section <span class="_ _e"> </span>16.4) <span class="_ _e"> </span>to <span class="_ _e"> </span>tell <span class="_ _e"> </span>the <span class="_ _e"> </span>kernel <span class="_ _e"> </span>that <span class="_ _e"> </span>the <span class="_ _e"> </span>process <span class="_ _53"> </span>will <span class="_ _e"> </span>be</div><div class="t m0 x32 h49 y4bbe ff19 fs26 fc0 sc0 ls0 ws0">acting <span class="_ _23"> </span>as <span class="_ _42"> </span>a <span class="_ _42"> </span>server <span class="_ _23"> </span>awaiting <span class="_ _42"> </span>connections <span class="_ _42"> </span>from <span class="_ _23"> </span>clients.<span class="_ _54"> </span>When <span class="_ _23"> </span>a <span class="_ _42"> </span>connect <span class="_ _42"> </span>r<span class="_ _0"></span>equest <span class="_ _42"> </span>fr<span class="_ _0"></span>om <span class="_ _42"> </span>a</div><div class="t m0 x32 h4d y4bbf ff19 fs26 fc0 sc0 ls0 ws0">client arrives, the server calls the<span class="_"> </span><span class="ff1a">serv_accept<span class="_ _80"> </span></span>function (Figur<span class="lsd3">e1<span class="_ _d"></span><span class="ls0">7.9).</span></span></div><div class="t m0 x32 h5d y4bc0 ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h5d y4bc1 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x32 h5d y4bc2 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;sys/un.h&gt;</div><div class="t m0 x32 h5d y4bc3 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;time.h&gt;</div><div class="t m0 x32 h5d y4bc4 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h5d y4bc5 ff1a fs2f fc0 sc0 ls0 ws0">#define STALE<span class="_ _68"> </span>30 <span class="_"> </span>/*<span class="_"> </span>client’s name can’t be older than this (sec) */</div><div class="t m0 x32 h5d y4bc6 ff1a fs2f fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h5d y4bc7 ff1a fs2f fc0 sc0 ls395 ws0">*W<span class="_ _1d"></span><span class="ls0">ait for a client connection to arrive, and accept it.</span></div><div class="t m0 x140 h5d y4bc8 ff1a fs2f fc0 sc0 ls0 ws0">*<span class="_"> </span>We<span class="_"> </span>also obtain the client’s user ID from the pathname</div><div class="t m0 x140 h5d y4bc9 ff1a fs2f fc0 sc0 ls395 ws0">*t<span class="_ _1d"></span><span class="ls0">hat it must bind before calling us.</span></div><div class="t m0 x140 h5d y4bca ff1a fs2f fc0 sc0 ls395 ws0">*R<span class="_ _1d"></span><span class="ls0">eturns new fd if all OK, &lt;0 on error</span></div><div class="t m0 x140 h5d y4bcb ff1a fs2f fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h5d y4bcc ff1a fs2f fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h5d y4bcd ff1a fs2f fc0 sc0 ls0 ws0">serv_accept(int listenfd, uid_t *uidptr)</div><div class="t m0 x32 h5d y4bce ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y4bcf ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>clifd,<span class="_"> </span>err, rval;</div><div class="t m0 x8a h5d y4bd0 ff1a fs2f fc0 sc0 ls0 ws0">socklen_t <span class="_ _74"> </span>len;</div><div class="t m0 x8a h5d y4bd1 ff1a fs2f fc0 sc0 ls0 ws0">time_t <span class="_ _166"> </span>staletime;</div><div class="t m0 x8a h5d y4bd2 ff1a fs2f fc0 sc0 ls0 ws0">struct sockaddr_un<span class="_ _d9"> </span>un;</div><div class="t m0 x8a h5d y4bd3 ff1a fs2f fc0 sc0 ls0 ws0">struct stat<span class="_ _176"> </span>statbuf;</div><div class="t m0 x8a h5d y4bd4 ff1a fs2f fc0 sc0 ls0 ws0">char <span class="_ _227"> </span>*name;</div><div class="t m0 x8a h5d y4bd5 ff1a fs2f fc0 sc0 ls0 ws0">/* allocate enough space for longest name plus terminating null */</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
