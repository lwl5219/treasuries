<div id="pf31e" class="pf w4 h1f" data-page-no="31e"><div class="pc pc31e w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg31e.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">764<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">262 <span class="_ _15"> </span>while<span class="_"> </span>(offset != 0) {</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">263 <span class="_ _186"> </span>nextoffset<span class="_"> </span><span class="ls15c">=_<span class="_ _1d"></span><span class="ls0">db_readidx(db, offset);</span></span></div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">264 <span class="_ _186"> </span>if<span class="_"> </span>(strcmp(db-&gt;idxbuf, key) == 0)</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">265 <span class="_ _82"> </span>break;<span class="_ _b7"> </span>/* found a match */</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">266 <span class="_ _186"> </span>db-&gt;ptroff<span class="_"> </span><span class="ls15c">=o<span class="_ _1d"></span><span class="ls0">ffset; /* offset of this (unequal) record */</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">267 <span class="_ _186"> </span>offset<span class="_"> </span><span class="ls15c">=n<span class="_ _1d"></span><span class="ls0">extoffset; /* next one to compare */</span></span></div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">268 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">269 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">270 <span class="_ _8a"> </span>*<span class="_"> </span>offset == 0 on error (record not found).</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">271 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">272 <span class="_ _15"> </span>return(offset<span class="_"> </span>== 0 ? -1 : 0);</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">273 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">274 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">275 <span class="_ _68"> </span>*<span class="_"> </span>Calculate the hash value for a key.</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">276 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">277 <span class="_ _d9"> </span>static<span class="_"> </span>DBHASH</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">278 <span class="_ _d9"> </span>_db_hash(DB<span class="_"> </span>*db, const char *key)</div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">279 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">280 <span class="_ _15"> </span>DBHASH<span class="_ _189"> </span>hval = 0;</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">281 <span class="_ _15"> </span>char<span class="_ _186"> </span>c;</div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">282 <span class="_ _15"> </span>int<span class="_ _176"> </span>i;</div><div class="t m0 x32 h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">283 <span class="_ _15"> </span>for<span class="_"> </span>(i = 1; (c = *key++) != 0; i++)</div><div class="t m0 x32 h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">284 <span class="_ _186"> </span>hval<span class="_"> </span>+= c * i;<span class="_ _189"> </span>/* ascii char times its 1-based index */</div><div class="t m0 x32 h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">285 <span class="_ _15"> </span>return(hval<span class="_"> </span><span class="ls15c">%d<span class="_ _1d"></span><span class="ls0">b-&gt;nhash);</span></span></div><div class="t m0 x32 h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">286 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y5777 ff19 fs26 fc0 sc0 ls0 ws0">[262 <span class="_ _a"></span>– <span class="_ _a"></span>268]<span class="_ _65"> </span>In <span class="_ _53"> </span>the<span class="_ _59"> </span><span class="ff1a">while<span class="_ _4b"> </span></span>loop, <span class="_ _e"> </span>we <span class="_ _e"> </span>go <span class="_ _e"> </span>through <span class="_ _53"> </span>each <span class="_ _e"> </span>index <span class="_ _e"> </span>recor<span class="_ _0"></span><span class="ls1681">do<span class="_ _55"></span><span class="ls1682">nt<span class="_ _55"></span><span class="ls0">he <span class="_ _e"> </span>hash <span class="_ _e"> </span>chain,</span></span></span></div><div class="t m0 x11a h4d y5778 ff19 fs26 fc0 sc0 ls0 ws0">comparing <span class="_ _45"> </span>keys.<span class="_ _5f"> </span><span class="ls164">We <span class="_ _61"> </span>c<span class="_ _9"></span></span>all<span class="_ _5a"> </span><span class="ff1a">_db_readidx<span class="_"> </span></span>to <span class="_ _45"> </span>read <span class="_ _47"> </span>each <span class="_ _45"> </span>index <span class="_ _45"> </span>recor<span class="_ _0"></span>d. <span class="_ _5a"> </span>It</div><div class="t m0 x11a h4d y5779 ff19 fs26 fc0 sc0 ls0 ws0">populates <span class="_ _59"> </span>the<span class="_ _60"> </span><span class="ff1a">idxbuf<span class="_ _60"> </span></span>ﬁeld <span class="_ _59"> </span>with <span class="_ _46"> </span>the <span class="_ _59"> </span>key <span class="_ _46"> </span>of <span class="_ _59"> </span>the <span class="_ _46"> </span>current <span class="_ _59"> </span>recor<span class="_ _0"></span>d. <span class="_ _60"> </span>If</div><div class="t m0 x11a h4d y577a ff1a fs26 fc0 sc0 ls0 ws0">_db_readidx<span class="_ _80"> </span><span class="ff19 lscc">re<span class="_ _2"></span><span class="ls0">turns zero, we’ve r<span class="_ _0"></span>eached the last entry in the chain.</span></span></div><div class="t m0 x32 h4d y1f45 ff19 fs26 fc0 sc0 ls0 ws0">[269 <span class="_ _a"></span>– <span class="_ _a"></span>273]<span class="_ _65"> </span>If<span class="_ _4b"> </span><span class="ff1a">offset<span class="_ _59"> </span></span>is <span class="_ _53"> </span>zer<span class="ls1683">oa<span class="_ _55"></span><span class="ls0">fter <span class="_ _e"> </span>the <span class="_ _e"> </span>loop, <span class="_ _e"> </span>we’ve <span class="_"> </span>r<span class="_ _1"></span>eached <span class="_"> </span>the <span class="_ _53"> </span>end <span class="_ _e"> </span>of <span class="_ _e"> </span>a <span class="_"> </span>hash <span class="_ _53"> </span>chain</span></span></div><div class="t m0 x11a h49 y1f46 ff19 fs26 fc0 sc0 ls0 ws0">without <span class="_ _42"> </span>ﬁnding <span class="_ _42"> </span>a <span class="_ _42"> </span>matching <span class="_ _53"> </span>key<span class="_ _4"></span>,<span class="_ _44"> </span>so<span class="_ _44"> </span>we<span class="_ _44"> </span>return<span class="_ _35"> </span><span class="ff20">−</span>1. <span class="_ _44"> </span>Otherwise,<span class="_ _44"> </span>we <span class="_ _42"> </span>found <span class="_ _53"> </span>a</div><div class="t m0 x11a h4d y1f47 ff19 fs26 fc0 sc0 ls0 ws0">match <span class="_ _2"></span>(and <span class="_ _3"></span>exited <span class="_ _3"></span>the <span class="_ _3"></span>loop <span class="_ _2"></span>with <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">break<span class="_ _47"> </span></span>statement), <span class="_ _2"></span>so <span class="_ _3"></span>we <span class="_ _3"></span>return <span class="_ _2"></span>success</div><div class="t m0 x11a h49 y577b ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x139 h49 y1f48 ff19 fs26 fc0 sc0 ls0 ws0">0</div><div class="t m0 x227 h49 y577b ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 x16e h4d y1f48 ff19 fs26 fc0 sc0 ls1684 ws0">.I<span class="_ _5b"></span><span class="ls1685">nt<span class="_ _4f"></span><span class="ls0">his <span class="_ _2"></span>case, <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">ptroff<span class="_ _47"> </span></span>ﬁeld <span class="_ _2"></span>contains <span class="_ _2"></span>the <span class="_ _2"></span>address of <span class="_ _2"></span>the <span class="_ _2"></span>previous index</span></span></div><div class="t m0 x11a h4d y1f49 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cord,<span class="_ _51"> </span><span class="ff1a">datoff<span class="_"> </span></span>contains <span class="_ _35"> </span>the <span class="_ _35"> </span>address <span class="_ _45"> </span>of <span class="_ _35"> </span>the <span class="_ _35"> </span>data <span class="_ _35"> </span>recor<span class="_ _0"></span>d, <span class="_ _45"> </span>and<span class="_ _51"> </span><span class="ff1a">datlen</span></span></div><div class="t m0 x11a h49 y1f4a ff19 fs26 fc0 sc0 ls0 ws0">contains <span class="_ _3"></span>the <span class="_ _3"></span>size <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _3"></span>record. <span class="_ _66"> </span>As<span class="_ _47"> </span>we <span class="_ _9"></span>make <span class="_ _2"></span>our <span class="_ _9"></span>way <span class="_ _2"></span>through <span class="_ _3"></span>the <span class="_ _3"></span>hash</div><div class="t m0 x11a h49 y1f4b ff19 fs26 fc0 sc0 ls0 ws0">chain, <span class="_ _42"> </span>we <span class="_ _53"> </span>save <span class="_ _42"> </span>the <span class="_ _53"> </span>previous <span class="_ _42"> </span>index <span class="_ _42"> </span>recor<span class="ls1686">dt<span class="_ _c"></span><span class="ls0">hat <span class="_ _42"> </span>points <span class="_ _53"> </span>to <span class="_ _53"> </span>the <span class="_ _42"> </span>current <span class="_ _42"> </span>index</span></span></div><div class="t m0 x11a h49 y1f4c ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cord. <span class="_ _47"> </span>W<span class="_ _6"></span>e’ll <span class="_ _2"></span>use <span class="_ _3"></span>this <span class="_ _2"></span>when <span class="_ _3"></span>we <span class="_ _3"></span>delete <span class="_ _2"></span>a <span class="_ _3"></span>record, since <span class="_ _3"></span>we <span class="_ _3"></span>have <span class="_ _2"></span>to <span class="_ _3"></span>modify <span class="_ _3"></span>the</span></div><div class="t m0 x11a h49 y1f4d ff19 fs26 fc0 sc0 ls0 ws0">chain pointer of the previous r<span class="_ _0"></span>ecor<span class="_ _0"></span>d<span class="_"> </span>to<span class="_"> </span>delete the current r<span class="_ _0"></span>ecord.</div><div class="t m0 x32 h4d y577c ff19 fs26 fc0 sc0 ls0 ws0">[274 <span class="_ _a"></span>– <span class="_ _a"></span>286]<span class="_ _65"> </span><span class="ff1a">_db_hash<span class="_ _46"> </span></span>calculates <span class="_"> </span>the <span class="_"> </span>hash <span class="_ _66"> </span>value <span class="_ _66"> </span>for <span class="_"> </span>a <span class="_ _66"> </span>given <span class="_ _66"> </span>key<span class="_ _6"></span><span class="ls1687">.I<span class="_ _49"></span><span class="ls1688">tm<span class="_ _4a"></span><span class="ls0">ultiplies <span class="_"> </span>each</span></span></span></div><div class="t m0 x11a h49 y577d ff19 fs26 fc0 sc0 ls0 ws0">ASCII character times its <span class="_ _2"></span>1</div><div class="t m0 x9a h49 y577e ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x1bb h49 y577d ff19 fs26 fc0 sc0 ls0 ws0">based index and divides <span class="_ _2"></span>the result by the number</div><div class="t m0 x11a h49 y577f ff19 fs26 fc0 sc0 ls0 ws0">of <span class="_ _3"></span>hash <span class="_ _9"></span>table <span class="_ _3"></span>entries.<span class="_ _16"> </span>The <span class="_ _9"></span>remainder <span class="_ _2"></span>from <span class="_ _3"></span>the <span class="_ _9"></span>division <span class="_ _3"></span>is <span class="_ _9"></span>the <span class="_ _3"></span>hash <span class="_ _3"></span>value <span class="_ _9"></span>for</div><div class="t m0 x11a h49 y5780 ff19 fs26 fc0 sc0 ls0 ws0">this key<span class="_ _6"></span><span class="ls1689">.R<span class="_ _5b"></span><span class="ls0">ecall <span class="_ _2"></span>that the <span class="_ _2"></span>number of <span class="_ _2"></span>hash table <span class="_ _2"></span>entries is <span class="_ _2"></span>137, which <span class="_ _2"></span>is a <span class="_ _2"></span>prime</span></span></div><div class="t m0 x11a h49 y5781 ff19 fs26 fc0 sc0 ls0 ws0">number<span class="_ _6"></span><span class="ls168a">.A<span class="_ _26"></span><span class="ls0">ccording <span class="_ _23"></span>to <span class="_ _23"></span>Knuth</span></span></div><div class="t m0 x67 h49 y5782 ff19 fs26 fc0 sc0 ls0 ws0">[</div><div class="t m0 x1cd h49 y5781 ff19 fs26 fc0 sc0 ls0 ws0">1998</div><div class="t m0 x15c h49 y5782 ff19 fs26 fc0 sc0 ls0 ws0">]</div><div class="t m0 xcd h49 y5781 ff19 fs26 fc0 sc0 ls168b ws0">,p<span class="_ _43"></span><span class="ls0">rime <span class="_ _23"> </span>hashes <span class="_ _23"> </span>generally <span class="_ _42"> </span>pr<span class="_ _0"></span>ovide <span class="_ _23"></span>good</span></div><div class="t m0 x11a h49 y5783 ff19 fs26 fc0 sc0 ls0 ws0">distribution characteristics.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
