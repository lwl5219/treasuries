<div id="pf269" class="pf w4 h1f" data-page-no="269"><div class="pc pc269 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg269.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>15.10<span class="_ _282"> </span>POSIX <span class="_"> </span>Semaphores<span class="_ _1fb"> </span><span class="ff18">583</span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a yce9 ff19 fsf fc0 sc0 ls0 ws0">One <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>motivations <span class="_ _9"></span>for <span class="_ _23"></span>introducing <span class="_ _9"></span>the <span class="_ _9"></span>POSIX <span class="_ _23"> </span>semaphor<span class="lsb7d">ei<span class="_ _43"></span><span class="ls0">nterfaces <span class="_ _23"> </span>was <span class="_ _23"></span>that <span class="_ _9"></span>they</span></span></div><div class="t m0 x32 h2a yceb ff19 fsf fc0 sc0 ls0 ws0">can <span class="_ _3"></span>be <span class="_ _3"></span>made <span class="_ _3"></span>to <span class="_ _3"></span>perform <span class="_ _9"></span>signiﬁcantly <span class="_ _3"></span>better <span class="_ _3"></span>than <span class="_ _3"></span>the <span class="_ _3"></span>existing <span class="_ _9"></span>XSI <span class="_ _3"></span>semaphor<span class="ls2f5">ei<span class="_ _b"></span><span class="ls0">nterfaces.</span></span></div><div class="t m0 x32 h2a y20ea ff19 fsf fc0 sc0 ls0 ws0">It <span class="_ _23"></span>is <span class="_ _23"></span>instructive <span class="_ _23"></span>to <span class="_ _23"></span>see <span class="_ _23"></span>if <span class="_ _23"></span>this <span class="_ _23"> </span>goal <span class="_ _23"> </span>was <span class="_ _23"> </span>reached <span class="_ _23"></span>in <span class="_ _23"></span>existing <span class="_ _23"></span>systems, <span class="_ _23"></span>even <span class="_ _23"></span>though <span class="_ _23"> </span>these</div><div class="t m0 x32 h2a y3fce ff19 fsf fc0 sc0 ls0 ws0">systems wer<span class="ls44">en<span class="_ _4f"></span><span class="ls0">ot designed to support real-time applications.</span></span></div><div class="t m0 x3f h2a y3bd8 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _53"> </span>Figur<span class="ls12ba">e1<span class="_ _55"></span><span class="ls0">5.34, <span class="_ _53"> </span>we <span class="_ _53"> </span>compar<span class="ls12ba">et<span class="_ _c"></span><span class="ls0">he <span class="_ _53"> </span>performance <span class="_ _53"> </span>of <span class="_ _53"> </span>using <span class="_ _53"> </span>XSI <span class="_ _53"> </span>semaphores <span class="_ _42"> </span>(without</span></span></span></span></div><div class="t m0 x32 h26 y3bd9 ff1a fsf fc0 sc0 ls0 ws0">SEM_UNDO<span class="ff19 ls12a2">)a<span class="_ _43"></span><span class="ls0">nd <span class="_ _23"> </span>POSIX <span class="_ _23"> </span>semaphores <span class="_ _23"></span>when <span class="_ _23"></span>3 <span class="_ _23"></span>processes <span class="_ _9"></span>compete <span class="_ _23"> </span>to <span class="_ _23"> </span>allocate <span class="_ _23"> </span>and <span class="_ _23"> </span>release</span></span></div><div class="t m0 x32 h2a y2090 ff19 fsf fc0 sc0 ls0 ws0">the semaphor<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">,000,000 times on two platforms</span></span></div><div class="t m0 x1fe h2a y463b ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x1ff h2a y2090 ff19 fsf fc0 sc0 ls0 ws0">Linux 3.2.0 and Solaris 10</div><div class="t m0 x1ae h2a y463b ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x1fb h2a y2090 ff19 fsf fc0 sc0 ls0 ws0">.</div><div class="t m0 xb5 h2d y463c ff19 fs10 fc0 sc0 ls0 ws0">Solaris 10<span class="_ _13c"> </span>Linux 3.2.0</div><div class="t m0 x66 h2e y463d ff19 fs11 fc0 sc0 ls0 ws0">User <span class="_ _d8"> </span>System<span class="_ _2b"> </span>Clock <span class="_ _75"> </span>User<span class="_ _87"> </span>System <span class="_ _6d"> </span>Clock</div><div class="t m0 x7b h2e y463e ff19 fs11 fc0 sc0 ls0 ws0">Operation</div><div class="t m0 x175 h2f y463f ff19 fs12 fc0 sc0 ls0 ws0">XSI semaphores <span class="_ _1a8"> </span>1<span class="_ _1"></span>1.85 <span class="_ _1fb"> </span>15.85 <span class="_ _9c"> </span>27.91<span class="_ _15"> </span>0.33 <span class="_ _15"> </span>5.93 <span class="_ _15"> </span>7.33</div><div class="t m0 x175 h2f y4640 ff19 fs12 fc0 sc0 ls0 ws0">POSIX semaphores <span class="_ _9b"> </span>13.72<span class="_ _72"> </span>10.52 <span class="_ _1fb"> </span>24.44<span class="_ _15"> </span>0.26 <span class="_ _2a8"> </span>0.75 <span class="_ _15"> </span>0.41</div><div class="t m0 x132 h30 y4641 ff18 fs13 fc0 sc0 ls0 ws0">Figure 15.34<span class="_ _5a"> </span><span class="ff19 ls10d4">Ti<span class="_ _3"></span><span class="ls0">ming comparison of semaphor<span class="ls673">ei<span class="_ _5"></span><span class="ls0">mplementations</span></span></span></span></div><div class="t m0 x3f h6e y4642 ff19 fs31 fc0 sc0 ls0 ws0">In <span class="_ _59"> </span>Figur<span class="ls12bb">e1<span class="_ _5d"></span><span class="ls0">5.34, <span class="_ _59"> </span>we <span class="_ _46"> </span>can <span class="_ _46"> </span>see <span class="_ _59"> </span>that <span class="_ _46"> </span>POSIX <span class="_ _46"> </span>semaphores <span class="_ _59"> </span>provide <span class="_ _59"> </span>only <span class="_ _46"> </span>a <span class="_ _59"> </span>12%</span></span></div><div class="t m0 x32 h6e y4643 ff19 fs31 fc0 sc0 ls0 ws0">improvement <span class="_ _23"></span>over <span class="_ _23"> </span>XSI <span class="_ _42"> </span>semaphores <span class="_ _23"></span>on <span class="_ _23"> </span>Solaris, <span class="_ _42"> </span>but <span class="_ _23"> </span>on <span class="_ _42"> </span>Linux <span class="_ _42"> </span>the <span class="_ _23"> </span>improvement <span class="_ _23"> </span>is <span class="_ _42"> </span>94%</div><div class="t m0 x32 h6e y4644 ff19 fs31 fc0 sc0 ls0 ws0">(almost <span class="_ _46"> </span>18 <span class="_ _61"> </span>times <span class="_ _61"> </span>faster)!<span class="_ _d9"> </span>If <span class="_ _46"> </span>we <span class="_ _61"> </span>trace <span class="_ _46"> </span>the <span class="_ _61"> </span>programs, <span class="_ _46"> </span>we <span class="_ _61"> </span>ﬁnd <span class="_ _61"> </span>that <span class="_ _61"> </span>the <span class="_ _46"> </span>Linux</div><div class="t m0 x32 h6e y4645 ff19 fs31 fc0 sc0 ls0 ws0">implementation <span class="_ _3"></span>of <span class="_ _3"></span>POSIX <span class="_ _3"></span>semaphores <span class="_ _3"></span>maps <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>into <span class="_ _3"></span>the <span class="_ _3"></span>process <span class="_ _3"></span>address <span class="_ _2"></span>space <span class="_ _3"></span>and</div><div class="t m0 x32 h6e y4646 ff19 fs31 fc0 sc0 ls0 ws0">performs individual semaphor<span class="ls229">eo<span class="_ _4f"></span><span class="ls0">perations without using system calls.</span></span></div><div class="t m0 x35 h97 y4647 ff16 fs49 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h96 y4648 ff19 fs49 fc0 sc0 ls0 ws0">Recall <span class="_ _2"></span>from <span class="_ _2"></span>Figur<span class="ls12bc">e1<span class="_ _8"></span><span class="ls0">2.5 <span class="_ _3"></span>that <span class="_ _2"></span>the <span class="_ _2"></span>Single <span class="_ _3"></span>UNIX <span class="_ _2"></span>Speciﬁcation <span class="_ _3"></span>doesn’t <span class="_ _2"></span>deﬁne <span class="_ _3"></span>what <span class="_ _2"></span>happens</span></span></div><div class="t m0 x32 h96 y4649 ff19 fs49 fc0 sc0 ls0 ws0">when <span class="_ _2"></span>one <span class="_ _2"></span>thread <span class="_ _2"></span>locks <span class="_ _2"></span>a <span class="_ _2"></span>normal <span class="_ _2"></span>mutex <span class="_ _3"></span>and <span class="_ _2"></span>a <span class="_ _2"></span>different thread tries <span class="_ _3"></span>to <span class="_ _2"></span>unlock <span class="_ _2"></span>it, <span class="_ _2"></span>but <span class="_ _3"></span>that</div><div class="t m0 x32 h96 y464a ff19 fs49 fc0 sc0 ls0 ws0">error<span class="_ _0"></span>-checking <span class="_ _23"></span>mutexes <span class="_ _23"></span>and <span class="_ _23"></span>recursive <span class="_ _9"></span>mutexes <span class="_ _23"> </span>generate <span class="_ _23"> </span>errors <span class="_ _23"> </span>in <span class="_ _23"> </span>this <span class="_ _23"> </span>case.<span class="_ _51"> </span>Because <span class="_ _23"> </span>a</div><div class="t m0 x32 h96 y464b ff19 fs49 fc0 sc0 ls0 ws0">binary <span class="_ _2"></span>semaphor<span class="ls12bd">ec<span class="_ _8"></span><span class="ls0">an <span class="_ _3"></span>be <span class="_ _3"></span>used <span class="_ _2"></span>like <span class="_ _3"></span>a <span class="_ _3"></span>mutex, <span class="_ _2"></span>we <span class="_ _3"></span>can <span class="_ _3"></span>use <span class="_ _2"></span>a <span class="_ _3"></span>semaphore<span class="_ _66"> </span>to<span class="_ _47"> </span>c<span class="ls4a6">re<span class="_ _2"></span></span>ate <span class="_ _2"></span>our <span class="_ _3"></span>own</span></span></div><div class="t m0 x32 h96 y464c ff19 fs49 fc0 sc0 ls0 ws0">locking primitive to provide mutual exclusion.</div><div class="t m0 x3f h96 y464d ff19 fs49 fc0 sc0 ls0 ws0">Assuming <span class="_ _3"></span>we <span class="_ _9"></span>were<span class="_ _47"> </span>to<span class="_ _45"> </span>c<span class="ls4a6">re<span class="_ _2"></span></span>ate <span class="_ _3"></span>our <span class="_ _9"></span>own <span class="_ _9"></span>lock <span class="_ _9"></span>that <span class="_ _3"></span>could <span class="_ _9"></span>be <span class="_ _9"></span>locked <span class="_ _9"></span>by <span class="_ _3"></span>one <span class="_ _9"></span>thread <span class="_ _3"></span>and</div><div class="t m0 x32 h96 y464e ff19 fs49 fc0 sc0 ls0 ws0">unlocked by another<span class="_ _6"></span><span class="ls48d">,o<span class="_ _5"></span><span class="ls0">ur lock structur<span class="_ _0"></span><span class="ls48d">em<span class="_ _d"></span><span class="ls0">ight look like</span></span></span></span></div><div class="t m0 x3f hc1 y464f ff1a fs69 fc0 sc0 ls0 ws0">struct slock {</div><div class="t m0 xf4 hc1 y4650 ff1a fs69 fc0 sc0 ls0 ws0">sem_t *semp;</div><div class="t m0 xf4 hc1 y4651 ff1a fs69 fc0 sc0 ls0 ws0">char <span class="_ _d9"> </span>name[_POSIX_NAME_MAX];</div><div class="t m0 x3f hc1 y4652 ff1a fs69 fc0 sc0 ls0 ws0">};</div><div class="t m0 x3f h96 y4653 ff19 fs49 fc0 sc0 ls0 ws0">The <span class="_ _47"> </span>program <span class="_ _47"> </span>in <span class="_ _47"> </span>Figur<span class="ls12be">e1<span class="_ _62"></span><span class="ls0">5.35 <span class="_ _47"> </span>shows <span class="_ _45"> </span>an <span class="_ _47"> </span>implementation <span class="_ _47"> </span>of <span class="_ _47"> </span>a <span class="_ _45"> </span>semaphor<span class="_ _0"></span>e-based</span></span></div><div class="t m0 x32 h96 y4654 ff19 fs49 fc0 sc0 ls0 ws0">mutual exclusion primitive.</div><div class="t m0 x32 h98 y4655 ff1a fs4a fc0 sc0 ls0 ws0">#include &quot;slock.h&quot;</div><div class="t m0 x32 h98 y4656 ff1a fs4a fc0 sc0 ls0 ws0">#include &lt;stdlib.h&gt;</div><div class="t m0 x32 h98 y4657 ff1a fs4a fc0 sc0 ls0 ws0">#include &lt;stdio.h&gt;</div><div class="t m0 x32 h98 y4658 ff1a fs4a fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x32 h98 y4659 ff1a fs4a fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h98 y465a ff1a fs4a fc0 sc0 ls0 ws0">struct slock *</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
