<div id="pf2a4" class="pf w4 h1f" data-page-no="2a4"><div class="pc pc2a4 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2a4.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">642<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>IPC<span class="_ _e8"> </span>Chapter <span class="_"> </span>17</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _16"> </span>t<span class="_ _9"></span><span class="ls0">hen <span class="_ _35"> </span>have <span class="_ _35"> </span>to <span class="_ _35"> </span>ﬁll <span class="_ _35"> </span>in <span class="_ _35"> </span>another<span class="_ _51"> </span><span class="ff1a">sockaddr_un<span class="_ _51"> </span></span>structure, <span class="_ _45"> </span>this <span class="_ _35"> </span>time <span class="_ _35"> </span>with <span class="_ _35"> </span>the</span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">well-known <span class="_ _23"></span>pathname <span class="_ _23"> </span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>server<span class="_ _1"></span><span class="ls13bf">.F<span class="_ _7"></span><span class="ls0">inally<span class="_ _6"></span>,<span class="_ _35"> </span>we<span class="_ _35"> </span>call <span class="_ _23"></span>the<span class="_ _35"> </span><span class="ff1a">connect<span class="_ _35"> </span></span>function <span class="_ _23"></span>to <span class="_ _23"></span>initiate</span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">the connection with the server<span class="_ _6"></span>.</div><div class="t m0 x35 h53 y134 ff16 fs2b fc0 sc0 ls0 ws0">17.4 <span class="_ _93"> </span>P<span class="_ _0"></span>assing <span class="_"> </span>File <span class="_"> </span>Descriptor<span class="_ _0"></span>s</div><div class="t m0 x32 h2a y6d4 ff19 fsf fc0 sc0 ls0 ws0">Passing <span class="_ _9"></span>an <span class="_ _9"></span>open <span class="_ _3"></span>ﬁle <span class="_ _9"></span>descriptor <span class="_ _9"></span>between <span class="_ _9"></span>processes <span class="_ _9"></span>is <span class="_ _3"></span>a <span class="_ _9"></span>powerful <span class="_ _9"></span>technique.<span class="_ _5a"> </span>It <span class="_ _9"></span>can <span class="_ _9"></span>lead</div><div class="t m0 x32 h2a y6d5 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _44"> </span>differ<span class="_ _0"></span>ent <span class="_ _44"> </span>ways <span class="_ _4b"> </span>of <span class="_ _44"> </span>designing <span class="_ _44"> </span>client–server <span class="_ _4b"> </span>applications.<span class="_ _93"> </span>It <span class="_ _44"> </span>allows <span class="_ _44"> </span>one <span class="_ _4b"> </span>process</div><div class="t m0 x32 h2a y6d6 ff19 fsf fc0 sc0 ls0 ws0">(typically <span class="_ _e"> </span>a <span class="_"> </span>server) <span class="_ _53"> </span>to <span class="_"> </span>do <span class="_ _e"> </span>everything <span class="_ _e"> </span>that <span class="_"> </span>is <span class="_ _53"> </span>required <span class="_ _e"> </span>to <span class="_ _e"> </span>open <span class="_"> </span>a <span class="_ _53"> </span>ﬁle <span class="_"> </span>(involving <span class="_ _e"> </span>such</div><div class="t m0 x32 h2a y6d7 ff19 fsf fc0 sc0 ls0 ws0">details <span class="_ _e"> </span>as <span class="_ _e"> </span>translating <span class="_ _e"> </span>a <span class="_ _e"> </span>network <span class="_"> </span>name <span class="_ _53"> </span>to <span class="_ _e"> </span>a <span class="_ _e"> </span>network <span class="_"> </span>addr<span class="_ _1"></span>ess, <span class="_"> </span>dialing <span class="_ _53"> </span>a <span class="_ _e"> </span>modem, <span class="_"> </span>and</div><div class="t m0 x32 h2a y6d8 ff19 fsf fc0 sc0 ls0 ws0">negotiating <span class="_ _23"></span>locks <span class="_ _9"></span>for <span class="_ _23"> </span>the <span class="_ _23"></span>ﬁle) <span class="_ _23"></span>and <span class="_ _23"></span>simply <span class="_ _9"></span>pass <span class="_ _23"> </span>back <span class="_ _23"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>calling <span class="_ _23"> </span>process <span class="_ _23"></span>a <span class="_ _9"></span>descriptor</div><div class="t m0 x32 h2a y6d9 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _3"></span>can <span class="_ _3"></span>be <span class="_ _3"></span>used <span class="_ _3"></span>with <span class="_ _3"></span>all <span class="_ _3"></span>the <span class="_ _3"></span>I/O <span class="_ _3"></span>functions.<span class="_ _16"> </span>All <span class="_ _3"></span>the <span class="_ _3"></span>details <span class="_ _3"></span>involved <span class="_ _3"></span>in <span class="_ _3"></span>opening <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle</div><div class="t m0 x32 h2a y6da ff19 fsf fc0 sc0 ls0 ws0">or device ar<span class="ls44">eh<span class="_ _4f"></span><span class="ls0">idden from the client.</span></span></div><div class="t m0 x3f h2a y6db ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>m<span class="_ _9"></span><span class="ls0">ust <span class="_ _2"></span>be mor<span class="ls1292">es<span class="_ _d"></span><span class="ls0">peciﬁc about <span class="_ _2"></span>what we mean <span class="_ _2"></span>by ‘‘passing an open ﬁle <span class="_ _2"></span>descriptor<span class="_ _9"></span><span class="ls124">’’</span></span></span></span></div><div class="t m0 x32 h2a y6dc ff19 fsf fc0 sc0 ls0 ws0">from <span class="_ _3"></span>one <span class="_ _9"></span>process <span class="_ _3"></span>to <span class="_ _9"></span>another<span class="_ _6"></span><span class="ls13c0">.R<span class="_ _62"></span><span class="ls0">ecall <span class="_ _9"></span>Figur<span class="lsf65">e3<span class="_ _b"></span><span class="ls0">.8, <span class="_ _9"></span>which <span class="_ _3"></span>showed <span class="_ _9"></span>two <span class="_ _9"></span>processes <span class="_ _3"></span>that <span class="_ _9"></span>have</span></span></span></span></div><div class="t m0 x32 h2a y6dd ff19 fsf fc0 sc0 ls0 ws0">opened <span class="_ _9"></span>the <span class="_ _9"></span>same <span class="_ _9"></span>ﬁle.<span class="_ _5a"> </span>Although <span class="_ _9"></span>they <span class="_ _9"></span>shar<span class="ls248">et<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>same <span class="_ _9"></span>v-node, <span class="_ _9"></span>each <span class="_ _9"></span>process <span class="_ _9"></span>has <span class="_ _9"></span>its <span class="_ _9"></span>own</span></span></div><div class="t m0 x32 h2a y6de ff19 fsf fc0 sc0 ls0 ws0">ﬁle table entry<span class="_ _4"></span>.</div><div class="t m0 x3f h2a y10cf ff19 fsf fc0 sc0 ls0 ws0">When <span class="_ _42"> </span>we <span class="_ _42"> </span>pass <span class="_ _42"> </span>an <span class="_ _42"> </span>open <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>descriptor <span class="_ _42"> </span>from <span class="_ _42"> </span>one <span class="_ _42"> </span>pr<span class="_ _0"></span>ocess <span class="_ _42"> </span>to <span class="_ _42"> </span>another<span class="_ _1"></span>,<span class="_ _35"> </span>we<span class="_ _44"> </span>want <span class="_ _42"> </span>the</div><div class="t m0 x32 h2a y10d0 ff19 fsf fc0 sc0 ls0 ws0">passing process and the <span class="_ _2"></span>receiving process to shar<span class="ls13c1">et<span class="_ _4f"></span><span class="ls0">he same <span class="_ _2"></span>ﬁle table <span class="_ _2"></span>entry<span class="_ _4"></span><span class="ls13c2">.F<span class="_ _4a"></span><span class="ls0">igur<span class="ls1f7">e1<span class="_ _4f"></span><span class="ls0">7.1<span class="_ _1"></span>1</span></span></span></span></span></span></div><div class="t m0 x32 h2a y4668 ff19 fsf fc0 sc0 ls0 ws0">shows the desired arrangement.</div><div class="t m0 x3f h2a y4669 ff19 fsf fc0 sc0 ls5f ws0">Te<span class="_ _9"></span><span class="ls0">chnically<span class="_ _4"></span>,<span class="_ _47"> </span>we<span class="_ _47"> </span>a<span class="ls45">re <span class="_ _9"></span>p</span>assing <span class="_ _3"></span>a <span class="_ _3"></span>pointer <span class="_ _2"></span>to <span class="_ _3"></span>an <span class="_ _2"></span>open <span class="_ _3"></span>ﬁle <span class="_ _3"></span>table <span class="_ _2"></span>entry <span class="_ _3"></span>from one <span class="_ _3"></span>process <span class="_ _2"></span>to</span></div><div class="t m0 x32 h2a y6df ff19 fsf fc0 sc0 ls0 ws0">another<span class="_ _6"></span><span class="ls5c4">.T<span class="_ _62"></span><span class="ls0">his <span class="_ _9"></span>pointer <span class="_ _9"></span>is <span class="_ _9"></span>assigned <span class="_ _9"></span>the <span class="_ _9"></span>ﬁrst <span class="_ _9"></span>available <span class="_ _9"></span>descriptor <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>receiving <span class="_ _3"></span>process.</span></span></div><div class="t m0 x32 h2a y6e0 ff19 fsf fc0 sc0 ls0 ws0">(Saying that <span class="_ _2"></span>we ar<span class="lsb68">ep<span class="_ _4f"></span><span class="ls0">assing <span class="_ _2"></span>an <span class="_ _2"></span>open descriptor <span class="_ _2"></span>mistakenly gives <span class="_ _2"></span>the <span class="_ _2"></span>impression that the</span></span></div><div class="t m0 x32 h2a y6e1 ff19 fsf fc0 sc0 ls0 ws0">descriptor <span class="_ _2"></span>number <span class="_ _2"></span>in <span class="_ _3"></span>the <span class="_ _2"></span>receiving <span class="_ _2"></span>process is <span class="_ _3"></span>the <span class="_ _2"></span>same <span class="_ _2"></span>as <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _2"></span>sending <span class="_ _3"></span>process, <span class="_ _2"></span>which</div><div class="t m0 x32 h2a y6e2 ff19 fsf fc0 sc0 ls0 ws0">usually <span class="_"> </span>isn’t <span class="_ _66"> </span>true.) <span class="_ _46"> </span>Having<span class="_ _61"> </span>two <span class="_ _66"> </span>processes <span class="_"> </span>share<span class="_ _46"> </span>an<span class="_ _46"> </span>open <span class="_ _66"> </span>ﬁle <span class="_ _47"> </span>table <span class="_"> </span>is <span class="_ _66"> </span>exactly <span class="_ _66"> </span>what</div><div class="t m0 x32 h26 y6e3 ff19 fsf fc0 sc0 ls0 ws0">happens after a<span class="_"> </span><span class="ff1a">fork<span class="_ _80"> </span></span>(recall Figur<span class="ls44">e8<span class="_ _4f"></span><span class="ls0">.2).</span></span></div><div class="t m0 x3f h2a y6e4 ff19 fsf fc0 sc0 ls0 ws0">What <span class="_ _2"></span>normally <span class="_ _2"></span>happens <span class="_ _2"></span>when <span class="_ _3"></span>a <span class="_ _2"></span>descriptor <span class="_ _2"></span>is <span class="_ _3"></span>passed <span class="_ _2"></span>from <span class="_ _2"></span>one <span class="_ _2"></span>process <span class="_ _2"></span>to <span class="_ _2"></span>another <span class="_ _2"></span>is</div><div class="t m0 x32 h2a y466a ff19 fsf fc0 sc0 ls0 ws0">that the sending process, after passing the descriptor<span class="_ _6"></span><span class="ls13c3">,t<span class="_ _d"></span><span class="ls0">hen closes <span class="_ _2"></span>the descriptor<span class="_ _6"></span><span class="ls12c4">.C<span class="_ _4a"></span><span class="ls0">losing</span></span></span></span></div><div class="t m0 x32 h2a y466b ff19 fsf fc0 sc0 ls0 ws0">the descriptor <span class="_ _2"></span>by <span class="_ _2"></span>the <span class="_ _2"></span>sender doesn’t <span class="_ _2"></span>really close <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>or device, <span class="_ _2"></span>since <span class="_ _2"></span>the <span class="_ _2"></span>descriptor is</div><div class="t m0 x32 h2a y466c ff19 fsf fc0 sc0 ls0 ws0">still <span class="_ _42"> </span>considered <span class="_ _23"> </span>open <span class="_ _53"> </span>by <span class="_ _42"> </span>the <span class="_ _42"> </span>receiving <span class="_ _42"> </span>process <span class="_ _23"> </span>(even <span class="_ _42"> </span>if <span class="_ _42"> </span>the <span class="_ _53"> </span>receiver <span class="_ _23"> </span>hasn’t <span class="_ _42"> </span>speciﬁcally</div><div class="t m0 x32 h2a y466e ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ceived the descriptor yet).</span></div><div class="t m0 x3f h2a y6a7 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _45"> </span>d<span class="_ _23"></span><span class="ls0">eﬁne <span class="_ _42"> </span>the <span class="_ _53"> </span>following <span class="_ _53"> </span>three <span class="_ _42"> </span>functions <span class="_ _53"> </span>that <span class="_ _53"> </span>we <span class="_ _53"> </span>use <span class="_ _53"> </span>in <span class="_ _53"> </span>this <span class="_ _53"> </span>chapter <span class="_ _53"> </span>to <span class="_ _53"> </span>send <span class="_ _42"> </span>and</span></div><div class="t m0 x32 h2a y466f ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ceive <span class="_ _47"> </span>ﬁle <span class="_ _47"> </span>descriptors.<span class="_ _5f"> </span>Later <span class="_ _47"> </span>in <span class="_ _47"> </span>this <span class="_ _66"> </span>section, <span class="_ _47"> </span>we’ll <span class="_ _47"> </span>show <span class="_ _47"> </span>the <span class="_ _47"> </span>code <span class="_ _47"> </span>for <span class="_ _47"> </span>these <span class="_ _47"> </span>three</span></div><div class="t m0 x32 h2a y4670 ff19 fsf fc0 sc0 ls0 ws0">functions.</div><div class="t m0 x3f h57 y4c01 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x3f h57 y4c02 ff1a fs2d fc0 sc0 ls0 ws0">int send_fd(int<span class="_"> </span><span class="ff1b">fd</span><span class="ls15c">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">fd_to_send</span>);</span></span></div><div class="t m0 x3f h57 y4c03 ff1a fs2d fc0 sc0 ls0 ws0">int send_err(int<span class="_"> </span><span class="ff1b">fd</span><span class="ls15c">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">status</span><span class="ls15c">,c<span class="_ _5b"></span><span class="ls0">onst char *<span class="ff1b">errmsg</span>);</span></span></span></span></div><div class="t m0 x1af h5f y4c04 ff19 fs2d fc0 sc0 ls0 ws0">Both return: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x3f h57 y4c05 ff1a fs2d fc0 sc0 ls0 ws0">int recv_fd(int<span class="_"> </span><span class="ff1b">fd</span><span class="ls15c">,s<span class="_ _1d"></span><span class="ls0">size_t (*<span class="ff1b">userfunc</span>)(int, const void *, size_t));</span></span></div><div class="t m0 x16 h5f y4c06 ff19 fs2d fc0 sc0 ls0 ws0">Returns: ﬁle descriptor if OK, negative value on error</div><a class="l" href="#pf12" data-dest-detail='[18,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1110.288916px;width:182.184807px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
