<div id="pf178" class="pf w4 h1f" data-page-no="178"><div class="pc pc178 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg178.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">342<span class="_ _1b"> </span><span class="ff19">Signals <span class="_ _24b"> </span>Chapter<span class="_ _21"> </span>10</span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 lsc85 ws0">Ac<span class="_ _4f"></span><span class="ls0">ommon <span class="_ _2"></span>use <span class="_ _2"></span>for<span class="_"> </span><span class="ff1a">alarm</span><span class="lsc85">,i<span class="_ _d"></span><span class="ls244">na<span class="_ _d"></span><span class="ls0">ddition to <span class="_ _2"></span>implementing <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">sleep<span class="_ _47"> </span></span>function, is <span class="_ _2"></span>to put <span class="_ _2"></span>an</span></span></span></span></div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">upper <span class="_ _47"> </span>time <span class="_ _47"> </span>limit <span class="_ _45"> </span>on <span class="_ _47"> </span>operations <span class="_ _47"> </span>that <span class="_ _47"> </span>can <span class="_ _45"> </span>block.<span class="_ _50"> </span>For <span class="_ _45"> </span>example, <span class="_ _47"> </span>if <span class="_ _47"> </span>we <span class="_ _47"> </span>have <span class="_ _45"> </span>a<span class="_ _61"> </span><span class="ff1a">read</span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">operation <span class="_ _3"></span>on <span class="_ _3"></span>a <span class="_ _3"></span>device <span class="_ _3"></span>that <span class="_ _3"></span>can <span class="_ _3"></span>block <span class="_ _3"></span>(a <span class="_ _3"></span>‘‘slow’<span class="_ _1"></span><span class="ls287">’d<span class="_ _8"></span><span class="ls0">evice, <span class="_ _3"></span>as <span class="_ _3"></span>described <span class="_ _3"></span>in <span class="_ _3"></span>Section <span class="_ _9"></span>10.5), <span class="_ _2"></span>we</span></span></div><div class="t m0 x32 h26 y134 ff19 fsf fc0 sc0 ls0 ws0">might <span class="_ _45"> </span>want <span class="_ _35"> </span>the<span class="_ _5a"> </span><span class="ff1a">read<span class="_"> </span></span>to <span class="_ _45"> </span>time <span class="_ _35"> </span>out <span class="_ _45"> </span>after <span class="_ _45"> </span>some <span class="_ _35"> </span>amount <span class="_ _45"> </span>of <span class="_ _45"> </span>time.<span class="_ _5c"> </span>The <span class="_ _45"> </span>program <span class="_ _45"> </span>in</div><div class="t m0 x32 h2a y135 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="lsc86">e1<span class="_ _b"></span><span class="ls0">0.10 <span class="_ _3"></span>does <span class="_ _9"></span>this, <span class="_ _3"></span>reading <span class="_ _3"></span>one <span class="_ _9"></span>line <span class="_ _3"></span>from <span class="_ _3"></span>standar<span class="lsc86">di<span class="_ _b"></span><span class="ls0">nput <span class="_ _9"></span>and <span class="_ _3"></span>writing <span class="_ _9"></span>it <span class="_ _3"></span>to <span class="_ _9"></span>standard</span></span></span></span></div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">output.</div><div class="t m0 x32 h4e y2bb8 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y2bb9 ff1a fs28 fc0 sc0 ls0 ws0">static void sig_alrm(int);</div><div class="t m0 x32 h4e y2bba ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y2bbb ff1a fs28 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h4e y2bbc ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y2bbd ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>n;</div><div class="t m0 x8a h4e y2bbe ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>line[MAXLINE];</div><div class="t m0 x8a h4e y2bbf ff1a fs28 fc0 sc0 ls0 ws0">if (signal(SIGALRM, sig_alrm) == SIG_ERR)</div><div class="t m0 x9d h4e y2bc0 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;signal(SIGALRM) error&quot;);</div><div class="t m0 x8a h4e y2bc1 ff1a fs28 fc0 sc0 ls0 ws0">alarm(10);</div><div class="t m0 x8a h4e y2bc2 ff1a fs28 fc0 sc0 ls0 ws0">if ((n = read(STDIN_FILENO, line, MAXLINE)) &lt; 0)</div><div class="t m0 x9d h4e y2bc3 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;read error&quot;);</div><div class="t m0 x8a h4e y2bc4 ff1a fs28 fc0 sc0 ls0 ws0">alarm(0);</div><div class="t m0 x8a h4e y2bc5 ff1a fs28 fc0 sc0 ls0 ws0">write(STDOUT_FILENO, line, n);</div><div class="t m0 x8a h4e y2bc6 ff1a fs28 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h4e y2bc7 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h4e y2bc8 ff1a fs28 fc0 sc0 ls0 ws0">static void</div><div class="t m0 x32 h4e y2bc9 ff1a fs28 fc0 sc0 ls0 ws0">sig_alrm(int signo)</div><div class="t m0 x32 h4e y2bca ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y2bcb ff1a fs28 fc0 sc0 ls0 ws0">/* nothing to do, just return to interrupt the read */</div><div class="t m0 x32 h4e y2bcc ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 xf3 h4f y2bcd ff18 fs11 fc0 sc0 ls0 ws0">Figure 10.10<span class="_ _5a"> </span><span class="ff19">Calling<span class="_"> </span><span class="ff1a">read<span class="_ _e"> </span></span>with a timeout</span></div><div class="t m0 x32 h55 y2bce ff19 fs2c fc0 sc0 ls0 ws0">This <span class="_"> </span>sequence <span class="_ _53"> </span>of <span class="_"> </span>code <span class="_ _e"> </span>is <span class="_"> </span>common <span class="_ _e"> </span>in <span class="_"> </span>UNIX <span class="_ _e"> </span>applications, <span class="_"> </span>but <span class="_ _53"> </span>this <span class="_"> </span>program <span class="_ _53"> </span>has <span class="_"> </span>two</div><div class="t m0 x32 h55 y2bcf ff19 fs2c fc0 sc0 ls0 ws0">problems.</div><div class="t m0 x3f h55 y2bd0 ff19 fs2c fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>The<span class="_ _44"> </span>program <span class="_ _42"> </span>in <span class="_ _42"> </span>Figur<span class="lsc87">e1<span class="_ _c"></span><span class="ls0">0.10 <span class="_ _42"> </span>has <span class="_ _53"> </span>one <span class="_ _42"> </span>of <span class="_ _53"> </span>the <span class="_ _42"> </span>same <span class="_ _53"> </span>ﬂaws <span class="_ _42"> </span>that <span class="_ _42"> </span>we <span class="_ _53"> </span>described <span class="_ _42"> </span>in</span></span></div><div class="t m0 x41 h54 y2bd1 ff19 fs2c fc0 sc0 ls0 ws0">Figur<span class="lsc88">e1<span class="_ _4f"></span><span class="ls0">0.7: a race condition between <span class="_ _2"></span>the ﬁrst call to<span class="_"> </span><span class="ff1a">alarm<span class="_ _80"> </span></span>and the call to<span class="_ _66"> </span><span class="ff1a">read</span>.</span></span></div><div class="t m0 x41 h55 y2bd2 ff19 fs2c fc0 sc0 ls0 ws0">If <span class="_ _2"></span>the <span class="_ _2"></span>kernel <span class="_ _3"></span>blocks <span class="_ _2"></span>the <span class="_ _3"></span>process between <span class="_ _3"></span>these <span class="_ _2"></span>two <span class="_ _2"></span>function <span class="_ _3"></span>calls <span class="_ _2"></span>for <span class="_ _3"></span>longer <span class="_ _2"></span>than</div><div class="t m0 x41 h54 y2bd3 ff19 fs2c fc0 sc0 ls0 ws0">the alarm period, the<span class="_"> </span><span class="ff1a">read<span class="_ _80"> </span></span>could block forever<span class="_ _6"></span><span class="lsc89">.M<span class="_ _4a"></span><span class="ls0">ost operations of this type use</span></span></div><div class="t m0 x41 h55 y2bd4 ff19 fs2c fc0 sc0 lsc8a ws0">al<span class="_ _64"></span><span class="ls0">ong <span class="_ _4b"> </span>alarm <span class="_ _4b"> </span>period, <span class="_ _4b"> </span>such <span class="_ _4b"> </span>as <span class="_ _4b"> </span>a <span class="_ _4b"> </span>minute <span class="_ _4b"> </span>or <span class="_ _4b"> </span>more, <span class="_ _44"> </span>making <span class="_ _4b"> </span>this <span class="_ _4b"> </span>unlikely;</span></div><div class="t m0 x41 h55 y2bd5 ff19 fs2c fc0 sc0 ls0 ws0">nevertheless, it is a race condition.</div><div class="t m0 x3f h54 y2bd6 ff19 fs2c fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>If<span class="_ _66"> </span>system <span class="_ _3"></span>calls <span class="_ _2"></span>ar<span class="lsc8b">ea<span class="_ _8"></span><span class="ls0">utomatically <span class="_ _2"></span>restarted, <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">read<span class="_ _66"> </span></span>is <span class="_ _2"></span>not <span class="_ _2"></span>interrupted <span class="_ _2"></span>when <span class="_ _2"></span>the</span></span></div><div class="t m0 x41 h54 y2bd7 ff1a fs2c fc0 sc0 ls0 ws0">SIGALRM<span class="_ _80"> </span><span class="ff19">signal handler returns. <span class="_"> </span>In<span class="_"> </span>this case, the timeout does nothing.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
