<div id="pf34f" class="pf w4 h1f" data-page-no="34f"><div class="pc pc34f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg34f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">813</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">38 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">39 <span class="_ _68"> </span>*<span class="_"> </span>Needed for logging.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">40 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">41 <span class="_ _d9"> </span>int<span class="_ _296"> </span>log_to_stderr = 0;</div><div class="t m0 x32 h57 y3c3 ff1a fs2d fc0 sc0 ls0 ws0">42 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c4 ff1a fs2d fc0 sc0 ls0 ws0">43 <span class="_ _68"> </span>*<span class="_"> </span>Printer-related stuff.</div><div class="t m0 x32 h57 y3c5 ff1a fs2d fc0 sc0 ls0 ws0">44 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y3c6 ff1a fs2d fc0 sc0 ls0 ws0">45 <span class="_ _d9"> </span>struct<span class="_"> </span>addrinfo <span class="_ _90"> </span>*printer;</div><div class="t m0 x32 h57 y1d7c ff1a fs2d fc0 sc0 ls0 ws0">46 <span class="_ _d9"> </span>char<span class="_ _31c"> </span>*printer_name;</div><div class="t m0 x32 h57 y1d7d ff1a fs2d fc0 sc0 ls0 ws0">47 <span class="_ _d9"> </span>pthread_mutex_t<span class="_ _186"> </span>configlock = PTHREAD_MUTEX_INITIALIZER;</div><div class="t m0 x32 h57 y1d7e ff1a fs2d fc0 sc0 ls0 ws0">48 <span class="_ _d9"> </span>int<span class="_ _296"> </span>reread;</div><div class="t m0 x32 h57 y3ca ff1a fs2d fc0 sc0 ls0 ws0">49 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y1cc6 ff1a fs2d fc0 sc0 ls0 ws0">50 <span class="_ _68"> </span>*<span class="_"> </span>Thread-related stuff.</div><div class="t m0 x32 h57 y1cc7 ff1a fs2d fc0 sc0 ls0 ws0">51 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y1cc8 ff1a fs2d fc0 sc0 ls0 ws0">52 <span class="_ _d9"> </span>struct<span class="_"> </span>worker_thread <span class="_ _3a"> </span>*workers;</div><div class="t m0 x32 h57 y4588 ff1a fs2d fc0 sc0 ls0 ws0">53 <span class="_ _d9"> </span>pthread_mutex_t<span class="_ _186"> </span>workerlock = PTHREAD_MUTEX_INITIALIZER;</div><div class="t m0 x32 h57 y4589 ff1a fs2d fc0 sc0 ls0 ws0">54 <span class="_ _d9"> </span>sigset_t<span class="_ _227"> </span>mask;</div><div class="t m0 x32 h57 y3d0 ff1a fs2d fc0 sc0 ls0 ws0">55 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3d1 ff1a fs2d fc0 sc0 ls0 ws0">56 <span class="_ _68"> </span>*<span class="_"> </span>Job-related stuff.</div><div class="t m0 x32 h57 y1cca ff1a fs2d fc0 sc0 ls0 ws0">57 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y1ccb ff1a fs2d fc0 sc0 ls0 ws0">58 <span class="_ _d9"> </span>struct<span class="_"> </span>job <span class="_ _2b3"> </span>*jobhead,<span class="_"> </span>*jobtail;</div><div class="t m0 x32 h57 y2315 ff1a fs2d fc0 sc0 ls0 ws0">59 <span class="_ _d9"> </span>int<span class="_ _296"> </span>jobfd;</div><div class="t m0 x32 h4d y5b6c ff19 fs26 fc0 sc0 ls0 ws0">[38 <span class="_ _a"></span>– <span class="_ _a"></span>41]<span class="_ _65"> </span>Our <span class="_ _53"> </span>logging <span class="_ _53"> </span>functions <span class="_ _e"> </span>requir<span class="_ _0"></span><span class="lsc9d">et<span class="_ _55"></span><span class="ls0">hat <span class="_ _e"> </span>we <span class="_ _53"> </span>deﬁne <span class="_ _e"> </span>the<span class="_ _4b"> </span><span class="ff1a">log_to_stderr<span class="_ _4b"> </span></span>variable</span></span></div><div class="t m0 x2d h49 y5b6d ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _9"></span>set <span class="_ _9"></span>it <span class="_ _9"></span>to <span class="_ _9"></span>0 <span class="_ _9"></span>to <span class="_ _9"></span>force <span class="_ _9"></span>log <span class="_ _9"></span>messages <span class="_ _9"></span>to <span class="_ _9"></span>be <span class="_ _9"></span>sent <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>system <span class="_ _9"></span>log <span class="_ _9"></span>instead <span class="_ _9"></span>of <span class="_ _9"></span>to</div><div class="t m0 x2d h4d y5b6e ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>standar<span class="ls176e">de<span class="_ _b"></span><span class="ls0">rr<span class="_ _0"></span>or<span class="_ _6"></span><span class="ls176f">.I<span class="_ _62"></span><span class="ls0">n<span class="_ _45"> </span><span class="ff1a">print.c</span>,<span class="_ _45"> </span>we<span class="_ _45"> </span>deﬁned<span class="_ _45"> </span><span class="ff1a">log_to_stderr<span class="_ _45"> </span></span>and <span class="_ _9"></span>set <span class="_ _9"></span>it <span class="_ _9"></span>to <span class="_ _9"></span>1,</span></span></span></span></div><div class="t m0 x2d h49 y5b6f ff19 fs26 fc0 sc0 ls0 ws0">even <span class="_ _9"></span>though <span class="_ _23"> </span>we <span class="_ _23"></span>don’t <span class="_ _9"></span>use <span class="_ _23"></span>the <span class="_ _23"></span>log <span class="_ _9"></span>functions <span class="_ _23"></span>in <span class="_ _9"></span>the <span class="_ _23"> </span>user <span class="_ _23"></span>command.<span class="_ _5a"> </span><span class="ls164">We <span class="_ _47"> </span>c<span class="_ _9"></span></span>ould</div><div class="t m0 x2d h49 y5b70 ff19 fs26 fc0 sc0 ls0 ws0">have <span class="_ _3"></span>avoided <span class="_ _9"></span>this <span class="_ _3"></span>by <span class="_ _9"></span>splitting <span class="_ _3"></span>the <span class="_ _9"></span>utility <span class="_ _9"></span>functions <span class="_ _3"></span>into <span class="_ _9"></span>two <span class="_ _3"></span>separate <span class="_ _9"></span>ﬁles: <span class="_ _3"></span>one</div><div class="t m0 x2d h49 y5b71 ff19 fs26 fc0 sc0 ls0 ws0">for the server and one for the client commands.</div><div class="t m0 x32 h4d y5b72 ff19 fs26 fc0 sc0 ls0 ws0">[42 <span class="_ _a"></span>– <span class="_ _a"></span>48]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>u<span class="_ _9"></span></span>se the global variable<span class="_"> </span><span class="ff1a">printer<span class="_ _66"> </span></span>to hold the network address of the printer<span class="_ _6"></span>.</div><div class="t m0 x2d h4d y5b73 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _47"> </span>s<span class="_ _9"></span><span class="ls0">tor<span class="ls1770">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>host <span class="_ _42"> </span>name <span class="_ _23"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>printer <span class="_ _23"></span>in<span class="_ _35"> </span><span class="ff1a">printer_name</span><span class="ls1771">.T<span class="_ _7"></span><span class="ls0">he<span class="_ _35"> </span><span class="ff1a">configlock</span></span></span></span></span></span></div><div class="t m0 x2d h4d y5b74 ff19 fs26 fc0 sc0 ls0 ws0">mutex <span class="_ _23"> </span>protects <span class="_ _23"></span>access <span class="_ _23"> </span>to <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">reread<span class="_ _35"> </span></span>variable, <span class="_ _23"> </span>which <span class="_ _23"> </span>is <span class="_ _42"> </span>used <span class="_ _23"> </span>to <span class="_ _23"> </span>indicate <span class="_ _42"> </span>that</div><div class="t m0 x2d h49 y5b75 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_"> </span>daemon <span class="_"> </span>needs <span class="_"> </span>to <span class="_ _e"> </span>reread <span class="_ _e"> </span>the <span class="_"> </span>conﬁguration <span class="_"> </span>ﬁle, <span class="_"> </span>pr<span class="_ _0"></span>esumably <span class="_"> </span>because <span class="_"> </span>an</div><div class="t m0 x2d h49 y5b76 ff19 fs26 fc0 sc0 ls0 ws0">administrator changed the printer or its network address.</div><div class="t m0 x32 h4d y5b77 ff19 fs26 fc0 sc0 ls0 ws0">[49 <span class="_ _a"></span>– <span class="_ _a"></span>54]<span class="_ _65"> </span>Next, we <span class="_ _2"></span>deﬁne the <span class="_ _2"></span>thread-r<span class="_ _0"></span>elated variables.<span class="_ _46"> </span><span class="ls164">We <span class="_ _e"> </span>u<span class="_ _9"></span></span>se<span class="_ _66"> </span><span class="ff1a">workers<span class="_ _66"> </span></span>as the <span class="_ _2"></span>head of <span class="_ _2"></span>a</div><div class="t m0 x2d h49 y5b78 ff19 fs26 fc0 sc0 ls0 ws0">doubly <span class="_ _42"> </span>linked <span class="_ _23"> </span>list <span class="_ _42"> </span>of <span class="_ _42"> </span>threads <span class="_ _23"></span>that <span class="_ _42"> </span>ar<span class="ls1772">er<span class="_ _c"></span><span class="ls0">eceiving <span class="_ _42"> </span>ﬁles <span class="_ _23"> </span>from <span class="_ _23"> </span>clients.<span class="_ _54"> </span>This <span class="_ _42"> </span>list <span class="_ _23"> </span>is</span></span></div><div class="t m0 x2d h4d y5b79 ff19 fs26 fc0 sc0 ls0 ws0">protected <span class="_ _2"></span>by <span class="_ _3"></span>the <span class="_ _3"></span>mutex<span class="_ _45"> </span><span class="ff1a">workerlock</span><span class="ls1773">.T<span class="_ _62"></span><span class="ls0">he <span class="_ _3"></span>signal <span class="_ _9"></span>mask <span class="_ _3"></span>used <span class="_ _3"></span>by <span class="_ _3"></span>the <span class="_ _3"></span>threads <span class="_ _3"></span>is</span></span></div><div class="t m0 x2d h4d y5b7a ff19 fs26 fc0 sc0 ls0 ws0">held in the variable<span class="_"> </span><span class="ff1a">mask</span>.</div><div class="t m0 x32 h4d y5b7b ff19 fs26 fc0 sc0 ls0 ws0">[55 <span class="_ _a"></span>– <span class="_ _a"></span>59]<span class="_ _65"> </span>For <span class="_ _9"></span>the <span class="_ _9"></span>list <span class="_ _9"></span>of <span class="_ _9"></span>pending <span class="_ _9"></span>jobs, <span class="_ _9"></span>we <span class="_ _9"></span>deﬁne<span class="_ _45"> </span><span class="ff1a">jobhead<span class="_ _45"> </span></span>to <span class="_ _9"></span>be <span class="_ _9"></span>the <span class="_ _9"></span>start <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>list <span class="_ _9"></span>and</div><div class="t m0 x2d h4d y5b7c ff1a fs26 fc0 sc0 ls0 ws0">jobtail<span class="_ _47"> </span><span class="ff19">to <span class="_ _9"></span>be <span class="_ _3"></span>the <span class="_ _9"></span>tail <span class="_ _9"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>list.<span class="_ _16"> </span>This <span class="_ _9"></span>list <span class="_ _3"></span>is <span class="_ _9"></span>also <span class="_ _3"></span>doubly <span class="_ _9"></span>linked, <span class="_ _9"></span>but <span class="_ _3"></span>we <span class="_ _9"></span>need</span></div><div class="t m0 x2d h49 y5b7d ff19 fs26 fc0 sc0 ls0 ws0">to add <span class="_ _2"></span>jobs <span class="_ _2"></span>to <span class="_ _2"></span>the end <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>list, so <span class="_ _2"></span>we <span class="_ _2"></span>must <span class="_ _2"></span>remember a pointer <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>list tail.</div><div class="t m0 x2d h49 y5b7e ff19 fs26 fc0 sc0 ls3aa ws0">Wi<span class="_ _3"></span><span class="ls0">th <span class="_ _9"></span>the <span class="_ _3"></span>list <span class="_ _9"></span>of <span class="_ _9"></span>worker <span class="_ _9"></span>threads, <span class="_ _3"></span>the <span class="_ _9"></span>order <span class="_ _3"></span>doesn’t <span class="_ _9"></span>matter<span class="_ _6"></span>,<span class="_ _45"> </span>so<span class="_ _45"> </span>we<span class="_ _47"> </span>can <span class="_ _9"></span>add <span class="_ _9"></span>them</span></div><div class="t m0 x2d h4d y5b7f ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _9"></span>the <span class="_ _23"></span>head <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _23"></span>list <span class="_ _9"></span>and <span class="_ _23"></span>don’t <span class="_ _9"></span>need <span class="_ _9"></span>to <span class="_ _23"></span>remember <span class="_ _9"></span>the <span class="_ _9"></span>tail <span class="_ _23"></span>pointer<span class="_ _6"></span>.<span class="_ _5a"> </span><span class="ff1a">jobfd<span class="_ _35"> </span></span>is</div><div class="t m0 x2d h49 y5b80 ff19 fs26 fc0 sc0 ls0 ws0">the ﬁle descriptor for the job ﬁle.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
