<div id="pf6c" class="pf w4 h1f" data-page-no="6c"><div class="pc pc6c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg6c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">74<span class="_ _1b"> </span><span class="ff19">File <span class="_"> </span>I/O<span class="_ _169"> </span>Chapter <span class="_"> </span>3</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls5f ws0">We<span class="_ _9"></span><span class="ls0">’ll <span class="_ _23"></span>return <span class="_ _9"></span>to <span class="_ _23"></span>this <span class="_ _23"></span>timing <span class="_ _9"></span>example <span class="_ _23"> </span>later <span class="_ _23"></span>in <span class="_ _23"></span>the <span class="_ _9"></span>text.<span class="_ _51"> </span>In <span class="_ _23"></span>Section <span class="_ _23"></span>3.14, <span class="_ _9"></span>we <span class="_ _23"> </span>show <span class="_ _23"></span>the</span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">effect <span class="_ _42"> </span>of <span class="_ _42"> </span>synchronous <span class="_ _42"> </span>writes; <span class="_ _42"> </span>in <span class="_ _53"> </span>Section <span class="_ _42"> </span>5.8, <span class="_ _53"> </span>we <span class="_ _42"> </span>compar<span class="ls3bb">et<span class="_ _c"></span><span class="ls0">hese <span class="_ _53"> </span>unbuffer<span class="_ _0"></span>ed <span class="_ _42"> </span>I/O <span class="_ _53"> </span>times</span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">with the standar<span class="ls44">dI<span class="_ _4f"></span><span class="ls0">/O library<span class="_ _6"></span>.</span></span></div><div class="t m0 x76 h51 yba0 ff19 fs2a fc0 sc0 ls0 ws0">Bewar<span class="ls3bc">ew<span class="_ _8"></span><span class="ls0">hen <span class="_ _9"></span>trying <span class="_ _9"> </span>to <span class="_ _9"> </span>measur<span class="ls3bd">et<span class="_ _4f"></span><span class="ls0">he <span class="_ _9"></span>performance <span class="_ _9"></span>of <span class="_ _9"> </span>programs <span class="_ _9"></span>that <span class="_ _9"></span>read <span class="_ _9"></span>and <span class="_ _9"></span>write <span class="_ _9"></span>ﬁles.<span class="_ _59"> </span>The</span></span></span></span></div><div class="t m0 x76 h51 yba1 ff19 fs2a fc0 sc0 ls0 ws0">operating <span class="_ _23"> </span>system <span class="_ _9"> </span>will <span class="_ _23"> </span>try <span class="_ _23"> </span>to <span class="_ _23"> </span>cache <span class="_ _23"> </span>the <span class="_ _9"> </span>ﬁle <span class="_ _23"> </span>incore, <span class="_ _23"> </span>so <span class="_ _9"> </span>if <span class="_ _23"> </span>you <span class="_ _23"> </span>measur<span class="ls3be">et<span class="_ _8"></span><span class="ls0">he <span class="_ _23"> </span>performance <span class="_ _9"> </span>of <span class="_ _23"> </span>the</span></span></div><div class="t m0 x76 h51 yba2 ff19 fs2a fc0 sc0 ls0 ws0">program <span class="_ _45"> </span>repeatedly<span class="_ _6"></span><span class="ls3bf">,t<span class="_ _62"></span><span class="ls0">he <span class="_ _35"> </span>successive <span class="_ _35"> </span>timings <span class="_ _35"> </span>will <span class="_ _35"> </span>likely <span class="_ _35"> </span>be <span class="_ _35"> </span>better <span class="_ _35"> </span>than <span class="_ _35"> </span>the <span class="_ _35"> </span>ﬁrst.<span class="_ _50"> </span>This</span></span></div><div class="t m0 x76 h51 yba3 ff19 fs2a fc0 sc0 ls0 ws0">improvement occurs <span class="_ _3"></span>because <span class="_ _2"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _2"></span>run <span class="_ _2"></span>causes <span class="_ _3"></span>the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>to <span class="_ _3"></span>be <span class="_ _2"></span>entered <span class="_ _2"></span>into <span class="_ _2"></span>the <span class="_ _3"></span>system’s <span class="_ _2"></span>cache,</div><div class="t m0 x76 h51 yba4 ff19 fs2a fc0 sc0 ls0 ws0">and successive <span class="_ _2"></span>runs <span class="_ _2"></span>access the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>from the <span class="_ _2"></span>system’s <span class="_ _2"></span>cache instead <span class="_ _2"></span>of <span class="_ _2"></span>from the <span class="_ _2"></span>disk.<span class="_ _44"> </span>(The <span class="_ _2"></span>term</div><div class="t m0 x76 h76 yba5 ff1b fs2a fc0 sc0 ls0 ws0">incore<span class="_ _47"> </span><span class="ff19">means<span class="_ _47"> </span></span>in <span class="_ _9"> </span>main <span class="_ _23"> </span>memory<span class="ff19 ls3c0">.B<span class="_ _4a"></span><span class="ls0">ack <span class="_ _9"> </span>in <span class="_ _23"> </span>the <span class="_ _23"> </span>day<span class="_ _6"></span><span class="ls3c1">,ac<span class="_ _8"></span><span class="ls0">omputer <span class="_ _4"></span>’s<span class="_ _47"> </span>main <span class="_ _9"></span>memory <span class="_ _23"> </span>was <span class="_ _9"> </span>built <span class="_ _23"> </span>out <span class="_ _23"> </span>of</span></span></span></span></div><div class="t m0 x76 h51 yba6 ff19 fs2a fc0 sc0 ls0 ws0">ferrite <span class="_ _2"></span>core. <span class="_ _80"> </span>This<span class="_ _66"> </span>is <span class="_ _3"></span>wher<span class="ls3c2">et<span class="_ _d"></span><span class="ls0">he <span class="_ _2"></span>phrase <span class="_ _3"></span>‘‘cor<span class="ls3c2">ed<span class="_ _4f"></span><span class="ls0">ump’<span class="ls3c2">’c<span class="_ _4f"></span><span class="ls0">omes <span class="_ _3"></span>from: <span class="_ _3"></span>the <span class="_ _2"></span>main <span class="_ _3"></span>memory <span class="_ _3"></span>image <span class="_ _3"></span>of <span class="_ _3"></span>a</span></span></span></span></span></span></div><div class="t m0 x76 h51 yba7 ff19 fs2a fc0 sc0 ls0 ws0">program stor<span class="_ _0"></span>ed in a ﬁle on disk for diagnosis.)</div><div class="t m0 x76 h51 yba8 ff19 fs2a fc0 sc0 ls0 ws0">In <span class="_ _23"> </span>the <span class="_ _42"> </span>tests <span class="_ _23"> </span>reported <span class="_ _42"> </span>in <span class="_ _23"> </span>Figur<span class="ls3c3">e3<span class="_ _b"></span><span class="ls0">.6, <span class="_ _23"> </span>each <span class="_ _42"> </span>run <span class="_ _23"> </span>with <span class="_ _42"> </span>a <span class="_ _23"> </span>different <span class="_ _23"> </span>buffer <span class="_ _23"> </span>size <span class="_ _42"> </span>was <span class="_ _23"> </span>made <span class="_ _42"> </span>using <span class="_ _42"> </span>a</span></span></div><div class="t m0 x76 h51 yba9 ff19 fs2a fc0 sc0 ls0 ws0">differ<span class="_ _0"></span>ent <span class="_ _23"> </span>copy <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>so <span class="_ _23"> </span>that <span class="_ _23"> </span>the <span class="_ _42"> </span>current <span class="_ _23"> </span>run <span class="_ _23"> </span>didn’t <span class="_ _23"> </span>ﬁnd <span class="_ _42"> </span>the <span class="_ _23"> </span>data <span class="_ _42"> </span>in <span class="_ _23"> </span>the <span class="_ _23"> </span>cache <span class="_ _42"> </span>from <span class="_ _23"> </span>the</div><div class="t m0 x76 h51 ybaa ff19 fs2a fc0 sc0 ls0 ws0">previous run. <span class="_"> </span>The<span class="_"> </span>ﬁles ar<span class="ls3c4">el<span class="_ _5"></span><span class="ls0">arge enough that they all don’t <span class="_ _2"></span>remain in the cache (the test system</span></span></div><div class="t m0 x76 h51 ybab ff19 fs2a fc0 sc0 ls0 ws0">was conﬁgured with 6 GB of RAM).</div><div class="t m0 x35 h53 ybac ff16 fs2b fc0 sc0 ls0 ws0">3.10 <span class="_ _93"> </span>File<span class="_ _54"> </span>Sharing</div><div class="t m0 x32 h2a ybad ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _2"></span>UNIX <span class="_ _3"></span>System <span class="_ _3"></span>supports <span class="_ _3"></span>the <span class="_ _3"></span>sharing <span class="_ _3"></span>of <span class="_ _3"></span>open <span class="_ _3"></span>ﬁles <span class="_ _3"></span>among <span class="_ _3"></span>differ<span class="_ _0"></span>ent <span class="_ _3"></span>processes. <span class="_ _66"> </span>Before</div><div class="t m0 x32 h26 ybae ff19 fsf fc0 sc0 ls0 ws0">describing the<span class="_ _66"> </span><span class="ff1a">dup<span class="_ _47"> </span></span>function, we <span class="_ _2"></span>need to <span class="_ _2"></span>describe <span class="_ _2"></span>this <span class="_ _2"></span>sharing.<span class="_ _46"> </span><span class="ls5f">To <span class="_ _e"> </span>d<span class="_ _9"></span><span class="ls3c5">ot<span class="_ _d"></span><span class="ls0">his, <span class="_ _2"></span>we’ll examine</span></span></span></div><div class="t m0 x32 h2a ybaf ff19 fsf fc0 sc0 ls0 ws0">the data structur<span class="_ _0"></span>es used by the kernel for all I/O.</div><div class="t m0 x76 h51 ybb0 ff19 fs2a fc0 sc0 ls0 ws0">The following <span class="_ _2"></span>description is <span class="_ _2"></span>conceptual; it <span class="_ _2"></span>may <span class="_ _2"></span>or may <span class="_ _2"></span>not match <span class="_ _2"></span>a particular <span class="_ _2"></span>implementation.</div><div class="t m0 x76 h51 ybb1 ff19 fs2a fc0 sc0 ls0 ws0">Refer <span class="_ _9"></span>to <span class="_ _9"> </span>Bach</div><div class="t m0 x26 h51 ybb2 ff19 fs2a fc0 sc0 ls0 ws0">[</div><div class="t m0 x36 h51 ybb1 ff19 fs2a fc0 sc0 ls0 ws0">1986</div><div class="t m0 x13c h51 ybb2 ff19 fs2a fc0 sc0 ls0 ws0">]</div><div class="t m0 xee h51 ybb1 ff19 fs2a fc0 sc0 ls0 ws0">for <span class="_ _9"></span>a <span class="_ _9"> </span>discussion <span class="_ _23"> </span>of <span class="_ _9"></span>these <span class="_ _9"> </span>structures <span class="_ _9"></span>in <span class="_ _9"> </span>System <span class="_ _23"> </span>V<span class="_ _4"></span><span class="ls3c6">.M<span class="_ _4a"></span><span class="ls0">cKusick <span class="_ _23"> </span>et <span class="_ _9"></span>al.</span></span></div><div class="t m0 x58 h51 ybb2 ff19 fs2a fc0 sc0 ls0 ws0">[</div><div class="t m0 x162 h51 ybb1 ff19 fs2a fc0 sc0 ls0 ws0">1996</div><div class="t m0 x163 h51 ybb2 ff19 fs2a fc0 sc0 ls0 ws0">]</div><div class="t m0 x76 h51 ybb3 ff19 fs2a fc0 sc0 ls0 ws0">describe <span class="_ _2"></span>these structures <span class="_ _2"></span>in <span class="_ _2"></span>4.4BSD.<span class="_ _44"> </span>McKusick <span class="_ _2"></span>and <span class="_ _2"></span>Neville-Neil</div><div class="t m0 x164 h51 ybb4 ff19 fs2a fc0 sc0 ls0 ws0">[</div><div class="t m0 x165 h51 ybb3 ff19 fs2a fc0 sc0 ls0 ws0">2005</div><div class="t m0 xfe h51 ybb4 ff19 fs2a fc0 sc0 ls0 ws0">]</div><div class="t m0 xbc h51 ybb3 ff19 fs2a fc0 sc0 ls0 ws0">cover <span class="_ _2"></span>FreeBSD 5.2.<span class="_ _44"> </span>For</div><div class="t m0 x76 h51 ybb5 ff19 fs2a fc0 sc0 ls3c7 ws0">as<span class="_ _55"></span><span class="ls0">imilar <span class="_ _66"> </span>discussion <span class="_ _80"> </span>of <span class="_ _80"> </span>Solaris, <span class="_ _66"> </span>see <span class="_ _80"> </span>McDougall <span class="_ _80"> </span>and <span class="_ _80"> </span>Mauro</span></div><div class="t m0 x166 h51 ybb6 ff19 fs2a fc0 sc0 ls0 ws0">[</div><div class="t m0 xba h51 ybb5 ff19 fs2a fc0 sc0 ls0 ws0">2007</div><div class="t m0 x12 h51 ybb6 ff19 fs2a fc0 sc0 ls0 ws0">]</div><div class="t m0 xd3 h51 ybb5 ff19 fs2a fc0 sc0 ls3c8 ws0">.T<span class="_ _7"></span><span class="ls0">he <span class="_ _80"> </span>Linux <span class="_ _80"> </span>2.6 <span class="_ _80"> </span>kernel</span></div><div class="t m0 x76 h51 ybb7 ff19 fs2a fc0 sc0 ls0 ws0">architectur<span class="_ _0"></span>e<span class="_"> </span>is<span class="_"> </span>discussed in Bovet and Cesati</div><div class="t m0 xa9 h51 ybb8 ff19 fs2a fc0 sc0 ls0 ws0">[</div><div class="t m0 x93 h51 ybb7 ff19 fs2a fc0 sc0 ls0 ws0">2006</div><div class="t m0 x117 h51 ybb8 ff19 fs2a fc0 sc0 ls0 ws0">]</div><div class="t m0 x80 h51 ybb7 ff19 fs2a fc0 sc0 ls0 ws0">.</div><div class="t m0 x3f h2a ybe ff19 fsf fc0 sc0 ls0 ws0">The kernel <span class="_ _2"></span>uses <span class="_ _2"></span>three data <span class="_ _2"></span>structures to <span class="_ _2"></span>repr<span class="_ _0"></span>esent an <span class="_ _2"></span>open <span class="_ _2"></span>ﬁle, <span class="_ _2"></span>and <span class="_ _2"></span>the relationships</div><div class="t m0 x32 h2a ybb9 ff19 fsf fc0 sc0 ls0 ws0">among them determine <span class="_ _2"></span>the effect one <span class="_ _2"></span>process has on another <span class="_ _2"></span>with regard<span class="_"> </span>to<span class="_"> </span>ﬁle sharing.</div><div class="t m0 x32 h2a ybba ff19 fsf fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>Every<span class="_ _47"> </span>process has <span class="_ _3"></span>an <span class="_ _2"></span>entry <span class="_ _2"></span>in <span class="_ _3"></span>the <span class="_ _2"></span>process <span class="_ _2"></span>table.<span class="_ _61"> </span><span class="ls65">Wi<span class="_ _3"></span></span>thin <span class="_ _3"></span>each <span class="_ _2"></span>process <span class="_ _2"></span>table <span class="_ _2"></span>entry <span class="_ _3"></span>is <span class="_ _2"></span>a</div><div class="t m0 x150 h2a yf1 ff19 fsf fc0 sc0 ls0 ws0">table <span class="_ _3"></span>of <span class="_ _3"></span>open <span class="_ _3"></span>ﬁle <span class="_ _9"></span>descriptors, <span class="_ _3"></span>which <span class="_ _3"></span>we <span class="_ _9"></span>can <span class="_ _3"></span>think <span class="_ _3"></span>of <span class="_ _3"></span>as <span class="_ _9"></span>a <span class="_ _3"></span>vector<span class="_ _6"></span><span class="ls286">,w<span class="_ _4f"></span><span class="ls0">ith <span class="_ _3"></span>one <span class="_ _3"></span>entry <span class="_ _3"></span>per</span></span></div><div class="t m0 x150 h2a ybbb ff19 fsf fc0 sc0 ls0 ws0">descriptor<span class="_ _6"></span><span class="ls86">.A<span class="_ _4a"></span><span class="ls0">ssociated with each ﬁle descriptor are</span></span></div><div class="t m0 x150 h2a ybbc ff19 fsf fc0 sc0 ls0 ws0">(a) <span class="_ _51"> </span>The<span class="_"> </span>ﬁle descriptor ﬂags (close-on-exec; refer to Figur<span class="_ _0"></span><span class="ls44">e3<span class="_ _d"></span><span class="ls0">.7 and Section 3.14)</span></span></div><div class="t m0 x150 h2a ybbd ff19 fsf fc0 sc0 ls0 ws0">(b) <span class="_ _16"> </span>A<span class="_"> </span>pointer to a ﬁle table entry</div><div class="t m0 x32 h2a ybbe ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>The<span class="_"> </span>kernel maintains a ﬁle table for all open ﬁles.<span class="_ _46"> </span>Each ﬁle table entry contains</div><div class="t m0 x150 h2a ybbf ff19 fsf fc0 sc0 ls0 ws0">(a) <span class="_ _51"> </span>The<span class="_ _51"> </span>ﬁle <span class="_ _45"> </span>status <span class="_ _35"> </span>ﬂags <span class="_ _45"> </span>for <span class="_ _35"> </span>the <span class="_ _45"> </span>ﬁle, <span class="_ _35"> </span>such <span class="_ _45"> </span>as <span class="_ _35"> </span>read, <span class="_ _45"> </span>write, <span class="_ _35"> </span>append, <span class="_ _45"> </span>sync, <span class="_ _35"> </span>and</div><div class="t m0 x135 h2a ybc0 ff19 fsf fc0 sc0 ls0 ws0">nonblocking; more<span class="_"> </span>on<span class="_"> </span>these in Section 3.14</div><div class="t m0 x150 h2a ybc1 ff19 fsf fc0 sc0 ls0 ws0">(b) <span class="_ _16"> </span>The<span class="_"> </span>current ﬁle offset</div><div class="t m0 x150 h2a ybc2 ff19 fsf fc0 sc0 ls0 ws0">(c) <span class="_ _65"> </span>A<span class="_"> </span>pointer to the v-node table entry for the ﬁle</div><div class="t m0 x32 h2a ybc3 ff19 fsf fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>Each<span class="_"> </span>open <span class="_ _2"></span>ﬁle <span class="_ _2"></span>(or device) <span class="_ _2"></span>has a <span class="_ _2"></span>v-node <span class="_ _2"></span>structur<span class="ls3c9">et<span class="_ _4f"></span><span class="ls0">hat contains <span class="_ _2"></span>information about <span class="_ _2"></span>the</span></span></div><div class="t m0 x150 h2a ybc4 ff19 fsf fc0 sc0 ls0 ws0">type <span class="_ _42"> </span>of <span class="_ _53"> </span>ﬁle <span class="_ _42"> </span>and <span class="_ _53"> </span>pointers <span class="_ _42"> </span>to <span class="_ _53"> </span>functions <span class="_ _42"> </span>that <span class="_ _53"> </span>operate <span class="_ _42"> </span>on <span class="_ _53"> </span>the <span class="_ _42"> </span>ﬁle.<span class="_ _54"> </span>For <span class="_ _53"> </span>most <span class="_ _42"> </span>ﬁles, <span class="_ _53"> </span>the</div><a class="l" href="#pfc" data-dest-detail='[12,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.890519px;bottom:826.788916px;width:108.023704px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
