<div id="pf197" class="pf w4 h1f" data-page-no="197"><div class="pc pc197 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg197.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>10.19<span class="_ _21f"> </span><span class="ff1a">sleep</span>,<span class="_ _4b"> </span><span class="ff1a">nanosleep</span><span class="ls30a">,a<span class="_ _55"></span><span class="ls0">nd<span class="_ _4b"> </span><span class="ff1a">clock_nanosleep<span class="_ _4b"> </span></span>Functions<span class="_ _1b"> </span><span class="ff18">373</span></span></span></div><div class="t m0 x35 h75 y12f ff16 fs2b fc0 sc0 ls0 ws0">10.19<span class="_ _5a"> </span><span class="ff1f">sleep</span>,<span class="_ _54"> </span><span class="ff1f">nanosleep</span><span class="ls1c3">,a<span class="_ _52"></span><span class="ls0">nd<span class="_ _54"> </span><span class="ff1f">clock_nanosleep<span class="_ _65"> </span></span>Functions</span></span></div><div class="t m0 x32 h26 y4de ff19 fsf fc0 sc0 ls5f ws0">We<span class="_ _9"></span><span class="ls0">’ve <span class="_ _53"> </span>used <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">sleep<span class="_ _44"> </span></span>function <span class="_ _53"> </span>in <span class="_ _53"> </span>numerous <span class="_ _53"> </span>examples <span class="_ _53"> </span>throughout <span class="_ _42"> </span>the <span class="_ _53"> </span>text, <span class="_ _e"> </span>and <span class="_ _53"> </span>we</span></div><div class="t m0 x32 h2a y6d0 ff19 fsf fc0 sc0 ls0 ws0">showed two ﬂawed implementations of it in Figures 10.7 and 10.8.</div><div class="t m0 x3f h57 y2685 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h57 y2686 ff1a fs2d fc0 sc0 ls0 ws0">unsigned int sleep(unsigned int<span class="_"> </span><span class="ff1b">seconds</span>);</div><div class="t m0 x176 h5f y2687 ff19 fs2d fc0 sc0 ls0 ws0">Returns: 0 or number of unslept seconds</div><div class="t m0 x32 h49 y2688 ff19 fs26 fc0 sc0 ls0 ws0">This function causes the calling process to be suspended until either</div><div class="t m0 x3f h4a y2fc8 ff19 fs26 fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>The<span class="_"> </span>amount of wall clock time speciﬁed by<span class="_"> </span><span class="ff1b">seconds<span class="_"> </span></span>has elapsed.</div><div class="t m0 x3f h49 y2fc9 ff19 fs26 fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>A<span class="_"> </span>signal is caught by the process and the signal handler r<span class="_ _0"></span>eturns.</div><div class="t m0 x32 h4d y2fca ff19 fs26 fc0 sc0 ls0 ws0">As <span class="_ _42"> </span>with <span class="_ _23"> </span>an<span class="_ _44"> </span><span class="ff1a">alarm<span class="_ _44"> </span></span>signal, <span class="_ _23"> </span>the <span class="_ _42"> </span>actual <span class="_ _42"> </span>return <span class="_ _23"> </span>may <span class="_ _42"> </span>occur <span class="_ _42"> </span>at <span class="_ _42"> </span>a <span class="_ _42"> </span>time <span class="_ _42"> </span>later <span class="_ _23"> </span>than <span class="_ _42"> </span>requested</div><div class="t m0 x32 h49 y2fcb ff19 fs26 fc0 sc0 ls0 ws0">because of other system activity<span class="_ _4"></span>.</div><div class="t m0 x3f h4d y2fcc ff19 fs26 fc0 sc0 ls0 ws0">In <span class="_ _9"></span>case <span class="_ _9"></span>1, <span class="_ _9"></span>the <span class="_ _9"></span>return <span class="_ _3"></span>value <span class="_ _9"></span>is <span class="_ _9"></span>0.<span class="_ _5a"> </span>When<span class="_ _45"> </span><span class="ff1a">sleep<span class="_ _45"> </span></span><span class="lscc">re</span>turns <span class="_ _9"></span>early <span class="_ _9"></span>because <span class="_ _9"></span>of <span class="_ _9"></span>some <span class="_ _9"></span>signal</div><div class="t m0 x32 h49 y2fcd ff19 fs26 fc0 sc0 ls0 ws0">being <span class="_ _3"></span>caught <span class="_ _3"></span>(case <span class="_ _3"></span>2), <span class="_ _3"></span>the <span class="_ _9"></span>return <span class="_ _2"></span>value <span class="_ _3"></span>is <span class="_ _9"></span>the <span class="_ _3"></span>number <span class="_ _3"></span>of <span class="_ _3"></span>unslept <span class="_ _3"></span>seconds <span class="_ _9"></span>(the <span class="_ _3"></span>requested</div><div class="t m0 x32 h49 y2fce ff19 fs26 fc0 sc0 ls0 ws0">time minus the actual time slept).</div><div class="t m0 x3f h4d y2fcf ff19 fs26 fc0 sc0 ls0 ws0">Although<span class="_ _47"> </span><span class="ff1a">sleep<span class="_ _47"> </span></span>can <span class="_ _3"></span>be <span class="_ _3"></span>implemented <span class="_ _3"></span>with <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">alarm<span class="_ _47"> </span></span>function <span class="_ _3"></span>(Section <span class="_ _3"></span>10.10), <span class="_ _3"></span>this</div><div class="t m0 x32 h4d y2fd0 ff19 fs26 fc0 sc0 ls0 ws0">isn’t <span class="_ _42"> </span>requir<span class="_ _1"></span>ed. <span class="_ _44"> </span>If<span class="_ _44"> </span><span class="ff1a">alarm<span class="_ _35"> </span></span>is <span class="_ _42"> </span>used, <span class="_ _42"> </span>however<span class="_ _6"></span><span class="lsd29">,t<span class="_ _43"></span><span class="ls0">her<span class="lsd29">ec<span class="_ _43"></span><span class="ls0">an <span class="_ _23"> </span>be <span class="_ _42"> </span>interactions <span class="_ _42"> </span>between <span class="_ _42"> </span>the <span class="_ _42"> </span>two</span></span></span></span></div><div class="t m0 x32 h49 y2fd1 ff19 fs26 fc0 sc0 ls0 ws0">functions. <span class="_"> </span>The<span class="_ _66"> </span>POSIX.1 <span class="_ _2"></span>standar<span class="lsd2a">dl<span class="_ _4f"></span><span class="ls0">eaves <span class="_ _2"></span>all these <span class="_ _2"></span>interactions <span class="_ _2"></span>unspeciﬁed.<span class="_ _46"> </span>For <span class="_ _2"></span>example,</span></span></div><div class="t m0 x32 h4d y2fd2 ff19 fs26 fc0 sc0 ls0 ws0">if <span class="_ _2"></span>we <span class="_ _3"></span>do <span class="_ _2"></span>an<span class="_ _47"> </span><span class="ff1a">alarm(10)<span class="_ _47"> </span></span>and <span class="_ _2"></span>3 <span class="_ _3"></span>wall <span class="_ _2"></span>clock <span class="_ _3"></span>seconds <span class="_ _2"></span>later <span class="_ _3"></span>do <span class="_ _3"></span>a<span class="_ _47"> </span><span class="ff1a">sleep(5)</span><span class="lsa58">,w<span class="_ _8"></span><span class="ls0">hat <span class="_ _3"></span>happens?</span></span></div><div class="t m0 x32 h4d y2fd3 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _66"> </span><span class="ff1a">sleep<span class="_ _47"> </span></span>will return <span class="_ _2"></span>in <span class="_ _2"></span>5 <span class="_ _2"></span>seconds <span class="_ _2"></span>(assuming <span class="_ _2"></span>that <span class="_ _2"></span>some <span class="_ _2"></span>other <span class="_ _2"></span>signal <span class="_ _2"></span>isn’t <span class="_ _2"></span>caught <span class="_ _2"></span>in <span class="_ _2"></span>the</div><div class="t m0 x32 h4d y2fd4 ff19 fs26 fc0 sc0 ls0 ws0">interim), <span class="_ _2"></span>but <span class="_ _2"></span>will <span class="_ _2"></span>another<span class="_ _47"> </span><span class="ff1a">SIGALRM<span class="_ _66"> </span></span>be <span class="_ _2"></span>generated <span class="_ _2"></span>2 <span class="_ _3"></span>seconds <span class="_ _2"></span>later?<span class="_ _61"> </span>These <span class="_ _2"></span>details <span class="_ _2"></span>depend</div><div class="t m0 x32 h49 y2fd5 ff19 fs26 fc0 sc0 ls0 ws0">on the implementation.</div><div class="t m0 x76 h5e y2fd6 ff19 fs10 fc0 sc0 ls0 ws0">FreeBSD <span class="_ _80"> </span>8.0, <span class="_ _80"> </span>Linux <span class="_ _66"> </span>3.2.0, <span class="_ _80"> </span>Mac <span class="_ _66"> </span>OS <span class="_ _66"> </span>X <span class="_ _80"> </span>10.6.8, <span class="_ _66"> </span>and <span class="_ _80"> </span>Solaris <span class="_ _66"> </span>10 <span class="_ _80"> </span>implement<span class="_ _4b"> </span><span class="ff1a">sleep<span class="_"> </span></span>using <span class="_ _80"> </span>the</div><div class="t m0 x76 h5e y2fd7 ff1a fs10 fc0 sc0 ls0 ws0">nanosleep<span class="_ _66"> </span><span class="ff19">function, <span class="_ _3"></span>which <span class="_ _9"></span>allows <span class="_ _3"></span>the <span class="_ _9"></span>implementation <span class="_ _3"></span>to <span class="_ _9"></span>be <span class="_ _3"></span>independent <span class="_ _9"></span>of <span class="_ _3"></span>signals <span class="_ _9"></span>and <span class="_ _3"></span>the</span></div><div class="t m0 x76 h2d y2fd8 ff19 fs10 fc0 sc0 ls0 ws0">alarm <span class="_ _3"></span>timer<span class="_ _1"></span><span class="lsd2b">.F<span class="_ _55"></span><span class="ls0">or <span class="_ _9"></span>portability<span class="_ _6"></span><span class="lsd2c">,y<span class="_ _4f"></span><span class="ls0">ou <span class="_ _9"></span>shouldn’t <span class="_ _9"></span>make <span class="_ _3"></span>any <span class="_ _9"></span>assumptions <span class="_ _3"></span>about <span class="_ _9"></span>the <span class="_ _9"></span>implementation</span></span></span></span></div><div class="t m0 x76 h5e y2fd9 ff19 fs10 fc0 sc0 ls0 ws0">of<span class="_ _45"> </span><span class="ff1a">sleep</span><span class="lsd2d">,b<span class="_ _b"></span><span class="ls0">ut <span class="_ _42"> </span>if <span class="_ _42"> </span>you <span class="_ _42"> </span>have <span class="_ _42"> </span>any <span class="_ _42"> </span>intentions <span class="_ _42"> </span>of <span class="_ _42"> </span>mixing <span class="_ _42"> </span>calls <span class="_ _42"> </span>to<span class="_ _35"> </span><span class="ff1a">sleep<span class="_ _45"> </span></span>with <span class="_ _42"> </span>any <span class="_ _42"> </span>other <span class="_ _42"> </span>timing</span></span></div><div class="t m0 x76 h2d y2fda ff19 fs10 fc0 sc0 ls0 ws0">functions, you need to be aware<span class="_"> </span>of<span class="_"> </span>possible interactions.</div><div class="t m0 x35 h4c y2fdb ff16 fs26 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h4d y2fdc ff19 fs26 fc0 sc0 ls0 ws0">Figur<span class="lsd2e">e1<span class="_ _8"></span><span class="ls0">0.29 <span class="_ _2"></span>shows <span class="_ _3"></span>an <span class="_ _2"></span>implementation <span class="_ _3"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>POSIX.1<span class="_ _47"> </span><span class="ff1a">sleep<span class="_ _47"> </span></span>function. <span class="_ _47"> </span>This<span class="_ _66"> </span>function <span class="_ _3"></span>is</span></span></div><div class="t m0 x32 h49 y2fdd ff19 fs26 fc0 sc0 lsd2f ws0">am<span class="_ _d"></span><span class="ls0">odiﬁcation of Figur<span class="lsd2f">e1<span class="_ _d"></span><span class="ls0">0.7, which handles signals reliably<span class="_ _4"></span><span class="lsd30">,a<span class="_ _d"></span><span class="ls0">voiding the race condition</span></span></span></span></span></div><div class="t m0 x32 h49 y2fde ff19 fs26 fc0 sc0 ls0 ws0">in <span class="_ _9"></span>the <span class="_ _9"></span>earlier <span class="_ _9"></span>implementation.<span class="_ _51"> </span><span class="ls164">We <span class="_ _66"> </span>s<span class="_ _9"></span></span>till <span class="_ _9"></span>do <span class="_ _9"></span>not <span class="_ _23"></span>handle <span class="_ _9"></span>any <span class="_ _9"></span>interactions <span class="_ _9"></span>with <span class="_ _9"></span>previously</div><div class="t m0 x32 h49 y2fdf ff19 fs26 fc0 sc0 ls0 ws0">set alarms.<span class="_ _59"> </span>(As we mentioned, these interactions ar<span class="lsd3">ee<span class="_ _d"></span><span class="ls0">xplicitly undeﬁned by POSIX.1.)</span></span></div><div class="t m0 x32 h5d y2fe0 ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h5d y2fe1 ff1a fs2f fc0 sc0 ls0 ws0">static void</div><div class="t m0 x32 h5d y2fe2 ff1a fs2f fc0 sc0 ls0 ws0">sig_alrm(int signo)</div><div class="t m0 x32 h5d y2fe3 ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y2fe4 ff1a fs2f fc0 sc0 ls0 ws0">/* nothing to do, just returning wakes up sigsuspend() */</div><div class="t m0 x32 h5d y2fe5 ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h5d y2fe6 ff1a fs2f fc0 sc0 ls0 ws0">unsigned int</div><a class="l" href="#pf10" data-dest-detail='[16,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1236.288916px;width:356.831810px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
