<div id="pf22a" class="pf w4 h1f" data-page-no="22a"><div class="pc pc22a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg22a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">520<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x1ca h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">numop--;</div><div class="t m0 x1ca h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x1f h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">if (numop == 0) {</div><div class="t m0 x1f h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">if (off &gt;= sbuf.st_size)</div><div class="t m0 x1ca h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x9d h57 y805 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x1f h57 y806 ff1a fs2d fc0 sc0 ls0 ws0">if (aio_suspend(aiolist, NBUF, NULL) &lt; 0)</div><div class="t m0 x1ca h57 y807 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;aio_suspend failed&quot;);</div><div class="t m0 x9d h57 y808 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y809 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y8da ff1a fs2d fc0 sc0 ls0 ws0">bufs[0].aiocb.aio_fildes = ofd;</div><div class="t m0 x8a h57 y8db ff1a fs2d fc0 sc0 ls0 ws0">if (aio_fsync(O_SYNC, &amp;bufs[0].aiocb) &lt; 0)</div><div class="t m0 x9d h57 y8dc ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;aio_fsync failed&quot;);</div><div class="t m0 x8a h57 y8dd ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y8de ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1e5 h2d y3f90 ff18 fs10 fc0 sc0 ls0 ws0">Figure 14.21<span class="_ _5a"> </span><span class="ff19 ls277">Tr<span class="_ _9"></span><span class="ls0">anslate a ﬁle using ROT</span></span></div><div class="t m0 x1ff h2d y3f91 ff19 fs10 fc0 sc0 ls0 ws0">-</div><div class="t m0 x174 h2d y3f90 ff19 fs10 fc0 sc0 ls0 ws0">13 and asynchronous I/O</div><div class="t m0 x3f h49 y3f92 ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_"> </span>that <span class="_ _e"> </span>we <span class="_"> </span>use <span class="_ _e"> </span>eight <span class="_"> </span>buffers, <span class="_ _e"> </span>so <span class="_"> </span>we <span class="_ _e"> </span>can <span class="_"> </span>have <span class="_ _e"> </span>up <span class="_"> </span>to <span class="_"> </span>eight <span class="_ _e"> </span>asynchronous <span class="_ _e"> </span>I/O</div><div class="t m0 x32 h49 y3f93 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">quests <span class="_ _42"> </span>pending.<span class="_ _51"> </span>Surprisingly<span class="_ _6"></span><span class="ls10c5">,t<span class="_ _43"></span><span class="ls0">his <span class="_ _23"> </span>might <span class="_ _42"> </span>actually <span class="_ _42"> </span>r<span class="_ _0"></span>educe <span class="_ _23"> </span>performance<span class="_ _9"></span><span class="ls161">—i<span class="_ _1"></span><span class="ls10c5">ft<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>reads</span></span></span></span></span></span></div><div class="t m0 x32 h49 y3f94 ff19 fs26 fc0 sc0 ls0 ws0">ar<span class="ls10c6">ep<span class="_ _b"></span><span class="lscc">re<span class="ls0">sented <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>system <span class="_ _9"></span>out <span class="_ _9"></span>of <span class="_ _9"></span>order<span class="_ _6"></span>,<span class="_ _45"> </span>it<span class="_ _45"> </span>can <span class="_ _3"></span>defeat <span class="_ _9"></span>the <span class="_ _9"></span>operating <span class="_ _9"></span>system’s <span class="_ _9"></span>read-</span></span></span></div><div class="t m0 x32 h49 y3f95 ff19 fs26 fc0 sc0 ls0 ws0">ahead algorithm.</div><div class="t m0 x3f h49 y3f96 ff19 fs26 fc0 sc0 ls0 ws0">Before<span class="_ _35"> </span>we<span class="_ _35"> </span>can <span class="_ _42"> </span>check <span class="_ _42"> </span>the <span class="_ _23"> </span>return <span class="_ _42"> </span>value <span class="_ _23"> </span>of <span class="_ _42"> </span>an <span class="_ _42"> </span>operation, <span class="_ _42"> </span>we <span class="_ _42"> </span>need <span class="_ _23"> </span>to <span class="_ _42"> </span>make <span class="_ _42"> </span>sur<span class="ls10c7">et<span class="_ _43"></span><span class="ls0">he</span></span></div><div class="t m0 x32 h4d y3f97 ff19 fs26 fc0 sc0 ls0 ws0">operation <span class="_ _2"></span>has <span class="_ _3"></span>completed.<span class="_ _16"> </span>When<span class="_ _47"> </span><span class="ff1a">aio_error<span class="_ _47"> </span></span><span class="lscc">re<span class="_ _2"></span></span>turns <span class="_ _2"></span>a <span class="_ _3"></span>value <span class="_ _3"></span>other <span class="_ _3"></span>than<span class="_ _47"> </span><span class="ff1a">EINPROGRESS</span></div><div class="t m0 x32 h49 y3f98 ff19 fs26 fc0 sc0 ls0 ws0">or<span class="_ _66"> </span><span class="ff20">−</span>1, <span class="_ _2"></span>we <span class="_ _2"></span>know <span class="_ _2"></span>the <span class="_ _2"></span>operation <span class="_ _3"></span>is <span class="_ _2"></span>complete.<span class="_ _61"> </span>Excluding <span class="_ _2"></span>these <span class="_ _2"></span>values, <span class="_ _2"></span>if <span class="_ _2"></span>the <span class="_ _2"></span>return <span class="_ _2"></span>value <span class="_ _2"></span>is</div><div class="t m0 x32 h49 y3f99 ff19 fs26 fc0 sc0 ls0 ws0">anything <span class="_ _23"></span>other <span class="_ _9"></span>than <span class="_ _23"> </span>0, <span class="_ _23"></span>then <span class="_ _23"></span>we <span class="_ _9"></span>know <span class="_ _23"> </span>the <span class="_ _23"></span>operation <span class="_ _23"></span>failed.<span class="_ _5a"> </span>Once <span class="_ _23"> </span>we’ve <span class="_ _23"></span>checked <span class="_ _23"></span>these</div><div class="t m0 x32 h4d y3f9a ff19 fs26 fc0 sc0 ls0 ws0">conditions, it is safe to call<span class="_"> </span><span class="ff1a">aio_return<span class="_ _80"> </span></span>to get the return value of the I/O operation.</div><div class="t m0 x3f h49 y3f9b ff19 fs26 fc0 sc0 ls0 ws0">As <span class="_"> </span>long <span class="_ _e"> </span>as <span class="_"> </span>we <span class="_"> </span>have <span class="_ _e"> </span>work <span class="_"> </span>to <span class="_"> </span>do, <span class="_ _e"> </span>we <span class="_"> </span>can <span class="_ _e"> </span>submit <span class="_"> </span>asynchronous <span class="_ _e"> </span>I/O <span class="_"> </span>operations.</div><div class="t m0 x32 h49 y3f9c ff19 fs26 fc0 sc0 ls0 ws0">When <span class="_ _53"> </span>we <span class="_ _53"> </span>have <span class="_ _e"> </span>an <span class="_ _53"> </span>unused <span class="_ _e"> </span>AIO <span class="_ _53"> </span>control <span class="_ _53"> </span>block, <span class="_ _53"> </span>we <span class="_ _e"> </span>can <span class="_ _53"> </span>submit <span class="_ _e"> </span>an <span class="_ _53"> </span>asynchronous <span class="_ _53"> </span>read</div><div class="t m0 x32 h49 y3f9d ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">quest. <span class="_ _35"> </span>When<span class="_ _45"> </span><span class="ls10c8">ar<span class="_ _b"></span><span class="ls0">ead <span class="_ _9"></span>completes, <span class="_ _23"></span>we <span class="_ _9"></span>translate <span class="_ _23"> </span>the <span class="_ _23"></span>buffer <span class="_ _9"></span>contents <span class="_ _23"></span>and <span class="_ _23"></span>then <span class="_ _9"></span>submit <span class="_ _23"> </span>an</span></span></span></div><div class="t m0 x32 h49 y3f9e ff19 fs26 fc0 sc0 ls0 ws0">asynchronous <span class="_ _23"> </span>write <span class="_ _42"> </span>request. <span class="_ _35"> </span>When<span class="_ _44"> </span>all <span class="_ _42"> </span>AIO <span class="_ _23"> </span>control <span class="_ _42"> </span>blocks <span class="_ _42"> </span>are<span class="_ _35"> </span>in<span class="_ _35"> </span>use, <span class="_ _42"> </span>we <span class="_ _42"> </span>wait <span class="_ _42"> </span>for <span class="_ _42"> </span>an</div><div class="t m0 x32 h4d y3f9f ff19 fs26 fc0 sc0 ls0 ws0">operation to complete by calling<span class="_"> </span><span class="ff1a">aio_suspend</span>.</div><div class="t m0 x3f h49 y3fa0 ff19 fs26 fc0 sc0 ls0 ws0">When we write a block to <span class="_ _2"></span>the output ﬁle, we retain the same offset at which we read</div><div class="t m0 x32 h49 y3fa1 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>data <span class="_ _3"></span>from <span class="_ _2"></span>the <span class="_ _9"></span>input <span class="_ _2"></span>ﬁle.<span class="_ _16"> </span>Consequently<span class="_ _6"></span><span class="lsc23">,t<span class="_ _8"></span><span class="ls0">he <span class="_ _3"></span>order <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>writes <span class="_ _3"></span>doesn’t <span class="_ _3"></span>matter<span class="_ _1"></span><span class="ls10c9">.T<span class="_ _1d"></span><span class="ls0">his</span></span></span></span></div><div class="t m0 x32 h49 y3fa2 ff19 fs26 fc0 sc0 ls0 ws0">strategy <span class="_ _47"> </span>works <span class="_ _47"> </span>only <span class="_ _47"> </span>because <span class="_ _45"> </span>each <span class="_ _47"> </span>character <span class="_ _47"> </span>in <span class="_ _47"> </span>the <span class="_ _47"> </span>input <span class="_ _47"> </span>ﬁle <span class="_ _45"> </span>has <span class="_ _47"> </span>a <span class="_ _47"> </span>corresponding</div><div class="t m0 x32 h49 y3fa3 ff19 fs26 fc0 sc0 ls0 ws0">character in the output ﬁle at the same offset; we neither add nor delete characters in the</div><div class="t m0 x32 h49 y3fa4 ff19 fs26 fc0 sc0 ls0 ws0">output ﬁle. (This insight might help solve Exercise 14.8.)</div><div class="t m0 x3f h49 y3fa5 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _e"> </span>d<span class="_ _9"></span><span class="ls0">on’t <span class="_ _3"></span>use <span class="_ _2"></span>asynchronous <span class="_ _2"></span>notiﬁcation <span class="_ _2"></span>in <span class="_ _3"></span>this <span class="_ _2"></span>example, <span class="_ _2"></span>because <span class="_ _3"></span>it <span class="_ _2"></span>is <span class="_ _2"></span>easier <span class="_ _3"></span>to <span class="_ _2"></span>use <span class="_ _2"></span>a</span></div><div class="t m0 x32 h49 y3fa6 ff19 fs26 fc0 sc0 ls0 ws0">synchronous <span class="_"> </span>programming <span class="_"> </span>model.<span class="_ _60"> </span>If <span class="_ _66"> </span>we <span class="_ _66"> </span>had <span class="_ _47"> </span>something <span class="_"> </span>else <span class="_ _66"> </span>to <span class="_ _66"> </span>do <span class="_ _66"> </span>while <span class="_ _66"> </span>the <span class="_ _47"> </span>I/O</div><div class="t m0 x32 h4d y3fa7 ff19 fs26 fc0 sc0 ls0 ws0">operations <span class="_ _53"> </span>were<span class="_ _44"> </span>in<span class="_ _4b"> </span>p<span class="lscc">ro</span>gress, <span class="_ _53"> </span>then <span class="_ _53"> </span>the <span class="_ _53"> </span>additional <span class="_ _53"> </span>work <span class="_ _53"> </span>could <span class="_ _e"> </span>be <span class="_ _53"> </span>folded <span class="_ _53"> </span>into <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">for</span></div><div class="t m0 x32 h49 y3fa8 ff19 fs26 fc0 sc0 ls0 ws0">loop. <span class="_"> </span>If<span class="_"> </span>we <span class="_ _2"></span>needed to <span class="_ _2"></span>prevent this additional work <span class="_ _2"></span>from delaying the task <span class="_ _2"></span>of translating</div><div class="t m0 x32 h49 y3fa9 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_"> </span>ﬁle, <span class="_ _47"> </span>however<span class="_ _6"></span><span class="lsc7a">,t<span class="_ _5b"></span><span class="ls0">hen <span class="_ _47"> </span>we <span class="_"> </span>might <span class="_ _66"> </span>have <span class="_ _47"> </span>to <span class="_"> </span>structur<span class="lsc7a">et<span class="_ _5b"></span><span class="ls0">he <span class="_"> </span>code <span class="_ _47"> </span>to <span class="_"> </span>use <span class="_ _66"> </span>some <span class="_ _47"> </span>form <span class="_"> </span>of</span></span></span></span></div><div class="t m0 x32 h49 y3faa ff19 fs26 fc0 sc0 ls0 ws0">asynchronous <span class="_ _9"></span>notiﬁcation.<span class="_ _51"> </span><span class="ls3aa">Wi<span class="_ _3"></span></span>th <span class="_ _23"> </span>multiple <span class="_ _23"> </span>tasks, <span class="_ _23"> </span>we <span class="_ _23"> </span>need <span class="_ _23"> </span>to <span class="_ _23"> </span>prioritize <span class="_ _23"> </span>the <span class="_ _23"> </span>tasks <span class="_ _23"> </span>before</div><div class="t m0 x32 h49 y1c06 ff19 fs26 fc0 sc0 ls0 ws0">deciding how the program should be str<span class="_ _0"></span>uctured.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
