<div id="pf248" class="pf w4 h1f" data-page-no="248"><div class="pc pc248 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg248.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">550<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>n,<span class="_"> </span>fd1[2], fd2[2];</div><div class="t m0 x8a h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">pid_t <span class="_ _d9"> </span>pid;</div><div class="t m0 x8a h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>line[MAXLINE];</div><div class="t m0 x8a h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">if (signal(SIGPIPE, sig_pipe) == SIG_ERR)</div><div class="t m0 x9d h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;signal error&quot;);</div><div class="t m0 x8a h57 y350c ff1a fs2d fc0 sc0 ls0 ws0">if (pipe(fd1) &lt; 0 || pipe(fd2) &lt; 0)</div><div class="t m0 x9d h57 y350d ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;pipe error&quot;);</div><div class="t m0 x8a h57 y16fa ff1a fs2d fc0 sc0 ls0 ws0">if ((pid = fork()) &lt; 0) {</div><div class="t m0 x9d h57 y340f ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fork error&quot;);</div><div class="t m0 x8a h57 y3410 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pid &gt; 0) {<span class="_ _1b8"> </span>/* parent */</span></div><div class="t m0 x9d h57 y3411 ff1a fs2d fc0 sc0 ls0 ws0">close(fd1[0]);</div><div class="t m0 x9d h57 y3412 ff1a fs2d fc0 sc0 ls0 ws0">close(fd2[1]);</div><div class="t m0 x9d h57 y1315 ff1a fs2d fc0 sc0 ls0 ws0">while (fgets(line, MAXLINE, stdin) != NULL) {</div><div class="t m0 x1f h57 y351c ff1a fs2d fc0 sc0 ls15c ws0">n=s<span class="_ _1d"></span><span class="ls0">trlen(line);</span></div><div class="t m0 x1f h57 y351d ff1a fs2d fc0 sc0 ls0 ws0">if (write(fd1[1], line, n) != n)</div><div class="t m0 x1ca h57 y351e ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write error to pipe&quot;);</div><div class="t m0 x1f h57 y351f ff1a fs2d fc0 sc0 ls0 ws0">if ((n = read(fd2[0], line, MAXLINE)) &lt; 0)</div><div class="t m0 x1ca h57 y3520 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;read error from pipe&quot;);</div><div class="t m0 x1f h57 y42b2 ff1a fs2d fc0 sc0 ls0 ws0">if (n == 0) {</div><div class="t m0 x1ca h57 y42b3 ff1a fs2d fc0 sc0 ls0 ws0">err_msg(&quot;child closed pipe&quot;);</div><div class="t m0 x1ca h57 y42b4 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x1f h57 y38bf ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1f h57 y38c0 ff1a fs2d fc0 sc0 ls0 ws0">line[n] = 0;<span class="_ _15"> </span>/* null terminate */</div><div class="t m0 x1f h57 y38c1 ff1a fs2d fc0 sc0 ls0 ws0">if (fputs(line, stdout) == EOF)</div><div class="t m0 x1ca h57 y42b5 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fputs error&quot;);</div><div class="t m0 x9d h57 y3f7e ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y38c4 ff1a fs2d fc0 sc0 ls0 ws0">if (ferror(stdin))</div><div class="t m0 x1f h57 y38c5 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fgets error on stdin&quot;);</div><div class="t m0 x9d h57 y42b6 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x8a h57 y42b7 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {<span class="_ _8b"> </span>/* child */</span></div><div class="t m0 x9d h57 y42b8 ff1a fs2d fc0 sc0 ls0 ws0">close(fd1[1]);</div><div class="t m0 x9d h57 y42b9 ff1a fs2d fc0 sc0 ls0 ws0">close(fd2[0]);</div><div class="t m0 x9d h57 y42ba ff1a fs2d fc0 sc0 ls0 ws0">if (fd1[0] != STDIN_FILENO) {</div><div class="t m0 x1f h57 y42bb ff1a fs2d fc0 sc0 ls0 ws0">if (dup2(fd1[0], STDIN_FILENO) != STDIN_FILENO)</div><div class="t m0 x1ca h57 y42bc ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;dup2 error to stdin&quot;);</div><div class="t m0 x1f h57 y42bd ff1a fs2d fc0 sc0 ls0 ws0">close(fd1[0]);</div><div class="t m0 x9d h57 y42be ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y342c ff1a fs2d fc0 sc0 ls0 ws0">if (fd2[1] != STDOUT_FILENO) {</div><div class="t m0 x1f h57 y42bf ff1a fs2d fc0 sc0 ls0 ws0">if (dup2(fd2[1], STDOUT_FILENO) != STDOUT_FILENO)</div><div class="t m0 x1ca h57 y42c0 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;dup2 error to stdout&quot;);</div><div class="t m0 x1f h57 y42c1 ff1a fs2d fc0 sc0 ls0 ws0">close(fd2[1]);</div><div class="t m0 x9d h57 y42c2 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y42c3 ff1a fs2d fc0 sc0 ls0 ws0">if (execl(&quot;./add2&quot;, &quot;add2&quot;, (char *)0) &lt; 0)</div><div class="t m0 x1f h57 y42c4 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;execl error&quot;);</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
