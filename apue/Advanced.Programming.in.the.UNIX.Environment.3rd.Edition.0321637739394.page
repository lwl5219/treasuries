<div id="pf18a" class="pf w4 h1f" data-page-no="18a"><div class="pc pc18a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg18a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">360<span class="_ _1b"> </span><span class="ff19">Signals <span class="_ _24b"> </span>Chapter<span class="_ _21"> </span>10</span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls24e">e1<span class="_ _43"></span><span class="ls0">0.22 <span class="_ _23"></span>shows <span class="_ _23"> </span>the <span class="_ _23"> </span>correct <span class="_ _23"></span>way <span class="_ _23"></span>to <span class="_ _23"> </span>protect <span class="_ _23"></span>a <span class="_ _23"></span>critical <span class="_ _23"> </span>region <span class="_ _23"></span>of <span class="_ _23"></span>code <span class="_ _23"></span>from <span class="_ _23"></span>a <span class="_ _23"></span>speciÔ¨Åc</span></span></div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">signal.</div><div class="t m0 x32 h4e y2d71 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y2d72 ff1a fs28 fc0 sc0 ls0 ws0">static void sig_int(int);</div><div class="t m0 x32 h4e y2e29 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y2e2a ff1a fs28 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h4e y2e2b ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y2d76 ff1a fs28 fc0 sc0 ls0 ws0">sigset_t <span class="_ _68"> </span>newmask,<span class="_"> </span>oldmask, waitmask;</div><div class="t m0 x8a h4e y2e2c ff1a fs28 fc0 sc0 ls0 ws0">pr_mask(&quot;program start: &quot;);</div><div class="t m0 x8a h4e y2e2d ff1a fs28 fc0 sc0 ls0 ws0">if (signal(SIGINT, sig_int) == SIG_ERR)</div><div class="t m0 x9d h4e y2e2e ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;signal(SIGINT) error&quot;);</div><div class="t m0 x8a h4e y2e2f ff1a fs28 fc0 sc0 ls0 ws0">sigemptyset(&amp;waitmask);</div><div class="t m0 x8a h4e y2e30 ff1a fs28 fc0 sc0 ls0 ws0">sigaddset(&amp;waitmask, SIGUSR1);</div><div class="t m0 x8a h4e y2e31 ff1a fs28 fc0 sc0 ls0 ws0">sigemptyset(&amp;newmask);</div><div class="t m0 x8a h4e y2e32 ff1a fs28 fc0 sc0 ls0 ws0">sigaddset(&amp;newmask, SIGINT);</div><div class="t m0 x8a h4e y2e33 ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h4e y2e34 ff1a fs28 fc0 sc0 ls1b6 ws0">*B<span class="_ _1d"></span><span class="ls0">lock SIGINT and save current signal mask.</span></div><div class="t m0 x214 h4e y2e35 ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h4e y2e36 ff1a fs28 fc0 sc0 ls0 ws0">if (sigprocmask(SIG_BLOCK, &amp;newmask, &amp;oldmask) &lt; 0)</div><div class="t m0 x9d h4e y2e37 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;SIG_BLOCK error&quot;);</div><div class="t m0 x8a h4e y2e38 ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h4e y2e39 ff1a fs28 fc0 sc0 ls1b6 ws0">*C<span class="_ _1d"></span><span class="ls0">ritical region of code.</span></div><div class="t m0 x214 h4e y2e3a ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h4e y2e3b ff1a fs28 fc0 sc0 ls0 ws0">pr_mask(&quot;in critical region: &quot;);</div><div class="t m0 x8a h4e y2e3c ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h4e y2e3d ff1a fs28 fc0 sc0 ls1b6 ws0">*P<span class="_ _1d"></span><span class="ls0">ause, allowing all signals except SIGUSR1.</span></div><div class="t m0 x214 h4e y2e3e ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h4e y2e3f ff1a fs28 fc0 sc0 ls0 ws0">if (sigsuspend(&amp;waitmask) != -1)</div><div class="t m0 x9d h4e y2e40 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;sigsuspend error&quot;);</div><div class="t m0 x8a h4e y2e41 ff1a fs28 fc0 sc0 ls0 ws0">pr_mask(&quot;after return from sigsuspend: &quot;);</div><div class="t m0 x8a h4e y2e42 ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h4e y2e43 ff1a fs28 fc0 sc0 ls1b6 ws0">*R<span class="_ _1d"></span><span class="ls0">eset signal mask which unblocks SIGINT.</span></div><div class="t m0 x214 h4e y2e44 ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h4e y2e45 ff1a fs28 fc0 sc0 ls0 ws0">if (sigprocmask(SIG_SETMASK, &amp;oldmask, NULL) &lt; 0)</div><div class="t m0 x9d h4e y2e46 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;SIG_SETMASK error&quot;);</div><div class="t m0 x8a h4e y2e47 ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h4e y2e48 ff1a fs28 fc0 sc0 ls1b6 ws0">*A<span class="_ _1d"></span><span class="ls0">nd continue processing ...</span></div><div class="t m0 x214 h4e y2e49 ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h4e y2e4a ff1a fs28 fc0 sc0 ls0 ws0">pr_mask(&quot;program exit: &quot;);</div><div class="t m0 x8a h4e y2e4b ff1a fs28 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h4e y2e4c ff1a fs28 fc0 sc0 ls0 ws0">}</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
