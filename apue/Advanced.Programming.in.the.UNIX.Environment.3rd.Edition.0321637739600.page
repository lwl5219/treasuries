<div id="pf258" class="pf w4 h1f" data-page-no="258"><div class="pc pc258 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg258.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">566<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">When <span class="_ _9"></span>a <span class="_ _23"> </span>process <span class="_ _9"></span>is <span class="_ _23"></span>done <span class="_ _9"></span>with <span class="_ _23"> </span>a <span class="_ _23"></span>shared <span class="_ _9"></span>resour<span class="_ _1"></span>ce <span class="_ _23"> </span>that <span class="_ _23"></span>is <span class="_ _9"></span>controlled <span class="_ _9"></span>by <span class="_ _23"> </span>a <span class="_ _23"></span>semaphore, <span class="_ _9"></span>the</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">semaphor<span class="ls1c8">ev<span class="_ _8"></span><span class="ls0">alue <span class="_ _2"></span>is <span class="_ _3"></span>incremented <span class="_ _2"></span>by <span class="_ _2"></span>1.<span class="_ _16"> </span>If <span class="_ _2"></span>any <span class="_ _3"></span>other <span class="_ _2"></span>processes <span class="_ _2"></span>ar<span class="ls3f3">ea<span class="_ _8"></span><span class="ls0">sleep, <span class="_ _3"></span>waiting <span class="_ _3"></span>for <span class="_ _2"></span>the</span></span></span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">semaphore, they ar<span class="_ _0"></span><span class="ls44">ea<span class="_ _d"></span><span class="ls0">wakened.</span></span></div><div class="t m0 x3f h2a y132 ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _61"> </span>i<span class="_ _9"></span><span class="ls0">mplement <span class="_ _45"> </span>semaphores <span class="_ _45"> </span>correctly<span class="_ _4"></span><span class="ls123b">,t<span class="_ _62"></span><span class="ls0">he <span class="_ _45"> </span>test <span class="_ _45"> </span>of <span class="_ _35"> </span>a <span class="_ _45"> </span>semaphore’s <span class="_ _45"> </span>value <span class="_ _45"> </span>and <span class="_ _45"> </span>the</span></span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">decrementing <span class="_ _9"></span>of <span class="_ _23"></span>this <span class="_ _9"></span>value <span class="_ _23"> </span>must <span class="_ _23"></span>be <span class="_ _9"></span>an <span class="_ _23"> </span>atomic <span class="_ _23"></span>operation.<span class="_ _5a"> </span>For <span class="_ _23"></span>this <span class="_ _9"></span>reason, <span class="_ _23"></span>semaphores</div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">ar<span class="ls44">en<span class="_ _4f"></span><span class="ls0">ormally implemented inside the kernel.</span></span></div><div class="t m0 x3f h2b y135 ff19 fsf fc0 sc0 ls123c ws0">Ac<span class="_ _4a"></span><span class="ls0">ommon <span class="_"> </span>form <span class="_ _e"> </span>of <span class="_"> </span>semaphor<span class="_ _0"></span>e<span class="_ _4b"> </span>is<span class="_ _59"> </span>called <span class="_"> </span>a<span class="_ _4b"> </span><span class="ff1b">binary <span class="_"> </span>semaphor<span class="_ _0"></span>e<span class="ff19 ls33f">.I<span class="_ _5d"></span><span class="ls340">tc<span class="_ _55"></span><span class="ls0">ontrols <span class="_ _e"> </span>a <span class="_"> </span>single</span></span></span></span></span></div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">source, <span class="_ _53"> </span>and <span class="_"> </span>its <span class="_ _53"> </span>value <span class="_ _e"> </span>is <span class="_ _e"> </span>initialized <span class="_ _e"> </span>to <span class="_ _e"> </span>1.<span class="_ _65"> </span>In <span class="_ _e"> </span>general, <span class="_ _e"> </span>however<span class="_ _1"></span><span class="ls108f">,as<span class="_ _55"></span><span class="ls0">emaphor<span class="ls123d">ec<span class="_ _55"></span><span class="ls0">an <span class="_ _e"> </span>be</span></span></span></span></span></div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">initialized to any positive value, with the value indicating <span class="_ _2"></span>how many units of the shared</div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">source ar<span class="ls44">ea<span class="_ _4f"></span><span class="ls0">vailable for sharing.</span></span></span></div><div class="t m0 x3f h2a y139 ff19 fsf fc0 sc0 ls0 ws0">XSI <span class="_"> </span>semaphores <span class="_"> </span>are, <span class="_"> </span>unfortunately<span class="_ _6"></span><span class="lsc1c">,m<span class="_ _5b"></span><span class="ls0">or<span class="lsc1c">ec<span class="_ _5b"></span><span class="ls0">omplicated <span class="_"> </span>than <span class="_ _66"> </span>this.<span class="_ _50"> </span>Three <span class="_"> </span>features</span></span></span></span></div><div class="t m0 x32 h2a y13a ff19 fsf fc0 sc0 ls0 ws0">contribute to this unnecessary complication.</div><div class="t m0 x3f h2a ya65 ff19 fsf fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>A<span class="_ _44"> </span>semaphore<span class="_ _44"> </span>is<span class="_ _44"> </span>not <span class="_ _42"> </span>simply <span class="_ _42"> </span>a <span class="_ _53"> </span>single <span class="_ _42"> </span>non-negative <span class="_ _53"> </span>value.<span class="_ _54"> </span>Instead, <span class="_ _42"> </span>we <span class="_ _53"> </span>have <span class="_ _42"> </span>to</div><div class="t m0 x41 h2a ya66 ff19 fsf fc0 sc0 ls0 ws0">deﬁne a semaphore<span class="_"> </span>as<span class="_"> </span>a<span class="_"> </span>set of one or mor<span class="ls273">es<span class="_ _4f"></span><span class="ls0">emaphor<span class="ls273">ev<span class="_ _d"></span><span class="ls0">alues. <span class="_"> </span>When<span class="_"> </span>we create a</span></span></span></span></div><div class="t m0 x41 h2a ya67 ff19 fsf fc0 sc0 ls0 ws0">semaphore, we specify the number of values in the set.</div><div class="t m0 x3f h26 ya29 ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>The<span class="_ _5a"> </span>creation <span class="_ _45"> </span>of <span class="_ _45"> </span>a <span class="_ _45"> </span>semaphor<span class="ls123e">e(<span class="_ _26"></span><span class="ff1a ls0">semget<span class="ff19">)<span class="_ _5a"> </span>is<span class="_ _51"> </span>independent <span class="_ _45"> </span>of <span class="_ _45"> </span>its <span class="_ _45"> </span>initialization</span></span></span></div><div class="t m0 x41 h26 ya2a ff19 fsf fc0 sc0 ls0 ws0">(<span class="ff1a">semctl</span>). <span class="_ _51"> </span>This<span class="_ _51"> </span>is <span class="_ _35"> </span>a <span class="_ _45"> </span>fatal <span class="_ _35"> </span>ﬂaw<span class="_ _6"></span><span class="ls123f">,s<span class="_ _26"></span><span class="ls0">ince <span class="_ _35"> </span>we <span class="_ _35"> </span>cannot <span class="_ _35"> </span>atomically <span class="_ _45"> </span>create <span class="_ _35"> </span>a <span class="_ _35"> </span>new</span></span></div><div class="t m0 x41 h2a y155d ff19 fsf fc0 sc0 ls0 ws0">semaphor<span class="ls44">es<span class="_ _4f"></span><span class="ls0">et and initialize all the values in the set.</span></span></div><div class="t m0 x3f h2a y1cb0 ff19 fsf fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>Since<span class="_ _35"> </span>all <span class="_ _23"> </span>forms <span class="_ _42"> </span>of <span class="_ _23"> </span>XSI <span class="_ _23"> </span>IPC <span class="_ _42"> </span>remain <span class="_ _23"></span>in <span class="_ _23"> </span>existence <span class="_ _23"> </span>even <span class="_ _42"> </span>when <span class="_ _23"> </span>no <span class="_ _23"> </span>process <span class="_ _23"> </span>is <span class="_ _42"> </span>using</div><div class="t m0 x41 h2a y1cb1 ff19 fsf fc0 sc0 ls0 ws0">them, <span class="_ _3"></span>we <span class="_ _9"></span>have <span class="_ _3"></span>to <span class="_ _9"></span>worry <span class="_ _3"></span>about <span class="_ _9"></span>a <span class="_ _3"></span>program <span class="_ _3"></span>that <span class="_ _9"></span>terminates <span class="_ _3"></span>without <span class="_ _9"></span>releasing <span class="_ _3"></span>the</div><div class="t m0 x41 h2b y1cb2 ff19 fsf fc0 sc0 ls0 ws0">semaphores <span class="_ _42"> </span>it <span class="_ _e"> </span>has <span class="_ _53"> </span>been <span class="_ _e"> </span>allocated.<span class="_ _65"> </span>The<span class="_ _4b"> </span><span class="ff1b">undo<span class="_ _4b"> </span></span>featur<span class="ls1240">et<span class="_ _55"></span><span class="ls0">hat <span class="_ _53"> </span>we <span class="_ _e"> </span>describe <span class="_ _53"> </span>later <span class="_ _e"> </span>is</span></span></div><div class="t m0 x41 h2a y1cb3 ff19 fsf fc0 sc0 ls0 ws0">supposed to handle this.</div><div class="t m0 x3f h26 y1d9a ff19 fsf fc0 sc0 ls0 ws0">The kernel maintains a<span class="_"> </span><span class="ff1a">semid_ds<span class="_ _80"> </span></span>structur<span class="ls44">ef<span class="_ _4f"></span><span class="ls0">or each semaphor<span class="ls44">es<span class="_ _d"></span><span class="ls0">et:</span></span></span></span></div><div class="t m0 x3f h57 y447c ff1a fs2d fc0 sc0 ls0 ws0">struct semid_ds {</div><div class="t m0 xf4 h57 y447d ff1a fs2d fc0 sc0 ls0 ws0">struct ipc_perm<span class="_ _d9"> </span>sem_perm; <span class="_"> </span>/*<span class="_"> </span>see Section 15.6.2 */</div><div class="t m0 xf4 h57 y447e ff1a fs2d fc0 sc0 ls0 ws0">unsigned short<span class="_ _68"> </span>sem_nsems; /* # of semaphores in set */</div><div class="t m0 xf4 h57 y447f ff1a fs2d fc0 sc0 ls0 ws0">time_t <span class="_ _74"> </span>sem_otime;<span class="_"> </span>/* last-semop() time */</div><div class="t m0 xf4 h57 y4480 ff1a fs2d fc0 sc0 ls0 ws0">time_t <span class="_ _74"> </span>sem_ctime;<span class="_"> </span>/* last-change time */</div><div class="t m0 xf4 h57 y4481 ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 xf4 h57 y4482 ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 xf4 h57 y4483 ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 x3f h57 y4484 ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h2a y4485 ff19 fsf fc0 sc0 ls0 ws0">The Single <span class="_ _2"></span>UNIX Speciﬁcation <span class="_ _2"></span>deﬁnes the <span class="_ _2"></span>ﬁelds <span class="_ _2"></span>shown, but <span class="_ _2"></span>implementations can <span class="_ _2"></span>deﬁne</div><div class="t m0 x32 h26 y4486 ff19 fsf fc0 sc0 ls0 ws0">additional members in the<span class="_"> </span><span class="ff1a">semid_ds<span class="_ _80"> </span></span>structure.</div><div class="t m0 x3f h2a y4487 ff19 fsf fc0 sc0 ls0 ws0">Each <span class="_ _23"></span>semaphor<span class="_ _0"></span>e<span class="_ _45"> </span>is<span class="_ _35"> </span>repr<span class="_ _1"></span>esented <span class="_ _23"> </span>by <span class="_ _23"></span>an <span class="_ _23"></span>anonymous <span class="_ _9"></span>structur<span class="ls1241">ec<span class="_ _43"></span><span class="ls0">ontaining <span class="_ _23"> </span>at <span class="_ _23"></span>least <span class="_ _23"></span>the</span></span></div><div class="t m0 x32 h2a y4488 ff19 fsf fc0 sc0 ls0 ws0">following members:</div><div class="t m0 x3f h57 y4489 ff1a fs2d fc0 sc0 ls0 ws0">struct {</div><div class="t m0 xf4 h57 y448a ff1a fs2d fc0 sc0 ls0 ws0">unsigned short<span class="_ _d9"> </span>semval; <span class="_ _3a"> </span>/*<span class="_"> </span>semaphore value, always &gt;= 0 */</div><div class="t m0 xf4 h57 y448b ff1a fs2d fc0 sc0 ls0 ws0">pid_t <span class="_ _74"> </span>sempid;<span class="_ _87"> </span>/* pid for last operation */</div><div class="t m0 xf4 h57 y448c ff1a fs2d fc0 sc0 ls0 ws0">unsigned short<span class="_ _d9"> </span>semncnt; <span class="_"> </span>/*<span class="_"> </span><span class="ls15c">#p<span class="_ _5b"></span><span class="ls0">rocesses awaiting semval&gt;curval */</span></span></div><div class="t m0 xf4 h57 y448d ff1a fs2d fc0 sc0 ls0 ws0">unsigned short<span class="_ _d9"> </span>semzcnt; <span class="_"> </span>/*<span class="_"> </span><span class="ls15c">#p<span class="_ _5b"></span><span class="ls0">rocesses awaiting semval==0 */</span></span></div><div class="t m0 xf4 h57 y448e ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 xf4 h57 y448f ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 xf4 h57 y4490 ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 x3f h57 y4491 ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h2a y4492 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">5.28 lists the system limits that affect semaphor<span class="ls44">es<span class="_ _4f"></span><span class="ls0">ets.</span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
