<div id="pf2a2" class="pf w4 h1f" data-page-no="2a2"><div class="pc pc2a2 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2a2.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">640<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>IPC<span class="_ _e8"> </span>Chapter <span class="_"> </span>17</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _e"> </span>server <span class="_ _e"> </span>blocks <span class="_ _e"> </span>in <span class="_"> </span>the <span class="_ _53"> </span>call <span class="_ _e"> </span>to<span class="_ _59"> </span><span class="ff1a">accept</span><span class="lsb9">,w<span class="_ _55"></span><span class="ls0">aiting <span class="_ _e"> </span>for <span class="_ _e"> </span>a <span class="_ _e"> </span>client <span class="_"> </span>to <span class="_ _53"> </span>call<span class="_ _4b"> </span><span class="ff1a">cli_conn</span>.</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">When<span class="_ _45"> </span><span class="ff1a">accept<span class="_ _35"> </span></span><span class="ls45">re</span>turns, <span class="_ _23"></span>its <span class="_ _23"></span>return <span class="_ _9"></span>value <span class="_ _23"></span>is <span class="_ _9"></span>a <span class="_ _23"></span>brand-new <span class="_ _23"></span>descriptor <span class="_ _9"></span>that <span class="_ _23"> </span>is <span class="_ _23"></span>connected <span class="_ _9"></span>to</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _23"></span>client.<span class="_ _51"> </span>Additionally<span class="_ _4"></span><span class="ls12a2">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>pathname <span class="_ _23"> </span>that <span class="_ _23"> </span>the <span class="_ _23"> </span>client <span class="_ _23"> </span>assigned <span class="_ _23"> </span>to <span class="_ _23"> </span>its <span class="_ _23"> </span>socket <span class="_ _23"> </span>(the <span class="_ _23"> </span>name</span></span></div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_"> </span>contained <span class="_"> </span>the <span class="_"> </span>client’s <span class="_ _66"> </span>process <span class="_"> </span>ID) <span class="_"> </span>is <span class="_"> </span>returned <span class="_"> </span>by<span class="_ _46"> </span><span class="ff1a">accept</span><span class="ls13bb">,t<span class="_ _4a"></span><span class="ls0">hrough <span class="_"> </span>the <span class="_"> </span>second</span></span></div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">argument <span class="_ _42"> </span>(the <span class="_ _53"> </span>pointer <span class="_ _53"> </span>to <span class="_ _e"> </span>the<span class="_ _44"> </span><span class="ff1a">sockaddr_un<span class="_ _4b"> </span></span>structure). <span class="_ _44"> </span>W<span class="_ _6"></span><span class="ls110b">ec<span class="_ _c"></span><span class="ls0">opy <span class="_ _53"> </span>this <span class="_ _53"> </span>pathname <span class="_ _53"> </span>and</span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">ensur<span class="ls13bc">et<span class="_ _55"></span><span class="ls0">hat <span class="_ _53"> </span>it <span class="_ _53"> </span>is <span class="_ _42"> </span>null <span class="_ _53"> </span>terminated <span class="_ _53"> </span>(if <span class="_ _42"> </span>the <span class="_ _53"> </span>pathname <span class="_ _42"> </span>takes <span class="_ _53"> </span>up <span class="_ _53"> </span>all <span class="_ _42"> </span>available <span class="_ _53"> </span>space <span class="_ _42"> </span>in <span class="_ _53"> </span>the</span></span></div><div class="t m0 x32 h26 y135 ff1a fsf fc0 sc0 ls0 ws0">sun_path<span class="_"> </span><span class="ff19">member <span class="_ _45"> </span>of <span class="_ _45"> </span>the<span class="_ _51"> </span></span>sockaddr_un<span class="_"> </span><span class="ff19">structur<span class="_ _0"></span>e, <span class="_ _45"> </span>ther<span class="ls13bd">ew<span class="_ _7"></span><span class="ls0">on’t <span class="_ _35"> </span>be <span class="_ _45"> </span>room <span class="_ _45"> </span>for <span class="_ _45"> </span>the</span></span></span></div><div class="t m0 x32 h26 y136 ff19 fsf fc0 sc0 ls0 ws0">terminating <span class="_ _e"> </span>null <span class="_ _e"> </span>byte).<span class="_ _48"> </span>Then <span class="_ _e"> </span>we <span class="_ _e"> </span>call<span class="_ _59"> </span><span class="ff1a">stat<span class="_ _4b"> </span></span>to <span class="_ _e"> </span>verify <span class="_"> </span>that <span class="_ _53"> </span>the <span class="_ _e"> </span>pathname <span class="_ _e"> </span>is <span class="_"> </span>indeed <span class="_ _53"> </span>a</div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">socket <span class="_ _2"></span>and <span class="_ _3"></span>that <span class="_ _3"></span>the <span class="_ _3"></span>permissions <span class="_ _3"></span>allow <span class="_ _3"></span>only <span class="_ _3"></span>user-r<span class="_ _0"></span>ead, <span class="_ _2"></span>user-write, <span class="_ _2"></span>and <span class="_ _3"></span>user-execute. <span class="_ _47"> </span>W<span class="_ _6"></span>e</div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">also <span class="_ _3"></span>verify <span class="_ _3"></span>that <span class="_ _3"></span>the <span class="_ _3"></span>three <span class="_ _2"></span>times <span class="_ _3"></span>associated <span class="_ _3"></span>with <span class="_ _3"></span>the <span class="_ _3"></span>socket <span class="_ _3"></span>are<span class="_ _47"> </span>no<span class="_ _47"> </span>older <span class="_ _3"></span>than <span class="_ _3"></span>30 <span class="_ _3"></span>seconds.</div><div class="t m0 x32 h26 y139 ff19 fsf fc0 sc0 ls0 ws0">(Recall <span class="_ _23"> </span>from <span class="_ _23"> </span>Section <span class="_ _42"> </span>6.10 <span class="_ _23"> </span>that <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">time<span class="_ _44"> </span></span>function <span class="_ _23"> </span>returns <span class="_ _23"> </span>the <span class="_ _42"> </span>current <span class="_ _23"></span>time <span class="_ _23"> </span>and <span class="_ _42"> </span>date <span class="_ _23"> </span>in</div><div class="t m0 x32 h2a y13a ff19 fsf fc0 sc0 ls0 ws0">seconds past the Epoch.)</div><div class="t m0 x3f h2a y254 ff19 fsf fc0 sc0 ls0 ws0">If all <span class="_ _2"></span>these checks <span class="_ _2"></span>ar<span class="ls24b">eO<span class="_ _4f"></span><span class="ls0">K, <span class="_ _2"></span>we assume <span class="_ _2"></span>that the <span class="_ _2"></span>identity of <span class="_ _2"></span>the <span class="_ _2"></span>client (its <span class="_ _2"></span>effective user</span></span></div><div class="t m0 x32 h2a y255 ff19 fsf fc0 sc0 ls0 ws0">ID) <span class="_ _2"></span>is <span class="_ _3"></span>the <span class="_ _3"></span>owner <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>socket.<span class="_ _61"> </span>Although <span class="_ _3"></span>this <span class="_ _2"></span>check <span class="_ _3"></span>isn’t <span class="_ _3"></span>perfect, <span class="_ _2"></span>it’s <span class="_ _3"></span>the <span class="_ _3"></span>best <span class="_ _2"></span>we <span class="_ _3"></span>can <span class="_ _3"></span>do</div><div class="t m0 x32 h2a y13b ff19 fsf fc0 sc0 ls0 ws0">with <span class="_ _3"></span>current <span class="_ _2"></span>systems.<span class="_ _5a"> </span>(It <span class="_ _3"></span>would <span class="_ _3"></span>be <span class="_ _3"></span>better <span class="_ _3"></span>if <span class="_ _9"></span>the <span class="_ _3"></span>kernel <span class="_ _3"></span>returned <span class="_ _3"></span>the <span class="_ _3"></span>effective <span class="_ _3"></span>user <span class="_ _3"></span>ID <span class="_ _3"></span>to</div><div class="t m0 x32 h26 y13c ff19 fsf fc0 sc0 ls0 ws0">us through a parameter to<span class="_"> </span><span class="ff1a">accept</span>.)</div><div class="t m0 x3f h26 y256 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _23"></span>client <span class="_ _23"></span>initiates <span class="_ _23"></span>the <span class="_ _23"></span>connection <span class="_ _23"></span>to <span class="_ _23"></span>the <span class="_ _23"></span>server <span class="_ _23"></span>by <span class="_ _23"></span>calling <span class="_ _23"></span>the<span class="_ _35"> </span><span class="ff1a">cli_conn<span class="_ _45"> </span></span>function</div><div class="t m0 x32 h2a y257 ff19 fsf fc0 sc0 ls0 ws0">(Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">7.10).</span></span></div><div class="t m0 x32 h4e y4bd7 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y4bd8 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x32 h4e y4bd9 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/un.h&gt;</div><div class="t m0 x32 h4e y4bda ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h4e y4bdb ff1a fs28 fc0 sc0 ls0 ws0">#define CLI_PATH<span class="_ _15"> </span>&quot;/var/tmp/&quot;</div><div class="t m0 x32 h4e y4bdc ff1a fs28 fc0 sc0 ls0 ws0">#define CLI_PERM<span class="_ _15"> </span>S_IRWXU <span class="_ _186"> </span>/*<span class="_"> </span>rwx for user only */</div><div class="t m0 x32 h4e y4bdd ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h4e y4bde ff1a fs28 fc0 sc0 ls1b6 ws0">*C<span class="_ _1d"></span><span class="ls0">reate a client endpoint and connect to a server.</span></div><div class="t m0 x140 h4e y4bdf ff1a fs28 fc0 sc0 ls1b6 ws0">*R<span class="_ _1d"></span><span class="ls0">eturns fd if all OK, &lt;0 on error.</span></div><div class="t m0 x140 h4e y4be0 ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h4e y4be1 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y4be2 ff1a fs28 fc0 sc0 ls0 ws0">cli_conn(const char *name)</div><div class="t m0 x32 h4e y4be3 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y4be4 ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>fd,<span class="_"> </span>len, err, rval;</div><div class="t m0 x8a h4e y4be5 ff1a fs28 fc0 sc0 ls0 ws0">struct sockaddr_un<span class="_ _d9"> </span>un, sun;</div><div class="t m0 x8a h4e y4be6 ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>do_unlink<span class="_"> </span><span class="ls1b6">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x8a h4e y4be7 ff1a fs28 fc0 sc0 ls0 ws0">if (strlen(name) &gt;= sizeof(un.sun_path)) {</div><div class="t m0 x9d h4e y4be8 ff1a fs28 fc0 sc0 ls0 ws0">errno = ENAMETOOLONG;</div><div class="t m0 x9d h4e y4be9 ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h4e y4bea ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h4e y4beb ff1a fs28 fc0 sc0 ls0 ws0">/* create a UNIX domain stream socket */</div><div class="t m0 x8a h4e y4bec ff1a fs28 fc0 sc0 ls0 ws0">if ((fd = socket(AF_UNIX, SOCK_STREAM, 0)) &lt; 0)</div><div class="t m0 x9d h4e y4bed ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h4e y4bee ff1a fs28 fc0 sc0 ls0 ws0">/* fill socket address structure with our address */</div><div class="t m0 x8a h4e y4bef ff1a fs28 fc0 sc0 ls0 ws0">memset(&amp;un, 0, sizeof(un));</div><div class="t m0 x8a h4e y4bf0 ff1a fs28 fc0 sc0 ls0 ws0">un.sun_family = AF_UNIX;</div><div class="t m0 x8a h4e y4bf1 ff1a fs28 fc0 sc0 ls0 ws0">sprintf(un.sun_path, &quot;%s%05ld&quot;, CLI_PATH, (long)getpid());</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
