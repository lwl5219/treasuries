<div id="pf2df" class="pf w4 h1f" data-page-no="2df"><div class="pc pc2df w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2df.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>18.10<span class="_ _23a"> </span>Canonical <span class="_"> </span>Mode<span class="_ _1b"> </span><span class="ff18">701</span></div><div class="t m0 x3f h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;signal.h&gt;</div><div class="t m0 x3f h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;stdio.h&gt;</div><div class="t m0 x3f h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;termios.h&gt;</div><div class="t m0 x3f h57 y3c2 ff1a fs2d fc0 sc0 ls0 ws0">#define MAX_PASS_LEN<span class="_ _15"> </span><span class="ls5d1">8/<span class="_ _12f"></span><span class="ls15c">*m<span class="_ _5b"></span><span class="ls0">ax #chars for user to enter */</span></span></span></div><div class="t m0 x3f h57 y1d34 ff1a fs2d fc0 sc0 ls0 ws0">char *</div><div class="t m0 x3f h57 y158d ff1a fs2d fc0 sc0 ls0 ws0">getpass(const char *prompt)</div><div class="t m0 x3f h57 y158e ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 xc2 h57 y158f ff1a fs2d fc0 sc0 ls0 ws0">static char<span class="_ _8a"> </span>buf[MAX_PASS_LEN + 1];<span class="_ _d9"> </span>/* null byte at end */</div><div class="t m0 xc2 h57 y3c7 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _bd"> </span>*ptr;</div><div class="t m0 xc2 h57 y3c8 ff1a fs2d fc0 sc0 ls0 ws0">sigset_t <span class="_ _b7"> </span>sig,<span class="_"> </span>osig;</div><div class="t m0 xc2 h57 y3c9 ff1a fs2d fc0 sc0 ls0 ws0">struct termios<span class="_ _d9"> </span>ts, ots;</div><div class="t m0 xc2 h57 y3ca ff1a fs2d fc0 sc0 ls0 ws0">FILE <span class="_ _bd"> </span>*fp;</div><div class="t m0 xc2 h57 y1cc6 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>c;</div><div class="t m0 xc2 h57 y3cc ff1a fs2d fc0 sc0 ls0 ws0">if ((fp = fopen(ctermid(NULL), &quot;r+&quot;)) == NULL)</div><div class="t m0 x16e h57 y3cd ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 xc2 h57 y3ce ff1a fs2d fc0 sc0 ls0 ws0">setbuf(fp, NULL);</div><div class="t m0 xc2 h57 y1f3c ff1a fs2d fc0 sc0 ls0 ws0">sigemptyset(&amp;sig);</div><div class="t m0 xc2 h57 y1f3d ff1a fs2d fc0 sc0 ls0 ws0">sigaddset(&amp;sig, SIGINT);<span class="_ _186"> </span>/* block SIGINT */</div><div class="t m0 xc2 h57 y1f3e ff1a fs2d fc0 sc0 ls0 ws0">sigaddset(&amp;sig, SIGTSTP);<span class="_ _b7"> </span>/* block SIGTSTP */</div><div class="t m0 xc2 h57 y3d2 ff1a fs2d fc0 sc0 ls0 ws0">sigprocmask(SIG_BLOCK, &amp;sig, &amp;osig);<span class="_ _15"> </span>/* and save mask */</div><div class="t m0 xc2 h57 y1d3f ff1a fs2d fc0 sc0 ls0 ws0">tcgetattr(fileno(fp), &amp;ts);<span class="_ _8a"> </span>/* save tty state */</div><div class="t m0 xc2 h57 y2aad ff1a fs2d fc0 sc0 ls0 ws0">ots = ts;<span class="_ _1e4"> </span>/* structure copy */</div><div class="t m0 xc2 h57 y2aae ff1a fs2d fc0 sc0 ls0 ws0">ts.c_lflag &amp;= ˜(ECHO | ECHOE | ECHOK | ECHONL);</div><div class="t m0 xc2 h57 y2aaf ff1a fs2d fc0 sc0 ls0 ws0">tcsetattr(fileno(fp), TCSAFLUSH, &amp;ts);</div><div class="t m0 xc2 h57 y2ba7 ff1a fs2d fc0 sc0 ls0 ws0">fputs(prompt, fp);</div><div class="t m0 xc2 h57 y1d44 ff1a fs2d fc0 sc0 ls0 ws0">ptr = buf;</div><div class="t m0 xc2 h57 y27ee ff1a fs2d fc0 sc0 ls0 ws0">while ((c = getc(fp)) != EOF &amp;&amp; c != ’\n’)</div><div class="t m0 x16e h57 y27ef ff1a fs2d fc0 sc0 ls0 ws0">if (ptr &lt; &amp;buf[MAX_PASS_LEN])</div><div class="t m0 xda h57 y27f0 ff1a fs2d fc0 sc0 ls0 ws0">*ptr++ = c;</div><div class="t m0 xc2 h57 y27f1 ff1a fs2d fc0 sc0 ls0 ws0">*ptr = 0;<span class="_ _bd"> </span>/* null terminate */</div><div class="t m0 xc2 h57 y27f2 ff1a fs2d fc0 sc0 ls0 ws0">putc(’\n’, fp);<span class="_ _8a"> </span>/* we echo a newline */</div><div class="t m0 xc2 h57 y45c7 ff1a fs2d fc0 sc0 ls0 ws0">tcsetattr(fileno(fp), TCSAFLUSH, &amp;ots); /* restore TTY state */</div><div class="t m0 xc2 h57 y45c8 ff1a fs2d fc0 sc0 ls0 ws0">sigprocmask(SIG_SETMASK, &amp;osig, NULL);<span class="_ _d9"> </span>/* restore mask */</div><div class="t m0 xc2 h57 y45c9 ff1a fs2d fc0 sc0 ls0 ws0">fclose(fp); <span class="_ _186"> </span>/*<span class="_"> </span>done with /dev/tty */</div><div class="t m0 xc2 h57 y45ca ff1a fs2d fc0 sc0 ls0 ws0">return(buf);</div><div class="t m0 x3f h57 y5172 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xa6 h5e y5173 ff18 fs10 fc0 sc0 ls0 ws0">Figure 18.17<span class="_ _5a"> </span><span class="ff19">Implementation of<span class="_"> </span><span class="ff1a">getpass<span class="_ _e"> </span></span>function</span></div><div class="t m0 x3f h4d y5174 ff19 fs26 fc0 sc0 ls1503 ws0">•W<span class="_ _30b"></span><span class="ls6b2">eb<span class="_ _8"></span><span class="ls0">lock <span class="_ _3"></span>the <span class="_ _3"></span>two <span class="_ _9"></span>signals<span class="_ _47"> </span><span class="ff1a">SIGINT<span class="_ _45"> </span></span>and<span class="_ _47"> </span><span class="ff1a">SIGTSTP</span><span class="ls1504">.I<span class="_ _62"></span><span class="ls0">f<span class="_ _45"> </span>we<span class="_ _47"> </span>didn’t <span class="_ _3"></span>do <span class="_ _9"></span>this, <span class="_ _3"></span>entering</span></span></span></span></div><div class="t m0 x52 h49 y5175 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _66"> </span>INTR <span class="_ _47"> </span>character <span class="_ _66"> </span>would <span class="_ _47"> </span>abort <span class="_ _47"> </span>the <span class="_ _66"> </span>program <span class="_ _66"> </span>and <span class="_ _47"> </span>leave <span class="_ _66"> </span>the <span class="_ _47"> </span>terminal <span class="_ _66"> </span>with</div><div class="t m0 x52 h49 y5176 ff19 fs26 fc0 sc0 ls0 ws0">echoing <span class="_ _35"> </span>disabled.<span class="_ _98"> </span>Similarly<span class="_ _4"></span><span class="ls1505">,e<span class="_ _7"></span><span class="ls0">ntering <span class="_ _44"> </span>the <span class="_ _35"> </span>SUSP <span class="_ _35"> </span>character <span class="_ _35"> </span>would <span class="_ _44"> </span>stop <span class="_ _35"> </span>the</span></span></div><div class="t m0 x52 h49 y5177 ff19 fs26 fc0 sc0 ls0 ws0">program <span class="_ _2"></span>and <span class="_ _3"></span>return <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>shell <span class="_ _3"></span>with <span class="_ _3"></span>echoing <span class="_ _3"></span>disabled.<span class="_ _16"> </span><span class="ls164">We <span class="_ _80"> </span>c<span class="_ _9"></span></span>hoose <span class="_ _3"></span>to <span class="_ _3"></span>block <span class="_ _3"></span>the</div><div class="t m0 x52 h49 y5178 ff19 fs26 fc0 sc0 ls0 ws0">signals <span class="_"> </span>while <span class="_"> </span>we <span class="_ _e"> </span>have <span class="_"> </span>echoing <span class="_"> </span>disabled.<span class="_ _48"> </span>If <span class="_"> </span>they <span class="_"> </span>ar<span class="_ _0"></span><span class="ls1506">eg<span class="_ _4a"></span><span class="ls0">enerated <span class="_"> </span>while <span class="_"> </span>we’r<span class="_ _0"></span>e</span></span></div><div class="t m0 x52 h49 y5179 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ading <span class="_ _23"> </span>the <span class="_ _23"></span>password, <span class="_ _9"></span>they <span class="_ _23"> </span>ar<span class="lse9f">eh<span class="_ _43"></span><span class="ls0">eld <span class="_ _23"> </span>until <span class="_ _23"></span>we <span class="_ _23"></span>return. <span class="_ _45"> </span>Ther<span class="lse9f">ea<span class="_ _43"></span><span class="lscc">re <span class="_ _42"> </span>o<span class="ls0">ther <span class="_ _23"> </span>ways <span class="_ _23"> </span>to</span></span></span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
