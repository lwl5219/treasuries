<div id="pf3cd" class="pf w4 h1f" data-page-no="3cd"><div class="pc pc3cd w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg3cd.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Appendix <span class="_"> </span>C<span class="_ _89"> </span>Chapter <span class="_"> </span>16<span class="_ _54"> </span>Solutions<span class="_ _1b"> </span><span class="ff18">939</span></div><div class="t m0 x32 h2a y12f ff18 fsf fc0 sc0 ls0 ws0">16.3<span class="_ _210"> </span><span class="ff19">For <span class="_ _23"> </span>each <span class="_ _23"></span>endpoint <span class="_ _9"></span>we <span class="_ _23"></span>will <span class="_ _23"></span>be <span class="_ _9"></span>listening <span class="_ _23"></span>on, <span class="_ _9"></span>we <span class="_ _23"> </span>need <span class="_ _23"></span>to <span class="_ _9"></span>bind <span class="_ _23"></span>the <span class="_ _9"></span>proper <span class="_ _9"></span>address</span></div><div class="t m0 xe2 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">and recor<span class="_ _0"></span>d<span class="_"> </span>an<span class="_"> </span>entry in <span class="_ _2"></span>an<span class="_"> </span><span class="ff1a">fd_set<span class="_ _66"> </span></span>structur<span class="lsa68">ec<span class="_ _4f"></span><span class="ls0">orresponding to each ﬁle descriptor<span class="_ _1"></span>.</span></span></div><div class="t m0 xe2 h26 y131 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>w<span class="_ _23"></span><span class="ls0">ill use<span class="_ _66"> </span><span class="ff1a">select<span class="_ _66"> </span></span>to <span class="_ _2"></span>wait <span class="_ _2"></span>for connect <span class="_ _2"></span>requests to <span class="_ _2"></span>arrive on <span class="_ _2"></span>multiple <span class="_ _2"></span>endpoints.</span></div><div class="t m0 xe2 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">Recall <span class="_ _2"></span>from Section <span class="_ _3"></span>16.4 <span class="_ _2"></span>that <span class="_ _2"></span>a <span class="_ _3"></span>passive <span class="_ _2"></span>endpoint <span class="_ _2"></span>will <span class="_ _2"></span>appear <span class="_ _3"></span>to <span class="_ _2"></span>be <span class="_ _2"></span>readable <span class="_ _2"></span>when</div><div class="t m0 xe2 h2a y133 ff19 fsf fc0 sc0 ls187e ws0">ac<span class="_ _55"></span><span class="ls0">onnect <span class="_ _e"> </span>request <span class="_ _53"> </span>arrives <span class="_ _53"> </span>on <span class="_ _e"> </span>it.<span class="_ _65"> </span>When <span class="_ _53"> </span>a <span class="_ _e"> </span>connect <span class="_ _53"> </span>request <span class="_ _53"> </span>does <span class="_ _53"> </span>arrive, <span class="_ _e"> </span>we <span class="_ _53"> </span>will</span></div><div class="t m0 xe2 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">accept the request and pr<span class="_ _0"></span>ocess it as befor<span class="_ _0"></span>e.</div><div class="t m0 x32 h26 y2915 ff18 fsf fc0 sc0 ls0 ws0">16.5<span class="_ _210"> </span><span class="ff19">In <span class="_ _e"> </span>the<span class="_ _4b"> </span><span class="ff1a">main<span class="_ _4b"> </span></span>procedur<span class="_ _0"></span>e, <span class="_ _53"> </span>we <span class="_ _53"> </span>need <span class="_ _e"> </span>to <span class="_ _53"> </span>arrange <span class="_ _53"> </span>to <span class="_ _e"> </span>catch<span class="_ _4b"> </span><span class="ff1a">SIGCHLD<span class="_ _4b"> </span></span>by <span class="_ _53"> </span>calling <span class="_ _53"> </span>our</span></div><div class="t m0 xe2 h26 y2937 ff1a fsf fc0 sc0 ls0 ws0">signal<span class="_ _80"> </span><span class="ff19">function <span class="_ _2"></span>(Figur<span class="ls8a7">e1<span class="_ _4f"></span><span class="ls0">0.18), which <span class="_ _2"></span>will use<span class="_"> </span><span class="ff1a">sigaction<span class="_ _66"> </span></span>to <span class="_ _2"></span>install the handler</span></span></span></div><div class="t m0 xe2 h2a y2938 ff19 fsf fc0 sc0 ls0 ws0">specifying the <span class="_ _2"></span>restartable system <span class="_ _2"></span>call option.<span class="_ _61"> </span>Next, we <span class="_ _2"></span>need <span class="_ _2"></span>to <span class="_ _2"></span>remove the call <span class="_ _2"></span>to</div><div class="t m0 xe2 h26 yeb6 ff1a fsf fc0 sc0 ls0 ws0">waitpid<span class="_ _46"> </span><span class="ff19">from <span class="_"> </span>our<span class="_ _61"> </span></span>serve<span class="_ _61"> </span><span class="ff19">function. <span class="_ _61"> </span>After<span class="_ _46"> </span></span>fork<span class="ff19">ing <span class="_ _47"> </span>the <span class="_"> </span>child <span class="_ _47"> </span>to <span class="_"> </span>service <span class="_ _47"> </span>the</span></div><div class="t m0 xe2 h2a yeb7 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">quest, <span class="_ _47"> </span>the <span class="_ _47"> </span>parent <span class="_"> </span>closes <span class="_ _47"> </span>the <span class="_ _47"> </span>new <span class="_ _47"> </span>ﬁle <span class="_ _47"> </span>descriptor <span class="_ _66"> </span>and <span class="_ _47"> </span>resumes <span class="_ _66"> </span>listening <span class="_ _47"> </span>for</span></div><div class="t m0 xe2 h26 yeb8 ff19 fsf fc0 sc0 ls0 ws0">additional <span class="_ _9"></span>connect <span class="_ _23"></span>requests. <span class="_ _45"> </span>Finally<span class="_ _4"></span>,<span class="_ _35"> </span>we<span class="_ _45"> </span>need <span class="_ _23"></span>a <span class="_ _9"></span>signal <span class="_ _23"></span>handler <span class="_ _9"></span>for<span class="_ _35"> </span><span class="ff1a">SIGCHLD</span><span class="ls187f">,a<span class="_ _b"></span><span class="ls0">s</span></span></div><div class="t m0 xe2 h2a yeb9 ff19 fsf fc0 sc0 ls0 ws0">follows:</div><div class="t m0 xd8 h57 y62c6 ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 xd8 h57 y62c7 ff1a fs2d fc0 sc0 ls0 ws0">sigchld(int signo)</div><div class="t m0 xd8 h57 y62c8 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 xb1 h57 y62c9 ff1a fs2d fc0 sc0 ls0 ws0">while (waitpid((pid_t)-1, NULL, WNOHANG) &gt; 0)</div><div class="t m0 x4 h57 y62ca ff1a fs2d fc0 sc0 ls0 ws0">;</div><div class="t m0 xd8 h57 y62cb ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h2a y62cc ff18 fsf fc0 sc0 ls0 ws0">16.6<span class="_ _210"> </span><span class="ff19 ls5f">To <span class="_ _e"> </span>e<span class="_ _9"></span><span class="ls0">nable <span class="_ _2"></span>asynchronous socket I/O, <span class="_ _2"></span>we need <span class="_ _2"></span>to establish <span class="_ _2"></span>socket ownership <span class="_ _2"></span>using</span></span></div><div class="t m0 xe2 h26 y62cd ff19 fsf fc0 sc0 ls0 ws0">the<span class="_ _47"> </span><span class="ff1a">F_SETOWN <span class="_ _4f"></span>fcntl<span class="_ _47"> </span><span class="ff19">command, <span class="_ _9"></span>and <span class="_ _3"></span>then <span class="_ _3"></span>enable <span class="_ _9"></span>asynchronous <span class="_ _2"></span>signaling <span class="_ _9"></span>using</span></span></div><div class="t m0 xe2 h26 y62ce ff19 fsf fc0 sc0 ls0 ws0">the<span class="_ _5a"> </span><span class="ff1a">FIOASYNC ioctl<span class="_"> </span></span>command. <span class="_ _5a"> </span>T<span class="_ _6"></span><span class="lsb64">od<span class="_ _26"></span><span class="ls0">isable <span class="_ _45"> </span>asynchronous <span class="_ _45"> </span>socket <span class="_ _45"> </span>I/O, <span class="_ _45"> </span>we</span></span></div><div class="t m0 xe2 h26 y62cf ff19 fsf fc0 sc0 ls0 ws0">simply <span class="_ _9"></span>need <span class="_ _9"></span>to <span class="_ _9"></span>disable <span class="_ _9"></span>asynchronous <span class="_ _3"></span>signaling.<span class="_ _5a"> </span>The <span class="_ _23"></span>r<span class="_ _0"></span>eason <span class="_ _9"></span>we <span class="_ _9"></span>mix<span class="_ _45"> </span><span class="ff1a">fcntl<span class="_ _45"> </span></span>and</div><div class="t m0 xe2 h26 y62d0 ff1a fsf fc0 sc0 ls0 ws0">ioctl<span class="_ _44"> </span><span class="ff19">commands <span class="_ _53"> </span>is <span class="_ _42"> </span>to <span class="_ _53"> </span>ﬁnd <span class="_ _53"> </span>the <span class="_ _53"> </span>methods <span class="_ _42"> </span>that <span class="_ _53"> </span>ar<span class="ls1880">em<span class="_ _c"></span><span class="ls0">ost <span class="_ _53"> </span>portable.<span class="_ _54"> </span>The <span class="_ _53"> </span>code <span class="_ _53"> </span>is</span></span></span></div><div class="t m0 xe2 h2a y62d1 ff19 fsf fc0 sc0 ls0 ws0">shown in Figur<span class="ls44">eC<span class="_ _4f"></span><span class="ls0">.23.</span></span></div><div class="t m0 xe2 h4e y62d2 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 xe2 h4e y62d3 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 xe2 h4e y62d4 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 xe2 h4e y62d5 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 xe2 h4e y62d6 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/ioctl.h&gt;</div><div class="t m0 xe2 h4e y62d7 ff1a fs28 fc0 sc0 ls0 ws0">#if defined(BSD) || defined(MACOS) || defined(SOLARIS)</div><div class="t m0 xe2 h4e y62d8 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/filio.h&gt;</div><div class="t m0 xe2 h4e y62d9 ff1a fs28 fc0 sc0 ls0 ws0">#endif</div><div class="t m0 xe2 h4e y62da ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 xe2 h4e y62db ff1a fs28 fc0 sc0 ls0 ws0">setasync(int sockfd)</div><div class="t m0 xe2 h4e y62dc ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x60 h4e y62dd ff1a fs28 fc0 sc0 ls0 ws0">int n;</div><div class="t m0 x60 h4e y62de ff1a fs28 fc0 sc0 ls0 ws0">if (fcntl(sockfd, F_SETOWN, getpid()) &lt; 0)</div><div class="t m0 xb9 h4e y62df ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x60 h4e y62e0 ff1a fs28 fc0 sc0 ls1b6 ws0">n=1<span class="_ _1d"></span><span class="ls0">;</span></div><div class="t m0 x60 h4e y62e1 ff1a fs28 fc0 sc0 ls0 ws0">if (ioctl(sockfd, FIOASYNC, &amp;n) &lt; 0)</div><div class="t m0 xb9 h4e y62e2 ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x60 h4e y62e3 ff1a fs28 fc0 sc0 ls0 ws0">return(0);</div><div class="t m0 xe2 h4e y62e4 ff1a fs28 fc0 sc0 ls0 ws0">}</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
