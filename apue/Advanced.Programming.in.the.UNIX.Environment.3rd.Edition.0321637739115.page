<div id="pf73" class="pf w4 h1f" data-page-no="73"><div class="pc pc73 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg73.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>3.13<span class="_ _c3"> </span><span class="ff1a">sync</span>,<span class="_ _44"> </span><span class="ff1a">fsync</span><span class="ls30a">,a<span class="_ _c"></span><span class="ls0">nd<span class="_ _4b"> </span><span class="ff1a">fdatasync<span class="_ _4b"> </span></span>Functions<span class="_ _1b"> </span><span class="ff18">81</span></span></span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">1.<span class="_ _5c"> </span><span class="ff1a">dup2<span class="_ _45"> </span></span>is <span class="_ _9"></span>an <span class="_ _9"></span>atomic <span class="_ _3"></span>operation, <span class="_ _9"></span>whereas <span class="_ _3"></span>the <span class="_ _9"></span>alternate <span class="_ _9"></span>form <span class="_ _9"></span>involves <span class="_ _9"></span>two <span class="_ _9"></span>function</div><div class="t m0 x41 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">calls. <span class="_ _47"> </span>It<span class="_ _47"> </span>is <span class="_ _9"></span>possible <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>latter <span class="_ _9"></span>case <span class="_ _3"></span>to <span class="_ _3"></span>have <span class="_ _9"></span>a <span class="_ _3"></span>signal <span class="_ _3"></span>catcher <span class="_ _3"></span>called <span class="_ _9"></span>between <span class="_ _3"></span>the</div><div class="t m0 x41 h26 y131 ff1a fsf fc0 sc0 ls0 ws0">close<span class="_ _59"> </span><span class="ff19">and <span class="_"> </span>the<span class="_ _46"> </span></span>fcntl<span class="_ _59"> </span><span class="ff19">that <span class="_"> </span>could <span class="_"> </span>modify <span class="_"> </span>the <span class="_"> </span>ﬁle <span class="_"> </span>descriptors.<span class="_ _48"> </span>(W<span class="_ _6"></span><span class="ls3fd">ed<span class="_ _4a"></span><span class="ls0">escribe</span></span></span></div><div class="t m0 x41 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">signals <span class="_"> </span>in <span class="_ _e"> </span>Chapter <span class="_"> </span>10.)<span class="_ _48"> </span>The <span class="_"> </span>same <span class="_"> </span>pr<span class="_ _1"></span>oblem <span class="_"> </span>could <span class="_"> </span>occur <span class="_ _e"> </span>if <span class="_"> </span>a <span class="_"> </span>dif<span class="_ _1"></span>ferent <span class="_"> </span>thr<span class="_ _0"></span>ead</div><div class="t m0 x41 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">changes the ﬁle descriptors.<span class="_ _59"> </span>(W<span class="_ _6"></span><span class="ls44">ed<span class="_ _5"></span><span class="ls0">escribe threads in Chapter 1<span class="_ _6"></span>1.)</span></span></div><div class="t m0 x3f h26 yc80 ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>Ther<span class="ls44">ea<span class="_ _4f"></span><span class="ls45">re <span class="_ _3"></span>s<span class="_ _2"></span><span class="ls0">ome<span class="_"> </span><span class="ff1a">errno<span class="_ _80"> </span></span>differences between<span class="_"> </span><span class="ff1a">dup2<span class="_ _e"> </span></span>and<span class="_"> </span><span class="ff1a">fcntl</span>.</span></span></span></div><div class="t m0 x76 h52 yc81 ff19 fs2a fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1a">dup2<span class="_ _e"> </span></span>system call originated with V<span class="_ _1"></span>ersion 7 and propagated through the BSD releases. <span class="_"> </span>The</div><div class="t m0 x76 h52 yc82 ff1a fs2a fc0 sc0 ls0 ws0">fcntl<span class="_ _66"> </span><span class="ff19">method <span class="_ _23"> </span>for <span class="_ _9"></span>duplicating <span class="_ _9"></span>ﬁle <span class="_ _9"></span>descriptors <span class="_ _9"></span>appeared <span class="_ _9"></span>with <span class="_ _9"></span>System <span class="_ _9"></span>III <span class="_ _9"></span>and <span class="_ _9"></span>continued <span class="_ _9"> </span>with</span></div><div class="t m0 x76 h52 yc83 ff19 fs2a fc0 sc0 ls0 ws0">System V<span class="_ _6"></span><span class="ls3fe">.S<span class="_ _c"></span><span class="ls0">VR3.2 <span class="_ _2"></span>picked up the<span class="_"> </span><span class="ff1a">dup2<span class="_ _e"> </span></span>function, and 4.2BSD picked up the<span class="_"> </span><span class="ff1a">fcntl<span class="_ _e"> </span></span>function and</span></span></div><div class="t m0 x76 h52 yc84 ff19 fs2a fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">F_DUPFD<span class="_ _53"> </span></span>functionality<span class="_ _6"></span><span class="ls10f">.P<span class="_ _43"></span><span class="ls0">OSIX.1 requires both<span class="_"> </span><span class="ff1a">dup2<span class="_ _53"> </span></span>and the<span class="_"> </span><span class="ff1a">F_DUPFD<span class="_ _53"> </span></span>featur<span class="lse9">eo<span class="_ _84"></span><span class="ls0">f<span class="_"> </span><span class="ff1a">fcntl</span>.</span></span></span></span></div><div class="t m0 x35 h75 yc85 ff16 fs2b fc0 sc0 ls0 ws0">3.13<span class="_ _6d"> </span><span class="ff1f">sync</span>,<span class="_ _54"> </span><span class="ff1f">fsync</span><span class="ls1c3">,a<span class="_ _52"></span><span class="ls0">nd<span class="_ _54"> </span><span class="ff1f">fdatasync<span class="_ _54"> </span></span>Functions</span></span></div><div class="t m0 x32 h2a yc86 ff19 fsf fc0 sc0 lsbc ws0">Tr<span class="_ _9"></span><span class="ls0">aditional <span class="_ _9"></span>implementations <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>UNIX <span class="_ _9"></span>System <span class="_ _9"></span>have <span class="_ _9"></span>a <span class="_ _23"></span>buffer <span class="_ _3"></span>cache <span class="_ _9"></span>or <span class="_ _23"></span>page <span class="_ _9"></span>cache <span class="_ _9"></span>in</span></div><div class="t m0 x32 h2a yc87 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _3"></span>kernel <span class="_ _3"></span>through <span class="_ _2"></span>which <span class="_ _3"></span>most <span class="_ _3"></span>disk <span class="_ _3"></span>I/O <span class="_ _3"></span>passes.<span class="_ _16"> </span>When <span class="_ _3"></span>we <span class="_ _3"></span>write <span class="_ _3"></span>data <span class="_ _3"></span>to <span class="_ _3"></span>a <span class="_ _3"></span>ﬁle, <span class="_ _3"></span>the <span class="_ _3"></span>data</div><div class="t m0 x32 h2a yc88 ff19 fsf fc0 sc0 ls0 ws0">is normally copied <span class="_ _2"></span>by the <span class="_ _2"></span>kernel into <span class="_ _2"></span>one of <span class="_ _2"></span>its buffers and queued <span class="_ _2"></span>for writing <span class="_ _2"></span>to disk <span class="_ _2"></span>at</div><div class="t m0 x32 h2b yc89 ff19 fsf fc0 sc0 ls0 ws0">some <span class="_ _23"> </span>later <span class="_ _42"> </span>time.<span class="_ _54"> </span>This <span class="_ _23"> </span>is <span class="_ _42"> </span>called<span class="_ _35"> </span><span class="ff1b">delayed <span class="_ _42"> </span>write</span><span class="ls3ff">.(<span class="_ _7"></span><span class="ls0">Chapter <span class="_ _23"> </span>3 <span class="_ _42"> </span>of <span class="_ _42"> </span>Bach</span></span></div><div class="t m0 x168 h2a yc8a ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 xd3 h2a yc89 ff19 fsf fc0 sc0 ls0 ws0">1986</div><div class="t m0 x11c h2a yc8a ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x37 h2a yc89 ff19 fsf fc0 sc0 ls0 ws0">discusses <span class="_ _23"> </span>this</div><div class="t m0 x32 h2a yc8b ff19 fsf fc0 sc0 ls0 ws0">buffer cache in detail.)</div><div class="t m0 x3f h2a y40f ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _3"></span>kernel <span class="_ _3"></span>eventually <span class="_ _3"></span>writes <span class="_ _3"></span>all <span class="_ _9"></span>the <span class="_ _3"></span>delayed-write <span class="_ _3"></span>blocks <span class="_ _3"></span>to <span class="_ _3"></span>disk, <span class="_ _9"></span>normally <span class="_ _3"></span>when <span class="_ _3"></span>it</div><div class="t m0 x32 h2a yc8c ff19 fsf fc0 sc0 ls0 ws0">needs <span class="_ _23"> </span>to <span class="_ _23"> </span>reuse <span class="_ _23"> </span>the <span class="_ _23"> </span>buffer <span class="_ _23"></span>for <span class="_ _23"> </span>some <span class="_ _23"> </span>other <span class="_ _42"> </span>disk <span class="_ _23"></span>block.<span class="_ _51"> </span><span class="ls5f">To <span class="_ _47"> </span>e<span class="_ _23"></span></span>nsur<span class="_ _0"></span><span class="ls400">ec<span class="_ _43"></span><span class="ls0">onsistency <span class="_ _23"> </span>of <span class="_ _42"> </span>the <span class="_ _23"></span>ﬁle</span></span></div><div class="t m0 x32 h26 yc8d ff19 fsf fc0 sc0 ls0 ws0">system on <span class="_ _2"></span>disk <span class="_ _2"></span>with the <span class="_ _2"></span>contents <span class="_ _2"></span>of the <span class="_ _2"></span>buffer cache, <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">sync</span>,<span class="_ _66"> </span><span class="ff1a">fsync</span><span class="ls401">,a<span class="_ _d"></span><span class="ls0">nd<span class="_ _66"> </span><span class="ff1a">fdatasync</span></span></span></div><div class="t m0 x32 h2a yc8e ff19 fsf fc0 sc0 ls0 ws0">functions ar<span class="ls44">ep<span class="_ _4f"></span><span class="ls45">ro<span class="_ _2"></span><span class="ls0">vided.</span></span></span></div><div class="t m0 x3f h57 yc8f ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h57 yc90 ff1a fs2d fc0 sc0 ls0 ws0">int fsync(int<span class="_"> </span><span class="ff1b">fd</span>);</div><div class="t m0 x3f h57 yc91 ff1a fs2d fc0 sc0 ls0 ws0">int fdatasync(int<span class="_"> </span><span class="ff1b">fd</span>);</div><div class="t m0 x153 h5f yc92 ff19 fs2d fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x3f h57 yc93 ff1a fs2d fc0 sc0 ls0 ws0">void sync(void);</div><div class="t m0 x32 h4d yc94 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1a">sync<span class="_ _66"> </span></span>function simply queues all <span class="_ _2"></span>the modiﬁed block <span class="_ _2"></span>buffers for writing and returns;</div><div class="t m0 x32 h49 yc95 ff19 fs26 fc0 sc0 ls0 ws0">it does not wait for the disk writes to take place.</div><div class="t m0 x3f h4d yc96 ff19 fs26 fc0 sc0 ls0 ws0">The function<span class="_ _66"> </span><span class="ff1a">sync<span class="_ _66"> </span></span>is <span class="_ _2"></span>normally called <span class="_ _2"></span>periodically <span class="_ _2"></span>(usually every <span class="_ _2"></span>30 seconds) <span class="_ _2"></span>from a</div><div class="t m0 x32 h4d yc97 ff19 fs26 fc0 sc0 ls0 ws0">system <span class="_ _9"></span>daemon, <span class="_ _9"></span>often <span class="_ _9"></span>called<span class="_ _45"> </span><span class="ff1a">update</span><span class="ls402">.T<span class="_ _62"></span><span class="ls0">his <span class="_ _9"></span>guarantees <span class="_ _9"></span>regular <span class="_ _9"></span>ﬂushing <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>kernel’s</span></span></div><div class="t m0 x32 h4d yc98 ff19 fs26 fc0 sc0 ls0 ws0">block buffers. <span class="_"> </span>The<span class="_"> </span>command<span class="_"> </span><span class="ff1a">sync</span></div><div class="t m0 x85 h49 yc99 ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x121 h49 yc98 ff19 fs26 fc0 sc0 ls0 ws0">1</div><div class="t m0 x99 h49 yc99 ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 x10f h4d yc98 ff19 fs26 fc0 sc0 ls0 ws0">also calls the<span class="_"> </span><span class="ff1a">sync<span class="_ _80"> </span></span>function.</div><div class="t m0 x3f h4d yc9a ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _23"> </span>function<span class="_ _35"> </span><span class="ff1a">fsync<span class="_ _44"> </span></span><span class="lscc">re</span>fers <span class="_ _23"> </span>only <span class="_ _42"> </span>to <span class="_ _23"> </span>a <span class="_ _42"> </span>single <span class="_ _23"> </span>ﬁle, <span class="_ _42"> </span>speciﬁed <span class="_ _23"> </span>by <span class="_ _42"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _23"> </span>descriptor<span class="_ _44"> </span><span class="ff1b">fd</span>,</div><div class="t m0 x32 h49 yc9b ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _3"></span>waits <span class="_ _3"></span>for <span class="_ _3"></span>the <span class="_ _9"></span>disk <span class="_ _3"></span>writes <span class="_ _3"></span>to <span class="_ _3"></span>complete <span class="_ _9"></span>befor<span class="_ _0"></span><span class="ls403">er<span class="_ _b"></span><span class="ls0">eturning. <span class="_ _45"> </span>This<span class="_ _47"> </span>function <span class="_ _3"></span>is <span class="_ _3"></span>used <span class="_ _3"></span>when</span></span></div><div class="t m0 x32 h49 yc9c ff19 fs26 fc0 sc0 ls0 ws0">an <span class="_ _3"></span>application, <span class="_ _2"></span>such <span class="_ _3"></span>as <span class="_ _3"></span>a <span class="_ _3"></span>database, <span class="_ _3"></span>needs <span class="_ _3"></span>to <span class="_ _3"></span>be <span class="_ _3"></span>sur<span class="ls404">et<span class="_ _8"></span><span class="ls0">hat <span class="_ _3"></span>the <span class="_ _3"></span>modiﬁed <span class="_ _3"></span>blocks <span class="_ _3"></span>have <span class="_ _3"></span>been</span></span></div><div class="t m0 x32 h49 yc9d ff19 fs26 fc0 sc0 ls0 ws0">written to the disk.</div><div class="t m0 x3f h4d yc9e ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1a">fdatasync<span class="_ _66"> </span></span>function <span class="_ _2"></span>is similar <span class="_ _2"></span>to<span class="_"> </span><span class="ff1a">fsync</span><span class="ls405">,b<span class="_ _d"></span><span class="ls0">ut <span class="_ _2"></span>it affects only the <span class="_ _2"></span>data <span class="_ _2"></span>portions of</span></span></div><div class="t m0 x32 h4d yc9f ff19 fs26 fc0 sc0 lsd3 ws0">aﬁ<span class="_ _d"></span><span class="ls0">le. <span class="_"> </span>W<span class="_ _1"></span>ith<span class="_"> </span><span class="ff1a">fsync</span><span class="lsd3">,t<span class="_ _5"></span><span class="ls0">he ﬁle’s attributes ar<span class="lsd3">ea<span class="_ _4f"></span><span class="ls0">lso updated synchronously<span class="_ _4"></span>.</span></span></span></span></span></div><div class="t m0 x76 h5e yca0 ff19 fs10 fc0 sc0 ls0 ws0">All <span class="_ _2"></span>four <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>platforms <span class="_ _2"></span>described <span class="_ _2"></span>in <span class="_ _2"></span>this <span class="_ _3"></span>book <span class="_ _2"></span>support<span class="_ _80"> </span><span class="ff1a">sync<span class="_ _e"> </span></span>and<span class="_ _80"> </span><span class="ff1a">fsync</span><span class="ls406">.H<span class="_ _c"></span><span class="ls0">owever<span class="_ _1"></span><span class="ls407">,F<span class="_ _5"></span><span class="ls21d">re<span class="_ _2"></span><span class="ls0">eBSD</span></span></span></span></span></div><div class="t m0 x76 h5e yca1 ff19 fs10 fc0 sc0 ls0 ws0">8.0 does not support<span class="_"> </span><span class="ff1a">fdatasync</span>.</div><a class="l" href="#pfc" data-dest-detail='[12,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.891993px;bottom:911.208878px;width:277.630989px;height:19.680023px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
