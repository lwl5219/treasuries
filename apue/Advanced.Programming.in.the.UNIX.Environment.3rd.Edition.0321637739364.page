<div id="pf16c" class="pf w4 h1f" data-page-no="16c"><div class="pc pc16c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg16c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">330<span class="_ _1b"> </span><span class="ff19">Signals <span class="_ _24b"> </span>Chapter<span class="_ _21"> </span>10</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">Be <span class="_ _9"></span>awar<span class="ls55d">et<span class="_ _b"></span><span class="ls0">hat <span class="_ _9"></span>UNIX <span class="_ _9"></span>systems <span class="_ _9"></span>from <span class="_ _9"></span>other <span class="_ _23"></span>vendors <span class="_ _9"></span>can <span class="_ _9"></span>have <span class="_ _23"></span>values <span class="_ _9"></span>differ<span class="_ _0"></span>ent <span class="_ _9"></span>from <span class="_ _9"></span>those</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">shown <span class="_ _44"> </span>in <span class="_ _4b"> </span>this <span class="_ _44"> </span>ﬁgure. <span class="_ _54"> </span>For<span class="_ _65"> </span>example,<span class="_ _65"> </span><span class="ff1a">sigaction<span class="_ _65"> </span></span>under <span class="_ _44"> </span>SunOS <span class="_ _4b"> </span>4.1.2 <span class="_ _44"> </span>restarts <span class="_ _44"> </span>an</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">interrupted system call by default, unlike the platforms listed in Figur<span class="_ _0"></span><span class="ls44">e1<span class="_ _d"></span><span class="ls0">0.3.</span></span></div><div class="t m0 x3f h26 y132 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _44"> </span>Figur<span class="lsc0d">e1<span class="_ _52"></span><span class="ls0">0.18, <span class="_ _35"> </span>we <span class="_ _4b"> </span>provide <span class="_ _35"> </span>our <span class="_ _44"> </span>own <span class="_ _4b"> </span>version <span class="_ _44"> </span>of <span class="_ _44"> </span>the<span class="_ _54"> </span><span class="ff1a">signal<span class="_ _54"> </span></span>function <span class="_ _4b"> </span>that</span></span></div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">automatically <span class="_"> </span>tries <span class="_ _66"> </span>to <span class="_ _66"> </span>restart <span class="_"> </span>interrupted <span class="_ _66"> </span>system <span class="_ _66"> </span>calls <span class="_ _66"> </span>(other <span class="_ _47"> </span>than <span class="_"> </span>for <span class="_ _66"> </span>the<span class="_ _46"> </span><span class="ff1a">SIGALRM</span></div><div class="t m0 x32 h26 y134 ff19 fsf fc0 sc0 ls0 ws0">signal). <span class="_"> </span>In<span class="_ _66"> </span>Figur<span class="lsc0e">e1<span class="_ _4f"></span><span class="ls0">0.19, <span class="_ _2"></span>we <span class="_ _2"></span>provide another function,<span class="_ _47"> </span><span class="ff1a">signal_intr</span><span class="lsc0e">,t<span class="_ _4f"></span><span class="ls0">hat <span class="_ _2"></span>tries to <span class="_ _2"></span>never</span></span></span></span></div><div class="t m0 x32 h2a y135 ff19 fsf fc0 sc0 ls0 ws0">do the restart.</div><div class="t m0 x3f h2a y136 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _44"> </span>t<span class="_ _9"></span><span class="ls0">alk <span class="_"> </span>mor<span class="_ _1"></span><span class="lsc0f">ea<span class="_ _55"></span><span class="ls0">bout <span class="_"> </span>interrupted <span class="_ _e"> </span>system <span class="_"> </span>calls <span class="_ _e"> </span>in <span class="_"> </span>Section <span class="_ _53"> </span>14.4 <span class="_"> </span>with <span class="_"> </span>r<span class="_ _1"></span>egar<span class="lsc0f">dt<span class="_ _4a"></span><span class="lsc10">ot<span class="_ _55"></span><span class="ls0">he</span></span></span></span></span></span></div><div class="t m0 x32 h26 y137 ff1a fsf fc0 sc0 ls0 ws0">select<span class="_ _80"> </span><span class="ff19">and<span class="_"> </span></span>poll<span class="_ _66"> </span><span class="ff19">functions.</span></div><div class="t m0 x35 h53 y2a6b ff16 fs2b fc0 sc0 ls0 ws0">10.6 <span class="_ _93"> </span>Reentrant<span class="_ _54"> </span>Functions</div><div class="t m0 x32 h2a y6b5 ff19 fsf fc0 sc0 ls0 ws0">When <span class="_ _42"> </span>a <span class="_ _53"> </span>signal <span class="_ _42"> </span>that <span class="_ _53"> </span>is <span class="_ _42"> </span>being <span class="_ _53"> </span>caught <span class="_ _42"> </span>is <span class="_ _53"> </span>handled <span class="_ _42"> </span>by <span class="_ _53"> </span>a <span class="_ _42"> </span>process, <span class="_ _42"> </span>the <span class="_ _42"> </span>normal <span class="_ _53"> </span>sequence <span class="_ _42"> </span>of</div><div class="t m0 x32 h2a y2a6c ff19 fsf fc0 sc0 ls0 ws0">instructions <span class="_"> </span>being <span class="_ _e"> </span>executed <span class="_"> </span>by <span class="_"> </span>the <span class="_"> </span>pr<span class="_ _0"></span>ocess <span class="_"> </span>is <span class="_"> </span>temporarily <span class="_ _e"> </span>interrupted <span class="_"> </span>by <span class="_"> </span>the <span class="_ _e"> </span>signal</div><div class="t m0 x32 h2a y2a6d ff19 fsf fc0 sc0 ls0 ws0">handler<span class="_ _6"></span><span class="lsc11">.T<span class="_ _56"></span><span class="ls0">he <span class="_ _45"> </span>process <span class="_ _47"> </span>then <span class="_ _45"> </span>continues <span class="_ _45"> </span>executing, <span class="_ _45"> </span>but <span class="_ _47"> </span>the <span class="_ _45"> </span>instructions <span class="_ _45"> </span>in <span class="_ _47"> </span>the <span class="_ _45"> </span>signal</span></span></div><div class="t m0 x32 h26 y25cc ff19 fsf fc0 sc0 ls0 ws0">handler <span class="_ _53"> </span>ar<span class="ls6d8">en<span class="_ _55"></span><span class="ls0">ow <span class="_ _e"> </span>executed.<span class="_ _65"> </span>If <span class="_ _53"> </span>the <span class="_ _e"> </span>signal <span class="_ _53"> </span>handler <span class="_ _e"> </span>returns <span class="_ _53"> </span>(instead <span class="_ _53"> </span>of <span class="_ _e"> </span>calling<span class="_ _4b"> </span><span class="ff1a">exit<span class="_ _4b"> </span></span>or</span></span></div><div class="t m0 x32 h26 y2a6e ff1a fsf fc0 sc0 ls0 ws0">longjmp<span class="ff19 lsc12">,f<span class="_ _b"></span><span class="ls0">or <span class="_ _9"></span>example), <span class="_ _9"></span>then <span class="_ _9"></span>the <span class="_ _9"></span>normal <span class="_ _9"></span>sequence <span class="_ _23"></span>of <span class="_ _9"></span>instructions <span class="_ _3"></span>that <span class="_ _23"></span>the <span class="_ _9"></span>process <span class="_ _3"></span>was</span></span></div><div class="t m0 x32 h2a y2a6f ff19 fsf fc0 sc0 ls0 ws0">executing <span class="_ _53"> </span>when <span class="_ _53"> </span>the <span class="_ _53"> </span>signal <span class="_ _e"> </span>was <span class="_ _53"> </span>caught <span class="_ _53"> </span>continues <span class="_ _53"> </span>executing.<span class="_ _65"> </span>(This <span class="_ _e"> </span>is <span class="_ _53"> </span>similar <span class="_ _53"> </span>to <span class="_ _53"> </span>what</div><div class="t m0 x32 h2a y2a70 ff19 fsf fc0 sc0 ls0 ws0">happens <span class="_ _42"> </span>when <span class="_ _53"> </span>a <span class="_ _42"> </span>hardwar<span class="lsc13">ei<span class="_ _55"></span><span class="ls0">nterrupt <span class="_ _53"> </span>occurs.)<span class="_ _54"> </span>But <span class="_ _42"> </span>in <span class="_ _53"> </span>the <span class="_ _42"> </span>signal <span class="_ _53"> </span>handler<span class="_ _1"></span>,<span class="_ _44"> </span>we<span class="_ _44"> </span>can’t <span class="_ _42"> </span>tell</span></span></div><div class="t m0 x32 h2a y2a71 ff19 fsf fc0 sc0 ls0 ws0">wher<span class="lsc14">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>process <span class="_ _3"></span>was <span class="_ _3"></span>executing <span class="_ _3"></span>when <span class="_ _3"></span>the <span class="_ _3"></span>signal <span class="_ _3"></span>was <span class="_ _3"></span>caught.<span class="_ _16"> </span>What <span class="_ _9"></span>if <span class="_ _3"></span>the <span class="_ _3"></span>process <span class="_ _2"></span>was</span></span></div><div class="t m0 x32 h26 y2a72 ff19 fsf fc0 sc0 ls0 ws0">in <span class="_ _9"></span>the <span class="_ _23"></span>middle <span class="_ _9"></span>of <span class="_ _23"></span>allocating <span class="_ _9"></span>additional <span class="_ _23"></span>memory <span class="_ _9"></span>on <span class="_ _23"></span>its <span class="_ _9"></span>heap <span class="_ _23"></span>using<span class="_ _45"> </span><span class="ff1a">malloc</span><span class="lsac7">,a<span class="_ _b"></span><span class="ls0">nd <span class="_ _9"></span>we <span class="_ _9"></span>call</span></span></div><div class="t m0 x32 h26 y2a73 ff1a fsf fc0 sc0 ls0 ws0">malloc<span class="_ _66"> </span><span class="ff19">from the signal handler?<span class="_ _61"> </span>Or<span class="_ _6"></span><span class="ls11b">,w<span class="_ _d"></span><span class="ls0">hat <span class="_ _2"></span>if the <span class="_ _2"></span>process was in the <span class="_ _2"></span>middle of <span class="_ _2"></span>a call <span class="_ _2"></span>to a</span></span></span></div><div class="t m0 x32 h26 y784 ff19 fsf fc0 sc0 ls0 ws0">function, <span class="_ _9"></span>such <span class="_ _23"></span>as<span class="_ _45"> </span><span class="ff1a">getpwnam<span class="_ _45"> </span></span>(Section <span class="_ _23"></span>6.2), <span class="_ _9"></span>that <span class="_ _23"></span>stores <span class="_ _3"></span>its <span class="_ _23"></span>result <span class="_ _9"></span>in <span class="_ _9"></span>a <span class="_ _23"></span>static <span class="_ _9"></span>location, <span class="_ _23"></span>and</div><div class="t m0 x32 h26 y785 ff19 fsf fc0 sc0 ls0 ws0">we <span class="_ _3"></span>call <span class="_ _3"></span>the <span class="_ _9"></span>same <span class="_ _3"></span>function <span class="_ _9"></span>from <span class="_ _2"></span>the <span class="_ _9"></span>signal <span class="_ _3"></span>handler?<span class="_ _16"> </span>In <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">malloc<span class="_ _45"> </span></span>example, <span class="_ _3"></span>havoc <span class="_ _3"></span>can</div><div class="t m0 x32 h26 ybc ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">sult <span class="_ _23"> </span>for <span class="_ _23"> </span>the <span class="_ _23"> </span>process, <span class="_ _23"></span>since<span class="_ _35"> </span><span class="ff1a">malloc<span class="_ _35"> </span></span>usually <span class="_ _9"></span>maintains <span class="_ _42"> </span>a <span class="_ _23"></span>linked <span class="_ _23"></span>list <span class="_ _23"></span>of <span class="_ _23"></span>all <span class="_ _23"></span>its <span class="_ _23"></span>allocated</span></div><div class="t m0 x32 h2a y29f4 ff19 fsf fc0 sc0 ls0 ws0">areas, <span class="_ _47"> </span>and <span class="_ _47"> </span>it <span class="_ _45"> </span>may <span class="_ _47"> </span>have <span class="_ _45"> </span>been <span class="_ _45"> </span>in <span class="_ _47"> </span>the <span class="_ _45"> </span>middle <span class="_ _47"> </span>of <span class="_ _45"> </span>changing <span class="_ _47"> </span>this <span class="_ _45"> </span>list.<span class="_ _5f"> </span>In <span class="_ _47"> </span>the <span class="_ _45"> </span>case <span class="_ _47"> </span>of</div><div class="t m0 x32 h26 y29f5 ff1a fsf fc0 sc0 ls0 ws0">getpwnam<span class="ff19 lsc15">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>information <span class="_ _9"></span>returned <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>normal <span class="_ _9"></span>caller <span class="_ _9"></span>can <span class="_ _9"></span>get <span class="_ _9"></span>overwritten <span class="_ _23"></span>with <span class="_ _9"></span>the</span></span></div><div class="t m0 x32 h2a y2a74 ff19 fsf fc0 sc0 ls0 ws0">information returned to the signal handler<span class="_ _6"></span>.</div><div class="t m0 x3f h2a y2a75 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _2"></span>Single <span class="_ _3"></span>UNIX <span class="_ _3"></span>Speciﬁcation <span class="_ _2"></span>speciﬁes <span class="_ _3"></span>the <span class="_ _3"></span>functions <span class="_ _2"></span>that <span class="_ _3"></span>ar<span class="ls25c">eg<span class="_ _8"></span><span class="ls0">uaranteed <span class="_ _3"></span>to <span class="_ _2"></span>be <span class="_ _3"></span>safe</span></span></div><div class="t m0 x32 h2a y2a76 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_"> </span>call <span class="_ _47"> </span>fr<span class="_ _0"></span>om <span class="_"> </span>within <span class="_ _47"> </span>a <span class="_"> </span>signal <span class="_ _66"> </span>handler<span class="_ _1"></span><span class="lsc16">.T<span class="_ _49"></span><span class="ls0">hese <span class="_ _66"> </span>functions <span class="_ _47"> </span>ar<span class="_ _0"></span><span class="lsc17">er<span class="_ _1d"></span><span class="ls0">eentrant <span class="_ _47"> </span>and <span class="_"> </span>ar<span class="lsc18">ec<span class="_ _5b"></span><span class="ls0">alled</span></span></span></span></span></span></div><div class="t m0 x32 h2b y2a77 ff1b fsf fc0 sc0 ls0 ws0">async-signal <span class="_ _23"></span>safe<span class="_ _35"> </span><span class="ff19">by <span class="_ _9"></span>the <span class="_ _23"> </span>Single <span class="_ _23"> </span>UNIX <span class="_ _23"> </span>Speciﬁcation.<span class="_ _51"> </span>Besides <span class="_ _23"></span>being <span class="_ _23"></span>reentrant, <span class="_ _9"></span>they <span class="_ _23"> </span>block</span></div><div class="t m0 x32 h2a y2a78 ff19 fsf fc0 sc0 ls0 ws0">any <span class="_ _45"> </span>signals <span class="_ _35"> </span>during <span class="_ _35"> </span>operation <span class="_ _45"> </span>if <span class="_ _35"> </span>delivery <span class="_ _45"> </span>of <span class="_ _35"> </span>a <span class="_ _45"> </span>signal <span class="_ _35"> </span>might <span class="_ _45"> </span>cause <span class="_ _35"> </span>inconsistencies.</div><div class="t m0 x32 h2a yc22 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="lsc19">e1<span class="_ _c"></span><span class="ls0">0.4 <span class="_ _42"> </span>lists <span class="_ _42"> </span>these <span class="_ _42"> </span>async-signal <span class="_ _53"> </span>safe <span class="_ _42"> </span>functions.<span class="_ _54"> </span>Most <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>functions <span class="_ _42"> </span>that <span class="_ _42"> </span>ar<span class="lsc1a">en<span class="_ _43"></span><span class="ls0">ot</span></span></span></span></div><div class="t m0 x32 h2a y2a79 ff19 fsf fc0 sc0 ls0 ws0">included <span class="_"> </span>in <span class="_"> </span>Figur<span class="lsc1b">e1<span class="_ _5b"></span><span class="ls0">0.4 <span class="_ _66"> </span>ar<span class="lsc1b">em<span class="_ _5b"></span><span class="ls0">issing <span class="_ _66"> </span>because <span class="_"> </span>(a) <span class="_ _66"> </span>they <span class="_"> </span>ar<span class="lsc1b">ek<span class="_ _4a"></span><span class="ls0">nown <span class="_"> </span>to <span class="_"> </span>use <span class="_"> </span>static <span class="_ _66"> </span>data</span></span></span></span></span></span></div><div class="t m0 x32 h26 y2a7a ff19 fsf fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>es, (b) <span class="_ _2"></span>they call<span class="_ _47"> </span><span class="ff1a">malloc<span class="_ _80"> </span></span>or<span class="_ _66"> </span><span class="ff1a">free</span>,<span class="_ _47"> </span>or<span class="_"> </span>(c) they <span class="_ _2"></span>ar<span class="ls3c9">ep<span class="_ _4f"></span><span class="ls0">art <span class="_ _2"></span>of the <span class="_ _2"></span>standar<span class="ls3c9">dI<span class="_ _4f"></span><span class="ls0">/O <span class="_ _2"></span>library<span class="_ _4"></span>.</span></span></span></span></div><div class="t m0 x32 h2a y2a7b ff19 fsf fc0 sc0 ls0 ws0">Most <span class="_ _66"> </span>implementations <span class="_ _47"> </span>of <span class="_ _47"> </span>the <span class="_ _66"> </span>standar<span class="ls428">dI<span class="_ _1d"></span><span class="ls0">/O <span class="_ _47"> </span>library <span class="_ _66"> </span>use <span class="_ _47"> </span>global <span class="_ _47"> </span>data <span class="_ _66"> </span>structures <span class="_"> </span>in <span class="_ _47"> </span>a</span></span></div><div class="t m0 x32 h26 y2a7c ff19 fsf fc0 sc0 ls0 ws0">nonreentrant way<span class="_ _4"></span><span class="lsc1c">.N<span class="_ _4a"></span><span class="ls0">ote that <span class="_ _2"></span>even though <span class="_ _2"></span>we call<span class="_ _66"> </span><span class="ff1a">printf<span class="_ _66"> </span></span>from signal <span class="_ _2"></span>handlers <span class="_ _2"></span>in some</span></span></div><div class="t m0 x32 h2a y2a7d ff19 fsf fc0 sc0 ls0 ws0">of <span class="_ _23"></span>our <span class="_ _9"></span>examples, <span class="_ _23"> </span>it <span class="_ _23"></span>is <span class="_ _23"></span>not <span class="_ _9"></span>guaranteed <span class="_ _23"> </span>to <span class="_ _23"></span>produce <span class="_ _9"></span>the <span class="_ _23"></span>expected <span class="_ _23"></span>results, <span class="_ _9"></span>since <span class="_ _23"></span>the <span class="_ _9"></span>signal</div><div class="t m0 x32 h26 y2a7e ff19 fsf fc0 sc0 ls0 ws0">handler can interrupt a call to<span class="_"> </span><span class="ff1a">printf<span class="_ _80"> </span></span>from our main pr<span class="_ _0"></span>ogram.</div><div class="t m0 x3f h2a y2a7f ff19 fsf fc0 sc0 ls0 ws0">Be <span class="_ _3"></span>awar<span class="lsc1d">et<span class="_ _b"></span><span class="ls0">hat <span class="_ _9"></span>even <span class="_ _3"></span>if <span class="_ _9"></span>we <span class="_ _3"></span>call <span class="_ _9"></span>a <span class="_ _3"></span>function <span class="_ _9"></span>listed <span class="_ _9"></span>in <span class="_ _3"></span>Figur<span class="lsc1e">e1<span class="_ _b"></span><span class="ls0">0.4 <span class="_ _9"></span>from <span class="_ _2"></span>a <span class="_ _9"></span>signal <span class="_ _9"></span>handler<span class="_ _6"></span>,</span></span></span></span></div><div class="t m0 x32 h26 y2a80 ff19 fsf fc0 sc0 ls0 ws0">there<span class="_"> </span>is<span class="_ _47"> </span>only one<span class="_ _47"> </span><span class="ff1a">errno<span class="_ _66"> </span></span>variable <span class="_ _2"></span>per <span class="_ _3"></span>thread (recall the <span class="_ _3"></span>discussion <span class="_ _2"></span>of<span class="_ _66"> </span><span class="ff1a">errno<span class="_ _47"> </span></span>and <span class="_ _2"></span>threads</div><div class="t m0 x32 h2a y2a81 ff19 fsf fc0 sc0 ls0 ws0">in <span class="_ _23"></span>Section <span class="_ _23"></span>1.7), <span class="_ _23"> </span>and <span class="_ _23"> </span>we <span class="_ _23"> </span>might <span class="_ _23"> </span>potentially <span class="_ _23"> </span>modify <span class="_ _42"> </span>its <span class="_ _23"></span>value.<span class="_ _51"> </span>Consider <span class="_ _23"></span>a <span class="_ _23"></span>signal <span class="_ _23"></span>handler</div><div class="t m0 x32 h26 y2a82 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _42"> </span>is <span class="_ _42"> </span>invoked <span class="_ _42"> </span>right <span class="_ _42"> </span>after<span class="_ _44"> </span><span class="ff1a">main<span class="_ _35"> </span></span>has <span class="_ _53"> </span>set<span class="_ _44"> </span><span class="ff1a">errno</span><span class="lsc1f">.I<span class="_ _52"></span><span class="lsc20">ft<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>signal <span class="_ _42"> </span>handler <span class="_ _53"> </span>calls<span class="_ _44"> </span><span class="ff1a">read</span><span class="lsc20">,f<span class="_ _c"></span><span class="ls0">or</span></span></span></span></span></div><div class="t m0 x32 h26 y2a83 ff19 fsf fc0 sc0 ls0 ws0">example, <span class="_ _23"> </span>this <span class="_ _23"> </span>call <span class="_ _42"> </span>can <span class="_ _23"> </span>change <span class="_ _23"> </span>the <span class="_ _42"> </span>value <span class="_ _23"></span>of<span class="_ _35"> </span><span class="ff1a">errno</span><span class="lsc21">,w<span class="_ _43"></span><span class="ls0">iping <span class="_ _23"> </span>out <span class="_ _42"> </span>the <span class="_ _23"> </span>value <span class="_ _23"> </span>that <span class="_ _42"> </span>was <span class="_ _23"></span>just</span></span></div><a class="l" href="#pff" data-dest-detail='[15,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.893259px;bottom:959.088916px;width:156.011399px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
