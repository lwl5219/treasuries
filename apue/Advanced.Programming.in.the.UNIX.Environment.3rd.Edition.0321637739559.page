<div id="pf22f" class="pf w4 h1f" data-page-no="22f"><div class="pc pc22f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg22f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.8<span class="_ _2b0"> </span>Memory-Mapped <span class="_"> </span>I/O<span class="_ _1b"> </span><span class="ff18">525</span></div><div class="t m0 x35 h53 y12f ff16 fs2b fc0 sc0 ls0 ws0">14.8 <span class="_ _93"> </span>Memory-Mapped <span class="_"> </span>I/O</div><div class="t m0 x32 h2a y4de ff19 fsf fc0 sc0 ls0 ws0">Memory-mapped <span class="_ _3"></span>I/O <span class="_ _9"></span>lets <span class="_ _3"></span>us <span class="_ _9"></span>map <span class="_ _3"></span>a <span class="_ _3"></span>ﬁle <span class="_ _9"></span>on <span class="_ _3"></span>disk <span class="_ _9"></span>into <span class="_ _3"></span>a <span class="_ _9"></span>buffer <span class="_ _3"></span>in <span class="_ _3"></span>memory <span class="_ _9"></span>so <span class="_ _3"></span>that, <span class="_ _9"></span>when</div><div class="t m0 x32 h2a y6d0 ff19 fsf fc0 sc0 ls0 ws0">we <span class="_ _9"></span>fetch <span class="_ _23"> </span>bytes <span class="_ _23"></span>from <span class="_ _9"></span>the <span class="_ _23"></span>buffer<span class="_ _6"></span><span class="ls10e7">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>corresponding <span class="_ _9"></span>bytes <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>ﬁle <span class="_ _23"></span>ar<span class="ls10e7">er<span class="_ _43"></span><span class="ls0">ead. <span class="_ _45"> </span>Similarly<span class="_ _6"></span>,</span></span></span></span></div><div class="t m0 x32 h2a y6d1 ff19 fsf fc0 sc0 ls0 ws0">when <span class="_ _9"></span>we <span class="_ _9"></span>stor<span class="ls10e8">ed<span class="_ _b"></span><span class="ls0">ata <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>buffer<span class="_ _6"></span><span class="ls10e8">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>corresponding <span class="_ _9"></span>bytes <span class="_ _9"></span>ar<span class="ls134">ea<span class="_ _b"></span><span class="ls0">utomatically <span class="_ _3"></span>written <span class="_ _9"></span>to</span></span></span></span></span></span></div><div class="t m0 x32 h26 y6d2 ff19 fsf fc0 sc0 ls0 ws0">the ﬁle.<span class="_ _59"> </span>This lets us perform I/O without using<span class="_"> </span><span class="ff1a">read<span class="_ _66"> </span></span>or<span class="_"> </span><span class="ff1a">write</span>.</div><div class="t m0 x76 h51 y736 ff19 fs2a fc0 sc0 ls0 ws0">Memory-mapped <span class="_ _2"></span>I/O <span class="_ _3"></span>has <span class="_ _3"></span>been <span class="_ _3"></span>in <span class="_ _3"></span>use <span class="_ _3"></span>with <span class="_ _3"></span>virtual <span class="_ _3"></span>memory <span class="_ _3"></span>systems <span class="_ _3"></span>for <span class="_ _3"></span>many <span class="_ _3"></span>years.<span class="_ _4b"> </span>In <span class="_ _3"></span>1981,</div><div class="t m0 x76 h52 ybc5 ff19 fs2a fc0 sc0 ls0 ws0">4.1BSD <span class="_ _80"> </span>provided <span class="_ _e"> </span>a <span class="_ _66"> </span>differ<span class="_ _0"></span>ent <span class="_ _80"> </span>form <span class="_ _80"> </span>of <span class="_ _80"> </span>memory-mapped <span class="_ _80"> </span>I/O <span class="_ _80"> </span>with <span class="_ _80"> </span>its<span class="_ _4b"> </span><span class="ff1a">vread<span class="_ _4b"> </span></span>and<span class="_ _4b"> </span><span class="ff1a">vwrite</span></div><div class="t m0 x76 h51 ybc6 ff19 fs2a fc0 sc0 ls0 ws0">functions. <span class="_ _44"> </span>These<span class="_ _4b"> </span>two <span class="_ _80"> </span>functions <span class="_ _80"> </span>wer<span class="ls10e9">et<span class="_ _c"></span><span class="ls0">hen <span class="_ _80"> </span>removed <span class="_ _e"> </span>in <span class="_ _80"> </span>4.2BSD <span class="_ _66"> </span>and <span class="_ _80"> </span>wer<span class="ls10e9">ei<span class="_ _55"></span><span class="ls0">ntended <span class="_ _80"> </span>to <span class="_ _80"> </span>be</span></span></span></span></div><div class="t m0 x76 h52 y1f1c ff19 fs2a fc0 sc0 ls34e ws0">re<span class="ls0">placed <span class="_ _2"></span>with <span class="_ _3"></span>the<span class="_ _80"> </span><span class="ff1a">mmap<span class="_ _80"> </span></span>function. <span class="_ _e"> </span>The<span class="_ _80"> </span><span class="ff1a">mmap<span class="_ _80"> </span></span>function, <span class="_ _3"></span>however<span class="_ _1"></span><span class="ls10ea">,w<span class="_ _5"></span><span class="ls0">as <span class="_ _2"></span>not <span class="_ _2"></span>included <span class="_ _2"></span>with <span class="_ _2"></span>4.2BSD</span></span></span></div><div class="t m0 x76 h51 y403a ff19 fs2a fc0 sc0 ls0 ws0">(for <span class="_ _3"></span>reasons <span class="_ _2"></span>described <span class="_ _3"></span>in <span class="_ _3"></span>Section <span class="_ _9"></span>2.5 <span class="_ _3"></span>of <span class="_ _3"></span>McKusick <span class="_ _3"></span>et <span class="_ _3"></span>al.</div><div class="t m0 x1b4 h51 y403b ff19 fs2a fc0 sc0 ls0 ws0">[</div><div class="t m0 x75 h51 y403a ff19 fs2a fc0 sc0 ls0 ws0">1996</div><div class="t m0 x13e h51 y403b ff19 fs2a fc0 sc0 ls0 ws0">]</div><div class="t m0 x14c h51 y403a ff19 fs2a fc0 sc0 ls0 ws0">). <span class="_ _80"> </span>Gingell,<span class="_ _66"> </span>Moran, <span class="_ _3"></span>and <span class="_ _3"></span>Shannon</div><div class="t m0 x76 h51 y403c ff19 fs2a fc0 sc0 ls0 ws0">[</div><div class="t m0 x198 h51 y403d ff19 fs2a fc0 sc0 ls0 ws0">1987</div><div class="t m0 x8 h51 y403c ff19 fs2a fc0 sc0 ls0 ws0">]</div><div class="t m0 x1e4 h52 y403d ff19 fs2a fc0 sc0 ls0 ws0">describe <span class="_"> </span>one <span class="_"> </span>implementation <span class="_ _e"> </span>of<span class="_ _44"> </span><span class="ff1a">mmap</span><span class="ls10eb">.V<span class="_ _52"></span><span class="ls0">ersion <span class="_"> </span>4 <span class="_"> </span>of <span class="_"> </span>the <span class="_ _e"> </span>Single <span class="_ _e"> </span>UNIX <span class="_ _80"> </span>Speciﬁcation</span></span></div><div class="t m0 x76 h52 y403e ff19 fs2a fc0 sc0 ls0 ws0">moved <span class="_ _42"> </span>the<span class="_ _45"> </span><span class="ff1a">mmap<span class="_ _45"> </span></span>function <span class="_"> </span>fr<span class="_ _0"></span>om <span class="_ _23"> </span>an <span class="_"> </span>option <span class="_ _23"> </span>to <span class="_ _42"> </span>the <span class="_ _42"> </span>base <span class="_ _42"> </span>speciﬁcation.<span class="_ _16"> </span>All <span class="_ _42"> </span>POSIX-conforming</div><div class="t m0 x76 h51 y403f ff19 fs2a fc0 sc0 ls0 ws0">systems ar<span class="lse9">er<span class="_ _5"></span><span class="ls0">equired to support it.</span></span></div><div class="t m0 x3f h2a y4040 ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _45"> </span>u<span class="_ _9"></span><span class="ls0">se <span class="_ _53"> </span>this <span class="_ _42"> </span>feature, <span class="_ _42"> </span>we <span class="_ _53"> </span>have <span class="_ _42"> </span>to <span class="_ _53"> </span>tell <span class="_ _42"> </span>the <span class="_ _53"> </span>kernel <span class="_ _42"> </span>to <span class="_ _53"> </span>map <span class="_ _42"> </span>a <span class="_ _53"> </span>given <span class="_ _42"> </span>ﬁle <span class="_ _53"> </span>to <span class="_ _42"> </span>a <span class="_ _53"> </span>region <span class="_ _42"> </span>in</span></div><div class="t m0 x32 h26 y4041 ff19 fsf fc0 sc0 ls0 ws0">memory<span class="_ _4"></span><span class="ls86">.T<span class="_ _4a"></span><span class="ls0">his task is handled by the<span class="_"> </span><span class="ff1a">mmap<span class="_ _66"> </span></span>function.</span></span></div><div class="t m0 xb8 h57 y4042 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/mman.h&gt;</div><div class="t m0 xb8 h57 y4043 ff1a fs2d fc0 sc0 ls0 ws0">void *mmap(void *<span class="ff1b">addr</span><span class="ls15c">,s<span class="_ _1d"></span><span class="ls0">ize_t<span class="_"> </span><span class="ff1b">len</span><span class="ls15c">,i<span class="_ _5b"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">prot</span><span class="ls15c">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">ﬂag</span><span class="ls15c">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">fd</span><span class="ls15c">,o<span class="_ _5b"></span><span class="ls0">ff_t<span class="_"> </span><span class="ff1b">off<span class="_ _42"> </span></span>);</span></span></span></span></span></span></span></span></span></span></div><div class="t m0 x38 h57 y4044 ff19 fs2d fc0 sc0 ls0 ws0">Returns: starting address of mapped r<span class="_ _0"></span>egion if OK,<span class="_"> </span><span class="ff1a">MAP_FAILED<span class="_ _e"> </span></span>on error</div><div class="t m0 x3f h4a y4045 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1b">addr<span class="_ _47"> </span></span>argument lets us <span class="_ _2"></span>specify <span class="_ _2"></span>the <span class="_ _2"></span>address where<span class="_ _66"> </span>we<span class="_ _66"> </span>want <span class="_ _2"></span>the <span class="_ _2"></span>mapped <span class="_ _2"></span>region to</div><div class="t m0 x32 h49 y4046 ff19 fs26 fc0 sc0 ls0 ws0">start. <span class="_"> </span>W<span class="_ _6"></span><span class="ls10ec">en<span class="_ _d"></span><span class="ls0">ormally <span class="_ _2"></span>set this <span class="_ _2"></span>value <span class="_ _2"></span>to 0 <span class="_ _2"></span>to <span class="_ _2"></span>allow the <span class="_ _2"></span>system to <span class="_ _2"></span>choose <span class="_ _2"></span>the starting <span class="_ _2"></span>address.</span></span></div><div class="t m0 x32 h49 y4047 ff19 fs26 fc0 sc0 ls0 ws0">The return value of this function is the starting addr<span class="_ _0"></span>ess of the mapped ar<span class="_ _0"></span>ea.</div><div class="t m0 x3f h4a y4048 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _45"> </span><span class="ff1b">fd<span class="_ _45"> </span></span>argument <span class="_ _9"></span>is <span class="_ _23"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>descriptor <span class="_ _23"></span>specifying <span class="_ _9"></span>the <span class="_ _23"></span>ﬁle <span class="_ _9"></span>that <span class="_ _9"></span>is <span class="_ _23"></span>to <span class="_ _9"></span>be <span class="_ _23"></span>mapped.<span class="_ _5a"> </span><span class="ls164">We</span></div><div class="t m0 x32 h4a y4049 ff19 fs26 fc0 sc0 ls0 ws0">have <span class="_ _3"></span>to <span class="_ _3"></span>open <span class="_ _3"></span>this <span class="_ _3"></span>ﬁle <span class="_ _3"></span>before<span class="_ _47"> </span>we<span class="_ _47"> </span>can <span class="_ _2"></span>map <span class="_ _9"></span>it <span class="_ _2"></span>into <span class="_ _3"></span>the <span class="_ _3"></span>address <span class="_ _3"></span>space.<span class="_ _16"> </span>The<span class="_ _47"> </span><span class="ff1b">len<span class="_ _47"> </span></span>argument <span class="_ _2"></span>is</div><div class="t m0 x32 h4a y404a ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>number <span class="_ _3"></span>of <span class="_ _3"></span>bytes <span class="_ _3"></span>to <span class="_ _3"></span>map, <span class="_ _9"></span>and<span class="_ _47"> </span><span class="ff1b">off<span class="_ _47"> </span></span>is <span class="_ _3"></span>the <span class="_ _3"></span>starting <span class="_ _3"></span>offset <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>bytes <span class="_ _3"></span>to <span class="_ _3"></span>map.</div><div class="t m0 x32 h4a y404b ff19 fs26 fc0 sc0 ls0 ws0">(Some restrictions on the value of<span class="_"> </span><span class="ff1b">off<span class="_"> </span></span>ar<span class="_ _0"></span><span class="lsd3">ed<span class="_ _d"></span><span class="ls0">escribed later<span class="_ _6"></span>.)</span></span></div><div class="t m0 x3f h4a y404c ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1b">prot<span class="_"> </span></span>ar<span class="_ _0"></span>gument speciﬁes the pr<span class="_ _0"></span>otection of the mapped region.</div><div class="t m0 x5a h56 y404d ff1b fs11 fc0 sc0 ls0 ws0">prot<span class="_ _ae"> </span><span class="ff19">Description</span></div><div class="t m0 x224 h6d y404e ff1a fs12 fc0 sc0 ls0 ws0">PROT_READ<span class="_ _75"> </span><span class="ff19">Region can be read.</span></div><div class="t m0 x224 h6d y404f ff1a fs12 fc0 sc0 ls0 ws0">PROT_WRITE<span class="_ _6e"> </span><span class="ff19">Region can be written.</span></div><div class="t m0 x224 h6d y4050 ff1a fs12 fc0 sc0 ls0 ws0">PROT_EXEC<span class="_ _75"> </span><span class="ff19">Region can be executed.</span></div><div class="t m0 x224 h6d y4051 ff1a fs12 fc0 sc0 ls0 ws0">PROT_NONE<span class="_ _75"> </span><span class="ff19">Region cannot be accessed.</span></div><div class="t m0 xab h30 y4052 ff18 fs13 fc0 sc0 ls0 ws0">Figure 14.25<span class="_ _5a"> </span><span class="ff19">Protection of memory-mapped region</span></div><div class="t m0 x32 h64 y4053 ff19 fs31 fc0 sc0 ls43f ws0">We <span class="_ _5a"> </span>c<span class="_ _9"></span><span class="ls0">an <span class="_ _44"> </span>specify <span class="_ _4b"> </span>the <span class="_ _44"> </span>protection <span class="_ _35"> </span>as <span class="_ _44"> </span>either<span class="_ _54"> </span><span class="ff1a">PROT_NONE<span class="_ _65"> </span></span>or <span class="_ _44"> </span>the <span class="_ _44"> </span>bitwise <span class="_ _44"> </span>OR <span class="_ _44"> </span>of <span class="_ _44"> </span>any</span></div><div class="t m0 x32 h64 y4054 ff19 fs31 fc0 sc0 ls0 ws0">combination <span class="_ _23"></span>of<span class="_ _35"> </span><span class="ff1a">PROT_READ</span>,<span class="_ _45"> </span><span class="ff1a">PROT_WRITE</span><span class="ls10ed">,a<span class="_ _b"></span><span class="ls0">nd<span class="_ _45"> </span><span class="ff1a">PROT_EXEC</span><span class="ls10ee">.T<span class="_ _26"></span><span class="ls0">he <span class="_ _23"> </span>protection <span class="_ _23"></span>speciﬁed</span></span></span></span></div><div class="t m0 x32 h64 y4055 ff19 fs31 fc0 sc0 ls0 ws0">for <span class="_ _9"></span>a <span class="_ _23"></span>r<span class="_ _0"></span>egion <span class="_ _9"></span>can’t <span class="_ _23"></span>allow <span class="_ _9"></span>mor<span class="ls10ef">ea<span class="_ _b"></span><span class="ls0">ccess <span class="_ _9"></span>than <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">open<span class="_ _45"> </span></span>mode <span class="_ _23"></span>of <span class="_ _9"></span>the <span class="_ _23"></span>ﬁle.<span class="_ _5a"> </span>For <span class="_ _9"></span>example, <span class="_ _23"></span>we</span></span></div><div class="t m0 x32 h64 y4056 ff19 fs31 fc0 sc0 ls0 ws0">can’t specify<span class="_"> </span><span class="ff1a">PROT_WRITE<span class="_ _80"> </span></span>if the ﬁle was opened read-only<span class="_ _4"></span>.</div><div class="t m0 x3f h79 y4057 ff19 fs31 fc0 sc0 ls0 ws0">Befor<span class="ls10f0">el<span class="_ _c"></span><span class="ls0">ooking <span class="_ _42"> </span>at <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1b">ﬂag<span class="_ _44"> </span></span>argument, <span class="_ _42"> </span>let’s <span class="_ _42"> </span>see <span class="_ _53"> </span>what’s <span class="_ _42"> </span>going <span class="_ _53"> </span>on <span class="_ _42"> </span>here. <span class="_ _44"> </span>Figur<span class="ls10f1">e1<span class="_ _c"></span><span class="ls0">4.26</span></span></span></span></div><div class="t m0 x32 h6e y4058 ff19 fs31 fc0 sc0 ls0 ws0">shows a memory-mapped ﬁle.<span class="_ _46"> </span>(Recall the <span class="_ _2"></span>memory layout of a <span class="_ _2"></span>typical process, shown in</div><div class="t m0 x32 h64 y4059 ff19 fs31 fc0 sc0 ls0 ws0">Figur<span class="ls10f2">e7<span class="_ _b"></span><span class="ls0">.6.) <span class="_ _47"> </span>In<span class="_ _45"> </span>this <span class="_ _2"></span>ﬁgure, <span class="_ _3"></span>‘<span class="_ _0"></span>‘start <span class="_ _3"></span>addr<span class="_ _9"></span><span class="ls10f3">’’ <span class="_ _23"> </span>i<span class="_ _2"></span><span class="ls10f4">st<span class="_ _8"></span><span class="ls0">he <span class="_ _9"></span>return <span class="_ _2"></span>value <span class="_ _3"></span>from<span class="_ _47"> </span><span class="ff1a">mmap</span><span class="ls10f5">.W<span class="_ _7"></span><span class="ls10f4">eh<span class="_ _8"></span><span class="ls0">ave <span class="_ _3"></span>shown</span></span></span></span></span></span></span></span></div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1236.288916px;width:154.139808px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
