<div id="pf264" class="pf w4 h1f" data-page-no="264"><div class="pc pc264 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg264.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">578<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _23"> </span>program <span class="_ _23"></span>opens <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">/dev/zero<span class="_ _35"> </span></span>device <span class="_ _42"> </span>and <span class="_ _23"> </span>calls<span class="_ _35"> </span><span class="ff1a">mmap</span><span class="ls4b8">,s<span class="_ _43"></span><span class="ls0">pecifying <span class="_ _42"> </span>a <span class="_ _23"></span>size <span class="_ _23"> </span>of <span class="_ _42"> </span>a</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">long <span class="_ _e"> </span>integer<span class="_ _6"></span><span class="ls1284">.N<span class="_ _64"></span><span class="ls0">ote <span class="_"> </span>that <span class="_ _53"> </span>once <span class="_ _e"> </span>the <span class="_ _e"> </span>region <span class="_ _53"> </span>is <span class="_"> </span>mapped, <span class="_ _53"> </span>we <span class="_ _e"> </span>can<span class="_ _4b"> </span><span class="ff1a">close<span class="_ _4b"> </span></span>the <span class="_"> </span>device.<span class="_ _65"> </span>The</span></span></div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 ls0 ws0">process <span class="_ _e"> </span>then <span class="_ _e"> </span>creates <span class="_"> </span>a <span class="_ _53"> </span>child.<span class="_ _60"> </span>Since<span class="_ _4b"> </span><span class="ff1a">MAP_SHARED<span class="_ _59"> </span></span>was <span class="_"> </span>speciﬁed <span class="_ _e"> </span>in <span class="_"> </span>the <span class="_ _e"> </span>call <span class="_"> </span>to<span class="_ _4b"> </span><span class="ff1a">mmap</span>,</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">writes <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>memory-mapped <span class="_ _9"></span>region <span class="_ _2"></span>by <span class="_ _9"></span>one <span class="_ _3"></span>process <span class="_ _3"></span>ar<span class="ls92c">es<span class="_ _8"></span><span class="ls0">een <span class="_ _3"></span>by <span class="_ _9"></span>the <span class="_ _3"></span>other <span class="_ _9"></span>process. <span class="_ _47"> </span>(If</span></span></div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">we had speciﬁed<span class="_"> </span><span class="ff1a">MAP_PRIVATE<span class="_ _80"> </span></span>instead, this example wouldn’t work.)</div><div class="t m0 x3f h2a y134 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _3"></span>parent <span class="_ _2"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>child <span class="_ _3"></span>then <span class="_ _3"></span>alternate <span class="_ _3"></span>running, <span class="_ _3"></span>incrementing <span class="_ _3"></span>a <span class="_ _3"></span>long <span class="_ _3"></span>integer <span class="_ _3"></span>in <span class="_ _3"></span>the</div><div class="t m0 x32 h2a y135 ff19 fsf fc0 sc0 ls0 ws0">shared <span class="_ _9"></span>memory-mapped <span class="_ _23"></span>region, <span class="_ _9"></span>using <span class="_ _23"></span>the <span class="_ _23"></span>synchronization <span class="_ _9"></span>functions <span class="_ _23"></span>from <span class="_ _9"></span>Section <span class="_ _23"></span>8.9.</div><div class="t m0 x32 h26 y136 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _3"></span>memory-mapped <span class="_ _9"></span>region <span class="_ _3"></span>is <span class="_ _9"></span>initialized <span class="_ _9"></span>to <span class="_ _3"></span>0 <span class="_ _9"></span>by<span class="_ _45"> </span><span class="ff1a">mmap</span><span class="ls1285">.T<span class="_ _62"></span><span class="ls0">he <span class="_ _9"></span>parent <span class="_ _3"></span>increments <span class="_ _3"></span>it <span class="_ _9"></span>to <span class="_ _3"></span>1,</span></span></div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">then the <span class="_ _2"></span>child increments it <span class="_ _2"></span>to <span class="_ _2"></span>2, then <span class="_ _2"></span>the parent increments it <span class="_ _2"></span>to 3, <span class="_ _2"></span>and <span class="_ _2"></span>so on.<span class="_ _61"> </span>Note that</div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">we <span class="_ _42"> </span>have <span class="_ _53"> </span>to <span class="_ _42"> </span>use <span class="_ _53"> </span>parentheses <span class="_ _42"> </span>when <span class="_ _42"> </span>we <span class="_ _42"> </span>increment <span class="_ _42"> </span>the <span class="_ _53"> </span>value <span class="_ _42"> </span>of <span class="_ _53"> </span>the <span class="_ _42"> </span>long <span class="_ _53"> </span>integer <span class="_ _53"> </span>in <span class="_ _42"> </span>the</div><div class="t m0 x32 h26 y139 ff1a fsf fc0 sc0 ls0 ws0">update<span class="_ _80"> </span><span class="ff19">function, since we ar<span class="ls44">ei<span class="_ _d"></span><span class="ls0">ncrementing the value and not the pointer<span class="_ _6"></span>.</span></span></span></div><div class="t m0 x3f h26 y13a ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _53"> </span>advantage <span class="_ _53"> </span>of <span class="_ _53"> </span>using<span class="_ _44"> </span><span class="ff1a">/dev/zero<span class="_ _4b"> </span></span>in <span class="_ _53"> </span>the <span class="_ _53"> </span>manner <span class="_ _53"> </span>that <span class="_ _53"> </span>we’ve <span class="_ _53"> </span>shown <span class="_ _53"> </span>is <span class="_ _53"> </span>that <span class="_ _53"> </span>an</div><div class="t m0 x32 h26 y254 ff19 fsf fc0 sc0 ls0 ws0">actual <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>need <span class="_ _23"></span>not <span class="_ _23"> </span>exist <span class="_ _42"> </span>befor<span class="ls1286">ew<span class="_ _43"></span><span class="ls1287">ec<span class="_ _43"></span><span class="ls0">all<span class="_ _35"> </span><span class="ff1a">mmap<span class="_ _35"> </span></span>to <span class="_ _23"> </span>create <span class="_ _23"> </span>the <span class="_ _23"> </span>mapped <span class="_ _42"> </span>region. <span class="_ _35"> </span>Mapping</span></span></span></div><div class="t m0 x32 h26 y255 ff1a fsf fc0 sc0 ls0 ws0">/dev/zero<span class="_ _60"> </span><span class="ff19">automatically <span class="_ _59"> </span>creates <span class="_ _59"> </span>a <span class="_ _59"> </span>mapped <span class="_ _46"> </span>region <span class="_ _59"> </span>of <span class="_ _46"> </span>the <span class="_ _59"> </span>speciﬁed <span class="_ _46"> </span>size.<span class="_ _5e"> </span>The</span></div><div class="t m0 x32 h2a y13b ff19 fsf fc0 sc0 ls0 ws0">disadvantage <span class="_ _42"> </span>of <span class="_ _23"> </span>this <span class="_ _42"> </span>technique <span class="_ _42"> </span>is <span class="_ _42"> </span>that <span class="_ _42"> </span>it <span class="_ _42"> </span>works <span class="_ _23"> </span>only <span class="_ _42"> </span>between <span class="_ _42"> </span>related <span class="_ _23"> </span>processes. <span class="_ _35"> </span>W<span class="_ _0"></span>ith</div><div class="t m0 x32 h2a y13c ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">lated <span class="_"> </span>pr<span class="_ _0"></span>ocesses, <span class="_ _e"> </span>however<span class="_ _6"></span>,<span class="_ _59"> </span>it<span class="_ _59"> </span>i<span class="ls1288">sp<span class="_ _55"></span><span class="ls45">ro<span class="ls0">bably <span class="_"> </span>simpler <span class="_ _53"> </span>and <span class="_"> </span>mor<span class="_ _1"></span><span class="ls1288">ee<span class="_ _55"></span><span class="ls45">fﬁ<span class="_ _2"></span><span class="ls0">cient <span class="_"> </span>to <span class="_ _53"> </span>use <span class="_"> </span>thr<span class="_ _1"></span>eads</span></span></span></span></span></span></span></div><div class="t m0 x32 h2a y256 ff19 fsf fc0 sc0 ls0 ws0">(Chapters <span class="_ _42"> </span>1<span class="_ _1"></span><span class="ls6df">1a<span class="_ _43"></span><span class="ls0">nd <span class="_ _42"> </span>12).<span class="_ _54"> </span>Note <span class="_ _42"> </span>that <span class="_ _42"> </span>no <span class="_ _42"> </span>matter <span class="_ _42"> </span>which <span class="_ _42"> </span>technique <span class="_ _42"> </span>is <span class="_ _42"> </span>used, <span class="_ _42"> </span>we <span class="_ _42"> </span>still <span class="_ _42"> </span>need <span class="_ _53"> </span>to</span></span></div><div class="t m0 x32 h2a y257 ff19 fsf fc0 sc0 ls0 ws0">synchronize access to the shar<span class="_ _0"></span>ed data.</div><div class="t m0 x35 h4c y40c6 ff16 fs26 fc0 sc0 ls0 ws0">Example <span class="_ _84"></span>— <span class="_ _84"></span>Anonymous Memor<span class="ls1289">yM<span class="_ _4f"></span><span class="ls0">apping</span></span></div><div class="t m0 x32 h49 y40c8 ff19 fs26 fc0 sc0 ls0 ws0">Many <span class="_ _9"></span>implementations <span class="_ _9"></span>provide <span class="_ _3"></span>anonymous <span class="_ _23"></span>memory <span class="_ _3"></span>mapping, <span class="_ _23"></span>a <span class="_ _9"></span>facility <span class="_ _9"></span>similar <span class="_ _9"></span>to <span class="_ _9"></span>the</div><div class="t m0 x32 h4d y40c9 ff1a fs26 fc0 sc0 ls0 ws0">/dev/zero<span class="_ _44"> </span><span class="ff19">feature. <span class="_ _35"> </span>T<span class="_ _6"></span><span class="ls128a">ou<span class="_ _43"></span><span class="ls0">se <span class="_ _42"> </span>this <span class="_ _42"> </span>facility<span class="_ _6"></span>,<span class="_ _44"> </span>we<span class="_ _35"> </span>specify <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1a">MAP_ANON<span class="_ _44"> </span></span>ﬂag <span class="_ _42"> </span>to<span class="_ _44"> </span><span class="ff1a">mmap<span class="_ _44"> </span></span>and</span></span></span></div><div class="t m0 x32 h49 y40cb ff19 fs26 fc0 sc0 ls0 ws0">specify <span class="_"> </span>the <span class="_"> </span>ﬁle <span class="_"> </span>descriptor <span class="_"> </span>as<span class="_ _59"> </span><span class="ff20">−</span>1. <span class="_ _59"> </span>The<span class="_ _46"> </span><span class="lscc">re</span>sulting <span class="_"> </span>region <span class="_"> </span>is <span class="_"> </span>anonymous <span class="_"> </span>(since <span class="_ _e"> </span>it’s <span class="_"> </span>not</div><div class="t m0 x32 h49 y40cc ff19 fs26 fc0 sc0 ls0 ws0">associated <span class="_ _2"></span>with <span class="_ _2"></span>a <span class="_ _2"></span>pathname <span class="_ _2"></span>through <span class="_ _2"></span>a <span class="_ _2"></span>ﬁle <span class="_ _2"></span>descriptor) <span class="_ _2"></span>and <span class="_ _2"></span>creates <span class="_ _2"></span>a <span class="_ _2"></span>memory <span class="_ _2"></span>region <span class="_ _2"></span>that</div><div class="t m0 x32 h49 y40cd ff19 fs26 fc0 sc0 ls0 ws0">can be shared with descendant pr<span class="_ _0"></span>ocesses.</div><div class="t m0 x76 h2d y45cc ff19 fs10 fc0 sc0 ls0 ws0">The <span class="_ _2"></span>anonymous <span class="_ _2"></span>memory-mapping <span class="_ _2"></span>facility <span class="_ _3"></span>is <span class="_ _2"></span>supported <span class="_ _2"></span>by <span class="_ _2"></span>all <span class="_ _3"></span>four <span class="_ _2"></span>platforms <span class="_ _2"></span>discussed <span class="_ _3"></span>in <span class="_ _2"></span>this</div><div class="t m0 x76 h5e y45cd ff19 fs10 fc0 sc0 ls0 ws0">text. <span class="_ _66"> </span>Note,<span class="_ _80"> </span>however<span class="_ _0"></span><span class="ls128b">,t<span class="_ _4f"></span><span class="ls0">hat <span class="_ _9"></span>Linux <span class="_ _3"></span>deﬁnes <span class="_ _3"></span>the<span class="_ _66"> </span><span class="ff1a">MAP_ANONYMOUS<span class="_ _66"> </span></span>ﬂag <span class="_ _3"></span>for <span class="_ _9"></span>this <span class="_ _3"></span>facility<span class="_ _6"></span><span class="ls128c">,b<span class="_ _d"></span><span class="ls0">ut <span class="_ _3"></span>deﬁnes</span></span></span></span></div><div class="t m0 x76 h5e y45ce ff19 fs10 fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">MAP_ANON<span class="_ _53"> </span></span>ﬂag to be the same value for improved application portability<span class="_ _6"></span>.</div><div class="t m0 x3f h49 y45cf ff19 fs26 fc0 sc0 ls164 ws0">To <span class="_ _66"> </span>m<span class="_ _9"></span><span class="ls0">odify <span class="_ _9"></span>the <span class="_ _9"></span>program <span class="_ _9"></span>in <span class="_ _9"></span>Figur<span class="ls128d">e1<span class="_ _b"></span><span class="ls0">5.33 <span class="_ _9"></span>to <span class="_ _9"></span>use <span class="_ _9"></span>this <span class="_ _9"></span>facility<span class="_ _4"></span>,<span class="_ _45"> </span>we<span class="_ _45"> </span>make <span class="_ _9"></span>three <span class="_ _9"></span>changes:</span></span></span></div><div class="t m0 x32 h4d y45d0 ff19 fs26 fc0 sc0 ls0 ws0">(a) remove the<span class="_"> </span><span class="ff1a">open<span class="_ _80"> </span></span>of<span class="_"> </span><span class="ff1a">/dev/zero</span><span class="lsbdc">,(<span class="_ _d"></span><span class="ls0">b) <span class="_ _2"></span>remove the<span class="_"> </span><span class="ff1a">close<span class="_ _80"> </span></span>of<span class="_"> </span><span class="ff1a">fd</span><span class="lsbdc">,a<span class="_ _d"></span><span class="ls0">nd <span class="_ _2"></span>(c) change the call</span></span></span></span></div><div class="t m0 x32 h4d y45d1 ff19 fs26 fc0 sc0 ls0 ws0">to<span class="_"> </span><span class="ff1a">mmap<span class="_ _80"> </span></span>to the following:</div><div class="t m0 x3f h4e y45d2 ff1a fs28 fc0 sc0 ls0 ws0">if ((area = mmap(0, SIZE, PROT_READ | PROT_WRITE,</div><div class="t m0 x199 h4e y45d3 ff1a fs28 fc0 sc0 ls0 ws0">MAP_ANON | MAP_SHARED, -1, 0)) == MAP_FAILED)</div><div class="t m0 x32 h4d y45d4 ff19 fs26 fc0 sc0 ls0 ws0">In <span class="_ _9"></span>this <span class="_ _3"></span>call, <span class="_ _9"></span>we <span class="_ _9"></span>specify <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">MAP_ANON<span class="_ _45"> </span></span>ﬂag <span class="_ _3"></span>and <span class="_ _9"></span>set <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>descriptor <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff20">−</span>1. <span class="_ _45"> </span>The<span class="_ _47"> </span><span class="lscc">re<span class="_ _2"></span></span>st <span class="_ _9"></span>of</div><div class="t m0 x32 h49 y45d5 ff19 fs26 fc0 sc0 ls0 ws0">the program fr<span class="_ _0"></span>om Figur<span class="_ _0"></span><span class="lsd3">e1<span class="_ _d"></span><span class="ls0">5.33 is unchanged.</span></span></div><div class="t m0 x3f h55 y45d6 ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _2"></span>last <span class="_ _2"></span>two <span class="_ _2"></span>examples illustrate <span class="_ _2"></span>sharing <span class="_ _2"></span>memory <span class="_ _2"></span>among <span class="_ _2"></span>multiple <span class="_ _2"></span>related <span class="_ _2"></span>processes.</div><div class="t m0 x32 h55 y45d7 ff19 fs2c fc0 sc0 ls0 ws0">If <span class="_ _23"></span>shar<span class="_ _0"></span>ed <span class="_ _23"></span>memory <span class="_ _9"></span>is <span class="_ _23"> </span>required <span class="_ _9"></span>between <span class="_ _23"></span>unrelated <span class="_ _9"></span>processes, <span class="_ _9"></span>ther<span class="ls128e">ea<span class="_ _b"></span><span class="ls150">re <span class="_ _23"> </span>t<span class="_ _2"></span><span class="ls0">wo <span class="_ _23"></span>alternatives.</span></span></span></div><div class="t m0 x32 h54 y45d8 ff19 fs2c fc0 sc0 ls0 ws0">Applications <span class="_ _23"></span>can <span class="_ _23"></span>use <span class="_ _9"></span>the <span class="_ _23"> </span>XSI <span class="_ _23"> </span>shared <span class="_ _23"></span>memory <span class="_ _9"></span>functions, <span class="_ _23"> </span>or <span class="_ _23"> </span>they <span class="_ _23"></span>can <span class="_ _23"></span>use<span class="_ _35"> </span><span class="ff1a">mmap<span class="_ _45"> </span></span>to <span class="_ _23"></span>map</div><div class="t m0 x32 h54 y45d9 ff19 fs2c fc0 sc0 ls0 ws0">the same ﬁle into their address spaces using the<span class="_"> </span><span class="ff1a">MAP_SHARED<span class="_ _80"> </span></span>ﬂag.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
