<div id="pf256" class="pf w4 h1f" data-page-no="256"><div class="pc pc256 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg256.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">564<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls0 ws0">Note <span class="_ _47"> </span>how <span class="_ _45"> </span>ungracefully <span class="_ _47"> </span>the <span class="_ _45"> </span>removal <span class="_ _47"> </span>of <span class="_ _45"> </span>a <span class="_ _47"> </span>message <span class="_ _45"> </span>queue <span class="_ _47"> </span>is <span class="_ _45"> </span>handled.<span class="_ _5f"> </span>Since <span class="_ _45"> </span>a</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ference <span class="_ _9"></span>count <span class="_ _9"></span>is <span class="_ _9"></span>not <span class="_ _9"></span>maintained <span class="_ _9"></span>with <span class="_ _9"></span>each <span class="_ _9"></span>message <span class="_ _9"></span>queue <span class="_ _9"></span>(as <span class="_ _9"></span>there<span class="_ _47"> </span>is<span class="_ _45"> </span>for <span class="_ _9"></span>open <span class="_ _9"></span>ﬁles),</span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _45"> </span>r<span class="_ _0"></span>emoval <span class="_ _47"> </span>of <span class="_ _45"> </span>a <span class="_ _45"> </span>queue <span class="_ _47"> </span>simply <span class="_ _45"> </span>generates <span class="_ _45"> </span>err<span class="_ _0"></span>ors <span class="_ _47"> </span>on <span class="_ _45"> </span>the <span class="_ _45"> </span>next <span class="_ _47"> </span>queue <span class="_ _45"> </span>operation <span class="_ _45"> </span>by</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">processes <span class="_ _9"></span>still <span class="_ _23"></span>using <span class="_ _23"></span>the <span class="_ _23"></span>queue.<span class="_ _5a"> </span>Semaphores <span class="_ _23"></span>handle <span class="_ _9"></span>this <span class="_ _23"> </span>removal <span class="_ _9"></span>in <span class="_ _23"> </span>the <span class="_ _23"> </span>same <span class="_ _23"></span>fashion.</div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _2"></span>contrast, <span class="_ _2"></span>when <span class="_ _2"></span>a <span class="_ _3"></span>ﬁle <span class="_ _2"></span>is <span class="_ _2"></span>removed, <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle’s <span class="_ _2"></span>contents <span class="_ _3"></span>ar<span class="ls676">en<span class="_ _8"></span><span class="ls0">ot <span class="_ _2"></span>deleted <span class="_ _3"></span>until <span class="_ _2"></span>the <span class="_ _2"></span>last <span class="_ _3"></span>open</span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">descriptor for the ﬁle is closed.</div><div class="t m0 x3f h26 y135 ff19 fsf fc0 sc0 ls0 ws0">When<span class="_ _4b"> </span><span class="ff1a">msgsnd<span class="_ _59"> </span></span><span class="ls45">re<span class="_ _2"></span></span>turns <span class="_ _e"> </span>successfully<span class="_ _6"></span><span class="ls9c1">,t<span class="_ _4a"></span><span class="ls0">he<span class="_ _59"> </span><span class="ff1a">msqid_ds<span class="_ _59"> </span></span>structur<span class="_ _0"></span><span class="ls9c1">ea<span class="_ _55"></span><span class="ls0">ssociated <span class="_ _e"> </span>with <span class="_ _e"> </span>the</span></span></span></span></div><div class="t m0 x32 h26 y136 ff19 fsf fc0 sc0 ls0 ws0">message <span class="_ _9"></span>queue <span class="_ _9"></span>is <span class="_ _23"></span>updated <span class="_ _9"></span>to <span class="_ _9"></span>indicate <span class="_ _9"></span>the <span class="_ _23"></span>process <span class="_ _3"></span>ID <span class="_ _9"></span>that <span class="_ _23"></span>made <span class="_ _9"></span>the <span class="_ _9"></span>call <span class="_ _23"></span>(<span class="ff1a">msg_lspid</span>),</div><div class="t m0 x32 h26 y137 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _42"> </span>time <span class="_ _42"> </span>that <span class="_ _42"> </span>the <span class="_ _42"> </span>call <span class="_ _53"> </span>was <span class="_ _42"> </span>made <span class="_ _42"> </span>(<span class="ff1a">msg_stime</span>), <span class="_ _42"> </span>and <span class="_ _53"> </span>that <span class="_ _42"> </span>one <span class="_ _42"> </span>mor<span class="lsa8e">em<span class="_ _c"></span><span class="ls0">essage <span class="_ _53"> </span>is <span class="_ _42"> </span>on <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h26 y138 ff19 fsf fc0 sc0 ls0 ws0">queue (<span class="ff1a">msg_qnum</span>).</div><div class="t m0 x3f h26 y139 ff19 fsf fc0 sc0 ls0 ws0">Messages ar<span class="ls44">er<span class="_ _4f"></span><span class="ls0">etrieved from a queue by<span class="_"> </span><span class="ff1a">msgrcv</span>.</span></span></div><div class="t m0 x3f h57 y37af ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/msg.h&gt;</div><div class="t m0 x3f h57 y37b0 ff1a fs2d fc0 sc0 ls0 ws0">ssize_t msgrcv(int<span class="_"> </span><span class="ff1b">msqid</span><span class="ls15c">,v<span class="_ _1d"></span><span class="ls0">oid *<span class="ff1b">ptr</span><span class="ls15c">,s<span class="_ _5b"></span><span class="ls0">ize_t<span class="_"> </span><span class="ff1b">nbytes</span><span class="ls15c">,l<span class="_ _1d"></span><span class="ls0">ong<span class="_"> </span><span class="ff1b">type</span><span class="ls15c">,i<span class="_ _5b"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">ﬂag</span>);</span></span></span></span></span></span></span></span></div><div class="t m0 x4a h5f y37b1 ff19 fs2d fc0 sc0 ls0 ws0">Returns: size of data portion of message if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h4d y37b2 ff19 fs26 fc0 sc0 ls0 ws0">As <span class="_ _3"></span>with<span class="_ _45"> </span><span class="ff1a">msgsnd</span><span class="ls122c">,t<span class="_ _b"></span><span class="ls0">he<span class="_ _45"> </span><span class="ff1b">ptr<span class="_ _47"> </span></span>argument <span class="_ _2"></span>points <span class="_ _9"></span>to <span class="_ _3"></span>a <span class="_ _9"></span>long <span class="_ _3"></span>integer <span class="_ _3"></span>(wher<span class="ls122d">et<span class="_ _8"></span><span class="ls0">he <span class="_ _3"></span>message <span class="_ _3"></span>type <span class="_ _9"></span>of</span></span></span></span></div><div class="t m0 x32 h49 y37b3 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>returned <span class="_ _9"></span>message <span class="_ _9"></span>is <span class="_ _9"></span>stored) <span class="_ _9"></span>followed <span class="_ _9"></span>by <span class="_ _9"></span>a <span class="_ _23"></span>data <span class="_ _9"></span>buffer <span class="_ _9"></span>for <span class="_ _9"></span>the <span class="_ _9"></span>actual <span class="_ _9"></span>message <span class="_ _23"></span>data.</div><div class="t m0 x32 h4a y37b4 ff1b fs26 fc0 sc0 ls0 ws0">nbytes<span class="_ _47"> </span><span class="ff19">speciﬁes <span class="_ _3"></span>the <span class="_ _9"></span>size <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _3"></span>buffer<span class="_ _6"></span><span class="ls122e">.I<span class="_ _1d"></span><span class="ls122f">ft<span class="_ _8"></span><span class="ls0">he <span class="_ _9"></span>returned <span class="_ _2"></span>message <span class="_ _3"></span>is <span class="_ _9"></span>larger <span class="_ _2"></span>than<span class="_ _47"> </span><span class="ff1b">nbytes</span></span></span></span></span></div><div class="t m0 x32 h4d y37b5 ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _e"> </span>the<span class="_ _4b"> </span><span class="ff1a">MSG_NOERROR<span class="_ _59"> </span></span>bit <span class="_ _e"> </span>in<span class="_ _4b"> </span><span class="ff1b">ﬂag<span class="_ _59"> </span></span>is <span class="_ _53"> </span>set, <span class="_"> </span>the <span class="_ _53"> </span>message <span class="_ _e"> </span>is <span class="_ _e"> </span>truncated. <span class="_ _4b"> </span>(In<span class="_ _59"> </span>this <span class="_ _e"> </span>case, <span class="_ _e"> </span>no</div><div class="t m0 x32 h49 y37b6 ff19 fs26 fc0 sc0 ls0 ws0">notiﬁcation <span class="_ _42"> </span>is <span class="_ _42"> </span>given <span class="_ _53"> </span>to <span class="_ _42"> </span>us <span class="_ _42"> </span>that <span class="_ _53"> </span>the <span class="_ _42"> </span>message <span class="_ _53"> </span>was <span class="_ _42"> </span>truncated, <span class="_ _42"> </span>and <span class="_ _42"> </span>the <span class="_ _53"> </span>remainder <span class="_ _42"> </span>of <span class="_ _42"> </span>the</div><div class="t m0 x32 h4a y37b7 ff19 fs26 fc0 sc0 ls0 ws0">message <span class="_ _9"></span>is <span class="_ _9"></span>discarded.) <span class="_ _47"> </span>If<span class="_ _45"> </span>the <span class="_ _9"></span>message <span class="_ _9"></span>is <span class="_ _9"></span>too <span class="_ _9"></span>big <span class="_ _9"></span>and <span class="_ _9"></span>this<span class="_ _45"> </span><span class="ff1b">ﬂag<span class="_ _45"> </span></span>value <span class="_ _9"></span>is <span class="_ _9"></span>not <span class="_ _9"></span>speciﬁed, <span class="_ _9"></span>an</div><div class="t m0 x32 h4d y37b8 ff19 fs26 fc0 sc0 ls0 ws0">error of<span class="_"> </span><span class="ff1a">E2BIG<span class="_ _80"> </span></span>is returned instead (and the message stays on the queue).</div><div class="t m0 x3f h4a y37b9 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1b">type<span class="_"> </span></span>argument lets us specify which message we want.</div><div class="t m0 x3f h4a y4452 ff1b fs26 fc0 sc0 ls0 ws0">type<span class="_ _59"> </span><span class="ff19">== <span class="_"> </span>0<span class="_ _98"> </span>The ﬁrst message on the queue is returned.</span></div><div class="t m0 x3f h4a y4453 ff1b fs26 fc0 sc0 ls0 ws0">type<span class="_ _59"> </span><span class="ff19 ls199">&gt;0 <span class="_ _66"> </span>T<span class="_ _4a"></span><span class="ls0">he <span class="_"> </span>ﬁrst <span class="_"> </span>message <span class="_"> </span>on <span class="_ _66"> </span>the <span class="_ _66"> </span>queue <span class="_"> </span>whose <span class="_ _66"> </span>message <span class="_ _66"> </span>type <span class="_"> </span>equals<span class="_ _46"> </span><span class="ff1b">type<span class="_ _61"> </span></span>is</span></span></div><div class="t m0 x6 h49 y4454 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turned.</span></div><div class="t m0 x3f h4a y4455 ff1b fs26 fc0 sc0 ls0 ws0">type<span class="_ _59"> </span><span class="ff19 ls199">&lt;0 <span class="_ _66"> </span>T<span class="_ _4a"></span><span class="ls0">he <span class="_ _2"></span>ﬁrst <span class="_ _2"></span>message <span class="_ _3"></span>on <span class="_ _2"></span>the <span class="_ _3"></span>queue <span class="_ _2"></span>whose <span class="_ _3"></span>message <span class="_ _2"></span>type <span class="_ _3"></span>is <span class="_ _2"></span>the <span class="_ _2"></span>lowest <span class="_ _3"></span>value</span></span></div><div class="t m0 x6 h4a y4456 ff19 fs26 fc0 sc0 ls0 ws0">less than or equal to the absolute value of<span class="_"> </span><span class="ff1b">type<span class="_"> </span></span>is returned.</div><div class="t m0 x32 h4a y4457 ff19 fs26 fc0 sc0 ls1230 ws0">An<span class="_ _4f"></span><span class="ls0">onzero<span class="_"> </span><span class="ff1b">type<span class="_ _66"> </span></span>is <span class="_ _2"></span>used <span class="_ _2"></span>to <span class="_ _2"></span>read the <span class="_ _2"></span>messages <span class="_ _2"></span>in an <span class="_ _2"></span>order other <span class="_ _2"></span>than <span class="_ _2"></span>ﬁrst <span class="_ _2"></span>in, ﬁrst <span class="_ _2"></span>out.<span class="_ _61"> </span>For</span></div><div class="t m0 x32 h4a y4458 ff19 fs26 fc0 sc0 ls0 ws0">example, <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1b">type<span class="_ _35"> </span></span>could <span class="_ _42"> </span>be <span class="_ _42"> </span>a <span class="_ _42"> </span>priority <span class="_ _42"> </span>value <span class="_ _23"> </span>if <span class="_ _42"> </span>the <span class="_ _42"> </span>application <span class="_ _42"> </span>assigns <span class="_ _23"> </span>priorities <span class="_ _42"> </span>to <span class="_ _42"> </span>the</div><div class="t m0 x32 h49 y4459 ff19 fs26 fc0 sc0 ls0 ws0">messages. <span class="_ _45"> </span>Another<span class="_ _47"> </span>use <span class="_ _9"></span>of <span class="_ _9"></span>this <span class="_ _9"></span>ﬁeld <span class="_ _9"></span>is <span class="_ _3"></span>to <span class="_ _9"></span>contain <span class="_ _9"></span>the <span class="_ _9"></span>process <span class="_ _3"></span>ID <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _3"></span>client <span class="_ _9"></span>if <span class="_ _9"></span>a <span class="_ _9"></span>single</div><div class="t m0 x32 h49 y445a ff19 fs26 fc0 sc0 ls0 ws0">message queue is being used by multiple clients and a single server (as long as a process</div><div class="t m0 x32 h49 y445b ff19 fs26 fc0 sc0 ls0 ws0">ID ﬁts in a long integer).</div><div class="t m0 x3f h4d y445c ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _45"> </span>c<span class="_ _23"></span><span class="ls0">an <span class="_ _42"> </span>specify <span class="_ _53"> </span>a<span class="_ _4b"> </span><span class="ff1b">ﬂag<span class="_ _44"> </span></span>value <span class="_ _53"> </span>of<span class="_ _44"> </span><span class="ff1a">IPC_NOWAIT<span class="_ _4b"> </span></span>to <span class="_ _42"> </span>make <span class="_ _53"> </span>the <span class="_ _53"> </span>operation <span class="_ _53"> </span>nonblocking,</span></div><div class="t m0 x32 h4d y445d ff19 fs26 fc0 sc0 ls0 ws0">causing<span class="_ _35"> </span><span class="ff1a">msgrcv<span class="_ _45"> </span></span>to <span class="_ _23"> </span>return<span class="_ _45"> </span><span class="ff20">−</span><span class="ls1231">1w<span class="_ _b"></span><span class="ls0">ith<span class="_ _45"> </span><span class="ff1a">errno<span class="_ _35"> </span></span>set <span class="_ _23"> </span>to<span class="_ _35"> </span><span class="ff1a">ENOMSG<span class="_ _35"> </span></span>if <span class="_ _9"></span>a <span class="_ _23"> </span>message <span class="_ _23"> </span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>speciﬁed</span></span></div><div class="t m0 x32 h4d y445e ff19 fs26 fc0 sc0 ls0 ws0">type <span class="_"> </span>is <span class="_ _e"> </span>not <span class="_"> </span>available.<span class="_ _60"> </span>If<span class="_ _59"> </span><span class="ff1a">IPC_NOWAIT<span class="_ _59"> </span></span>is <span class="_"> </span>not <span class="_"> </span>speciﬁed, <span class="_ _e"> </span>the <span class="_"> </span>operation <span class="_"> </span>blocks <span class="_ _e"> </span>until <span class="_"> </span>a</div><div class="t m0 x32 h49 y445f ff19 fs26 fc0 sc0 ls0 ws0">message <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>speciﬁed <span class="_ _3"></span>type <span class="_ _3"></span>is <span class="_ _3"></span>available, <span class="_ _9"></span>the <span class="_ _3"></span>queue <span class="_ _3"></span>is <span class="_ _9"></span>removed <span class="_ _2"></span>from <span class="_ _3"></span>the <span class="_ _3"></span>system <span class="_ _9"></span>(<span class="ff20">−</span><span class="ls91f">1i<span class="_ _b"></span><span class="ls0">s</span></span></div><div class="t m0 x32 h4d y4460 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turned <span class="_ _3"></span>with<span class="_ _66"> </span><span class="ff1a">errno<span class="_ _47"> </span></span>set <span class="_ _2"></span>to<span class="_ _47"> </span><span class="ff1a">EIDRM</span>), <span class="_ _2"></span>or <span class="_ _2"></span>a <span class="_ _2"></span>signal <span class="_ _3"></span>is <span class="_ _2"></span>caught <span class="_ _2"></span>and <span class="_ _3"></span>the <span class="_ _2"></span>signal <span class="_ _2"></span>handler <span class="_ _3"></span>returns</span></div><div class="t m0 x32 h4d y4461 ff19 fs26 fc0 sc0 ls0 ws0">(causing<span class="_"> </span><span class="ff1a">msgrcv<span class="_ _80"> </span></span>to return<span class="_"> </span><span class="ff20">−</span><span class="lsd3">1w<span class="_ _d"></span><span class="ls0">ith<span class="_"> </span><span class="ff1a">errno<span class="_ _80"> </span></span>set to<span class="_"> </span><span class="ff1a">EINTR</span>).</span></span></div><div class="t m0 x3f h4d y4462 ff19 fs26 fc0 sc0 ls0 ws0">When<span class="_ _59"> </span><span class="ff1a">msgrcv<span class="_ _59"> </span></span>succeeds, <span class="_"> </span>the <span class="_"> </span>kernel <span class="_"> </span>updates <span class="_ _e"> </span>the<span class="_ _59"> </span><span class="ff1a">msqid_ds<span class="_ _46"> </span></span>structur<span class="ls1232">ea<span class="_ _5b"></span><span class="ls0">ssociated</span></span></div><div class="t m0 x32 h4d y4463 ff19 fs26 fc0 sc0 ls0 ws0">with the <span class="_ _2"></span>message <span class="_ _2"></span>queue <span class="_ _2"></span>to <span class="_ _2"></span>indicate the <span class="_ _2"></span>caller<span class="_ _9"></span>’s <span class="_ _2"></span>process ID (<span class="_ _2"></span><span class="ff1a">msg_lrpid</span>), the <span class="_ _2"></span>time <span class="_ _2"></span>of <span class="_ _2"></span>the</div><div class="t m0 x32 h4d y4464 ff19 fs26 fc0 sc0 ls0 ws0">call (<span class="ff1a">msg_rtime</span>), and that one less message is on the queue (<span class="ff1a">msg_qnum</span>).</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
