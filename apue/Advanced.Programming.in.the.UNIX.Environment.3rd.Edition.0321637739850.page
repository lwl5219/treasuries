<div id="pf352" class="pf w4 h1f" data-page-no="352"><div class="pc pc352 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg352.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">816<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">122 <span class="_ _15"> </span>FD_ZERO(&amp;rendezvous);</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">123 <span class="_ _15"> </span>maxfd<span class="_"> </span><span class="ls15c">=-<span class="_ _1d"></span><span class="ls0">1;</span></span></div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">124 <span class="_ _15"> </span>for<span class="_"> </span>(aip = ailist; aip != NULL; aip = aip-&gt;ai_next) {</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">125 <span class="_ _186"> </span>if<span class="_"> </span>((sockfd = initserver(SOCK_STREAM, aip-&gt;ai_addr,</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">126 <span class="_ _74"> </span>aip-&gt;ai_addrlen,<span class="_"> </span>QLEN)) &gt;= 0) {</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">127 <span class="_ _82"> </span>FD_SET(sockfd,<span class="_"> </span>&amp;rendezvous);</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">128 <span class="_ _82"> </span>if<span class="_"> </span>(sockfd &gt; maxfd)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">129 <span class="_ _1e7"> </span>maxfd<span class="_"> </span><span class="ls15c">=s<span class="_ _1d"></span><span class="ls0">ockfd;</span></span></div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">130 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">131 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">132 <span class="_ _15"> </span>if<span class="_"> </span>(maxfd == -1)</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">133 <span class="_ _186"> </span>log_quit(&quot;service<span class="_"> </span>not enabled&quot;);</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">134 <span class="_ _15"> </span>pwdp<span class="_"> </span><span class="ls15c">=g<span class="_ _1d"></span><span class="ls0">etpwnam(LPNAME);</span></span></div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">135 <span class="_ _15"> </span>if<span class="_"> </span>(pwdp == NULL)</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">136 <span class="_ _186"> </span>log_sys(&quot;can’t<span class="_"> </span>find user %s&quot;, LPNAME);</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">137 <span class="_ _15"> </span>if<span class="_"> </span>(pwdp-&gt;pw_uid == 0)</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">138 <span class="_ _186"> </span>log_quit(&quot;user<span class="_"> </span>%s is privileged&quot;, LPNAME);</div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">139 <span class="_ _15"> </span>if<span class="_"> </span>(setgid(pwdp-&gt;pw_gid) &lt; 0 || setuid(pwdp-&gt;pw_uid) &lt; 0)</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">140 <span class="_ _186"> </span>log_sys(&quot;can’t<span class="_"> </span>change IDs to user %s&quot;, LPNAME);</div><div class="t m0 x32 h57 y33b4 ff1a fs2d fc0 sc0 ls0 ws0">141 <span class="_ _15"> </span>init_request();</div><div class="t m0 x32 h57 y33b5 ff1a fs2d fc0 sc0 ls0 ws0">142 <span class="_ _15"> </span>init_printer();</div><div class="t m0 x32 h4d y5b9f ff19 fs26 fc0 sc0 ls0 ws0">[122 <span class="_ _a"></span>– <span class="_ _a"></span>131]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>c<span class="_ _23"></span></span>lear the<span class="_"> </span><span class="ff1a">rendezvous <span class="_ _8"></span>fd_set<span class="_ _66"> </span><span class="ff19">variable that <span class="_ _2"></span>we will <span class="_ _2"></span>use with<span class="_ _66"> </span></span>select<span class="_ _66"> </span><span class="ff19">to</span></span></div><div class="t m0 x11a h49 y5ba0 ff19 fs26 fc0 sc0 ls0 ws0">wait for client <span class="_ _2"></span>connect requests. <span class="_"> </span>W<span class="_ _6"></span><span class="ls177d">ei<span class="_ _d"></span><span class="ls0">nitialize the maximum <span class="_ _2"></span>ﬁle descriptor to</span></span></div><div class="t m0 x11a h49 y5ba1 ff20 fs26 fc0 sc0 ls0 ws0">−<span class="ff19">1<span class="_ _59"> </span>so<span class="_ _46"> </span>that <span class="_"> </span>the <span class="_"> </span>ﬁrst <span class="_"> </span>ﬁle <span class="_"> </span>descriptor <span class="_"> </span>we <span class="_"> </span>allocate <span class="_ _e"> </span>is <span class="_"> </span>sure<span class="_ _59"> </span>to<span class="_ _46"> </span>be<span class="_ _59"> </span>g<span class="lscc">re<span class="_ _2"></span></span>ater <span class="_"> </span>than</span></div><div class="t m0 x11a h4d y5ba2 ff1a fs26 fc0 sc0 ls0 ws0">maxfd<span class="ff19 ls177e">.F<span class="_ _1d"></span><span class="ls0">or <span class="_ _3"></span>each <span class="_ _2"></span>network <span class="_ _3"></span>address <span class="_ _2"></span>on <span class="_ _3"></span>which <span class="_ _3"></span>we <span class="_ _2"></span>need <span class="_ _3"></span>to <span class="_ _3"></span>provide <span class="_ _2"></span>service, <span class="_ _3"></span>we</span></span></div><div class="t m0 x11a h4d y5ba3 ff19 fs26 fc0 sc0 ls0 ws0">call<span class="_ _35"> </span><span class="ff1a">initserver<span class="_ _44"> </span></span>(fr<span class="_ _0"></span>om <span class="_ _23"> </span>Figur<span class="ls1405">e1<span class="_ _43"></span><span class="ls0">6.22) <span class="_ _42"> </span>to <span class="_ _23"> </span>allocate <span class="_ _42"> </span>and <span class="_ _42"> </span>initialize <span class="_ _23"> </span>a <span class="_ _42"> </span>socket.<span class="_ _54"> </span>If</span></span></div><div class="t m0 x11a h4d y5ba4 ff1a fs26 fc0 sc0 ls0 ws0">initserver<span class="_ _4b"> </span><span class="ff19">succeeds, <span class="_ _e"> </span>we <span class="_ _e"> </span>add <span class="_ _e"> </span>the <span class="_ _e"> </span>ﬁle <span class="_ _e"> </span>descriptor <span class="_ _e"> </span>to <span class="_ _e"> </span>the<span class="_ _4b"> </span></span>fd_set<span class="ff19">;<span class="_ _59"> </span>if<span class="_ _4b"> </span>it<span class="_ _4b"> </span>is</span></div><div class="t m0 x11a h4d y5ba5 ff19 fs26 fc0 sc0 ls0 ws0">greater than the maximum, we set<span class="_"> </span><span class="ff1a">maxfd<span class="_ _80"> </span></span>equal to the socket ﬁle descriptor<span class="_ _6"></span>.</div><div class="t m0 x32 h4d y5ba6 ff19 fs26 fc0 sc0 ls0 ws0">[132 <span class="_ _a"></span>– <span class="_ _a"></span>133]<span class="_ _65"> </span>If<span class="_ _35"> </span><span class="ff1a">maxfd<span class="_ _45"> </span></span>is <span class="_ _23"> </span>still<span class="_ _35"> </span><span class="ff20">−</span><span class="ls177f">1a<span class="_ _b"></span><span class="ls0">fter <span class="_ _9"></span>stepping <span class="_ _23"> </span>through <span class="_ _23"></span>the <span class="_ _23"></span>list <span class="_ _23"></span>of<span class="_ _35"> </span><span class="ff1a">addrinfo<span class="_ _45"> </span></span>structures,</span></span></div><div class="t m0 x11a h49 y5ba7 ff19 fs26 fc0 sc0 ls0 ws0">we can’t enable the printer spooling service, so we log a message and exit.</div><div class="t m0 x32 h49 y5ba8 ff19 fs26 fc0 sc0 ls0 ws0">[134 <span class="_ _a"></span>– <span class="_ _a"></span>140]<span class="_ _65"> </span>Our <span class="_ _9"></span>daemon <span class="_ _9"></span>needs <span class="_ _9"></span>superuser <span class="_ _9"></span>privileges <span class="_ _9"></span>to <span class="_ _9"></span>bind <span class="_ _9"></span>a <span class="_ _9"></span>socket <span class="_ _9"></span>to <span class="_ _23"></span>a <span class="_ _3"></span>reserved <span class="_ _9"></span>port</div><div class="t m0 x11a h49 y5ba9 ff19 fs26 fc0 sc0 ls0 ws0">number<span class="_ _6"></span><span class="ls1780">.N<span class="_ _62"></span><span class="ls0">ow <span class="_ _9"></span>that <span class="_ _9"></span>this <span class="_ _9"></span>is <span class="_ _9"></span>done, <span class="_ _9"></span>we <span class="_ _9"></span>can <span class="_ _9"></span>lower <span class="_ _3"></span>its <span class="_ _9"></span>privileges <span class="_ _9"></span>by <span class="_ _9"></span>changing <span class="_ _9"></span>its</span></span></div><div class="t m0 x11a h4d y5baa ff19 fs26 fc0 sc0 ls0 ws0">user <span class="_ _42"> </span>and <span class="_ _53"> </span>group <span class="_ _42"> </span>IDs <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _53"> </span>ones <span class="_ _42"> </span>associated <span class="_ _53"> </span>with <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">LPNAME<span class="_ _44"> </span></span>account. <span class="_ _44"> </span>W<span class="_ _6"></span>e</div><div class="t m0 x11a h49 y5bab ff19 fs26 fc0 sc0 ls0 ws0">follow <span class="_ _9"></span>the <span class="_ _9"></span>principles <span class="_ _23"></span>of <span class="_ _9"></span>least <span class="_ _23"></span>privilege <span class="_ _9"></span>to <span class="_ _9"></span>avoid <span class="_ _23"></span>exposing <span class="_ _9"></span>the <span class="_ _9"></span>system <span class="_ _23"></span>to <span class="_ _9"></span>any</div><div class="t m0 x11a h4d y5bac ff19 fs26 fc0 sc0 ls0 ws0">potential <span class="_ _47"> </span>vulnerabilities <span class="_ _47"> </span>in <span class="_ _47"> </span>the <span class="_ _45"> </span>daemon.<span class="_ _50"> </span><span class="ls164">We <span class="_ _46"> </span>c<span class="_ _9"></span></span>all<span class="_ _16"> </span><span class="ff1a">getpwnam<span class="_ _16"> </span></span>to <span class="_ _47"> </span>ﬁnd <span class="_ _45"> </span>the</div><div class="t m0 x11a h49 y5bad ff19 fs26 fc0 sc0 ls0 ws0">passwor<span class="ls166a">de<span class="_ _8"></span><span class="ls0">ntry <span class="_ _2"></span>for <span class="_ _3"></span>the <span class="_ _2"></span>daemon.<span class="_ _61"> </span>If <span class="_ _3"></span>no <span class="_ _2"></span>such <span class="_ _3"></span>user <span class="_ _2"></span>account <span class="_ _3"></span>exists, <span class="_ _2"></span>or <span class="_ _2"></span>if <span class="_ _3"></span>it <span class="_ _2"></span>exists</span></span></div><div class="t m0 x11a h49 y5bae ff19 fs26 fc0 sc0 ls0 ws0">with <span class="_ _23"></span>the <span class="_ _23"></span>same <span class="_ _9"></span>user <span class="_ _23"> </span>ID <span class="_ _23"> </span>as <span class="_ _23"> </span>the <span class="_ _23"> </span>superuser<span class="_ _6"></span>,<span class="_ _35"> </span>we<span class="_ _35"> </span>log <span class="_ _9"></span>an <span class="_ _23"> </span>error <span class="_ _23"></span>message <span class="_ _23"></span>and <span class="_ _9"></span>exit.</div><div class="t m0 x11a h4d y5baf ff19 fs26 fc0 sc0 ls0 ws0">Otherwise, <span class="_ _2"></span>we <span class="_ _2"></span>change <span class="_ _2"></span>both <span class="_ _2"></span>the <span class="_ _2"></span>real <span class="_ _2"></span>and <span class="_ _2"></span>effective IDs <span class="_ _2"></span>by <span class="_ _3"></span>calling<span class="_ _66"> </span><span class="ff1a">setgid<span class="_ _47"> </span></span>and</div><div class="t m0 x11a h4d y5bb0 ff1a fs26 fc0 sc0 ls0 ws0">setuid<span class="ff19 ls1781">.T<span class="_ _52"></span><span class="ls1782">oa<span class="_ _8"></span><span class="ls0">void <span class="_ _9"></span>exposing <span class="_ _3"></span>our <span class="_ _3"></span>system, <span class="_ _3"></span>we <span class="_ _9"></span>choose <span class="_ _3"></span>to <span class="_ _3"></span>provide <span class="_ _3"></span>no <span class="_ _3"></span>service <span class="_ _3"></span>at</span></span></span></div><div class="t m0 x11a h49 y5bb1 ff19 fs26 fc0 sc0 ls0 ws0">all if we can’t reduce our privileges.</div><div class="t m0 x32 h4d y2326 ff19 fs26 fc0 sc0 ls0 ws0">[141 <span class="_ _a"></span>– <span class="_ _a"></span>142]<span class="_ _65"> </span><span class="ls164">We <span class="_ _45"> </span>c<span class="_ _9"></span></span>all<span class="_ _44"> </span><span class="ff1a">init_request<span class="_ _35"> </span></span>to <span class="_ _42"> </span>initialize <span class="_ _42"> </span>the <span class="_ _42"> </span>job <span class="_ _42"> </span>requests <span class="_ _42"> </span>and <span class="_ _42"> </span>ensur<span class="ls1783">et<span class="_ _c"></span><span class="ls0">hat <span class="_ _42"> </span>only</span></span></div><div class="t m0 x11a h4d y2327 ff19 fs26 fc0 sc0 ls0 ws0">one <span class="_ _2"></span>copy <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>daemon <span class="_ _3"></span>is <span class="_ _2"></span>running, <span class="_ _2"></span>and <span class="_ _2"></span>we <span class="_ _2"></span>call<span class="_ _47"> </span><span class="ff1a">init_printer<span class="_ _66"> </span></span>to <span class="_ _2"></span>initialize</div><div class="t m0 x11a h49 y2328 ff19 fs26 fc0 sc0 ls0 ws0">the printer information (we’ll see both of these functions shortly).</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
