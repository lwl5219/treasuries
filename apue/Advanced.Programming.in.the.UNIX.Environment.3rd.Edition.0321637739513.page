<div id="pf201" class="pf w4 h1f" data-page-no="201"><div class="pc pc201 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg201.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>13.7<span class="_ _29d"> </span>Client–Server <span class="_"> </span>Model<span class="_ _1b"> </span><span class="ff18">479</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">sigaddset(&amp;sa.sa_mask, SIGTERM);</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">sa.sa_flags = 0;</div><div class="t m0 x8a h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">if (sigaction(SIGHUP, &amp;sa, NULL) &lt; 0) {</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_ERR, &quot;can’t catch SIGHUP: %s&quot;, strerror(errno));</div><div class="t m0 x9d h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y16f9 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y16df ff1a fs2d fc0 sc0 ls15c ws0">*P<span class="_ _1d"></span><span class="ls0">roceed with the rest of the daemon.</span></div><div class="t m0 x214 h57 y16e0 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y16e1 ff1a fs2d fc0 sc0 ls0 ws0">/* ... */</div><div class="t m0 x8a h57 y16e2 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y16e3 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x60 h2d y3aee ff18 fs10 fc0 sc0 ls0 ws0">Figure 13.8<span class="_ _5a"> </span><span class="ff19">Alternative implementation of daemon rereading conﬁguration ﬁles</span></div><div class="t m0 x32 h4d y3aef ff19 fs26 fc0 sc0 ls0 ws0">After <span class="_ _2"></span>initializing <span class="_ _3"></span>the <span class="_ _2"></span>daemon, <span class="_ _3"></span>we <span class="_ _2"></span>install <span class="_ _3"></span>signal <span class="_ _2"></span>handlers <span class="_ _3"></span>for<span class="_ _47"> </span><span class="ff1a">SIGHUP<span class="_ _66"> </span></span>and<span class="_ _47"> </span><span class="ff1a">SIGTERM</span><span class="lsfa3">.W<span class="_ _7"></span><span class="ls0">e</span></span></div><div class="t m0 x32 h49 y3af0 ff19 fs26 fc0 sc0 ls0 ws0">can either place the reread logic in the signal handler or <span class="_ _2"></span>just set a ﬂag <span class="_ _2"></span>in the handler and</div><div class="t m0 x32 h49 y3af1 ff19 fs26 fc0 sc0 ls0 ws0">have the main thread of the daemon do all the work instead.</div><div class="t m0 x35 h99 y3af2 ff16 fs3b fc0 sc0 ls0 ws0">13.7 <span class="_ _93"> </span>Client–Server <span class="_"> </span>Model</div><div class="t m0 x32 h55 y3af3 ff19 fs2c fc0 sc0 lsfa4 ws0">Ac<span class="_ _b"></span><span class="ls0">ommon <span class="_ _9"></span>use <span class="_ _3"></span>for <span class="_ _9"></span>a <span class="_ _3"></span>daemon <span class="_ _9"></span>process <span class="_ _3"></span>is <span class="_ _3"></span>as <span class="_ _9"></span>a <span class="_ _3"></span>server <span class="_ _9"></span>process. <span class="_ _47"> </span>Indeed,<span class="_ _45"> </span>in <span class="_ _3"></span>Figur<span class="lsfa5">e1<span class="_ _b"></span><span class="ls0">3.2, <span class="_ _3"></span>we</span></span></span></div><div class="t m0 x32 h54 y3af4 ff19 fs2c fc0 sc0 ls0 ws0">can <span class="_ _23"> </span>call <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">syslogd<span class="_ _35"> </span></span>process <span class="_ _23"> </span>a <span class="_ _42"> </span>server <span class="_ _42"> </span>that <span class="_ _23"> </span>has <span class="_ _42"> </span>messages <span class="_ _42"> </span>sent <span class="_ _23"> </span>to <span class="_ _42"> </span>it <span class="_ _42"> </span>by <span class="_ _42"> </span>user <span class="_ _23"> </span>processes</div><div class="t m0 x32 h55 y3af5 ff19 fs2c fc0 sc0 ls0 ws0">(clients) using a UNIX domain datagram socket.</div><div class="t m0 x3f h60 y3af6 ff19 fs2c fc0 sc0 ls0 ws0">In <span class="_ _9"></span>general, <span class="_ _3"></span>a<span class="_ _45"> </span><span class="ff1b">server<span class="_ _45"> </span></span>is <span class="_ _3"></span>a <span class="_ _9"></span>process <span class="_ _3"></span>that <span class="_ _9"></span>waits <span class="_ _9"></span>for <span class="_ _9"></span>a<span class="_ _45"> </span><span class="ff1b">client<span class="_ _45"> </span></span>to <span class="_ _3"></span>contact <span class="_ _9"></span>it, <span class="_ _9"></span>requesting <span class="_ _3"></span>some</div><div class="t m0 x32 h54 y3af7 ff19 fs2c fc0 sc0 ls0 ws0">type <span class="_ _2"></span>of <span class="_ _2"></span>service.<span class="_ _61"> </span>In <span class="_ _3"></span>Figur<span class="lsce8">e1<span class="_ _8"></span><span class="ls0">3.2, <span class="_ _2"></span>the <span class="_ _3"></span>service <span class="_ _2"></span>being <span class="_ _2"></span>provided <span class="_ _2"></span>by <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">syslogd<span class="_ _66"> </span></span>server <span class="_ _2"></span>is <span class="_ _3"></span>the</span></span></div><div class="t m0 x32 h55 y3af8 ff19 fs2c fc0 sc0 ls0 ws0">logging of an error message.</div><div class="t m0 x3f h55 y3af9 ff19 fs2c fc0 sc0 ls0 ws0">In <span class="_ _42"> </span>Figur<span class="lsfa6">e1<span class="_ _c"></span><span class="ls0">3.2, <span class="_ _53"> </span>the <span class="_ _42"> </span>communication <span class="_ _42"> </span>between <span class="_ _53"> </span>the <span class="_ _42"> </span>client <span class="_ _53"> </span>and <span class="_ _42"> </span>the <span class="_ _53"> </span>server <span class="_ _42"> </span>is <span class="_ _53"> </span>one <span class="_ _42"> </span>way<span class="_ _6"></span>.</span></span></div><div class="t m0 x32 h55 y3afa ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _9"></span>client <span class="_ _23"> </span>sends <span class="_ _23"></span>its <span class="_ _9"></span>service <span class="_ _23"> </span>request <span class="_ _9"></span>to <span class="_ _23"></span>the <span class="_ _23"></span>server; <span class="_ _9"></span>the <span class="_ _23"></span>server <span class="_ _9"></span>sends <span class="_ _23"> </span>nothing <span class="_ _23"></span>back <span class="_ _9"></span>to <span class="_ _23"> </span>the</div><div class="t m0 x32 h55 y3afb ff19 fs2c fc0 sc0 ls0 ws0">client. <span class="_ _5f"> </span>In<span class="_ _1a3"> </span>the <span class="_ _16"> </span>upcoming <span class="_ _5a"> </span>chapters, <span class="_ _5a"> </span>we’ll <span class="_ _16"> </span>see <span class="_ _5a"> </span>numerous <span class="_ _61"> </span>examples <span class="_ _5a"> </span>of <span class="_ _5a"> </span>two-way</div><div class="t m0 x32 h55 y3afc ff19 fs2c fc0 sc0 ls0 ws0">communication <span class="_ _3"></span>between <span class="_ _3"></span>a <span class="_ _9"></span>client <span class="_ _3"></span>and <span class="_ _9"></span>a <span class="_ _3"></span>server<span class="_ _9"></span><span class="ls6bf">—t<span class="_ _6"></span><span class="ls0">he <span class="_ _9"></span>client <span class="_ _3"></span>sends <span class="_ _9"></span>a <span class="_ _3"></span>request <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>server<span class="_ _6"></span>,</span></span></div><div class="t m0 x32 h55 y3afd ff19 fs2c fc0 sc0 ls0 ws0">and the server sends a reply back to the client.</div><div class="t m0 x3f h54 y3afe ff19 fs2c fc0 sc0 ls0 ws0">It <span class="_"> </span>is <span class="_ _e"> </span>common <span class="_"> </span>to <span class="_ _e"> </span>ﬁnd <span class="_"> </span>servers <span class="_"> </span>that<span class="_ _4b"> </span><span class="ff1a">fork<span class="_ _59"> </span></span>and<span class="_ _46"> </span><span class="ff1a">exec<span class="_ _59"> </span></span>another <span class="_"> </span>pr<span class="_ _0"></span>ogram <span class="_"> </span>to <span class="_ _e"> </span>provide</div><div class="t m0 x32 h55 y3aff ff19 fs2c fc0 sc0 ls0 ws0">service to a <span class="_ _2"></span>client.<span class="_ _46"> </span>These <span class="_ _2"></span>servers often <span class="_ _2"></span>manage multiple <span class="_ _2"></span>ﬁle descriptors: communication</div><div class="t m0 x32 h55 y3b00 ff19 fs2c fc0 sc0 ls0 ws0">endpoints, <span class="_ _42"> </span>conﬁguration <span class="_ _42"> </span>ﬁles, <span class="_ _42"> </span>log <span class="_ _42"> </span>ﬁles, <span class="_ _42"> </span>and <span class="_ _42"> </span>the <span class="_ _42"> </span>like.<span class="_ _54"> </span>At <span class="_ _42"> </span>best, <span class="_ _42"> </span>it <span class="_ _42"> </span>would <span class="_ _42"> </span>be <span class="_ _42"> </span>careless <span class="_ _42"> </span>to</div><div class="t m0 x32 h55 y3b01 ff19 fs2c fc0 sc0 ls0 ws0">leave <span class="_ _23"></span>these <span class="_ _23"></span>ﬁle <span class="_ _23"> </span>descriptors <span class="_ _23"> </span>open <span class="_ _23"> </span>in <span class="_ _23"> </span>the <span class="_ _23"> </span>child <span class="_ _42"> </span>pr<span class="_ _0"></span>ocess, <span class="_ _23"></span>because <span class="_ _23"> </span>they <span class="_ _23"> </span>probably <span class="_ _23"></span>won’t <span class="_ _23"></span>be</div><div class="t m0 x32 h55 y3b02 ff19 fs2c fc0 sc0 ls0 ws0">used <span class="_ _2"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>program <span class="_ _2"></span>executed <span class="_ _2"></span>by <span class="_ _3"></span>the <span class="_ _3"></span>child, <span class="_ _2"></span>especially <span class="_ _3"></span>if <span class="_ _3"></span>the <span class="_ _2"></span>program <span class="_ _2"></span>is <span class="_ _3"></span>unrelated <span class="_ _2"></span>to <span class="_ _3"></span>the</div><div class="t m0 x32 h55 y3b03 ff19 fs2c fc0 sc0 ls0 ws0">server<span class="_ _6"></span><span class="lsfa7">.A<span class="_ _5d"></span><span class="lsc89">tw<span class="_ _4a"></span><span class="ls0">orst, <span class="_"> </span>leaving <span class="_"> </span>them <span class="_"> </span>open <span class="_"> </span>could <span class="_"> </span>pose <span class="_"> </span>a <span class="_"> </span>security <span class="_"> </span>problem <span class="_ _a"></span>— <span class="_ _a"></span>the<span class="_ _46"> </span>program</span></span></span></div><div class="t m0 x32 h55 y3b04 ff19 fs2c fc0 sc0 ls0 ws0">executed <span class="_ _9"></span>could <span class="_ _23"></span>do <span class="_ _9"></span>something <span class="_ _23"></span>malicious, <span class="_ _9"></span>such <span class="_ _23"></span>as <span class="_ _9"></span>change <span class="_ _9"></span>the <span class="_ _23"></span>server<span class="_ _3"></span>’s <span class="_ _23"></span>conﬁguration <span class="_ _9"></span>ﬁle</div><div class="t m0 x32 h55 y3b05 ff19 fs2c fc0 sc0 ls0 ws0">or <span class="_ _42"> </span>trick <span class="_ _53"> </span>the <span class="_ _42"> </span>client <span class="_ _53"> </span>into <span class="_ _42"> </span>thinking <span class="_ _53"> </span>it <span class="_ _42"> </span>is <span class="_ _53"> </span>communicating <span class="_ _42"> </span>with <span class="_ _53"> </span>the <span class="_ _42"> </span>server<span class="_ _1"></span><span class="lsfa8">,t<span class="_ _43"></span><span class="ls0">her<span class="_ _1"></span>eby <span class="_ _53"> </span>gaining</span></span></div><div class="t m0 x32 h55 y3b06 ff19 fs2c fc0 sc0 ls0 ws0">access to unauthorized information.</div><div class="t m0 x3f h55 y3b07 ff19 fs2c fc0 sc0 ls0 ws0">An <span class="_ _45"> </span>easy <span class="_ _35"> </span>solution <span class="_ _45"> </span>to <span class="_ _35"> </span>this <span class="_ _45"> </span>problem <span class="_ _35"> </span>is <span class="_ _45"> </span>to <span class="_ _35"> </span>set <span class="_ _45"> </span>the <span class="_ _35"> </span>close-on-exec <span class="_ _45"> </span>ﬂag <span class="_ _35"> </span>for <span class="_ _45"> </span>all <span class="_ _35"> </span>ﬁle</div><div class="t m0 x32 h55 y3b08 ff19 fs2c fc0 sc0 ls0 ws0">descriptors that the executed program won’t need.<span class="_ _59"> </span>Figur<span class="lsfa9">e1<span class="_ _4f"></span><span class="ls0">3.9 shows a function that we</span></span></div><div class="t m0 x32 h55 y3b09 ff19 fs2c fc0 sc0 ls0 ws0">can use in a server process to do just this.</div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892842px;bottom:756.039909px;width:154.824600px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
