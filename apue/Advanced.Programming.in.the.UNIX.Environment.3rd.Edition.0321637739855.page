<div id="pf357" class="pf w4 h1f" data-page-no="357"><div class="pc pc357 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg357.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">821</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">254 <span class="_ _15"> </span>jp-&gt;jobid<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">obid;</span></span></div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">255 <span class="_ _15"> </span>jp-&gt;next<span class="_"> </span><span class="ls15c">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">256 <span class="_ _15"> </span>pthread_mutex_lock(&amp;joblock);</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">257 <span class="_ _15"> </span>jp-&gt;prev<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">obtail;</span></span></div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">258 <span class="_ _15"> </span>if<span class="_"> </span>(jobtail == NULL)</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">259 <span class="_ _186"> </span>jobhead<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">260 <span class="_ _15"> </span>else</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">261 <span class="_ _186"> </span>jobtail-&gt;next<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">262 <span class="_ _15"> </span>jobtail<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">263 <span class="_ _15"> </span>pthread_mutex_unlock(&amp;joblock);</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">264 <span class="_ _15"> </span>pthread_cond_signal(&amp;jobwait);</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">265 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y5712 ff1a fs2d fc0 sc0 ls0 ws0">266 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y5713 ff1a fs2d fc0 sc0 ls0 ws0">267 <span class="_ _68"> </span>*<span class="_"> </span>Replace a job back on the head of the list.</div><div class="t m0 x32 h57 y5714 ff1a fs2d fc0 sc0 ls0 ws0">268 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y5715 ff1a fs2d fc0 sc0 ls0 ws0">269 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: acquires and releases joblock.</div><div class="t m0 x32 h57 y5716 ff1a fs2d fc0 sc0 ls0 ws0">270 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y5717 ff1a fs2d fc0 sc0 ls0 ws0">271 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y5844 ff1a fs2d fc0 sc0 ls0 ws0">272 <span class="_ _d9"> </span>replace_job(struct<span class="_"> </span>job *jp)</div><div class="t m0 x32 h57 y5845 ff1a fs2d fc0 sc0 ls0 ws0">273 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y5846 ff1a fs2d fc0 sc0 ls0 ws0">274 <span class="_ _15"> </span>pthread_mutex_lock(&amp;joblock);</div><div class="t m0 x32 h57 y5847 ff1a fs2d fc0 sc0 ls0 ws0">275 <span class="_ _15"> </span>jp-&gt;prev<span class="_"> </span><span class="ls15c">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h57 y5ae2 ff1a fs2d fc0 sc0 ls0 ws0">276 <span class="_ _15"> </span>jp-&gt;next<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">obhead;</span></span></div><div class="t m0 x32 h57 y5ae3 ff1a fs2d fc0 sc0 ls0 ws0">277 <span class="_ _15"> </span>if<span class="_"> </span>(jobhead == NULL)</div><div class="t m0 x32 h57 y5ae4 ff1a fs2d fc0 sc0 ls0 ws0">278 <span class="_ _186"> </span>jobtail<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y5ae5 ff1a fs2d fc0 sc0 ls0 ws0">279 <span class="_ _15"> </span>else</div><div class="t m0 x32 h57 y5ae6 ff1a fs2d fc0 sc0 ls0 ws0">280 <span class="_ _186"> </span>jobhead-&gt;prev<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y5bcf ff1a fs2d fc0 sc0 ls0 ws0">281 <span class="_ _15"> </span>jobhead<span class="_"> </span><span class="ls15c">=j<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y5bd0 ff1a fs2d fc0 sc0 ls0 ws0">282 <span class="_ _15"> </span>pthread_mutex_unlock(&amp;joblock);</div><div class="t m0 x32 h57 y5bd1 ff1a fs2d fc0 sc0 ls0 ws0">283 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y5bd2 ff19 fs26 fc0 sc0 ls0 ws0">[254 <span class="_ _a"></span>– <span class="_ _a"></span>265]<span class="_ _65"> </span><span class="ls164">We <span class="_ _80"> </span>s<span class="_ _9"></span></span>ave <span class="_ _9"></span>the <span class="_ _3"></span>job <span class="_ _9"></span>ID <span class="_ _3"></span>and <span class="_ _3"></span>lock <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">joblock<span class="_ _45"> </span></span>mutex <span class="_ _3"></span>to <span class="_ _3"></span>gain <span class="_ _9"></span>exclusive <span class="_ _3"></span>access <span class="_ _3"></span>to</div><div class="t m0 x11a h49 y5bd3 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>linked <span class="_ _2"></span>list <span class="_ _2"></span>of <span class="_ _2"></span>print <span class="_ _2"></span>jobs.<span class="_ _46"> </span><span class="ls164">We <span class="_ _80"> </span>a<span class="_ _9"></span><span class="lscc">re <span class="_ _3"></span>a<span class="_ _2"></span></span></span>bout <span class="_ _2"></span>to <span class="_ _2"></span>add <span class="_ _2"></span>the <span class="_ _2"></span>new <span class="_ _2"></span>job <span class="_ _2"></span>structure<span class="_"> </span>to<span class="_ _47"> </span>the</div><div class="t m0 x11a h49 y5bd4 ff19 fs26 fc0 sc0 ls0 ws0">end <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _3"></span>list.<span class="_ _61"> </span><span class="ls164">We <span class="_ _e"> </span>s<span class="_ _23"></span></span>et <span class="_ _2"></span>the <span class="_ _2"></span>new <span class="_ _2"></span>structure’s <span class="_ _2"></span>previous <span class="_ _2"></span>pointer <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _3"></span>last <span class="_ _2"></span>job <span class="_ _2"></span>on</div><div class="t m0 x11a h4d y5bd5 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>list.<span class="_ _51"> </span>If <span class="_ _23"></span>the <span class="_ _9"></span>list <span class="_ _23"></span>is <span class="_ _23"></span>empty<span class="_ _4"></span>,<span class="_ _45"> </span>we<span class="_ _35"> </span>set<span class="_ _45"> </span><span class="ff1a">jobhead<span class="_ _35"> </span></span>to <span class="_ _9"></span>point <span class="_ _23"> </span>to <span class="_ _23"></span>the <span class="_ _9"></span>new <span class="_ _23"></span>structure.</div><div class="t m0 x11a h49 y5bd6 ff19 fs26 fc0 sc0 ls0 ws0">Otherwise, <span class="_ _2"></span>we <span class="_ _3"></span>set <span class="_ _2"></span>the <span class="_ _3"></span>next <span class="_ _2"></span>pointer <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>last <span class="_ _2"></span>entry <span class="_ _3"></span>on <span class="_ _2"></span>the <span class="_ _3"></span>list <span class="_ _2"></span>to <span class="_ _3"></span>point <span class="_ _2"></span>to <span class="_ _3"></span>the</div><div class="t m0 x11a h4d y5bd7 ff19 fs26 fc0 sc0 ls0 ws0">new <span class="_ _53"> </span>structure. <span class="_ _4b"> </span>Then<span class="_ _4b"> </span>we <span class="_ _53"> </span>set<span class="_ _59"> </span><span class="ff1a">jobtail<span class="_ _4b"> </span></span>to <span class="_ _53"> </span>point <span class="_ _e"> </span>to <span class="_ _e"> </span>the <span class="_ _e"> </span>new <span class="_ _e"> </span>structure. <span class="_ _44"> </span>W<span class="_ _6"></span>e</div><div class="t m0 x11a h49 y5bd8 ff19 fs26 fc0 sc0 ls0 ws0">unlock the mutex and signal the printer thread that another job is available.</div><div class="t m0 x32 h4d y5bd9 ff19 fs26 fc0 sc0 ls0 ws0">[266 <span class="_ _a"></span>– <span class="_ _a"></span>283]<span class="_ _65"> </span>The<span class="_"> </span><span class="ff1a">replace_job<span class="_ _66"> </span></span>function is used <span class="_ _2"></span>to insert a <span class="_ _2"></span>job at the <span class="_ _2"></span>head of the <span class="_ _2"></span>pending</div><div class="t m0 x11a h4d y5bda ff19 fs26 fc0 sc0 ls0 ws0">job <span class="_ _2"></span>list.<span class="_ _61"> </span><span class="ls164">We <span class="_ _80"> </span>a<span class="_ _9"></span></span>cquir<span class="lsfcb">et<span class="_ _4f"></span><span class="ls0">he<span class="_ _66"> </span><span class="ff1a">joblock<span class="_ _47"> </span></span>mutex, <span class="_ _3"></span>set <span class="_ _2"></span>the <span class="_ _3"></span>previous pointer <span class="_ _3"></span>in <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">job</span></span></span></div><div class="t m0 x11a h4d y5bdb ff19 fs26 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span><span class="ls179b">et<span class="_ _b"></span><span class="ls0">o<span class="_ _45"> </span><span class="ff1a">NULL</span><span class="ls179b">,a<span class="_ _b"></span><span class="ls0">nd <span class="_ _9"></span>set <span class="_ _23"></span>the <span class="_ _9"></span>next <span class="_ _23"></span>pointer <span class="_ _9"></span>in <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">job<span class="_ _35"> </span></span>structur<span class="_ _0"></span>e<span class="_ _45"> </span>to<span class="_ _45"> </span>point <span class="_ _23"></span>to</span></span></span></span></div><div class="t m0 x11a h4d y5bdc ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>head <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>list.<span class="_ _16"> </span>If <span class="_ _9"></span>the <span class="_ _3"></span>list <span class="_ _3"></span>is <span class="_ _3"></span>empty<span class="_ _6"></span>,<span class="_ _47"> </span>we<span class="_ _47"> </span>set<span class="_ _47"> </span><span class="ff1a">jobtail<span class="_ _45"> </span></span>to <span class="_ _2"></span>point <span class="_ _9"></span>to <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">job</span></div><div class="t m0 x11a h49 y5bdd ff19 fs26 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>e<span class="_ _44"> </span>we<span class="_ _44"> </span>a<span class="lscc">re <span class="_"> </span>re</span>placing. <span class="_ _44"> </span>Otherwise,<span class="_ _44"> </span>we <span class="_ _42"> </span>set <span class="_ _53"> </span>the <span class="_ _42"> </span>previous <span class="_ _42"> </span>pointer <span class="_ _53"> </span>in <span class="_ _42"> </span>the</div><div class="t m0 x11a h4d y5bde ff19 fs26 fc0 sc0 ls0 ws0">ﬁrst<span class="_ _47"> </span><span class="ff1a">job<span class="_ _47"> </span></span>structure<span class="_ _47"> </span>on<span class="_ _47"> </span>the <span class="_ _9"></span>list <span class="_ _3"></span>to <span class="_ _3"></span>point <span class="_ _3"></span>to <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">job<span class="_ _47"> </span></span>structure<span class="_ _47"> </span>we<span class="_ _47"> </span>a<span class="lscc">re <span class="_ _23"></span>re</span>placing.</div><div class="t m0 x11a h4d y5bdf ff19 fs26 fc0 sc0 ls0 ws0">Then <span class="_ _53"> </span>we <span class="_ _e"> </span>set <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">jobhead<span class="_ _4b"> </span></span>pointer <span class="_ _53"> </span>to <span class="_ _e"> </span>the<span class="_ _4b"> </span><span class="ff1a">job<span class="_ _4b"> </span></span>structur<span class="ls179c">ew<span class="_ _55"></span><span class="ls1404">ea<span class="_ _55"></span><span class="lscc">re <span class="_"> </span>re<span class="_ _2"></span><span class="ls0">placing.</span></span></span></span></div><div class="t m0 x11a h4d y5be0 ff19 fs26 fc0 sc0 ls0 ws0">Finally<span class="_ _4"></span>,<span class="_"> </span>we<span class="_"> </span>release the<span class="_"> </span><span class="ff1a">joblock<span class="_ _80"> </span></span>mutex.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
