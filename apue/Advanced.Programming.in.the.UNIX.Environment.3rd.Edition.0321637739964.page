<div id="pf3c4" class="pf w4 h1f" data-page-no="3c4"><div class="pc pc3c4 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg3c4.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">930<span class="_ _1b"> </span><span class="ff19">Solutions <span class="_"> </span>to <span class="_"> </span>Selected <span class="_"> </span>Exercises <span class="_ _2eb"> </span>Appendix<span class="_ _4b"> </span>C</span></div><div class="t m0 xe2 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _9"></span>results <span class="_ _3"></span>depend <span class="_ _9"></span>on <span class="_ _9"></span>the <span class="_ _9"></span>platform.<span class="_ _5a"> </span>Recall <span class="_ _9"></span>that<span class="_ _45"> </span><span class="ff1a">daemonize<span class="_ _45"> </span></span>closes <span class="_ _9"></span>all <span class="_ _9"></span>open <span class="_ _9"></span>ﬁle</div><div class="t m0 xe2 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">descriptors <span class="_ _3"></span>and <span class="_ _9"></span>then <span class="_ _3"></span>reopens <span class="_ _3"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _9"></span>three <span class="_ _2"></span>to<span class="_ _45"> </span><span class="ff1a">/dev/null</span><span class="ls146c">.T<span class="_ _62"></span><span class="ls0">his <span class="_ _9"></span>means <span class="_ _3"></span>that <span class="_ _9"></span>the</span></span></div><div class="t m0 xe2 h26 y131 ff19 fsf fc0 sc0 ls0 ws0">process won’t <span class="_ _3"></span>have <span class="_ _2"></span>a <span class="_ _3"></span>controlling terminal, <span class="_ _3"></span>so<span class="_ _47"> </span><span class="ff1a">getlogin<span class="_ _66"> </span></span>won’t <span class="_ _3"></span>be <span class="_ _2"></span>able <span class="_ _3"></span>to <span class="_ _2"></span>look <span class="_ _2"></span>in</div><div class="t m0 xe2 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">the<span class="_ _45"> </span><span class="ff1a">utmp<span class="_ _35"> </span></span>ﬁle <span class="_ _9"></span>for <span class="_ _23"></span>the <span class="_ _23"></span>pr<span class="_ _0"></span>ocess’s <span class="_ _23"></span>login <span class="_ _9"></span>entry<span class="_ _6"></span><span class="ls185b">.T<span class="_ _26"></span><span class="ls0">hus, <span class="_ _9"></span>on <span class="_ _23"> </span>Linux <span class="_ _23"></span>3.2.0 <span class="_ _9"></span>and <span class="_ _23"> </span>Solaris <span class="_ _23"></span>10,</span></span></div><div class="t m0 xe2 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">we ﬁnd that a daemon has no login name.</div><div class="t m0 xe2 h2a y31e ff19 fsf fc0 sc0 ls0 ws0">Under <span class="_ _2"></span>FreeBSD <span class="_ _2"></span>8.0 <span class="_ _3"></span>and <span class="_ _2"></span>Mac <span class="_ _3"></span>OS <span class="_ _3"></span>X <span class="_ _2"></span>10.6.8, <span class="_ _3"></span>however<span class="_ _1"></span><span class="ls185c">,t<span class="_ _8"></span><span class="ls0">he <span class="_ _3"></span>login <span class="_ _3"></span>name <span class="_ _2"></span>is <span class="_ _3"></span>maintained</span></span></div><div class="t m0 xe2 h26 y31f ff19 fsf fc0 sc0 ls0 ws0">in <span class="_ _9"></span>the <span class="_ _9"></span>process <span class="_ _9"></span>table <span class="_ _9"></span>and <span class="_ _9"></span>copied <span class="_ _9"></span>across <span class="_ _9"></span>a<span class="_ _45"> </span><span class="ff1a">fork</span><span class="ls185d">.T<span class="_ _26"></span><span class="ls0">his <span class="_ _9"></span>means <span class="_ _9"></span>that <span class="_ _23"></span>the <span class="_ _9"></span>process <span class="_ _3"></span>can</span></span></div><div class="t m0 xe2 h2a y320 ff19 fsf fc0 sc0 ls0 ws0">always get <span class="_ _2"></span>the login <span class="_ _2"></span>name, <span class="_ _2"></span>unless the <span class="_ _2"></span>parent didn’t <span class="_ _2"></span>have one <span class="_ _2"></span>to <span class="_ _2"></span>start out <span class="_ _2"></span>(such <span class="_ _2"></span>as</div><div class="t m0 xe2 h26 y321 ff1a fsf fc0 sc0 ls0 ws0">init<span class="_ _80"> </span><span class="ff19">when the system is bootstrapped).</span></div><div class="t m0 x35 h27 y5d4 ff16 fsf fc0 sc0 ls0 ws0">Chapter <span class="_"> </span>14</div><div class="t m0 x32 h2a y1f0f ff18 fsf fc0 sc0 ls0 ws0">14.1<span class="_ _210"> </span><span class="ff19">The test program is shown in Figur<span class="ls44">eC<span class="_ _4f"></span><span class="ls0">.15.</span></span></span></div><div class="t m0 xe2 h4e y61c7 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 xe2 h4e y61c8 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 xe2 h4e y61c9 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 xe2 h4e y61ca ff1a fs28 fc0 sc0 ls0 ws0">void</div><div class="t m0 xe2 h4e y61cb ff1a fs28 fc0 sc0 ls0 ws0">sigint(int signo)</div><div class="t m0 xe2 h4e y61cc ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 xe2 h4e y61cd ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 xe2 h4e y61ce ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 xe2 h4e y61cf ff1a fs28 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 xe2 h4e y61d0 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x60 h4e y61d1 ff1a fs28 fc0 sc0 ls0 ws0">pid_t pid1, pid2, pid3;</div><div class="t m0 x60 h4e y61d2 ff1a fs28 fc0 sc0 ls0 ws0">int fd;</div><div class="t m0 x60 h4e y61d3 ff1a fs28 fc0 sc0 ls0 ws0">setbuf(stdout, NULL);</div><div class="t m0 x60 h4e y61d4 ff1a fs28 fc0 sc0 ls0 ws0">signal_intr(SIGINT, sigint);</div><div class="t m0 x60 h4e y61d5 ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x211 h4e y61d6 ff1a fs28 fc0 sc0 ls1b6 ws0">*C<span class="_ _1d"></span><span class="ls0">reate a file.</span></div><div class="t m0 x211 h4e y61d7 ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x60 h4e y61d8 ff1a fs28 fc0 sc0 ls0 ws0">if ((fd = open(&quot;lockfile&quot;, O_RDWR|O_CREAT, 0666)) &lt; 0)</div><div class="t m0 xb9 h4e y61d9 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;can’t open/create lockfile&quot;);</div><div class="t m0 x60 h4e y61da ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x211 h4e y61db ff1a fs28 fc0 sc0 ls1b6 ws0">*R<span class="_ _1d"></span><span class="ls0">ead-lock the file.</span></div><div class="t m0 x211 h4e y61dc ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x60 h4e y61dd ff1a fs28 fc0 sc0 ls0 ws0">if ((pid1 = fork()) &lt; 0) {</div><div class="t m0 xb9 h4e y61de ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;fork failed&quot;);</div><div class="t m0 x60 h4e y61df ff1a fs28 fc0 sc0 ls1b6 ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pid1 == 0) { /* child */</span></div><div class="t m0 xb9 h4e y61e0 ff1a fs28 fc0 sc0 ls0 ws0">if (lock_reg(fd, F_SETLK, F_RDLCK, 0, SEEK_SET, 0) &lt; 0)</div><div class="t m0 x1ce h4e y61e1 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;child 1: can’t read-lock file&quot;);</div><div class="t m0 xb9 h4e y61e2 ff1a fs28 fc0 sc0 ls0 ws0">printf(&quot;child 1: obtained read lock on file\n&quot;);</div><div class="t m0 xb9 h4e y61e3 ff1a fs28 fc0 sc0 ls0 ws0">pause();</div><div class="t m0 xb9 h4e y61e4 ff1a fs28 fc0 sc0 ls0 ws0">printf(&quot;child 1: exit after pause\n&quot;);</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
