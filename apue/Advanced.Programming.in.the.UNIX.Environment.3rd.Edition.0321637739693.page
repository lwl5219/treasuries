<div id="pf2b5" class="pf w4 h1f" data-page-no="2b5"><div class="pc pc2b5 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2b5.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.6<span class="_ _67"> </span>An <span class="_"> </span>Open <span class="_"> </span>Server<span class="_ _6"></span><span class="ls30a">,V<span class="_ _1d"></span><span class="ls0">ersion <span class="_"> </span>2<span class="_ _1b"> </span><span class="ff18">659</span></span></span></div><div class="t m0 x35 h53 y12f ff16 fs2b fc0 sc0 ls0 ws0">17.6 <span class="_ _93"> </span>An<span class="_ _54"> </span>Open <span class="_"> </span>Server<span class="_ _1"></span><span class="ls1c3">,V<span class="_ _64"></span><span class="ls0">er<span class="_ _0"></span>sion <span class="_"> </span>2</span></span></div><div class="t m0 x32 h26 y4de ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _3"></span>the <span class="_ _3"></span>previous <span class="_ _3"></span>section, <span class="_ _3"></span>we <span class="_ _3"></span>developed <span class="_ _3"></span>an <span class="_ _9"></span>open <span class="_ _3"></span>server <span class="_ _3"></span>that <span class="_ _3"></span>was <span class="_ _3"></span>invoked <span class="_ _9"></span>by <span class="_ _3"></span>a<span class="_ _47"> </span><span class="ff1a">fork<span class="_ _47"> </span></span>and</div><div class="t m0 x32 h26 y6d0 ff1a fsf fc0 sc0 ls0 ws0">exec<span class="_ _35"> </span><span class="ff19">by <span class="_ _23"></span>the <span class="_ _23"> </span>client, <span class="_ _23"> </span>demonstrating <span class="_ _42"> </span>how <span class="_ _23"></span>we <span class="_ _23"></span>can <span class="_ _23"> </span>pass <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>descriptors <span class="_ _23"></span>from <span class="_ _23"></span>a <span class="_ _23"></span>child <span class="_ _23"></span>to <span class="_ _23"> </span>a</span></div><div class="t m0 x32 h2a y6d1 ff19 fsf fc0 sc0 ls0 ws0">parent. <span class="_ _35"> </span>In<span class="_ _35"> </span>this <span class="_ _23"> </span>section, <span class="_ _42"> </span>we <span class="_ _23"> </span>develop <span class="_ _42"> </span>an <span class="_ _23"> </span>open <span class="_ _42"> </span>server <span class="_ _23"> </span>as <span class="_ _42"> </span>a <span class="_ _42"> </span>daemon <span class="_ _23"> </span>process. <span class="_ _35"> </span>One<span class="_ _35"> </span>server</div><div class="t m0 x32 h26 y6d2 ff19 fsf fc0 sc0 ls0 ws0">handles all clients.<span class="_ _46"> </span><span class="ls5f">We <span class="_ _53"> </span>e<span class="_ _9"></span></span>xpect <span class="_ _2"></span>this design to be mor<span class="ls13f8">ee<span class="_ _d"></span><span class="ls45">fﬁ<span class="ls0">cient, <span class="_ _2"></span>since a<span class="_"> </span><span class="ff1a">fork<span class="_ _66"> </span></span>and an<span class="_"> </span><span class="ff1a">exec</span></span></span></span></div><div class="t m0 x32 h2a y6d3 ff19 fsf fc0 sc0 ls0 ws0">ar<span class="ls13f9">ea<span class="_ _4a"></span><span class="ls0">voided. <span class="_ _59"> </span>W<span class="_ _6"></span><span class="ls13f9">eu<span class="_ _55"></span><span class="ls0">se <span class="_ _e"> </span>a <span class="_ _e"> </span>UNIX <span class="_ _e"> </span>domain <span class="_ _e"> </span>socket <span class="_ _e"> </span>connection <span class="_ _e"> </span>between <span class="_ _e"> </span>the <span class="_ _e"> </span>client <span class="_ _e"> </span>and <span class="_ _e"> </span>the</span></span></span></span></div><div class="t m0 x32 h2a y6d4 ff19 fsf fc0 sc0 ls0 ws0">server <span class="_ _2"></span>and <span class="_ _3"></span>demonstrate <span class="_ _2"></span>passing <span class="_ _3"></span>ﬁle <span class="_ _2"></span>descriptors <span class="_ _3"></span>between <span class="_ _2"></span>unrelated <span class="_ _2"></span>processes. <span class="_ _66"> </span>W<span class="_ _6"></span>e’ll <span class="_ _3"></span>use</div><div class="t m0 x32 h26 y6d5 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _44"> </span>three <span class="_ _35"> </span>functions<span class="_ _54"> </span><span class="ff1a">serv_listen</span>,<span class="_ _54"> </span><span class="ff1a">serv_accept</span><span class="ls13fa">,a<span class="_ _52"></span><span class="ls0">nd<span class="_ _54"> </span><span class="ff1a">cli_conn<span class="_ _54"> </span></span>introduced <span class="_ _44"> </span>in</span></span></div><div class="t m0 x32 h2a y6d6 ff19 fsf fc0 sc0 ls0 ws0">Section <span class="_ _42"> </span>17.3.<span class="_ _54"> </span>This <span class="_ _53"> </span>server <span class="_ _42"> </span>also <span class="_ _53"> </span>demonstrates <span class="_ _42"> </span>how <span class="_ _53"> </span>a <span class="_ _53"> </span>single <span class="_ _42"> </span>server <span class="_ _53"> </span>can <span class="_ _42"> </span>handle <span class="_ _53"> </span>multiple</div><div class="t m0 x32 h26 y6d7 ff19 fsf fc0 sc0 ls0 ws0">clients, using both the<span class="_"> </span><span class="ff1a">select<span class="_ _80"> </span></span>and<span class="_"> </span><span class="ff1a">poll<span class="_ _66"> </span></span>functions from Section 14.4.</div><div class="t m0 x3f h2a y6d8 ff19 fsf fc0 sc0 ls0 ws0">This <span class="_ _9"></span>version <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>client <span class="_ _9"></span>is <span class="_ _23"></span>similar <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _23"></span>client <span class="_ _9"></span>from <span class="_ _9"></span>Section <span class="_ _9"></span>17.5.<span class="_ _5a"> </span>Indeed, <span class="_ _23"></span>the <span class="_ _9"></span>ﬁle</div><div class="t m0 x32 h26 y6d9 ff1a fsf fc0 sc0 ls0 ws0">main.c<span class="_ _44"> </span><span class="ff19">is <span class="_ _42"> </span>identical <span class="_ _42"> </span>(Figur<span class="ls13fb">e1<span class="_ _c"></span><span class="ls0">7.18). <span class="_ _44"> </span>W<span class="_ _6"></span><span class="ls13fb">ea<span class="_ _43"></span><span class="ls0">dd <span class="_ _23"> </span>the <span class="_ _42"> </span>following <span class="_ _42"> </span>line <span class="_ _42"> </span>to <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">open.h<span class="_ _44"> </span></span>header</span></span></span></span></span></div><div class="t m0 x32 h2a y6da ff19 fsf fc0 sc0 ls0 ws0">(Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">7.17):</span></span></div><div class="t m0 x3f h57 y4da0 ff1a fs2d fc0 sc0 ls0 ws0">#define CS_OPEN &quot;/tmp/opend.socket&quot;<span class="_ _d9"> </span>/* server’s well-known name */</div><div class="t m0 x32 h26 y4da1 ff19 fsf fc0 sc0 ls0 ws0">The ﬁle<span class="_ _66"> </span><span class="ff1a">open.c<span class="_ _66"> </span></span>does <span class="_ _2"></span>change <span class="_ _2"></span>from Figur<span class="ls9ad">e1<span class="_ _4f"></span><span class="ls0">7.19, since <span class="_ _2"></span>we <span class="_ _2"></span>now call<span class="_ _66"> </span><span class="ff1a">cli_conn<span class="_ _66"> </span></span>instead <span class="_ _2"></span>of</span></span></div><div class="t m0 x32 h26 y4da2 ff19 fsf fc0 sc0 ls0 ws0">doing the<span class="_"> </span><span class="ff1a">fork<span class="_ _80"> </span></span>and<span class="_"> </span><span class="ff1a">exec</span><span class="ls86">.T<span class="_ _4a"></span><span class="ls0">his is shown in Figur<span class="ls44">e1<span class="_ _d"></span><span class="ls0">7.25.</span></span></span></span></div><div class="t m0 x32 h4e y4da3 ff1a fs28 fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&quot;open.h&quot;</div><div class="t m0 x32 h4e y4da4 ff1a fs28 fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;sys/uio.h&gt;<span class="_ _8a"> </span>/* struct iovec */</div><div class="t m0 x32 h4e y4da5 ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h4e y4da6 ff1a fs28 fc0 sc0 ls1b6 ws0">*O<span class="_ _1d"></span><span class="ls0">pen the file by sending the &quot;name&quot; and &quot;oflag&quot; to the</span></div><div class="t m0 x140 h4e y4da7 ff1a fs28 fc0 sc0 ls1b6 ws0">*c<span class="_ _1d"></span><span class="ls0">onnection server and reading a file descriptor back.</span></div><div class="t m0 x140 h4e y4da8 ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h4e y4da9 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y4daa ff1a fs28 fc0 sc0 ls0 ws0">csopen(char *name, int oflag)</div><div class="t m0 x32 h4e y4dab ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y4dac ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>len;</div><div class="t m0 x8a h4e y4dad ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _bd"> </span>buf[12];</div><div class="t m0 x8a h4e y4dae ff1a fs28 fc0 sc0 ls0 ws0">struct iovec<span class="_ _15"> </span>iov[3];</div><div class="t m0 x8a h4e y4daf ff1a fs28 fc0 sc0 ls0 ws0">static int<span class="_ _189"> </span>csfd = -1;</div><div class="t m0 x8a h4e y4db0 ff1a fs28 fc0 sc0 ls0 ws0">if (csfd &lt; 0) {<span class="_ _8a"> </span>/* open connection to conn server */</div><div class="t m0 x9d h4e y4db1 ff1a fs28 fc0 sc0 ls0 ws0">if ((csfd = cli_conn(CS_OPEN)) &lt; 0) {</div><div class="t m0 x1f h4e y4db2 ff1a fs28 fc0 sc0 ls0 ws0">err_ret(&quot;cli_conn error&quot;);</div><div class="t m0 x1f h4e y4db3 ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x9d h4e y4db4 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h4e y4db5 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h4e y4db6 ff1a fs28 fc0 sc0 ls0 ws0">sprintf(buf, &quot; %d&quot;, oflag);<span class="_ _8a"> </span>/* oflag to ascii */</div><div class="t m0 x8a h4e y4db7 ff1a fs28 fc0 sc0 ls0 ws0">iov[0].iov_base = CL_OPEN &quot; &quot;;<span class="_ _d9"> </span>/* string concatenation */</div><div class="t m0 x8a h4e y4db8 ff1a fs28 fc0 sc0 ls0 ws0">iov[0].iov_len <span class="_"> </span>=<span class="_"> </span>strlen(CL_OPEN) + 1;</div><div class="t m0 x8a h4e y4db9 ff1a fs28 fc0 sc0 ls0 ws0">iov[1].iov_base = name;</div><div class="t m0 x8a h4e y4dba ff1a fs28 fc0 sc0 ls0 ws0">iov[1].iov_len <span class="_"> </span>=<span class="_"> </span>strlen(name);</div><div class="t m0 x8a h4e y4dbb ff1a fs28 fc0 sc0 ls0 ws0">iov[2].iov_base = buf;</div><div class="t m0 x8a h4e y4dbc ff1a fs28 fc0 sc0 ls0 ws0">iov[2].iov_len <span class="_"> </span>=<span class="_"> </span>strlen(buf) + 1;<span class="_ _d9"> </span>/* null always sent */</div><div class="t m0 x8a h4e y4dbd ff1a fs28 fc0 sc0 ls0 ws0">len = iov[0].iov_len + iov[1].iov_len + iov[2].iov_len;</div><a class="l" href="#pf12" data-dest-detail='[18,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1236.288916px;width:199.356804px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
