<div id="pf25c" class="pf w4 h1f" data-page-no="25c"><div class="pc pc25c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg25c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">570<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x41 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">If the semaphore’s value is curr<span class="_ _0"></span>ently 0, the function r<span class="_ _0"></span>eturns immediately<span class="_ _4"></span>.</div><div class="t m0 x41 h2a y1105 ff19 fsf fc0 sc0 ls0 ws0">If the semaphore’s value is nonzer<span class="_ _0"></span>o, the following conditions apply<span class="_ _4"></span>.</div><div class="t m0 x41 h26 y44fd ff19 fsf fc0 sc0 ls0 ws0">a. <span class="_ _51"> </span>If<span class="_"> </span><span class="ff1a">IPC_NOWAIT<span class="_ _80"> </span></span>is speciﬁed, return is made with an error of<span class="_"> </span><span class="ff1a">EAGAIN</span>.</div><div class="t m0 x41 h26 ya1f ff19 fsf fc0 sc0 ls0 ws0">b. <span class="_ _16"> </span>If<span class="_ _44"> </span><span class="ff1a">IPC_NOWAIT<span class="_ _44"> </span></span>is <span class="_ _23"> </span>not <span class="_ _42"> </span>speciﬁed, <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">semzcnt<span class="_ _35"> </span></span>value <span class="_ _42"> </span>for <span class="_ _42"> </span>this <span class="_ _42"> </span>semaphor<span class="ls1252">ei<span class="_ _43"></span><span class="ls0">s</span></span></div><div class="t m0 x122 h2a ya20 ff19 fsf fc0 sc0 ls0 ws0">incremented (since <span class="_ _3"></span>the <span class="_ _3"></span>caller <span class="_ _2"></span>is <span class="_ _3"></span>about <span class="_ _2"></span>to <span class="_ _3"></span>go <span class="_ _2"></span>to <span class="_ _3"></span>sleep), <span class="_ _2"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>calling <span class="_ _2"></span>process</div><div class="t m0 x122 h2a yd7d ff19 fsf fc0 sc0 ls0 ws0">is suspended until one of the following occurs.</div><div class="t m0 x122 h26 y320 ff19 fsf fc0 sc0 ls0 ws0">i. <span class="_ _6e"> </span>The<span class="_ _61"> </span>semaphore’s <span class="_ _66"> </span>value <span class="_ _47"> </span>becomes <span class="_ _47"> </span>0.<span class="_ _50"> </span>The <span class="_ _66"> </span>value <span class="_ _47"> </span>of<span class="_ _61"> </span><span class="ff1a">semzcnt<span class="_ _61"> </span></span>for <span class="_ _47"> </span>this</div><div class="t m0 x6 h2a y321 ff19 fsf fc0 sc0 ls0 ws0">semaphore<span class="_"> </span>is<span class="_"> </span>decr<span class="_ _0"></span>emented (since the calling pr<span class="_ _0"></span>ocess is done waiting).</div><div class="t m0 x122 h2a y44fe ff19 fsf fc0 sc0 ls0 ws0">ii. <span class="_ _93"> </span>The<span class="_ _45"> </span>semaphore<span class="_ _45"> </span>is<span class="_ _45"> </span>removed <span class="_ _9"></span>from <span class="_ _9"></span>the <span class="_ _23"></span>system.<span class="_ _5a"> </span>In <span class="_ _23"></span>this <span class="_ _9"></span>case, <span class="_ _23"></span>the <span class="_ _9"></span>function</div><div class="t m0 x6 h26 y44ff ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">turns an error of<span class="_"> </span><span class="ff1a">EIDRM</span>.</span></div><div class="t m0 x122 h2a yd81 ff19 fsf fc0 sc0 ls0 ws0">iii. <span class="_ _51"> </span>A<span class="_"> </span>signal is <span class="_ _2"></span>caught by the process, and the <span class="_ _2"></span>signal handler returns. <span class="_"> </span>In<span class="_"> </span>this</div><div class="t m0 x6 h26 yd82 ff19 fsf fc0 sc0 ls0 ws0">case, the value of<span class="_"> </span><span class="ff1a">semzcnt<span class="_ _80"> </span></span>for this semaphore<span class="_"> </span>is<span class="_"> </span>decremented (since the</div><div class="t m0 x6 h2a yd83 ff19 fsf fc0 sc0 ls0 ws0">calling <span class="_ _9"></span>process <span class="_ _9"></span>is <span class="_ _9"></span>no <span class="_ _9"></span>longer <span class="_ _23"></span>waiting), <span class="_ _9"></span>and <span class="_ _9"></span>the <span class="_ _9"></span>function <span class="_ _23"></span>returns <span class="_ _3"></span>an <span class="_ _23"></span>err<span class="_ _0"></span>or</div><div class="t m0 x6 h26 yd84 ff19 fsf fc0 sc0 ls0 ws0">of<span class="_"> </span><span class="ff1a">EINTR</span>.</div><div class="t m0 x32 h26 y15f ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _66"> </span><span class="ff1a">semop<span class="_ _47"> </span></span>function <span class="_ _3"></span>operates <span class="_ _2"></span>atomically; <span class="_ _3"></span>it <span class="_ _2"></span>does <span class="_ _3"></span>either <span class="_ _2"></span>all <span class="_ _3"></span>the <span class="_ _2"></span>operations <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>array <span class="_ _2"></span>or</div><div class="t m0 x32 h2a y160 ff19 fsf fc0 sc0 ls0 ws0">none of them.</div><div class="t m0 x35 h26 y1cb1 ff16 fsf fc0 sc0 ls0 ws0">Semaphore Adjustment on<span class="_"> </span><span class="ff1f">exit</span></div><div class="t m0 x32 h2a y14b3 ff19 fsf fc0 sc0 ls0 ws0">As <span class="_ _9"></span>we <span class="_ _23"></span>mentioned <span class="_ _9"></span>earlier<span class="_ _1"></span>,<span class="_ _45"> </span>it<span class="_ _35"> </span>i<span class="ls1253">sap<span class="_ _b"></span><span class="ls45">ro<span class="ls0">blem <span class="_ _9"></span>if <span class="_ _23"></span>a <span class="_ _9"></span>process <span class="_ _9"></span>terminates <span class="_ _23"></span>while <span class="_ _9"></span>it <span class="_ _23"></span>has <span class="_ _9"></span>resources</span></span></span></div><div class="t m0 x32 h26 y14b4 ff19 fsf fc0 sc0 ls0 ws0">allocated <span class="_ _35"> </span>through <span class="_ _45"> </span>a <span class="_ _35"> </span>semaphore. <span class="_ _51"> </span>Whenever<span class="_ _51"> </span>we <span class="_ _35"> </span>specify <span class="_ _35"> </span>the<span class="_ _51"> </span><span class="ff1a">SEM_UNDO<span class="_ _54"> </span></span>ﬂag <span class="_ _35"> </span>for <span class="_ _35"> </span>a</div><div class="t m0 x32 h26 y30ed ff19 fsf fc0 sc0 ls0 ws0">semaphor<span class="lsd03">eo<span class="_ _8"></span><span class="ls0">peration <span class="_ _2"></span>and <span class="_ _2"></span>we <span class="_ _2"></span>allocate <span class="_ _2"></span>resources (a<span class="_ _66"> </span><span class="ff1a">sem_op<span class="_ _47"> </span></span>value <span class="_ _2"></span>less <span class="_ _2"></span>than <span class="_ _2"></span>0), <span class="_ _2"></span>the <span class="_ _2"></span>kernel</span></span></div><div class="t m0 x32 h2a y1803 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">members <span class="_ _47"> </span>how <span class="_ _66"> </span>many <span class="_ _47"> </span>resour<span class="_ _1"></span>ces <span class="_ _47"> </span>we <span class="_ _66"> </span>allocated <span class="_ _47"> </span>from <span class="_"> </span>that <span class="_ _47"> </span>particular <span class="_"> </span>semaphor<span class="ls1254">e(<span class="_ _5b"></span><span class="ls0">the</span></span></span></div><div class="t m0 x32 h26 y30ee ff19 fsf fc0 sc0 ls0 ws0">absolute <span class="_ _44"> </span>value <span class="_ _4b"> </span>of<span class="_ _54"> </span><span class="ff1a">sem_op</span>). <span class="_ _65"> </span>When<span class="_ _65"> </span>the <span class="_ _4b"> </span>process <span class="_ _44"> </span>terminates, <span class="_ _44"> </span>either <span class="_ _4b"> </span>voluntarily <span class="_ _44"> </span>or</div><div class="t m0 x32 h2a y30f0 ff19 fsf fc0 sc0 ls0 ws0">involuntarily<span class="_ _4"></span><span class="ls1255">,t<span class="_ _43"></span><span class="ls0">he <span class="_ _42"> </span>kernel <span class="_ _42"> </span>checks <span class="_ _53"> </span>whether <span class="_ _53"> </span>the <span class="_ _42"> </span>process <span class="_ _42"> </span>has <span class="_ _53"> </span>any <span class="_ _53"> </span>outstanding <span class="_ _42"> </span>semaphore</span></span></div><div class="t m0 x32 h2a y30f1 ff19 fsf fc0 sc0 ls0 ws0">adjustments and, if so, applies the adjustment to the corresponding semaphor<span class="_ _0"></span>e.</div><div class="t m0 x3f h26 y30f3 ff19 fsf fc0 sc0 ls0 ws0">If <span class="_"> </span>we <span class="_"> </span>set <span class="_"> </span>the <span class="_ _66"> </span>value <span class="_"> </span>of <span class="_ _66"> </span>a <span class="_"> </span>semaphor<span class="ls1256">eu<span class="_ _5b"></span><span class="ls0">sing<span class="_ _46"> </span><span class="ff1a">semctl</span><span class="ls1256">,w<span class="_ _4a"></span><span class="ls0">ith <span class="_"> </span>either <span class="_ _66"> </span>the<span class="_ _46"> </span><span class="ff1a">SETVAL<span class="_ _46"> </span></span>or</span></span></span></span></div><div class="t m0 x32 h26 y30f4 ff1a fsf fc0 sc0 ls0 ws0">SETALL<span class="_ _66"> </span><span class="ff19">commands, <span class="_ _2"></span>the <span class="_ _2"></span>adjustment <span class="_ _2"></span>value <span class="_ _2"></span>for <span class="_ _2"></span>that <span class="_ _2"></span>semaphore<span class="_ _66"> </span>in<span class="_ _47"> </span>all processes <span class="_ _2"></span>is <span class="_ _2"></span>set <span class="_ _2"></span>to <span class="_ _2"></span>0.</span></div><div class="t m0 x35 h27 y4500 ff16 fsf fc0 sc0 ls0 ws0">Example <span class="_ _84"></span>— <span class="_ _84"></span>Timing<span class="_"> </span>Comparison of Semaphores, Recor<span class="ls12e">dL<span class="_ _4f"></span><span class="ls0">ocking, and Mute<span class="_ _0"></span><span class="ls25">xe<span class="ls0">s</span></span></span></span></div><div class="t m0 x32 h2a y4501 ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _9"></span>we <span class="_ _9"></span>ar<span class="ls699">es<span class="_ _b"></span><span class="ls0">haring <span class="_ _9"></span>a <span class="_ _9"></span>single <span class="_ _9"></span>resource <span class="_ _3"></span>among <span class="_ _23"></span>multiple <span class="_ _9"></span>processes, <span class="_ _9"></span>we <span class="_ _9"></span>can <span class="_ _9"></span>use <span class="_ _9"></span>one <span class="_ _23"></span>of <span class="_ _9"></span>three</span></span></div><div class="t m0 x32 h2a y4502 ff19 fsf fc0 sc0 ls0 ws0">techniques <span class="_ _3"></span>to <span class="_ _3"></span>coordinate <span class="_ _2"></span>access.<span class="_ _16"> </span><span class="ls5f">We <span class="_ _66"> </span>c<span class="_ _9"></span></span>an <span class="_ _3"></span>use <span class="_ _3"></span>a <span class="_ _3"></span>a <span class="_ _9"></span>semaphore, <span class="_ _2"></span>recor<span class="_ _0"></span><span class="ls1064">dl<span class="_ _8"></span><span class="ls0">ocking, <span class="_ _3"></span>or <span class="_ _3"></span>a <span class="_ _3"></span>mutex</span></span></div><div class="t m0 x32 h2a y4503 ff19 fsf fc0 sc0 ls0 ws0">that is <span class="_ _2"></span>mapped into <span class="_ _2"></span>the address spaces <span class="_ _2"></span>of both <span class="_ _2"></span>processes. <span class="_"> </span>It’s<span class="_"> </span>interesting to compar<span class="ls1257">et<span class="_ _d"></span><span class="ls0">he</span></span></div><div class="t m0 x32 h2a y4504 ff19 fsf fc0 sc0 ls0 ws0">timing differ<span class="_ _0"></span>ences between the thr<span class="_ _0"></span>ee techniques.</div><div class="t m0 x3f h2a y4505 ff19 fsf fc0 sc0 ls65 ws0">Wi<span class="_ _3"></span><span class="ls0">th <span class="_ _23"> </span>a <span class="_ _42"> </span>semaphore, <span class="_ _23"> </span>we <span class="_ _42"> </span>create <span class="_ _23"></span>a <span class="_ _42"> </span>semaphor<span class="_ _0"></span><span class="ls3cc">es<span class="_ _43"></span><span class="ls0">et <span class="_ _23"> </span>consisting <span class="_ _42"> </span>of <span class="_ _42"> </span>a <span class="_ _23"> </span>single <span class="_ _42"> </span>member <span class="_ _42"> </span>and</span></span></span></div><div class="t m0 x32 h26 y4506 ff19 fsf fc0 sc0 ls0 ws0">initialize <span class="_ _42"> </span>the <span class="_ _42"> </span>semaphore’s <span class="_ _42"> </span>value <span class="_ _42"> </span>to <span class="_ _42"> </span>1.<span class="_ _54"> </span><span class="ls5f">To <span class="_ _45"> </span>a<span class="_ _9"></span></span>llocate <span class="_ _42"> </span>the <span class="_ _42"> </span>resource, <span class="_ _23"> </span>we <span class="_ _42"> </span>call<span class="_ _44"> </span><span class="ff1a">semop<span class="_ _44"> </span></span>with <span class="_ _42"> </span>a</div><div class="t m0 x32 h26 y4507 ff1a fsf fc0 sc0 ls0 ws0">sem_op<span class="_ _44"> </span><span class="ff19">of<span class="_ _44"> </span><span class="ff20">−</span>1; <span class="_ _42"> </span>to <span class="_ _42"> </span>release <span class="_ _42"> </span>the <span class="_ _42"> </span>resource, <span class="_ _42"> </span>we <span class="_ _42"> </span>perform <span class="_ _42"> </span>a<span class="_ _44"> </span></span>sem_op<span class="_ _44"> </span><span class="ff19">of<span class="_ _44"> </span><span class="ff1c">+</span>1. <span class="_ _44"> </span>W<span class="_ _6"></span><span class="lsc44">ea<span class="_ _43"></span><span class="ls0">lso <span class="_ _23"> </span>specify</span></span></span></div><div class="t m0 x32 h26 y4508 ff1a fsf fc0 sc0 ls0 ws0">SEM_UNDO<span class="_ _47"> </span><span class="ff19">with <span class="_ _2"></span>each <span class="_ _3"></span>operation, <span class="_ _3"></span>to <span class="_ _3"></span>handle <span class="_ _3"></span>the <span class="_ _3"></span>case <span class="_ _3"></span>of <span class="_ _2"></span>a <span class="_ _3"></span>process <span class="_ _3"></span>that <span class="_ _3"></span>terminates <span class="_ _2"></span>without</span></div><div class="t m0 x32 h2a y4509 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">leasing its resource.</span></div><div class="t m0 x3f h2a y450a ff19 fsf fc0 sc0 ls65 ws0">Wi<span class="_ _3"></span><span class="ls0">th <span class="_ _2"></span>recor<span class="_ _0"></span><span class="ls1250">dl<span class="_ _4f"></span><span class="ls0">ocking, <span class="_ _2"></span>we <span class="_ _2"></span>create <span class="_ _2"></span>an <span class="_ _2"></span>empty <span class="_ _2"></span>ﬁle <span class="_ _3"></span>and <span class="_ _2"></span>use <span class="_ _2"></span>the <span class="_ _2"></span>ﬁrst <span class="_ _3"></span>byte <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _3"></span>(which</span></span></span></div><div class="t m0 x32 h2a y450b ff19 fsf fc0 sc0 ls0 ws0">need <span class="_ _3"></span>not <span class="_ _9"></span>exist) <span class="_ _3"></span>as <span class="_ _3"></span>the <span class="_ _9"></span>lock <span class="_ _3"></span>byte.<span class="_ _16"> </span><span class="ls5f">To <span class="_ _66"> </span>a<span class="_ _9"></span></span>llocate <span class="_ _9"></span>the <span class="_ _3"></span>resource, <span class="_ _2"></span>we <span class="_ _9"></span>obtain <span class="_ _3"></span>a <span class="_ _3"></span>write <span class="_ _9"></span>lock <span class="_ _3"></span>on <span class="_ _9"></span>the</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
