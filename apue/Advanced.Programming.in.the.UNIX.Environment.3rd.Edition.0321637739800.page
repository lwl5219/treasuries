<div id="pf320" class="pf w4 h1f" data-page-no="320"><div class="pc pc320 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg320.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">766<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">317 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">318 <span class="_ _8a"> </span>*<span class="_"> </span>Position index file and record the offset.<span class="_ _d9"> </span>db_nextrec</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">319 <span class="_ _8a"> </span>*<span class="_"> </span>calls us with offset==0, meaning read from current offset.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">320 <span class="_ _8a"> </span>*<span class="_"> </span>We still need to call lseek to record the current offset.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">321 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">322 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;idxoff = lseek(db-&gt;idxfd, offset,</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">323 <span class="_ _189"> </span>offset<span class="_"> </span>== 0 ? SEEK_CUR : SEEK_SET)) == -1)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">324 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>lseek error&quot;);</div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">325 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">326 <span class="_ _8a"> </span>*<span class="_"> </span>Read the ascii chain ptr and the ascii length at</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">327 <span class="_ _8a"> </span>*<span class="_"> </span>the front of the index record.<span class="_ _d9"> </span>This tells us the</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">328 <span class="_ _8a"> </span>*<span class="_"> </span>remaining size of the index record.</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">329 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">330 <span class="_ _15"> </span>iov[0].iov_base<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">sciiptr;</span></span></div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">331 <span class="_ _15"> </span>iov[0].iov_len<span class="_ _d9"> </span><span class="ls15c">=P<span class="_ _5b"></span><span class="ls0">TR_SZ;</span></span></div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">332 <span class="_ _15"> </span>iov[1].iov_base<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">sciilen;</span></span></div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">333 <span class="_ _15"> </span>iov[1].iov_len<span class="_ _d9"> </span><span class="ls15c">=I<span class="_ _5b"></span><span class="ls0">DXLEN_SZ;</span></span></div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">334 <span class="_ _15"> </span>if<span class="_"> </span>((i = readv(db-&gt;idxfd, &amp;iov[0], 2)) != PTR_SZ + IDXLEN_SZ) {</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">335 <span class="_ _186"> </span>if<span class="_"> </span>(i == 0 &amp;&amp; offset == 0)</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">336 <span class="_ _82"> </span>return(-1);<span class="_ _8a"> </span>/* EOF for db_nextrec */</div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">337 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>readv error of index record&quot;);</div><div class="t m0 x32 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">338 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">339 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">340 <span class="_ _8a"> </span>*<span class="_"> </span>This is our return value; always &gt;= 0.</div><div class="t m0 x32 h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">341 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y33b9 ff1a fs2d fc0 sc0 ls0 ws0">342 <span class="_ _15"> </span>asciiptr[PTR_SZ]<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls965">;/<span class="_ _223"></span><span class="ls15c">*n<span class="_ _1d"></span><span class="ls0">ull terminate */</span></span></span></span></div><div class="t m0 x32 h57 y33ba ff1a fs2d fc0 sc0 ls0 ws0">343 <span class="_ _15"> </span>db-&gt;ptrval<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">tol(asciiptr); /* offset of next key in chain */</span></span></div><div class="t m0 x32 h57 y5754 ff1a fs2d fc0 sc0 ls0 ws0">344 <span class="_ _15"> </span>asciilen[IDXLEN_SZ]<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls168d">;/<span class="_ _91"></span><span class="ls15c">*n<span class="_ _5b"></span><span class="ls0">ull terminate */</span></span></span></span></div><div class="t m0 x32 h57 y5755 ff1a fs2d fc0 sc0 ls0 ws0">345 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;idxlen = atoi(asciilen)) &lt; IDXLEN_MIN ||</div><div class="t m0 x32 h57 y5756 ff1a fs2d fc0 sc0 ls0 ws0">346 <span class="_ _189"> </span>db-&gt;idxlen<span class="_"> </span><span class="ls15c">&gt;I<span class="_ _5b"></span><span class="ls0">DXLEN_MAX)</span></span></div><div class="t m0 x32 h57 y5794 ff1a fs2d fc0 sc0 ls0 ws0">347 <span class="_ _186"> </span>err_dump(&quot;_db_readidx:<span class="_"> </span>invalid length&quot;);</div><div class="t m0 x32 h49 y5795 ff19 fs26 fc0 sc0 ls0 ws0">[317 <span class="_ _a"></span>– <span class="_ _a"></span>324]<span class="_ _65"> </span><span class="ls164">We <span class="_ _e"> </span>s<span class="_ _9"></span></span>tart <span class="_ _3"></span>by <span class="_ _2"></span>seeking <span class="_ _3"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>index <span class="_ _3"></span>ﬁle <span class="_ _2"></span>offset <span class="_ _2"></span>provided by <span class="_ _3"></span>the <span class="_ _2"></span>caller<span class="_ _1"></span><span class="ls168e">.W<span class="_ _7"></span><span class="ls7f2">er<span class="_ _8"></span><span class="ls0">ecord</span></span></span></div><div class="t m0 x11a h4d y5796 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>offset in <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">DB<span class="_ _66"> </span></span>structure, so <span class="_ _2"></span>even <span class="_ _2"></span>if <span class="_ _3"></span>the <span class="_ _2"></span>caller <span class="_ _2"></span>wants <span class="_ _2"></span>to <span class="_ _2"></span>read <span class="_ _2"></span>the <span class="_ _2"></span>recor<span class="_ _0"></span><span class="ls63b">da<span class="_ _4f"></span><span class="ls0">t</span></span></div><div class="t m0 x11a h4d y5797 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>current <span class="_ _2"></span>ﬁle <span class="_ _2"></span>offset (by <span class="_ _3"></span>setting<span class="_ _47"> </span><span class="ff1a">offset<span class="_ _66"> </span></span>to <span class="_ _2"></span>0), <span class="_ _3"></span>we <span class="_ _2"></span>still <span class="_ _2"></span>need <span class="_ _3"></span>to <span class="_ _2"></span>call<span class="_ _47"> </span><span class="ff1a">lseek<span class="_ _66"> </span></span>to</div><div class="t m0 x11a h49 y5798 ff19 fs26 fc0 sc0 ls0 ws0">determine <span class="_ _23"></span>the <span class="_ _23"></span>current <span class="_ _9"></span>offset. <span class="_ _45"> </span>Since<span class="_ _35"> </span>an <span class="_ _23"> </span>index <span class="_ _23"> </span>recor<span class="_ _0"></span><span class="ls168f">dw<span class="_ _43"></span><span class="ls0">ill <span class="_ _23"> </span>never <span class="_ _23"> </span>be <span class="_ _23"> </span>stored <span class="_ _23"></span>at</span></span></div><div class="t m0 x11a h49 y5799 ff19 fs26 fc0 sc0 ls0 ws0">offset 0 <span class="_ _2"></span>in the <span class="_ _2"></span>index <span class="_ _2"></span>ﬁle, <span class="_ _2"></span>we <span class="_ _2"></span>can <span class="_ _2"></span>safely overload <span class="_ _2"></span>the <span class="_ _2"></span>value <span class="_ _2"></span>of <span class="_ _2"></span>0 <span class="_ _2"></span>to mean <span class="_ _2"></span>‘‘r<span class="_ _1"></span>ead</div><div class="t m0 x11a h49 y579a ff19 fs26 fc0 sc0 ls0 ws0">from the curr<span class="_ _0"></span>ent of<span class="_ _0"></span>fset.’<span class="_ _0"></span>’</div><div class="t m0 x32 h4d y579b ff19 fs26 fc0 sc0 ls0 ws0">[325 <span class="_ _a"></span>– <span class="_ _a"></span>338]<span class="_ _65"> </span><span class="ls164">We <span class="_ _45"> </span>c<span class="_ _9"></span></span>all<span class="_ _44"> </span><span class="ff1a">readv<span class="_ _44"> </span></span>to <span class="_ _53"> </span>read <span class="_ _42"> </span>the <span class="_ _42"> </span>two <span class="_ _53"> </span>ﬁxed</div><div class="t m0 x1eb h49 y579c ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x1d3 h49 y579b ff19 fs26 fc0 sc0 ls0 ws0">length <span class="_ _42"> </span>ﬁelds <span class="_ _53"> </span>at <span class="_ _42"> </span>the <span class="_ _53"> </span>beginning <span class="_ _42"> </span>of <span class="_ _53"> </span>the</div><div class="t m0 x11a h49 y579d ff19 fs26 fc0 sc0 ls0 ws0">index <span class="_ _9"></span>record: <span class="_ _9"></span>the <span class="_ _9"></span>chain <span class="_ _23"></span>pointer <span class="_ _9"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>next <span class="_ _23"></span>index <span class="_ _9"></span>recor<span class="ls1690">da<span class="_ _43"></span><span class="ls0">nd <span class="_ _23"></span>the <span class="_ _9"></span>size <span class="_ _23"></span>of <span class="_ _9"></span>the</span></span></div><div class="t m0 x11a h49 y579e ff19 fs26 fc0 sc0 ls0 ws0">variable-length index recor<span class="_ _0"></span><span class="lsd3">dt<span class="_ _d"></span><span class="ls0">hat follows.</span></span></div><div class="t m0 x32 h49 y579f ff19 fs26 fc0 sc0 ls0 ws0">[339 <span class="_ _a"></span>– <span class="_ _a"></span>347]<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>c<span class="_ _9"></span></span>onvert <span class="_ _53"> </span>the <span class="_ _e"> </span>offset <span class="_ _53"> </span>of <span class="_ _53"> </span>the <span class="_ _e"> </span>next <span class="_ _e"> </span>recor<span class="_ _0"></span>d<span class="_ _44"> </span>to<span class="_ _4b"> </span>an<span class="_ _4b"> </span>integer <span class="_ _e"> </span>and <span class="_ _e"> </span>store<span class="_ _44"> </span>it<span class="_ _4b"> </span>in<span class="_ _4b"> </span>the</div><div class="t m0 x11a h4d y57a0 ff1a fs26 fc0 sc0 ls0 ws0">ptrval<span class="_ _45"> </span><span class="ff19">ﬁeld <span class="_ _9"></span>(this <span class="_ _9"></span>will <span class="_ _9"></span>be <span class="_ _9"></span>used <span class="_ _9"></span>as <span class="_ _9"></span>the <span class="_ _23"></span>r<span class="_ _0"></span>eturn <span class="_ _9"></span>value <span class="_ _9"></span>for <span class="_ _9"></span>this <span class="_ _9"></span>function).<span class="_ _5a"> </span>Then</span></div><div class="t m0 x11a h49 y57a1 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _9"></span>convert <span class="_ _9"></span>the <span class="_ _9"></span>length <span class="_ _23"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>index <span class="_ _9"></span>recor<span class="_ _0"></span><span class="ls1691">di<span class="_ _b"></span><span class="ls0">nto <span class="_ _9"></span>an <span class="_ _9"></span>integer <span class="_ _9"></span>and <span class="_ _9"></span>save <span class="_ _23"></span>it <span class="_ _9"></span>in <span class="_ _9"></span>the</span></span></div><div class="t m0 x11a h4d y57a2 ff1a fs26 fc0 sc0 ls0 ws0">idxlen<span class="_ _80"> </span><span class="ff19">ﬁeld.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
