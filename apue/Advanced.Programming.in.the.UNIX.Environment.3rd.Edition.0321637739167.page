<div id="pfa7" class="pf w4 h1f" data-page-no="a7"><div class="pc pca7 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bga7.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>4.22<span class="_ _1c1"> </span>Reading <span class="_"> </span>Directories<span class="_ _1b"> </span><span class="ff18">133</span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">#define FTW_DNR 3<span class="_ _b7"> </span>/* directory that can’t be read */</div><div class="t m0 x32 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">#define FTW_NS<span class="_ _d9"> </span><span class="ls5d1">4/<span class="_ _1c2"></span><span class="ls15c">*f<span class="_ _1d"></span><span class="ls0">ile that we can’t stat */</span></span></span></div><div class="t m0 x32 h57 y1307 ff1a fs2d fc0 sc0 ls0 ws0">static char *fullpath;<span class="_ _189"> </span>/* contains full pathname for every file */</div><div class="t m0 x32 h57 y1308 ff1a fs2d fc0 sc0 ls0 ws0">static size_t pathlen;</div><div class="t m0 x32 h57 y1309 ff1a fs2d fc0 sc0 ls0 ws0">static int<span class="_ _cb"> </span>/* we return whatever func() returns */</div><div class="t m0 x32 h57 y130a ff1a fs2d fc0 sc0 ls0 ws0">myftw(char *pathname, Myfunc *func)</div><div class="t m0 x32 h57 y130b ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y130c ff1a fs2d fc0 sc0 ls0 ws0">fullpath = path_alloc(&amp;pathlen);<span class="_ _15"> </span>/* malloc PATH_MAX+1 bytes */</div><div class="t m0 x93 h57 y130d ff1a fs2d fc0 sc0 ls0 ws0">/* (Figure 2.16) */</div><div class="t m0 x8a h57 y130e ff1a fs2d fc0 sc0 ls0 ws0">if (pathlen &lt;= strlen(pathname)) {</div><div class="t m0 x9d h57 y130f ff1a fs2d fc0 sc0 ls0 ws0">pathlen = strlen(pathname) * 2;</div><div class="t m0 x9d h57 y1310 ff1a fs2d fc0 sc0 ls0 ws0">if ((fullpath = realloc(fullpath, pathlen)) == NULL)</div><div class="t m0 x1f h57 y1311 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;realloc failed&quot;);</div><div class="t m0 x8a h57 y1312 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y1313 ff1a fs2d fc0 sc0 ls0 ws0">strcpy(fullpath, pathname);</div><div class="t m0 x8a h57 y1314 ff1a fs2d fc0 sc0 ls0 ws0">return(dopath(func));</div><div class="t m0 x32 h57 y1315 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y1316 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h57 y1317 ff1a fs2d fc0 sc0 ls15c ws0">*D<span class="_ _1d"></span><span class="ls0">escend through the hierarchy, starting at &quot;fullpath&quot;.</span></div><div class="t m0 x140 h57 y1318 ff1a fs2d fc0 sc0 ls0 ws0">*<span class="_"> </span>If<span class="_"> </span>&quot;fullpath&quot; is anything other than a directory, we lstat() it,</div><div class="t m0 x140 h57 y1319 ff1a fs2d fc0 sc0 ls15c ws0">*c<span class="_ _1d"></span><span class="ls0">all func(), and return.<span class="_ _3a"> </span>For a directory, we call ourself</span></div><div class="t m0 x140 h57 y131a ff1a fs2d fc0 sc0 ls15c ws0">*r<span class="_ _1d"></span><span class="ls0">ecursively for each name in the directory.</span></div><div class="t m0 x140 h57 y131b ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h57 y131c ff1a fs2d fc0 sc0 ls0 ws0">static int<span class="_ _cb"> </span>/* we return whatever func() returns */</div><div class="t m0 x32 h57 y131d ff1a fs2d fc0 sc0 ls0 ws0">dopath(Myfunc* func)</div><div class="t m0 x32 h57 y131e ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y131f ff1a fs2d fc0 sc0 ls0 ws0">struct stat<span class="_ _8a"> </span>statbuf;</div><div class="t m0 x8a h57 y1320 ff1a fs2d fc0 sc0 ls0 ws0">struct dirent<span class="_ _68"> </span>*dirp;</div><div class="t m0 x8a h57 y1321 ff1a fs2d fc0 sc0 ls0 ws0">DIR <span class="_ _82"> </span>*dp;</div><div class="t m0 x8a h57 y1322 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>ret,<span class="_"> </span>n;</div><div class="t m0 x8a h57 y1323 ff1a fs2d fc0 sc0 ls0 ws0">if (lstat(fullpath, &amp;statbuf) &lt; 0)<span class="_ _d9"> </span>/* stat error */</div><div class="t m0 x9d h57 y1324 ff1a fs2d fc0 sc0 ls0 ws0">return(func(fullpath, &amp;statbuf, FTW_NS));</div><div class="t m0 x8a h57 y1325 ff1a fs2d fc0 sc0 ls0 ws0">if (S_ISDIR(statbuf.st_mode) == 0)<span class="_ _d9"> </span>/* not a directory */</div><div class="t m0 x9d h57 y1326 ff1a fs2d fc0 sc0 ls0 ws0">return(func(fullpath, &amp;statbuf, FTW_F));</div><div class="t m0 x8a h57 y1327 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 xe1 h57 y1328 ff1a fs2d fc0 sc0 ls15c ws0">*I<span class="_ _1d"></span><span class="ls0">t’s a directory.<span class="_ _3a"> </span>First call func() for the directory,</span></div><div class="t m0 xe1 h57 y1329 ff1a fs2d fc0 sc0 ls15c ws0">*t<span class="_ _1d"></span><span class="ls0">hen process each filename in the directory.</span></div><div class="t m0 xe1 h57 y132a ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y132b ff1a fs2d fc0 sc0 ls0 ws0">if ((ret = func(fullpath, &amp;statbuf, FTW_D)) != 0)</div><div class="t m0 x9d h57 y132c ff1a fs2d fc0 sc0 ls0 ws0">return(ret);</div><div class="t m0 x8a h57 y132d ff1a fs2d fc0 sc0 ls15c ws0">n=s<span class="_ _1d"></span><span class="ls0">trlen(fullpath);</span></div><div class="t m0 x8a h57 y132e ff1a fs2d fc0 sc0 ls0 ws0">if (n + NAME_MAX + 2 &gt; pathlen) {<span class="_ _68"> </span>/* expand path buffer */</div><div class="t m0 x9d h57 y132f ff1a fs2d fc0 sc0 ls0 ws0">pathlen *= 2;</div><div class="t m0 x9d h57 y1330 ff1a fs2d fc0 sc0 ls0 ws0">if ((fullpath = realloc(fullpath, pathlen)) == NULL)</div><div class="t m0 x1f h57 y1331 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;realloc failed&quot;);</div><div class="t m0 x8a h57 y1332 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y1333 ff1a fs2d fc0 sc0 ls0 ws0">fullpath[n++] = ’/’;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
