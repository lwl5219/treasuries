<div id="pf2ad" class="pf w4 h1f" data-page-no="2ad"><div class="pc pc2ad w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg2ad.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.4<span class="_ _284"> </span>Passing <span class="_"> </span>File <span class="_"> </span>Descriptors<span class="_ _1fb"> </span><span class="ff18">651</span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">#define CREDSTRUCT<span class="_ _189"> </span>ucred</div><div class="t m0 x32 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">#define CR_UID<span class="_ _74"> </span>uid</div><div class="t m0 x32 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">#define CREDOPT<span class="_ _176"> </span>SO_PASSCRED</div><div class="t m0 x32 h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">#define SCM_CREDTYPE<span class="_ _15"> </span>SCM_CREDENTIALS</div><div class="t m0 x32 h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">#else</div><div class="t m0 x32 h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">#error passing credentials is unsupported!</div><div class="t m0 x32 h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x32 h57 y23cb ff1a fs2d fc0 sc0 ls0 ws0">/* size of control buffer to send/recv one file descriptor */</div><div class="t m0 x32 h57 y86e ff1a fs2d fc0 sc0 ls0 ws0">#define RIGHTSLEN<span class="_ _68"> </span>CMSG_LEN(sizeof(int))</div><div class="t m0 x32 h57 y86f ff1a fs2d fc0 sc0 ls0 ws0">#define CREDSLEN<span class="_ _15"> </span>CMSG_LEN(sizeof(struct CREDSTRUCT))</div><div class="t m0 x32 h57 y870 ff1a fs2d fc0 sc0 ls0 ws0">#define CONTROLLEN<span class="_ _d9"> </span>(RIGHTSLEN + CREDSLEN)</div><div class="t m0 x32 h57 y23cd ff1a fs2d fc0 sc0 ls0 ws0">static struct cmsghdr<span class="_ _68"> </span>*cmptr = NULL;<span class="_ _88"> </span>/* mallocâ€™ed first time */</div><div class="t m0 x32 h57 y4cfa ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h57 y4cfb ff1a fs2d fc0 sc0 ls15c ws0">*R<span class="_ _1d"></span><span class="ls0">eceive a file descriptor from a server process.<span class="_ _3a"> </span>Also, any data</span></div><div class="t m0 x140 h57 y2fe7 ff1a fs2d fc0 sc0 ls15c ws0">*r<span class="_ _1d"></span><span class="ls0">eceived is passed to (*userfunc)(STDERR_FILENO, buf, nbytes).</span></div><div class="t m0 x140 h57 y2fe8 ff1a fs2d fc0 sc0 ls0 ws0">*<span class="_"> </span>We<span class="_"> </span>have a 2-byte protocol for receiving the fd from send_fd().</div><div class="t m0 x140 h57 y23ce ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h57 y23cf ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y23d0 ff1a fs2d fc0 sc0 ls0 ws0">recv_ufd(int fd, uid_t *uidptr,</div><div class="t m0 x175 h57 y23d1 ff1a fs2d fc0 sc0 ls0 ws0">ssize_t (*userfunc)(int, const void *, size_t))</div><div class="t m0 x32 h57 y23d2 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y23d3 ff1a fs2d fc0 sc0 ls0 ws0">struct cmsghdr<span class="_ _189"> </span>*cmp;</div><div class="t m0 x8a h57 y3358 ff1a fs2d fc0 sc0 ls0 ws0">struct CREDSTRUCT<span class="_ _68"> </span>*credp;</div><div class="t m0 x8a h57 y1700 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _227"> </span>*ptr;</div><div class="t m0 x8a h57 y1701 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _227"> </span>buf[MAXLINE];</div><div class="t m0 x8a h57 y1702 ff1a fs2d fc0 sc0 ls0 ws0">struct iovec<span class="_ _186"> </span>iov[1];</div><div class="t m0 x8a h57 y1703 ff1a fs2d fc0 sc0 ls0 ws0">struct msghdr<span class="_ _b7"> </span>msg;</div><div class="t m0 x8a h57 y1704 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>nr;</div><div class="t m0 x8a h57 y3359 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>newfd<span class="_"> </span><span class="ls15c">=-<span class="_ _1d"></span><span class="ls0">1;</span></span></div><div class="t m0 x8a h57 y335a ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>status<span class="_"> </span><span class="ls15c">=-<span class="_ _1d"></span><span class="ls0">1;</span></span></div><div class="t m0 x32 h57 y16ee ff1a fs2d fc0 sc0 ls0 ws0">#if defined(CREDOPT)</div><div class="t m0 x8a h57 y16ef ff1a fs2d fc0 sc0 ls0 ws0">const int<span class="_ _bd"> </span>on = 1;</div><div class="t m0 x8a h57 y23f0 ff1a fs2d fc0 sc0 ls0 ws0">if (setsockopt(fd, SOL_SOCKET, CREDOPT, &amp;on, sizeof(int)) &lt; 0) {</div><div class="t m0 x9d h57 y23f1 ff1a fs2d fc0 sc0 ls0 ws0">err_ret(&quot;setsockopt error&quot;);</div><div class="t m0 x9d h57 y23f2 ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y1327 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y1328 ff1a fs2d fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x8a h57 y1329 ff1a fs2d fc0 sc0 ls0 ws0">for ( ; ; ) {</div><div class="t m0 x9d h57 y132a ff1a fs2d fc0 sc0 ls0 ws0">iov[0].iov_base = buf;</div><div class="t m0 x9d h57 y132b ff1a fs2d fc0 sc0 ls0 ws0">iov[0].iov_len <span class="_"> </span>=<span class="_"> </span>sizeof(buf);</div><div class="t m0 x9d h57 y132c ff1a fs2d fc0 sc0 ls0 ws0">msg.msg_iov <span class="_ _15"> </span>=<span class="_"> </span>iov;</div><div class="t m0 x9d h57 y23f3 ff1a fs2d fc0 sc0 ls0 ws0">msg.msg_iovlen <span class="_"> </span>=<span class="_"> </span>1;</div><div class="t m0 x9d h57 y23f4 ff1a fs2d fc0 sc0 ls0 ws0">msg.msg_name <span class="_ _68"> </span>=<span class="_"> </span>NULL;</div><div class="t m0 x9d h57 y23f5 ff1a fs2d fc0 sc0 ls0 ws0">msg.msg_namelen = 0;</div><div class="t m0 x9d h57 y23f6 ff1a fs2d fc0 sc0 ls0 ws0">if (cmptr == NULL &amp;&amp; (cmptr = malloc(CONTROLLEN)) == NULL)</div><div class="t m0 x1f h57 y23f7 ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x9d h57 y4cfc ff1a fs2d fc0 sc0 ls0 ws0">msg.msg_control <span class="_ _68"> </span>=<span class="_"> </span>cmptr;</div><div class="t m0 x9d h57 y4cfd ff1a fs2d fc0 sc0 ls0 ws0">msg.msg_controllen = CONTROLLEN;</div><div class="t m0 x9d h57 y4cfe ff1a fs2d fc0 sc0 ls0 ws0">if ((nr = recvmsg(fd, &amp;msg, 0)) &lt; 0) {</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
