<div id="pf355" class="pf w4 h1f" data-page-no="355"><div class="pc pc355 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg355.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">819</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">193 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">194 <span class="_ _68"> </span>*<span class="_"> </span>Initialize printer information from configuration file.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">195 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">196 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">197 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">198 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">199 <span class="_ _d9"> </span>init_printer(void)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">200 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">201 <span class="_ _15"> </span>printer<span class="_"> </span><span class="ls15c">=g<span class="_ _1d"></span><span class="ls0">et_printaddr();</span></span></div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">202 <span class="_ _15"> </span>if<span class="_"> </span>(printer == NULL)</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">203 <span class="_ _186"> </span>exit(1);<span class="_ _15"> </span>/* message already logged */</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">204 <span class="_ _15"> </span>printer_name<span class="_"> </span><span class="ls15c">=p<span class="_ _1d"></span><span class="ls0">rinter-&gt;ai_canonname;</span></span></div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">205 <span class="_ _15"> </span>if<span class="_"> </span>(printer_name == NULL)</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">206 <span class="_ _186"> </span>printer_name<span class="_"> </span><span class="ls15c">=&quot;<span class="_ _1d"></span><span class="ls0">printer&quot;;</span></span></div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">207 <span class="_ _15"> </span>log_msg(&quot;printer<span class="_"> </span>is %s&quot;, printer_name);</div><div class="t m0 x32 h57 y56d0 ff1a fs2d fc0 sc0 ls0 ws0">208 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y2c5e ff1a fs2d fc0 sc0 ls0 ws0">209 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y2c5f ff1a fs2d fc0 sc0 ls0 ws0">210 <span class="_ _68"> </span>*<span class="_"> </span>Update the job ID file with the next job number.</div><div class="t m0 x32 h57 y2c60 ff1a fs2d fc0 sc0 ls0 ws0">211 <span class="_ _68"> </span>*<span class="_"> </span>Doesn’t handle wrap-around of job number.</div><div class="t m0 x32 h57 y2c61 ff1a fs2d fc0 sc0 ls0 ws0">212 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y2c62 ff1a fs2d fc0 sc0 ls0 ws0">213 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h57 y5689 ff1a fs2d fc0 sc0 ls0 ws0">214 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y568a ff1a fs2d fc0 sc0 ls0 ws0">215 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y568b ff1a fs2d fc0 sc0 ls0 ws0">216 <span class="_ _d9"> </span>update_jobno(void)</div><div class="t m0 x32 h57 y568c ff1a fs2d fc0 sc0 ls0 ws0">217 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y568d ff1a fs2d fc0 sc0 ls0 ws0">218 <span class="_ _15"> </span>char<span class="_ _15"> </span>buf[32];</div><div class="t m0 x32 h57 y5abe ff1a fs2d fc0 sc0 ls0 ws0">219 <span class="_ _15"> </span>if<span class="_"> </span>(lseek(jobfd, 0, SEEK_SET) == -1)</div><div class="t m0 x32 h57 y5abf ff1a fs2d fc0 sc0 ls0 ws0">220 <span class="_ _186"> </span>log_sys(&quot;can’t<span class="_"> </span>seek in job file&quot;);</div><div class="t m0 x32 h57 y5ac0 ff1a fs2d fc0 sc0 ls0 ws0">221 <span class="_ _15"> </span>sprintf(buf,<span class="_"> </span>&quot;%d&quot;, nextjob);</div><div class="t m0 x32 h57 y3b50 ff1a fs2d fc0 sc0 ls0 ws0">222 <span class="_ _15"> </span>if<span class="_"> </span>(write(jobfd, buf, strlen(buf)) &lt; 0)</div><div class="t m0 x32 h57 y3b51 ff1a fs2d fc0 sc0 ls0 ws0">223 <span class="_ _186"> </span>log_sys(&quot;can’t<span class="_"> </span>update job file&quot;);</div><div class="t m0 x32 h57 y5b61 ff1a fs2d fc0 sc0 ls0 ws0">224 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y576a ff19 fs26 fc0 sc0 ls0 ws0">[193 <span class="_ _a"></span>– <span class="_ _a"></span>208]<span class="_ _65"> </span>The<span class="_ _35"> </span><span class="ff1a">init_printer<span class="_ _35"> </span></span>function <span class="_ _23"> </span>is <span class="_ _42"> </span>used <span class="_ _23"> </span>to <span class="_ _23"> </span>set <span class="_ _42"> </span>the <span class="_ _23"> </span>printer <span class="_ _42"> </span>name <span class="_ _23"> </span>and <span class="_ _23"> </span>address.</div><div class="t m0 x11a h4d y576b ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _45"> </span>g<span class="_ _9"></span><span class="ls0">et <span class="_ _23"> </span>the <span class="_ _42"> </span>printer <span class="_ _42"> </span>address <span class="_ _23"></span>by <span class="_ _42"> </span>calling<span class="_ _35"> </span><span class="ff1a">get_printaddr<span class="_ _35"> </span></span>(from<span class="_ _35"> </span><span class="ff1a">util.c</span>). <span class="_ _44"> </span>If</span></div><div class="t m0 x11a h4d y576c ff19 fs26 fc0 sc0 ls0 ws0">this <span class="_"> </span>fails, <span class="_"> </span>we <span class="_ _66"> </span>exit.<span class="_ _50"> </span>The<span class="_ _46"> </span><span class="ff1a">get_printaddr<span class="_ _46"> </span></span>function <span class="_ _66"> </span>logs <span class="_ _66"> </span>its <span class="_"> </span>own <span class="_ _66"> </span>message</div><div class="t m0 x11a h49 y576d ff19 fs26 fc0 sc0 ls0 ws0">when <span class="_ _2"></span>it <span class="_ _3"></span>is <span class="_ _2"></span>unable <span class="_ _2"></span>to <span class="_ _3"></span>ﬁnd <span class="_ _2"></span>the <span class="_ _3"></span>printer<span class="_ _9"></span>’s <span class="_ _2"></span>address. <span class="_ _66"> </span>If<span class="_ _47"> </span><span class="ls6ff">ap<span class="_ _4f"></span><span class="ls0">rinter <span class="_ _2"></span>address <span class="_ _2"></span>is <span class="_ _3"></span>found,</span></span></div><div class="t m0 x11a h4d y576e ff19 fs26 fc0 sc0 ls0 ws0">however<span class="_ _6"></span><span class="ls1791">,w<span class="_ _26"></span><span class="ls1792">es<span class="_ _26"></span><span class="ls0">et <span class="_ _35"> </span>the <span class="_ _45"> </span>printer <span class="_ _35"> </span>name <span class="_ _35"> </span>to <span class="_ _45"> </span>the<span class="_ _51"> </span><span class="ff1a">ai_canonname<span class="_ _51"> </span></span>ﬁeld <span class="_ _35"> </span>in <span class="_ _45"> </span>the</span></span></span></div><div class="t m0 x11a h4d y5bca ff1a fs26 fc0 sc0 ls0 ws0">addrinfo<span class="_ _66"> </span><span class="ff19">structure. <span class="_"> </span>If<span class="_"> </span>this <span class="_ _2"></span>ﬁeld <span class="_ _2"></span>is null, <span class="_ _2"></span>we <span class="_ _2"></span>set the <span class="_ _2"></span>printer <span class="_ _2"></span>name <span class="_ _2"></span>to a <span class="_ _2"></span>default</span></div><div class="t m0 x11a h4d y5bcb ff19 fs26 fc0 sc0 ls0 ws0">value <span class="_ _2"></span>of<span class="_ _66"> </span><span class="ff1a">printer</span><span class="ls1793">.N<span class="_ _5b"></span><span class="ls0">ote <span class="_ _2"></span>that <span class="_ _3"></span>we <span class="_ _2"></span>log <span class="_ _2"></span>the <span class="_ _2"></span>name <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>printer <span class="_ _2"></span>we <span class="_ _3"></span>ar<span class="ls1794">eu<span class="_ _8"></span><span class="ls0">sing <span class="_ _2"></span>to</span></span></span></span></div><div class="t m0 x11a h49 y5bcc ff19 fs26 fc0 sc0 ls0 ws0">aid administrators in diagnosing problems with the spooling system.</div><div class="t m0 x32 h4d y5772 ff19 fs26 fc0 sc0 ls0 ws0">[209 <span class="_ _a"></span>– <span class="_ _a"></span>224]<span class="_ _65"> </span>The<span class="_ _66"> </span><span class="ff1a">update_jobno<span class="_ _47"> </span></span>function <span class="_ _2"></span>is <span class="_ _2"></span>used <span class="_ _2"></span>to <span class="_ _3"></span>write <span class="_ _2"></span>the <span class="_ _2"></span>next <span class="_ _2"></span>job <span class="_ _3"></span>number <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>job</div><div class="t m0 x11a h4d y5773 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle,<span class="_ _35"> </span><span class="ff1a">/var/spool/printer/jobno</span><span class="ls1795">.W<span class="_ _5d"></span><span class="ls1796">es<span class="_ _43"></span><span class="ls0">eek <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _23"> </span>beginning <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _23"> </span>ﬁle,</span></span></span></div><div class="t m0 x11a h49 y5774 ff19 fs26 fc0 sc0 ls0 ws0">convert the integer job number into a string, and write it to the ﬁle.<span class="_ _46"> </span>On error<span class="_ _6"></span>,</div><div class="t m0 x11a h49 y5bcd ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _45"> </span>log <span class="_ _35"> </span>a <span class="_ _45"> </span>message <span class="_ _35"> </span>and <span class="_ _45"> </span>exit.<span class="_ _5c"> </span>The <span class="_ _35"> </span>job <span class="_ _45"> </span>number <span class="_ _35"> </span>increases <span class="_ _45"> </span>monotonically;</div><div class="t m0 x11a h49 y5bce ff19 fs26 fc0 sc0 ls0 ws0">handling wrap-around is left as an exer<span class="_ _0"></span>cise (see Exer<span class="_ _0"></span>cise 21.9).</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
