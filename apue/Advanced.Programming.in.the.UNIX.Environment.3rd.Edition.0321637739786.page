<div id="pf312" class="pf w4 h1f" data-page-no="312"><div class="pc pc312 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg312.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">752<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _42"> </span>user <span class="_ _42"> </span>processes <span class="_ _42"> </span>that <span class="_ _42"> </span>call <span class="_ _42"> </span>the <span class="_ _42"> </span>functions <span class="_ _42"> </span>in <span class="_ _42"> </span>the <span class="_ _53"> </span>database <span class="_ _42"> </span>library <span class="_ _42"> </span>to <span class="_ _42"> </span>perform <span class="_ _42"> </span>I/O <span class="_ _53"> </span>are</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">considered <span class="_ _4b"> </span>cooperating <span class="_ _4b"> </span>processes, <span class="_ _4b"> </span>since <span class="_ _59"> </span>they <span class="_ _4b"> </span>use <span class="_ _59"> </span>byte-range <span class="_ _4b"> </span>locking <span class="_ _59"> </span>to <span class="_ _4b"> </span>provide</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">concurrent access.</div><div class="t m0 x35 h53 y5649 ff16 fs2b fc0 sc0 ls0 ws0">20.6 <span class="_ _93"> </span>Concurrency</div><div class="t m0 x32 h2a y34a7 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _45"> </span>p<span class="_ _3"></span><span class="ls0">urposely <span class="_ _42"> </span>chose <span class="_ _42"> </span>a <span class="_ _23"> </span>two-ﬁle <span class="_ _42"> </span>implementation <span class="_ _42"> </span>(an <span class="_ _23"> </span>index <span class="_ _42"> </span>ﬁle <span class="_ _23"> </span>and <span class="_ _42"> </span>a <span class="_ _42"> </span>data <span class="_ _23"> </span>ﬁle) <span class="_ _42"> </span>because</span></div><div class="t m0 x32 h2a y34a8 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _e"> </span>is <span class="_ _e"> </span>a <span class="_ _e"> </span>common <span class="_ _e"> </span>implementation <span class="_ _e"> </span>technique <span class="_ _e"> </span>(it <span class="_ _e"> </span>simpliﬁes <span class="_"> </span>space <span class="_ _53"> </span>management <span class="_ _e"> </span>in <span class="_ _e"> </span>the</div><div class="t m0 x32 h2a y34a9 ff19 fsf fc0 sc0 ls0 ws0">ﬁles). <span class="_ _59"> </span>It<span class="_ _46"> </span><span class="ls45">re<span class="_ _2"></span></span>quires <span class="_"> </span>us <span class="_"> </span>to <span class="_"> </span>handle <span class="_"> </span>the <span class="_"> </span>locking <span class="_"> </span>interactions <span class="_"> </span>of <span class="_"> </span>both <span class="_"> </span>ﬁles.<span class="_ _60"> </span>But <span class="_"> </span>ther<span class="ls1637">ea<span class="_ _5b"></span><span class="ls45">re</span></span></div><div class="t m0 x32 h2a y34aa ff19 fsf fc0 sc0 ls0 ws0">numerous ways to handle the locking of these two ﬁles.</div><div class="t m0 x35 h27 y34ac ff16 fsf fc0 sc0 ls0 ws0">Coarse-Grained Loc<span class="_ _0"></span>king</div><div class="t m0 x32 h2a y564a ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _e"> </span>simplest <span class="_ _e"> </span>form <span class="_"> </span>of <span class="_ _53"> </span>locking <span class="_"> </span>is <span class="_ _53"> </span>to <span class="_"> </span>use <span class="_ _53"> </span>one <span class="_"> </span>of <span class="_ _53"> </span>the <span class="_"> </span>two <span class="_ _53"> </span>ﬁles <span class="_"> </span>as <span class="_ _53"> </span>a <span class="_"> </span>lock <span class="_ _53"> </span>for <span class="_"> </span>the <span class="_ _53"> </span>entire</div><div class="t m0 x32 h2a y564b ff19 fsf fc0 sc0 ls0 ws0">database <span class="_ _9"></span>and <span class="_ _9"></span>to <span class="_ _9"></span>requir<span class="lsf99">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>caller <span class="_ _23"></span>to <span class="_ _9"></span>obtain <span class="_ _9"></span>this <span class="_ _9"></span>lock <span class="_ _9"></span>befor<span class="ls142b">eo<span class="_ _b"></span><span class="ls0">perating <span class="_ _9"></span>on <span class="_ _9"></span>the <span class="_ _9"></span>database.</span></span></span></span></div><div class="t m0 x32 h2b y564c ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _80"> </span>c<span class="_ _9"></span><span class="ls0">all <span class="_ _3"></span>this<span class="_ _47"> </span><span class="ff1b">coarse-grained <span class="_ _2"></span>locking</span><span class="lse19">.F<span class="_ _5b"></span><span class="ls0">or <span class="_ _3"></span>example, <span class="_ _2"></span>we <span class="_ _3"></span>can <span class="_ _3"></span>say <span class="_ _3"></span>that <span class="_ _3"></span>the <span class="_ _2"></span>process <span class="_ _3"></span>with <span class="_ _2"></span>a <span class="_ _3"></span>read</span></span></span></div><div class="t m0 x32 h2a y564d ff19 fsf fc0 sc0 ls0 ws0">lock <span class="_ _3"></span>on <span class="_ _3"></span>byte <span class="_ _3"></span>0 <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>index <span class="_ _2"></span>ﬁle <span class="_ _9"></span>has <span class="_ _3"></span>read <span class="_ _2"></span>access <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>entir<span class="_ _0"></span><span class="lsb88">ed<span class="_ _8"></span><span class="ls0">atabase. <span class="_ _47"> </span>A<span class="_ _45"> </span>pr<span class="_ _0"></span>ocess <span class="_ _3"></span>with <span class="_ _3"></span>a</span></span></div><div class="t m0 x32 h2a y564e ff19 fsf fc0 sc0 ls0 ws0">write <span class="_ _2"></span>lock <span class="_ _2"></span>on <span class="_ _2"></span>byte <span class="_ _2"></span>0 <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>index <span class="_ _2"></span>ﬁle <span class="_ _2"></span>has <span class="_ _3"></span>write <span class="_ _2"></span>access <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>entir<span class="ls9e9">ed<span class="_ _4f"></span><span class="ls0">atabase. <span class="_ _66"> </span>W<span class="_ _6"></span><span class="ls9e9">ec<span class="_ _4f"></span><span class="ls0">an <span class="_ _3"></span>use</span></span></span></span></div><div class="t m0 x32 h2a y564f ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _3"></span>normal <span class="_ _2"></span>UNIX <span class="_ _3"></span>System <span class="_ _3"></span>byte-range <span class="_ _3"></span>locking <span class="_ _3"></span>semantics <span class="_ _3"></span>to <span class="_ _3"></span>allow <span class="_ _3"></span>any <span class="_ _3"></span>number <span class="_ _3"></span>of <span class="_ _3"></span>readers</div><div class="t m0 x32 h2a y5650 ff19 fsf fc0 sc0 ls0 ws0">at <span class="_ _45"> </span>one <span class="_ _35"> </span>time, <span class="_ _45"> </span>but <span class="_ _35"> </span>only <span class="_ _45"> </span>one <span class="_ _45"> </span>writer <span class="_ _35"> </span>at <span class="_ _45"> </span>a <span class="_ _35"> </span>time.<span class="_ _1a3"> </span>(Recall <span class="_ _35"> </span>Figur<span class="_ _0"></span><span class="ls1638">e1<span class="_ _26"></span><span class="ls0">4.3.) <span class="_ _5a"> </span>The<span class="_ _51"> </span>functions</span></span></div><div class="t m0 x32 h26 y5651 ff1a fsf fc0 sc0 ls0 ws0">db_fetch<span class="_ _4b"> </span><span class="ff19">and<span class="_ _59"> </span></span>db_nextrec<span class="_ _59"> </span><span class="ff19 ls45">re<span class="_ _2"></span><span class="ls0">quir<span class="lsee3">ear<span class="_ _5b"></span><span class="ls0">ead <span class="_"> </span>lock, <span class="_ _e"> </span>and<span class="_ _59"> </span><span class="ff1a">db_delete</span>,<span class="_ _4b"> </span><span class="ff1a">db_store</span><span class="lsee3">,a<span class="_ _55"></span><span class="ls0">nd</span></span></span></span></span></span></div><div class="t m0 x32 h26 y5652 ff1a fsf fc0 sc0 ls0 ws0">db_open<span class="_ _45"> </span><span class="ff19">all <span class="_ _3"></span>requir<span class="ls4ae">eaw<span class="_ _b"></span><span class="ls0">rite <span class="_ _3"></span>lock.<span class="_ _5a"> </span>(The <span class="_ _9"></span>reason<span class="_ _47"> </span><span class="ff1a">db_open<span class="_ _45"> </span></span><span class="ls45">re<span class="_ _2"></span></span>quires <span class="_ _3"></span>a <span class="_ _9"></span>write <span class="_ _9"></span>lock <span class="_ _9"></span>is <span class="_ _9"></span>that <span class="_ _3"></span>if</span></span></span></div><div class="t m0 x32 h2a y5653 ff19 fsf fc0 sc0 ls0 ws0">the ﬁle <span class="_ _2"></span>is <span class="_ _2"></span>being <span class="_ _2"></span>created, it <span class="_ _2"></span>has <span class="_ _2"></span>to <span class="_ _2"></span>write <span class="_ _2"></span>the <span class="_ _2"></span>empty free <span class="_ _2"></span>list and <span class="_ _2"></span>hash <span class="_ _2"></span>chains <span class="_ _2"></span>at <span class="_ _2"></span>the <span class="_ _2"></span>front of</div><div class="t m0 x32 h2a y5654 ff19 fsf fc0 sc0 ls0 ws0">the index ﬁle.)</div><div class="t m0 x3f h2a y5655 ff19 fsf fc0 sc0 ls0 ws0">The problem with coarse-grained locking <span class="_ _2"></span>is that it <span class="_ _2"></span>limits concurrency<span class="_ _4"></span><span class="ls1639">.I<span class="_ _4a"></span><span class="ls8a7">fap<span class="_ _4f"></span><span class="ls45">ro<span class="_ _2"></span><span class="ls0">cess is</span></span></span></span></div><div class="t m0 x32 h2a y5656 ff19 fsf fc0 sc0 ls0 ws0">adding <span class="_ _2"></span>a <span class="_ _2"></span>record<span class="_"> </span>to<span class="_ _47"> </span>one <span class="_ _2"></span>hash <span class="_ _3"></span>chain, <span class="_ _2"></span>another <span class="_ _3"></span>process should <span class="_ _3"></span>be <span class="_ _2"></span>able <span class="_ _2"></span>to <span class="_ _3"></span>read <span class="_ _2"></span>a <span class="_ _2"></span>record<span class="_"> </span>on<span class="_ _47"> </span>a</div><div class="t m0 x32 h2a y5657 ff19 fsf fc0 sc0 ls0 ws0">differ<span class="_ _0"></span>ent hash chain.</div><div class="t m0 x35 h27 y5658 ff16 fsf fc0 sc0 ls0 ws0">Fine-Grained Locking</div><div class="t m0 x32 h2b y5659 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _80"> </span>e<span class="_ _9"></span><span class="ls0">nhance <span class="_ _3"></span>coarse-grained <span class="_ _9"></span>locking <span class="_ _3"></span>to <span class="_ _3"></span>allow <span class="_ _3"></span>mor</span><span class="ls45f">ec<span class="_ _b"></span><span class="ls0">oncurrency <span class="_ _3"></span>and <span class="_ _3"></span>call <span class="_ _3"></span>this<span class="_ _45"> </span><span class="ff1b">ﬁne-grained</span></span></span></div><div class="t m0 x32 h2b y565a ff1b fsf fc0 sc0 ls0 ws0">locking<span class="ff19 ls163a">.W<span class="_ _7"></span><span class="ls163b">eﬁ<span class="_ _8"></span><span class="ls0">rst <span class="_ _3"></span>requir<span class="_ _0"></span><span class="lsfb8">ear<span class="_ _b"></span><span class="ls0">eader <span class="_ _3"></span>or <span class="_ _3"></span>a <span class="_ _3"></span>writer <span class="_ _3"></span>to <span class="_ _3"></span>obtain <span class="_ _3"></span>a <span class="_ _3"></span>read <span class="_ _2"></span>lock <span class="_ _3"></span>or <span class="_ _3"></span>a <span class="_ _3"></span>write <span class="_ _3"></span>lock <span class="_ _2"></span>on <span class="_ _3"></span>the</span></span></span></span></span></div><div class="t m0 x32 h2a y565b ff19 fsf fc0 sc0 ls0 ws0">hash chain <span class="_ _2"></span>for a <span class="_ _2"></span>given <span class="_ _2"></span>recor<span class="_ _0"></span>d. <span class="_"> </span>W<span class="_ _6"></span><span class="ls8e9">ea<span class="_ _d"></span><span class="ls0">llow <span class="_ _2"></span>any number <span class="_ _2"></span>of <span class="_ _2"></span>readers at one <span class="_ _2"></span>time on <span class="_ _2"></span>any <span class="_ _2"></span>hash</span></span></div><div class="t m0 x32 h2a y565c ff19 fsf fc0 sc0 ls0 ws0">chain <span class="_ _2"></span>but <span class="_ _2"></span>only <span class="_ _3"></span>a <span class="_ _2"></span>single <span class="_ _2"></span>writer <span class="_ _3"></span>on <span class="_ _2"></span>a <span class="_ _2"></span>hash <span class="_ _2"></span>chain.<span class="_ _16"> </span>Next, <span class="_ _2"></span>a <span class="_ _2"></span>writer <span class="_ _3"></span>needing <span class="_ _2"></span>to <span class="_ _2"></span>access <span class="_ _3"></span>the <span class="_ _2"></span>free</div><div class="t m0 x32 h26 y565d ff19 fsf fc0 sc0 ls0 ws0">list <span class="_ _3"></span>(either<span class="_ _45"> </span><span class="ff1a">db_delete<span class="_ _47"> </span></span>or<span class="_ _47"> </span><span class="ff1a">db_store</span><span class="ls11f0">)m<span class="_ _8"></span><span class="ls0">ust <span class="_ _9"></span>obtain <span class="_ _3"></span>a <span class="_ _3"></span>write <span class="_ _9"></span>lock <span class="_ _3"></span>on <span class="_ _3"></span>the <span class="_ _9"></span>free <span class="_ _2"></span>list.<span class="_ _5a"> </span>Finally<span class="_ _4"></span>,</span></span></div><div class="t m0 x32 h2a y565e ff19 fsf fc0 sc0 ls0 ws0">whenever <span class="_ _23"> </span>it <span class="_ _23"> </span>appends <span class="_ _42"> </span>a <span class="_ _23"> </span>new <span class="_ _23"> </span>record<span class="_ _45"> </span>to<span class="_ _35"> </span>the <span class="_ _42"> </span>end <span class="_ _23"> </span>of <span class="_ _23"> </span>either <span class="_ _42"> </span>the <span class="_ _23"> </span>index <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>or <span class="_ _23"></span>the <span class="_ _23"> </span>data <span class="_ _23"> </span>ﬁle,</div><div class="t m0 x32 h26 y565f ff1a fsf fc0 sc0 ls0 ws0">db_store<span class="_ _80"> </span><span class="ff19">has to obtain a write lock on that portion of the ﬁle.</span></div><div class="t m0 x3f h2a y5660 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _45"> </span>e<span class="_ _9"></span><span class="ls0">xpect <span class="_ _42"> </span>ﬁne-grained <span class="_ _42"> </span>locking <span class="_ _53"> </span>to <span class="_ _42"> </span>provide <span class="_ _42"> </span>mor<span class="ls88d">ec<span class="_ _c"></span><span class="ls0">oncurrency <span class="_ _23"> </span>than <span class="_ _53"> </span>coarse-grained</span></span></span></div><div class="t m0 x32 h2a y5661 ff19 fsf fc0 sc0 ls0 ws0">locking. <span class="_ _66"> </span>In<span class="_ _47"> </span>Section <span class="_ _2"></span>20.9, <span class="_ _2"></span>we <span class="_ _2"></span>show <span class="_ _3"></span>some <span class="_ _2"></span>actual <span class="_ _2"></span>measurements. <span class="_ _66"> </span>In<span class="_ _47"> </span>Section <span class="_ _2"></span>20.8, <span class="_ _2"></span>we <span class="_ _2"></span>show</div><div class="t m0 x32 h2a y5662 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _9"></span>source <span class="_ _3"></span>code <span class="_ _9"></span>for <span class="_ _9"></span>our <span class="_ _9"></span>implementation <span class="_ _9"></span>of <span class="_ _9"></span>ﬁne-grained <span class="_ _9"></span>locking <span class="_ _9"></span>and <span class="_ _9"></span>discuss <span class="_ _9"></span>the <span class="_ _9"></span>details</div><div class="t m0 x32 h2a y5663 ff19 fsf fc0 sc0 ls0 ws0">of <span class="_"> </span>implementing <span class="_"> </span>locking.<span class="_ _50"> </span>(Coarse-grained <span class="_"> </span>locking <span class="_"> </span>is <span class="_ _66"> </span>merely <span class="_"> </span>a <span class="_"> </span>simpliﬁcation <span class="_"> </span>of <span class="_ _66"> </span>the</div><div class="t m0 x32 h2a y5664 ff19 fsf fc0 sc0 ls0 ws0">locking that we show<span class="_ _6"></span>.)</div><div class="t m0 x3f h26 y5665 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _9"></span>the <span class="_ _9"></span>source <span class="_ _3"></span>code, <span class="_ _9"></span>we <span class="_ _9"></span>call<span class="_ _45"> </span><span class="ff1a">read</span>,<span class="_ _45"> </span><span class="ff1a">readv</span>,<span class="_ _47"> </span><span class="ff1a">write</span><span class="ls1295">,a<span class="_ _8"></span><span class="ls0">nd<span class="_ _45"> </span><span class="ff1a">writev<span class="_ _45"> </span></span>dir<span class="_ _0"></span>ectly<span class="_ _4"></span><span class="lsf8c">.W<span class="_ _52"></span><span class="ls0">e<span class="_ _45"> </span>do<span class="_ _45"> </span>not</span></span></span></span></div><div class="t m0 x32 h2a y5666 ff19 fsf fc0 sc0 ls0 ws0">use <span class="_ _2"></span>the <span class="_ _3"></span>standar<span class="ls6e0">dI<span class="_ _8"></span><span class="ls0">/O <span class="_ _2"></span>library<span class="_ _6"></span><span class="ls163c">.A<span class="_ _1d"></span><span class="ls0">lthough <span class="_ _3"></span>it <span class="_ _2"></span>is <span class="_ _3"></span>possible <span class="_ _2"></span>to <span class="_ _2"></span>use <span class="_ _3"></span>byte-range <span class="_ _2"></span>locking <span class="_ _3"></span>with <span class="_ _2"></span>the</span></span></span></span></div><div class="t m0 x32 h2a y5667 ff19 fsf fc0 sc0 ls0 ws0">standar<span class="ls1114">dI<span class="_ _1d"></span><span class="ls0">/O <span class="_ _66"> </span>library<span class="_ _6"></span><span class="ls1114">,c<span class="_ _5b"></span><span class="ls0">areful <span class="_"> </span>handling <span class="_ _66"> </span>of <span class="_ _66"> </span>buffering <span class="_"> </span>is <span class="_"> </span>required. <span class="_ _59"> </span>W<span class="_ _6"></span><span class="ls163d">ed<span class="_ _4a"></span><span class="ls0">on’t <span class="_"> </span>want <span class="_ _66"> </span>an</span></span></span></span></span></span></div><a class="l" href="#pf13" data-dest-detail='[19,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.891993px;bottom:1117.848863px;width:109.896004px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
