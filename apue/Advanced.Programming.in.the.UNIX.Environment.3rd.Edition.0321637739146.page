<div id="pf92" class="pf w4 h1f" data-page-no="92"><div class="pc pc92 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg92.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls153 ws0">11<span class="_ _2"></span><span class="ls0">2<span class="_ _1b"> </span><span class="ff19">Files <span class="_"> </span>and <span class="_"> </span>Directories <span class="_ _199"> </span>Chapter<span class="_ _4b"> </span>4</span></span></div><div class="t m0 x3f h57 yf5f ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">wc -c core</span></div><div class="t m0 x90 h57 yf60 ff1a fs2d fc0 sc0 ls0 ws0">8483248 core</div><div class="t m0 x76 h52 y102a ff19 fs2a fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1a">wc</span></div><div class="t m0 x50 h51 y102b ff19 fs2a fc0 sc0 ls0 ws0">(</div><div class="t m0 x144 h51 y102a ff19 fs2a fc0 sc0 ls0 ws0">1</div><div class="t m0 x180 h51 y102b ff19 fs2a fc0 sc0 ls0 ws0">)</div><div class="t m0 x38 h52 y102a ff19 fs2a fc0 sc0 ls0 ws0">command with the<span class="_"> </span><span class="ff1a">-c<span class="_ _53"> </span></span>option counts the number of characters (bytes) in the ﬁle.</div><div class="t m0 x3f h26 y102c ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _42"> </span>we <span class="_ _53"> </span>make <span class="_ _42"> </span>a <span class="_ _53"> </span>copy <span class="_ _53"> </span>of <span class="_ _42"> </span>this <span class="_ _53"> </span>ﬁle, <span class="_ _42"> </span>using <span class="_ _53"> </span>a <span class="_ _53"> </span>utility <span class="_ _42"> </span>such <span class="_ _53"> </span>as<span class="_ _44"> </span><span class="ff1a">cat</span></div><div class="t m0 x5e h2a y102d ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x111 h2a y102c ff19 fsf fc0 sc0 ls0 ws0">1</div><div class="t m0 x119 h2a y102d ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x16c h2a y102c ff19 fsf fc0 sc0 ls4fa ws0">,a<span class="_ _c"></span><span class="ls0">ll <span class="_ _53"> </span>these <span class="_ _42"> </span>holes <span class="_ _53"> </span>are</span></div><div class="t m0 x32 h2a y102e ff19 fsf fc0 sc0 ls0 ws0">written out as actual data bytes of 0:</div><div class="t m0 x3f h57 y102f ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">cat core &gt; core.copy</span></div><div class="t m0 x3f h57 y1030 ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">ls -l core*</span></div><div class="t m0 x3f h57 y1031 ff1a fs2d fc0 sc0 ls0 ws0">-rw-r--r-- <span class="_"> </span>1<span class="_"> </span>sar <span class="_ _d9"> </span>8483248<span class="_"> </span>Nov 18 12:18 core</div><div class="t m0 x3f h57 y1032 ff1a fs2d fc0 sc0 ls0 ws0">-rw-rw-r-- <span class="_"> </span>1<span class="_"> </span>sar <span class="_ _d9"> </span>8483248<span class="_"> </span>Nov 18 12:27 core.copy</div><div class="t m0 x3f h57 y1033 ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">du -s core*</span></div><div class="t m0 x3f h57 y1034 ff1a fs2d fc0 sc0 ls0 ws0">272 <span class="_ _15"> </span>core</div><div class="t m0 x3f h57 y1035 ff1a fs2d fc0 sc0 ls0 ws0">16592 <span class="_ _d9"> </span>core.copy</div><div class="t m0 x32 h2a y1036 ff19 fsf fc0 sc0 ls0 ws0">Here, <span class="_ _9"></span>the <span class="_ _9"></span>actual <span class="_ _23"></span>number <span class="_ _9"></span>of <span class="_ _9"></span>bytes <span class="_ _23"></span>used <span class="_ _9"></span>by <span class="_ _23"></span>the <span class="_ _9"></span>new <span class="_ _23"></span>ﬁle <span class="_ _9"></span>is <span class="_ _9"></span>8,495,104</div><div class="t m0 x18d h2a y1037 ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x16f h2a y1036 ff19 fsf fc0 sc0 ls0 ws0">512<span class="_ _45"> </span><span class="ff20">×<span class="_ _45"> </span></span>16,592</div><div class="t m0 x18e h2a y1037 ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x10b h2a y1036 ff19 fsf fc0 sc0 ls4fb ws0">.T<span class="_ _26"></span><span class="ls0">he</span></div><div class="t m0 x32 h26 y1038 ff19 fsf fc0 sc0 ls0 ws0">differ<span class="_ _0"></span>ence <span class="_ _23"> </span>between <span class="_ _42"> </span>this <span class="_ _42"> </span>size <span class="_ _42"> </span>and <span class="_ _42"> </span>the <span class="_ _42"> </span>size <span class="_ _42"> </span>reported <span class="_ _23"> </span>by<span class="_ _44"> </span><span class="ff1a">ls<span class="_ _44"> </span></span>is <span class="_ _23"> </span>caused <span class="_ _42"> </span>by <span class="_ _42"> </span>the <span class="_ _42"> </span>number <span class="_ _42"> </span>of</div><div class="t m0 x32 h2a y1039 ff19 fsf fc0 sc0 ls0 ws0">blocks used by the ﬁle system to hold pointers to the actual data blocks.</div><div class="t m0 x3f h2a y103a ff19 fsf fc0 sc0 ls0 ws0">Interested <span class="_ _2"></span>readers <span class="_ _3"></span>should <span class="_ _9"></span>refer <span class="_ _3"></span>to <span class="_ _3"></span>Section <span class="_ _9"></span>4.2 <span class="_ _3"></span>of <span class="_ _9"></span>Bach</div><div class="t m0 xa4 h2a y103b ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x15b h2a y103a ff19 fsf fc0 sc0 ls0 ws0">1986</div><div class="t m0 xc h2a y103b ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x6e h2a y103a ff19 fsf fc0 sc0 ls4fc ws0">,S<span class="_ _b"></span><span class="ls0">ections <span class="_ _9"></span>7.2 <span class="_ _3"></span>and <span class="_ _9"></span>7.3 <span class="_ _3"></span>of</span></div><div class="t m0 x32 h2a y103c ff19 fsf fc0 sc0 ls0 ws0">McKusick <span class="_ _42"> </span>et <span class="_ _42"> </span>al.</div><div class="t m0 xdf h2a y103d ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x12f h2a y103c ff19 fsf fc0 sc0 ls0 ws0">1996</div><div class="t m0 x89 h2a y103d ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x18f h2a y103c ff19 fsf fc0 sc0 ls0 ws0">(or <span class="_ _42"> </span>Sections <span class="_ _42"> </span>8.2 <span class="_ _42"> </span>and <span class="_ _42"> </span>8.3 <span class="_ _42"> </span>in <span class="_ _42"> </span>McKusick <span class="_ _42"> </span>and <span class="_ _42"> </span>Neville-Neil</div><div class="t m0 x190 h2a y103d ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 xfb h2a y103c ff19 fsf fc0 sc0 ls0 ws0">2005</div><div class="t m0 xcf h2a y103d ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x191 h2a y103c ff19 fsf fc0 sc0 ls0 ws0">),</div><div class="t m0 x32 h2a y103e ff19 fsf fc0 sc0 ls0 ws0">Section <span class="_ _66"> </span>15.2 <span class="_ _47"> </span>of <span class="_ _47"> </span>McDougall <span class="_ _47"> </span>and <span class="_ _66"> </span>Mauro</div><div class="t m0 x67 h2a y103f ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x12e h2a y103e ff19 fsf fc0 sc0 ls0 ws0">2007</div><div class="t m0 x78 h2a y103f ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x15d h2a y103e ff19 fsf fc0 sc0 ls4fd ws0">,a<span class="_ _1d"></span><span class="ls0">nd <span class="_ _47"> </span>Chapter <span class="_ _47"> </span>12 <span class="_ _66"> </span>in <span class="_ _47"> </span>Singh</span></div><div class="t m0 xd5 h2a y103f ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x69 h2a y103e ff19 fsf fc0 sc0 ls0 ws0">2006</div><div class="t m0 x58 h2a y103f ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x192 h2a y103e ff19 fsf fc0 sc0 ls0 ws0">for</div><div class="t m0 x32 h2a y1040 ff19 fsf fc0 sc0 ls0 ws0">additional details on the physical layout of ﬁles.</div><div class="t m0 x35 h53 y1041 ff16 fs2b fc0 sc0 ls0 ws0">4.13 <span class="_ _93"> </span>File<span class="_ _54"> </span><span class="ls4fe">Tr<span class="_ _9"></span></span>uncation</div><div class="t m0 x32 h2a y1042 ff19 fsf fc0 sc0 ls0 ws0">Sometimes <span class="_ _9"></span>we <span class="_ _9"></span>would <span class="_ _9"></span>like <span class="_ _9"></span>to <span class="_ _9"></span>truncate <span class="_ _9"></span>a <span class="_ _9"></span>ﬁle <span class="_ _9"></span>by <span class="_ _9"></span>chopping <span class="_ _23"></span>of<span class="ls4ff">fd<span class="_ _b"></span><span class="ls0">ata <span class="_ _3"></span>at <span class="_ _9"></span>the <span class="_ _9"></span>end <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _3"></span>ﬁle.</span></span></div><div class="t m0 x32 h26 y1043 ff19 fsf fc0 sc0 ls0 ws0">Emptying <span class="_ _9"></span>a <span class="_ _23"></span>ﬁle, <span class="_ _9"></span>which <span class="_ _23"></span>we <span class="_ _9"></span>can <span class="_ _23"></span>do <span class="_ _9"></span>with <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">O_TRUNC<span class="_ _45"> </span></span>ﬂag <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">open</span>,<span class="_ _45"> </span>is<span class="_ _35"> </span>a<span class="_ _45"> </span>special <span class="_ _9"></span>case <span class="_ _23"></span>of</div><div class="t m0 x32 h2a y1044 ff19 fsf fc0 sc0 ls0 ws0">truncation.</div><div class="t m0 x3f h57 y1045 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h57 y1046 ff1a fs2d fc0 sc0 ls0 ws0">int truncate(const char *<span class="ff1b">pathname</span><span class="ls15c">,o<span class="_ _1d"></span><span class="ls0">ff_t<span class="_"> </span><span class="ff1b">length</span>);</span></span></div><div class="t m0 x3f h57 y1047 ff1a fs2d fc0 sc0 ls0 ws0">int ftruncate(int<span class="_"> </span><span class="ff1b">fd</span><span class="ls15c">,o<span class="_ _1d"></span><span class="ls0">ff_t<span class="_"> </span><span class="ff1b">length</span>);</span></span></div><div class="t m0 x103 h5f y1048 ff19 fs2d fc0 sc0 ls0 ws0">Both return: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x32 h4a y1049 ff19 fs26 fc0 sc0 ls0 ws0">These <span class="_ _3"></span>two <span class="_ _9"></span>functions <span class="_ _9"></span>truncate <span class="_ _3"></span>an <span class="_ _9"></span>existing <span class="_ _3"></span>ﬁle <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1b">length<span class="_ _47"> </span></span>bytes. <span class="_ _45"> </span>If<span class="_ _45"> </span>the <span class="_ _3"></span>previous <span class="_ _3"></span>size <span class="_ _9"></span>of <span class="_ _3"></span>the</div><div class="t m0 x32 h4a y104a ff19 fs26 fc0 sc0 ls0 ws0">ﬁle was <span class="_ _2"></span>greater than<span class="_ _66"> </span><span class="ff1b">length</span><span class="ls500">,t<span class="_ _d"></span><span class="ls0">he <span class="_ _2"></span>data beyond<span class="_ _66"> </span><span class="ff1b">length<span class="_ _47"> </span></span>is no <span class="_ _2"></span>longer accessible.<span class="_ _61"> </span>Otherwise, <span class="_ _2"></span>if</span></span></div><div class="t m0 x32 h4a y104b ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>previous <span class="_ _23"></span>size <span class="_ _9"></span>was <span class="_ _23"> </span>less <span class="_ _23"></span>than<span class="_ _45"> </span><span class="ff1b">length</span><span class="ls501">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>ﬁle <span class="_ _23"> </span>size <span class="_ _23"></span>will <span class="_ _9"></span>increase <span class="_ _23"></span>and <span class="_ _9"></span>the <span class="_ _23"></span>data <span class="_ _23"></span>between</span></span></div><div class="t m0 x32 h49 y104c ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>old <span class="_ _3"></span>end <span class="_ _3"></span>of <span class="_ _3"></span>ﬁle <span class="_ _3"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>new <span class="_ _3"></span>end <span class="_ _3"></span>of <span class="_ _3"></span>ﬁle <span class="_ _3"></span>will <span class="_ _3"></span>read <span class="_ _2"></span>as <span class="_ _9"></span>0 <span class="_ _2"></span>(i.e., <span class="_ _3"></span>a <span class="_ _9"></span>hole <span class="_ _2"></span>is <span class="_ _3"></span>probably <span class="_ _3"></span>created</div><div class="t m0 x32 h49 y104d ff19 fs26 fc0 sc0 ls0 ws0">in the ﬁle).</div><div class="t m0 x76 h5e y104e ff19 fs10 fc0 sc0 ls0 ws0">BSD releases prior to 4.4BSD could only make a ﬁle smaller with<span class="_"> </span><span class="ff1a">truncate</span>.</div><div class="t m0 x76 h5e y104f ff19 fs10 fc0 sc0 ls0 ws0">Solaris <span class="_ _9"></span>also <span class="_ _9"> </span>includes <span class="_ _23"> </span>an <span class="_ _9"></span>extension <span class="_ _9"></span>to<span class="_ _47"> </span><span class="ff1a">fcntl<span class="_ _47"> </span></span>(<span class="ff1a">F_FREESP</span><span class="ls502">)t<span class="_ _8"></span><span class="ls0">hat <span class="_ _23"> </span>allows <span class="_ _9"></span>us <span class="_ _9"></span>to <span class="_ _23"> </span>fr<span class="_ _0"></span>ee <span class="_ _9"></span>any <span class="_ _9"> </span>part <span class="_ _23"> </span>of <span class="_ _9"></span>a</span></span></div><div class="t m0 x76 h2d y1050 ff19 fs10 fc0 sc0 ls0 ws0">ﬁle, not just a chunk at the end of the ﬁle.</div><div class="t m0 x3f h4d y1051 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _e"> </span>u<span class="_ _9"></span><span class="ls0">se<span class="_ _47"> </span><span class="ff1a">ftruncate<span class="_ _66"> </span></span>in <span class="_ _2"></span>the <span class="_ _2"></span>program shown <span class="_ _3"></span>in <span class="_ _2"></span>Figur<span class="ls503">e1<span class="_ _8"></span><span class="ls0">3.6 <span class="_ _2"></span>when <span class="_ _2"></span>we <span class="_ _2"></span>need <span class="_ _3"></span>to <span class="_ _2"></span>empty <span class="_ _2"></span>a</span></span></span></div><div class="t m0 x32 h49 y1052 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle after obtaining a lock on the ﬁle.</div><a class="l" href="#pfd" data-dest-detail='[13,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.896399px;bottom:658.158878px;width:124.390899px;height:19.680023px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
