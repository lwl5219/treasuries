<div id="pf20f" class="pf w4 h1f" data-page-no="20f"><div class="pc pc20f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg20f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.3<span class="_ _1f7"> </span>Recor<span class="ls30a">dL<span class="_ _55"></span><span class="ls0">ocking<span class="_ _1b"> </span><span class="ff18">493</span></span></span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="lsa27">e1<span class="_ _b"></span><span class="ls0">4.8 <span class="_ _3"></span>shows <span class="_ _3"></span>the <span class="_ _3"></span>resulting <span class="_ _2"></span>data <span class="_ _3"></span>structures <span class="_ _2"></span>after <span class="_ _3"></span>both <span class="_ _3"></span>the <span class="_ _3"></span>parent <span class="_ _2"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>child <span class="_ _3"></span>have</span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">paused.</div><div class="t m0 x1c1 h2d y3c5e ff19 fs10 fc0 sc0 ls0 ws0">parent pr<span class="_ _0"></span>ocess table entry</div><div class="t m0 x139 h80 y3c5f ff19 fs3e fc0 sc0 ls3cf ws0">...</div><div class="t m0 x1fa h81 y3c60 ff19 fs3f fc0 sc0 ls0 ws0">fd1:</div><div class="t m0 x1fa h81 y3c61 ff19 fs3f fc0 sc0 ls0 ws0">fd2:</div><div class="t m0 x1fa h81 y3c62 ff19 fs3f fc0 sc0 ls0 ws0">fd3:</div><div class="t m0 x167 h82 y3c63 ff19 fs40 fc0 sc0 ls0 ws0">fd</div><div class="t m0 x135 h82 y3c64 ff19 fs40 fc0 sc0 ls0 ws0">ﬂags</div><div class="t m0 x21c h82 y3c63 ff19 fs40 fc0 sc0 ls0 ws0">ﬁle</div><div class="t m0 x16e h82 y3c64 ff19 fs40 fc0 sc0 ls0 ws0">pointer</div><div class="t m0 x1f4 h30 y3c65 ff19 fs13 fc0 sc0 ls0 ws0">child process table entry</div><div class="t m0 x139 h8a y3c66 ff19 fs45 fc0 sc0 ls3d4 ws0">...</div><div class="t m0 x1fa h8b y3c67 ff19 fs46 fc0 sc0 ls0 ws0">fd1:</div><div class="t m0 x1fa h8b y3c68 ff19 fs46 fc0 sc0 ls0 ws0">fd2:</div><div class="t m0 x1fa h8b y3c69 ff19 fs46 fc0 sc0 ls0 ws0">fd3:</div><div class="t m0 x167 h7f y3c6a ff19 fs3d fc0 sc0 ls0 ws0">fd</div><div class="t m0 x135 h7f y3c6b ff19 fs3d fc0 sc0 ls0 ws0">ﬂags</div><div class="t m0 x21c h7f y3c6a ff19 fs3d fc0 sc0 ls0 ws0">ﬁle</div><div class="t m0 x16e h7f y3c6b ff19 fs3d fc0 sc0 ls0 ws0">pointer</div><div class="t m0 x1f5 h33 y3c6c ff19 fs16 fc0 sc0 ls0 ws0">ﬁle status ﬂags</div><div class="t m0 x17 h83 y3c6d ff19 fs36 fc0 sc0 ls0 ws0">current ﬁle of<span class="_ _0"></span>fset</div><div class="t m0 x1f5 h34 y3c6e ff19 fs17 fc0 sc0 ls0 ws0">v-node pointer</div><div class="t m0 x1f5 h35 y3c6f ff19 fs18 fc0 sc0 ls0 ws0">ﬁle status ﬂags</div><div class="t m0 x17 h36 y3c70 ff19 fs19 fc0 sc0 ls0 ws0">current ﬁle of<span class="_ _0"></span>fset</div><div class="t m0 x1f5 h37 y3c71 ff19 fs1a fc0 sc0 ls0 ws0">v-node pointer</div><div class="t m0 x87 h37 y3c72 ff19 fs1a fc0 sc0 ls0 ws0">ﬁle table entry</div><div class="t m0 x87 h37 y3c73 ff19 fs1a fc0 sc0 ls0 ws0">ﬁle table entry</div><div class="t m0 x168 h86 y3c74 ff19 fs42 fc0 sc0 ls0 ws0">v-node information</div><div class="t m0 xe3 h87 y3c75 ff1a fs42 fc0 sc0 ls0 ws0">lockf<span class="_ _42"> </span><span class="ff19">pointer</span></div><div class="t m0 x11f h87 y3c76 ff1a fs42 fc0 sc0 ls0 ws0">v_data</div><div class="t m0 x13b h86 y3c77 ff19 fs42 fc0 sc0 ls0 ws0">i-node information</div><div class="t m0 xd4 h86 y3c78 ff19 fs42 fc0 sc0 ls0 ws0">current ﬁle size</div><div class="t m0 x169 h87 y3c79 ff1a fs42 fc0 sc0 ls0 ws0">i_vnode</div><div class="t m0 x16a h88 y3c7a ff19 fs43 fc0 sc0 ls0 ws0">v-node table entry</div><div class="t m0 x16b h88 y3c7b ff19 fs43 fc0 sc0 ls0 ws0">i-node</div><div class="t m0 xcd h3c y3c7c ff19 fs1e fc0 sc0 ls0 ws0">lock header</div><div class="t m0 x107 h146 y3c7d ff1a fsb1 fc0 sc0 ls0 ws0">lockf_entry<span class="_ _42"> </span><span class="ff19">list</span></div><div class="t m0 x9c h3d y3c7e ff19 fs1f fc0 sc0 ls0 ws0">link</div><div class="t m0 xdd h3e y3c7f ff19 fs20 fc0 sc0 ls0 ws0">ﬂags</div><div class="t m0 xe h3f y3c80 ff19 fs21 fc0 sc0 ls0 ws0">starting offset</div><div class="t m0 x16 h40 y3c81 ff19 fs22 fc0 sc0 ls0 ws0">ending offset</div><div class="t m0 x5b h147 y3c82 ff1a fs65 fc0 sc0 ls0 ws0">lock_owner<span class="_ _42"> </span><span class="ff19">pointer</span></div><div class="t m0 x16f h42 y3c83 ff19 fs24 fc0 sc0 ls0 ws0">link</div><div class="t m0 x1b1 hf4 y3c84 ff19 fs85 fc0 sc0 ls0 ws0">ﬂags</div><div class="t m0 x5e h148 y3c85 ff19 fsa3 fc0 sc0 ls0 ws0">starting offset</div><div class="t m0 x1a1 h149 y3c86 ff19 fsa4 fc0 sc0 ls0 ws0">ending offset</div><div class="t m0 x166 h14a y3c87 ff1a fsb2 fc0 sc0 ls0 ws0">lock_owner<span class="_ _42"> </span><span class="ff19">pointer</span></div><div class="t m0 xc7 h14b y3c88 ff19 fsa5 fc0 sc0 ls0 ws0">owner information</div><div class="t m0 x10 h14b y3c89 ff19 fsa5 fc0 sc0 ls0 ws0">parent pr<span class="_ _0"></span>ocess ID</div><div class="t m0 x166 heb y3c8a ff19 fs67 fc0 sc0 ls0 ws0">owner information</div><div class="t m0 x6e heb y3c8b ff19 fs67 fc0 sc0 ls0 ws0">child process ID</div><div class="t m0 x107 h130 y3c8c ff1a fsa6 fc0 sc0 ls0 ws0">struct lockf</div><div class="t m0 x4a h130 y3c8d ff1a fsa6 fc0 sc0 ls0 ws0">struct lockf_entry<span class="_ _186"> </span>struct lockf_entry</div><div class="t m0 x110 h130 y3c8e ff1a fsa6 fc0 sc0 ls0 ws0">struct lock_owner<span class="_ _173"> </span>struct lock_owner</div><div class="t m0 x185 h14c y3c8f ff18 fsb3 fc0 sc0 ls0 ws0">Figure 14.8<span class="_ _5a"> </span><span class="ff19">The FreeBSD data structures for r<span class="_ _1"></span>ecor<span class="lsffc">dl<span class="_ _84"></span><span class="ls0">ocking</span></span></span></div><div class="t m0 x12a h14d y3c90 ff19 fsb4 fc0 sc0 lsffd ws0">We<span class="_ _9"></span><span class="ls0">’ve <span class="_ _42"> </span>shown <span class="_ _42"> </span>the <span class="_ _42"> </span>data <span class="_ _42"> </span>structures <span class="_ _42"> </span>that <span class="_ _42"> </span>result <span class="_ _23"> </span>from <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">open</span>,<span class="_ _44"> </span><span class="ff1a">fork</span><span class="lsffe">,a<span class="_ _c"></span><span class="ls0">nd<span class="_ _44"> </span><span class="ff1a">dup<span class="_ _44"> </span></span>calls</span></span></span></div><div class="t m0 x32 h14d y3c91 ff19 fsb4 fc0 sc0 ls0 ws0">earlier <span class="_ _3"></span>(Figures <span class="_ _2"></span>3.9 <span class="_ _3"></span>and <span class="_ _3"></span>8.2).<span class="_ _16"> </span>What <span class="_ _3"></span>is <span class="_ _3"></span>new <span class="_ _3"></span>her<span class="lsfff">ea<span class="_ _8"></span><span class="ls1000">re <span class="_ _9"></span>t<span class="_ _2"></span><span class="ls0">he<span class="_ _47"> </span><span class="ff1a">lockf<span class="_ _47"> </span></span>structures <span class="_ _2"></span>that <span class="_ _3"></span>ar<span class="lsfff">el<span class="_ _8"></span><span class="ls0">inked</span></span></span></span></span></div><div class="t m0 x32 h14d y3c92 ff19 fsb4 fc0 sc0 ls0 ws0">together <span class="_ _9"></span>from <span class="_ _9"></span>the <span class="_ _23"> </span>i-node <span class="_ _23"></span>structur<span class="_ _0"></span>e. <span class="_ _45"> </span>Each<span class="_ _45"> </span><span class="ff1a">lockf<span class="_ _35"> </span></span>structur<span class="_ _0"></span><span class="ls1001">ed<span class="_ _b"></span><span class="ls0">escribes <span class="_ _9"></span>one <span class="_ _23"></span>locked <span class="_ _9"></span>region</span></span></div><div class="t m0 x32 h14e y3c93 ff19 fsb4 fc0 sc0 ls0 ws0">(deﬁned <span class="_ _2"></span>by <span class="_ _3"></span>an <span class="_ _3"></span>offset <span class="_ _3"></span>and <span class="_ _3"></span>length) <span class="_ _2"></span>for <span class="_ _3"></span>a <span class="_ _3"></span>given <span class="_ _3"></span>process. <span class="_ _47"> </span>W<span class="_ _6"></span><span class="ls1002">es<span class="_ _8"></span><span class="ls0">how <span class="_ _3"></span>two <span class="_ _3"></span>of <span class="_ _3"></span>these <span class="_ _3"></span>structures:</span></span></div><div class="t m0 x32 h14d y3c94 ff19 fsb4 fc0 sc0 ls0 ws0">one <span class="_ _42"> </span>for <span class="_ _53"> </span>the <span class="_ _42"> </span>parent’s <span class="_ _42"> </span>call <span class="_ _42"> </span>to<span class="_ _44"> </span><span class="ff1a">write_lock<span class="_ _44"> </span></span>and <span class="_ _53"> </span>one <span class="_ _42"> </span>for <span class="_ _53"> </span>the <span class="_ _42"> </span>child’s <span class="_ _53"> </span>call <span class="_ _42"> </span>to<span class="_ _44"> </span><span class="ff1a">read_lock</span>.</div><div class="t m0 x32 h14e y3c95 ff19 fsb4 fc0 sc0 ls0 ws0">Each structur<span class="_ _0"></span><span class="ls1003">ec<span class="_ _d"></span><span class="ls0">ontains the corresponding process ID.</span></span></div><div class="t m0 x12a h14d y3c96 ff19 fsb4 fc0 sc0 ls0 ws0">In <span class="_ _23"> </span>the <span class="_ _23"> </span>parent, <span class="_ _23"> </span>closing <span class="_ _42"> </span>any <span class="_ _23"> </span>one <span class="_ _23"> </span>of<span class="_ _35"> </span><span class="ff1a">fd1</span>,<span class="_ _35"> </span><span class="ff1a">fd2</span><span class="ls1004">,o<span class="_ _b"></span><span class="ls0">r<span class="_ _45"> </span><span class="ff1a">fd3<span class="_ _35"> </span></span>causes <span class="_ _42"> </span>the <span class="_ _23"> </span>parent’s <span class="_ _23"></span>lock <span class="_ _23"> </span>to <span class="_ _42"> </span>be</span></span></div><div class="t m0 x32 h14e y3c97 ff19 fsb4 fc0 sc0 ls1000 ws0">re<span class="ls0">leased. <span class="_ _66"> </span>When<span class="_ _66"> </span>any <span class="_ _2"></span>one <span class="_ _2"></span>of these <span class="_ _2"></span>three ﬁle <span class="_ _2"></span>descriptors is <span class="_ _2"></span>closed, <span class="_ _2"></span>the kernel <span class="_ _2"></span>goes through</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
