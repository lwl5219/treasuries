<div id="pf282" class="pf w4 h1f" data-page-no="282"><div class="pc pc282 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg282.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">608<span class="_ _1b"> </span><span class="ff19">Network <span class="_"> </span>IPC: <span class="_"> </span>Sockets<span class="_ _2c6"> </span>Chapter <span class="_"> </span>16</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _47"> </span>the <span class="_ _47"> </span>socket <span class="_ _45"> </span>descriptor <span class="_ _47"> </span>is <span class="_ _47"> </span>in <span class="_ _47"> </span>nonblocking <span class="_ _45"> </span>mode, <span class="_ _47"> </span>which <span class="_ _47"> </span>we <span class="_ _45"> </span>discuss <span class="_ _47"> </span>further <span class="_ _47"> </span>in</div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">Section <span class="_ _35"> </span>16.8,<span class="_ _51"> </span><span class="ff1a">connect<span class="_ _54"> </span></span>will <span class="_ _35"> </span>return<span class="_ _51"> </span><span class="ff20">−</span><span class="ls1349">1w<span class="_ _52"></span><span class="ls0">ith<span class="_ _54"> </span><span class="ff1a">errno<span class="_ _51"> </span></span>set <span class="_ _35"> </span>to <span class="_ _35"> </span>the <span class="_ _35"> </span>special <span class="_ _44"> </span>error <span class="_ _45"> </span>code</span></span></div><div class="t m0 x32 h26 y131 ff1a fsf fc0 sc0 ls0 ws0">EINPROGRESS<span class="_ _45"> </span><span class="ff19">if <span class="_ _3"></span>the <span class="_ _9"></span>connection <span class="_ _9"></span>can’t <span class="_ _9"></span>be <span class="_ _9"></span>established <span class="_ _3"></span>immediately<span class="_ _6"></span><span class="ls134a">.T<span class="_ _62"></span><span class="ls0">he <span class="_ _9"></span>application <span class="_ _9"></span>can</span></span></span></div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">use <span class="_ _23"></span>either<span class="_ _35"> </span><span class="ff1a">poll<span class="_ _35"> </span></span>or<span class="_ _35"> </span><span class="ff1a">select<span class="_ _45"> </span></span>to <span class="_ _42"> </span>determine <span class="_ _23"></span>when <span class="_ _23"></span>the <span class="_ _23"></span>ﬁle <span class="_ _23"> </span>descriptor <span class="_ _23"> </span>is <span class="_ _23"> </span>writable.<span class="_ _51"> </span>At <span class="_ _23"> </span>this</div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">point, the connection is complete.</div><div class="t m0 x3f h26 y134 ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _59"> </span><span class="ff1a">connect<span class="_ _46"> </span></span>function <span class="_"> </span>can <span class="_"> </span>also <span class="_"> </span>be <span class="_ _e"> </span>used <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>connectionless <span class="_"> </span>network <span class="_ _e"> </span>service</div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls0 ws0">(<span class="ff1a">SOCK_DGRAM</span>). <span class="_ _47"> </span>This<span class="_ _47"> </span>might <span class="_ _9"></span>seem <span class="_ _3"></span>like <span class="_ _3"></span>a <span class="_ _3"></span>contradiction, <span class="_ _9"></span>but <span class="_ _3"></span>it <span class="_ _3"></span>is <span class="_ _9"></span>an <span class="_ _3"></span>optimization <span class="_ _3"></span>instead.</div><div class="t m0 x32 h26 y136 ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _2"></span>we <span class="_ _3"></span>call<span class="_ _47"> </span><span class="ff1a">connect<span class="_ _47"> </span></span>with <span class="_ _2"></span>a<span class="_ _47"> </span><span class="ff1a">SOCK_DGRAM<span class="_ _47"> </span></span>socket, <span class="_ _3"></span>the <span class="_ _2"></span>destination <span class="_ _3"></span>address <span class="_ _2"></span>of <span class="_ _3"></span>all <span class="_ _3"></span>messages</div><div class="t m0 x32 h26 y137 ff19 fsf fc0 sc0 ls0 ws0">we send <span class="_ _2"></span>is <span class="_ _2"></span>set <span class="_ _2"></span>to the <span class="_ _2"></span>address we <span class="_ _2"></span>speciﬁed <span class="_ _2"></span>in <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">connect<span class="_ _47"> </span></span>call, relieving us <span class="_ _2"></span>from having</div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _3"></span>provide <span class="_ _9"></span>the <span class="_ _3"></span>address <span class="_ _3"></span>every <span class="_ _9"></span>time <span class="_ _9"></span>we <span class="_ _9"></span>transmit <span class="_ _3"></span>a <span class="_ _9"></span>message.<span class="_ _5a"> </span>In <span class="_ _3"></span>addition, <span class="_ _9"></span>we <span class="_ _9"></span>will <span class="_ _3"></span>receive</div><div class="t m0 x32 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">datagrams only from the addr<span class="_ _0"></span>ess we’ve speciﬁed.</div><div class="t m0 x3f h2a y13a ff19 fsf fc0 sc0 ls19c ws0">As<span class="_ _4a"></span><span class="ls0">erver <span class="_"> </span>announces <span class="_"> </span>that <span class="_"> </span>it <span class="_"> </span>is <span class="_"> </span>willing <span class="_"> </span>to <span class="_"> </span>accept <span class="_"> </span>connect <span class="_ _66"> </span>requests <span class="_"> </span>by <span class="_"> </span>calling <span class="_"> </span>the</span></div><div class="t m0 x32 h26 y254 ff1a fsf fc0 sc0 ls0 ws0">listen<span class="_ _80"> </span><span class="ff19">function.</span></div><div class="t m0 x3f h57 y48ce ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x3f h57 y48cf ff1a fs2d fc0 sc0 ls0 ws0">int listen(int<span class="_"> </span><span class="ff1b">sockfd</span><span class="ls15c">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">backlog</span>);</span></span></div><div class="t m0 x153 h5f y48d0 ff19 fs2d fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h4a y48d1 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _65"> </span><span class="ff1b">backlog<span class="_ _48"> </span></span>argument <span class="_ _44"> </span>provides <span class="_ _4b"> </span>a <span class="_ _4b"> </span>hint <span class="_ _4b"> </span>to <span class="_ _59"> </span>the <span class="_ _4b"> </span>system <span class="_ _4b"> </span>regar<span class="_ _0"></span>ding <span class="_ _4b"> </span>the <span class="_ _4b"> </span>number <span class="_ _4b"> </span>of</div><div class="t m0 x32 h49 y48d2 ff19 fs26 fc0 sc0 ls0 ws0">outstanding <span class="_"> </span>connect <span class="_ _e"> </span>requests <span class="_ _e"> </span>that <span class="_"> </span>it <span class="_"> </span>should <span class="_ _e"> </span>enqueue <span class="_"> </span>on <span class="_ _e"> </span>behalf <span class="_"> </span>of <span class="_"> </span>the <span class="_ _e"> </span>process. <span class="_ _4b"> </span>The</div><div class="t m0 x32 h4d y48d3 ff19 fs26 fc0 sc0 ls0 ws0">actual value is determined <span class="_ _2"></span>by the system, <span class="_ _2"></span>but the upper <span class="_ _2"></span>limit is speciﬁed as<span class="_ _66"> </span><span class="ff1a">SOMAXCONN</span></div><div class="t m0 x32 h4d y48d4 ff19 fs26 fc0 sc0 ls0 ws0">in<span class="_"> </span><span class="ff1a">&lt;sys/socket.h&gt;</span>.</div><div class="t m0 x76 h5e y48d5 ff19 fs10 fc0 sc0 ls0 ws0">On <span class="_ _3"></span>Solaris, <span class="_ _9"></span>the<span class="_ _66"> </span><span class="ff1a">SOMAXCONN<span class="_ _66"> </span></span>value <span class="_ _3"></span>in<span class="_ _66"> </span><span class="ff1a">&lt;sys/socket.h&gt;<span class="_ _66"> </span></span>is <span class="_ _9"></span>ignored. <span class="_ _80"> </span>The<span class="_ _66"> </span>particular <span class="_ _9"></span>maximum</div><div class="t m0 x76 h2d y48d6 ff19 fs10 fc0 sc0 ls0 ws0">depends on the implementation of each protocol. <span class="_"> </span>For<span class="_"> </span>TCP<span class="_ _4"></span><span class="ls136">,t<span class="_ _84"></span><span class="ls0">he default is 128.</span></span></div><div class="t m0 x3f h49 y48d7 ff19 fs26 fc0 sc0 ls0 ws0">Once <span class="_ _42"> </span>the <span class="_ _53"> </span>queue <span class="_ _53"> </span>is <span class="_ _53"> </span>full, <span class="_ _53"> </span>the <span class="_ _53"> </span>system <span class="_ _53"> </span>will <span class="_ _53"> </span>reject <span class="_ _42"> </span>additional <span class="_ _53"> </span>connect <span class="_ _53"> </span>requests, <span class="_ _42"> </span>so <span class="_ _53"> </span>the</div><div class="t m0 x32 h4a y48d8 ff1b fs26 fc0 sc0 ls0 ws0">backlog<span class="_ _47"> </span><span class="ff19">value <span class="_ _9"></span>must <span class="_ _3"></span>be <span class="_ _9"></span>chosen <span class="_ _3"></span>based <span class="_ _9"></span>on <span class="_ _3"></span>the <span class="_ _9"></span>expected <span class="_ _3"></span>load <span class="_ _9"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>server <span class="_ _3"></span>and <span class="_ _9"></span>the <span class="_ _3"></span>amount</span></div><div class="t m0 x32 h49 y48d9 ff19 fs26 fc0 sc0 ls0 ws0">of processing it must do to accept a connect r<span class="_ _0"></span>equest and start the service.</div><div class="t m0 x3f h4d y48da ff19 fs26 fc0 sc0 ls0 ws0">Once <span class="_ _2"></span>a <span class="_ _3"></span>server <span class="_ _3"></span>has <span class="_ _2"></span>called<span class="_ _47"> </span><span class="ff1a">listen</span><span class="ls134b">,t<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>socket <span class="_ _3"></span>used <span class="_ _3"></span>can <span class="_ _2"></span>receive <span class="_ _2"></span>connect <span class="_ _3"></span>requests. <span class="_ _66"> </span>W<span class="_ _6"></span>e</span></span></div><div class="t m0 x32 h4d y48db ff19 fs26 fc0 sc0 ls0 ws0">use the<span class="_"> </span><span class="ff1a">accept<span class="_ _80"> </span></span>function to retrieve a connect request and convert it into a connection.</div><div class="t m0 x3f h4e y48dc ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x3f h4e y48dd ff1a fs28 fc0 sc0 ls0 ws0">int accept(int<span class="_"> </span><span class="ff1b">sockfd</span><span class="ls1b6">,s<span class="_ _1d"></span><span class="ls0">truct sockaddr *restrict<span class="_"> </span><span class="ff1b">addr</span>,</span></span></div><div class="t m0 x10c h4e y48de ff1a fs28 fc0 sc0 ls0 ws0">socklen_t *restrict<span class="_"> </span><span class="ff1b">len</span>);</div><div class="t m0 xdd h7c y48df ff19 fs28 fc0 sc0 ls0 ws0">Returns: ﬁle (socket) descriptor if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h54 y48e0 ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _23"></span>ﬁle <span class="_ _23"></span>descriptor <span class="_ _23"></span>returned <span class="_ _9"></span>by<span class="_ _35"> </span><span class="ff1a">accept<span class="_ _35"> </span></span>is <span class="_ _23"></span>a <span class="_ _23"></span>socket <span class="_ _23"></span>descriptor <span class="_ _23"></span>that <span class="_ _23"></span>is <span class="_ _23"></span>connected <span class="_ _23"></span>to <span class="_ _23"></span>the</div><div class="t m0 x32 h54 y48e1 ff19 fs2c fc0 sc0 ls0 ws0">client <span class="_ _23"></span>that <span class="_ _23"></span>called<span class="_ _35"> </span><span class="ff1a">connect</span><span class="ls134c">.T<span class="_ _7"></span><span class="ls0">his <span class="_ _23"> </span>new <span class="_ _23"> </span>socket <span class="_ _23"> </span>descriptor <span class="_ _23"> </span>has <span class="_ _42"> </span>the <span class="_ _23"></span>same <span class="_ _23"></span>socket <span class="_ _23"></span>type <span class="_ _23"></span>and</span></span></div><div class="t m0 x32 h54 y48e2 ff19 fs2c fc0 sc0 ls0 ws0">address <span class="_ _3"></span>family <span class="_ _23"></span>as <span class="_ _9"></span>the <span class="_ _9"></span>original <span class="_ _9"></span>socket <span class="_ _9"></span>(<span class="ff1b">sockfd</span>). <span class="_ _45"> </span>The<span class="_ _45"> </span>original <span class="_ _23"></span>socket <span class="_ _9"></span>passed <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">accept<span class="_ _45"> </span></span>is</div><div class="t m0 x32 h55 y48e3 ff19 fs2c fc0 sc0 ls0 ws0">not <span class="_ _9"></span>associated <span class="_ _9"></span>with <span class="_ _23"></span>the <span class="_ _9"></span>connection, <span class="_ _9"></span>but <span class="_ _9"></span>instead <span class="_ _23"></span>remains <span class="_ _3"></span>available <span class="_ _9"></span>to <span class="_ _23"></span>receive <span class="_ _3"></span>additional</div><div class="t m0 x32 h55 y48e4 ff19 fs2c fc0 sc0 ls0 ws0">connect requests.</div><div class="t m0 x3f h60 y48e5 ff19 fs2c fc0 sc0 ls0 ws0">If we <span class="_ _2"></span>don’t <span class="_ _2"></span>car<span class="ls134d">ea<span class="_ _4f"></span><span class="ls0">bout <span class="_ _2"></span>the <span class="_ _2"></span>client’s <span class="_ _2"></span>identity<span class="_ _4"></span>,<span class="_ _47"> </span>we<span class="_"> </span>can <span class="_ _2"></span>set <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1b">addr<span class="_"> </span></span>and<span class="_ _47"> </span><span class="ff1b">len<span class="_"> </span></span>parameters <span class="_ _2"></span>to</span></span></div><div class="t m0 x32 h54 y48e6 ff1a fs2c fc0 sc0 ls0 ws0">NULL<span class="ff19 ls134e">.O<span class="_ _1d"></span><span class="ls0">therwise, <span class="_ _3"></span>befor<span class="ls134f">ec<span class="_ _b"></span><span class="ls0">alling<span class="_ _47"> </span><span class="ff1a">accept</span>,<span class="_ _45"> </span>we<span class="_ _47"> </span>need <span class="_ _3"></span>to <span class="_ _3"></span>set <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1b">addr<span class="_ _47"> </span></span>parameter <span class="_ _9"></span>to <span class="_ _3"></span>a <span class="_ _3"></span>buffer</span></span></span></span></div><div class="t m0 x32 h60 y48e7 ff19 fs2c fc0 sc0 ls0 ws0">large <span class="_ _2"></span>enough <span class="_ _3"></span>to <span class="_ _3"></span>hold <span class="_ _3"></span>the <span class="_ _3"></span>address <span class="_ _2"></span>and <span class="_ _3"></span>set <span class="_ _3"></span>the <span class="_ _3"></span>integer <span class="_ _3"></span>pointed <span class="_ _3"></span>to <span class="_ _3"></span>by<span class="_ _45"> </span><span class="ff1b">len<span class="_ _66"> </span></span>to <span class="_ _3"></span>the <span class="_ _3"></span>size <span class="_ _3"></span>of <span class="_ _3"></span>the</div><div class="t m0 x32 h54 y48e8 ff19 fs2c fc0 sc0 ls0 ws0">buffer <span class="_ _42"> </span>in <span class="_ _42"> </span>bytes.<span class="_ _54"> </span>On <span class="_ _53"> </span>return,<span class="_ _44"> </span><span class="ff1a">accept<span class="_ _44"> </span></span>will <span class="_ _42"> </span>ﬁll <span class="_ _53"> </span>in <span class="_ _53"> </span>the <span class="_ _42"> </span>client’s <span class="_ _53"> </span>address <span class="_ _42"> </span>in <span class="_ _42"> </span>the <span class="_ _53"> </span>buffer <span class="_ _42"> </span>and</div><div class="t m0 x32 h60 y48e9 ff19 fs2c fc0 sc0 ls0 ws0">update the integer pointed to by<span class="_"> </span><span class="ff1b">len<span class="_"> </span></span>to reﬂect the size of the addr<span class="_ _0"></span>ess.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
