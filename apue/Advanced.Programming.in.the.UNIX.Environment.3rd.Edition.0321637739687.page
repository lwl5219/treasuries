<div id="pf2af" class="pf w4 h1f" data-page-no="2af"><div class="pc pc2af w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg2af.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.5<span class="_ _67"> </span>An <span class="_"> </span>Open <span class="_"> </span>Server<span class="_ _6"></span><span class="ls30a">,V<span class="_ _1d"></span><span class="ls0">ersion <span class="_"> </span>1<span class="_ _1b"> </span><span class="ff18">653</span></span></span></div><div class="t m0 x35 h53 y12f ff16 fs2b fc0 sc0 ls0 ws0">17.5 <span class="_ _93"> </span>An<span class="_ _54"> </span>Open <span class="_"> </span>Server<span class="_ _1"></span><span class="ls1c3">,V<span class="_ _64"></span><span class="ls0">er<span class="_ _0"></span>sion <span class="_"> </span>1</span></span></div><div class="t m0 x32 h2a yffe ff19 fsf fc0 sc0 ls0 ws0">Using <span class="_"> </span>ﬁle <span class="_"> </span>descriptor <span class="_"> </span>passing, <span class="_"> </span>we <span class="_"> </span>now <span class="_"> </span>develop <span class="_"> </span>an <span class="_"> </span>open <span class="_"> </span>server<span class="_ _9"></span><span class="ls9d">—a <span class="_ _9"></span>p<span class="_ _6"></span><span class="ls45">ro<span class="_ _2"></span><span class="ls0">gram <span class="_"> </span>that <span class="_"> </span>is</span></span></span></div><div class="t m0 x32 h2a yfff ff19 fsf fc0 sc0 ls0 ws0">executed <span class="_ _3"></span>by <span class="_ _3"></span>a <span class="_ _3"></span>process <span class="_ _3"></span>to <span class="_ _3"></span>open <span class="_ _3"></span>one <span class="_ _3"></span>or <span class="_ _3"></span>mor<span class="lsbf6">eﬁ<span class="_ _8"></span><span class="ls0">les. <span class="_ _47"> </span>Instead<span class="_ _45"> </span>of <span class="_ _2"></span>sending <span class="_ _3"></span>the <span class="_ _9"></span>contents <span class="_ _3"></span>of <span class="_ _3"></span>the</span></span></div><div class="t m0 x32 h2a y43d3 ff19 fsf fc0 sc0 ls0 ws0">ﬁle <span class="_ _3"></span>back <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>calling <span class="_ _3"></span>process, <span class="_ _3"></span>however<span class="_ _1"></span><span class="ls43">,t<span class="_ _8"></span><span class="ls0">his <span class="_ _3"></span>server <span class="_ _9"></span>sends <span class="_ _3"></span>back <span class="_ _9"></span>an <span class="_ _3"></span>open <span class="_ _9"></span>ﬁle <span class="_ _3"></span>descriptor<span class="_ _1"></span>.</span></span></div><div class="t m0 x32 h2a y4d08 ff19 fsf fc0 sc0 ls0 ws0">As <span class="_ _2"></span>a <span class="_ _2"></span>result, the <span class="_ _2"></span>open <span class="_ _2"></span>server <span class="_ _2"></span>can <span class="_ _2"></span>work <span class="_ _2"></span>with <span class="_ _2"></span>any <span class="_ _2"></span>type <span class="_ _2"></span>of <span class="_ _2"></span>ﬁle <span class="_ _2"></span>(such <span class="_ _2"></span>as <span class="_ _2"></span>a <span class="_ _2"></span>device <span class="_ _2"></span>or <span class="_ _2"></span>a <span class="_ _2"></span>socket)</div><div class="t m0 x32 h2a y4d09 ff19 fsf fc0 sc0 ls0 ws0">and <span class="_ _42"> </span>not <span class="_ _53"> </span>simply <span class="_ _42"> </span>regular <span class="_ _42"> </span>ﬁles.<span class="_ _54"> </span>The <span class="_ _53"> </span>client <span class="_ _42"> </span>and <span class="_ _53"> </span>server <span class="_ _42"> </span>exchange <span class="_ _53"> </span>a <span class="_ _42"> </span>minimum <span class="_ _53"> </span>amount <span class="_ _42"> </span>of</div><div class="t m0 x32 h2a y370c ff19 fsf fc0 sc0 ls0 ws0">information <span class="_ _45"> </span>using <span class="_ _45"> </span>IPC: <span class="_ _45"> </span>the <span class="_ _45"> </span>ﬁlename <span class="_ _45"> </span>and <span class="_ _45"> </span>open <span class="_ _45"> </span>mode <span class="_ _45"> </span>sent <span class="_ _45"> </span>by <span class="_ _45"> </span>the <span class="_ _45"> </span>client, <span class="_ _45"> </span>and <span class="_ _35"> </span>the</div><div class="t m0 x32 h2a y370d ff19 fsf fc0 sc0 ls0 ws0">descriptor returned by the server<span class="_ _6"></span><span class="ls86">.T<span class="_ _4a"></span><span class="ls0">he contents of the ﬁle ar<span class="ls44">en<span class="_ _4f"></span><span class="ls0">ot exchanged using IPC.</span></span></span></span></div><div class="t m0 x3f h2a y370e ff19 fsf fc0 sc0 ls0 ws0">Ther<span class="lsbcb">ea<span class="_ _c"></span><span class="ls45">re <span class="_ _53"> </span>s<span class="_ _2"></span><span class="ls0">everal <span class="_ _53"> </span>advantages <span class="_ _42"> </span>in <span class="_ _42"> </span>designing <span class="_ _53"> </span>the <span class="_ _42"> </span>server <span class="_ _53"> </span>to <span class="_ _42"> </span>be <span class="_ _53"> </span>a <span class="_ _42"> </span>separate <span class="_ _53"> </span>executable</span></span></span></div><div class="t m0 x32 h2a y4d0a ff19 fsf fc0 sc0 ls0 ws0">program <span class="_ _9"></span>(either <span class="_ _42"> </span>one <span class="_ _23"></span>that <span class="_ _23"> </span>is <span class="_ _23"> </span>executed <span class="_ _23"> </span>by <span class="_ _42"> </span>the <span class="_ _23"></span>client, <span class="_ _23"></span>as <span class="_ _23"> </span>we <span class="_ _23"> </span>develop <span class="_ _23"> </span>in <span class="_ _42"> </span>this <span class="_ _23"></span>section, <span class="_ _23"> </span>or <span class="_ _23"> </span>a</div><div class="t m0 x32 h2a y4d0b ff19 fsf fc0 sc0 ls0 ws0">daemon server<span class="_ _6"></span><span class="ls44">,w<span class="_ _5"></span><span class="ls0">hich we develop in the next section).</span></span></div><div class="t m0 x3f h2a y4d0c ff19 fsf fc0 sc0 ls49 ws0">•T<span class="_ _4d"></span><span class="ls0">he <span class="_ _23"> </span>server <span class="_ _23"> </span>can <span class="_ _42"> </span>easily <span class="_ _23"> </span>be <span class="_ _23"> </span>contacted <span class="_ _42"> </span>by <span class="_ _23"> </span>any <span class="_ _23"> </span>client, <span class="_ _42"> </span>similar <span class="_ _23"> </span>to <span class="_ _23"> </span>the <span class="_ _42"> </span>client <span class="_ _23"> </span>calling <span class="_ _23"> </span>a</span></div><div class="t m0 x15 h2a y4d0d ff19 fsf fc0 sc0 ls0 ws0">library <span class="_ _61"> </span>function.<span class="_ _d9"> </span><span class="ls5f">We <span class="_ _65"> </span>a<span class="_ _9"></span><span class="ls45">re <span class="_ _5a"> </span>n</span></span>ot <span class="_ _61"> </span>hard-coding <span class="_ _61"> </span>a <span class="_ _61"> </span>particular <span class="_ _61"> </span>service <span class="_ _61"> </span>into <span class="_ _61"> </span>the</div><div class="t m0 x15 h2a y4d0e ff19 fsf fc0 sc0 ls0 ws0">application, but designing a general facility that others can reuse.</div><div class="t m0 x3f h2a y4d0f ff19 fsf fc0 sc0 ls49 ws0">•I<span class="_ _4d"></span><span class="ls0">f<span class="_ _45"> </span>we<span class="_ _45"> </span>need <span class="_ _9"></span>to <span class="_ _9"></span>change <span class="_ _23"></span>the <span class="_ _9"></span>server<span class="_ _6"></span><span class="ls13e8">,o<span class="_ _b"></span><span class="ls0">nly <span class="_ _9"></span>a <span class="_ _23"></span>single <span class="_ _9"></span>program <span class="_ _3"></span>is <span class="_ _23"></span>af<span class="_ _0"></span>fected. <span class="_ _45"> </span>Conversely<span class="_ _4"></span>,</span></span></span></div><div class="t m0 x15 h2a y4d10 ff19 fsf fc0 sc0 ls0 ws0">updating a library function can requir<span class="_ _0"></span><span class="ls273">et<span class="_ _d"></span><span class="ls0">hat all programs that call the function be</span></span></div><div class="t m0 x15 h2a y4d11 ff19 fsf fc0 sc0 ls0 ws0">updated <span class="_ _23"> </span>(i.e., <span class="_ _42"> </span>relinked <span class="_ _23"> </span>with <span class="_ _42"> </span>the <span class="_ _42"> </span>link <span class="_ _23"> </span>editor).<span class="_ _54"> </span>Shared <span class="_ _23"> </span>libraries <span class="_ _42"> </span>can <span class="_ _23"> </span>simplify <span class="_ _42"> </span>this</div><div class="t m0 x15 h2a y4d12 ff19 fsf fc0 sc0 ls0 ws0">updating (Section 7.7).</div><div class="t m0 x3f h2a y4d13 ff19 fsf fc0 sc0 ls49 ws0">•T<span class="_ _4d"></span><span class="ls0">he <span class="_ _46"> </span>server <span class="_ _46"> </span>can <span class="_ _46"> </span>be <span class="_ _61"> </span>a <span class="_ _46"> </span>set-user-ID <span class="_ _46"> </span>program, <span class="_ _59"> </span>providing <span class="_ _46"> </span>it <span class="_ _46"> </span>with <span class="_ _61"> </span>additional</span></div><div class="t m0 x15 h2a y4d14 ff19 fsf fc0 sc0 ls0 ws0">permissions that the client <span class="_ _2"></span>does not have.<span class="_ _46"> </span>Note that <span class="_ _2"></span>a library function <span class="_ _2"></span>(or shared</div><div class="t m0 x15 h2a y4d15 ff19 fsf fc0 sc0 ls0 ws0">library function) can’t provide this capability<span class="_ _4"></span>.</div><div class="t m0 x3f h26 y4d16 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _23"></span>client <span class="_ _9"></span>process <span class="_ _23"></span>creates <span class="_ _9"></span>an <span class="_ _23"></span>fd-pipe <span class="_ _23"></span>and <span class="_ _9"></span>then <span class="_ _23"> </span>calls<span class="_ _35"> </span><span class="ff1a">fork<span class="_ _45"> </span></span>and<span class="_ _35"> </span><span class="ff1a">exec<span class="_ _35"> </span></span>to <span class="_ _9"></span>invoke <span class="_ _23"></span>the</div><div class="t m0 x32 h2a y4d17 ff19 fsf fc0 sc0 ls0 ws0">server<span class="_ _6"></span><span class="ls5c7">.T<span class="_ _5b"></span><span class="ls0">he <span class="_ _2"></span>client <span class="_ _2"></span>sends <span class="_ _2"></span>requests <span class="_ _2"></span>across the <span class="_ _2"></span>fd-pipe <span class="_ _2"></span>using <span class="_ _2"></span>one <span class="_ _2"></span>end, <span class="_ _2"></span>and <span class="_ _2"></span>the <span class="_ _2"></span>server <span class="_ _2"></span>sends</span></span></div><div class="t m0 x32 h2a y4d18 ff19 fsf fc0 sc0 ls0 ws0">back responses over the fd-pipe using the other end.</div><div class="t m0 x3f h2a y4d19 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>d<span class="_ _9"></span><span class="ls0">eﬁne the following application protocol between the client and the server<span class="_ _6"></span>.</span></div><div class="t m0 x3f h26 y4d1a ff19 fsf fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>The<span class="_ _51"> </span>client <span class="_ _45"> </span>sends <span class="_ _35"> </span>a <span class="_ _45"> </span>request <span class="_ _45"> </span>of <span class="_ _35"> </span>the <span class="_ _45"> </span>form <span class="_ _35"> </span>‘<span class="_ _1"></span>‘<span class="ff1a">open<span class="_ _46"> </span><span class="ff1b">&lt;pathname&gt; <span class="_"> </span>&lt;openmode&gt;</span></span>\0’<span class="_ _0"></span>’</div><div class="t m0 x41 h2b y4d1b ff19 fsf fc0 sc0 ls0 ws0">across <span class="_ _2"></span>the <span class="_ _3"></span>fd-pipe <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>server<span class="_ _1"></span><span class="ls1123">.T<span class="_ _1d"></span><span class="ls0">he<span class="_ _47"> </span><span class="ff1b">&lt;openmode&gt;<span class="_ _47"> </span></span>is <span class="_ _3"></span>the <span class="_ _3"></span>numeric <span class="_ _2"></span>value, <span class="_ _3"></span>in <span class="_ _3"></span>ASCII</span></span></div><div class="t m0 x41 h26 y4d1c ff19 fsf fc0 sc0 ls0 ws0">decimal, <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>second <span class="_ _42"> </span>argument <span class="_ _23"> </span>to <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">open<span class="_ _44"> </span></span>function. <span class="_ _35"> </span>This<span class="_ _44"> </span><span class="ls45">re</span>quest <span class="_ _42"> </span>string <span class="_ _42"> </span>is</div><div class="t m0 x41 h2a y4d1d ff19 fsf fc0 sc0 ls0 ws0">terminated by a null byte.</div><div class="t m0 x3f h26 y4d1e ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>The<span class="_ _47"> </span>server <span class="_ _2"></span>sends <span class="_ _2"></span>back <span class="_ _3"></span>an <span class="_ _2"></span>open <span class="_ _3"></span>descriptor <span class="_ _2"></span>or <span class="_ _2"></span>an <span class="_ _3"></span>error <span class="_ _2"></span>by <span class="_ _2"></span>calling <span class="_ _3"></span>either<span class="_ _47"> </span><span class="ff1a">send_fd</span></div><div class="t m0 x41 h26 y4d1f ff19 fsf fc0 sc0 ls0 ws0">or<span class="_"> </span><span class="ff1a">send_err</span>.</div><div class="t m0 x32 h2a y4d20 ff19 fsf fc0 sc0 ls0 ws0">This is an <span class="_ _2"></span>example of a <span class="_ _2"></span>process sending an open <span class="_ _2"></span>descriptor to its <span class="_ _2"></span>parent. <span class="_"> </span>In<span class="_"> </span>Section 17.6,</div><div class="t m0 x32 h2a y4d21 ff19 fsf fc0 sc0 ls0 ws0">we’ll <span class="_ _53"> </span>modify <span class="_ _e"> </span>this <span class="_ _e"> </span>example <span class="_ _e"> </span>to <span class="_ _e"> </span>use <span class="_ _e"> </span>a <span class="_ _e"> </span>single <span class="_ _53"> </span>daemon <span class="_ _e"> </span>server<span class="_ _1"></span><span class="ls13e9">,w<span class="_ _55"></span><span class="ls0">her<span class="ls13e9">et<span class="_ _55"></span><span class="ls0">he <span class="_ _e"> </span>server <span class="_ _e"> </span>sends <span class="_ _e"> </span>a</span></span></span></span></div><div class="t m0 x32 h2a y4d22 ff19 fsf fc0 sc0 ls0 ws0">descriptor to a completely unrelated pr<span class="_ _0"></span>ocess.</div><div class="t m0 x3f h26 y4d23 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _59"> </span>ﬁ<span class="_ _9"></span><span class="ls0">rst <span class="_ _47"> </span>have <span class="_ _66"> </span>the <span class="_ _47"> </span>header<span class="_ _6"></span>,<span class="_ _16"> </span><span class="ff1a">open.h<span class="_ _61"> </span></span>(Figur<span class="ls8dc">e1<span class="_ _1d"></span><span class="ls0">7.17), <span class="_ _47"> </span>which <span class="_ _47"> </span>includes <span class="_ _66"> </span>the <span class="_ _47"> </span>standard</span></span></span></div><div class="t m0 x32 h2a y4d24 ff19 fsf fc0 sc0 ls0 ws0">headers and deﬁnes the function prototypes.</div><div class="t m0 x32 h4e y4d25 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y4d26 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h4e y4d27 ff1a fs28 fc0 sc0 ls0 ws0">#define CL_OPEN &quot;open&quot;<span class="_ _74"> </span>/* client’s request for server */</div><div class="t m0 x32 h4e y4d28 ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>csopen(char<span class="_"> </span>*, int);</div><div class="t m0 x5a h4f y4d29 ff18 fs11 fc0 sc0 ls0 ws0">Figure 17.17<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">open.h<span class="_ _e"> </span></span>header</span></div><a class="l" href="#pf12" data-dest-detail='[18,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1236.288916px;width:199.356804px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
