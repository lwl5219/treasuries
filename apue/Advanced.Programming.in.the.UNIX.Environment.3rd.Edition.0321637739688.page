<div id="pf2b0" class="pf w4 h1f" data-page-no="2b0"><div class="pc pc2b0 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2b0.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">654<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>IPC<span class="_ _e8"> </span>Chapter <span class="_"> </span>17</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _44"> </span><span class="ff1a">main<span class="_ _35"> </span></span>function <span class="_ _42"> </span>(Figur<span class="ls13ea">e1<span class="_ _43"></span><span class="ls0">7.18) <span class="_ _23"> </span>is <span class="_ _53"> </span>a <span class="_ _42"> </span>loop <span class="_ _42"> </span>that <span class="_ _42"> </span>reads <span class="_ _42"> </span>a <span class="_ _42"> </span>pathname <span class="_ _42"> </span>from <span class="_ _23"> </span>standard</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">input <span class="_ _9"></span>and <span class="_ _9"></span>copies <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>to <span class="_ _9"></span>standar<span class="ls13eb">do<span class="_ _b"></span><span class="ls0">utput. <span class="_ _45"> </span>The<span class="_ _45"> </span>function <span class="_ _3"></span>calls<span class="_ _45"> </span><span class="ff1a">csopen<span class="_ _45"> </span></span>to <span class="_ _9"></span>contact <span class="_ _9"></span>the</span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">open server and return an open descriptor<span class="_ _6"></span>.</div><div class="t m0 x32 h4e y245e ff1a fs28 fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&quot;open.h&quot;</div><div class="t m0 x32 h4e y245f ff1a fs28 fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;fcntl.h&gt;</div><div class="t m0 x32 h4e y4d2a ff1a fs28 fc0 sc0 ls0 ws0">#define BUFFSIZE<span class="_ _15"> </span>8192</div><div class="t m0 x32 h4e y4d2b ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y4d2c ff1a fs28 fc0 sc0 ls0 ws0">main(int argc, char *argv[])</div><div class="t m0 x32 h4e y4d2d ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y4d2e ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>n,<span class="_"> </span>fd;</div><div class="t m0 x8a h4e y4d2f ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>buf[BUFFSIZE];</div><div class="t m0 x8a h4e y4d30 ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>line[MAXLINE];</div><div class="t m0 x8a h4e y4d31 ff1a fs28 fc0 sc0 ls0 ws0">/* read filename to cat from stdin */</div><div class="t m0 x8a h4e y4d32 ff1a fs28 fc0 sc0 ls0 ws0">while (fgets(line, MAXLINE, stdin) != NULL) {</div><div class="t m0 x9d h4e y4d33 ff1a fs28 fc0 sc0 ls0 ws0">if (line[strlen(line) - 1] == ’\n’)</div><div class="t m0 x1f h4e y4d34 ff1a fs28 fc0 sc0 ls0 ws0">line[strlen(line) - 1] = 0; /* replace newline with null */</div><div class="t m0 x9d h4e y4d35 ff1a fs28 fc0 sc0 ls0 ws0">/* open the file */</div><div class="t m0 x9d h4e y4d36 ff1a fs28 fc0 sc0 ls0 ws0">if ((fd = csopen(line, O_RDONLY)) &lt; 0)</div><div class="t m0 x1f h4e y4d37 ff1a fs28 fc0 sc0 ls0 ws0">continue; <span class="_ _d9"> </span>/*<span class="_"> </span>csopen() prints error from server */</div><div class="t m0 x9d h4e y246f ff1a fs28 fc0 sc0 ls0 ws0">/* and cat to stdout */</div><div class="t m0 x9d h4e y2470 ff1a fs28 fc0 sc0 ls0 ws0">while ((n = read(fd, buf, BUFFSIZE)) &gt; 0)</div><div class="t m0 x1f h4e y2471 ff1a fs28 fc0 sc0 ls0 ws0">if (write(STDOUT_FILENO, buf, n) != n)</div><div class="t m0 x1ca h4e y2472 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><div class="t m0 x9d h4e y2473 ff1a fs28 fc0 sc0 ls0 ws0">if (n &lt; 0)</div><div class="t m0 x1f h4e y4d38 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;read error&quot;);</div><div class="t m0 x9d h4e y4d39 ff1a fs28 fc0 sc0 ls0 ws0">close(fd);</div><div class="t m0 x8a h4e y4d3a ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h4e y4d3b ff1a fs28 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h4e y4d3c ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x36 h4f y4d3d ff18 fs11 fc0 sc0 ls0 ws0">Figure 17.18<span class="_ _5a"> </span><span class="ff19">The client<span class="_"> </span><span class="ff1a">main<span class="_ _e"> </span></span>function, version 1</span></div><div class="t m0 x3f h54 y4d3e ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _42"> </span>function<span class="_ _44"> </span><span class="ff1a">csopen<span class="_ _35"> </span></span>(Figur<span class="ls13ec">e1<span class="_ _43"></span><span class="ls0">7.19) <span class="_ _23"> </span>does <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1a">fork<span class="_ _35"> </span></span>and<span class="_ _44"> </span><span class="ff1a">exec<span class="_ _44"> </span></span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>server<span class="_ _6"></span><span class="ls13ed">,a<span class="_ _43"></span><span class="ls0">fter</span></span></span></span></div><div class="t m0 x32 h55 y4d3f ff19 fs2c fc0 sc0 ls0 ws0">creating the fd-pipe.</div><div class="t m0 x32 h62 y4d40 ff1a fs30 fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&quot;open.h&quot;</div><div class="t m0 x32 h62 y4d41 ff1a fs30 fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;sys/uio.h&gt;<span class="_ _8a"> </span>/* struct iovec */</div><div class="t m0 x32 h62 y4d42 ff1a fs30 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h62 y4d43 ff1a fs30 fc0 sc0 ls1185 ws0">*O<span class="_ _1d"></span><span class="ls0">pen the file by sending the &quot;name&quot; and &quot;oflag&quot; to the</span></div><div class="t m0 x140 h62 y4d44 ff1a fs30 fc0 sc0 ls1185 ws0">*c<span class="_ _1d"></span><span class="ls0">onnection server and reading a file descriptor back.</span></div><div class="t m0 x140 h62 y4d45 ff1a fs30 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h62 y4d46 ff1a fs30 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h62 y4d47 ff1a fs30 fc0 sc0 ls0 ws0">csopen(char *name, int oflag)</div><div class="t m0 x32 h62 y4d48 ff1a fs30 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h62 y4d49 ff1a fs30 fc0 sc0 ls0 ws0">pid_t <span class="_ _74"> </span>pid;</div><div class="t m0 x8a h62 y4d4a ff1a fs30 fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>len;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
