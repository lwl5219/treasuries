<div id="pf32e" class="pf w4 h1f" data-page-no="32e"><div class="pc pc32e w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg32e.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">780<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">751 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">752 <span class="_ _8a"> </span>*<span class="_"> </span>We read lock the free list so that we don’t read</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">753 <span class="_ _8a"> </span>*<span class="_"> </span><span class="ls15c">ar<span class="_ _1d"></span><span class="ls0">ecord in the middle of its being deleted.</span></span></div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">754 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">755 <span class="_ _15"> </span>if<span class="_"> </span>(readw_lock(db-&gt;idxfd, FREE_OFF, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">756 <span class="_ _186"> </span>err_dump(&quot;db_nextrec:<span class="_"> </span>readw_lock error&quot;);</div><div class="t m0 x32 h57 y583e ff1a fs2d fc0 sc0 ls0 ws0">757 <span class="_ _15"> </span>do<span class="_"> </span>{</div><div class="t m0 x32 h57 y583f ff1a fs2d fc0 sc0 ls0 ws0">758 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y5710 ff1a fs2d fc0 sc0 ls0 ws0">759 <span class="_ _176"> </span>*<span class="_"> </span>Read next sequential index record.</div><div class="t m0 x32 h57 y5711 ff1a fs2d fc0 sc0 ls0 ws0">760 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y5840 ff1a fs2d fc0 sc0 ls0 ws0">761 <span class="_ _186"> </span>if<span class="_"> </span>(_db_readidx(db, 0) &lt; 0) {</div><div class="t m0 x32 h57 y5841 ff1a fs2d fc0 sc0 ls0 ws0">762 <span class="_ _82"> </span>ptr<span class="_"> </span><span class="ls15c">=N<span class="_ _1d"></span><span class="ls0">ULL; <span class="_ _15"> </span>/*<span class="_"> </span>end of index file, EOF */</span></span></div><div class="t m0 x32 h57 y5842 ff1a fs2d fc0 sc0 ls0 ws0">763 <span class="_ _82"> </span>goto<span class="_"> </span>doreturn;</div><div class="t m0 x32 h57 y5843 ff1a fs2d fc0 sc0 ls0 ws0">764 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y5715 ff1a fs2d fc0 sc0 ls0 ws0">765 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y5716 ff1a fs2d fc0 sc0 ls0 ws0">766 <span class="_ _176"> </span>*<span class="_"> </span>Check if key is all blank (empty record).</div><div class="t m0 x32 h57 y5717 ff1a fs2d fc0 sc0 ls0 ws0">767 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y5844 ff1a fs2d fc0 sc0 ls0 ws0">768 <span class="_ _186"> </span>ptr<span class="_"> </span><span class="ls15c">=d<span class="_ _1d"></span><span class="ls0">b-&gt;idxbuf;</span></span></div><div class="t m0 x32 h57 y5845 ff1a fs2d fc0 sc0 ls0 ws0">769 <span class="_ _186"> </span>while<span class="_"> </span>((c = *ptr++) != 0<span class="_ _d9"> </span>&amp;&amp; <span class="_"> </span>c<span class="_"> </span>== SPACE)</div><div class="t m0 x32 h57 y5846 ff1a fs2d fc0 sc0 ls0 ws0">770 <span class="_ _82"> </span>;<span class="_ _68"> </span>/* skip until null byte or nonblank */</div><div class="t m0 x32 h57 y5847 ff1a fs2d fc0 sc0 ls0 ws0">771 <span class="_ _15"> </span>}<span class="_"> </span>while (c == 0);<span class="_ _68"> </span>/* loop until a nonblank key is found */</div><div class="t m0 x32 h57 y2f30 ff1a fs2d fc0 sc0 ls0 ws0">772 <span class="_ _15"> </span>if<span class="_"> </span>(key != NULL)</div><div class="t m0 x32 h57 y56fd ff1a fs2d fc0 sc0 ls0 ws0">773 <span class="_ _186"> </span>strcpy(key,<span class="_"> </span>db-&gt;idxbuf); <span class="_ _68"> </span>/*<span class="_"> </span>return key */</div><div class="t m0 x32 h57 y5848 ff1a fs2d fc0 sc0 ls0 ws0">774 <span class="_ _15"> </span>ptr<span class="_"> </span><span class="ls15c">=_<span class="_ _1d"></span><span class="ls0">db_readdat(db); <span class="_"> </span>/*<span class="_"> </span>return pointer to data buffer */</span></span></div><div class="t m0 x32 h57 y5849 ff1a fs2d fc0 sc0 ls0 ws0">775 <span class="_ _15"> </span>db-&gt;cnt_nextrec++;</div><div class="t m0 x32 h57 y5700 ff1a fs2d fc0 sc0 ls0 ws0">776 <span class="_ _d9"> </span>doreturn:</div><div class="t m0 x32 h57 y5701 ff1a fs2d fc0 sc0 ls0 ws0">777 <span class="_ _15"> </span>if<span class="_"> </span>(un_lock(db-&gt;idxfd, FREE_OFF, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y584a ff1a fs2d fc0 sc0 ls0 ws0">778 <span class="_ _186"> </span>err_dump(&quot;db_nextrec:<span class="_"> </span>un_lock error&quot;);</div><div class="t m0 x32 h57 y584b ff1a fs2d fc0 sc0 ls0 ws0">779 <span class="_ _15"> </span>return(ptr);</div><div class="t m0 x32 h57 y584c ff1a fs2d fc0 sc0 ls0 ws0">780 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h49 y584d ff19 fs26 fc0 sc0 ls0 ws0">[751 <span class="_ _a"></span>– <span class="_ _a"></span>756]<span class="_ _65"> </span><span class="ls164">We <span class="_ _e"> </span>ﬁ<span class="_ _23"></span></span>rst <span class="_ _2"></span>need <span class="_ _3"></span>to <span class="_ _3"></span>read <span class="_ _2"></span>lock <span class="_ _2"></span>the <span class="_ _3"></span>free <span class="_ _2"></span>list <span class="_ _3"></span>so <span class="_ _3"></span>that <span class="_ _2"></span>no <span class="_ _3"></span>other <span class="_ _3"></span>processes <span class="_ _2"></span>can <span class="_ _3"></span>remove</div><div class="t m0 x11a h49 y584e ff19 fs26 fc0 sc0 lsd3 ws0">ar<span class="_ _4f"></span><span class="ls0">ecor<span class="lsd3">dw<span class="_ _d"></span><span class="ls0">hile we ar<span class="lsd3">er<span class="_ _4f"></span><span class="ls0">eading it.</span></span></span></span></span></div><div class="t m0 x32 h4d y584f ff19 fs26 fc0 sc0 ls0 ws0">[757 <span class="_ _a"></span>– <span class="_ _a"></span>771]<span class="_ _65"> </span><span class="ls164">We <span class="_ _66"> </span>c<span class="_ _9"></span></span>all<span class="_ _45"> </span><span class="ff1a">_db_readidx<span class="_ _45"> </span></span>to <span class="_ _9"></span>read <span class="_ _9"></span>the <span class="_ _9"></span>next <span class="_ _9"></span>recor<span class="_ _0"></span>d. <span class="_ _45"> </span>W<span class="_ _6"></span><span class="ls133f">ep<span class="_ _b"></span><span class="ls0">ass <span class="_ _9"></span>in <span class="_ _9"></span>an <span class="_ _9"></span>offset <span class="_ _3"></span>of <span class="_ _23"></span>0 <span class="_ _3"></span>to</span></span></div><div class="t m0 x11a h4d y5850 ff19 fs26 fc0 sc0 ls0 ws0">tell<span class="_ _47"> </span><span class="ff1a">_db_readidx<span class="_ _47"> </span></span>to <span class="_ _2"></span>continue <span class="_ _3"></span>reading <span class="_ _2"></span>from <span class="_ _2"></span>the <span class="_ _2"></span>current <span class="_ _2"></span>offset. <span class="_ _47"> </span>Since<span class="_ _47"> </span>we <span class="_ _2"></span>are</div><div class="t m0 x11a h49 y5851 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ading <span class="_ _e"> </span>the <span class="_ _53"> </span>index <span class="_ _53"> </span>ﬁle <span class="_ _53"> </span>sequentially<span class="_ _6"></span>,<span class="_ _4b"> </span>we<span class="_ _44"> </span>can <span class="_ _53"> </span>come <span class="_ _e"> </span>across <span class="_ _42"> </span>records <span class="_ _42"> </span>that <span class="_ _e"> </span>have</span></div><div class="t m0 x11a h49 y5852 ff19 fs26 fc0 sc0 ls0 ws0">been <span class="_ _9"></span>deleted.<span class="_ _5a"> </span><span class="ls164">We <span class="_ _47"> </span>w<span class="_ _9"></span></span>ant <span class="_ _9"></span>to <span class="_ _23"></span>return <span class="_ _3"></span>only <span class="_ _23"></span>valid <span class="_ _9"></span>records, <span class="_ _3"></span>so <span class="_ _23"></span>we <span class="_ _9"></span>skip <span class="_ _9"></span>any <span class="_ _23"></span>recor<span class="_ _1"></span>d</div><div class="t m0 x11a h4d y5853 ff19 fs26 fc0 sc0 ls0 ws0">whose <span class="_ _2"></span>key <span class="_ _3"></span>is <span class="_ _3"></span>all <span class="_ _3"></span>spaces <span class="_ _3"></span>(recall <span class="_ _2"></span>that<span class="_ _47"> </span><span class="ff1a">_db_dodelete<span class="_ _47"> </span></span>clears <span class="_ _3"></span>a <span class="_ _3"></span>key <span class="_ _3"></span>by <span class="_ _3"></span>setting <span class="_ _2"></span>it</div><div class="t m0 x11a h49 y5854 ff19 fs26 fc0 sc0 ls0 ws0">to all spaces).</div><div class="t m0 x32 h49 y5855 ff19 fs26 fc0 sc0 ls0 ws0">[772 <span class="_ _a"></span>– <span class="_ _a"></span>780]<span class="_ _65"> </span>When <span class="_"> </span>we <span class="_"> </span>ﬁnd <span class="_"> </span>a <span class="_"> </span>valid <span class="_"> </span>key<span class="_ _6"></span>,<span class="_ _46"> </span>we<span class="_ _46"> </span>copy <span class="_"> </span>it <span class="_"> </span>to <span class="_"> </span>the <span class="_ _66"> </span>caller<span class="_ _9"></span>’s <span class="_"> </span>buffer <span class="_"> </span>if <span class="_"> </span>one <span class="_"> </span>was</div><div class="t m0 x11a h49 y5856 ff19 fs26 fc0 sc0 ls0 ws0">supplied. <span class="_ _47"> </span>Then<span class="_ _47"> </span>we <span class="_ _3"></span>read <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _3"></span>recor<span class="lsa20">da<span class="_ _b"></span><span class="ls0">nd <span class="_ _3"></span>set <span class="_ _9"></span>the <span class="_ _3"></span>return <span class="_ _2"></span>value <span class="_ _3"></span>to <span class="_ _3"></span>point <span class="_ _9"></span>to</span></span></div><div class="t m0 x11a h49 y5857 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_"> </span>internal <span class="_"> </span>buffer <span class="_"> </span>containing <span class="_"> </span>the <span class="_"> </span>data <span class="_"> </span>recor<span class="_ _1"></span>d. <span class="_ _46"> </span>W<span class="_ _6"></span><span class="ls16c4">ei<span class="_ _4a"></span><span class="ls0">ncrement <span class="_"> </span>a <span class="_"> </span>statistics</span></span></div><div class="t m0 x11a h49 y5858 ff19 fs26 fc0 sc0 ls0 ws0">counter<span class="_ _6"></span><span class="lsd3">,u<span class="_ _5"></span><span class="ls0">nlock the free list, and r<span class="_ _1"></span>eturn the pointer to the data record.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
