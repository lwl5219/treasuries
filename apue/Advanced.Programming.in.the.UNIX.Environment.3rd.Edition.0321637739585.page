<div id="pf249" class="pf w4 h1f" data-page-no="249"><div class="pc pc249 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg249.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>15.4<span class="_ _ec"> </span>Coprocesses<span class="_ _1b"> </span><span class="ff18">551</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y31b5 ff1a fs2d fc0 sc0 ls0 ws0">static void</div><div class="t m0 x32 h57 y124b ff1a fs2d fc0 sc0 ls0 ws0">sig_pipe(int signo)</div><div class="t m0 x32 h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;SIGPIPE caught\n&quot;);</div><div class="t m0 x8a h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x32 h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8c h5e y42c5 ff18 fs10 fc0 sc0 ls0 ws0">Figure 15.18<span class="_ _5a"> </span><span class="ff19">Program to drive the<span class="_"> </span><span class="ff1a">add2<span class="_ _53"> </span></span>ﬁlter</span></div><div class="t m0 x3f h49 y42c6 ff19 fs26 fc0 sc0 ls0 ws0">Here, we create two <span class="_ _2"></span>pipes, <span class="_ _2"></span>with the <span class="_ _2"></span>parent and <span class="_ _2"></span>the child <span class="_ _2"></span>closing <span class="_ _2"></span>the ends <span class="_ _2"></span>they <span class="_ _2"></span>don’t</div><div class="t m0 x32 h49 y42c7 ff19 fs26 fc0 sc0 ls0 ws0">need. <span class="_"> </span>W<span class="_ _6"></span><span class="ls11ad">eh<span class="_ _d"></span><span class="ls0">ave to <span class="_ _2"></span>use two pipes: one <span class="_ _2"></span>for the standar<span class="ls11ae">di<span class="_ _d"></span><span class="ls0">nput of the <span class="_ _2"></span>coprocess and one for</span></span></span></span></div><div class="t m0 x32 h4d y42c8 ff19 fs26 fc0 sc0 ls0 ws0">its <span class="_ _42"> </span>standar<span class="ls11af">do<span class="_ _c"></span><span class="ls0">utput. <span class="_ _44"> </span>The<span class="_ _35"> </span>child <span class="_ _42"> </span>then <span class="_ _42"> </span>calls<span class="_ _44"> </span><span class="ff1a">dup2<span class="_ _44"> </span></span>to <span class="_ _23"> </span>move <span class="_ _42"> </span>the <span class="_ _42"> </span>pipe <span class="_ _42"> </span>descriptors <span class="_ _42"> </span>onto <span class="_ _42"> </span>its</span></span></div><div class="t m0 x32 h4d y42c9 ff19 fs26 fc0 sc0 ls0 ws0">standar<span class="lsd3">di<span class="_ _4f"></span><span class="ls0">nput and standar<span class="lsd3">do<span class="_ _d"></span><span class="ls0">utput, befor<span class="lsd3">ec<span class="_ _d"></span><span class="ls0">alling<span class="_"> </span><span class="ff1a">execl</span>.</span></span></span></span></span></span></div><div class="t m0 x3f h49 y42ca ff19 fs26 fc0 sc0 ls0 ws0">If <span class="_ _35"> </span>we <span class="_ _44"> </span>compile <span class="_ _35"> </span>and <span class="_ _44"> </span>run <span class="_ _35"> </span>the <span class="_ _44"> </span>program <span class="_ _35"> </span>in <span class="_ _44"> </span>Figur<span class="_ _0"></span><span class="ls11b0">e1<span class="_ _52"></span><span class="ls0">5.18, <span class="_ _44"> </span>it <span class="_ _44"> </span>works <span class="_ _35"> </span>as <span class="_ _44"> </span>expected.</span></span></div><div class="t m0 x32 h4d y42cb ff19 fs26 fc0 sc0 ls0 ws0">Furthermore, <span class="_ _e"> </span>if <span class="_"> </span>we<span class="_ _59"> </span><span class="ff1a">kill<span class="_ _59"> </span></span>the<span class="_ _59"> </span><span class="ff1a">add2<span class="_ _59"> </span></span>coprocess <span class="_"> </span>while <span class="_ _e"> </span>the <span class="_"> </span>program <span class="_ _e"> </span>in <span class="_"> </span>Figur<span class="ls11b1">e1<span class="_ _5b"></span><span class="ls0">5.18 <span class="_"> </span>is</span></span></div><div class="t m0 x32 h49 y42cc ff19 fs26 fc0 sc0 ls0 ws0">waiting <span class="_ _3"></span>for <span class="_ _3"></span>our <span class="_ _3"></span>input <span class="_ _3"></span>and <span class="_ _9"></span>then <span class="_ _3"></span>enter <span class="_ _3"></span>two <span class="_ _3"></span>numbers, <span class="_ _3"></span>the <span class="_ _3"></span>signal <span class="_ _9"></span>handler <span class="_ _3"></span>is <span class="_ _3"></span>invoked <span class="_ _3"></span>when</div><div class="t m0 x32 h49 y42cd ff19 fs26 fc0 sc0 ls0 ws0">the program writes to the pipe that has no r<span class="_ _0"></span>eader<span class="_ _6"></span><span class="ls199">.(<span class="_ _4a"></span><span class="ls0">See Exercise 15.4.)</span></span></div><div class="t m0 x35 h61 y42ce ff16 fs2c fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h54 y42cf ff19 fs2c fc0 sc0 ls0 ws0">In <span class="_ _9"></span>the <span class="_ _23"></span>copr<span class="_ _0"></span>ocess<span class="_ _45"> </span><span class="ff1a">add2<span class="_ _45"> </span></span>(Figur<span class="ls10b7">e1<span class="_ _b"></span><span class="ls0">5.17), <span class="_ _9"></span>we <span class="_ _9"></span>purposely <span class="_ _23"></span>used <span class="_ _9"></span>low-level <span class="_ _23"></span>I/O <span class="_ _9"></span>(UNIX <span class="_ _9"></span>system</span></span></div><div class="t m0 x32 h54 y42d0 ff19 fs2c fc0 sc0 ls0 ws0">calls):<span class="_ _44"> </span><span class="ff1a">read<span class="_ _44"> </span></span>and<span class="_ _44"> </span><span class="ff1a">write</span><span class="ls11b2">.W<span class="_ _52"></span><span class="ls0">hat <span class="_ _42"> </span>happens <span class="_ _42"> </span>if <span class="_ _42"> </span>we <span class="_ _53"> </span>rewrite <span class="_ _42"> </span>this <span class="_ _42"> </span>coprocess <span class="_ _42"> </span>to <span class="_ _42"> </span>use <span class="_ _42"> </span>standard</span></span></div><div class="t m0 x32 h55 y42d1 ff19 fs2c fc0 sc0 ls0 ws0">I/O? <span class="_"> </span>Figur<span class="ls142">e1<span class="_ _4f"></span><span class="ls0">5.19 shows the new version.</span></span></div><div class="t m0 x32 h62 y42d2 ff1a fs30 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h62 y42d3 ff1a fs30 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h62 y42d4 ff1a fs30 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h62 y42d5 ff1a fs30 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h62 y42d6 ff1a fs30 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>int1,<span class="_"> </span>int2;</div><div class="t m0 x8a h62 y42d7 ff1a fs30 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>line[MAXLINE];</div><div class="t m0 x8a h62 y42d8 ff1a fs30 fc0 sc0 ls0 ws0">while (fgets(line, MAXLINE, stdin) != NULL) {</div><div class="t m0 x9d h62 y42d9 ff1a fs30 fc0 sc0 ls0 ws0">if (sscanf(line, &quot;%d%d&quot;, &amp;int1, &amp;int2) == 2) {</div><div class="t m0 x1f h62 y42da ff1a fs30 fc0 sc0 ls0 ws0">if (printf(&quot;%d\n&quot;, int1 + int2) == EOF)</div><div class="t m0 x1ca h62 y42db ff1a fs30 fc0 sc0 ls0 ws0">err_sys(&quot;printf error&quot;);</div><div class="t m0 x9d h62 y42dc ff1a fs30 fc0 sc0 ls1185 ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x1f h62 y42dd ff1a fs30 fc0 sc0 ls0 ws0">if (printf(&quot;invalid args\n&quot;) == EOF)</div><div class="t m0 x1ca h62 y42de ff1a fs30 fc0 sc0 ls0 ws0">err_sys(&quot;printf error&quot;);</div><div class="t m0 x9d h62 y42df ff1a fs30 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h62 y42e0 ff1a fs30 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h62 y42e1 ff1a fs30 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h62 y42e2 ff1a fs30 fc0 sc0 ls0 ws0">}</div><div class="t m0 xe8 h30 y42e3 ff18 fs13 fc0 sc0 ls0 ws0">Figure 15.19<span class="_ _5a"> </span><span class="ff19">Filter to add two numbers, using standar<span class="ls673">dI<span class="_ _84"></span><span class="ls0">/O</span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
