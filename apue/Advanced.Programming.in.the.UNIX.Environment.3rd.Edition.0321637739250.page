<div id="pffa" class="pf w4 h1f" data-page-no="fa"><div class="pc pcfa w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bgfa.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">216<span class="_ _1b"> </span><span class="ff19">Process <span class="_"> </span>Envir<span class="_ _0"></span>onment <span class="_ _1c1"> </span>Chapter<span class="_ _44"> </span>7</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _80"> </span>c<span class="_ _9"></span><span class="ls0">all<span class="_ _47"> </span><span class="ff1a">setjmp<span class="_ _45"> </span></span>fr<span class="_ _0"></span>om <span class="_ _3"></span>the <span class="_ _3"></span>location <span class="_ _3"></span>that <span class="_ _3"></span>we <span class="_ _3"></span>want <span class="_ _9"></span>to <span class="_ _3"></span>return <span class="_ _2"></span>to, <span class="_ _3"></span>which <span class="_ _3"></span>in <span class="_ _9"></span>this <span class="_ _3"></span>example</span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">is <span class="_ _2"></span>in <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">main<span class="_ _47"> </span></span>function. <span class="_ _47"> </span>In<span class="_ _47"> </span>this <span class="_ _3"></span>case,<span class="_ _47"> </span><span class="ff1a">setjmp<span class="_ _47"> </span></span><span class="ls45">re<span class="_ _2"></span></span>turns <span class="_ _3"></span>0 <span class="_ _2"></span>because <span class="_ _3"></span>we <span class="_ _3"></span>called <span class="_ _3"></span>it <span class="_ _3"></span>directly<span class="_ _4"></span><span class="ls897">.I<span class="_ _1d"></span><span class="ls0">n</span></span></div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _3"></span>call <span class="_ _3"></span>to<span class="_ _45"> </span><span class="ff1a">setjmp</span><span class="ls8d3">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>argument<span class="_ _47"> </span><span class="ff1b">env<span class="_ _47"> </span></span>is <span class="_ _9"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>special <span class="_ _9"></span>type<span class="_ _47"> </span><span class="ff1a">jmp_buf</span><span class="ls8d4">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _3"></span>data <span class="_ _9"></span>type <span class="_ _3"></span>is</span></span></span></span></div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">some <span class="_ _2"></span>form <span class="_ _3"></span>of <span class="_ _2"></span>array <span class="_ _2"></span>that <span class="_ _3"></span>is <span class="_ _2"></span>capable <span class="_ _3"></span>of <span class="_ _2"></span>holding <span class="_ _3"></span>all <span class="_ _2"></span>the <span class="_ _3"></span>information <span class="_ _2"></span>required <span class="_ _2"></span>to <span class="_ _2"></span>restor<span class="ls8d5">et<span class="_ _8"></span><span class="ls0">he</span></span></div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">status <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _23"></span>stack <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _23"></span>state <span class="_ _9"></span>when <span class="_ _9"></span>we <span class="_ _9"></span>call<span class="_ _45"> </span><span class="ff1a">longjmp</span><span class="ls8d6">.N<span class="_ _62"></span><span class="ls0">ormally<span class="_ _6"></span><span class="ls4af">,t<span class="_ _b"></span><span class="ls0">he<span class="_ _45"> </span><span class="ff1b">env<span class="_ _45"> </span></span>variable <span class="_ _9"></span>is <span class="_ _9"></span>a</span></span></span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">global variable, since we’ll need to refer<span class="_ _0"></span>ence it fr<span class="_ _0"></span>om another function.</div><div class="t m0 x3f h26 y135 ff19 fsf fc0 sc0 ls0 ws0">When <span class="_ _53"> </span>we <span class="_ _53"> </span>encounter <span class="_ _53"> </span>an <span class="_ _e"> </span>error <span class="_ _84"></span>— <span class="_ _4"></span>say<span class="_ _4"></span>,<span class="_ _44"> </span>in<span class="_ _4b"> </span>the<span class="_ _4b"> </span><span class="ff1a">cmd_add<span class="_ _44"> </span></span>function <span class="_ _4"></span>— <span class="_ _84"></span>we<span class="_ _4b"> </span>call<span class="_ _4b"> </span><span class="ff1a">longjmp</span></div><div class="t m0 x32 h26 y136 ff19 fsf fc0 sc0 ls0 ws0">with two <span class="_ _2"></span>arguments. <span class="_"> </span>The<span class="_ _47"> </span>ﬁrst is <span class="_ _2"></span>the <span class="_ _2"></span>same<span class="_ _66"> </span><span class="ff1b">env<span class="_ _47"> </span></span>that we <span class="_ _2"></span>used <span class="_ _2"></span>in <span class="_ _2"></span>a <span class="_ _2"></span>call <span class="_ _2"></span>to<span class="_"> </span><span class="ff1a">setjmp</span><span class="ls28a">,a<span class="_ _d"></span><span class="ls0">nd <span class="_ _2"></span>the</span></span></div><div class="t m0 x32 h26 y137 ff19 fsf fc0 sc0 ls0 ws0">second,<span class="_"> </span><span class="ff1b">val</span>,<span class="_ _47"> </span>is<span class="_"> </span>a<span class="_ _66"> </span>nonzer<span class="ls8d7">ov<span class="_ _4f"></span><span class="ls0">alue <span class="_ _2"></span>that <span class="_ _2"></span>becomes <span class="_ _2"></span>the return <span class="_ _2"></span>value from<span class="_ _66"> </span><span class="ff1a">setjmp</span><span class="ls8d8">.T<span class="_ _5b"></span><span class="ls0">he <span class="_ _2"></span>second</span></span></span></span></div><div class="t m0 x32 h26 y138 ff19 fsf fc0 sc0 ls0 ws0">argument <span class="_ _2"></span>allows <span class="_ _2"></span>us <span class="_ _3"></span>to <span class="_ _3"></span>use <span class="_ _2"></span>mor<span class="ls8d9">et<span class="_ _8"></span><span class="ls0">han <span class="_ _3"></span>one<span class="_ _47"> </span><span class="ff1a">longjmp<span class="_ _47"> </span></span>for <span class="_ _3"></span>each<span class="_ _47"> </span><span class="ff1a">setjmp</span><span class="ls8da">.F<span class="_ _1d"></span><span class="ls0">or <span class="_ _2"></span>example, <span class="_ _3"></span>we</span></span></span></span></div><div class="t m0 x32 h26 y139 ff19 fsf fc0 sc0 ls0 ws0">could<span class="_ _47"> </span><span class="ff1a">longjmp<span class="_ _66"> </span></span>from<span class="_ _47"> </span><span class="ff1a">cmd_add<span class="_ _47"> </span></span>with <span class="_ _2"></span>a<span class="_ _47"> </span><span class="ff1b">val<span class="_ _47"> </span></span>of <span class="_ _2"></span>1 <span class="_ _3"></span>and <span class="_ _3"></span>also <span class="_ _2"></span>call<span class="_ _47"> </span><span class="ff1a">longjmp<span class="_ _47"> </span></span>from<span class="_ _66"> </span><span class="ff1a">get_token</span></div><div class="t m0 x32 h26 y13a ff19 fsf fc0 sc0 ls0 ws0">with a<span class="_ _47"> </span><span class="ff1b">val<span class="_ _66"> </span></span>of <span class="_ _2"></span>2.<span class="_ _61"> </span>In <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">main<span class="_ _66"> </span></span>function, <span class="_ _2"></span>the <span class="_ _2"></span>return <span class="_ _2"></span>value <span class="_ _2"></span>from<span class="_"> </span><span class="ff1a">setjmp<span class="_ _66"> </span></span>is <span class="_ _2"></span>either <span class="_ _2"></span>1 <span class="_ _2"></span>or <span class="_ _2"></span>2, <span class="_ _2"></span>and</div><div class="t m0 x32 h26 y254 ff19 fsf fc0 sc0 ls0 ws0">we <span class="_ _e"> </span>can <span class="_ _e"> </span>test <span class="_"> </span>this <span class="_ _53"> </span>value, <span class="_ _e"> </span>if <span class="_"> </span>we <span class="_ _53"> </span>want, <span class="_"> </span>and <span class="_ _53"> </span>determine <span class="_ _e"> </span>whether <span class="_"> </span>the<span class="_ _4b"> </span><span class="ff1a">longjmp<span class="_ _4b"> </span></span>was <span class="_"> </span>fr<span class="_ _1"></span>om</div><div class="t m0 x32 h26 y255 ff1a fsf fc0 sc0 ls0 ws0">cmd_add<span class="_ _80"> </span><span class="ff19">or<span class="_"> </span></span>get_token<span class="ff19">.</span></div><div class="t m0 x3f h26 y13b ff19 fsf fc0 sc0 ls0 ws0">Let’s <span class="_ _47"> </span>return <span class="_ _47"> </span>to <span class="_ _47"> </span>the <span class="_ _45"> </span>example.<span class="_ _5f"> </span>Figur<span class="ls477">e7<span class="_ _62"></span><span class="ls0">.1<span class="_ _1"></span><span class="ls477">1s<span class="_ _1d"></span><span class="ls0">hows <span class="_ _47"> </span>both <span class="_ _45"> </span>the<span class="_ _61"> </span><span class="ff1a">main<span class="_"> </span></span>and<span class="_ _61"> </span><span class="ff1a">cmd_add</span></span></span></span></span></div><div class="t m0 x32 h26 y13c ff19 fsf fc0 sc0 ls0 ws0">functions. <span class="_"> </span>(The<span class="_"> </span>other two functions,<span class="_"> </span><span class="ff1a">do_line<span class="_ _80"> </span></span>and<span class="_"> </span><span class="ff1a">get_token</span><span class="ls44">,h<span class="_ _5"></span><span class="ls0">aven’t changed.)</span></span></div><div class="t m0 x32 h4e y1d05 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y1d06 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;setjmp.h&gt;</div><div class="t m0 x32 h4e y1d07 ff1a fs28 fc0 sc0 ls0 ws0">#define TOK_ADD<span class="_ _15"> </span>5</div><div class="t m0 x32 h4e y1d08 ff1a fs28 fc0 sc0 ls0 ws0">jmp_buf jmpbuffer;</div><div class="t m0 x32 h4e y1d09 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y1d0a ff1a fs28 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h4e y1d0b ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y1d0c ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>line[MAXLINE];</div><div class="t m0 x8a h4e y1d0d ff1a fs28 fc0 sc0 ls0 ws0">if (setjmp(jmpbuffer) != 0)</div><div class="t m0 x9d h4e y1d0e ff1a fs28 fc0 sc0 ls0 ws0">printf(&quot;error&quot;);</div><div class="t m0 x8a h4e y1d0f ff1a fs28 fc0 sc0 ls0 ws0">while (fgets(line, MAXLINE, stdin) != NULL)</div><div class="t m0 x9d h4e y1d10 ff1a fs28 fc0 sc0 ls0 ws0">do_line(line);</div><div class="t m0 x8a h4e y1d11 ff1a fs28 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h4e y1d12 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x140 h4e y1d13 ff1a fs28 fc0 sc0 ls1b6 ws0">...</div><div class="t m0 x32 h4e y1d14 ff1a fs28 fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h4e y1d15 ff1a fs28 fc0 sc0 ls0 ws0">cmd_add(void)</div><div class="t m0 x32 h4e y1d16 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y1d17 ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>token;</div><div class="t m0 x8a h4e y1d18 ff1a fs28 fc0 sc0 ls0 ws0">token = get_token();</div><div class="t m0 x8a h4e y1d19 ff1a fs28 fc0 sc0 ls0 ws0">if (token &lt; 0)<span class="_ _189"> </span>/* an error has occurred */</div><div class="t m0 x9d h4e y1d1a ff1a fs28 fc0 sc0 ls0 ws0">longjmp(jmpbuffer, 1);</div><div class="t m0 x8a h4e y1d1b ff1a fs28 fc0 sc0 ls0 ws0">/* rest of processing for this command */</div><div class="t m0 x32 h4e y1d1c ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x2f h4f y1d1d ff18 fs11 fc0 sc0 ls0 ws0">Figure 7.1<span class="_ _0"></span>1<span class="_ _5a"> </span><span class="ff19">Example of<span class="_"> </span><span class="ff1a">setjmp<span class="_ _e"> </span></span>and<span class="_"> </span><span class="ff1a">longjmp</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
