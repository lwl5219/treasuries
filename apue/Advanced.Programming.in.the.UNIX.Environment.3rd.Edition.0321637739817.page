<div id="pf331" class="pf w4 h1f" data-page-no="331"><div class="pc pc331 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg331.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.9<span class="_ _24b"> </span>Performance<span class="_ _1fb"> </span><span class="ff18">783</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">mandatory <span class="_ _9"></span>locking), <span class="_ _23"></span>we <span class="_ _9"></span>ran <span class="_ _9"></span>three <span class="_ _9"></span>versions <span class="_ _23"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>test <span class="_ _23"></span>program. <span class="_ _47"> </span>The<span class="_ _35"> </span>ﬁrst <span class="_ _9"></span>version <span class="_ _9"></span>used</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _42"> </span>source <span class="_ _23"></span>code <span class="_ _42"> </span>shown <span class="_ _42"> </span>in <span class="_ _42"> </span>Section <span class="_ _23"> </span>20.8, <span class="_ _42"> </span>which <span class="_ _42"> </span>we’ve <span class="_ _42"> </span>called <span class="_ _42"> </span>ﬁne-grained <span class="_ _42"> </span>locking.<span class="_ _51"> </span>The</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">second <span class="_ _47"> </span>version <span class="_ _47"> </span>changed <span class="_ _45"> </span>the <span class="_ _47"> </span>locking <span class="_ _47"> </span>calls <span class="_ _45"> </span>to <span class="_ _47"> </span>implement <span class="_ _47"> </span>coarse-grained <span class="_ _45"> </span>locking, <span class="_ _47"> </span>as</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">described <span class="_ _3"></span>in <span class="_ _3"></span>Section <span class="_ _3"></span>20.6.<span class="_ _16"> </span>The <span class="_ _3"></span>thir<span class="lsa7e">dv<span class="_ _8"></span><span class="ls0">ersion <span class="_ _3"></span>had <span class="_ _3"></span>all <span class="_ _3"></span>locking <span class="_ _3"></span>calls <span class="_ _9"></span>removed, <span class="_ _2"></span>so <span class="_ _3"></span>we <span class="_ _3"></span>could</span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">measur<span class="ls16db">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"></span>overhead <span class="_ _23"></span>involved <span class="_ _23"> </span>in <span class="_ _42"> </span>locking.<span class="_ _51"> </span><span class="ls5f">We <span class="_ _45"> </span>c<span class="_ _9"></span></span>an <span class="_ _42"> </span>run <span class="_ _23"> </span>the <span class="_ _42"> </span>ﬁrst <span class="_ _23"> </span>and <span class="_ _42"> </span>second <span class="_ _23"> </span>versions</span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">(ﬁne-grained <span class="_ _23"> </span>locking <span class="_ _23"> </span>and <span class="_ _42"> </span>coarse-grained <span class="_ _23"> </span>locking) <span class="_ _23"> </span>using <span class="_ _42"> </span>either <span class="_ _23"> </span>advisory <span class="_ _23"> </span>or <span class="_ _42"> </span>mandatory</div><div class="t m0 x32 h2a y135 ff19 fsf fc0 sc0 ls0 ws0">locking, <span class="_ _2"></span>by <span class="_ _3"></span>changing <span class="_ _3"></span>the <span class="_ _3"></span>permission <span class="_ _2"></span>bits <span class="_ _3"></span>on <span class="_ _3"></span>the <span class="_ _3"></span>database <span class="_ _3"></span>ﬁles.<span class="_ _61"> </span>(In <span class="_ _3"></span>all <span class="_ _3"></span>the <span class="_ _3"></span>tests <span class="_ _2"></span>reported</div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">in <span class="_ _4b"> </span>this <span class="_ _4b"> </span>section, <span class="_ _4b"> </span>we <span class="_ _59"> </span>measured <span class="_ _44"> </span>the <span class="_ _59"> </span>times <span class="_ _4b"> </span>for <span class="_ _4b"> </span>mandatory <span class="_ _4b"> </span>locking <span class="_ _4b"> </span>using <span class="_ _59"> </span>only <span class="_ _4b"> </span>the</div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">implementation of ﬁne-grained locking.)</div><div class="t m0 x3f h2a y138 ff19 fsf fc0 sc0 ls0 ws0">All <span class="_ _23"> </span>the <span class="_ _42"> </span>timing <span class="_ _23"> </span>tests <span class="_ _42"> </span>in <span class="_ _23"> </span>this <span class="_ _42"> </span>section <span class="_ _42"> </span>wer<span class="_ _0"></span><span class="ls16dc">ed<span class="_ _43"></span><span class="ls0">one <span class="_ _23"> </span>on <span class="_ _42"> </span>an <span class="_ _42"> </span>Intel <span class="_ _23"> </span>Core-i5 <span class="_ _23"> </span>system <span class="_ _42"> </span>running</span></span></div><div class="t m0 x32 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">Linux <span class="_"> </span>3.2.0.<span class="_ _48"> </span>This <span class="_"> </span>system <span class="_ _e"> </span>has <span class="_"> </span>four <span class="_"> </span>cor<span class="_ _0"></span>es, <span class="_"> </span>which <span class="_ _e"> </span>allows <span class="_"> </span>up <span class="_"> </span>to <span class="_ _e"> </span>four <span class="_"> </span>pr<span class="_ _0"></span>ocesses <span class="_"> </span>to <span class="_ _e"> </span>run</div><div class="t m0 x32 h2a y13a ff19 fsf fc0 sc0 ls0 ws0">concurrently<span class="_ _4"></span>.</div><div class="t m0 x35 h27 yea1 ff16 fsf fc0 sc0 ls0 ws0">Single-Process Results</div><div class="t m0 x32 h2b y1f11 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls271">e2<span class="_ _4f"></span><span class="ls0">0.7 shows <span class="_ _2"></span>the results when <span class="_ _2"></span>only a <span class="_ _2"></span>single <span class="_ _2"></span>child process ran, <span class="_ _2"></span>with an<span class="_ _66"> </span><span class="ff1b">nrec<span class="_"> </span></span>of 2,000,</span></span></div><div class="t m0 x32 h2a y2853 ff19 fsf fc0 sc0 ls0 ws0">6,000, and 12,000.</div><div class="t m0 x10a h9f y587e ff19 fs39 fc0 sc0 ls0 ws0">Advisory locking<span class="_ _134"> </span>Mandatory locking</div><div class="t m0 x59 h81 y353b ff19 fs3f fc0 sc0 ls0 ws0">Coarse-grained locking<span class="_ _75"> </span>Fine-grained locking<span class="_ _13f"> </span>Fine-grained locking</div><div class="t m0 x148 h81 y587f ff19 fs3f fc0 sc0 ls0 ws0">No locking</div><div class="t m0 x7c h82 y5880 ff19 fs40 fc0 sc0 ls0 ws0">User <span class="_ _1bb"> </span>Sys<span class="_ _1bb"> </span>Clock <span class="_ _d9"> </span>User<span class="_ _1c3"> </span>Sys <span class="_ _df"> </span>Clock<span class="_ _6e"> </span>User <span class="_ _1bb"> </span>Sys<span class="_ _d8"> </span>Clock <span class="_ _5e"> </span>User<span class="_ _68"> </span>Sys <span class="_ _df"> </span>Clock</div><div class="t m0 xf7 h19c y5881 ff1b fs40 fc0 sc0 ls0 ws0">nrec</div><div class="t m0 xf7 ha0 y5882 ff19 fs4c fc0 sc0 ls0 ws0">2,000 <span class="_ _141"> </span>0.10<span class="_ _87"> </span>0.22 <span class="_ _68"> </span>0.33<span class="_ _1bb"> </span>0.17 <span class="_ _87"> </span>0.33<span class="_ _68"> </span>0.51 <span class="_ _df"> </span>0.13<span class="_ _1b"> </span>0.38 <span class="_ _1bb"> </span>0.51<span class="_ _d8"> </span>0.14 <span class="_ _68"> </span>0.43<span class="_ _87"> </span>0.58</div><div class="t m0 xf7 ha0 y5883 ff19 fs4c fc0 sc0 ls0 ws0">6,000 <span class="_ _141"> </span>0.59<span class="_ _87"> </span>1.32 <span class="_ _68"> </span>1.91<span class="_ _1bb"> </span>0.88 <span class="_ _87"> </span>2.13<span class="_ _68"> </span>3.03 <span class="_ _df"> </span>0.90<span class="_ _1b"> </span>2.14 <span class="_ _1bb"> </span>3.05<span class="_ _d8"> </span>0.99 <span class="_ _68"> </span>2.52<span class="_ _87"> </span>3.53</div><div class="t m0 x1a0 ha0 y5884 ff19 fs4c fc0 sc0 ls0 ws0">12,000 <span class="_ _141"> </span>4.37<span class="_ _87"> </span>9.58 <span class="_ _df"> </span>13.97 <span class="_ _6d"> </span>5.38 <span class="_ _df"> </span>12.60<span class="_ _6d"> </span>18.01 <span class="_ _6d"> </span>5.34 <span class="_ _6d"> </span>12.63<span class="_ _6d"> </span>18.01 <span class="_ _6d"> </span>5.53 <span class="_ _df"> </span>15.03<span class="_ _6d"> </span>20.60</div><div class="t m0 x143 hd2 y5885 ff18 fs14 fc0 sc0 ls0 ws0">Figure 20.7<span class="_ _5a"> </span><span class="ff19">Single child, varying<span class="_"> </span><span class="ff1b">nrec</span><span class="ls56a">,d<span class="_ _84"></span><span class="ls0">iffer<span class="_ _0"></span>ent locking techniques</span></span></span></div><div class="t m0 x32 h96 y5886 ff19 fs49 fc0 sc0 ls0 ws0">The last <span class="_ _2"></span>12 <span class="_ _2"></span>columns <span class="_ _2"></span>give <span class="_ _2"></span>the <span class="_ _2"></span>corresponding times <span class="_ _2"></span>in <span class="_ _2"></span>seconds.<span class="_ _61"> </span>In <span class="_ _2"></span>all <span class="_ _2"></span>cases, <span class="_ _2"></span>the user <span class="_ _2"></span>CPU</div><div class="t m0 x32 h96 y5887 ff19 fs49 fc0 sc0 ls0 ws0">time <span class="_ _23"></span>plus <span class="_ _9"></span>the <span class="_ _23"> </span>system <span class="_ _23"> </span>CPU <span class="_ _23"></span>time <span class="_ _23"></span>approximately <span class="_ _9"></span>equals <span class="_ _23"></span>the <span class="_ _23"></span>clock <span class="_ _9"></span>time.<span class="_ _51"> </span>This <span class="_ _23"></span>set <span class="_ _23"></span>of <span class="_ _23"></span>tests</div><div class="t m0 x32 h96 y5888 ff19 fs49 fc0 sc0 ls0 ws0">was CPU limited and not disk limited.</div><div class="t m0 x3f h96 y5889 ff19 fs49 fc0 sc0 ls0 ws0">The <span class="_ _53"> </span>six <span class="_ _53"> </span>columns <span class="_ _e"> </span>under <span class="_ _53"> </span>‘<span class="_ _0"></span>‘Advisory <span class="_ _53"> </span>locking’<span class="_ _0"></span><span class="ls16dd">’a<span class="_ _c"></span><span class="ls4a6">re <span class="_"> </span>a<span class="ls0">lmost <span class="_ _53"> </span>equal <span class="_ _e"> </span>for <span class="_ _53"> </span>each <span class="_ _53"> </span>row<span class="_ _6"></span><span class="ls16de">.T<span class="_ _64"></span><span class="ls0">his</span></span></span></span></span></div><div class="t m0 x32 h96 y588a ff19 fs49 fc0 sc0 ls0 ws0">makes <span class="_ _2"></span>sense <span class="_ _3"></span>because <span class="_ _3"></span>for <span class="_ _3"></span>a <span class="_ _3"></span>single <span class="_ _3"></span>process; <span class="_ _2"></span>there<span class="_ _47"> </span>is<span class="_ _47"> </span>no<span class="_ _47"> </span>differ<span class="_ _0"></span>ence <span class="_ _2"></span>between <span class="_ _3"></span>coarse-grained</div><div class="t m0 x32 h9b y588b ff19 fs49 fc0 sc0 ls0 ws0">locking and ﬁne-grained locking, except for the extra calls to<span class="_"> </span><span class="ff1a">fcntl</span>.</div><div class="t m0 x3f h96 y588c ff19 fs49 fc0 sc0 ls0 ws0">Comparing <span class="_ _9"></span>no <span class="_ _9"></span>locking <span class="_ _23"></span>with <span class="_ _9"></span>advisory <span class="_ _9"></span>locking, <span class="_ _23"></span>we <span class="_ _9"></span>see <span class="_ _9"></span>that <span class="_ _9"></span>adding <span class="_ _23"></span>the <span class="_ _9"></span>locking <span class="_ _9"></span>calls</div><div class="t m0 x32 h96 y588d ff19 fs49 fc0 sc0 ls0 ws0">increases <span class="_ _9"></span>the <span class="_ _9"></span>system <span class="_ _23"></span>CPU <span class="_ _9"></span>time <span class="_ _9"></span>by <span class="_ _23"></span>32% <span class="_ _9"></span>to <span class="_ _23"></span>73%.<span class="_ _5a"> </span>Even <span class="_ _9"></span>though <span class="_ _23"></span>the <span class="_ _9"></span>locks <span class="_ _23"></span>ar<span class="ls16df">en<span class="_ _43"></span><span class="ls0">ever <span class="_ _23"></span>used</span></span></div><div class="t m0 x32 h9b y588e ff19 fs49 fc0 sc0 ls0 ws0">(since <span class="_ _9"></span>only <span class="_ _3"></span>a <span class="_ _9"></span>single <span class="_ _9"></span>process <span class="_ _9"></span>is <span class="_ _3"></span>running), <span class="_ _9"></span>the <span class="_ _9"></span>system <span class="_ _9"></span>call <span class="_ _9"></span>overhead <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>calls <span class="_ _9"></span>to<span class="_ _47"> </span><span class="ff1a">fcntl</span></div><div class="t m0 x32 h96 y588f ff19 fs49 fc0 sc0 ls0 ws0">adds <span class="_ _9"></span>time.<span class="_ _16"> </span>Also <span class="_ _9"></span>note <span class="_ _9"></span>that <span class="_ _9"></span>the <span class="_ _3"></span>user <span class="_ _9"></span>CPU <span class="_ _9"></span>time <span class="_ _9"></span>is <span class="_ _9"></span>about <span class="_ _9"></span>the <span class="_ _3"></span>same <span class="_ _9"></span>for <span class="_ _9"></span>all <span class="_ _9"></span>four <span class="_ _9"></span>versions <span class="_ _3"></span>of</div><div class="t m0 x32 h96 y5890 ff19 fs49 fc0 sc0 ls0 ws0">locking. <span class="_ _44"> </span>Since<span class="_ _4b"> </span>the <span class="_ _53"> </span>user <span class="_ _e"> </span>code <span class="_ _53"> </span>is <span class="_ _e"> </span>almost <span class="_ _53"> </span>equivalent <span class="_ _53"> </span>(except <span class="_ _e"> </span>for <span class="_ _53"> </span>the <span class="_ _53"> </span>number <span class="_ _e"> </span>of <span class="_ _53"> </span>calls <span class="_ _53"> </span>to</div><div class="t m0 x32 h9b y5891 ff1a fs49 fc0 sc0 ls0 ws0">fcntl<span class="ff19">), this makes sense.</span></div><div class="t m0 x3f h96 y5892 ff19 fs49 fc0 sc0 ls0 ws0">The <span class="_ _53"> </span>ﬁnal <span class="_ _53"> </span>point <span class="_ _53"> </span>to <span class="_ _53"> </span>note <span class="_ _53"> </span>from <span class="_ _53"> </span>Figur<span class="ls16e0">e2<span class="_ _55"></span><span class="ls0">0.7 <span class="_ _53"> </span>is <span class="_ _53"> </span>that <span class="_ _e"> </span>mandatory <span class="_ _53"> </span>locking <span class="_ _53"> </span>increases <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h96 y5893 ff19 fs49 fc0 sc0 ls0 ws0">system <span class="_ _23"></span>CPU <span class="_ _23"></span>time <span class="_ _9"></span>by <span class="_ _23"> </span>13% <span class="_ _23"> </span>to <span class="_ _23"> </span>19% <span class="_ _23"> </span>compared <span class="_ _9"></span>to <span class="_ _23"> </span>advisory <span class="_ _23"> </span>locking.<span class="_ _51"> </span>Since <span class="_ _23"></span>the <span class="_ _23"></span>number <span class="_ _23"></span>of</div><div class="t m0 x32 h96 y5894 ff19 fs49 fc0 sc0 ls0 ws0">locking <span class="_ _3"></span>calls <span class="_ _9"></span>is <span class="_ _9"></span>the <span class="_ _3"></span>same <span class="_ _9"></span>for <span class="_ _9"></span>advisory <span class="_ _3"></span>ﬁne-grained <span class="_ _9"></span>locking <span class="_ _9"></span>and <span class="_ _3"></span>mandatory <span class="_ _9"></span>ﬁne-grained</div><div class="t m0 x32 h96 y5895 ff19 fs49 fc0 sc0 ls0 ws0">locking, the additional system call overhead must be fr<span class="_ _0"></span>om the r<span class="_ _0"></span>eads and writes.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
