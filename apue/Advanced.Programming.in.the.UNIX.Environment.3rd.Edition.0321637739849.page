<div id="pf351" class="pf w4 h1f" data-page-no="351"><div class="pc pc351 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg351.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">815</span></div><div class="t m0 x140 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">98 <span class="_ _15"> </span>if<span class="_"> </span>(argc != 1)</div><div class="t m0 x140 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">99 <span class="_ _186"> </span>err_quit(&quot;usage:<span class="_"> </span>printd&quot;);</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">100 <span class="_ _15"> </span>daemonize(&quot;printd&quot;);</div><div class="t m0 x32 h57 y2013 ff1a fs2d fc0 sc0 ls0 ws0">101 <span class="_ _15"> </span>sigemptyset(&amp;sa.sa_mask);</div><div class="t m0 x32 h57 y2014 ff1a fs2d fc0 sc0 ls0 ws0">102 <span class="_ _15"> </span>sa.sa_flags<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y2015 ff1a fs2d fc0 sc0 ls0 ws0">103 <span class="_ _15"> </span>sa.sa_handler<span class="_"> </span><span class="ls15c">=S<span class="_ _1d"></span><span class="ls0">IG_IGN;</span></span></div><div class="t m0 x32 h57 y33ad ff1a fs2d fc0 sc0 ls0 ws0">104 <span class="_ _15"> </span>if<span class="_"> </span>(sigaction(SIGPIPE, &amp;sa, NULL) &lt; 0)</div><div class="t m0 x32 h57 y33ae ff1a fs2d fc0 sc0 ls0 ws0">105 <span class="_ _186"> </span>log_sys(&quot;sigaction<span class="_"> </span>failed&quot;);</div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">106 <span class="_ _15"> </span>sigemptyset(&amp;mask);</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">107 <span class="_ _15"> </span>sigaddset(&amp;mask,<span class="_"> </span>SIGHUP);</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">108 <span class="_ _15"> </span>sigaddset(&amp;mask,<span class="_"> </span>SIGTERM);</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">109 <span class="_ _15"> </span>if<span class="_"> </span>((err = pthread_sigmask(SIG_BLOCK, &amp;mask, NULL)) != 0)</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">110 <span class="_ _186"> </span>log_sys(&quot;pthread_sigmask<span class="_"> </span>failed&quot;);</div><div class="t m0 x32 h57 y2ad4 ff1a fs2d fc0 sc0 ls0 ws0">111 <span class="_ _15"> </span>n<span class="_"> </span><span class="ls15c">=s<span class="_ _1d"></span><span class="ls0">ysconf(_SC_HOST_NAME_MAX);</span></span></div><div class="t m0 x32 h57 y2ad5 ff1a fs2d fc0 sc0 ls0 ws0">112 <span class="_ _15"> </span>if<span class="_"> </span>(n &lt; 0)<span class="_ _d9"> </span>/* best guess */</div><div class="t m0 x32 h57 y2ad6 ff1a fs2d fc0 sc0 ls0 ws0">113 <span class="_ _186"> </span>n<span class="_"> </span><span class="ls15c">=H<span class="_ _1d"></span><span class="ls0">OST_NAME_MAX;</span></span></div><div class="t m0 x32 h57 y33b1 ff1a fs2d fc0 sc0 ls0 ws0">114 <span class="_ _15"> </span>if<span class="_"> </span>((host = malloc(n)) == NULL)</div><div class="t m0 x32 h57 y33b2 ff1a fs2d fc0 sc0 ls0 ws0">115 <span class="_ _186"> </span>log_sys(&quot;malloc<span class="_"> </span>error&quot;);</div><div class="t m0 x32 h57 y33b3 ff1a fs2d fc0 sc0 ls0 ws0">116 <span class="_ _15"> </span>if<span class="_"> </span>(gethostname(host, n) &lt; 0)</div><div class="t m0 x32 h57 y33b4 ff1a fs2d fc0 sc0 ls0 ws0">117 <span class="_ _186"> </span>log_sys(&quot;gethostname<span class="_"> </span>error&quot;);</div><div class="t m0 x32 h57 y2020 ff1a fs2d fc0 sc0 ls0 ws0">118 <span class="_ _15"> </span>if<span class="_"> </span>((err = getaddrlist(host, &quot;print&quot;, &amp;ailist)) != 0) {</div><div class="t m0 x32 h57 y2021 ff1a fs2d fc0 sc0 ls0 ws0">119 <span class="_ _186"> </span>log_quit(&quot;getaddrinfo<span class="_"> </span>error: %s&quot;, gai_strerror(err));</div><div class="t m0 x32 h57 y2022 ff1a fs2d fc0 sc0 ls0 ws0">120 <span class="_ _186"> </span>exit(1);</div><div class="t m0 x32 h57 y5750 ff1a fs2d fc0 sc0 ls0 ws0">121 <span class="_ _15"> </span>}</div><div class="t m0 x32 h49 y5b8c ff19 fs26 fc0 sc0 ls0 ws0">[98 <span class="_ _a"></span>– <span class="_ _a"></span>100]<span class="_ _288"> </span>The <span class="_ _23"></span>daemon <span class="_ _9"></span>doesn’t <span class="_ _23"></span>have <span class="_ _9"></span>any <span class="_ _23"></span>options <span class="_ _9"></span>(the <span class="_ _23"></span>only <span class="_ _9"></span>argument <span class="_ _9"></span>is <span class="_ _23"></span>the <span class="_ _9"></span>command</div><div class="t m0 x11a h4d y5b8d ff19 fs26 fc0 sc0 ls0 ws0">name itself<span class="_ _9"></span>), <span class="_ _2"></span>so <span class="_ _2"></span>if<span class="_ _47"> </span><span class="ff1a">argc<span class="_ _66"> </span></span>is <span class="_ _2"></span>not 1, <span class="_ _2"></span>we <span class="_ _2"></span>call<span class="_ _47"> </span><span class="ff1a">err_quit<span class="_ _66"> </span></span>to <span class="_ _2"></span>print an <span class="_ _2"></span>error <span class="_ _2"></span>message</div><div class="t m0 x11a h4d y5b8e ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _53"> </span>exit.<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>c<span class="_ _9"></span></span>all <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">daemonize<span class="_ _4b"> </span></span>function <span class="_ _53"> </span>from <span class="_ _53"> </span>Figur<span class="lsc6d">e1<span class="_ _55"></span><span class="ls0">3.1 <span class="_ _e"> </span>to <span class="_ _53"> </span>become <span class="_ _53"> </span>a</span></span></div><div class="t m0 x11a h49 y5b8f ff19 fs26 fc0 sc0 ls0 ws0">daemon. <span class="_ _35"> </span>After<span class="_ _35"> </span>this <span class="_ _23"></span>point, <span class="_ _23"></span>we <span class="_ _23"></span>can’t <span class="_ _23"> </span>print <span class="_ _23"> </span>error <span class="_ _23"></span>messages <span class="_ _23"> </span>to <span class="_ _23"> </span>standar<span class="ls1775">de<span class="_ _43"></span><span class="ls0">rror;</span></span></div><div class="t m0 x11a h49 y5b90 ff19 fs26 fc0 sc0 ls0 ws0">we need to log them instead.</div><div class="t m0 x32 h4d y5b91 ff19 fs26 fc0 sc0 ls0 ws0">[101 <span class="_ _a"></span>– <span class="_ _a"></span>1<span class="_ _0"></span>10] <span class="_ _4b"> </span>W<span class="_ _6"></span><span class="ls1776">ea<span class="_ _d"></span><span class="ls0">rrange <span class="_ _2"></span>to ignore<span class="_"> </span><span class="ff1a">SIGPIPE</span><span class="ls1777">.W<span class="_ _26"></span><span class="ls1776">ew<span class="_ _d"></span><span class="ls0">ill <span class="_ _2"></span>be writing <span class="_ _2"></span>to <span class="_ _2"></span>socket ﬁle <span class="_ _2"></span>descriptors,</span></span></span></span></span></div><div class="t m0 x11a h4d y5b92 ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _42"> </span>we <span class="_ _53"> </span>don’t <span class="_ _53"> </span>want <span class="_ _42"> </span>a <span class="_ _53"> </span>write <span class="_ _53"> </span>error <span class="_ _42"> </span>to <span class="_ _42"> </span>trigger<span class="_ _44"> </span><span class="ff1a">SIGPIPE</span><span class="ls1778">,b<span class="_ _43"></span><span class="ls0">ecause <span class="_ _42"> </span>the <span class="_ _53"> </span>default</span></span></div><div class="t m0 x11a h49 y5b93 ff19 fs26 fc0 sc0 ls0 ws0">action <span class="_ _23"> </span>is <span class="_ _42"> </span>to <span class="_ _23"> </span>kill <span class="_ _23"> </span>the <span class="_ _42"> </span>process. <span class="_ _35"> </span>Next,<span class="_ _35"> </span>we <span class="_ _23"> </span>set <span class="_ _23"> </span>the <span class="_ _42"> </span>signal <span class="_ _23"> </span>mask <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>thr<span class="_ _0"></span>ead <span class="_ _23"> </span>to</div><div class="t m0 x11a h4d y5b94 ff19 fs26 fc0 sc0 ls0 ws0">include<span class="_ _47"> </span><span class="ff1a">SIGHUP<span class="_ _66"> </span></span>and<span class="_ _47"> </span><span class="ff1a">SIGTERM</span><span class="ls1779">.A<span class="_ _5b"></span><span class="ls0">ll <span class="_ _2"></span>threads <span class="_ _2"></span>we <span class="_ _3"></span>create <span class="_ _2"></span>will <span class="_ _2"></span>inherit <span class="_ _3"></span>this <span class="_ _2"></span>signal</span></span></div><div class="t m0 x11a h4d y5b95 ff19 fs26 fc0 sc0 ls0 ws0">mask. <span class="_ _44"> </span>W<span class="_ _6"></span>e’ll <span class="_ _42"> </span>send <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">SIGHUP<span class="_ _44"> </span></span>signal <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _42"> </span>daemon <span class="_ _42"> </span>to <span class="_ _42"> </span>tell <span class="_ _53"> </span>it <span class="_ _42"> </span>to <span class="_ _42"> </span>rer<span class="_ _0"></span>ead <span class="_ _42"> </span>its</div><div class="t m0 x11a h4d y5b96 ff19 fs26 fc0 sc0 ls0 ws0">conﬁguration <span class="_ _3"></span>ﬁle.<span class="_ _16"> </span><span class="ls164">We<span class="_ _9"></span></span>’ll <span class="_ _3"></span>send <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">SIGTERM<span class="_ _45"> </span></span>signal <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>daemon <span class="_ _3"></span>to <span class="_ _3"></span>tell <span class="_ _3"></span>it <span class="_ _9"></span>to</div><div class="t m0 x11a h49 y5b97 ff19 fs26 fc0 sc0 ls0 ws0">clean up and exit gracefully<span class="_ _4"></span>.</div><div class="t m0 x32 h4d y5b98 ff19 fs26 fc0 sc0 ls0 ws0">[1<span class="_ _1"></span><span class="ls3aa">11 <span class="_ _1"></span>– <span class="_ _1"></span>11<span class="_ _3"></span><span class="ls0">7] <span class="_ _5a"> </span>W<span class="_ _6"></span><span class="ls177a">ec<span class="_ _4f"></span><span class="ls0">all<span class="_ _47"> </span><span class="ff1a">sysconf<span class="_ _47"> </span></span>to <span class="_ _2"></span>get <span class="_ _3"></span>the <span class="_ _2"></span>maximum <span class="_ _3"></span>size <span class="_ _3"></span>of <span class="_ _2"></span>a <span class="_ _3"></span>host <span class="_ _2"></span>name.<span class="_ _16"> </span>If<span class="_ _47"> </span><span class="ff1a">sysconf<span class="_ _47"> </span></span>fails</span></span></span></span></div><div class="t m0 x11a h4d y5b99 ff19 fs26 fc0 sc0 ls0 ws0">or <span class="_ _44"> </span>the <span class="_ _4b"> </span>limit <span class="_ _44"> </span>is <span class="_ _4b"> </span>undeﬁned, <span class="_ _44"> </span>we <span class="_ _4b"> </span>use<span class="_ _65"> </span><span class="ff1a">HOST_NAME_MAX<span class="_ _65"> </span></span>as <span class="_ _44"> </span>a <span class="_ _4b"> </span>best <span class="_ _44"> </span>guess.</div><div class="t m0 x11a h49 y5b9a ff19 fs26 fc0 sc0 ls0 ws0">Sometimes, <span class="_ _3"></span>this <span class="_ _3"></span>constant <span class="_ _9"></span>is <span class="_ _3"></span>deﬁned <span class="_ _3"></span>for <span class="_ _3"></span>us <span class="_ _9"></span>by <span class="_ _3"></span>the <span class="_ _3"></span>platform, <span class="_ _9"></span>but <span class="_ _3"></span>if <span class="_ _3"></span>it <span class="_ _9"></span>isn’t, <span class="_ _3"></span>we</div><div class="t m0 x11a h4d y5b9b ff19 fs26 fc0 sc0 ls0 ws0">chose <span class="_ _53"> </span>our <span class="_ _e"> </span>own <span class="_ _53"> </span>value <span class="_ _e"> </span>in<span class="_ _4b"> </span><span class="ff1a">print.h</span><span class="ls177b">.W<span class="_ _49"></span><span class="ls177c">ea<span class="_ _55"></span><span class="ls0">llocate <span class="_ _e"> </span>memory <span class="_ _53"> </span>to <span class="_ _e"> </span>hold <span class="_ _53"> </span>the <span class="_ _e"> </span>host</span></span></span></div><div class="t m0 x11a h4d y5b9c ff19 fs26 fc0 sc0 ls0 ws0">name and call<span class="_"> </span><span class="ff1a">gethostname<span class="_ _80"> </span></span>to retrieve it.</div><div class="t m0 x32 h49 y5b9d ff19 fs26 fc0 sc0 ls0 ws0">[1<span class="_ _1"></span>18 <span class="_ _a"></span>– <span class="_ _4"></span>121]<span class="_ _65"> </span>Next, <span class="_ _2"></span>we try <span class="_ _2"></span>to ﬁnd <span class="_ _2"></span>the network <span class="_ _2"></span>address that the <span class="_ _2"></span>daemon is <span class="_ _2"></span>supposed to <span class="_ _2"></span>use</div><div class="t m0 x11a h49 y5b9e ff19 fs26 fc0 sc0 ls0 ws0">to provide the printer spooling service.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
