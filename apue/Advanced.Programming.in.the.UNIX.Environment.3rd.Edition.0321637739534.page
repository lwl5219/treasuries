<div id="pf216" class="pf w4 h1f" data-page-no="216"><div class="pc pc216 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg216.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">500<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x35 h53 y12f ff16 fs2b fc0 sc0 ls0 ws0">14.4 <span class="_ _93"> </span>I/O<span class="_ _54"> </span>Multiplexing</div><div class="t m0 x32 h2a y4de ff19 fsf fc0 sc0 ls0 ws0">When <span class="_ _3"></span>we <span class="_ _9"></span>read <span class="_ _2"></span>from <span class="_ _3"></span>one <span class="_ _9"></span>descriptor <span class="_ _3"></span>and <span class="_ _9"></span>write <span class="_ _3"></span>to <span class="_ _9"></span>another<span class="_ _6"></span>,<span class="_ _45"> </span>we<span class="_ _47"> </span>can <span class="_ _9"></span>use <span class="_ _3"></span>blocking <span class="_ _3"></span>I/O <span class="_ _9"></span>in <span class="_ _3"></span>a</div><div class="t m0 x32 h2a y6d0 ff19 fsf fc0 sc0 ls0 ws0">loop, such as</div><div class="t m0 xc2 h57 y2685 ff1a fs2d fc0 sc0 ls0 ws0">while ((n = read(STDIN_FILENO, buf, BUFSIZ)) &gt; 0)</div><div class="t m0 x16e h57 y3d50 ff1a fs2d fc0 sc0 ls0 ws0">if (write(STDOUT_FILENO, buf, n) != n)</div><div class="t m0 xda h57 y3d51 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><div class="t m0 x32 h2a y3d52 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _66"> </span>s<span class="_ _23"></span><span class="ls0">ee <span class="_ _9"></span>this <span class="_ _23"></span>form <span class="_ _9"></span>of <span class="_ _23"></span>blocking <span class="_ _9"></span>I/O <span class="_ _23"></span>over <span class="_ _9"></span>and <span class="_ _23"></span>over <span class="_ _9"></span>again.<span class="_ _51"> </span>What <span class="_ _9"></span>if <span class="_ _23"></span>we <span class="_ _9"></span>have <span class="_ _23"></span>to <span class="_ _9"></span>read <span class="_ _9"></span>from</span></div><div class="t m0 x32 h26 y3d53 ff19 fsf fc0 sc0 ls0 ws0">two <span class="_ _2"></span>descriptors?<span class="_ _16"> </span>In <span class="_ _3"></span>this <span class="_ _3"></span>case, <span class="_ _3"></span>we <span class="_ _2"></span>can’t <span class="_ _3"></span>do <span class="_ _3"></span>a <span class="_ _3"></span>blocking<span class="_ _47"> </span><span class="ff1a">read<span class="_ _47"> </span></span>on <span class="_ _3"></span>either <span class="_ _3"></span>descriptor<span class="_ _6"></span>,<span class="_ _47"> </span>as<span class="_ _47"> </span>data</div><div class="t m0 x32 h26 y3d54 ff19 fsf fc0 sc0 ls0 ws0">may <span class="_ _3"></span>appear <span class="_ _3"></span>on <span class="_ _9"></span>one <span class="_ _3"></span>descriptor <span class="_ _9"></span>while <span class="_ _3"></span>we’r<span class="ls1035">eb<span class="_ _b"></span><span class="ls0">locked <span class="_ _9"></span>in <span class="_ _3"></span>a<span class="_ _45"> </span><span class="ff1a">read<span class="_ _47"> </span></span>on <span class="_ _3"></span>the <span class="_ _9"></span>other<span class="_ _6"></span><span class="ls1036">.A<span class="_ _d"></span><span class="ls0">different</span></span></span></span></div><div class="t m0 x32 h2a y3d55 ff19 fsf fc0 sc0 ls0 ws0">technique is requir<span class="_ _0"></span>ed to handle this case.</div><div class="t m0 x3f h26 y3d56 ff19 fsf fc0 sc0 ls0 ws0">Let’s <span class="_ _23"> </span>look <span class="_ _42"> </span>at <span class="_ _23"> </span>the <span class="_ _42"> </span>structur<span class="ls1037">eo<span class="_ _43"></span><span class="ls302">ft<span class="_ _43"></span><span class="ls0">he<span class="_ _35"> </span><span class="ff1a">telnet</span></span></span></span></div><div class="t m0 x107 h2a y3d57 ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x78 h2a y3d56 ff19 fsf fc0 sc0 ls0 ws0">1</div><div class="t m0 x1fe h2a y3d57 ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x174 h2a y3d56 ff19 fsf fc0 sc0 ls0 ws0">command. <span class="_ _35"> </span>In<span class="_ _35"> </span>this <span class="_ _42"> </span>program, <span class="_ _23"></span>we <span class="_ _23"> </span>read</div><div class="t m0 x32 h2a y3d58 ff19 fsf fc0 sc0 ls0 ws0">from <span class="_ _42"> </span>the <span class="_ _53"> </span>terminal <span class="_ _53"> </span>(standar<span class="ls1038">di<span class="_ _55"></span><span class="ls0">nput) <span class="_ _53"> </span>and <span class="_ _53"> </span>write <span class="_ _53"> </span>to <span class="_ _53"> </span>a <span class="_ _53"> </span>network <span class="_ _53"> </span>connection, <span class="_ _53"> </span>and <span class="_ _53"> </span>we <span class="_ _53"> </span>read</span></span></div><div class="t m0 x32 h2a y3d59 ff19 fsf fc0 sc0 ls0 ws0">from <span class="_ _2"></span>the <span class="_ _3"></span>network <span class="_ _3"></span>connection <span class="_ _9"></span>and <span class="_ _2"></span>write <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>terminal <span class="_ _3"></span>(standar<span class="ls1039">do<span class="_ _b"></span><span class="ls0">utput). <span class="_ _45"> </span>At<span class="_ _47"> </span>the <span class="_ _3"></span>other</span></span></div><div class="t m0 x32 h26 y3d5a ff19 fsf fc0 sc0 ls0 ws0">end <span class="_ _47"> </span>of <span class="_ _45"> </span>the <span class="_ _45"> </span>network <span class="_ _47"> </span>connection, <span class="_ _45"> </span>the<span class="_ _16"> </span><span class="ff1a">telnetd<span class="_"> </span></span>daemon <span class="_ _47"> </span>reads <span class="_ _47"> </span>what <span class="_ _45"> </span>we <span class="_ _47"> </span>typed <span class="_ _45"> </span>and</div><div class="t m0 x32 h26 y3d5b ff19 fsf fc0 sc0 ls0 ws0">presents <span class="_ _42"> </span>it <span class="_ _53"> </span>to <span class="_ _42"> </span>a <span class="_ _53"> </span>shell <span class="_ _53"> </span>as <span class="_ _53"> </span>if <span class="_ _53"> </span>we <span class="_ _53"> </span>wer<span class="ls9ab">el<span class="_ _55"></span><span class="ls0">ogged <span class="_ _53"> </span>in <span class="_ _53"> </span>to <span class="_ _53"> </span>the <span class="_ _53"> </span>remote <span class="_ _42"> </span>machine.<span class="_ _65"> </span>The<span class="_ _44"> </span><span class="ff1a">telnetd</span></span></span></div><div class="t m0 x32 h2a y3d5c ff19 fsf fc0 sc0 ls0 ws0">daemon <span class="_ _3"></span>sends <span class="_ _3"></span>any <span class="_ _3"></span>output <span class="_ _3"></span>generated <span class="_ _3"></span>by <span class="_ _3"></span>the <span class="_ _3"></span>commands <span class="_ _3"></span>we <span class="_ _3"></span>type <span class="_ _3"></span>back <span class="_ _3"></span>to <span class="_ _9"></span>us <span class="_ _2"></span>through <span class="_ _3"></span>the</div><div class="t m0 x32 h26 y3d5d ff1a fsf fc0 sc0 ls0 ws0">telnet<span class="_ _35"> </span><span class="ff19">command, <span class="_ _42"> </span>to <span class="_ _23"> </span>be <span class="_ _42"> </span>displayed <span class="_ _42"> </span>on <span class="_ _23"> </span>our <span class="_ _42"> </span>terminal.<span class="_ _51"> </span>Figur<span class="ls103a">e1<span class="_ _43"></span><span class="ls0">4.13 <span class="_ _42"> </span>shows <span class="_ _23"> </span>a <span class="_ _42"> </span>pictur<span class="ls103a">eo<span class="_ _43"></span><span class="ls0">f</span></span></span></span></span></div><div class="t m0 x32 h2a y3d5e ff19 fsf fc0 sc0 ls0 ws0">this arrangement.</div><div class="t m0 x38 h2d y3d5f ff19 fs10 fc0 sc0 ls0 ws0">user at a</div><div class="t m0 x38 h2d y3d60 ff19 fs10 fc0 sc0 ls0 ws0">terminal</div><div class="t m0 x1d8 h4f y3d61 ff1a fs11 fc0 sc0 ls0 ws0">telnet</div><div class="t m0 x221 h2e y3d62 ff19 fs11 fc0 sc0 ls0 ws0">command</div><div class="t m0 x196 h6d y3d63 ff1a fs12 fc0 sc0 ls0 ws0">telnetd</div><div class="t m0 x97 h2f y3d64 ff19 fs12 fc0 sc0 ls0 ws0">daemon</div><div class="t m0 x27 h70 y3d65 ff18 fs16 fc0 sc0 ls0 ws0">Figure 14.13<span class="_ _5a"> </span><span class="ff19">Overview of<span class="_"> </span><span class="ff1a">telnet<span class="_ _e"> </span></span>program</span></div><div class="t m0 x3f hc8 y3d66 ff19 fs6a fc0 sc0 ls0 ws0">The<span class="_ _66"> </span><span class="ff1a">telnet<span class="_ _66"> </span></span>process <span class="_ _2"></span>has <span class="_ _2"></span>two <span class="_ _2"></span>inputs <span class="_ _2"></span>and <span class="_ _2"></span>two <span class="_ _2"></span>outputs.<span class="_ _61"> </span><span class="ls103b">We <span class="_ _e"> </span>c<span class="_ _9"></span></span>an’t <span class="_ _2"></span>do <span class="_ _2"></span>a <span class="_ _2"></span>blocking<span class="_ _47"> </span><span class="ff1a">read</span></div><div class="t m0 x32 hc5 y3d67 ff19 fs6a fc0 sc0 ls0 ws0">on either of the inputs, as we never know which input will have data for us.</div><div class="t m0 x3f hc5 y3d68 ff19 fs6a fc0 sc0 ls0 ws0">One <span class="_ _23"> </span>way <span class="_ _42"> </span>to <span class="_ _23"> </span>handle <span class="_ _42"> </span>this <span class="_ _23"> </span>particular <span class="_ _42"> </span>problem <span class="_ _23"> </span>is <span class="_ _42"> </span>to <span class="_ _23"> </span>divide <span class="_ _42"> </span>the <span class="_ _23"> </span>process <span class="_ _23"> </span>in <span class="_ _42"> </span>two <span class="_ _23"> </span>pieces</div><div class="t m0 x32 hc8 y3d69 ff19 fs6a fc0 sc0 ls0 ws0">(using<span class="_ _51"> </span><span class="ff1a">fork</span>), <span class="_ _44"> </span>with <span class="_ _35"> </span>each <span class="_ _35"> </span>half <span class="_ _44"> </span>handling <span class="_ _35"> </span>one <span class="_ _35"> </span>direction <span class="_ _35"> </span>of <span class="_ _35"> </span>data.<span class="_ _98"> </span><span class="ls103b">We <span class="_ _5a"> </span>s<span class="_ _9"></span></span>how <span class="_ _35"> </span>this <span class="_ _44"> </span>in</div><div class="t m0 x32 hc8 y3d6a ff19 fs6a fc0 sc0 ls0 ws0">Figur<span class="ls103c">e1<span class="_ _55"></span><span class="ls0">4.14. <span class="_ _4b"> </span>(The<span class="_ _4b"> </span><span class="ff1a">cu</span></span></span></div><div class="t m0 x134 hc5 y3d6b ff19 fs6a fc0 sc0 ls0 ws0">(</div><div class="t m0 x91 hc5 y3d6a ff19 fs6a fc0 sc0 ls0 ws0">1</div><div class="t m0 x8b hc5 y3d6b ff19 fs6a fc0 sc0 ls0 ws0">)</div><div class="t m0 x1e hc8 y3d6a ff19 fs6a fc0 sc0 ls0 ws0">command <span class="_ _53"> </span>provided <span class="_ _53"> </span>with <span class="_ _e"> </span>System <span class="_ _e"> </span>V’s<span class="_ _4b"> </span><span class="ff1a">uucp<span class="_ _4b"> </span></span>communication</div><div class="t m0 x32 hc5 y3d6c ff19 fs6a fc0 sc0 ls0 ws0">package was structur<span class="_ _0"></span>ed like this.)</div><div class="t m0 x38 h83 y3d6d ff19 fs36 fc0 sc0 ls0 ws0">user at a</div><div class="t m0 x38 h83 y3d6e ff19 fs36 fc0 sc0 ls0 ws0">terminal</div><div class="t m0 x196 hcc y3d6f ff1a fs17 fc0 sc0 ls0 ws0">telnetd</div><div class="t m0 x12c h34 y3d70 ff19 fs17 fc0 sc0 ls0 ws0">daemon</div><div class="t m0 xb5 hd4 y3d71 ff1a fs18 fc0 sc0 ls0 ws0">telnet<span class="_ _53"> </span><span class="ff19">command</span></div><div class="t m0 x1d8 h35 y3d72 ff19 fs18 fc0 sc0 ls0 ws0">(parent)</div><div class="t m0 xb5 hd5 y3d73 ff1a fs19 fc0 sc0 ls0 ws0">telnet<span class="_ _53"> </span><span class="ff19">command</span></div><div class="t m0 x10a h36 y3d74 ff19 fs19 fc0 sc0 ls0 ws0">(child)</div><div class="t m0 x9f h128 y3d75 ff18 fs43 fc0 sc0 ls0 ws0">Figure 14.14<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">telnet<span class="_ _e"> </span></span>program using two processes</span></div><div class="t m0 x32 h14f y3d76 ff19 fsb5 fc0 sc0 ls0 ws0">If we <span class="_ _2"></span>use <span class="_ _2"></span>two <span class="_ _2"></span>processes, we <span class="_ _2"></span>can <span class="_ _2"></span>let <span class="_ _2"></span>each <span class="_ _2"></span>process do <span class="_ _2"></span>a blocking<span class="_ _47"> </span><span class="ff1a">read</span><span class="ls103d">.B<span class="_ _5b"></span><span class="ls0">ut <span class="_ _2"></span>this leads <span class="_ _2"></span>to <span class="_ _2"></span>a</span></span></div><div class="t m0 x32 h150 y3d77 ff19 fsb5 fc0 sc0 ls0 ws0">problem <span class="_ _9"></span>when <span class="_ _23"></span>the <span class="_ _9"></span>operation <span class="_ _23"> </span>terminates.<span class="_ _51"> </span>If <span class="_ _9"></span>an <span class="_ _23"> </span>end <span class="_ _23"></span>of <span class="_ _23"></span>ﬁle <span class="_ _9"></span>is <span class="_ _23"> </span>received <span class="_ _9"></span>by <span class="_ _23"> </span>the <span class="_ _23"></span>child <span class="_ _23"></span>(the</div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1236.288916px;width:128.507805px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
