<div id="pf209" class="pf w4 h1f" data-page-no="209"><div class="pc pc209 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg209.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.3<span class="_ _1f7"> </span>Recor<span class="ls30a">dL<span class="_ _55"></span><span class="ls0">ocking<span class="_ _1b"> </span><span class="ff18">487</span></span></span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _59"> </span>p<span class="_ _23"></span><span class="ls45">re<span class="ls0">viously <span class="_ _47"> </span>mentioned <span class="_ _45"> </span>two <span class="_ _47"> </span>types <span class="_ _47"> </span>of <span class="_ _45"> </span>locks: <span class="_ _47"> </span>a <span class="_ _47"> </span>shared <span class="_ _47"> </span>read <span class="_ _47"> </span>lock <span class="_ _47"> </span>(<span class="ff1a">l_type<span class="_ _16"> </span></span>of</span></span></div><div class="t m0 x32 h26 y130 ff1a fsf fc0 sc0 ls0 ws0">F_RDLCK<span class="ff19 ls92e">)a<span class="_ _4f"></span><span class="ls0">nd <span class="_ _2"></span>an <span class="_ _2"></span>exclusive <span class="_ _2"></span>write <span class="_ _3"></span>lock <span class="_ _2"></span>(<span class="ff1a">F_WRLCK</span>). <span class="_ _47"> </span>The<span class="_ _66"> </span>basic <span class="_ _2"></span>rule <span class="_ _2"></span>is <span class="_ _2"></span>that <span class="_ _3"></span>any <span class="_ _2"></span>number <span class="_ _2"></span>of</span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">processes can have <span class="_ _2"></span>a shared read lock <span class="_ _2"></span>on a <span class="_ _2"></span>given <span class="_ _2"></span>byte, but <span class="_ _2"></span>only one <span class="_ _2"></span>process can have <span class="_ _2"></span>an</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">exclusive <span class="_ _9"></span>write <span class="_ _9"></span>lock <span class="_ _9"></span>on <span class="_ _9"></span>a <span class="_ _9"></span>given <span class="_ _23"></span>byte.<span class="_ _16"> </span>Furthermore, <span class="_ _9"></span>if <span class="_ _9"></span>ther<span class="ls248">ea<span class="_ _b"></span><span class="ls45">re <span class="_ _23"></span>o<span class="ls0">ne <span class="_ _23"></span>or <span class="_ _9"></span>mor<span class="ls248">er<span class="_ _43"></span><span class="ls0">ead <span class="_ _9"></span>locks</span></span></span></span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">on <span class="_ _3"></span>a <span class="_ _3"></span>byte, <span class="_ _9"></span>ther<span class="lsb6f">ec<span class="_ _b"></span><span class="ls0">an’t <span class="_ _3"></span>be <span class="_ _9"></span>any <span class="_ _3"></span>write <span class="_ _3"></span>locks <span class="_ _9"></span>on <span class="_ _3"></span>that <span class="_ _3"></span>byte; <span class="_ _9"></span>if <span class="_ _3"></span>there<span class="_ _47"> </span>is<span class="_ _47"> </span>an<span class="_ _45"> </span>exclusive <span class="_ _3"></span>write <span class="_ _3"></span>lock</span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">on <span class="_ _2"></span>a <span class="_ _2"></span>byte, <span class="_ _2"></span>ther<span class="lsfdf">ec<span class="_ _8"></span><span class="ls0">an’t <span class="_ _2"></span>be <span class="_ _3"></span>any <span class="_ _2"></span>read locks <span class="_ _2"></span>on <span class="_ _2"></span>that <span class="_ _2"></span>byte.<span class="_ _61"> </span><span class="ls5f">We <span class="_ _e"> </span>s<span class="_ _23"></span></span>how this <span class="_ _2"></span>compatibility <span class="_ _3"></span>rule in</span></span></div><div class="t m0 x32 h2a y135 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">4.3.</span></span></div><div class="t m0 x178 h51 y2887 ff19 fs2a fc0 sc0 ls0 ws0">Request for</div><div class="t m0 x1d3 h2d y3bb6 ff19 fs10 fc0 sc0 ls21d ws0">re<span class="ls0">ad lock<span class="_ _6e"> </span>write lock</span></div><div class="t m0 x80 h2e y3bb7 ff19 fs11 fc0 sc0 ls0 ws0">OK <span class="_ _7b"> </span>OK<span class="_ _2a2"></span>no locks</div><div class="t m0 x80 h2f y3bb8 ff19 fs12 fc0 sc0 ls0 ws0">OK <span class="_ _7a"> </span>denied<span class="_ _2a3"></span>one or more</div><div class="t m0 x17 h2f y3bb9 ff19 fs12 fc0 sc0 ls222 ws0">re<span class="ls0">ad locks</span></div><div class="t m0 x5d h30 y3bba ff19 fs13 fc0 sc0 ls0 ws0">denied <span class="_ _72"> </span>denied</div><div class="t m0 xda h30 y3bbb ff19 fs13 fc0 sc0 ls0 ws0">Region currently has</div><div class="t m0 x17 h30 y3bba ff19 fs13 fc0 sc0 ls0 ws0">one write</div><div class="t m0 x17 h30 y3bbc ff19 fs13 fc0 sc0 ls0 ws0">lock</div><div class="t m0 x30 h31 y3bbd ff18 fs14 fc0 sc0 ls0 ws0">Figure 14.3<span class="_ _5a"> </span><span class="ff19">Compatibility between different lock types</span></div><div class="t m0 x3f h96 y3bbe ff19 fs49 fc0 sc0 ls0 ws0">The compatibility rule applies <span class="_ _2"></span>to lock <span class="_ _2"></span>requests made from differ<span class="_ _1"></span>ent <span class="_ _2"></span>processes, not to</div><div class="t m0 x32 h96 y3bbf ff19 fs49 fc0 sc0 ls0 ws0">multiple <span class="_ _9"></span>lock <span class="_ _3"></span>requests <span class="_ _9"></span>made <span class="_ _3"></span>by <span class="_ _9"></span>a <span class="_ _9"></span>single <span class="_ _9"></span>process. <span class="_ _47"> </span>If<span class="_ _45"> </span><span class="lsfe0">ap<span class="_ _b"></span><span class="ls4a6">ro<span class="_ _2"></span><span class="ls0">cess <span class="_ _9"></span>has <span class="_ _3"></span>an <span class="_ _9"></span>existing <span class="_ _9"></span>lock <span class="_ _9"></span>on <span class="_ _9"></span>a</span></span></span></div><div class="t m0 x32 h96 y3bc0 ff19 fs49 fc0 sc0 ls0 ws0">range <span class="_ _42"> </span>of <span class="_ _42"> </span>a <span class="_ _42"> </span>ﬁle, <span class="_ _42"> </span>a <span class="_ _42"> </span>subsequent <span class="_ _42"> </span>attempt <span class="_ _42"> </span>to <span class="_ _42"> </span>place <span class="_ _42"> </span>a <span class="_ _42"> </span>lock <span class="_ _42"> </span>on <span class="_ _42"> </span>the <span class="_ _42"> </span>same <span class="_ _42"> </span>range <span class="_ _42"> </span>by <span class="_ _42"> </span>the <span class="_ _42"> </span>same</div><div class="t m0 x32 h96 y3bc1 ff19 fs49 fc0 sc0 ls0 ws0">process <span class="_ _3"></span>will <span class="_ _23"></span>replace <span class="_ _3"></span>the <span class="_ _23"></span>existing <span class="_ _9"></span>lock <span class="_ _9"></span>with <span class="_ _9"></span>the <span class="_ _23"></span>new <span class="_ _9"></span>one.<span class="_ _5a"> </span>Thus, <span class="_ _9"></span>if <span class="_ _23"></span>a <span class="_ _9"></span>process <span class="_ _3"></span>has <span class="_ _23"></span>a <span class="_ _9"></span>write</div><div class="t m0 x32 h96 y3bc2 ff19 fs49 fc0 sc0 ls0 ws0">lock <span class="_ _42"> </span>on <span class="_ _42"> </span>bytes <span class="_ _53"> </span>16</div><div class="t m0 x143 h96 y3bc3 ff19 fs49 fc0 sc0 ls0 ws0">–</div><div class="t m0 xd0 h96 y3bc2 ff19 fs49 fc0 sc0 ls0 ws0">32 <span class="_ _42"> </span>of <span class="_ _42"> </span>a <span class="_ _53"> </span>ﬁle <span class="_ _42"> </span>and <span class="_ _42"> </span>then <span class="_ _53"> </span>tries <span class="_ _42"> </span>to <span class="_ _42"> </span>place <span class="_ _53"> </span>a <span class="_ _42"> </span>read <span class="_ _42"> </span>lock <span class="_ _42"> </span>on <span class="_ _42"> </span>bytes <span class="_ _53"> </span>16</div><div class="t m0 x16d h96 y3bc3 ff19 fs49 fc0 sc0 ls0 ws0">–</div><div class="t m0 x21e h96 y3bc2 ff19 fs49 fc0 sc0 ls0 ws0">32, <span class="_ _42"> </span>the</div><div class="t m0 x32 h96 y3bc4 ff19 fs49 fc0 sc0 ls4a6 ws0">re<span class="ls0">quest will succeed, and the write lock will be replaced by a read lock.</span></div><div class="t m0 x3f h96 y3bc5 ff19 fs49 fc0 sc0 ls9ae ws0">To <span class="_ _45"> </span>o<span class="_ _9"></span><span class="ls0">btain <span class="_ _42"> </span>a <span class="_ _42"> </span>r<span class="_ _0"></span>ead <span class="_ _42"> </span>lock, <span class="_ _42"> </span>the <span class="_ _23"> </span>descriptor <span class="_ _42"> </span>must <span class="_ _42"> </span>be <span class="_ _42"> </span>open <span class="_ _42"> </span>for <span class="_ _42"> </span>reading; <span class="_ _23"> </span>to <span class="_ _42"> </span>obtain <span class="_ _42"> </span>a <span class="_ _42"> </span>write</span></div><div class="t m0 x32 h96 y3bc6 ff19 fs49 fc0 sc0 ls0 ws0">lock, the descriptor must be open for writing.</div><div class="t m0 x3f h9b y3bc7 ff19 fs49 fc0 sc0 ls9ae ws0">We <span class="_ _53"> </span>c<span class="_ _9"></span><span class="ls0">an now describe the three commands for the<span class="_"> </span><span class="ff1a">fcntl<span class="_ _80"> </span></span>function.</span></div><div class="t m0 x32 h9b y3bc8 ff1a fs49 fc0 sc0 ls0 ws0">F_GETLK<span class="_ _1b"> </span><span class="ff19">Determine whether <span class="_ _2"></span>the <span class="_ _2"></span>lock <span class="_ _2"></span>described <span class="_ _2"></span>by<span class="_"> </span><span class="ff1b">ﬂockptr<span class="_ _47"> </span></span>is blocked <span class="_ _2"></span>by <span class="_ _2"></span>some <span class="_ _2"></span>other</span></div><div class="t m0 x13f h96 y3bc9 ff19 fs49 fc0 sc0 ls0 ws0">lock. <span class="_ _59"> </span>If<span class="_ _59"> </span><span class="lsfe1">al<span class="_ _4a"></span><span class="ls0">ock <span class="_"> </span>exists <span class="_"> </span>that <span class="_ _53"> </span>would <span class="_"> </span>prevent <span class="_ _e"> </span>ours <span class="_"> </span>fr<span class="_ _0"></span>om <span class="_"> </span>being <span class="_ _e"> </span>created, <span class="_ _e"> </span>the</span></span></div><div class="t m0 x13f h96 y3bca ff19 fs49 fc0 sc0 ls0 ws0">information on <span class="_ _2"></span>that <span class="_ _2"></span>existing <span class="_ _2"></span>lock <span class="_ _2"></span>overwrites <span class="_ _2"></span>the <span class="_ _2"></span>information <span class="_ _2"></span>pointed <span class="_ _2"></span>to <span class="_ _2"></span>by</div><div class="t m0 x13f h9a y3bcb ff1b fs49 fc0 sc0 ls0 ws0">ﬂockptr<span class="ff19 lsfe2">.I<span class="_ _62"></span><span class="ls0">f<span class="_ _45"> </span>no<span class="_ _47"> </span>lock <span class="_ _9"></span>exists <span class="_ _9"></span>that <span class="_ _3"></span>would <span class="_ _9"></span>prevent <span class="_ _3"></span>ours <span class="_ _9"></span>from <span class="_ _3"></span>being <span class="_ _9"></span>created, <span class="_ _3"></span>the</span></span></div><div class="t m0 x13f h9b y3bcc ff19 fs49 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span><span class="lsfe3">ep<span class="_ _43"></span><span class="ls0">ointed <span class="_ _23"> </span>to <span class="_ _42"> </span>by<span class="_ _44"> </span><span class="ff1b">ﬂockptr<span class="_ _35"> </span></span>is <span class="_ _42"> </span>left <span class="_ _42"> </span>unchanged <span class="_ _42"> </span>except <span class="_ _23"> </span>for <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">l_type</span></span></span></div><div class="t m0 x13f h9b y3bcd ff19 fs49 fc0 sc0 ls0 ws0">member<span class="_ _6"></span><span class="ls48d">,w<span class="_ _5"></span><span class="ls0">hich is set to<span class="_"> </span><span class="ff1a">F_UNLCK</span>.</span></span></div><div class="t m0 x32 h9b y3bce ff1a fs49 fc0 sc0 ls0 ws0">F_SETLK<span class="_ _1b"> </span><span class="ff19">Set <span class="_ _23"> </span>the <span class="_ _42"> </span>lock <span class="_ _42"> </span>described <span class="_ _23"> </span>by<span class="_ _35"> </span><span class="ff1b">ﬂockptr</span><span class="lsfe4">.I<span class="_ _7"></span><span class="ls0">f<span class="_ _44"> </span>we<span class="_ _35"> </span>a<span class="ls4a6">re <span class="_ _53"> </span>t</span>rying <span class="_ _42"> </span>to <span class="_ _42"> </span>obtain <span class="_ _23"> </span>a <span class="_ _42"> </span>read <span class="_ _23"> </span>lock</span></span></span></div><div class="t m0 x13f h9b y3bcf ff19 fs49 fc0 sc0 ls0 ws0">(<span class="ff1a">l_type<span class="_ _46"> </span></span>of<span class="_ _46"> </span><span class="ff1a">F_RDLCK</span>)<span class="_ _46"> </span>or<span class="_ _61"> </span>a<span class="_ _46"> </span>write <span class="_"> </span>lock <span class="_ _66"> </span>(<span class="ff1a">l_type<span class="_ _46"> </span></span>of<span class="_ _61"> </span><span class="ff1a">F_WRLCK</span><span class="lsfe5">)a<span class="_ _5b"></span><span class="ls0">nd <span class="_ _66"> </span>the</span></span></div><div class="t m0 x13f h96 y3bd0 ff19 fs49 fc0 sc0 ls0 ws0">compatibility <span class="_ _51"> </span>rule <span class="_ _5a"> </span>prevents <span class="_ _5a"> </span>the <span class="_ _51"> </span>system <span class="_ _51"> </span>from <span class="_ _5a"> </span>giving <span class="_ _51"> </span>us <span class="_ _51"> </span>the <span class="_ _5a"> </span>lock</div><div class="t m0 x13f h9b y3bd1 ff19 fs49 fc0 sc0 ls0 ws0">(Figur<span class="lsfe6">e1<span class="_ _52"></span><span class="ls0">4.3),<span class="_ _54"> </span><span class="ff1a">fcntl<span class="_ _54"> </span></span><span class="ls4a6">re</span>turns <span class="_ _44"> </span>immediately <span class="_ _44"> </span>with<span class="_ _54"> </span><span class="ff1a">errno<span class="_ _65"> </span></span>set <span class="_ _44"> </span>to <span class="_ _44"> </span>either</span></span></div><div class="t m0 x13f h9b y3bd2 ff1a fs49 fc0 sc0 ls0 ws0">EACCES<span class="_ _80"> </span><span class="ff19">or<span class="_"> </span></span>EAGAIN<span class="ff19">.</span></div><div class="t m0 x38 h31 y3bd3 ff19 fs14 fc0 sc0 ls0 ws0">Although <span class="_"> </span>POSIX <span class="_"> </span>allows <span class="_ _e"> </span>an <span class="_ _e"> </span>implementation <span class="_ _80"> </span>to <span class="_"> </span>return <span class="_"> </span>either <span class="_"> </span>error <span class="_"> </span>code, <span class="_"> </span>all <span class="_"> </span>four</div><div class="t m0 x38 h6f y3bd4 ff19 fs14 fc0 sc0 ls0 ws0">implementations <span class="_ _3"></span>described <span class="_ _9"></span>in <span class="_ _3"></span>this <span class="_ _9"></span>text <span class="_ _9"></span>return<span class="_ _80"> </span><span class="ff1a">EAGAIN<span class="_ _66"> </span></span>if <span class="_ _9"></span>the <span class="_ _9"></span>locking <span class="_ _3"></span>request <span class="_ _3"></span>cannot</div><div class="t m0 x38 h31 y3bd5 ff19 fs14 fc0 sc0 ls0 ws0">be satisﬁed.</div><div class="t m0 x13f h9b y3bd6 ff19 fs49 fc0 sc0 ls0 ws0">This <span class="_ _2"></span>command <span class="_ _2"></span>is <span class="_ _3"></span>also <span class="_ _2"></span>used <span class="_ _2"></span>to <span class="_ _3"></span>clear <span class="_ _2"></span>the <span class="_ _2"></span>lock <span class="_ _2"></span>described <span class="_ _3"></span>by<span class="_ _66"> </span><span class="ff1b">ﬂockptr<span class="_ _47"> </span></span>(<span class="ff1a">l_type</span></div><div class="t m0 x13f h9b y3bd7 ff19 fs49 fc0 sc0 ls0 ws0">of<span class="_"> </span><span class="ff1a">F_UNLCK</span>).</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
