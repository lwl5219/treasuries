<div id="pf1ff" class="pf w4 h1f" data-page-no="1ff"><div class="pc pc1ff w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1ff.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>13.6<span class="_ _29c"> </span>Daemon <span class="_"> </span>Conventions<span class="_ _1b"> </span><span class="ff18">477</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">sigfillset(&amp;mask);</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">if ((err = pthread_sigmask(SIG_BLOCK, &amp;mask, NULL)) != 0)</div><div class="t m0 x9d h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">err_exit(err, &quot;SIG_BLOCK error&quot;);</div><div class="t m0 x8a h57 yae9 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 yaea ff1a fs2d fc0 sc0 ls15c ws0">*C<span class="_ _1d"></span><span class="ls0">reate a thread to handle SIGHUP and SIGTERM.</span></div><div class="t m0 x214 h57 yaeb ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y16f9 ff1a fs2d fc0 sc0 ls0 ws0">err = pthread_create(&amp;tid, NULL, thr_fn, 0);</div><div class="t m0 x8a h57 y16df ff1a fs2d fc0 sc0 ls0 ws0">if (err != 0)</div><div class="t m0 x9d h57 y16e0 ff1a fs2d fc0 sc0 ls0 ws0">err_exit(err, &quot;can’t create thread&quot;);</div><div class="t m0 x8a h57 y340e ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y16fa ff1a fs2d fc0 sc0 ls15c ws0">*P<span class="_ _1d"></span><span class="ls0">roceed with the rest of the daemon.</span></div><div class="t m0 x214 h57 y340f ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y3410 ff1a fs2d fc0 sc0 ls0 ws0">/* ... */</div><div class="t m0 x8a h57 y3411 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y3412 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x18f h2d y3acd ff18 fs10 fc0 sc0 ls0 ws0">Figure 13.7<span class="_ _5a"> </span><span class="ff19">Daemon rereading conﬁguration ﬁles</span></div><div class="t m0 x3f h4d y3ace ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _80"> </span>c<span class="_ _9"></span><span class="ls0">all<span class="_ _47"> </span><span class="ff1a">daemonize<span class="_ _47"> </span></span>from <span class="_ _2"></span>Figur<span class="lsf9d">e1<span class="_ _8"></span><span class="ls0">3.1 <span class="_ _3"></span>to <span class="_ _3"></span>initialize <span class="_ _3"></span>the <span class="_ _3"></span>daemon.<span class="_ _16"> </span>When <span class="_ _3"></span>it <span class="_ _3"></span>returns, <span class="_ _2"></span>we</span></span></span></div><div class="t m0 x32 h4d y3acf ff19 fs26 fc0 sc0 ls0 ws0">call<span class="_ _66"> </span><span class="ff1a">already_running<span class="_ _66"> </span></span>from <span class="_ _2"></span>Figur<span class="ls974">e1<span class="_ _8"></span><span class="ls0">3.6 <span class="_ _2"></span>to <span class="_ _2"></span>ensur<span class="lsf9e">et<span class="_ _4f"></span><span class="ls0">hat <span class="_ _2"></span>only <span class="_ _2"></span>one <span class="_ _2"></span>copy <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>daemon <span class="_ _2"></span>is</span></span></span></span></div><div class="t m0 x32 h4d y3ad0 ff19 fs26 fc0 sc0 ls2b1 ws0">ru<span class="ls0">nning. <span class="_ _35"> </span>At<span class="_ _45"> </span>this <span class="_ _23"></span>point,<span class="_ _45"> </span><span class="ff1a">SIGHUP<span class="_ _35"> </span></span>is <span class="_ _9"></span>still <span class="_ _23"></span>ignored, <span class="_ _9"></span>so <span class="_ _23"></span>we <span class="_ _23"></span>need <span class="_ _9"></span>to <span class="_ _23"> </span>reset <span class="_ _9"></span>the <span class="_ _23"></span>disposition <span class="_ _23"></span>to</span></div><div class="t m0 x32 h4d y3ad1 ff19 fs26 fc0 sc0 ls0 ws0">the default behavior; otherwise, the thread calling<span class="_"> </span><span class="ff1a">sigwait<span class="_ _80"> </span></span>may never see the signal.</div><div class="t m0 x3f h49 y3ad2 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _66"> </span>b<span class="_ _9"></span><span class="ls0">lock <span class="_ _9"></span>all <span class="_ _9"></span>signals, <span class="_ _9"></span>as <span class="_ _23"></span>is <span class="_ _9"></span>recommended <span class="_ _3"></span>for <span class="_ _9"></span>multithreaded <span class="_ _9"></span>programs, <span class="_ _3"></span>and <span class="_ _9"></span>create <span class="_ _9"></span>a</span></div><div class="t m0 x32 h4d y3ad3 ff19 fs26 fc0 sc0 ls0 ws0">thread <span class="_ _23"> </span>to <span class="_ _42"> </span>handle <span class="_ _23"> </span>signals.<span class="_ _54"> </span>The <span class="_ _42"> </span>thread’s <span class="_ _23"></span>only <span class="_ _42"> </span>job <span class="_ _23"> </span>is <span class="_ _42"> </span>to <span class="_ _42"> </span>wait <span class="_ _42"> </span>for<span class="_ _35"> </span><span class="ff1a">SIGHUP<span class="_ _35"> </span></span>and<span class="_ _44"> </span><span class="ff1a">SIGTERM</span>.</div><div class="t m0 x32 h4d y3ad4 ff19 fs26 fc0 sc0 ls0 ws0">When it receives<span class="_"> </span><span class="ff1a">SIGHUP</span><span class="lsf9f">,t<span class="_ _d"></span><span class="ls0">he thread calls<span class="_"> </span><span class="ff1a">reread<span class="_ _80"> </span></span>to reread its conﬁguration ﬁle.<span class="_ _46"> </span>When</span></span></div><div class="t m0 x32 h4d y3ad5 ff19 fs26 fc0 sc0 ls0 ws0">it receives<span class="_"> </span><span class="ff1a">SIGTERM</span><span class="lsd3">,t<span class="_ _4f"></span><span class="ls0">he thread logs a message and exits.</span></span></div><div class="t m0 x3f h4d y3ad6 ff19 fs26 fc0 sc0 ls0 ws0">Recall <span class="_"> </span>from <span class="_"> </span>Figur<span class="_ _1"></span><span class="lsfa0">e1<span class="_ _4a"></span><span class="ls0">0.1 <span class="_"> </span>that <span class="_"> </span>the <span class="_"> </span>default <span class="_"> </span>action <span class="_"> </span>for<span class="_ _46"> </span><span class="ff1a">SIGHUP<span class="_ _59"> </span></span>and<span class="_ _46"> </span><span class="ff1a">SIGTERM<span class="_ _46"> </span></span>is <span class="_"> </span>to</span></span></div><div class="t m0 x32 h49 y3ad7 ff19 fs26 fc0 sc0 ls0 ws0">terminate <span class="_ _23"></span>the <span class="_ _9"></span>process. <span class="_ _45"> </span>Because<span class="_ _35"> </span>we <span class="_ _23"></span>block <span class="_ _9"></span>these <span class="_ _23"> </span>signals, <span class="_ _23"></span>the <span class="_ _23"></span>daemon <span class="_ _9"></span>will <span class="_ _23"> </span>not <span class="_ _23"></span>die <span class="_ _23"></span>when</div><div class="t m0 x32 h4d y3ad8 ff19 fs26 fc0 sc0 ls0 ws0">one <span class="_ _2"></span>of <span class="_ _2"></span>them <span class="_ _2"></span>is <span class="_ _2"></span>sent <span class="_ _3"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>process. <span class="_ _66"> </span>Instead,<span class="_ _47"> </span>the <span class="_ _2"></span>thread calling<span class="_ _47"> </span><span class="ff1a">sigwait<span class="_ _66"> </span></span>will <span class="_ _2"></span>return <span class="_ _2"></span>with</div><div class="t m0 x32 h49 y3ad9 ff19 fs26 fc0 sc0 ls0 ws0">an indication that the signal has been received.</div><div class="t m0 x35 h61 y3ada ff16 fs2c fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h55 y3adb ff19 fs2c fc0 sc0 ls0 ws0">Not <span class="_ _23"></span>all <span class="_ _9"></span>daemons <span class="_ _23"> </span>ar<span class="lsfa1">em<span class="_ _b"></span><span class="ls0">ultithr<span class="_ _1"></span>eaded. <span class="_ _35"> </span>The<span class="_ _35"> </span>pr<span class="_ _0"></span>ogram <span class="_ _23"></span>in <span class="_ _9"></span>Figur<span class="lsfa2">e1<span class="_ _b"></span><span class="ls0">3.8 <span class="_ _9"></span>shows <span class="_ _23"> </span>how <span class="_ _23"></span>a <span class="_ _23"></span>single-</span></span></span></span></div><div class="t m0 x32 h54 y3adc ff19 fs2c fc0 sc0 ls0 ws0">threaded daemon can catch<span class="_"> </span><span class="ff1a">SIGHUP<span class="_ _80"> </span></span>and rer<span class="_ _1"></span>ead its conﬁguration ﬁle.</div><div class="t m0 x32 h62 y3add ff1a fs30 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h62 y3ade ff1a fs30 fc0 sc0 ls0 ws0">#include &lt;syslog.h&gt;</div><div class="t m0 x32 h62 y3adf ff1a fs30 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h62 y3ae0 ff1a fs30 fc0 sc0 ls0 ws0">extern int lockfile(int);</div><div class="t m0 x32 h62 y3ae1 ff1a fs30 fc0 sc0 ls0 ws0">extern int already_running(void);</div><div class="t m0 x32 h62 y3ae2 ff1a fs30 fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h62 y3ae3 ff1a fs30 fc0 sc0 ls0 ws0">reread(void)</div><div class="t m0 x32 h62 y3ae4 ff1a fs30 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h62 y3ae5 ff1a fs30 fc0 sc0 ls0 ws0">/* ... */</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
