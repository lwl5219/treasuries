<div id="pf3b7" class="pf w4 h1f" data-page-no="3b7"><div class="pc pc3b7 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg3b7.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Appendix <span class="_"> </span>C<span class="_ _322"> </span>Chapter <span class="_"> </span>5<span class="_ _54"> </span>Solutions<span class="_ _1b"> </span><span class="ff18">917</span></div><div class="t m0 xc4 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">if (ms-&gt;curpos &gt; ms-&gt;vsize) {</div><div class="t m0 x206 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;vsize = ms-&gt;curpos;</div><div class="t m0 x206 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">if (((ms-&gt;flags &amp; (MS_READ|MS_WRITE)) ==</div><div class="t m0 x132 h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">(MS_READ|MS_WRITE)) &amp;&amp; (ms-&gt;vsize &lt; ms-&gt;rsize))</div><div class="t m0 xe9 h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">*(ms-&gt;buf + ms-&gt;vsize) = 0;</div><div class="t m0 xc4 h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">if ((ms-&gt;flags &amp; (MS_WRITE|MS_APPEND)) &amp;&amp;</div><div class="t m0 x1b0 h57 y805 ff1a fs2d fc0 sc0 ls0 ws0">!(ms-&gt;flags &amp; MS_READ)) {</div><div class="t m0 x206 h57 y806 ff1a fs2d fc0 sc0 ls0 ws0">if (ms-&gt;curpos &lt; ms-&gt;rsize)</div><div class="t m0 xe9 h57 y807 ff1a fs2d fc0 sc0 ls0 ws0">*(ms-&gt;buf + ms-&gt;curpos) = 0;</div><div class="t m0 x206 h57 y808 ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 xe9 h57 y809 ff1a fs2d fc0 sc0 ls0 ws0">*(ms-&gt;buf + ms-&gt;rsize - 1) = 0;</div><div class="t m0 xc4 h57 y80a ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y80b ff1a fs2d fc0 sc0 ls0 ws0">return(nw);</div><div class="t m0 x215 h57 y80c ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x215 h57 y31bb ff1a fs2d fc0 sc0 ls0 ws0">static fpos_t</div><div class="t m0 x215 h57 y2f71 ff1a fs2d fc0 sc0 ls0 ws0">mstream_seek(void *cookie, fpos_t pos, int whence)</div><div class="t m0 x215 h57 y2f72 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 xc4 h57 y2f73 ff1a fs2d fc0 sc0 ls0 ws0">int off;</div><div class="t m0 xc4 h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">struct memstream *ms = cookie;</div><div class="t m0 xc4 h57 y351f ff1a fs2d fc0 sc0 ls0 ws0">switch (whence) {</div><div class="t m0 xc4 h57 y3520 ff1a fs2d fc0 sc0 ls0 ws0">case SEEK_SET:</div><div class="t m0 x206 h57 y42b2 ff1a fs2d fc0 sc0 ls0 ws0">off = pos;</div><div class="t m0 x206 h57 y42b3 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 xc4 h57 y42b4 ff1a fs2d fc0 sc0 ls0 ws0">case SEEK_END:</div><div class="t m0 x206 h57 y38bf ff1a fs2d fc0 sc0 ls0 ws0">off = ms-&gt;vsize + pos;</div><div class="t m0 x206 h57 y38c0 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 xc4 h57 y38c1 ff1a fs2d fc0 sc0 ls0 ws0">case SEEK_CUR:</div><div class="t m0 x206 h57 y42b5 ff1a fs2d fc0 sc0 ls0 ws0">off = ms-&gt;curpos + pos;</div><div class="t m0 x206 h57 y3f7e ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 xc4 h57 y3f7f ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y3f80 ff1a fs2d fc0 sc0 ls0 ws0">if (off &lt; 0 || off &gt; ms-&gt;vsize) {</div><div class="t m0 x206 h57 y3f81 ff1a fs2d fc0 sc0 ls0 ws0">errno = EINVAL;</div><div class="t m0 x206 h57 y2f7f ff1a fs2d fc0 sc0 ls0 ws0">return -1;</div><div class="t m0 xc4 h57 y2f80 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y3f82 ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;curpos = off;</div><div class="t m0 xc4 h57 y3f83 ff1a fs2d fc0 sc0 ls0 ws0">return(off);</div><div class="t m0 x215 h57 y3f84 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x215 h57 y338d ff1a fs2d fc0 sc0 ls0 ws0">static int</div><div class="t m0 x215 h57 y338e ff1a fs2d fc0 sc0 ls0 ws0">mstream_close(void *cookie)</div><div class="t m0 x215 h57 y342a ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 xc4 h57 y342b ff1a fs2d fc0 sc0 ls0 ws0">struct memstream *ms = cookie;</div><div class="t m0 xc4 h57 y1350 ff1a fs2d fc0 sc0 ls0 ws0">if (ms-&gt;flags &amp; MS_MYBUF)</div><div class="t m0 x206 h57 y1351 ff1a fs2d fc0 sc0 ls0 ws0">free(ms-&gt;buf);</div><div class="t m0 xc4 h57 y1352 ff1a fs2d fc0 sc0 ls0 ws0">free(ms);</div><div class="t m0 xc4 h57 y1353 ff1a fs2d fc0 sc0 ls0 ws0">return(0);</div><div class="t m0 x215 h57 y4de1 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xab h5e y60af ff18 fs10 fc0 sc0 ls0 ws0">Figure C.4<span class="_ _5a"> </span><span class="ff19">Implementation of<span class="_"> </span><span class="ff1a">fmemopen<span class="_ _e"> </span></span>for BSD systems</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
