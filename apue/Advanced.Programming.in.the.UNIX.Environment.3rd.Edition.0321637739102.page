<div id="pf66" class="pf w4 h1f" data-page-no="66"><div class="pc pc66 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg66.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">68<span class="_ _1b"> </span><span class="ff19">File <span class="_"> </span>I/O<span class="_ _169"> </span>Chapter <span class="_"> </span>3</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">If we invoke this program interactively<span class="_ _4"></span>,<span class="_"> </span>we<span class="_"> </span>get</div><div class="t m0 x3f h57 ya9b ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out &lt; /etc/passwd</span></div><div class="t m0 x3f h57 yac1 ff1a fs2d fc0 sc0 ls0 ws0">seek OK</div><div class="t m0 x3f h57 yac2 ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">cat &lt; /etc/passwd | ./a.out</span></div><div class="t m0 x3f h57 yac3 ff1a fs2d fc0 sc0 ls0 ws0">cannot seek</div><div class="t m0 x3f h57 yac4 ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out &lt; /var/spool/cron/FIFO</span></div><div class="t m0 x3f h57 yac5 ff1a fs2d fc0 sc0 ls0 ws0">cannot seek</div><div class="t m0 x3f h49 yac6 ff19 fs26 fc0 sc0 ls0 ws0">Normally<span class="_ _4"></span><span class="ls38b">,aﬁ<span class="_ _4a"></span><span class="ls0">le’s <span class="_"> </span>current <span class="_"> </span>offset <span class="_"> </span>must <span class="_ _66"> </span>be <span class="_ _66"> </span>a <span class="_ _66"> </span>non-negative <span class="_ _66"> </span>integer<span class="_ _1"></span><span class="ls38c">.I<span class="_ _49"></span><span class="ls0">t<span class="_ _46"> </span>is<span class="_ _61"> </span>possible,</span></span></span></span></div><div class="t m0 x32 h49 yac7 ff19 fs26 fc0 sc0 ls0 ws0">however<span class="_ _6"></span><span class="ls38d">,t<span class="_ _c"></span><span class="ls0">hat <span class="_ _53"> </span>certain <span class="_ _e"> </span>devices <span class="_ _e"> </span>could <span class="_ _53"> </span>allow <span class="_ _e"> </span>negative <span class="_ _e"> </span>offsets. <span class="_ _44"> </span>But<span class="_ _4b"> </span>for <span class="_ _e"> </span>regular <span class="_ _53"> </span>ﬁles, <span class="_ _e"> </span>the</span></span></div><div class="t m0 x32 h49 yac8 ff19 fs26 fc0 sc0 ls0 ws0">offset must be <span class="_ _2"></span>non-negative.<span class="_ _46"> </span>Because <span class="_ _2"></span>negative offsets ar<span class="ls38e">ep<span class="_ _4f"></span><span class="ls0">ossible, <span class="_ _2"></span>we should <span class="_ _2"></span>be careful</span></span></div><div class="t m0 x32 h4d yac9 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _23"> </span>compar<span class="ls38f">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>return <span class="_ _23"> </span>value <span class="_ _42"> </span>from<span class="_ _35"> </span><span class="ff1a">lseek<span class="_ _35"> </span></span>as <span class="_ _23"> </span>being <span class="_ _42"> </span>equal <span class="_ _23"> </span>to <span class="_ _42"> </span>or <span class="_ _42"> </span>not <span class="_ _23"> </span>equal <span class="_ _42"> </span>to<span class="_ _35"> </span><span class="ff20">−</span>1, <span class="_ _23"> </span>rather</span></span></div><div class="t m0 x32 h49 yaca ff19 fs26 fc0 sc0 ls0 ws0">than testing whether it is less than 0.</div><div class="t m0 x76 h5e yacb ff19 fs10 fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1a">/dev/kmem<span class="_ _53"> </span></span>device on FreeBSD for the Intel x86 processor supports negative offsets.</div><div class="t m0 x76 h5e yacc ff19 fs10 fc0 sc0 ls0 ws0">Because <span class="_ _23"> </span>the <span class="_ _42"> </span>offset <span class="_ _23"> </span>(<span class="ff1a">off_t</span>)<span class="_ _45"> </span>is<span class="_ _45"> </span>a<span class="_ _45"> </span>signed <span class="_ _42"> </span>data <span class="_ _23"> </span>type <span class="_ _42"> </span>(Figur<span class="ls390">e2<span class="_ _b"></span><span class="ls0">.21), <span class="_ _23"> </span>we <span class="_ _42"> </span>lose <span class="_ _23"> </span>a <span class="_ _42"> </span>factor <span class="_ _42"> </span>of <span class="_ _23"> </span>2 <span class="_ _42"> </span>in <span class="_ _42"> </span>the</span></span></div><div class="t m0 x76 h5e yacd ff19 fs10 fc0 sc0 ls0 ws0">maximum ﬁle size.<span class="_ _35"> </span>If<span class="_"> </span><span class="ff1a">off_t<span class="_ _e"> </span></span>is a 32</div><div class="t m0 x154 h2d yace ff19 fs10 fc0 sc0 ls0 ws0">-</div><div class="t m0 x10a h2d yacd ff19 fs10 fc0 sc0 ls0 ws0">bit integer<span class="_ _1"></span><span class="ls136">,t<span class="_ _84"></span><span class="ls0">he maximum ﬁle size is 2</span></span></div><div class="t m0 x11d h7e yacf ff19 fs3c fc0 sc0 ls0 ws0">31</div><div class="t m0 x120 h2d yad0 ff20 fs10 fc0 sc0 ls0 ws0">−<span class="ff19 ls136">1b<span class="_ _84"></span><span class="ls0">ytes.</span></span></div><div class="t m0 x3f h4d yad1 ff1a fs26 fc0 sc0 ls0 ws0">lseek<span class="_ _47"> </span><span class="ff19">only <span class="_ _9"></span>recor<span class="_ _0"></span>ds <span class="_ _3"></span>the <span class="_ _3"></span>current <span class="_ _3"></span>ﬁle <span class="_ _9"></span>offset <span class="_ _2"></span>within <span class="_ _9"></span>the <span class="_ _3"></span>kernel<span class="_ _9"></span><span class="ls161">—i<span class="_ _1"></span><span class="ls391">td<span class="_ _b"></span><span class="ls0">oes <span class="_ _9"></span>not <span class="_ _3"></span>cause <span class="_ _9"></span>any</span></span></span></span></div><div class="t m0 x32 h49 yad2 ff19 fs26 fc0 sc0 ls0 ws0">I/O to take place.<span class="_ _59"> </span>This offset is then used by the next read or write operation.</div><div class="t m0 x3f h49 yad3 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _42"> </span>ﬁle’s <span class="_ _42"> </span>offset <span class="_ _23"> </span>can <span class="_ _42"> </span>be <span class="_ _42"> </span>greater <span class="_ _23"> </span>than <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle’s <span class="_ _42"> </span>current <span class="_ _23"> </span>size, <span class="_ _42"> </span>in <span class="_ _42"> </span>which <span class="_ _42"> </span>case <span class="_ _42"> </span>the <span class="_ _42"> </span>next</div><div class="t m0 x32 h4d yad4 ff1a fs26 fc0 sc0 ls0 ws0">write<span class="_ _66"> </span><span class="ff19">to the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>will extend <span class="_ _2"></span>the ﬁle.<span class="_ _61"> </span>This <span class="_ _2"></span>is referred to as <span class="_ _2"></span>creating a <span class="_ _2"></span>hole in <span class="_ _2"></span>a ﬁle <span class="_ _2"></span>and <span class="_ _2"></span>is</span></div><div class="t m0 x32 h49 yad5 ff19 fs26 fc0 sc0 ls0 ws0">allowed. <span class="_"> </span>Any<span class="_"> </span>bytes in a ﬁle that have not been written ar<span class="lsd3">er<span class="_ _4f"></span><span class="ls0">ead back as 0.</span></span></div><div class="t m0 x3f h49 yad6 ff19 fs26 fc0 sc0 ls392 ws0">Ah<span class="_ _8"></span><span class="ls0">ole <span class="_ _3"></span>in <span class="_ _3"></span>a <span class="_ _3"></span>ﬁle <span class="_ _3"></span>isn’t <span class="_ _3"></span>requir<span class="_ _1"></span>ed <span class="_ _3"></span>to <span class="_ _3"></span>have <span class="_ _3"></span>storage <span class="_ _3"></span>backing <span class="_ _3"></span>it <span class="_ _3"></span>on <span class="_ _3"></span>disk.<span class="_ _61"> </span>Depending <span class="_ _3"></span>on <span class="_ _3"></span>the</span></div><div class="t m0 x32 h49 yad7 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle <span class="_ _23"> </span>system <span class="_ _42"> </span>implementation, <span class="_ _42"> </span>when <span class="_ _23"> </span>you <span class="_ _42"> </span>write <span class="_ _42"> </span>after <span class="_ _42"> </span>seeking <span class="_ _23"> </span>past <span class="_ _42"> </span>the <span class="_ _42"> </span>end <span class="_ _23"> </span>of <span class="_ _42"> </span>a <span class="_ _42"> </span>ﬁle, <span class="_ _23"> </span>new</div><div class="t m0 x32 h49 yad8 ff19 fs26 fc0 sc0 ls0 ws0">disk <span class="_ _23"> </span>blocks <span class="_ _42"> </span>might <span class="_ _23"> </span>be <span class="_ _42"> </span>allocated <span class="_ _23"> </span>to <span class="_ _42"> </span>stor<span class="ls393">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"></span>data, <span class="_ _23"> </span>but <span class="_ _42"> </span>there<span class="_ _35"> </span>is<span class="_ _35"> </span>n<span class="ls394">on<span class="_ _43"></span><span class="ls0">eed <span class="_ _23"> </span>to <span class="_ _42"> </span>allocate <span class="_ _23"> </span>disk</span></span></span></span></div><div class="t m0 x32 h49 yad9 ff19 fs26 fc0 sc0 ls0 ws0">blocks for the data between the old end of ﬁle and the location wher<span class="lsd3">ey<span class="_ _4f"></span><span class="ls0">ou start writing.</span></span></div><div class="t m0 x35 h4c yada ff16 fs26 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h49 yadb ff19 fs26 fc0 sc0 ls0 ws0">The program shown in Figur<span class="_ _0"></span><span class="lsd3">e3<span class="_ _d"></span><span class="ls0">.2 creates a ﬁle with a hole in it.</span></span></div><div class="t m0 x32 h5d yadc ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h5d yadd ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h5d yade ff1a fs2f fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>buf1[]<span class="_"> </span><span class="ls395">=&quot;<span class="_ _5b"></span><span class="ls0">abcdefghij&quot;;</span></span></div><div class="t m0 x32 h5d yadf ff1a fs2f fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>buf2[]<span class="_"> </span><span class="ls395">=&quot;<span class="_ _5b"></span><span class="ls0">ABCDEFGHIJ&quot;;</span></span></div><div class="t m0 x32 h5d yae0 ff1a fs2f fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h5d yae1 ff1a fs2f fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h5d yae2 ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d yae3 ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>fd;</div><div class="t m0 x8a h5d yae4 ff1a fs2f fc0 sc0 ls0 ws0">if ((fd = creat(&quot;file.hole&quot;, FILE_MODE)) &lt; 0)</div><div class="t m0 x9d h5d yae5 ff1a fs2f fc0 sc0 ls0 ws0">err_sys(&quot;creat error&quot;);</div><div class="t m0 x8a h5d yae6 ff1a fs2f fc0 sc0 ls0 ws0">if (write(fd, buf1, 10) != 10)</div><div class="t m0 x9d h5d yae7 ff1a fs2f fc0 sc0 ls0 ws0">err_sys(&quot;buf1 write error&quot;);</div><div class="t m0 x8a h5d yae8 ff1a fs2f fc0 sc0 ls0 ws0">/* offset now = 10 */</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
