<div id="pf323" class="pf w4 h1f" data-page-no="323"><div class="pc pc323 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg323.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">769</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">412 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">413 <span class="_ _68"> </span>*<span class="_"> </span>Delete the current record specified by the DB structure.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">414 <span class="_ _68"> </span>*<span class="_"> </span>This function is called by db_delete and db_store, after</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">415 <span class="_ _68"> </span>*<span class="_"> </span>the record has been located by _db_find_and_lock.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">416 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">417 <span class="_ _d9"> </span>static<span class="_"> </span>void</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">418 <span class="_ _d9"> </span>_db_dodelete(DB<span class="_"> </span>*db)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">419 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">420 <span class="_ _15"> </span>int <span class="_ _15"> </span>i;</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">421 <span class="_ _15"> </span>char<span class="_ _15"> </span>*ptr;</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">422 <span class="_ _15"> </span>off_t<span class="_ _68"> </span>freeptr, saveptr;</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">423 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">424 <span class="_ _8a"> </span>*<span class="_"> </span>Set data buffer and key to all blanks.</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">425 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">426 <span class="_ _15"> </span>for<span class="_"> </span>(ptr = db-&gt;datbuf, i = 0; i &lt; db-&gt;datlen - 1; i++)</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">427 <span class="_ _186"> </span>*ptr++<span class="_"> </span><span class="ls15c">=S<span class="_ _1d"></span><span class="ls0">PACE;</span></span></div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">428 <span class="_ _15"> </span>*ptr<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="lsa73">;/<span class="_ _244"></span><span class="ls15c">*n<span class="_ _1d"></span><span class="ls0">ull terminate for _db_writedat */</span></span></span></span></div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">429 <span class="_ _15"> </span>ptr<span class="_"> </span><span class="ls15c">=d<span class="_ _1d"></span><span class="ls0">b-&gt;idxbuf;</span></span></div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">430 <span class="_ _15"> </span>while<span class="_"> </span>(*ptr)</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">431 <span class="_ _186"> </span>*ptr++<span class="_"> </span><span class="ls15c">=S<span class="_ _1d"></span><span class="ls0">PACE;</span></span></div><div class="t m0 x32 h57 y33b5 ff1a fs2d fc0 sc0 ls0 ws0">432 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">433 <span class="_ _8a"> </span>*<span class="_"> </span>We have to lock the free list.</div><div class="t m0 x32 h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">434 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">435 <span class="_ _15"> </span>if<span class="_"> </span>(writew_lock(db-&gt;idxfd, FREE_OFF, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">436 <span class="_ _186"> </span>err_dump(&quot;_db_dodelete:<span class="_"> </span>writew_lock error&quot;);</div><div class="t m0 x32 h57 y5752 ff1a fs2d fc0 sc0 ls0 ws0">437 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y5753 ff1a fs2d fc0 sc0 ls0 ws0">438 <span class="_ _8a"> </span>*<span class="_"> </span>Write the data record with all blanks.</div><div class="t m0 x32 h57 y5754 ff1a fs2d fc0 sc0 ls0 ws0">439 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y5755 ff1a fs2d fc0 sc0 ls0 ws0">440 <span class="_ _15"> </span>_db_writedat(db,<span class="_"> </span>db-&gt;datbuf, db-&gt;datoff, SEEK_SET);</div><div class="t m0 x32 h4d y57be ff19 fs26 fc0 sc0 ls0 ws0">[412 <span class="_ _a"></span>– <span class="_ _a"></span>431]<span class="_ _65"> </span>The<span class="_ _47"> </span><span class="ff1a">_db_dodelete<span class="_ _47"> </span></span>function <span class="_ _9"></span>does <span class="_ _3"></span>all <span class="_ _3"></span>the <span class="_ _3"></span>work <span class="_ _9"></span>necessary <span class="_ _3"></span>to <span class="_ _3"></span>delete <span class="_ _3"></span>a <span class="_ _3"></span>record</div><div class="t m0 x11a h4d y57bf ff19 fs26 fc0 sc0 ls0 ws0">from <span class="_ _2"></span>the <span class="_ _9"></span>database.<span class="_ _16"> </span>(This <span class="_ _9"></span>function <span class="_ _3"></span>is <span class="_ _3"></span>also <span class="_ _9"></span>called <span class="_ _3"></span>by<span class="_ _45"> </span><span class="ff1a">db_store</span>.) <span class="_ _47"> </span>Most<span class="_ _45"> </span>of <span class="_ _2"></span>the</div><div class="t m0 x11a h49 y57c0 ff19 fs26 fc0 sc0 ls0 ws0">function just <span class="_ _2"></span>updates <span class="_ _2"></span>two <span class="_ _2"></span>linked <span class="_ _2"></span>lists: the <span class="_ _2"></span>free list <span class="_ _2"></span>and <span class="_ _2"></span>the <span class="_ _2"></span>hash chain <span class="_ _2"></span>for <span class="_ _2"></span>this</div><div class="t m0 x11a h49 y57c1 ff19 fs26 fc0 sc0 ls0 ws0">key<span class="_ _4"></span><span class="ls169d">.W<span class="_ _4a"></span><span class="ls0">hen a <span class="_ _2"></span>recor<span class="_ _0"></span>d<span class="_"> </span>is<span class="_"> </span>deleted, <span class="_ _2"></span>we <span class="_ _2"></span>set its <span class="_ _2"></span>key and <span class="_ _2"></span>data record<span class="_"> </span>to<span class="_"> </span>blanks. <span class="_ _66"> </span>This</span></span></div><div class="t m0 x11a h4d y57c2 ff19 fs26 fc0 sc0 ls0 ws0">fact is used by<span class="_"> </span><span class="ff1a">db_nextrec</span><span class="lsd3">,w<span class="_ _d"></span><span class="ls0">hich we’ll examine later in this section.</span></span></div><div class="t m0 x32 h4d y57c3 ff19 fs26 fc0 sc0 ls0 ws0">[432 <span class="_ _a"></span>– <span class="_ _a"></span>440]<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>c<span class="_ _9"></span></span>all<span class="_ _4b"> </span><span class="ff1a">writew_lock<span class="_ _44"> </span></span>to <span class="_ _e"> </span>write <span class="_ _53"> </span>lock <span class="_ _e"> </span>the <span class="_ _53"> </span>free <span class="_ _53"> </span>list.<span class="_ _65"> </span>This <span class="_ _53"> </span>step <span class="_ _e"> </span>prevents <span class="_ _42"> </span>two</div><div class="t m0 x11a h49 y57c4 ff19 fs26 fc0 sc0 ls0 ws0">processes <span class="_ _9"></span>that <span class="_ _23"> </span>ar<span class="ls169e">ed<span class="_ _43"></span><span class="ls0">eleting <span class="_ _23"> </span>records <span class="_ _9"></span>at <span class="_ _23"></span>the <span class="_ _23"></span>same <span class="_ _23"></span>time, <span class="_ _23"></span>on <span class="_ _23"></span>two <span class="_ _9"></span>different <span class="_ _9"></span>hash</span></span></div><div class="t m0 x11a h49 y57c5 ff19 fs26 fc0 sc0 ls0 ws0">chains, <span class="_ _3"></span>from <span class="_ _9"></span>interfering <span class="_ _3"></span>with <span class="_ _9"></span>each <span class="_ _9"></span>other<span class="_ _6"></span><span class="ls7ae">.S<span class="_ _1d"></span><span class="ls0">ince <span class="_ _3"></span>we’ll <span class="_ _9"></span>add <span class="_ _9"></span>the <span class="_ _9"></span>deleted <span class="_ _3"></span>record</span></span></div><div class="t m0 x11a h49 y57c6 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _2"></span>the <span class="_ _2"></span>free list, <span class="_ _2"></span>which <span class="_ _2"></span>changes <span class="_ _2"></span>the <span class="_ _2"></span>free-list <span class="_ _2"></span>pointer<span class="_ _6"></span><span class="ls1187">,o<span class="_ _d"></span><span class="ls0">nly <span class="_ _2"></span>one <span class="_ _2"></span>process at <span class="_ _2"></span>a <span class="_ _2"></span>time</span></span></div><div class="t m0 x11a h49 y57c7 ff19 fs26 fc0 sc0 ls0 ws0">can be doing this.</div><div class="t m0 x11a h4d y57c8 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _35"> </span>w<span class="_ _9"></span><span class="ls0">rite <span class="_ _e"> </span>the <span class="_ _e"> </span>all-blank <span class="_ _e"> </span>data <span class="_ _e"> </span>record<span class="_ _44"> </span>by<span class="_ _59"> </span>calling<span class="_ _4b"> </span><span class="ff1a">_db_writedat</span><span class="ls169f">.N<span class="_ _64"></span><span class="ls0">ote <span class="_ _e"> </span>that</span></span></span></div><div class="t m0 x11a h4d y57c9 ff19 fs26 fc0 sc0 ls0 ws0">there<span class="_ _47"> </span>is<span class="_ _45"> </span>no<span class="_ _45"> </span>need <span class="_ _9"></span>for<span class="_ _45"> </span><span class="ff1a">_db_writedat<span class="_ _45"> </span></span>to <span class="_ _9"></span>lock <span class="_ _9"></span>the <span class="_ _9"></span>data <span class="_ _9"></span>ﬁle <span class="_ _23"></span>in <span class="_ _9"></span>this <span class="_ _9"></span>case.<span class="_ _5a"> </span>Since</div><div class="t m0 x11a h4d y57ca ff1a fs26 fc0 sc0 ls0 ws0">db_delete<span class="_ _80"> </span><span class="ff19">has write locked <span class="_ _2"></span>the hash chain for this record, we know that no</span></div><div class="t m0 x11a h49 y57cb ff19 fs26 fc0 sc0 ls0 ws0">other process is r<span class="_ _0"></span>eading or writing this particular data r<span class="_ _0"></span>ecord.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
