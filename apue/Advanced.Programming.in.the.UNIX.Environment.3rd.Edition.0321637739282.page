<div id="pf11a" class="pf w4 h1f" data-page-no="11a"><div class="pc pc11a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg11a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">248<span class="_ _1b"> </span><span class="ff19">Process <span class="_"> </span>Contr<span class="_ _0"></span>ol <span class="_ _222"> </span>Chapter<span class="_ _4b"> </span>8</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">mean <span class="_ _9"></span>that <span class="_ _9"></span>the <span class="_ _9"></span>race <span class="_ _9"></span>condition <span class="_ _9"></span>doesn’t <span class="_ _23"></span>exist; <span class="_ _9"></span>it <span class="_ _9"></span>simply <span class="_ _9"></span>means <span class="_ _9"></span>that <span class="_ _9"></span>we <span class="_ _9"></span>can’t <span class="_ _9"></span>see <span class="_ _9"></span>it <span class="_ _23"></span>on <span class="_ _9"></span>this</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">particular system.)<span class="_ _59"> </span>The following actual output shows how the results can vary:</div><div class="t m0 x3f h57 y1c09 ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h57 y1c0a ff1a fs2d fc0 sc0 ls0 ws0">ooutput from child</div><div class="t m0 x3f h57 y1c0b ff1a fs2d fc0 sc0 ls0 ws0">utput from parent</div><div class="t m0 x3f h57 y1c0c ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h57 y1c0d ff1a fs2d fc0 sc0 ls0 ws0">ooutput from child</div><div class="t m0 x3f h57 y1c0e ff1a fs2d fc0 sc0 ls0 ws0">utput from parent</div><div class="t m0 x3f h57 y1d56 ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h57 y1d57 ff1a fs2d fc0 sc0 ls0 ws0">output from child</div><div class="t m0 x3f h57 y1d58 ff1a fs2d fc0 sc0 ls0 ws0">output from parent</div><div class="t m0 x32 h26 y20af ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>n<span class="_ _9"></span><span class="ls0">eed <span class="_ _2"></span>to change <span class="_ _2"></span>the program in Figur<span class="ls9d9">e8<span class="_ _4f"></span><span class="ls0">.12 <span class="_ _2"></span>to use the<span class="_ _66"> </span><span class="ff1a">TELL<span class="_ _66"> </span></span>and<span class="_"> </span><span class="ff1a">WAIT<span class="_ _66"> </span></span>functions. <span class="_"> </span>The</span></span></span></div><div class="t m0 x32 h2a y20b0 ff19 fsf fc0 sc0 ls0 ws0">program in Figur<span class="_ _0"></span><span class="ls44">e8<span class="_ _d"></span><span class="ls0">.13 does this.<span class="_ _46"> </span>The lines preceded by a plus sign ar<span class="_ _0"></span><span class="ls44">en<span class="_ _d"></span><span class="ls0">ew lines.</span></span></span></span></div><div class="t m0 xb8 h4e y20b1 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 xb8 h4e y20b2 ff1a fs28 fc0 sc0 ls0 ws0">static void charatatime(char *);</div><div class="t m0 xb8 h4e y20b3 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 xb8 h4e y20b4 ff1a fs28 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 xb8 h4e y20b5 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x194 h4e y20b6 ff1a fs28 fc0 sc0 ls0 ws0">pid_t <span class="_ _d9"> </span>pid;</div><div class="t m0 x32 h4e y20b7 ff1a fs28 fc0 sc0 ls1b7 ws0">+T<span class="_ _91"></span><span class="ls0">ELL_WAIT();</span></div><div class="t m0 x32 h4e y20b8 ff1a fs28 fc0 sc0 ls0 ws0">+</div><div class="t m0 x194 h4e y20b9 ff1a fs28 fc0 sc0 ls0 ws0">if ((pid = fork()) &lt; 0) {</div><div class="t m0 x76 h4e y20ba ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;fork error&quot;);</div><div class="t m0 x194 h4e y20bb ff1a fs28 fc0 sc0 ls1b6 ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pid == 0) {</span></div><div class="t m0 x32 h4e y20bc ff1a fs28 fc0 sc0 ls1b8 ws0">+W<span class="_ _92"></span><span class="ls0">AIT_PARENT(); <span class="_ _8a"> </span>/*<span class="_"> </span>parent goes first */</span></div><div class="t m0 x76 h4e y20bd ff1a fs28 fc0 sc0 ls0 ws0">charatatime(&quot;output from child\n&quot;);</div><div class="t m0 x194 h4e y20be ff1a fs28 fc0 sc0 ls1b6 ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x76 h4e y20bf ff1a fs28 fc0 sc0 ls0 ws0">charatatime(&quot;output from parent\n&quot;);</div><div class="t m0 x32 h4e y20c0 ff1a fs28 fc0 sc0 ls1b8 ws0">+T<span class="_ _92"></span><span class="ls0">ELL_CHILD(pid);</span></div><div class="t m0 x194 h4e y20c1 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x194 h4e y20c2 ff1a fs28 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 xb8 h4e y20c3 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 xb8 h4e y20c4 ff1a fs28 fc0 sc0 ls0 ws0">static void</div><div class="t m0 xb8 h4e y20c5 ff1a fs28 fc0 sc0 ls0 ws0">charatatime(char *str)</div><div class="t m0 xb8 h4e y20c6 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x194 h4e y20c7 ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>*ptr;</div><div class="t m0 x194 h4e y20c8 ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>c;</div><div class="t m0 x194 h4e y20c9 ff1a fs28 fc0 sc0 ls0 ws0">setbuf(stdout, NULL);<span class="_ _bd"> </span>/* set unbuffered */</div><div class="t m0 x194 h4e y20ca ff1a fs28 fc0 sc0 ls0 ws0">for (ptr = str; (c = *ptr++) != 0; )</div><div class="t m0 x76 h4e y20cb ff1a fs28 fc0 sc0 ls0 ws0">putc(c, stdout);</div><div class="t m0 xb8 h4e y20cc ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 xda h2e y20cd ff18 fs11 fc0 sc0 ls0 ws0">Figure 8.13<span class="_ _5a"> </span><span class="ff19">Modiﬁcation of Figur<span class="lsdb">e8<span class="_ _84"></span><span class="ls0">.12 to avoid race condition</span></span></span></div><div class="t m0 x32 h55 y20ce ff19 fs2c fc0 sc0 ls0 ws0">When we run this <span class="_ _2"></span>program, the output is as <span class="_ _2"></span>we expect; there<span class="_"> </span>is<span class="_"> </span>no<span class="_ _66"> </span>intermixing of <span class="_ _2"></span>output</div><div class="t m0 x32 h55 y20cf ff19 fs2c fc0 sc0 ls0 ws0">from the two pr<span class="_ _0"></span>ocesses.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
