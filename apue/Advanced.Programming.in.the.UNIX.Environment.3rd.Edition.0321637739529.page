<div id="pf211" class="pf w4 h1f" data-page-no="211"><div class="pc pc211 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg211.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.3<span class="_ _1f7"> </span>Recor<span class="ls30a">dL<span class="_ _55"></span><span class="ls0">ocking<span class="_ _1b"> </span><span class="ff18">495</span></span></span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">Assuming <span class="_ _23"></span>that <span class="_ _23"> </span>we <span class="_ _23"> </span>are<span class="_ _35"> </span>at<span class="_ _45"> </span>end <span class="_ _42"> </span>of <span class="_ _23"></span>ﬁle <span class="_ _23"></span>when <span class="_ _23"></span>we <span class="_ _23"> </span>perform <span class="_ _23"> </span>the <span class="_ _23"> </span>ﬁrst<span class="_ _35"> </span><span class="ff1a">write</span><span class="ls1007">,t<span class="_ _b"></span><span class="ls0">his <span class="_ _9"></span>operation</span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">will <span class="_ _2"></span>extend <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>by <span class="_ _2"></span>one <span class="_ _2"></span>byte, <span class="_ _2"></span>and <span class="_ _2"></span>that <span class="_ _2"></span>byte <span class="_ _2"></span>will <span class="_ _2"></span>be <span class="_ _2"></span>locked.<span class="_ _61"> </span>The <span class="_ _2"></span>unlock <span class="_ _2"></span>operation <span class="_ _3"></span>that</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">follows <span class="_ _23"></span>has <span class="_ _23"> </span>the <span class="_ _23"> </span>effect <span class="_ _23"></span>of <span class="_ _23"></span>removing <span class="_ _23"></span>the <span class="_ _23"></span>locks <span class="_ _23"></span>for <span class="_ _23"></span>futur<span class="ls887">ew<span class="_ _43"></span><span class="ls0">rites <span class="_ _23"></span>that <span class="_ _23"> </span>append <span class="_ _23"> </span>data <span class="_ _23"> </span>to <span class="_ _23"> </span>the</span></span></div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">ﬁle, <span class="_ _9"></span>but <span class="_ _9"></span>it <span class="_ _23"></span>leaves <span class="_ _9"></span>a <span class="_ _9"></span>lock <span class="_ _9"></span>on <span class="_ _9"></span>the <span class="_ _23"></span>last <span class="_ _9"></span>byte <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _23"></span>ﬁle.<span class="_ _5a"> </span>When <span class="_ _9"></span>the <span class="_ _9"></span>second <span class="_ _23"></span>write <span class="_ _9"></span>occurs, <span class="_ _9"></span>the</div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">end of <span class="_ _2"></span>ﬁle <span class="_ _2"></span>is <span class="_ _2"></span>extended <span class="_ _2"></span>by one <span class="_ _2"></span>byte, <span class="_ _2"></span>but <span class="_ _2"></span>this <span class="_ _2"></span>byte is <span class="_ _2"></span>not <span class="_ _2"></span>locked.<span class="_ _61"> </span>The state <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>locks</div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">for this sequence of steps is shown in Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">4.10.</span></span></div><div class="t m0 x104 h2d y3cb7 ff19 fs10 fc0 sc0 ls0 ws0">ﬁrst</div><div class="t m0 x104 h2d y3cb8 ff19 fs10 fc0 sc0 ls0 ws0">byte</div><div class="t m0 x178 h2d y3cb9 ff19 fs10 fc0 sc0 ls0 ws0">written</div><div class="t m0 x47 h30 y3cba ff19 fs13 fc0 sc0 ls0 ws0">locked</div><div class="t m0 x1ce h63 y3cbb ff19 fs13 fc0 sc0 ls0 ws0">state of ﬁle after ﬁrst<span class="_"> </span><span class="ff1a">write</span></div><div class="t m0 x104 h31 y3cbc ff19 fs14 fc0 sc0 ls0 ws0">ﬁrst</div><div class="t m0 x104 h31 y3cbd ff19 fs14 fc0 sc0 ls0 ws0">byte</div><div class="t m0 x178 h31 y3cbe ff19 fs14 fc0 sc0 ls0 ws0">written</div><div class="t m0 x15a h32 y3cbf ff19 fs15 fc0 sc0 ls0 ws0">second</div><div class="t m0 x13b h32 y3cc0 ff19 fs15 fc0 sc0 ls0 ws0">byte</div><div class="t m0 x49 h32 y3cc1 ff19 fs15 fc0 sc0 ls0 ws0">written</div><div class="t m0 xa1 h34 y3cc2 ff19 fs17 fc0 sc0 ls0 ws0">locked</div><div class="t m0 x185 hcc y3cc3 ff19 fs17 fc0 sc0 ls0 ws0">state of ﬁle after second<span class="_"> </span><span class="ff1a">write</span></div><div class="t m0 x72 h34 y3cc4 ff18 fs17 fc0 sc0 ls0 ws0">Figure 14.10<span class="_ _5a"> </span><span class="ff19">File range lock diagram</span></div><div class="t m0 x3f hcd y3cc5 ff19 fs6e fc0 sc0 ls0 ws0">When <span class="_ _23"></span>a <span class="_ _23"> </span>portion <span class="_ _23"> </span>of <span class="_ _23"> </span>a <span class="_ _42"> </span>ﬁle <span class="_ _23"></span>is <span class="_ _23"></span>locked, <span class="_ _23"> </span>the <span class="_ _23"> </span>kernel <span class="_ _23"> </span>converts <span class="_ _23"> </span>the <span class="_ _42"> </span>offset <span class="_ _9"></span>speciﬁed <span class="_ _23"> </span>into <span class="_ _42"> </span>an</div><div class="t m0 x32 h138 y3cc6 ff19 fs6e fc0 sc0 ls0 ws0">absolute <span class="_ _2"></span>ﬁle <span class="_ _3"></span>offset. <span class="_ _47"> </span>In<span class="_ _66"> </span>addition <span class="_ _3"></span>to <span class="_ _3"></span>specifying <span class="_ _3"></span>an <span class="_ _2"></span>absolute <span class="_ _3"></span>ﬁle <span class="_ _3"></span>offset <span class="_ _2"></span>(<span class="ff1a">SEEK_SET</span>),<span class="_ _47"> </span><span class="ff1a">fcntl</span></div><div class="t m0 x32 h138 y3cc7 ff19 fs6e fc0 sc0 ls0 ws0">allows <span class="_ _3"></span>us <span class="_ _3"></span>to <span class="_ _3"></span>specify <span class="_ _3"></span>this <span class="_ _3"></span>offset <span class="_ _2"></span>relative <span class="_ _2"></span>to <span class="_ _3"></span>a <span class="_ _3"></span>point <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle: <span class="_ _3"></span>current <span class="_ _3"></span>(<span class="ff1a">SEEK_CUR</span>)<span class="_ _47"> </span>or<span class="_ _47"> </span>end</div><div class="t m0 x32 h138 y3cc8 ff19 fs6e fc0 sc0 ls0 ws0">of <span class="_ _2"></span>ﬁle <span class="_ _2"></span>(<span class="ff1a">SEEK_END</span>). <span class="_ _66"> </span>The<span class="_ _47"> </span>kernel needs <span class="_ _2"></span>to <span class="_ _2"></span>remember <span class="_ _2"></span>the <span class="_ _2"></span>locks <span class="_ _2"></span>independent <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>current</div><div class="t m0 x32 hcd y3cc9 ff19 fs6e fc0 sc0 ls0 ws0">ﬁle <span class="_ _e"> </span>offset <span class="_ _53"> </span>or <span class="_"> </span>end <span class="_ _53"> </span>of <span class="_ _e"> </span>ﬁle, <span class="_ _e"> </span>because <span class="_ _e"> </span>the <span class="_"> </span>curr<span class="_ _1"></span>ent <span class="_"> </span>of<span class="_ _0"></span>fset <span class="_ _53"> </span>and <span class="_"> </span>end <span class="_ _53"> </span>of <span class="_ _e"> </span>ﬁle <span class="_ _e"> </span>can <span class="_"> </span>change, <span class="_ _53"> </span>and</div><div class="t m0 x32 hcd y3cca ff19 fs6e fc0 sc0 ls0 ws0">changes to these attributes shouldn’t affect the state of existing locks.</div><div class="t m0 x3f hcd y3ccb ff19 fs6e fc0 sc0 ls0 ws0">If <span class="_ _3"></span>we <span class="_ _3"></span>intended <span class="_ _3"></span>to <span class="_ _3"></span>remove <span class="_ _2"></span>the <span class="_ _9"></span>lock <span class="_ _3"></span>covering <span class="_ _3"></span>the <span class="_ _3"></span>byte <span class="_ _3"></span>we <span class="_ _3"></span>wrote <span class="_ _2"></span>in <span class="_ _9"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _3"></span>write, <span class="_ _3"></span>we</div><div class="t m0 x32 hcd y3ccc ff19 fs6e fc0 sc0 ls0 ws0">could have <span class="_ _2"></span>speciﬁed the <span class="_ _2"></span>length as<span class="_ _66"> </span><span class="ff20">−</span>1. <span class="_ _66"> </span>Negative<span class="_ _66"> </span>length <span class="_ _2"></span>values <span class="_ _2"></span>repr<span class="_ _0"></span>esent the bytes <span class="_ _2"></span>before</div><div class="t m0 x32 hcd y3ccd ff19 fs6e fc0 sc0 ls0 ws0">the speciﬁed offset.</div><div class="t m0 x35 h144 y3cce ff16 fs6e fc0 sc0 ls0 ws0">Advisor <span class="_ _4f"></span>y<span class="_"> </span>versus Mandator<span class="ls1008">yL<span class="_ _4f"></span><span class="ls0">ocking</span></span></div><div class="t m0 x32 hcd y3ccf ff19 fs6e fc0 sc0 ls0 ws0">Consider <span class="_ _3"></span>a <span class="_ _3"></span>library <span class="_ _3"></span>of <span class="_ _3"></span>database <span class="_ _9"></span>access <span class="_ _3"></span>routines. <span class="_ _66"> </span>If<span class="_ _45"> </span>all <span class="_ _2"></span>the <span class="_ _9"></span>functions <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>library <span class="_ _3"></span>handle</div><div class="t m0 x32 hcd y3cd0 ff19 fs6e fc0 sc0 lsd14 ws0">re<span class="ls0">cor<span class="ls1009">dl<span class="_ _43"></span><span class="ls0">ocking <span class="_ _23"> </span>in <span class="_ _42"> </span>a <span class="_ _42"> </span>consistent <span class="_ _23"> </span>way<span class="_ _6"></span><span class="ls1009">,t<span class="_ _43"></span><span class="ls0">hen <span class="_ _23"> </span>we <span class="_ _42"> </span>say <span class="_ _42"> </span>that <span class="_ _23"> </span>any <span class="_ _42"> </span>set <span class="_ _42"> </span>of <span class="_ _23"> </span>processes <span class="_ _42"> </span>using <span class="_ _23"> </span>these</span></span></span></span></span></div><div class="t m0 x32 hce y3cd1 ff19 fs6e fc0 sc0 ls0 ws0">functions <span class="_ _9"></span>to <span class="_ _9"></span>access <span class="_ _23"></span>a <span class="_ _9"></span>database <span class="_ _23"></span>ar<span class="_ _0"></span>e<span class="_ _45"> </span><span class="ff1b">cooperating <span class="_ _9"></span>processes</span><span class="ls100a">.I<span class="_ _26"></span><span class="ls0">t<span class="_ _45"> </span>is<span class="_ _35"> </span>feasible <span class="_ _9"></span>for <span class="_ _9"></span>these <span class="_ _9"></span>database</span></span></div><div class="t m0 x32 hcd y3cd2 ff19 fs6e fc0 sc0 ls0 ws0">access <span class="_ _9"></span>functions <span class="_ _9"></span>to <span class="_ _23"></span>use <span class="_ _9"></span>advisory <span class="_ _9"></span>locking <span class="_ _9"></span>if <span class="_ _23"></span>they <span class="_ _9"></span>ar<span class="ls100b">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>only <span class="_ _23"></span>ones <span class="_ _9"></span>being <span class="_ _9"></span>used <span class="_ _9"></span>to <span class="_ _23"></span>access</span></span></div><div class="t m0 x32 hcd y3cd3 ff19 fs6e fc0 sc0 ls0 ws0">the <span class="_ _23"></span>database.<span class="_ _5a"> </span>But <span class="_ _23"> </span>advisory <span class="_ _23"></span>locking <span class="_ _23"></span>doesn’t <span class="_ _23"></span>pr<span class="_ _0"></span>event <span class="_ _23"></span>some <span class="_ _9"></span>other <span class="_ _23"> </span>process <span class="_ _9"></span>that <span class="_ _23"> </span>has <span class="_ _23"> </span>write</div><div class="t m0 x32 hcd y3cd4 ff19 fs6e fc0 sc0 ls0 ws0">permission <span class="_ _42"> </span>for <span class="_ _53"> </span>the <span class="_ _53"> </span>database <span class="_ _53"> </span>ﬁle <span class="_ _53"> </span>from <span class="_ _42"> </span>writing <span class="_ _42"> </span>whatever <span class="_ _53"> </span>it <span class="_ _53"> </span>wants <span class="_ _53"> </span>to <span class="_ _53"> </span>the <span class="_ _42"> </span>database <span class="_ _53"> </span>ﬁle.</div><div class="t m0 x32 hcd y3cd5 ff19 fs6e fc0 sc0 ls0 ws0">This rogue process <span class="_ _2"></span>would be <span class="_ _2"></span>an <span class="_ _2"></span>uncooperating <span class="_ _2"></span>process, since <span class="_ _2"></span>it’s not <span class="_ _2"></span>using <span class="_ _2"></span>the <span class="_ _2"></span>accepted</div><div class="t m0 x32 hcd y3cd6 ff19 fs6e fc0 sc0 ls0 ws0">method (the library of database functions) to access the database.</div><div class="t m0 x3f h138 y3cd7 ff19 fs6e fc0 sc0 ls0 ws0">Mandatory <span class="_ _53"> </span>locking <span class="_ _53"> </span>causes <span class="_ _53"> </span>the <span class="_ _53"> </span>kernel <span class="_ _53"> </span>to <span class="_ _53"> </span>check <span class="_ _53"> </span>every<span class="_ _4b"> </span><span class="ff1a">open</span>,<span class="_ _4b"> </span><span class="ff1a">read</span><span class="ls100c">,a<span class="_ _c"></span><span class="ls0">nd<span class="_ _44"> </span><span class="ff1a">write<span class="_ _4b"> </span></span>to</span></span></div><div class="t m0 x32 hcd y3cd8 ff19 fs6e fc0 sc0 ls0 ws0">verify <span class="_ _35"> </span>that <span class="_ _44"> </span>the <span class="_ _35"> </span>calling <span class="_ _44"> </span>process <span class="_ _35"> </span>isn’t <span class="_ _35"> </span>violating <span class="_ _44"> </span>a <span class="_ _35"> </span>lock <span class="_ _44"> </span>on <span class="_ _35"> </span>the <span class="_ _35"> </span>ﬁle <span class="_ _44"> </span>being <span class="_ _35"> </span>accessed.</div><div class="t m0 x32 hce y3cd9 ff19 fs6e fc0 sc0 ls0 ws0">Mandatory locking is sometimes called<span class="_"> </span><span class="ff1b">enforcement-mode locking</span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
