<div id="pf19c" class="pf w4 h1f" data-page-no="19c"><div class="pc pc19c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg19c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">378<span class="_ _1b"> </span><span class="ff19">Signals <span class="_ _24b"> </span>Chapter<span class="_ _21"> </span>10</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h57 y363 ff1a fs2d fc0 sc0 ls0 ws0">#define BUFFSIZE<span class="_ _15"> </span>1024</div><div class="t m0 x32 h57 y364 ff1a fs2d fc0 sc0 ls0 ws0">static void</div><div class="t m0 x32 h57 y365 ff1a fs2d fc0 sc0 ls0 ws0">sig_tstp(int signo) /* signal handler for SIGTSTP */</div><div class="t m0 x32 h57 y366 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y367 ff1a fs2d fc0 sc0 ls0 ws0">sigset_t <span class="_ _68"> </span>mask;</div><div class="t m0 x8a h57 y3061 ff1a fs2d fc0 sc0 ls0 ws0">/* ... move cursor to lower left corner, reset tty mode ... */</div><div class="t m0 x8a h57 y3062 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y3063 ff1a fs2d fc0 sc0 ls15c ws0">*U<span class="_ _1d"></span><span class="ls0">nblock SIGTSTP, since it’s blocked while we’re handling it.</span></div><div class="t m0 x214 h57 y3064 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y36c ff1a fs2d fc0 sc0 ls0 ws0">sigemptyset(&amp;mask);</div><div class="t m0 x8a h57 y36d ff1a fs2d fc0 sc0 ls0 ws0">sigaddset(&amp;mask, SIGTSTP);</div><div class="t m0 x8a h57 y13a2 ff1a fs2d fc0 sc0 ls0 ws0">sigprocmask(SIG_UNBLOCK, &amp;mask, NULL);</div><div class="t m0 x8a h57 y36f ff1a fs2d fc0 sc0 ls0 ws0">signal(SIGTSTP, SIG_DFL);<span class="_ _68"> </span>/* reset disposition to default */</div><div class="t m0 x8a h57 y3065 ff1a fs2d fc0 sc0 ls0 ws0">kill(getpid(), SIGTSTP);<span class="_ _15"> </span>/* and send the signal to ourself */</div><div class="t m0 x8a h57 y3066 ff1a fs2d fc0 sc0 ls0 ws0">/* we won’t return from the kill until we’re continued */</div><div class="t m0 x8a h57 y3067 ff1a fs2d fc0 sc0 ls0 ws0">signal(SIGTSTP, sig_tstp);<span class="_ _d9"> </span>/* reestablish signal handler */</div><div class="t m0 x8a h57 y3068 ff1a fs2d fc0 sc0 ls0 ws0">/* ... reset tty mode, redraw screen ... */</div><div class="t m0 x32 h57 y3069 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y306a ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y306b ff1a fs2d fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h57 y306c ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y306d ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>n;</div><div class="t m0 x8a h57 y306e ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>buf[BUFFSIZE];</div><div class="t m0 x8a h57 y306f ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y3070 ff1a fs2d fc0 sc0 ls15c ws0">*O<span class="_ _1d"></span><span class="ls0">nly catch SIGTSTP if we’re running with a job-control shell.</span></div><div class="t m0 x214 h57 y3071 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y3072 ff1a fs2d fc0 sc0 ls0 ws0">if (signal(SIGTSTP, SIG_IGN) == SIG_DFL)</div><div class="t m0 x9d h57 y3073 ff1a fs2d fc0 sc0 ls0 ws0">signal(SIGTSTP, sig_tstp);</div><div class="t m0 x8a h57 y3074 ff1a fs2d fc0 sc0 ls0 ws0">while ((n = read(STDIN_FILENO, buf, BUFFSIZE)) &gt; 0)</div><div class="t m0 x9d h57 y3075 ff1a fs2d fc0 sc0 ls0 ws0">if (write(STDOUT_FILENO, buf, n) != n)</div><div class="t m0 x1f h57 y3076 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><div class="t m0 x8a h57 y3077 ff1a fs2d fc0 sc0 ls0 ws0">if (n &lt; 0)</div><div class="t m0 x9d h57 y3078 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;read error&quot;);</div><div class="t m0 x8a h57 y3079 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y307a ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc0 h5e y307b ff18 fs10 fc0 sc0 ls0 ws0">Figure 10.31<span class="_ _5a"> </span><span class="ff19">How to handle<span class="_"> </span><span class="ff1a">SIGTSTP</span></span></div><div class="t m0 x32 h4d y307c ff19 fs26 fc0 sc0 ls0 ws0">When the <span class="_ _2"></span>program in <span class="_ _2"></span>Figur<span class="ls5a1">e1<span class="_ _4f"></span><span class="ls0">0.31 starts, <span class="_ _2"></span>it <span class="_ _2"></span>arranges <span class="_ _2"></span>to catch <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">SIGTSTP<span class="_ _66"> </span></span>signal <span class="_ _2"></span>only <span class="_ _2"></span>if</span></span></div><div class="t m0 x32 h4d y307d ff19 fs26 fc0 sc0 ls0 ws0">the signal’s disposition is<span class="_"> </span><span class="ff1a">SIG_DFL</span><span class="lsd4c">.T<span class="_ _4a"></span><span class="ls0">he reason is that when the program is started by a</span></span></div><div class="t m0 x32 h4d y307e ff19 fs26 fc0 sc0 ls0 ws0">shell <span class="_ _23"></span>that <span class="_ _9"></span>doesn’t <span class="_ _23"> </span>support <span class="_ _23"></span>job <span class="_ _9"></span>control <span class="_ _23"></span>(<span class="ff1a">/bin/sh</span><span class="ls96d">,f<span class="_ _43"></span><span class="ls0">or <span class="_ _23"> </span>example), <span class="_ _23"></span>the <span class="_ _23"></span>signal’s <span class="_ _9"></span>disposition</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
