<div id="pf98" class="pf w4 h1f" data-page-no="98"><div class="pc pc98 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg98.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls153 ws0">11<span class="_ _2"></span><span class="ls0">8<span class="_ _1b"> </span><span class="ff19">Files <span class="_"> </span>and <span class="_"> </span>Directories <span class="_ _199"> </span>Chapter<span class="_ _4b"> </span>4</span></span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y1105 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _3"></span>program <span class="_ _9"></span>shown <span class="_ _3"></span>in <span class="_ _9"></span>Figur<span class="ls53e">e4<span class="_ _b"></span><span class="ls0">.16 <span class="_ _9"></span>opens <span class="_ _9"></span>a <span class="_ _3"></span>ﬁle <span class="_ _9"></span>and <span class="_ _9"></span>then <span class="_ _9"></span>unlinks <span class="_ _9"></span>it.<span class="_ _16"> </span>The <span class="_ _9"></span>program <span class="_ _3"></span>then</span></span></div><div class="t m0 x32 h2a y150 ff19 fsf fc0 sc0 ls0 ws0">goes to sleep for 15 seconds befor<span class="ls44">et<span class="_ _4f"></span><span class="ls0">erminating.</span></span></div><div class="t m0 x32 h4e y1106 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y1107 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h4e y1108 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y1109 ff1a fs28 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h4e y110a ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y110b ff1a fs28 fc0 sc0 ls0 ws0">if (open(&quot;tempfile&quot;, O_RDWR) &lt; 0)</div><div class="t m0 x9d h4e y110c ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;open error&quot;);</div><div class="t m0 x8a h4e y110d ff1a fs28 fc0 sc0 ls0 ws0">if (unlink(&quot;tempfile&quot;) &lt; 0)</div><div class="t m0 x9d h4e y110e ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;unlink error&quot;);</div><div class="t m0 x8a h4e y110f ff1a fs28 fc0 sc0 ls0 ws0">printf(&quot;file unlinked\n&quot;);</div><div class="t m0 x8a h4e y1110 ff1a fs28 fc0 sc0 ls0 ws0">sleep(15);</div><div class="t m0 x8a h4e y1111 ff1a fs28 fc0 sc0 ls0 ws0">printf(&quot;done\n&quot;);</div><div class="t m0 x8a h4e y1112 ff1a fs28 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h4e y1113 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x1e h4f y1114 ff18 fs11 fc0 sc0 ls0 ws0">Figure 4.16<span class="_ _5a"> </span><span class="ff19">Open a ﬁle and then<span class="_"> </span><span class="ff1a">unlink<span class="_ _e"> </span></span>it</span></div><div class="t m0 x32 h55 y1115 ff19 fs2c fc0 sc0 ls0 ws0">Running this program gives us</div><div class="t m0 x3f h5d y1116 ff1a fs2f fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">ls -l tempfile<span class="_ _19d"> </span><span class="ff1b">look at how big the ﬁle is</span></span></div><div class="t m0 x3f h5d y1117 ff1a fs2f fc0 sc0 ls0 ws0">-rw-r----- <span class="_"> </span>1<span class="_"> </span>sar <span class="_ _15"> </span>413265408<span class="_"> </span>Jan 21 07:14 tempfile</div><div class="t m0 x3f h5d y1118 ff1a fs2f fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">df /home<span class="_ _17f"> </span><span class="ff1b">check how much free space is available</span></span></div><div class="t m0 x3f h5d y1119 ff1a fs2f fc0 sc0 ls0 ws0">Filesystem <span class="_ _d9"> </span>1K-blocks<span class="_ _8a"> </span>Used <span class="_"> </span>Available <span class="_"> </span>Use% <span class="_"> </span>Mounted<span class="_"> </span>on</div><div class="t m0 x3f h5d y111a ff1a fs2f fc0 sc0 ls0 ws0">/dev/hda4 <span class="_ _15"> </span>11021440<span class="_ _d9"> </span>1956332 <span class="_ _87"> </span>9065108<span class="_ _68"> </span>18% <span class="_"> </span>/home</div><div class="t m0 x3f h5d y111b ff1a fs2f fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out &amp;<span class="_ _195"> </span><span class="ff1b">run the program in Figur<span class="_ _0"></span><span class="ls4c3">e4<span class="_ _5"></span><span class="ls0">.16 in the background</span></span></span></span></div><div class="t m0 x3f h5d y111c ff1a fs2f fc0 sc0 ls0 ws0">1364<span class="_ _19e"> </span><span class="ff1b">the shell prints its process ID</span></div><div class="t m0 x3f h5d y111d ff1a fs2f fc0 sc0 ls395 ws0">$f<span class="_ _1d"></span><span class="ls0">ile unlinked<span class="_ _19f"> </span><span class="ff1b">the ﬁle is unlinked</span></span></div><div class="t m0 x3f h5d y111e ff1f fs2f fc0 sc0 ls0 ws0">ls -l tempfile<span class="_ _1a0"> </span><span class="ff1b">see if the ﬁlename is still there</span></div><div class="t m0 x3f h5d y111f ff1a fs2f fc0 sc0 ls0 ws0">ls: tempfile: No such file or directory<span class="_ _170"> </span><span class="ff1b">the directory entry is gone</span></div><div class="t m0 x3f h5d y1120 ff1a fs2f fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">df /home<span class="_ _17f"> </span><span class="ff1b">see if the space is available yet</span></span></div><div class="t m0 x3f h5d y1121 ff1a fs2f fc0 sc0 ls0 ws0">Filesystem <span class="_ _d9"> </span>1K-blocks<span class="_ _8a"> </span>Used <span class="_"> </span>Available <span class="_"> </span>Use% <span class="_"> </span>Mounted<span class="_"> </span>on</div><div class="t m0 x3f h5d y1122 ff1a fs2f fc0 sc0 ls0 ws0">/dev/hda4 <span class="_ _15"> </span>11021440<span class="_ _d9"> </span>1956332 <span class="_ _87"> </span>9065108<span class="_ _68"> </span>18% <span class="_"> </span>/home</div><div class="t m0 x3f h5d y1123 ff1a fs2f fc0 sc0 ls395 ws0">$d<span class="_ _1d"></span><span class="ls0">one<span class="_ _1a1"> </span><span class="ff1b">the program is done, all open ﬁles ar<span class="_ _0"></span><span class="ls4c3">ec<span class="_ _5"></span><span class="ls0">losed</span></span></span></span></div><div class="t m0 x3f h5d y1124 ff1f fs2f fc0 sc0 ls0 ws0">df /home<span class="_ _1a2"> </span><span class="ff1b">now the disk space should be available</span></div><div class="t m0 x3f h5d y1125 ff1a fs2f fc0 sc0 ls0 ws0">Filesystem <span class="_ _d9"> </span>1K-blocks<span class="_ _8a"> </span>Used <span class="_"> </span>Available <span class="_"> </span>Use% <span class="_"> </span>Mounted<span class="_"> </span>on</div><div class="t m0 x3f h5d y1126 ff1a fs2f fc0 sc0 ls0 ws0">/dev/hda4 <span class="_ _15"> </span>11021440<span class="_ _d9"> </span>1552352 <span class="_ _87"> </span>9469088<span class="_ _68"> </span>15% <span class="_"> </span>/home</div><div class="t m0 x6c hc0 y1127 ff1b fs2f fc0 sc0 ls0 ws0">now the 394.1 MB of disk space ar<span class="ls4c3">ea<span class="_ _d"></span><span class="ls0">vailable</span></span></div><div class="t m0 x3f h5c y1128 ff19 fs29 fc0 sc0 ls0 ws0">This <span class="_ _2"></span>property of<span class="_ _47"> </span><span class="ff1a">unlink<span class="_ _47"> </span></span>is <span class="_ _2"></span>often <span class="_ _2"></span>used <span class="_ _2"></span>by <span class="_ _2"></span>a <span class="_ _3"></span>program to <span class="_ _3"></span>ensur<span class="ls53f">et<span class="_ _8"></span><span class="ls0">hat <span class="_ _2"></span>a <span class="_ _3"></span>temporary <span class="_ _2"></span>ﬁle</span></span></div><div class="t m0 x32 h50 y1129 ff19 fs29 fc0 sc0 ls0 ws0">it <span class="_ _23"></span>creates <span class="_ _9"></span>won’t <span class="_ _23"> </span>be <span class="_ _23"> </span>left <span class="_ _23"> </span>around <span class="_ _23"></span>in <span class="_ _9"></span>case <span class="_ _23"> </span>the <span class="_ _23"> </span>program <span class="_ _23"></span>crashes.<span class="_ _51"> </span>The <span class="_ _23"></span>pr<span class="_ _0"></span>ocess <span class="_ _23"></span>creates <span class="_ _9"></span>a <span class="_ _23"> </span>ﬁle</div><div class="t m0 x32 h5c y112a ff19 fs29 fc0 sc0 ls0 ws0">using either<span class="_"> </span><span class="ff1a">open<span class="_ _66"> </span></span>or<span class="_"> </span><span class="ff1a">creat<span class="_ _66"> </span></span>and then immediately <span class="_ _2"></span>calls<span class="_"> </span><span class="ff1a">unlink</span><span class="ls540">.T<span class="_ _4a"></span><span class="ls0">he ﬁle is not <span class="_ _2"></span>deleted,</span></span></div><div class="t m0 x32 h50 y112b ff19 fs29 fc0 sc0 ls0 ws0">however<span class="_ _6"></span><span class="ls541">,b<span class="_ _5b"></span><span class="ls0">ecause <span class="_ _47"> </span>it <span class="_ _66"> </span>is <span class="_ _47"> </span>still <span class="_ _47"> </span>open.<span class="_ _50"> </span>Only <span class="_ _47"> </span>when <span class="_ _47"> </span>the <span class="_ _66"> </span>process <span class="_ _47"> </span>either <span class="_ _66"> </span>closes <span class="_ _47"> </span>the <span class="_ _47"> </span>ﬁle <span class="_ _47"> </span>or</span></span></div><div class="t m0 x32 h50 y112c ff19 fs29 fc0 sc0 ls0 ws0">terminates, which causes the kernel to close all its open ﬁles, is the ﬁle deleted.</div><div class="t m0 x3f h5c y112d ff19 fs29 fc0 sc0 ls0 ws0">If<span class="_ _59"> </span><span class="ff1b">pathname<span class="_ _46"> </span></span>is <span class="_"> </span>a <span class="_"> </span>symbolic <span class="_"> </span>link,<span class="_ _46"> </span><span class="ff1a">unlink<span class="_ _46"> </span></span><span class="lsdf">re</span>moves <span class="_"> </span>the <span class="_"> </span>symbolic <span class="_"> </span>link, <span class="_"> </span>not <span class="_"> </span>the <span class="_"> </span>ﬁle</div><div class="t m0 x32 h50 y112e ff19 fs29 fc0 sc0 lsdf ws0">re<span class="ls0">ferenced <span class="_ _2"></span>by <span class="_ _3"></span>the <span class="_ _2"></span>link.<span class="_ _16"> </span>There<span class="_ _66"> </span>is<span class="_ _47"> </span>no<span class="_ _47"> </span>function <span class="_ _2"></span>to <span class="_ _2"></span>remove <span class="_ _2"></span>the <span class="_ _3"></span>ﬁle <span class="_ _2"></span>referenced <span class="_ _2"></span>by <span class="_ _2"></span>a <span class="_ _3"></span>symbolic</span></div><div class="t m0 x32 h50 y112f ff19 fs29 fc0 sc0 ls0 ws0">link given the name of the link.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
