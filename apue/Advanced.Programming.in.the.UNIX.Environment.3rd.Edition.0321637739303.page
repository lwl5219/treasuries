<div id="pf12f" class="pf w4 h1f" data-page-no="12f"><div class="pc pc12f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg12f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>8.14<span class="_ _18d"> </span>Process <span class="_"> </span>Accounting<span class="_ _1b"> </span><span class="ff18">269</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The superuser permissions that we gave the<span class="_"> </span><span class="ff1a">tsys<span class="_ _66"> </span></span>program ar<span class="_ _0"></span><span class="lsa5c">er<span class="_ _4f"></span><span class="ls0">etained across the<span class="_"> </span><span class="ff1a">fork</span></span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">and<span class="_"> </span><span class="ff1a">exec<span class="_ _80"> </span></span>that ar<span class="ls44">ed<span class="_ _d"></span><span class="ls0">one by<span class="_"> </span><span class="ff1a">system</span>.</span></span></div><div class="t m0 x76 h52 y2355 ff19 fs2a fc0 sc0 ls0 ws0">Some <span class="_"> </span>implementations <span class="_ _80"> </span>have <span class="_ _80"> </span>closed <span class="_ _e"> </span>this <span class="_ _80"> </span>security <span class="_ _80"> </span>hole <span class="_ _e"> </span>by <span class="_ _80"> </span>changing<span class="_ _44"> </span><span class="ff1a">/bin/sh<span class="_ _4b"> </span></span>to <span class="_ _e"> </span>reset <span class="_ _80"> </span>the</div><div class="t m0 x76 h51 y2356 ff19 fs2a fc0 sc0 ls0 ws0">effective <span class="_ _3"></span>user <span class="_ _9"></span>ID <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>real <span class="_ _9"></span>user <span class="_ _9"></span>ID <span class="_ _9"></span>when <span class="_ _9"></span>they <span class="_ _9"></span>don’t <span class="_ _9"></span>match.<span class="_ _59"> </span>On <span class="_ _9"></span>these <span class="_ _9"></span>systems, <span class="_ _9"></span>the <span class="_ _9"></span>previous</div><div class="t m0 x76 h51 y2357 ff19 fs2a fc0 sc0 ls0 ws0">example doesn’t <span class="_ _2"></span>work <span class="_ _2"></span>as shown.<span class="_ _4b"> </span>Instead, the <span class="_ _2"></span>same <span class="_ _2"></span>effective user ID <span class="_ _2"></span>will <span class="_ _2"></span>be <span class="_ _2"></span>printed regardless</div><div class="t m0 x76 h52 y2358 ff19 fs2a fc0 sc0 ls0 ws0">of the status of the set-user-ID bit on the pr<span class="_ _0"></span>ogram calling<span class="_"> </span><span class="ff1a">system</span>.</div><div class="t m0 x3f h2a y6d4 ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _9"></span>it <span class="_ _9"></span>is <span class="_ _23"></span>running <span class="_ _9"></span>with <span class="_ _9"></span>special <span class="_ _23"></span>permissions<span class="_ _3"></span><span class="ls9d">—e<span class="_ _1"></span><span class="ls0">ither <span class="_ _9"></span>set-user-ID <span class="_ _9"></span>or <span class="_ _9"></span>set-group-ID <span class="_ _a"></span>— <span class="_ _a"></span>and</span></span></div><div class="t m0 x32 h26 y6d5 ff19 fsf fc0 sc0 ls0 ws0">wants <span class="_ _23"></span>to <span class="_ _23"></span>spawn <span class="_ _9"></span>another <span class="_ _23"> </span>process, <span class="_ _23"></span>a <span class="_ _23"></span>pr<span class="_ _0"></span>ocess <span class="_ _23"></span>should <span class="_ _23"></span>use<span class="_ _45"> </span><span class="ff1a">fork<span class="_ _35"> </span></span>and<span class="_ _45"> </span><span class="ff1a">exec<span class="_ _35"> </span></span>directly<span class="_ _4"></span><span class="lsa5d">,b<span class="_ _b"></span><span class="ls0">eing</span></span></div><div class="t m0 x32 h26 y6d6 ff19 fsf fc0 sc0 ls0 ws0">certain <span class="_ _3"></span>to <span class="_ _9"></span>change <span class="_ _3"></span>back <span class="_ _9"></span>to <span class="_ _3"></span>normal <span class="_ _9"></span>permissions <span class="_ _3"></span>after <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">fork</span><span class="ls92c">,b<span class="_ _8"></span><span class="ls0">efor<span class="ls92c">ec<span class="_ _b"></span><span class="ls0">alling<span class="_ _45"> </span><span class="ff1a">exec</span><span class="ls364">.T<span class="_ _62"></span><span class="ls0">he</span></span></span></span></span></span></div><div class="t m0 x32 h26 y6d7 ff1a fsf fc0 sc0 ls0 ws0">system<span class="_ _80"> </span><span class="ff19">function should<span class="_"> </span><span class="ff1b">never<span class="_"> </span></span>be used from a set-user-ID or a set-gr<span class="_ _1"></span>oup-ID program.</span></div><div class="t m0 x76 h52 y15a ff19 fs2a fc0 sc0 ls0 ws0">One <span class="_ _2"></span>reason for <span class="_ _2"></span>this <span class="_ _2"></span>admonition <span class="_ _3"></span>is <span class="_ _2"></span>that<span class="_ _80"> </span><span class="ff1a">system<span class="_ _80"> </span></span>invokes <span class="_ _2"></span>the <span class="_ _2"></span>shell <span class="_ _2"></span>to <span class="_ _2"></span>parse <span class="_ _2"></span>the <span class="_ _2"></span>command <span class="_ _2"></span>string,</div><div class="t m0 x76 h52 y1053 ff19 fs2a fc0 sc0 ls0 ws0">and <span class="_ _23"> </span>the <span class="_ _23"> </span>shell <span class="_ _42"> </span>uses <span class="_ _23"> </span>its<span class="_ _45"> </span><span class="ff1a">IFS<span class="_ _45"> </span></span>variable <span class="_ _23"> </span>as <span class="_ _23"> </span>the <span class="_ _23"> </span>input <span class="_ _42"> </span>ﬁeld <span class="_ _23"> </span>separator<span class="_ _1"></span><span class="lsa5e">.O<span class="_ _5b"></span><span class="ls0">lder <span class="_ _23"> </span>versions <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>shell</span></span></div><div class="t m0 x76 h51 y1054 ff19 fs2a fc0 sc0 ls0 ws0">didn’t <span class="_ _2"></span>reset <span class="_ _3"></span>this <span class="_ _3"></span>variable <span class="_ _3"></span>to <span class="_ _3"></span>a <span class="_ _3"></span>normal <span class="_ _3"></span>set <span class="_ _3"></span>of <span class="_ _2"></span>characters <span class="_ _3"></span>when <span class="_ _3"></span>invoked.<span class="_ _4b"> </span>As <span class="_ _3"></span>a <span class="_ _3"></span>result, <span class="_ _3"></span>a <span class="_ _3"></span>malicious</div><div class="t m0 x76 h52 y1055 ff19 fs2a fc0 sc0 ls0 ws0">user <span class="_ _2"></span>could <span class="_ _2"></span>set<span class="_ _e"> </span><span class="ff1a">IFS<span class="_ _80"> </span></span>before<span class="_ _80"> </span><span class="ff1a">system<span class="_ _e"> </span></span>was <span class="_ _2"></span>called, <span class="_ _2"></span>causing<span class="_ _80"> </span><span class="ff1a">system<span class="_ _80"> </span></span>to <span class="_ _2"></span>execute <span class="_ _2"></span>a <span class="_ _2"></span>different program.</div><div class="t m0 x35 h53 yfe7 ff16 fs2b fc0 sc0 ls0 ws0">8.14 <span class="_ _93"> </span>Process <span class="_"> </span>Accounting</div><div class="t m0 x32 h2a y2359 ff19 fsf fc0 sc0 ls0 ws0">Most <span class="_ _23"> </span>UNIX <span class="_ _42"> </span>systems <span class="_ _42"> </span>provide <span class="_ _23"></span>an <span class="_ _42"> </span>option <span class="_ _23"> </span>to <span class="_ _42"> </span>do <span class="_ _42"> </span>process <span class="_ _23"></span>accounting.<span class="_ _51"> </span>When <span class="_ _42"> </span>enabled, <span class="_ _42"> </span>the</div><div class="t m0 x32 h2a yb8 ff19 fsf fc0 sc0 ls0 ws0">kernel <span class="_ _23"> </span>writes <span class="_ _42"> </span>an <span class="_ _23"> </span>accounting <span class="_ _42"> </span>recor<span class="_ _0"></span><span class="lsa5f">de<span class="_ _43"></span><span class="ls0">ach <span class="_ _23"> </span>time <span class="_ _42"> </span>a <span class="_ _23"> </span>process <span class="_ _23"> </span>terminates.<span class="_ _54"> </span>These <span class="_ _23"> </span>accounting</span></span></div><div class="t m0 x32 h2a y235a ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">cords typically <span class="_ _2"></span>contain <span class="_ _2"></span>a small <span class="_ _2"></span>amount <span class="_ _2"></span>of <span class="_ _2"></span>binary data <span class="_ _2"></span>with <span class="_ _2"></span>the name <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>command,</span></div><div class="t m0 x32 h2a y235b ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _9"></span>amount <span class="_ _9"></span>of <span class="_ _9"></span>CPU <span class="_ _9"></span>time <span class="_ _9"></span>used, <span class="_ _9"></span>the <span class="_ _9"></span>user <span class="_ _9"></span>ID <span class="_ _3"></span>and <span class="_ _9"></span>group <span class="_ _9"></span>ID, <span class="_ _9"></span>the <span class="_ _9"></span>starting <span class="_ _9"></span>time, <span class="_ _9"></span>and <span class="_ _9"></span>so <span class="_ _9"></span>on.</div><div class="t m0 x32 h2a y235c ff19 fsf fc0 sc0 ls5f ws0">We<span class="_ _9"></span><span class="ls0">’ll take a <span class="_ _2"></span>closer look at these <span class="_ _2"></span>accounting records in this section, as it gives <span class="_ _2"></span>us a chance</span></div><div class="t m0 x32 h26 y581 ff19 fsf fc0 sc0 ls0 ws0">to look at processes again and to use the<span class="_"> </span><span class="ff1a">fread<span class="_ _80"> </span></span>function from Section 5.9.</div><div class="t m0 x76 h51 y235d ff19 fs2a fc0 sc0 ls0 ws0">Process accounting is not speciﬁed by any of the standards. <span class="_"> </span>Thus<span class="_"> </span>all the implementations have</div><div class="t m0 x76 h51 y235e ff19 fs2a fc0 sc0 ls0 ws0">annoying <span class="_ _23"> </span>differ<span class="_ _0"></span>ences. <span class="_ _47"> </span>For<span class="_ _47"> </span>example, <span class="_ _23"> </span>the <span class="_ _23"> </span>I/O <span class="_ _23"> </span>counts <span class="_ _23"> </span>maintained <span class="_ _9"> </span>on <span class="_ _23"> </span>Solaris <span class="_ _23"> </span>10 <span class="_ _23"> </span>are<span class="_ _47"> </span>in<span class="_ _47"> </span>units <span class="_ _23"> </span>of</div><div class="t m0 x76 h51 y235f ff19 fs2a fc0 sc0 ls0 ws0">bytes, whereas <span class="_ _2"></span>FreeBSD 8.0 <span class="_ _2"></span>and <span class="_ _2"></span>Mac OS <span class="_ _2"></span>X <span class="_ _2"></span>10.6.8 <span class="_ _2"></span>maintain <span class="_ _2"></span>units of <span class="_ _2"></span>blocks, <span class="_ _2"></span>although <span class="_ _2"></span>there<span class="_"> </span>is<span class="_ _80"> </span>no</div><div class="t m0 x76 h51 y2360 ff19 fs2a fc0 sc0 ls0 ws0">distinction <span class="_ _9"></span>between <span class="_ _3"></span>different <span class="_ _3"></span>block <span class="_ _9"></span>sizes, <span class="_ _9"></span>making <span class="_ _9"></span>the <span class="_ _9"></span>counter <span class="_ _9"></span>effectively <span class="_ _3"></span>useless.<span class="_ _59"> </span>Linux <span class="_ _9"></span>3.2.0,</div><div class="t m0 x76 h51 y2361 ff19 fs2a fc0 sc0 ls0 ws0">on the other hand, doesn’t try to maintain I/O statistics at all.</div><div class="t m0 x76 h51 y2362 ff19 fs2a fc0 sc0 ls0 ws0">Each <span class="_ _66"> </span>implementation <span class="_ _47"> </span>also <span class="_ _66"> </span>has <span class="_ _66"> </span>its <span class="_ _47"> </span>own <span class="_ _66"> </span>set <span class="_ _47"> </span>of <span class="_ _66"> </span>administrative <span class="_ _47"> </span>commands <span class="_ _66"> </span>to <span class="_ _66"> </span>process <span class="_ _66"> </span>raw</div><div class="t m0 x76 h52 y2363 ff19 fs2a fc0 sc0 ls0 ws0">accounting <span class="_ _80"> </span>data.<span class="_ _54"> </span>For <span class="_ _66"> </span>example, <span class="_ _80"> </span>Solaris <span class="_ _66"> </span>provides<span class="_ _44"> </span><span class="ff1a">runacct</span>(1m) <span class="_ _66"> </span>and<span class="_ _4b"> </span><span class="ff1a">acctcom</span></div><div class="t m0 xd5 h51 y2364 ff19 fs2a fc0 sc0 ls0 ws0">(</div><div class="t m0 xd1 h51 y2363 ff19 fs2a fc0 sc0 ls0 ws0">1</div><div class="t m0 xd6 h51 y2364 ff19 fs2a fc0 sc0 ls0 ws0">)</div><div class="t m0 x1c9 h51 y2363 ff19 fs2a fc0 sc0 lsa60 ws0">,w<span class="_ _55"></span><span class="ls0">hereas</span></div><div class="t m0 x76 h52 y2365 ff19 fs2a fc0 sc0 ls0 ws0">FreeBSD pr<span class="_ _0"></span>ovides the<span class="_"> </span><span class="ff1a">sa</span></div><div class="t m0 x17c h51 y2366 ff19 fs2a fc0 sc0 ls0 ws0">(</div><div class="t m0 x4b h51 y2365 ff19 fs2a fc0 sc0 ls0 ws0">8</div><div class="t m0 x1b7 h51 y2366 ff19 fs2a fc0 sc0 ls0 ws0">)</div><div class="t m0 xed h51 y2365 ff19 fs2a fc0 sc0 ls0 ws0">command to process and summarize the raw accounting data.</div><div class="t m0 x3f h26 y2367 ff19 fsf fc0 sc0 ls6d2 ws0">Af<span class="_ _43"></span><span class="ls0">unction <span class="_ _23"> </span>we <span class="_ _23"> </span>haven’t <span class="_ _42"> </span>described <span class="_ _23"></span>(<span class="ff1a">acct</span><span class="ls6d2">)e<span class="_ _43"></span><span class="ls0">nables <span class="_ _23"> </span>and <span class="_ _23"> </span>disables <span class="_ _42"> </span>process <span class="_ _9"></span>accounting.</span></span></span></div><div class="t m0 x32 h26 y2368 ff19 fsf fc0 sc0 ls0 ws0">The only use of this <span class="_ _2"></span>function is from the<span class="_"> </span><span class="ff1a">accton</span></div><div class="t m0 x1fe h2a y2369 ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x1ff h2a y2368 ff19 fsf fc0 sc0 ls0 ws0">8</div><div class="t m0 x1c5 h2a y2369 ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x187 h2a y2368 ff19 fsf fc0 sc0 ls0 ws0">command (which happens to be <span class="_ _2"></span>one</div><div class="t m0 x32 h26 y236a ff19 fsf fc0 sc0 ls0 ws0">of <span class="_ _35"> </span>the <span class="_ _35"> </span>few <span class="_ _35"> </span>similarities <span class="_ _35"> </span>among <span class="_ _35"> </span>platforms).<span class="_ _98"> </span><span class="lsa61">As<span class="_ _7"></span><span class="ls0">uperuser <span class="_ _35"> </span>executes<span class="_ _51"> </span><span class="ff1a">accton<span class="_ _51"> </span></span>with <span class="_ _35"> </span>a</span></span></div><div class="t m0 x32 h2a y236b ff19 fsf fc0 sc0 ls0 ws0">pathname <span class="_ _42"> </span>argument <span class="_ _23"> </span>to <span class="_ _42"> </span>enable <span class="_ _42"> </span>accounting.<span class="_ _54"> </span>The <span class="_ _42"> </span>accounting <span class="_ _42"> </span>records <span class="_ _23"> </span>ar<span class="lsa62">ew<span class="_ _43"></span><span class="ls0">ritten <span class="_ _23"> </span>to <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h26 y236c ff19 fsf fc0 sc0 ls0 ws0">speciﬁed <span class="_ _66"> </span>ﬁle, <span class="_ _66"> </span>which <span class="_ _47"> </span>is <span class="_"> </span>usually<span class="_ _61"> </span><span class="ff1a">/var/account/acct<span class="_ _61"> </span></span>on <span class="_ _47"> </span>Fr<span class="_ _0"></span>eeBSD <span class="_ _66"> </span>and <span class="_ _66"> </span>Mac <span class="_ _47"> </span>OS <span class="_ _66"> </span>X,</div><div class="t m0 x32 h26 y236d ff1a fsf fc0 sc0 ls0 ws0">/var/log/account/pacct<span class="_ _66"> </span><span class="ff19">on <span class="_ _2"></span>Linux, <span class="_ _3"></span>and<span class="_ _66"> </span></span>/var/adm/pacct<span class="_ _47"> </span><span class="ff19">on <span class="_ _2"></span>Solaris.<span class="_ _61"> </span>Accounting</span></div><div class="t m0 x32 h26 y236e ff19 fsf fc0 sc0 ls0 ws0">is turned off<span class="_"> </span>by<span class="_"> </span>executing<span class="_"> </span><span class="ff1a">accton<span class="_ _80"> </span></span>without any arguments.</div><div class="t m0 x3f h26 y236f ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _23"> </span>structur<span class="ls10b">eo<span class="_ _43"></span><span class="ls10c">ft<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>accounting <span class="_ _42"> </span>recor<span class="_ _0"></span>ds <span class="_ _23"> </span>is <span class="_ _42"> </span>deﬁned <span class="_ _42"> </span>in <span class="_ _23"> </span>the <span class="_ _42"> </span>header<span class="_ _35"> </span><span class="ff1a">&lt;sys/acct.h&gt;</span>.</span></span></span></div><div class="t m0 x32 h2a y2370 ff19 fsf fc0 sc0 ls0 ws0">Although <span class="_ _45"> </span>the <span class="_ _47"> </span>implementation <span class="_ _45"> </span>of <span class="_ _45"> </span>each <span class="_ _47"> </span>system <span class="_ _45"> </span>differs, <span class="_ _47"> </span>the <span class="_ _45"> </span>accounting <span class="_ _47"> </span>records <span class="_ _47"> </span>look</div><div class="t m0 x32 h2a y2371 ff19 fsf fc0 sc0 ls0 ws0">something like</div><a class="l" href="#pff" data-dest-detail='[15,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.894092px;bottom:791.088916px;width:155.123001px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
