<div id="pf79" class="pf w4 h1f" data-page-no="79"><div class="pc pc79 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg79.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>3.15<span class="_ _177"> </span><span class="ff1a">ioctl<span class="_ _4b"> </span></span>Function<span class="_ _1b"> </span><span class="ff18">87</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls45 ws0">ro<span class="ls0">w<span class="_ _35"> </span>in<span class="_ _45"> </span>Figur<span class="ls436">e3<span class="_ _43"></span><span class="ls0">.13, <span class="_ _23"></span>but <span class="_ _9"></span>since <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">O_SYNC<span class="_ _35"> </span></span>ﬂag <span class="_ _9"></span>isn’t <span class="_ _9"></span>having <span class="_ _23"></span>the <span class="_ _9"></span>intended <span class="_ _23"> </span>effect, <span class="_ _9"></span>the <span class="_ _23"></span>last</span></span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls45 ws0">ro<span class="ls44">wb<span class="_ _5"></span><span class="ls0">ehaves the same way as the ﬁfth row<span class="_ _4"></span>.</span></span></div><div class="t m0 x3f h2a y131 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls23b">e3<span class="_ _b"></span><span class="ls0">.14 <span class="_ _3"></span>shows <span class="_ _9"></span>timing <span class="_ _9"></span>results <span class="_ _3"></span>for <span class="_ _9"></span>the <span class="_ _9"></span>same <span class="_ _9"></span>tests <span class="_ _9"></span>run <span class="_ _3"></span>on <span class="_ _9"></span>Mac <span class="_ _9"></span>OS <span class="_ _9"></span>X <span class="_ _9"></span>10.6.8, <span class="_ _9"></span>which</span></span></div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">uses <span class="_ _e"> </span>the<span class="_ _4b"> </span><span class="ff1a">HFS<span class="_ _59"> </span></span>ﬁle <span class="_ _53"> </span>system.<span class="_ _48"> </span>Note <span class="_"> </span>that <span class="_ _53"> </span>the <span class="_ _e"> </span>times <span class="_ _e"> </span>match <span class="_ _e"> </span>our <span class="_ _e"> </span>expectations: <span class="_ _e"> </span>synchronous</div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">writes <span class="_ _2"></span>ar<span class="ls437">ef<span class="_ _8"></span><span class="ls0">ar <span class="_ _3"></span>mor<span class="ls437">ee<span class="_ _8"></span><span class="ls0">xpensive <span class="_ _3"></span>than <span class="_ _3"></span>delayed <span class="_ _3"></span>writes, <span class="_ _3"></span>and <span class="_ _2"></span>using<span class="_ _47"> </span><span class="ff1a">fsync<span class="_ _45"> </span></span>with <span class="_ _2"></span>synchronous</span></span></span></span></div><div class="t m0 x32 h26 y134 ff19 fsf fc0 sc0 ls0 ws0">writes <span class="_ _3"></span>makes <span class="_ _3"></span>very <span class="_ _9"></span>little <span class="_ _3"></span>difference. <span class="_ _47"> </span>Note<span class="_ _47"> </span>also <span class="_ _3"></span>that <span class="_ _9"></span>adding <span class="_ _3"></span>a <span class="_ _3"></span>call <span class="_ _9"></span>to<span class="_ _47"> </span><span class="ff1a">fsync<span class="_ _45"> </span></span>at <span class="_ _3"></span>the <span class="_ _3"></span>end <span class="_ _9"></span>of</div><div class="t m0 x32 h2a y135 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>delayed <span class="_ _53"> </span>writes <span class="_ _53"> </span>makes <span class="_ _e"> </span>little <span class="_ _53"> </span>measurable <span class="_ _53"> </span>difference. <span class="_ _44"> </span>It<span class="_ _4b"> </span>is <span class="_ _53"> </span>likely <span class="_ _53"> </span>that <span class="_ _53"> </span>the <span class="_ _e"> </span>operating</div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">system <span class="_ _3"></span>ﬂushed <span class="_ _3"></span>previously <span class="_ _2"></span>written <span class="_ _3"></span>data <span class="_ _3"></span>to <span class="_ _3"></span>disk <span class="_ _3"></span>as <span class="_ _3"></span>we <span class="_ _3"></span>wer<span class="ls34b">ew<span class="_ _8"></span><span class="ls0">riting <span class="_ _3"></span>new <span class="_ _3"></span>data <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle,</span></span></div><div class="t m0 x32 h26 y137 ff19 fsf fc0 sc0 ls0 ws0">so by the time that we called<span class="_"> </span><span class="ff1a">fsync</span><span class="ls44">,v<span class="_ _d"></span><span class="ls0">ery little work was left to be done.</span></span></div><div class="t m0 x173 h2d yd5f ff19 fs10 fc0 sc0 ls0 ws0">User CPU<span class="_ _6e"> </span>System CPU<span class="_ _6e"> </span>Clock time</div><div class="t m0 x174 h2d yd60 ff19 fs10 fc0 sc0 ls0 ws0">(seconds) <span class="_ _87"> </span>(seconds)<span class="_ _170"> </span>(seconds)</div><div class="t m0 xa0 h2d yd61 ff19 fs10 fc0 sc0 ls0 ws0">Operation</div><div class="t m0 xe1 h4f yd62 ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">to<span class="_"> </span></span>/dev/null<span class="_ _32"> </span><span class="ff19">0.14 <span class="_ _b7"> </span>1.02<span class="_ _16e"> </span>5.28</span></div><div class="t m0 xe1 h4f yd63 ff19 fs11 fc0 sc0 ls0 ws0">normal<span class="_"> </span><span class="ff1a">write<span class="_ _53"> </span></span>to disk ﬁle<span class="_ _17b"> </span>0.14 <span class="_ _b7"> </span>3.21<span class="_ _17c"> </span>17.04</div><div class="t m0 xe1 h4f yd64 ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">to disk ﬁle with<span class="_"> </span></span>O_SYNC<span class="_ _e"> </span><span class="ff19">set <span class="_ _d2"> </span>0.39<span class="_ _9f"> </span>16.89 <span class="_ _17e"> </span>60.82</span></div><div class="t m0 xe1 h4f yd65 ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">to disk followed by<span class="_"> </span></span>fsync<span class="_ _17d"> </span><span class="ff19">0.13 <span class="_ _b7"> </span>3.07<span class="_ _17c"> </span>17.10</span></div><div class="t m0 xe1 h4f yd66 ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">to disk with<span class="_"> </span></span>O_SYNC<span class="_ _e"> </span><span class="ff19">set followed by<span class="_"> </span></span>fsync<span class="_ _12b"> </span><span class="ff19">0.39 <span class="_ _dd"> </span>18.18<span class="_ _16d"> </span>62.39</span></div><div class="t m0 x9d h6d yd67 ff18 fs12 fc0 sc0 ls0 ws0">Figure 3.14<span class="_ _5a"> </span><span class="ff19">Mac OS X<span class="_"> </span><span class="ff1a">HFS<span class="_ _e"> </span></span>timing results using various synchronization mechanisms</span></div><div class="t m0 x3f h5c yd68 ff19 fs29 fc0 sc0 ls0 ws0">Compare<span class="_ _47"> </span><span class="ff1a">fsync<span class="_ _45"> </span></span>and<span class="_ _45"> </span><span class="ff1a">fdatasync</span><span class="ls438">,b<span class="_ _b"></span><span class="ls0">oth <span class="_ _9"></span>of <span class="_ _3"></span>which <span class="_ _9"></span>update <span class="_ _9"></span>a <span class="_ _9"></span>ﬁle’s <span class="_ _9"></span>contents <span class="_ _9"></span>when <span class="_ _9"></span>we</span></span></div><div class="t m0 x32 h5c yd69 ff19 fs29 fc0 sc0 ls0 ws0">say <span class="_ _2"></span>so, <span class="_ _2"></span>with <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">O_SYNC<span class="_ _47"> </span></span>ﬂag, <span class="_ _2"></span>which <span class="_ _2"></span>updates <span class="_ _2"></span>a <span class="_ _2"></span>ﬁle’s <span class="_ _2"></span>contents <span class="_ _2"></span>every <span class="_ _2"></span>time <span class="_ _2"></span>we <span class="_ _2"></span>write <span class="_ _2"></span>to <span class="_ _2"></span>the</div><div class="t m0 x32 h50 yd6a ff19 fs29 fc0 sc0 ls0 ws0">ﬁle. <span class="_ _35"> </span>The<span class="_ _35"> </span>performance <span class="_ _42"> </span>of <span class="_ _23"></span>each <span class="_ _23"> </span>alternative <span class="_ _42"> </span>will <span class="_ _23"> </span>depend <span class="_ _42"> </span>on <span class="_ _23"> </span>many <span class="_ _42"> </span>factors, <span class="_ _23"> </span>including <span class="_ _42"> </span>the</div><div class="t m0 x32 h50 yd6b ff19 fs29 fc0 sc0 ls0 ws0">underlying <span class="_ _2"></span>operating <span class="_ _3"></span>system <span class="_ _3"></span>implementation, <span class="_ _3"></span>the <span class="_ _3"></span>speed <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>disk <span class="_ _3"></span>drive, <span class="_ _3"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>type</div><div class="t m0 x32 h50 yd6c ff19 fs29 fc0 sc0 ls0 ws0">of the ﬁle system.</div><div class="t m0 x3f h64 yd6d ff19 fs31 fc0 sc0 ls439 ws0">Wi<span class="_ _3"></span><span class="ls0">th <span class="_ _47"> </span>this <span class="_ _45"> </span>example, <span class="_ _47"> </span>we <span class="_ _45"> </span>see <span class="_ _47"> </span>the <span class="_ _45"> </span>need <span class="_ _45"> </span>for<span class="_ _61"> </span><span class="ff1a">fcntl</span><span class="ls43a">.O<span class="_ _56"></span><span class="ls0">ur <span class="_ _45"> </span>program <span class="_ _47"> </span>operates <span class="_ _45"> </span>on <span class="_ _47"> </span>a</span></span></span></div><div class="t m0 x32 h6e yd6e ff19 fs31 fc0 sc0 ls0 ws0">descriptor <span class="_ _23"></span>(standar<span class="ls43b">do<span class="_ _43"></span><span class="ls0">utput), <span class="_ _23"></span>never <span class="_ _23"></span>knowing <span class="_ _23"></span>the <span class="_ _23"></span>name <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>ﬁle <span class="_ _23"></span>that <span class="_ _23"></span>was <span class="_ _23"></span>opened <span class="_ _23"></span>on</span></span></div><div class="t m0 x32 h64 yd6f ff19 fs31 fc0 sc0 ls0 ws0">that <span class="_ _23"> </span>descriptor<span class="_ _1"></span><span class="ls43c">.W<span class="_ _5d"></span><span class="ls43d">ec<span class="_ _b"></span><span class="ls0">an’t <span class="_ _23"></span>set <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">O_SYNC<span class="_ _35"> </span></span>ﬂag <span class="_ _42"> </span>when <span class="_ _23"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>is <span class="_ _23"> </span>opened, <span class="_ _42"> </span>since <span class="_ _23"> </span>the <span class="_ _42"> </span>shell</span></span></span></div><div class="t m0 x32 h64 yd70 ff19 fs31 fc0 sc0 ls0 ws0">opened <span class="_ _23"> </span>the <span class="_ _42"> </span>ﬁle.<span class="_ _51"> </span><span class="ls439">Wi<span class="_ _3"></span></span>th<span class="_ _44"> </span><span class="ff1a">fcntl</span>,<span class="_ _35"> </span>we<span class="_ _35"> </span>can <span class="_ _42"> </span>modify <span class="_ _23"> </span>the <span class="_ _42"> </span>properties <span class="_ _23"> </span>of <span class="_ _42"> </span>a <span class="_ _23"> </span>descriptor<span class="_ _1"></span><span class="ls43e">,k<span class="_ _43"></span><span class="ls0">nowing</span></span></div><div class="t m0 x32 h64 yd71 ff19 fs31 fc0 sc0 ls0 ws0">only <span class="_"> </span>the <span class="_"> </span>descriptor <span class="_ _66"> </span>for <span class="_"> </span>the <span class="_ _66"> </span>open <span class="_"> </span>ﬁle.<span class="_ _50"> </span><span class="ls43f">We<span class="_ _9"></span></span>’ll <span class="_"> </span>see <span class="_ _66"> </span>another <span class="_ _66"> </span>need <span class="_"> </span>for<span class="_ _46"> </span><span class="ff1a">fcntl<span class="_ _61"> </span></span>when <span class="_"> </span>we</div><div class="t m0 x32 h6e yd72 ff19 fs31 fc0 sc0 ls0 ws0">describe nonblocking pipes (Section 15.2), since all we have with a pipe is a descriptor<span class="_ _6"></span>.</div><div class="t m0 x35 h91 yd73 ff16 fs3a fc0 sc0 ls0 ws0">3.15<span class="_ _6d"> </span><span class="ff1f">ioctl<span class="_ _54"> </span></span>Function</div><div class="t m0 x32 h64 yd74 ff19 fs31 fc0 sc0 ls0 ws0">The<span class="_ _44"> </span><span class="ff1a">ioctl<span class="_ _44"> </span></span>function <span class="_ _42"> </span>has <span class="_ _42"> </span>always <span class="_ _53"> </span>been <span class="_ _42"> </span>the <span class="_ _42"> </span>catchall <span class="_ _53"> </span>for <span class="_ _42"> </span>I/O <span class="_ _42"> </span>operations.<span class="_ _65"> </span>Anything <span class="_ _42"> </span>that</div><div class="t m0 x32 h6e yd75 ff19 fs31 fc0 sc0 ls0 ws0">couldn’t <span class="_ _2"></span>be <span class="_ _3"></span>expressed using <span class="_ _3"></span>one <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>other <span class="_ _3"></span>functions <span class="_ _2"></span>in <span class="_ _3"></span>this <span class="_ _2"></span>chapter <span class="_ _3"></span>usually <span class="_ _2"></span>ended <span class="_ _3"></span>up</div><div class="t m0 x32 h64 yd76 ff19 fs31 fc0 sc0 ls0 ws0">being <span class="_ _53"> </span>speciﬁed <span class="_ _53"> </span>with <span class="_ _53"> </span>an<span class="_ _44"> </span><span class="ff1a">ioctl</span><span class="ls440">.T<span class="_ _49"></span><span class="ls0">erminal <span class="_ _53"> </span>I/O <span class="_ _e"> </span>was <span class="_ _53"> </span>the <span class="_ _53"> </span>biggest <span class="_ _53"> </span>user <span class="_ _53"> </span>of <span class="_ _53"> </span>this <span class="_ _53"> </span>function.</span></span></div><div class="t m0 x32 h6e yd77 ff19 fs31 fc0 sc0 ls0 ws0">(When <span class="_ _e"> </span>we <span class="_"> </span>get <span class="_ _53"> </span>to <span class="_"> </span>Chapter <span class="_ _53"> </span>18, <span class="_"> </span>we’ll <span class="_ _53"> </span>see <span class="_"> </span>that <span class="_ _53"> </span>POSIX.1 <span class="_"> </span>has <span class="_ _53"> </span>replaced <span class="_ _e"> </span>the <span class="_"> </span>terminal <span class="_ _53"> </span>I/O</div><div class="t m0 x32 h6e yd78 ff19 fs31 fc0 sc0 ls0 ws0">operations with separate functions.)</div><div class="t m0 x3f h65 yd79 ff1a fs32 fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;<span class="_ _8a"> </span>/* System V */</div><div class="t m0 x3f h65 yd7a ff1a fs32 fc0 sc0 ls0 ws0">#include &lt;sys/ioctl.h&gt;<span class="_ _d9"> </span>/* BSD and Linux */</div><div class="t m0 x3f h65 yd7b ff1a fs32 fc0 sc0 ls0 ws0">int ioctl(int<span class="_"> </span><span class="ff1b">fd</span><span class="ls441">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b ls442">re<span class="_ _2"></span><span class="ls0">quest</span></span><span class="ls441">,.<span class="_ _1d"></span><span class="ls0">..);</span></span></span></span></div><div class="t m0 x107 h92 yd7c ff19 fs32 fc0 sc0 ls0 ws0">Returns:<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error<span class="_ _6"></span><span class="ls443">,s<span class="_ _5"></span><span class="ls0">omething else if OK</span></span></div><a class="l" href="#pfd" data-dest-detail='[13,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.893050px;bottom:397.131018px;width:129.336494px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
