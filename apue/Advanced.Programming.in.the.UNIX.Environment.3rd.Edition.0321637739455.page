<div id="pf1c7" class="pf w4 h1f" data-page-no="1c7"><div class="pc pc1c7 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg1c7.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>1<span class="_ _1"></span>1.6 <span class="_ _284"> </span>Thread <span class="_"> </span>Synchr<span class="_ _0"></span>onization<span class="_ _1b"> </span><span class="ff18">421</span></div><div class="t m0 x1ca h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">minidx = i;</div><div class="t m0 x1f h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">snums[sidx] = nums[idx[minidx]];</div><div class="t m0 x9d h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">idx[minidx]++;</div><div class="t m0 x8a h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y350b ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y350c ff1a fs2d fc0 sc0 ls0 ws0">main()</div><div class="t m0 x32 h57 y350d ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y31b6 ff1a fs2d fc0 sc0 ls0 ws0">unsigned long<span class="_ _68"> </span>i;</div><div class="t m0 x8a h57 y31b7 ff1a fs2d fc0 sc0 ls0 ws0">struct timeval<span class="_ _d9"> </span>start, end;</div><div class="t m0 x8a h57 y31b8 ff1a fs2d fc0 sc0 ls0 ws0">long long<span class="_ _b7"> </span>startusec, endusec;</div><div class="t m0 x8a h57 y31b9 ff1a fs2d fc0 sc0 ls0 ws0">double <span class="_ _176"> </span>elapsed;</div><div class="t m0 x8a h57 y31ba ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>err;</div><div class="t m0 x8a h57 y31bb ff1a fs2d fc0 sc0 ls0 ws0">pthread_t <span class="_ _189"> </span>tid;</div><div class="t m0 x8a h57 y1315 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y351c ff1a fs2d fc0 sc0 ls15c ws0">*C<span class="_ _1d"></span><span class="ls0">reate the initial set of numbers to sort.</span></div><div class="t m0 x214 h57 y351d ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y351e ff1a fs2d fc0 sc0 ls0 ws0">srandom(1);</div><div class="t m0 x8a h57 y351f ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; NUMNUM; i++)</div><div class="t m0 x9d h57 y3520 ff1a fs2d fc0 sc0 ls0 ws0">nums[i] = random();</div><div class="t m0 x8a h57 y131b ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y131c ff1a fs2d fc0 sc0 ls15c ws0">*C<span class="_ _1d"></span><span class="ls0">reate 8 threads to sort the numbers.</span></div><div class="t m0 x214 h57 y131d ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y131e ff1a fs2d fc0 sc0 ls0 ws0">gettimeofday(&amp;start, NULL);</div><div class="t m0 x8a h57 y131f ff1a fs2d fc0 sc0 ls0 ws0">pthread_barrier_init(&amp;b, NULL, NTHR+1);</div><div class="t m0 x8a h57 y1320 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; NTHR; i++) {</div><div class="t m0 x9d h57 y1321 ff1a fs2d fc0 sc0 ls0 ws0">err = pthread_create(&amp;tid, NULL, thr_fn, (void *)(i * TNUM));</div><div class="t m0 x9d h57 y1322 ff1a fs2d fc0 sc0 ls0 ws0">if (err != 0)</div><div class="t m0 x1f h57 y3419 ff1a fs2d fc0 sc0 ls0 ws0">err_exit(err, &quot;canâ€™t create thread&quot;);</div><div class="t m0 x8a h57 y341a ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y341b ff1a fs2d fc0 sc0 ls0 ws0">pthread_barrier_wait(&amp;b);</div><div class="t m0 x8a h57 y341c ff1a fs2d fc0 sc0 ls0 ws0">merge();</div><div class="t m0 x8a h57 y341d ff1a fs2d fc0 sc0 ls0 ws0">gettimeofday(&amp;end, NULL);</div><div class="t m0 x8a h57 y1349 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y134a ff1a fs2d fc0 sc0 ls15c ws0">*P<span class="_ _1d"></span><span class="ls0">rint the sorted list.</span></div><div class="t m0 x214 h57 y134b ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y134c ff1a fs2d fc0 sc0 ls0 ws0">startusec = start.tv_sec * 1000000 + start.tv_usec;</div><div class="t m0 x8a h57 y134d ff1a fs2d fc0 sc0 ls0 ws0">endusec = end.tv_sec * 1000000 + end.tv_usec;</div><div class="t m0 x8a h57 y134e ff1a fs2d fc0 sc0 ls0 ws0">elapsed = (double)(endusec - startusec) / 1000000.0;</div><div class="t m0 x8a h57 y134f ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;sort took %.4f seconds\n&quot;, elapsed);</div><div class="t m0 x8a h57 y1350 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; NUMNUM; i++)</div><div class="t m0 x9d h57 y1351 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;%ld\n&quot;, snums[i]);</div><div class="t m0 x8a h57 y1352 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y1353 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x110 h2d y1354 ff18 fs10 fc0 sc0 ls0 ws0">Figure 1<span class="_ _0"></span>1.16<span class="_ _54"> </span><span class="ff19">Using a barrier</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
