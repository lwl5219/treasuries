<div id="pf176" class="pf w4 h1f" data-page-no="176"><div class="pc pc176 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg176.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">340<span class="_ _1b"> </span><span class="ff19">Signals <span class="_ _24b"> </span>Chapter<span class="_ _21"> </span>10</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">Earlier <span class="_ _e"> </span>implementations <span class="_ _e"> </span>of<span class="_ _4b"> </span><span class="ff1a">sleep<span class="_ _59"> </span></span>looked <span class="_ _53"> </span>like <span class="_"> </span>our <span class="_ _53"> </span>program, <span class="_ _53"> </span>with <span class="_"> </span>pr<span class="_ _1"></span>oblems <span class="_"> </span>1 <span class="_ _53"> </span>and <span class="_ _e"> </span>2</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">corrected <span class="_ _47"> </span>as <span class="_ _47"> </span>described.<span class="_ _5f"> </span>Ther<span class="lsc79">ea<span class="_ _62"></span><span class="ls45">re <span class="_ _45"> </span>t<span class="_ _2"></span><span class="ls0">wo <span class="_ _45"> </span>ways <span class="_ _47"> </span>to <span class="_ _47"> </span>correct <span class="_ _47"> </span>problem <span class="_ _47"> </span>3.<span class="_ _5f"> </span>The <span class="_ _45"> </span>ﬁrst <span class="_ _47"> </span>uses</span></span></span></div><div class="t m0 x32 h26 y131 ff1a fsf fc0 sc0 ls0 ws0">setjmp<span class="ff19 ls2ee">,w<span class="_ _5b"></span><span class="ls0">hich <span class="_ _66"> </span>we <span class="_"> </span>show <span class="_ _66"> </span>in <span class="_"> </span>the <span class="_ _66"> </span>next <span class="_"> </span>example.<span class="_ _50"> </span>The <span class="_"> </span>other <span class="_"> </span>uses<span class="_ _46"> </span><span class="ff1a">sigprocmask<span class="_ _46"> </span></span>and</span></span></div><div class="t m0 x32 h26 y132 ff1a fsf fc0 sc0 ls0 ws0">sigsuspend<span class="ff19 ls44">,a<span class="_ _d"></span><span class="ls0">nd we describe it in Section 10.19.</span></span></div><div class="t m0 x35 h4c y2b84 ff16 fs26 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h4d y2b85 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _2"></span>SVR2 <span class="_ _2"></span>implementation <span class="_ _2"></span>of<span class="_ _47"> </span><span class="ff1a">sleep<span class="_ _66"> </span></span>used<span class="_ _47"> </span><span class="ff1a">setjmp<span class="_ _66"> </span></span>and<span class="_ _66"> </span><span class="ff1a">longjmp<span class="_ _47"> </span></span>(Section <span class="_ _2"></span>7.10) <span class="_ _2"></span>to <span class="_ _2"></span>avoid</div><div class="t m0 x32 h49 y2b86 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>race <span class="_ _2"></span>condition <span class="_ _2"></span>described <span class="_ _2"></span>in <span class="_ _2"></span>problem 3 <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>previous example.<span class="_ _61"> </span><span class="ls597">As<span class="_ _d"></span><span class="ls0">imple <span class="_ _2"></span>version <span class="_ _2"></span>of</span></span></div><div class="t m0 x32 h4d y2b87 ff19 fs26 fc0 sc0 ls0 ws0">this <span class="_"> </span>function, <span class="_ _47"> </span>called<span class="_ _46"> </span><span class="ff1a">sleep2</span>,<span class="_ _61"> </span>is<span class="_ _46"> </span>shown <span class="_ _47"> </span>in <span class="_"> </span>Figur<span class="lsc7a">e1<span class="_ _5b"></span><span class="ls0">0.8. <span class="_ _46"> </span>(T<span class="_ _6"></span><span class="lsc7a">or<span class="_ _5b"></span><span class="ls0">educe <span class="_ _66"> </span>the <span class="_ _47"> </span>size <span class="_"> </span>of <span class="_ _66"> </span>this</span></span></span></span></div><div class="t m0 x32 h49 y2b88 ff19 fs26 fc0 sc0 ls0 ws0">example, we don’t handle problems 1 and 2 described earlier<span class="_ _6"></span>.)</div><div class="t m0 x32 h5d y2b89 ff1a fs2f fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;setjmp.h&gt;</div><div class="t m0 x32 h5d y2b8a ff1a fs2f fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;signal.h&gt;</div><div class="t m0 x32 h5d y2b8b ff1a fs2f fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;unistd.h&gt;</div><div class="t m0 x32 h5d y2b8c ff1a fs2f fc0 sc0 ls0 ws0">static jmp_buf<span class="_ _d9"> </span>env_alrm;</div><div class="t m0 x32 h5d y2b8d ff1a fs2f fc0 sc0 ls0 ws0">static void</div><div class="t m0 x32 h5d y2b8e ff1a fs2f fc0 sc0 ls0 ws0">sig_alrm(int signo)</div><div class="t m0 x32 h5d y2b8f ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y2b90 ff1a fs2f fc0 sc0 ls0 ws0">longjmp(env_alrm, 1);</div><div class="t m0 x32 h5d y2b91 ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h5d y2b92 ff1a fs2f fc0 sc0 ls0 ws0">unsigned int</div><div class="t m0 x32 h5d y2b93 ff1a fs2f fc0 sc0 ls0 ws0">sleep2(unsigned int seconds)</div><div class="t m0 x32 h5d y2b94 ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y2b95 ff1a fs2f fc0 sc0 ls0 ws0">if (signal(SIGALRM, sig_alrm) == SIG_ERR)</div><div class="t m0 x9d h5d y2b96 ff1a fs2f fc0 sc0 ls0 ws0">return(seconds);</div><div class="t m0 x8a h5d y2b97 ff1a fs2f fc0 sc0 ls0 ws0">if (setjmp(env_alrm) == 0) {</div><div class="t m0 x9d h5d y2b98 ff1a fs2f fc0 sc0 ls0 ws0">alarm(seconds); <span class="_ _15"> </span>/*<span class="_"> </span>start the timer */</div><div class="t m0 x9d h5d y2b99 ff1a fs2f fc0 sc0 ls0 ws0">pause(); <span class="_ _bd"> </span>/*<span class="_"> </span>next caught signal wakes us up */</div><div class="t m0 x8a h5d y2b9a ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h5d y2b9b ff1a fs2f fc0 sc0 ls0 ws0">return(alarm(0)); <span class="_ _189"> </span>/*<span class="_"> </span>turn off timer, return unslept time */</div><div class="t m0 x32 h5d y2b9c ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x38 h6d y2b9d ff18 fs12 fc0 sc0 ls0 ws0">Figure 10.8<span class="_ _5a"> </span><span class="ff19">Another (imperfect) implementation of<span class="_"> </span><span class="ff1a">sleep</span></span></div><div class="t m0 x32 h5c y2b9e ff19 fs29 fc0 sc0 ls0 ws0">The<span class="_ _47"> </span><span class="ff1a">sleep2<span class="_ _45"> </span></span>function <span class="_ _3"></span>avoids <span class="_ _3"></span>the <span class="_ _9"></span>race <span class="_ _3"></span>condition <span class="_ _9"></span>from <span class="_ _3"></span>Figur<span class="lsc7b">e1<span class="_ _b"></span><span class="ls0">0.7. <span class="_ _47"> </span>Even<span class="_ _45"> </span>if <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">pause<span class="_ _47"> </span></span>is</span></span></div><div class="t m0 x32 h5c y2b9f ff19 fs29 fc0 sc0 ls0 ws0">never executed, the<span class="_"> </span><span class="ff1a">sleep2<span class="_ _80"> </span></span>function returns when the<span class="_"> </span><span class="ff1a">SIGALRM<span class="_ _80"> </span></span>occurs.</div><div class="t m0 x3f h5c y2ba0 ff19 fs29 fc0 sc0 ls0 ws0">Ther<span class="lsc7c">ei<span class="_ _b"></span><span class="ls0">s, <span class="_ _3"></span>however<span class="_ _1"></span><span class="lsc7d">,a<span class="_ _b"></span><span class="ls0">nother <span class="_ _9"></span>subtle <span class="_ _9"></span>problem <span class="_ _3"></span>with <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">sleep2<span class="_ _45"> </span></span>function <span class="_ _3"></span>that <span class="_ _9"></span>involves</span></span></span></span></div><div class="t m0 x32 h5c y2ba1 ff19 fs29 fc0 sc0 ls0 ws0">its <span class="_ _3"></span>interaction <span class="_ _3"></span>with <span class="_ _3"></span>other <span class="_ _3"></span>signals.<span class="_ _16"> </span>If <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">SIGALRM<span class="_ _47"> </span></span>interrupts <span class="_ _2"></span>some <span class="_ _3"></span>other <span class="_ _3"></span>signal <span class="_ _3"></span>handler<span class="_ _1"></span>,</div><div class="t m0 x32 h5c y2ba2 ff19 fs29 fc0 sc0 ls0 ws0">then <span class="_ _3"></span>when <span class="_ _3"></span>we <span class="_ _9"></span>call<span class="_ _47"> </span><span class="ff1a">longjmp</span>,<span class="_ _47"> </span>we<span class="_ _45"> </span>abort <span class="_ _3"></span>the <span class="_ _3"></span>other <span class="_ _3"></span>signal <span class="_ _9"></span>handler<span class="_ _6"></span><span class="lsc7e">.F<span class="_ _1d"></span><span class="ls0">igur<span class="lsc7f">e1<span class="_ _b"></span><span class="ls0">0.9 <span class="_ _9"></span>shows <span class="_ _3"></span>this</span></span></span></span></div><div class="t m0 x32 h5c y2ba3 ff19 fs29 fc0 sc0 ls0 ws0">scenario. <span class="_ _44"> </span>The<span class="_ _35"> </span>loop <span class="_ _42"> </span>in <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">SIGINT<span class="_ _44"> </span></span>handler <span class="_ _42"> </span>was <span class="_ _42"> </span>written <span class="_ _42"> </span>so <span class="_ _42"> </span>that <span class="_ _42"> </span>it <span class="_ _42"> </span>executes <span class="_ _53"> </span>for <span class="_ _42"> </span>longer</div><div class="t m0 x32 h50 y2ba4 ff19 fs29 fc0 sc0 ls0 ws0">than <span class="_ _2"></span>5 <span class="_ _3"></span>seconds <span class="_ _3"></span>on <span class="_ _2"></span>one <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>systems <span class="_ _3"></span>used <span class="_ _3"></span>by <span class="_ _2"></span>the <span class="_ _3"></span>author<span class="_ _1"></span><span class="lsc80">.W<span class="_ _7"></span><span class="lsc81">es<span class="_ _8"></span><span class="ls0">imply <span class="_ _3"></span>want <span class="_ _3"></span>it <span class="_ _2"></span>to <span class="_ _3"></span>execute</span></span></span></div><div class="t m0 x32 h5c y2ba5 ff19 fs29 fc0 sc0 ls0 ws0">longer than the argument to<span class="_"> </span><span class="ff1a">sleep2</span><span class="lsc82">.T<span class="_ _4a"></span><span class="ls0">he integer<span class="_"> </span><span class="ff1a">k<span class="_ _66"> </span></span>is declared as<span class="_"> </span><span class="ff1a">volatile<span class="_ _66"> </span></span>to prevent</span></span></div><div class="t m0 x32 h50 y2ba6 ff19 fs29 fc0 sc0 ls0 ws0">an optimizing compiler from discar<span class="_ _0"></span>ding the loop.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
