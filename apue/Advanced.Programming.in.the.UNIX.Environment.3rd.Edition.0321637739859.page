<div id="pf35b" class="pf w4 h1f" data-page-no="35b"><div class="pc pc35b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg35b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">825</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">385 <span class="_ _15"> </span>req.size<span class="_"> </span><span class="ls15c">=n<span class="_ _1d"></span><span class="ls0">tohl(req.size);</span></span></div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">386 <span class="_ _15"> </span>req.flags<span class="_"> </span><span class="ls15c">=n<span class="_ _1d"></span><span class="ls0">tohl(req.flags);</span></span></div><div class="t m0 x32 h57 y13a0 ff1a fs2d fc0 sc0 ls0 ws0">387 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y846 ff1a fs2d fc0 sc0 ls0 ws0">388 <span class="_ _8a"> </span>*<span class="_"> </span>Create the data file.</div><div class="t m0 x32 h57 y847 ff1a fs2d fc0 sc0 ls0 ws0">389 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y13a1 ff1a fs2d fc0 sc0 ls0 ws0">390 <span class="_ _15"> </span>jobid<span class="_"> </span><span class="ls15c">=g<span class="_ _1d"></span><span class="ls0">et_newjobno();</span></span></div><div class="t m0 x32 h57 y1fb8 ff1a fs2d fc0 sc0 ls0 ws0">391 <span class="_ _15"> </span>sprintf(name,<span class="_"> </span>&quot;%s/%s/%d&quot;, SPOOLDIR, DATADIR, jobid);</div><div class="t m0 x32 h57 y1fb9 ff1a fs2d fc0 sc0 ls0 ws0">392 <span class="_ _15"> </span>fd<span class="_"> </span><span class="ls15c">=c<span class="_ _1d"></span><span class="ls0">reat(name, FILEPERM);</span></span></div><div class="t m0 x32 h57 y1fba ff1a fs2d fc0 sc0 ls0 ws0">393 <span class="_ _15"> </span>if<span class="_"> </span>(fd &lt; 0) {</div><div class="t m0 x32 h57 y1fbb ff1a fs2d fc0 sc0 ls0 ws0">394 <span class="_ _186"> </span>res.jobid<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y1fbc ff1a fs2d fc0 sc0 ls0 ws0">395 <span class="_ _186"> </span>res.retcode<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(errno);</span></span></div><div class="t m0 x32 h57 y1fbd ff1a fs2d fc0 sc0 ls0 ws0">396 <span class="_ _186"> </span>log_msg(&quot;client_thread:<span class="_"> </span>can’t create %s: %s&quot;, name,</div><div class="t m0 x32 h57 y1fbe ff1a fs2d fc0 sc0 ls0 ws0">397 <span class="_ _74"> </span>strerror(res.retcode));</div><div class="t m0 x32 h57 y1fbf ff1a fs2d fc0 sc0 ls0 ws0">398 <span class="_ _186"> </span>strncpy(res.msg,<span class="_"> </span>strerror(res.retcode), MSGLEN_MAX);</div><div class="t m0 x32 h57 y1fc0 ff1a fs2d fc0 sc0 ls0 ws0">399 <span class="_ _186"> </span>writen(sockfd,<span class="_"> </span>&amp;res, sizeof(struct printresp));</div><div class="t m0 x32 h57 y1fc1 ff1a fs2d fc0 sc0 ls0 ws0">400 <span class="_ _186"> </span>pthread_exit((void<span class="_"> </span>*)1);</div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">401 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y57a4 ff1a fs2d fc0 sc0 ls0 ws0">402 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y458a ff1a fs2d fc0 sc0 ls0 ws0">403 <span class="_ _8a"> </span>*<span class="_"> </span>Read the file and store it in the spool directory.</div><div class="t m0 x32 h57 y458b ff1a fs2d fc0 sc0 ls0 ws0">404 <span class="_ _8a"> </span>*<span class="_"> </span>Try to figure out if the file is a PostScript file</div><div class="t m0 x32 h57 y458c ff1a fs2d fc0 sc0 ls0 ws0">405 <span class="_ _8a"> </span>*<span class="_"> </span>or a plain text file.</div><div class="t m0 x32 h57 y2ada ff1a fs2d fc0 sc0 ls0 ws0">406 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2adb ff1a fs2d fc0 sc0 ls0 ws0">407 <span class="_ _15"> </span>first<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y2adc ff1a fs2d fc0 sc0 ls0 ws0">408 <span class="_ _15"> </span>while<span class="_"> </span>((nr = tread(sockfd, buf, IOBUFSZ, 20)) &gt; 0) {</div><div class="t m0 x32 h57 y2add ff1a fs2d fc0 sc0 ls0 ws0">409 <span class="_ _186"> </span>if<span class="_"> </span>(first) {</div><div class="t m0 x32 h57 y2ade ff1a fs2d fc0 sc0 ls0 ws0">410 <span class="_ _82"> </span>first<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y2c66 ff1a fs2d fc0 sc0 ls0 ws0">411 <span class="_ _82"> </span>if<span class="_"> </span>(strncmp(buf, &quot;%!PS&quot;, 4) != 0)</div><div class="t m0 x32 h57 y2c67 ff1a fs2d fc0 sc0 ls0 ws0">412 <span class="_ _1e7"> </span>req.flags<span class="_"> </span>|= PR_TEXT;</div><div class="t m0 x32 h57 y573f ff1a fs2d fc0 sc0 ls0 ws0">413 <span class="_ _186"> </span>}</div><div class="t m0 x32 h49 y5740 ff19 fs26 fc0 sc0 ls0 ws0">[385 <span class="_ _a"></span>– <span class="_ _a"></span>401]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>c<span class="_ _9"></span></span>onvert the integer ﬁelds in the <span class="_ _2"></span>request header to host byte or<span class="_ _0"></span>der and call</div><div class="t m0 x11a h4d y5741 ff1a fs26 fc0 sc0 ls0 ws0">get_newjobno<span class="_ _45"> </span><span class="ff19">to <span class="_ _9"></span>reserve <span class="_ _9"></span>the <span class="_ _23"></span>next <span class="_ _9"></span>job <span class="_ _9"></span>ID <span class="_ _23"></span>for <span class="_ _9"></span>this <span class="_ _9"></span>print <span class="_ _23"></span>request. <span class="_ _45"> </span>W<span class="_ _4"></span><span class="ls17a7">ec<span class="_ _b"></span><span class="lscc">re<span class="_ _2"></span><span class="ls0">ate</span></span></span></span></div><div class="t m0 x11a h4d y5742 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>job <span class="_ _3"></span>data <span class="_ _9"></span>ﬁle, <span class="_ _9"></span>named<span class="_ _45"> </span><span class="ff1a">/var/spool/printer/data/<span class="ff1b">jobid</span></span><span class="ls174d">,w<span class="_ _b"></span><span class="ls0">here<span class="_ _47"> </span><span class="ff1b">jobid<span class="_ _45"> </span></span>is</span></span></div><div class="t m0 x11a h49 y5743 ff19 fs26 fc0 sc0 ls0 ws0">the request’s job ID.<span class="_ _61"> </span><span class="ls164">We <span class="_ _53"> </span>u<span class="_ _23"></span></span>se permissions that <span class="_ _2"></span>prevent others from being <span class="_ _2"></span>able</div><div class="t m0 x11a h4d y5744 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ad <span class="_ _9"></span>the <span class="_ _3"></span>ﬁles <span class="_ _3"></span>(<span class="ff1a">FILEPERM<span class="_ _45"> </span></span>is <span class="_ _3"></span>deﬁned <span class="_ _3"></span>as<span class="_ _45"> </span><span class="ff1a">S_IRUSR|S_IWUSR<span class="_ _47"> </span></span>in<span class="_ _47"> </span><span class="ff1a">print.h</span>). <span class="_ _45"> </span>If</span></div><div class="t m0 x11a h49 y5c05 ff19 fs26 fc0 sc0 ls0 ws0">we can’t create the ﬁle, we log an error message, send a failur<span class="_ _0"></span><span class="ls17a8">er<span class="_ _4f"></span><span class="ls0">esponse back</span></span></div><div class="t m0 x11a h4d y5c06 ff19 fs26 fc0 sc0 ls0 ws0">to the client, and terminate the thread by calling<span class="_"> </span><span class="ff1a">pthread_exit</span>.</div><div class="t m0 x32 h49 y5747 ff19 fs26 fc0 sc0 ls0 ws0">[402 <span class="_ _a"></span>– <span class="_ _a"></span>413]<span class="_ _65"> </span><span class="ls164">We <span class="_ _47"> </span>r<span class="_ _9"></span></span>ead <span class="_ _42"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>contents <span class="_ _23"> </span>from <span class="_ _23"></span>the <span class="_ _23"> </span>client, <span class="_ _42"> </span>with <span class="_ _23"> </span>the <span class="_ _42"> </span>intention <span class="_ _23"> </span>of <span class="_ _42"> </span>writing <span class="_ _23"> </span>the</div><div class="t m0 x11a h49 y5c07 ff19 fs26 fc0 sc0 ls0 ws0">contents <span class="_ _47"> </span>out <span class="_ _66"> </span>to <span class="_ _47"> </span>our <span class="_ _47"> </span>private <span class="_ _47"> </span>copy <span class="_ _47"> </span>of <span class="_ _47"> </span>the <span class="_ _47"> </span>data <span class="_ _66"> </span>ﬁle.<span class="_ _5f"> </span>But <span class="_ _47"> </span>before<span class="_ _46"> </span>we<span class="_ _16"> </span>write</div><div class="t m0 x11a h49 y5c08 ff19 fs26 fc0 sc0 ls0 ws0">anything, <span class="_ _9"></span>we <span class="_ _23"></span>need <span class="_ _9"></span>to <span class="_ _23"></span>check <span class="_ _9"></span>if <span class="_ _23"></span>this <span class="_ _9"></span>is <span class="_ _23"></span>a <span class="_ _9"></span>PostScript <span class="_ _23"></span>ﬁle <span class="_ _9"></span>the <span class="_ _23"></span>ﬁrst <span class="_ _9"></span>time <span class="_ _23"></span>through</div><div class="t m0 x11a h4d y5c09 ff19 fs26 fc0 sc0 ls0 ws0">the loop.<span class="_ _61"> </span>If <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>doesn’t <span class="_ _2"></span>begin <span class="_ _2"></span>with the <span class="_ _2"></span>pattern<span class="_ _47"> </span><span class="ff1a">%!PS</span>,<span class="_"> </span>we<span class="_ _66"> </span>can <span class="_ _2"></span>assume <span class="_ _2"></span>that</div><div class="t m0 x11a h4d y5c0a ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>is <span class="_ _3"></span>plaintext, <span class="_ _3"></span>so <span class="_ _3"></span>we <span class="_ _3"></span>set <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">PR_TEXT<span class="_ _47"> </span></span>ﬂag <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>request <span class="_ _2"></span>header <span class="_ _3"></span>in <span class="_ _3"></span>this</div><div class="t m0 x11a h4d y5c0b ff19 fs26 fc0 sc0 ls0 ws0">case. <span class="_ _35"> </span>(Recall<span class="_ _35"> </span>that <span class="_ _42"> </span>the <span class="_ _23"> </span>client <span class="_ _42"> </span>can <span class="_ _23"> </span>also <span class="_ _42"> </span>set <span class="_ _23"> </span>this <span class="_ _42"> </span>ﬂag <span class="_ _23"> </span>if <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">-t<span class="_ _35"> </span></span>ﬂag <span class="_ _42"> </span>is <span class="_ _23"> </span>included</div><div class="t m0 x11a h4d y5c0c ff19 fs26 fc0 sc0 ls0 ws0">when <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">print<span class="_ _45"> </span></span>command <span class="_ _3"></span>is <span class="_ _3"></span>executed.)<span class="_ _16"> </span>Although <span class="_ _9"></span>PostScript <span class="_ _3"></span>programs <span class="_ _3"></span>are</div><div class="t m0 x11a h4d y5c0d ff19 fs26 fc0 sc0 ls0 ws0">not <span class="_ _45"> </span>required <span class="_ _45"> </span>to <span class="_ _45"> </span>start <span class="_ _45"> </span>with <span class="_ _35"> </span>the <span class="_ _45"> </span>pattern<span class="_ _51"> </span><span class="ff1a">%!PS</span><span class="ls17a9">,t<span class="_ _26"></span><span class="ls0">he <span class="_ _45"> </span>document <span class="_ _35"> </span>formatting</span></span></div><div class="t m0 x11a h49 y5c0e ff19 fs26 fc0 sc0 ls0 ws0">guidelines (Adobe Systems</div><div class="t m0 x1f5 h49 y5c0f ff19 fs26 fc0 sc0 ls0 ws0">[</div><div class="t m0 xdd h49 y5c0e ff19 fs26 fc0 sc0 ls0 ws0">1999</div><div class="t m0 x115 h49 y5c0f ff19 fs26 fc0 sc0 ls0 ws0">]</div><div class="t m0 xeb h49 y5c0e ff19 fs26 fc0 sc0 lsd3 ws0">)s<span class="_ _d"></span><span class="ls0">trongly recommends that they do.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
