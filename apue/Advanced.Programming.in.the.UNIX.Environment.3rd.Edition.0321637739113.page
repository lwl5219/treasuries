<div id="pf71" class="pf w4 h1f" data-page-no="71"><div class="pc pc71 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg71.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>3.12<span class="_ _107"> </span><span class="ff1a">dup<span class="_ _44"> </span></span>and<span class="_ _59"> </span><span class="ff1a">dup2<span class="_ _4b"> </span></span>Functions<span class="_ _1b"> </span><span class="ff18">79</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">Calling<span class="_"> </span><span class="ff1a">pwrite<span class="_ _66"> </span></span>is equivalent <span class="_ _2"></span>to calling<span class="_ _66"> </span><span class="ff1a">lseek<span class="_ _66"> </span></span>followed by <span class="_ _2"></span>a call <span class="_ _2"></span>to<span class="_"> </span><span class="ff1a">write</span><span class="ls3f0">,w<span class="_ _d"></span><span class="ls0">ith <span class="_ _2"></span>similar</span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">exceptions.</div><div class="t m0 x35 h27 yc35 ff16 fsf fc0 sc0 ls0 ws0">Creating a File</div><div class="t m0 x32 h26 yc36 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _80"> </span>s<span class="_ _9"></span><span class="ls0">aw <span class="_ _9"></span>another <span class="_ _3"></span>example <span class="_ _9"></span>of <span class="_ _3"></span>an <span class="_ _9"></span>atomic <span class="_ _3"></span>operation <span class="_ _9"></span>when <span class="_ _3"></span>we <span class="_ _9"></span>described <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">O_CREAT<span class="_ _47"> </span></span>and</span></div><div class="t m0 x32 h26 yc37 ff1a fsf fc0 sc0 ls0 ws0">O_EXCL<span class="_ _35"> </span><span class="ff19">options <span class="_ _9"></span>for <span class="_ _23"> </span>the<span class="_ _35"> </span></span>open<span class="_ _35"> </span><span class="ff19">function. <span class="_ _45"> </span>When<span class="_ _35"> </span>both <span class="_ _23"></span>of <span class="_ _23"></span>these <span class="_ _9"></span>options <span class="_ _23"> </span>ar<span class="ls3f1">es<span class="_ _43"></span><span class="ls0">peciﬁed, <span class="_ _23"> </span>the</span></span></span></div><div class="t m0 x32 h26 yc38 ff1a fsf fc0 sc0 ls0 ws0">open<span class="_ _45"> </span><span class="ff19">will <span class="_ _3"></span>fail <span class="_ _9"></span>if <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>already <span class="_ _9"></span>exists.<span class="_ _5a"> </span><span class="ls5f">We <span class="_ _66"> </span>a<span class="_ _9"></span></span>lso <span class="_ _9"></span>said <span class="_ _9"></span>that <span class="_ _9"></span>the <span class="_ _9"></span>check <span class="_ _9"></span>for <span class="_ _9"></span>the <span class="_ _9"></span>existence <span class="_ _9"></span>of</span></div><div class="t m0 x32 h2a yc39 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>and <span class="_ _9"></span>the <span class="_ _3"></span>creation <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>ﬁle <span class="_ _3"></span>was <span class="_ _9"></span>performed <span class="_ _3"></span>as <span class="_ _3"></span>an <span class="_ _9"></span>atomic <span class="_ _3"></span>operation.<span class="_ _5a"> </span>If <span class="_ _3"></span>we <span class="_ _3"></span>didn’t</div><div class="t m0 x32 h2a yc3a ff19 fsf fc0 sc0 ls0 ws0">have this atomic operation, we might try</div><div class="t m0 x3f h57 yc3b ff1a fs2d fc0 sc0 ls0 ws0">if ((fd = open(path, O_WRONLY)) &lt; 0) {</div><div class="t m0 xc2 h57 yc3c ff1a fs2d fc0 sc0 ls0 ws0">if (errno == ENOENT) {</div><div class="t m0 x16e h57 yc3d ff1a fs2d fc0 sc0 ls0 ws0">if ((fd = creat(path, mode)) &lt; 0)</div><div class="t m0 xda h57 yc3e ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;creat error&quot;);</div><div class="t m0 xc2 h57 yc3f ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x16e h57 yc40 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;open error&quot;);</div><div class="t m0 xc2 h57 yc41 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x3f h57 yc42 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h26 yc43 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _9"></span>problem <span class="_ _3"></span>occurs <span class="_ _9"></span>if <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>is <span class="_ _9"></span>created <span class="_ _9"></span>by <span class="_ _9"></span>another <span class="_ _9"></span>process <span class="_ _3"></span>between <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">open<span class="_ _45"> </span></span>and <span class="_ _9"></span>the</div><div class="t m0 x32 h26 yc44 ff1a fsf fc0 sc0 ls0 ws0">creat<span class="ff19 ls3f2">.I<span class="_ _1d"></span><span class="ls3f3">ft<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>ﬁle <span class="_ _3"></span>is <span class="_ _3"></span>created by <span class="_ _3"></span>another <span class="_ _3"></span>process between <span class="_ _3"></span>these <span class="_ _2"></span>two <span class="_ _3"></span>function <span class="_ _3"></span>calls, <span class="_ _2"></span>and <span class="_ _3"></span>if</span></span></span></div><div class="t m0 x32 h26 yc45 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _9"></span>other <span class="_ _23"></span>process <span class="_ _9"></span>writes <span class="_ _9"></span>something <span class="_ _23"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle, <span class="_ _23"></span>that <span class="_ _9"></span>data <span class="_ _23"></span>is <span class="_ _9"></span>erased <span class="_ _23"></span>when <span class="_ _9"></span>this<span class="_ _35"> </span><span class="ff1a">creat<span class="_ _45"> </span></span>is</div><div class="t m0 x32 h2a yc46 ff19 fsf fc0 sc0 ls0 ws0">executed. <span class="_ _16"> </span>Combining<span class="_ _5a"> </span>the <span class="_ _47"> </span>test <span class="_ _45"> </span>for <span class="_ _47"> </span>existence <span class="_ _45"> </span>and <span class="_ _45"> </span>the <span class="_ _47"> </span>creation <span class="_ _47"> </span>into <span class="_ _45"> </span>a <span class="_ _47"> </span>single <span class="_ _45"> </span>atomic</div><div class="t m0 x32 h2a yc47 ff19 fsf fc0 sc0 ls0 ws0">operation avoids this problem.</div><div class="t m0 x3f h2b yc48 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _3"></span>general, <span class="_ _9"></span>the <span class="_ _3"></span>term<span class="_ _45"> </span><span class="ff1b">atomic <span class="_ _3"></span>operation<span class="_ _45"> </span></span><span class="ls45">re</span>fers <span class="_ _9"></span>to <span class="_ _9"></span>an <span class="_ _3"></span>operation <span class="_ _9"></span>that <span class="_ _3"></span>might <span class="_ _9"></span>be <span class="_ _9"></span>composed</div><div class="t m0 x32 h2a yc49 ff19 fsf fc0 sc0 ls0 ws0">of <span class="_"> </span>multiple <span class="_"> </span>steps.<span class="_ _48"> </span>If <span class="_"> </span>the <span class="_"> </span>operation <span class="_"> </span>is <span class="_"> </span>performed <span class="_"> </span>atomically<span class="_ _4"></span><span class="ls3f4">,e<span class="_ _4a"></span><span class="ls0">ither <span class="_"> </span>all <span class="_"> </span>the <span class="_"> </span>steps <span class="_"> </span>are</span></span></div><div class="t m0 x32 h2a yc4a ff19 fsf fc0 sc0 ls0 ws0">performed <span class="_ _9"></span>(on <span class="_ _3"></span>success) <span class="_ _9"></span>or <span class="_ _9"></span>none <span class="_ _9"></span>ar<span class="ls3f5">ep<span class="_ _b"></span><span class="ls0">erformed <span class="_ _3"></span>(on <span class="_ _9"></span>failure). <span class="_ _45"> </span>It<span class="_ _47"> </span>must <span class="_ _9"></span>not <span class="_ _9"></span>be <span class="_ _9"></span>possible <span class="_ _9"></span>for</span></span></div><div class="t m0 x32 h2a yc4b ff19 fsf fc0 sc0 ls0 ws0">only a subset of the steps to be performed.<span class="_ _46"> </span><span class="ls5f">We<span class="_ _9"></span></span>’ll <span class="_ _2"></span>return to the topic of atomic operations</div><div class="t m0 x32 h26 yc4c ff19 fsf fc0 sc0 ls0 ws0">when we describe the<span class="_"> </span><span class="ff1a">link<span class="_ _80"> </span></span>function (Section 4.15) and recor<span class="ls44">dl<span class="_ _4f"></span><span class="ls0">ocking (Section 14.3).</span></span></div><div class="t m0 x35 h75 yc4d ff16 fs2b fc0 sc0 ls0 ws0">3.12<span class="_ _6d"> </span><span class="ff1f">dup<span class="_ _54"> </span></span>and<span class="_ _54"> </span><span class="ff1f">dup2<span class="_ _54"> </span></span>Functions</div><div class="t m0 x32 h2a yc4e ff19 fsf fc0 sc0 ls0 ws0">An existing ﬁle descriptor is duplicated by either of the following functions:</div><div class="t m0 x3f h57 y4fd ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h57 yc4f ff1a fs2d fc0 sc0 ls0 ws0">int dup(int<span class="_"> </span><span class="ff1b">fd</span>);</div><div class="t m0 x3f h57 yc50 ff1a fs2d fc0 sc0 ls0 ws0">int dup2(int<span class="_"> </span><span class="ff1b">fd</span><span class="ls15c">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">fd2</span>);</span></span></div><div class="t m0 xc5 h5f yc51 ff19 fs2d fc0 sc0 ls0 ws0">Both return: new ﬁle descriptor if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x32 h4d yc52 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_"> </span>new <span class="_"> </span>ﬁle <span class="_"> </span>descriptor <span class="_"> </span>r<span class="_ _1"></span>eturned <span class="_"> </span>by<span class="_ _46"> </span><span class="ff1a">dup<span class="_ _46"> </span></span>is <span class="_"> </span>guaranteed <span class="_"> </span>to <span class="_"> </span>be <span class="_"> </span>the <span class="_"> </span>lowest-number<span class="_ _1"></span>ed</div><div class="t m0 x32 h4d yc53 ff19 fs26 fc0 sc0 ls0 ws0">available ﬁle descriptor<span class="_ _1"></span><span class="ls3f6">.W<span class="_ _62"></span><span class="ls0">ith<span class="_ _66"> </span><span class="ff1a">dup2</span>,<span class="_"> </span>we<span class="_"> </span>specify the <span class="_ _2"></span>value of the new descriptor <span class="_ _2"></span>with the</span></span></div><div class="t m0 x32 h4d yc54 ff1b fs26 fc0 sc0 ls0 ws0">fd2<span class="_ _66"> </span><span class="ff19">argument. <span class="_"> </span>If<span class="_ _47"> </span></span>fd2<span class="_ _66"> </span><span class="ff19">is <span class="_ _2"></span>already open, <span class="_ _2"></span>it <span class="_ _2"></span>is <span class="_ _2"></span>ﬁrst <span class="_ _2"></span>closed.<span class="_ _61"> </span>If<span class="_ _47"> </span></span>fd<span class="_ _66"> </span><span class="ff19">equals<span class="_ _47"> </span></span>fd2<span class="ff19 ls3f7">,t<span class="_ _4f"></span><span class="ls0">hen<span class="_ _66"> </span><span class="ff1a">dup2<span class="_ _66"> </span></span><span class="lscc">re<span class="_ _2"></span></span>turns</span></span></div><div class="t m0 x32 h4d yc55 ff1b fs26 fc0 sc0 ls0 ws0">fd2<span class="_"> </span><span class="ff19">without <span class="_ _2"></span>closing <span class="_ _2"></span>it.<span class="_ _46"> </span>Otherwise, <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">FD_CLOEXEC<span class="_ _47"> </span></span>ﬁle descriptor <span class="_ _2"></span>ﬂag is <span class="_ _2"></span>cleared for<span class="_ _66"> </span></span>fd2<span class="ff19">,</span></div><div class="t m0 x32 h4d yc56 ff19 fs26 fc0 sc0 ls0 ws0">so that<span class="_"> </span><span class="ff1b">fd2<span class="_"> </span></span>is left open if the process calls<span class="_"> </span><span class="ff1a">exec</span>.</div><a class="l" href="#pfc" data-dest-detail='[12,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.891368px;bottom:451.728903px;width:185.087311px;height:19.679016px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
