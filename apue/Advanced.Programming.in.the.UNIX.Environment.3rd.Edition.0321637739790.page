<div id="pf316" class="pf w4 h1f" data-page-no="316"><div class="pc pc316 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg316.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">756<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">27 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">28 <span class="_ _68"> </span>*<span class="_"> </span>Library’s private representation of the database.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">29 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">30 <span class="_ _d9"> </span>typedef<span class="_"> </span>struct {</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">31 <span class="_ _15"> </span>int<span class="_ _15"> </span>idxfd; <span class="_"> </span>/*<span class="_"> </span>fd for index file */</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">32 <span class="_ _15"> </span>int<span class="_ _15"> </span>datfd; <span class="_"> </span>/*<span class="_"> </span>fd for data file */</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">33 <span class="_ _15"> </span>char<span class="_ _d9"> </span>*idxbuf; /* malloc’ed buffer for index record */</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">34 <span class="_ _15"> </span>char<span class="_ _d9"> </span>*datbuf; /* malloc’ed buffer for data record*/</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">35 <span class="_ _15"> </span>char<span class="_ _d9"> </span>*name; <span class="_ _3a"> </span>/*<span class="_"> </span>name db was opened under */</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">36 <span class="_ _15"> </span>off_t<span class="_ _d9"> </span>idxoff; /* offset in index file of index record */</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">37 <span class="_ _1e9"> </span>/*<span class="_"> </span>key is at (idxoff + PTR_SZ + IDXLEN_SZ) */</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">38 <span class="_ _15"> </span>size_t<span class="_"> </span>idxlen; /* length of index record */</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">39 <span class="_ _1e9"> </span>/*<span class="_"> </span>excludes IDXLEN_SZ bytes at front of record */</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">40 <span class="_ _1e9"> </span>/*<span class="_"> </span>includes newline at end of index record */</div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">41 <span class="_ _15"> </span>off_t<span class="_ _d9"> </span>datoff; /* offset in data file of data record */</div><div class="t m0 x32 h57 y56d0 ff1a fs2d fc0 sc0 ls0 ws0">42 <span class="_ _15"> </span>size_t<span class="_"> </span>datlen; /* length of data record */</div><div class="t m0 x32 h57 y56d1 ff1a fs2d fc0 sc0 ls0 ws0">43 <span class="_ _1e9"> </span>/*<span class="_"> </span>includes newline at end */</div><div class="t m0 x32 h57 y56d2 ff1a fs2d fc0 sc0 ls0 ws0">44 <span class="_ _15"> </span>off_t<span class="_ _d9"> </span>ptrval; /* contents of chain ptr in index record */</div><div class="t m0 x32 h57 y56d3 ff1a fs2d fc0 sc0 ls0 ws0">45 <span class="_ _15"> </span>off_t<span class="_ _d9"> </span>ptroff; /* chain ptr offset pointing to this idx record */</div><div class="t m0 x32 h57 y56d4 ff1a fs2d fc0 sc0 ls0 ws0">46 <span class="_ _15"> </span>off_t<span class="_ _d9"> </span>chainoff; /* offset of hash chain for this index record */</div><div class="t m0 x32 h57 y56d5 ff1a fs2d fc0 sc0 ls0 ws0">47 <span class="_ _15"> </span>off_t<span class="_ _d9"> </span>hashoff; <span class="_"> </span>/*<span class="_"> </span>offset in index file of hash table */</div><div class="t m0 x32 h57 y56d6 ff1a fs2d fc0 sc0 ls0 ws0">48 <span class="_ _15"> </span>DBHASH<span class="_"> </span>nhash; <span class="_ _68"> </span>/*<span class="_"> </span>current hash table size */</div><div class="t m0 x32 h57 y56d7 ff1a fs2d fc0 sc0 ls0 ws0">49 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_delok; <span class="_ _87"> </span>/*<span class="_"> </span>delete OK */</div><div class="t m0 x32 h57 y56d8 ff1a fs2d fc0 sc0 ls0 ws0">50 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_delerr; <span class="_ _3a"> </span>/*<span class="_"> </span>delete error */</div><div class="t m0 x32 h57 y56d9 ff1a fs2d fc0 sc0 ls0 ws0">51 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_fetchok; <span class="_"> </span>/*<span class="_"> </span>fetch OK */</div><div class="t m0 x32 h57 y56da ff1a fs2d fc0 sc0 ls0 ws0">52 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_fetcherr; /* fetch error */</div><div class="t m0 x32 h57 y56db ff1a fs2d fc0 sc0 ls0 ws0">53 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_nextrec; <span class="_"> </span>/*<span class="_"> </span>nextrec */</div><div class="t m0 x32 h57 y56dc ff1a fs2d fc0 sc0 ls0 ws0">54 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_stor1; <span class="_ _87"> </span>/*<span class="_"> </span>store: DB_INSERT, no empty, appended */</div><div class="t m0 x32 h57 y56dd ff1a fs2d fc0 sc0 ls0 ws0">55 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_stor2; <span class="_ _87"> </span>/*<span class="_"> </span>store: DB_INSERT, found empty, reused */</div><div class="t m0 x32 h57 y56de ff1a fs2d fc0 sc0 ls0 ws0">56 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_stor3; <span class="_ _87"> </span>/*<span class="_"> </span>store: DB_REPLACE, diff len, appended */</div><div class="t m0 x32 h57 y56df ff1a fs2d fc0 sc0 ls0 ws0">57 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_stor4; <span class="_ _87"> </span>/*<span class="_"> </span>store: DB_REPLACE, same len, overwrote */</div><div class="t m0 x32 h57 y56e0 ff1a fs2d fc0 sc0 ls0 ws0">58 <span class="_ _15"> </span>COUNT<span class="_ _d9"> </span>cnt_storerr; <span class="_"> </span>/*<span class="_"> </span>store error */</div><div class="t m0 x32 h57 y56e1 ff1a fs2d fc0 sc0 ls0 ws0">59 <span class="_ _d9"> </span>}<span class="_"> </span>DB;</div><div class="t m0 x32 h4d y56e2 ff19 fs26 fc0 sc0 ls0 ws0">[27 <span class="_ _a"></span>– <span class="_ _a"></span>48]<span class="_ _65"> </span>The<span class="_ _47"> </span><span class="ff1a">DB<span class="_ _47"> </span></span>structur<span class="_ _0"></span>e<span class="_ _47"> </span>is<span class="_ _47"> </span>where<span class="_ _66"> </span>we<span class="_ _47"> </span>keep <span class="_ _3"></span>all <span class="_ _3"></span>the <span class="_ _3"></span>information <span class="_ _3"></span>for <span class="_ _3"></span>each <span class="_ _2"></span>open <span class="_ _3"></span>database.</div><div class="t m0 x2d h4d y56e3 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _35"> </span><span class="ff1a">DBHANDLE<span class="_ _45"> </span></span>value <span class="_ _23"> </span>that <span class="_ _23"></span>is <span class="_ _23"></span>returned <span class="_ _9"></span>by<span class="_ _35"> </span><span class="ff1a">db_open<span class="_ _35"> </span></span>and <span class="_ _9"></span>used <span class="_ _23"> </span>by <span class="_ _23"> </span>all <span class="_ _23"> </span>the <span class="_ _23"></span>other</div><div class="t m0 x2d h49 y56e4 ff19 fs26 fc0 sc0 ls0 ws0">functions <span class="_ _42"> </span>is <span class="_ _23"> </span>really <span class="_ _42"> </span>just <span class="_ _42"> </span>a <span class="_ _23"> </span>pointer <span class="_ _42"> </span>to <span class="_ _42"> </span>one <span class="_ _42"> </span>of <span class="_ _42"> </span>these <span class="_ _42"> </span>structur<span class="_ _0"></span>es, <span class="_ _23"> </span>but <span class="_ _42"> </span>we <span class="_ _42"> </span>hide <span class="_ _42"> </span>that</div><div class="t m0 x2d h49 y56e5 ff19 fs26 fc0 sc0 ls0 ws0">from the callers.</div><div class="t m0 x2d h49 y56e6 ff19 fs26 fc0 sc0 ls0 ws0">Since <span class="_ _2"></span>we <span class="_ _2"></span>stor<span class="ls165b">ep<span class="_ _4f"></span><span class="ls0">ointers <span class="_ _2"></span>and <span class="_ _2"></span>lengths <span class="_ _2"></span>as <span class="_ _2"></span>ASCII <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _2"></span>database, <span class="_ _2"></span>we <span class="_ _3"></span>convert <span class="_ _2"></span>these</span></span></div><div class="t m0 x2d h4d y56e7 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _23"></span>numeric <span class="_ _23"></span>values <span class="_ _23"></span>and <span class="_ _9"></span>save <span class="_ _23"> </span>them <span class="_ _23"> </span>in <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">DB<span class="_ _35"> </span></span>structur<span class="_ _0"></span>e. <span class="_ _45"> </span>W<span class="_ _6"></span><span class="ls165c">ea<span class="_ _b"></span><span class="ls0">lso <span class="_ _23"></span>save <span class="_ _9"></span>the <span class="_ _23"> </span>hash</span></span></div><div class="t m0 x2d h49 y56e8 ff19 fs26 fc0 sc0 ls0 ws0">table <span class="_ _3"></span>size <span class="_ _3"></span>even <span class="_ _3"></span>though <span class="_ _3"></span>it <span class="_ _9"></span>is <span class="_ _3"></span>ﬁxed, <span class="_ _3"></span>just <span class="_ _3"></span>in <span class="_ _3"></span>case <span class="_ _9"></span>we <span class="_ _3"></span>decide <span class="_ _3"></span>to <span class="_ _3"></span>enhance <span class="_ _3"></span>the <span class="_ _9"></span>library</div><div class="t m0 x2d h49 y56e9 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _4b"> </span>allow <span class="_ _4b"> </span>callers <span class="_ _4b"> </span>to <span class="_ _4b"> </span>specify <span class="_ _4b"> </span>the <span class="_ _4b"> </span>size <span class="_ _4b"> </span>when <span class="_ _4b"> </span>the <span class="_ _4b"> </span>database <span class="_ _4b"> </span>is <span class="_ _4b"> </span>created <span class="_ _44"> </span>(see</div><div class="t m0 x2d h49 y56ea ff19 fs26 fc0 sc0 ls0 ws0">Exercise 20.7).</div><div class="t m0 x32 h4d y56eb ff19 fs26 fc0 sc0 ls0 ws0">[49 <span class="_ _a"></span>– <span class="_ _a"></span>59]<span class="_ _65"> </span>The <span class="_ _9"></span>last <span class="_ _23"></span>ten <span class="_ _9"></span>ﬁelds <span class="_ _23"></span>in <span class="_ _9"></span>the<span class="_ _35"> </span><span class="ff1a">DB<span class="_ _45"> </span></span>structur<span class="ls10a8">ec<span class="_ _43"></span><span class="ls0">ount <span class="_ _23"></span>both <span class="_ _9"></span>successful <span class="_ _23"></span>and <span class="_ _23"></span>unsuccessful</span></span></div><div class="t m0 x2d h49 y56ec ff19 fs26 fc0 sc0 ls0 ws0">operations. <span class="_ _44"> </span>If<span class="_ _35"> </span>we <span class="_ _42"> </span>want <span class="_ _42"> </span>to <span class="_ _42"> </span>analyze <span class="_ _53"> </span>the <span class="_ _42"> </span>performance <span class="_ _42"> </span>of <span class="_ _42"> </span>our <span class="_ _42"> </span>database, <span class="_ _42"> </span>we <span class="_ _42"> </span>can</div><div class="t m0 x2d h49 y56ed ff19 fs26 fc0 sc0 ls0 ws0">write <span class="_ _42"> </span>a <span class="_ _23"> </span>function <span class="_ _42"> </span>to <span class="_ _42"> </span>return <span class="_ _23"> </span>these <span class="_ _42"> </span>statistics, <span class="_ _42"> </span>but <span class="_ _42"> </span>for <span class="_ _42"> </span>now <span class="_ _42"> </span>we <span class="_ _23"> </span>only <span class="_ _42"> </span>maintain <span class="_ _42"> </span>the</div><div class="t m0 x2d h49 y56ee ff19 fs26 fc0 sc0 ls0 ws0">counters.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
