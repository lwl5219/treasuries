<div id="pffb" class="pf w4 h1f" data-page-no="fb"><div class="pc pcfb w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bgfb.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>7.10<span class="_ _15b"> </span><span class="ff1a">setjmp<span class="_ _4b"> </span></span>and<span class="_ _59"> </span><span class="ff1a">longjmp<span class="_ _4b"> </span></span>Functions<span class="_ _1b"> </span><span class="ff18">217</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">When<span class="_ _47"> </span><span class="ff1a">main<span class="_ _45"> </span></span>is <span class="_ _2"></span>executed, <span class="_ _9"></span>we <span class="_ _3"></span>call<span class="_ _47"> </span><span class="ff1a">setjmp</span><span class="ls8db">,w<span class="_ _8"></span><span class="ls0">hich <span class="_ _9"></span>recor<span class="_ _0"></span>ds <span class="_ _3"></span>whatever <span class="_ _3"></span>information <span class="_ _3"></span>it <span class="_ _9"></span>needs</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _66"> </span>in <span class="_ _47"> </span>the <span class="_ _47"> </span>variable<span class="_ _61"> </span><span class="ff1a">jmpbuffer<span class="_ _61"> </span></span>and <span class="_ _47"> </span>returns <span class="_ _66"> </span>0.<span class="_ _50"> </span><span class="ls5f">We <span class="_ _59"> </span>t<span class="_ _23"></span></span>hen <span class="_ _66"> </span>call<span class="_ _61"> </span><span class="ff1a">do_line</span><span class="ls8dc">,w<span class="_ _5b"></span><span class="ls0">hich <span class="_ _47"> </span>calls</span></span></div><div class="t m0 x32 h26 y131 ff1a fsf fc0 sc0 ls0 ws0">cmd_add<span class="ff19 ls8dd">,a<span class="_ _1d"></span><span class="ls0">nd <span class="_ _47"> </span>assume <span class="_ _47"> </span>that <span class="_ _47"> </span>an <span class="_ _66"> </span>error <span class="_ _47"> </span>of <span class="_ _66"> </span>some <span class="_ _47"> </span>form <span class="_ _47"> </span>is <span class="_ _47"> </span>detected.<span class="_ _50"> </span>Befor<span class="ls8dd">et<span class="_ _1d"></span><span class="ls0">he <span class="_ _47"> </span>call <span class="_ _47"> </span>to</span></span></span></span></div><div class="t m0 x32 h26 y132 ff1a fsf fc0 sc0 ls0 ws0">longjmp<span class="_ _47"> </span><span class="ff19">in<span class="_ _47"> </span></span>cmd_add<span class="ff19 ls868">,t<span class="_ _8"></span><span class="ls0">he <span class="_ _3"></span>stack <span class="_ _2"></span>looks <span class="_ _3"></span>like <span class="_ _3"></span>that <span class="_ _3"></span>in <span class="_ _2"></span>Figur<span class="ls868">e7<span class="_ _8"></span><span class="ls0">.10. <span class="_ _47"> </span>But<span class="_ _47"> </span><span class="ff1a">longjmp<span class="_ _47"> </span></span>causes <span class="_ _3"></span>the</span></span></span></span></div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">stack <span class="_ _3"></span>to <span class="_ _3"></span>be <span class="_ _9"></span>‘<span class="_ _1"></span>‘unwound’<span class="ls753">’b<span class="_ _b"></span><span class="ls0">ack <span class="_ _3"></span>to <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">main<span class="_ _45"> </span></span>function, <span class="_ _2"></span>throwing <span class="_ _3"></span>away <span class="_ _3"></span>the <span class="_ _9"></span>stack <span class="_ _3"></span>frames <span class="_ _3"></span>for</span></span></div><div class="t m0 x32 h26 y134 ff1a fsf fc0 sc0 ls0 ws0">cmd_add<span class="_ _47"> </span><span class="ff19">and<span class="_ _47"> </span></span>do_line<span class="_ _45"> </span><span class="ff19">(Figur<span class="_ _0"></span><span class="ls216">e7<span class="_ _8"></span><span class="ls0">.12). <span class="_ _47"> </span>Calling<span class="_ _47"> </span><span class="ff1a">longjmp<span class="_ _45"> </span></span>causes <span class="_ _2"></span>the<span class="_ _45"> </span><span class="ff1a">setjmp<span class="_ _47"> </span></span>in<span class="_ _47"> </span><span class="ff1a">main<span class="_ _47"> </span></span>to</span></span></span></div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">turn, but this time it returns with a value of 1 (the second argument for<span class="_"> </span><span class="ff1a">longjmp</span>).</span></div><div class="t m0 x1e7 h2d y1d1e ff19 fs10 fc0 sc0 ls0 ws0">stack frame</div><div class="t m0 x113 h5e y1d1f ff19 fs10 fc0 sc0 ls0 ws0">for<span class="_"> </span><span class="ff1a">main</span></div><div class="t m0 x6b h2e y1d20 ff19 fs11 fc0 sc0 ls0 ws0">bottom of stack<span class="_ _b9"> </span>higher address</div><div class="t m0 xa2 h2e y1d21 ff19 fs11 fc0 sc0 ls0 ws0">lower address</div><div class="t m0 xe8 h2f y1d22 ff19 fs12 fc0 sc0 ls0 ws0">direction of</div><div class="t m0 xd0 h2f y1d23 ff19 fs12 fc0 sc0 ls0 ws0">stack growth</div><div class="t m0 x30 h6d y1d24 ff18 fs12 fc0 sc0 ls0 ws0">Figure 7.12<span class="_ _5a"> </span><span class="ff19">Stack frame after<span class="_"> </span><span class="ff1a">longjmp<span class="_ _e"> </span></span>has been called</span></div><div class="t m0 x35 h5a y1d25 ff16 fs29 fc0 sc0 ls2d3 ws0">Au<span class="_ _2"></span><span class="ls0">tomatic, Register<span class="_ _1"></span><span class="ls8de">,a<span class="_ _4f"></span><span class="ls0">nd V<span class="_ _6"></span>olatile V<span class="_ _1"></span>ariables</span></span></span></div><div class="t m0 x32 h5c y1d26 ff19 fs29 fc0 sc0 lse2 ws0">We<span class="_ _9"></span><span class="ls0">’ve seen what the stack looks like after calling<span class="_"> </span><span class="ff1a">longjmp</span><span class="ls8df">.T<span class="_ _4a"></span><span class="ls0">he next question is, ‘<span class="_ _0"></span>‘What</span></span></span></div><div class="t m0 x32 h5c y1d27 ff19 fs29 fc0 sc0 ls0 ws0">ar<span class="ls8e0">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"></span>states <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>automatic <span class="_ _23"> </span>variables <span class="_ _23"> </span>and <span class="_ _23"> </span>register <span class="_ _9"></span>variables <span class="_ _23"> </span>in <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">main<span class="_ _45"> </span></span>function?’’</span></span></div><div class="t m0 x32 h5c y1d28 ff19 fs29 fc0 sc0 ls0 ws0">When <span class="_ _42"> </span>we <span class="_ _23"> </span>return <span class="_ _42"> </span>to<span class="_ _35"> </span><span class="ff1a">main<span class="_ _35"> </span></span>as <span class="_ _42"> </span>a <span class="_ _42"> </span>result <span class="_ _23"> </span>of <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">longjmp</span>,<span class="_ _44"> </span>do<span class="_ _35"> </span>these <span class="_ _42"> </span>variables <span class="_ _42"> </span>have <span class="_ _42"> </span>values</div><div class="t m0 x32 h5c y1d29 ff19 fs29 fc0 sc0 ls0 ws0">corresponding <span class="_ _23"></span>to <span class="_ _23"> </span>those <span class="_ _42"> </span>when <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">setjmp<span class="_ _35"> </span></span>was <span class="_ _42"> </span>previously <span class="_ _23"></span>called <span class="_ _23"> </span>(i.e., <span class="_ _42"> </span>ar<span class="ls8e1">et<span class="_ _43"></span><span class="ls0">heir <span class="_ _23"></span>values</span></span></div><div class="t m0 x32 h50 y1d2a ff19 fs29 fc0 sc0 lsdf ws0">ro<span class="ls0">lled <span class="_ _23"> </span>back), <span class="_ _23"></span>or <span class="_ _23"></span>ar<span class="ls8e2">et<span class="_ _43"></span><span class="ls0">heir <span class="_ _23"></span>values <span class="_ _23"></span>left <span class="_ _9"></span>alone <span class="_ _23"> </span>so <span class="_ _23"> </span>that <span class="_ _23"></span>their <span class="_ _23"></span>values <span class="_ _9"></span>ar<span class="ls8e3">ew<span class="_ _b"></span><span class="ls0">hatever <span class="_ _9"></span>they <span class="_ _23"></span>were</span></span></span></span></span></div><div class="t m0 x32 h5c y1d2b ff19 fs29 fc0 sc0 ls0 ws0">when<span class="_ _51"> </span><span class="ff1a">do_line<span class="_ _54"> </span></span>was <span class="_ _35"> </span>called <span class="_ _35"> </span>(which <span class="_ _44"> </span>caused<span class="_ _51"> </span><span class="ff1a">cmd_add<span class="_ _54"> </span></span>to <span class="_ _35"> </span>be <span class="_ _35"> </span>called, <span class="_ _44"> </span>which <span class="_ _35"> </span>caused</div><div class="t m0 x32 h5c y1d2c ff1a fs29 fc0 sc0 ls0 ws0">longjmp<span class="_ _93"> </span><span class="ff19">to <span class="_ _54"> </span>be <span class="_ _65"> </span>called)?<span class="_ _6e"> </span>Unfortunately<span class="_ _4"></span><span class="ls8e4">,t<span class="_ _184"></span><span class="ls0">he <span class="_ _54"> </span>answer <span class="_ _65"> </span>is <span class="_ _54"> </span>‘‘It <span class="_ _54"> </span>depends.’<span class="_ _0"></span><span class="ls8e5">’M<span class="_ _de"></span><span class="ls0">ost</span></span></span></span></span></div><div class="t m0 x32 h50 y1d2d ff19 fs29 fc0 sc0 ls0 ws0">implementations do <span class="_ _2"></span>not <span class="_ _2"></span>try to <span class="_ _2"></span>roll back <span class="_ _2"></span>these <span class="_ _2"></span>automatic variables <span class="_ _2"></span>and <span class="_ _2"></span>register variables,</div><div class="t m0 x32 h50 y1d2e ff19 fs29 fc0 sc0 ls0 ws0">but the standards say only that their values ar<span class="ls8e6">ei<span class="_ _d"></span><span class="ls0">ndeterminate. <span class="_"> </span>If<span class="_"> </span>you <span class="_ _2"></span>have an automatic</span></span></div><div class="t m0 x32 h5c y1d2f ff19 fs29 fc0 sc0 ls0 ws0">variable <span class="_ _47"> </span>that <span class="_ _45"> </span>you <span class="_ _45"> </span>don’t <span class="_ _47"> </span>want <span class="_ _45"> </span>r<span class="_ _0"></span>olled <span class="_ _45"> </span>back, <span class="_ _47"> </span>deﬁne <span class="_ _45"> </span>it <span class="_ _47"> </span>with <span class="_ _45"> </span>the<span class="_ _16"> </span><span class="ff1a">volatile<span class="_"> </span></span>attribute.</div><div class="t m0 x32 h5c y1d30 ff19 fs29 fc0 sc0 lse2 ws0">Va<span class="_ _9"></span><span class="ls0">riables that ar<span class="lsdd">ed<span class="_ _d"></span><span class="ls0">eclared as global or static ar<span class="_ _0"></span><span class="lsdd">el<span class="_ _d"></span><span class="ls0">eft alone when<span class="_"> </span><span class="ff1a">longjmp<span class="_ _80"> </span></span>is executed.</span></span></span></span></span></div><div class="t m0 x35 h5a y1d31 ff16 fs29 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h50 y1d32 ff19 fs29 fc0 sc0 ls0 ws0">The <span class="_ _9"></span>program <span class="_ _23"></span>in <span class="_ _9"></span>Figur<span class="ls8e7">e7<span class="_ _b"></span><span class="ls0">.13 <span class="_ _9"></span>demonstrates <span class="_ _9"></span>the <span class="_ _23"> </span>differ<span class="_ _0"></span>ent <span class="_ _23"></span>behavior <span class="_ _9"></span>that <span class="_ _23"></span>can <span class="_ _9"></span>be <span class="_ _23"></span>seen <span class="_ _23"></span>with</span></span></div><div class="t m0 x32 h5c y1d33 ff19 fs29 fc0 sc0 ls0 ws0">automatic, global, register<span class="_ _6"></span><span class="lsdd">,s<span class="_ _d"></span><span class="ls0">tatic, and volatile variables after calling<span class="_"> </span><span class="ff1a">longjmp</span>.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
