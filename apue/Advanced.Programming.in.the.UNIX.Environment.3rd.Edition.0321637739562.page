<div id="pf232" class="pf w4 h1f" data-page-no="232"><div class="pc pc232 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg232.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">528<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">kernel daemons <span class="_ _2"></span>decide <span class="_ _2"></span>when <span class="_ _2"></span>dirty <span class="_ _2"></span>pages <span class="_ _2"></span>ar<span class="ls110a">ew<span class="_ _4f"></span><span class="ls0">ritten <span class="_ _2"></span>back based <span class="_ _2"></span>on <span class="_ _2"></span>(a) <span class="_ _2"></span>system <span class="_ _2"></span>load <span class="_ _2"></span>and</span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">(b) <span class="_ _23"></span>conﬁguration <span class="_ _23"></span>parameters <span class="_ _23"></span>meant <span class="_ _23"></span>to <span class="_ _23"></span>limit <span class="_ _23"> </span>data <span class="_ _23"> </span>loss <span class="_ _23"> </span>in <span class="_ _23"> </span>the <span class="_ _23"> </span>event <span class="_ _23"> </span>of <span class="_ _23"> </span>a <span class="_ _23"> </span>system <span class="_ _23"> </span>failure.</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">When <span class="_ _53"> </span>the <span class="_ _53"> </span>changes <span class="_ _53"> </span>ar<span class="ls110b">ew<span class="_ _c"></span><span class="ls0">ritten <span class="_ _53"> </span>back, <span class="_ _53"> </span>they <span class="_ _53"> </span>ar<span class="ls110b">ew<span class="_ _55"></span><span class="ls0">ritten <span class="_ _e"> </span>in <span class="_ _53"> </span>units <span class="_ _53"> </span>of <span class="_ _53"> </span>pages.<span class="_ _65"> </span>Thus, <span class="_ _53"> </span>if <span class="_ _e"> </span>we</span></span></span></span></div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">modify <span class="_ _9"></span>only <span class="_ _9"></span>one <span class="_ _9"></span>byte <span class="_ _9"></span>in <span class="_ _9"></span>a <span class="_ _9"></span>page, <span class="_ _9"></span>when <span class="_ _9"></span>the <span class="_ _9"></span>change <span class="_ _9"></span>is <span class="_ _23"></span>written <span class="_ _3"></span>back <span class="_ _23"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>ﬁle, <span class="_ _23"></span>the <span class="_ _3"></span>entire</div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">page will be written.</div><div class="t m0 x3f h26 y134 ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _9"></span>the <span class="_ _23"></span>pages <span class="_ _9"></span>in <span class="_ _23"></span>a <span class="_ _9"></span>shared <span class="_ _9"></span>mapping <span class="_ _23"></span>have <span class="_ _9"></span>been <span class="_ _23"></span>modiﬁed, <span class="_ _9"></span>we <span class="_ _23"></span>can <span class="_ _9"></span>call<span class="_ _35"> </span><span class="ff1a">msync<span class="_ _45"> </span></span>to <span class="_ _9"></span>ﬂush</div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _2"></span>changes <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _3"></span>ﬁle <span class="_ _2"></span>that <span class="_ _2"></span>backs <span class="_ _3"></span>the <span class="_ _2"></span>mapping.<span class="_ _61"> </span>The<span class="_ _47"> </span><span class="ff1a">msync<span class="_ _66"> </span></span>function <span class="_ _2"></span>is <span class="_ _3"></span>similar <span class="_ _2"></span>to<span class="_ _47"> </span><span class="ff1a">fsync</span></div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">(Section 3.13), but works on memory-mapped regions.</div><div class="t m0 x3f h57 y797 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/mman.h&gt;</div><div class="t m0 x3f h57 y798 ff1a fs2d fc0 sc0 ls0 ws0">int msync(void *<span class="ff1b">addr</span><span class="ls15c">,s<span class="_ _1d"></span><span class="ls0">ize_t<span class="_"> </span><span class="ff1b">len</span><span class="ls15c">,i<span class="_ _5b"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">ﬂags</span>);</span></span></span></span></div><div class="t m0 x153 h5f y799 ff19 fs2d fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h49 y408a ff19 fs26 fc0 sc0 ls0 ws0">If <span class="_ _35"> </span>the <span class="_ _35"> </span>mapping <span class="_ _45"> </span>is <span class="_ _35"> </span>private, <span class="_ _35"> </span>the <span class="_ _35"> </span>ﬁle <span class="_ _35"> </span>mapped <span class="_ _45"> </span>is <span class="_ _35"> </span>not <span class="_ _35"> </span>modiﬁed.<span class="_ _5c"> </span>As <span class="_ _35"> </span>with <span class="_ _35"> </span>the <span class="_ _35"> </span>other</div><div class="t m0 x32 h49 y408b ff19 fs26 fc0 sc0 ls0 ws0">memory-mapped functions, the address must be aligned on a page boundary<span class="_ _4"></span>.</div><div class="t m0 x3f h4a y408c ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _35"> </span><span class="ff1b">ﬂags<span class="_ _35"> </span></span>argument <span class="_ _23"> </span>allows <span class="_ _23"> </span>us <span class="_ _42"> </span>some <span class="_ _23"> </span>control <span class="_ _23"> </span>over <span class="_ _42"> </span>how <span class="_ _23"> </span>the <span class="_ _42"> </span>memory <span class="_ _23"> </span>is <span class="_ _23"> </span>ﬂushed.<span class="_ _54"> </span><span class="ls164">We</span></div><div class="t m0 x32 h4d y408d ff19 fs26 fc0 sc0 ls0 ws0">can <span class="_ _3"></span>specify <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">MS_ASYNC<span class="_ _47"> </span></span>ﬂag <span class="_ _9"></span>to <span class="_ _9"></span>simply <span class="_ _3"></span>schedule <span class="_ _9"></span>the <span class="_ _9"></span>pages <span class="_ _3"></span>to <span class="_ _9"></span>be <span class="_ _9"></span>written.<span class="_ _16"> </span>If <span class="_ _9"></span>we <span class="_ _9"></span>want</div><div class="t m0 x32 h4d y408e ff19 fs26 fc0 sc0 ls0 ws0">to wait for the <span class="_ _2"></span>writes to complete befor<span class="ls110c">er<span class="_ _4f"></span><span class="ls0">eturning, we <span class="_ _2"></span>can use the<span class="_ _66"> </span><span class="ff1a">MS_SYNC<span class="_ _66"> </span></span>ﬂag. <span class="_"> </span>Either</span></span></div><div class="t m0 x32 h4d y408f ff1a fs26 fc0 sc0 ls0 ws0">MS_ASYNC<span class="_ _80"> </span><span class="ff19">or<span class="_"> </span></span>MS_SYNC<span class="_ _66"> </span><span class="ff19">must be speciﬁed.</span></div><div class="t m0 x3f h4d y4090 ff19 fs26 fc0 sc0 ls0 ws0">An <span class="_ _3"></span>optional <span class="_ _3"></span>ﬂag,<span class="_ _45"> </span><span class="ff1a">MS_INVALIDATE</span><span class="lscf3">,l<span class="_ _b"></span><span class="ls0">ets <span class="_ _3"></span>us <span class="_ _9"></span>tell <span class="_ _3"></span>the <span class="_ _3"></span>operating <span class="_ _9"></span>system <span class="_ _3"></span>to <span class="_ _3"></span>discar<span class="ls110d">da<span class="_ _b"></span><span class="ls0">ny</span></span></span></span></div><div class="t m0 x32 h49 y4091 ff19 fs26 fc0 sc0 ls0 ws0">pages <span class="_ _53"> </span>that <span class="_ _53"> </span>ar<span class="ls110e">eo<span class="_ _55"></span><span class="ls0">ut <span class="_ _e"> </span>of <span class="_ _53"> </span>sync <span class="_ _53"> </span>with <span class="_ _e"> </span>the <span class="_ _53"> </span>underlying <span class="_ _53"> </span>storage.<span class="_ _48"> </span>Some <span class="_ _53"> </span>implementations <span class="_ _53"> </span>will</span></span></div><div class="t m0 x32 h49 y4092 ff19 fs26 fc0 sc0 ls0 ws0">discar<span class="ls110f">da<span class="_ _b"></span><span class="ls0">ll <span class="_ _3"></span>pages <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _23"></span>speciﬁed <span class="_ _3"></span>range <span class="_ _23"></span>when <span class="_ _3"></span>we <span class="_ _23"></span>use <span class="_ _3"></span>this <span class="_ _9"></span>ﬂag, <span class="_ _23"></span>but <span class="_ _3"></span>this <span class="_ _23"></span>behavior <span class="_ _3"></span>is <span class="_ _23"></span>not</span></span></div><div class="t m0 x32 h49 y4093 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">quired.</span></div><div class="t m0 x76 h5e y2b50 ff19 fs10 fc0 sc0 ls0 ws0">The<span class="_ _66"> </span><span class="ff1a">msync<span class="_ _66"> </span></span>function <span class="_ _9"></span>is <span class="_ _3"></span>included <span class="_ _9"></span>in <span class="_ _3"></span>the <span class="_ _9"></span>XSI <span class="_ _3"></span>option <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _3"></span>Single <span class="_ _9"></span>UNIX <span class="_ _3"></span>Speciﬁcation.<span class="_ _59"> </span>As <span class="_ _9"></span>such,</div><div class="t m0 x76 h2d y2b51 ff19 fs10 fc0 sc0 ls0 ws0">all UNIX systems must support it.</div><div class="t m0 x3f h49 y4094 ff19 fs26 fc0 sc0 ls1110 ws0">Am<span class="_ _4f"></span><span class="ls0">emory-mapped <span class="_ _2"></span>region is automatically <span class="_ _2"></span>unmapped when <span class="_ _2"></span>the process terminates</span></div><div class="t m0 x32 h4d y4095 ff19 fs26 fc0 sc0 ls0 ws0">or <span class="_ _42"> </span>we <span class="_ _53"> </span>can <span class="_ _53"> </span>unmap <span class="_ _42"> </span>a <span class="_ _53"> </span>region <span class="_ _42"> </span>directly <span class="_ _42"> </span>by <span class="_ _53"> </span>calling <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1a">munmap<span class="_ _44"> </span></span>function. <span class="_ _4b"> </span>Closing<span class="_ _44"> </span>the <span class="_ _42"> </span>ﬁle</div><div class="t m0 x32 h49 y4096 ff19 fs26 fc0 sc0 ls0 ws0">descriptor used when we mapped the region does not unmap the r<span class="_ _0"></span>egion.</div><div class="t m0 x3f h4e y4097 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/mman.h&gt;</div><div class="t m0 x3f h4e y4098 ff1a fs28 fc0 sc0 ls0 ws0">int munmap(void *<span class="ff1b">addr</span><span class="ls1b6">,s<span class="_ _1d"></span><span class="ls0">ize_t<span class="_"> </span><span class="ff1b">len</span>);</span></span></div><div class="t m0 x153 h7c y4099 ff19 fs28 fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h54 y409a ff19 fs2c fc0 sc0 ls0 ws0">The<span class="_ _35"> </span><span class="ff1a">munmap<span class="_ _35"> </span></span>function <span class="_ _23"> </span>does <span class="_ _23"> </span>not <span class="_ _42"> </span>affect <span class="_ _9"></span>the <span class="_ _42"> </span>object <span class="_ _23"> </span>that <span class="_ _23"> </span>was <span class="_ _42"> </span>mapped<span class="_ _9"></span><span class="ls6bf">—t<span class="_ _6"></span><span class="ls0">hat <span class="_ _23"> </span>is, <span class="_ _42"> </span>the <span class="_ _23"></span>call <span class="_ _23"> </span>to</span></span></div><div class="t m0 x32 h54 y409b ff1a fs2c fc0 sc0 ls0 ws0">munmap<span class="_ _47"> </span><span class="ff19">does <span class="_ _2"></span>not <span class="_ _2"></span>cause <span class="_ _3"></span>the <span class="_ _2"></span>contents <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>mapped <span class="_ _3"></span>region <span class="_ _2"></span>to <span class="_ _2"></span>be <span class="_ _3"></span>written <span class="_ _3"></span>to <span class="_ _2"></span>the <span class="_ _3"></span>disk <span class="_ _2"></span>ﬁle.</span></div><div class="t m0 x32 h54 y409c ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _23"></span>updating <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>disk <span class="_ _23"></span>ﬁle <span class="_ _23"></span>for <span class="_ _23"></span>a<span class="_ _35"> </span><span class="ff1a">MAP_SHARED<span class="_ _45"> </span></span><span class="ls150">re<span class="_ _2"></span></span>gion <span class="_ _23"> </span>happens <span class="_ _23"> </span>automatically <span class="_ _23"> </span>by <span class="_ _23"> </span>the</div><div class="t m0 x32 h55 y409d ff19 fs2c fc0 sc0 ls0 ws0">kernel’s <span class="_ _23"></span>virtual <span class="_ _23"> </span>memory <span class="_ _23"> </span>algorithm <span class="_ _23"> </span>sometime <span class="_ _23"> </span>after <span class="_ _42"> </span>we <span class="_ _23"></span>stor<span class="ls1111">ei<span class="_ _43"></span><span class="ls0">nto <span class="_ _23"></span>the <span class="_ _23"></span>memory-mapped</span></span></div><div class="t m0 x32 h54 y409e ff19 fs2c fc0 sc0 ls150 ws0">re<span class="ls0">gion. <span class="_ _44"> </span>Modiﬁcations<span class="_ _44"> </span>to <span class="_ _53"> </span>memory <span class="_ _42"> </span>in <span class="_ _53"> </span>a<span class="_ _44"> </span><span class="ff1a">MAP_PRIVATE<span class="_ _44"> </span></span></span>re<span class="ls0">gion <span class="_ _53"> </span>ar<span class="ls1112">ed<span class="_ _c"></span><span class="ls0">iscarded <span class="_ _42"> </span>when <span class="_ _42"> </span>the</span></span></span></div><div class="t m0 x32 h55 y409f ff19 fs2c fc0 sc0 ls150 ws0">re<span class="ls0">gion is unmapped.</span></div><div class="t m0 x35 h61 y40a0 ff16 fs2c fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h54 y40a1 ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _45"> </span>pr<span class="_ _0"></span>ogram <span class="_ _45"> </span>in <span class="_ _47"> </span>Figur<span class="ls1113">e1<span class="_ _62"></span><span class="ls0">4.27 <span class="_ _45"> </span>copies <span class="_ _45"> </span>a <span class="_ _47"> </span>ﬁle <span class="_ _45"> </span>(similar <span class="_ _45"> </span>to <span class="_ _45"> </span>the<span class="_ _16"> </span><span class="ff1a">cp</span></span></span></div><div class="t m0 xfc h55 y40a2 ff19 fs2c fc0 sc0 ls0 ws0">(</div><div class="t m0 x168 h55 y40a1 ff19 fs2c fc0 sc0 ls0 ws0">1</div><div class="t m0 xfe h55 y40a2 ff19 fs2c fc0 sc0 ls0 ws0">)</div><div class="t m0 x1a5 h55 y40a1 ff19 fs2c fc0 sc0 ls0 ws0">command) <span class="_ _45"> </span>using</div><div class="t m0 x32 h55 y40a3 ff19 fs2c fc0 sc0 ls0 ws0">memory-mapped I/O.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
