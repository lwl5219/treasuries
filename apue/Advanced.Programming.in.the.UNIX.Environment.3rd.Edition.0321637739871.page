<div id="pf367" class="pf w4 h1f" data-page-no="367"><div class="pc pc367 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg367.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">837</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">754 <span class="_ _186"> </span>if<span class="_"> </span>(nr &lt; 0) {</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">755 <span class="_ _82"> </span>log_ret(&quot;can’t<span class="_"> </span>read %s&quot;, name);</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">756 <span class="_ _82"> </span>goto<span class="_"> </span>defer;</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">757 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y847 ff1a fs2d fc0 sc0 ls0 ws0">758 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y13a1 ff1a fs2d fc0 sc0 ls0 ws0">759 <span class="_ _176"> </span>*<span class="_"> </span>Read the response from the printer.</div><div class="t m0 x32 h57 y1fb8 ff1a fs2d fc0 sc0 ls0 ws0">760 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y1fb9 ff1a fs2d fc0 sc0 ls0 ws0">761 <span class="_ _186"> </span>if<span class="_"> </span>(printer_status(sockfd, jp)) {</div><div class="t m0 x32 h57 y1fba ff1a fs2d fc0 sc0 ls0 ws0">762 <span class="_ _82"> </span>unlink(name);</div><div class="t m0 x32 h57 y1fbb ff1a fs2d fc0 sc0 ls0 ws0">763 <span class="_ _82"> </span>sprintf(name,<span class="_"> </span>&quot;%s/%s/%d&quot;, SPOOLDIR, REQDIR, jp-&gt;jobid);</div><div class="t m0 x32 h57 y1fbc ff1a fs2d fc0 sc0 ls0 ws0">764 <span class="_ _82"> </span>unlink(name);</div><div class="t m0 x32 h57 y1fbd ff1a fs2d fc0 sc0 ls0 ws0">765 <span class="_ _82"> </span>free(jp);</div><div class="t m0 x32 h57 y1fbe ff1a fs2d fc0 sc0 ls0 ws0">766 <span class="_ _82"> </span>jp<span class="_"> </span><span class="ls15c">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h57 y1fbf ff1a fs2d fc0 sc0 ls0 ws0">767 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y1fc0 ff1a fs2d fc0 sc0 ls0 ws0">768 <span class="_ _d9"> </span>defer:</div><div class="t m0 x32 h57 y1fc1 ff1a fs2d fc0 sc0 ls0 ws0">769 <span class="_ _186"> </span>close(fd);</div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">770 <span class="_ _186"> </span>if<span class="_"> </span>(sockfd &gt;= 0)</div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">771 <span class="_ _82"> </span>close(sockfd);</div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">772 <span class="_ _186"> </span>if<span class="_"> </span>(jp != NULL) {</div><div class="t m0 x32 h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">773 <span class="_ _82"> </span>replace_job(jp);</div><div class="t m0 x32 h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">774 <span class="_ _82"> </span>nanosleep(&amp;ts,<span class="_"> </span>NULL);</div><div class="t m0 x32 h57 y57b4 ff1a fs2d fc0 sc0 ls0 ws0">775 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y419b ff1a fs2d fc0 sc0 ls0 ws0">776 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y419c ff1a fs2d fc0 sc0 ls0 ws0">777 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y2add ff1a fs2d fc0 sc0 ls0 ws0">778 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y2ade ff1a fs2d fc0 sc0 ls0 ws0">779 <span class="_ _68"> </span>*<span class="_"> </span>Read data from the printer, possibly increasing the buffer.</div><div class="t m0 x32 h57 y2c66 ff1a fs2d fc0 sc0 ls0 ws0">780 <span class="_ _68"> </span>*<span class="_"> </span>Returns offset of end of data in buffer or -1 on failure.</div><div class="t m0 x32 h57 y2c67 ff1a fs2d fc0 sc0 ls0 ws0">781 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y573f ff1a fs2d fc0 sc0 ls0 ws0">782 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h57 y57b5 ff1a fs2d fc0 sc0 ls0 ws0">783 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y57b6 ff1a fs2d fc0 sc0 ls0 ws0">784 <span class="_ _d9"> </span>ssize_t</div><div class="t m0 x32 h57 y57b7 ff1a fs2d fc0 sc0 ls0 ws0">785 <span class="_ _d9"> </span>readmore(int<span class="_"> </span>sockfd, char **bpp, int off, int *bszp)</div><div class="t m0 x32 h4d y56e2 ff19 fs26 fc0 sc0 ls0 ws0">[754 <span class="_ _a"></span>– <span class="_ _a"></span>757]<span class="_ _65"> </span>When <span class="_ _23"> </span>we <span class="_ _42"> </span>reach <span class="_ _23"> </span>the <span class="_ _42"> </span>end <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>ﬁle,<span class="_ _44"> </span><span class="ff1a">read<span class="_ _35"> </span></span>will <span class="_ _42"> </span>return <span class="_ _23"></span>0.<span class="_ _51"> </span>However<span class="_ _1"></span><span class="ls17d3">,i<span class="_ _43"></span><span class="ls0">f<span class="_ _35"> </span><span class="ff1a">read</span></span></span></div><div class="t m0 x11a h4d y56e3 ff19 fs26 fc0 sc0 ls0 ws0">fails, we log an error message and jump to<span class="_"> </span><span class="ff1a">defer</span>.</div><div class="t m0 x32 h4d y5c9e ff19 fs26 fc0 sc0 ls0 ws0">[758 <span class="_ _a"></span>– <span class="_ _a"></span>767]<span class="_ _65"> </span>After <span class="_ _23"></span>sending <span class="_ _23"></span>the <span class="_ _23"></span>ﬁle <span class="_ _23"></span>to <span class="_ _23"></span>the <span class="_ _23"></span>printer<span class="_ _6"></span>,<span class="_ _35"> </span>we<span class="_ _35"> </span>call<span class="_ _45"> </span><span class="ff1a">printer_status<span class="_ _35"> </span></span>to <span class="_ _23"> </span>read <span class="_ _23"></span>the</div><div class="t m0 x11a h4d y5c9f ff19 fs26 fc0 sc0 ls0 ws0">printer <span class="_ _a"></span>’s<span class="_ _45"> </span><span class="lscc">re<span class="_ _2"></span></span>sponse <span class="_ _9"></span>to <span class="_ _23"></span>our <span class="_ _9"></span>request. <span class="_ _45"> </span>On<span class="_ _45"> </span>success,<span class="_ _45"> </span><span class="ff1a">printer_status<span class="_ _45"> </span></span><span class="lscc">re<span class="_ _2"></span></span>turns <span class="_ _23"></span>a</div><div class="t m0 x11a h49 y5ca0 ff19 fs26 fc0 sc0 ls0 ws0">nonzer<span class="ls17d4">ov<span class="_ _c"></span><span class="ls0">alue <span class="_ _42"> </span>and <span class="_ _42"> </span>we <span class="_ _42"> </span>delete <span class="_ _42"> </span>the <span class="_ _42"> </span>data <span class="_ _42"> </span>and <span class="_ _42"> </span>control <span class="_ _23"> </span>ﬁles.<span class="_ _54"> </span>Then <span class="_ _42"> </span>we <span class="_ _42"> </span>free <span class="_ _23"> </span>the</span></span></div><div class="t m0 x11a h4d y5ca1 ff1a fs26 fc0 sc0 ls0 ws0">job<span class="_ _80"> </span><span class="ff19">structure, set its pointer to<span class="_"> </span></span>NULL<span class="ff19 lsd3">,a<span class="_ _4f"></span><span class="ls0">nd fall through to the<span class="_"> </span><span class="ff1a">defer<span class="_ _80"> </span></span>label.</span></span></div><div class="t m0 x32 h4d y5ca2 ff19 fs26 fc0 sc0 ls0 ws0">[768 <span class="_ _a"></span>– <span class="_ _a"></span>777]<span class="_ _65"> </span>At <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">defer<span class="_ _45"> </span></span>label, <span class="_ _2"></span>we <span class="_ _3"></span>close <span class="_ _9"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>descriptor <span class="_ _3"></span>for <span class="_ _3"></span>the <span class="_ _9"></span>open <span class="_ _3"></span>data <span class="_ _3"></span>ﬁle.<span class="_ _16"> </span>If <span class="_ _3"></span>the</div><div class="t m0 x11a h4d y5ca3 ff19 fs26 fc0 sc0 ls0 ws0">socket <span class="_ _53"> </span>descriptor <span class="_ _e"> </span>is <span class="_ _e"> </span>valid, <span class="_ _e"> </span>we <span class="_ _53"> </span>close <span class="_ _e"> </span>it.<span class="_ _48"> </span>On <span class="_ _53"> </span>error<span class="_ _6"></span>,<span class="_ _4b"> </span><span class="ff1a">jp<span class="_ _59"> </span></span>will <span class="_ _53"> </span>point <span class="_ _e"> </span>to <span class="_ _e"> </span>the <span class="_ _53"> </span>job</div><div class="t m0 x11a h49 y5ca4 ff19 fs26 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span><span class="ls17d5">ef<span class="_ _b"></span><span class="ls0">or <span class="_ _9"></span>the <span class="_ _9"></span>job <span class="_ _9"></span>we <span class="_ _23"></span>ar<span class="ls17d6">et<span class="_ _b"></span><span class="ls0">rying <span class="_ _3"></span>to <span class="_ _9"></span>print, <span class="_ _23"></span>so <span class="_ _9"></span>we <span class="_ _9"></span>place <span class="_ _9"></span>the <span class="_ _9"></span>job <span class="_ _23"></span>back <span class="_ _9"></span>on <span class="_ _9"></span>the</span></span></span></span></div><div class="t m0 x11a h4d y5ca5 ff19 fs26 fc0 sc0 ls0 ws0">head <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>pending <span class="_ _2"></span>job <span class="_ _2"></span>list <span class="_ _2"></span>and <span class="_ _3"></span>delay <span class="_ _2"></span>for <span class="_ _2"></span>1 <span class="_ _2"></span>minute.<span class="_ _61"> </span>On <span class="_ _2"></span>success,<span class="_ _47"> </span><span class="ff1a">jp<span class="_ _66"> </span></span>is<span class="_ _47"> </span><span class="ff1a">NULL</span>,</div><div class="t m0 x11a h49 y5ca6 ff19 fs26 fc0 sc0 ls0 ws0">so we simply go back to the top of the loop to get the next job to print.</div><div class="t m0 x32 h4d y5ca7 ff19 fs26 fc0 sc0 ls0 ws0">[778 <span class="_ _a"></span>– <span class="_ _a"></span>785]<span class="_ _65"> </span>The<span class="_ _45"> </span><span class="ff1a">readmore<span class="_ _35"> </span></span>function <span class="_ _9"></span>is <span class="_ _23"></span>used <span class="_ _9"></span>to <span class="_ _23"></span>read <span class="_ _9"></span>part <span class="_ _23"></span>of <span class="_ _9"></span>the <span class="_ _23"></span>response <span class="_ _9"></span>message <span class="_ _9"></span>from</div><div class="t m0 x11a h49 y5ca8 ff19 fs26 fc0 sc0 ls0 ws0">the printer<span class="_ _6"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
