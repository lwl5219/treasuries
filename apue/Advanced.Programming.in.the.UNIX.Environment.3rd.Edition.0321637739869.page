<div id="pf365" class="pf w4 h1f" data-page-no="365"><div class="pc pc365 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg365.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">835</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">699 <span class="_ _186"> </span>if<span class="_"> </span>(jp-&gt;req.flags &amp; PR_TEXT) {</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">700 <span class="_ _82"> </span>p<span class="_"> </span><span class="ls15c">=&quot;<span class="_ _1d"></span><span class="ls0">text/plain&quot;;</span></span></div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">701 <span class="_ _82"> </span>extra<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">702 <span class="_ _186"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">703 <span class="_ _82"> </span>p<span class="_"> </span><span class="ls15c">=&quot;<span class="_ _1d"></span><span class="ls0">application/postscript&quot;;</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">704 <span class="_ _82"> </span>extra<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">705 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">706 <span class="_ _186"> </span>icp<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">dd_option(icp, TAG_MIMETYPE, &quot;document-format&quot;, p);</span></span></div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">707 <span class="_ _186"> </span>*icp++<span class="_"> </span><span class="ls15c">=T<span class="_ _1d"></span><span class="ls0">AG_END_OF_ATTR;</span></span></div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">708 <span class="_ _186"> </span>ilen<span class="_"> </span><span class="ls15c">=i<span class="_ _1d"></span><span class="ls0">cp - ibuf;</span></span></div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">709 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">710 <span class="_ _176"> </span>*<span class="_"> </span>Set up the HTTP header.</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">711 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">712 <span class="_ _186"> </span>hcp<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">buf;</span></span></div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">713 <span class="_ _186"> </span>sprintf(hcp,<span class="_"> </span>&quot;POST /ipp HTTP/1.1\r\n&quot;);</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">714 <span class="_ _186"> </span>hcp<span class="_"> </span>+= strlen(hcp);</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">715 <span class="_ _186"> </span>sprintf(hcp,<span class="_"> </span>&quot;Content-Length: %ld\r\n&quot;,</div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">716 <span class="_ _74"> </span>(long)sbuf.st_size<span class="_"> </span><span class="ls15c">+i<span class="_ _1d"></span><span class="ls0">len + extra);</span></span></div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">717 <span class="_ _186"> </span>hcp<span class="_"> </span>+= strlen(hcp);</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">718 <span class="_ _186"> </span>strcpy(hcp,<span class="_"> </span>&quot;Content-Type: application/ipp\r\n&quot;);</div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">719 <span class="_ _186"> </span>hcp<span class="_"> </span>+= strlen(hcp);</div><div class="t m0 x32 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">720 <span class="_ _186"> </span>sprintf(hcp,<span class="_"> </span>&quot;Host: %s:%d\r\n&quot;, printer_name, IPP_PORT);</div><div class="t m0 x32 h57 y2f2f ff1a fs2d fc0 sc0 ls0 ws0">721 <span class="_ _186"> </span>hcp<span class="_"> </span>+= strlen(hcp);</div><div class="t m0 x32 h57 y2f30 ff1a fs2d fc0 sc0 ls0 ws0">722 <span class="_ _186"> </span>*hcp++<span class="_"> </span><span class="ls15c">=’<span class="_ _1d"></span><span class="ls0">\r’;</span></span></div><div class="t m0 x32 h57 y56fd ff1a fs2d fc0 sc0 ls0 ws0">723 <span class="_ _186"> </span>*hcp++<span class="_"> </span><span class="ls15c">=’<span class="_ _1d"></span><span class="ls0">\n’;</span></span></div><div class="t m0 x32 h57 y5848 ff1a fs2d fc0 sc0 ls0 ws0">724 <span class="_ _186"> </span>hlen<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">cp - hbuf;</span></span></div><div class="t m0 x32 h4d y5b4f ff19 fs26 fc0 sc0 ls0 ws0">[699 <span class="_ _a"></span>– <span class="_ _a"></span>708]<span class="_ _65"> </span>The <span class="_ _23"> </span>last <span class="_ _42"> </span>attribute <span class="_ _42"> </span>we <span class="_ _23"> </span>supply <span class="_ _42"> </span>is <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">document-format</span><span class="ls17ca">.I<span class="_ _7"></span><span class="ls0">f<span class="_ _35"> </span>we<span class="_ _44"> </span>omit <span class="_ _23"> </span>it, <span class="_ _42"> </span>the</span></span></div><div class="t m0 x11a h49 y5b50 ff19 fs26 fc0 sc0 ls0 ws0">printer <span class="_ _42"> </span>will <span class="_ _53"> </span>interpret <span class="_ _53"> </span>the <span class="_ _53"> </span>ﬁle <span class="_ _42"> </span>using <span class="_ _53"> </span>some <span class="_ _53"> </span>default <span class="_ _53"> </span>format.<span class="_ _65"> </span>For <span class="_ _53"> </span>a <span class="_ _53"> </span>PostScript</div><div class="t m0 x11a h49 y5b51 ff19 fs26 fc0 sc0 ls0 ws0">printer<span class="_ _6"></span><span class="ls12bf">,t<span class="_ _4a"></span><span class="ls0">his <span class="_"> </span>is <span class="_ _66"> </span>probably <span class="_"> </span>PostScript, <span class="_"> </span>but <span class="_ _66"> </span>some <span class="_ _66"> </span>printers <span class="_"> </span>can <span class="_ _66"> </span>autosense <span class="_ _66"> </span>the</span></span></div><div class="t m0 x11a h49 y5b52 ff19 fs26 fc0 sc0 ls0 ws0">format <span class="_ _2"></span>and <span class="_ _2"></span>choose <span class="_ _3"></span>between <span class="_ _2"></span>PostScript, <span class="_ _2"></span>plaintext, <span class="_ _3"></span>or <span class="_ _2"></span>PCL <span class="_ _2"></span>(Hewlett-Packard’s</div><div class="t m0 x11a h4d y5c86 ff19 fs26 fc0 sc0 ls0 ws0">Printer <span class="_ _9"></span>Command <span class="_ _3"></span>Language).<span class="_ _5a"> </span>If <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">PR_TEXT<span class="_ _45"> </span></span>ﬂag <span class="_ _3"></span>is <span class="_ _9"></span>set, <span class="_ _9"></span>we <span class="_ _9"></span>set <span class="_ _9"></span>the <span class="_ _9"></span>format</div><div class="t m0 x11a h4d y5c87 ff19 fs26 fc0 sc0 ls0 ws0">to<span class="_ _51"> </span><span class="ff1a">text/plain</span><span class="ls17cb">.O<span class="_ _4d"></span><span class="ls0">therwise, <span class="_ _35"> </span>we <span class="_ _45"> </span>set <span class="_ _35"> </span>it <span class="_ _45"> </span>to<span class="_ _51"> </span><span class="ff1a">application/postscript</span>.</span></span></div><div class="t m0 x11a h49 y5c88 ff19 fs26 fc0 sc0 ls0 ws0">Then <span class="_ _e"> </span>we <span class="_ _e"> </span>delimit <span class="_ _e"> </span>the <span class="_"> </span>end <span class="_ _53"> </span>of <span class="_ _e"> </span>the <span class="_ _e"> </span>attributes <span class="_"> </span>portion <span class="_ _53"> </span>of <span class="_ _e"> </span>the <span class="_"> </span>header <span class="_ _53"> </span>with <span class="_ _e"> </span>an</div><div class="t m0 x11a h49 y5c89 ff19 fs26 fc0 sc0 ls0 ws0">end-of-attributes tag and calculate the size of the IPP header<span class="_ _6"></span>.</div><div class="t m0 x11a h4d y5c8a ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _66"> </span><span class="ff1a">extra<span class="_ _47"> </span></span>integer <span class="_ _2"></span>counts <span class="_ _2"></span>any <span class="_ _2"></span>extra <span class="_ _2"></span>characters <span class="_ _2"></span>we <span class="_ _3"></span>might <span class="_ _2"></span>need <span class="_ _2"></span>to <span class="_ _2"></span>transmit <span class="_ _2"></span>to</div><div class="t m0 x11a h49 y5c8b ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>printer<span class="_ _6"></span><span class="ls17cc">.A<span class="_ _5b"></span><span class="ls0">s<span class="_ _47"> </span>we<span class="_ _66"> </span>shall <span class="_ _2"></span>see <span class="_ _2"></span>shortly<span class="_ _6"></span>,<span class="_ _66"> </span>we<span class="_ _66"> </span>n<span class="_ _2"></span>eed <span class="_ _2"></span>to <span class="_ _2"></span>send <span class="_ _2"></span>an <span class="_ _2"></span>extra <span class="_ _2"></span>character <span class="_ _2"></span>to <span class="_ _2"></span>be</span></span></div><div class="t m0 x11a h49 y5c8c ff19 fs26 fc0 sc0 ls0 ws0">able <span class="_ _9"></span>to <span class="_ _9"></span>print <span class="_ _9"></span>plain <span class="_ _23"></span>text <span class="_ _9"></span>reliably<span class="_ _4"></span><span class="ls1532">.W<span class="_ _52"></span><span class="ls1533">en<span class="_ _b"></span><span class="ls0">eed <span class="_ _3"></span>to <span class="_ _23"></span>account <span class="_ _9"></span>for <span class="_ _9"></span>this <span class="_ _9"></span>extra <span class="_ _9"></span>character</span></span></span></div><div class="t m0 x11a h49 y5c8d ff19 fs26 fc0 sc0 ls0 ws0">when we calculate the content length.</div><div class="t m0 x32 h49 y5c8e ff19 fs26 fc0 sc0 ls0 ws0">[709 <span class="_ _a"></span>– <span class="_ _a"></span>724]<span class="_ _65"> </span>Now that <span class="_ _2"></span>we <span class="_ _2"></span>know <span class="_ _2"></span>the <span class="_ _2"></span>IPP <span class="_ _2"></span>header <span class="_ _2"></span>size, <span class="_ _2"></span>we <span class="_ _2"></span>can <span class="_ _2"></span>set <span class="_ _2"></span>up <span class="_ _2"></span>the <span class="_ _2"></span>HTTP <span class="_ _2"></span>header<span class="_ _6"></span><span class="ls17cd">.W<span class="_ _26"></span><span class="ls0">e</span></span></div><div class="t m0 x11a h4d y5c8f ff19 fs26 fc0 sc0 ls0 ws0">set <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">Content-Length<span class="_ _47"> </span></span>to <span class="_ _2"></span>the <span class="_ _2"></span>size <span class="_ _3"></span>in <span class="_ _2"></span>bytes <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _3"></span>IPP <span class="_ _2"></span>header <span class="_ _2"></span>plus <span class="_ _2"></span>the <span class="_ _3"></span>size</div><div class="t m0 x11a h49 y5c90 ff19 fs26 fc0 sc0 ls0 ws0">of <span class="_ _42"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>to <span class="_ _42"> </span>be <span class="_ _42"> </span>printed <span class="_ _42"> </span>plus <span class="_ _42"> </span>any <span class="_ _42"> </span>extra <span class="_ _23"> </span>characters <span class="_ _42"> </span>we <span class="_ _42"> </span>might <span class="_ _42"> </span>need <span class="_ _42"> </span>to <span class="_ _42"> </span>send.</div><div class="t m0 x11a h4d y5c91 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _47"> </span><span class="ff1a">Content-Type<span class="_ _45"> </span></span>is<span class="_ _47"> </span><span class="ff1a">application/ipp</span><span class="ls17ce">.W<span class="_ _7"></span><span class="ls2c7">em<span class="_ _b"></span><span class="ls0">ark <span class="_ _9"></span>the <span class="_ _3"></span>end <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _3"></span>HTTP</span></span></span></div><div class="t m0 x11a h49 y5c92 ff19 fs26 fc0 sc0 ls0 ws0">header with a carriage return and a line feed.<span class="_ _59"> </span>Finally<span class="_ _4"></span>,<span class="_"> </span>we<span class="_"> </span>calculate the size of</div><div class="t m0 x11a h49 y5c93 ff19 fs26 fc0 sc0 ls0 ws0">the HTTP header<span class="_ _6"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
