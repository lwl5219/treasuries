<div id="pf1d7" class="pf w4 h1f" data-page-no="1d7"><div class="pc pc1d7 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg1d7.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>12.4<span class="_ _57"> </span>Synchronization <span class="_"> </span>Attributes<span class="_ _1b"> </span><span class="ff18">437</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">void <span class="_ _74"> </span>*to_arg;<span class="_ _176"> </span>/* argument */</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">struct timespec to_wait;<span class="_ _186"> </span>/* time to wait */</div><div class="t m0 x32 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h57 y2db4 ff1a fs2d fc0 sc0 ls0 ws0">#define SECTONSEC<span class="_ _d9"> </span>1000000000 <span class="_ _3a"> </span>/*<span class="_"> </span>seconds to nanoseconds */</div><div class="t m0 x32 h57 y2db5 ff1a fs2d fc0 sc0 ls0 ws0">#if !defined(CLOCK_REALTIME) || defined(BSD)</div><div class="t m0 x32 h57 y3684 ff1a fs2d fc0 sc0 ls0 ws0">#define clock_nanosleep(ID, FL, REQ, REM)<span class="_ _68"> </span>nanosleep((REQ), (REM))</div><div class="t m0 x32 h57 y3685 ff1a fs2d fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x32 h57 y2db8 ff1a fs2d fc0 sc0 ls0 ws0">#ifndef CLOCK_REALTIME</div><div class="t m0 x32 h57 y2db9 ff1a fs2d fc0 sc0 ls0 ws0">#define CLOCK_REALTIME 0</div><div class="t m0 x32 h57 y2dba ff1a fs2d fc0 sc0 ls0 ws0">#define USECTONSEC 1000<span class="_ _8a"> </span>/* microseconds to nanoseconds */</div><div class="t m0 x32 h57 y2dbb ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h57 y3686 ff1a fs2d fc0 sc0 ls0 ws0">clock_gettime(int id, struct timespec *tsp)</div><div class="t m0 x32 h57 y1de9 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y1dea ff1a fs2d fc0 sc0 ls0 ws0">struct timeval tv;</div><div class="t m0 x8a h57 y3687 ff1a fs2d fc0 sc0 ls0 ws0">gettimeofday(&amp;tv, NULL);</div><div class="t m0 x8a h57 y2e77 ff1a fs2d fc0 sc0 ls0 ws0">tsp-&gt;tv_sec = tv.tv_sec;</div><div class="t m0 x8a h57 y2e78 ff1a fs2d fc0 sc0 ls0 ws0">tsp-&gt;tv_nsec = tv.tv_usec * USECTONSEC;</div><div class="t m0 x32 h57 y2e79 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y2e7a ff1a fs2d fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x32 h57 y3688 ff1a fs2d fc0 sc0 ls0 ws0">void *</div><div class="t m0 x32 h57 y3689 ff1a fs2d fc0 sc0 ls0 ws0">timeout_helper(void *arg)</div><div class="t m0 x32 h57 y368a ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y368b ff1a fs2d fc0 sc0 ls0 ws0">struct to_info<span class="_ _d9"> </span>*tip;</div><div class="t m0 x8a h57 y368c ff1a fs2d fc0 sc0 ls0 ws0">tip = (struct to_info *)arg;</div><div class="t m0 x8a h57 y368d ff1a fs2d fc0 sc0 ls0 ws0">clock_nanosleep(CLOCK_REALTIME, 0, &amp;tip-&gt;to_wait, NULL);</div><div class="t m0 x8a h57 y368e ff1a fs2d fc0 sc0 ls0 ws0">(*tip-&gt;to_fn)(tip-&gt;to_arg);</div><div class="t m0 x8a h57 y368f ff1a fs2d fc0 sc0 ls0 ws0">free(arg);</div><div class="t m0 x8a h57 y3690 ff1a fs2d fc0 sc0 ls0 ws0">return(0);</div><div class="t m0 x32 h57 y3691 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y3692 ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h57 y3693 ff1a fs2d fc0 sc0 ls0 ws0">timeout(const struct timespec *when, void (*func)(void *), void *arg)</div><div class="t m0 x32 h57 y3694 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y3695 ff1a fs2d fc0 sc0 ls0 ws0">struct timespec now;</div><div class="t m0 x8a h57 y3696 ff1a fs2d fc0 sc0 ls0 ws0">struct to_info<span class="_ _d9"> </span>*tip;</div><div class="t m0 x8a h57 y3697 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>err;</div><div class="t m0 x8a h57 y3698 ff1a fs2d fc0 sc0 ls0 ws0">clock_gettime(CLOCK_REALTIME, &amp;now);</div><div class="t m0 x8a h57 y3699 ff1a fs2d fc0 sc0 ls0 ws0">if ((when-&gt;tv_sec &gt; now.tv_sec) ||</div><div class="t m0 x194 h57 y369a ff1a fs2d fc0 sc0 ls0 ws0">(when-&gt;tv_sec == now.tv_sec &amp;&amp; when-&gt;tv_nsec &gt; now.tv_nsec)) {</div><div class="t m0 x9d h57 y369b ff1a fs2d fc0 sc0 ls0 ws0">tip = malloc(sizeof(struct to_info));</div><div class="t m0 x9d h57 y369c ff1a fs2d fc0 sc0 ls0 ws0">if (tip != NULL) {</div><div class="t m0 x1f h57 y369d ff1a fs2d fc0 sc0 ls0 ws0">tip-&gt;to_fn = func;</div><div class="t m0 x1f h57 y369e ff1a fs2d fc0 sc0 ls0 ws0">tip-&gt;to_arg = arg;</div><div class="t m0 x1f h57 y369f ff1a fs2d fc0 sc0 ls0 ws0">tip-&gt;to_wait.tv_sec = when-&gt;tv_sec - now.tv_sec;</div><div class="t m0 x1f h57 y36a0 ff1a fs2d fc0 sc0 ls0 ws0">if (when-&gt;tv_nsec &gt;= now.tv_nsec) {</div><div class="t m0 x1ca h57 y36a1 ff1a fs2d fc0 sc0 ls0 ws0">tip-&gt;to_wait.tv_nsec = when-&gt;tv_nsec - now.tv_nsec;</div><div class="t m0 x1f h57 y36a2 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
