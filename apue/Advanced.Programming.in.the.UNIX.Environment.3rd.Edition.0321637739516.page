<div id="pf204" class="pf w4 h1f" data-page-no="204"><div class="pc pc204 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg204.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">482<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls49 ws0">•C<span class="_ _4d"></span><span class="ls0">ertain<span class="_"> </span><span class="ff1a">ioctl<span class="_ _80"> </span></span>operations</span></div><div class="t m0 x3f h2a y95d ff19 fsf fc0 sc0 ls49 ws0">•S<span class="_ _4d"></span><span class="ls0">ome of the interprocess communication functions (Chapter 15)</span></div><div class="t m0 x32 h2a y3b2a ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _80"> </span>a<span class="_ _9"></span><span class="ls0">lso <span class="_ _3"></span>said <span class="_ _3"></span>that <span class="_ _3"></span>system <span class="_ _2"></span>calls <span class="_ _3"></span>related <span class="_ _3"></span>to <span class="_ _2"></span>disk <span class="_ _3"></span>I/O <span class="_ _3"></span>ar<span class="lsfb8">en<span class="_ _8"></span><span class="ls0">ot <span class="_ _3"></span>considered <span class="_ _2"></span>slow<span class="_ _6"></span><span class="lsfb8">,e<span class="_ _4f"></span><span class="ls0">ven <span class="_ _2"></span>though</span></span></span></span></span></div><div class="t m0 x32 h2a y3b2b ff19 fsf fc0 sc0 ls0 ws0">the read or write of a disk ﬁle can block the caller temporarily<span class="_ _4"></span>.</div><div class="t m0 x3f h26 y3b2c ff19 fsf fc0 sc0 ls0 ws0">Nonblocking <span class="_ _2"></span>I/O <span class="_ _3"></span>lets <span class="_ _2"></span>us <span class="_ _2"></span>issue <span class="_ _3"></span>an <span class="_ _2"></span>I/O <span class="_ _3"></span>operation, <span class="_ _2"></span>such <span class="_ _3"></span>as <span class="_ _2"></span>an<span class="_ _47"> </span><span class="ff1a">open</span>,<span class="_ _47"> </span><span class="ff1a">read</span><span class="lsfb9">,o<span class="_ _4f"></span><span class="ls0">r<span class="_ _66"> </span><span class="ff1a">write</span>,</span></span></div><div class="t m0 x32 h2a y1931 ff19 fsf fc0 sc0 ls0 ws0">and <span class="_ _42"> </span>not <span class="_ _42"> </span>have <span class="_ _42"> </span>it <span class="_ _53"> </span>block <span class="_ _42"> </span>forever<span class="_ _6"></span><span class="lsfba">.I<span class="_ _52"></span><span class="lsfbb">ft<span class="_ _43"></span><span class="ls0">he <span class="_ _42"> </span>operation <span class="_ _42"> </span>cannot <span class="_ _53"> </span>be <span class="_ _42"> </span>completed, <span class="_ _42"> </span>the <span class="_ _53"> </span>call <span class="_ _42"> </span>returns</span></span></span></div><div class="t m0 x32 h2a y1fe ff19 fsf fc0 sc0 ls0 ws0">immediately with an error noting that the operation would have blocked.</div><div class="t m0 x3f h2a y1ff ff19 fsf fc0 sc0 ls0 ws0">Ther<span class="ls44">ea<span class="_ _4f"></span><span class="ls45">re <span class="_ _3"></span>t<span class="ls0">wo ways to specify nonblocking I/O for a given descriptor<span class="_ _1"></span>.</span></span></span></div><div class="t m0 x3f h26 y3b2d ff19 fsf fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>If<span class="_ _59"> </span>we <span class="_"> </span>call<span class="_ _59"> </span><span class="ff1a">open<span class="_ _59"> </span></span>to <span class="_"> </span>get <span class="_"> </span>the <span class="_"> </span>descriptor<span class="_ _6"></span>,<span class="_ _59"> </span>we<span class="_ _59"> </span>can <span class="_"> </span>specify <span class="_"> </span>the<span class="_ _59"> </span><span class="ff1a">O_NONBLOCK<span class="_ _59"> </span></span>ﬂag</div><div class="t m0 x41 h2a y95f ff19 fsf fc0 sc0 ls0 ws0">(Section 3.3).</div><div class="t m0 x3f h26 y1155 ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>For<span class="_"> </span><span class="ls271">ad<span class="_ _d"></span><span class="ls0">escriptor <span class="_ _2"></span>that is <span class="_ _2"></span>already open, we <span class="_ _2"></span>call<span class="_"> </span><span class="ff1a">fcntl<span class="_ _66"> </span></span>to <span class="_ _2"></span>turn <span class="_ _2"></span>on the<span class="_ _66"> </span><span class="ff1a">O_NONBLOCK</span></span></span></div><div class="t m0 x41 h2a y961 ff19 fsf fc0 sc0 ls0 ws0">ﬁle <span class="_ _23"></span>status <span class="_ _23"></span>ﬂag <span class="_ _23"> </span>(Section <span class="_ _23"> </span>3.14).<span class="_ _51"> </span>Figur<span class="ls12f">e3<span class="_ _43"></span><span class="ls0">.12 <span class="_ _23"> </span>shows <span class="_ _23"> </span>a <span class="_ _23"> </span>function <span class="_ _23"> </span>that <span class="_ _23"> </span>we <span class="_ _42"> </span>can <span class="_ _23"></span>call <span class="_ _23"></span>to</span></span></div><div class="t m0 x41 h2a y962 ff19 fsf fc0 sc0 ls0 ws0">turn on any of the ﬁle status ﬂags for a descriptor<span class="_ _6"></span>.</div><div class="t m0 x76 h52 y3b2e ff19 fs2a fc0 sc0 ls0 ws0">Earlier <span class="_ _23"> </span>versions <span class="_ _42"> </span>of <span class="_ _23"> </span>System <span class="_ _42"> </span>V <span class="_ _23"> </span>used <span class="_ _23"> </span>the <span class="_ _42"> </span>ﬂag<span class="_ _45"> </span><span class="ff1a">O_NDELAY<span class="_ _45"> </span></span>to <span class="_ _23"> </span>specify <span class="_ _42"> </span>nonblocking <span class="_ _23"> </span>mode.<span class="_ _61"> </span>These</div><div class="t m0 x76 h52 y3b2f ff19 fs2a fc0 sc0 ls0 ws0">versions <span class="_ _2"></span>of <span class="_ _3"></span>System <span class="_ _2"></span>V <span class="_ _3"></span>returned <span class="_ _2"></span>a <span class="_ _2"></span>value <span class="_ _3"></span>of <span class="_ _3"></span>0 <span class="_ _2"></span>from <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">read<span class="_ _80"> </span></span>function <span class="_ _2"></span>if <span class="_ _3"></span>ther<span class="lsfbc">ew<span class="_ _d"></span><span class="ls0">asn’t <span class="_ _3"></span>any <span class="_ _2"></span>data <span class="_ _3"></span>to</span></span></div><div class="t m0 x76 h51 y3b30 ff19 fs2a fc0 sc0 ls0 ws0">be <span class="_"> </span>r<span class="_ _0"></span>ead. <span class="_ _35"> </span>Since<span class="_ _35"> </span>this <span class="_ _42"> </span>use <span class="_"> </span>of <span class="_"> </span>a <span class="_ _42"> </span>return <span class="_ _42"> </span>value <span class="_"> </span>of <span class="_"> </span>0 <span class="_ _42"> </span>overlapped <span class="_"> </span>with <span class="_ _42"> </span>the <span class="_"> </span>normal <span class="_ _42"> </span>UNIX <span class="_"> </span>System</div><div class="t m0 x76 h51 y3b31 ff19 fs2a fc0 sc0 ls0 ws0">convention <span class="_ _3"></span>of <span class="_ _9"></span>0 <span class="_ _9"></span>meaning <span class="_ _9"></span>the <span class="_ _9"></span>end <span class="_ _3"></span>of <span class="_ _9"></span>ﬁle, <span class="_ _9"></span>POSIX.1 <span class="_ _9"></span>chose <span class="_ _3"></span>to <span class="_ _9"></span>provide <span class="_ _9"></span>a <span class="_ _3"></span>nonblocking <span class="_ _9"></span>ﬂag <span class="_ _9"></span>with <span class="_ _9"></span>a</div><div class="t m0 x76 h51 y3b32 ff19 fs2a fc0 sc0 ls0 ws0">differ<span class="_ _0"></span>ent <span class="_ _3"></span>name <span class="_ _9"></span>and <span class="_ _3"></span>different <span class="_ _2"></span>semantics.<span class="_ _59"> </span>Indeed, <span class="_ _3"></span>with <span class="_ _9"></span>these <span class="_ _3"></span>older <span class="_ _9"></span>versions <span class="_ _3"></span>of <span class="_ _9"></span>System <span class="_ _3"></span>V<span class="_ _6"></span><span class="lsfbd">,w<span class="_ _4f"></span><span class="ls0">hen</span></span></div><div class="t m0 x76 h52 y3b33 ff19 fs2a fc0 sc0 ls0 ws0">we <span class="_ _42"> </span>get <span class="_ _42"> </span>a <span class="_"> </span>r<span class="_ _0"></span>eturn <span class="_ _42"> </span>of <span class="_ _42"> </span>0 <span class="_ _42"> </span>from<span class="_ _35"> </span><span class="ff1a">read</span>,<span class="_ _45"> </span>we<span class="_ _35"> </span>don’t <span class="_ _42"> </span>know <span class="_ _42"> </span>whether <span class="_ _42"> </span>the <span class="_"> </span>call <span class="_ _23"> </span>would <span class="_"> </span>have <span class="_ _42"> </span>blocked <span class="_ _42"> </span>or</div><div class="t m0 x76 h52 y3b34 ff19 fs2a fc0 sc0 ls0 ws0">whether <span class="_ _2"></span>the <span class="_ _3"></span>end <span class="_ _3"></span>of <span class="_ _3"></span>ﬁle <span class="_ _3"></span>was <span class="_ _3"></span>encountered. <span class="_ _80"> </span>W<span class="_ _6"></span>e’ll <span class="_ _3"></span>see <span class="_ _3"></span>that <span class="_ _3"></span>POSIX.1 <span class="_ _3"></span>requires <span class="_ _2"></span>that<span class="_ _80"> </span><span class="ff1a">read<span class="_ _66"> </span></span><span class="ls34e">re</span>turn<span class="_ _66"> </span><span class="ff20">−</span>1</div><div class="t m0 x76 h52 y3b35 ff19 fs2a fc0 sc0 ls0 ws0">with<span class="_ _47"> </span><span class="ff1a">errno<span class="_ _45"> </span></span>set <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">EAGAIN<span class="_ _47"> </span></span>if <span class="_ _23"> </span>there<span class="_ _66"> </span>is<span class="_ _45"> </span>n<span class="lsfbe">od<span class="_ _b"></span><span class="ls0">ata <span class="_ _23"> </span>to <span class="_ _23"> </span>read <span class="_ _9"> </span>from <span class="_ _23"> </span>a <span class="_ _23"> </span>nonblocking <span class="_ _9"> </span>descriptor<span class="_ _1"></span><span class="lsfbf">.S<span class="_ _4a"></span><span class="ls0">ome</span></span></span></span></div><div class="t m0 x76 h52 y3b36 ff19 fs2a fc0 sc0 ls0 ws0">platforms <span class="_ _47"> </span>derived <span class="_ _47"> </span>from <span class="_ _66"> </span>System <span class="_ _47"> </span>V <span class="_ _47"> </span>support <span class="_ _47"> </span>both <span class="_ _47"> </span>the <span class="_ _47"> </span>older<span class="_ _59"> </span><span class="ff1a">O_NDELAY<span class="_ _46"> </span></span>and <span class="_ _47"> </span>the <span class="_ _47"> </span>POSIX.1</div><div class="t m0 x76 h52 y3b37 ff1a fs2a fc0 sc0 ls0 ws0">O_NONBLOCK<span class="ff19 lsfc0">,b<span class="_ _b"></span><span class="ls0">ut <span class="_ _23"> </span>in <span class="_"> </span>this <span class="_ _23"> </span>text <span class="_"> </span>we’ll <span class="_ _23"> </span>use <span class="_"> </span>only <span class="_ _23"> </span>the <span class="_"> </span>POSIX.1 <span class="_ _23"> </span>feature. <span class="_ _35"> </span>The<span class="_ _45"> </span>older<span class="_ _35"> </span><span class="ff1a">O_NDELAY<span class="_ _45"> </span></span>is</span></span></div><div class="t m0 x76 h51 y3b38 ff19 fs2a fc0 sc0 ls0 ws0">intended for backwar<span class="lse9">dc<span class="_ _5"></span><span class="ls0">ompatibility and should not be used in new applications.</span></span></div><div class="t m0 x76 h52 y3b39 ff19 fs2a fc0 sc0 ls0 ws0">4.3BSD <span class="_"> </span>provided <span class="_ _80"> </span>the<span class="_ _44"> </span><span class="ff1a">FNDELAY<span class="_ _44"> </span></span>ﬂag <span class="_ _80"> </span>for<span class="_ _44"> </span><span class="ff1a">fcntl</span><span class="lsfc1">,a<span class="_ _43"></span><span class="ls0">nd <span class="_"> </span>its <span class="_ _e"> </span>semantics <span class="_ _80"> </span>wer<span class="ls50b">es<span class="_ _c"></span><span class="ls0">lightly <span class="_ _80"> </span>differ<span class="_ _0"></span>ent.</span></span></span></span></div><div class="t m0 x76 h51 y3b3a ff19 fs2a fc0 sc0 ls0 ws0">Instead <span class="_ _2"></span>of <span class="_ _3"></span>affecting <span class="_ _2"></span>only <span class="_ _2"></span>the <span class="_ _3"></span>ﬁle <span class="_ _2"></span>status <span class="_ _3"></span>ﬂags <span class="_ _2"></span>for <span class="_ _3"></span>the <span class="_ _2"></span>descriptor<span class="_ _0"></span><span class="lsfc2">,t<span class="_ _d"></span><span class="ls0">he <span class="_ _3"></span>ﬂags <span class="_ _2"></span>for <span class="_ _3"></span>either <span class="_ _2"></span>the <span class="_ _3"></span>terminal</span></span></div><div class="t m0 x76 h51 y3b3b ff19 fs2a fc0 sc0 ls0 ws0">device <span class="_ _23"> </span>or <span class="_ _9"></span>the <span class="_ _23"> </span>socket <span class="_ _23"> </span>wer<span class="lsfc3">ea<span class="_ _b"></span><span class="ls0">lso <span class="_ _23"> </span>changed <span class="_ _23"> </span>to <span class="_ _9"></span>be <span class="_ _23"> </span>nonblocking, <span class="_ _23"> </span>thereby <span class="_ _9"></span>affecting <span class="_ _9"> </span>all <span class="_ _23"> </span>users <span class="_ _23"> </span>of <span class="_ _23"> </span>the</span></span></div><div class="t m0 x76 h51 y3b3c ff19 fs2a fc0 sc0 ls0 ws0">terminal or socket, <span class="_ _2"></span>not just the <span class="_ _2"></span>users sharing the <span class="_ _2"></span>same ﬁle table <span class="_ _2"></span>entry (4.3BSD nonblocking <span class="_ _2"></span>I/O</div><div class="t m0 x76 h52 y3b3d ff19 fs2a fc0 sc0 ls0 ws0">worked <span class="_ _2"></span>only <span class="_ _3"></span>on <span class="_ _3"></span>terminals <span class="_ _3"></span>and <span class="_ _2"></span>sockets).<span class="_ _59"> </span>Also, <span class="_ _2"></span>4.3BSD <span class="_ _3"></span>returned<span class="_ _80"> </span><span class="ff1a">EWOULDBLOCK<span class="_ _80"> </span></span>if <span class="_ _3"></span>an <span class="_ _3"></span>operation</div><div class="t m0 x76 h51 y3b3e ff19 fs2a fc0 sc0 ls0 ws0">on <span class="_ _2"></span>a <span class="_ _3"></span>nonblocking <span class="_ _2"></span>descriptor <span class="_ _3"></span>could <span class="_ _2"></span>not <span class="_ _3"></span>complete <span class="_ _2"></span>without <span class="_ _3"></span>blocking.<span class="_ _4b"> </span><span class="lsed">To<span class="_ _3"></span></span>day<span class="_ _1"></span><span class="ls106">,B<span class="_ _d"></span><span class="ls0">SD</span></span></div><div class="t m0 x82 h51 y3b3f ff19 fs2a fc0 sc0 ls0 ws0">-</div><div class="t m0 xf9 h51 y3b3e ff19 fs2a fc0 sc0 ls0 ws0">based <span class="_ _2"></span>systems</div><div class="t m0 x76 h52 y3b40 ff19 fs2a fc0 sc0 ls0 ws0">provide <span class="_ _3"></span>the <span class="_ _3"></span>POSIX.1<span class="_ _47"> </span><span class="ff1a">O_NONBLOCK<span class="_ _66"> </span></span>ﬂag <span class="_ _3"></span>and <span class="_ _9"></span>deﬁne<span class="_ _66"> </span><span class="ff1a">EWOULDBLOCK<span class="_ _66"> </span></span>to <span class="_ _9"></span>be <span class="_ _9"></span>the <span class="_ _3"></span>same <span class="_ _9"></span>as<span class="_ _66"> </span><span class="ff1a">EAGAIN</span>.</div><div class="t m0 x76 h51 y3b41 ff19 fs2a fc0 sc0 ls0 ws0">These <span class="_ _45"> </span>systems <span class="_ _35"> </span>provide <span class="_ _45"> </span>nonblocking <span class="_ _35"> </span>semantics <span class="_ _45"> </span>consistent <span class="_ _35"> </span>with <span class="_ _45"> </span>other <span class="_ _35"> </span>POSIX-compatible</div><div class="t m0 x76 h51 y3b42 ff19 fs2a fc0 sc0 ls0 ws0">systems: <span class="_ _e"> </span>changes <span class="_ _80"> </span>in <span class="_ _80"> </span>ﬁle <span class="_ _e"> </span>status <span class="_ _80"> </span>ﬂags <span class="_ _80"> </span>affect <span class="_"> </span>all <span class="_ _80"> </span>users <span class="_ _80"> </span>of <span class="_ _e"> </span>the <span class="_ _80"> </span>same <span class="_ _80"> </span>ﬁle <span class="_ _80"> </span>table <span class="_"> </span>entry<span class="_ _1"></span><span class="lsfc4">,b<span class="_ _c"></span><span class="ls0">ut <span class="_ _80"> </span>are</span></span></div><div class="t m0 x76 h51 y3b43 ff19 fs2a fc0 sc0 ls0 ws0">independent <span class="_ _3"></span>of <span class="_ _9"></span>accesses <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>same <span class="_ _9"></span>device <span class="_ _9"></span>through <span class="_ _2"></span>other <span class="_ _9"></span>ﬁle <span class="_ _9"></span>table <span class="_ _3"></span>entries.<span class="_ _59"> </span>(Refer <span class="_ _3"></span>to <span class="_ _9"></span>Figures</div><div class="t m0 x76 h51 y3b44 ff19 fs2a fc0 sc0 ls0 ws0">3.7 and 3.9.)</div><div class="t m0 x35 h27 y3b45 ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y3b46 ff19 fsf fc0 sc0 ls0 ws0">Let’s <span class="_ _9"></span>look <span class="_ _9"></span>at <span class="_ _23"></span>an <span class="_ _9"></span>example <span class="_ _9"></span>of <span class="_ _23"></span>nonblocking <span class="_ _9"></span>I/O.<span class="_ _5a"> </span>The <span class="_ _9"></span>program <span class="_ _9"></span>in <span class="_ _9"></span>Figur<span class="lsfc5">e1<span class="_ _b"></span><span class="ls0">4.1 <span class="_ _9"></span>reads <span class="_ _9"></span>up <span class="_ _9"></span>to</span></span></div><div class="t m0 x32 h2a y3b47 ff19 fsf fc0 sc0 ls0 ws0">500,000 <span class="_ _9"></span>bytes <span class="_ _9"></span>from <span class="_ _9"></span>the <span class="_ _9"></span>standar<span class="ls848">di<span class="_ _b"></span><span class="ls0">nput <span class="_ _3"></span>and <span class="_ _9"></span>attempts <span class="_ _23"></span>to <span class="_ _9"></span>write <span class="_ _9"></span>it <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>standar<span class="ls848">do<span class="_ _b"></span><span class="ls0">utput.</span></span></span></span></div><div class="t m0 x32 h2a y3b48 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _42"> </span>standar<span class="_ _0"></span><span class="lsa81">do<span class="_ _43"></span><span class="ls0">utput <span class="_ _23"> </span>is <span class="_ _42"> </span>ﬁrst <span class="_ _42"> </span>set <span class="_ _42"> </span>to <span class="_ _42"> </span>be <span class="_ _23"> </span>nonblocking.<span class="_ _54"> </span>The <span class="_ _42"> </span>output <span class="_ _23"> </span>is <span class="_ _42"> </span>in <span class="_ _42"> </span>a <span class="_ _42"> </span>loop, <span class="_ _23"> </span>with <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h26 y3b49 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">sults <span class="_ _53"> </span>of <span class="_ _e"> </span>each<span class="_ _4b"> </span><span class="ff1a">write<span class="_ _44"> </span></span>being <span class="_ _e"> </span>printed <span class="_ _53"> </span>on <span class="_ _53"> </span>the <span class="_ _53"> </span>standar<span class="lsfc6">de<span class="_ _c"></span><span class="ls0">rror<span class="_ _6"></span><span class="lsfc7">.T<span class="_ _64"></span><span class="ls0">he <span class="_ _e"> </span>function<span class="_ _4b"> </span><span class="ff1a">clr_fl<span class="_ _44"> </span></span>is</span></span></span></span></span></div><div class="t m0 x32 h26 y3b4a ff19 fsf fc0 sc0 ls0 ws0">similar <span class="_"> </span>to <span class="_"> </span>the <span class="_ _e"> </span>function<span class="_ _59"> </span><span class="ff1a">set_fl<span class="_ _46"> </span></span>that <span class="_"> </span>we <span class="_"> </span>showed <span class="_ _e"> </span>in <span class="_"> </span>Figur<span class="lsfc8">e3<span class="_ _5b"></span><span class="ls0">.12. <span class="_ _46"> </span>This<span class="_ _59"> </span>new <span class="_"> </span>function</span></span></div><div class="t m0 x32 h2a y3b4b ff19 fsf fc0 sc0 ls0 ws0">simply clears one or more<span class="_"> </span>of<span class="_"> </span>the ﬂag bits.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
