<div id="pf6b" class="pf w4 h1f" data-page-no="6b"><div class="pc pc6b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg6b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>3.9<span class="_ _16f"> </span>I/O <span class="_"> </span>Efﬁciency<span class="_ _1b"> </span><span class="ff18">73</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls49 ws0">•T<span class="_ _4d"></span><span class="ls0">he <span class="_ _42"> </span>program <span class="_ _42"> </span>doesn’t <span class="_ _42"> </span>close <span class="_ _53"> </span>the <span class="_ _42"> </span>input <span class="_ _53"> </span>ﬁle <span class="_ _42"> </span>or <span class="_ _53"> </span>output <span class="_ _42"> </span>ﬁle.<span class="_ _65"> </span>Instead, <span class="_ _42"> </span>the <span class="_ _53"> </span>program</span></div><div class="t m0 x15 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">uses <span class="_ _53"> </span>the <span class="_ _e"> </span>feature<span class="_ _4b"> </span>of<span class="_ _4b"> </span>the <span class="_ _e"> </span>UNIX <span class="_ _e"> </span>kernel <span class="_ _53"> </span>that <span class="_ _e"> </span>closes <span class="_ _e"> </span>all <span class="_ _e"> </span>open <span class="_ _e"> </span>ﬁle <span class="_ _53"> </span>descriptors <span class="_ _e"> </span>in <span class="_ _e"> </span>a</div><div class="t m0 x15 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">process when that pr<span class="_ _0"></span>ocess terminates.</div><div class="t m0 x3f h2a y3ec ff19 fsf fc0 sc0 ls49 ws0">•T<span class="_ _4d"></span><span class="ls0">his <span class="_ _45"> </span>example <span class="_ _45"> </span>works <span class="_ _45"> </span>for <span class="_ _45"> </span>both <span class="_ _45"> </span>text <span class="_ _45"> </span>ﬁles <span class="_ _45"> </span>and <span class="_ _47"> </span>binary <span class="_ _45"> </span>ﬁles, <span class="_ _45"> </span>since <span class="_ _45"> </span>there<span class="_ _5a"> </span>is<span class="_ _5a"> </span>no</span></div><div class="t m0 x15 h2a y1ad ff19 fsf fc0 sc0 ls0 ws0">differ<span class="_ _0"></span>ence between the two to the UNIX kernel.</div><div class="t m0 x3f h26 y1af ff19 fsf fc0 sc0 ls0 ws0">One <span class="_"> </span>question <span class="_ _66"> </span>we <span class="_ _66"> </span>haven’t <span class="_ _66"> </span>answered, <span class="_"> </span>however<span class="_ _1"></span>,<span class="_ _46"> </span>is<span class="_ _61"> </span>how <span class="_"> </span>we <span class="_ _66"> </span>chose <span class="_ _66"> </span>the<span class="_ _61"> </span><span class="ff1a">BUFFSIZE</span></div><div class="t m0 x32 h2a y1b0 ff19 fsf fc0 sc0 ls0 ws0">value. <span class="_ _65"> </span>Befor<span class="ls3b0">ea<span class="_ _64"></span><span class="ls0">nswering <span class="_ _4b"> </span>that, <span class="_ _4b"> </span>let’s <span class="_ _44"> </span>run <span class="_ _4b"> </span>the <span class="_ _4b"> </span>program <span class="_ _44"> </span>using <span class="_ _4b"> </span>differ<span class="_ _0"></span>ent <span class="_ _4b"> </span>values <span class="_ _44"> </span>for</span></span></div><div class="t m0 x32 h26 y153 ff1a fsf fc0 sc0 ls0 ws0">BUFFSIZE<span class="ff19 ls3b1">.F<span class="_ _52"></span><span class="ls0">igur<span class="ls3b2">e3<span class="_ _c"></span><span class="ls0">.6 <span class="_ _42"> </span>shows <span class="_ _53"> </span>the <span class="_ _42"> </span>results <span class="_ _42"> </span>for <span class="_ _42"> </span>reading <span class="_ _42"> </span>a <span class="_ _42"> </span>516,581,760</span></span></span></span></div><div class="t m0 xd4 h2a y154 ff19 fsf fc0 sc0 ls0 ws0">-</div><div class="t m0 x160 h2a y153 ff19 fsf fc0 sc0 ls0 ws0">byte <span class="_ _42"> </span>ﬁle, <span class="_ _42"> </span>using <span class="_ _53"> </span>20</div><div class="t m0 x32 h2a y155 ff19 fsf fc0 sc0 ls0 ws0">differ<span class="_ _0"></span>ent buf<span class="_ _0"></span>fer sizes.</div><div class="t m0 x9e h2d yb7c ff19 fs10 fc0 sc0 ls0 ws0">User CPU<span class="_ _6e"> </span>System CPU<span class="_ _6e"> </span>Clock time<span class="_ _75"> </span>Number</div><div class="t m0 x123 h2d yb7d ff19 fs10 fc0 sc0 ls0 ws0">(seconds) <span class="_ _87"> </span>(seconds)<span class="_ _170"> </span>(seconds) <span class="_ _1b"> </span>of<span class="_"> </span>loops</div><div class="t m0 x8 h5e yb7e ff1a fs10 fc0 sc0 ls0 ws0">BUFFSIZE</div><div class="t m0 x134 h2e yb7f ff19 fs11 fc0 sc0 ls3b3 ws0">12<span class="_ _91"></span><span class="ls0">0.03 <span class="_ _14"> </span>1<span class="_ _1"></span>17.50 <span class="_ _171"> </span>138.73<span class="_ _13"> </span>516,581,760</span></div><div class="t m0 x134 h2e yb80 ff19 fs11 fc0 sc0 ls3b4 ws0">29<span class="_ _172"></span><span class="ls0">.69 <span class="_ _dd"> </span>58.76<span class="_ _16d"> </span>68.60 <span class="_ _1b"> </span>258,290,880</span></div><div class="t m0 x134 h2e yb81 ff19 fs11 fc0 sc0 ls3b4 ws0">44<span class="_ _172"></span><span class="ls0">.60 <span class="_ _dd"> </span>36.47<span class="_ _16d"> </span>41.27 <span class="_ _1b"> </span>129,145,440</span></div><div class="t m0 x134 h2e yb82 ff19 fs11 fc0 sc0 ls3b4 ws0">82<span class="_ _172"></span><span class="ls0">.47 <span class="_ _dd"> </span>15.44<span class="_ _16d"> </span>18.38 <span class="_ _129"> </span>64,572,720</span></div><div class="t m0 x10d h2e yb83 ff19 fs11 fc0 sc0 ls0 ws0">16 <span class="_ _db"> </span>1.07<span class="_ _16e"> </span>7.93 <span class="_ _b7"> </span>9.38<span class="_ _78"> </span>32,286,360</div><div class="t m0 x10d h2e yb84 ff19 fs11 fc0 sc0 ls0 ws0">32 <span class="_ _db"> </span>0.56<span class="_ _16e"> </span>4.51 <span class="_ _b7"> </span>8.82<span class="_ _78"> </span>16,143,180</div><div class="t m0 x10d h2e yb85 ff19 fs11 fc0 sc0 ls0 ws0">64 <span class="_ _db"> </span>0.34<span class="_ _16e"> </span>2.72 <span class="_ _b7"> </span>8.66<span class="_ _ba"> </span>8,071,590</div><div class="t m0 x161 h2e yb86 ff19 fs11 fc0 sc0 ls0 ws0">128 <span class="_ _db"> </span>0.34<span class="_ _16e"> </span>1.84 <span class="_ _b7"> </span>8.69<span class="_ _ba"> </span>4,035,795</div><div class="t m0 x161 h2e yb87 ff19 fs11 fc0 sc0 ls0 ws0">256 <span class="_ _db"> </span>0.15<span class="_ _16e"> </span>1.30 <span class="_ _b7"> </span>8.69<span class="_ _ba"> </span>2,017,898</div><div class="t m0 x161 h2e yb88 ff19 fs11 fc0 sc0 ls0 ws0">512 <span class="_ _db"> </span>0.09<span class="_ _16e"> </span>0.95 <span class="_ _b7"> </span>8.63<span class="_ _ba"> </span>1,008,949</div><div class="t m0 x126 h2e yb89 ff19 fs11 fc0 sc0 ls0 ws0">1,024 <span class="_ _db"> </span>0.02<span class="_ _16e"> </span>0.78 <span class="_ _b7"> </span>8.58<span class="_ _dd"> </span>504,475</div><div class="t m0 x126 h2e yb8a ff19 fs11 fc0 sc0 ls0 ws0">2,048 <span class="_ _db"> </span>0.04<span class="_ _16e"> </span>0.66 <span class="_ _b7"> </span>8.68<span class="_ _dd"> </span>252,238</div><div class="t m0 x126 h2e yb8b ff19 fs11 fc0 sc0 ls0 ws0">4,096 <span class="_ _db"> </span>0.03<span class="_ _16e"> </span>0.58 <span class="_ _b7"> </span>8.62<span class="_ _2e"> </span>126,1<span class="_ _0"></span>19</div><div class="t m0 x126 h2e yb8c ff19 fs11 fc0 sc0 ls0 ws0">8,192 <span class="_ _db"> </span>0.00<span class="_ _16e"> </span>0.54 <span class="_ _b7"> </span>8.52<span class="_ _90"> </span>63,060</div><div class="t m0 xda h2e yb8d ff19 fs11 fc0 sc0 ls0 ws0">16,384 <span class="_ _db"> </span>0.01<span class="_ _16e"> </span>0.56 <span class="_ _b7"> </span>8.69<span class="_ _90"> </span>31,530</div><div class="t m0 xda h2e yb8e ff19 fs11 fc0 sc0 ls0 ws0">32,768 <span class="_ _db"> </span>0.00<span class="_ _16e"> </span>0.56 <span class="_ _b7"> </span>8.51<span class="_ _90"> </span>15,765</div><div class="t m0 xda h2e yb8f ff19 fs11 fc0 sc0 ls0 ws0">65,536 <span class="_ _db"> </span>0.01<span class="_ _16e"> </span>0.56 <span class="_ _b7"> </span>9.12<span class="_ _77"> </span>7,883</div><div class="t m0 x50 h2e yb90 ff19 fs11 fc0 sc0 ls0 ws0">131,072 <span class="_ _db"> </span>0.00<span class="_ _16e"> </span>0.58 <span class="_ _b7"> </span>9.08<span class="_ _77"> </span>3,942</div><div class="t m0 x50 h2e yb91 ff19 fs11 fc0 sc0 ls0 ws0">262,144 <span class="_ _db"> </span>0.00<span class="_ _16e"> </span>0.60 <span class="_ _b7"> </span>8.70<span class="_ _77"> </span>1,971</div><div class="t m0 x50 h2e yb92 ff19 fs11 fc0 sc0 ls0 ws0">524,288 <span class="_ _db"> </span>0.01<span class="_ _16e"> </span>0.58 <span class="_ _b7"> </span>8.58<span class="_ _173"> </span>986</div><div class="t m0 x1f h2f yb93 ff18 fs12 fc0 sc0 ls0 ws0">Figure 3.6<span class="_ _5a"> </span><span class="ff19 ls3b5">Ti<span class="_ _3"></span><span class="ls0">ming results for r<span class="_ _0"></span>eading with differ<span class="_ _0"></span>ent buffer sizes on Linux</span></span></div><div class="t m0 x3f h50 yb94 ff19 fs29 fc0 sc0 ls0 ws0">The <span class="_ _42"> </span>ﬁle <span class="_ _53"> </span>was <span class="_ _53"> </span>read <span class="_ _42"> </span>using <span class="_ _53"> </span>the <span class="_ _53"> </span>program <span class="_ _42"> </span>shown <span class="_ _53"> </span>in <span class="_ _53"> </span>Figur<span class="ls3b6">e3<span class="_ _c"></span><span class="ls0">.5, <span class="_ _53"> </span>with <span class="_ _42"> </span>standar<span class="ls3b6">do<span class="_ _c"></span><span class="ls0">utput</span></span></span></span></div><div class="t m0 x32 h5c yb95 ff19 fs29 fc0 sc0 lsdf ws0">re<span class="ls0">directed <span class="_ _23"> </span>to<span class="_ _44"> </span><span class="ff1a">/dev/null</span><span class="ls3b7">.T<span class="_ _7"></span><span class="ls0">he <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>system <span class="_ _42"> </span>used <span class="_ _42"> </span>for <span class="_ _23"> </span>this <span class="_ _42"> </span>test <span class="_ _42"> </span>was <span class="_ _23"> </span>the <span class="_ _42"> </span>Linux<span class="_ _44"> </span><span class="ff1a">ext4<span class="_ _35"> </span></span>ﬁle</span></span></span></div><div class="t m0 x32 h50 yb96 ff19 fs29 fc0 sc0 ls0 ws0">system <span class="_ _44"> </span>with <span class="_ _44"> </span>4,096</div><div class="t m0 xe8 h50 yb97 ff19 fs29 fc0 sc0 ls0 ws0">-</div><div class="t m0 xe9 h5c yb96 ff19 fs29 fc0 sc0 ls0 ws0">byte <span class="_ _44"> </span>blocks.<span class="_ _93"> </span>(The<span class="_ _54"> </span><span class="ff1a">st_blksize<span class="_ _65"> </span></span>value, <span class="_ _44"> </span>which <span class="_ _4b"> </span>we <span class="_ _44"> </span>describe <span class="_ _4b"> </span>in</div><div class="t m0 x32 h50 yb98 ff19 fs29 fc0 sc0 ls0 ws0">Section <span class="_ _9"></span>4.12, <span class="_ _9"></span>is <span class="_ _9"></span>4,096.)<span class="_ _5a"> </span>This <span class="_ _9"></span>accounts <span class="_ _23"></span>for <span class="_ _9"></span>the <span class="_ _9"></span>minimum <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>system <span class="_ _9"></span>time <span class="_ _23"></span>occurring <span class="_ _9"></span>at</div><div class="t m0 x32 h5c yb99 ff19 fs29 fc0 sc0 ls0 ws0">the <span class="_ _e"> </span>few <span class="_ _e"> </span>timing <span class="_"> </span>measur<span class="_ _1"></span>ements <span class="_"> </span>starting <span class="_ _53"> </span>around <span class="_ _e"> </span>a<span class="_ _4b"> </span><span class="ff1a">BUFFSIZE<span class="_ _59"> </span></span>of <span class="_ _e"> </span>4,096.<span class="_ _48"> </span>Increasing <span class="_ _e"> </span>the</div><div class="t m0 x32 h50 yb9a ff19 fs29 fc0 sc0 ls0 ws0">buffer size beyond this limit has little positive ef<span class="_ _0"></span>fect.</div><div class="t m0 x3f h50 yb9b ff19 fs29 fc0 sc0 ls0 ws0">Most ﬁle <span class="_ _2"></span>systems <span class="_ _2"></span>support some <span class="_ _2"></span>kind <span class="_ _2"></span>of read-ahead to <span class="_ _2"></span>improve performance.<span class="_ _61"> </span>When</div><div class="t m0 x32 h50 yb9c ff19 fs29 fc0 sc0 ls0 ws0">sequential <span class="_ _3"></span>reads <span class="_ _2"></span>ar<span class="ls3b8">ed<span class="_ _8"></span><span class="ls0">etected, <span class="_ _3"></span>the <span class="_ _3"></span>system <span class="_ _9"></span>tries <span class="_ _3"></span>to <span class="_ _3"></span>read <span class="_ _3"></span>in <span class="_ _3"></span>mor<span class="ls3b8">ed<span class="_ _b"></span><span class="ls0">ata <span class="_ _9"></span>than <span class="_ _3"></span>an <span class="_ _3"></span>application</span></span></span></span></div><div class="t m0 x32 h50 yb9d ff19 fs29 fc0 sc0 lsdf ws0">re<span class="ls0">quests, <span class="_ _2"></span>assuming <span class="_ _2"></span>that the <span class="_ _2"></span>application <span class="_ _2"></span>will <span class="_ _2"></span>read it shortly<span class="_ _6"></span><span class="ls3b9">.T<span class="_ _5b"></span><span class="ls0">he <span class="_ _2"></span>effect of read-ahead can</span></span></span></div><div class="t m0 x32 h50 yb9e ff19 fs29 fc0 sc0 ls0 ws0">be <span class="_ _9"></span>seen <span class="_ _9"></span>in <span class="_ _9"></span>Figur<span class="ls3ba">e3<span class="_ _b"></span><span class="ls0">.6, <span class="_ _3"></span>wher<span class="ls3ba">et<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>elapsed <span class="_ _9"></span>time <span class="_ _9"></span>for <span class="_ _9"></span>buffer <span class="_ _3"></span>sizes <span class="_ _9"></span>as <span class="_ _9"></span>small <span class="_ _9"></span>as <span class="_ _9"></span>32 <span class="_ _9"></span>bytes <span class="_ _9"></span>is <span class="_ _9"></span>as</span></span></span></span></div><div class="t m0 x32 h50 yb9f ff19 fs29 fc0 sc0 ls0 ws0">good as the elapsed time for larger buf<span class="_ _0"></span>fer sizes.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
