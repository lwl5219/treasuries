<div id="pf2b7" class="pf w4 h1f" data-page-no="2b7"><div class="pc pc2b7 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg2b7.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.6<span class="_ _67"> </span>An <span class="_"> </span>Open <span class="_"> </span>Server<span class="_ _6"></span><span class="ls30a">,V<span class="_ _1d"></span><span class="ls0">ersion <span class="_"> </span>2<span class="_ _1b"> </span><span class="ff18">661</span></span></span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>i;</div><div class="t m0 x8a h57 y3810 ff1a fs2d fc0 sc0 ls0 ws0">if (client == NULL)</div><div class="t m0 x9d h57 y31b5 ff1a fs2d fc0 sc0 ls0 ws0">client = malloc(NALLOC * sizeof(Client));</div><div class="t m0 x8a h57 y124b ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 x9d h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">client = realloc(client, (client_size+NALLOC)*sizeof(Client));</div><div class="t m0 x8a h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">if (client == NULL)</div><div class="t m0 x9d h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;can’t alloc for client array&quot;);</div><div class="t m0 x8a h57 y350d ff1a fs2d fc0 sc0 ls0 ws0">/* initialize the new entries */</div><div class="t m0 x8a h57 y31b6 ff1a fs2d fc0 sc0 ls0 ws0">for (i = client_size; i &lt; client_size + NALLOC; i++)</div><div class="t m0 x9d h57 y31b7 ff1a fs2d fc0 sc0 ls0 ws0">client[i].fd = -1;<span class="_ _d9"> </span>/* fd of -1 means entry available */</div><div class="t m0 x8a h57 y3410 ff1a fs2d fc0 sc0 ls0 ws0">client_size += NALLOC;</div><div class="t m0 x32 h57 y3411 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y1314 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h57 y1315 ff1a fs2d fc0 sc0 ls15c ws0">*C<span class="_ _1d"></span><span class="ls0">alled by loop() when connection request from a new client arrives.</span></div><div class="t m0 x140 h57 y351c ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h57 y351d ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y351e ff1a fs2d fc0 sc0 ls0 ws0">client_add(int fd, uid_t uid)</div><div class="t m0 x32 h57 y351f ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y3520 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>i;</div><div class="t m0 x8a h57 y87d ff1a fs2d fc0 sc0 ls0 ws0">if (client == NULL)<span class="_ _8a"> </span>/* first time we’re called */</div><div class="t m0 x9d h57 y87e ff1a fs2d fc0 sc0 ls0 ws0">client_alloc();</div><div class="t m0 x32 h57 y87f ff1a fs2d fc0 sc0 ls0 ws0">again:</div><div class="t m0 x8a h57 y880 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; client_size; i++) {</div><div class="t m0 x9d h57 y4d00 ff1a fs2d fc0 sc0 ls0 ws0">if (client[i].fd == -1) {<span class="_ _68"> </span>/* find an available entry */</div><div class="t m0 x1f h57 y4d01 ff1a fs2d fc0 sc0 ls0 ws0">client[i].fd = fd;</div><div class="t m0 x1f h57 y38c2 ff1a fs2d fc0 sc0 ls0 ws0">client[i].uid = uid;</div><div class="t m0 x1f h57 y38c3 ff1a fs2d fc0 sc0 ls0 ws0">return(i); <span class="_"> </span>/*<span class="_"> </span>return index in client[] array */</div><div class="t m0 x9d h57 y38c4 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y38c5 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y341c ff1a fs2d fc0 sc0 ls0 ws0">/* client array full, time to realloc for more */</div><div class="t m0 x8a h57 y341d ff1a fs2d fc0 sc0 ls0 ws0">client_alloc();</div><div class="t m0 x8a h57 y338a ff1a fs2d fc0 sc0 ls0 ws0">goto again;<span class="_ _8a"> </span>/* and search again (will work this time) */</div><div class="t m0 x32 h57 y338b ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y38c8 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h57 y38c9 ff1a fs2d fc0 sc0 ls15c ws0">*C<span class="_ _1d"></span><span class="ls0">alled by loop() when we’re done with a client.</span></div><div class="t m0 x140 h57 y38ca ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h57 y4ddd ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h57 y4dde ff1a fs2d fc0 sc0 ls0 ws0">client_del(int fd)</div><div class="t m0 x32 h57 y4ddf ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y4de0 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>i;</div><div class="t m0 x8a h57 y1353 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; client_size; i++) {</div><div class="t m0 x9d h57 y4de1 ff1a fs2d fc0 sc0 ls0 ws0">if (client[i].fd == fd) {</div><div class="t m0 x1f h57 y4de2 ff1a fs2d fc0 sc0 ls0 ws0">client[i].fd = -1;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
