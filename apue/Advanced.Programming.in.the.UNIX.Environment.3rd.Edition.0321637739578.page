<div id="pf242" class="pf w4 h1f" data-page-no="242"><div class="pc pc242 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg242.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">544<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">if (childpid == NULL) {<span class="_ _8a"> </span>/* first time through */</div><div class="t m0 x9d h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">/* allocate zeroed out array for child pids */</div><div class="t m0 x9d h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">maxfd = open_max();</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">if ((childpid = calloc(maxfd, sizeof(pid_t))) == NULL)</div><div class="t m0 x1f h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 x8a h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y4208 ff1a fs2d fc0 sc0 ls0 ws0">if (pipe(pfd) &lt; 0)</div><div class="t m0 x9d h57 y13df ff1a fs2d fc0 sc0 ls0 ws0">return(NULL); <span class="_ _d9"> </span>/*<span class="_"> </span>errno set by pipe() */</div><div class="t m0 x8a h57 y13e0 ff1a fs2d fc0 sc0 ls0 ws0">if (pfd[0] &gt;= maxfd || pfd[1] &gt;= maxfd) {</div><div class="t m0 x9d h57 y41e9 ff1a fs2d fc0 sc0 ls0 ws0">close(pfd[0]);</div><div class="t m0 x9d h57 y4209 ff1a fs2d fc0 sc0 ls0 ws0">close(pfd[1]);</div><div class="t m0 x9d h57 y420a ff1a fs2d fc0 sc0 ls0 ws0">errno = EMFILE;</div><div class="t m0 x9d h57 y420b ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 x8a h57 y420c ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y8dd ff1a fs2d fc0 sc0 ls0 ws0">if ((pid = fork()) &lt; 0) {</div><div class="t m0 x9d h57 y8de ff1a fs2d fc0 sc0 ls0 ws0">return(NULL); <span class="_ _d9"> </span>/*<span class="_"> </span>errno set by fork() */</div><div class="t m0 x8a h57 y8df ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pid == 0) {<span class="_ _1ab"> </span>/* child */</span></div><div class="t m0 x9d h57 y1251 ff1a fs2d fc0 sc0 ls0 ws0">if (*type == ’r’) {</div><div class="t m0 x1f h57 y1252 ff1a fs2d fc0 sc0 ls0 ws0">close(pfd[0]);</div><div class="t m0 x1f h57 y1253 ff1a fs2d fc0 sc0 ls0 ws0">if (pfd[1] != STDOUT_FILENO) {</div><div class="t m0 x1ca h57 y3261 ff1a fs2d fc0 sc0 ls0 ws0">dup2(pfd[1], STDOUT_FILENO);</div><div class="t m0 x1ca h57 y3262 ff1a fs2d fc0 sc0 ls0 ws0">close(pfd[1]);</div><div class="t m0 x1f h57 y3263 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y420d ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x1f h57 y420e ff1a fs2d fc0 sc0 ls0 ws0">close(pfd[1]);</div><div class="t m0 x1f h57 y420f ff1a fs2d fc0 sc0 ls0 ws0">if (pfd[0] != STDIN_FILENO) {</div><div class="t m0 x1ca h57 y4210 ff1a fs2d fc0 sc0 ls0 ws0">dup2(pfd[0], STDIN_FILENO);</div><div class="t m0 x1ca h57 y4211 ff1a fs2d fc0 sc0 ls0 ws0">close(pfd[0]);</div><div class="t m0 x1f h57 y4212 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y4213 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y4214 ff1a fs2d fc0 sc0 ls0 ws0">/* close all descriptors in childpid[] */</div><div class="t m0 x9d h57 y4215 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; maxfd; i++)</div><div class="t m0 x1f h57 y4216 ff1a fs2d fc0 sc0 ls0 ws0">if (childpid[i] &gt; 0)</div><div class="t m0 x1ca h57 y4217 ff1a fs2d fc0 sc0 ls0 ws0">close(i);</div><div class="t m0 x9d h57 y4218 ff1a fs2d fc0 sc0 ls0 ws0">execl(&quot;/bin/sh&quot;, &quot;sh&quot;, &quot;-c&quot;, cmdstring, (char *)0);</div><div class="t m0 x9d h57 y4219 ff1a fs2d fc0 sc0 ls0 ws0">_exit(127);</div><div class="t m0 x8a h57 y421a ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y421b ff1a fs2d fc0 sc0 ls0 ws0">/* parent continues... */</div><div class="t m0 x8a h57 y421c ff1a fs2d fc0 sc0 ls0 ws0">if (*type == ’r’) {</div><div class="t m0 x9d h57 y421d ff1a fs2d fc0 sc0 ls0 ws0">close(pfd[1]);</div><div class="t m0 x9d h57 y421e ff1a fs2d fc0 sc0 ls0 ws0">if ((fp = fdopen(pfd[0], type)) == NULL)</div><div class="t m0 x1f h57 y421f ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 x8a h57 y4220 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x9d h57 y4221 ff1a fs2d fc0 sc0 ls0 ws0">close(pfd[0]);</div><div class="t m0 x9d h57 y4222 ff1a fs2d fc0 sc0 ls0 ws0">if ((fp = fdopen(pfd[1], type)) == NULL)</div><div class="t m0 x1f h57 y4223 ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
