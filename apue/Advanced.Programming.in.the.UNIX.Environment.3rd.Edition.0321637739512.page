<div id="pf200" class="pf w4 h1f" data-page-no="200"><div class="pc pc200 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg200.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">478<span class="_ _1b"> </span><span class="ff19">Daemon <span class="_"> </span>Processes <span class="_ _20f"> </span>Chapter<span class="_ _4b"> </span>13</span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y8f6 ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h57 y8f7 ff1a fs2d fc0 sc0 ls0 ws0">sigterm(int signo)</div><div class="t m0 x32 h57 yae9 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 yaea ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_INFO, &quot;got SIGTERM; exiting&quot;);</div><div class="t m0 x8a h57 yaeb ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y16f9 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 yaed ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h57 y340d ff1a fs2d fc0 sc0 ls0 ws0">sighup(int signo)</div><div class="t m0 x32 h57 y340e ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y16fa ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_INFO, &quot;Re-reading configuration file&quot;);</div><div class="t m0 x8a h57 y340f ff1a fs2d fc0 sc0 ls0 ws0">reread();</div><div class="t m0 x32 h57 y3410 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y16fd ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y16fe ff1a fs2d fc0 sc0 ls0 ws0">main(int argc, char *argv[])</div><div class="t m0 x32 h57 y16ff ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y3413 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _227"> </span>*cmd;</div><div class="t m0 x8a h57 y3414 ff1a fs2d fc0 sc0 ls0 ws0">struct sigaction<span class="_ _15"> </span>sa;</div><div class="t m0 x8a h57 y1318 ff1a fs2d fc0 sc0 ls0 ws0">if ((cmd = strrchr(argv[0], ’/’)) == NULL)</div><div class="t m0 x9d h57 y1319 ff1a fs2d fc0 sc0 ls0 ws0">cmd = argv[0];</div><div class="t m0 x8a h57 y131a ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 x9d h57 y131b ff1a fs2d fc0 sc0 ls0 ws0">cmd++;</div><div class="t m0 x8a h57 y1701 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y1702 ff1a fs2d fc0 sc0 ls15c ws0">*B<span class="_ _1d"></span><span class="ls0">ecome a daemon.</span></div><div class="t m0 x214 h57 y1703 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y1704 ff1a fs2d fc0 sc0 ls0 ws0">daemonize(cmd);</div><div class="t m0 x8a h57 y1705 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y1706 ff1a fs2d fc0 sc0 ls15c ws0">*M<span class="_ _1d"></span><span class="ls0">ake sure only one copy of the daemon is running.</span></div><div class="t m0 x214 h57 y1707 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y1708 ff1a fs2d fc0 sc0 ls0 ws0">if (already_running()) {</div><div class="t m0 x9d h57 y1709 ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_ERR, &quot;daemon already running&quot;);</div><div class="t m0 x9d h57 y170a ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y170b ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y3ac9 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y3aca ff1a fs2d fc0 sc0 ls15c ws0">*H<span class="_ _1d"></span><span class="ls0">andle signals of interest.</span></div><div class="t m0 x214 h57 y170c ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y3acb ff1a fs2d fc0 sc0 ls0 ws0">sa.sa_handler = sigterm;</div><div class="t m0 x8a h57 y3ae6 ff1a fs2d fc0 sc0 ls0 ws0">sigemptyset(&amp;sa.sa_mask);</div><div class="t m0 x8a h57 y16f8 ff1a fs2d fc0 sc0 ls0 ws0">sigaddset(&amp;sa.sa_mask, SIGHUP);</div><div class="t m0 x8a h57 y3ae7 ff1a fs2d fc0 sc0 ls0 ws0">sa.sa_flags = 0;</div><div class="t m0 x8a h57 y3ae8 ff1a fs2d fc0 sc0 ls0 ws0">if (sigaction(SIGTERM, &amp;sa, NULL) &lt; 0) {</div><div class="t m0 x9d h57 y3ae9 ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_ERR, &quot;can’t catch SIGTERM: %s&quot;, strerror(errno));</div><div class="t m0 x9d h57 y3aea ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y3aeb ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y3aec ff1a fs2d fc0 sc0 ls0 ws0">sa.sa_handler = sighup;</div><div class="t m0 x8a h57 y3aed ff1a fs2d fc0 sc0 ls0 ws0">sigemptyset(&amp;sa.sa_mask);</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
