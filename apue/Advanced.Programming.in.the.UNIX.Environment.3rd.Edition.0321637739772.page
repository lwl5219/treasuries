<div id="pf304" class="pf w4 h1f" data-page-no="304"><div class="pc pc304 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg304.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">738<span class="_ _1b"> </span><span class="ff19">Pseudo <span class="_"> </span>T<span class="_ _6"></span>erminals <span class="_ _23a"> </span>Chapter<span class="_ _4b"> </span>19</span></div><div class="t m0 x32 h26 y12f ff1a fsf fc0 sc0 ls0 ws0">isatty<span class="_ _4b"> </span><span class="ff19 ls45">re<span class="ls0">turns <span class="_ _e"> </span>false.<span class="_ _48"> </span>This <span class="_ _53"> </span>means <span class="_ _e"> </span>that <span class="_ _e"> </span>the <span class="_ _e"> </span>line <span class="_ _e"> </span>discipline <span class="_ _53"> </span>above <span class="_ _e"> </span>the <span class="_ _e"> </span>actual <span class="_ _e"> </span>terminal</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">mains <span class="_ _2"></span>in <span class="_ _3"></span>canonical <span class="_ _2"></span>mode <span class="_ _2"></span>with <span class="_ _2"></span>echo <span class="_ _3"></span>enabled.<span class="_ _61"> </span>By <span class="_ _2"></span>specifying <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">-e<span class="_ _66"> </span></span>option, <span class="_ _2"></span>we <span class="_ _2"></span>turn <span class="_ _3"></span>off</span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">echo <span class="_ _2"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>line <span class="_ _3"></span>discipline <span class="_ _3"></span>module <span class="_ _3"></span>above <span class="_ _3"></span>the <span class="_ _2"></span>PTY <span class="_ _3"></span>slave.<span class="_ _16"> </span>If <span class="_ _3"></span>we <span class="_ _3"></span>don’t <span class="_ _3"></span>do <span class="_ _2"></span>this, <span class="_ _3"></span>everything</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">we type is echoed twice<span class="_ _9"></span><span class="ls9d">—b<span class="_ _6"></span><span class="ls44">yb<span class="_ _d"></span><span class="ls0">oth line discipline modules.</span></span></span></div><div class="t m0 x3f h26 y133 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _45"> </span>a<span class="_ _9"></span><span class="ls0">lso <span class="_ _42"> </span>have <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">-e<span class="_ _44"> </span></span>option <span class="_ _42"> </span>turn <span class="_ _23"> </span>of<span class="ls15ce">ft<span class="_ _43"></span><span class="ls0">he<span class="_ _35"> </span><span class="ff1a">ONLCR<span class="_ _44"> </span></span>ﬂag <span class="_ _42"> </span>in <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">termios<span class="_ _44"> </span></span>structur<span class="_ _0"></span><span class="ls15ce">et<span class="_ _43"></span><span class="ls0">o</span></span></span></span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">prevent <span class="_ _2"></span>all <span class="_ _3"></span>the <span class="_ _3"></span>output <span class="_ _3"></span>from <span class="_ _3"></span>the <span class="_ _3"></span>coprocess <span class="_ _2"></span>from <span class="_ _3"></span>being <span class="_ _3"></span>terminated <span class="_ _3"></span>with <span class="_ _3"></span>a <span class="_ _3"></span>carriage <span class="_ _3"></span>return</div><div class="t m0 x32 h2a y135 ff19 fsf fc0 sc0 ls0 ws0">and a newline.</div><div class="t m0 x3f h2a y136 ff19 fsf fc0 sc0 ls5f ws0">Te<span class="_ _9"></span><span class="ls0">sting this <span class="_ _2"></span>example on different systems revealed another problem that we alluded</span></div><div class="t m0 x32 h26 y137 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _2"></span>in <span class="_ _2"></span>Section <span class="_ _2"></span>14.7 <span class="_ _2"></span>when <span class="_ _2"></span>we <span class="_ _3"></span>described <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">readn<span class="_ _47"> </span></span>and<span class="_ _66"> </span><span class="ff1a">writen<span class="_ _47"> </span></span>functions. <span class="_ _66"> </span>The<span class="_ _47"> </span>amount <span class="_ _2"></span>of</div><div class="t m0 x32 h26 y138 ff19 fsf fc0 sc0 ls0 ws0">data <span class="_ _47"> </span>returned <span class="_ _66"> </span>by <span class="_ _47"> </span>a<span class="_ _16"> </span><span class="ff1a">read</span><span class="ls15cf">,w<span class="_ _1d"></span><span class="ls0">hen <span class="_ _47"> </span>the <span class="_ _47"> </span>descriptor <span class="_ _47"> </span>refers <span class="_ _47"> </span>to <span class="_ _47"> </span>something <span class="_ _47"> </span>other <span class="_ _47"> </span>than <span class="_ _47"> </span>an</span></span></div><div class="t m0 x32 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">ordinary <span class="_ _9"></span>disk <span class="_ _23"></span>ﬁle, <span class="_ _9"></span>can <span class="_ _23"></span>differ <span class="_ _9"></span>between <span class="_ _23"></span>implementations.<span class="_ _5a"> </span>This <span class="_ _23"></span>coprocess <span class="_ _9"></span>example <span class="_ _23"></span>using</div><div class="t m0 x32 h26 y13a ff1a fsf fc0 sc0 ls0 ws0">pty<span class="_ _47"> </span><span class="ff19">gave <span class="_ _9"></span>unexpected <span class="_ _3"></span>results <span class="_ _3"></span>that <span class="_ _3"></span>wer<span class="lsff8">et<span class="_ _b"></span><span class="ls0">racked <span class="_ _9"></span>down <span class="_ _3"></span>to <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">read<span class="_ _45"> </span></span>function <span class="_ _3"></span>on <span class="_ _3"></span>the <span class="_ _9"></span>pipe</span></span></span></div><div class="t m0 x32 h2a y254 ff19 fsf fc0 sc0 ls0 ws0">in <span class="_ _3"></span>the <span class="_ _3"></span>program <span class="_ _3"></span>from <span class="_ _2"></span>Figur<span class="ls15d0">e1<span class="_ _8"></span><span class="ls0">5.18, <span class="_ _3"></span>which <span class="_ _3"></span>returned <span class="_ _3"></span>less <span class="_ _3"></span>than <span class="_ _3"></span>a <span class="_ _3"></span>line.<span class="_ _16"> </span>The <span class="_ _9"></span>solution <span class="_ _3"></span>was <span class="_ _3"></span>to</span></span></div><div class="t m0 x32 h2a y255 ff19 fsf fc0 sc0 ls0 ws0">not use the program shown in Figur<span class="_ _0"></span><span class="ls15c8">e1<span class="_ _d"></span><span class="ls0">5.18, but rather to use the version <span class="_ _2"></span>of this program</span></span></div><div class="t m0 x32 h2a y13b ff19 fsf fc0 sc0 ls0 ws0">from Exercise <span class="_ _2"></span>15.5 <span class="_ _3"></span>that <span class="_ _2"></span>was <span class="_ _3"></span>modiﬁed <span class="_ _3"></span>to <span class="_ _2"></span>use <span class="_ _3"></span>the <span class="_ _2"></span>standar<span class="ls15d1">dI<span class="_ _8"></span><span class="ls0">/O <span class="_ _3"></span>library<span class="_ _6"></span><span class="ls15d1">,w<span class="_ _8"></span><span class="ls0">ith <span class="_ _3"></span>the <span class="_ _2"></span>standard</span></span></span></span></div><div class="t m0 x32 h26 y13c ff19 fsf fc0 sc0 ls0 ws0">I/O streams for both pipes set to line buffering. <span class="_"> </span>W<span class="_ _1"></span>ith this approach, the<span class="_"> </span><span class="ff1a">fgets<span class="_ _66"> </span></span>function</div><div class="t m0 x32 h26 y256 ff19 fsf fc0 sc0 ls0 ws0">does <span class="_ _45"> </span>as <span class="_ _47"> </span>many<span class="_ _5a"> </span><span class="ff1a">read</span><span class="ls15d2">sa<span class="_ _62"></span><span class="ls7d3">sr<span class="_ _62"></span><span class="ls0">equired <span class="_ _47"> </span>to <span class="_ _45"> </span>obtain <span class="_ _47"> </span>a <span class="_ _45"> </span>complete <span class="_ _45"> </span>line.<span class="_ _5f"> </span>The<span class="_ _5a"> </span><span class="ff1a">while<span class="_"> </span></span>loop <span class="_ _47"> </span>in</span></span></span></div><div class="t m0 x32 h2a y257 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">5.18 assumes that each line sent to the coprocess causes one line to be returned.</span></span></div><div class="t m0 x35 h27 y967 ff16 fsf fc0 sc0 ls0 ws0">Driving Interactive Programs Noninteractivel<span class="_ _0"></span>y</div><div class="t m0 x32 h26 y32c ff19 fsf fc0 sc0 ls0 ws0">Although it’s <span class="_ _2"></span>tempting <span class="_ _2"></span>to think <span class="_ _2"></span>that<span class="_ _66"> </span><span class="ff1a">pty<span class="_ _66"> </span></span>can <span class="_ _2"></span>run any <span class="_ _2"></span>coprocess, even <span class="_ _2"></span>a coprocess that <span class="_ _2"></span>is</div><div class="t m0 x32 h26 y4faf ff19 fsf fc0 sc0 ls0 ws0">interactive, <span class="_"> </span>it <span class="_"> </span>doesn’t <span class="_ _e"> </span>work.<span class="_ _60"> </span>The <span class="_"> </span>problem <span class="_ _e"> </span>is <span class="_"> </span>that<span class="_ _59"> </span><span class="ff1a">pty<span class="_ _46"> </span></span>just <span class="_"> </span>copies <span class="_"> </span>everything <span class="_ _e"> </span>on <span class="_"> </span>its</div><div class="t m0 x32 h2a y4fb0 ff19 fsf fc0 sc0 ls0 ws0">standar<span class="ls15d3">di<span class="_ _43"></span><span class="ls0">nput <span class="_ _23"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>PTY <span class="_ _23"></span>and <span class="_ _23"></span>everything <span class="_ _9"></span>from <span class="_ _9"></span>the <span class="_ _23"> </span>PTY <span class="_ _23"></span>to <span class="_ _9"></span>its <span class="_ _23"> </span>standar<span class="lsaff">do<span class="_ _43"></span><span class="ls0">utput, <span class="_ _23"> </span>never</span></span></span></span></div><div class="t m0 x32 h2a y4fb1 ff19 fsf fc0 sc0 ls0 ws0">looking at what it sends or what it gets back.</div><div class="t m0 x3f h26 yea7 ff19 fsf fc0 sc0 ls0 ws0">As an example, we <span class="_ _2"></span>can run the<span class="_"> </span><span class="ff1a">telnet<span class="_ _66"> </span></span>command under<span class="_ _66"> </span><span class="ff1a">pty</span><span class="ls15d4">,t<span class="_ _d"></span><span class="ls0">alking <span class="_ _2"></span>directly to the</span></span></div><div class="t m0 x32 h2a yea8 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">mote host:</span></div><div class="t m0 x3f h57 y54fa ff1a fs2d fc0 sc0 ls0 ws0">pty telnet 192.168.1.3</div><div class="t m0 x32 h26 y1d6c ff19 fsf fc0 sc0 ls0 ws0">Doing <span class="_ _2"></span>this <span class="_ _3"></span>provides <span class="_ _3"></span>no <span class="_ _3"></span>beneﬁt <span class="_ _3"></span>over <span class="_ _2"></span>just <span class="_ _3"></span>typing<span class="_ _45"> </span><span class="ff1a">telnet <span class="_ _2"></span>192.168.1.3</span><span class="ls15d5">,b<span class="_ _8"></span><span class="ls0">ut <span class="_ _3"></span>we <span class="_ _3"></span>would</span></span></div><div class="t m0 x32 h26 y54fb ff19 fsf fc0 sc0 ls0 ws0">like <span class="_ _3"></span>to <span class="_ _3"></span>run <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">telnet<span class="_ _45"> </span></span>pr<span class="_ _0"></span>ogram <span class="_ _3"></span>from <span class="_ _3"></span>a <span class="_ _3"></span>script, <span class="_ _3"></span>perhaps <span class="_ _3"></span>to <span class="_ _9"></span>check <span class="_ _3"></span>some <span class="_ _3"></span>condition <span class="_ _9"></span>on <span class="_ _3"></span>the</div><div class="t m0 x32 h26 y54fc ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">mote host.<span class="_ _46"> </span>If the ﬁle<span class="_"> </span><span class="ff1a">telnet.cmd<span class="_ _66"> </span></span>contains the four lines</span></div><div class="t m0 x3f h57 y54fd ff1a fs2d fc0 sc0 ls0 ws0">sar</div><div class="t m0 x3f h58 y54fe ff1b fs2d fc0 sc0 ls0 ws0">passwd</div><div class="t m0 x3f h57 y54ff ff1a fs2d fc0 sc0 ls0 ws0">uptime</div><div class="t m0 x3f h57 y5500 ff1a fs2d fc0 sc0 ls0 ws0">exit</div><div class="t m0 x32 h2a y5501 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _3"></span>ﬁrst <span class="_ _3"></span>line <span class="_ _3"></span>is <span class="_ _3"></span>the <span class="_ _3"></span>user <span class="_ _3"></span>name <span class="_ _3"></span>we <span class="_ _9"></span>use <span class="_ _2"></span>to <span class="_ _9"></span>log <span class="_ _3"></span>in <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>remote <span class="_ _2"></span>host, <span class="_ _3"></span>the <span class="_ _9"></span>second <span class="_ _3"></span>line <span class="_ _3"></span>is <span class="_ _3"></span>the</div><div class="t m0 x32 h2a y5502 ff19 fsf fc0 sc0 ls0 ws0">password, <span class="_ _3"></span>the <span class="_ _3"></span>thir<span class="ls15d6">dl<span class="_ _b"></span><span class="ls0">ine <span class="_ _9"></span>is <span class="_ _9"></span>a <span class="_ _3"></span>command <span class="_ _9"></span>we’d <span class="_ _9"></span>like <span class="_ _3"></span>to <span class="_ _9"></span>run, <span class="_ _3"></span>and <span class="_ _9"></span>the <span class="_ _9"></span>fourth <span class="_ _3"></span>line <span class="_ _9"></span>terminates</span></span></div><div class="t m0 x32 h2a y5503 ff19 fsf fc0 sc0 ls0 ws0">the session.<span class="_ _59"> </span>But if we run this script as</div><div class="t m0 x3f h57 y5504 ff1a fs2d fc0 sc0 ls0 ws0">pty -i &lt; telnet.cmd telnet 192.168.1.3</div><div class="t m0 x32 h26 y5505 ff19 fsf fc0 sc0 ls0 ws0">it doesn’t do what we want.<span class="_ _46"> </span>Instead, the contents of the ﬁle<span class="_"> </span><span class="ff1a">telnet.cmd<span class="_ _80"> </span></span>ar<span class="ls15d7">es<span class="_ _d"></span><span class="ls0">ent to the</span></span></div><div class="t m0 x32 h2a y5506 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">mote <span class="_ _42"> </span>host <span class="_ _42"> </span>before<span class="_ _35"> </span>it<span class="_ _35"> </span>has <span class="_ _23"> </span>a <span class="_ _42"> </span>chance <span class="_ _42"> </span>to <span class="_ _23"> </span>prompt <span class="_ _23"> </span>us <span class="_ _42"> </span>for <span class="_ _42"> </span>an <span class="_ _23"> </span>account <span class="_ _42"> </span>name <span class="_ _23"> </span>and <span class="_ _42"> </span>password.</span></div><div class="t m0 x32 h26 y5507 ff19 fsf fc0 sc0 ls0 ws0">When <span class="_ _23"> </span>it <span class="_ _42"> </span>turns <span class="_ _42"> </span>of<span class="ls3cc">fe<span class="_ _c"></span><span class="ls0">choing <span class="_ _42"> </span>to <span class="_ _42"> </span>read <span class="_ _23"></span>the <span class="_ _23"> </span>password,<span class="_ _35"> </span><span class="ff1a">login<span class="_ _44"> </span></span>uses <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">tcsetattr<span class="_ _44"> </span></span>option,</span></span></div><div class="t m0 x32 h2a y5508 ff19 fsf fc0 sc0 ls0 ws0">which discards any data alr<span class="_ _0"></span>eady queued.<span class="_ _59"> </span>Thus, the data we send is thrown away<span class="_ _4"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
