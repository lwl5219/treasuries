<div id="pf35f" class="pf w4 h1f" data-page-no="35f"><div class="pc pc35f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg35f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">829</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">520 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">521 <span class="_ _68"> </span>*<span class="_"> </span>Cancellation routine for the worker thread.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">522 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">523 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: acquires and releases workerlock.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">524 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">525 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">526 <span class="_ _d9"> </span>client_cleanup(void<span class="_"> </span>*arg)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">527 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">528 <span class="_ _15"> </span>struct<span class="_"> </span>worker_thread <span class="_ _68"> </span>*wtp;</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">529 <span class="_ _15"> </span>pthread_t<span class="_ _227"> </span>tid;</div><div class="t m0 x32 h57 y2f24 ff1a fs2d fc0 sc0 ls0 ws0">530 <span class="_ _15"> </span>tid<span class="_"> </span><span class="ls15c">=(<span class="_ _1d"></span><span class="ls0">pthread_t)((long)arg);</span></span></div><div class="t m0 x32 h57 y2f25 ff1a fs2d fc0 sc0 ls0 ws0">531 <span class="_ _15"> </span>pthread_mutex_lock(&amp;workerlock);</div><div class="t m0 x32 h57 y5712 ff1a fs2d fc0 sc0 ls0 ws0">532 <span class="_ _15"> </span>for<span class="_"> </span>(wtp = workers; wtp != NULL; wtp = wtp-&gt;next) {</div><div class="t m0 x32 h57 y5713 ff1a fs2d fc0 sc0 ls0 ws0">533 <span class="_ _186"> </span>if<span class="_"> </span>(wtp-&gt;tid == tid) {</div><div class="t m0 x32 h57 y5714 ff1a fs2d fc0 sc0 ls0 ws0">534 <span class="_ _82"> </span>if<span class="_"> </span>(wtp-&gt;next != NULL)</div><div class="t m0 x32 h57 y5715 ff1a fs2d fc0 sc0 ls0 ws0">535 <span class="_ _1e7"> </span>wtp-&gt;next-&gt;prev<span class="_"> </span><span class="ls15c">=w<span class="_ _1d"></span><span class="ls0">tp-&gt;prev;</span></span></div><div class="t m0 x32 h57 y5716 ff1a fs2d fc0 sc0 ls0 ws0">536 <span class="_ _82"> </span>if<span class="_"> </span>(wtp-&gt;prev != NULL)</div><div class="t m0 x32 h57 y5717 ff1a fs2d fc0 sc0 ls0 ws0">537 <span class="_ _1e7"> </span>wtp-&gt;prev-&gt;next<span class="_"> </span><span class="ls15c">=w<span class="_ _1d"></span><span class="ls0">tp-&gt;next;</span></span></div><div class="t m0 x32 h57 y5844 ff1a fs2d fc0 sc0 ls0 ws0">538 <span class="_ _82"> </span>else</div><div class="t m0 x32 h57 y5845 ff1a fs2d fc0 sc0 ls0 ws0">539 <span class="_ _1e7"> </span>workers<span class="_"> </span><span class="ls15c">=w<span class="_ _1d"></span><span class="ls0">tp-&gt;next;</span></span></div><div class="t m0 x32 h57 y5846 ff1a fs2d fc0 sc0 ls0 ws0">540 <span class="_ _82"> </span>break;</div><div class="t m0 x32 h57 y5847 ff1a fs2d fc0 sc0 ls0 ws0">541 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y5ae2 ff1a fs2d fc0 sc0 ls0 ws0">542 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y5ae3 ff1a fs2d fc0 sc0 ls0 ws0">543 <span class="_ _15"> </span>pthread_mutex_unlock(&amp;workerlock);</div><div class="t m0 x32 h57 y5ae4 ff1a fs2d fc0 sc0 ls0 ws0">544 <span class="_ _15"> </span>if<span class="_"> </span>(wtp != NULL) {</div><div class="t m0 x32 h57 y5ae5 ff1a fs2d fc0 sc0 ls0 ws0">545 <span class="_ _186"> </span>close(wtp-&gt;sockfd);</div><div class="t m0 x32 h57 y5ae6 ff1a fs2d fc0 sc0 ls0 ws0">546 <span class="_ _186"> </span>free(wtp);</div><div class="t m0 x32 h57 y5bcf ff1a fs2d fc0 sc0 ls0 ws0">547 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y5bd0 ff1a fs2d fc0 sc0 ls0 ws0">548 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y5c2b ff19 fs26 fc0 sc0 ls0 ws0">[520 <span class="_ _a"></span>– <span class="_ _a"></span>542]<span class="_ _65"> </span>The<span class="_ _51"> </span><span class="ff1a">client_cleanup<span class="_ _51"> </span></span>function <span class="_ _35"> </span>is <span class="_ _35"> </span>the <span class="_ _35"> </span>thr<span class="_ _0"></span>ead <span class="_ _35"> </span>cleanup <span class="_ _35"> </span>handler <span class="_ _35"> </span>for <span class="_ _35"> </span>the</div><div class="t m0 x11a h49 y5c2c ff19 fs26 fc0 sc0 ls0 ws0">worker <span class="_ _42"> </span>threads <span class="_ _23"> </span>that <span class="_ _42"> </span>communicate <span class="_ _42"> </span>with <span class="_ _42"> </span>client <span class="_ _42"> </span>commands.<span class="_ _54"> </span>This <span class="_ _42"> </span>function <span class="_ _42"> </span>is</div><div class="t m0 x11a h4d y5c2d ff19 fs26 fc0 sc0 ls0 ws0">called when <span class="_ _2"></span>the <span class="_ _2"></span>thread calls<span class="_ _66"> </span><span class="ff1a">pthread_exit</span><span class="ls1680">,c<span class="_ _d"></span><span class="ls0">alls<span class="_ _66"> </span><span class="ff1a">pthread_cleanup_pop</span></span></span></div><div class="t m0 x11a h49 y5c2e ff19 fs26 fc0 sc0 ls0 ws0">with <span class="_ _35"> </span>a <span class="_ _35"> </span>nonzer<span class="_ _0"></span><span class="ls17ad">oa<span class="_ _7"></span><span class="lscc">rg<span class="_ _2"></span><span class="ls0">ument, <span class="_ _35"> </span>or <span class="_ _35"> </span>responds <span class="_ _45"> </span>to <span class="_ _35"> </span>a <span class="_ _35"> </span>cancellation <span class="_ _35"> </span>request. <span class="_ _5a"> </span>The</span></span></span></div><div class="t m0 x11a h49 y5c2f ff19 fs26 fc0 sc0 ls0 ws0">argument is the thr<span class="_ _0"></span>ead ID of the thr<span class="_ _0"></span>ead terminating.</div><div class="t m0 x11a h4d y5c30 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _80"> </span>l<span class="_ _23"></span><span class="ls0">ock <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">workerlock<span class="_ _45"> </span></span>mutex <span class="_ _3"></span>and <span class="_ _9"></span>search <span class="_ _3"></span>the <span class="_ _3"></span>list <span class="_ _9"></span>of <span class="_ _9"></span>worker <span class="_ _3"></span>threads <span class="_ _9"></span>until</span></div><div class="t m0 x11a h49 y5c31 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_"> </span>ﬁnd <span class="_"> </span>a <span class="_"> </span>matching <span class="_"> </span>thr<span class="_ _0"></span>ead <span class="_"> </span>ID.<span class="_ _60"> </span>When <span class="_"> </span>we <span class="_"> </span>ﬁnd <span class="_"> </span>a <span class="_"> </span>match, <span class="_"> </span>we <span class="_"> </span>r<span class="_ _0"></span>emove <span class="_"> </span>the</div><div class="t m0 x11a h49 y5c32 ff19 fs26 fc0 sc0 ls0 ws0">worker thread str<span class="_ _0"></span>uctur<span class="lsd3">ef<span class="_ _4f"></span><span class="lscc">ro<span class="_ _2"></span><span class="lsd3">mt<span class="_ _d"></span><span class="ls0">he list and stop the search.</span></span></span></span></div><div class="t m0 x32 h4d y5c33 ff19 fs26 fc0 sc0 ls0 ws0">[543 <span class="_ _a"></span>– <span class="_ _a"></span>548]<span class="_ _65"> </span><span class="ls164">We <span class="_ _66"> </span>u<span class="_ _9"></span></span>nlock <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">workerlock<span class="_ _45"> </span></span>mutex, <span class="_ _9"></span>close <span class="_ _9"></span>the <span class="_ _9"></span>socket <span class="_ _9"></span>ﬁle <span class="_ _9"></span>descriptor <span class="_ _9"></span>used <span class="_ _9"></span>by</div><div class="t m0 x11a h49 y5c34 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>thread <span class="_ _2"></span>to <span class="_ _2"></span>communicate <span class="_ _2"></span>with <span class="_ _3"></span>the <span class="_ _2"></span>client, <span class="_ _3"></span>and <span class="_ _2"></span>free <span class="_ _2"></span>the <span class="_ _2"></span>memory <span class="_ _3"></span>backing <span class="_ _2"></span>the</div><div class="t m0 x11a h4d y5c35 ff1a fs26 fc0 sc0 ls0 ws0">worker_thread<span class="_ _80"> </span><span class="ff19">structure.</span></div><div class="t m0 x11a h4d y5c36 ff19 fs26 fc0 sc0 ls0 ws0">Since <span class="_ _47"> </span>we <span class="_ _47"> </span>try <span class="_ _45"> </span>to <span class="_ _47"> </span>acquir<span class="ls17ae">et<span class="_ _62"></span><span class="ls0">he<span class="_ _16"> </span><span class="ff1a">workerlock<span class="_"> </span></span>mutex, <span class="_ _66"> </span>if <span class="_ _45"> </span>a <span class="_ _47"> </span>thread <span class="_ _47"> </span>reaches <span class="_ _47"> </span>a</span></span></div><div class="t m0 x11a h4d y5c37 ff19 fs26 fc0 sc0 ls0 ws0">cancellation point <span class="_ _2"></span>while <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">kill_workers<span class="_ _47"> </span></span>function is <span class="_ _2"></span>still walking <span class="_ _2"></span>the <span class="_ _2"></span>list,</div><div class="t m0 x11a h4d y5c38 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _2"></span>will <span class="_ _3"></span>have <span class="_ _2"></span>to <span class="_ _3"></span>wait <span class="_ _2"></span>until<span class="_ _47"> </span><span class="ff1a">kill_workers<span class="_ _47"> </span></span><span class="lscc">re</span>leases <span class="_ _3"></span>the <span class="_ _2"></span>mutex <span class="_ _3"></span>before<span class="_ _66"> </span>we<span class="_ _47"> </span>can</div><div class="t m0 x11a h49 y5c39 ff19 fs26 fc0 sc0 ls0 ws0">proceed.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
