<div id="pf324" class="pf w4 h1f" data-page-no="324"><div class="pc pc324 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg324.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">770<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">441 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">442 <span class="_ _8a"> </span>*<span class="_"> </span>Read the free list pointer.<span class="_ _d9"> </span>Its value becomes the</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">443 <span class="_ _8a"> </span>*<span class="_"> </span>chain ptr field of the deleted index record.<span class="_ _d9"> </span>This means</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">444 <span class="_ _8a"> </span>*<span class="_"> </span>the deleted record becomes the head of the free list.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">445 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">446 <span class="_ _15"> </span>freeptr<span class="_"> </span><span class="ls15c">=_<span class="_ _1d"></span><span class="ls0">db_readptr(db, FREE_OFF);</span></span></div><div class="t m0 x32 h57 y1fb8 ff1a fs2d fc0 sc0 ls0 ws0">447 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y1fb9 ff1a fs2d fc0 sc0 ls0 ws0">448 <span class="_ _8a"> </span>*<span class="_"> </span>Save the contents of index record chain ptr,</div><div class="t m0 x32 h57 y1fba ff1a fs2d fc0 sc0 ls0 ws0">449 <span class="_ _8a"> </span>*<span class="_"> </span>before it’s rewritten by _db_writeidx.</div><div class="t m0 x32 h57 y1fbb ff1a fs2d fc0 sc0 ls0 ws0">450 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y1fbc ff1a fs2d fc0 sc0 ls0 ws0">451 <span class="_ _15"> </span>saveptr<span class="_"> </span><span class="ls15c">=d<span class="_ _1d"></span><span class="ls0">b-&gt;ptrval;</span></span></div><div class="t m0 x32 h57 y331b ff1a fs2d fc0 sc0 ls0 ws0">452 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y520c ff1a fs2d fc0 sc0 ls0 ws0">453 <span class="_ _8a"> </span>*<span class="_"> </span>Rewrite the index record.<span class="_ _d9"> </span>This also rewrites the length</div><div class="t m0 x32 h57 y233c ff1a fs2d fc0 sc0 ls0 ws0">454 <span class="_ _8a"> </span>*<span class="_"> </span>of the index record, the data offset, and the data length,</div><div class="t m0 x32 h57 y2329 ff1a fs2d fc0 sc0 ls0 ws0">455 <span class="_ _8a"> </span>*<span class="_"> </span>none of which has changed, but that’s OK.</div><div class="t m0 x32 h57 y57a3 ff1a fs2d fc0 sc0 ls0 ws0">456 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y1cc9 ff1a fs2d fc0 sc0 ls0 ws0">457 <span class="_ _15"> </span>_db_writeidx(db,<span class="_"> </span>db-&gt;idxbuf, db-&gt;idxoff, SEEK_SET, freeptr);</div><div class="t m0 x32 h57 y852 ff1a fs2d fc0 sc0 ls0 ws0">458 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y853 ff1a fs2d fc0 sc0 ls0 ws0">459 <span class="_ _8a"> </span>*<span class="_"> </span>Write the new free list pointer.</div><div class="t m0 x32 h57 y854 ff1a fs2d fc0 sc0 ls0 ws0">460 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y331c ff1a fs2d fc0 sc0 ls0 ws0">461 <span class="_ _15"> </span>_db_writeptr(db,<span class="_"> </span>FREE_OFF, db-&gt;idxoff);</div><div class="t m0 x32 h57 y1d3f ff1a fs2d fc0 sc0 ls0 ws0">462 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y2aad ff1a fs2d fc0 sc0 ls0 ws0">463 <span class="_ _8a"> </span>*<span class="_"> </span>Rewrite the chain ptr that pointed to this record being</div><div class="t m0 x32 h57 y2aae ff1a fs2d fc0 sc0 ls0 ws0">464 <span class="_ _8a"> </span>*<span class="_"> </span>deleted. <span class="_"> </span>Recall<span class="_"> </span>that _db_find_and_lock sets db-&gt;ptroff to</div><div class="t m0 x32 h57 y2aaf ff1a fs2d fc0 sc0 ls0 ws0">465 <span class="_ _8a"> </span>*<span class="_"> </span>point to this chain ptr.<span class="_ _d9"> </span>We set this chain ptr to the</div><div class="t m0 x32 h57 y2ba7 ff1a fs2d fc0 sc0 ls0 ws0">466 <span class="_ _8a"> </span>*<span class="_"> </span>contents of the deleted record’s chain ptr, saveptr.</div><div class="t m0 x32 h57 y2ba8 ff1a fs2d fc0 sc0 ls0 ws0">467 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2ba9 ff1a fs2d fc0 sc0 ls0 ws0">468 <span class="_ _15"> </span>_db_writeptr(db,<span class="_"> </span>db-&gt;ptroff, saveptr);</div><div class="t m0 x32 h57 y2baa ff1a fs2d fc0 sc0 ls0 ws0">469 <span class="_ _15"> </span>if<span class="_"> </span>(un_lock(db-&gt;idxfd, FREE_OFF, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y331f ff1a fs2d fc0 sc0 ls0 ws0">470 <span class="_ _186"> </span>err_dump(&quot;_db_dodelete:<span class="_"> </span>un_lock error&quot;);</div><div class="t m0 x32 h57 y520d ff1a fs2d fc0 sc0 ls0 ws0">471 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h49 y56e2 ff19 fs26 fc0 sc0 ls0 ws0">[441 <span class="_ _a"></span>– <span class="_ _a"></span>461]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>r<span class="_ _9"></span></span>ead the free-list pointer and then update the index <span class="_ _2"></span>recor<span class="_ _0"></span>d<span class="_"> </span>so<span class="_"> </span>that its next</div><div class="t m0 x11a h49 y56e3 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cor<span class="ls12b0">dp<span class="_ _43"></span><span class="ls0">ointer <span class="_ _23"> </span>is <span class="_ _42"> </span>set <span class="_ _23"></span>to <span class="_ _23"></span>the <span class="_ _23"> </span>ﬁrst <span class="_ _23"> </span>recor<span class="_ _0"></span><span class="ls12b0">do<span class="_ _43"></span><span class="ls16a0">nt<span class="_ _b"></span><span class="ls0">he <span class="_ _23"></span>fr<span class="_ _0"></span>ee <span class="_ _23"></span>list.<span class="_ _51"> </span>(If <span class="_ _23"> </span>the <span class="_ _23"> </span>free <span class="_ _23"></span>list <span class="_ _23"> </span>was</span></span></span></span></span></span></div><div class="t m0 x11a h49 y56e4 ff19 fs26 fc0 sc0 ls0 ws0">empty<span class="_ _4"></span><span class="ls12a9">,t<span class="_ _8"></span><span class="ls0">his <span class="_ _9"></span>new <span class="_ _3"></span>chain <span class="_ _9"></span>pointer <span class="_ _9"></span>is <span class="_ _3"></span>0.)<span class="_ _5a"> </span><span class="ls164">We <span class="_ _80"> </span>h<span class="_ _23"></span></span>ave <span class="_ _3"></span>already <span class="_ _3"></span>cleared <span class="_ _3"></span>the <span class="_ _9"></span>key<span class="_ _4"></span><span class="ls16a1">.T<span class="_ _1d"></span><span class="ls0">hen</span></span></span></span></div><div class="t m0 x11a h49 y56e5 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _42"> </span>update <span class="_ _53"> </span>the <span class="_ _53"> </span>free-list <span class="_ _42"> </span>pointer <span class="_ _53"> </span>with <span class="_ _53"> </span>the <span class="_ _53"> </span>offset <span class="_ _42"> </span>of <span class="_ _53"> </span>the <span class="_ _42"> </span>index <span class="_ _53"> </span>record<span class="_ _44"> </span>we<span class="_ _44"> </span>a<span class="lscc">re</span></div><div class="t m0 x11a h49 y57cc ff19 fs26 fc0 sc0 ls0 ws0">deleting. <span class="_ _47"> </span>This<span class="_ _47"> </span>means <span class="_ _3"></span>that <span class="_ _3"></span>the <span class="_ _9"></span>free <span class="_ _2"></span>list <span class="_ _3"></span>is <span class="_ _3"></span>handled <span class="_ _3"></span>on <span class="_ _9"></span>a <span class="_ _3"></span>last-in, <span class="_ _3"></span>ﬁrst-out <span class="_ _3"></span>basis;</div><div class="t m0 x11a h49 y57cd ff19 fs26 fc0 sc0 ls0 ws0">that <span class="_ _23"> </span>is, <span class="_ _23"> </span>deleted <span class="_ _23"> </span>records <span class="_ _23"></span>ar<span class="_ _0"></span><span class="ls16a2">ea<span class="_ _43"></span><span class="ls0">dded <span class="_ _23"> </span>to <span class="_ _42"> </span>the <span class="_ _23"></span>front <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _23"> </span>free <span class="_ _23"></span>list <span class="_ _23"></span>(although <span class="_ _23"> </span>we</span></span></div><div class="t m0 x11a h49 y57ce ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">move entries from the free list on a ﬁrst-ﬁt basis).</span></div><div class="t m0 x11a h49 y56e9 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _53"> </span>d<span class="_ _9"></span><span class="ls0">on’t <span class="_ _2"></span>have a separate free list for each <span class="_ _2"></span>ﬁle.<span class="_ _46"> </span>When we add <span class="_ _2"></span>a deleted index</span></div><div class="t m0 x11a h49 y56ea ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cord<span class="_ _66"> </span>to<span class="_ _47"> </span>the <span class="_ _2"></span>free <span class="_ _2"></span>list, <span class="_ _2"></span>the <span class="_ _3"></span>index <span class="_ _2"></span>recor<span class="ls16a3">ds<span class="_ _8"></span><span class="ls0">till <span class="_ _2"></span>points <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _2"></span>deleted <span class="_ _3"></span>data <span class="_ _2"></span>recor<span class="_ _0"></span>d.</span></span></span></div><div class="t m0 x11a h49 y57cf ff19 fs26 fc0 sc0 ls0 ws0">Ther<span class="lsd3">ea<span class="_ _4f"></span><span class="lscc">re <span class="_ _3"></span>b<span class="ls0">etter ways to do this, in exchange for added complexity<span class="_ _6"></span>.</span></span></span></div><div class="t m0 x32 h49 y56ec ff19 fs26 fc0 sc0 ls0 ws0">[462 <span class="_ _a"></span>– <span class="_ _a"></span>471]<span class="_ _65"> </span><span class="ls164">We <span class="_ _80"> </span>u<span class="_ _9"></span></span>pdate <span class="_ _3"></span>the <span class="_ _3"></span>previous <span class="_ _3"></span>recor<span class="_ _0"></span>d<span class="_ _47"> </span>in<span class="_ _47"> </span>the <span class="_ _3"></span>hash <span class="_ _3"></span>chain <span class="_ _9"></span>to <span class="_ _3"></span>point <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>recor<span class="ls118d">da<span class="_ _b"></span><span class="ls0">fter</span></span></div><div class="t m0 x11a h49 y56ed ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>one <span class="_ _42"> </span>we <span class="_ _53"> </span>ar<span class="ls16a4">ed<span class="_ _c"></span><span class="ls0">eleting, <span class="_ _53"> </span>thus <span class="_ _53"> </span>removing <span class="_ _42"> </span>the <span class="_ _53"> </span>deleted <span class="_ _53"> </span>recor<span class="ls16a4">df<span class="_ _55"></span><span class="lscc">ro<span class="_ _2"></span><span class="ls16a5">mt<span class="_ _c"></span><span class="ls0">he <span class="_ _53"> </span>hash</span></span></span></span></span></span></div><div class="t m0 x11a h49 y56ee ff19 fs26 fc0 sc0 ls0 ws0">chain. <span class="_"> </span>Finally<span class="_ _4"></span>,<span class="_"> </span>we<span class="_"> </span>unlock the free list.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
