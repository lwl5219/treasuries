<div id="pf54" class="pf w4 h1f" data-page-no="54"><div class="pc pc54 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg54.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">50<span class="_ _1b"> </span><span class="ff19">UNIX <span class="_"> </span>Standardization <span class="_"> </span>and <span class="_"> </span>Implementations<span class="_ _99"> </span>Chapter <span class="_"> </span>2</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">POSIX.1 <span class="_ _9"></span>tries <span class="_ _23"></span>to <span class="_ _9"></span>help <span class="_ _9"></span>with <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">PATH_MAX<span class="_ _45"> </span></span>value, <span class="_ _23"></span>but <span class="_ _9"></span>if <span class="_ _9"></span>this <span class="_ _23"></span>value <span class="_ _9"></span>is <span class="_ _23"></span>indeterminate,</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">we’r<span class="ls2da">es<span class="_ _b"></span><span class="ls0">till <span class="_ _3"></span>out <span class="_ _9"></span>of <span class="_ _9"></span>luck.<span class="_ _16"> </span>Figur<span class="ls2db">e2<span class="_ _b"></span><span class="ls0">.16 <span class="_ _9"></span>shows <span class="_ _3"></span>a <span class="_ _9"></span>function <span class="_ _3"></span>that <span class="_ _9"></span>we’ll <span class="_ _9"></span>use <span class="_ _3"></span>throughout <span class="_ _3"></span>this <span class="_ _9"></span>text</span></span></span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">to allocate storage dynamically for a pathname.</div><div class="t m0 x3f h26 y132 ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _3"></span>the <span class="_ _9"></span>constant<span class="_ _45"> </span><span class="ff1a">PATH_MAX<span class="_ _47"> </span></span>is <span class="_ _9"></span>deﬁned <span class="_ _3"></span>in<span class="_ _45"> </span><span class="ff1a">&lt;limits.h&gt;</span><span class="ls2dc">,t<span class="_ _b"></span><span class="ls0">hen <span class="_ _9"></span>we’r<span class="ls2dc">ea<span class="_ _b"></span><span class="ls0">ll <span class="_ _3"></span>set.<span class="_ _5a"> </span>If <span class="_ _3"></span>it’s <span class="_ _9"></span>not,</span></span></span></span></div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">then we need <span class="_ _2"></span>to call<span class="_"> </span><span class="ff1a">pathconf</span><span class="ls2dd">.T<span class="_ _4a"></span><span class="ls0">he value <span class="_ _2"></span>returned by<span class="_"> </span><span class="ff1a">pathconf<span class="_ _66"> </span></span>is the maximum <span class="_ _2"></span>size</span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">of <span class="_ _3"></span>a <span class="_ _9"></span>relative <span class="_ _3"></span>pathname <span class="_ _9"></span>when <span class="_ _3"></span>the <span class="_ _9"></span>ﬁrst <span class="_ _3"></span>argument <span class="_ _3"></span>is <span class="_ _9"></span>the <span class="_ _9"></span>working <span class="_ _3"></span>directory<span class="_ _4"></span>,<span class="_ _45"> </span>so<span class="_ _47"> </span>we<span class="_ _45"> </span>specify</div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_"> </span>r<span class="_ _1"></span>oot <span class="_"> </span>as <span class="_ _e"> </span>the <span class="_"> </span>ﬁrst <span class="_ _e"> </span>argument <span class="_ _e"> </span>and <span class="_"> </span>add <span class="_ _e"> </span>1 <span class="_"> </span>to <span class="_ _53"> </span>the <span class="_"> </span>result. <span class="_ _4b"> </span>If<span class="_ _59"> </span><span class="ff1a">pathconf<span class="_ _59"> </span></span>indicates <span class="_"> </span>that</div><div class="t m0 x32 h26 y136 ff1a fsf fc0 sc0 ls0 ws0">PATH_MAX<span class="_ _80"> </span><span class="ff19">is indeterminate, we have to punt and just guess a value.</span></div><div class="t m0 x3f h26 y137 ff19 fsf fc0 sc0 lsc1 ws0">Ve<span class="_ _23"></span><span class="ls0">rsions of <span class="_ _3"></span>POSIX.1 <span class="_ _2"></span>prior <span class="_ _2"></span>to <span class="_ _2"></span>2001 <span class="_ _2"></span>wer<span class="ls2de">eu<span class="_ _4f"></span><span class="ls0">nclear <span class="_ _2"></span>as <span class="_ _2"></span>to <span class="_ _2"></span>whether<span class="_ _47"> </span><span class="ff1a">PATH_MAX<span class="_ _66"> </span></span>included <span class="_ _2"></span>a</span></span></span></div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">null byte <span class="_ _2"></span>at <span class="_ _2"></span>the <span class="_ _2"></span>end <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>pathname.<span class="_ _61"> </span>If <span class="_ _2"></span>the <span class="_ _2"></span>operating <span class="_ _2"></span>system <span class="_ _2"></span>implementation <span class="_ _2"></span>conforms</div><div class="t m0 x32 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _9"></span>one <span class="_ _23"> </span>of <span class="_ _23"></span>these <span class="_ _9"></span>prior <span class="_ _23"> </span>versions <span class="_ _23"></span>and <span class="_ _9"></span>doesn’t <span class="_ _23"></span>conform <span class="_ _23"></span>to <span class="_ _9"></span>any <span class="_ _23"></span>version <span class="_ _23"></span>of <span class="_ _9"></span>the <span class="_ _23"></span>Single <span class="_ _9"></span>UNIX</div><div class="t m0 x32 h2b y13a ff19 fsf fc0 sc0 ls0 ws0">Speciﬁcation <span class="_ _9"></span>(which<span class="_ _45"> </span><span class="ff1b">does<span class="_ _45"> </span></span><span class="ls45">re</span>quir<span class="ls2df">et<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>terminating <span class="_ _9"></span>null <span class="_ _9"></span>byte <span class="_ _9"></span>to <span class="_ _9"></span>be <span class="_ _23"></span>included), <span class="_ _9"></span>we <span class="_ _9"></span>need <span class="_ _9"></span>to</span></span></div><div class="t m0 x32 h2a y254 ff19 fsf fc0 sc0 ls0 ws0">add 1 to the amount of memory we allocate for a pathname, just to be on the safe side.</div><div class="t m0 x3f h2a y255 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _3"></span>correct <span class="_ _3"></span>way <span class="_ _9"></span>to <span class="_ _9"></span>handle <span class="_ _3"></span>the <span class="_ _9"></span>case <span class="_ _9"></span>of <span class="_ _3"></span>an <span class="_ _9"></span>indeterminate <span class="_ _9"></span>result <span class="_ _3"></span>depends <span class="_ _3"></span>on <span class="_ _9"></span>how <span class="_ _9"></span>the</div><div class="t m0 x32 h26 y13b ff19 fsf fc0 sc0 ls0 ws0">allocated <span class="_"> </span>space <span class="_"> </span>is <span class="_ _e"> </span>being <span class="_"> </span>used.<span class="_ _60"> </span>If <span class="_"> </span>we <span class="_"> </span>ar<span class="_ _1"></span><span class="ls2e0">ea<span class="_ _55"></span><span class="ls0">llocating <span class="_"> </span>space <span class="_"> </span>for <span class="_ _e"> </span>a <span class="_"> </span>call <span class="_"> </span>to<span class="_ _59"> </span><span class="ff1a">getcwd</span><span class="ls2e0">,f<span class="_ _4a"></span><span class="ls0">or</span></span></span></span></div><div class="t m0 x32 h2a y13c ff19 fsf fc0 sc0 ls0 ws0">example <span class="_ _a"></span>— <span class="_ _a"></span>to<span class="_ _51"> </span><span class="ls45">re</span>turn <span class="_ _45"> </span>the <span class="_ _35"> </span>absolute <span class="_ _45"> </span>pathname <span class="_ _45"> </span>of <span class="_ _45"> </span>the <span class="_ _35"> </span>curr<span class="_ _0"></span>ent <span class="_ _45"> </span>working <span class="_ _45"> </span>directory; <span class="_ _45"> </span>see</div><div class="t m0 x32 h26 y256 ff19 fsf fc0 sc0 ls0 ws0">Section <span class="_ _3"></span>4.23<span class="_ _9"></span><span class="ls9d">—a<span class="_ _6"></span><span class="ls0">nd <span class="_ _9"></span>if <span class="_ _3"></span>the <span class="_ _9"></span>allocated <span class="_ _3"></span>space <span class="_ _3"></span>is <span class="_ _9"></span>too <span class="_ _3"></span>small, <span class="_ _9"></span>an <span class="_ _3"></span>error <span class="_ _3"></span>is <span class="_ _3"></span>returned <span class="_ _3"></span>and<span class="_ _45"> </span><span class="ff1a">errno<span class="_ _47"> </span></span>is</span></span></div><div class="t m0 x32 h26 y257 ff19 fsf fc0 sc0 ls0 ws0">set <span class="_ _42"> </span>to<span class="_ _4b"> </span><span class="ff1a">ERANGE</span><span class="ls2e1">.W<span class="_ _49"></span><span class="ls2e2">ec<span class="_ _c"></span><span class="ls0">ould <span class="_ _53"> </span>then <span class="_ _53"> </span>increase <span class="_ _42"> </span>the <span class="_ _53"> </span>allocated <span class="_ _53"> </span>space <span class="_ _53"> </span>by <span class="_ _53"> </span>calling<span class="_ _44"> </span><span class="ff1a">realloc<span class="_ _4b"> </span></span>(see</span></span></span></div><div class="t m0 x32 h2a y258 ff19 fsf fc0 sc0 ls0 ws0">Section <span class="_ _3"></span>7.8 <span class="_ _9"></span>and <span class="_ _9"></span>Exercise <span class="_ _3"></span>4.16) <span class="_ _9"></span>and <span class="_ _3"></span>try <span class="_ _9"></span>again.<span class="_ _16"> </span><span class="ls5f">We <span class="_ _66"> </span>c<span class="_ _9"></span></span>ould <span class="_ _9"></span>keep <span class="_ _9"></span>doing <span class="_ _3"></span>this <span class="_ _9"></span>until <span class="_ _9"></span>the <span class="_ _3"></span>call <span class="_ _9"></span>to</div><div class="t m0 x32 h26 y161 ff1a fsf fc0 sc0 ls0 ws0">getcwd<span class="_ _80"> </span><span class="ff19">succeeded.</span></div><div class="t m0 x32 h4e y8c2 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y8c3 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h4e y8c4 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;limits.h&gt;</div><div class="t m0 x32 h4e y8c5 ff1a fs28 fc0 sc0 ls0 ws0">#ifdef <span class="_"> </span>PATH_MAX</div><div class="t m0 x32 h4e y8c6 ff1a fs28 fc0 sc0 ls0 ws0">static long pathmax = PATH_MAX;</div><div class="t m0 x32 h4e y8c7 ff1a fs28 fc0 sc0 ls0 ws0">#else</div><div class="t m0 x32 h4e y8c8 ff1a fs28 fc0 sc0 ls0 ws0">static long pathmax = 0;</div><div class="t m0 x32 h4e y8c9 ff1a fs28 fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x32 h4e y8ca ff1a fs28 fc0 sc0 ls0 ws0">static long posix_version = 0;</div><div class="t m0 x32 h4e y8cb ff1a fs28 fc0 sc0 ls0 ws0">static long xsi_version = 0;</div><div class="t m0 x32 h4e y8cc ff1a fs28 fc0 sc0 ls0 ws0">/* If PATH_MAX is indeterminate, no guarantee this is adequate */</div><div class="t m0 x32 h4e y8cd ff1a fs28 fc0 sc0 ls0 ws0">#define PATH_MAX_GUESS<span class="_ _d9"> </span>1024</div><div class="t m0 x32 h4e y8ce ff1a fs28 fc0 sc0 ls0 ws0">char *</div><div class="t m0 x32 h4e y8cf ff1a fs28 fc0 sc0 ls0 ws0">path_alloc(size_t *sizep) /* also return allocated size, if nonnull */</div><div class="t m0 x32 h4e y8d0 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y8d1 ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>*ptr;</div><div class="t m0 x8a h4e y8d2 ff1a fs28 fc0 sc0 ls0 ws0">size_t <span class="_"> </span>size;</div><div class="t m0 x8a h4e y8d3 ff1a fs28 fc0 sc0 ls0 ws0">if (posix_version == 0)</div><div class="t m0 x9d h4e y8d4 ff1a fs28 fc0 sc0 ls0 ws0">posix_version = sysconf(_SC_VERSION);</div><div class="t m0 x8a h4e y8d5 ff1a fs28 fc0 sc0 ls0 ws0">if (xsi_version == 0)</div><div class="t m0 x9d h4e y8d6 ff1a fs28 fc0 sc0 ls0 ws0">xsi_version = sysconf(_SC_XOPEN_VERSION);</div><div class="t m0 x8a h4e y8d7 ff1a fs28 fc0 sc0 ls0 ws0">if (pathmax == 0) {<span class="_ _8a"> </span>/* first time through */</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
