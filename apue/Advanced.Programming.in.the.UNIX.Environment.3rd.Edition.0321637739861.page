<div id="pf35d" class="pf w4 h1f" data-page-no="35d"><div class="pc pc35d w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg35d.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">827</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">449 <span class="_ _15"> </span>nw<span class="_"> </span><span class="ls15c">=w<span class="_ _1d"></span><span class="ls0">rite(fd, &amp;req, sizeof(struct printreq));</span></span></div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">450 <span class="_ _15"> </span>if<span class="_"> </span>(nw != sizeof(struct printreq)) {</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">451 <span class="_ _186"> </span>res.jobid<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">452 <span class="_ _186"> </span>if<span class="_"> </span>(nw &lt; 0)</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">453 <span class="_ _82"> </span>res.retcode<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(errno);</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">454 <span class="_ _186"> </span>else</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">455 <span class="_ _82"> </span>res.retcode<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(EIO);</span></span></div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">456 <span class="_ _186"> </span>log_msg(&quot;client_thread:<span class="_"> </span>can’t write %s: %s&quot;, name,</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">457 <span class="_ _74"> </span>strerror(res.retcode));</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">458 <span class="_ _186"> </span>close(fd);</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">459 <span class="_ _186"> </span>strncpy(res.msg,<span class="_"> </span>strerror(res.retcode), MSGLEN_MAX);</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">460 <span class="_ _186"> </span>writen(sockfd,<span class="_"> </span>&amp;res, sizeof(struct printresp));</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">461 <span class="_ _186"> </span>unlink(name);</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">462 <span class="_ _186"> </span>sprintf(name,<span class="_"> </span>&quot;%s/%s/%d&quot;, SPOOLDIR, DATADIR, jobid);</div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">463 <span class="_ _186"> </span>unlink(name);</div><div class="t m0 x32 h57 y56d0 ff1a fs2d fc0 sc0 ls0 ws0">464 <span class="_ _186"> </span>pthread_exit((void<span class="_"> </span>*)1);</div><div class="t m0 x32 h57 y56d1 ff1a fs2d fc0 sc0 ls0 ws0">465 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y56d2 ff1a fs2d fc0 sc0 ls0 ws0">466 <span class="_ _15"> </span>close(fd);</div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">467 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">468 <span class="_ _8a"> </span>*<span class="_"> </span>Send response to client.</div><div class="t m0 x32 h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">469 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y57b4 ff1a fs2d fc0 sc0 ls0 ws0">470 <span class="_ _15"> </span>res.retcode<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y419b ff1a fs2d fc0 sc0 ls0 ws0">471 <span class="_ _15"> </span>res.jobid<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(jobid);</span></span></div><div class="t m0 x32 h57 y419c ff1a fs2d fc0 sc0 ls0 ws0">472 <span class="_ _15"> </span>sprintf(res.msg,<span class="_"> </span>&quot;request ID %d&quot;, jobid);</div><div class="t m0 x32 h57 y5bef ff1a fs2d fc0 sc0 ls0 ws0">473 <span class="_ _15"> </span>writen(sockfd,<span class="_"> </span>&amp;res, sizeof(struct printresp));</div><div class="t m0 x32 h57 y2ade ff1a fs2d fc0 sc0 ls0 ws0">474 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y2c66 ff1a fs2d fc0 sc0 ls0 ws0">475 <span class="_ _8a"> </span>*<span class="_"> </span>Notify the printer thread, clean up, and exit.</div><div class="t m0 x32 h57 y2c67 ff1a fs2d fc0 sc0 ls0 ws0">476 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y573f ff1a fs2d fc0 sc0 ls0 ws0">477 <span class="_ _15"> </span>log_msg(&quot;adding<span class="_"> </span>job %d to queue&quot;, jobid);</div><div class="t m0 x32 h57 y57b5 ff1a fs2d fc0 sc0 ls0 ws0">478 <span class="_ _15"> </span>add_job(&amp;req,<span class="_"> </span>jobid);</div><div class="t m0 x32 h57 y57b6 ff1a fs2d fc0 sc0 ls0 ws0">479 <span class="_ _15"> </span>pthread_cleanup_pop(1);</div><div class="t m0 x32 h57 y57b7 ff1a fs2d fc0 sc0 ls0 ws0">480 <span class="_ _15"> </span>return((void<span class="_"> </span>*)0);</div><div class="t m0 x32 h57 y57b8 ff1a fs2d fc0 sc0 ls0 ws0">481 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y57f5 ff19 fs26 fc0 sc0 ls0 ws0">[449 <span class="_ _a"></span>– <span class="_ _a"></span>465]<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>w<span class="_ _9"></span></span>rite <span class="_"> </span>the<span class="_ _44"> </span><span class="ff1a">printreq<span class="_ _59"> </span></span>structur<span class="_ _0"></span>e<span class="_ _4b"> </span>to<span class="_ _4b"> </span>the <span class="_"> </span>contr<span class="_ _1"></span>ol <span class="_"> </span>ﬁle.<span class="_ _54"> </span>On <span class="_"> </span>err<span class="_ _0"></span>or<span class="_ _6"></span>,<span class="_ _4b"> </span>we<span class="_ _59"> </span>log <span class="_ _e"> </span>a</div><div class="t m0 x11a h49 y57f6 ff19 fs26 fc0 sc0 ls0 ws0">message, close the descriptor <span class="_ _2"></span>for the control ﬁle, send a <span class="_ _2"></span>failur<span class="ls11ad">er<span class="_ _8"></span><span class="ls0">esponse <span class="_ _2"></span>back</span></span></div><div class="t m0 x11a h49 y57f7 ff19 fs26 fc0 sc0 ls0 ws0">to the client, remove the data and contr<span class="_ _0"></span>ol ﬁles, and terminate the thr<span class="_ _0"></span>ead.</div><div class="t m0 x32 h49 y5c16 ff19 fs26 fc0 sc0 ls0 ws0">[466 <span class="_ _a"></span>– <span class="_ _a"></span>473]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>c<span class="_ _9"></span></span>lose the ﬁle descriptor for the <span class="_ _2"></span>control ﬁle and send a message containing</div><div class="t m0 x11a h4d y5c17 ff19 fs26 fc0 sc0 ls0 ws0">the job ID and a successful status (<span class="ff1a">retcode<span class="_ _80"> </span></span>set to 0) back to the client.</div><div class="t m0 x32 h4d y5c18 ff19 fs26 fc0 sc0 ls0 ws0">[474 <span class="_ _a"></span>– <span class="_ _a"></span>481]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>c<span class="_ _23"></span></span>all<span class="_"> </span><span class="ff1a">add_job<span class="_ _66"> </span></span>to <span class="_ _2"></span>add <span class="_ _2"></span>the received job <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>list of <span class="_ _2"></span>pending <span class="_ _2"></span>print jobs <span class="_ _2"></span>and</div><div class="t m0 x11a h4d y5c19 ff19 fs26 fc0 sc0 ls0 ws0">call<span class="_ _51"> </span><span class="ff1a">pthread_cleanup_pop<span class="_"> </span></span>to <span class="_ _35"> </span>complete <span class="_ _35"> </span>the <span class="_ _35"> </span>cleanup <span class="_ _35"> </span>processing. <span class="_ _5a"> </span>The</div><div class="t m0 x11a h49 y5c1a ff19 fs26 fc0 sc0 ls0 ws0">thread terminates when we r<span class="_ _0"></span>eturn.</div><div class="t m0 x11a h49 y5c1b ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _9"></span>that <span class="_ _23"> </span>befor<span class="ls17ac">et<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>thread <span class="_ _9"></span>exits, <span class="_ _23"></span>we <span class="_ _9"></span>must <span class="_ _23"></span>close <span class="_ _23"></span>any <span class="_ _9"></span>ﬁle <span class="_ _23"></span>descriptors <span class="_ _9"></span>we <span class="_ _23"> </span>no</span></span></div><div class="t m0 x11a h49 y5c1c ff19 fs26 fc0 sc0 ls0 ws0">longer <span class="_ _2"></span>need.<span class="_ _61"> </span>Unlike <span class="_ _2"></span>with <span class="_ _2"></span>process <span class="_ _2"></span>termination, <span class="_ _2"></span>ﬁle <span class="_ _2"></span>descriptors <span class="_ _3"></span>ar<span class="ls609">en<span class="_ _8"></span><span class="ls0">ot <span class="_ _2"></span>closed</span></span></div><div class="t m0 x11a h49 y5c1d ff19 fs26 fc0 sc0 ls0 ws0">automatically <span class="_ _2"></span>when <span class="_ _2"></span>a <span class="_ _2"></span>thread <span class="_ _2"></span>ends <span class="_ _2"></span>if <span class="_ _2"></span>other <span class="_ _2"></span>threads <span class="_ _2"></span>exist <span class="_ _2"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>process. <span class="_"> </span>If<span class="_ _47"> </span>we</div><div class="t m0 x11a h49 y5c1e ff19 fs26 fc0 sc0 ls0 ws0">didn’t <span class="_ _2"></span>close <span class="_ _3"></span>unneeded <span class="_ _2"></span>ﬁle <span class="_ _3"></span>descriptors, <span class="_ _3"></span>we’d <span class="_ _2"></span>eventually <span class="_ _3"></span>run <span class="_ _2"></span>out <span class="_ _3"></span>of <span class="_ _3"></span>resour<span class="_ _1"></span>ces.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
