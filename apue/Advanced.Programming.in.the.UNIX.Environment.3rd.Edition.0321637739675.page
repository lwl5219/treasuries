<div id="pf2a3" class="pf w4 h1f" data-page-no="2a3"><div class="pc pc2a3 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2a3.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.3<span class="_ _282"> </span>Unique <span class="_"> </span>Connections<span class="_ _1b"> </span><span class="ff18">641</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">len = offsetof(struct sockaddr_un, sun_path) + strlen(un.sun_path);</div><div class="t m0 x8a h57 y1334 ff1a fs2d fc0 sc0 ls0 ws0">unlink(un.sun_path); <span class="_ _b7"> </span>/*<span class="_"> </span>in case it already exists */</div><div class="t m0 x8a h57 y1307 ff1a fs2d fc0 sc0 ls0 ws0">if (bind(fd, (struct sockaddr *)&amp;un, len) &lt; 0) {</div><div class="t m0 x9d h57 y1308 ff1a fs2d fc0 sc0 ls0 ws0">rval = -2;</div><div class="t m0 x9d h57 y3508 ff1a fs2d fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h57 y3509 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y350a ff1a fs2d fc0 sc0 ls0 ws0">if (chmod(un.sun_path, CLI_PERM) &lt; 0) {</div><div class="t m0 x9d h57 y350b ff1a fs2d fc0 sc0 ls0 ws0">rval = -3;</div><div class="t m0 x9d h57 y350c ff1a fs2d fc0 sc0 ls0 ws0">do_unlink = 1;</div><div class="t m0 x9d h57 y350d ff1a fs2d fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h57 y31b6 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y1310 ff1a fs2d fc0 sc0 ls0 ws0">/* fill socket address structure with server’s address */</div><div class="t m0 x8a h57 y1311 ff1a fs2d fc0 sc0 ls0 ws0">memset(&amp;sun, 0, sizeof(sun));</div><div class="t m0 x8a h57 y1312 ff1a fs2d fc0 sc0 ls0 ws0">sun.sun_family = AF_UNIX;</div><div class="t m0 x8a h57 y1313 ff1a fs2d fc0 sc0 ls0 ws0">strcpy(sun.sun_path, name);</div><div class="t m0 x8a h57 y1314 ff1a fs2d fc0 sc0 ls0 ws0">len = offsetof(struct sockaddr_un, sun_path) + strlen(name);</div><div class="t m0 x8a h57 y1315 ff1a fs2d fc0 sc0 ls0 ws0">if (connect(fd, (struct sockaddr *)&amp;sun, len) &lt; 0) {</div><div class="t m0 x9d h57 y351c ff1a fs2d fc0 sc0 ls0 ws0">rval = -4;</div><div class="t m0 x9d h57 y351d ff1a fs2d fc0 sc0 ls0 ws0">do_unlink = 1;</div><div class="t m0 x9d h57 y351e ff1a fs2d fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h57 y351f ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y3520 ff1a fs2d fc0 sc0 ls0 ws0">return(fd);</div><div class="t m0 x32 h57 y131b ff1a fs2d fc0 sc0 ls0 ws0">errout:</div><div class="t m0 x8a h57 y131c ff1a fs2d fc0 sc0 ls0 ws0">err = errno;</div><div class="t m0 x8a h57 y131d ff1a fs2d fc0 sc0 ls0 ws0">close(fd);</div><div class="t m0 x8a h57 y131e ff1a fs2d fc0 sc0 ls0 ws0">if (do_unlink)</div><div class="t m0 x9d h57 y131f ff1a fs2d fc0 sc0 ls0 ws0">unlink(un.sun_path);</div><div class="t m0 x8a h57 y1320 ff1a fs2d fc0 sc0 ls0 ws0">errno = err;</div><div class="t m0 x8a h57 y1321 ff1a fs2d fc0 sc0 ls0 ws0">return(rval);</div><div class="t m0 x32 h57 y1322 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x145 h5e y4bf2 ff18 fs10 fc0 sc0 ls0 ws0">Figure 17.10<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">cli_conn<span class="_ _e"> </span></span>function</span></div><div class="t m0 x32 h4d y4bf3 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _47"> </span>c<span class="_ _9"></span><span class="ls0">all<span class="_ _35"> </span><span class="ff1a">socket<span class="_ _45"> </span></span>to <span class="_ _23"> </span>create <span class="_ _23"></span>the <span class="_ _23"></span>client’s <span class="_ _23"></span>end <span class="_ _23"></span>of <span class="_ _23"></span>a <span class="_ _9"></span>UNIX <span class="_ _23"> </span>domain <span class="_ _23"> </span>socket.<span class="_ _51"> </span></span>We <span class="_ _47"> </span>t<span class="_ _9"></span><span class="ls0">hen <span class="_ _23"> </span>ﬁll <span class="_ _23"> </span>in <span class="_ _23"> </span>a</span></div><div class="t m0 x32 h4d y4bf4 ff1a fs26 fc0 sc0 ls0 ws0">sockaddr_un<span class="_ _80"> </span><span class="ff19">structur<span class="lsd3">ew<span class="_ _4f"></span><span class="ls0">ith a client-speciﬁc name.</span></span></span></div><div class="t m0 x3f h49 y4bf5 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _66"> </span>d<span class="_ _9"></span><span class="ls0">on’t <span class="_ _9"></span>let <span class="_ _23"></span>the <span class="_ _9"></span>system <span class="_ _9"></span>choose <span class="_ _9"></span>a <span class="_ _9"></span>default <span class="_ _23"></span>addr<span class="_ _0"></span>ess <span class="_ _9"></span>for <span class="_ _9"></span>us, <span class="_ _9"></span>because <span class="_ _23"></span>the <span class="_ _9"></span>server <span class="_ _9"></span>would</span></div><div class="t m0 x32 h49 y4bf6 ff19 fs26 fc0 sc0 ls0 ws0">be <span class="_ _2"></span>unable <span class="_ _2"></span>to <span class="_ _2"></span>distinguish <span class="_ _2"></span>one <span class="_ _2"></span>client <span class="_ _2"></span>from <span class="_ _2"></span>another <span class="_ _2"></span>(if <span class="_ _2"></span>we <span class="_ _2"></span>don’t <span class="_ _2"></span>explicitly <span class="_ _3"></span>bind <span class="_ _2"></span>a <span class="_ _2"></span>name <span class="_ _2"></span>to <span class="_ _2"></span>a</div><div class="t m0 x32 h49 y4bf7 ff19 fs26 fc0 sc0 ls0 ws0">UNIX <span class="_ _3"></span>domain <span class="_ _9"></span>socket, <span class="_ _9"></span>the <span class="_ _3"></span>kernel <span class="_ _9"></span>implicitly <span class="_ _3"></span>binds <span class="_ _9"></span>an <span class="_ _9"></span>address <span class="_ _2"></span>to <span class="_ _9"></span>it <span class="_ _9"></span>on <span class="_ _3"></span>our <span class="_ _9"></span>behalf <span class="_ _9"></span>and <span class="_ _3"></span>no</div><div class="t m0 x32 h49 y4bf8 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle <span class="_ _53"> </span>is <span class="_ _53"> </span>created <span class="_ _53"> </span>in <span class="_ _53"> </span>the <span class="_ _e"> </span>ﬁle <span class="_ _53"> </span>system <span class="_ _e"> </span>to <span class="_ _53"> </span>represent <span class="_ _42"> </span>the <span class="_ _e"> </span>socket).<span class="_ _65"> </span>Instead, <span class="_ _53"> </span>we <span class="_ _53"> </span>bind <span class="_ _e"> </span>our <span class="_ _53"> </span>own</div><div class="t m0 x32 h49 y4bf9 ff19 fs26 fc0 sc0 ls0 ws0">address <span class="_ _84"></span>— <span class="_ _4"></span>a<span class="_ _44"> </span>step <span class="_ _e"> </span>we <span class="_ _53"> </span>usually <span class="_ _e"> </span>don’t <span class="_ _e"> </span>take <span class="_ _53"> </span>when <span class="_ _e"> </span>developing <span class="_ _e"> </span>a <span class="_ _e"> </span>client <span class="_ _53"> </span>program <span class="_ _53"> </span>that <span class="_ _e"> </span>uses</div><div class="t m0 x32 h49 y4bfa ff19 fs26 fc0 sc0 ls0 ws0">sockets.</div><div class="t m0 x3f h49 y4bfb ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _9"></span>last <span class="_ _9"></span>ﬁve <span class="_ _23"></span>characters <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>pathname <span class="_ _9"></span>we <span class="_ _23"></span>bind <span class="_ _9"></span>ar<span class="ls944">em<span class="_ _b"></span><span class="ls0">ade <span class="_ _9"></span>from <span class="_ _3"></span>the <span class="_ _23"></span>pr<span class="_ _0"></span>ocess <span class="_ _9"></span>ID <span class="_ _9"></span>of</span></span></div><div class="t m0 x32 h4d y4bfc ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>client.<span class="_ _61"> </span><span class="ls164">We <span class="_ _e"> </span>c<span class="_ _23"></span></span>all<span class="_"> </span><span class="ff1a">unlink</span><span class="ls6b0">,j<span class="_ _d"></span><span class="ls0">ust <span class="_ _2"></span>in <span class="_ _2"></span>case <span class="_ _2"></span>the <span class="_ _2"></span>pathname <span class="_ _3"></span>already exists.<span class="_ _61"> </span><span class="ls164">We <span class="_ _80"> </span>t<span class="_ _9"></span></span>hen <span class="_ _2"></span>call<span class="_ _47"> </span><span class="ff1a">bind</span></span></span></div><div class="t m0 x32 h49 y4bfd ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _3"></span>assign <span class="_ _9"></span>a <span class="_ _3"></span>name <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>client’s <span class="_ _3"></span>socket.<span class="_ _5a"> </span>This <span class="_ _3"></span>creates <span class="_ _3"></span>a <span class="_ _3"></span>socket <span class="_ _9"></span>ﬁle <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _3"></span>ﬁle <span class="_ _9"></span>system <span class="_ _3"></span>with</div><div class="t m0 x32 h4d y4bfe ff19 fs26 fc0 sc0 ls0 ws0">the same <span class="_ _2"></span>name <span class="_ _2"></span>as <span class="_ _2"></span>the <span class="_ _2"></span>bound <span class="_ _2"></span>pathname.<span class="_ _46"> </span><span class="ls164">We <span class="_ _e"> </span>c<span class="_ _23"></span></span>all<span class="_"> </span><span class="ff1a">chmod<span class="_ _47"> </span></span>to turn <span class="_ _2"></span>of<span class="lsa1e">fa<span class="_ _4f"></span><span class="ls0">ll <span class="_ _2"></span>permissions <span class="_ _2"></span>other</span></span></div><div class="t m0 x32 h4d y4bff ff19 fs26 fc0 sc0 ls0 ws0">than <span class="_ _2"></span>user-read, <span class="_ _2"></span>user-write, <span class="_ _2"></span>and <span class="_ _2"></span>user-execute. <span class="_ _47"> </span>In<span class="_ _66"> </span><span class="ff1a">serv_accept</span><span class="ls13be">,t<span class="_ _4f"></span><span class="ls0">he <span class="_ _3"></span>server <span class="_ _2"></span>checks <span class="_ _3"></span>these</span></span></div><div class="t m0 x32 h49 y4c00 ff19 fs26 fc0 sc0 ls0 ws0">permissions and the user ID of the socket to verify the client’s identity<span class="_ _4"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
