<div id="pf2bf" class="pf w4 h1f" data-page-no="2bf"><div class="pc pc2bf w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2bf.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.7<span class="_ _221"> </span>Summary<span class="_ _1b"> </span><span class="ff18">669</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">/* parse the arguments, set options */</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">if (buf_args(buf, cli_args) &lt; 0) {</div><div class="t m0 x9d h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">send_err(clifd, -1, errmsg);</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">log_msg(errmsg);</div><div class="t m0 x9d h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">return;</div><div class="t m0 x8a h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">if ((newfd = open(pathname, oflag)) &lt; 0) {</div><div class="t m0 x9d h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">snprintf(errmsg, MAXLINE-1, &quot;can’t open %s: %s\n&quot;,</div><div class="t m0 x76 h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">pathname, strerror(errno));</div><div class="t m0 x9d h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">send_err(clifd, -1, errmsg);</div><div class="t m0 x9d h57 y8d8 ff1a fs2d fc0 sc0 ls0 ws0">log_msg(errmsg);</div><div class="t m0 x9d h57 y8d9 ff1a fs2d fc0 sc0 ls0 ws0">return;</div><div class="t m0 x8a h57 y8da ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y31ba ff1a fs2d fc0 sc0 ls0 ws0">/* send the descriptor */</div><div class="t m0 x8a h57 y31bb ff1a fs2d fc0 sc0 ls0 ws0">if (send_fd(clifd, newfd) &lt; 0)</div><div class="t m0 x9d h57 y2f71 ff1a fs2d fc0 sc0 ls0 ws0">log_sys(&quot;send_fd error&quot;);</div><div class="t m0 x8a h57 y2f72 ff1a fs2d fc0 sc0 ls0 ws0">log_msg(&quot;sent fd %d over fd %d for %s&quot;, newfd, clifd, pathname);</div><div class="t m0 x8a h57 y2f73 ff1a fs2d fc0 sc0 ls0 ws0">close(newfd); <span class="_ _189"> </span>/*<span class="_"> </span>we’re done with descriptor */</div><div class="t m0 x32 h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x2f h5e y3f65 ff18 fs10 fc0 sc0 ls0 ws0">Figure 17.31<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">request<span class="_ _e"> </span></span>function, version 2</span></div><div class="t m0 x32 h49 y3f67 ff19 fs26 fc0 sc0 ls0 ws0">This <span class="_ _23"></span>completes <span class="_ _23"></span>the <span class="_ _23"> </span>second <span class="_ _23"> </span>version <span class="_ _23"> </span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>open <span class="_ _42"> </span>server<span class="_ _6"></span><span class="ls141d">,w<span class="_ _43"></span><span class="ls0">hich <span class="_ _42"> </span>uses <span class="_ _23"></span>a <span class="_ _23"></span>single <span class="_ _23"></span>daemon <span class="_ _23"></span>to</span></span></div><div class="t m0 x32 h49 y3f68 ff19 fs26 fc0 sc0 ls0 ws0">handle all the client requests.</div><div class="t m0 x35 h4b y4e7a ff16 fs27 fc0 sc0 ls0 ws0">17.7 <span class="_ _93"> </span>Summary</div><div class="t m0 x32 h49 y4e7b ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _3"></span>key <span class="_ _9"></span>points <span class="_ _9"></span>in <span class="_ _3"></span>this <span class="_ _9"></span>chapter <span class="_ _9"></span>ar<span class="lsfda">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>ability <span class="_ _9"></span>to <span class="_ _9"></span>pass <span class="_ _3"></span>ﬁle <span class="_ _9"></span>descriptors <span class="_ _9"></span>between <span class="_ _3"></span>processes</span></span></div><div class="t m0 x32 h49 y4e7c ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _e"> </span>the <span class="_"> </span>ability <span class="_ _e"> </span>of <span class="_"> </span>a <span class="_ _53"> </span>server <span class="_"> </span>to <span class="_ _e"> </span>accept <span class="_"> </span>unique <span class="_ _e"> </span>connections <span class="_"> </span>fr<span class="_ _1"></span>om <span class="_"> </span>clients.<span class="_ _48"> </span>Although <span class="_"> </span>all</div><div class="t m0 x32 h49 y4e7d ff19 fs26 fc0 sc0 ls0 ws0">platforms <span class="_ _9"></span>provide <span class="_ _9"></span>support <span class="_ _9"></span>for <span class="_ _9"></span>UNIX <span class="_ _9"></span>domain <span class="_ _9"></span>sockets <span class="_ _23"></span>(r<span class="_ _0"></span>efer <span class="_ _9"></span>back <span class="_ _9"></span>to <span class="_ _9"></span>Figur<span class="lsdf0">e1<span class="_ _b"></span><span class="ls0">5.1), <span class="_ _9"></span>we’ve</span></span></div><div class="t m0 x32 h49 y4e7e ff19 fs26 fc0 sc0 ls0 ws0">seen that <span class="_ _2"></span>ther<span class="ls13a9">ea<span class="_ _4f"></span><span class="lscc">re <span class="_ _3"></span>d<span class="_ _2"></span><span class="ls0">iffer<span class="_ _0"></span>ences in <span class="_ _2"></span>each implementation, <span class="_ _2"></span>which makes <span class="_ _2"></span>it <span class="_ _2"></span>mor<span class="ls141e">ed<span class="_ _4f"></span><span class="ls0">ifﬁcult for</span></span></span></span></span></div><div class="t m0 x32 h49 y4e7f ff19 fs26 fc0 sc0 ls0 ws0">us to develop portable applications.</div><div class="t m0 x3f h49 y4e80 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _66"> </span>u<span class="_ _9"></span><span class="ls0">sed <span class="_ _9"></span>UNIX <span class="_ _9"></span>domain <span class="_ _9"></span>sockets <span class="_ _3"></span>throughout <span class="_ _9"></span>this <span class="_ _9"></span>chapter<span class="_ _6"></span><span class="ls141f">.W<span class="_ _52"></span><span class="ls1420">es<span class="_ _b"></span><span class="ls0">aw <span class="_ _9"></span>how <span class="_ _9"></span>to <span class="_ _9"></span>use <span class="_ _9"></span>them</span></span></span></span></div><div class="t m0 x32 h49 y4e81 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _35"> </span>implement <span class="_ _44"> </span>a <span class="_ _35"> </span>full-duplex <span class="_ _44"> </span>pipe <span class="_ _35"> </span>and <span class="_ _44"> </span>how <span class="_ _35"> </span>they <span class="_ _44"> </span>can <span class="_ _44"> </span>be <span class="_ _35"> </span>used <span class="_ _44"> </span>to <span class="_ _35"> </span>adapt <span class="_ _44"> </span>the <span class="_ _35"> </span>I/O</div><div class="t m0 x32 h49 y4e82 ff19 fs26 fc0 sc0 ls0 ws0">multiplexing functions from Section 14.4 to work indir<span class="_ _0"></span>ectly with XSI message queues.</div><div class="t m0 x3f h49 y4e83 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _e"> </span>p<span class="_ _9"></span><span class="lscc">re<span class="_ _2"></span><span class="ls0">sented <span class="_ _2"></span>two <span class="_ _3"></span>versions <span class="_ _2"></span>of <span class="_ _2"></span>an <span class="_ _3"></span>open <span class="_ _2"></span>server<span class="_ _1"></span><span class="ls1421">.O<span class="_ _1d"></span><span class="ls0">ne <span class="_ _3"></span>version <span class="_ _2"></span>was <span class="_ _2"></span>invoked <span class="_ _3"></span>directly by</span></span></span></span></div><div class="t m0 x32 h4d y4e84 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _42"> </span>client, <span class="_ _42"> </span>using<span class="_ _44"> </span><span class="ff1a">fork<span class="_ _35"> </span></span>and<span class="_ _44"> </span><span class="ff1a">exec</span><span class="ls13ee">.T<span class="_ _52"></span><span class="ls0">he <span class="_ _42"> </span>second <span class="_ _42"> </span>was <span class="_ _42"> </span>a <span class="_ _42"> </span>daemon <span class="_ _53"> </span>server <span class="_ _42"> </span>that <span class="_ _42"> </span>handled <span class="_ _42"> </span>all</span></span></div><div class="t m0 x32 h49 y4e85 ff19 fs26 fc0 sc0 ls0 ws0">client requests. <span class="_"> </span>Both<span class="_"> </span>versions used the ﬁle descriptor passing and r<span class="_ _0"></span>eceiving functions.</div><div class="t m0 x3f h4d y4e86 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _47"> </span>a<span class="_ _9"></span><span class="ls0">lso <span class="_ _23"></span>saw <span class="_ _9"></span>how <span class="_ _23"></span>to <span class="_ _23"></span>use <span class="_ _9"></span>the<span class="_ _35"> </span><span class="ff1a">getopt<span class="_ _45"> </span></span>function <span class="_ _23"></span>to <span class="_ _9"></span>enforce <span class="_ _23"></span>consistent <span class="_ _9"></span>command</span></div><div class="t m0 x17d h49 y4e87 ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x61 h49 y4e86 ff19 fs26 fc0 sc0 ls0 ws0">line</div><div class="t m0 x32 h4d y4e88 ff19 fs26 fc0 sc0 ls0 ws0">processing <span class="_ _42"> </span>for <span class="_ _42"> </span>our <span class="_ _42"> </span>programs. <span class="_ _44"> </span>The<span class="_ _44"> </span>ﬁnal <span class="_ _42"> </span>version <span class="_ _53"> </span>of <span class="_ _42"> </span>the <span class="_ _53"> </span>open <span class="_ _42"> </span>server <span class="_ _53"> </span>used <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">getopt</span></div><div class="t m0 x32 h49 y4e89 ff19 fs26 fc0 sc0 ls0 ws0">function, <span class="_ _2"></span>the <span class="_ _3"></span>client–server <span class="_ _3"></span>connection <span class="_ _3"></span>functions <span class="_ _3"></span>introduced <span class="_ _2"></span>in <span class="_ _3"></span>Section <span class="_ _3"></span>17.3, <span class="_ _3"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>I/O</div><div class="t m0 x32 h49 y4e8a ff19 fs26 fc0 sc0 ls0 ws0">multiplexing functions from Section 14.4.</div><a class="l" href="#pf12" data-dest-detail='[18,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.893467px;bottom:603.724799px;width:90.804299px;height:19.679992px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
