<div id="pf243" class="pf w4 h1f" data-page-no="243"><div class="pc pc243 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg243.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>15.3<span class="_ _2ae"> </span><span class="ff1a">popen<span class="_ _4b"> </span></span>and<span class="_ _4b"> </span><span class="ff1a">pclose<span class="_ _4b"> </span></span>Functions<span class="_ _1b"> </span><span class="ff18">545</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y4224 ff1a fs2d fc0 sc0 ls0 ws0">childpid[fileno(fp)] = pid; /* remember child pid for this fd */</div><div class="t m0 x8a h57 y4225 ff1a fs2d fc0 sc0 ls0 ws0">return(fp);</div><div class="t m0 x32 h57 y4226 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">pclose(FILE *fp)</div><div class="t m0 x32 h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>fd,<span class="_"> </span>stat;</div><div class="t m0 x8a h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">pid_t <span class="_ _d9"> </span>pid;</div><div class="t m0 x8a h57 y16e3 ff1a fs2d fc0 sc0 ls0 ws0">if (childpid == NULL) {</div><div class="t m0 x9d h57 y16e4 ff1a fs2d fc0 sc0 ls0 ws0">errno = EINVAL;</div><div class="t m0 x9d h57 y16e5 ff1a fs2d fc0 sc0 ls0 ws0">return(-1); <span class="_ _15"> </span>/*<span class="_"> </span>popen() has never been called */</div><div class="t m0 x8a h57 y16e6 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y2f71 ff1a fs2d fc0 sc0 ls0 ws0">fd = fileno(fp);</div><div class="t m0 x8a h57 y2f72 ff1a fs2d fc0 sc0 ls0 ws0">if (fd &gt;= maxfd) {</div><div class="t m0 x9d h57 y2f73 ff1a fs2d fc0 sc0 ls0 ws0">errno = EINVAL;</div><div class="t m0 x9d h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">return(-1); <span class="_ _15"> </span>/*<span class="_"> </span>invalid file descriptor */</div><div class="t m0 x8a h57 y8e1 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y2f74 ff1a fs2d fc0 sc0 ls0 ws0">if ((pid = childpid[fd]) == 0) {</div><div class="t m0 x9d h57 y2f75 ff1a fs2d fc0 sc0 ls0 ws0">errno = EINVAL;</div><div class="t m0 x9d h57 y2f76 ff1a fs2d fc0 sc0 ls0 ws0">return(-1); <span class="_ _15"> </span>/*<span class="_"> </span>fp wasn’t opened by popen() */</div><div class="t m0 x8a h57 y2f77 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y4227 ff1a fs2d fc0 sc0 ls0 ws0">childpid[fd] = 0;</div><div class="t m0 x8a h57 y4228 ff1a fs2d fc0 sc0 ls0 ws0">if (fclose(fp) == EOF)</div><div class="t m0 x9d h57 y4229 ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y2f7c ff1a fs2d fc0 sc0 ls0 ws0">while (waitpid(pid, &amp;stat, 0) &lt; 0)</div><div class="t m0 x9d h57 y2f7d ff1a fs2d fc0 sc0 ls0 ws0">if (errno != EINTR)</div><div class="t m0 x1f h57 y2f7e ff1a fs2d fc0 sc0 ls0 ws0">return(-1); /* error other than EINTR from waitpid() */</div><div class="t m0 x8a h57 y422a ff1a fs2d fc0 sc0 ls0 ws0">return(stat); <span class="_ _d9"> </span>/*<span class="_"> </span>return child’s termination status */</div><div class="t m0 x32 h57 y422b ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8b h5e y422c ff18 fs10 fc0 sc0 ls0 ws0">Figure 15.12<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">popen<span class="_ _e"> </span></span>and<span class="_"> </span><span class="ff1a">pclose<span class="_ _e"> </span></span>functions</span></div><div class="t m0 x32 h4d y422d ff19 fs26 fc0 sc0 ls0 ws0">Although <span class="_ _23"> </span>the <span class="_ _42"> </span>cor<span class="ls1186">eo<span class="_ _43"></span><span class="ls0">f<span class="_ _35"> </span><span class="ff1a">popen<span class="_ _35"> </span></span>is <span class="_ _42"> </span>similar <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _23"> </span>code <span class="_ _42"> </span>we’ve <span class="_ _42"> </span>used <span class="_ _23"> </span>earlier <span class="_ _42"> </span>in <span class="_ _42"> </span>this <span class="_ _23"> </span>chapter<span class="_ _1"></span>,</span></span></div><div class="t m0 x32 h4d y422e ff19 fs26 fc0 sc0 ls0 ws0">ther<span class="ls1187">ea<span class="_ _8"></span><span class="lscc">re <span class="_ _9"></span>m<span class="ls0">any <span class="_ _2"></span>details <span class="_ _2"></span>that <span class="_ _2"></span>we <span class="_ _2"></span>need <span class="_ _2"></span>to <span class="_ _2"></span>take <span class="_ _3"></span>car<span class="ls1187">eo<span class="_ _8"></span><span class="ls0">f. <span class="_ _47"> </span>First,<span class="_"> </span>each <span class="_ _3"></span>time<span class="_ _66"> </span><span class="ff1a">popen<span class="_ _47"> </span></span>is called, <span class="_ _2"></span>we</span></span></span></span></span></div><div class="t m0 x32 h49 y422f ff19 fs26 fc0 sc0 ls0 ws0">have to <span class="_ _2"></span>remember the <span class="_ _2"></span>process <span class="_ _2"></span>ID of <span class="_ _2"></span>the <span class="_ _2"></span>child <span class="_ _2"></span>that <span class="_ _2"></span>we <span class="_ _2"></span>create and <span class="_ _2"></span>either <span class="_ _2"></span>its <span class="_ _2"></span>ﬁle descriptor</div><div class="t m0 x32 h4d y4230 ff19 fs26 fc0 sc0 ls0 ws0">or<span class="_ _4b"> </span><span class="ff1a">FILE<span class="_ _4b"> </span></span>pointer<span class="_ _1"></span><span class="lse93">.W<span class="_ _49"></span><span class="ls1188">ec<span class="_ _4a"></span><span class="ls0">hoose <span class="_"> </span>to <span class="_ _53"> </span>save <span class="_ _e"> </span>the <span class="_ _e"> </span>child’s <span class="_ _e"> </span>process <span class="_ _53"> </span>ID <span class="_"> </span>in <span class="_ _53"> </span>the <span class="_ _e"> </span>array<span class="_ _4b"> </span><span class="ff1a">childpid</span>,</span></span></span></div><div class="t m0 x32 h4d y4231 ff19 fs26 fc0 sc0 ls0 ws0">which <span class="_ _2"></span>we <span class="_ _3"></span>index <span class="_ _3"></span>by <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>descriptor<span class="_ _1"></span><span class="ls1189">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _3"></span>way<span class="_ _4"></span><span class="ls118a">,w<span class="_ _4f"></span><span class="ls0">hen<span class="_ _47"> </span><span class="ff1a">pclose<span class="_ _47"> </span></span>is <span class="_ _3"></span>called <span class="_ _3"></span>with <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">FILE</span></span></span></span></span></div><div class="t m0 x32 h4d y4232 ff19 fs26 fc0 sc0 ls0 ws0">pointer <span class="_"> </span>as <span class="_"> </span>its <span class="_"> </span>argument, <span class="_"> </span>we <span class="_"> </span>call <span class="_"> </span>the <span class="_"> </span>standar<span class="ls118b">dI<span class="_ _5b"></span><span class="ls0">/O <span class="_ _66"> </span>function<span class="_ _46"> </span><span class="ff1a">fileno<span class="_ _46"> </span></span>to <span class="_"> </span>get <span class="_"> </span>the <span class="_ _66"> </span>ﬁle</span></span></div><div class="t m0 x32 h4d y4233 ff19 fs26 fc0 sc0 ls0 ws0">descriptor <span class="_"> </span>and <span class="_ _47"> </span>then <span class="_"> </span>have <span class="_ _66"> </span>the <span class="_ _47"> </span>child <span class="_"> </span>process <span class="_"> </span>ID <span class="_ _66"> </span>for <span class="_ _47"> </span>the <span class="_"> </span>call <span class="_ _66"> </span>to<span class="_ _61"> </span><span class="ff1a">waitpid</span><span class="ls118c">.S<span class="_ _49"></span><span class="ls0">ince <span class="_ _66"> </span>it’s</span></span></div><div class="t m0 x32 h4d y4234 ff19 fs26 fc0 sc0 ls0 ws0">possible <span class="_ _3"></span>for <span class="_ _3"></span>a <span class="_ _3"></span>given <span class="_ _3"></span>process <span class="_ _3"></span>to <span class="_ _3"></span>call<span class="_ _47"> </span><span class="ff1a">popen<span class="_ _47"> </span></span>mor<span class="ls118d">et<span class="_ _8"></span><span class="ls0">han <span class="_ _3"></span>once, <span class="_ _3"></span>we <span class="_ _3"></span>dynamically <span class="_ _9"></span>allocate <span class="_ _3"></span>the</span></span></div><div class="t m0 x32 h4d y4235 ff1a fs26 fc0 sc0 ls0 ws0">childpid<span class="_ _44"> </span><span class="ff19">array <span class="_ _42"> </span>(the <span class="_ _42"> </span>ﬁrst <span class="_ _53"> </span>time<span class="_ _44"> </span></span>popen<span class="_ _44"> </span><span class="ff19">is <span class="_ _42"> </span>called), <span class="_ _42"> </span>with <span class="_ _53"> </span>room <span class="_ _42"> </span>for <span class="_ _42"> </span>as <span class="_ _42"> </span>many <span class="_ _53"> </span>children <span class="_ _42"> </span>as</span></div><div class="t m0 x32 h49 y4236 ff19 fs26 fc0 sc0 ls0 ws0">ther<span class="lsd3">ea<span class="_ _4f"></span><span class="lscc">re <span class="_ _3"></span>ﬁ<span class="ls0">le descriptors.</span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
