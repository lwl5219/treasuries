<div id="pf241" class="pf w4 h1f" data-page-no="241"><div class="pc pc241 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg241.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>15.3<span class="_ _2ae"> </span><span class="ff1a">popen<span class="_ _4b"> </span></span>and<span class="_ _4b"> </span><span class="ff1a">pclose<span class="_ _4b"> </span></span>Functions<span class="_ _1b"> </span><span class="ff18">543</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">while (fgets(line, MAXLINE, fpin) != NULL) {</div><div class="t m0 x9d h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">if (fputs(line, fpout) == EOF)</div><div class="t m0 x1f h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fputs error to pipe&quot;);</div><div class="t m0 x8a h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">if (ferror(fpin))</div><div class="t m0 x9d h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fgets error&quot;);</div><div class="t m0 x8a h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">if (pclose(fpout) == -1)</div><div class="t m0 x9d h57 y805 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;pclose error&quot;);</div><div class="t m0 x8a h57 y13e0 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y41e9 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x89 h5e y41ea ff18 fs10 fc0 sc0 ls0 ws0">Figure 15.1<span class="_ _0"></span>1<span class="_ _5a"> </span><span class="ff19">Copy ﬁle to pager program using<span class="_"> </span><span class="ff1a">popen</span></span></div><div class="t m0 x32 h4d y41eb ff19 fs26 fc0 sc0 ls0 ws0">Using<span class="_"> </span><span class="ff1a">popen<span class="_ _80"> </span></span><span class="lscc">re<span class="_ _2"></span></span>duces the amount of code we have to write.</div><div class="t m0 x3f h4d y41ec ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _23"> </span>shell <span class="_ _42"> </span>command<span class="_ _35"> </span><span class="ff1a">${PAGER:-more}<span class="_ _35"> </span></span>says <span class="_ _23"> </span>to <span class="_ _23"> </span>use <span class="_ _42"> </span>the <span class="_ _23"> </span>value <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>shell <span class="_ _42"> </span>variable</div><div class="t m0 x32 h4d y41ed ff1a fs26 fc0 sc0 ls0 ws0">PAGER<span class="_ _80"> </span><span class="ff19">if it is deﬁned and non-null; otherwise, use the string<span class="_"> </span></span>more<span class="ff19">.</span></div><div class="t m0 x35 h54 y41ee ff16 fs2c fc0 sc0 ls0 ws0">Example <span class="_ _84"></span>—<span class="_ _9"></span><span class="ff1f">popen<span class="_ _66"> </span></span>and<span class="_"> </span><span class="ff1f">pclose<span class="_ _47"> </span></span>Functions</div><div class="t m0 x32 h54 y41ef ff19 fs2c fc0 sc0 ls0 ws0">Figur<span class="ls142">e1<span class="_ _4f"></span><span class="ls0">5.12 shows our version of<span class="_"> </span><span class="ff1a">popen<span class="_ _66"> </span></span>and<span class="_"> </span><span class="ff1a">pclose</span>.</span></span></div><div class="t m0 x32 h62 y41f0 ff1a fs30 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h62 y41f1 ff1a fs30 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h62 y41f2 ff1a fs30 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h62 y41f3 ff1a fs30 fc0 sc0 ls0 ws0">#include &lt;sys/wait.h&gt;</div><div class="t m0 x32 h62 y41f4 ff1a fs30 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h62 y41f5 ff1a fs30 fc0 sc0 ls1185 ws0">*P<span class="_ _1d"></span><span class="ls0">ointer to array allocated at run-time.</span></div><div class="t m0 x140 h62 y41f6 ff1a fs30 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h62 y41f7 ff1a fs30 fc0 sc0 ls0 ws0">static pid_t<span class="_ _15"> </span>*childpid = NULL;</div><div class="t m0 x32 h62 y41f8 ff1a fs30 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h62 y41f9 ff1a fs30 fc0 sc0 ls1185 ws0">*F<span class="_ _1d"></span><span class="ls0">rom our open_max(), Figure 2.17.</span></div><div class="t m0 x140 h62 y41fa ff1a fs30 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h62 y41fb ff1a fs30 fc0 sc0 ls0 ws0">static int<span class="_ _189"> </span>maxfd;</div><div class="t m0 x32 h62 y41fc ff1a fs30 fc0 sc0 ls0 ws0">FILE *</div><div class="t m0 x32 h62 y41fd ff1a fs30 fc0 sc0 ls0 ws0">popen(const char *cmdstring, const char *type)</div><div class="t m0 x32 h62 y41fe ff1a fs30 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h62 y41ff ff1a fs30 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>i;</div><div class="t m0 x8a h62 y4200 ff1a fs30 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>pfd[2];</div><div class="t m0 x8a h62 y4201 ff1a fs30 fc0 sc0 ls0 ws0">pid_t <span class="_ _d9"> </span>pid;</div><div class="t m0 x8a h62 y4202 ff1a fs30 fc0 sc0 ls0 ws0">FILE <span class="_ _68"> </span>*fp;</div><div class="t m0 x8a h62 y4203 ff1a fs30 fc0 sc0 ls0 ws0">/* only allow &quot;r&quot; or &quot;w&quot; */</div><div class="t m0 x8a h62 y4204 ff1a fs30 fc0 sc0 ls0 ws0">if ((type[0] != ’r’ &amp;&amp; type[0] != ’w’) || type[1] != 0) {</div><div class="t m0 x9d h62 y4205 ff1a fs30 fc0 sc0 ls0 ws0">errno = EINVAL;</div><div class="t m0 x9d h62 y4206 ff1a fs30 fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 x8a h62 y4207 ff1a fs30 fc0 sc0 ls0 ws0">}</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
