<div id="pf344" class="pf w4 h1f" data-page-no="344"><div class="pc pc344 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg344.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">802<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The next ﬁle we will look at is<span class="_"> </span><span class="ff1a">util.c</span><span class="ls44">,t<span class="_ _d"></span><span class="ls0">he ﬁle containing utility routines.</span></span></div><div class="t m0 x140 h4e y59f9 ff1a fs28 fc0 sc0 ls1651 ws0">1#<span class="_ _244"></span><span class="ls0">include &quot;apue.h&quot;</span></div><div class="t m0 x140 h4e y59fa ff1a fs28 fc0 sc0 ls1651 ws0">2#<span class="_ _244"></span><span class="ls0">include &quot;print.h&quot;</span></div><div class="t m0 x140 h4e y5a8f ff1a fs28 fc0 sc0 ls1651 ws0">3#<span class="_ _244"></span><span class="ls0">include &lt;ctype.h&gt;</span></div><div class="t m0 x140 h4e y5a90 ff1a fs28 fc0 sc0 ls1651 ws0">4#<span class="_ _244"></span><span class="ls0">include &lt;sys/select.h&gt;</span></div><div class="t m0 x140 h4e y5a45 ff1a fs28 fc0 sc0 ls1651 ws0">5#<span class="_ _244"></span><span class="ls0">define MAXCFGLINE 512</span></div><div class="t m0 x140 h4e y5a46 ff1a fs28 fc0 sc0 ls1651 ws0">6#<span class="_ _244"></span><span class="ls0">define MAXKWLEN<span class="_ _68"> </span>16</span></div><div class="t m0 x140 h4e y5a47 ff1a fs28 fc0 sc0 ls1651 ws0">7#<span class="_ _244"></span><span class="ls0">define MAXFMTLEN<span class="_ _d9"> </span>16</span></div><div class="t m0 x140 h4e y5a91 ff1a fs28 fc0 sc0 ls1651 ws0">8/<span class="_ _244"></span><span class="ls0">*</span></div><div class="t m0 x140 h4e y5a92 ff1a fs28 fc0 sc0 lsf75 ws0">9*<span class="_ _244"></span><span class="ls0">Get the address list for the given host and service and</span></div><div class="t m0 x32 h4e y5a4a ff1a fs28 fc0 sc0 ls0 ws0">10 <span class="_ _68"> </span>*<span class="_"> </span>return through ailistpp.<span class="_ _3a"> </span>Returns 0 on success or an error</div><div class="t m0 x32 h4e y5a4b ff1a fs28 fc0 sc0 ls0 ws0">11 <span class="_ _68"> </span>*<span class="_"> </span>code on failure.<span class="_ _3a"> </span>Note that we do not set errno if we</div><div class="t m0 x32 h4e y5a4c ff1a fs28 fc0 sc0 ls0 ws0">12 <span class="_ _68"> </span>*<span class="_"> </span>encounter an error.</div><div class="t m0 x32 h4e y5a4d ff1a fs28 fc0 sc0 ls0 ws0">13 <span class="_ _68"> </span>*</div><div class="t m0 x32 h4e y5a4e ff1a fs28 fc0 sc0 ls0 ws0">14 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h4e y5a93 ff1a fs28 fc0 sc0 ls0 ws0">15 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h4e y5a94 ff1a fs28 fc0 sc0 ls0 ws0">16 <span class="_ _d9"> </span>int</div><div class="t m0 x32 h4e y5a95 ff1a fs28 fc0 sc0 ls0 ws0">17 <span class="_ _d9"> </span>getaddrlist(const<span class="_"> </span>char *host, const char *service,</div><div class="t m0 x32 h4e y5a96 ff1a fs28 fc0 sc0 ls0 ws0">18 <span class="_ _15"> </span>struct<span class="_"> </span>addrinfo **ailistpp)</div><div class="t m0 x32 h4e y5a97 ff1a fs28 fc0 sc0 ls0 ws0">19 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h4e y5a98 ff1a fs28 fc0 sc0 ls0 ws0">20 <span class="_ _8a"> </span>int<span class="_ _166"> </span>err;</div><div class="t m0 x32 h4e y5a99 ff1a fs28 fc0 sc0 ls0 ws0">21 <span class="_ _8a"> </span>struct<span class="_"> </span>addrinfo hint;</div><div class="t m0 x32 h4e y5a9a ff1a fs28 fc0 sc0 ls0 ws0">22 <span class="_ _8a"> </span>hint.ai_flags<span class="_"> </span><span class="ls1b6">=A<span class="_ _1d"></span><span class="ls0">I_CANONNAME;</span></span></div><div class="t m0 x32 h4e y5a9b ff1a fs28 fc0 sc0 ls0 ws0">23 <span class="_ _8a"> </span>hint.ai_family<span class="_"> </span><span class="ls1b6">=A<span class="_ _1d"></span><span class="ls0">F_INET;</span></span></div><div class="t m0 x32 h4e y5a9c ff1a fs28 fc0 sc0 ls0 ws0">24 <span class="_ _8a"> </span>hint.ai_socktype<span class="_"> </span><span class="ls1b6">=S<span class="_ _1d"></span><span class="ls0">OCK_STREAM;</span></span></div><div class="t m0 x32 h4e y5a9d ff1a fs28 fc0 sc0 ls0 ws0">25 <span class="_ _8a"> </span>hint.ai_protocol<span class="_"> </span><span class="ls1b6">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h4e y5a9e ff1a fs28 fc0 sc0 ls0 ws0">26 <span class="_ _8a"> </span>hint.ai_addrlen<span class="_"> </span><span class="ls1b6">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h4e y5a9f ff1a fs28 fc0 sc0 ls0 ws0">27 <span class="_ _8a"> </span>hint.ai_canonname<span class="_"> </span><span class="ls1b6">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h4e y5aa0 ff1a fs28 fc0 sc0 ls0 ws0">28 <span class="_ _8a"> </span>hint.ai_addr<span class="_"> </span><span class="ls1b6">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h4e y5aa1 ff1a fs28 fc0 sc0 ls0 ws0">29 <span class="_ _8a"> </span>hint.ai_next<span class="_"> </span><span class="ls1b6">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h4e y5aa2 ff1a fs28 fc0 sc0 ls0 ws0">30 <span class="_ _8a"> </span>err<span class="_"> </span><span class="ls1b6">=g<span class="_ _1d"></span><span class="ls0">etaddrinfo(host, service, &amp;hint, ailistpp);</span></span></div><div class="t m0 x32 h4e y5aa3 ff1a fs28 fc0 sc0 ls0 ws0">31 <span class="_ _8a"> </span>return(err);</div><div class="t m0 x32 h4e y5aa4 ff1a fs28 fc0 sc0 ls0 ws0">32 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h54 y5aa5 ff19 fs2c fc0 sc0 ls0 ws0">[1 <span class="_ _a"></span>– <span class="_ _a"></span>7]<span class="_ _75"> </span><span class="ls155">We <span class="_ _66"> </span>ﬁ<span class="_ _9"></span></span>rst <span class="_ _9"></span>deﬁne <span class="_ _9"></span>the <span class="_ _9"></span>limits <span class="_ _3"></span>needed <span class="_ _9"></span>by <span class="_ _9"></span>the <span class="_ _9"></span>functions <span class="_ _9"></span>in <span class="_ _3"></span>this <span class="_ _9"></span>ﬁle.<span class="_ _5a"> </span><span class="ff1a">MAXCFGLINE<span class="_ _45"> </span></span>is</div><div class="t m0 x2d h54 y5aa6 ff19 fs2c fc0 sc0 ls0 ws0">the <span class="_ _9"></span>maximum <span class="_ _23"></span>size <span class="_ _9"></span>of <span class="_ _9"></span>a <span class="_ _23"></span>line <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _23"></span>printer <span class="_ _9"></span>conﬁguration <span class="_ _9"></span>ﬁle,<span class="_ _35"> </span><span class="ff1a">MAXKWLEN<span class="_ _45"> </span></span>is <span class="_ _9"></span>the</div><div class="t m0 x2d h54 y5aa7 ff19 fs2c fc0 sc0 ls0 ws0">maximum <span class="_ _23"></span>size <span class="_ _9"></span>of <span class="_ _23"> </span>a <span class="_ _23"> </span>keyword<span class="_ _45"> </span>in<span class="_ _35"> </span>the <span class="_ _23"></span>conﬁguration <span class="_ _9"></span>ﬁle, <span class="_ _23"> </span>and<span class="_ _35"> </span><span class="ff1a">MAXFMTLEN<span class="_ _45"> </span></span>is <span class="_ _23"> </span>the</div><div class="t m0 x2d h54 y5aa8 ff19 fs2c fc0 sc0 ls0 ws0">maximum size of the format string we pass to<span class="_"> </span><span class="ff1a">sscanf</span>.</div><div class="t m0 x32 h54 y5aa9 ff19 fs2c fc0 sc0 ls0 ws0">[8 <span class="_ _a"></span>– <span class="_ _a"></span>32]<span class="_ _288"> </span>The <span class="_ _44"> </span>ﬁrst <span class="_ _44"> </span>function <span class="_ _35"> </span>is<span class="_ _54"> </span><span class="ff1a">getaddrlist</span><span class="ls174b">.I<span class="_ _30f"></span><span class="ls0">t<span class="_ _54"> </span>is<span class="_ _51"> </span>a<span class="_ _54"> </span>wrapper <span class="_ _44"> </span>for<span class="_ _51"> </span><span class="ff1a">getaddrinfo</span></span></span></div><div class="t m0 x2d h54 y5aaa ff19 fs2c fc0 sc0 ls0 ws0">(Section <span class="_ _45"> </span>16.3.3), <span class="_ _35"> </span>since <span class="_ _35"> </span>we <span class="_ _45"> </span>always <span class="_ _35"> </span>call<span class="_ _51"> </span><span class="ff1a">getaddrinfo<span class="_"> </span></span>with <span class="_ _35"> </span>the <span class="_ _45"> </span>same <span class="_ _35"> </span>hint</div><div class="t m0 x2d h55 y5aab ff19 fs2c fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>e. <span class="_ _46"> </span>Note<span class="_ _46"> </span>that <span class="_"> </span>we <span class="_"> </span>do <span class="_ _66"> </span>not <span class="_"> </span>need <span class="_ _66"> </span>mutex <span class="_"> </span>locking <span class="_ _66"> </span>in <span class="_"> </span>this <span class="_ _66"> </span>function.<span class="_ _60"> </span>The</div><div class="t m0 x2d h54 y5aac ff1a fs2c fc0 sc0 ls0 ws0">LOCKING<span class="_ _59"> </span><span class="ff19">comment <span class="_"> </span>at <span class="_"> </span>the <span class="_"> </span>beginning <span class="_"> </span>of <span class="_"> </span>each <span class="_"> </span>function <span class="_"> </span>is <span class="_"> </span>intended <span class="_"> </span>only <span class="_"> </span>for</span></div><div class="t m0 x2d h55 y5aad ff19 fs2c fc0 sc0 ls0 ws0">documenting <span class="_ _42"> </span>multithreaded <span class="_ _42"> </span>locking.<span class="_ _54"> </span>This <span class="_ _42"> </span>comment <span class="_ _42"> </span>lists <span class="_ _42"> </span>the <span class="_ _53"> </span>assumptions, <span class="_ _42"> </span>if</div><div class="t m0 x2d h55 y5aae ff19 fs2c fc0 sc0 ls0 ws0">any<span class="_ _4"></span><span class="ls174c">,t<span class="_ _8"></span><span class="ls0">hat <span class="_ _9"></span>ar<span class="ls174c">em<span class="_ _b"></span><span class="ls0">ade <span class="_ _3"></span>regarding <span class="_ _3"></span>the <span class="_ _3"></span>locking, <span class="_ _9"></span>tells <span class="_ _9"></span>which <span class="_ _3"></span>locks <span class="_ _9"></span>the <span class="_ _9"></span>function <span class="_ _3"></span>might</span></span></span></span></div><div class="t m0 x2d h55 y5aaf ff19 fs2c fc0 sc0 ls0 ws0">acquire<span class="_"> </span>or<span class="_"> </span>r<span class="_ _0"></span>elease, and tells which locks must be held to call the function.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
