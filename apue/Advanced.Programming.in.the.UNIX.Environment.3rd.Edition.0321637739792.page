<div id="pf318" class="pf w4 h1f" data-page-no="318"><div class="pc pc318 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg318.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">758<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x140 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">94 <span class="_ _15"> </span>db-&gt;nhash<span class="_ _68"> </span><span class="ls15c">=N<span class="_ _5b"></span><span class="ls0">HASH_DEF;/* hash table size */</span></span></div><div class="t m0 x140 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">95 <span class="_ _15"> </span>db-&gt;hashoff<span class="_"> </span><span class="ls15c">=H<span class="_ _1d"></span><span class="ls0">ASH_OFF; /* offset in index file of hash table */</span></span></div><div class="t m0 x140 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">96 <span class="_ _15"> </span>strcpy(db-&gt;name,<span class="_"> </span>pathname);</div><div class="t m0 x140 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">97 <span class="_ _15"> </span>strcat(db-&gt;name,<span class="_"> </span>&quot;.idx&quot;);</div><div class="t m0 x140 h57 y2f1f ff1a fs2d fc0 sc0 ls0 ws0">98 <span class="_ _15"> </span>if<span class="_"> </span>(oflag &amp; O_CREAT) {</div><div class="t m0 x140 h57 y2f20 ff1a fs2d fc0 sc0 ls0 ws0">99 <span class="_ _186"> </span>va_list<span class="_"> </span>ap;</div><div class="t m0 x32 h57 y2f21 ff1a fs2d fc0 sc0 ls0 ws0">100 <span class="_ _186"> </span>va_start(ap,<span class="_"> </span>oflag);</div><div class="t m0 x32 h57 y2f22 ff1a fs2d fc0 sc0 ls0 ws0">101 <span class="_ _186"> </span>mode<span class="_"> </span><span class="ls15c">=v<span class="_ _1d"></span><span class="ls0">a_arg(ap, int);</span></span></div><div class="t m0 x32 h57 y2f23 ff1a fs2d fc0 sc0 ls0 ws0">102 <span class="_ _186"> </span>va_end(ap);</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">103 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">104 <span class="_ _176"> </span>*<span class="_"> </span>Open index file and data file.</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">105 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">106 <span class="_ _186"> </span>db-&gt;idxfd<span class="_"> </span><span class="ls15c">=o<span class="_ _1d"></span><span class="ls0">pen(db-&gt;name, oflag, mode);</span></span></div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">107 <span class="_ _186"> </span>strcpy(db-&gt;name<span class="_"> </span><span class="ls15c">+l<span class="_ _1d"></span><span class="ls0">en, &quot;.dat&quot;);</span></span></div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">108 <span class="_ _186"> </span>db-&gt;datfd<span class="_"> </span><span class="ls15c">=o<span class="_ _1d"></span><span class="ls0">pen(db-&gt;name, oflag, mode);</span></span></div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">109 <span class="_ _15"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">110 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">111 <span class="_ _176"> </span>*<span class="_"> </span>Open index file and data file.</div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">112 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">113 <span class="_ _186"> </span>db-&gt;idxfd<span class="_"> </span><span class="ls15c">=o<span class="_ _1d"></span><span class="ls0">pen(db-&gt;name, oflag);</span></span></div><div class="t m0 x32 h57 y2f2f ff1a fs2d fc0 sc0 ls0 ws0">114 <span class="_ _186"> </span>strcpy(db-&gt;name<span class="_"> </span><span class="ls15c">+l<span class="_ _1d"></span><span class="ls0">en, &quot;.dat&quot;);</span></span></div><div class="t m0 x32 h57 y2f30 ff1a fs2d fc0 sc0 ls0 ws0">115 <span class="_ _186"> </span>db-&gt;datfd<span class="_"> </span><span class="ls15c">=o<span class="_ _1d"></span><span class="ls0">pen(db-&gt;name, oflag);</span></span></div><div class="t m0 x32 h57 y56fd ff1a fs2d fc0 sc0 ls0 ws0">116 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y56fe ff1a fs2d fc0 sc0 ls0 ws0">117 <span class="_ _15"> </span>if<span class="_"> </span>(db-&gt;idxfd &lt; 0 || db-&gt;datfd &lt; 0) {</div><div class="t m0 x32 h57 y56ff ff1a fs2d fc0 sc0 ls0 ws0">118 <span class="_ _186"> </span>_db_free(db);</div><div class="t m0 x32 h57 y5700 ff1a fs2d fc0 sc0 ls0 ws0">119 <span class="_ _186"> </span>return(NULL);</div><div class="t m0 x32 h57 y5701 ff1a fs2d fc0 sc0 ls0 ws0">120 <span class="_ _15"> </span>}</div><div class="t m0 x32 h4d y5702 ff19 fs26 fc0 sc0 ls0 ws0">[94 <span class="_ _a"></span>– <span class="_ _a"></span>97]<span class="_ _75"> </span><span class="ls164">We <span class="_ _47"> </span>c<span class="_ _9"></span></span>ontinue <span class="_ _23"> </span>to <span class="_ _23"> </span>initialize <span class="_ _42"> </span>the<span class="_ _45"> </span><span class="ff1a">DB<span class="_ _35"> </span></span>structure. <span class="_ _45"> </span>The<span class="_ _35"> </span>pathname <span class="_ _23"> </span>passed <span class="_ _23"> </span>in <span class="_ _23"> </span>by <span class="_ _23"> </span>the</div><div class="t m0 x11a h49 y5703 ff19 fs26 fc0 sc0 ls0 ws0">caller <span class="_ _42"> </span>speciﬁes <span class="_ _23"> </span>the <span class="_ _42"> </span>preﬁx <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>database <span class="_ _42"> </span>ﬁlenames.<span class="_ _54"> </span><span class="ls164">We <span class="_ _45"> </span>a<span class="_ _3"></span></span>ppend <span class="_ _42"> </span>the <span class="_ _42"> </span>sufﬁx</div><div class="t m0 x11a h4d y5704 ff1a fs26 fc0 sc0 ls0 ws0">.idx<span class="_ _80"> </span><span class="ff19">to create the name for the database index ﬁle.</span></div><div class="t m0 x32 h49 y5705 ff19 fs26 fc0 sc0 ls0 ws0">[98 <span class="_ _a"></span>– <span class="_ _a"></span>108]<span class="_ _288"> </span>If <span class="_ _9"></span>the <span class="_ _3"></span>caller <span class="_ _3"></span>wants <span class="_ _3"></span>to <span class="_ _3"></span>create <span class="_ _2"></span>the <span class="_ _9"></span>database <span class="_ _3"></span>ﬁles, <span class="_ _3"></span>we <span class="_ _3"></span>use <span class="_ _3"></span>the <span class="_ _3"></span>variable <span class="_ _3"></span>argument</div><div class="t m0 x11a h4d y5706 ff19 fs26 fc0 sc0 ls0 ws0">functions <span class="_ _9"></span>from<span class="_ _45"> </span><span class="ff1a">&lt;stdarg.h&gt;<span class="_ _45"> </span></span>to <span class="_ _9"></span>ﬁnd <span class="_ _9"></span>the <span class="_ _23"></span>optional <span class="_ _9"></span>thir<span class="ls636">da<span class="_ _b"></span><span class="lscc">rg<span class="ls0">ument. <span class="_ _45"> </span>Then<span class="_ _45"> </span>we</span></span></span></div><div class="t m0 x11a h4d y5707 ff19 fs26 fc0 sc0 ls0 ws0">use<span class="_ _59"> </span><span class="ff1a">open<span class="_ _59"> </span></span>to <span class="_ _e"> </span>create <span class="_ _e"> </span>and <span class="_"> </span>open <span class="_ _e"> </span>the <span class="_"> </span>index <span class="_ _e"> </span>ﬁle <span class="_"> </span>and <span class="_ _e"> </span>data <span class="_"> </span>ﬁle.<span class="_ _65"> </span>Note <span class="_"> </span>that <span class="_ _e"> </span>the</div><div class="t m0 x11a h49 y5708 ff19 fs26 fc0 sc0 ls0 ws0">ﬁlename <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _3"></span>data <span class="_ _9"></span>ﬁle <span class="_ _3"></span>starts <span class="_ _9"></span>with <span class="_ _3"></span>the <span class="_ _9"></span>same <span class="_ _3"></span>preﬁx <span class="_ _3"></span>as <span class="_ _9"></span>the <span class="_ _3"></span>index <span class="_ _9"></span>ﬁle <span class="_ _3"></span>but <span class="_ _3"></span>has</div><div class="t m0 x11a h4d y5709 ff1a fs26 fc0 sc0 ls0 ws0">.dat<span class="_ _80"> </span><span class="ff19">as a sufﬁx instead.</span></div><div class="t m0 x32 h4d y570a ff19 fs26 fc0 sc0 ls0 ws0">[109 <span class="_ _a"></span>– <span class="_ _a"></span>1<span class="_ _0"></span>16] <span class="_ _4b"> </span>If<span class="_ _35"> </span>the <span class="_ _23"> </span>caller <span class="_ _42"> </span>doesn’t <span class="_ _23"></span>specify <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">O_CREAT<span class="_ _35"> </span></span>ﬂag, <span class="_ _23"> </span>then <span class="_ _23"> </span>we’r<span class="ls1663">eo<span class="_ _43"></span><span class="ls0">pening <span class="_ _23"> </span>existing</span></span></div><div class="t m0 x11a h4d y570b ff19 fs26 fc0 sc0 ls0 ws0">database ﬁles.<span class="_ _59"> </span>In this case, we simply call<span class="_"> </span><span class="ff1a">open<span class="_ _66"> </span></span>with two arguments.</div><div class="t m0 x32 h49 y570c ff19 fs26 fc0 sc0 ls0 ws0">[1<span class="_ _1"></span>17 <span class="_ _a"></span>– <span class="_ _4"></span>120]<span class="_ _65"> </span>If <span class="_ _23"></span>an <span class="_ _9"></span>error <span class="_ _9"></span>occurs <span class="_ _9"></span>while <span class="_ _23"></span>we <span class="_ _9"></span>ar<span class="ls1664">eo<span class="_ _b"></span><span class="ls0">pening <span class="_ _9"></span>or <span class="_ _9"></span>creating <span class="_ _9"></span>either <span class="_ _23"></span>database <span class="_ _9"></span>ﬁle, <span class="_ _23"></span>we</span></span></div><div class="t m0 x11a h4d y570d ff19 fs26 fc0 sc0 ls0 ws0">call<span class="_ _44"> </span><span class="ff1a">_db_free<span class="_ _4b"> </span></span>to <span class="_ _53"> </span>clean <span class="_ _53"> </span>up <span class="_ _e"> </span>the<span class="_ _44"> </span><span class="ff1a">DB<span class="_ _4b"> </span></span>structur<span class="lsea0">ea<span class="_ _55"></span><span class="ls0">nd <span class="_ _53"> </span>then <span class="_ _53"> </span>return<span class="_ _44"> </span><span class="ff1a">NULL<span class="_ _4b"> </span></span>to <span class="_ _53"> </span>the</span></span></div><div class="t m0 x11a h4d y570e ff19 fs26 fc0 sc0 ls0 ws0">caller<span class="_ _6"></span><span class="ls1665">.I<span class="_ _7"></span><span class="ls1666">fo<span class="_ _43"></span><span class="ls0">ne<span class="_ _35"> </span><span class="ff1a">open<span class="_ _44"> </span></span>succeeded <span class="_ _42"> </span>and <span class="_ _42"> </span>one <span class="_ _42"> </span>failed,<span class="_ _35"> </span><span class="ff1a">_db_free<span class="_ _44"> </span></span>will <span class="_ _42"> </span>take <span class="_ _42"> </span>car<span class="ls1667">eo<span class="_ _c"></span><span class="ls0">f</span></span></span></span></span></div><div class="t m0 x11a h49 y570f ff19 fs26 fc0 sc0 ls0 ws0">closing the open ﬁle descriptor<span class="_ _6"></span>,<span class="_"> </span>as<span class="_"> </span>we<span class="_"> </span>shall see shortly<span class="_ _6"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
