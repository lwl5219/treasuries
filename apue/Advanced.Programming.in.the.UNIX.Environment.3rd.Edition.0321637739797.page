<div id="pf31d" class="pf w4 h1f" data-page-no="31d"><div class="pc pc31d w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg31d.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">763</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">230 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">231 <span class="_ _68"> </span>*<span class="_"> </span>Find the specified record.<span class="_ _3a"> </span>Called by db_delete, db_fetch,</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">232 <span class="_ _68"> </span>*<span class="_"> </span>and db_store.<span class="_ _3a"> </span>Returns with the hash chain locked.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">233 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">234 <span class="_ _d9"> </span>static<span class="_"> </span>int</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">235 <span class="_ _d9"> </span>_db_find_and_lock(DB<span class="_"> </span>*db, const char *key, int writelock)</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">236 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">237 <span class="_ _15"> </span>off_t<span class="_ _68"> </span>offset, nextoffset;</div><div class="t m0 x32 h57 y1cc3 ff1a fs2d fc0 sc0 ls0 ws0">238 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y1cc4 ff1a fs2d fc0 sc0 ls0 ws0">239 <span class="_ _8a"> </span>*<span class="_"> </span>Calculate the hash value for this key, then calculate the</div><div class="t m0 x32 h57 y1cc5 ff1a fs2d fc0 sc0 ls0 ws0">240 <span class="_ _8a"> </span>*<span class="_"> </span>byte offset of corresponding chain ptr in hash table.</div><div class="t m0 x32 h57 y2016 ff1a fs2d fc0 sc0 ls0 ws0">241 <span class="_ _8a"> </span>*<span class="_"> </span>This is where our search starts.<span class="_ _d9"> </span>First we calculate the</div><div class="t m0 x32 h57 y2017 ff1a fs2d fc0 sc0 ls0 ws0">242 <span class="_ _8a"> </span>*<span class="_"> </span>offset in the hash table for this key.</div><div class="t m0 x32 h57 y2018 ff1a fs2d fc0 sc0 ls0 ws0">243 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2ad4 ff1a fs2d fc0 sc0 ls0 ws0">244 <span class="_ _15"> </span>db-&gt;chainoff<span class="_"> </span><span class="ls15c">=(<span class="_ _1d"></span><span class="ls0">_db_hash(db, key) * PTR_SZ) + db-&gt;hashoff;</span></span></div><div class="t m0 x32 h57 y2ad5 ff1a fs2d fc0 sc0 ls0 ws0">245 <span class="_ _15"> </span>db-&gt;ptroff<span class="_"> </span><span class="ls15c">=d<span class="_ _1d"></span><span class="ls0">b-&gt;chainoff;</span></span></div><div class="t m0 x32 h57 y3ce ff1a fs2d fc0 sc0 ls0 ws0">246 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3cf ff1a fs2d fc0 sc0 ls0 ws0">247 <span class="_ _8a"> </span>*<span class="_"> </span>We lock the hash chain here.<span class="_ _d9"> </span>The caller must unlock it</div><div class="t m0 x32 h57 y3d0 ff1a fs2d fc0 sc0 ls0 ws0">248 <span class="_ _8a"> </span>*<span class="_"> </span>when done.<span class="_ _d9"> </span>Note we lock and unlock only the first byte.</div><div class="t m0 x32 h57 y3d1 ff1a fs2d fc0 sc0 ls0 ws0">249 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y1cca ff1a fs2d fc0 sc0 ls0 ws0">250 <span class="_ _15"> </span>if<span class="_"> </span>(writelock) {</div><div class="t m0 x32 h57 y1ccb ff1a fs2d fc0 sc0 ls0 ws0">251 <span class="_ _186"> </span>if<span class="_"> </span>(writew_lock(db-&gt;idxfd, db-&gt;chainoff, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y2315 ff1a fs2d fc0 sc0 ls0 ws0">252 <span class="_ _82"> </span>err_dump(&quot;_db_find_and_lock:<span class="_"> </span>writew_lock error&quot;);</div><div class="t m0 x32 h57 y2316 ff1a fs2d fc0 sc0 ls0 ws0">253 <span class="_ _15"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y458d ff1a fs2d fc0 sc0 ls0 ws0">254 <span class="_ _186"> </span>if<span class="_"> </span>(readw_lock(db-&gt;idxfd, db-&gt;chainoff, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y2023 ff1a fs2d fc0 sc0 ls0 ws0">255 <span class="_ _82"> </span>err_dump(&quot;_db_find_and_lock:<span class="_"> </span>readw_lock error&quot;);</div><div class="t m0 x32 h57 y2024 ff1a fs2d fc0 sc0 ls0 ws0">256 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y5765 ff1a fs2d fc0 sc0 ls0 ws0">257 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y5766 ff1a fs2d fc0 sc0 ls0 ws0">258 <span class="_ _8a"> </span>*<span class="_"> </span>Get the offset in the index file of first record</div><div class="t m0 x32 h57 y5767 ff1a fs2d fc0 sc0 ls0 ws0">259 <span class="_ _8a"> </span>*<span class="_"> </span>on the hash chain (can be 0).</div><div class="t m0 x32 h57 y5768 ff1a fs2d fc0 sc0 ls0 ws0">260 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y5769 ff1a fs2d fc0 sc0 ls0 ws0">261 <span class="_ _15"> </span>offset<span class="_"> </span><span class="ls15c">=_<span class="_ _1d"></span><span class="ls0">db_readptr(db, db-&gt;ptroff);</span></span></div><div class="t m0 x32 h4d y576a ff19 fs26 fc0 sc0 ls0 ws0">[230 <span class="_ _a"></span>– <span class="_ _a"></span>237]<span class="_ _65"> </span>The<span class="_ _47"> </span><span class="ff1a">_db_find_and_lock<span class="_ _45"> </span></span>function <span class="_ _3"></span>is <span class="_ _3"></span>used <span class="_ _9"></span>internally <span class="_ _3"></span>by <span class="_ _3"></span>the <span class="_ _9"></span>library <span class="_ _3"></span>to <span class="_ _9"></span>ﬁnd</div><div class="t m0 x11a h4d y576b ff19 fs26 fc0 sc0 lsa58 ws0">ar<span class="_ _8"></span><span class="ls0">ecor<span class="lsa58">dg<span class="_ _8"></span><span class="ls0">iven <span class="_ _2"></span>its <span class="_ _3"></span>key<span class="_ _6"></span><span class="ls1402">.W<span class="_ _7"></span><span class="ls141a">es<span class="_ _8"></span><span class="ls0">et <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">writelock<span class="_ _47"> </span></span>parameter <span class="_ _2"></span>to <span class="_ _2"></span>a <span class="_ _3"></span>nonzer<span class="ls141a">ov<span class="_ _8"></span><span class="ls0">alue</span></span></span></span></span></span></span></span></div><div class="t m0 x11a h49 y576c ff19 fs26 fc0 sc0 ls0 ws0">if <span class="_ _9"></span>we <span class="_ _9"></span>want <span class="_ _9"></span>to <span class="_ _9"></span>acquir<span class="ls398">eaw<span class="_ _b"></span><span class="ls0">rite <span class="_ _9"></span>lock <span class="_ _9"></span>on <span class="_ _9"></span>the <span class="_ _9"></span>index <span class="_ _9"></span>ﬁle <span class="_ _23"></span>while <span class="_ _9"></span>we <span class="_ _9"></span>search <span class="_ _3"></span>for <span class="_ _9"></span>the</span></span></div><div class="t m0 x11a h4d y576d ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cord. <span class="_ _45"> </span>If<span class="_ _45"> </span>we <span class="_ _23"></span>set<span class="_ _45"> </span><span class="ff1a">writelock<span class="_ _45"> </span></span>to <span class="_ _23"></span>zero, <span class="_ _3"></span>we <span class="_ _23"></span>read <span class="_ _9"></span>lock <span class="_ _9"></span>the <span class="_ _23"></span>index <span class="_ _9"></span>ﬁle <span class="_ _9"></span>while <span class="_ _23"></span>we</span></div><div class="t m0 x11a h49 y576e ff19 fs26 fc0 sc0 ls0 ws0">search it.</div><div class="t m0 x32 h4d y576f ff19 fs26 fc0 sc0 ls0 ws0">[238 <span class="_ _a"></span>– <span class="_ _a"></span>256]<span class="_ _65"> </span><span class="ls164">We <span class="_ _66"> </span>p<span class="_ _23"></span><span class="lscc">re</span></span>pare<span class="_ _45"> </span>to<span class="_ _45"> </span>traverse <span class="_ _9"></span>a <span class="_ _23"></span>hash <span class="_ _9"></span>chain <span class="_ _23"></span>in<span class="_ _45"> </span><span class="ff1a">_db_find_and_lock</span><span class="ls1601">.W<span class="_ _64"></span><span class="lsdc4">ec<span class="_ _b"></span><span class="ls0">onvert</span></span></span></div><div class="t m0 x11a h49 y5770 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>key <span class="_ _3"></span>into <span class="_ _9"></span>a <span class="_ _9"></span>hash <span class="_ _9"></span>value, <span class="_ _9"></span>which <span class="_ _9"></span>we <span class="_ _3"></span>use <span class="_ _9"></span>to <span class="_ _9"></span>calculate <span class="_ _9"></span>the <span class="_ _9"></span>starting <span class="_ _9"></span>address <span class="_ _3"></span>of</div><div class="t m0 x11a h4d y5771 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _23"> </span>hash <span class="_ _23"> </span>chain <span class="_ _42"> </span>in <span class="_ _23"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>(<span class="ff1a">chainoff</span>). <span class="_ _35"> </span>W<span class="_ _6"></span><span class="ls167f">ew<span class="_ _43"></span><span class="ls0">ait <span class="_ _23"> </span>for <span class="_ _42"> </span>the <span class="_ _23"> </span>lock <span class="_ _23"> </span>to <span class="_ _42"> </span>be <span class="_ _23"> </span>granted</span></span></div><div class="t m0 x11a h49 y5772 ff19 fs26 fc0 sc0 ls0 ws0">befor<span class="ls1680">eg<span class="_ _8"></span><span class="ls0">oing <span class="_ _2"></span>through the <span class="_ _2"></span>hash <span class="_ _2"></span>chain.<span class="_ _61"> </span>Note that <span class="_ _2"></span>we <span class="_ _2"></span>lock <span class="_ _2"></span>only <span class="_ _2"></span>the ﬁrst <span class="_ _2"></span>byte <span class="_ _2"></span>in</span></span></div><div class="t m0 x11a h49 y5773 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>start <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>hash <span class="_ _2"></span>chain.<span class="_ _16"> </span>This <span class="_ _3"></span>increases <span class="_ _2"></span>concurrency <span class="_ _2"></span>by <span class="_ _3"></span>allowing <span class="_ _2"></span>multiple</div><div class="t m0 x11a h49 y5774 ff19 fs26 fc0 sc0 ls0 ws0">processes to sear<span class="_ _0"></span>ch dif<span class="_ _0"></span>ferent hash chains at the same time.</div><div class="t m0 x32 h4d y5775 ff19 fs26 fc0 sc0 ls0 ws0">[257 <span class="_ _a"></span>– <span class="_ _a"></span>261]<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>c<span class="_ _9"></span></span>all<span class="_ _4b"> </span><span class="ff1a">_db_readptr<span class="_ _4b"> </span></span>to <span class="_ _53"> </span>read <span class="_ _53"> </span>the <span class="_ _53"> </span>ﬁrst <span class="_ _53"> </span>pointer <span class="_ _e"> </span>in <span class="_ _53"> </span>the <span class="_ _e"> </span>hash <span class="_ _53"> </span>chain.<span class="_ _65"> </span>If <span class="_ _e"> </span>this</div><div class="t m0 x11a h49 y5776 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turns zero, the hash chain is empty<span class="_ _4"></span>.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
