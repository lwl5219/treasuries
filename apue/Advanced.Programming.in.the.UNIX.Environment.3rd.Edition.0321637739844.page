<div id="pf34c" class="pf w4 h1f" data-page-no="34c"><div class="pc pc34c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg34c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">810<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x140 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">81 <span class="_ _15"> </span>req.size<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(nbytes);</span></span></div><div class="t m0 x140 h57 y348c ff1a fs2d fc0 sc0 ls0 ws0">82 <span class="_ _15"> </span>if<span class="_"> </span>(text)</div><div class="t m0 x140 h57 y2012 ff1a fs2d fc0 sc0 ls0 ws0">83 <span class="_ _186"> </span>req.flags<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(PR_TEXT);</span></span></div><div class="t m0 x140 h57 y2013 ff1a fs2d fc0 sc0 ls0 ws0">84 <span class="_ _15"> </span>else</div><div class="t m0 x140 h57 y2014 ff1a fs2d fc0 sc0 ls0 ws0">85 <span class="_ _186"> </span>req.flags<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x140 h57 y27e6 ff1a fs2d fc0 sc0 ls0 ws0">86 <span class="_ _15"> </span>if<span class="_"> </span>((len = strlen(fname)) &gt;= JOBNM_MAX) {</div><div class="t m0 x140 h57 y1cc2 ff1a fs2d fc0 sc0 ls0 ws0">87 <span class="_ _186"> </span>/*</div><div class="t m0 x140 h57 y1cc3 ff1a fs2d fc0 sc0 ls0 ws0">88 <span class="_ _176"> </span>*<span class="_"> </span>Truncate the filename (+-5 accounts for the leading</div><div class="t m0 x140 h57 y1cc4 ff1a fs2d fc0 sc0 ls0 ws0">89 <span class="_ _176"> </span>*<span class="_"> </span>four characters and the terminating null).</div><div class="t m0 x140 h57 y1cc5 ff1a fs2d fc0 sc0 ls0 ws0">90 <span class="_ _176"> </span>*/</div><div class="t m0 x140 h57 y2016 ff1a fs2d fc0 sc0 ls0 ws0">91 <span class="_ _186"> </span>strcpy(req.jobnm,<span class="_"> </span>&quot;... &quot;);</div><div class="t m0 x140 h57 y2017 ff1a fs2d fc0 sc0 ls0 ws0">92 <span class="_ _186"> </span>strncat(req.jobnm,<span class="_"> </span>&amp;fname[len-JOBNM_MAX+5], JOBNM_MAX-5);</div><div class="t m0 x140 h57 y2018 ff1a fs2d fc0 sc0 ls0 ws0">93 <span class="_ _15"> </span>}<span class="_"> </span>else {</div><div class="t m0 x140 h57 y2ad4 ff1a fs2d fc0 sc0 ls0 ws0">94 <span class="_ _186"> </span>strcpy(req.jobnm,<span class="_"> </span>fname);</div><div class="t m0 x140 h57 y2ad5 ff1a fs2d fc0 sc0 ls0 ws0">95 <span class="_ _15"> </span>}</div><div class="t m0 x140 h57 y201b ff1a fs2d fc0 sc0 ls0 ws0">96 <span class="_ _15"> </span>/*</div><div class="t m0 x140 h57 y201c ff1a fs2d fc0 sc0 ls0 ws0">97 <span class="_ _8a"> </span>*<span class="_"> </span>Send the header to the server.</div><div class="t m0 x140 h57 y201d ff1a fs2d fc0 sc0 ls0 ws0">98 <span class="_ _8a"> </span>*/</div><div class="t m0 x140 h57 y201e ff1a fs2d fc0 sc0 ls0 ws0">99 <span class="_ _15"> </span>nw<span class="_"> </span><span class="ls15c">=w<span class="_ _1d"></span><span class="ls0">riten(sockfd, &amp;req, sizeof(struct printreq));</span></span></div><div class="t m0 x32 h57 y201f ff1a fs2d fc0 sc0 ls0 ws0">100 <span class="_ _15"> </span>if<span class="_"> </span>(nw != sizeof(struct printreq)) {</div><div class="t m0 x32 h57 y2020 ff1a fs2d fc0 sc0 ls0 ws0">101 <span class="_ _186"> </span>if<span class="_"> </span>(nw &lt; 0)</div><div class="t m0 x32 h57 y2021 ff1a fs2d fc0 sc0 ls0 ws0">102 <span class="_ _82"> </span>err_sys(&quot;can’t<span class="_"> </span>write to print server&quot;);</div><div class="t m0 x32 h57 y2022 ff1a fs2d fc0 sc0 ls0 ws0">103 <span class="_ _186"> </span>else</div><div class="t m0 x32 h57 y5750 ff1a fs2d fc0 sc0 ls0 ws0">104 <span class="_ _82"> </span>err_quit(&quot;short<span class="_"> </span>write (%d/%d) to print server&quot;,</div><div class="t m0 x32 h57 y5751 ff1a fs2d fc0 sc0 ls0 ws0">105 <span class="_ _12d"> </span>nw,<span class="_"> </span>sizeof(struct printreq));</div><div class="t m0 x32 h57 y5752 ff1a fs2d fc0 sc0 ls0 ws0">106 <span class="_ _15"> </span>}</div><div class="t m0 x32 h49 y5b3e ff19 fs26 fc0 sc0 ls0 ws0">[81 <span class="_ _a"></span>– <span class="_ _a"></span>95]<span class="_ _75"> </span><span class="ls164">We <span class="_ _80"> </span>s<span class="_ _9"></span></span>tor<span class="ls176b">et<span class="_ _8"></span><span class="ls0">he <span class="_ _3"></span>size <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>to <span class="_ _3"></span>be <span class="_ _9"></span>printed <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>header <span class="_ _9"></span>after <span class="_ _3"></span>converting <span class="_ _3"></span>it <span class="_ _3"></span>to</span></span></div><div class="t m0 x11a h4d y5b3f ff19 fs26 fc0 sc0 ls0 ws0">network byte order<span class="_ _6"></span><span class="ls199">.T<span class="_ _4a"></span><span class="ls0">hen we do the same with the<span class="_"> </span><span class="ff1a">PR_TEXT<span class="_ _80"> </span></span>ﬂag if the ﬁle is</span></span></div><div class="t m0 x11a h49 y5b40 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _e"> </span>be <span class="_"> </span>printed <span class="_ _e"> </span>as <span class="_"> </span>plaintext.<span class="_ _65"> </span>By <span class="_"> </span>translating <span class="_ _e"> </span>these <span class="_"> </span>integers <span class="_ _e"> </span>to <span class="_ _e"> </span>network <span class="_"> </span>byte</div><div class="t m0 x11a h49 y5b41 ff19 fs26 fc0 sc0 ls0 ws0">order<span class="_ _6"></span>,<span class="_ _35"> </span>we<span class="_ _35"> </span>can <span class="_ _23"></span>run <span class="_ _23"></span>the <span class="_ _23"> </span>print <span class="_ _23"> </span>command <span class="_ _23"> </span>on <span class="_ _42"> </span>a <span class="_ _23"></span>client <span class="_ _23"> </span>system <span class="_ _23"> </span>while <span class="_ _23"> </span>the <span class="_ _42"> </span>printer</div><div class="t m0 x11a h49 y5b42 ff19 fs26 fc0 sc0 ls0 ws0">spooling <span class="_ _9"></span>daemon <span class="_ _9"></span>is <span class="_ _9"></span>running <span class="_ _9"></span>on <span class="_ _9"></span>another <span class="_ _9"></span>computer <span class="_ _9"></span>system.<span class="_ _5a"> </span>If <span class="_ _23"></span>these <span class="_ _9"></span>systems</div><div class="t m0 x11a h49 y5b43 ff19 fs26 fc0 sc0 ls0 ws0">use <span class="_ _53"> </span>processors <span class="_ _53"> </span>with <span class="_ _e"> </span>differ<span class="_ _0"></span>ent <span class="_ _53"> </span>byte <span class="_ _53"> </span>ordering, <span class="_ _53"> </span>then <span class="_ _e"> </span>the <span class="_ _53"> </span>commands <span class="_ _e"> </span>will <span class="_ _e"> </span>still</div><div class="t m0 x11a h49 y5b44 ff19 fs26 fc0 sc0 ls0 ws0">work. <span class="_"> </span>(W<span class="_ _6"></span><span class="lsd3">ed<span class="_ _d"></span><span class="ls0">iscussed byte ordering in Section 16.3.1.)</span></span></div><div class="t m0 x11a h49 y5b45 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _45"> </span>s<span class="_ _9"></span><span class="ls0">et <span class="_ _42"> </span>the <span class="_ _42"> </span>job <span class="_ _42"> </span>name <span class="_ _42"> </span>to <span class="_ _23"> </span>the <span class="_ _42"> </span>name <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>being <span class="_ _42"> </span>printed.<span class="_ _54"> </span>If <span class="_ _42"> </span>the <span class="_ _23"> </span>name <span class="_ _42"> </span>is</span></div><div class="t m0 x11a h49 y5b46 ff19 fs26 fc0 sc0 ls0 ws0">longer <span class="_ _23"></span>than <span class="_ _9"></span>will <span class="_ _23"> </span>ﬁt <span class="_ _23"></span>in <span class="_ _23"></span>the <span class="_ _9"></span>job <span class="_ _23"> </span>name <span class="_ _23"></span>ﬁeld <span class="_ _23"></span>in <span class="_ _9"></span>the <span class="_ _23"> </span>message, <span class="_ _23"></span>we <span class="_ _23"></span>copy <span class="_ _9"></span>only <span class="_ _23"> </span>the</div><div class="t m0 x11a h49 y5b47 ff19 fs26 fc0 sc0 ls0 ws0">last portion <span class="_ _2"></span>of the <span class="_ _2"></span>name <span class="_ _2"></span>that will <span class="_ _2"></span>ﬁt.<span class="_ _46"> </span>This <span class="_ _2"></span>effectively truncates the <span class="_ _2"></span>beginning</div><div class="t m0 x11a h49 y5b48 ff19 fs26 fc0 sc0 ls0 ws0">portion <span class="_ _42"> </span>of <span class="_ _53"> </span>the <span class="_ _53"> </span>name.<span class="_ _54"> </span>In <span class="_ _53"> </span>this <span class="_ _53"> </span>case, <span class="_ _53"> </span>we <span class="_ _42"> </span>prepend <span class="_ _42"> </span>an <span class="_ _53"> </span>ellipsis <span class="_ _53"> </span>to <span class="_ _53"> </span>indicate <span class="_ _42"> </span>that</div><div class="t m0 x11a h49 y5b49 ff19 fs26 fc0 sc0 ls0 ws0">ther<span class="lsd3">ew<span class="_ _4f"></span><span class="ls0">er<span class="lsd3">em<span class="_ _d"></span><span class="ls0">or<span class="lsd3">ec<span class="_ _d"></span><span class="ls0">haracters than would ﬁt in the ﬁeld.</span></span></span></span></span></span></div><div class="t m0 x32 h4d y5b4a ff19 fs26 fc0 sc0 ls0 ws0">[96 <span class="_ _a"></span>– <span class="_ _a"></span>106]<span class="_ _288"> </span><span class="ls164">We <span class="_ _47"> </span>s<span class="_ _23"></span></span>end <span class="_ _23"></span>the <span class="_ _9"></span>request <span class="_ _23"></span>header <span class="_ _23"></span>to <span class="_ _9"></span>the <span class="_ _23"> </span>daemon <span class="_ _23"> </span>using<span class="_ _35"> </span><span class="ff1a">writen</span><span class="ls176c">.(<span class="_ _7"></span><span class="ls0">Recall <span class="_ _23"> </span>that <span class="_ _23"> </span>we</span></span></div><div class="t m0 x11a h4d y5b4b ff19 fs26 fc0 sc0 ls0 ws0">introduced the<span class="_"> </span><span class="ff1a">writen<span class="_ _47"> </span></span>function in <span class="_ _2"></span>Figur<span class="ls1680">e1<span class="_ _4f"></span><span class="ls0">4.24.) <span class="_ _66"> </span>The<span class="_ _66"> </span><span class="ff1a">writen<span class="_ _66"> </span></span>function <span class="_ _2"></span>uses</span></span></div><div class="t m0 x11a h4d y5b4c ff19 fs26 fc0 sc0 ls0 ws0">multiple calls <span class="_ _2"></span>to<span class="_"> </span><span class="ff1a">write</span>,<span class="_ _47"> </span>if<span class="_"> </span>necessary<span class="_ _4"></span>,<span class="_ _47"> </span>to<span class="_"> </span>transmit the <span class="_ _2"></span>speciﬁed <span class="_ _2"></span>amount.<span class="_ _46"> </span>If <span class="_ _2"></span>the</div><div class="t m0 x11a h4d y5b4d ff1a fs26 fc0 sc0 ls0 ws0">writen<span class="_ _35"> </span><span class="ff19">function <span class="_ _42"> </span>returns <span class="_ _23"> </span>an <span class="_ _42"> </span>error <span class="_ _23"></span>or <span class="_ _23"> </span>transmits <span class="_ _42"> </span>less <span class="_ _42"> </span>than <span class="_ _42"> </span>we <span class="_ _23"> </span>requested, <span class="_ _23"> </span>we</span></div><div class="t m0 x11a h49 y5b4e ff19 fs26 fc0 sc0 ls0 ws0">print an error message and exit.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
