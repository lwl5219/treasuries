<div id="pf22c" class="pf w4 h1f" data-page-no="22c"><div class="pc pc22c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg22c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">522<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h26 yce9 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _44"> </span>Section <span class="_ _44"> </span>20.8, <span class="_ _44"> </span>in <span class="_ _44"> </span>the <span class="_ _44"> </span>function<span class="_ _54"> </span><span class="ff1a">_db_writeidx</span>,<span class="_ _54"> </span>we<span class="_ _54"> </span>need <span class="_ _44"> </span>to <span class="_ _44"> </span>write <span class="_ _44"> </span>two <span class="_ _44"> </span>buffers</div><div class="t m0 x32 h2a yceb ff19 fsf fc0 sc0 ls0 ws0">consecutively <span class="_ _2"></span>to <span class="_ _2"></span>a <span class="_ _2"></span>ﬁle.<span class="_ _61"> </span>The <span class="_ _2"></span>second <span class="_ _2"></span>buffer <span class="_ _2"></span>to <span class="_ _2"></span>output <span class="_ _2"></span>is <span class="_ _2"></span>an <span class="_ _2"></span>argument <span class="_ _2"></span>passed <span class="_ _2"></span>by <span class="_ _2"></span>the <span class="_ _2"></span>caller<span class="_ _1"></span>,</div><div class="t m0 x32 h2a y20ea ff19 fsf fc0 sc0 ls0 ws0">and the <span class="_ _2"></span>ﬁrst buffer is <span class="_ _2"></span>one we <span class="_ _2"></span>create, containing the <span class="_ _2"></span>length of <span class="_ _2"></span>the second <span class="_ _2"></span>buffer and <span class="_ _2"></span>a ﬁle</div><div class="t m0 x32 h2a y3fce ff19 fsf fc0 sc0 ls0 ws0">offset of other information in the ﬁle.<span class="_ _59"> </span>Ther<span class="ls44">ea<span class="_ _4f"></span><span class="ls45">re <span class="_ _3"></span>t<span class="ls0">hree ways we can do this.</span></span></span></div><div class="t m0 x3f h26 y39a5 ff19 fsf fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>Call<span class="_"> </span><span class="ff1a">write<span class="_ _80"> </span></span>twice, once for each buffer<span class="_ _6"></span>.</div><div class="t m0 x3f h2a y3fcf ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>Allocate<span class="_ _35"> </span><span class="lse37">ab<span class="_ _43"></span><span class="ls0">uffer <span class="_ _23"></span>of <span class="_ _23"></span>our <span class="_ _23"></span>own <span class="_ _23"></span>that <span class="_ _23"></span>is <span class="_ _9"></span>large <span class="_ _23"></span>enough <span class="_ _23"></span>to <span class="_ _23"></span>contain <span class="_ _23"></span>both <span class="_ _23"></span>buffers, <span class="_ _9"></span>and</span></span></div><div class="t m0 x41 h26 y3fd0 ff19 fsf fc0 sc0 ls0 ws0">copy both into the new buffer<span class="_ _6"></span><span class="ls86">.W<span class="_ _26"></span><span class="ls44">et<span class="_ _5"></span><span class="ls0">hen call<span class="_"> </span><span class="ff1a">write<span class="_ _80"> </span></span>once for this new buffer<span class="_ _6"></span>.</span></span></span></div><div class="t m0 x3f h26 y641 ff19 fsf fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>Call<span class="_"> </span><span class="ff1a">writev<span class="_ _80"> </span></span>to output both buffers.</div><div class="t m0 x32 h26 y3fd1 ff19 fsf fc0 sc0 ls0 ws0">The solution we <span class="_ _2"></span>use in Section <span class="_ _2"></span>20.8 is <span class="_ _2"></span>to use<span class="_ _66"> </span><span class="ff1a">writev</span><span class="ls10d2">,b<span class="_ _d"></span><span class="ls0">ut it’s <span class="_ _2"></span>instructive to compare<span class="_"> </span>it<span class="_"> </span>to</span></span></div><div class="t m0 x32 h2a y3fd2 ff19 fsf fc0 sc0 ls0 ws0">the other two solutions.</div><div class="t m0 x3f h2a y3fd3 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">4.23 shows the results from the thr<span class="_ _0"></span>ee methods just described.</span></span></div><div class="t m0 x205 h2d y3fd4 ff19 fs10 fc0 sc0 ls0 ws0">Linux</div><div class="t m0 x46 h2d y3fd5 ff19 fs10 fc0 sc0 ls0 ws0">(</div><div class="t m0 x1cd h2d y3fd4 ff19 fs10 fc0 sc0 ls0 ws0">Intel x86</div><div class="t m0 x174 h2d y3fd5 ff19 fs10 fc0 sc0 ls0 ws0">)</div><div class="t m0 x13e h2d y3fd4 ff19 fs10 fc0 sc0 ls0 ws0">Mac OS X</div><div class="t m0 x151 h2d y3fd5 ff19 fs10 fc0 sc0 ls0 ws0">(</div><div class="t m0 x152 h2d y3fd4 ff19 fs10 fc0 sc0 ls0 ws0">Intel x86</div><div class="t m0 x223 h2d y3fd5 ff19 fs10 fc0 sc0 ls0 ws0">)</div><div class="t m0 x1b7 h2e y3fd6 ff19 fs11 fc0 sc0 ls0 ws0">User <span class="_ _d8"> </span>System<span class="_ _2b"> </span>Clock <span class="_ _75"> </span>User<span class="_ _87"> </span>System <span class="_ _6d"> </span>Clock</div><div class="t m0 x7b h2e y3fd7 ff19 fs11 fc0 sc0 ls0 ws0">Operation</div><div class="t m0 x194 h6d y3fd8 ff19 fs12 fc0 sc0 ls0 ws0">two<span class="_"> </span><span class="ff1a">write</span><span class="ls10d3">s0<span class="_ _2af"></span><span class="ls0">.06 <span class="_ _2a8"> </span>2.04 <span class="_ _15"> </span>2.13 <span class="_ _15"> </span>0.85 <span class="_ _15"> </span>8.33<span class="_ _2a8"> </span>13.83</span></span></div><div class="t m0 x194 h6d y3fd9 ff19 fs12 fc0 sc0 ls0 ws0">buffer copy<span class="_ _4"></span><span class="ls38a">,t<span class="_ _a"></span><span class="ls0">hen one<span class="_"> </span><span class="ff1a">write<span class="_ _1fb"> </span></span>0.03 <span class="_ _15"> </span>1.13 <span class="_ _15"> </span>1.16 <span class="_ _2a8"> </span>0.70 <span class="_ _15"> </span>4.87<span class="_ _7a"> </span>9.25</span></span></div><div class="t m0 x194 h6d y3fda ff19 fs12 fc0 sc0 ls0 ws0">one<span class="_"> </span><span class="ff1a">writev<span class="_ _1e2"> </span></span>0.04 <span class="_ _2a8"> </span>1.21 <span class="_ _15"> </span>1.26 <span class="_ _15"> </span>0.43 <span class="_ _15"> </span>5.34<span class="_ _7a"> </span>9.24</div><div class="t m0 x6 h63 y3fdb ff18 fs13 fc0 sc0 ls0 ws0">Figure 14.23<span class="_ _5a"> </span><span class="ff19 ls10d4">Ti<span class="_ _3"></span><span class="ls0">ming results comparing<span class="_"> </span><span class="ff1a">writev<span class="_ _53"> </span></span>and other techniques</span></span></div><div class="t m0 x32 h6e y3fdc ff19 fs31 fc0 sc0 ls0 ws0">The <span class="_ _3"></span>test <span class="_ _9"></span>program <span class="_ _2"></span>that <span class="_ _9"></span>we <span class="_ _3"></span>measured <span class="_ _3"></span>output <span class="_ _9"></span>a <span class="_ _3"></span>100</div><div class="t m0 xdc h6e y3fdd ff19 fs31 fc0 sc0 ls0 ws0">-</div><div class="t m0 x1c5 h6e y3fdc ff19 fs31 fc0 sc0 ls0 ws0">byte <span class="_ _3"></span>header <span class="_ _9"></span>followed <span class="_ _3"></span>by <span class="_ _9"></span>200 <span class="_ _3"></span>bytes <span class="_ _9"></span>of</div><div class="t m0 x32 h6e y3fde ff19 fs31 fc0 sc0 ls0 ws0">data. <span class="_ _47"> </span>This<span class="_ _47"> </span>was <span class="_ _3"></span>done <span class="_ _3"></span>1,048,576 <span class="_ _3"></span>times, <span class="_ _3"></span>generating <span class="_ _3"></span>a <span class="_ _3"></span>300-megabyte <span class="_ _3"></span>ﬁle.<span class="_ _16"> </span>The <span class="_ _3"></span>test <span class="_ _3"></span>program</div><div class="t m0 x32 h6e y3fdf ff19 fs31 fc0 sc0 ls0 ws0">has <span class="_ _3"></span>three <span class="_ _2"></span>separate <span class="_ _3"></span>cases<span class="_ _9"></span><span class="ls417">—o<span class="_ _6"></span><span class="ls0">ne <span class="_ _3"></span>for <span class="_ _9"></span>each <span class="_ _2"></span>of <span class="_ _9"></span>the <span class="_ _2"></span>techniques <span class="_ _9"></span>measured <span class="_ _2"></span>in <span class="_ _3"></span>Figur<span class="ls10d5">e1<span class="_ _b"></span><span class="ls0">4.23. <span class="_ _45"> </span>W<span class="_ _4"></span>e</span></span></span></span></div><div class="t m0 x32 h64 y3fe0 ff19 fs31 fc0 sc0 ls0 ws0">used<span class="_ _44"> </span><span class="ff1a">times<span class="_ _44"> </span></span>(Section <span class="_ _53"> </span>8.17) <span class="_ _53"> </span>to <span class="_ _53"> </span>obtain <span class="_ _53"> </span>the <span class="_ _53"> </span>user <span class="_ _53"> </span>CPU <span class="_ _42"> </span>time, <span class="_ _53"> </span>system <span class="_ _53"> </span>CPU <span class="_ _53"> </span>time, <span class="_ _53"> </span>and <span class="_ _53"> </span>wall</div><div class="t m0 x32 h6e y3fe1 ff19 fs31 fc0 sc0 ls0 ws0">clock time befor<span class="ls229">ea<span class="_ _4f"></span><span class="ls0">nd after the writes.<span class="_ _46"> </span>All three times ar<span class="ls229">es<span class="_ _4f"></span><span class="ls0">hown in seconds.</span></span></span></span></div><div class="t m0 x3f h64 y3fe2 ff19 fs31 fc0 sc0 ls0 ws0">As <span class="_ _23"></span>we <span class="_ _23"> </span>expect, <span class="_ _23"> </span>the <span class="_ _23"> </span>system <span class="_ _42"> </span>time <span class="_ _23"></span>increases <span class="_ _9"></span>when <span class="_ _42"> </span>we <span class="_ _23"></span>call<span class="_ _35"> </span><span class="ff1a">write<span class="_ _35"> </span></span>twice, <span class="_ _23"></span>compared <span class="_ _9"></span>to</div><div class="t m0 x32 h64 y3fe3 ff19 fs31 fc0 sc0 ls0 ws0">calling either<span class="_"> </span><span class="ff1a">write<span class="_ _80"> </span></span>or<span class="_"> </span><span class="ff1a">writev<span class="_ _66"> </span></span>once. <span class="_"> </span>This<span class="_"> </span>correlates with the r<span class="_ _0"></span>esults in Figur<span class="_ _0"></span><span class="ls229">e3<span class="_ _d"></span><span class="ls0">.6.</span></span></div><div class="t m0 x3f h6e y3fe4 ff19 fs31 fc0 sc0 ls0 ws0">Next, note that the sum of the CPU times <span class="_ _2"></span>(user plus system) is slightly less when we</div><div class="t m0 x32 h64 y3fe5 ff19 fs31 fc0 sc0 ls0 ws0">do a <span class="_ _2"></span>buffer copy followed <span class="_ _2"></span>by <span class="_ _2"></span>a single<span class="_ _47"> </span><span class="ff1a">write<span class="_ _80"> </span></span>compared to <span class="_ _2"></span>a <span class="_ _2"></span>single call <span class="_ _2"></span>to<span class="_ _66"> </span><span class="ff1a">writev</span><span class="ls10d6">.W<span class="_ _1d"></span><span class="ls0">ith</span></span></div><div class="t m0 x32 h64 y3fe6 ff19 fs31 fc0 sc0 ls0 ws0">the <span class="_ _42"> </span>single<span class="_ _35"> </span><span class="ff1a">write</span>,<span class="_ _44"> </span>we<span class="_ _35"> </span>copy <span class="_ _42"> </span>the <span class="_ _42"> </span>buffers <span class="_ _23"> </span>to <span class="_ _42"> </span>a <span class="_ _42"> </span>staging <span class="_ _42"> </span>buffer <span class="_ _23"> </span>at <span class="_ _42"> </span>user <span class="_ _42"> </span>level, <span class="_ _23"> </span>and <span class="_ _42"> </span>then <span class="_ _42"> </span>the</div><div class="t m0 x32 h64 y3fe7 ff19 fs31 fc0 sc0 ls0 ws0">kernel <span class="_ _2"></span>will <span class="_ _3"></span>copy <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _2"></span>to <span class="_ _3"></span>its <span class="_ _3"></span>internal <span class="_ _3"></span>buffers <span class="_ _2"></span>when <span class="_ _3"></span>we <span class="_ _2"></span>call<span class="_ _47"> </span><span class="ff1a">write</span><span class="ls10d7">.W<span class="_ _62"></span><span class="ls0">ith<span class="_ _47"> </span><span class="ff1a">writev</span><span class="ls10d8">,w<span class="_ _8"></span><span class="ls0">e</span></span></span></span></div><div class="t m0 x32 h6e y3fe8 ff19 fs31 fc0 sc0 ls0 ws0">should <span class="_ _3"></span>do <span class="_ _3"></span>less <span class="_ _3"></span>copying, <span class="_ _3"></span>because <span class="_ _9"></span>the <span class="_ _3"></span>kernel <span class="_ _3"></span>only <span class="_ _3"></span>needs <span class="_ _3"></span>to <span class="_ _9"></span>copy <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _3"></span>directly <span class="_ _3"></span>into <span class="_ _3"></span>its</div><div class="t m0 x32 h64 y3fe9 ff19 fs31 fc0 sc0 ls0 ws0">staging <span class="_ _66"> </span>buffers. <span class="_ _61"> </span>The<span class="_ _61"> </span>ﬁxed <span class="_ _47"> </span>cost <span class="_ _66"> </span>of <span class="_ _47"> </span>using<span class="_ _61"> </span><span class="ff1a">writev<span class="_ _61"> </span></span>for <span class="_ _47"> </span>such <span class="_ _66"> </span>small <span class="_ _47"> </span>amounts <span class="_ _66"> </span>of <span class="_ _47"> </span>data,</div><div class="t m0 x32 h6e y3fea ff19 fs31 fc0 sc0 ls0 ws0">however<span class="_ _6"></span>,<span class="_ _45"> </span>is<span class="_ _47"> </span>g<span class="ls225">re</span>ater <span class="_ _3"></span>than <span class="_ _9"></span>the <span class="_ _3"></span>beneﬁt.<span class="_ _16"> </span>As <span class="_ _3"></span>the <span class="_ _3"></span>amount <span class="_ _3"></span>of <span class="_ _9"></span>data <span class="_ _3"></span>we <span class="_ _3"></span>need <span class="_ _3"></span>to <span class="_ _3"></span>copy <span class="_ _9"></span>increases,</div><div class="t m0 x32 h64 y3feb ff19 fs31 fc0 sc0 ls0 ws0">the <span class="_ _e"> </span>mor<span class="ls10d9">ee<span class="_ _4a"></span><span class="ls0">xpensive <span class="_"> </span>it <span class="_ _53"> </span>will <span class="_ _e"> </span>be <span class="_ _e"> </span>to <span class="_ _e"> </span>copy <span class="_ _e"> </span>the <span class="_ _e"> </span>buffers <span class="_ _53"> </span>in <span class="_ _e"> </span>our <span class="_ _e"> </span>program, <span class="_ _53"> </span>and <span class="_"> </span>the<span class="_ _44"> </span><span class="ff1a">writev</span></span></span></div><div class="t m0 x32 h6e y3fec ff19 fs31 fc0 sc0 ls0 ws0">alternative will be mor<span class="ls229">ea<span class="_ _4f"></span><span class="ls0">ttractive.</span></span></div><div class="t m0 x76 h30 y1942 ff19 fs13 fc0 sc0 ls0 ws0">Don’t infer too much <span class="_ _2"></span>about the relative performance of Linux and <span class="_ _2"></span>Mac OS X from the numbers</div><div class="t m0 x76 h30 y3fed ff19 fs13 fc0 sc0 ls0 ws0">shown <span class="_ _9"></span>in <span class="_ _9"></span>Figur<span class="ls10da">e1<span class="_ _8"></span><span class="ls0">4.23. <span class="_ _47"> </span>The<span class="_ _66"> </span>two <span class="_ _9"></span>computers <span class="_ _9"></span>wer<span class="ls10da">ev<span class="_ _4f"></span><span class="ls0">ery <span class="_ _9"></span>differ<span class="_ _0"></span>ent: <span class="_ _9"></span>they <span class="_ _9"></span>had <span class="_ _9"></span>differ<span class="_ _0"></span>ent <span class="_ _9"></span>processor</span></span></span></span></div><div class="t m0 x76 h30 y3fee ff19 fs13 fc0 sc0 ls0 ws0">generations, <span class="_ _3"></span>different <span class="_ _2"></span>amounts <span class="_ _9"></span>of <span class="_ _3"></span>RAM, <span class="_ _9"></span>and <span class="_ _3"></span>disks <span class="_ _9"></span>with <span class="_ _3"></span>different <span class="_ _2"></span>speeds.<span class="_ _59"> </span><span class="ls9b5">To <span class="_ _e"> </span>d<span class="_ _9"></span></span>o<span class="_ _66"> </span>an<span class="_ _66"> </span>apples-to-</div><div class="t m0 x76 h30 y3fef ff19 fs13 fc0 sc0 ls0 ws0">apples <span class="_ _2"></span>comparison <span class="_ _3"></span>of <span class="_ _2"></span>one <span class="_ _3"></span>operating <span class="_ _2"></span>system <span class="_ _3"></span>to <span class="_ _3"></span>another<span class="_ _1"></span><span class="ls10db">,w<span class="_ _d"></span><span class="ls10dc">en<span class="_ _5"></span><span class="ls0">eed <span class="_ _3"></span>to <span class="_ _2"></span>use <span class="_ _3"></span>the <span class="_ _2"></span>same <span class="_ _3"></span>hardwar<span class="ls10dc">ef<span class="_ _4f"></span><span class="ls0">or</span></span></span></span></span></div><div class="t m0 x76 h30 y3ff0 ff19 fs13 fc0 sc0 ls0 ws0">each operating system.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
