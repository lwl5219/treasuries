<div id="pf34a" class="pf w4 h1f" data-page-no="34a"><div class="pc pc34a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg34a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">808<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">34 <span class="_ _8a"> </span>if<span class="_"> </span>(err || (optind != argc - 1))</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">35 <span class="_ _176"> </span>err_quit(&quot;usage:<span class="_"> </span>print [-t] filename&quot;);</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">36 <span class="_ _8a"> </span>if<span class="_"> </span>((fd = open(argv[optind], O_RDONLY)) &lt; 0)</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">37 <span class="_ _176"> </span>err_sys(&quot;print:<span class="_"> </span>can’t open %s&quot;, argv[optind]);</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">38 <span class="_ _8a"> </span>if<span class="_"> </span>(fstat(fd, &amp;sbuf) &lt; 0)</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">39 <span class="_ _176"> </span>err_sys(&quot;print:<span class="_"> </span>can’t stat %s&quot;, argv[optind]);</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">40 <span class="_ _8a"> </span>if<span class="_"> </span>(!S_ISREG(sbuf.st_mode))</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">41 <span class="_ _176"> </span>err_quit(&quot;print:<span class="_"> </span>%s must be a regular file&quot;, argv[optind]);</div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">42 <span class="_ _8a"> </span>/*</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">43 <span class="_ _189"> </span>*<span class="_"> </span>Get the hostname of the host acting as the print server.</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">44 <span class="_ _189"> </span>*/</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">45 <span class="_ _8a"> </span>if<span class="_"> </span>((host = get_printserver()) == NULL)</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">46 <span class="_ _176"> </span>err_quit(&quot;print:<span class="_"> </span>no print server defined&quot;);</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">47 <span class="_ _8a"> </span>if<span class="_"> </span>((err = getaddrlist(host, &quot;print&quot;, &amp;ailist)) != 0)</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">48 <span class="_ _176"> </span>err_quit(&quot;print:<span class="_"> </span>getaddrinfo error: %s&quot;, gai_strerror(err));</div><div class="t m0 x32 h57 y2ad6 ff1a fs2d fc0 sc0 ls0 ws0">49 <span class="_ _8a"> </span>for<span class="_"> </span>(aip = ailist; aip != NULL; aip = aip-&gt;ai_next) {</div><div class="t m0 x32 h57 y33b1 ff1a fs2d fc0 sc0 ls0 ws0">50 <span class="_ _176"> </span>if<span class="_"> </span>((sfd = connect_retry(AF_INET, SOCK_STREAM, 0,</div><div class="t m0 x32 h57 y33b2 ff1a fs2d fc0 sc0 ls0 ws0">51 <span class="_ _bd"> </span>aip-&gt;ai_addr,<span class="_"> </span>aip-&gt;ai_addrlen)) &lt; 0) {</div><div class="t m0 x32 h57 y33b3 ff1a fs2d fc0 sc0 ls0 ws0">52 <span class="_ _166"> </span>err<span class="_"> </span><span class="ls15c">=e<span class="_ _1d"></span><span class="ls0">rrno;</span></span></div><div class="t m0 x32 h4d y5b18 ff19 fs26 fc0 sc0 ls0 ws0">[34 <span class="_ _a"></span>– <span class="_ _a"></span>41]<span class="_ _65"> </span>When<span class="_ _5a"> </span><span class="ff1a">getopt<span class="_"> </span></span>completes <span class="_ _35"> </span>pr<span class="_ _0"></span>ocessing <span class="_ _45"> </span>the <span class="_ _45"> </span>command <span class="_ _35"> </span>options, <span class="_ _45"> </span>it <span class="_ _45"> </span>leaves <span class="_ _35"> </span>the</div><div class="t m0 x2d h4d y5b19 ff19 fs26 fc0 sc0 ls0 ws0">variable<span class="_ _45"> </span><span class="ff1a">optind<span class="_ _35"> </span></span>set <span class="_ _9"></span>to <span class="_ _23"></span>the <span class="_ _23"></span>index <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>ﬁrst <span class="_ _9"></span>nonoptional <span class="_ _23"></span>argument. <span class="_ _45"> </span>If<span class="_ _45"> </span>this <span class="_ _23"></span>is</div><div class="t m0 x2d h49 y5b1a ff19 fs26 fc0 sc0 ls0 ws0">any value <span class="_ _2"></span>other <span class="_ _2"></span>than the <span class="_ _2"></span>index <span class="_ _2"></span>of the <span class="_ _2"></span>last <span class="_ _2"></span>argument, then the <span class="_ _2"></span>wrong number <span class="_ _2"></span>of</div><div class="t m0 x2d h49 y5b1b ff19 fs26 fc0 sc0 ls0 ws0">arguments <span class="_ _23"></span>was <span class="_ _42"> </span>speciﬁed <span class="_ _23"> </span>(we <span class="_ _42"> </span>support <span class="_ _42"> </span>only <span class="_ _23"> </span>one <span class="_ _42"> </span>nonoptional <span class="_ _42"> </span>argument). <span class="_ _35"> </span>Our</div><div class="t m0 x2d h49 y5b1c ff19 fs26 fc0 sc0 ls0 ws0">error <span class="_ _e"> </span>processing <span class="_ _e"> </span>includes <span class="_ _e"> </span>checks <span class="_"> </span>to <span class="_ _e"> </span>ensur<span class="ls175f">et<span class="_ _4a"></span><span class="ls0">hat <span class="_"> </span>we <span class="_ _e"> </span>can <span class="_"> </span>open <span class="_ _e"> </span>the <span class="_"> </span>ﬁle <span class="_ _53"> </span>to <span class="_"> </span>be</span></span></div><div class="t m0 x2d h49 y5b1d ff19 fs26 fc0 sc0 ls0 ws0">printed <span class="_ _9"></span>and <span class="_ _9"></span>that <span class="_ _9"></span>it <span class="_ _3"></span>is <span class="_ _9"></span>a <span class="_ _9"></span>regular <span class="_ _9"></span>ﬁle <span class="_ _9"></span>(as <span class="_ _9"></span>opposed <span class="_ _9"></span>to <span class="_ _3"></span>a <span class="_ _9"></span>directory <span class="_ _9"></span>or <span class="_ _9"></span>other <span class="_ _9"></span>type <span class="_ _9"></span>of</div><div class="t m0 x2d h49 y5b1e ff19 fs26 fc0 sc0 ls0 ws0">ﬁle).</div><div class="t m0 x32 h49 y5b1f ff19 fs26 fc0 sc0 ls0 ws0">[42 <span class="_ _a"></span>– <span class="_ _a"></span>48]<span class="_ _65"> </span><span class="ls164">We <span class="_ _80"> </span>g<span class="_ _9"></span></span>et <span class="_ _3"></span>the <span class="_ _3"></span>name <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>host <span class="_ _3"></span>wher<span class="ls1760">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>printer <span class="_ _3"></span>spooling <span class="_ _3"></span>daemon <span class="_ _3"></span>is <span class="_ _3"></span>running <span class="_ _3"></span>by</span></span></div><div class="t m0 x2d h4d y5b20 ff19 fs26 fc0 sc0 ls0 ws0">calling <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">get_printserver<span class="_ _45"> </span></span>function <span class="_ _3"></span>from<span class="_ _45"> </span><span class="ff1a">util.c</span><span class="ls1761">.T<span class="_ _26"></span><span class="ls0">hen <span class="_ _9"></span>we <span class="_ _9"></span>translate <span class="_ _9"></span>the</span></span></div><div class="t m0 x2d h4d y5b21 ff19 fs26 fc0 sc0 ls0 ws0">host <span class="_ _35"> </span>name <span class="_ _35"> </span>into <span class="_ _44"> </span>a <span class="_ _35"> </span>network <span class="_ _35"> </span>address <span class="_ _35"> </span>by <span class="_ _35"> </span>calling<span class="_ _51"> </span><span class="ff1a">getaddrlist<span class="_ _54"> </span></span>(also <span class="_ _35"> </span>from</div><div class="t m0 x2d h4d y5b22 ff1a fs26 fc0 sc0 ls0 ws0">util.c<span class="ff19">).</span></div><div class="t m0 x2d h49 y5b23 ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _23"> </span>that <span class="_ _42"> </span>we <span class="_ _23"> </span>specify <span class="_ _42"> </span>the <span class="_ _23"> </span>service <span class="_ _42"> </span>as <span class="_ _23"> </span>‘‘print.’<span class="_ _1"></span><span class="ls1762">’A<span class="_ _7"></span><span class="ls1763">sp<span class="_ _43"></span><span class="ls0">art <span class="_ _42"> </span>of <span class="_ _23"> </span>installing <span class="_ _42"> </span>the <span class="_ _23"> </span>printer</span></span></span></div><div class="t m0 x2d h4d y5b24 ff19 fs26 fc0 sc0 ls0 ws0">spooling daemon on <span class="_ _2"></span>a system, <span class="_ _2"></span>we need <span class="_ _2"></span>to make <span class="_ _2"></span>sur<span class="lsa59">et<span class="_ _4f"></span><span class="ls0">hat<span class="_"> </span><span class="ff1a">/etc/services<span class="_ _66"> </span></span>(or</span></span></div><div class="t m0 x2d h49 y5b25 ff19 fs26 fc0 sc0 ls0 ws0">the equivalent <span class="_ _2"></span>database) <span class="_ _2"></span>has <span class="_ _2"></span>an <span class="_ _2"></span>entry <span class="_ _2"></span>for <span class="_ _2"></span>the <span class="_ _2"></span>printer <span class="_ _2"></span>service.<span class="_ _61"> </span>When <span class="_ _2"></span>we <span class="_ _2"></span>select <span class="_ _2"></span>a</div><div class="t m0 x2d h49 y5b26 ff19 fs26 fc0 sc0 ls0 ws0">port <span class="_ _53"> </span>number <span class="_ _53"> </span>for <span class="_ _e"> </span>the <span class="_ _53"> </span>daemon, <span class="_ _53"> </span>it <span class="_ _e"> </span>would <span class="_ _53"> </span>be <span class="_ _53"> </span>a <span class="_ _e"> </span>good <span class="_ _53"> </span>idea <span class="_ _53"> </span>to <span class="_ _e"> </span>select <span class="_ _53"> </span>one <span class="_ _53"> </span>that <span class="_ _e"> </span>is</div><div class="t m0 x2d h49 y5b27 ff19 fs26 fc0 sc0 ls0 ws0">privileged, <span class="_ _23"></span>to <span class="_ _23"></span>prevent <span class="_ _9"></span>malicious <span class="_ _23"> </span>users <span class="_ _23"> </span>from <span class="_ _23"></span>writing <span class="_ _9"></span>applications <span class="_ _23"> </span>that <span class="_ _23"> </span>pretend</div><div class="t m0 x2d h49 y5b28 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _9"></span>be <span class="_ _9"></span>a <span class="_ _9"></span>printer <span class="_ _9"></span>spooling <span class="_ _9"></span>daemon <span class="_ _9"></span>but <span class="_ _9"></span>instead <span class="_ _23"></span>steal <span class="_ _3"></span>copies <span class="_ _23"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>ﬁles <span class="_ _9"></span>we <span class="_ _9"></span>try <span class="_ _9"></span>to</div><div class="t m0 x2d h49 y5b29 ff19 fs26 fc0 sc0 ls0 ws0">print. <span class="_ _61"> </span>This<span class="_ _61"> </span>means <span class="_ _66"> </span>that <span class="_ _47"> </span>the <span class="_ _66"> </span>port <span class="_ _47"> </span>number <span class="_ _66"> </span>should <span class="_ _47"> </span>be <span class="_ _66"> </span>less <span class="_ _47"> </span>than <span class="_ _66"> </span>1,024 <span class="_ _47"> </span>(recall</div><div class="t m0 x2d h49 y5b2a ff19 fs26 fc0 sc0 ls0 ws0">Section <span class="_ _2"></span>16.3.4) <span class="_ _2"></span>and <span class="_ _2"></span>that <span class="_ _2"></span>our <span class="_ _2"></span>daemon <span class="_ _2"></span>will <span class="_ _2"></span>have <span class="_ _2"></span>to <span class="_ _2"></span>run with <span class="_ _2"></span>superuser <span class="_ _2"></span>privileges</div><div class="t m0 x2d h49 y5b2b ff19 fs26 fc0 sc0 ls0 ws0">to allow it to bind to a reserved port.</div><div class="t m0 x32 h49 y5b2c ff19 fs26 fc0 sc0 ls0 ws0">[49 <span class="_ _a"></span>– <span class="_ _a"></span>52]<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>t<span class="_ _9"></span></span>ry <span class="_ _53"> </span>to <span class="_ _53"> </span>connect <span class="_ _53"> </span>to <span class="_ _e"> </span>the <span class="_ _53"> </span>daemon <span class="_ _53"> </span>using <span class="_ _53"> </span>one <span class="_ _e"> </span>address <span class="_ _42"> </span>at <span class="_ _53"> </span>a <span class="_ _e"> </span>time <span class="_ _53"> </span>from <span class="_ _53"> </span>the <span class="_ _53"> </span>list</div><div class="t m0 x2d h4d y5b2d ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turned <span class="_ _23"></span>by<span class="_ _45"> </span><span class="ff1a">getaddrinfo</span><span class="ls1764">.W<span class="_ _52"></span><span class="ls93d">ew<span class="_ _b"></span><span class="ls0">ill <span class="_ _3"></span>try <span class="_ _23"></span>to <span class="_ _9"></span>send <span class="_ _23"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>daemon <span class="_ _23"></span>using</span></span></span></span></div><div class="t m0 x2d h49 y5b2e ff19 fs26 fc0 sc0 ls0 ws0">the ﬁrst address to which we can connect.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
