<div id="pf31c" class="pf w4 h1f" data-page-no="31c"><div class="pc pc31c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg31c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">762<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">200 <span class="_ _15"> </span>if<span class="_"> </span>(db-&gt;idxbuf != NULL)</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">201 <span class="_ _186"> </span>free(db-&gt;idxbuf);</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">202 <span class="_ _15"> </span>if<span class="_"> </span>(db-&gt;datbuf != NULL)</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">203 <span class="_ _186"> </span>free(db-&gt;datbuf);</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">204 <span class="_ _15"> </span>if<span class="_"> </span>(db-&gt;name != NULL)</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">205 <span class="_ _186"> </span>free(db-&gt;name);</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">206 <span class="_ _15"> </span>free(db);</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">207 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">208 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">209 <span class="_ _68"> </span>*<span class="_"> </span>Fetch a record.<span class="_ _3a"> </span>Return a pointer to the null-terminated data.</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">210 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">211 <span class="_ _d9"> </span>char<span class="_"> </span>*</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">212 <span class="_ _d9"> </span>db_fetch(DBHANDLE<span class="_"> </span>h, const char *key)</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">213 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">214 <span class="_ _15"> </span>DB<span class="_ _189"> </span>*db = h;</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">215 <span class="_ _15"> </span>char<span class="_ _15"> </span>*ptr;</div><div class="t m0 x32 h57 y33b1 ff1a fs2d fc0 sc0 ls0 ws0">216 <span class="_ _15"> </span>if<span class="_"> </span>(_db_find_and_lock(db, key, 0) &lt; 0) {</div><div class="t m0 x32 h57 y33b2 ff1a fs2d fc0 sc0 ls0 ws0">217 <span class="_ _186"> </span>ptr<span class="_"> </span><span class="ls15c">=N<span class="_ _1d"></span><span class="ls0">ULL; <span class="_ _82"> </span>/*<span class="_"> </span>error, record not found */</span></span></div><div class="t m0 x32 h57 y33b3 ff1a fs2d fc0 sc0 ls0 ws0">218 <span class="_ _186"> </span>db-&gt;cnt_fetcherr++;</div><div class="t m0 x32 h57 y33b4 ff1a fs2d fc0 sc0 ls0 ws0">219 <span class="_ _15"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y33b5 ff1a fs2d fc0 sc0 ls0 ws0">220 <span class="_ _186"> </span>ptr<span class="_"> </span><span class="ls15c">=_<span class="_ _1d"></span><span class="ls0">db_readdat(db); <span class="_"> </span>/*<span class="_"> </span>return pointer to data */</span></span></div><div class="t m0 x32 h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">221 <span class="_ _186"> </span>db-&gt;cnt_fetchok++;</div><div class="t m0 x32 h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">222 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y5750 ff1a fs2d fc0 sc0 ls0 ws0">223 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y5751 ff1a fs2d fc0 sc0 ls0 ws0">224 <span class="_ _8a"> </span>*<span class="_"> </span>Unlock the hash chain that _db_find_and_lock locked.</div><div class="t m0 x32 h57 y5752 ff1a fs2d fc0 sc0 ls0 ws0">225 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y5753 ff1a fs2d fc0 sc0 ls0 ws0">226 <span class="_ _15"> </span>if<span class="_"> </span>(un_lock(db-&gt;idxfd, db-&gt;chainoff, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y5754 ff1a fs2d fc0 sc0 ls0 ws0">227 <span class="_ _186"> </span>err_dump(&quot;db_fetch:<span class="_"> </span>un_lock error&quot;);</div><div class="t m0 x32 h57 y5755 ff1a fs2d fc0 sc0 ls0 ws0">228 <span class="_ _15"> </span>return(ptr);</div><div class="t m0 x32 h57 y5756 ff1a fs2d fc0 sc0 ls0 ws0">229 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h49 y5757 ff19 fs26 fc0 sc0 ls0 ws0">[200 <span class="_ _a"></span>– <span class="_ _a"></span>207]<span class="_ _65"> </span>Next, <span class="_ _9"></span>we <span class="_ _23"></span>fr<span class="_ _0"></span>ee <span class="_ _9"></span>any <span class="_ _23"></span>dynamically <span class="_ _9"></span>allocated <span class="_ _9"></span>buffers. <span class="_ _45"> </span>W<span class="_ _6"></span><span class="lsf80">ec<span class="_ _b"></span><span class="ls0">an <span class="_ _9"></span>safely <span class="_ _23"></span>pass <span class="_ _9"></span>a <span class="_ _23"></span>null</span></span></div><div class="t m0 x11a h4d y5758 ff19 fs26 fc0 sc0 ls0 ws0">pointer <span class="_ _3"></span>to<span class="_ _45"> </span><span class="ff1a">free</span>,<span class="_ _47"> </span>so<span class="_ _45"> </span>we<span class="_ _47"> </span>d<span class="_ _2"></span>on’t <span class="_ _3"></span>need <span class="_ _9"></span>to <span class="_ _3"></span>check <span class="_ _9"></span>the <span class="_ _9"></span>value <span class="_ _3"></span>of <span class="_ _9"></span>each <span class="_ _3"></span>buffer <span class="_ _3"></span>pointer</div><div class="t m0 x11a h49 y5759 ff19 fs26 fc0 sc0 ls0 ws0">beforehand, <span class="_ _2"></span>but <span class="_ _3"></span>we <span class="_ _3"></span>do <span class="_ _2"></span>so <span class="_ _3"></span>anyway <span class="_ _3"></span>because <span class="_ _3"></span>we <span class="_ _3"></span>consider <span class="_ _3"></span>it <span class="_ _3"></span>better <span class="_ _3"></span>style <span class="_ _3"></span>to <span class="_ _2"></span>free</div><div class="t m0 x11a h49 y575a ff19 fs26 fc0 sc0 ls0 ws0">only <span class="_ _42"> </span>those <span class="_ _53"> </span>objects <span class="_ _53"> </span>that <span class="_ _53"> </span>we <span class="_ _42"> </span>allocated.<span class="_ _65"> </span>(Not <span class="_ _53"> </span>all <span class="_ _42"> </span>deallocator <span class="_ _53"> </span>functions <span class="_ _53"> </span>ar<span class="ls127c">ea<span class="_ _c"></span><span class="ls0">s</span></span></div><div class="t m0 x11a h4d y575b ff19 fs26 fc0 sc0 ls0 ws0">forgiving as<span class="_"> </span><span class="ff1a">free</span>.) <span class="_"> </span>Finally<span class="_ _4"></span>,<span class="_"> </span>we<span class="_"> </span>f<span class="lscc">re<span class="lsd3">et<span class="_ _5"></span><span class="ls0">he memory backing the<span class="_"> </span><span class="ff1a">DB<span class="_ _80"> </span></span>structure.</span></span></span></div><div class="t m0 x32 h4d y575c ff19 fs26 fc0 sc0 ls0 ws0">[208 <span class="_ _a"></span>– <span class="_ _a"></span>218]<span class="_ _65"> </span>The<span class="_"> </span><span class="ff1a">db_fetch<span class="_ _66"> </span></span>function <span class="_ _2"></span>is <span class="_ _2"></span>used <span class="_ _2"></span>to read a <span class="_ _2"></span>recor<span class="lsd7">dg<span class="_ _8"></span><span class="ls0">iven <span class="_ _2"></span>its <span class="_ _2"></span>key<span class="_ _4"></span><span class="ls1678">.W<span class="_ _26"></span><span class="lsd7">eﬁ<span class="_ _d"></span><span class="ls0">rst <span class="_ _2"></span>try <span class="_ _2"></span>to</span></span></span></span></span></div><div class="t m0 x11a h4d y575d ff19 fs26 fc0 sc0 ls0 ws0">ﬁnd <span class="_"> </span>the <span class="_ _66"> </span>record<span class="_ _59"> </span>by<span class="_ _61"> </span>calling<span class="_ _46"> </span><span class="ff1a">_db_find_and_lock</span><span class="ls1679">.I<span class="_ _49"></span><span class="ls167a">ft<span class="_ _4a"></span><span class="ls0">he <span class="_"> </span>recor<span class="ls167a">dc<span class="_ _1d"></span><span class="ls0">an’t <span class="_ _66"> </span>be</span></span></span></span></span></div><div class="t m0 x11a h4d y575e ff19 fs26 fc0 sc0 ls0 ws0">found, <span class="_ _42"> </span>we <span class="_ _42"> </span>set <span class="_ _42"> </span>the <span class="_ _42"> </span>return <span class="_ _42"> </span>value <span class="_ _42"> </span>(<span class="ff1a">ptr</span><span class="ls167b">)t<span class="_ _43"></span><span class="ls0">o<span class="_ _35"> </span><span class="ff1a">NULL<span class="_ _44"> </span></span>and <span class="_ _42"> </span>increment <span class="_ _42"> </span>the <span class="_ _42"> </span>count <span class="_ _42"> </span>of</span></span></div><div class="t m0 x11a h4d y575f ff19 fs26 fc0 sc0 ls0 ws0">unsuccessful <span class="_ _23"> </span>recor<span class="ls167c">ds<span class="_ _43"></span><span class="ls0">ear<span class="_ _0"></span>ches. <span class="_ _35"> </span>Because<span class="_ _35"> </span><span class="ff1a">_db_find_and_lock<span class="_ _44"> </span></span><span class="lscc">re</span>turns <span class="_ _42"> </span>with</span></span></div><div class="t m0 x11a h49 y5760 ff19 fs26 fc0 sc0 ls0 ws0">the database index ﬁle locked, we can’t return until we unlock it.</div><div class="t m0 x32 h4d y5761 ff19 fs26 fc0 sc0 ls0 ws0">[219 <span class="_ _a"></span>– <span class="_ _a"></span>229]<span class="_ _65"> </span>If <span class="_ _2"></span>the <span class="_ _2"></span>record<span class="_"> </span>is<span class="_ _47"> </span>found, <span class="_ _2"></span>we <span class="_ _3"></span>call<span class="_ _66"> </span><span class="ff1a">_db_readdat<span class="_ _47"> </span></span>to <span class="_ _2"></span>read <span class="_ _2"></span>the <span class="_ _2"></span>corresponding <span class="_ _2"></span>data</div><div class="t m0 x11a h49 y5762 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cor<span class="ls167d">da<span class="_ _55"></span><span class="ls0">nd <span class="_ _e"> </span>increment <span class="_ _53"> </span>the <span class="_ _e"> </span>count <span class="_ _e"> </span>of <span class="_ _e"> </span>the <span class="_ _e"> </span>successful <span class="_ _e"> </span>recor<span class="_ _0"></span><span class="ls167d">ds<span class="_ _55"></span><span class="ls0">earches. <span class="_ _4b"> </span>Before</span></span></span></span></span></div><div class="t m0 x11a h4d y5763 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turning, <span class="_ _23"> </span>we <span class="_ _23"> </span>unlock <span class="_ _23"> </span>the <span class="_ _23"></span>index <span class="_ _23"></span>ﬁle <span class="_ _23"></span>by <span class="_ _23"></span>calling<span class="_ _45"> </span><span class="ff1a">un_lock</span><span class="ls167e">.T<span class="_ _26"></span><span class="ls0">hen <span class="_ _23"> </span>we <span class="_ _23"></span>return <span class="_ _9"></span>a</span></span></span></div><div class="t m0 x11a h4d y5764 ff19 fs26 fc0 sc0 ls0 ws0">pointer to the recor<span class="_ _0"></span><span class="lsd3">df<span class="_ _d"></span><span class="ls0">ound (or<span class="_"> </span><span class="ff1a">NULL<span class="_ _80"> </span></span>if the recor<span class="lsd3">dw<span class="_ _4f"></span><span class="ls0">asn’t found).</span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
