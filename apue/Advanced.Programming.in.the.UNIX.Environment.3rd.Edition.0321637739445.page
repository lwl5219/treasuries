<div id="pf1bd" class="pf w4 h1f" data-page-no="1bd"><div class="pc pc1bd w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg1bd.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>1<span class="_ _1"></span>1.6 <span class="_ _286"> </span>Thread <span class="_"> </span>Synchr<span class="_ _0"></span>onization<span class="_ _1b"> </span><span class="ff18">41<span class="_ _0"></span>1</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">pthread_t <span class="_ _d9"> </span>j_id; <span class="_ _3a"> </span>/*<span class="_"> </span>tells which thread handles this job */</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">/* ... more stuff here ... */</div><div class="t m0 x32 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h57 yae9 ff1a fs2d fc0 sc0 ls0 ws0">struct queue {</div><div class="t m0 x8a h57 yaea ff1a fs2d fc0 sc0 ls0 ws0">struct job<span class="_ _189"> </span>*q_head;</div><div class="t m0 x8a h57 yaeb ff1a fs2d fc0 sc0 ls0 ws0">struct job<span class="_ _189"> </span>*q_tail;</div><div class="t m0 x8a h57 y16f9 ff1a fs2d fc0 sc0 ls0 ws0">pthread_rwlock_t q_lock;</div><div class="t m0 x32 h57 y16df ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h57 y340d ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h57 y340e ff1a fs2d fc0 sc0 ls15c ws0">*I<span class="_ _1d"></span><span class="ls0">nitialize a queue.</span></div><div class="t m0 x140 h57 y16fa ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h57 y340f ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y3410 ff1a fs2d fc0 sc0 ls0 ws0">queue_init(struct queue *qp)</div><div class="t m0 x32 h57 y3411 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y3412 ff1a fs2d fc0 sc0 ls0 ws0">int err;</div><div class="t m0 x8a h57 y16ff ff1a fs2d fc0 sc0 ls0 ws0">qp-&gt;q_head = NULL;</div><div class="t m0 x8a h57 y3413 ff1a fs2d fc0 sc0 ls0 ws0">qp-&gt;q_tail = NULL;</div><div class="t m0 x8a h57 y3414 ff1a fs2d fc0 sc0 ls0 ws0">err = pthread_rwlock_init(&amp;qp-&gt;q_lock, NULL);</div><div class="t m0 x8a h57 y3415 ff1a fs2d fc0 sc0 ls0 ws0">if (err != 0)</div><div class="t m0 x9d h57 y3416 ff1a fs2d fc0 sc0 ls0 ws0">return(err);</div><div class="t m0 x8a h57 y3417 ff1a fs2d fc0 sc0 ls0 ws0">/* ... continue initialization ... */</div><div class="t m0 x8a h57 y3418 ff1a fs2d fc0 sc0 ls0 ws0">return(0);</div><div class="t m0 x32 h57 y16ed ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y131d ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h57 y131e ff1a fs2d fc0 sc0 ls15c ws0">*I<span class="_ _1d"></span><span class="ls0">nsert a job at the head of the queue.</span></div><div class="t m0 x140 h57 y131f ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h57 y1320 ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h57 y1321 ff1a fs2d fc0 sc0 ls0 ws0">job_insert(struct queue *qp, struct job *jp)</div><div class="t m0 x32 h57 y1322 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y3419 ff1a fs2d fc0 sc0 ls0 ws0">pthread_rwlock_wrlock(&amp;qp-&gt;q_lock);</div><div class="t m0 x8a h57 y341a ff1a fs2d fc0 sc0 ls0 ws0">jp-&gt;j_next = qp-&gt;q_head;</div><div class="t m0 x8a h57 y341b ff1a fs2d fc0 sc0 ls0 ws0">jp-&gt;j_prev = NULL;</div><div class="t m0 x8a h57 y341c ff1a fs2d fc0 sc0 ls0 ws0">if (qp-&gt;q_head != NULL)</div><div class="t m0 x9d h57 y341d ff1a fs2d fc0 sc0 ls0 ws0">qp-&gt;q_head-&gt;j_prev = jp;</div><div class="t m0 x8a h57 y338a ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 x9d h57 y338b ff1a fs2d fc0 sc0 ls0 ws0">qp-&gt;q_tail = jp;<span class="_ _15"> </span>/* list was empty */</div><div class="t m0 x8a h57 y338c ff1a fs2d fc0 sc0 ls0 ws0">qp-&gt;q_head = jp;</div><div class="t m0 x8a h57 y338d ff1a fs2d fc0 sc0 ls0 ws0">pthread_rwlock_unlock(&amp;qp-&gt;q_lock);</div><div class="t m0 x32 h57 y338e ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y3361 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h57 y3362 ff1a fs2d fc0 sc0 ls15c ws0">*A<span class="_ _1d"></span><span class="ls0">ppend a job on the tail of the queue.</span></div><div class="t m0 x140 h57 y3363 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h57 y3364 ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h57 y3365 ff1a fs2d fc0 sc0 ls0 ws0">job_append(struct queue *qp, struct job *jp)</div><div class="t m0 x32 h57 y3366 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y338f ff1a fs2d fc0 sc0 ls0 ws0">pthread_rwlock_wrlock(&amp;qp-&gt;q_lock);</div><div class="t m0 x8a h57 y3390 ff1a fs2d fc0 sc0 ls0 ws0">jp-&gt;j_next = NULL;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
