<div id="pf1fc" class="pf w4 h1f" data-page-no="1fc"><div class="pc pc1fc w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1fc.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">474<span class="_ _1b"> </span><span class="ff19">Daemon <span class="_"> </span>Processes <span class="_ _20f"> </span>Chapter<span class="_ _4b"> </span>13</span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">already_running(void)</div><div class="t m0 x32 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>fd;</div><div class="t m0 x8a h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>buf[16];</div><div class="t m0 x8a h57 y3509 ff1a fs2d fc0 sc0 ls0 ws0">fd = open(LOCKFILE, O_RDWR|O_CREAT, LOCKMODE);</div><div class="t m0 x8a h57 y350a ff1a fs2d fc0 sc0 ls0 ws0">if (fd &lt; 0) {</div><div class="t m0 x9d h57 y350b ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_ERR, &quot;can’t open %s: %s&quot;, LOCKFILE, strerror(errno));</div><div class="t m0 x9d h57 y350c ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y350d ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y31b6 ff1a fs2d fc0 sc0 ls0 ws0">if (lockfile(fd) &lt; 0) {</div><div class="t m0 x9d h57 y31b7 ff1a fs2d fc0 sc0 ls0 ws0">if (errno == EACCES || errno == EAGAIN) {</div><div class="t m0 x1f h57 y31b8 ff1a fs2d fc0 sc0 ls0 ws0">close(fd);</div><div class="t m0 x1f h57 y31b9 ff1a fs2d fc0 sc0 ls0 ws0">return(1);</div><div class="t m0 x9d h57 y31ba ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y31bb ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_ERR, &quot;can’t lock %s: %s&quot;, LOCKFILE, strerror(errno));</div><div class="t m0 x9d h57 y2f71 ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y2f72 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y2f73 ff1a fs2d fc0 sc0 ls0 ws0">ftruncate(fd, 0);</div><div class="t m0 x8a h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">sprintf(buf, &quot;%ld&quot;, (long)getpid());</div><div class="t m0 x8a h57 y8e1 ff1a fs2d fc0 sc0 ls0 ws0">write(fd, buf, strlen(buf)+1);</div><div class="t m0 x8a h57 y2f74 ff1a fs2d fc0 sc0 ls0 ws0">return(0);</div><div class="t m0 x32 h57 y2f75 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xe7 h2d y3a9e ff18 fs10 fc0 sc0 ls0 ws0">Figure 13.6<span class="_ _5a"> </span><span class="ff19">Ensur<span class="ls136">et<span class="_ _84"></span><span class="ls0">hat only one copy of a daemon is running</span></span></span></div><div class="t m0 x3f h49 y3a9f ff19 fs26 fc0 sc0 ls0 ws0">Each <span class="_ _2"></span>copy <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>daemon <span class="_ _3"></span>will <span class="_ _2"></span>try <span class="_ _3"></span>to <span class="_ _3"></span>create <span class="_ _2"></span>a <span class="_ _3"></span>ﬁle <span class="_ _3"></span>and <span class="_ _3"></span>write <span class="_ _3"></span>its <span class="_ _2"></span>process <span class="_ _2"></span>ID <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle.</div><div class="t m0 x32 h49 y3aa0 ff19 fs26 fc0 sc0 ls0 ws0">This will <span class="_ _2"></span>allow <span class="_ _2"></span>administrators <span class="_ _2"></span>to <span class="_ _2"></span>identify <span class="_ _2"></span>the <span class="_ _2"></span>process easily<span class="_ _6"></span><span class="lsf92">.I<span class="_ _5b"></span><span class="lsf93">ft<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>ﬁle <span class="_ _2"></span>is <span class="_ _2"></span>already locked,</span></span></span></div><div class="t m0 x32 h4d y3aa1 ff19 fs26 fc0 sc0 ls0 ws0">the<span class="_ _47"> </span><span class="ff1a">lockfile<span class="_ _47"> </span></span>function <span class="_ _9"></span>will <span class="_ _3"></span>fail <span class="_ _3"></span>with<span class="_ _45"> </span><span class="ff1a">errno<span class="_ _47"> </span></span>set <span class="_ _3"></span>to<span class="_ _47"> </span><span class="ff1a">EACCES<span class="_ _45"> </span></span>or<span class="_ _47"> </span><span class="ff1a">EAGAIN</span>,<span class="_ _47"> </span>so<span class="_ _45"> </span>we<span class="_ _47"> </span>return <span class="_ _2"></span>1,</div><div class="t m0 x32 h49 y3aa2 ff19 fs26 fc0 sc0 ls0 ws0">indicating <span class="_ _23"> </span>that <span class="_ _23"> </span>the <span class="_ _42"> </span>daemon <span class="_ _23"></span>is <span class="_ _23"> </span>already <span class="_ _23"></span>running. <span class="_ _35"> </span>Otherwise,<span class="_ _35"> </span>we <span class="_ _23"></span>truncate <span class="_ _23"></span>the <span class="_ _23"> </span>ﬁle, <span class="_ _23"> </span>write</div><div class="t m0 x32 h49 y3aa3 ff19 fs26 fc0 sc0 ls0 ws0">our process ID to it, and r<span class="_ _0"></span>eturn 0.</div><div class="t m0 x3f h49 y3aa4 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _45"> </span>n<span class="_ _9"></span><span class="ls0">eed <span class="_ _42"> </span>to <span class="_ _42"> </span>truncate <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle, <span class="_ _42"> </span>because <span class="_ _42"> </span>the <span class="_ _42"> </span>pr<span class="_ _0"></span>evious <span class="_ _42"> </span>instance <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>daemon <span class="_ _42"> </span>might</span></div><div class="t m0 x32 h49 y3aa5 ff19 fs26 fc0 sc0 ls0 ws0">have <span class="_ _3"></span>had <span class="_ _3"></span>a <span class="_ _3"></span>process <span class="_ _3"></span>ID <span class="_ _3"></span>larger <span class="_ _3"></span>than <span class="_ _3"></span>ours, <span class="_ _3"></span>with <span class="_ _3"></span>a <span class="_ _9"></span>larger <span class="_ _2"></span>string <span class="_ _3"></span>length.<span class="_ _16"> </span>For <span class="_ _3"></span>example, <span class="_ _9"></span>if <span class="_ _3"></span>the</div><div class="t m0 x32 h49 y3aa6 ff19 fs26 fc0 sc0 ls0 ws0">previous instance <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>daemon <span class="_ _3"></span>was <span class="_ _2"></span>process <span class="_ _2"></span>ID <span class="_ _3"></span>12345, <span class="_ _3"></span>and <span class="_ _2"></span>the <span class="_ _3"></span>new <span class="_ _2"></span>instance <span class="_ _3"></span>is <span class="_ _2"></span>process</div><div class="t m0 x32 h49 y3aa7 ff19 fs26 fc0 sc0 ls0 ws0">ID <span class="_ _3"></span>9999, <span class="_ _3"></span>when <span class="_ _9"></span>we <span class="_ _3"></span>write <span class="_ _3"></span>the <span class="_ _9"></span>process <span class="_ _2"></span>ID <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle, <span class="_ _9"></span>we <span class="_ _3"></span>will <span class="_ _3"></span>be <span class="_ _9"></span>left <span class="_ _3"></span>with <span class="_ _3"></span>99995 <span class="_ _9"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle.</div><div class="t m0 x32 h49 y3aa8 ff19 fs26 fc0 sc0 lsf94 ws0">Tr <span class="_ _6"></span>u<span class="_ _9"></span><span class="ls0">ncating <span class="_ _2"></span>the <span class="_ _3"></span>ﬁle <span class="_ _2"></span>prevents data <span class="_ _3"></span>from the <span class="_ _2"></span>previous <span class="_ _2"></span>daemon <span class="_ _2"></span>appearing <span class="_ _2"></span>as <span class="_ _2"></span>if <span class="_ _2"></span>it <span class="_ _3"></span>applies <span class="_ _2"></span>to</span></div><div class="t m0 x32 h49 y3aa9 ff19 fs26 fc0 sc0 ls0 ws0">the current daemon.</div><div class="t m0 x35 h99 y3aaa ff16 fs3b fc0 sc0 ls0 ws0">13.6 <span class="_ _93"> </span>Daemon<span class="_ _54"> </span>Con<span class="_ _1"></span>ventions</div><div class="t m0 x32 h55 y3aab ff19 fs2c fc0 sc0 ls0 ws0">Several common conventions ar<span class="ls142">ef<span class="_ _4f"></span><span class="ls0">ollowed by daemons in the UNIX System.</span></span></div><div class="t m0 x3f h54 y3aac ff19 fs2c fc0 sc0 ls237 ws0">•I<span class="_ _4d"></span><span class="lsf95">ft<span class="_ _c"></span><span class="ls0">he <span class="_ _53"> </span>daemon <span class="_ _53"> </span>uses <span class="_ _53"> </span>a <span class="_ _53"> </span>lock <span class="_ _53"> </span>ﬁle, <span class="_ _53"> </span>the <span class="_ _53"> </span>ﬁle <span class="_ _53"> </span>is <span class="_ _53"> </span>usually <span class="_ _53"> </span>stored <span class="_ _53"> </span>in<span class="_ _44"> </span><span class="ff1a">/var/run</span><span class="lsf96">.N<span class="_ _52"></span><span class="ls0">ote,</span></span></span></span></div><div class="t m0 x15 h55 y3aad ff19 fs2c fc0 sc0 ls0 ws0">however<span class="_ _6"></span><span class="lsf97">,t<span class="_ _55"></span><span class="ls0">hat <span class="_"> </span>the <span class="_ _53"> </span>daemon <span class="_ _e"> </span>might <span class="_"> </span>need <span class="_ _53"> </span>superuser <span class="_ _e"> </span>permissions <span class="_ _e"> </span>to <span class="_ _e"> </span>create <span class="_ _53"> </span>a <span class="_"> </span>ﬁle</span></span></div><div class="t m0 x15 h54 y3aae ff19 fs2c fc0 sc0 ls0 ws0">here. <span class="_ _47"> </span>The<span class="_ _45"> </span>name <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>is <span class="_ _9"></span>usually<span class="_ _45"> </span><span class="ff1b">name<span class="ff1a">.pid</span></span><span class="lsf98">,w<span class="_ _b"></span><span class="ls0">here<span class="_ _45"> </span><span class="ff1b">name<span class="_ _47"> </span></span>is <span class="_ _9"></span>the <span class="_ _9"></span>name <span class="_ _9"></span>of <span class="_ _9"></span>the</span></span></div><div class="t m0 x15 h54 y3aaf ff19 fs2c fc0 sc0 ls0 ws0">daemon <span class="_ _3"></span>or <span class="_ _2"></span>the <span class="_ _3"></span>service.<span class="_ _16"> </span>For <span class="_ _3"></span>example, <span class="_ _3"></span>on <span class="_ _3"></span>Linux, <span class="_ _3"></span>the <span class="_ _3"></span>name <span class="_ _3"></span>of <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">cron<span class="_ _47"> </span></span>daemon’s</div><div class="t m0 x15 h54 y3ab0 ff19 fs2c fc0 sc0 ls0 ws0">lock ﬁle is<span class="_"> </span><span class="ff1a">/var/run/crond.pid</span>.</div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892842px;bottom:309.514818px;width:162.204590px;height:19.679992px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
