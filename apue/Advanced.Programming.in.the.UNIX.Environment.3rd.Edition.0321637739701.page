<div id="pf2bd" class="pf w4 h1f" data-page-no="2bd"><div class="pc pc2bd w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2bd.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.6<span class="_ _67"> </span>An <span class="_"> </span>Open <span class="_"> </span>Server<span class="_ _6"></span><span class="ls30a">,V<span class="_ _1d"></span><span class="ls0">ersion <span class="_"> </span>2<span class="_ _1b"> </span><span class="ff18">667</span></span></span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; NALLOC; i++) {</div><div class="t m0 x9d h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">pollfd[i].fd = -1;</div><div class="t m0 x9d h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">pollfd[i].events = POLLIN;</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">pollfd[i].revents = 0;</div><div class="t m0 x8a h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">/* obtain fd to listen for client requests on */</div><div class="t m0 x8a h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">if ((listenfd = serv_listen(CS_OPEN)) &lt; 0)</div><div class="t m0 x9d h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">log_sys(&quot;serv_listen error&quot;);</div><div class="t m0 x8a h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">client_add(listenfd, 0);<span class="_ _15"> </span>/* we use [0] for listenfd */</div><div class="t m0 x8a h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">pollfd[0].fd = listenfd;</div><div class="t m0 x8a h57 y31b7 ff1a fs2d fc0 sc0 ls0 ws0">for ( ; ; ) {</div><div class="t m0 x9d h57 y31b8 ff1a fs2d fc0 sc0 ls0 ws0">if (poll(pollfd, numfd, -1) &lt; 0)</div><div class="t m0 x1f h57 y31b9 ff1a fs2d fc0 sc0 ls0 ws0">log_sys(&quot;poll error&quot;);</div><div class="t m0 x9d h57 y3412 ff1a fs2d fc0 sc0 ls0 ws0">if (pollfd[0].revents &amp; POLLIN) {</div><div class="t m0 x1f h57 y3811 ff1a fs2d fc0 sc0 ls0 ws0">/* accept new client request */</div><div class="t m0 x1f h57 y3812 ff1a fs2d fc0 sc0 ls0 ws0">if ((clifd = serv_accept(listenfd, &amp;uid)) &lt; 0)</div><div class="t m0 x1ca h57 y3813 ff1a fs2d fc0 sc0 ls0 ws0">log_sys(&quot;serv_accept error: %d&quot;, clifd);</div><div class="t m0 x1f h57 y3814 ff1a fs2d fc0 sc0 ls0 ws0">client_add(clifd, uid);</div><div class="t m0 x1f h57 y351f ff1a fs2d fc0 sc0 ls0 ws0">/* possibly increase the size of the pollfd array */</div><div class="t m0 x1f h57 y3520 ff1a fs2d fc0 sc0 ls0 ws0">if (numfd == maxfd)</div><div class="t m0 x1ca h57 y42b2 ff1a fs2d fc0 sc0 ls0 ws0">pollfd = grow_pollfd(pollfd, &amp;maxfd);</div><div class="t m0 x1f h57 y42b3 ff1a fs2d fc0 sc0 ls0 ws0">pollfd[numfd].fd = clifd;</div><div class="t m0 x1f h57 y42b4 ff1a fs2d fc0 sc0 ls0 ws0">pollfd[numfd].events = POLLIN;</div><div class="t m0 x1f h57 y38bf ff1a fs2d fc0 sc0 ls0 ws0">pollfd[numfd].revents = 0;</div><div class="t m0 x1f h57 y38c0 ff1a fs2d fc0 sc0 ls0 ws0">numfd++;</div><div class="t m0 x1f h57 y38c1 ff1a fs2d fc0 sc0 ls0 ws0">log_msg(&quot;new connection: uid %d, fd %d&quot;, uid, clifd);</div><div class="t m0 x9d h57 y42b5 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y38c3 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 1; i &lt; numfd; i++) {</div><div class="t m0 x1f h57 y38c4 ff1a fs2d fc0 sc0 ls0 ws0">if (pollfd[i].revents &amp; POLLHUP) {</div><div class="t m0 x1ca h57 y38c5 ff1a fs2d fc0 sc0 ls0 ws0">goto hungup;</div><div class="t m0 x1f h57 y42b6 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pollfd[i].revents &amp; POLLIN) {</span></div><div class="t m0 x1ca h57 y42b7 ff1a fs2d fc0 sc0 ls0 ws0">/* read argument buffer from client */</div><div class="t m0 x1ca h57 y42b8 ff1a fs2d fc0 sc0 ls0 ws0">if ((nread = read(pollfd[i].fd, buf, MAXLINE)) &lt; 0) {</div><div class="t m0 x36 h57 y42b9 ff1a fs2d fc0 sc0 ls0 ws0">log_sys(&quot;read error on fd %d&quot;, pollfd[i].fd);</div><div class="t m0 x1ca h57 y42ba ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (nread == 0) {</span></div><div class="t m0 x32 h57 y42bb ff1a fs2d fc0 sc0 ls0 ws0">hungup:</div><div class="t m0 x36 h57 y42bc ff1a fs2d fc0 sc0 ls0 ws0">/* the client closed the connection */</div><div class="t m0 x36 h57 y42bd ff1a fs2d fc0 sc0 ls0 ws0">log_msg(&quot;closed: uid %d, fd %d&quot;,</div><div class="t m0 x1f7 h57 y42be ff1a fs2d fc0 sc0 ls0 ws0">client[i].uid, pollfd[i].fd);</div><div class="t m0 x36 h57 y4d02 ff1a fs2d fc0 sc0 ls0 ws0">client_del(pollfd[i].fd);</div><div class="t m0 x36 h57 y4d03 ff1a fs2d fc0 sc0 ls0 ws0">close(pollfd[i].fd);</div><div class="t m0 x36 h57 y4d04 ff1a fs2d fc0 sc0 ls0 ws0">if (i &lt; (numfd-1)) {</div><div class="t m0 xee h57 y4e5d ff1a fs2d fc0 sc0 ls0 ws0">/* pack the array */</div><div class="t m0 xee h57 y4e5e ff1a fs2d fc0 sc0 ls0 ws0">pollfd[i].fd = pollfd[numfd-1].fd;</div><div class="t m0 xee h57 y4e5f ff1a fs2d fc0 sc0 ls0 ws0">pollfd[i].events = pollfd[numfd-1].events;</div><div class="t m0 xee h57 y4e60 ff1a fs2d fc0 sc0 ls0 ws0">pollfd[i].revents = pollfd[numfd-1].revents;</div><div class="t m0 xee h57 y4e61 ff1a fs2d fc0 sc0 ls0 ws0">i--; <span class="_ _68"> </span>/*<span class="_"> </span>recheck this entry */</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
