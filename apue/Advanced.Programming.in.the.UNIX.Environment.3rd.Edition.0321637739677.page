<div id="pf2a5" class="pf w4 h1f" data-page-no="2a5"><div class="pc pc2a5 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg2a5.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.4<span class="_ _284"> </span>Passing <span class="_"> </span>File <span class="_"> </span>Descriptors<span class="_ _1fb"> </span><span class="ff18">643</span></div><div class="t m0 x14b h51 y1ed4 ff19 fs2a fc0 sc0 ls0 ws0">process table entry</div><div class="t m0 x7a hee y4c07 ff19 fs82 fc0 sc0 ls945 ws0">...</div><div class="t m0 x33 h9f y3653 ff19 fs39 fc0 sc0 ls0 ws0">fd 0:</div><div class="t m0 x33 h9f y4c08 ff19 fs39 fc0 sc0 ls0 ws0">fd 1:</div><div class="t m0 x33 h9f y4c09 ff19 fs39 fc0 sc0 ls0 ws0">fd 2:</div><div class="t m0 x33 h9f y4c0a ff19 fs39 fc0 sc0 ls0 ws0">fd 3:</div><div class="t m0 xc4 h81 y4c0b ff19 fs3f fc0 sc0 ls0 ws0">fd</div><div class="t m0 x1a7 h81 y4c0c ff19 fs3f fc0 sc0 ls0 ws0">ﬂags</div><div class="t m0 xdf h81 y4c0b ff19 fs3f fc0 sc0 ls0 ws0">ﬁle</div><div class="t m0 x137 h81 y4c0c ff19 fs3f fc0 sc0 ls0 ws0">pointer</div><div class="t m0 x14b h2f y4c0d ff19 fs12 fc0 sc0 ls0 ws0">process table entry</div><div class="t m0 x7a hef y4c0e ff19 fs83 fc0 sc0 ls946 ws0">...</div><div class="t m0 x33 ha0 y4c0f ff19 fs4c fc0 sc0 ls0 ws0">fd 0:</div><div class="t m0 x33 ha0 y4c10 ff19 fs4c fc0 sc0 ls0 ws0">fd 1:</div><div class="t m0 x33 ha0 y4c11 ff19 fs4c fc0 sc0 ls0 ws0">fd 2:</div><div class="t m0 x33 ha0 y4c12 ff19 fs4c fc0 sc0 ls0 ws0">fd 3:</div><div class="t m0 x33 ha0 y4c13 ff19 fs4c fc0 sc0 ls0 ws0">fd 4:</div><div class="t m0 xc4 h8b y4c14 ff19 fs46 fc0 sc0 ls0 ws0">fd</div><div class="t m0 x1a7 h8b y4c15 ff19 fs46 fc0 sc0 ls0 ws0">ﬂags</div><div class="t m0 xdf h8b y4c14 ff19 fs46 fc0 sc0 ls0 ws0">ﬁle</div><div class="t m0 x137 h8b y4c15 ff19 fs46 fc0 sc0 ls0 ws0">pointer</div><div class="t m0 x1f5 h32 y4c16 ff19 fs15 fc0 sc0 ls0 ws0">ﬁle status ﬂags</div><div class="t m0 x10f h33 y4065 ff19 fs16 fc0 sc0 ls0 ws0">current ﬁle of<span class="_ _0"></span>fset</div><div class="t m0 x1f5 h83 y4c17 ff19 fs36 fc0 sc0 ls0 ws0">v-node pointer</div><div class="t m0 x207 h83 y4c18 ff19 fs36 fc0 sc0 ls0 ws0">ﬁle table</div><div class="t m0 x44 hb1 y4c19 ff19 fs5b fc0 sc0 ls0 ws0">v-node information</div><div class="t m0 x151 h16d y4c1a ff1a fs5b fc0 sc0 ls0 ws0">v_data</div><div class="t m0 x111 hb1 y4c1b ff19 fs5b fc0 sc0 ls0 ws0">i-node information</div><div class="t m0 x119 hb1 y4c1c ff19 fs5b fc0 sc0 ls0 ws0">current ﬁle size</div><div class="t m0 x16f h16d y4c1d ff1a fs5b fc0 sc0 ls0 ws0">i_vnode</div><div class="t m0 x13b h36 y4c1e ff19 fs19 fc0 sc0 ls0 ws0">v-node table</div><div class="t m0 x1b0 h39 y4c1f ff18 fs1c fc0 sc0 ls0 ws0">Figure 17.1<span class="_ _0"></span>1<span class="_ _5a"> </span><span class="ff19">Passing an open ﬁle from the top process to the bottom pr<span class="_ _0"></span>ocess</span></div><div class="t m0 x3f h16e y4c20 ff19 fsc0 fc0 sc0 ls13c4 ws0">Ap<span class="_ _c"></span><span class="ls13c5">ro<span class="_ _2"></span><span class="ls0">cess <span class="_ _42"> </span>(normally <span class="_ _53"> </span>a <span class="_ _42"> </span>server) <span class="_ _42"> </span>that <span class="_ _53"> </span>wants <span class="_ _42"> </span>to <span class="_ _42"> </span>pass <span class="_ _53"> </span>a <span class="_ _42"> </span>descriptor <span class="_ _42"> </span>to <span class="_ _53"> </span>another <span class="_ _42"> </span>process</span></span></div><div class="t m0 x32 h16f y4c21 ff19 fsc0 fc0 sc0 ls0 ws0">calls <span class="_ _9"></span>either<span class="_ _45"> </span><span class="ff1a">send_fd<span class="_ _45"> </span></span>or<span class="_ _45"> </span><span class="ff1a">send_err</span><span class="ls13c6">.T<span class="_ _62"></span><span class="ls0">he <span class="_ _9"></span>process <span class="_ _9"></span>waiting <span class="_ _9"></span>to <span class="_ _9"></span>receive <span class="_ _9"></span>the <span class="_ _9"></span>descriptor <span class="_ _23"></span>(the</span></span></div><div class="t m0 x32 h16f y4c22 ff19 fsc0 fc0 sc0 ls0 ws0">client) calls<span class="_"> </span><span class="ff1a">recv_fd</span>.</div><div class="t m0 x3f h16f y4c23 ff19 fsc0 fc0 sc0 ls0 ws0">The<span class="_ _16"> </span><span class="ff1a">send_fd<span class="_ _16"> </span></span>function <span class="_ _45"> </span>sends <span class="_ _47"> </span>the <span class="_ _47"> </span>descriptor<span class="_ _5a"> </span><span class="ff1b">fd_to_send<span class="_ _16"> </span></span>across <span class="_ _47"> </span>using <span class="_ _47"> </span>the <span class="_ _45"> </span>UNIX</div><div class="t m0 x32 h16f y4c24 ff19 fsc0 fc0 sc0 ls0 ws0">domain <span class="_ _42"> </span>socket <span class="_ _42"> </span>repr<span class="_ _1"></span>esented <span class="_ _42"> </span>by<span class="_ _44"> </span><span class="ff1b">fd</span><span class="ls13c7">.T<span class="_ _52"></span><span class="ls0">he<span class="_ _44"> </span><span class="ff1a">send_err<span class="_ _35"> </span></span>function <span class="_ _42"> </span>sends <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1b">errmsg<span class="_ _35"> </span></span>using<span class="_ _44"> </span><span class="ff1b">fd</span>,</span></span></div><div class="t m0 x32 h170 y4c25 ff19 fsc0 fc0 sc0 ls0 ws0">followed by the<span class="_"> </span><span class="ff1b">status<span class="_"> </span></span>byte. <span class="_"> </span>The<span class="_"> </span>value of<span class="_"> </span><span class="ff1b">status<span class="_"> </span></span>must be in the range<span class="_"> </span><span class="ff20">−</span><span class="ls13c8">1t<span class="_ _d"></span><span class="ls0">hrough<span class="_"> </span><span class="ff20">−</span>255.</span></span></div><div class="t m0 x3f h16f y4c26 ff19 fsc0 fc0 sc0 ls0 ws0">Clients <span class="_ _45"> </span>call<span class="_ _5a"> </span><span class="ff1a">recv_fd<span class="_"> </span></span>to <span class="_ _45"> </span>r<span class="_ _0"></span>eceive <span class="_ _45"> </span>a <span class="_ _45"> </span>descriptor<span class="_ _6"></span><span class="ls13c9">.I<span class="_ _95"></span><span class="ls13ca">fa<span class="_ _62"></span><span class="ls0">ll <span class="_ _45"> </span>is <span class="_ _45"> </span>OK <span class="_ _45"> </span>(the <span class="_ _45"> </span>sender <span class="_ _45"> </span>called</span></span></span></div><div class="t m0 x32 h16f y4c27 ff1a fsc0 fc0 sc0 ls0 ws0">send_fd<span class="ff19">), <span class="_ _35"> </span>the <span class="_ _35"> </span>non-negative <span class="_ _35"> </span>descriptor <span class="_ _35"> </span>is <span class="_ _35"> </span>returned <span class="_ _35"> </span>as <span class="_ _35"> </span>the <span class="_ _35"> </span>value <span class="_ _35"> </span>of <span class="_ _35"> </span>the <span class="_ _35"> </span>function.</span></div><div class="t m0 x32 h16f y4c28 ff19 fsc0 fc0 sc0 ls0 ws0">Otherwise, the value <span class="_ _2"></span>returned is the<span class="_ _66"> </span><span class="ff1b">status<span class="_ _66"> </span></span>that was <span class="_ _2"></span>sent by<span class="_ _66"> </span><span class="ff1a">send_err</span></div><div class="t m0 x169 h16e y4c29 ff19 fsc0 fc0 sc0 ls0 ws0">(</div><div class="t m0 x16b h16e y4c28 ff19 fsc0 fc0 sc0 ls13cb ws0">an<span class="_ _4f"></span><span class="ls0">egative <span class="_ _2"></span>value</span></div><div class="t m0 x32 h16e y4c2a ff19 fsc0 fc0 sc0 ls0 ws0">in <span class="_ _2"></span>the <span class="_ _2"></span>range<span class="_ _47"> </span><span class="ff20">−</span><span class="ls13cc">1t<span class="_ _4f"></span><span class="ls0">hrough<span class="_"> </span><span class="ff20">−</span>255</span></span></div><div class="t m0 x72 h16e y4c2b ff19 fsc0 fc0 sc0 ls0 ws0">)</div><div class="t m0 x59 h16e y4c2a ff19 fsc0 fc0 sc0 ls13cd ws0">.A<span class="_ _1d"></span><span class="ls0">dditionally<span class="_ _6"></span>,<span class="_ _66"> </span>if<span class="_ _47"> </span>an<span class="_ _47"> </span>error message <span class="_ _2"></span>was <span class="_ _3"></span>sent <span class="_ _2"></span>by <span class="_ _3"></span>the <span class="_ _2"></span>server<span class="_ _1"></span>,</span></div><div class="t m0 x32 h170 y4c2c ff19 fsc0 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>client’s<span class="_ _35"> </span><span class="ff1b">userfunc<span class="_ _45"> </span></span>is <span class="_ _23"> </span>called <span class="_ _23"></span>to <span class="_ _9"></span>process <span class="_ _23"></span>the <span class="_ _9"></span>message.<span class="_ _51"> </span>The <span class="_ _9"></span>ﬁrst <span class="_ _23"> </span>argument <span class="_ _9"></span>to<span class="_ _35"> </span><span class="ff1b">userfunc<span class="_ _45"> </span></span>is</div><div class="t m0 x32 h16f y4c2d ff19 fsc0 fc0 sc0 ls0 ws0">the <span class="_"> </span>constant<span class="_ _46"> </span><span class="ff1a">STDERR_FILENO</span><span class="ls13ce">,f<span class="_ _4a"></span><span class="ls0">ollowed <span class="_"> </span>by <span class="_ _66"> </span>a <span class="_"> </span>pointer <span class="_ _66"> </span>to <span class="_ _66"> </span>the <span class="_ _66"> </span>error <span class="_"> </span>message <span class="_"> </span>and <span class="_ _66"> </span>its</span></span></div><div class="t m0 x32 h170 y4c2e ff19 fsc0 fc0 sc0 ls0 ws0">length. <span class="_ _44"> </span>The<span class="_ _44"> </span><span class="ls13c5">re<span class="_ _2"></span></span>turn <span class="_ _42"> </span>value <span class="_ _53"> </span>from<span class="_ _44"> </span><span class="ff1b">userfunc<span class="_ _44"> </span></span>is <span class="_ _42"> </span>the <span class="_ _53"> </span>number <span class="_ _42"> </span>of <span class="_ _53"> </span>bytes <span class="_ _42"> </span>written <span class="_ _53"> </span>or <span class="_ _53"> </span>a <span class="_ _42"> </span>negative</div><div class="t m0 x32 h16f y4c2f ff19 fsc0 fc0 sc0 ls0 ws0">number on error<span class="_ _6"></span><span class="ls13cf">.O<span class="_ _4a"></span><span class="ls0">ften, the client speciﬁes the normal<span class="_"> </span><span class="ff1a">write<span class="_ _80"> </span></span>function as the<span class="_"> </span><span class="ff1b">userfunc</span>.</span></span></div><div class="t m0 x3f h16e y4c30 ff19 fsc0 fc0 sc0 ls13d0 ws0">We <span class="_ _47"> </span>i<span class="_ _9"></span><span class="ls0">mplement <span class="_ _42"> </span>our <span class="_ _23"> </span>own <span class="_ _23"> </span>protocol <span class="_ _23"> </span>that <span class="_ _23"> </span>is <span class="_ _42"> </span>used <span class="_ _23"></span>by <span class="_ _23"> </span>these <span class="_ _23"> </span>three <span class="_ _23"> </span>functions.<span class="_ _51"> </span></span>To <span class="_ _45"> </span>s<span class="_ _9"></span><span class="ls0">end <span class="_ _23"> </span>a</span></div><div class="t m0 x32 h16f y4c31 ff19 fsc0 fc0 sc0 ls0 ws0">descriptor<span class="_ _6"></span>,<span class="_ _66"> </span><span class="ff1a">send_fd<span class="_ _66"> </span></span>sends two <span class="_ _2"></span>bytes of 0, <span class="_ _2"></span>followed by the <span class="_ _2"></span>actual descriptor<span class="_ _1"></span><span class="ls13d1">.T<span class="_ _26"></span><span class="ls13d2">os<span class="_ _d"></span><span class="ls0">end <span class="_ _2"></span>an</span></span></span></div><div class="t m0 x32 h16f y4c32 ff19 fsc0 fc0 sc0 ls0 ws0">error<span class="_ _6"></span>,<span class="_ _35"> </span><span class="ff1a">send_err<span class="_ _44"> </span></span>sends <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1b">errmsg</span><span class="ls13d3">,f<span class="_ _43"></span><span class="ls0">ollowed <span class="_ _42"> </span>by <span class="_ _42"> </span>a <span class="_ _42"> </span>byte <span class="_ _42"> </span>of <span class="_ _42"> </span>0, <span class="_ _42"> </span>followed <span class="_ _42"> </span>by <span class="_ _23"> </span>the <span class="_ _42"> </span>absolute</span></span></div><div class="t m0 x32 h170 y4c33 ff19 fsc0 fc0 sc0 ls0 ws0">value <span class="_ _2"></span>of <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1b">status<span class="_ _47"> </span></span>byte</div><div class="t m0 x1dd h16e y4c34 ff19 fsc0 fc0 sc0 ls0 ws0">(</div><div class="t m0 x20e h16e y4c33 ff19 fsc0 fc0 sc0 ls13d4 ws0">1t<span class="_ _4f"></span><span class="ls0">hrough 255</span></div><div class="t m0 x10f h16e y4c34 ff19 fsc0 fc0 sc0 ls0 ws0">)</div><div class="t m0 x9b h16f y4c33 ff19 fsc0 fc0 sc0 ls13d5 ws0">.T<span class="_ _5b"></span><span class="ls0">he<span class="_ _66"> </span><span class="ff1a">recv_fd<span class="_ _47"> </span></span>function reads <span class="_ _2"></span>everything <span class="_ _2"></span>on <span class="_ _2"></span>the</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
