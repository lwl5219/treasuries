<div id="pf18b" class="pf w4 h1f" data-page-no="18b"><div class="pc pc18b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg18b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>10.16<span class="_ _274"> </span><span class="ff1a">sigsuspend<span class="_ _4b"> </span></span>Function<span class="_ _1b"> </span><span class="ff18">361</span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">static void</div><div class="t m0 x32 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">sig_int(int signo)</div><div class="t m0 x32 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">pr_mask(&quot;\nin sig_int: &quot;);</div><div class="t m0 x32 h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xa0 h2d y2e4d ff18 fs10 fc0 sc0 ls0 ws0">Figure 10.22<span class="_ _5a"> </span><span class="ff19">Protecting a critical region fr<span class="_ _0"></span>om a signal</span></div><div class="t m0 x32 h4d y2e4e ff19 fs26 fc0 sc0 ls0 ws0">When<span class="_ _45"> </span><span class="ff1a">sigsuspend<span class="_ _45"> </span></span><span class="lscc">re<span class="_ _2"></span></span>turns, <span class="_ _9"></span>it <span class="_ _23"></span>sets <span class="_ _9"></span>the <span class="_ _9"></span>signal <span class="_ _23"></span>mask <span class="_ _9"></span>to <span class="_ _9"></span>its <span class="_ _23"></span>value <span class="_ _9"></span>befor<span class="lsce3">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>call.<span class="_ _51"> </span>In <span class="_ _9"></span>this</span></span></div><div class="t m0 x32 h4d y2e4f ff19 fs26 fc0 sc0 ls0 ws0">example, <span class="_ _2"></span>the<span class="_ _45"> </span><span class="ff1a">SIGINT<span class="_ _66"> </span></span>signal <span class="_ _3"></span>will <span class="_ _3"></span>be <span class="_ _3"></span>blocked, <span class="_ _3"></span>so <span class="_ _3"></span>we <span class="_ _3"></span>restor<span class="lsce4">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>signal <span class="_ _3"></span>mask <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>value</span></span></div><div class="t m0 x32 h4d y2e50 ff19 fs26 fc0 sc0 ls0 ws0">that we saved earlier (<span class="ff1a">oldmask</span>).</div><div class="t m0 x3f h49 y2e51 ff19 fs26 fc0 sc0 ls0 ws0">Running the program fr<span class="_ _0"></span>om Figur<span class="_ _0"></span><span class="lsd3">e1<span class="_ _d"></span><span class="ls0">0.22 produces the following output:</span></span></div><div class="t m0 x3f h4e y2e52 ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h4e y2e53 ff1a fs28 fc0 sc0 ls0 ws0">program start:</div><div class="t m0 x3f h4e y2e54 ff1a fs28 fc0 sc0 ls0 ws0">in critical region: SIGINT</div><div class="t m0 x3f h4e y2e55 ff1f fs28 fc0 sc0 ls0 ws0">Ë†C<span class="_ _23d"> </span><span class="ff1b">type the interrupt character</span></div><div class="t m0 x3f h4e y2e56 ff1a fs28 fc0 sc0 ls0 ws0">in sig_int: SIGINT SIGUSR1</div><div class="t m0 x3f h4e y2e57 ff1a fs28 fc0 sc0 ls0 ws0">after return from sigsuspend: SIGINT</div><div class="t m0 x3f h4e y2e58 ff1a fs28 fc0 sc0 ls0 ws0">program exit:</div><div class="t m0 x32 h4d y2e59 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _66"> </span>a<span class="_ _23"></span><span class="ls0">dded<span class="_ _45"> </span><span class="ff1a">SIGUSR1<span class="_ _45"> </span></span>to <span class="_ _23"> </span>the <span class="_ _23"></span>mask <span class="_ _9"></span>installed <span class="_ _23"></span>when <span class="_ _9"></span>we <span class="_ _23"></span>called<span class="_ _45"> </span><span class="ff1a">sigsuspend<span class="_ _35"> </span></span>so <span class="_ _9"></span>that <span class="_ _23"></span>when</span></div><div class="t m0 x32 h49 y2e5a ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>signal <span class="_ _23"> </span>handler <span class="_ _23"></span>ran, <span class="_ _23"></span>we <span class="_ _9"></span>could <span class="_ _23"></span>tell <span class="_ _23"></span>that <span class="_ _9"></span>the <span class="_ _23"></span>mask <span class="_ _23"></span>had <span class="_ _9"></span>actually <span class="_ _23"></span>changed.<span class="_ _5a"> </span><span class="ls164">We <span class="_ _47"> </span>c<span class="_ _9"></span></span>an <span class="_ _23"> </span>see</div><div class="t m0 x32 h4d y2e5b ff19 fs26 fc0 sc0 ls0 ws0">that when<span class="_"> </span><span class="ff1a">sigsuspend<span class="_ _80"> </span></span><span class="lscc">re<span class="_ _2"></span></span>turns, it restor<span class="_ _0"></span>es the signal mask to its value befor<span class="lsd3">et<span class="_ _4f"></span><span class="ls0">he call.</span></span></div><div class="t m0 x35 h61 y2e5c ff16 fs2c fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h54 y2e5d ff19 fs2c fc0 sc0 ls0 ws0">Another <span class="_ _3"></span>use <span class="_ _9"></span>of<span class="_ _45"> </span><span class="ff1a">sigsuspend<span class="_ _47"> </span></span>is <span class="_ _9"></span>to <span class="_ _9"></span>wait <span class="_ _9"></span>for <span class="_ _3"></span>a <span class="_ _9"></span>signal <span class="_ _9"></span>handler <span class="_ _9"></span>to <span class="_ _3"></span>set <span class="_ _9"></span>a <span class="_ _9"></span>global <span class="_ _3"></span>variable.<span class="_ _5a"> </span>In</div><div class="t m0 x32 h55 y2e5e ff19 fs2c fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>program <span class="_ _42"> </span>shown <span class="_ _53"> </span>in <span class="_ _53"> </span>Figur<span class="lsce5">e1<span class="_ _c"></span><span class="ls0">0.23, <span class="_ _53"> </span>we <span class="_ _53"> </span>catch <span class="_ _53"> </span>both <span class="_ _53"> </span>the <span class="_ _53"> </span>interrupt <span class="_ _53"> </span>signal <span class="_ _53"> </span>and <span class="_ _53"> </span>the <span class="_ _53"> </span>quit</span></span></div><div class="t m0 x32 h55 y2e5f ff19 fs2c fc0 sc0 ls0 ws0">signal, but want to wake up the main routine only when the quit signal is caught.</div><div class="t m0 x32 h62 y2e60 ff1a fs30 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h62 y2e61 ff1a fs30 fc0 sc0 ls0 ws0">volatile sig_atomic_t<span class="_ _68"> </span>quitflag; <span class="_ _3a"> </span>/*<span class="_"> </span>set nonzero by signal handler */</div><div class="t m0 x32 h62 y2e62 ff1a fs30 fc0 sc0 ls0 ws0">static void</div><div class="t m0 x32 h62 y2e63 ff1a fs30 fc0 sc0 ls0 ws0">sig_int(int signo)<span class="_ _d9"> </span>/* one signal handler for SIGINT and SIGQUIT */</div><div class="t m0 x32 h62 y2e64 ff1a fs30 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h62 y2e65 ff1a fs30 fc0 sc0 ls0 ws0">if (signo == SIGINT)</div><div class="t m0 x9d h62 y2e66 ff1a fs30 fc0 sc0 ls0 ws0">printf(&quot;\ninterrupt\n&quot;);</div><div class="t m0 x8a h62 y2e67 ff1a fs30 fc0 sc0 ls0 ws0">else if (signo == SIGQUIT)</div><div class="t m0 x9d h62 y2e68 ff1a fs30 fc0 sc0 ls0 ws0">quitflag = 1;<span class="_ _68"> </span>/* set flag for main loop */</div><div class="t m0 x32 h62 y2e69 ff1a fs30 fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h62 y2e6a ff1a fs30 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h62 y2e6b ff1a fs30 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h62 y2e6c ff1a fs30 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h62 y2e6d ff1a fs30 fc0 sc0 ls0 ws0">sigset_t <span class="_ _68"> </span>newmask,<span class="_"> </span>oldmask, zeromask;</div><div class="t m0 x8a h62 y2e6e ff1a fs30 fc0 sc0 ls0 ws0">if (signal(SIGINT, sig_int) == SIG_ERR)</div><div class="t m0 x9d h62 y2e6f ff1a fs30 fc0 sc0 ls0 ws0">err_sys(&quot;signal(SIGINT) error&quot;);</div><div class="t m0 x8a h62 y2e70 ff1a fs30 fc0 sc0 ls0 ws0">if (signal(SIGQUIT, sig_int) == SIG_ERR)</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
