<div id="pf231" class="pf w4 h1f" data-page-no="231"><div class="pc pc231 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg231.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.8<span class="_ _2b0"> </span>Memory-Mapped <span class="_"> </span>I/O<span class="_ _1b"> </span><span class="ff18">527</span></div><div class="t m0 x14e h2a y12f ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ferences to the mapped <span class="_ _2"></span>region then refer<span class="_ _0"></span>ence the copy<span class="_ _4"></span><span class="lsdc8">.(<span class="_ _4a"></span><span class="ls0">One use</span></span></span></div><div class="t m0 x14e h2a y130 ff19 fsf fc0 sc0 ls0 ws0">of <span class="_"> </span>this <span class="_ _66"> </span>ﬂag <span class="_"> </span>is <span class="_ _66"> </span>for <span class="_ _66"> </span>a <span class="_ _66"> </span>debugger <span class="_ _66"> </span>that <span class="_ _66"> </span>maps <span class="_ _66"> </span>the <span class="_"> </span>text <span class="_ _66"> </span>portion <span class="_ _66"> </span>of <span class="_ _66"> </span>a</div><div class="t m0 x14e h2a y131 ff19 fsf fc0 sc0 ls0 ws0">program <span class="_ _3"></span>ﬁle <span class="_ _9"></span>but <span class="_ _23"></span>allows <span class="_ _9"></span>the <span class="_ _9"></span>user <span class="_ _9"></span>to <span class="_ _9"></span>modify <span class="_ _9"></span>the <span class="_ _9"></span>instructions. <span class="_ _45"> </span>Any</div><div class="t m0 x14e h2a y132 ff19 fsf fc0 sc0 ls0 ws0">modiﬁcations affect the copy<span class="_ _4"></span><span class="ls44">,n<span class="_ _d"></span><span class="ls0">ot the original program ﬁle.)</span></span></div><div class="t m0 x32 h26 y1fc ff19 fsf fc0 sc0 ls0 ws0">Each <span class="_ _53"> </span>implementation <span class="_ _53"> </span>has <span class="_ _53"> </span>additional<span class="_ _4b"> </span><span class="ff1a">MAP_xxx<span class="_ _44"> </span></span>ﬂag <span class="_ _e"> </span>values, <span class="_ _53"> </span>which <span class="_ _53"> </span>ar<span class="ls10ff">es<span class="_ _55"></span><span class="ls0">peciﬁc <span class="_ _e"> </span>to <span class="_ _53"> </span>that</span></span></div><div class="t m0 x32 h26 y1fd ff19 fsf fc0 sc0 ls0 ws0">implementation. <span class="_"> </span>Check<span class="_"> </span>the<span class="_"> </span><span class="ff1a">mmap</span></div><div class="t m0 x15f h2a y735 ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x157 h2a y1fd ff19 fsf fc0 sc0 ls0 ws0">2</div><div class="t m0 x23 h2a y735 ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x226 h2a y1fd ff19 fsf fc0 sc0 ls0 ws0">manual page on your system for details.</div><div class="t m0 x3f h26 y406 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_"> </span>value <span class="_"> </span>of<span class="_ _46"> </span><span class="ff1b">off<span class="_ _59"> </span></span>and <span class="_"> </span>the <span class="_"> </span>value <span class="_"> </span>of<span class="_ _46"> </span><span class="ff1b">addr<span class="_ _46"> </span></span>(if<span class="_ _46"> </span><span class="ff1a">MAP_FIXED<span class="_ _46"> </span></span>is <span class="_"> </span>speciﬁed) <span class="_"> </span>ar<span class="lsafd">eu<span class="_ _5b"></span><span class="ls0">sually</span></span></div><div class="t m0 x32 h2a y407 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">quired <span class="_ _23"></span>to <span class="_ _23"></span>be <span class="_ _9"></span>multiples <span class="_ _23"> </span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>system’s <span class="_ _23"> </span>virtual <span class="_ _23"></span>memory <span class="_ _23"></span>page <span class="_ _23"></span>size.<span class="_ _51"> </span>This <span class="_ _9"></span>value <span class="_ _23"> </span>can <span class="_ _23"> </span>be</span></div><div class="t m0 x32 h26 y408 ff19 fsf fc0 sc0 ls0 ws0">obtained <span class="_ _65"> </span>from <span class="_ _65"> </span>the<span class="_ _7f"> </span><span class="ff1a">sysconf<span class="_ _93"> </span></span>function <span class="_ _48"> </span>(Section <span class="_ _65"> </span>2.5.4) <span class="_ _48"> </span>with <span class="_ _48"> </span>an <span class="_ _65"> </span>argument <span class="_ _65"> </span>of</div><div class="t m0 x32 h26 y409 ff1a fsf fc0 sc0 ls0 ws0">_SC_PAGESIZE<span class="_ _35"> </span><span class="ff19">or<span class="_ _44"> </span></span>_SC_PAGE_SIZE<span class="ff19 ls1100">.S<span class="_ _7"></span><span class="ls0">ince<span class="_ _35"> </span><span class="ff1b">off<span class="_ _44"> </span></span>and<span class="_ _44"> </span><span class="ff1b">addr<span class="_ _44"> </span></span>ar<span class="_ _0"></span><span class="ls1101">eo<span class="_ _43"></span><span class="ls0">ften <span class="_ _23"> </span>speciﬁed <span class="_ _42"> </span>as <span class="_ _42"> </span>0, <span class="_ _53"> </span>this</span></span></span></span></div><div class="t m0 x32 h2a y40a ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">quirement is not a big deal.</span></div><div class="t m0 x76 h51 y407e ff19 fs2a fc0 sc0 ls0 ws0">This <span class="_ _42"> </span>requir<span class="_ _0"></span>ement <span class="_ _42"> </span>is <span class="_ _42"> </span>usually <span class="_ _42"> </span>imposed <span class="_ _42"> </span>by <span class="_ _42"> </span>the <span class="_ _42"> </span>system <span class="_ _42"> </span>implementations.<span class="_ _16"> </span>Although <span class="_ _42"> </span>the <span class="_ _42"> </span>Single</div><div class="t m0 x76 h51 y407f ff19 fs2a fc0 sc0 ls0 ws0">UNIX Speciﬁcation no <span class="_ _2"></span>longer requires that this condition be satisﬁed, <span class="_ _2"></span>all the platforms <span class="_ _2"></span>covered</div><div class="t m0 x76 h51 y4080 ff19 fs2a fc0 sc0 ls0 ws0">in <span class="_ _23"> </span>this <span class="_ _42"> </span>book, <span class="_ _23"> </span>except <span class="_ _23"> </span>FreeBSD <span class="_ _23"> </span>8.0, <span class="_ _42"> </span>have <span class="_ _23"> </span>this <span class="_ _23"> </span>requirement. <span class="_ _45"> </span>Fr<span class="_ _0"></span>eeBSD <span class="_ _23"> </span>8.0 <span class="_ _42"> </span>allows <span class="_ _23"> </span>us <span class="_ _23"> </span>to <span class="_ _42"> </span>use <span class="_ _23"> </span>any</div><div class="t m0 x76 h51 y4081 ff19 fs2a fc0 sc0 ls0 ws0">address alignment and of<span class="_ _0"></span>fset alignment as long as the alignments match.</div><div class="t m0 x3f h2a y34d ff19 fsf fc0 sc0 ls0 ws0">Since <span class="_ _23"></span>the <span class="_ _23"></span>starting <span class="_ _23"></span>offset <span class="_ _9"></span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>mapped <span class="_ _23"> </span>ﬁle <span class="_ _23"> </span>is <span class="_ _23"> </span>tied <span class="_ _23"> </span>to <span class="_ _23"> </span>the <span class="_ _23"> </span>system’s <span class="_ _23"> </span>virtual <span class="_ _23"> </span>memory</div><div class="t m0 x32 h2a y34b1 ff19 fsf fc0 sc0 ls0 ws0">page <span class="_ _2"></span>size, <span class="_ _3"></span>what <span class="_ _3"></span>happens <span class="_ _3"></span>if <span class="_ _2"></span>the <span class="_ _3"></span>length <span class="_ _3"></span>of <span class="_ _2"></span>the <span class="_ _3"></span>mapped <span class="_ _3"></span>region <span class="_ _2"></span>isn’t <span class="_ _3"></span>a <span class="_ _3"></span>multiple <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>page</div><div class="t m0 x32 h2a y34b2 ff19 fsf fc0 sc0 ls0 ws0">size? <span class="_ _45"> </span>Assume<span class="_ _47"> </span>that <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _3"></span>size <span class="_ _9"></span>is <span class="_ _9"></span>12 <span class="_ _9"></span>bytes <span class="_ _3"></span>and <span class="_ _9"></span>that <span class="_ _9"></span>the <span class="_ _9"></span>system’s <span class="_ _3"></span>page <span class="_ _9"></span>size <span class="_ _9"></span>is <span class="_ _9"></span>512 <span class="_ _3"></span>bytes.</div><div class="t m0 x32 h2a y34b3 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _9"></span>this <span class="_ _3"></span>case, <span class="_ _9"></span>the <span class="_ _9"></span>system <span class="_ _9"></span>normally <span class="_ _9"></span>provides <span class="_ _3"></span>a <span class="_ _9"></span>mapped <span class="_ _3"></span>region <span class="_ _3"></span>of <span class="_ _9"></span>512 <span class="_ _9"></span>bytes, <span class="_ _9"></span>and <span class="_ _9"></span>the <span class="_ _3"></span>ﬁnal</div><div class="t m0 x32 h2a y34b4 ff19 fsf fc0 sc0 ls0 ws0">500 <span class="_ _2"></span>bytes <span class="_ _2"></span>of <span class="_ _2"></span>this <span class="_ _3"></span>region ar<span class="ls92f">es<span class="_ _4f"></span><span class="ls0">et <span class="_ _2"></span>to <span class="_ _2"></span>0.<span class="_ _61"> </span><span class="ls5f">We <span class="_ _80"> </span>c<span class="_ _9"></span></span>an <span class="_ _2"></span>modify <span class="_ _2"></span>the <span class="_ _3"></span>ﬁnal <span class="_ _2"></span>500 <span class="_ _2"></span>bytes, <span class="_ _2"></span>but <span class="_ _3"></span>any <span class="_ _2"></span>changes</span></span></div><div class="t m0 x32 h2a y34b5 ff19 fsf fc0 sc0 ls0 ws0">we <span class="_ _42"> </span>make <span class="_ _23"> </span>to <span class="_ _42"> </span>them <span class="_ _42"> </span>ar<span class="ls1102">en<span class="_ _c"></span><span class="ls0">ot <span class="_ _42"> </span>reﬂected <span class="_ _23"> </span>in <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle.<span class="_ _51"> </span>Thus <span class="_ _42"> </span>we <span class="_ _42"> </span>cannot <span class="_ _42"> </span>append <span class="_ _23"> </span>to <span class="_ _42"> </span>a <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>with</span></span></div><div class="t m0 x32 h26 y34b6 ff1a fsf fc0 sc0 ls0 ws0">mmap<span class="ff19 ls86">.W<span class="_ _26"></span><span class="ls44">em<span class="_ _5"></span><span class="ls0">ust ﬁrst grow the ﬁle, as we will see in Figur<span class="_ _1"></span><span class="ls44">e1<span class="_ _5"></span><span class="ls0">4.27.</span></span></span></span></span></div><div class="t m0 x3f h26 y34b7 ff19 fsf fc0 sc0 lsbc ws0">Tw<span class="_ _9"></span><span class="ls1103">os<span class="_ _4f"></span><span class="ls0">ignals <span class="_ _2"></span>ar<span class="ls1104">en<span class="_ _4f"></span><span class="ls0">ormally <span class="_ _2"></span>used <span class="_ _2"></span>with <span class="_ _2"></span>mapped <span class="_ _2"></span>regions.<span class="_ _46"> </span><span class="ff1a">SIGSEGV<span class="_ _66"> </span></span>is <span class="_ _2"></span>normally <span class="_ _2"></span>used <span class="_ _2"></span>to</span></span></span></span></div><div class="t m0 x32 h2a y34b8 ff19 fsf fc0 sc0 ls0 ws0">indicate <span class="_ _2"></span>that <span class="_ _2"></span>we <span class="_ _2"></span>have <span class="_ _2"></span>tried <span class="_ _3"></span>to <span class="_ _2"></span>access <span class="_ _2"></span>memory <span class="_ _2"></span>that <span class="_ _2"></span>is <span class="_ _3"></span>not <span class="_ _2"></span>available <span class="_ _2"></span>to <span class="_ _2"></span>us.<span class="_ _61"> </span>This <span class="_ _3"></span>signal <span class="_ _2"></span>can</div><div class="t m0 x32 h26 y34b9 ff19 fsf fc0 sc0 ls0 ws0">also <span class="_ _9"></span>be <span class="_ _9"></span>generated <span class="_ _3"></span>if <span class="_ _9"></span>we <span class="_ _9"></span>try <span class="_ _9"></span>to <span class="_ _9"></span>stor<span class="ls4e4">ei<span class="_ _b"></span><span class="ls0">nto <span class="_ _9"></span>a <span class="_ _9"></span>mapped <span class="_ _9"></span>region <span class="_ _3"></span>that <span class="_ _9"></span>we <span class="_ _9"></span>speciﬁed <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">mmap<span class="_ _45"> </span></span>as</span></span></div><div class="t m0 x32 h26 y25d7 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ad-only<span class="_ _6"></span><span class="ls1105">.T<span class="_ _26"></span><span class="ls0">he<span class="_ _45"> </span><span class="ff1a">SIGBUS<span class="_ _35"> </span></span>signal <span class="_ _23"></span>can <span class="_ _9"></span>be <span class="_ _23"> </span>generated <span class="_ _23"></span>if <span class="_ _23"></span>we <span class="_ _23"></span>access <span class="_ _9"></span>a <span class="_ _23"> </span>portion <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>mapped</span></span></span></div><div class="t m0 x32 h2a y34ba ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">gion <span class="_ _3"></span>that <span class="_ _2"></span>does <span class="_ _2"></span>not <span class="_ _3"></span>make <span class="_ _2"></span>sense <span class="_ _3"></span>at <span class="_ _2"></span>the <span class="_ _2"></span>time <span class="_ _3"></span>of <span class="_ _2"></span>the <span class="_ _3"></span>access.<span class="_ _61"> </span>For <span class="_ _2"></span>example, <span class="_ _2"></span>assume <span class="_ _3"></span>that <span class="_ _2"></span>we</span></div><div class="t m0 x32 h2a y34bb ff19 fsf fc0 sc0 ls0 ws0">map a <span class="_ _2"></span>ﬁle <span class="_ _2"></span>using <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle’s <span class="_ _2"></span>size, <span class="_ _2"></span>but <span class="_ _2"></span>before<span class="_"> </span>we<span class="_ _66"> </span>reference the <span class="_ _2"></span>mapped <span class="_ _2"></span>region, the <span class="_ _2"></span>ﬁle’s <span class="_ _2"></span>size</div><div class="t m0 x32 h2a y34bc ff19 fsf fc0 sc0 ls0 ws0">is truncated by <span class="_ _2"></span>some other <span class="_ _2"></span>process. <span class="_"> </span>If<span class="_"> </span>we then <span class="_ _2"></span>try to <span class="_ _2"></span>access the <span class="_ _2"></span>memory-mapped region</div><div class="t m0 x32 h26 y34bd ff19 fsf fc0 sc0 ls0 ws0">corresponding to the end portion of the ﬁle that was tr<span class="_ _0"></span>uncated, we’ll receive<span class="_"> </span><span class="ff1a">SIGBUS</span>.</div><div class="t m0 x3f h26 y2ca2 ff19 fsf fc0 sc0 ls1106 ws0">Am<span class="_ _b"></span><span class="ls0">emory-mapped <span class="_ _9"></span>region <span class="_ _9"></span>is <span class="_ _23"> </span>inherited <span class="_ _23"></span>by <span class="_ _23"></span>a <span class="_ _9"></span>child <span class="_ _23"> </span>across <span class="_ _9"></span>a<span class="_ _35"> </span><span class="ff1a">fork<span class="_ _35"> </span></span>(since <span class="_ _9"></span>it’s <span class="_ _23"> </span>part <span class="_ _23"></span>of</span></div><div class="t m0 x32 h2a y2ca3 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _66"> </span>parent’s <span class="_"> </span>address <span class="_ _66"> </span>space), <span class="_ _47"> </span>but <span class="_ _66"> </span>for <span class="_ _47"> </span>the <span class="_"> </span>same <span class="_ _47"> </span>reason, <span class="_"> </span>is <span class="_ _47"> </span>not <span class="_"> </span>inherited <span class="_ _47"> </span>by <span class="_ _66"> </span>the <span class="_ _47"> </span>new</div><div class="t m0 x32 h26 y2ca4 ff19 fsf fc0 sc0 ls0 ws0">program acr<span class="_ _0"></span>oss an<span class="_"> </span><span class="ff1a">exec</span>.</div><div class="t m0 x3f h26 y2ca5 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>c<span class="_ _9"></span><span class="ls0">an change the permissions on an existing mapping by calling<span class="_"> </span><span class="ff1a">mprotect</span>.</span></div><div class="t m0 x3f h57 y4082 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/mman.h&gt;</div><div class="t m0 x3f h57 y4083 ff1a fs2d fc0 sc0 ls0 ws0">int mprotect(void *<span class="ff1b">addr</span><span class="ls15c">,s<span class="_ _1d"></span><span class="ls0">ize_t<span class="_"> </span><span class="ff1b">len</span><span class="ls15c">,i<span class="_ _5b"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">prot</span>);</span></span></span></span></div><div class="t m0 x153 h5f y4084 ff19 fs2d fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h4d y4085 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _9"></span>legal <span class="_ _23"></span>values <span class="_ _9"></span>for<span class="_ _35"> </span><span class="ff1b">prot<span class="_ _45"> </span></span>ar<span class="_ _0"></span><span class="ls702">et<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>same <span class="_ _23"></span>as <span class="_ _9"></span>those <span class="_ _23"></span>for<span class="_ _45"> </span><span class="ff1a">mmap<span class="_ _45"> </span></span>(Figur<span class="ls1107">e1<span class="_ _b"></span><span class="ls0">4.25). <span class="_ _45"> </span>Be<span class="_ _45"> </span>awar<span class="ls1107">et<span class="_ _b"></span><span class="ls0">hat</span></span></span></span></span></span></div><div class="t m0 x32 h49 y4086 ff19 fs26 fc0 sc0 ls0 ws0">implementations <span class="_ _42"> </span>may <span class="_ _42"> </span>requir<span class="_ _0"></span><span class="ls1108">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>address <span class="_ _42"> </span>argument <span class="_ _23"> </span>to <span class="_ _42"> </span>be <span class="_ _42"> </span>an <span class="_ _42"> </span>integral <span class="_ _42"> </span>multiple <span class="_ _42"> </span>of <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h49 y4087 ff19 fs26 fc0 sc0 ls0 ws0">system’s page size.</div><div class="t m0 x3f h49 y4088 ff19 fs26 fc0 sc0 ls0 ws0">When <span class="_ _66"> </span>we <span class="_ _47"> </span>modify <span class="_ _66"> </span>pages <span class="_ _47"> </span>that <span class="_ _47"> </span>we’ve <span class="_ _66"> </span>mapped <span class="_ _47"> </span>into <span class="_ _66"> </span>our <span class="_ _47"> </span>address <span class="_"> </span>space <span class="_ _47"> </span>using <span class="_ _66"> </span>the</div><div class="t m0 x32 h4d y4089 ff1a fs26 fc0 sc0 ls0 ws0">MAP_SHARED<span class="_ _47"> </span><span class="ff19">ﬂag, <span class="_ _9"></span>the <span class="_ _3"></span>changes <span class="_ _9"></span>aren’t <span class="_ _2"></span>written <span class="_ _9"></span>back <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>immediately<span class="_ _6"></span><span class="ls1109">.I<span class="_ _62"></span><span class="ls0">nstead, <span class="_ _9"></span>the</span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
