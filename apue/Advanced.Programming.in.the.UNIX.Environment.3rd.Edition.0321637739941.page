<div id="pf3ad" class="pf w4 h1f" data-page-no="3ad"><div class="pc pc3ad w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg3ad.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Appendix <span class="_"> </span>C<span class="_ _322"> </span>Chapter <span class="_"> </span>3<span class="_ _54"> </span>Solutions<span class="_ _1b"> </span><span class="ff18">907</span></div><div class="t m0 x215 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x215 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;limits.h&gt;</div><div class="t m0 x215 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/resource.h&gt;</div><div class="t m0 x215 h57 y2f1e ff1a fs2d fc0 sc0 ls0 ws0">#define OPEN_MAX_GUESS<span class="_ _d9"> </span>256</div><div class="t m0 x215 h57 y1d7b ff1a fs2d fc0 sc0 ls0 ws0">long</div><div class="t m0 x215 h57 y2197 ff1a fs2d fc0 sc0 ls0 ws0">open_max(void)</div><div class="t m0 x215 h57 y2f21 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 xc4 h57 y2f22 ff1a fs2d fc0 sc0 ls0 ws0">long openmax;</div><div class="t m0 xc4 h57 y2f23 ff1a fs2d fc0 sc0 ls0 ws0">struct rlimit rl;</div><div class="t m0 xc4 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">if ((openmax = sysconf(_SC_OPEN_MAX)) &lt; 0 ||</div><div class="t m0 x1b0 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">openmax == LONG_MAX) {</div><div class="t m0 x206 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">if (getrlimit(RLIMIT_NOFILE, &amp;rl) &lt; 0)</div><div class="t m0 xe9 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;can’t get file limit&quot;);</div><div class="t m0 x206 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">if (rl.rlim_max == RLIM_INFINITY)</div><div class="t m0 xe9 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">openmax = OPEN_MAX_GUESS;</div><div class="t m0 x206 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 xe9 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">openmax = rl.rlim_max;</div><div class="t m0 xc4 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">return(openmax);</div><div class="t m0 x215 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1f h2d y5ffa ff18 fs10 fc0 sc0 ls0 ws0">Figure C.1<span class="_ _5a"> </span><span class="ff19">Alternative method for identifying the largest possible ﬁle descriptor</span></div><div class="t m0 x35 h4c y5ffb ff16 fs26 fc0 sc0 ls0 ws0">Chapter <span class="_"> </span>3</div><div class="t m0 x32 h49 y5ffc ff18 fs26 fc0 sc0 ls0 ws0">3.1<span class="_ _9b"> </span><span class="ff19">All <span class="_ _e"> </span>disk <span class="_"> </span>I/O <span class="_"> </span>goes <span class="_"> </span>thr<span class="_ _0"></span>ough <span class="_"> </span>the <span class="_"> </span>kernel’s <span class="_"> </span>block <span class="_ _e"> </span>buffers <span class="_"> </span>(also <span class="_"> </span>called <span class="_ _e"> </span>the <span class="_"> </span>kernel’s</span></div><div class="t m0 x215 h49 y5ffd ff19 fs26 fc0 sc0 ls0 ws0">buffer <span class="_ _2"></span>cache).<span class="_ _16"> </span>The <span class="_ _3"></span>exception <span class="_ _9"></span>to <span class="_ _3"></span>this <span class="_ _3"></span>is <span class="_ _3"></span>I/O <span class="_ _3"></span>on <span class="_ _3"></span>a <span class="_ _9"></span>raw <span class="_ _3"></span>disk <span class="_ _3"></span>device, <span class="_ _3"></span>which <span class="_ _3"></span>we <span class="_ _3"></span>aren’t</div><div class="t m0 x215 h4a y5ffe ff19 fs26 fc0 sc0 ls0 ws0">considering. <span class="_ _47"> </span>(Some<span class="_ _47"> </span>systems <span class="_ _3"></span>also <span class="_ _3"></span>provide <span class="_ _3"></span>a<span class="_ _47"> </span><span class="ff1b">direct <span class="_ _3"></span>I/O<span class="_ _47"> </span></span>option <span class="_ _3"></span>to <span class="_ _3"></span>allow <span class="_ _3"></span>applications</div><div class="t m0 x215 h49 y5fff ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _35"> </span>bypass <span class="_ _45"> </span>the <span class="_ _35"> </span>kernel <span class="_ _35"> </span>buffers, <span class="_ _45"> </span>but <span class="_ _35"> </span>we <span class="_ _35"> </span>aren’t <span class="_ _45"> </span>considering <span class="_ _35"> </span>this <span class="_ _35"> </span>option <span class="_ _45"> </span>either<span class="_ _1"></span>.)</div><div class="t m0 x215 h49 y6000 ff19 fs26 fc0 sc0 ls0 ws0">Chapter <span class="_ _23"> </span>3 <span class="_ _42"> </span>of <span class="_ _23"> </span>Bach</div><div class="t m0 xa6 h49 y6001 ff19 fs26 fc0 sc0 ls0 ws0">[</div><div class="t m0 x27 h49 y6000 ff19 fs26 fc0 sc0 ls0 ws0">1986</div><div class="t m0 x11b h49 y6001 ff19 fs26 fc0 sc0 ls0 ws0">]</div><div class="t m0 x110 h49 y6000 ff19 fs26 fc0 sc0 ls0 ws0">describes <span class="_ _23"> </span>the <span class="_ _42"> </span>operation <span class="_ _23"> </span>of <span class="_ _42"> </span>this <span class="_ _23"> </span>buffer <span class="_ _23"> </span>cache.<span class="_ _54"> </span>Since <span class="_ _23"> </span>the</div><div class="t m0 x215 h4d y6002 ff19 fs26 fc0 sc0 ls0 ws0">data <span class="_ _42"> </span>that <span class="_ _53"> </span>we<span class="_ _44"> </span><span class="ff1a">read<span class="_ _44"> </span></span>or<span class="_ _44"> </span><span class="ff1a">write<span class="_ _44"> </span></span>is <span class="_ _53"> </span>buffer<span class="_ _0"></span>ed <span class="_ _42"> </span>by <span class="_ _53"> </span>the <span class="_ _42"> </span>kernel, <span class="_ _53"> </span>the <span class="_ _42"> </span>term<span class="_ _44"> </span><span class="ff1b">unbuffered <span class="_ _42"> </span>I/O</span></div><div class="t m0 x215 h49 y6003 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">fers <span class="_ _47"> </span>to <span class="_ _47"> </span>the <span class="_ _66"> </span>lack <span class="_ _47"> </span>of <span class="_ _66"> </span>automatic <span class="_ _47"> </span>buffering <span class="_ _66"> </span>in <span class="_ _47"> </span>the <span class="_ _66"> </span>user <span class="_ _47"> </span>process <span class="_ _66"> </span>with <span class="_ _47"> </span>these <span class="_ _66"> </span>two</span></div><div class="t m0 x215 h4d y6004 ff19 fs26 fc0 sc0 ls0 ws0">functions. <span class="_"> </span>Each<span class="_"> </span><span class="ff1a">read<span class="_ _80"> </span></span>or<span class="_"> </span><span class="ff1a">write<span class="_ _66"> </span></span>invokes a single system call.</div><div class="t m0 x32 h4d y6005 ff18 fs26 fc0 sc0 ls0 ws0">3.3<span class="_ _9b"> </span><span class="ff19">Each <span class="_ _42"> </span>call <span class="_ _53"> </span>to<span class="_ _4b"> </span><span class="ff1a">open<span class="_ _4b"> </span></span>gives <span class="_ _53"> </span>us <span class="_ _53"> </span>a <span class="_ _53"> </span>new <span class="_ _e"> </span>ﬁle <span class="_ _53"> </span>table <span class="_ _53"> </span>entry<span class="_ _6"></span><span class="ls17fc">.H<span class="_ _64"></span><span class="ls0">owever<span class="_ _1"></span><span class="lsef2">,s<span class="_ _c"></span><span class="ls0">ince <span class="_ _53"> </span>both<span class="_ _4b"> </span><span class="ff1a">open</span>s</span></span></span></span></span></div><div class="t m0 x215 h49 y6006 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ference <span class="_ _2"></span>the <span class="_ _2"></span>same <span class="_ _2"></span>ﬁle, <span class="_ _2"></span>both <span class="_ _2"></span>ﬁle <span class="_ _3"></span>table <span class="_ _2"></span>entries <span class="_ _2"></span>point <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>same <span class="_ _3"></span>v-node <span class="_ _2"></span>table <span class="_ _2"></span>entry<span class="_ _4"></span>.</span></div><div class="t m0 x215 h4d y6007 ff19 fs26 fc0 sc0 ls0 ws0">The call <span class="_ _2"></span>to<span class="_ _47"> </span><span class="ff1a">dup<span class="_ _66"> </span></span><span class="lscc">re<span class="_ _2"></span></span>ferences the <span class="_ _2"></span>existing <span class="_ _2"></span>ﬁle <span class="_ _2"></span>table <span class="_ _2"></span>entry<span class="_ _4"></span><span class="ls17fd">.W<span class="_ _26"></span><span class="ls17fe">es<span class="_ _4f"></span><span class="ls0">how <span class="_ _2"></span>this <span class="_ _2"></span>in <span class="_ _2"></span>Figur<span class="ls17fe">eC<span class="_ _4f"></span><span class="ls0">.2.</span></span></span></span></span></div><div class="t m0 x215 h4d y6008 ff19 fs26 fc0 sc0 ls0 ws0">An<span class="_"> </span><span class="ff1a">F_SETFD<span class="_ _66"> </span></span>on<span class="_"> </span><span class="ff1a">fd1<span class="_ _66"> </span></span>affects only the <span class="_ _2"></span>ﬁle descriptor <span class="_ _2"></span>ﬂags for<span class="_ _66"> </span><span class="ff1a">fd1</span><span class="ls17ff">,b<span class="_ _d"></span><span class="ls0">ut <span class="_ _2"></span>an<span class="_"> </span><span class="ff1a">F_SETFL</span></span></span></div><div class="t m0 x215 h4d y6009 ff19 fs26 fc0 sc0 ls0 ws0">on<span class="_"> </span><span class="ff1a">fd1<span class="_ _80"> </span></span>affects the ﬁle table entry that both<span class="_"> </span><span class="ff1a">fd1<span class="_ _80"> </span></span>and<span class="_"> </span><span class="ff1a">fd2<span class="_ _66"> </span></span>point to.</div><div class="t m0 x32 h4d y600a ff18 fs26 fc0 sc0 ls0 ws0">3.4<span class="_ _9b"> </span><span class="ff19">If<span class="_ _4b"> </span><span class="ff1a">fd<span class="_ _46"> </span></span>is <span class="_"> </span>1, <span class="_"> </span>then <span class="_"> </span>the<span class="_ _59"> </span><span class="ff1a">dup2(fd, <span class="_ _d"></span>1)<span class="_ _59"> </span><span class="ff19 lscc">re<span class="_ _2"></span><span class="ls0">turns <span class="_"> </span>1 <span class="_"> </span>without <span class="_"> </span>closing <span class="_"> </span>ﬁle <span class="_ _e"> </span>descriptor <span class="_"> </span>1.</span></span></span></span></div><div class="t m0 x215 h4d y600b ff19 fs26 fc0 sc0 ls0 ws0">(Remember <span class="_ _9"></span>our <span class="_ _9"></span>discussion <span class="_ _23"></span>of <span class="_ _9"></span>this <span class="_ _23"></span>in <span class="_ _9"></span>Section <span class="_ _9"></span>3.12.)<span class="_ _5a"> </span>After <span class="_ _23"></span>the <span class="_ _9"></span>three <span class="_ _9"></span>calls <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">dup2</span>,</div><div class="t m0 x215 h49 y600c ff19 fs26 fc0 sc0 ls0 ws0">all three descriptors <span class="_ _2"></span>point <span class="_ _2"></span>to the <span class="_ _2"></span>same <span class="_ _2"></span>ﬁle table <span class="_ _2"></span>entry<span class="_ _6"></span><span class="ls1800">.N<span class="_ _5b"></span><span class="ls0">othing <span class="_ _2"></span>needs to <span class="_ _2"></span>be <span class="_ _2"></span>closed.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
