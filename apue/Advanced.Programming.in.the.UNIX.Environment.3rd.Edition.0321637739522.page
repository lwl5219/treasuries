<div id="pf20a" class="pf w4 h1f" data-page-no="20a"><div class="pc pc20a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg20a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">488<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x32 h26 y12f ff1a fsf fc0 sc0 ls0 ws0">F_SETLKW<span class="_ _6e"> </span><span class="ff19">This <span class="_ _2"></span>command <span class="_ _2"></span>is <span class="_ _3"></span>a <span class="_ _2"></span>blocking <span class="_ _2"></span>version <span class="_ _3"></span>of<span class="_ _66"> </span></span>F_SETLK<span class="ff19 lsfe7">.(<span class="_ _5b"></span><span class="ls0">The<span class="_ _47"> </span><span class="ff1a">W<span class="_ _47"> </span></span>in <span class="_ _2"></span>the <span class="_ _2"></span>command</span></span></div><div class="t m0 x13f h2b y130 ff19 fsf fc0 sc0 ls0 ws0">name <span class="_"> </span>means<span class="_ _4b"> </span><span class="ff1b">wait</span>.) <span class="_ _59"> </span>If<span class="_ _59"> </span>the <span class="_"> </span>requested <span class="_ _e"> </span>read <span class="_ _e"> </span>lock <span class="_"> </span>or <span class="_ _e"> </span>write <span class="_"> </span>lock <span class="_"> </span>cannot <span class="_ _e"> </span>be</div><div class="t m0 x13f h2a y131 ff19 fsf fc0 sc0 ls0 ws0">granted <span class="_ _3"></span>because <span class="_ _3"></span>another <span class="_ _3"></span>process <span class="_ _2"></span>currently <span class="_ _3"></span>has <span class="_ _3"></span>some <span class="_ _3"></span>part <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>requested</div><div class="t m0 x13f h2a y132 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">gion <span class="_ _23"> </span>locked, <span class="_ _42"> </span>the <span class="_ _23"></span>calling <span class="_ _23"></span>process <span class="_ _23"></span>is <span class="_ _23"></span>put <span class="_ _23"></span>to <span class="_ _23"> </span>sleep.<span class="_ _51"> </span>The <span class="_ _23"> </span>process <span class="_ _23"></span>wakes <span class="_ _23"></span>up</span></div><div class="t m0 x13f h2a y133 ff19 fsf fc0 sc0 ls0 ws0">either when the lock becomes available or when interrupted by a signal.</div><div class="t m0 x3f h26 y3bd8 ff19 fsf fc0 sc0 ls0 ws0">Be <span class="_ _9"></span>awar<span class="ls1a2">et<span class="_ _b"></span><span class="ls0">hat <span class="_ _9"></span>testing <span class="_ _9"></span>for <span class="_ _23"></span>a <span class="_ _9"></span>lock <span class="_ _23"></span>with<span class="_ _45"> </span><span class="ff1a">F_GETLK<span class="_ _45"> </span></span>and <span class="_ _23"></span>then <span class="_ _9"></span>trying <span class="_ _23"></span>to <span class="_ _9"></span>obtain <span class="_ _23"></span>that <span class="_ _9"></span>lock</span></span></div><div class="t m0 x32 h26 y3bd9 ff19 fsf fc0 sc0 ls0 ws0">with<span class="_ _35"> </span><span class="ff1a">F_SETLK<span class="_ _35"> </span></span>or<span class="_ _35"> </span><span class="ff1a">F_SETLKW<span class="_ _35"> </span></span>is <span class="_ _42"> </span>not <span class="_ _23"></span>an <span class="_ _23"> </span>atomic <span class="_ _42"> </span>operation.<span class="_ _51"> </span><span class="ls5f">We <span class="_ _47"> </span>h<span class="_ _23"></span></span>ave <span class="_ _23"></span>no <span class="_ _23"> </span>guarantee <span class="_ _42"> </span>that,</div><div class="t m0 x32 h26 y2090 ff19 fsf fc0 sc0 ls0 ws0">between <span class="_ _23"></span>the <span class="_ _9"></span>two<span class="_ _35"> </span><span class="ff1a">fcntl<span class="_ _45"> </span></span>calls, <span class="_ _23"> </span>some <span class="_ _23"> </span>other <span class="_ _23"></span>process <span class="_ _9"></span>won’t <span class="_ _23"></span>come <span class="_ _23"></span>in <span class="_ _9"></span>and <span class="_ _23"> </span>obtain <span class="_ _23"> </span>the <span class="_ _23"></span>same</div><div class="t m0 x32 h2a y3bda ff19 fsf fc0 sc0 ls0 ws0">lock. <span class="_ _45"> </span>If<span class="_ _45"> </span>we <span class="_ _3"></span>don’t <span class="_ _9"></span>want <span class="_ _9"></span>to <span class="_ _9"></span>block <span class="_ _9"></span>while <span class="_ _9"></span>waiting <span class="_ _9"></span>for <span class="_ _9"></span>a <span class="_ _9"></span>lock <span class="_ _9"></span>to <span class="_ _9"></span>become <span class="_ _9"></span>available <span class="_ _9"></span>to <span class="_ _9"></span>us, <span class="_ _9"></span>we</div><div class="t m0 x32 h26 y2091 ff19 fsf fc0 sc0 ls0 ws0">must handle the possible error r<span class="_ _0"></span>eturns fr<span class="_ _0"></span>om<span class="_"> </span><span class="ff1a">F_SETLK</span>.</div><div class="t m0 x76 h51 y3bdb ff19 fs2a fc0 sc0 ls0 ws0">Note that <span class="_ _2"></span>POSIX.1 <span class="_ _2"></span>doesn’t <span class="_ _2"></span>specify what <span class="_ _2"></span>happens <span class="_ _2"></span>when <span class="_ _2"></span>one process <span class="_ _2"></span>read locks <span class="_ _2"></span>a range <span class="_ _2"></span>of <span class="_ _2"></span>a <span class="_ _2"></span>ﬁle,</div><div class="t m0 x76 h51 y3bdc ff19 fs2a fc0 sc0 lsfe8 ws0">as<span class="_ _43"></span><span class="ls0">econd <span class="_"> </span>process <span class="_ _42"> </span>blocks <span class="_"> </span>while <span class="_"> </span>trying <span class="_"> </span>to <span class="_ _42"> </span>get <span class="_"> </span>a <span class="_"> </span>write <span class="_"> </span>lock <span class="_ _42"> </span>on <span class="_"> </span>the <span class="_"> </span>same <span class="_"> </span>range, <span class="_"> </span>and <span class="_ _42"> </span>a <span class="_"> </span>third</span></div><div class="t m0 x76 h51 y3bdd ff19 fs2a fc0 sc0 ls0 ws0">processes then attempts to get another read lock on the range.<span class="_ _44"> </span>If the thir<span class="lsfe9">dp<span class="_ _5"></span><span class="ls34e">ro<span class="ls0">cess is <span class="_ _2"></span>allowed to</span></span></span></div><div class="t m0 x76 h51 y3bde ff19 fs2a fc0 sc0 ls0 ws0">place <span class="_ _80"> </span>a <span class="_ _80"> </span>read <span class="_ _80"> </span>lock <span class="_ _80"> </span>on <span class="_ _80"> </span>the <span class="_ _66"> </span>range <span class="_ _80"> </span>just <span class="_ _80"> </span>because <span class="_ _80"> </span>the <span class="_ _66"> </span>range <span class="_ _80"> </span>is <span class="_ _80"> </span>already <span class="_ _80"> </span>read <span class="_ _80"> </span>locked, <span class="_ _80"> </span>then <span class="_ _80"> </span>the</div><div class="t m0 x76 h51 y3bdf ff19 fs2a fc0 sc0 ls0 ws0">implementation might <span class="_ _2"></span>starve processes <span class="_ _2"></span>with pending <span class="_ _2"></span>write locks.<span class="_ _44"> </span>Thus, <span class="_ _2"></span>as <span class="_ _2"></span>additional requests</div><div class="t m0 x76 h51 y3be0 ff19 fs2a fc0 sc0 ls0 ws0">to <span class="_ _42"> </span>read <span class="_ _42"> </span>lock <span class="_"> </span>the <span class="_ _23"> </span>same <span class="_"> </span>range <span class="_ _42"> </span>arrive, <span class="_ _42"> </span>the <span class="_"> </span>time <span class="_ _42"> </span>that <span class="_ _42"> </span>the <span class="_ _42"> </span>process <span class="_ _42"> </span>with <span class="_"> </span>the <span class="_ _42"> </span>pending <span class="_ _42"> </span>write-lock</div><div class="t m0 x76 h51 y3be1 ff19 fs2a fc0 sc0 ls34e ws0">re<span class="ls0">quest <span class="_ _3"></span>has <span class="_ _2"></span>to <span class="_ _3"></span>wait <span class="_ _2"></span>is <span class="_ _3"></span>extended.<span class="_ _4b"> </span>If <span class="_ _2"></span>the <span class="_ _2"></span>read</span></div><div class="t m0 x8e h51 y3be2 ff19 fs2a fc0 sc0 ls0 ws0">-</div><div class="t m0 x176 h51 y3be1 ff19 fs2a fc0 sc0 ls0 ws0">lock <span class="_ _2"></span>requests <span class="_ _2"></span>arrive <span class="_ _3"></span>quickly <span class="_ _2"></span>enough <span class="_ _3"></span>without <span class="_ _2"></span>a <span class="_ _3"></span>lull</div><div class="t m0 x76 h51 y3be3 ff19 fs2a fc0 sc0 ls0 ws0">in the arrival rate, then the writer could wait for a long time.</div><div class="t m0 x3f h2a y3be4 ff19 fsf fc0 sc0 ls0 ws0">When <span class="_ _23"> </span>setting <span class="_ _42"> </span>or <span class="_ _23"> </span>releasing <span class="_ _23"> </span>a <span class="_ _42"> </span>lock <span class="_ _23"> </span>on <span class="_ _42"> </span>a <span class="_ _23"> </span>ﬁle, <span class="_ _42"> </span>the <span class="_ _23"> </span>system <span class="_ _42"> </span>combines <span class="_ _23"> </span>or <span class="_ _23"> </span>splits <span class="_ _42"> </span>adjacent</div><div class="t m0 x32 h2a y3be5 ff19 fsf fc0 sc0 ls0 ws0">areas <span class="_ _2"></span>as <span class="_ _9"></span>requir<span class="_ _0"></span>ed. <span class="_ _47"> </span>For<span class="_ _45"> </span>example, <span class="_ _3"></span>if <span class="_ _3"></span>we <span class="_ _9"></span>lock <span class="_ _3"></span>bytes <span class="_ _3"></span>100 <span class="_ _9"></span>through <span class="_ _3"></span>199 <span class="_ _3"></span>and <span class="_ _9"></span>then <span class="_ _3"></span>unlock <span class="_ _9"></span>byte</div><div class="t m0 x32 h2a y3be6 ff19 fsf fc0 sc0 ls0 ws0">150, <span class="_ _2"></span>the <span class="_ _2"></span>kernel <span class="_ _3"></span>still <span class="_ _2"></span>maintains <span class="_ _2"></span>the <span class="_ _3"></span>locks <span class="_ _2"></span>on <span class="_ _2"></span>bytes <span class="_ _3"></span>100 <span class="_ _2"></span>through <span class="_ _2"></span>149 <span class="_ _2"></span>and <span class="_ _3"></span>bytes <span class="_ _2"></span>151 <span class="_ _2"></span>through</div><div class="t m0 x32 h2a y3be7 ff19 fsf fc0 sc0 ls0 ws0">199. <span class="_"> </span>Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">4.4 illustrates the byte-range locks in this situation.</span></span></div><div class="t m0 x9b h2e y3be8 ff19 fs11 fc0 sc0 ls0 ws0">locked range</div><div class="t m0 x21f h2f y3be9 ff19 fs12 fc0 sc0 ls0 ws0">100</div><div class="t m0 x1c6 h30 y3bea ff19 fs13 fc0 sc0 ls0 ws0">199</div><div class="t m0 xc0 h30 y3beb ff19 fs13 fc0 sc0 ls0 ws0">File after locking bytes 100 through 199</div><div class="t m0 x1ab h32 y3bec ff19 fs15 fc0 sc0 ls0 ws0">ﬁrst</div><div class="t m0 xe0 h32 y3bed ff19 fs15 fc0 sc0 ls0 ws0">locked</div><div class="t m0 xe h32 y3bee ff19 fs15 fc0 sc0 ls0 ws0">range</div><div class="t m0 x1de h33 y3bef ff19 fs16 fc0 sc0 ls0 ws0">second</div><div class="t m0 x8e h33 y3bf0 ff19 fs16 fc0 sc0 ls0 ws0">locked</div><div class="t m0 x78 h33 y3bf1 ff19 fs16 fc0 sc0 ls0 ws0">range</div><div class="t m0 x21f h83 y3bf2 ff19 fs36 fc0 sc0 ls0 ws0">100</div><div class="t m0 x19a h34 y3bf3 ff19 fs17 fc0 sc0 ls0 ws0">149</div><div class="t m0 x115 h35 y3bf4 ff19 fs18 fc0 sc0 ls0 ws0">151</div><div class="t m0 x1c6 h36 y3bf5 ff19 fs19 fc0 sc0 ls0 ws0">199</div><div class="t m0 x4b h36 y3bf6 ff19 fs19 fc0 sc0 ls0 ws0">File after unlocking byte 150</div><div class="t m0 xa5 h37 y3bf7 ff18 fs1a fc0 sc0 ls0 ws0">Figure 14.4<span class="_ _5a"> </span><span class="ff19">File byte-range lock diagram</span></div><div class="t m0 x3f h8e y3bf8 ff19 fs47 fc0 sc0 ls0 ws0">If <span class="_ _3"></span>we <span class="_ _9"></span>were<span class="_ _47"> </span>to<span class="_ _47"> </span>lock <span class="_ _9"></span>byte <span class="_ _3"></span>150, <span class="_ _9"></span>the <span class="_ _3"></span>system <span class="_ _9"></span>would <span class="_ _3"></span>coalesce <span class="_ _9"></span>the <span class="_ _3"></span>adjacent <span class="_ _9"></span>locked <span class="_ _3"></span>regions</div><div class="t m0 x32 h8e y3bf9 ff19 fs47 fc0 sc0 ls0 ws0">into <span class="_ _2"></span>a <span class="_ _3"></span>single <span class="_ _2"></span>region <span class="_ _2"></span>from <span class="_ _2"></span>byte <span class="_ _3"></span>100 <span class="_ _3"></span>through <span class="_ _2"></span>199.<span class="_ _61"> </span>The <span class="_ _3"></span>resulting <span class="_ _2"></span>pictur<span class="lsfea">ew<span class="_ _8"></span><span class="ls0">ould <span class="_ _2"></span>be <span class="_ _3"></span>the <span class="_ _3"></span>ﬁrst</span></span></div><div class="t m0 x32 h8e y3bfa ff19 fs47 fc0 sc0 ls0 ws0">diagram in Figur<span class="ls3fc">e1<span class="_ _4f"></span><span class="ls0">4.4, the same as when we started.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
