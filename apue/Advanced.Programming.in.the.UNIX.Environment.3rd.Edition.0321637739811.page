<div id="pf32b" class="pf w4 h1f" data-page-no="32b"><div class="pc pc32b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg32b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">777</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">655 <span class="_ _82"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">656 <span class="_ _166"> </span>*<span class="_"> </span>Same size data, just replace data record.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">657 <span class="_ _166"> </span>*/</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">658 <span class="_ _82"> </span>_db_writedat(db,<span class="_"> </span>data, db-&gt;datoff, SEEK_SET);</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">659 <span class="_ _82"> </span>db-&gt;cnt_stor4++;</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">660 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">661 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">662 <span class="_ _15"> </span>rc<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls168d">;/<span class="_ _91"></span><span class="ls0">*<span class="_"> </span>OK<span class="_"> </span>*/</span></span></span></div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">663 <span class="_ _d9"> </span>doreturn:<span class="_"> </span>/* unlock hash chain locked by _db_find_and_lock */</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">664 <span class="_ _15"> </span>if<span class="_"> </span>(un_lock(db-&gt;idxfd, db-&gt;chainoff, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">665 <span class="_ _186"> </span>err_dump(&quot;db_store:<span class="_"> </span>un_lock error&quot;);</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">666 <span class="_ _15"> </span>return(rc);</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">667 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y2ad4 ff1a fs2d fc0 sc0 ls0 ws0">668 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y2ad5 ff1a fs2d fc0 sc0 ls0 ws0">669 <span class="_ _68"> </span>*<span class="_"> </span>Try to find a free index record and accompanying data record</div><div class="t m0 x32 h57 y2ad6 ff1a fs2d fc0 sc0 ls0 ws0">670 <span class="_ _68"> </span>*<span class="_"> </span>of the correct sizes.<span class="_ _3a"> </span>We’re only called by db_store.</div><div class="t m0 x32 h57 y33b1 ff1a fs2d fc0 sc0 ls0 ws0">671 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y33b2 ff1a fs2d fc0 sc0 ls0 ws0">672 <span class="_ _d9"> </span>static<span class="_"> </span>int</div><div class="t m0 x32 h57 y33b3 ff1a fs2d fc0 sc0 ls0 ws0">673 <span class="_ _d9"> </span>_db_findfree(DB<span class="_"> </span>*db, int keylen, int datlen)</div><div class="t m0 x32 h57 y33b4 ff1a fs2d fc0 sc0 ls0 ws0">674 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y33b5 ff1a fs2d fc0 sc0 ls0 ws0">675 <span class="_ _15"> </span>int <span class="_ _15"> </span>rc;</div><div class="t m0 x32 h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">676 <span class="_ _15"> </span>off_t<span class="_ _68"> </span>offset, nextoffset, saveoffset;</div><div class="t m0 x32 h57 y2022 ff1a fs2d fc0 sc0 ls0 ws0">677 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y5750 ff1a fs2d fc0 sc0 ls0 ws0">678 <span class="_ _8a"> </span>*<span class="_"> </span>Lock the free list.</div><div class="t m0 x32 h57 y5751 ff1a fs2d fc0 sc0 ls0 ws0">679 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y5752 ff1a fs2d fc0 sc0 ls0 ws0">680 <span class="_ _15"> </span>if<span class="_"> </span>(writew_lock(db-&gt;idxfd, FREE_OFF, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y5753 ff1a fs2d fc0 sc0 ls0 ws0">681 <span class="_ _186"> </span>err_dump(&quot;_db_findfree:<span class="_"> </span>writew_lock error&quot;);</div><div class="t m0 x32 h57 y57d0 ff1a fs2d fc0 sc0 ls0 ws0">682 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y57d1 ff1a fs2d fc0 sc0 ls0 ws0">683 <span class="_ _8a"> </span>*<span class="_"> </span>Read the free list pointer.</div><div class="t m0 x32 h57 y57d2 ff1a fs2d fc0 sc0 ls0 ws0">684 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y581e ff1a fs2d fc0 sc0 ls0 ws0">685 <span class="_ _15"> </span>saveoffset<span class="_"> </span><span class="ls15c">=F<span class="_ _1d"></span><span class="ls0">REE_OFF;</span></span></div><div class="t m0 x32 h57 y581f ff1a fs2d fc0 sc0 ls0 ws0">686 <span class="_ _15"> </span>offset<span class="_"> </span><span class="ls15c">=_<span class="_ _1d"></span><span class="ls0">db_readptr(db, saveoffset);</span></span></div><div class="t m0 x32 h49 y5820 ff19 fs26 fc0 sc0 ls0 ws0">[655 <span class="_ _a"></span>– <span class="_ _a"></span>661]<span class="_ _65"> </span>Case <span class="_ _3"></span>4: <span class="_ _3"></span>An <span class="_ _3"></span>existing <span class="_ _3"></span>recor<span class="_ _0"></span>d<span class="_ _47"> </span>is<span class="_ _47"> </span>being <span class="_ _3"></span>replaced, <span class="_ _3"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>length <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>new <span class="_ _3"></span>data</div><div class="t m0 x11a h49 y5821 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cor<span class="ls1660">de<span class="_ _8"></span><span class="ls0">quals <span class="_ _3"></span>the <span class="_ _3"></span>length <span class="_ _9"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>existing <span class="_ _9"></span>data <span class="_ _3"></span>recor<span class="_ _0"></span>d. <span class="_ _47"> </span>This<span class="_ _45"> </span>is <span class="_ _3"></span>the <span class="_ _3"></span>easiest <span class="_ _3"></span>case;</span></span></span></div><div class="t m0 x11a h4d y5822 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _9"></span>simply <span class="_ _9"></span>rewrite <span class="_ _3"></span>the <span class="_ _9"></span>data <span class="_ _9"></span>recor<span class="ls903">da<span class="_ _b"></span><span class="ls0">nd <span class="_ _3"></span>increment <span class="_ _9"></span>the <span class="_ _9"></span>counter <span class="_ _9"></span>(<span class="ff1a">cnt_stor4</span>)</span></span></div><div class="t m0 x11a h49 y5823 ff19 fs26 fc0 sc0 ls0 ws0">for this case.</div><div class="t m0 x32 h49 y5824 ff19 fs26 fc0 sc0 ls0 ws0">[662 <span class="_ _a"></span>– <span class="_ _a"></span>667]<span class="_ _65"> </span>In <span class="_ _66"> </span>the <span class="_ _47"> </span>normal <span class="_"> </span>case, <span class="_ _47"> </span>we <span class="_ _66"> </span>set <span class="_ _47"> </span>the <span class="_ _66"> </span>return <span class="_"> </span>code <span class="_ _47"> </span>to <span class="_ _66"> </span>indicate <span class="_ _47"> </span>success <span class="_ _66"> </span>and <span class="_ _47"> </span>fall</div><div class="t m0 x11a h49 y5825 ff19 fs26 fc0 sc0 ls0 ws0">through <span class="_ _42"> </span>to <span class="_ _53"> </span>the <span class="_ _42"> </span>common <span class="_ _53"> </span>return <span class="_ _42"> </span>logic.<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>u<span class="_ _9"></span></span>nlock <span class="_ _53"> </span>the <span class="_ _42"> </span>hash <span class="_ _53"> </span>chain <span class="_ _53"> </span>that <span class="_ _53"> </span>was</div><div class="t m0 x11a h4d y5826 ff19 fs26 fc0 sc0 ls0 ws0">locked as a result of calling<span class="_"> </span><span class="ff1a">_db_find_and_lock<span class="_ _80"> </span></span>and return to the caller<span class="_ _6"></span>.</div><div class="t m0 x32 h4d y5827 ff19 fs26 fc0 sc0 ls0 ws0">[668 <span class="_ _a"></span>– <span class="_ _a"></span>686]<span class="_ _65"> </span>The<span class="_ _66"> </span><span class="ff1a">_db_findfree<span class="_ _47"> </span></span>function <span class="_ _2"></span>tries <span class="_ _2"></span>to <span class="_ _2"></span>ﬁnd <span class="_ _3"></span>a <span class="_ _2"></span>free index <span class="_ _3"></span>recor<span class="_ _0"></span><span class="lsc4d">da<span class="_ _4f"></span><span class="ls0">nd <span class="_ _2"></span>associated</span></span></div><div class="t m0 x11a h49 y5828 ff19 fs26 fc0 sc0 ls0 ws0">data record<span class="_"> </span>of<span class="_ _66"> </span>the <span class="_ _2"></span>speciﬁed <span class="_ _2"></span>sizes.<span class="_ _46"> </span><span class="ls164">We <span class="_ _e"> </span>n<span class="_ _23"></span></span>eed to <span class="_ _2"></span>write <span class="_ _2"></span>lock the <span class="_ _2"></span>free list <span class="_ _2"></span>to <span class="_ _2"></span>avoid</div><div class="t m0 x11a h49 y5829 ff19 fs26 fc0 sc0 ls0 ws0">interfering with any <span class="_ _2"></span>other processes using the <span class="_ _2"></span>free list.<span class="_ _59"> </span>After <span class="_ _2"></span>locking the <span class="_ _2"></span>free</div><div class="t m0 x11a h49 y582a ff19 fs26 fc0 sc0 ls0 ws0">list, we get the pointer address at the head of the list.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
