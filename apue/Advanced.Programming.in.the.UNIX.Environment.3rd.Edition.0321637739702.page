<div id="pf2be" class="pf w4 h1f" data-page-no="2be"><div class="pc pc2be w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2be.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">668<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>IPC<span class="_ _e8"> </span>Chapter <span class="_"> </span>17</span></div><div class="t m0 x36 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x36 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">numfd--;</div><div class="t m0 x1ca h57 y800 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {<span class="_ _186"> </span>/* process client’s request */</span></div><div class="t m0 x36 h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">handle_request(buf, nread, pollfd[i].fd,</div><div class="t m0 x1f7 h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">client[i].uid);</div><div class="t m0 x1ca h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1f h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y805 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y806 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y807 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x27 h5e y3391 ff18 fs10 fc0 sc0 ls0 ws0">Figure 17.30<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">loop<span class="_ _e"> </span></span>function using<span class="_"> </span><span class="ff1a">poll</span></span></div><div class="t m0 x32 h49 y3392 ff19 fs26 fc0 sc0 ls164 ws0">To <span class="_ _45"> </span>a<span class="_ _23"></span><span class="ls0">llow <span class="_ _42"> </span>for <span class="_ _53"> </span>as <span class="_ _53"> </span>many <span class="_ _53"> </span>clients <span class="_ _53"> </span>as <span class="_ _53"> </span>ther<span class="ls1415">ea<span class="_ _c"></span><span class="lscc">re <span class="_"> </span>p<span class="ls0">ossible <span class="_ _42"> </span>open <span class="_ _53"> </span>descriptors, <span class="_ _53"> </span>we <span class="_ _53"> </span>dynamically</span></span></span></span></div><div class="t m0 x32 h4d y3393 ff19 fs26 fc0 sc0 ls0 ws0">allocate <span class="_ _2"></span>space <span class="_ _2"></span>for <span class="_ _3"></span>the <span class="_ _2"></span>array <span class="_ _3"></span>of<span class="_ _66"> </span><span class="ff1a">pollfd<span class="_ _47"> </span></span>structures using <span class="_ _3"></span>the <span class="_ _2"></span>same <span class="_ _3"></span>strategy <span class="_ _2"></span>as <span class="_ _2"></span>used <span class="_ _3"></span>in <span class="_ _2"></span>the</div><div class="t m0 x32 h4d y3394 ff1a fs26 fc0 sc0 ls0 ws0">client_alloc<span class="_ _80"> </span><span class="ff19">function for the<span class="_"> </span></span>client<span class="_ _66"> </span><span class="ff19">array (see Figur<span class="lsd3">e1<span class="_ _4f"></span><span class="ls0">7.27).</span></span></span></div><div class="t m0 x3f h4d y3395 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _66"> </span>u<span class="_ _9"></span><span class="ls0">se <span class="_ _23"></span>the <span class="_ _9"></span>ﬁrst <span class="_ _9"></span>entry <span class="_ _23"></span>(index <span class="_ _9"></span>0) <span class="_ _9"></span>of <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">pollfd<span class="_ _45"> </span></span>array <span class="_ _9"></span>for <span class="_ _9"></span>the<span class="_ _35"> </span><span class="ff1a">listenfd<span class="_ _45"> </span></span>descriptor<span class="_ _6"></span>.</span></div><div class="t m0 x32 h4d y3396 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _e"> </span>arrival <span class="_ _e"> </span>of <span class="_"> </span>a <span class="_ _53"> </span>new <span class="_"> </span>client <span class="_ _53"> </span>connection <span class="_"> </span>is <span class="_ _53"> </span>indicated <span class="_"> </span>by <span class="_ _53"> </span>a<span class="_ _59"> </span><span class="ff1a">POLLIN<span class="_ _4b"> </span></span>on <span class="_"> </span>the<span class="_ _4b"> </span><span class="ff1a">listenfd</span></div><div class="t m0 x32 h4d y3397 ff19 fs26 fc0 sc0 ls0 ws0">descriptor<span class="_ _6"></span><span class="ls199">.A<span class="_ _4a"></span><span class="lsd3">sb<span class="_ _d"></span><span class="ls0">efore, we call<span class="_"> </span><span class="ff1a">serv_accept<span class="_ _80"> </span></span>to accept the connection.</span></span></span></div><div class="t m0 x3f h4d y3398 ff19 fs26 fc0 sc0 ls0 ws0">For <span class="_ _23"></span>an <span class="_ _9"></span>existing <span class="_ _23"> </span>client, <span class="_ _23"> </span>we <span class="_ _23"></span>have <span class="_ _23"></span>to <span class="_ _9"></span>handle <span class="_ _23"> </span>two <span class="_ _23"> </span>differ<span class="_ _0"></span>ent <span class="_ _23"></span>events <span class="_ _23"></span>fr<span class="_ _0"></span>om<span class="_ _45"> </span><span class="ff1a">poll</span><span class="ls1416">:ac<span class="_ _b"></span><span class="ls0">lient</span></span></div><div class="t m0 x32 h4d y3399 ff19 fs26 fc0 sc0 ls0 ws0">termination <span class="_"> </span>is <span class="_ _e"> </span>indicated <span class="_"> </span>by<span class="_ _4b"> </span><span class="ff1a">POLLHUP</span><span class="ls1417">,a<span class="_ _55"></span><span class="ls0">nd <span class="_"> </span>a <span class="_ _e"> </span>new <span class="_"> </span>r<span class="_ _0"></span>equest <span class="_"> </span>fr<span class="_ _1"></span>om <span class="_"> </span>an <span class="_"> </span>existing <span class="_ _e"> </span>client <span class="_"> </span>is</span></span></div><div class="t m0 x32 h4d y339a ff19 fs26 fc0 sc0 ls0 ws0">indicated <span class="_ _9"></span>by<span class="_ _45"> </span><span class="ff1a">POLLIN</span><span class="ls1418">.T<span class="_ _26"></span><span class="ls0">he <span class="_ _9"></span>client <span class="_ _9"></span>can <span class="_ _9"></span>close <span class="_ _9"></span>its <span class="_ _9"></span>end <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>connection <span class="_ _9"></span>while <span class="_ _9"></span>there<span class="_ _45"> </span>is<span class="_ _45"> </span>still</span></span></div><div class="t m0 x32 h49 y4e62 ff19 fs26 fc0 sc0 ls0 ws0">data <span class="_ _9"></span>to <span class="_ _23"> </span>be <span class="_ _23"></span>read <span class="_ _9"></span>from <span class="_ _9"></span>the <span class="_ _23"></span>server<span class="_ _3"></span>’s <span class="_ _23"></span>end <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>connection.<span class="_ _5a"> </span>Even <span class="_ _23"></span>though <span class="_ _9"></span>the <span class="_ _23"></span>endpoint <span class="_ _23"></span>is</div><div class="t m0 x32 h49 y4e63 ff19 fs26 fc0 sc0 ls0 ws0">marked <span class="_ _9"></span>as <span class="_ _23"></span>hung <span class="_ _9"></span>up, <span class="_ _23"></span>the <span class="_ _9"></span>server <span class="_ _23"></span>can <span class="_ _9"></span>read <span class="_ _9"></span>all <span class="_ _23"></span>the <span class="_ _9"></span>data <span class="_ _23"></span>queued <span class="_ _9"></span>on <span class="_ _23"></span>its <span class="_ _9"></span>end.<span class="_ _51"> </span>But <span class="_ _9"></span>with <span class="_ _23"></span>this</div><div class="t m0 x32 h4d y4e64 ff19 fs26 fc0 sc0 ls0 ws0">server<span class="_ _6"></span><span class="ls1419">,w<span class="_ _d"></span><span class="ls0">hen <span class="_ _2"></span>we receive the hangup from the client, we <span class="_ _2"></span>can<span class="_"> </span><span class="ff1a">close<span class="_ _66"> </span></span>the connection to <span class="_ _2"></span>the</span></span></div><div class="t m0 x32 h49 y4e65 ff19 fs26 fc0 sc0 ls0 ws0">client, <span class="_ _23"></span>effectively <span class="_ _9"></span>throwing <span class="_ _23"></span>away <span class="_ _23"></span>any <span class="_ _23"></span>queued <span class="_ _23"></span>data.<span class="_ _51"> </span>Ther<span class="_ _0"></span>e<span class="_ _35"> </span>is<span class="_ _45"> </span>no<span class="_ _35"> </span>reason <span class="_ _9"></span>to <span class="_ _23"> </span>process <span class="_ _23"></span>any</div><div class="t m0 x32 h49 y4e66 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">quests still remaining, since we can’t send any responses back.</span></div><div class="t m0 x3f h4d y4e67 ff19 fs26 fc0 sc0 ls0 ws0">As with the<span class="_"> </span><span class="ff1a">select<span class="_ _66"> </span></span>version of <span class="_ _2"></span>this function, new <span class="_ _2"></span>requests fr<span class="_ _0"></span>om a client <span class="_ _2"></span>ar<span class="ls11ae">eh<span class="_ _4f"></span><span class="ls0">andled</span></span></div><div class="t m0 x32 h4d y4e68 ff19 fs26 fc0 sc0 ls0 ws0">by <span class="_ _2"></span>calling <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">handle_request<span class="_ _66"> </span></span>function <span class="_ _3"></span>(Figur<span class="ls141a">e1<span class="_ _8"></span><span class="ls0">7.31). <span class="_ _47"> </span>This<span class="_ _47"> </span>function <span class="_ _2"></span>is <span class="_ _3"></span>similar <span class="_ _2"></span>to <span class="_ _3"></span>the</span></span></div><div class="t m0 x32 h4d y4e69 ff19 fs26 fc0 sc0 ls0 ws0">earlier <span class="_ _3"></span>version <span class="_ _9"></span>(Figur<span class="ls141b">e1<span class="_ _b"></span><span class="ls0">7.22). <span class="_ _47"> </span>It<span class="_ _45"> </span>calls <span class="_ _3"></span>the <span class="_ _9"></span>same <span class="_ _3"></span>function,<span class="_ _45"> </span><span class="ff1a">buf_args<span class="_ _47"> </span></span>(Figur<span class="ls141b">e1<span class="_ _b"></span><span class="ls0">7.23), <span class="_ _3"></span>that</span></span></span></span></div><div class="t m0 x32 h4d y4e6a ff19 fs26 fc0 sc0 ls0 ws0">calls<span class="_ _35"> </span><span class="ff1a">cli_args<span class="_ _44"> </span></span>(Figur<span class="_ _0"></span><span class="ls141c">e1<span class="_ _43"></span><span class="ls0">7.24), <span class="_ _23"> </span>but <span class="_ _42"> </span>since <span class="_ _42"> </span>it <span class="_ _23"> </span>runs <span class="_ _42"> </span>from <span class="_ _23"> </span>a <span class="_ _42"> </span>daemon <span class="_ _23"> </span>process, <span class="_ _23"> </span>it <span class="_ _42"> </span>logs <span class="_ _42"> </span>error</span></span></div><div class="t m0 x32 h49 y4e6b ff19 fs26 fc0 sc0 ls0 ws0">messages instead of printing them on the standar<span class="lsd3">de<span class="_ _4f"></span><span class="ls0">rror<span class="_ _6"></span>.</span></span></div><div class="t m0 x32 h5d y4e6c ff1a fs2f fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&quot;opend.h&quot;</div><div class="t m0 x32 h5d y4e6d ff1a fs2f fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;fcntl.h&gt;</div><div class="t m0 x32 h5d y4e6e ff1a fs2f fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h5d y4e6f ff1a fs2f fc0 sc0 ls0 ws0">handle_request(char *buf, int nread, int clifd, uid_t uid)</div><div class="t m0 x32 h5d y4e70 ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y4e71 ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>newfd;</div><div class="t m0 x8a h5d y4e72 ff1a fs2f fc0 sc0 ls0 ws0">if (buf[nread-1] != 0) {</div><div class="t m0 x9d h5d y4e73 ff1a fs2f fc0 sc0 ls0 ws0">snprintf(errmsg, MAXLINE-1,</div><div class="t m0 x76 h5d y4e74 ff1a fs2f fc0 sc0 ls0 ws0">&quot;request from uid %d not null terminated: %*.*s\n&quot;,</div><div class="t m0 x76 h5d y4e75 ff1a fs2f fc0 sc0 ls0 ws0">uid, nread, nread, buf);</div><div class="t m0 x9d h5d y4e76 ff1a fs2f fc0 sc0 ls0 ws0">send_err(clifd, -1, errmsg);</div><div class="t m0 x9d h5d y4e77 ff1a fs2f fc0 sc0 ls0 ws0">return;</div><div class="t m0 x8a h5d y4e78 ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h5d y4e79 ff1a fs2f fc0 sc0 ls0 ws0">log_msg(&quot;request: %s, from uid %d&quot;, buf, uid);</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
