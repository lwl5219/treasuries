<div id="pf360" class="pf w4 h1f" data-page-no="360"><div class="pc pc360 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg360.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">830<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">549 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">550 <span class="_ _68"> </span>*<span class="_"> </span>Deal with signals.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">551 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">552 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: acquires and releases configlock.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">553 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">554 <span class="_ _d9"> </span>void<span class="_"> </span>*</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">555 <span class="_ _d9"> </span>signal_thread(void<span class="_"> </span>*arg)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">556 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">557 <span class="_ _15"> </span>int <span class="_ _15"> </span>err,<span class="_"> </span>signo;</div><div class="t m0 x32 h57 y2f23 ff1a fs2d fc0 sc0 ls0 ws0">558 <span class="_ _15"> </span>for<span class="_"> </span>(;;) {</div><div class="t m0 x32 h57 y2f24 ff1a fs2d fc0 sc0 ls0 ws0">559 <span class="_ _186"> </span>err<span class="_"> </span><span class="ls15c">=s<span class="_ _1d"></span><span class="ls0">igwait(&amp;mask, &amp;signo);</span></span></div><div class="t m0 x32 h57 y2f25 ff1a fs2d fc0 sc0 ls0 ws0">560 <span class="_ _186"> </span>if<span class="_"> </span>(err != 0)</div><div class="t m0 x32 h57 y5712 ff1a fs2d fc0 sc0 ls0 ws0">561 <span class="_ _82"> </span>log_quit(&quot;sigwait<span class="_"> </span>failed: %s&quot;, strerror(err));</div><div class="t m0 x32 h57 y5713 ff1a fs2d fc0 sc0 ls0 ws0">562 <span class="_ _186"> </span>switch<span class="_"> </span>(signo) {</div><div class="t m0 x32 h57 y5714 ff1a fs2d fc0 sc0 ls0 ws0">563 <span class="_ _186"> </span>case<span class="_"> </span>SIGHUP:</div><div class="t m0 x32 h57 y5715 ff1a fs2d fc0 sc0 ls0 ws0">564 <span class="_ _82"> </span>/*</div><div class="t m0 x32 h57 y5716 ff1a fs2d fc0 sc0 ls0 ws0">565 <span class="_ _166"> </span>*<span class="_"> </span>Schedule to re-read the configuration file.</div><div class="t m0 x32 h57 y5717 ff1a fs2d fc0 sc0 ls0 ws0">566 <span class="_ _166"> </span>*/</div><div class="t m0 x32 h57 y5844 ff1a fs2d fc0 sc0 ls0 ws0">567 <span class="_ _82"> </span>pthread_mutex_lock(&amp;configlock);</div><div class="t m0 x32 h57 y5845 ff1a fs2d fc0 sc0 ls0 ws0">568 <span class="_ _82"> </span>reread<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y5846 ff1a fs2d fc0 sc0 ls0 ws0">569 <span class="_ _82"> </span>pthread_mutex_unlock(&amp;configlock);</div><div class="t m0 x32 h57 y5847 ff1a fs2d fc0 sc0 ls0 ws0">570 <span class="_ _82"> </span>break;</div><div class="t m0 x32 h57 y568b ff1a fs2d fc0 sc0 ls0 ws0">571 <span class="_ _186"> </span>case<span class="_"> </span>SIGTERM:</div><div class="t m0 x32 h57 y568c ff1a fs2d fc0 sc0 ls0 ws0">572 <span class="_ _82"> </span>kill_workers();</div><div class="t m0 x32 h57 y568d ff1a fs2d fc0 sc0 ls0 ws0">573 <span class="_ _82"> </span>log_msg(&quot;terminate<span class="_"> </span>with signal %s&quot;, strsignal(signo));</div><div class="t m0 x32 h57 y56fe ff1a fs2d fc0 sc0 ls0 ws0">574 <span class="_ _82"> </span>exit(0);</div><div class="t m0 x32 h57 y33bb ff1a fs2d fc0 sc0 ls0 ws0">575 <span class="_ _186"> </span>default:</div><div class="t m0 x32 h57 y33bc ff1a fs2d fc0 sc0 ls0 ws0">576 <span class="_ _82"> </span>kill_workers();</div><div class="t m0 x32 h57 y5784 ff1a fs2d fc0 sc0 ls0 ws0">577 <span class="_ _82"> </span>log_quit(&quot;unexpected<span class="_"> </span>signal %d&quot;, signo);</div><div class="t m0 x32 h57 y5a27 ff1a fs2d fc0 sc0 ls0 ws0">578 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y5a28 ff1a fs2d fc0 sc0 ls0 ws0">579 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y5a29 ff1a fs2d fc0 sc0 ls0 ws0">580 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y5c3a ff19 fs26 fc0 sc0 ls0 ws0">[549 <span class="_ _a"></span>– <span class="_ _a"></span>562]<span class="_ _65"> </span>The<span class="_ _35"> </span><span class="ff1a">signal_thread<span class="_ _44"> </span></span>function <span class="_ _42"> </span>is <span class="_ _42"> </span>run <span class="_ _23"> </span>by <span class="_ _42"> </span>the <span class="_ _42"> </span>thread <span class="_ _23"> </span>that <span class="_ _42"> </span>is <span class="_ _42"> </span>responsible <span class="_ _23"> </span>for</div><div class="t m0 x11a h4d y5c3b ff19 fs26 fc0 sc0 ls0 ws0">handling <span class="_ _53"> </span>signals.<span class="_ _54"> </span>In <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">main<span class="_ _44"> </span></span>function, <span class="_ _53"> </span>we <span class="_ _53"> </span>initialized <span class="_ _53"> </span>the <span class="_ _53"> </span>signal <span class="_ _53"> </span>mask <span class="_ _53"> </span>to</div><div class="t m0 x11a h4d y5c3c ff19 fs26 fc0 sc0 ls0 ws0">include<span class="_ _35"> </span><span class="ff1a">SIGHUP<span class="_ _35"> </span></span>and<span class="_ _44"> </span><span class="ff1a">SIGTERM</span><span class="ls17af">.H<span class="_ _52"></span><span class="ls0">ere, <span class="_ _23"> </span>we <span class="_ _42"> </span>call<span class="_ _35"> </span><span class="ff1a">sigwait<span class="_ _44"> </span></span>to <span class="_ _23"> </span>wait <span class="_ _42"> </span>for <span class="_ _23"> </span>one <span class="_ _42"> </span>of</span></span></div><div class="t m0 x11a h4d y5c3d ff19 fs26 fc0 sc0 ls0 ws0">these signals to occur<span class="_ _6"></span><span class="ls199">.I<span class="_ _4a"></span><span class="ls0">f<span class="_"> </span><span class="ff1a">sigwait<span class="_ _66"> </span></span>fails, we log an error message and exit.</span></span></div><div class="t m0 x32 h4d y5c3e ff19 fs26 fc0 sc0 ls0 ws0">[563 <span class="_ _a"></span>– <span class="_ _a"></span>570]<span class="_ _65"> </span>If <span class="_ _9"></span>we <span class="_ _23"></span>r<span class="_ _0"></span>eceive<span class="_ _45"> </span><span class="ff1a">SIGHUP</span>,<span class="_ _45"> </span>we<span class="_ _35"> </span>acquir<span class="_ _0"></span><span class="ls93d">et<span class="_ _b"></span><span class="ls0">he<span class="_ _45"> </span><span class="ff1a">configlock<span class="_ _45"> </span></span>mutex, <span class="_ _9"></span>set <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">reread</span></span></span></div><div class="t m0 x11a h49 y5c3f ff19 fs26 fc0 sc0 ls0 ws0">variable <span class="_ _2"></span>to <span class="_ _3"></span>1, <span class="_ _3"></span>and <span class="_ _3"></span>release <span class="_ _3"></span>the <span class="_ _2"></span>mutex.<span class="_ _16"> </span>This <span class="_ _3"></span>tells <span class="_ _3"></span>the <span class="_ _3"></span>printer <span class="_ _3"></span>daemon <span class="_ _3"></span>to <span class="_ _3"></span>rer<span class="_ _0"></span>ead</div><div class="t m0 x11a h49 y5c40 ff19 fs26 fc0 sc0 ls0 ws0">the conﬁguration ﬁle on the next iteration in its processing loop.</div><div class="t m0 x32 h4d y5c41 ff19 fs26 fc0 sc0 ls0 ws0">[571 <span class="_ _a"></span>– <span class="_ _a"></span>574]<span class="_ _65"> </span>If <span class="_ _45"> </span>we <span class="_ _45"> </span>r<span class="_ _0"></span>eceive<span class="_ _5a"> </span><span class="ff1a">SIGTERM</span><span class="ls17b0">,w<span class="_ _26"></span><span class="ls17b1">ec<span class="_ _62"></span><span class="ls0">all<span class="_ _5a"> </span><span class="ff1a">kill_workers<span class="_"> </span></span>to <span class="_ _45"> </span>kill <span class="_ _45"> </span>all <span class="_ _45"> </span>the <span class="_ _47"> </span>worker</span></span></span></div><div class="t m0 x11a h4d y5c42 ff19 fs26 fc0 sc0 ls0 ws0">threads, log a message, and call<span class="_"> </span><span class="ff1a">exit<span class="_ _80"> </span></span>to terminate the process.</div><div class="t m0 x32 h49 y5c43 ff19 fs26 fc0 sc0 ls0 ws0">[575 <span class="_ _a"></span>– <span class="_ _a"></span>580]<span class="_ _65"> </span>If <span class="_ _9"></span>we <span class="_ _9"></span>receive <span class="_ _9"></span>a <span class="_ _9"></span>signal <span class="_ _9"></span>we <span class="_ _23"></span>ar<span class="lse08">en<span class="_ _b"></span><span class="ls0">ot <span class="_ _3"></span>expecting, <span class="_ _9"></span>we <span class="_ _23"></span>kill <span class="_ _9"></span>the <span class="_ _9"></span>worker <span class="_ _9"></span>threads <span class="_ _9"></span>and</span></span></div><div class="t m0 x11a h4d y5c44 ff19 fs26 fc0 sc0 ls0 ws0">call<span class="_"> </span><span class="ff1a">log_quit<span class="_ _80"> </span></span>to log an error message and exit.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
