<div id="pf28b" class="pf w4 h1f" data-page-no="28b"><div class="pc pc28b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg28b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>16.5<span class="_ _2db"> </span>Data <span class="_"> </span>T<span class="_ _6"></span>ransfer<span class="_ _1b"> </span><span class="ff18">617</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _35"> </span>ﬁ<span class="_ _9"></span><span class="ls0">nd <span class="_ _53"> </span>its <span class="_ _e"> </span>address, <span class="_ _42"> </span>the <span class="_ _e"> </span>server <span class="_ _53"> </span>needs <span class="_ _e"> </span>to <span class="_ _53"> </span>get <span class="_ _e"> </span>the <span class="_ _53"> </span>name <span class="_ _e"> </span>of <span class="_ _53"> </span>the <span class="_ _e"> </span>host <span class="_ _53"> </span>on <span class="_ _e"> </span>which <span class="_ _53"> </span>it <span class="_ _53"> </span>is</span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls4e ws0">ru<span class="ls0">nning. <span class="_ _9"></span>If <span class="_ _9"></span>the <span class="_ _3"></span>maximum <span class="_ _9"></span>host <span class="_ _9"></span>name <span class="_ _9"></span>length <span class="_ _9"></span>is <span class="_ _3"></span>indeterminate, <span class="_ _9"></span>we <span class="_ _9"></span>use<span class="_ _45"> </span><span class="ff1a">HOST_NAME_MAX</span></span></div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 ls0 ws0">instead. <span class="_"> </span>If<span class="_ _47"> </span>the <span class="_ _2"></span>system doesn’t <span class="_ _2"></span>deﬁne<span class="_ _47"> </span><span class="ff1a">HOST_NAME_MAX</span>,<span class="_"> </span>we<span class="_ _47"> </span>deﬁne <span class="_ _2"></span>it ourselves.<span class="_ _61"> </span>POSIX.1</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">quires <span class="_ _e"> </span>the <span class="_ _e"> </span>maximum <span class="_ _e"> </span>host <span class="_ _e"> </span>name <span class="_ _e"> </span>length <span class="_ _e"> </span>to <span class="_ _e"> </span>be <span class="_ _e"> </span>at <span class="_ _e"> </span>least <span class="_ _e"> </span>255 <span class="_ _e"> </span>bytes, <span class="_ _e"> </span>not <span class="_ _e"> </span>including <span class="_"> </span>the</span></div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">terminating <span class="_ _42"> </span>null, <span class="_ _23"> </span>so <span class="_ _42"> </span>we <span class="_ _42"> </span>deﬁne<span class="_ _35"> </span><span class="ff1a">HOST_NAME_MAX<span class="_ _44"> </span></span>to <span class="_ _42"> </span>be <span class="_ _23"> </span>256 <span class="_ _42"> </span>to <span class="_ _42"> </span>include <span class="_ _42"> </span>the <span class="_ _23"> </span>terminating</div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">null.</div><div class="t m0 x3f h26 y135 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _9"></span>server <span class="_ _23"></span>gets <span class="_ _9"></span>the <span class="_ _23"></span>host <span class="_ _9"></span>name <span class="_ _23"></span>by <span class="_ _9"></span>calling<span class="_ _45"> </span><span class="ff1a">gethostname<span class="_ _35"> </span></span>and <span class="_ _9"></span>looks <span class="_ _23"></span>up <span class="_ _9"></span>the <span class="_ _23"></span>addr<span class="_ _0"></span>ess</div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">for <span class="_"> </span>the <span class="_ _e"> </span>remote <span class="_"> </span>uptime <span class="_ _e"> </span>service.<span class="_ _60"> </span>Multiple <span class="_"> </span>addr<span class="_ _0"></span>esses <span class="_"> </span>can <span class="_ _e"> </span>be <span class="_"> </span>returned, <span class="_ _e"> </span>but <span class="_"> </span>we <span class="_"> </span>simply</div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">choose <span class="_ _2"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _2"></span>one <span class="_ _3"></span>for <span class="_ _2"></span>which <span class="_ _3"></span>we <span class="_ _2"></span>can <span class="_ _3"></span>establish <span class="_ _3"></span>a <span class="_ _2"></span>passive <span class="_ _3"></span>socket <span class="_ _2"></span>endpoint <span class="_ _3"></span>(i.e., <span class="_ _2"></span>one <span class="_ _3"></span>used</div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">only to listen for connect requests). <span class="_"> </span>Handling<span class="_"> </span>multiple addr<span class="_ _0"></span>esses is left as an exer<span class="_ _0"></span>cise.</div><div class="t m0 x3f h26 y139 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>u<span class="_ _9"></span><span class="ls0">se the<span class="_ _66"> </span><span class="ff1a">initserver<span class="_ _66"> </span></span>function from Figur<span class="lsf60">e1<span class="_ _4f"></span><span class="ls0">6.12 to initialize <span class="_ _2"></span>the socket endpoint</span></span></span></div><div class="t m0 x32 h2a y13a ff19 fsf fc0 sc0 ls0 ws0">on which we <span class="_ _2"></span>will wait <span class="_ _2"></span>for connect <span class="_ _2"></span>requests to arrive.<span class="_ _46"> </span>(Actually<span class="_ _6"></span>,<span class="_"> </span>we<span class="_"> </span>u<span class="_ _2"></span>se the version <span class="_ _2"></span>from</div><div class="t m0 x32 h2a y254 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">6.22; we’ll see why when we discuss socket options in Section 16.6.)</span></span></div><div class="t m0 x35 h4c y49e9 ff16 fs26 fc0 sc0 ls0 ws0">Example <span class="_ _84"></span>— <span class="_ _84"></span>Alternative<span class="_"> </span>Connection-Oriented Ser<span class="_ _2"></span>ver</div><div class="t m0 x32 h49 y49ea ff19 fs26 fc0 sc0 ls0 ws0">Previously<span class="_ _4"></span>,<span class="_ _16"> </span>we<span class="_ _16"> </span>stated <span class="_ _45"> </span>that <span class="_ _47"> </span>using <span class="_ _45"> </span>ﬁle <span class="_ _47"> </span>descriptors <span class="_ _45"> </span>to <span class="_ _47"> </span>access <span class="_ _45"> </span>sockets <span class="_ _47"> </span>was <span class="_ _45"> </span>signiﬁcant,</div><div class="t m0 x32 h49 y49eb ff19 fs26 fc0 sc0 ls0 ws0">because <span class="_"> </span>it <span class="_"> </span>allowed <span class="_ _e"> </span>programs <span class="_"> </span>that <span class="_ _e"> </span>knew <span class="_"> </span>nothing <span class="_"> </span>about <span class="_ _e"> </span>networking <span class="_"> </span>to <span class="_"> </span>be <span class="_"> </span>used <span class="_ _e"> </span>in <span class="_"> </span>a</div><div class="t m0 x32 h49 y49ec ff19 fs26 fc0 sc0 ls0 ws0">networked environment. <span class="_"> </span>The<span class="_"> </span>version of <span class="_ _2"></span>the server shown <span class="_ _2"></span>in Figur<span class="ls136e">e1<span class="_ _4f"></span><span class="ls0">6.18 <span class="_ _2"></span>illustrates this</span></span></div><div class="t m0 x32 h4d y49ed ff19 fs26 fc0 sc0 ls0 ws0">point. <span class="_ _44"> </span>Instead<span class="_ _44"> </span>of <span class="_ _42"> </span>reading <span class="_ _42"> </span>the <span class="_ _42"> </span>output <span class="_ _53"> </span>of <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">uptime<span class="_ _44"> </span></span>command <span class="_ _53"> </span>and <span class="_ _42"> </span>sending <span class="_ _42"> </span>it <span class="_ _53"> </span>to <span class="_ _42"> </span>the</div><div class="t m0 x32 h49 y49ee ff19 fs26 fc0 sc0 ls0 ws0">client, <span class="_ _66"> </span>the <span class="_ _47"> </span>server <span class="_ _47"> </span>arranges <span class="_ _66"> </span>to <span class="_ _47"> </span>have <span class="_ _47"> </span>the <span class="_ _66"> </span>standar<span class="ls5b7">do<span class="_ _1d"></span><span class="ls0">utput <span class="_ _47"> </span>and <span class="_ _47"> </span>standar<span class="ls5b7">de<span class="_ _62"></span><span class="ls0">rror <span class="_ _47"> </span>of <span class="_ _66"> </span>the</span></span></span></span></div><div class="t m0 x32 h4d y49ef ff1a fs26 fc0 sc0 ls0 ws0">uptime<span class="_ _80"> </span><span class="ff19">command be the socket endpoint connected to the client.</span></div><div class="t m0 x32 h5d y49f0 ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h5d y49f1 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;netdb.h&gt;</div><div class="t m0 x32 h5d y49f2 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h5d y49f3 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;syslog.h&gt;</div><div class="t m0 x32 h5d y49f4 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h5d y49f5 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x32 h5d y49f6 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;sys/wait.h&gt;</div><div class="t m0 x32 h5d y49f7 ff1a fs2f fc0 sc0 ls0 ws0">#define QLEN 10</div><div class="t m0 x32 h5d y49f8 ff1a fs2f fc0 sc0 ls0 ws0">#ifndef HOST_NAME_MAX</div><div class="t m0 x32 h5d y49f9 ff1a fs2f fc0 sc0 ls0 ws0">#define HOST_NAME_MAX 256</div><div class="t m0 x32 h5d y49fa ff1a fs2f fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x32 h5d y49fb ff1a fs2f fc0 sc0 ls0 ws0">extern int initserver(int, const struct sockaddr *, socklen_t, int);</div><div class="t m0 x32 h5d y49fc ff1a fs2f fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h5d y49fd ff1a fs2f fc0 sc0 ls0 ws0">serve(int sockfd)</div><div class="t m0 x32 h5d y49fe ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y49ff ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>clfd,<span class="_"> </span>status;</div><div class="t m0 x8a h5d y4a00 ff1a fs2f fc0 sc0 ls0 ws0">pid_t <span class="_ _d9"> </span>pid;</div><div class="t m0 x8a h5d y4a01 ff1a fs2f fc0 sc0 ls0 ws0">set_cloexec(sockfd);</div><div class="t m0 x8a h5d y4a02 ff1a fs2f fc0 sc0 ls0 ws0">for (;;) {</div><div class="t m0 x9d h5d y4a03 ff1a fs2f fc0 sc0 ls0 ws0">if ((clfd = accept(sockfd, NULL, NULL)) &lt; 0) {</div><div class="t m0 x1f h5d y4a04 ff1a fs2f fc0 sc0 ls0 ws0">syslog(LOG_ERR, &quot;ruptimed: accept error: %s&quot;,</div><div class="t m0 xae h5d y4a05 ff1a fs2f fc0 sc0 ls0 ws0">strerror(errno));</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
