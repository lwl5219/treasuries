<div id="pf347" class="pf w4 h1f" data-page-no="347"><div class="pc pc347 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg347.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">805</span></div><div class="t m0 x140 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">95 <span class="_ _d9"> </span>/*</div><div class="t m0 x140 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">96 <span class="_ _68"> </span>*<span class="_"> </span>&quot;Timed&quot; read - timout specifies the # of seconds to wait before</div><div class="t m0 x140 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">97 <span class="_ _68"> </span>*<span class="_"> </span>giving up (5th argument to select controls how long to wait for</div><div class="t m0 x140 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">98 <span class="_ _68"> </span>*<span class="_"> </span>data to be readable).<span class="_ _3a"> </span>Returns # of bytes read or -1 on error.</div><div class="t m0 x140 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">99 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">100 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">101 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">102 <span class="_ _d9"> </span>ssize_t</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">103 <span class="_ _d9"> </span>tread(int<span class="_"> </span>fd, void *buf, size_t nbytes, unsigned int timout)</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">104 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">105 <span class="_ _15"> </span>int<span class="_ _166"> </span>nfds;</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">106 <span class="_ _15"> </span>fd_set<span class="_ _74"> </span>readfds;</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">107 <span class="_ _15"> </span>struct<span class="_"> </span>timeval <span class="_"> </span>tv;</div><div class="t m0 x32 h57 y2c5b ff1a fs2d fc0 sc0 ls0 ws0">108 <span class="_ _15"> </span>tv.tv_sec<span class="_"> </span><span class="ls15c">=t<span class="_ _1d"></span><span class="ls0">imout;</span></span></div><div class="t m0 x32 h57 y2c5c ff1a fs2d fc0 sc0 ls0 ws0">109 <span class="_ _15"> </span>tv.tv_usec<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y2c5d ff1a fs2d fc0 sc0 ls0 ws0">110 <span class="_ _15"> </span>FD_ZERO(&amp;readfds);</div><div class="t m0 x32 h57 y2c5e ff1a fs2d fc0 sc0 ls0 ws0">111 <span class="_ _15"> </span>FD_SET(fd,<span class="_"> </span>&amp;readfds);</div><div class="t m0 x32 h57 y2c5f ff1a fs2d fc0 sc0 ls0 ws0">112 <span class="_ _15"> </span>nfds<span class="_"> </span><span class="ls15c">=s<span class="_ _1d"></span><span class="ls0">elect(fd+1, &amp;readfds, NULL, NULL, &amp;tv);</span></span></div><div class="t m0 x32 h57 y2c60 ff1a fs2d fc0 sc0 ls0 ws0">113 <span class="_ _15"> </span>if<span class="_"> </span>(nfds &lt;= 0) {</div><div class="t m0 x32 h57 y2c61 ff1a fs2d fc0 sc0 ls0 ws0">114 <span class="_ _186"> </span>if<span class="_"> </span>(nfds == 0)</div><div class="t m0 x32 h57 y2c62 ff1a fs2d fc0 sc0 ls0 ws0">115 <span class="_ _82"> </span>errno<span class="_"> </span><span class="ls15c">=E<span class="_ _1d"></span><span class="ls0">TIME;</span></span></div><div class="t m0 x32 h57 y5689 ff1a fs2d fc0 sc0 ls0 ws0">116 <span class="_ _186"> </span>return(-1);</div><div class="t m0 x32 h57 y568a ff1a fs2d fc0 sc0 ls0 ws0">117 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y568b ff1a fs2d fc0 sc0 ls0 ws0">118 <span class="_ _15"> </span>return(read(fd,<span class="_"> </span>buf, nbytes));</div><div class="t m0 x32 h57 y568c ff1a fs2d fc0 sc0 ls0 ws0">119 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y5acf ff19 fs26 fc0 sc0 ls0 ws0">[95 <span class="_ _a"></span>– <span class="_ _a"></span>107]<span class="_ _288"> </span><span class="ls164">We <span class="_ _80"> </span>p<span class="_ _9"></span><span class="lscc">ro<span class="_ _2"></span></span></span>vide <span class="_ _2"></span>a <span class="_ _2"></span>function <span class="_ _2"></span>called<span class="_ _66"> </span><span class="ff1a">tread<span class="_ _47"> </span></span>to read <span class="_ _2"></span>a <span class="_ _2"></span>speciﬁed <span class="_ _2"></span>number <span class="_ _2"></span>of <span class="_ _2"></span>bytes, <span class="_ _2"></span>but</div><div class="t m0 x11a h4a y5ad0 ff19 fs26 fc0 sc0 ls0 ws0">block <span class="_ _23"> </span>for <span class="_ _42"> </span>at <span class="_ _42"> </span>most<span class="_ _35"> </span><span class="ff1b">timout<span class="_ _44"> </span></span>seconds <span class="_ _23"> </span>befor<span class="ls1752">eg<span class="_ _43"></span><span class="ls0">iving <span class="_ _23"> </span>up.<span class="_ _54"> </span>This <span class="_ _23"> </span>function <span class="_ _42"> </span>is <span class="_ _42"> </span>useful</span></span></div><div class="t m0 x11a h49 y5ad1 ff19 fs26 fc0 sc0 ls0 ws0">when <span class="_ _23"></span>reading <span class="_ _23"></span>from <span class="_ _9"></span>a <span class="_ _23"> </span>socket <span class="_ _42"> </span>or <span class="_ _23"></span>a <span class="_ _23"> </span>pipe.<span class="_ _51"> </span>If <span class="_ _23"> </span>we <span class="_ _23"> </span>don’t <span class="_ _42"> </span>receive <span class="_ _9"></span>data <span class="_ _42"> </span>befor<span class="lse9c">et<span class="_ _43"></span><span class="ls0">he</span></span></div><div class="t m0 x11a h4d y5ad2 ff19 fs26 fc0 sc0 ls0 ws0">speciﬁed <span class="_"> </span>time <span class="_ _66"> </span>limit, <span class="_"> </span>we <span class="_ _66"> </span>return<span class="_ _46"> </span><span class="ff20">−</span><span class="ls1753">1w<span class="_ _4a"></span><span class="ls0">ith<span class="_ _46"> </span><span class="ff1a">errno<span class="_ _46"> </span></span>set <span class="_ _66"> </span>to<span class="_ _46"> </span><span class="ff1a">ETIME</span><span class="ls1754">.I<span class="_ _5d"></span><span class="ls2ba">fd<span class="_ _5b"></span><span class="ls0">ata <span class="_ _66"> </span>is</span></span></span></span></span></div><div class="t m0 x11a h4a y5ad3 ff19 fs26 fc0 sc0 ls0 ws0">available within the time limit, we return at most<span class="_"> </span><span class="ff1b">nbytes<span class="_"> </span></span>bytes of data, but we</div><div class="t m0 x11a h49 y5ad4 ff19 fs26 fc0 sc0 ls0 ws0">can return less than r<span class="_ _0"></span>equested if all the data doesn’t arrive in time.</div><div class="t m0 x11a h4d y5ad5 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _45"> </span>u<span class="_ _9"></span><span class="ls0">se<span class="_ _35"> </span><span class="ff1a">tread<span class="_ _44"> </span></span>to <span class="_ _23"> </span>prevent <span class="_ _23"> </span>denial-of-service <span class="_ _42"> </span>attacks <span class="_ _42"> </span>on <span class="_ _42"> </span>the <span class="_ _23"> </span>printer <span class="_ _42"> </span>spooling</span></div><div class="t m0 x11a h49 y5ad6 ff19 fs26 fc0 sc0 ls0 ws0">daemon. <span class="_ _35"> </span>A<span class="_ _35"> </span>malicious <span class="_ _23"> </span>user <span class="_ _42"> </span>might <span class="_ _23"></span>repeatedly <span class="_ _23"></span>try <span class="_ _23"> </span>to <span class="_ _23"> </span>connect <span class="_ _42"> </span>to <span class="_ _23"> </span>the <span class="_ _42"> </span>daemon</div><div class="t m0 x11a h49 y5ad7 ff19 fs26 fc0 sc0 ls0 ws0">without sending it data, just to prevent other users fr<span class="_ _0"></span>om being able to submit</div><div class="t m0 x11a h49 y5ad8 ff19 fs26 fc0 sc0 ls0 ws0">print <span class="_ _3"></span>jobs.<span class="_ _5a"> </span>By <span class="_ _3"></span>giving <span class="_ _9"></span>up <span class="_ _9"></span>after <span class="_ _3"></span>a <span class="_ _9"></span>reasonable <span class="_ _3"></span>amount <span class="_ _3"></span>of <span class="_ _9"></span>time, <span class="_ _9"></span>we <span class="_ _3"></span>prevent <span class="_ _3"></span>this</div><div class="t m0 x11a h49 y5ad9 ff19 fs26 fc0 sc0 ls0 ws0">from <span class="_ _2"></span>happening.<span class="_ _16"> </span>The <span class="_ _3"></span>tricky <span class="_ _3"></span>part <span class="_ _3"></span>is <span class="_ _3"></span>selecting <span class="_ _3"></span>a <span class="_ _3"></span>suitable <span class="_ _3"></span>timeout <span class="_ _2"></span>value <span class="_ _3"></span>that <span class="_ _3"></span>is</div><div class="t m0 x11a h49 y5ada ff19 fs26 fc0 sc0 ls0 ws0">large <span class="_ _9"></span>enough <span class="_ _23"></span>to <span class="_ _9"></span>prevent <span class="_ _23"></span>prematur<span class="_ _1"></span><span class="ls39a">ef<span class="_ _b"></span><span class="ls0">ailures <span class="_ _9"></span>when <span class="_ _23"></span>the <span class="_ _23"></span>system <span class="_ _9"></span>is <span class="_ _23"> </span>under <span class="_ _23"></span>load</span></span></div><div class="t m0 x11a h49 y5adb ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _42"> </span>tasks <span class="_ _42"> </span>ar<span class="ls1755">et<span class="_ _43"></span><span class="ls0">aking <span class="_ _42"> </span>longer <span class="_ _42"> </span>to <span class="_ _42"> </span>complete.<span class="_ _54"> </span>If <span class="_ _53"> </span>we <span class="_ _42"> </span>choose <span class="_ _53"> </span>a <span class="_ _42"> </span>value <span class="_ _53"> </span>that <span class="_ _42"> </span>is <span class="_ _53"> </span>too</span></span></div><div class="t m0 x11a h49 y5adc ff19 fs26 fc0 sc0 ls0 ws0">large, <span class="_ _42"> </span>however<span class="_ _6"></span>,<span class="_ _4b"> </span>we<span class="_ _44"> </span>might <span class="_ _53"> </span>enable <span class="_ _42"> </span>denial-of-service <span class="_ _53"> </span>attacks <span class="_ _53"> </span>by <span class="_ _53"> </span>allowing <span class="_ _42"> </span>the</div><div class="t m0 x11a h49 y5add ff19 fs26 fc0 sc0 ls0 ws0">daemon to consume too many resour<span class="_ _0"></span>ces to pr<span class="_ _0"></span>ocess the pending requests.</div><div class="t m0 x32 h4d y5ade ff19 fs26 fc0 sc0 ls0 ws0">[108 <span class="_ _a"></span>– <span class="_ _a"></span>1<span class="_ _0"></span>19] <span class="_ _4b"> </span>W<span class="_ _6"></span><span class="ls6b0">eu<span class="_ _4f"></span><span class="ls0">se<span class="_ _47"> </span><span class="ff1a">select<span class="_ _66"> </span></span>to <span class="_ _3"></span>wait <span class="_ _2"></span>for <span class="_ _2"></span>the <span class="_ _2"></span>speciﬁed <span class="_ _2"></span>ﬁle <span class="_ _3"></span>descriptor <span class="_ _2"></span>to <span class="_ _2"></span>be <span class="_ _2"></span>readable. <span class="_ _66"> </span>If<span class="_ _47"> </span>the</span></span></div><div class="t m0 x11a h4d y5adf ff19 fs26 fc0 sc0 ls0 ws0">time <span class="_ _23"></span>limit <span class="_ _23"></span>expir<span class="_ _0"></span>es <span class="_ _23"></span>befor<span class="ls1756">ed<span class="_ _43"></span><span class="ls0">ata <span class="_ _23"></span>is <span class="_ _23"></span>available <span class="_ _23"></span>to <span class="_ _23"></span>be <span class="_ _9"></span>read,<span class="_ _35"> </span><span class="ff1a">select<span class="_ _45"> </span></span><span class="lscc">re<span class="_ _2"></span></span>turns <span class="_ _23"></span>0, <span class="_ _23"></span>so</span></span></div><div class="t m0 x11a h4d y5ae0 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _2"></span>set<span class="_ _47"> </span><span class="ff1a">errno<span class="_ _47"> </span></span>to<span class="_ _47"> </span><span class="ff1a">ETIME<span class="_ _47"> </span></span>in <span class="_ _3"></span>this <span class="_ _3"></span>case.<span class="_ _16"> </span>If<span class="_ _47"> </span><span class="ff1a">select<span class="_ _47"> </span></span>fails <span class="_ _3"></span>or <span class="_ _3"></span>times <span class="_ _2"></span>out, <span class="_ _3"></span>we <span class="_ _3"></span>return</div><div class="t m0 x11a h49 y5ae1 ff20 fs26 fc0 sc0 ls0 ws0">−<span class="ff19">1. <span class="_"> </span>Otherwise,<span class="_"> </span>we return whatever data is available.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
