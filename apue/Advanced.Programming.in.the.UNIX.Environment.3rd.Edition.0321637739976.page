<div id="pf3d0" class="pf w4 h1f" data-page-no="3d0"><div class="pc pc3d0 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg3d0.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">942<span class="_ _1b"> </span><span class="ff19">Solutions <span class="_"> </span>to <span class="_"> </span>Selected <span class="_"> </span>Exercises <span class="_ _2eb"> </span>Appendix<span class="_ _4b"> </span>C</span></div><div class="t m0 x60 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">for (;;) {</div><div class="t m0 xb9 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">if (poll(pfd, NQ, -1) &lt; 0)</div><div class="t m0 x1ce h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;poll error&quot;);</div><div class="t m0 xb9 h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; NQ; i++) {</div><div class="t m0 x1ce h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">if (pfd[i].revents &amp; POLLIN) {</div><div class="t m0 x6b h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">if ((n = read(pfd[i].fd, &amp;c, sizeof(char))) &lt; 0)</div><div class="t m0 x17f h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;read error&quot;);</div><div class="t m0 x6b h57 y805 ff1a fs2d fc0 sc0 ls0 ws0">ti[i].m.mtext[ti[i].len] = 0;</div><div class="t m0 x6b h57 y806 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;queue id %d, message %s\n&quot;, qid[i],</div><div class="t m0 x145 h57 y807 ff1a fs2d fc0 sc0 ls0 ws0">ti[i].m.mtext);</div><div class="t m0 x6b h57 y808 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_lock(&amp;ti[i].mutex);</div><div class="t m0 x6b h57 y809 ff1a fs2d fc0 sc0 ls0 ws0">pthread_cond_signal(&amp;ti[i].ready);</div><div class="t m0 x6b h57 y80a ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;ti[i].mutex);</div><div class="t m0 x1ce h57 y80b ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xb9 h57 y80c ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x60 h57 y80d ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x60 h57 y8de ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 xe2 h57 y8df ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x145 h2d y6303 ff18 fs10 fc0 sc0 ls0 ws0">Figure C.24<span class="_ _5a"> </span><span class="ff19">Poll for XSI messages using pipes</span></div><div class="t m0 x32 h4a y6304 ff18 fs26 fc0 sc0 ls0 ws0">17.3<span class="_ _210"> </span><span class="ff19">A<span class="_ _47"> </span><span class="ff1b">declaration<span class="_ _47"> </span></span>speciﬁes <span class="_ _3"></span>the <span class="_ _3"></span>attributes <span class="_ _3"></span>(such <span class="_ _3"></span>as <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _2"></span>type) <span class="_ _3"></span>of <span class="_ _3"></span>a <span class="_ _3"></span>set <span class="_ _3"></span>of <span class="_ _3"></span>identiﬁers.</span></div><div class="t m0 xe2 h4a y6305 ff19 fs26 fc0 sc0 ls0 ws0">If the declaration also causes storage to be allocated, it is called a<span class="_"> </span><span class="ff1b">deﬁnition</span>.</div><div class="t m0 xe2 h4d y6306 ff19 fs26 fc0 sc0 ls0 ws0">In <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">opend.h<span class="_ _35"> </span></span>header<span class="_ _6"></span>,<span class="_ _35"> </span>we<span class="_ _45"> </span>declar<span class="ls6e7">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>three <span class="_ _9"></span>global <span class="_ _23"> </span>variables <span class="_ _23"></span>with <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">extern</span></span></span></div><div class="t m0 xe2 h49 y6307 ff19 fs26 fc0 sc0 ls0 ws0">storage <span class="_ _53"> </span>class.<span class="_ _65"> </span>These <span class="_ _e"> </span>declarations <span class="_ _53"> </span>do <span class="_ _e"> </span>not <span class="_ _53"> </span>cause <span class="_ _e"> </span>storage <span class="_ _53"> </span>to <span class="_ _e"> </span>be <span class="_ _53"> </span>allocated <span class="_ _e"> </span>for <span class="_ _53"> </span>the</div><div class="t m0 xe2 h4d y6308 ff19 fs26 fc0 sc0 ls0 ws0">variables. <span class="_ _45"> </span>In<span class="_ _35"> </span>the<span class="_ _45"> </span><span class="ff1a">main.c<span class="_ _45"> </span></span>ﬁle, <span class="_ _23"></span>we <span class="_ _9"></span>deﬁne <span class="_ _23"></span>the <span class="_ _9"></span>three <span class="_ _9"></span>global <span class="_ _23"></span>variables.<span class="_ _5a"> </span>Sometimes,</div><div class="t m0 xe2 h49 y6309 ff19 fs26 fc0 sc0 ls0 ws0">we’ll also <span class="_ _2"></span>initialize <span class="_ _2"></span>a <span class="_ _2"></span>global <span class="_ _2"></span>variable <span class="_ _2"></span>when <span class="_ _2"></span>we <span class="_ _2"></span>deﬁne it, <span class="_ _2"></span>but <span class="_ _2"></span>we <span class="_ _2"></span>typically <span class="_ _2"></span>let <span class="_ _2"></span>the <span class="_ _2"></span>C</div><div class="t m0 xe2 h49 y630a ff19 fs26 fc0 sc0 ls0 ws0">default apply<span class="_ _4"></span>.</div><div class="t m0 x32 h4d y630b ff18 fs26 fc0 sc0 ls0 ws0">17.5<span class="_ _210"> </span><span class="ff19">Both<span class="_ _35"> </span><span class="ff1a">select<span class="_ _45"> </span></span>and<span class="_ _45"> </span><span class="ff1a">poll<span class="_ _35"> </span></span><span class="lscc">re</span>turn <span class="_ _9"></span>the <span class="_ _23"></span>number <span class="_ _9"></span>of <span class="_ _23"></span>ready <span class="_ _9"></span>descriptors <span class="_ _9"></span>as <span class="_ _23"></span>the <span class="_ _9"></span>value <span class="_ _23"></span>of</span></div><div class="t m0 xe2 h4d y630c ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>function.<span class="_ _16"> </span>The <span class="_ _9"></span>loop <span class="_ _3"></span>that <span class="_ _9"></span>goes <span class="_ _3"></span>through <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">client<span class="_ _45"> </span></span>array <span class="_ _3"></span>can <span class="_ _3"></span>terminate <span class="_ _9"></span>when</div><div class="t m0 xe2 h49 y630d ff19 fs26 fc0 sc0 ls0 ws0">the number of ready descriptors has been pr<span class="_ _0"></span>ocessed.</div><div class="t m0 x32 h49 y630e ff18 fs26 fc0 sc0 ls0 ws0">17.6<span class="_ _210"> </span><span class="ff19">The <span class="_ _23"></span>ﬁrst <span class="_ _3"></span>problem <span class="_ _9"></span>with <span class="_ _9"></span>the <span class="_ _9"></span>proposed <span class="_ _9"></span>solution <span class="_ _9"></span>is <span class="_ _9"></span>that <span class="_ _9"></span>there<span class="_ _45"> </span>is<span class="_ _45"> </span>a<span class="_ _45"> </span>race <span class="_ _3"></span>between <span class="_ _23"></span>the</span></div><div class="t m0 xe2 h4d y630f ff19 fs26 fc0 sc0 ls0 ws0">call <span class="_ _e"> </span>to<span class="_ _59"> </span><span class="ff1a">stat<span class="_ _59"> </span></span>and <span class="_"> </span>the <span class="_ _53"> </span>call <span class="_"> </span>to<span class="_ _4b"> </span><span class="ff1a">unlink<span class="_ _59"> </span></span>wher<span class="ls1882">et<span class="_ _4a"></span><span class="ls0">he <span class="_"> </span>ﬁle <span class="_ _e"> </span>can <span class="_"> </span>change.<span class="_ _65"> </span>The <span class="_"> </span>second</span></span></div><div class="t m0 xe2 h49 y6310 ff19 fs26 fc0 sc0 ls0 ws0">problem <span class="_ _53"> </span>is <span class="_ _53"> </span>that <span class="_ _e"> </span>if <span class="_ _e"> </span>the <span class="_ _e"> </span>name <span class="_ _e"> </span>is <span class="_ _e"> </span>a <span class="_ _53"> </span>symbolic <span class="_ _e"> </span>link <span class="_ _e"> </span>pointing <span class="_ _e"> </span>to <span class="_ _e"> </span>the <span class="_ _53"> </span>UNIX <span class="_ _e"> </span>domain</div><div class="t m0 xe2 h4d y6311 ff19 fs26 fc0 sc0 ls0 ws0">socket <span class="_ _9"></span>ﬁle, <span class="_ _3"></span>then<span class="_ _45"> </span><span class="ff1a">stat<span class="_ _45"> </span></span>will <span class="_ _9"></span>report <span class="_ _3"></span>that <span class="_ _9"></span>the <span class="_ _9"></span>name <span class="_ _9"></span>is <span class="_ _3"></span>a <span class="_ _9"></span>socket <span class="_ _9"></span>(recall <span class="_ _9"></span>that <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">stat</span></div><div class="t m0 xe2 h4d y6312 ff19 fs26 fc0 sc0 ls0 ws0">function <span class="_ _e"> </span>follows <span class="_ _e"> </span>symbolic <span class="_ _e"> </span>links), <span class="_"> </span>but <span class="_ _53"> </span>when <span class="_ _e"> </span>we <span class="_ _e"> </span>call<span class="_ _59"> </span><span class="ff1a">unlink</span>,<span class="_ _4b"> </span>we<span class="_ _59"> </span>will <span class="_ _e"> </span>actually</div><div class="t m0 xe2 h49 y6313 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">move <span class="_ _42"> </span>the <span class="_ _42"> </span>symbolic <span class="_ _23"> </span>link <span class="_ _42"> </span>instead <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>socket <span class="_ _42"> </span>ﬁle.<span class="_ _51"> </span><span class="ls164">To <span class="_ _45"> </span>s<span class="_ _9"></span></span>olve <span class="_ _23"> </span>this <span class="_ _42"> </span>problem, <span class="_ _23"> </span>we</span></div><div class="t m0 xe2 h4d y6314 ff19 fs26 fc0 sc0 ls0 ws0">should use<span class="_"> </span><span class="ff1a">lstat<span class="_ _80"> </span></span>instead of<span class="_"> </span><span class="ff1a">stat</span><span class="lsd3">,b<span class="_ _5"></span><span class="ls0">ut this doesn’t solve the ﬁrst pr<span class="_ _0"></span>oblem.</span></span></div><div class="t m0 x32 h49 y6315 ff18 fs26 fc0 sc0 ls0 ws0">17.7<span class="_ _210"> </span><span class="ff19">The <span class="_ _3"></span>ﬁrst <span class="_ _9"></span>option <span class="_ _2"></span>is <span class="_ _9"></span>to <span class="_ _2"></span>send <span class="_ _9"></span>both <span class="_ _2"></span>ﬁle <span class="_ _9"></span>descriptors <span class="_ _2"></span>in <span class="_ _9"></span>one <span class="_ _2"></span>control <span class="_ _3"></span>message.<span class="_ _16"> </span>Each <span class="_ _3"></span>ﬁle</span></div><div class="t m0 xe2 h49 y6316 ff19 fs26 fc0 sc0 ls0 ws0">descriptor <span class="_ _53"> </span>is <span class="_ _53"> </span>stored <span class="_ _53"> </span>in <span class="_ _53"> </span>adjacent <span class="_ _53"> </span>memory <span class="_ _53"> </span>locations.<span class="_ _65"> </span>The <span class="_ _e"> </span>following <span class="_ _53"> </span>code <span class="_ _53"> </span>shows</div><div class="t m0 xe2 h49 y6317 ff19 fs26 fc0 sc0 ls0 ws0">this:</div><div class="t m0 xd8 h4e y6318 ff1a fs28 fc0 sc0 ls0 ws0">struct msghdr msg;</div><div class="t m0 xd8 h4e y6319 ff1a fs28 fc0 sc0 ls0 ws0">struct cmsghdr *cmptr;</div><div class="t m0 xd8 h4e y631a ff1a fs28 fc0 sc0 ls0 ws0">int *ip;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
