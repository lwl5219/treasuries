<div id="pf1d5" class="pf w4 h1f" data-page-no="1d5"><div class="pc pc1d5 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1d5.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>12.4<span class="_ _57"> </span>Synchronization <span class="_"> </span>Attributes<span class="_ _1b"> </span><span class="ff18">435</span></div><div class="t m0 x52 h52 y2ddc ff1f fs2a fc0 sc0 ls0 ws0">main</div><div class="t m0 x215 h5e y3653 ff1a fs10 fc0 sc0 ls0 ws0">func1(x)</div><div class="t m0 x215 h4f y3654 ff1a fs11 fc0 sc0 ls0 ws0">func2(x)</div><div class="t m0 xe h6d y3655 ff1f fs12 fc0 sc0 ls0 ws0">func1</div><div class="t m0 x3d h63 y3656 ff1a fs13 fc0 sc0 ls0 ws0">pthread_mutex_lock(x-&gt;lock)</div><div class="t m0 x1e3 h6f y3657 ff1a fs14 fc0 sc0 ls0 ws0">func2(x)</div><div class="t m0 x171 h66 y3658 ff1a fs15 fc0 sc0 ls0 ws0">pthread_mutex_unlock(x-&gt;lock)</div><div class="t m0 x5e h70 y3659 ff1f fs16 fc0 sc0 ls0 ws0">func2</div><div class="t m0 xb4 h71 y365a ff1a fs36 fc0 sc0 ls0 ws0">pthread_mutex_lock(x-&gt;lock)</div><div class="t m0 x117 hcc y365b ff1a fs17 fc0 sc0 ls0 ws0">pthread_mutex_unlock(x-&gt;lock)</div><div class="t m0 x13c h35 y365c ff18 fs18 fc0 sc0 ls0 ws0">Figure 12.6<span class="_ _5a"> </span><span class="ff19">Recursive locking opportunity</span></div><div class="t m0 x32 h6a y365d ff19 fs34 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>mutex <span class="_ _3"></span>befor<span class="lsea8">ec<span class="_ _b"></span><span class="ls0">alling<span class="_ _47"> </span><span class="ff1a">func2<span class="_ _45"> </span></span>and <span class="_ _2"></span>reacquire<span class="_ _66"> </span>it<span class="_ _47"> </span>after<span class="_ _47"> </span><span class="ff1a">func2<span class="_ _45"> </span></span><span class="ls1df">re</span>turns, <span class="_ _3"></span>but <span class="_ _3"></span>this <span class="_ _3"></span>approach</span></span></div><div class="t m0 x32 h69 y365e ff19 fs34 fc0 sc0 ls0 ws0">opens <span class="_ _e"> </span>a <span class="_ _e"> </span>window <span class="_"> </span>wher<span class="_ _0"></span><span class="lsea9">ea<span class="_ _4a"></span><span class="ls0">nother <span class="_"> </span>thr<span class="_ _0"></span>ead <span class="_ _e"> </span>can <span class="_ _e"> </span>possibly <span class="_"> </span>grab <span class="_ _53"> </span>control <span class="_ _e"> </span>of <span class="_"> </span>the <span class="_ _53"> </span>mutex <span class="_ _e"> </span>and</span></span></div><div class="t m0 x32 h6a y365f ff19 fs34 fc0 sc0 ls0 ws0">change <span class="_ _45"> </span>the <span class="_ _47"> </span>data <span class="_ _45"> </span>structure<span class="_ _16"> </span>in<span class="_ _5a"> </span>the <span class="_ _45"> </span>middle <span class="_ _45"> </span>of<span class="_ _16"> </span><span class="ff1a">func1</span><span class="lseaa">.T<span class="_ _56"></span><span class="ls0">his <span class="_ _45"> </span>may <span class="_ _45"> </span>not <span class="_ _47"> </span>be <span class="_ _45"> </span>acceptable,</span></span></div><div class="t m0 x32 h69 y3660 ff19 fs34 fc0 sc0 ls0 ws0">depending on what protection the mutex is intended to pr<span class="_ _0"></span>ovide.</div><div class="t m0 x3f h69 y3661 ff19 fs34 fc0 sc0 ls0 ws0">Figur<span class="lseab">e1<span class="_ _c"></span><span class="ls0">2.7 <span class="_ _42"> </span>shows <span class="_ _42"> </span>an <span class="_ _42"> </span>alternative <span class="_ _23"> </span>to <span class="_ _42"> </span>using <span class="_ _42"> </span>a <span class="_ _23"> </span>recursive <span class="_ _42"> </span>mutex <span class="_ _23"> </span>in <span class="_ _42"> </span>this <span class="_ _42"> </span>case.<span class="_ _51"> </span><span class="ls1e2">We <span class="_ _45"> </span>c<span class="_ _9"></span></span>an</span></span></div><div class="t m0 x32 h6a y3662 ff19 fs34 fc0 sc0 ls0 ws0">leave <span class="_ _23"></span>the <span class="_ _23"> </span>interfaces <span class="_ _23"> </span>to<span class="_ _35"> </span><span class="ff1a">func1<span class="_ _35"> </span></span>and<span class="_ _35"> </span><span class="ff1a">func2<span class="_ _35"> </span></span>unchanged <span class="_ _23"></span>and <span class="_ _23"></span>avoid <span class="_ _23"></span>a <span class="_ _23"></span>recursive <span class="_ _23"></span>mutex <span class="_ _23"></span>by</div><div class="t m0 x32 h6a y3663 ff19 fs34 fc0 sc0 ls0 ws0">providing <span class="_ _2"></span>a <span class="_ _9"></span>private <span class="_ _3"></span>version <span class="_ _9"></span>of<span class="_ _47"> </span><span class="ff1a">func2</span><span class="lseac">,c<span class="_ _8"></span><span class="ls0">alled<span class="_ _45"> </span><span class="ff1a">func2_locked</span><span class="lsead">.T<span class="_ _52"></span><span class="lseac">oc<span class="_ _b"></span><span class="ls0">all<span class="_ _45"> </span><span class="ff1a">func2_locked</span>,</span></span></span></span></span></div><div class="t m0 x32 h69 y3664 ff19 fs34 fc0 sc0 ls0 ws0">we <span class="_ _2"></span>must <span class="_ _3"></span>hold <span class="_ _3"></span>the <span class="_ _3"></span>mutex <span class="_ _3"></span>embedded <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _2"></span>data <span class="_ _3"></span>structur<span class="lseae">ew<span class="_ _8"></span><span class="ls0">hose <span class="_ _3"></span>address <span class="_ _2"></span>we <span class="_ _3"></span>pass <span class="_ _3"></span>as <span class="_ _3"></span>the</span></span></div><div class="t m0 x32 h6a y3665 ff19 fs34 fc0 sc0 ls0 ws0">argument. <span class="_ _35"> </span>The<span class="_ _4b"> </span>body <span class="_ _42"> </span>of<span class="_ _44"> </span><span class="ff1a">func2_locked<span class="_ _44"> </span></span>contains <span class="_ _53"> </span>a <span class="_ _53"> </span>copy <span class="_ _42"> </span>of<span class="_ _44"> </span><span class="ff1a">func2</span><span class="lseaf">,a<span class="_ _43"></span><span class="ls0">nd<span class="_ _44"> </span><span class="ff1a">func2<span class="_ _44"> </span></span>now</span></span></div><div class="t m0 x32 h6a y3666 ff19 fs34 fc0 sc0 ls0 ws0">simply acquires the mutex, calls<span class="_"> </span><span class="ff1a">func2_locked</span><span class="ls66a">,a<span class="_ _4f"></span><span class="ls0">nd then releases the mutex.</span></span></div><div class="t m0 x3f h69 y3667 ff19 fs34 fc0 sc0 ls0 ws0">If <span class="_ _53"> </span>we <span class="_ _53"> </span>didnâ€™t <span class="_ _53"> </span>have <span class="_ _e"> </span>to <span class="_ _53"> </span>leave <span class="_ _53"> </span>the <span class="_ _e"> </span>interfaces <span class="_ _53"> </span>to <span class="_ _53"> </span>the <span class="_ _53"> </span>library <span class="_ _e"> </span>functions <span class="_ _53"> </span>unchanged, <span class="_ _53"> </span>we</div><div class="t m0 x32 h69 y3668 ff19 fs34 fc0 sc0 ls0 ws0">could have added <span class="_ _2"></span>a second <span class="_ _2"></span>parameter to <span class="_ _2"></span>each function <span class="_ _2"></span>to indicate <span class="_ _2"></span>whether the structure</div><div class="t m0 x32 h69 y3669 ff19 fs34 fc0 sc0 ls0 ws0">is <span class="_ _9"></span>locked <span class="_ _9"></span>by <span class="_ _9"></span>the <span class="_ _9"></span>caller<span class="_ _6"></span><span class="lseb0">.I<span class="_ _62"></span><span class="ls0">t<span class="_ _45"> </span>is<span class="_ _45"> </span>usually <span class="_ _9"></span>better <span class="_ _9"></span>to <span class="_ _9"></span>leave <span class="_ _9"></span>the <span class="_ _9"></span>interfaces <span class="_ _9"></span>unchanged <span class="_ _9"></span>if <span class="_ _9"></span>we <span class="_ _9"></span>can,</span></span></div><div class="t m0 x32 h69 y366a ff19 fs34 fc0 sc0 ls0 ws0">however<span class="_ _6"></span><span class="ls66a">,i<span class="_ _5"></span><span class="ls0">nstead of polluting them with implementation artifacts.</span></span></div><div class="t m0 x3f h69 y366b ff19 fs34 fc0 sc0 ls0 ws0">The <span class="_"> </span>strategy <span class="_ _53"> </span>of <span class="_"> </span>providing <span class="_ _53"> </span>locked <span class="_"> </span>and <span class="_"> </span>unlocked <span class="_ _53"> </span>versions <span class="_"> </span>of <span class="_ _e"> </span>functions <span class="_"> </span>is <span class="_ _e"> </span>usually</div><div class="t m0 x32 h69 y366c ff19 fs34 fc0 sc0 ls0 ws0">applicable <span class="_ _23"></span>in <span class="_ _23"></span>simple <span class="_ _23"></span>situations.<span class="_ _51"> </span>In <span class="_ _23"></span>mor<span class="lseb1">ec<span class="_ _43"></span><span class="ls0">omplex <span class="_ _23"></span>situations, <span class="_ _23"></span>such <span class="_ _23"></span>as <span class="_ _23"></span>when <span class="_ _23"></span>the <span class="_ _23"></span>library</span></span></div><div class="t m0 x32 h69 y366d ff19 fs34 fc0 sc0 ls0 ws0">needs <span class="_ _3"></span>to <span class="_ _9"></span>call <span class="_ _9"></span>a <span class="_ _3"></span>function <span class="_ _9"></span>outside <span class="_ _9"></span>the <span class="_ _3"></span>library<span class="_ _6"></span><span class="lseb2">,w<span class="_ _b"></span><span class="ls0">hich <span class="_ _9"></span>then <span class="_ _9"></span>might <span class="_ _3"></span>call <span class="_ _9"></span>back <span class="_ _9"></span>into <span class="_ _9"></span>the <span class="_ _3"></span>library<span class="_ _6"></span>,</span></span></div><div class="t m0 x32 h69 y366e ff19 fs34 fc0 sc0 ls0 ws0">we need to rely on r<span class="_ _0"></span>ecursive locks.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
