<div id="pf313" class="pf w4 h1f" data-page-no="313"><div class="pc pc313 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg313.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">753</span></div><div class="t m0 x32 h26 y12f ff1a fsf fc0 sc0 ls0 ws0">fgets<span class="ff19 ls9f0">,f<span class="_ _4f"></span><span class="ls0">or <span class="_ _2"></span>example, <span class="_ _2"></span>to <span class="_ _3"></span>return data <span class="_ _3"></span>that <span class="_ _2"></span>was <span class="_ _2"></span>read <span class="_ _2"></span>into <span class="_ _2"></span>a <span class="_ _2"></span>standar<span class="ls163e">dI<span class="_ _4f"></span><span class="ls0">/O <span class="_ _2"></span>buffer <span class="_ _2"></span>10 <span class="_ _2"></span>minutes</span></span></span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">ago if the data was modiﬁed by another process 5 minutes ago.</div><div class="t m0 x3f h2a y131 ff19 fsf fc0 sc0 ls0 ws0">Our <span class="_ _42"> </span>discussion <span class="_ _23"> </span>of <span class="_ _42"> </span>concurrency <span class="_ _42"> </span>is <span class="_ _42"> </span>pr<span class="_ _0"></span>edicated <span class="_ _42"> </span>on <span class="_ _42"> </span>the <span class="_ _23"> </span>simple <span class="_ _42"> </span>needs <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>database</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">library<span class="_ _4"></span><span class="ls163f">.C<span class="_ _52"></span><span class="ls0">ommer<span class="_ _0"></span>cial <span class="_ _53"> </span>systems <span class="_ _e"> </span>often <span class="_ _53"> </span>have <span class="_ _e"> </span>additional <span class="_ _e"> </span>requir<span class="_ _0"></span>ements. <span class="_ _44"> </span>See<span class="_ _4b"> </span>Chapter <span class="_ _e"> </span>16 <span class="_ _e"> </span>of</span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">Date</div><div class="t m0 x90 h2a y18af ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x9 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">2004</div><div class="t m0 x7c h2a y18af ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x7d h2a y133 ff19 fsf fc0 sc0 ls0 ws0">for additional details on concurrency<span class="_ _4"></span>.</div><div class="t m0 x35 h53 y34a7 ff16 fs2b fc0 sc0 ls0 ws0">20.7 <span class="_ _93"> </span>Building<span class="_ _54"> </span>the <span class="_"> </span>Library</div><div class="t m0 x32 h2a y5668 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _2"></span>database <span class="_ _3"></span>library <span class="_ _2"></span>consists <span class="_ _2"></span>of <span class="_ _3"></span>two <span class="_ _2"></span>ﬁles: <span class="_ _3"></span>a <span class="_ _2"></span>public <span class="_ _3"></span>C <span class="_ _2"></span>header <span class="_ _3"></span>ﬁle <span class="_ _2"></span>and <span class="_ _3"></span>a <span class="_ _2"></span>C <span class="_ _3"></span>source ﬁle.<span class="_ _16"> </span><span class="ls5f">We</span></div><div class="t m0 x32 h2a y5669 ff19 fsf fc0 sc0 ls0 ws0">can build a static library using the commands</div><div class="t m0 x3f h57 y566a ff1a fs2d fc0 sc0 ls0 ws0">gcc -I../include -Wall -c db.c</div><div class="t m0 x3f h57 y566b ff1a fs2d fc0 sc0 ls0 ws0">ar rsv libapue_db.a db.o</div><div class="t m0 x32 h26 y566c ff19 fsf fc0 sc0 ls0 ws0">Applications <span class="_ _45"> </span>that <span class="_ _35"> </span>want <span class="_ _45"> </span>to <span class="_ _35"> </span>link <span class="_ _45"> </span>with<span class="_ _5a"> </span><span class="ff1a">libapue_db.a<span class="_ _51"> </span></span>will <span class="_ _45"> </span>also <span class="_ _35"> </span>need <span class="_ _45"> </span>to <span class="_ _35"> </span>link <span class="_ _45"> </span>with</div><div class="t m0 x32 h26 y566d ff1a fsf fc0 sc0 ls0 ws0">libapue.a<span class="ff19 ls44">,s<span class="_ _d"></span><span class="ls0">ince we use some of our common functions in the database library<span class="_ _6"></span>.</span></span></div><div class="t m0 x3f h2a y566e ff19 fsf fc0 sc0 ls0 ws0">If, <span class="_ _42"> </span>on <span class="_ _53"> </span>the <span class="_ _42"> </span>other <span class="_ _53"> </span>hand, <span class="_ _42"> </span>we <span class="_ _53"> </span>want <span class="_ _42"> </span>to <span class="_ _53"> </span>build <span class="_ _42"> </span>a <span class="_ _53"> </span>dynamic <span class="_ _42"> </span>shared <span class="_ _42"> </span>library <span class="_ _53"> </span>version <span class="_ _42"> </span>of <span class="_ _53"> </span>the</div><div class="t m0 x32 h2a y566f ff19 fsf fc0 sc0 ls0 ws0">database library<span class="_ _4"></span>,<span class="_"> </span>we<span class="_"> </span>can use the following commands:</div><div class="t m0 x3f h57 y5670 ff1a fs2d fc0 sc0 ls0 ws0">gcc -I../include -Wall -fPIC -c db.c</div><div class="t m0 x3f h57 y5671 ff1a fs2d fc0 sc0 ls0 ws0">gcc -shared -Wl,-soname,libapue_db.so.1 -o libapue_db.so.1 \</div><div class="t m0 xc2 h57 y5672 ff1a fs2d fc0 sc0 ls0 ws0">-L../lib -lapue -lc db.o</div><div class="t m0 x32 h26 y5673 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_"> </span>r<span class="_ _0"></span>esulting <span class="_"> </span>shar<span class="_ _0"></span>ed <span class="_"> </span>library<span class="_ _4"></span>,<span class="_ _59"> </span><span class="ff1a">libapue_db.so.1</span><span class="ls1640">,n<span class="_ _55"></span><span class="ls0">eeds <span class="_"> </span>to <span class="_ _e"> </span>be <span class="_"> </span>placed <span class="_"> </span>in <span class="_"> </span>a <span class="_"> </span>common</span></span></div><div class="t m0 x32 h2a y5674 ff19 fsf fc0 sc0 ls0 ws0">directory <span class="_ _2"></span>wher<span class="ls1641">et<span class="_ _8"></span><span class="ls0">he <span class="_ _2"></span>dynamic <span class="_ _3"></span>linker/loader <span class="_ _3"></span>can <span class="_ _3"></span>ﬁnd <span class="_ _2"></span>it.<span class="_ _16"> </span>Alternatively<span class="_ _6"></span>,<span class="_ _47"> </span>we<span class="_ _47"> </span>can <span class="_ _2"></span>place <span class="_ _3"></span>it <span class="_ _3"></span>in</span></span></div><div class="t m0 x32 h26 y5675 ff19 fsf fc0 sc0 ls1642 ws0">ap<span class="_ _7"></span><span class="ls0">rivate <span class="_ _35"> </span>directory <span class="_ _35"> </span>and <span class="_ _35"> </span>modify <span class="_ _35"> </span>our<span class="_ _51"> </span><span class="ff1a">LD_LIBRARY_PATH<span class="_ _54"> </span></span>environment <span class="_ _45"> </span>variable <span class="_ _44"> </span>to</span></div><div class="t m0 x32 h2a y5676 ff19 fsf fc0 sc0 ls0 ws0">include the private directory in the sear<span class="_ _0"></span>ch path of the dynamic linker/loader<span class="_ _6"></span>.</div><div class="t m0 x76 h51 y5677 ff19 fs2a fc0 sc0 ls0 ws0">The <span class="_ _2"></span>steps <span class="_ _3"></span>used <span class="_ _3"></span>to <span class="_ _2"></span>build <span class="_ _3"></span>shared <span class="_ _2"></span>libraries <span class="_ _3"></span>vary <span class="_ _3"></span>among <span class="_ _3"></span>platforms.<span class="_ _4b"> </span>Here, <span class="_ _2"></span>we <span class="_ _2"></span>have <span class="_ _3"></span>shown <span class="_ _3"></span>how <span class="_ _3"></span>to</div><div class="t m0 x76 h51 y5678 ff19 fs2a fc0 sc0 ls0 ws0">do it on a Linux system with the GNU C compiler<span class="_ _1"></span>.</div><div class="t m0 x35 h53 y5679 ff16 fs2b fc0 sc0 ls0 ws0">20.8 <span class="_ _93"> </span>Source <span class="_"> </span>Code</div><div class="t m0 x32 h26 y567a ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _45"> </span>s<span class="_ _9"></span><span class="ls0">tart <span class="_ _53"> </span>by <span class="_ _42"> </span>showing <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">apue_db.h<span class="_ _44"> </span></span>header<span class="_ _1"></span><span class="ls1643">.T<span class="_ _52"></span><span class="ls0">his <span class="_ _53"> </span>header <span class="_ _42"> </span>is <span class="_ _42"> </span>included <span class="_ _53"> </span>by <span class="_ _42"> </span>the <span class="_ _53"> </span>library</span></span></span></div><div class="t m0 x32 h2a y567b ff19 fsf fc0 sc0 ls0 ws0">source code and all applications that call the library<span class="_ _4"></span>.</div><div class="t m0 x3f h2a y567c ff19 fsf fc0 sc0 ls0 ws0">For <span class="_ _2"></span>the <span class="_ _2"></span>remainder <span class="_ _2"></span>of <span class="_ _2"></span>this <span class="_ _3"></span>text, <span class="_ _2"></span>we <span class="_ _2"></span>depart <span class="_ _3"></span>from <span class="_ _2"></span>the <span class="_ _2"></span>style <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>previous <span class="_ _2"></span>examples <span class="_ _2"></span>in</div><div class="t m0 x32 h2a y567d ff19 fsf fc0 sc0 ls0 ws0">several <span class="_ _3"></span>ways.<span class="_ _5a"> </span>First, <span class="_ _9"></span>because <span class="_ _3"></span>the <span class="_ _9"></span>source <span class="_ _3"></span>code <span class="_ _9"></span>example <span class="_ _3"></span>is <span class="_ _9"></span>longer <span class="_ _9"></span>than <span class="_ _3"></span>usual, <span class="_ _9"></span>we <span class="_ _9"></span>number</div><div class="t m0 x32 h2a y567e ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>lines.<span class="_ _65"> </span>This <span class="_ _e"> </span>makes <span class="_ _53"> </span>it <span class="_ _e"> </span>easier <span class="_ _53"> </span>to <span class="_ _e"> </span>link <span class="_ _53"> </span>the <span class="_ _e"> </span>discussion <span class="_ _53"> </span>with <span class="_ _e"> </span>the <span class="_ _53"> </span>corresponding <span class="_ _53"> </span>source</div><div class="t m0 x32 h2a y567f ff19 fsf fc0 sc0 ls0 ws0">code. <span class="_ _46"> </span>Second,<span class="_ _46"> </span>we <span class="_"> </span>place <span class="_"> </span>the <span class="_"> </span>description <span class="_ _66"> </span>of <span class="_"> </span>the <span class="_ _66"> </span>source <span class="_"> </span>code <span class="_"> </span>immediately <span class="_"> </span>below <span class="_"> </span>the</div><div class="t m0 x32 h2a y5680 ff19 fsf fc0 sc0 ls0 ws0">source code on the same page.</div><div class="t m0 x76 h51 y5681 ff19 fs2a fc0 sc0 ls0 ws0">This <span class="_ _2"></span>style <span class="_ _3"></span>was <span class="_ _3"></span>inspired <span class="_ _2"></span>by <span class="_ _3"></span>John <span class="_ _3"></span>Lions <span class="_ _2"></span>in <span class="_ _3"></span>his <span class="_ _3"></span>book <span class="_ _3"></span>documenting <span class="_ _2"></span>the <span class="_ _3"></span>UNIX <span class="_ _3"></span>V<span class="_ _6"></span>ersion <span class="_ _3"></span>6 <span class="_ _2"></span>operating</div><div class="t m0 x76 h51 y5682 ff19 fs2a fc0 sc0 ls0 ws0">system <span class="_ _42"> </span>source <span class="_ _23"> </span>code</div><div class="t m0 xb7 h51 y5683 ff19 fs2a fc0 sc0 ls0 ws0">[</div><div class="t m0 x59 h51 y5682 ff19 fs2a fc0 sc0 ls0 ws0">Lions <span class="_ _42"> </span>1977, <span class="_ _42"> </span>1996</div><div class="t m0 x114 h51 y5683 ff19 fs2a fc0 sc0 ls0 ws0">]</div><div class="t m0 xcb h51 y5682 ff19 fs2a fc0 sc0 ls1644 ws0">.I<span class="_ _1d"></span><span class="ls1645">ts<span class="_ _b"></span><span class="ls0">impliﬁes <span class="_ _23"> </span>the <span class="_ _42"> </span>task <span class="_ _42"> </span>of <span class="_ _42"> </span>studying <span class="_ _42"> </span>large <span class="_ _42"> </span>amounts <span class="_ _42"> </span>of</span></span></div><div class="t m0 x76 h51 y5684 ff19 fs2a fc0 sc0 ls0 ws0">source code.</div><div class="t m0 x32 h2a y5685 ff19 fsf fc0 sc0 ls0 ws0">Note <span class="_ _53"> </span>that <span class="_ _53"> </span>we <span class="_ _53"> </span>do <span class="_ _e"> </span>not <span class="_ _53"> </span>bother <span class="_ _53"> </span>to <span class="_ _53"> </span>number <span class="_ _e"> </span>blank <span class="_ _53"> </span>lines.<span class="_ _65"> </span>Although <span class="_ _53"> </span>this <span class="_ _53"> </span>departs <span class="_ _e"> </span>from <span class="_ _42"> </span>the</div><div class="t m0 x32 h26 y5686 ff19 fsf fc0 sc0 ls0 ws0">normal <span class="_ _3"></span>behavior <span class="_ _3"></span>of <span class="_ _3"></span>such <span class="_ _3"></span>tools <span class="_ _9"></span>as<span class="_ _47"> </span><span class="ff1a">pr</span></div><div class="t m0 xb5 h2a y5687 ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 xc6 h2a y5686 ff19 fsf fc0 sc0 ls0 ws0">1</div><div class="t m0 xf5 h2a y5687 ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x87 h2a y5686 ff19 fsf fc0 sc0 ls0 ws0">,<span class="_ _47"> </span>we<span class="_ _47"> </span>have <span class="_ _3"></span>nothing <span class="_ _9"></span>interesting <span class="_ _2"></span>to <span class="_ _3"></span>say <span class="_ _3"></span>about <span class="_ _9"></span>blank</div><div class="t m0 x32 h2a y5688 ff19 fsf fc0 sc0 ls0 ws0">lines.</div><a class="l" href="#pf13" data-dest-detail='[19,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1067.448863px;width:156.143806px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a><a class="l" href="#pf13" data-dest-detail='[19,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.891785px;bottom:484.950918px;width:113.112107px;height:19.678986px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
