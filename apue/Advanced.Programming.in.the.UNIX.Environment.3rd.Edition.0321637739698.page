<div id="pf2ba" class="pf w4 h1f" data-page-no="2ba"><div class="pc pc2ba w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2ba.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">664<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>IPC<span class="_ _e8"> </span>Chapter <span class="_"> </span>17</span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">Client <span class="_"> </span>*client<span class="_"> </span><span class="ls15c">=N<span class="_ _1d"></span><span class="ls0">ULL;</span></span></div><div class="t m0 x32 h57 y380f ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y3810 ff1a fs2d fc0 sc0 ls0 ws0">main(int argc, char *argv[])</div><div class="t m0 x32 h57 y31b5 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y124b ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>c;</div><div class="t m0 x8a h57 y350a ff1a fs2d fc0 sc0 ls0 ws0">log_open(&quot;open.serv&quot;, LOG_PID, LOG_USER);</div><div class="t m0 x8a h57 yaed ff1a fs2d fc0 sc0 ls0 ws0">opterr = 0;<span class="_ _8a"> </span>/* don’t want getopt() writing to stderr */</div><div class="t m0 x8a h57 y340d ff1a fs2d fc0 sc0 ls0 ws0">while ((c = getopt(argc, argv, &quot;d&quot;)) != EOF) {</div><div class="t m0 x9d h57 y340e ff1a fs2d fc0 sc0 ls0 ws0">switch (c) {</div><div class="t m0 x9d h57 y16fa ff1a fs2d fc0 sc0 ls0 ws0">case ’d’:<span class="_ _b7"> </span>/* debug */</div><div class="t m0 x1f h57 y340f ff1a fs2d fc0 sc0 ls0 ws0">debug = log_to_stderr = 1;</div><div class="t m0 x1f h57 y3410 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x9d h57 y1313 ff1a fs2d fc0 sc0 ls0 ws0">case ’?’:</div><div class="t m0 x1f h57 y1314 ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;unrecognized option: -%c&quot;, optopt);</div><div class="t m0 x9d h57 y1315 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y351c ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y879 ff1a fs2d fc0 sc0 ls0 ws0">if (debug == 0)</div><div class="t m0 x9d h57 y87a ff1a fs2d fc0 sc0 ls0 ws0">daemonize(&quot;opend&quot;);</div><div class="t m0 x8a h57 y131a ff1a fs2d fc0 sc0 ls0 ws0">loop(); <span class="_ _15"> </span>/*<span class="_"> </span>never returns */</div><div class="t m0 x32 h57 y131b ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x3d h5e y4e23 ff18 fs10 fc0 sc0 ls0 ws0">Figure 17.28<span class="_ _5a"> </span><span class="ff19">The server<span class="_"> </span><span class="ff1a">main<span class="_ _e"> </span></span>function, version 2</span></div><div class="t m0 x3f h4d y4e24 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _53"> </span>function<span class="_ _44"> </span><span class="ff1a">loop<span class="_ _4b"> </span></span>is <span class="_ _53"> </span>the <span class="_ _53"> </span>server<span class="_ _9"></span>’s <span class="_ _42"> </span>inﬁnite <span class="_ _e"> </span>loop.<span class="_ _54"> </span><span class="ls164">We<span class="_ _23"></span></span>’ll <span class="_ _42"> </span>show <span class="_ _53"> </span>two <span class="_ _e"> </span>versions <span class="_ _53"> </span>of <span class="_ _53"> </span>this</div><div class="t m0 x32 h4d y4e25 ff19 fs26 fc0 sc0 ls0 ws0">function. <span class="_"> </span>Figur<span class="ls140c">e1<span class="_ _4f"></span><span class="ls0">7.29 <span class="_ _2"></span>shows one version <span class="_ _2"></span>that uses<span class="_ _66"> </span><span class="ff1a">select</span><span class="ls140d">;F<span class="_ _d"></span><span class="ls0">igur<span class="ls140d">e1<span class="_ _4f"></span><span class="ls0">7.30 <span class="_ _2"></span>shows another</span></span></span></span></span></span></div><div class="t m0 x32 h4d y4e26 ff19 fs26 fc0 sc0 ls0 ws0">version that uses<span class="_"> </span><span class="ff1a">poll</span>.</div><div class="t m0 x32 h5d y4e27 ff1a fs2f fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&quot;opend.h&quot;</div><div class="t m0 x32 h5d y4e28 ff1a fs2f fc0 sc0 ls0 ws0">#include <span class="_ _68"> </span>&lt;sys/select.h&gt;</div><div class="t m0 x32 h5d y4e29 ff1a fs2f fc0 sc0 ls0 ws0">void</div><div class="t m0 x32 h5d y4e2a ff1a fs2f fc0 sc0 ls0 ws0">loop(void)</div><div class="t m0 x32 h5d y4e2b ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y4e2c ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>i,<span class="_"> </span>n, maxfd, maxi, listenfd, clifd, nread;</div><div class="t m0 x8a h5d y4e2d ff1a fs2f fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>buf[MAXLINE];</div><div class="t m0 x8a h5d y4e2e ff1a fs2f fc0 sc0 ls0 ws0">uid_t <span class="_ _d9"> </span>uid;</div><div class="t m0 x8a h5d y4e2f ff1a fs2f fc0 sc0 ls0 ws0">fd_set <span class="_"> </span>rset,<span class="_"> </span>allset;</div><div class="t m0 x8a h5d y4e30 ff1a fs2f fc0 sc0 ls0 ws0">FD_ZERO(&amp;allset);</div><div class="t m0 x8a h5d y4e31 ff1a fs2f fc0 sc0 ls0 ws0">/* obtain fd to listen for client requests on */</div><div class="t m0 x8a h5d y4e32 ff1a fs2f fc0 sc0 ls0 ws0">if ((listenfd = serv_listen(CS_OPEN)) &lt; 0)</div><div class="t m0 x9d h5d y4e33 ff1a fs2f fc0 sc0 ls0 ws0">log_sys(&quot;serv_listen error&quot;);</div><div class="t m0 x8a h5d y4e34 ff1a fs2f fc0 sc0 ls0 ws0">FD_SET(listenfd, &amp;allset);</div><div class="t m0 x8a h5d y4e35 ff1a fs2f fc0 sc0 ls0 ws0">maxfd = listenfd;</div><div class="t m0 x8a h5d y4e36 ff1a fs2f fc0 sc0 ls0 ws0">maxi = -1;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
