<div id="pf16e" class="pf w4 h1f" data-page-no="16e"><div class="pc pc16e w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg16e.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">332<span class="_ _1b"> </span><span class="ff19">Signals <span class="_ _24b"> </span>Chapter<span class="_ _21"> </span>10</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;pwd.h&gt;</div><div class="t m0 x32 h57 y13a0 ff1a fs2d fc0 sc0 ls0 ws0">static void</div><div class="t m0 x32 h57 y846 ff1a fs2d fc0 sc0 ls0 ws0">my_alarm(int signo)</div><div class="t m0 x32 h57 y847 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y13a1 ff1a fs2d fc0 sc0 ls0 ws0">struct passwd<span class="_ _68"> </span>*rootptr;</div><div class="t m0 x8a h57 y368 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;in signal handler\n&quot;);</div><div class="t m0 x8a h57 y848 ff1a fs2d fc0 sc0 ls0 ws0">if ((rootptr = getpwnam(&quot;root&quot;)) == NULL)</div><div class="t m0 x1f h57 y849 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;getpwnam(root) error&quot;);</div><div class="t m0 x8a h57 y84a ff1a fs2d fc0 sc0 ls0 ws0">alarm(1);</div><div class="t m0 x32 h57 y1fdc ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y84c ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y84d ff1a fs2d fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h57 y84e ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y84f ff1a fs2d fc0 sc0 ls0 ws0">struct passwd<span class="_ _68"> </span>*ptr;</div><div class="t m0 x8a h57 y1d3a ff1a fs2d fc0 sc0 ls0 ws0">signal(SIGALRM, my_alarm);</div><div class="t m0 x8a h57 y1d3b ff1a fs2d fc0 sc0 ls0 ws0">alarm(1);</div><div class="t m0 x8a h57 y1d3c ff1a fs2d fc0 sc0 ls0 ws0">for ( ; ; ) {</div><div class="t m0 x9d h57 y1d3d ff1a fs2d fc0 sc0 ls0 ws0">if ((ptr = getpwnam(&quot;sar&quot;)) == NULL)</div><div class="t m0 x1f h57 y1d3e ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;getpwnam error&quot;);</div><div class="t m0 x9d h57 y855 ff1a fs2d fc0 sc0 ls0 ws0">if (strcmp(ptr-&gt;pw_name, &quot;sar&quot;) != 0)</div><div class="t m0 x1f h57 y1d3f ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;return value corrupted!, pw_name = %s\n&quot;,</div><div class="t m0 x36 h57 y2aad ff1a fs2d fc0 sc0 ls0 ws0">ptr-&gt;pw_name);</div><div class="t m0 x8a h57 y2aae ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y2aaf ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xda h2d y2ab0 ff18 fs10 fc0 sc0 ls0 ws0">Figure 10.5<span class="_ _5a"> </span><span class="ff19">Call a nonreentrant function from a signal handler</span></div><div class="t m0 x3f h49 y2ab1 ff19 fs26 fc0 sc0 ls0 ws0">When this <span class="_ _2"></span>program <span class="_ _2"></span>was <span class="_ _2"></span>run, the <span class="_ _2"></span>results wer<span class="ls193">er<span class="_ _4f"></span><span class="ls0">andom. <span class="_ _66"> </span>Usually<span class="_ _6"></span><span class="ls193">,t<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>program would</span></span></span></span></div><div class="t m0 x32 h4d y2ab2 ff19 fs26 fc0 sc0 ls0 ws0">be <span class="_ _e"> </span>terminated <span class="_"> </span>by <span class="_ _e"> </span>a<span class="_ _59"> </span><span class="ff1a">SIGSEGV<span class="_ _59"> </span></span>signal <span class="_ _e"> </span>when <span class="_"> </span>the <span class="_ _e"> </span>signal <span class="_"> </span>handler <span class="_ _53"> </span>returned <span class="_"> </span>after <span class="_ _53"> </span>several</div><div class="t m0 x32 h4d y2ab3 ff19 fs26 fc0 sc0 ls0 ws0">iterations. <span class="_ _45"> </span>An<span class="_ _45"> </span>examination <span class="_ _9"></span>of <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">core<span class="_ _45"> </span></span>ﬁle <span class="_ _9"></span>showed <span class="_ _23"></span>that <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">main<span class="_ _45"> </span></span>function <span class="_ _9"></span>had <span class="_ _9"></span>called</div><div class="t m0 x32 h4d y2ab4 ff1a fs26 fc0 sc0 ls0 ws0">getpwnam<span class="ff19 lsc2c">,b<span class="_ _4f"></span><span class="ls0">ut <span class="_ _2"></span>that <span class="_ _2"></span>when<span class="_ _66"> </span><span class="ff1a">getpwnam<span class="_ _47"> </span></span>called<span class="_ _66"> </span><span class="ff1a">free</span><span class="lsc2c">,t<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>signal <span class="_ _2"></span>handler <span class="_ _2"></span>interrupted <span class="_ _2"></span>it <span class="_ _2"></span>and</span></span></span></span></div><div class="t m0 x32 h4d y2ab5 ff19 fs26 fc0 sc0 ls0 ws0">called<span class="_ _16"> </span><span class="ff1a">getpwnam</span><span class="lsc2d">,w<span class="_ _1d"></span><span class="ls0">hich <span class="_ _47"> </span>in <span class="_ _47"> </span>turn <span class="_ _45"> </span>called<span class="_ _61"> </span><span class="ff1a">free</span><span class="lsc2e">.T<span class="_ _49"></span><span class="ls0">he <span class="_ _47"> </span>data <span class="_ _47"> </span>structures <span class="_ _66"> </span>maintained <span class="_ _45"> </span>by</span></span></span></span></div><div class="t m0 x32 h4d y2ab6 ff1a fs26 fc0 sc0 ls0 ws0">malloc<span class="_ _66"> </span><span class="ff19">and<span class="_ _66"> </span></span>free<span class="_ _66"> </span><span class="ff19">had <span class="_ _2"></span>been <span class="_ _2"></span>corrupted when <span class="_ _2"></span>the <span class="_ _2"></span>signal <span class="_ _2"></span>handler (indirectly) <span class="_ _2"></span>called<span class="_"> </span></span>free</div><div class="t m0 x32 h4d y2ab7 ff19 fs26 fc0 sc0 ls0 ws0">while <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">main<span class="_ _35"> </span></span>function <span class="_ _9"></span>was <span class="_ _9"></span>also <span class="_ _23"></span>calling<span class="_ _45"> </span><span class="ff1a">free</span><span class="lsc2f">.O<span class="_ _26"></span><span class="ls0">ccasionally<span class="_ _6"></span><span class="lsc30">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>program <span class="_ _3"></span>would <span class="_ _23"></span>run</span></span></span></span></div><div class="t m0 x32 h4d y2ab8 ff19 fs26 fc0 sc0 ls0 ws0">for several <span class="_ _2"></span>seconds <span class="_ _2"></span>befor<span class="lsc31">ec<span class="_ _4f"></span><span class="ls0">rashing <span class="_ _2"></span>with <span class="_ _2"></span>a<span class="_"> </span><span class="ff1a">SIGSEGV<span class="_ _47"> </span></span>error<span class="_ _6"></span><span class="lsc32">.W<span class="_ _5b"></span><span class="ls0">hen <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">main<span class="_ _47"> </span></span>function did</span></span></span></span></div><div class="t m0 x32 h49 y2ab9 ff19 fs26 fc0 sc0 ls2b1 ws0">ru<span class="lsc33">nc<span class="_ _26"></span><span class="ls0">orrectly <span class="_ _45"> </span>after <span class="_ _35"> </span>the <span class="_ _45"> </span>signal <span class="_ _35"> </span>had <span class="_ _35"> </span>been <span class="_ _45"> </span>caught, <span class="_ _35"> </span>the <span class="_ _35"> </span>r<span class="_ _0"></span>eturn <span class="_ _45"> </span>value <span class="_ _35"> </span>was <span class="_ _35"> </span>sometimes</span></span></div><div class="t m0 x32 h49 y2aba ff19 fs26 fc0 sc0 ls0 ws0">corrupted and sometimes ﬁne.</div><div class="t m0 x3f h49 y2abb ff19 fs26 fc0 sc0 ls0 ws0">As <span class="_ _2"></span>shown <span class="_ _2"></span>by <span class="_ _2"></span>this <span class="_ _3"></span>example, <span class="_ _2"></span>if <span class="_ _2"></span>we <span class="_ _3"></span>call <span class="_ _2"></span>a <span class="_ _2"></span>nonreentrant <span class="_ _2"></span>function <span class="_ _2"></span>from <span class="_ _2"></span>a <span class="_ _2"></span>signal <span class="_ _2"></span>handler<span class="_ _1"></span>,</div><div class="t m0 x32 h49 y2abc ff19 fs26 fc0 sc0 ls0 ws0">the results ar<span class="_ _0"></span><span class="lsd3">eu<span class="_ _d"></span><span class="ls0">npredictable.</span></span></div><div class="t m0 x35 h7d y2abd ff16 fs3b fc0 sc0 ls0 ws0">10.7<span class="_ _6d"> </span><span class="ff1f">SIGCLD<span class="_ _54"> </span></span>Semantics</div><div class="t m0 x32 h54 y2abe ff19 fs2c fc0 sc0 lsa9d ws0">Tw<span class="_ _9"></span><span class="lsc34">os<span class="_ _b"></span><span class="ls0">ignals <span class="_ _9"></span>that <span class="_ _9"></span>continually <span class="_ _9"></span>generate <span class="_ _9"></span>confusion <span class="_ _9"></span>are<span class="_ _45"> </span><span class="ff1a">SIGCLD<span class="_ _47"> </span></span>and<span class="_ _45"> </span><span class="ff1a">SIGCHLD</span><span class="lsc35">.T<span class="_ _62"></span><span class="ls0">he <span class="_ _9"></span>name</span></span></span></span></div><div class="t m0 x32 h54 y2abf ff1a fs2c fc0 sc0 ls0 ws0">SIGCLD<span class="_ _45"> </span><span class="ff19">(without <span class="_ _3"></span>the<span class="_ _45"> </span></span>H<span class="ff19">)<span class="_ _45"> </span>is<span class="_ _47"> </span>f<span class="ls150">ro<span class="_ _2"></span><span class="lsc36">mS<span class="_ _b"></span><span class="ls0">ystem <span class="_ _9"></span>V<span class="_ _4"></span><span class="lsc36">,a<span class="_ _8"></span><span class="ls0">nd <span class="_ _3"></span>this <span class="_ _9"></span>signal <span class="_ _9"></span>has <span class="_ _9"></span>differ<span class="_ _0"></span>ent <span class="_ _9"></span>semantics <span class="_ _3"></span>from</span></span></span></span></span></span></div><div class="t m0 x32 h54 y2ac0 ff19 fs2c fc0 sc0 ls0 ws0">the BSD signal, named<span class="_"> </span><span class="ff1a">SIGCHLD</span><span class="ls5e9">.T<span class="_ _4a"></span><span class="ls0">he POSIX.1 signal is also named<span class="_"> </span><span class="ff1a">SIGCHLD</span>.</span></span></div><a class="l" href="#pff" data-dest-detail='[15,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892842px;bottom:200.354711px;width:145.896591px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
