<div id="pf21a" class="pf w4 h1f" data-page-no="21a"><div class="pc pc21a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg21a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">504<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">These <span class="_ _9"></span>interfaces <span class="_ _9"></span>can <span class="_ _9"></span>be <span class="_ _9"></span>implemented <span class="_ _9"></span>as <span class="_ _9"></span>either <span class="_ _9"></span>macros <span class="_ _3"></span>or <span class="_ _9"></span>functions.<span class="_ _5a"> </span>An<span class="_ _45"> </span><span class="ff1a">fd_set<span class="_ _45"> </span></span>is</div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">set <span class="_ _2"></span>to <span class="_ _3"></span>all <span class="_ _3"></span>zer<span class="ls882">ob<span class="_ _8"></span><span class="ls0">its <span class="_ _3"></span>by <span class="_ _2"></span>calling<span class="_ _47"> </span><span class="ff1a">FD_ZERO</span><span class="ls105c">.T<span class="_ _7"></span><span class="ls882">ot<span class="_ _4f"></span><span class="ls0">urn <span class="_ _3"></span>on <span class="_ _2"></span>a <span class="_ _3"></span>single <span class="_ _3"></span>bit <span class="_ _3"></span>in <span class="_ _3"></span>a <span class="_ _2"></span>set, <span class="_ _3"></span>we <span class="_ _3"></span>use<span class="_ _47"> </span><span class="ff1a">FD_SET</span>.</span></span></span></span></span></div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _80"> </span>c<span class="_ _9"></span><span class="ls0">an <span class="_ _9"></span>clear <span class="_ _3"></span>a <span class="_ _9"></span>single <span class="_ _3"></span>bit <span class="_ _9"></span>by <span class="_ _3"></span>calling<span class="_ _45"> </span><span class="ff1a">FD_CLR</span><span class="ls105d">.F<span class="_ _62"></span><span class="ls0">inally<span class="_ _6"></span>,<span class="_ _47"> </span>we<span class="_ _45"> </span>can <span class="_ _3"></span>test <span class="_ _3"></span>whether <span class="_ _9"></span>a <span class="_ _3"></span>given <span class="_ _9"></span>bit <span class="_ _3"></span>is</span></span></span></div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">turned on in the set with<span class="_"> </span><span class="ff1a">FD_ISSET</span>.</div><div class="t m0 x3f h26 y133 ff19 fsf fc0 sc0 ls0 ws0">After <span class="_ _3"></span>declaring <span class="_ _9"></span>a <span class="_ _3"></span>descriptor <span class="_ _9"></span>set, <span class="_ _3"></span>we <span class="_ _3"></span>must <span class="_ _9"></span>zer<span class="ls105e">ot<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>set <span class="_ _3"></span>using<span class="_ _45"> </span><span class="ff1a">FD_ZERO</span><span class="ls105f">.W<span class="_ _52"></span><span class="ls105e">et<span class="_ _b"></span><span class="ls0">hen <span class="_ _9"></span>set</span></span></span></span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">bits in the set for each descriptor that we’r<span class="ls44">ei<span class="_ _4f"></span><span class="ls0">nterested in, as in</span></span></div><div class="t m0 x3f h57 y3dbd ff1a fs2d fc0 sc0 ls0 ws0">fd_set <span class="_ _d9"> </span>rset;</div><div class="t m0 x3f h57 y3dbe ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _8a"> </span>fd;</div><div class="t m0 x3f h57 y3dbf ff1a fs2d fc0 sc0 ls0 ws0">FD_ZERO(&amp;rset);</div><div class="t m0 x3f h57 y3dc0 ff1a fs2d fc0 sc0 ls0 ws0">FD_SET(fd, &amp;rset);</div><div class="t m0 x3f h57 y3dc1 ff1a fs2d fc0 sc0 ls0 ws0">FD_SET(STDIN_FILENO, &amp;rset);</div><div class="t m0 x32 h26 y3dc2 ff19 fsf fc0 sc0 ls0 ws0">On <span class="_ _42"> </span>return <span class="_ _53"> </span>from<span class="_ _44"> </span><span class="ff1a">select</span>,<span class="_ _44"> </span>we<span class="_ _44"> </span>can <span class="_ _53"> </span>test <span class="_ _53"> </span>whether <span class="_ _53"> </span>a <span class="_ _53"> </span>given <span class="_ _42"> </span>bit <span class="_ _53"> </span>in <span class="_ _53"> </span>the <span class="_ _53"> </span>set <span class="_ _53"> </span>is <span class="_ _53"> </span>still <span class="_ _53"> </span>on <span class="_ _53"> </span>using</div><div class="t m0 x32 h26 y3dc3 ff1a fsf fc0 sc0 ls0 ws0">FD_ISSET<span class="ff19">:</span></div><div class="t m0 x3f h57 y3dc4 ff1a fs2d fc0 sc0 ls0 ws0">if (FD_ISSET(fd, &amp;rset)) {</div><div class="t m0 x122 h57 y3dc5 ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 x122 h57 y3dc6 ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 x122 h57 y3dc7 ff1a fs2d fc0 sc0 ls0 ws0">.</div><div class="t m0 x3f h57 y3dc8 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x3f h26 y3dc9 ff19 fsf fc0 sc0 ls0 ws0">Any (or all) of the <span class="_ _2"></span>middle three arguments to<span class="_"> </span><span class="ff1a">select<span class="_ _80"> </span></span>(the pointers to <span class="_ _2"></span>the descriptor</div><div class="t m0 x32 h2a y3dca ff19 fsf fc0 sc0 ls0 ws0">sets) <span class="_ _9"></span>can <span class="_ _9"></span>be <span class="_ _23"></span>null <span class="_ _9"></span>pointers <span class="_ _9"></span>if <span class="_ _23"></span>we’r<span class="ls1060">en<span class="_ _43"></span><span class="ls0">ot <span class="_ _23"></span>interested <span class="_ _3"></span>in <span class="_ _23"></span>that <span class="_ _9"></span>condition.<span class="_ _5a"> </span>If <span class="_ _23"></span>all <span class="_ _9"></span>three <span class="_ _9"></span>pointers</span></span></div><div class="t m0 x32 h26 y3dcb ff19 fsf fc0 sc0 ls0 ws0">are<span class="_ _35"> </span><span class="ff1a">NULL</span><span class="ls1061">,t<span class="_ _43"></span><span class="ls0">hen <span class="_ _23"> </span>we <span class="_ _42"> </span>have <span class="_ _23"> </span>a <span class="_ _42"> </span>higher-pr<span class="_ _0"></span>ecision <span class="_ _23"> </span>timer <span class="_ _42"> </span>than <span class="_ _42"> </span>is <span class="_ _23"> </span>provided <span class="_ _23"> </span>by<span class="_ _44"> </span><span class="ff1a">sleep</span><span class="ls1062">.(<span class="_ _52"></span><span class="ls0">Recall</span></span></span></span></div><div class="t m0 x32 h26 y3dcc ff19 fsf fc0 sc0 ls0 ws0">from <span class="_ _3"></span>Section <span class="_ _3"></span>10.19 <span class="_ _9"></span>that<span class="_ _47"> </span><span class="ff1a">sleep<span class="_ _45"> </span></span>waits <span class="_ _3"></span>for <span class="_ _9"></span>an <span class="_ _3"></span>integral <span class="_ _9"></span>number <span class="_ _9"></span>of <span class="_ _3"></span>seconds.<span class="_ _16"> </span><span class="ls65">Wi<span class="_ _9"></span></span>th<span class="_ _47"> </span><span class="ff1a">select</span>,</div><div class="t m0 x32 h2a y3dcd ff19 fsf fc0 sc0 ls0 ws0">we <span class="_ _42"> </span>can <span class="_ _42"> </span>wait <span class="_ _42"> </span>for <span class="_ _42"> </span>intervals <span class="_ _42"> </span>less <span class="_ _53"> </span>than <span class="_ _42"> </span>one <span class="_ _42"> </span>second; <span class="_ _42"> </span>the <span class="_ _42"> </span>actual <span class="_ _42"> </span>resolution <span class="_ _42"> </span>depends <span class="_ _42"> </span>on <span class="_ _42"> </span>the</div><div class="t m0 x32 h2a y3dce ff19 fsf fc0 sc0 ls0 ws0">system’s clock.)<span class="_ _59"> </span>Exercise 14.5 shows such a function.</div><div class="t m0 x3f h26 y3dcf ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _23"></span>ﬁrst <span class="_ _9"></span>argument <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">select</span>,<span class="_ _35"> </span><span class="ff1b">maxfdp1</span><span class="ls879">,s<span class="_ _43"></span><span class="ls0">tands <span class="_ _23"> </span>for <span class="_ _23"></span>‘<span class="_ _0"></span>‘maximum <span class="_ _9"></span>ﬁle <span class="_ _23"> </span>descriptor <span class="_ _23"> </span>plus</span></span></div><div class="t m0 x32 h2a y3dd0 ff19 fsf fc0 sc0 ls0 ws0">1.’<span class="_ _0"></span><span class="ls1063">’W<span class="_ _52"></span><span class="ls1064">ec<span class="_ _8"></span><span class="ls0">alculate <span class="_ _3"></span>the <span class="_ _9"></span>highest <span class="_ _2"></span>descriptor <span class="_ _9"></span>that <span class="_ _3"></span>we’r<span class="ls4a2">ei<span class="_ _b"></span><span class="ls0">nterested <span class="_ _3"></span>in, <span class="_ _3"></span>considering <span class="_ _3"></span>all <span class="_ _3"></span>three <span class="_ _3"></span>of</span></span></span></span></span></div><div class="t m0 x32 h2a y3dd1 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>descriptor <span class="_"> </span>sets, <span class="_ _53"> </span>add <span class="_ _e"> </span>1, <span class="_ _e"> </span>and <span class="_ _e"> </span>that’s <span class="_ _e"> </span>the <span class="_ _e"> </span>ﬁrst <span class="_ _e"> </span>argument. <span class="_ _44"> </span>W<span class="_ _6"></span><span class="ls1065">ec<span class="_ _c"></span><span class="ls0">ould <span class="_ _53"> </span>just <span class="_"> </span>set <span class="_ _53"> </span>the <span class="_ _e"> </span>ﬁrst</span></span></div><div class="t m0 x32 h26 y3dd2 ff19 fsf fc0 sc0 ls0 ws0">argument to<span class="_"> </span><span class="ff1a">FD_SETSIZE</span><span class="ls64c">,ac<span class="_ _d"></span><span class="ls0">onstant in<span class="_ _66"> </span><span class="ff1a">&lt;sys/select.h&gt;<span class="_ _66"> </span></span>that <span class="_ _2"></span>speciﬁes the <span class="_ _2"></span>maximum</span></span></div><div class="t m0 x32 h2a y3dd3 ff19 fsf fc0 sc0 ls0 ws0">number <span class="_ _42"> </span>of <span class="_ _42"> </span>descriptors <span class="_ _42"> </span>(often <span class="_ _42"> </span>1,024), <span class="_ _42"> </span>but <span class="_ _42"> </span>this <span class="_ _42"> </span>value <span class="_ _42"> </span>is <span class="_ _42"> </span>too <span class="_ _42"> </span>large <span class="_ _42"> </span>for <span class="_ _42"> </span>most <span class="_ _42"> </span>applications.</div><div class="t m0 x32 h2a y3dd4 ff19 fsf fc0 sc0 ls0 ws0">Indeed, <span class="_ _59"> </span>most <span class="_ _46"> </span>applications <span class="_ _46"> </span>probably <span class="_ _59"> </span>use <span class="_ _59"> </span>between <span class="_ _46"> </span>3 <span class="_ _46"> </span>and <span class="_ _59"> </span>10 <span class="_ _46"> </span>descriptors.<span class="_ _5e"> </span>(Some</div><div class="t m0 x32 h2a y3dd5 ff19 fsf fc0 sc0 ls0 ws0">applications <span class="_ _9"></span>need <span class="_ _23"> </span>many <span class="_ _23"></span>mor<span class="ls242">ed<span class="_ _43"></span><span class="ls0">escriptors, <span class="_ _23"></span>but <span class="_ _9"></span>these <span class="_ _23"> </span>UNIX <span class="_ _23"></span>programs <span class="_ _9"></span>ar<span class="ls242">ea<span class="_ _43"></span><span class="ls0">typical.) <span class="_ _35"> </span>By</span></span></span></span></div><div class="t m0 x32 h2a y3dd6 ff19 fsf fc0 sc0 ls0 ws0">specifying <span class="_ _53"> </span>the <span class="_ _53"> </span>highest <span class="_ _53"> </span>descriptor <span class="_ _53"> </span>that <span class="_ _53"> </span>we’r<span class="lsff6">ei<span class="_ _c"></span><span class="ls0">nterested <span class="_ _42"> </span>in, <span class="_ _53"> </span>we <span class="_ _53"> </span>can <span class="_ _53"> </span>prevent <span class="_ _53"> </span>the <span class="_ _53"> </span>kernel</span></span></div><div class="t m0 x32 h2a y3dd7 ff19 fsf fc0 sc0 ls0 ws0">from going thr<span class="_ _0"></span>ough hundreds of unused bits in the three descriptor sets, looking for bits</div><div class="t m0 x32 h2a y3dd8 ff19 fsf fc0 sc0 ls0 ws0">that ar<span class="ls44">et<span class="_ _4f"></span><span class="ls0">urned on.</span></span></div><div class="t m0 x3f h2a y3dd9 ff19 fsf fc0 sc0 ls0 ws0">As an example, Figur<span class="ls44">e1<span class="_ _4f"></span><span class="ls0">4.16 shows what two descriptor sets look like if we write</span></span></div><div class="t m0 x3f h57 y3dda ff1a fs2d fc0 sc0 ls0 ws0">fd_set <span class="_"> </span>readset,<span class="_"> </span>writeset;</div><div class="t m0 x3f h57 y3ddb ff1a fs2d fc0 sc0 ls0 ws0">FD_ZERO(&amp;readset);</div><div class="t m0 x3f h57 y3ddc ff1a fs2d fc0 sc0 ls0 ws0">FD_ZERO(&amp;writeset);</div><div class="t m0 x3f h57 y3ddd ff1a fs2d fc0 sc0 ls0 ws0">FD_SET(0, &amp;readset);</div><div class="t m0 x3f h57 y3dde ff1a fs2d fc0 sc0 ls0 ws0">FD_SET(3, &amp;readset);</div><div class="t m0 x3f h57 y3ddf ff1a fs2d fc0 sc0 ls0 ws0">FD_SET(1, &amp;writeset);</div><div class="t m0 x3f h57 y3de0 ff1a fs2d fc0 sc0 ls0 ws0">FD_SET(2, &amp;writeset);</div><div class="t m0 x3f h57 y3de1 ff1a fs2d fc0 sc0 ls0 ws0">select(4, &amp;readset, &amp;writeset, NULL, NULL);</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
