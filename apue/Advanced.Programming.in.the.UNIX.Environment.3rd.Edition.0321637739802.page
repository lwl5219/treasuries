<div id="pf322" class="pf w4 h1f" data-page-no="322"><div class="pc pc322 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg322.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">768<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">377 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">378 <span class="_ _68"> </span>*<span class="_"> </span>Read the current data record into the data buffer.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">379 <span class="_ _68"> </span>*<span class="_"> </span>Return a pointer to the null-terminated data buffer.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">380 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">381 <span class="_ _d9"> </span>static<span class="_"> </span>char *</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">382 <span class="_ _d9"> </span>_db_readdat(DB<span class="_"> </span>*db)</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">383 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">384 <span class="_ _15"> </span>if<span class="_"> </span>(lseek(db-&gt;datfd, db-&gt;datoff, SEEK_SET) == -1)</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">385 <span class="_ _186"> </span>err_dump(&quot;_db_readdat:<span class="_"> </span>lseek error&quot;);</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">386 <span class="_ _15"> </span>if<span class="_"> </span>(read(db-&gt;datfd, db-&gt;datbuf, db-&gt;datlen) != db-&gt;datlen)</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">387 <span class="_ _186"> </span>err_dump(&quot;_db_readdat:<span class="_"> </span>read error&quot;);</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">388 <span class="_ _15"> </span>if<span class="_"> </span>(db-&gt;datbuf[db-&gt;datlen-1] != NEWLINE)<span class="_ _15"> </span>/* sanity check */</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">389 <span class="_ _186"> </span>err_dump(&quot;_db_readdat:<span class="_"> </span>missing newline&quot;);</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">390 <span class="_ _15"> </span>db-&gt;datbuf[db-&gt;datlen-1]<span class="_"> </span>=<span class="_"> </span>0;<span class="_"> </span>/*<span class="_"> </span>replace newline with null */</div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">391 <span class="_ _15"> </span>return(db-&gt;datbuf); <span class="_ _15"> </span>/*<span class="_"> </span>return pointer to data record */</div><div class="t m0 x32 h57 y56d0 ff1a fs2d fc0 sc0 ls0 ws0">392 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">393 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">394 <span class="_ _68"> </span>*<span class="_"> </span>Delete the specified record.</div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">395 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">396 <span class="_ _d9"> </span>int</div><div class="t m0 x32 h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">397 <span class="_ _d9"> </span>db_delete(DBHANDLE<span class="_"> </span>h, const char *key)</div><div class="t m0 x32 h57 y57b4 ff1a fs2d fc0 sc0 ls0 ws0">398 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y419b ff1a fs2d fc0 sc0 ls0 ws0">399 <span class="_ _15"> </span>DB<span class="_ _189"> </span>*db = h;</div><div class="t m0 x32 h57 y419c ff1a fs2d fc0 sc0 ls0 ws0">400 <span class="_ _15"> </span>int <span class="_ _15"> </span>rc<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls1698">;/<span class="_ _92"></span><span class="ls15c">*a<span class="_ _5b"></span><span class="ls0">ssume record will be found */</span></span></span></span></div><div class="t m0 x32 h57 y2add ff1a fs2d fc0 sc0 ls0 ws0">401 <span class="_ _15"> </span>if<span class="_"> </span>(_db_find_and_lock(db, key, 1) == 0) {</div><div class="t m0 x32 h57 y2ade ff1a fs2d fc0 sc0 ls0 ws0">402 <span class="_ _186"> </span>_db_dodelete(db);</div><div class="t m0 x32 h57 y2c66 ff1a fs2d fc0 sc0 ls0 ws0">403 <span class="_ _186"> </span>db-&gt;cnt_delok++;</div><div class="t m0 x32 h57 y2c67 ff1a fs2d fc0 sc0 ls0 ws0">404 <span class="_ _15"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y573f ff1a fs2d fc0 sc0 ls0 ws0">405 <span class="_ _186"> </span>rc<span class="_"> </span><span class="ls15c">=-<span class="_ _1d"></span><span class="ls0">1; <span class="_ _1ef"> </span>/*<span class="_"> </span>not found */</span></span></div><div class="t m0 x32 h57 y57b5 ff1a fs2d fc0 sc0 ls0 ws0">406 <span class="_ _186"> </span>db-&gt;cnt_delerr++;</div><div class="t m0 x32 h57 y57b6 ff1a fs2d fc0 sc0 ls0 ws0">407 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y57b7 ff1a fs2d fc0 sc0 ls0 ws0">408 <span class="_ _15"> </span>if<span class="_"> </span>(un_lock(db-&gt;idxfd, db-&gt;chainoff, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y57b8 ff1a fs2d fc0 sc0 ls0 ws0">409 <span class="_ _186"> </span>err_dump(&quot;db_delete:<span class="_"> </span>un_lock error&quot;);</div><div class="t m0 x32 h57 y57b9 ff1a fs2d fc0 sc0 ls0 ws0">410 <span class="_ _15"> </span>return(rc);</div><div class="t m0 x32 h57 y57ba ff1a fs2d fc0 sc0 ls0 ws0">411 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y56f2 ff19 fs26 fc0 sc0 ls0 ws0">[377 <span class="_ _a"></span>– <span class="_ _a"></span>392]<span class="_ _65"> </span>The<span class="_ _45"> </span><span class="ff1a">_db_readdat<span class="_ _47"> </span></span>function <span class="_ _9"></span>populates <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">datbuf<span class="_ _45"> </span></span>ﬁeld <span class="_ _3"></span>in <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">DB<span class="_ _47"> </span></span>structure</div><div class="t m0 x11a h4d y56f3 ff19 fs26 fc0 sc0 ls0 ws0">with the <span class="_ _2"></span>contents <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>data <span class="_ _2"></span>record, expecting <span class="_ _2"></span>that <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">datoff<span class="_ _66"> </span></span>and<span class="_ _47"> </span><span class="ff1a">datlen</span></div><div class="t m0 x11a h49 y56f4 ff19 fs26 fc0 sc0 ls0 ws0">ﬁelds will have been properly initialized alr<span class="_ _0"></span>eady<span class="_ _4"></span>.</div><div class="t m0 x32 h4d y57bb ff19 fs26 fc0 sc0 ls0 ws0">[393 <span class="_ _a"></span>– <span class="_ _a"></span>41<span class="_ _0"></span>1] <span class="_ _4b"> </span>The<span class="_ _44"> </span><span class="ff1a">db_delete<span class="_ _35"> </span></span>function <span class="_ _42"> </span>is <span class="_ _42"> </span>used <span class="_ _23"> </span>to <span class="_ _42"> </span>delete <span class="_ _42"> </span>a <span class="_ _23"> </span>recor<span class="ls1699">dg<span class="_ _43"></span><span class="ls0">iven <span class="_ _23"> </span>its <span class="_ _42"> </span>key<span class="_ _4"></span><span class="ls169a">.W<span class="_ _5d"></span><span class="ls1699">eu<span class="_ _43"></span><span class="ls0">se</span></span></span></span></span></div><div class="t m0 x11a h4d y57bc ff1a fs26 fc0 sc0 ls0 ws0">_db_find_and_lock<span class="_ _48"> </span><span class="ff19">to <span class="_ _59"> </span>determine <span class="_ _59"> </span>whether <span class="_ _59"> </span>the <span class="_ _4b"> </span>recor<span class="ls169b">de<span class="_ _5d"></span><span class="ls0">xists <span class="_ _59"> </span>in <span class="_ _59"> </span>the</span></span></span></div><div class="t m0 x11a h4d y56f7 ff19 fs26 fc0 sc0 ls0 ws0">database. <span class="_"> </span>If<span class="_ _66"> </span>it <span class="_ _2"></span>does, we <span class="_ _2"></span>call<span class="_"> </span><span class="ff1a">_db_dodelete<span class="_ _66"> </span></span>to <span class="_ _2"></span>do <span class="_ _2"></span>the work <span class="_ _2"></span>needed to <span class="_ _2"></span>delete</div><div class="t m0 x11a h4d y56f9 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>record. <span class="_ _45"> </span>The<span class="_ _45"> </span>thir<span class="ls169c">da<span class="_ _b"></span><span class="lscc">rg<span class="ls0">ument <span class="_ _9"></span>to<span class="_ _35"> </span><span class="ff1a">_db_find_and_lock<span class="_ _45"> </span></span>controls <span class="_ _9"></span>whether</span></span></span></div><div class="t m0 x11a h49 y56fa ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>chain <span class="_ _42"> </span>is <span class="_ _53"> </span>read <span class="_ _53"> </span>locked <span class="_ _53"> </span>or <span class="_ _53"> </span>write <span class="_ _42"> </span>locked.<span class="_ _65"> </span>Here<span class="_ _44"> </span>we<span class="_ _44"> </span>a<span class="lscc">re <span class="_"> </span>re</span>questing <span class="_ _53"> </span>a <span class="_ _53"> </span>write</div><div class="t m0 x11a h4d y56fb ff19 fs26 fc0 sc0 ls0 ws0">lock, <span class="_ _9"></span>since <span class="_ _9"></span>we <span class="_ _9"></span>will <span class="_ _9"></span>potentially <span class="_ _9"></span>change <span class="_ _9"></span>the <span class="_ _9"></span>list.<span class="_ _5a"> </span>Since<span class="_ _45"> </span><span class="ff1a">_db_find_and_lock</span></div><div class="t m0 x11a h49 y56fc ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turns <span class="_ _9"></span>with <span class="_ _23"></span>the <span class="_ _9"></span>lock <span class="_ _9"></span>still <span class="_ _9"></span>held, <span class="_ _9"></span>we <span class="_ _23"></span>need <span class="_ _9"></span>to <span class="_ _9"></span>unlock <span class="_ _9"></span>it, <span class="_ _9"></span>regardless <span class="_ _3"></span>of <span class="_ _9"></span>whether</span></div><div class="t m0 x11a h49 y57bd ff19 fs26 fc0 sc0 ls0 ws0">the recor<span class="_ _0"></span><span class="lsd3">dw<span class="_ _d"></span><span class="ls0">as found.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
