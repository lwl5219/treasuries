<div id="pf1f4" class="pf w4 h1f" data-page-no="1f4"><div class="pc pc1f4 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1f4.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">466<span class="_ _1b"> </span><span class="ff19">Daemon <span class="_"> </span>Processes <span class="_ _20f"> </span>Chapter<span class="_ _4b"> </span>13</span></div><div class="t m0 x35 h53 y12f ff16 fs2b fc0 sc0 ls0 ws0">13.3 <span class="_ _93"> </span>Coding<span class="_ _54"> </span>Rules</div><div class="t m0 x32 h2a y4de ff19 fsf fc0 sc0 ls0 ws0">Some <span class="_ _9"></span>basic <span class="_ _23"></span>rules <span class="_ _9"></span>to <span class="_ _23"></span>coding <span class="_ _9"></span>a <span class="_ _23"></span>daemon <span class="_ _23"></span>pr<span class="_ _0"></span>event <span class="_ _9"></span>unwanted <span class="_ _23"></span>interactions <span class="_ _23"></span>fr<span class="_ _0"></span>om <span class="_ _9"></span>happening.</div><div class="t m0 x32 h26 y6d0 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>s<span class="_ _23"></span><span class="ls0">tate these <span class="_ _2"></span>rules <span class="_ _2"></span>her<span class="lsf69">ea<span class="_ _8"></span><span class="ls0">nd <span class="_ _2"></span>then <span class="_ _2"></span>show <span class="_ _2"></span>a <span class="_ _2"></span>function,<span class="_"> </span><span class="ff1a">daemonize</span><span class="lsf69">,t<span class="_ _d"></span><span class="ls0">hat <span class="_ _2"></span>implements <span class="_ _2"></span>them.</span></span></span></span></span></div><div class="t m0 x3f h26 y39b4 ff19 fsf fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>Call<span class="_ _47"> </span><span class="ff1a">umask<span class="_ _47"> </span></span>to <span class="_ _2"></span>set <span class="_ _2"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>mode <span class="_ _2"></span>creation <span class="_ _2"></span>mask <span class="_ _3"></span>to <span class="_ _2"></span>a <span class="_ _3"></span>known <span class="_ _3"></span>value, <span class="_ _2"></span>usually <span class="_ _3"></span>0.<span class="_ _61"> </span>The</div><div class="t m0 x41 h2a y39b5 ff19 fsf fc0 sc0 ls0 ws0">inherited <span class="_ _23"></span>ﬁle <span class="_ _9"></span>mode <span class="_ _23"> </span>creation <span class="_ _9"></span>mask <span class="_ _23"> </span>could <span class="_ _23"> </span>be <span class="_ _23"></span>set <span class="_ _23"></span>to <span class="_ _9"></span>deny <span class="_ _23"> </span>certain <span class="_ _23"></span>permissions.<span class="_ _51"> </span>If</div><div class="t m0 x41 h2a y39b6 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _23"> </span>daemon <span class="_ _42"> </span>process <span class="_ _23"> </span>creates <span class="_ _23"> </span>ﬁles, <span class="_ _42"> </span>it <span class="_ _23"> </span>may <span class="_ _42"> </span>want <span class="_ _23"> </span>to <span class="_ _42"> </span>set <span class="_ _42"> </span>speciﬁc <span class="_ _23"> </span>permissions.<span class="_ _54"> </span>For</div><div class="t m0 x41 h2a y39b7 ff19 fsf fc0 sc0 ls0 ws0">example, <span class="_ _2"></span>if <span class="_ _2"></span>it <span class="_ _2"></span>creates ﬁles <span class="_ _2"></span>with <span class="_ _2"></span>group-r<span class="_ _0"></span>ead and <span class="_ _2"></span>group-write <span class="_ _2"></span>enabled, <span class="_ _2"></span>a <span class="_ _2"></span>ﬁle <span class="_ _2"></span>mode</div><div class="t m0 x41 h2a y39b8 ff19 fsf fc0 sc0 ls0 ws0">creation <span class="_ _3"></span>mask <span class="_ _9"></span>that <span class="_ _9"></span>turns <span class="_ _9"></span>of<span class="lsf6a">fe<span class="_ _b"></span><span class="ls0">ither <span class="_ _9"></span>of <span class="_ _9"></span>these <span class="_ _9"></span>permissions <span class="_ _9"></span>would <span class="_ _9"></span>undo <span class="_ _9"></span>its <span class="_ _9"></span>efforts.</span></span></div><div class="t m0 x41 h2a y39b9 ff19 fsf fc0 sc0 ls0 ws0">On <span class="_ _2"></span>the <span class="_ _2"></span>other <span class="_ _2"></span>hand, <span class="_ _2"></span>if <span class="_ _2"></span>the <span class="_ _2"></span>daemon <span class="_ _3"></span>calls <span class="_ _2"></span>library <span class="_ _2"></span>functions <span class="_ _2"></span>that <span class="_ _2"></span>result in <span class="_ _3"></span>ﬁles <span class="_ _2"></span>being</div><div class="t m0 x41 h2a y39ba ff19 fsf fc0 sc0 ls0 ws0">created, <span class="_ _23"> </span>then <span class="_ _42"> </span>it <span class="_ _42"> </span>might <span class="_ _42"> </span>make <span class="_ _42"> </span>sense <span class="_ _42"> </span>to <span class="_ _42"> </span>set <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>mode <span class="_ _42"> </span>create <span class="_ _42"> </span>mask <span class="_ _42"> </span>to <span class="_ _42"> </span>a <span class="_ _42"> </span>more</div><div class="t m0 x41 h2a y39bb ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">strictive <span class="_ _42"> </span>value <span class="_ _23"> </span>(such <span class="_ _42"> </span>as <span class="_ _42"> </span>007), <span class="_ _23"> </span>since <span class="_ _42"> </span>the <span class="_ _23"> </span>library <span class="_ _42"> </span>functions <span class="_ _42"> </span>might <span class="_ _23"> </span>not <span class="_ _42"> </span>allow <span class="_ _23"> </span>the</span></div><div class="t m0 x41 h2a y39bc ff19 fsf fc0 sc0 ls0 ws0">caller to specify the permissions through an explicit ar<span class="_ _0"></span>gument.</div><div class="t m0 x3f h26 y39bd ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>Call<span class="_ _4b"> </span><span class="ff1a">fork<span class="_ _4b"> </span></span>and <span class="_ _53"> </span>have <span class="_ _e"> </span>the <span class="_ _53"> </span>parent<span class="_ _4b"> </span><span class="ff1a">exit</span><span class="lsf6b">.T<span class="_ _64"></span><span class="ls0">his <span class="_ _e"> </span>does <span class="_ _53"> </span>several <span class="_ _e"> </span>things.<span class="_ _65"> </span>First, <span class="_ _e"> </span>if <span class="_ _e"> </span>the</span></span></div><div class="t m0 x41 h2a y39be ff19 fsf fc0 sc0 ls0 ws0">daemon <span class="_ _42"> </span>was <span class="_ _42"> </span>started <span class="_ _23"> </span>as <span class="_ _42"> </span>a <span class="_ _42"> </span>simple <span class="_ _42"> </span>shell <span class="_ _42"> </span>command, <span class="_ _42"> </span>having <span class="_ _42"> </span>the <span class="_ _42"> </span>parent <span class="_ _23"> </span>terminate</div><div class="t m0 x41 h2a y39bf ff19 fsf fc0 sc0 ls0 ws0">makes <span class="_ _3"></span>the <span class="_ _9"></span>shell <span class="_ _3"></span>think <span class="_ _9"></span>that <span class="_ _3"></span>the <span class="_ _9"></span>command <span class="_ _3"></span>is <span class="_ _9"></span>done.<span class="_ _16"> </span>Second, <span class="_ _3"></span>the <span class="_ _9"></span>child <span class="_ _3"></span>inherits <span class="_ _9"></span>the</div><div class="t m0 x41 h2a y39c0 ff19 fsf fc0 sc0 ls0 ws0">process <span class="_ _3"></span>group <span class="_ _3"></span>ID <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _3"></span>parent <span class="_ _9"></span>but <span class="_ _3"></span>gets <span class="_ _9"></span>a <span class="_ _9"></span>new <span class="_ _9"></span>process <span class="_ _3"></span>ID, <span class="_ _9"></span>so <span class="_ _9"></span>we’r<span class="lsf6c">eg<span class="_ _b"></span><span class="ls0">uaranteed</span></span></div><div class="t m0 x41 h2a y39c1 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _3"></span>the <span class="_ _3"></span>child <span class="_ _3"></span>is <span class="_ _3"></span>not <span class="_ _9"></span>a <span class="_ _3"></span>process <span class="_ _2"></span>group <span class="_ _3"></span>leader<span class="_ _6"></span><span class="lsf6d">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _3"></span>is <span class="_ _9"></span>a <span class="_ _3"></span>prer<span class="_ _0"></span>equisite <span class="_ _3"></span>for <span class="_ _3"></span>the <span class="_ _3"></span>call <span class="_ _3"></span>to</span></span></div><div class="t m0 x41 h26 y39c2 ff1a fsf fc0 sc0 ls0 ws0">setsid<span class="_ _80"> </span><span class="ff19">that is done next.</span></div><div class="t m0 x3f h26 y39c3 ff19 fsf fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>Call<span class="_ _47"> </span><span class="ff1a">setsid<span class="_ _47"> </span></span>to <span class="_ _2"></span>create <span class="_ _2"></span>a <span class="_ _3"></span>new <span class="_ _2"></span>session.<span class="_ _16"> </span>The <span class="_ _3"></span>three <span class="_ _2"></span>steps <span class="_ _2"></span>listed <span class="_ _3"></span>in <span class="_ _3"></span>Section <span class="_ _2"></span>9.5 <span class="_ _3"></span>occur<span class="_ _1"></span>.</div><div class="t m0 x41 h2a y39c4 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _2"></span>process (a) <span class="_ _3"></span>becomes <span class="_ _2"></span>the <span class="_ _2"></span>leader <span class="_ _2"></span>of <span class="_ _3"></span>a <span class="_ _2"></span>new <span class="_ _2"></span>session, <span class="_ _2"></span>(b) <span class="_ _3"></span>becomes <span class="_ _2"></span>the <span class="_ _2"></span>leader <span class="_ _2"></span>of <span class="_ _3"></span>a</div><div class="t m0 x41 h2a y39c5 ff19 fsf fc0 sc0 ls0 ws0">new process gr<span class="_ _0"></span>oup, and (c) is disassociated fr<span class="_ _0"></span>om its controlling terminal.</div><div class="t m0 xf6 h52 y39c6 ff19 fs2a fc0 sc0 ls0 ws0">Under <span class="_"> </span>System <span class="_ _42"> </span>V–based <span class="_"> </span>systems, <span class="_"> </span>some <span class="_"> </span>people <span class="_ _42"> </span>recommend <span class="_"> </span>calling<span class="_ _35"> </span><span class="ff1a">fork<span class="_ _35"> </span></span>again <span class="_"> </span>at <span class="_ _42"> </span>this</div><div class="t m0 xf6 h51 y39c7 ff19 fs2a fc0 sc0 ls0 ws0">point, <span class="_ _9"></span>terminating <span class="_ _9"></span>the <span class="_ _3"></span>parent, <span class="_ _9"></span>and <span class="_ _9"></span>continuing <span class="_ _9"></span>the <span class="_ _9"></span>daemon <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>child.<span class="_ _59"> </span>This <span class="_ _9"></span>guarantees</div><div class="t m0 xf6 h51 y39c8 ff19 fs2a fc0 sc0 ls0 ws0">that <span class="_ _9"> </span>the <span class="_ _23"> </span>daemon <span class="_ _23"> </span>is <span class="_ _9"> </span>not <span class="_ _23"> </span>a <span class="_ _23"> </span>session <span class="_ _9"> </span>leader<span class="_ _0"></span><span class="lsf6e">,w<span class="_ _b"></span><span class="ls0">hich <span class="_ _23"> </span>prevents <span class="_ _9"> </span>it <span class="_ _23"> </span>from <span class="_ _9"> </span>acquiring <span class="_ _23"> </span>a <span class="_ _23"> </span>controlling</span></span></div><div class="t m0 xf6 h51 y39c9 ff19 fs2a fc0 sc0 ls0 ws0">terminal <span class="_"> </span>under <span class="_"> </span>the <span class="_ _e"> </span>System <span class="_ _e"> </span>V <span class="_ _80"> </span>rules <span class="_"> </span>(Section <span class="_"> </span>9.6).<span class="_ _51"> </span>Alternatively<span class="_ _6"></span>,<span class="_ _35"> </span>to<span class="_ _44"> </span>avoid <span class="_ _e"> </span>acquiring <span class="_ _e"> </span>a</div><div class="t m0 xf6 h52 y39ca ff19 fs2a fc0 sc0 ls0 ws0">controlling terminal, be sur<span class="_ _0"></span>e<span class="_"> </span>to<span class="_"> </span>specify<span class="_"> </span><span class="ff1a">O_NOCTTY<span class="_ _53"> </span></span>whenever opening a terminal device.</div><div class="t m0 x3f h2a y39cb ff19 fsf fc0 sc0 ls0 ws0">4. <span class="_ _51"> </span>Change<span class="_ _51"> </span>the <span class="_ _44"> </span>current <span class="_ _35"> </span>working <span class="_ _35"> </span>directory <span class="_ _35"> </span>to <span class="_ _35"> </span>the <span class="_ _44"> </span>root <span class="_ _35"> </span>dir<span class="_ _0"></span>ectory<span class="_ _4"></span><span class="lsf6f">.T<span class="_ _4d"></span><span class="ls0">he <span class="_ _35"> </span>current</span></span></div><div class="t m0 x41 h2a y39cc ff19 fsf fc0 sc0 ls0 ws0">working <span class="_ _2"></span>directory <span class="_ _2"></span>inherited <span class="_ _2"></span>from <span class="_ _2"></span>the <span class="_ _2"></span>parent <span class="_ _2"></span>could <span class="_ _3"></span>be <span class="_ _2"></span>on <span class="_ _2"></span>a <span class="_ _3"></span>mounted <span class="_ _2"></span>ﬁle <span class="_ _3"></span>system.</div><div class="t m0 x41 h2a y39cd ff19 fsf fc0 sc0 ls0 ws0">Since <span class="_ _3"></span>daemons <span class="_ _9"></span>normally <span class="_ _3"></span>exist <span class="_ _9"></span>until <span class="_ _3"></span>the <span class="_ _9"></span>system <span class="_ _9"></span>is <span class="_ _3"></span>rebooted, <span class="_ _3"></span>if <span class="_ _9"></span>the <span class="_ _3"></span>daemon <span class="_ _9"></span>stays</div><div class="t m0 x41 h2a y39ce ff19 fsf fc0 sc0 ls0 ws0">on a mounted ﬁle system, that ﬁle system cannot be unmounted.</div><div class="t m0 x41 h2a y2ca4 ff19 fsf fc0 sc0 ls0 ws0">Alternatively<span class="_ _4"></span><span class="ls881">,s<span class="_ _b"></span><span class="ls0">ome <span class="_ _9"></span>daemons <span class="_ _23"> </span>might <span class="_ _23"> </span>change <span class="_ _23"> </span>the <span class="_ _23"> </span>current <span class="_ _23"></span>working <span class="_ _23"></span>directory <span class="_ _9"></span>to <span class="_ _23"> </span>a</span></span></div><div class="t m0 x41 h2a y2ca5 ff19 fsf fc0 sc0 ls0 ws0">speciﬁc <span class="_ _9"></span>location <span class="_ _9"></span>wher<span class="ls29a">et<span class="_ _b"></span><span class="ls0">hey <span class="_ _9"></span>will <span class="_ _23"></span>do <span class="_ _9"></span>all <span class="_ _9"></span>their <span class="_ _23"></span>work.<span class="_ _5a"> </span>For <span class="_ _9"></span>example, <span class="_ _9"></span>a <span class="_ _23"></span>line <span class="_ _9"></span>printer</span></span></div><div class="t m0 x41 h2a y2ca6 ff19 fsf fc0 sc0 ls0 ws0">spooling daemon might change its working directory to its spool dir<span class="_ _0"></span>ectory<span class="_ _4"></span>.</div><div class="t m0 x3f h2a y39cf ff19 fsf fc0 sc0 ls0 ws0">5. <span class="_ _51"> </span>Unneeded<span class="_ _4b"> </span>ﬁle <span class="_ _53"> </span>descriptors <span class="_ _53"> </span>should <span class="_ _e"> </span>be <span class="_ _53"> </span>closed.<span class="_ _65"> </span>This <span class="_ _e"> </span>prevents <span class="_ _42"> </span>the <span class="_ _e"> </span>daemon <span class="_ _53"> </span>from</div><div class="t m0 x41 h2a y39d0 ff19 fsf fc0 sc0 ls0 ws0">holding <span class="_ _3"></span>open <span class="_ _3"></span>any <span class="_ _9"></span>descriptors <span class="_ _3"></span>that <span class="_ _9"></span>it <span class="_ _3"></span>may <span class="_ _3"></span>have <span class="_ _9"></span>inherited <span class="_ _3"></span>from <span class="_ _3"></span>its <span class="_ _3"></span>parent <span class="_ _3"></span>(which</div><div class="t m0 x41 h26 y39d1 ff19 fsf fc0 sc0 ls0 ws0">could <span class="_ _42"> </span>be <span class="_ _42"> </span>a <span class="_ _42"> </span>shell <span class="_ _42"> </span>or <span class="_ _42"> </span>some <span class="_ _42"> </span>other <span class="_ _42"> </span>process). <span class="_ _35"> </span>W<span class="_ _6"></span><span class="ls59a">ec<span class="_ _43"></span><span class="ls0">an <span class="_ _42"> </span>use <span class="_ _42"> </span>our<span class="_ _44"> </span><span class="ff1a">open_max<span class="_ _44"> </span></span>function</span></span></div><div class="t m0 x41 h26 y39d2 ff19 fsf fc0 sc0 ls0 ws0">(Figur<span class="lsf70">e2<span class="_ _b"></span><span class="ls0">.17) <span class="_ _3"></span>or <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">getrlimit<span class="_ _47"> </span></span>function <span class="_ _3"></span>(Section <span class="_ _3"></span>7.1<span class="_ _1"></span>1) <span class="_ _3"></span>to <span class="_ _3"></span>determine <span class="_ _2"></span>the <span class="_ _3"></span>highest</span></span></div><div class="t m0 x41 h2a y39d3 ff19 fsf fc0 sc0 ls0 ws0">descriptor and close all descriptors up to that value.</div><div class="t m0 x3f h26 y39d4 ff19 fsf fc0 sc0 ls0 ws0">6. <span class="_ _51"> </span>Some<span class="_ _59"> </span>daemons <span class="_"> </span>open <span class="_"> </span>ﬁle <span class="_ _e"> </span>descriptors <span class="_"> </span>0, <span class="_ _e"> </span>1, <span class="_"> </span>and <span class="_"> </span>2 <span class="_ _e"> </span>to<span class="_ _59"> </span><span class="ff1a">/dev/null<span class="_ _59"> </span></span>so <span class="_"> </span>that <span class="_"> </span>any</div><div class="t m0 x41 h2a y39d5 ff19 fsf fc0 sc0 ls0 ws0">library routines <span class="_ _2"></span>that <span class="_ _2"></span>try <span class="_ _2"></span>to read <span class="_ _2"></span>from standar<span class="lsf71">di<span class="_ _4f"></span><span class="ls0">nput <span class="_ _2"></span>or write <span class="_ _2"></span>to <span class="_ _2"></span>standar<span class="lsf71">do<span class="_ _4f"></span><span class="ls0">utput</span></span></span></span></div><div class="t m0 x41 h2a y39d6 ff19 fsf fc0 sc0 ls0 ws0">or <span class="_ _2"></span>standar<span class="lsf72">de<span class="_ _8"></span><span class="ls0">rror <span class="_ _2"></span>will <span class="_ _3"></span>have <span class="_ _2"></span>no <span class="_ _3"></span>effect. <span class="_ _47"> </span>Since<span class="_ _66"> </span>the <span class="_ _3"></span>daemon <span class="_ _3"></span>is <span class="_ _2"></span>not <span class="_ _3"></span>associated <span class="_ _3"></span>with <span class="_ _2"></span>a</span></span></div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1236.288916px;width:116.675804px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
