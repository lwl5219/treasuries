<div id="pfaa" class="pf w4 h1f" data-page-no="aa"><div class="pc pcaa w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bgaa.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">136<span class="_ _1b"> </span><span class="ff19">Files <span class="_"> </span>and <span class="_"> </span>Directories <span class="_ _18d"> </span>Chapter<span class="_ _4b"> </span>4</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">If we compile this program, call the executable<span class="_"> </span><span class="ff1a">mycd</span><span class="ls44">,a<span class="_ _4f"></span><span class="ls0">nd run it, we get the following:</span></span></div><div class="t m0 x3f h57 y1377 ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">pwd</span></div><div class="t m0 x3f h57 y1378 ff1a fs2d fc0 sc0 ls0 ws0">/usr/lib</div><div class="t m0 x3f h57 y1379 ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">mycd</span></div><div class="t m0 x3f h57 y137a ff1a fs2d fc0 sc0 ls0 ws0">chdir to /tmp succeeded</div><div class="t m0 x3f h57 y137b ff1a fs2d fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">pwd</span></div><div class="t m0 x3f h57 y137c ff1a fs2d fc0 sc0 ls0 ws0">/usr/lib</div><div class="t m0 x32 h26 y137d ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _e"> </span>current <span class="_ _e"> </span>working <span class="_ _e"> </span>directory <span class="_ _e"> </span>for <span class="_ _e"> </span>the <span class="_"> </span>shell <span class="_ _53"> </span>that <span class="_"> </span>executed <span class="_ _53"> </span>the<span class="_ _59"> </span><span class="ff1a">mycd<span class="_ _59"> </span></span>program <span class="_ _53"> </span>didn’t</div><div class="t m0 x32 h2a y137e ff19 fsf fc0 sc0 ls0 ws0">change. <span class="_ _66"> </span>This<span class="_ _47"> </span>is a <span class="_ _2"></span>side <span class="_ _3"></span>effect of <span class="_ _2"></span>the <span class="_ _2"></span>way <span class="_ _2"></span>that <span class="_ _2"></span>the <span class="_ _2"></span>shell <span class="_ _3"></span>executes <span class="_ _2"></span>programs. <span class="_"> </span>Each<span class="_ _66"> </span>program</div><div class="t m0 x32 h2a y137f ff19 fsf fc0 sc0 ls0 ws0">is <span class="_ _9"></span>run <span class="_ _9"></span>in <span class="_ _9"></span>a <span class="_ _9"></span>separate <span class="_ _9"></span>process, <span class="_ _3"></span>so <span class="_ _9"></span>the <span class="_ _9"></span>current <span class="_ _9"></span>working <span class="_ _9"></span>directory <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>shell <span class="_ _9"></span>is <span class="_ _9"></span>unaffected</div><div class="t m0 x32 h26 y1380 ff19 fsf fc0 sc0 ls0 ws0">by <span class="_ _42"> </span>the <span class="_ _53"> </span>call <span class="_ _42"> </span>to<span class="_ _44"> </span><span class="ff1a">chdir<span class="_ _44"> </span></span>in <span class="_ _53"> </span>the <span class="_ _53"> </span>program. <span class="_ _35"> </span>For<span class="_ _4b"> </span>this <span class="_ _42"> </span>reason, <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">chdir<span class="_ _44"> </span></span>function <span class="_ _53"> </span>has <span class="_ _42"> </span>to <span class="_ _53"> </span>be</div><div class="t m0 x32 h26 y1381 ff19 fsf fc0 sc0 ls0 ws0">called directly fr<span class="_ _0"></span>om the shell, so the<span class="_"> </span><span class="ff1a">cd<span class="_ _80"> </span></span>command is built into the shells.</div><div class="t m0 x3f h49 y1382 ff19 fs26 fc0 sc0 ls0 ws0">Because <span class="_ _9"></span>the <span class="_ _9"></span>kernel <span class="_ _9"></span>must <span class="_ _3"></span>maintain <span class="_ _9"></span>knowledge <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>current <span class="_ _9"></span>working <span class="_ _9"></span>directory<span class="_ _4"></span><span class="ls5dc">,w<span class="_ _b"></span><span class="ls0">e</span></span></div><div class="t m0 x32 h49 y1383 ff19 fs26 fc0 sc0 ls0 ws0">should <span class="_ _2"></span>be <span class="_ _2"></span>able <span class="_ _2"></span>to <span class="_ _3"></span>fetch <span class="_ _2"></span>its <span class="_ _2"></span>current <span class="_ _2"></span>value.<span class="_ _61"> </span>Unfortunately<span class="_ _4"></span><span class="ls5dd">,t<span class="_ _4f"></span><span class="ls0">he <span class="_ _3"></span>kernel <span class="_ _2"></span>doesn’t <span class="_ _2"></span>maintain <span class="_ _2"></span>the</span></span></div><div class="t m0 x32 h49 y1384 ff19 fs26 fc0 sc0 ls0 ws0">full <span class="_ _35"> </span>pathname <span class="_ _35"> </span>of <span class="_ _35"> </span>the <span class="_ _35"> </span>directory<span class="_ _4"></span><span class="ls5de">.I<span class="_ _4d"></span><span class="ls0">nstead, <span class="_ _35"> </span>the <span class="_ _35"> </span>kernel <span class="_ _35"> </span>keeps <span class="_ _35"> </span>information <span class="_ _35"> </span>about <span class="_ _35"> </span>the</span></span></div><div class="t m0 x32 h49 y1385 ff19 fs26 fc0 sc0 ls0 ws0">directory<span class="_ _4"></span><span class="lsd3">,s<span class="_ _d"></span><span class="ls0">uch as a pointer to the directory’s v-node.</span></span></div><div class="t m0 x76 h2d y1386 ff19 fs10 fc0 sc0 ls0 ws0">The Linux <span class="_ _2"></span>kernel can <span class="_ _2"></span>determine the <span class="_ _2"></span>full pathname.<span class="_ _44"> </span>Its <span class="_ _2"></span>components ar<span class="ls5df">ed<span class="_ _5"></span><span class="ls0">istributed <span class="_ _2"></span>throughout</span></span></div><div class="t m0 x76 h2d y1387 ff19 fs10 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>mount <span class="_ _9"></span>table <span class="_ _9"></span>and <span class="_ _9"></span>the <span class="_ _9"></span>dcache <span class="_ _9"></span>table, <span class="_ _9"> </span>and <span class="_ _9"> </span>ar<span class="ls5e0">er<span class="_ _8"></span><span class="ls0">eassembled, <span class="_ _9"> </span>for <span class="_ _23"> </span>example, <span class="_ _3"></span>when <span class="_ _23"> </span>you <span class="_ _3"></span>read <span class="_ _9"></span>the</span></span></div><div class="t m0 x76 h5e y1388 ff1a fs10 fc0 sc0 ls0 ws0">/proc/self/cwd<span class="_ _53"> </span><span class="ff19">symbolic link.</span></div><div class="t m0 x3f h49 y1389 ff19 fs26 fc0 sc0 ls0 ws0">What <span class="_ _23"></span>we <span class="_ _23"> </span>need <span class="_ _23"> </span>is <span class="_ _23"> </span>a <span class="_ _23"> </span>function <span class="_ _42"> </span>that <span class="_ _23"></span>starts <span class="_ _23"></span>at <span class="_ _23"></span>the <span class="_ _23"> </span>current <span class="_ _23"></span>working <span class="_ _23"></span>directory <span class="_ _9"></span>(dot) <span class="_ _23"> </span>and</div><div class="t m0 x32 h49 y138a ff19 fs26 fc0 sc0 ls0 ws0">works <span class="_ _3"></span>its <span class="_ _3"></span>way <span class="_ _9"></span>up <span class="_ _3"></span>the <span class="_ _9"></span>directory <span class="_ _2"></span>hierarchy<span class="_ _4"></span><span class="ls5e1">,u<span class="_ _8"></span><span class="ls0">sing <span class="_ _9"></span>dot-dot <span class="_ _3"></span>to <span class="_ _3"></span>move <span class="_ _9"></span>up <span class="_ _3"></span>one <span class="_ _9"></span>level.<span class="_ _16"> </span>At <span class="_ _3"></span>each</span></span></div><div class="t m0 x32 h49 y138b ff19 fs26 fc0 sc0 ls0 ws0">level, <span class="_ _2"></span>the <span class="_ _2"></span>function <span class="_ _2"></span>reads <span class="_ _2"></span>the <span class="_ _2"></span>directory <span class="_ _2"></span>entries <span class="_ _2"></span>until <span class="_ _2"></span>it <span class="_ _3"></span>ﬁnds <span class="_ _2"></span>the <span class="_ _2"></span>name <span class="_ _3"></span>that <span class="_ _2"></span>corresponds to</div><div class="t m0 x32 h49 y138c ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _23"> </span>i-node <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _23"> </span>directory <span class="_ _23"> </span>that <span class="_ _42"> </span>it <span class="_ _42"> </span>just <span class="_ _23"> </span>came <span class="_ _42"> </span>from. <span class="_ _35"> </span>Repeating<span class="_ _35"> </span>this <span class="_ _42"> </span>procedur<span class="ls5e2">eu<span class="_ _c"></span><span class="ls0">ntil <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h49 y138d ff19 fs26 fc0 sc0 lscc ws0">ro<span class="ls0">ot <span class="_ _35"> </span>is <span class="_ _44"> </span>encountered <span class="_ _45"> </span>yields <span class="_ _44"> </span>the <span class="_ _35"> </span>entir<span class="ls5e3">ea<span class="_ _52"></span><span class="ls0">bsolute <span class="_ _35"> </span>pathname <span class="_ _44"> </span>of <span class="_ _35"> </span>the <span class="_ _35"> </span>current <span class="_ _35"> </span>working</span></span></span></div><div class="t m0 x32 h49 y138e ff19 fs26 fc0 sc0 ls0 ws0">directory<span class="_ _4"></span><span class="ls199">.F<span class="_ _4a"></span><span class="ls0">ortunately<span class="_ _4"></span><span class="lsd3">,af<span class="_ _d"></span><span class="ls0">unction already exists that does this work for us.</span></span></span></span></div><div class="t m0 x3f h4e y138f ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h4e y1390 ff1a fs28 fc0 sc0 ls0 ws0">char *getcwd(char *<span class="ff1b">buf</span><span class="ls1b6">,s<span class="_ _1d"></span><span class="ls0">ize_t<span class="_"> </span><span class="ff1b">size</span>);</span></span></div><div class="t m0 x1ba h4e y1391 ff19 fs28 fc0 sc0 ls0 ws0">Returns:<span class="_"> </span><span class="ff1b">buf<span class="_"> </span></span>if OK,<span class="_"> </span><span class="ff1a">NULL<span class="_ _e"> </span></span>on error</div><div class="t m0 x32 h60 y1392 ff19 fs2c fc0 sc0 ls155 ws0">We <span class="_ _47"> </span>m<span class="_ _9"></span><span class="ls0">ust <span class="_ _23"> </span>pass <span class="_ _23"> </span>to <span class="_ _42"> </span>this <span class="_ _23"></span>function <span class="_ _23"></span>the <span class="_ _23"></span>address <span class="_ _9"></span>of <span class="_ _42"> </span>a <span class="_ _23"></span>buffer<span class="_ _6"></span>,<span class="_ _35"> </span><span class="ff1b">buf</span><span class="ls5e4">,a<span class="_ _43"></span><span class="ls0">nd <span class="_ _23"> </span>its<span class="_ _35"> </span><span class="ff1b">size<span class="_ _35"> </span></span>(in <span class="_ _23"></span>bytes).<span class="_ _51"> </span>The</span></span></span></div><div class="t m0 x32 h55 y1393 ff19 fs2c fc0 sc0 ls0 ws0">buffer must <span class="_ _2"></span>be large <span class="_ _2"></span>enough <span class="_ _2"></span>to accommodate <span class="_ _2"></span>the <span class="_ _2"></span>absolute <span class="_ _2"></span>pathname <span class="_ _2"></span>plus <span class="_ _2"></span>a <span class="_ _2"></span>terminating</div><div class="t m0 x32 h55 y1394 ff19 fs2c fc0 sc0 ls0 ws0">null byte, <span class="_ _2"></span>or <span class="_ _2"></span>else <span class="_ _2"></span>an <span class="_ _2"></span>error <span class="_ _2"></span>will <span class="_ _2"></span>be returned. <span class="_ _66"> </span>(Recall<span class="_ _47"> </span>the discussion <span class="_ _2"></span>of <span class="_ _2"></span>allocating <span class="_ _2"></span>space <span class="_ _2"></span>for</div><div class="t m0 x32 h55 y1395 ff19 fs2c fc0 sc0 ls142 ws0">am<span class="_ _d"></span><span class="ls0">aximum-sized pathname in Section 2.5.5.)</span></div><div class="t m0 x76 h4f y1396 ff19 fs11 fc0 sc0 ls0 ws0">Some <span class="_ _2"></span>older <span class="_ _3"></span>implementations <span class="_ _3"></span>of<span class="_ _80"> </span><span class="ff1a">getcwd<span class="_ _66"> </span></span>allow <span class="_ _3"></span>the <span class="_ _2"></span>ﬁrst <span class="_ _3"></span>argument<span class="_ _80"> </span><span class="ff1b">buf<span class="_ _80"> </span></span>to <span class="_ _3"></span>be<span class="_ _66"> </span><span class="ff1a">NULL</span><span class="ls5e5">.I<span class="_ _55"></span><span class="ls5e6">nt<span class="_ _5"></span><span class="ls0">his <span class="_ _2"></span>case,</span></span></span></div><div class="t m0 x76 h4f y1397 ff19 fs11 fc0 sc0 ls0 ws0">the <span class="_ _23"> </span>function <span class="_ _23"> </span>calls<span class="_ _45"> </span><span class="ff1a">malloc<span class="_ _45"> </span></span>to <span class="_ _23"> </span>allocate<span class="_ _45"> </span><span class="ff1b">size<span class="_ _45"> </span></span>number <span class="_ _23"> </span>of <span class="_ _42"> </span>bytes <span class="_ _23"> </span>dynamically<span class="_ _6"></span><span class="ls5e7">.T<span class="_ _5b"></span><span class="ls0">his <span class="_ _23"> </span>is <span class="_ _42"> </span>not <span class="_ _23"> </span>part <span class="_ _23"> </span>of</span></span></div><div class="t m0 x76 h2e y1398 ff19 fs11 fc0 sc0 ls0 ws0">POSIX.1 or the Single UNIX Speciﬁcation and should be avoided.</div><div class="t m0 x35 h61 y1399 ff16 fs2c fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h54 y139a ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _42"> </span>program <span class="_ _23"> </span>in <span class="_ _42"> </span>Figur<span class="ls5e8">e4<span class="_ _43"></span><span class="ls0">.24 <span class="_ _23"> </span>changes <span class="_ _42"> </span>to <span class="_ _42"> </span>a <span class="_ _42"> </span>speciﬁc <span class="_ _42"> </span>directory <span class="_ _42"> </span>and <span class="_ _42"> </span>then <span class="_ _42"> </span>calls<span class="_ _35"> </span><span class="ff1a">getcwd<span class="_ _44"> </span></span>to</span></span></div><div class="t m0 x32 h55 y139b ff19 fs2c fc0 sc0 ls0 ws0">print the working directory<span class="_ _4"></span><span class="ls5e9">.I<span class="_ _4a"></span><span class="ls0">f<span class="_"> </span>we<span class="_"> </span>run the pr<span class="_ _0"></span>ogram, we get</span></span></div><div class="t m0 x3f h5d y139c ff1a fs2f fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h5d y139d ff1a fs2f fc0 sc0 ls0 ws0">cwd = /var/spool/uucppublic</div><div class="t m0 x3f h5d y139e ff1a fs2f fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">ls -l /usr/spool</span></div><div class="t m0 x3f h5d y139f ff1a fs2f fc0 sc0 ls0 ws0">lrwxrwxrwx <span class="_"> </span>1<span class="_"> </span>root <span class="_"> </span>12<span class="_"> </span>Jan 31 07:57 /usr/spool -&gt; ../var/spool</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
