<div id="pf32c" class="pf w4 h1f" data-page-no="32c"><div class="pc pc32c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg32c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">778<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">687 <span class="_ _15"> </span>while<span class="_"> </span>(offset != 0) {</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">688 <span class="_ _186"> </span>nextoffset<span class="_"> </span><span class="ls15c">=_<span class="_ _1d"></span><span class="ls0">db_readidx(db, offset);</span></span></div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">689 <span class="_ _186"> </span>if<span class="_"> </span>(strlen(db-&gt;idxbuf) == keylen &amp;&amp; db-&gt;datlen == datlen)</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">690 <span class="_ _82"> </span>break;<span class="_ _189"> </span>/* found a match */</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">691 <span class="_ _186"> </span>saveoffset<span class="_"> </span><span class="ls15c">=o<span class="_ _1d"></span><span class="ls0">ffset;</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">692 <span class="_ _186"> </span>offset<span class="_"> </span><span class="ls15c">=n<span class="_ _1d"></span><span class="ls0">extoffset;</span></span></div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">693 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y33ae ff1a fs2d fc0 sc0 ls0 ws0">694 <span class="_ _15"> </span>if<span class="_"> </span>(offset == 0) {</div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">695 <span class="_ _186"> </span>rc<span class="_"> </span><span class="ls15c">=-<span class="_ _1d"></span><span class="ls0">1; <span class="_ _87"> </span>/*<span class="_"> </span>no match found */</span></span></div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">696 <span class="_ _15"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">697 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">698 <span class="_ _176"> </span>*<span class="_"> </span>Found a free record with matching sizes.</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">699 <span class="_ _176"> </span>*<span class="_"> </span>The index record was read in by _db_readidx above,</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">700 <span class="_ _176"> </span>*<span class="_"> </span>which sets db-&gt;ptrval.<span class="_ _d9"> </span>Also, saveoffset points to</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">701 <span class="_ _176"> </span>*<span class="_"> </span>the chain ptr that pointed to this empty record on</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">702 <span class="_ _176"> </span>*<span class="_"> </span>the free list.<span class="_ _d9"> </span>We set this chain ptr to db-&gt;ptrval,</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">703 <span class="_ _176"> </span>*<span class="_"> </span>which removes the empty record from the free list.</div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">704 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">705 <span class="_ _186"> </span>_db_writeptr(db,<span class="_"> </span>saveoffset, db-&gt;ptrval);</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">706 <span class="_ _186"> </span>rc<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y33b5 ff1a fs2d fc0 sc0 ls0 ws0">707 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">708 <span class="_ _176"> </span>*<span class="_"> </span>Notice also that _db_readidx set both db-&gt;idxoff</div><div class="t m0 x32 h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">709 <span class="_ _176"> </span>*<span class="_"> </span>and db-&gt;datoff.<span class="_ _d9"> </span>This is used by the caller, db_store,</div><div class="t m0 x32 h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">710 <span class="_ _176"> </span>*<span class="_"> </span>to write the new index record and data record.</div><div class="t m0 x32 h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">711 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y33b9 ff1a fs2d fc0 sc0 ls0 ws0">712 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y5753 ff1a fs2d fc0 sc0 ls0 ws0">713 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y5754 ff1a fs2d fc0 sc0 ls0 ws0">714 <span class="_ _8a"> </span>*<span class="_"> </span>Unlock the free list.</div><div class="t m0 x32 h57 y5755 ff1a fs2d fc0 sc0 ls0 ws0">715 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y5756 ff1a fs2d fc0 sc0 ls0 ws0">716 <span class="_ _15"> </span>if<span class="_"> </span>(un_lock(db-&gt;idxfd, FREE_OFF, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x32 h57 y5794 ff1a fs2d fc0 sc0 ls0 ws0">717 <span class="_ _186"> </span>err_dump(&quot;_db_findfree:<span class="_"> </span>un_lock error&quot;);</div><div class="t m0 x32 h57 y582b ff1a fs2d fc0 sc0 ls0 ws0">718 <span class="_ _15"> </span>return(rc);</div><div class="t m0 x32 h57 y582c ff1a fs2d fc0 sc0 ls0 ws0">719 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h4d y582d ff19 fs26 fc0 sc0 ls0 ws0">[687 <span class="_ _a"></span>– <span class="_ _a"></span>693]<span class="_ _65"> </span>The<span class="_ _45"> </span><span class="ff1a">while<span class="_ _47"> </span></span>loop <span class="_ _9"></span>in<span class="_ _45"> </span><span class="ff1a">_db_findfree<span class="_ _47"> </span></span>goes <span class="_ _9"></span>through <span class="_ _3"></span>the <span class="_ _9"></span>free <span class="_ _3"></span>list, <span class="_ _9"></span>looking <span class="_ _9"></span>for <span class="_ _3"></span>a</div><div class="t m0 x11a h49 y582e ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cor<span class="lsc31">dw<span class="_ _4f"></span><span class="ls0">ith <span class="_ _2"></span>matching <span class="_ _2"></span>key <span class="_ _2"></span>and data <span class="_ _2"></span>sizes.<span class="_ _61"> </span>In <span class="_ _2"></span>this <span class="_ _2"></span>simple implementation, <span class="_ _2"></span>we</span></span></span></div><div class="t m0 x11a h49 y582f ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">use <span class="_"> </span>a <span class="_"> </span>deleted <span class="_"> </span>r<span class="_ _0"></span>ecor<span class="ls1694">do<span class="_ _5b"></span><span class="ls0">nly <span class="_"> </span>if <span class="_"> </span>the <span class="_"> </span>key <span class="_"> </span>length <span class="_ _e"> </span>and <span class="_"> </span>data <span class="_"> </span>length <span class="_"> </span>equal <span class="_"> </span>the</span></span></span></div><div class="t m0 x11a h49 y5830 ff19 fs26 fc0 sc0 ls0 ws0">lengths for <span class="_ _2"></span>the <span class="_ _2"></span>new <span class="_ _2"></span>recor<span class="ls6d5">db<span class="_ _8"></span><span class="ls0">eing <span class="_ _2"></span>inserted.<span class="_ _61"> </span>Ther<span class="ls16be">ea<span class="_ _4f"></span><span class="lscc">re <span class="_ _3"></span>a <span class="_ _9"></span>v<span class="ls0">ariety <span class="_ _2"></span>of <span class="_ _2"></span>better <span class="_ _2"></span>ways</span></span></span></span></span></div><div class="t m0 x11a h49 y5831 ff19 fs26 fc0 sc0 ls0 ws0">to reuse this deleted space, in exchange for added complexity<span class="_ _4"></span>.</div><div class="t m0 x32 h49 y5832 ff19 fs26 fc0 sc0 ls0 ws0">[694 <span class="_ _a"></span>– <span class="_ _a"></span>712]<span class="_ _65"> </span>If <span class="_ _9"></span>we <span class="_ _9"></span>can’t <span class="_ _9"></span>ﬁnd <span class="_ _9"></span>an <span class="_ _9"></span>available <span class="_ _9"></span>recor<span class="_ _0"></span>d<span class="_ _45"> </span>of<span class="_ _45"> </span>the <span class="_ _9"></span>requested <span class="_ _3"></span>key <span class="_ _9"></span>and <span class="_ _9"></span>data <span class="_ _9"></span>sizes, <span class="_ _9"></span>we</div><div class="t m0 x11a h49 y5833 ff19 fs26 fc0 sc0 ls0 ws0">set <span class="_ _e"> </span>the <span class="_ _e"> </span>return <span class="_ _53"> </span>code <span class="_ _e"> </span>to <span class="_ _e"> </span>indicate <span class="_ _e"> </span>failure. <span class="_ _4b"> </span>Otherwise,<span class="_ _4b"> </span>we <span class="_ _e"> </span>write <span class="_ _e"> </span>the <span class="_ _e"> </span>previous</div><div class="t m0 x11a h49 y5834 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cord’s <span class="_ _9"></span>chain <span class="_ _9"></span>pointer <span class="_ _3"></span>to <span class="_ _9"></span>point <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>next <span class="_ _9"></span>chain <span class="_ _9"></span>pointer <span class="_ _9"></span>value <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>recor<span class="_ _0"></span>d</span></div><div class="t m0 x11a h49 y5835 ff19 fs26 fc0 sc0 ls0 ws0">we have found.<span class="_ _59"> </span>This removes the recor<span class="_ _0"></span><span class="lsd3">df<span class="_ _d"></span><span class="lscc">ro<span class="_ _2"></span><span class="lsd3">mt<span class="_ _d"></span><span class="ls0">he free list.</span></span></span></span></div><div class="t m0 x32 h49 y5836 ff19 fs26 fc0 sc0 ls0 ws0">[713 <span class="_ _a"></span>– <span class="_ _a"></span>719]<span class="_ _65"> </span>Once <span class="_ _53"> </span>we <span class="_ _53"> </span>ar<span class="ls16bf">ed<span class="_ _c"></span><span class="ls0">one <span class="_ _53"> </span>with <span class="_ _53"> </span>the <span class="_ _e"> </span>free <span class="_ _53"> </span>list, <span class="_ _53"> </span>we <span class="_ _53"> </span>release <span class="_ _53"> </span>the <span class="_ _e"> </span>write <span class="_ _53"> </span>lock.<span class="_ _65"> </span>Then <span class="_ _e"> </span>we</span></span></div><div class="t m0 x11a h49 y5837 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turn the status to the caller<span class="_ _1"></span>.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
