<div id="pf35a" class="pf w4 h1f" data-page-no="35a"><div class="pc pc35a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg35a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">824<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">352 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">353 <span class="_ _68"> </span>*<span class="_"> </span>Accept a print job from a client.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">354 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">355 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">356 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">357 <span class="_ _d9"> </span>void<span class="_"> </span>*</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">358 <span class="_ _d9"> </span>client_thread(void<span class="_"> </span>*arg)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">359 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">360 <span class="_ _15"> </span>int<span class="_ _ce"> </span>n, fd, sockfd, nr, nw, first;</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">361 <span class="_ _15"> </span>int32_t<span class="_ _166"> </span>jobid;</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">362 <span class="_ _15"> </span>pthread_t<span class="_ _bd"> </span>tid;</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">363 <span class="_ _15"> </span>struct<span class="_"> </span>printreq <span class="_ _15"> </span>req;</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">364 <span class="_ _15"> </span>struct<span class="_"> </span>printresp <span class="_ _68"> </span>res;</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">365 <span class="_ _15"> </span>char<span class="_ _1e7"> </span>name[FILENMSZ];</div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">366 <span class="_ _15"> </span>char<span class="_ _1e7"> </span>buf[IOBUFSZ];</div><div class="t m0 x32 h57 y1fc1 ff1a fs2d fc0 sc0 ls0 ws0">367 <span class="_ _15"> </span>tid<span class="_"> </span><span class="ls15c">=p<span class="_ _1d"></span><span class="ls0">thread_self();</span></span></div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">368 <span class="_ _15"> </span>pthread_cleanup_push(client_cleanup,<span class="_"> </span>(void *)((long)tid));</div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">369 <span class="_ _15"> </span>sockfd<span class="_"> </span><span class="ls15c">=(<span class="_ _1d"></span><span class="ls0">long)arg;</span></span></div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">370 <span class="_ _15"> </span>add_worker(tid,<span class="_"> </span>sockfd);</div><div class="t m0 x32 h57 y458b ff1a fs2d fc0 sc0 ls0 ws0">371 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y458c ff1a fs2d fc0 sc0 ls0 ws0">372 <span class="_ _8a"> </span>*<span class="_"> </span>Read the request header.</div><div class="t m0 x32 h57 y2ada ff1a fs2d fc0 sc0 ls0 ws0">373 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2adb ff1a fs2d fc0 sc0 ls0 ws0">374 <span class="_ _15"> </span>if<span class="_"> </span>((n = treadn(sockfd, &amp;req, sizeof(struct printreq), 10)) !=</div><div class="t m0 x32 h57 y2adc ff1a fs2d fc0 sc0 ls0 ws0">375 <span class="_ _189"> </span>sizeof(struct<span class="_"> </span>printreq)) {</div><div class="t m0 x32 h57 y2add ff1a fs2d fc0 sc0 ls0 ws0">376 <span class="_ _186"> </span>res.jobid<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y2ade ff1a fs2d fc0 sc0 ls0 ws0">377 <span class="_ _186"> </span>if<span class="_"> </span>(n &lt; 0)</div><div class="t m0 x32 h57 y2c66 ff1a fs2d fc0 sc0 ls0 ws0">378 <span class="_ _82"> </span>res.retcode<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(errno);</span></span></div><div class="t m0 x32 h57 y2c67 ff1a fs2d fc0 sc0 ls0 ws0">379 <span class="_ _186"> </span>else</div><div class="t m0 x32 h57 y573f ff1a fs2d fc0 sc0 ls0 ws0">380 <span class="_ _82"> </span>res.retcode<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(EIO);</span></span></div><div class="t m0 x32 h57 y57b5 ff1a fs2d fc0 sc0 ls0 ws0">381 <span class="_ _186"> </span>strncpy(res.msg,<span class="_"> </span>strerror(res.retcode), MSGLEN_MAX);</div><div class="t m0 x32 h57 y57b6 ff1a fs2d fc0 sc0 ls0 ws0">382 <span class="_ _186"> </span>writen(sockfd,<span class="_"> </span>&amp;res, sizeof(struct printresp));</div><div class="t m0 x32 h57 y57b7 ff1a fs2d fc0 sc0 ls0 ws0">383 <span class="_ _186"> </span>pthread_exit((void<span class="_"> </span>*)1);</div><div class="t m0 x32 h57 y57b8 ff1a fs2d fc0 sc0 ls0 ws0">384 <span class="_ _15"> </span>}</div><div class="t m0 x32 h4d y57f5 ff19 fs26 fc0 sc0 ls0 ws0">[352 <span class="_ _a"></span>– <span class="_ _a"></span>370]<span class="_ _65"> </span>The<span class="_ _4b"> </span><span class="ff1a">client_thread<span class="_ _59"> </span></span>is <span class="_ _53"> </span>spawned <span class="_"> </span>fr<span class="_ _0"></span>om <span class="_ _e"> </span>the<span class="_ _4b"> </span><span class="ff1a">main<span class="_ _59"> </span></span>thread <span class="_ _53"> </span>when <span class="_ _e"> </span>a <span class="_ _e"> </span>connect</div><div class="t m0 x11a h49 y57f6 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">quest <span class="_ _3"></span>is <span class="_ _9"></span>accepted.<span class="_ _16"> </span>Its <span class="_ _3"></span>job <span class="_ _3"></span>is <span class="_ _3"></span>to <span class="_ _9"></span>receive <span class="_ _2"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>to <span class="_ _9"></span>be <span class="_ _3"></span>printed <span class="_ _3"></span>from <span class="_ _3"></span>the <span class="_ _3"></span>client</span></div><div class="t m0 x11a h4d y57f7 ff1a fs26 fc0 sc0 ls0 ws0">print<span class="_ _80"> </span><span class="ff19">command. <span class="_"> </span>W<span class="_ _6"></span><span class="lsd3">ec<span class="_ _5"></span><span class="lscc">re<span class="ls0">ate a separate thread for each client print r<span class="_ _0"></span>equest.</span></span></span></span></div><div class="t m0 x11a h49 y5bfc ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _2"></span>ﬁrst <span class="_ _3"></span>thing <span class="_ _3"></span>we <span class="_ _3"></span>do <span class="_ _2"></span>is <span class="_ _3"></span>install <span class="_ _3"></span>a <span class="_ _3"></span>thread <span class="_ _2"></span>cleanup <span class="_ _3"></span>handler <span class="_ _2"></span>(see <span class="_ _3"></span>Section <span class="_ _3"></span>1<span class="_ _1"></span>1.5 <span class="_ _3"></span>for</div><div class="t m0 x11a h49 y5bfd ff19 fs26 fc0 sc0 ls17a4 ws0">ad<span class="_ _95"></span><span class="ls0">iscussion <span class="_ _5a"> </span>of <span class="_ _5a"> </span>thread <span class="_ _5a"> </span>cleanup <span class="_ _5a"> </span>handlers).<span class="_ _3a"> </span>The <span class="_ _5a"> </span>cleanup <span class="_ _5a"> </span>handler <span class="_ _5a"> </span>is</span></div><div class="t m0 x11a h4d y5bfe ff1a fs26 fc0 sc0 ls0 ws0">client_cleanup<span class="ff19 ls3a7">,w<span class="_ _b"></span><span class="ls0">hich <span class="_ _9"></span>we <span class="_ _9"></span>will <span class="_ _9"></span>see <span class="_ _9"></span>later<span class="_ _6"></span><span class="ls17a5">.I<span class="_ _62"></span><span class="ls3a7">tt<span class="_ _8"></span><span class="ls0">akes <span class="_ _9"></span>a <span class="_ _3"></span>single <span class="_ _9"></span>argument: <span class="_ _9"></span>our</span></span></span></span></span></div><div class="t m0 x11a h4d y5bff ff19 fs26 fc0 sc0 ls0 ws0">thread ID.<span class="_ _46"> </span>Then <span class="_ _2"></span>we call<span class="_ _66"> </span><span class="ff1a">add_worker<span class="_ _66"> </span></span>to <span class="_ _2"></span>create a<span class="_ _66"> </span><span class="ff1a">worker_thread<span class="_ _66"> </span></span>structure</div><div class="t m0 x11a h49 y5c00 ff19 fs26 fc0 sc0 ls0 ws0">and add it to the list of active client threads.</div><div class="t m0 x32 h49 y5c01 ff19 fs26 fc0 sc0 ls0 ws0">[371 <span class="_ _a"></span>– <span class="_ _a"></span>384]<span class="_ _65"> </span>At <span class="_ _9"></span>this <span class="_ _9"></span>point, <span class="_ _23"></span>we <span class="_ _9"></span>ar<span class="ls17a6">ed<span class="_ _b"></span><span class="ls0">one <span class="_ _3"></span>with <span class="_ _23"></span>the <span class="_ _9"></span>thread’s <span class="_ _3"></span>initialization <span class="_ _23"></span>tasks, <span class="_ _9"></span>so <span class="_ _9"></span>we <span class="_ _23"></span>r<span class="_ _0"></span>ead</span></span></div><div class="t m0 x11a h49 y5c02 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _e"> </span>request <span class="_ _53"> </span>header <span class="_"> </span>fr<span class="_ _0"></span>om <span class="_ _e"> </span>the <span class="_ _e"> </span>client.<span class="_ _48"> </span>If <span class="_"> </span>the <span class="_ _53"> </span>client <span class="_"> </span>sends <span class="_ _53"> </span>less <span class="_"> </span>data <span class="_ _53"> </span>than <span class="_ _e"> </span>we</div><div class="t m0 x11a h49 y5c03 ff19 fs26 fc0 sc0 ls0 ws0">expect <span class="_ _9"></span>or <span class="_ _3"></span>we <span class="_ _9"></span>encounter <span class="_ _9"></span>an <span class="_ _9"></span>error<span class="_ _6"></span>,<span class="_ _45"> </span>we<span class="_ _47"> </span>respond <span class="_ _9"></span>with <span class="_ _9"></span>a <span class="_ _3"></span>message <span class="_ _9"></span>indicating <span class="_ _9"></span>the</div><div class="t m0 x11a h4d y5c04 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ason for the error and call<span class="_"> </span><span class="ff1a">pthread_exit<span class="_ _80"> </span></span>to terminate the thread.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
