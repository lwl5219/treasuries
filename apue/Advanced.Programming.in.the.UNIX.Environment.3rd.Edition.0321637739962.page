<div id="pf3c2" class="pf w4 h1f" data-page-no="3c2"><div class="pc pc3c2 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg3c2.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">928<span class="_ _1b"> </span><span class="ff19">Solutions <span class="_"> </span>to <span class="_"> </span>Selected <span class="_"> </span>Exercises <span class="_ _2eb"> </span>Appendix<span class="_ _4b"> </span>C</span></div><div class="t m0 xe2 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _2"></span>we <span class="_ _3"></span>don’t <span class="_ _3"></span>know <span class="_ _3"></span>whether <span class="_ _2"></span>any <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>functions <span class="_ _3"></span>we <span class="_ _3"></span>call <span class="_ _3"></span>might <span class="_ _2"></span>unmask <span class="_ _3"></span>a <span class="_ _3"></span>signal</div><div class="t m0 xe2 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _23"></span>we’ve <span class="_ _23"></span>blocked, <span class="_ _23"></span>thereby <span class="_ _9"></span>making <span class="_ _23"> </span>it <span class="_ _23"> </span>possible <span class="_ _23"> </span>for <span class="_ _23"> </span>the <span class="_ _23"> </span>function <span class="_ _23"> </span>to <span class="_ _23"> </span>be <span class="_ _23"> </span>reenter<span class="_ _0"></span>ed</div><div class="t m0 xe2 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">through another signal handler<span class="_ _6"></span>.</div><div class="t m0 x32 h26 y114e ff18 fsf fc0 sc0 ls0 ws0">12.4<span class="_ _210"> </span><span class="ff19">On <span class="_ _23"></span>Fr<span class="_ _0"></span>eeBSD <span class="_ _9"></span>8.0, <span class="_ _9"></span>the <span class="_ _9"></span>program <span class="_ _9"></span>drops <span class="_ _3"></span>core. <span class="_ _45"> </span>W<span class="_ _1"></span>ith<span class="_ _45"> </span><span class="ff1a">gdb</span>,<span class="_ _45"> </span>we<span class="_ _45"> </span>a<span class="ls45">re <span class="_ _23"></span>a</span>ble <span class="_ _9"></span>to <span class="_ _9"></span>see <span class="_ _9"></span>that <span class="_ _9"></span>the</span></div><div class="t m0 xe2 h26 y2936 ff19 fsf fc0 sc0 ls0 ws0">program <span class="_ _e"> </span>initialization <span class="_"> </span>calls <span class="_ _53"> </span>pthread <span class="_"> </span>functions, <span class="_ _53"> </span>which <span class="_"> </span>call<span class="_ _4b"> </span><span class="ff1a">getenv<span class="_ _59"> </span></span>to <span class="_"> </span>ﬁnd <span class="_ _e"> </span>the</div><div class="t m0 xe2 h26 y2914 ff19 fsf fc0 sc0 ls0 ws0">value <span class="_ _48"> </span>of <span class="_ _60"> </span>the<span class="_ _5e"> </span><span class="ff1a">LIBPTHREAD_SPINLOOPS<span class="_ _7f"> </span></span>and<span class="_ _5e"> </span><span class="ff1a">LIBPTHREAD_YIELDLOOPS</span></div><div class="t m0 xe2 h26 y2915 ff19 fsf fc0 sc0 ls0 ws0">environment <span class="_ _9"></span>variables.<span class="_ _5a"> </span>However<span class="_ _1"></span><span class="ls92a">,o<span class="_ _b"></span><span class="ls0">ur <span class="_ _9"></span>thread-safe <span class="_ _9"></span>version <span class="_ _23"></span>of<span class="_ _45"> </span><span class="ff1a">getenv<span class="_ _35"> </span></span>calls <span class="_ _9"></span>back</span></span></div><div class="t m0 xe2 h2a y2937 ff19 fsf fc0 sc0 ls0 ws0">into <span class="_"> </span>the <span class="_"> </span>pthr<span class="_ _0"></span>ead <span class="_"> </span>library <span class="_"> </span>while <span class="_"> </span>it <span class="_ _e"> </span>is <span class="_"> </span>in <span class="_"> </span>an <span class="_"> </span>intermediate, <span class="_"> </span>inconsistent <span class="_"> </span>state.<span class="_ _48"> </span>In</div><div class="t m0 xe2 h26 y2938 ff19 fsf fc0 sc0 ls0 ws0">addition, <span class="_"> </span>the <span class="_"> </span>thread <span class="_"> </span>initialization <span class="_"> </span>functions <span class="_"> </span>call<span class="_ _59"> </span><span class="ff1a">malloc</span><span class="ls4ab">,w<span class="_ _4a"></span><span class="ls0">hich, <span class="_"> </span>in <span class="_"> </span>turn, <span class="_"> </span>call</span></span></div><div class="t m0 xe2 h26 yeb6 ff1a fsf fc0 sc0 ls0 ws0">getenv<span class="_ _80"> </span><span class="ff19">to ﬁnd the value of the<span class="_"> </span></span>MALLOC_OPTIONS<span class="_ _66"> </span><span class="ff19">environment variable.</span></div><div class="t m0 xe2 h2a y323 ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _44"> </span>g<span class="_ _9"></span><span class="ls0">et <span class="_"> </span>around <span class="_"> </span>this <span class="_"> </span>pr<span class="_ _1"></span>oblem, <span class="_"> </span>we <span class="_"> </span>could <span class="_"> </span>make <span class="_"> </span>the <span class="_"> </span>r<span class="_ _0"></span>easonable <span class="_"> </span>assumption <span class="_"> </span>that</span></div><div class="t m0 xe2 h2a y324 ff19 fsf fc0 sc0 ls0 ws0">program start-up is single threaded, and use a ﬂag to indicate whether the <span class="_ _2"></span>thread</div><div class="t m0 xe2 h26 y325 ff19 fsf fc0 sc0 ls0 ws0">initialization <span class="_ _23"></span>had <span class="_ _9"></span>been <span class="_ _23"> </span>completed <span class="_ _23"></span>by <span class="_ _9"></span>our <span class="_ _23"> </span>version <span class="_ _23"></span>of<span class="_ _35"> </span><span class="ff1a">getenv</span><span class="ls1855">.W<span class="_ _7"></span><span class="ls0">hile <span class="_ _23"></span>this <span class="_ _23"></span>ﬂag <span class="_ _9"></span>is</span></span></div><div class="t m0 xe2 h26 y326 ff19 fsf fc0 sc0 ls0 ws0">false, <span class="_ _3"></span>our <span class="_ _3"></span>version <span class="_ _3"></span>of<span class="_ _45"> </span><span class="ff1a">getenv<span class="_ _47"> </span></span>can <span class="_ _3"></span>operate <span class="_ _3"></span>as <span class="_ _9"></span>the <span class="_ _3"></span>non-reentrant <span class="_ _3"></span>version <span class="_ _3"></span>does <span class="_ _3"></span>(and</div><div class="t m0 xe2 h26 y327 ff19 fsf fc0 sc0 ls0 ws0">avoid <span class="_"> </span>all <span class="_ _e"> </span>calls <span class="_"> </span>to <span class="_ _e"> </span>pthread <span class="_ _e"> </span>functions <span class="_"> </span>and<span class="_ _4b"> </span><span class="ff1a">malloc</span>). <span class="_ _46"> </span>Then<span class="_ _59"> </span>we <span class="_"> </span>could <span class="_ _e"> </span>provide <span class="_ _e"> </span>a</div><div class="t m0 xe2 h26 y206 ff19 fsf fc0 sc0 ls0 ws0">separate <span class="_ _3"></span>initialization <span class="_ _9"></span>function <span class="_ _9"></span>to <span class="_ _9"></span>call<span class="_ _45"> </span><span class="ff1a">pthread_once</span><span class="ls1856">,i<span class="_ _b"></span><span class="ls0">nstead <span class="_ _9"></span>of <span class="_ _3"></span>calling <span class="_ _9"></span>it <span class="_ _9"></span>from</span></span></div><div class="t m0 xe2 h26 y1f12 ff19 fsf fc0 sc0 ls0 ws0">inside<span class="_ _44"> </span><span class="ff1a">getenv</span><span class="ls1857">.T<span class="_ _52"></span><span class="ls0">his <span class="_ _53"> </span>requir<span class="_ _0"></span>es <span class="_ _42"> </span>that <span class="_ _53"> </span>the <span class="_ _53"> </span>program <span class="_ _42"> </span>call <span class="_ _53"> </span>our <span class="_ _53"> </span>initialization <span class="_ _53"> </span>function</span></span></div><div class="t m0 xe2 h26 y1f79 ff19 fsf fc0 sc0 ls0 ws0">befor<span class="ls6a8">ec<span class="_ _8"></span><span class="ls0">alling<span class="_ _47"> </span><span class="ff1a">getenv</span><span class="ls1858">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _3"></span>solves <span class="_ _2"></span>our <span class="_ _2"></span>problem, because <span class="_ _3"></span>this <span class="_ _2"></span>can’t <span class="_ _2"></span>be <span class="_ _2"></span>done <span class="_ _2"></span>until</span></span></span></span></div><div class="t m0 xe2 h2a y1f7a ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _35"> </span>pr<span class="_ _0"></span>ogram <span class="_ _45"> </span>start-up <span class="_ _35"> </span>initialization <span class="_ _35"> </span>completes.<span class="_ _5c"> </span>After <span class="_ _35"> </span>the <span class="_ _45"> </span>program <span class="_ _45"> </span>calls <span class="_ _35"> </span>our</div><div class="t m0 xe2 h26 y1f7b ff19 fsf fc0 sc0 ls0 ws0">initialization function, our version of<span class="_"> </span><span class="ff1a">getenv<span class="_ _80"> </span></span>operates in a thread-safe manner<span class="_ _6"></span>.</div><div class="t m0 x32 h26 y28ba ff18 fsf fc0 sc0 ls0 ws0">12.5<span class="_ _210"> </span><span class="ff19 ls5f">We <span class="_ _47"> </span>s<span class="_ _23"></span><span class="ls0">till <span class="_ _9"></span>need<span class="_ _35"> </span><span class="ff1a">fork<span class="_ _35"> </span></span>if <span class="_ _9"></span>we <span class="_ _23"> </span>want <span class="_ _23"></span>to <span class="_ _23"></span>run <span class="_ _9"></span>a <span class="_ _23"> </span>program <span class="_ _9"></span>from <span class="_ _23"></span>within <span class="_ _23"></span>another <span class="_ _9"></span>program</span></span></div><div class="t m0 xe2 h26 y28bb ff19 fsf fc0 sc0 ls0 ws0">(i.e., befor<span class="ls44">ec<span class="_ _4f"></span><span class="ls0">alling<span class="_"> </span><span class="ff1a">exec</span>).</span></span></div><div class="t m0 x32 h26 y4fb1 ff18 fsf fc0 sc0 ls0 ws0">12.6<span class="_ _210"> </span><span class="ff19">Figur<span class="ls31d">eC<span class="_ _55"></span><span class="ls0">.13 <span class="_ _e"> </span>shows <span class="_"> </span>a <span class="_ _53"> </span>thread-safe<span class="_ _4b"> </span><span class="ff1a">sleep<span class="_ _59"> </span></span>implementation <span class="_ _e"> </span>that <span class="_"> </span>uses<span class="_ _4b"> </span><span class="ff1a">select<span class="_ _4b"> </span></span>to</span></span></span></div><div class="t m0 xe2 h2a yea7 ff19 fsf fc0 sc0 ls0 ws0">delay <span class="_ _23"> </span>for <span class="_ _23"> </span>the <span class="_ _42"> </span>speciﬁed <span class="_ _23"></span>amount <span class="_ _23"> </span>of <span class="_ _23"> </span>time.<span class="_ _51"> </span>It <span class="_ _42"> </span>is <span class="_ _23"> </span>thread-safe <span class="_ _23"></span>because <span class="_ _23"> </span>it <span class="_ _23"> </span>doesn’t <span class="_ _42"> </span>use</div><div class="t m0 xe2 h2a yea8 ff19 fsf fc0 sc0 ls0 ws0">any unprotected global or static data and calls only other thr<span class="_ _0"></span>ead-safe functions.</div><div class="t m0 x32 h2a y61ad ff18 fsf fc0 sc0 ls0 ws0">12.7<span class="_ _210"> </span><span class="ff19">The <span class="_ _23"></span>implementation <span class="_ _9"></span>of <span class="_ _23"></span>a <span class="_ _9"></span>condition <span class="_ _9"></span>variable <span class="_ _23"></span>most <span class="_ _9"></span>likely <span class="_ _23"></span>uses <span class="_ _9"></span>a <span class="_ _9"></span>mutex <span class="_ _23"></span>to <span class="_ _9"></span>protect</span></div><div class="t m0 xe2 h2a y5073 ff19 fsf fc0 sc0 ls0 ws0">its <span class="_"> </span>internal <span class="_ _e"> </span>structure. <span class="_ _4b"> </span>Because<span class="_ _59"> </span>this <span class="_"> </span>is <span class="_ _e"> </span>an <span class="_"> </span>implementation <span class="_ _e"> </span>detail <span class="_"> </span>and <span class="_ _e"> </span>therefore</div><div class="t m0 xe2 h2a y5074 ff19 fsf fc0 sc0 ls0 ws0">hidden, there<span class="_ _66"> </span>is<span class="_ _47"> </span>no<span class="_"> </span>portable <span class="_ _2"></span>way <span class="_ _2"></span>for <span class="_ _2"></span>us <span class="_ _2"></span>to <span class="_ _2"></span>acquir<span class="ls1c5">ea<span class="_ _4f"></span><span class="ls0">nd <span class="_ _2"></span>release the <span class="_ _2"></span>lock <span class="_ _2"></span>in <span class="_ _2"></span>the <span class="_ _2"></span>fork</span></span></div><div class="t m0 xe2 h2a y5075 ff19 fsf fc0 sc0 ls0 ws0">handlers. <span class="_ _45"> </span>Since<span class="_ _35"> </span>we <span class="_ _23"></span>can’t <span class="_ _9"></span>determine <span class="_ _23"> </span>the <span class="_ _23"></span>state <span class="_ _23"></span>of <span class="_ _9"></span>the <span class="_ _23"> </span>internal <span class="_ _23"></span>lock <span class="_ _23"></span>in <span class="_ _9"></span>a <span class="_ _23"> </span>condition</div><div class="t m0 xe2 h26 y5076 ff19 fsf fc0 sc0 ls0 ws0">variable <span class="_ _2"></span>after <span class="_ _3"></span>calling<span class="_ _47"> </span><span class="ff1a">fork</span>,<span class="_ _66"> </span>it<span class="_ _47"> </span>is<span class="_ _47"> </span>unsafe <span class="_ _2"></span>for <span class="_ _3"></span>us <span class="_ _2"></span>to <span class="_ _3"></span>use <span class="_ _2"></span>the <span class="_ _3"></span>condition <span class="_ _2"></span>variable <span class="_ _3"></span>in <span class="_ _2"></span>the</div><div class="t m0 xe2 h2a y5077 ff19 fsf fc0 sc0 ls0 ws0">child process.</div><div class="t m0 x35 h27 y61ae ff16 fsf fc0 sc0 ls0 ws0">Chapter <span class="_"> </span>13</div><div class="t m0 x32 h26 y61af ff18 fsf fc0 sc0 ls0 ws0">13.1<span class="_ _210"> </span><span class="ff19">If it calls<span class="_ _66"> </span><span class="ff1a">chroot</span><span class="ls1354">,t<span class="_ _d"></span><span class="ls0">he process will not be able to open<span class="_"> </span><span class="ff1a">/dev/log</span><span class="ls1307">.T<span class="_ _4a"></span><span class="ls0">he solution is</span></span></span></span></span></div><div class="t m0 xe2 h26 y61b0 ff19 fsf fc0 sc0 ls0 ws0">for <span class="_ _23"> </span>the <span class="_ _23"> </span>daemon <span class="_ _42"> </span>to <span class="_ _23"></span>call<span class="_ _35"> </span><span class="ff1a">openlog<span class="_ _35"> </span></span>with <span class="_ _23"> </span>an<span class="_ _35"> </span><span class="ff1b">option<span class="_ _35"> </span></span>of<span class="_ _35"> </span><span class="ff1a">LOG_NDELAY</span><span class="ls1859">,b<span class="_ _43"></span><span class="ls0">efor<span class="ls1859">ec<span class="_ _43"></span><span class="ls0">alling</span></span></span></span></div><div class="t m0 xe2 h26 y61b1 ff1a fsf fc0 sc0 ls0 ws0">chroot<span class="ff19 ls3e3">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _3"></span>opens <span class="_ _2"></span>the <span class="_ _3"></span>special <span class="_ _3"></span>device <span class="_ _3"></span>ﬁle <span class="_ _2"></span>(the <span class="_ _3"></span>UNIX <span class="_ _3"></span>domain <span class="_ _3"></span>datagram <span class="_ _2"></span>socket),</span></span></div><div class="t m0 xe2 h26 y180c ff19 fsf fc0 sc0 ls0 ws0">yielding <span class="_ _2"></span>a <span class="_ _2"></span>descriptor <span class="_ _2"></span>that <span class="_ _3"></span>is <span class="_ _2"></span>still <span class="_ _2"></span>valid, <span class="_ _3"></span>even <span class="_ _2"></span>after <span class="_ _2"></span>a <span class="_ _2"></span>call <span class="_ _3"></span>to<span class="_ _47"> </span><span class="ff1a">chroot</span><span class="ls185a">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _2"></span>scenario</span></span></div><div class="t m0 xe2 h26 y61b2 ff19 fsf fc0 sc0 ls0 ws0">is <span class="_ _42"> </span>encounter<span class="_ _0"></span>ed <span class="_ _42"> </span>in <span class="_ _23"> </span>daemons, <span class="_ _42"> </span>such <span class="_ _42"> </span>as<span class="_ _35"> </span><span class="ff1a">ftpd<span class="_ _44"> </span></span>(the <span class="_ _42"> </span>File <span class="_ _23"> </span>T<span class="_ _6"></span>ransfer <span class="_ _42"> </span>Protocol <span class="_ _23"> </span>daemon),</div><div class="t m0 xe2 h26 y507d ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _2"></span>speciﬁcally <span class="_ _3"></span>call<span class="_ _47"> </span><span class="ff1a">chroot<span class="_ _47"> </span></span>for <span class="_ _3"></span>security <span class="_ _3"></span>reasons <span class="_ _2"></span>but <span class="_ _3"></span>still <span class="_ _3"></span>need <span class="_ _3"></span>to <span class="_ _3"></span>call<span class="_ _47"> </span><span class="ff1a">syslog<span class="_ _47"> </span></span>to</div><div class="t m0 xe2 h2a y507e ff19 fsf fc0 sc0 ls0 ws0">log error conditions.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
