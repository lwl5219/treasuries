<div id="pf22d" class="pf w4 h1f" data-page-no="22d"><div class="pc pc22d w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg22d.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.7<span class="_ _2ae"> </span><span class="ff1a">readn<span class="_ _4b"> </span></span>and<span class="_ _4b"> </span><span class="ff1a">writen<span class="_ _4b"> </span></span>Functions<span class="_ _1b"> </span><span class="ff18">523</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _47"> </span>summary<span class="_ _4"></span><span class="ls55b">,w<span class="_ _1d"></span><span class="ls10dd">es<span class="_ _5b"></span><span class="ls0">hould <span class="_ _47"> </span>always <span class="_ _47"> </span>try <span class="_ _47"> </span>to <span class="_ _66"> </span>use <span class="_ _47"> </span>the <span class="_ _47"> </span>fewest <span class="_ _47"> </span>number <span class="_ _47"> </span>of <span class="_ _47"> </span>system <span class="_ _47"> </span>calls</span></span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">necessary <span class="_ _9"></span>to <span class="_ _9"></span>get <span class="_ _9"></span>the <span class="_ _9"></span>job <span class="_ _9"></span>done.<span class="_ _5a"> </span>If <span class="_ _9"></span>we <span class="_ _9"></span>ar<span class="lsb70">ew<span class="_ _b"></span><span class="ls0">riting <span class="_ _3"></span>small <span class="_ _9"></span>amounts <span class="_ _9"></span>of <span class="_ _9"></span>data, <span class="_ _9"></span>we <span class="_ _9"></span>will <span class="_ _9"></span>ﬁnd <span class="_ _9"></span>it</span></span></div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 ls0 ws0">less <span class="_ _e"> </span>expensive <span class="_"> </span>to <span class="_ _53"> </span>copy <span class="_"> </span>the <span class="_ _53"> </span>data <span class="_"> </span>ourselves <span class="_ _e"> </span>and <span class="_ _e"> </span>use <span class="_"> </span>a <span class="_ _53"> </span>single<span class="_ _59"> </span><span class="ff1a">write<span class="_ _59"> </span></span>instead <span class="_ _e"> </span>of <span class="_"> </span>using</div><div class="t m0 x32 h26 y132 ff1a fsf fc0 sc0 ls0 ws0">writev<span class="ff19 ls10de">.W<span class="_ _52"></span><span class="ls1045">em<span class="_ _8"></span><span class="ls0">ight <span class="_ _9"></span>ﬁnd, <span class="_ _3"></span>however<span class="_ _6"></span><span class="ls10df">,t<span class="_ _8"></span><span class="ls0">hat <span class="_ _9"></span>the <span class="_ _3"></span>performance <span class="_ _3"></span>beneﬁts <span class="_ _3"></span>aren’t <span class="_ _3"></span>worth <span class="_ _3"></span>the <span class="_ _9"></span>extra</span></span></span></span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">complexity cost needed to manage our own staging buffers.</div><div class="t m0 x35 h75 y6d4 ff16 fs2b fc0 sc0 ls0 ws0">14.7<span class="_ _6d"> </span><span class="ff1f">readn<span class="_ _54"> </span></span>and<span class="_ _54"> </span><span class="ff1f">writen<span class="_ _54"> </span></span>Functions</div><div class="t m0 x32 h2a y2b49 ff19 fsf fc0 sc0 ls0 ws0">Pipes, <span class="_ _2"></span>FIFOs, <span class="_ _3"></span>and <span class="_ _3"></span>some <span class="_ _2"></span>devices<span class="_ _9"></span><span class="ls9d">—n<span class="_ _1"></span><span class="ls0">otably <span class="_ _2"></span>terminals <span class="_ _3"></span>and <span class="_ _2"></span>networks<span class="_ _9"></span><span class="ls9d">—h<span class="_ _1"></span><span class="ls0">ave <span class="_ _2"></span>the <span class="_ _3"></span>following</span></span></span></span></div><div class="t m0 x32 h2a y3ff1 ff19 fsf fc0 sc0 ls0 ws0">two properties.</div><div class="t m0 x3f h26 y3ff2 ff19 fsf fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>A<span class="_ _44"> </span><span class="ff1a">read<span class="_ _4b"> </span></span>operation <span class="_ _53"> </span>may <span class="_ _53"> </span>return <span class="_ _42"> </span>less <span class="_ _53"> </span>than <span class="_ _53"> </span>asked <span class="_ _53"> </span>for<span class="_ _1"></span><span class="ls10e0">,e<span class="_ _c"></span><span class="ls0">ven <span class="_ _53"> </span>though <span class="_ _53"> </span>we <span class="_ _53"> </span>have <span class="_ _53"> </span>not</span></span></div><div class="t m0 x41 h2a y3ff3 ff19 fsf fc0 sc0 ls0 ws0">encountered the end <span class="_ _2"></span>of <span class="_ _2"></span>ﬁle.<span class="_ _46"> </span>This <span class="_ _2"></span>is not <span class="_ _2"></span>an <span class="_ _2"></span>error<span class="_ _6"></span><span class="ls80a">,a<span class="_ _d"></span><span class="ls0">nd we <span class="_ _2"></span>should <span class="_ _2"></span>simply continue</span></span></div><div class="t m0 x41 h2a y3ff4 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ading from the device.</span></div><div class="t m0 x3f h26 y3ff5 ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>A<span class="_ _35"> </span><span class="ff1a">write<span class="_ _35"> </span></span>operation <span class="_ _23"></span>can <span class="_ _23"></span>r<span class="_ _0"></span>eturn <span class="_ _23"></span>less <span class="_ _23"></span>than <span class="_ _23"> </span>we <span class="_ _23"> </span>speciﬁed.<span class="_ _51"> </span>This <span class="_ _23"> </span>may <span class="_ _23"> </span>be <span class="_ _23"> </span>caused <span class="_ _23"> </span>by</div><div class="t m0 x41 h2a y3ff6 ff19 fsf fc0 sc0 ls0 ws0">kernel <span class="_ _9"></span>output <span class="_ _23"></span>buf<span class="_ _0"></span>fers <span class="_ _9"></span>becoming <span class="_ _23"></span>full, <span class="_ _9"></span>for <span class="_ _9"></span>example.<span class="_ _51"> </span>Again, <span class="_ _9"></span>it’s <span class="_ _23"></span>not <span class="_ _9"></span>an <span class="_ _9"></span>error<span class="_ _6"></span><span class="lsee6">,a<span class="_ _b"></span><span class="ls0">nd</span></span></div><div class="t m0 x41 h2a y3ff7 ff19 fsf fc0 sc0 ls0 ws0">we <span class="_ _53"> </span>should <span class="_ _42"> </span>continue <span class="_ _53"> </span>writing <span class="_ _53"> </span>the <span class="_ _53"> </span>remainder <span class="_ _53"> </span>of <span class="_ _42"> </span>the <span class="_ _53"> </span>data.<span class="_ _65"> </span>(Normally<span class="_ _6"></span><span class="ls10e1">,t<span class="_ _c"></span><span class="ls0">his <span class="_ _53"> </span>short</span></span></div><div class="t m0 x41 h26 y3ff8 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">turn <span class="_ _9"></span>from <span class="_ _2"></span>a<span class="_ _47"> </span><span class="ff1a">write<span class="_ _45"> </span></span>occurs <span class="_ _2"></span>only <span class="_ _9"></span>with <span class="_ _3"></span>a <span class="_ _3"></span>nonblocking <span class="_ _3"></span>descriptor <span class="_ _9"></span>or <span class="_ _3"></span>if <span class="_ _3"></span>a <span class="_ _3"></span>signal <span class="_ _9"></span>is</span></div><div class="t m0 x41 h2a y3ff9 ff19 fsf fc0 sc0 ls0 ws0">caught.)</div><div class="t m0 x32 h2a y3ffa ff19 fsf fc0 sc0 ls5f ws0">We<span class="_ _9"></span><span class="ls0">’ll <span class="_ _23"> </span>never <span class="_ _42"> </span>see <span class="_ _23"> </span>this <span class="_ _23"> </span>happen <span class="_ _42"> </span>when <span class="_ _23"> </span>reading <span class="_ _23"></span>or <span class="_ _23"> </span>writing <span class="_ _42"> </span>a <span class="_ _23"></span>disk <span class="_ _23"> </span>ﬁle, <span class="_ _42"> </span>except <span class="_ _23"></span>when <span class="_ _23"> </span>the <span class="_ _42"> </span>ﬁle</span></div><div class="t m0 x32 h2a y3ffb ff19 fsf fc0 sc0 ls0 ws0">system <span class="_ _e"> </span>runs <span class="_ _e"> </span>out <span class="_"> </span>of <span class="_ _53"> </span>space <span class="_"> </span>or <span class="_ _53"> </span>we <span class="_"> </span>hit <span class="_ _53"> </span>our <span class="_ _e"> </span>quota <span class="_"> </span>limit <span class="_ _53"> </span>and <span class="_"> </span>we <span class="_ _53"> </span>can’t <span class="_"> </span>write <span class="_ _53"> </span>all <span class="_"> </span>that <span class="_ _53"> </span>we</div><div class="t m0 x32 h2a y3ffc ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">quested.</span></div><div class="t m0 x3f h2a y3ffd ff19 fsf fc0 sc0 ls0 ws0">Generally<span class="_ _4"></span><span class="ls249">,w<span class="_ _b"></span><span class="ls0">hen <span class="_ _9"></span>we <span class="_ _23"></span>read <span class="_ _9"></span>from <span class="_ _9"></span>or <span class="_ _9"></span>write <span class="_ _23"></span>to <span class="_ _9"></span>a <span class="_ _9"></span>pipe, <span class="_ _23"></span>network <span class="_ _9"></span>device, <span class="_ _23"></span>or <span class="_ _9"></span>terminal, <span class="_ _23"></span>we</span></span></div><div class="t m0 x32 h26 y3ffe ff19 fsf fc0 sc0 ls0 ws0">need <span class="_ _47"> </span>to <span class="_ _45"> </span>take <span class="_ _47"> </span>these <span class="_ _45"> </span>characteristics <span class="_ _47"> </span>into <span class="_ _45"> </span>consideration.<span class="_ _50"> </span><span class="ls5f">We <span class="_ _46"> </span>c<span class="_ _23"></span></span>an <span class="_ _47"> </span>use <span class="_ _47"> </span>the<span class="_ _5a"> </span><span class="ff1a">readn<span class="_ _16"> </span></span>and</div><div class="t m0 x32 h26 y3fff ff1a fsf fc0 sc0 ls0 ws0">writen<span class="_ _66"> </span><span class="ff19">functions to <span class="_ _2"></span>read and <span class="_ _2"></span>write<span class="_ _66"> </span><span class="ff1b">N<span class="_ _66"> </span></span>bytes <span class="_ _2"></span>of <span class="_ _2"></span>data, <span class="_ _2"></span>respectively<span class="_ _4"></span><span class="ls10e2">,l<span class="_ _4f"></span><span class="ls0">etting <span class="_ _2"></span>these <span class="_ _2"></span>functions</span></span></span></div><div class="t m0 x32 h2a y4000 ff19 fsf fc0 sc0 ls0 ws0">handle <span class="_ _9"></span>a <span class="_ _23"></span>return <span class="_ _9"></span>value <span class="_ _9"></span>that’s <span class="_ _23"></span>possibly <span class="_ _9"></span>less <span class="_ _23"></span>than <span class="_ _9"></span>requested. <span class="_ _45"> </span>These<span class="_ _35"> </span>two <span class="_ _9"></span>functions <span class="_ _23"></span>simply</div><div class="t m0 x32 h26 y4001 ff19 fsf fc0 sc0 ls0 ws0">call<span class="_ _35"> </span><span class="ff1a">read<span class="_ _35"> </span></span>or<span class="_ _35"> </span><span class="ff1a">write<span class="_ _35"> </span></span>as <span class="_ _42"> </span>many <span class="_ _23"> </span>times <span class="_ _42"> </span>as <span class="_ _23"> </span>required <span class="_ _23"></span>to <span class="_ _23"> </span>read <span class="_ _23"> </span>or <span class="_ _42"> </span>write <span class="_ _23"> </span>the <span class="_ _42"> </span>entire<span class="_ _45"> </span><span class="ff1b">N<span class="_ _44"> </span></span>bytes <span class="_ _23"> </span>of</div><div class="t m0 x32 h2a y4002 ff19 fsf fc0 sc0 ls0 ws0">data.</div><div class="t m0 x3f h57 y4003 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x3f h57 y4004 ff1a fs2d fc0 sc0 ls0 ws0">ssize_t readn(int<span class="_"> </span><span class="ff1b">fd</span><span class="ls15c">,v<span class="_ _1d"></span><span class="ls0">oid *<span class="ff1b">buf</span><span class="ls15c">,s<span class="_ _5b"></span><span class="ls0">ize_t<span class="_"> </span><span class="ff1b">nbytes</span>);</span></span></span></span></div><div class="t m0 x3f h57 y4005 ff1a fs2d fc0 sc0 ls0 ws0">ssize_t writen(int<span class="_"> </span><span class="ff1b">fd</span><span class="ls15c">,v<span class="_ _1d"></span><span class="ls0">oid *<span class="ff1b">buf</span><span class="ls15c">,s<span class="_ _5b"></span><span class="ls0">ize_t<span class="_"> </span><span class="ff1b">nbytes</span>);</span></span></span></span></div><div class="t m0 xff h5f y4006 ff19 fs2d fc0 sc0 ls0 ws0">Both return: number of bytes r<span class="_ _0"></span>ead or written,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x76 h2d y4007 ff19 fs10 fc0 sc0 ls292 ws0">We <span class="_ _80"> </span>d<span class="_ _9"></span><span class="ls0">eﬁne <span class="_ _23"> </span>these <span class="_ _9"> </span>functions <span class="_ _23"> </span>as <span class="_ _23"> </span>a <span class="_ _23"> </span>convenience <span class="_ _9"></span>for <span class="_ _23"> </span>later <span class="_ _23"> </span>examples, <span class="_ _9"> </span>similar <span class="_ _23"> </span>to <span class="_ _23"> </span>the <span class="_ _9"> </span>error-handling</span></div><div class="t m0 x76 h5e y4008 ff19 fs10 fc0 sc0 ls21d ws0">ro<span class="ls0">utines <span class="_ _3"></span>used <span class="_ _2"></span>in <span class="_ _3"></span>many <span class="_ _3"></span>of <span class="_ _2"></span>the <span class="_ _3"></span>examples <span class="_ _3"></span>in <span class="_ _2"></span>this <span class="_ _3"></span>text.<span class="_ _4b"> </span>The<span class="_ _80"> </span><span class="ff1a">readn<span class="_ _80"> </span></span>and<span class="_ _66"> </span><span class="ff1a">writen<span class="_ _80"> </span></span>functions <span class="_ _3"></span>ar<span class="ls10e3">en<span class="_ _d"></span><span class="ls0">ot</span></span></span></div><div class="t m0 x76 h2d y4009 ff19 fs10 fc0 sc0 ls0 ws0">part of any standard.</div><div class="t m0 x3f h4d y400a ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _e"> </span>c<span class="_ _9"></span><span class="ls0">all<span class="_ _47"> </span><span class="ff1a">writen<span class="_ _47"> </span></span>whenever <span class="_ _2"></span>we’r<span class="ls10e4">ew<span class="_ _8"></span><span class="ls0">riting <span class="_ _2"></span>to <span class="_ _3"></span>one <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _3"></span>ﬁle <span class="_ _2"></span>types <span class="_ _2"></span>that <span class="_ _3"></span>we <span class="_ _2"></span>mentioned,</span></span></span></div><div class="t m0 x32 h4d y400b ff19 fs26 fc0 sc0 ls0 ws0">but we <span class="_ _2"></span>call<span class="_"> </span><span class="ff1a">readn<span class="_ _66"> </span></span>only <span class="_ _2"></span>when we <span class="_ _2"></span>know ahead <span class="_ _2"></span>of <span class="_ _2"></span>time that <span class="_ _2"></span>we will <span class="_ _2"></span>be receiving a <span class="_ _2"></span>certain</div><div class="t m0 x32 h4d y400c ff19 fs26 fc0 sc0 ls0 ws0">number <span class="_ _9"></span>of <span class="_ _23"></span>bytes.<span class="_ _5a"> </span>Figur<span class="ls10e5">e1<span class="_ _b"></span><span class="ls0">4.24 <span class="_ _3"></span>shows <span class="_ _23"></span>implementations <span class="_ _9"></span>of<span class="_ _45"> </span><span class="ff1a">readn<span class="_ _45"> </span></span>and<span class="_ _35"> </span><span class="ff1a">writen<span class="_ _45"> </span></span>that <span class="_ _9"></span>we</span></span></div><div class="t m0 x32 h49 y400d ff19 fs26 fc0 sc0 ls0 ws0">will use in later examples.</div><div class="t m0 x3f h49 y400e ff19 fs26 fc0 sc0 ls0 ws0">Note that if we encounter an error and have previously read or written any data, we</div><div class="t m0 x32 h49 y400f ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turn <span class="_ _2"></span>the <span class="_ _2"></span>amount <span class="_ _2"></span>of data <span class="_ _2"></span>transferred instead <span class="_ _2"></span>of <span class="_ _2"></span>the error<span class="_ _1"></span><span class="ls10e6">.S<span class="_ _5b"></span><span class="ls0">imilarly<span class="_ _4"></span>,<span class="_ _47"> </span>if<span class="_"> </span>we<span class="_ _66"> </span>reach the <span class="_ _2"></span>end</span></span></span></div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.891993px;bottom:1059.888916px;width:213.887001px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
