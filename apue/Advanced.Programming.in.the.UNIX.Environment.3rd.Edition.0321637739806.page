<div id="pf326" class="pf w4 h1f" data-page-no="326"><div class="pc pc326 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg326.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">772<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">502 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">503 <span class="_ _68"> </span>*<span class="_"> </span>Write an index record.<span class="_ _3a"> </span>_db_writedat is called before</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">504 <span class="_ _68"> </span>*<span class="_"> </span>this function to set the datoff and datlen fields in the</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">505 <span class="_ _68"> </span>*<span class="_"> </span>DB structure, which we need to write the index record.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">506 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">507 <span class="_ _d9"> </span>static<span class="_"> </span>void</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">508 <span class="_ _d9"> </span>_db_writeidx(DB<span class="_"> </span>*db, const char *key,</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">509 <span class="_ _227"> </span>off_t<span class="_"> </span>offset, int whence, off_t ptrval)</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">510 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">511 <span class="_ _15"> </span>struct<span class="_"> </span>iovec <span class="_ _68"> </span>iov[2];</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">512 <span class="_ _15"> </span>char<span class="_ _82"> </span>asciiptrlen[PTR_SZ + IDXLEN_SZ + 1];</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">513 <span class="_ _15"> </span>int<span class="_ _166"> </span>len;</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">514 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;ptrval = ptrval) &lt; 0 || ptrval &gt; PTR_MAX)</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">515 <span class="_ _186"> </span>err_quit(&quot;_db_writeidx:<span class="_"> </span>invalid ptr: %d&quot;, ptrval);</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">516 <span class="_ _15"> </span>sprintf(db-&gt;idxbuf,<span class="_"> </span>&quot;%s%c%lld%c%ld\n&quot;, key, SEP,</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">517 <span class="_ _189"> </span>(long<span class="_"> </span>long)db-&gt;datoff, SEP, (long)db-&gt;datlen);</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">518 <span class="_ _15"> </span>len<span class="_"> </span><span class="ls15c">=s<span class="_ _1d"></span><span class="ls0">trlen(db-&gt;idxbuf);</span></span></div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">519 <span class="_ _15"> </span>if<span class="_"> </span>(len &lt; IDXLEN_MIN || len &gt; IDXLEN_MAX)</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">520 <span class="_ _186"> </span>err_dump(&quot;_db_writeidx:<span class="_"> </span>invalid length&quot;);</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">521 <span class="_ _15"> </span>sprintf(asciiptrlen,<span class="_"> </span>&quot;%*lld%*d&quot;, PTR_SZ, (long long)ptrval,</div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">522 <span class="_ _189"> </span>IDXLEN_SZ,<span class="_"> </span>len);</div><div class="t m0 x32 h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">523 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">524 <span class="_ _8a"> </span>*<span class="_"> </span>If we’re appending, we have to lock before doing the lseek</div><div class="t m0 x32 h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">525 <span class="_ _8a"> </span>*<span class="_"> </span>and write to make the two an atomic operation.<span class="_ _d9"> </span>If we’re</div><div class="t m0 x32 h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">526 <span class="_ _8a"> </span>*<span class="_"> </span>overwriting an existing record, we don’t have to lock.</div><div class="t m0 x32 h57 y33b9 ff1a fs2d fc0 sc0 ls0 ws0">527 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y33ba ff1a fs2d fc0 sc0 ls0 ws0">528 <span class="_ _15"> </span>if<span class="_"> </span>(whence == SEEK_END)<span class="_ _8a"> </span>/* we’re appending */</div><div class="t m0 x32 h57 y33bb ff1a fs2d fc0 sc0 ls0 ws0">529 <span class="_ _186"> </span>if<span class="_"> </span>(writew_lock(db-&gt;idxfd, ((db-&gt;nhash+1)*PTR_SZ)+1,</div><div class="t m0 x32 h57 y33bc ff1a fs2d fc0 sc0 ls0 ws0">530 <span class="_ _74"> </span>SEEK_SET,<span class="_"> </span>0) &lt; 0)</div><div class="t m0 x32 h57 y5784 ff1a fs2d fc0 sc0 ls0 ws0">531 <span class="_ _82"> </span>err_dump(&quot;_db_writeidx:<span class="_"> </span>writew_lock error&quot;);</div><div class="t m0 x32 h4d y5785 ff19 fs26 fc0 sc0 ls0 ws0">[502 <span class="_ _a"></span>– <span class="_ _a"></span>522]<span class="_ _65"> </span>The<span class="_ _16"> </span><span class="ff1a">_db_writeidx<span class="_"> </span></span>function <span class="_ _47"> </span>is <span class="_ _47"> </span>called <span class="_ _45"> </span>to <span class="_ _47"> </span>write <span class="_ _45"> </span>an <span class="_ _47"> </span>index <span class="_ _45"> </span>recor<span class="_ _1"></span>d. <span class="_ _5a"> </span>After</div><div class="t m0 x11a h49 y5786 ff19 fs26 fc0 sc0 ls0 ws0">validating <span class="_ _2"></span>the <span class="_ _2"></span>next <span class="_ _2"></span>pointer <span class="_ _2"></span>in <span class="_ _2"></span>the <span class="_ _2"></span>chain, <span class="_ _2"></span>we <span class="_ _2"></span>create the <span class="_ _2"></span>index <span class="_ _2"></span>recor<span class="ls40a">da<span class="_ _8"></span><span class="ls0">nd <span class="_ _2"></span>store</span></span></div><div class="t m0 x11a h4d y5787 ff19 fs26 fc0 sc0 ls0 ws0">the second half <span class="_ _2"></span>of it <span class="_ _2"></span>in<span class="_"> </span><span class="ff1a">idxbuf</span><span class="ls16a9">.W<span class="_ _62"></span><span class="ls1604">en<span class="_ _4f"></span><span class="ls0">eed <span class="_ _2"></span>the size <span class="_ _2"></span>of this <span class="_ _2"></span>portion of <span class="_ _2"></span>the index</span></span></span></div><div class="t m0 x11a h49 y5788 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cord<span class="_ _47"> </span>to<span class="_ _47"> </span>c</span>re<span class="ls0">ate <span class="_ _3"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _3"></span>half <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>index <span class="_ _3"></span>record, <span class="_ _2"></span>which <span class="_ _3"></span>we <span class="_ _2"></span>store<span class="_ _47"> </span>in<span class="_ _47"> </span>the <span class="_ _3"></span>local</span></div><div class="t m0 x11a h4d y5789 ff19 fs26 fc0 sc0 ls0 ws0">variable<span class="_"> </span><span class="ff1a">asciiptrlen</span>.</div><div class="t m0 x11a h4d y57e0 ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _42"> </span>that <span class="_ _23"> </span>we <span class="_ _42"> </span>use <span class="_ _42"> </span>casts <span class="_ _42"> </span>to <span class="_ _42"> </span>force <span class="_ _23"></span>the <span class="_ _42"> </span>size <span class="_ _23"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>arguments <span class="_ _23"> </span>in <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">sprintf</span></div><div class="t m0 x11a h49 y57e1 ff19 fs26 fc0 sc0 ls0 ws0">statements <span class="_ _2"></span>to <span class="_ _2"></span>match <span class="_ _2"></span>the <span class="_ _2"></span>format <span class="_ _2"></span>speciﬁcations.<span class="_ _61"> </span>This <span class="_ _2"></span>is <span class="_ _3"></span>because <span class="_ _2"></span>the <span class="_ _2"></span>size <span class="_ _2"></span>of <span class="_ _2"></span>the</div><div class="t m0 x11a h4d y57e2 ff1a fs26 fc0 sc0 ls0 ws0">off_t<span class="_ _44"> </span><span class="ff19">and<span class="_ _4b"> </span></span>size_t<span class="_ _44"> </span><span class="ff19">data <span class="_ _53"> </span>types <span class="_ _53"> </span>can <span class="_ _53"> </span>vary <span class="_ _53"> </span>among <span class="_ _53"> </span>platforms.<span class="_ _65"> </span>Even <span class="_ _53"> </span>a <span class="_ _53"> </span>32</span></div><div class="t m0 x42 h49 y57e3 ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x40 h49 y57e2 ff19 fs26 fc0 sc0 ls0 ws0">bit</div><div class="t m0 x11a h49 y57e4 ff19 fs26 fc0 sc0 ls0 ws0">system <span class="_ _53"> </span>can <span class="_ _53"> </span>provide <span class="_ _53"> </span>64</div><div class="t m0 x1e0 h49 y57e5 ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x23 h49 y57e4 ff19 fs26 fc0 sc0 ls0 ws0">bit <span class="_ _53"> </span>ﬁle <span class="_ _53"> </span>offsets, <span class="_ _53"> </span>so <span class="_ _e"> </span>we <span class="_ _53"> </span>can’t <span class="_ _e"> </span>make <span class="_ _53"> </span>any <span class="_ _53"> </span>assumptions</div><div class="t m0 x11a h4d y57e6 ff19 fs26 fc0 sc0 ls0 ws0">about the size of the<span class="_"> </span><span class="ff1a">off_t<span class="_ _80"> </span></span>data type.</div><div class="t m0 x32 h4d y57e7 ff19 fs26 fc0 sc0 ls0 ws0">[523 <span class="_ _a"></span>– <span class="_ _a"></span>531]<span class="_ _65"> </span>As <span class="_ _3"></span>with<span class="_ _45"> </span><span class="ff1a">_db_writedat</span><span class="ls16aa">,t<span class="_ _b"></span><span class="ls0">his <span class="_ _9"></span>function <span class="_ _3"></span>deals <span class="_ _9"></span>with <span class="_ _9"></span>locking <span class="_ _3"></span>only <span class="_ _9"></span>when <span class="_ _3"></span>a <span class="_ _9"></span>new</span></span></div><div class="t m0 x11a h4d y57e8 ff19 fs26 fc0 sc0 ls0 ws0">index <span class="_ _e"> </span>recor<span class="_ _0"></span>d<span class="_ _4b"> </span>is<span class="_ _4b"> </span>being <span class="_"> </span>appended <span class="_ _53"> </span>to <span class="_ _e"> </span>the <span class="_ _e"> </span>index <span class="_ _e"> </span>ﬁle.<span class="_ _48"> </span>When<span class="_ _59"> </span><span class="ff1a">_db_dodelete</span></div><div class="t m0 x11a h49 y57e9 ff19 fs26 fc0 sc0 ls0 ws0">calls <span class="_ _2"></span>this <span class="_ _3"></span>function, <span class="_ _2"></span>we’r<span class="ls16ab">er<span class="_ _8"></span><span class="ls0">ewriting <span class="_ _2"></span>an <span class="_ _3"></span>existing <span class="_ _3"></span>index <span class="_ _2"></span>record. <span class="_"> </span>In<span class="_ _47"> </span>this <span class="_ _3"></span>case, <span class="_ _2"></span>the</span></span></div><div class="t m0 x11a h49 y57ea ff19 fs26 fc0 sc0 ls0 ws0">caller has write locked the hash chain, so no additional locking is requir<span class="_ _0"></span>ed.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
