<div id="pf123" class="pf w4 h1f" data-page-no="123"><div class="pc pc123 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg123.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>8.1<span class="_ _1"></span><span class="lsa07">1C<span class="_ _234"></span><span class="ls0">hanging <span class="_"> </span>User <span class="_"> </span>IDs <span class="_"> </span>and <span class="_"> </span>Group <span class="_"> </span>IDs<span class="_ _1fb"> </span><span class="ff18">257</span></span></span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls44">e8<span class="_ _4f"></span><span class="ls0">.18 summarizes the various ways these three user IDs can be changed.</span></span></div><div class="t m0 x16 h5e y21d3 ff1a fs10 fc0 sc0 ls0 ws0">exec <span class="_ _17b"> </span>setuid(<span class="ff1b">uid</span>)</div><div class="t m0 xea h2e y21d4 ff19 fs11 fc0 sc0 ls0 ws0">set-user-ID bit of<span class="_ _0"></span><span class="lsa10">fs<span class="_ _216"></span><span class="ls0">et-user-ID bit on<span class="_ _13f"> </span>superuser <span class="_ _5e"> </span>unprivileged<span class="_"> </span>user</span></span></div><div class="t m0 x14 h2e y21d5 ff19 fs11 fc0 sc0 ls0 ws0">ID</div><div class="t m0 x1f4 hd1 y21d6 ff19 fs12 fc0 sc0 ls222 ws0">re<span class="ls0">al user ID<span class="_ _12c"> </span>unchanged <span class="_ _ab"> </span>unchanged <span class="_ _b1"> </span>set<span class="_"> </span>to<span class="_"> </span><span class="ff1b">uid<span class="_ _1c3"> </span></span>unchanged</span></div><div class="t m0 x1f4 hd1 y21d7 ff19 fs12 fc0 sc0 ls0 ws0">effective user ID<span class="_ _179"> </span>unchanged <span class="_ _235"> </span>set<span class="_"> </span>to<span class="_"> </span><span class="ff1b">uid<span class="_ _1c3"> </span></span>set to<span class="_"> </span><span class="ff1b">uid<span class="_ _236"></span><span class="ff19">set from user ID of</span></span></div><div class="t m0 x67 h2f y21d8 ff19 fs12 fc0 sc0 ls0 ws0">program ﬁle</div><div class="t m0 x1f4 hd1 y21d9 ff19 fs12 fc0 sc0 ls0 ws0">saved set-user ID<span class="_ _8b"> </span>set to<span class="_"> </span><span class="ff1b">uid<span class="_ _1c3"> </span></span>unchanged<span class="_ _237"></span>copied from ef<span class="_ _0"></span>fective</div><div class="t m0 x14e h2f y21da ff19 fs12 fc0 sc0 ls0 ws0">user ID</div><div class="t m0 x6c h2f y21d9 ff19 fs12 fc0 sc0 ls0 ws0">copied from ef<span class="_ _0"></span>fective</div><div class="t m0 x67 h2f y21da ff19 fs12 fc0 sc0 ls0 ws0">user ID</div><div class="t m0 xa6 h30 y21db ff18 fs13 fc0 sc0 ls0 ws0">Figure 8.18<span class="_ _5a"> </span><span class="ff19 ls9b5">Wa<span class="_ _9"></span><span class="ls0">ys to change the three user IDs</span></span></div><div class="t m0 x32 h6e y21dc ff19 fs31 fc0 sc0 ls0 ws0">Note <span class="_ _2"></span>that <span class="_ _2"></span>we <span class="_ _2"></span>can <span class="_ _3"></span>obtain <span class="_ _2"></span>only <span class="_ _2"></span>the <span class="_ _3"></span>current value <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>real <span class="_ _2"></span>user <span class="_ _2"></span>ID <span class="_ _2"></span>and <span class="_ _2"></span>the <span class="_ _3"></span>effective user</div><div class="t m0 x32 h64 y21dd ff19 fs31 fc0 sc0 ls0 ws0">ID with the functions<span class="_"> </span><span class="ff1a">getuid<span class="_ _66"> </span></span>and<span class="_"> </span><span class="ff1a">geteuid<span class="_ _80"> </span></span>from Section 8.2.<span class="_ _46"> </span><span class="ls43f">We <span class="_ _53"> </span>h<span class="_ _9"></span></span>ave no <span class="_ _2"></span>portable way</div><div class="t m0 x32 h6e y21de ff19 fs31 fc0 sc0 ls0 ws0">to obtain the current value of the saved set-user<span class="_ _0"></span>-ID.</div><div class="t m0 x76 h63 y21df ff19 fs13 fc0 sc0 ls0 ws0">FreeBSD <span class="_ _3"></span>8.0 <span class="_ _3"></span>and <span class="_ _9"></span>LINUX <span class="_ _3"></span>3.2.0 <span class="_ _9"></span>provide <span class="_ _3"></span>the<span class="_ _66"> </span><span class="ff1a">getresuid<span class="_ _66"> </span></span>and<span class="_ _66"> </span><span class="ff1a">getresgid<span class="_ _47"> </span></span>functions, <span class="_ _3"></span>which <span class="_ _9"></span>can</div><div class="t m0 x76 h30 y21e0 ff19 fs13 fc0 sc0 ls0 ws0">be used to get the saved set-user-ID and saved set-gr<span class="_ _0"></span>oup-ID, respectively<span class="_ _4"></span>.</div><div class="t m0 x35 h64 y21e1 ff1f fs31 fc0 sc0 ls0 ws0">setreuid<span class="_ _66"> </span><span class="ff16">and<span class="_"> </span></span>setregid<span class="_ _47"> </span><span class="ff16">Functions</span></div><div class="t m0 x32 h6e y21e2 ff19 fs31 fc0 sc0 ls0 ws0">Historically<span class="_ _4"></span><span class="lsa11">,B<span class="_ _b"></span><span class="ls0">SD <span class="_ _9"></span>supported <span class="_ _9"></span>the <span class="_ _9"></span>swapping <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>real <span class="_ _9"></span>user <span class="_ _9"></span>ID <span class="_ _9"></span>and <span class="_ _9"></span>the <span class="_ _9"></span>effective <span class="_ _3"></span>user <span class="_ _9"></span>ID</span></span></div><div class="t m0 x32 h64 y21e3 ff19 fs31 fc0 sc0 ls0 ws0">with the<span class="_"> </span><span class="ff1a">setreuid<span class="_ _80"> </span></span>function.</div><div class="t m0 x3f h65 y21e4 ff1a fs32 fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h65 y21e5 ff1a fs32 fc0 sc0 ls0 ws0">int setreuid(uid_t<span class="_"> </span><span class="ff1b">ruid</span><span class="ls441">,u<span class="_ _1d"></span><span class="ls0">id_t<span class="_"> </span><span class="ff1b">euid</span>);</span></span></div><div class="t m0 x3f h65 y21e6 ff1a fs32 fc0 sc0 ls0 ws0">int setregid(gid_t<span class="_"> </span><span class="ff1b ls442">rg<span class="ls0">id</span></span><span class="ls441">,g<span class="_ _5b"></span><span class="ls0">id_t<span class="_"> </span><span class="ff1b">egid</span>);</span></span></div><div class="t m0 x1af h92 y21e7 ff19 fs32 fc0 sc0 ls0 ws0">Both return: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x32 h96 y21e8 ff19 fs49 fc0 sc0 ls9ae ws0">We <span class="_ _53"> </span>c<span class="_ _23"></span><span class="ls0">an supply <span class="_ _2"></span>a value <span class="_ _2"></span>of<span class="_ _66"> </span><span class="ff20">−</span><span class="lsa12">1f<span class="_ _d"></span><span class="ls0">or <span class="_ _2"></span>any of <span class="_ _2"></span>the <span class="_ _2"></span>arguments to indicate <span class="_ _2"></span>that <span class="_ _2"></span>the corresponding</span></span></span></div><div class="t m0 x32 h96 y21e9 ff19 fs49 fc0 sc0 ls0 ws0">ID should remain unchanged.</div><div class="t m0 x3f h96 y21ea ff19 fs49 fc0 sc0 ls0 ws0">The <span class="_ _3"></span>rule <span class="_ _3"></span>is <span class="_ _3"></span>simple: <span class="_ _3"></span>an <span class="_ _9"></span>unprivileged <span class="_ _3"></span>user <span class="_ _3"></span>can <span class="_ _3"></span>always <span class="_ _9"></span>swap <span class="_ _3"></span>between <span class="_ _3"></span>the <span class="_ _3"></span>real <span class="_ _3"></span>user <span class="_ _3"></span>ID</div><div class="t m0 x32 h96 y21eb ff19 fs49 fc0 sc0 ls0 ws0">and <span class="_ _e"> </span>the <span class="_ _e"> </span>effective <span class="_ _e"> </span>user <span class="_ _e"> </span>ID.<span class="_ _48"> </span>This <span class="_ _e"> </span>allows <span class="_"> </span>a <span class="_ _53"> </span>set-user-ID <span class="_ _e"> </span>program <span class="_ _53"> </span>to <span class="_"> </span>swap <span class="_ _53"> </span>to <span class="_"> </span>the <span class="_ _53"> </span>user<span class="_ _9"></span>’s</div><div class="t m0 x32 h96 y21ec ff19 fs49 fc0 sc0 ls0 ws0">normal <span class="_ _42"> </span>permissions <span class="_ _42"> </span>and <span class="_ _53"> </span>swap <span class="_ _42"> </span>back <span class="_ _42"> </span>again <span class="_ _53"> </span>later <span class="_ _42"> </span>for <span class="_ _53"> </span>set-user-ID <span class="_ _42"> </span>operations.<span class="_ _54"> </span>When <span class="_ _42"> </span>the</div><div class="t m0 x32 h96 y21ed ff19 fs49 fc0 sc0 ls0 ws0">saved <span class="_ _9"></span>set-user-ID <span class="_ _3"></span>featur<span class="lsa13">ew<span class="_ _b"></span><span class="ls0">as <span class="_ _9"></span>introduced <span class="_ _9"></span>with <span class="_ _9"></span>POSIX.1, <span class="_ _9"></span>the <span class="_ _9"></span>rule <span class="_ _9"></span>was <span class="_ _9"></span>enhanced <span class="_ _9"></span>to <span class="_ _9"></span>also</span></span></div><div class="t m0 x32 h96 y21ee ff19 fs49 fc0 sc0 ls0 ws0">allow an unprivileged user to set its effective user ID to its saved set-user<span class="_ _0"></span>-ID.</div><div class="t m0 x76 h6f y21ef ff19 fs14 fc0 sc0 ls0 ws0">Both<span class="_ _80"> </span><span class="ff1a">setreuid<span class="_ _80"> </span></span>and<span class="_ _80"> </span><span class="ff1a">setregid<span class="_ _80"> </span></span>ar<span class="lsa14">ei<span class="_ _d"></span><span class="ls0">ncluded <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>XSI <span class="_ _2"></span>option <span class="_ _2"></span>in <span class="_ _3"></span>POSIX.1.<span class="_ _4b"> </span>As <span class="_ _2"></span>such, <span class="_ _2"></span>all <span class="_ _3"></span>UNIX</span></span></div><div class="t m0 x76 h31 y21f0 ff19 fs14 fc0 sc0 ls0 ws0">System implementations ar<span class="ls56a">ee<span class="_ _5"></span><span class="ls0">xpected to provide support for them.</span></span></div><div class="t m0 x76 h6f y21f1 ff19 fs14 fc0 sc0 ls0 ws0">4.3BSD <span class="_ _42"> </span>didn’t <span class="_"> </span>have <span class="_ _23"> </span>the <span class="_"> </span>saved <span class="_ _42"> </span>set-user-ID <span class="_ _42"> </span>featur<span class="lsa15">ed<span class="_ _43"></span><span class="ls0">escribed <span class="_ _42"> </span>earlier; <span class="_"> </span>it <span class="_ _23"> </span>used<span class="_ _35"> </span><span class="ff1a">setreuid<span class="_ _35"> </span></span>and</span></span></div><div class="t m0 x76 h6f y21f2 ff1a fs14 fc0 sc0 ls0 ws0">setregid<span class="_ _47"> </span><span class="ff19">instead. <span class="_ _47"> </span>This<span class="_ _45"> </span>allowed <span class="_ _9"></span>an <span class="_ _23"> </span>unprivileged <span class="_ _23"> </span>user <span class="_ _9"></span>to <span class="_ _23"> </span>swap <span class="_ _23"> </span>back <span class="_ _9"> </span>and <span class="_ _23"> </span>forth <span class="_ _23"> </span>between <span class="_ _9"> </span>the</span></div><div class="t m0 x76 h31 y21f3 ff19 fs14 fc0 sc0 ls0 ws0">two <span class="_ _9"></span>values.<span class="_ _59"> </span>Be <span class="_ _9"></span>aware, <span class="_ _3"></span>however<span class="_ _1"></span><span class="lsa16">,t<span class="_ _4f"></span><span class="ls0">hat <span class="_ _9"> </span>when <span class="_ _9"> </span>programs <span class="_ _9"></span>that <span class="_ _9"></span>used <span class="_ _9"></span>this <span class="_ _9"></span>featur<span class="lsa17">es<span class="_ _8"></span><span class="ls0">pawned <span class="_ _9"></span>a <span class="_ _9"></span>shell,</span></span></span></span></div><div class="t m0 x76 h6f y21f4 ff19 fs14 fc0 sc0 ls0 ws0">they <span class="_ _3"></span>had <span class="_ _3"></span>to <span class="_ _3"></span>set <span class="_ _3"></span>the <span class="_ _3"></span>real <span class="_ _2"></span>user <span class="_ _3"></span>ID <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _2"></span>normal <span class="_ _3"></span>user <span class="_ _9"></span>ID <span class="_ _2"></span>befor<span class="lsa18">et<span class="_ _d"></span><span class="ls0">he<span class="_ _66"> </span><span class="ff1a">exec</span><span class="lsa19">.I<span class="_ _55"></span><span class="lsa1a">ft<span class="_ _d"></span><span class="ls0">hey <span class="_ _3"></span>didn’t <span class="_ _3"></span>do <span class="_ _3"></span>this,</span></span></span></span></span></div><div class="t m0 x76 h6f y21f5 ff19 fs14 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>real <span class="_ _2"></span>user <span class="_ _2"></span>ID <span class="_ _3"></span>could <span class="_ _2"></span>be <span class="_ _3"></span>privileged <span class="_ _2"></span>(from <span class="_ _2"></span>the <span class="_ _2"></span>swap <span class="_ _3"></span>done <span class="_ _2"></span>by<span class="_ _80"> </span><span class="ff1a">setreuid</span><span class="lsa14">)a<span class="_ _5"></span><span class="ls0">nd <span class="_ _2"></span>the <span class="_ _3"></span>shell <span class="_ _2"></span>process</span></span></div><div class="t m0 x76 h6f y21f6 ff19 fs14 fc0 sc0 ls0 ws0">could call<span class="_"> </span><span class="ff1a">setreuid<span class="_ _e"> </span></span>to <span class="_ _2"></span>swap the <span class="_ _2"></span>two and assume <span class="_ _2"></span>the permissions of <span class="_ _2"></span>the mor<span class="lsa1b">ep<span class="_ _5"></span><span class="ls0">rivileged <span class="_ _2"></span>user<span class="_ _1"></span>.</span></span></div><div class="t m0 x76 h31 y21f7 ff19 fs14 fc0 sc0 ls0 ws0">As a defensive programming measure<span class="_"> </span>to<span class="_"> </span>solve this problem, pr<span class="_ _0"></span>ograms set both the real user ID</div><div class="t m0 x76 h6f y21f8 ff19 fs14 fc0 sc0 ls0 ws0">and the effective user ID to the normal user ID befor<span class="_ _0"></span><span class="ls56a">et<span class="_ _84"></span><span class="ls0">he call to<span class="_"> </span><span class="ff1a">exec<span class="_ _53"> </span></span>in the child.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
