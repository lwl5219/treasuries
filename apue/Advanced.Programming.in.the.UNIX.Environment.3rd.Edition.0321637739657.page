<div id="pf291" class="pf w4 h1f" data-page-no="291"><div class="pc pc291 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg291.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>16.6<span class="_ _177"> </span>Socket <span class="_"> </span>Options<span class="_ _1b"> </span><span class="ff18">623</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">if (argc != 1)</div><div class="t m0 x9d h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;usage: ruptimed&quot;);</div><div class="t m0 x8a h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">if ((n = sysconf(_SC_HOST_NAME_MAX)) &lt; 0)</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls15c ws0">n=H<span class="_ _1d"></span><span class="ls0">OST_NAME_MAX; <span class="_"> </span>/*<span class="_"> </span>best guess */</span></div><div class="t m0 x8a h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">if ((host = malloc(n)) == NULL)</div><div class="t m0 x9d h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;malloc error&quot;);</div><div class="t m0 x8a h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">if (gethostname(host, n) &lt; 0)</div><div class="t m0 x9d h57 y805 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;gethostname error&quot;);</div><div class="t m0 x8a h57 y806 ff1a fs2d fc0 sc0 ls0 ws0">daemonize(&quot;ruptimed&quot;);</div><div class="t m0 x8a h57 y807 ff1a fs2d fc0 sc0 ls0 ws0">memset(&amp;hint, 0, sizeof(hint));</div><div class="t m0 x8a h57 y808 ff1a fs2d fc0 sc0 ls0 ws0">hint.ai_flags = AI_CANONNAME;</div><div class="t m0 x8a h57 y809 ff1a fs2d fc0 sc0 ls0 ws0">hint.ai_socktype = SOCK_DGRAM;</div><div class="t m0 x8a h57 y80a ff1a fs2d fc0 sc0 ls0 ws0">hint.ai_canonname = NULL;</div><div class="t m0 x8a h57 y80b ff1a fs2d fc0 sc0 ls0 ws0">hint.ai_addr = NULL;</div><div class="t m0 x8a h57 y80c ff1a fs2d fc0 sc0 ls0 ws0">hint.ai_next = NULL;</div><div class="t m0 x8a h57 y80d ff1a fs2d fc0 sc0 ls0 ws0">if ((err = getaddrinfo(host, &quot;ruptime&quot;, &amp;hint, &amp;ailist)) != 0) {</div><div class="t m0 x9d h57 y80e ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_ERR, &quot;ruptimed: getaddrinfo error: %s&quot;,</div><div class="t m0 x76 h57 y80f ff1a fs2d fc0 sc0 ls0 ws0">gai_strerror(err));</div><div class="t m0 x9d h57 y810 ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y811 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y812 ff1a fs2d fc0 sc0 ls0 ws0">for (aip = ailist; aip != NULL; aip = aip-&gt;ai_next) {</div><div class="t m0 x9d h57 y813 ff1a fs2d fc0 sc0 ls0 ws0">if ((sockfd = initserver(SOCK_DGRAM, aip-&gt;ai_addr,</div><div class="t m0 x76 h57 y814 ff1a fs2d fc0 sc0 ls0 ws0">aip-&gt;ai_addrlen, 0)) &gt;= 0) {</div><div class="t m0 x1f h57 y815 ff1a fs2d fc0 sc0 ls0 ws0">serve(sockfd);</div><div class="t m0 x1f h57 y816 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x9d h57 y817 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y818 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y819 ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x32 h57 y81a ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xe7 h2d y4a79 ff18 fs10 fc0 sc0 ls0 ws0">Figure 16.20<span class="_ _5a"> </span><span class="ff19">Server providing system uptime over datagrams</span></div><div class="t m0 x32 h4d y4a7a ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _23"></span>server <span class="_ _23"></span>blocks <span class="_ _23"> </span>in<span class="_ _35"> </span><span class="ff1a">recvfrom<span class="_ _35"> </span></span>for <span class="_ _23"></span>a <span class="_ _23"></span>request <span class="_ _9"></span>for <span class="_ _42"> </span>service.<span class="_ _51"> </span>When <span class="_ _23"></span>a <span class="_ _23"></span>request <span class="_ _9"></span>arrives, <span class="_ _23"> </span>we</div><div class="t m0 x32 h4d y4a7b ff19 fs26 fc0 sc0 ls0 ws0">save <span class="_ _2"></span>the <span class="_ _2"></span>requester <span class="_ _84"></span>’s<span class="_ _66"> </span>address <span class="_ _2"></span>and <span class="_ _2"></span>use<span class="_ _66"> </span><span class="ff1a">popen<span class="_ _47"> </span></span>to run <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">uptime<span class="_ _47"> </span></span>command. <span class="_ _66"> </span>W<span class="_ _6"></span><span class="ls10c0">es<span class="_ _4f"></span><span class="ls0">end <span class="_ _2"></span>the</span></span></div><div class="t m0 x32 h4d y4a7c ff19 fs26 fc0 sc0 ls0 ws0">output <span class="_ _2"></span>back <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _3"></span>client <span class="_ _2"></span>using <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">sendto<span class="_ _66"> </span></span>function, <span class="_ _2"></span>with <span class="_ _3"></span>the <span class="_ _2"></span>destination <span class="_ _2"></span>address <span class="_ _2"></span>set <span class="_ _2"></span>to</div><div class="t m0 x32 h49 y4a7d ff19 fs26 fc0 sc0 ls0 ws0">the requester <span class="_ _84"></span>’s<span class="_"> </span>address.</div><div class="t m0 x35 h99 y4a7e ff16 fs3b fc0 sc0 ls0 ws0">16.6 <span class="_ _93"> </span>Socket <span class="_"> </span>Options</div><div class="t m0 x32 h55 y4a7f ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _47"> </span>socket <span class="_ _66"> </span>mechanism <span class="_ _47"> </span>provides <span class="_ _66"> </span>two <span class="_ _47"> </span>socket-option <span class="_ _47"> </span>interfaces <span class="_ _47"> </span>for <span class="_ _47"> </span>us <span class="_ _66"> </span>to <span class="_ _47"> </span>control <span class="_ _66"> </span>the</div><div class="t m0 x32 h55 y4a80 ff19 fs2c fc0 sc0 ls0 ws0">behavior <span class="_ _2"></span>of <span class="_ _2"></span>sockets.<span class="_ _46"> </span>One <span class="_ _2"></span>interface <span class="_ _2"></span>is <span class="_ _2"></span>used <span class="_ _2"></span>to <span class="_ _2"></span>set <span class="_ _2"></span>an <span class="_ _2"></span>option, <span class="_ _2"></span>and <span class="_ _2"></span>another <span class="_ _2"></span>interface <span class="_ _2"></span>allows</div><div class="t m0 x32 h55 y4a81 ff19 fs2c fc0 sc0 ls0 ws0">us to query the state of an option.<span class="_ _59"> </span><span class="ls155">We <span class="_ _e"> </span>c<span class="_ _9"></span></span>an get and set three kinds of options:</div><div class="t m0 x3f h55 y4a82 ff19 fs2c fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>Generic<span class="_"> </span>options that work with all socket types</div><div class="t m0 x3f h55 y4a83 ff19 fs2c fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>Options<span class="_ _44"> </span>that <span class="_ _53"> </span>ar<span class="ls137b">em<span class="_ _c"></span><span class="ls0">anaged <span class="_ _53"> </span>at <span class="_ _53"> </span>the <span class="_ _53"> </span>socket <span class="_ _53"> </span>level, <span class="_ _53"> </span>but <span class="_ _53"> </span>depend <span class="_ _53"> </span>on <span class="_ _53"> </span>the <span class="_ _53"> </span>underlying</span></span></div><div class="t m0 x41 h55 y4a84 ff19 fs2c fc0 sc0 ls0 ws0">protocols for support</div><div class="t m0 x3f h55 y4a85 ff19 fs2c fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>Protocol-speciﬁc options unique to each individual pr<span class="_ _0"></span>otocol</div><div class="t m0 x32 h55 y4a86 ff19 fs2c fc0 sc0 ls0 ws0">The Single UNIX Speciﬁcation <span class="_ _2"></span>deﬁnes only the <span class="_ _2"></span>socket-layer options (the <span class="_ _2"></span>ﬁrst two option</div><div class="t m0 x32 h55 y4a87 ff19 fs2c fc0 sc0 ls0 ws0">types in the preceding list).</div><a class="l" href="#pf12" data-dest-detail='[18,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892842px;bottom:382.216839px;width:127.116592px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
