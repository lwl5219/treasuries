<div id="pf78" class="pf w4 h1f" data-page-no="78"><div class="pc pc78 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg78.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">86<span class="_ _1b"> </span><span class="ff19">File <span class="_"> </span>I/O<span class="_ _169"> </span>Chapter <span class="_"> </span>3</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls0 ws0">If we add the line</div><div class="t m0 x3f h57 yd36 ff1a fs2d fc0 sc0 ls0 ws0">set_fl(STDOUT_FILENO, O_SYNC);</div><div class="t m0 x32 h2a yd37 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _23"> </span>the <span class="_ _23"> </span>beginning <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>pr<span class="_ _0"></span>ogram <span class="_ _23"> </span>shown <span class="_ _42"> </span>in <span class="_ _23"></span>Figur<span class="ls427">e3<span class="_ _43"></span><span class="ls0">.5, <span class="_ _23"> </span>we’ll <span class="_ _23"> </span>turn <span class="_ _42"> </span>on <span class="_ _23"> </span>the <span class="_ _23"> </span>synchronous-</span></span></div><div class="t m0 x32 h26 yd38 ff19 fsf fc0 sc0 ls0 ws0">write <span class="_ _42"> </span>ﬂag.<span class="_ _54"> </span>This <span class="_ _53"> </span>causes <span class="_ _42"> </span>each<span class="_ _44"> </span><span class="ff1a">write<span class="_ _44"> </span></span>to <span class="_ _42"> </span>wait <span class="_ _53"> </span>for <span class="_ _42"> </span>the <span class="_ _53"> </span>data <span class="_ _42"> </span>to <span class="_ _42"> </span>be <span class="_ _53"> </span>written <span class="_ _42"> </span>to <span class="_ _53"> </span>disk <span class="_ _42"> </span>before</div><div class="t m0 x32 h26 yd39 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">turning. <span class="_"> </span>Normally<span class="_ _66"> </span>in the UNIX <span class="_ _2"></span>System, a<span class="_"> </span><span class="ff1a">write<span class="_ _66"> </span></span>only queues the data for <span class="_ _2"></span>writing; the</span></div><div class="t m0 x32 h2a yd3a ff19 fsf fc0 sc0 ls0 ws0">actual <span class="_ _2"></span>disk <span class="_ _2"></span>write <span class="_ _3"></span>operation <span class="_ _2"></span>can <span class="_ _2"></span>take <span class="_ _3"></span>place <span class="_ _2"></span>sometime <span class="_ _2"></span>later<span class="_ _1"></span><span class="ls428">.A<span class="_ _d"></span><span class="ls0">database <span class="_ _2"></span>system <span class="_ _3"></span>is <span class="_ _2"></span>a <span class="_ _2"></span>likely</span></span></div><div class="t m0 x32 h26 yd3b ff19 fsf fc0 sc0 ls0 ws0">candidate <span class="_ _9"></span>for <span class="_ _9"></span>using<span class="_ _35"> </span><span class="ff1a">O_SYNC</span>,<span class="_ _45"> </span>so<span class="_ _45"> </span>that <span class="_ _9"></span>it <span class="_ _9"></span>knows <span class="_ _23"></span>on <span class="_ _9"></span>return <span class="_ _3"></span>from <span class="_ _9"></span>a<span class="_ _45"> </span><span class="ff1a">write<span class="_ _35"> </span></span>that <span class="_ _9"></span>the <span class="_ _9"></span>data <span class="_ _9"></span>is</div><div class="t m0 x32 h2a yd3c ff19 fsf fc0 sc0 ls0 ws0">actually on the disk, in case of an abnormal system failure.</div><div class="t m0 x3f h26 yd3d ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _59"> </span>e<span class="_ _9"></span><span class="ls0">xpect <span class="_ _47"> </span>the<span class="_ _16"> </span><span class="ff1a">O_SYNC<span class="_ _16"> </span></span>ﬂag <span class="_ _47"> </span>to <span class="_ _47"> </span>increase <span class="_ _66"> </span>the <span class="_ _47"> </span>system <span class="_ _47"> </span>and <span class="_ _45"> </span>clock <span class="_ _66"> </span>times <span class="_ _47"> </span>when <span class="_ _47"> </span>the</span></div><div class="t m0 x32 h2a yd3e ff19 fsf fc0 sc0 ls0 ws0">program <span class="_ _2"></span>runs. <span class="_ _47"> </span>T<span class="_ _6"></span><span class="ls429">ot<span class="_ _8"></span><span class="ls0">est <span class="_ _9"></span>this, <span class="_ _3"></span>we <span class="_ _3"></span>can <span class="_ _9"></span>run <span class="_ _3"></span>the <span class="_ _3"></span>program <span class="_ _3"></span>in <span class="_ _3"></span>Figur<span class="ls429">e3<span class="_ _b"></span><span class="ls0">.5, <span class="_ _9"></span>copying <span class="_ _3"></span>492.6 <span class="_ _3"></span>MB <span class="_ _9"></span>of</span></span></span></span></div><div class="t m0 x32 h2a yd3f ff19 fsf fc0 sc0 ls0 ws0">data <span class="_ _42"> </span>from <span class="_ _23"> </span>one <span class="_ _53"> </span>ﬁle <span class="_ _42"> </span>on <span class="_ _42"> </span>disk <span class="_ _42"> </span>to <span class="_ _42"> </span>another <span class="_ _42"> </span>and <span class="_ _42"> </span>compar<span class="ls42a">et<span class="_ _43"></span><span class="ls0">his <span class="_ _23"> </span>with <span class="_ _42"> </span>a <span class="_ _42"> </span>version <span class="_ _53"> </span>that <span class="_ _42"> </span>does <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h26 yd40 ff19 fsf fc0 sc0 ls0 ws0">same <span class="_ _3"></span>thing <span class="_ _9"></span>with <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">O_SYNC<span class="_ _47"> </span></span>ﬂag <span class="_ _9"></span>set.<span class="_ _16"> </span>The <span class="_ _9"></span>results <span class="_ _3"></span>from <span class="_ _3"></span>a <span class="_ _3"></span>Linux <span class="_ _9"></span>system <span class="_ _3"></span>using <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">ext4</span></div><div class="t m0 x32 h2a yd41 ff19 fsf fc0 sc0 ls0 ws0">ﬁle system ar<span class="ls44">es<span class="_ _4f"></span><span class="ls0">hown in Figur<span class="ls44">e3<span class="_ _d"></span><span class="ls0">.13.</span></span></span></span></div><div class="t m0 x173 h2d yd42 ff19 fs10 fc0 sc0 ls0 ws0">User CPU<span class="_ _6e"> </span>System CPU<span class="_ _6e"> </span>Clock time</div><div class="t m0 x174 h2d yd43 ff19 fs10 fc0 sc0 ls0 ws0">(seconds) <span class="_ _87"> </span>(seconds)<span class="_ _170"> </span>(seconds)</div><div class="t m0 xa0 h2d yd44 ff19 fs10 fc0 sc0 ls0 ws0">Operation</div><div class="t m0 xe1 h4f yd45 ff19 fs11 fc0 sc0 ls293 ws0">re<span class="ls0">ad time from Figur<span class="lsdb">e3<span class="_ _5"></span><span class="ls0">.6 for<span class="_"> </span><span class="ff1a">BUFFSIZE<span class="_ _e"> </span></span><span class="lsdb">=4<span class="_ _84"></span><span class="ls0">,096 <span class="_ _20"> </span>0.03<span class="_ _90"> </span>0.58 <span class="_ _17a"> </span>8.62</span></span></span></span></span></div><div class="t m0 xe1 h4f yd46 ff19 fs11 fc0 sc0 ls0 ws0">normal<span class="_"> </span><span class="ff1a">write<span class="_ _53"> </span></span>to disk ﬁle<span class="_ _17b"> </span>0.00 <span class="_ _9f"> </span>1.05<span class="_ _6f"> </span>9.70</div><div class="t m0 xe1 h4f yd47 ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">to disk ﬁle with<span class="_"> </span></span>O_SYNC<span class="_ _e"> </span><span class="ff19">set <span class="_ _d2"> </span>0.02<span class="_ _90"> </span>1.09 <span class="_ _16d"> </span>10.28</span></div><div class="t m0 xe1 h4f yd48 ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">to disk followed by<span class="_"> </span></span>fdatasync<span class="_ _82"> </span><span class="ff19">0.02 <span class="_ _17c"> </span>1.14<span class="_ _2f"> </span>17.93</span></div><div class="t m0 xe1 h4f yd49 ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">to disk followed by<span class="_"> </span></span>fsync<span class="_ _17d"> </span><span class="ff19">0.00 <span class="_ _17c"> </span>1.19<span class="_ _b7"> </span>18.17</span></div><div class="t m0 xe1 h4f yd4a ff1a fs11 fc0 sc0 ls0 ws0">write<span class="_ _53"> </span><span class="ff19">to disk with<span class="_"> </span></span>O_SYNC<span class="_ _e"> </span><span class="ff19">set followed by<span class="_"> </span></span>fsync<span class="_ _12b"> </span><span class="ff19">0.02 <span class="_ _9f"> </span>1.15<span class="_ _2f"> </span>17.88</span></div><div class="t m0 x175 h6d yd4b ff18 fs12 fc0 sc0 ls0 ws0">Figure 3.13<span class="_ _5a"> </span><span class="ff19">Linux<span class="_"> </span><span class="ff1a">ext4<span class="_ _e"> </span></span>timing results using various synchronization mechanisms</span></div><div class="t m0 x3f h5c yd4c ff19 fs29 fc0 sc0 ls0 ws0">The six <span class="_ _2"></span>rows in <span class="_ _2"></span>Figur<span class="ls42b">e3<span class="_ _4f"></span><span class="ls0">.13 <span class="_ _2"></span>wer<span class="ls42c">ea<span class="_ _4f"></span><span class="ls0">ll measured with <span class="_ _2"></span>a<span class="_ _66"> </span><span class="ff1a">BUFFSIZE<span class="_ _66"> </span></span>of <span class="_ _2"></span>4,096 <span class="_ _2"></span>bytes.<span class="_ _61"> </span>The</span></span></span></span></div><div class="t m0 x32 h50 yd4d ff19 fs29 fc0 sc0 lsdf ws0">re<span class="ls0">sults <span class="_ _4b"> </span>in <span class="_ _4b"> </span>Figur<span class="ls42d">e3<span class="_ _64"></span><span class="ls0">.6 <span class="_ _4b"> </span>wer<span class="ls42d">em<span class="_ _64"></span><span class="ls0">easured <span class="_ _4b"> </span>while <span class="_ _4b"> </span>reading <span class="_ _44"> </span>a <span class="_ _4b"> </span>disk <span class="_ _59"> </span>ﬁle <span class="_ _4b"> </span>and <span class="_ _4b"> </span>writing <span class="_ _4b"> </span>to</span></span></span></span></span></div><div class="t m0 x32 h5c yd4e ff1a fs29 fc0 sc0 ls0 ws0">/dev/null<span class="ff19">,<span class="_"> </span>so<span class="_"> </span>ther<span class="ls42e">ew<span class="_ _4f"></span><span class="ls0">as <span class="_ _2"></span>no disk output.<span class="_ _46"> </span>The second row in Figur<span class="ls42f">e3<span class="_ _4f"></span><span class="ls0">.13 <span class="_ _2"></span>corresponds to</span></span></span></span></span></div><div class="t m0 x32 h50 yd4f ff19 fs29 fc0 sc0 lsdf ws0">re<span class="ls0">ading <span class="_ _42"> </span>a <span class="_ _42"> </span>disk <span class="_ _42"> </span>ﬁle <span class="_ _23"> </span>and <span class="_ _42"> </span>writing <span class="_ _42"> </span>to <span class="_ _23"> </span>another <span class="_ _42"> </span>disk <span class="_ _42"> </span>ﬁle.<span class="_ _54"> </span>This <span class="_ _23"> </span>is <span class="_ _42"> </span>why <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁrst <span class="_ _23"> </span>and <span class="_ _42"> </span>second</span></div><div class="t m0 x32 h50 yd50 ff19 fs29 fc0 sc0 lsdf ws0">ro<span class="ls0">ws <span class="_ _23"> </span>in <span class="_ _23"> </span>Figur<span class="ls430">e3<span class="_ _43"></span><span class="ls0">.13 <span class="_ _23"> </span>ar<span class="ls430">ed<span class="_ _43"></span><span class="ls0">ifferent. <span class="_ _45"> </span>The<span class="_ _35"> </span>system <span class="_ _23"> </span>time <span class="_ _23"> </span>increases <span class="_ _23"></span>when <span class="_ _23"></span>we <span class="_ _23"></span>write <span class="_ _23"></span>to <span class="_ _23"></span>a <span class="_ _23"></span>disk</span></span></span></span></span></div><div class="t m0 x32 h50 yd51 ff19 fs29 fc0 sc0 ls0 ws0">ﬁle, <span class="_ _9"></span>because <span class="_ _23"></span>the <span class="_ _9"></span>kernel <span class="_ _23"></span>now <span class="_ _9"></span>copies <span class="_ _9"></span>the <span class="_ _23"></span>data <span class="_ _9"></span>from <span class="_ _9"></span>our <span class="_ _23"></span>pr<span class="_ _0"></span>ocess <span class="_ _9"></span>and <span class="_ _23"></span>queues <span class="_ _9"></span>the <span class="_ _23"></span>data <span class="_ _9"></span>for</div><div class="t m0 x32 h50 yd52 ff19 fs29 fc0 sc0 ls0 ws0">writing <span class="_ _3"></span>by <span class="_ _3"></span>the <span class="_ _3"></span>disk <span class="_ _3"></span>driver<span class="_ _1"></span><span class="ls431">.W<span class="_ _7"></span><span class="ls432">ee<span class="_ _8"></span><span class="ls0">xpect <span class="_ _3"></span>the <span class="_ _3"></span>clock <span class="_ _3"></span>time <span class="_ _9"></span>to <span class="_ _3"></span>increase <span class="_ _2"></span>as <span class="_ _3"></span>well <span class="_ _3"></span>when <span class="_ _9"></span>we <span class="_ _3"></span>write</span></span></span></div><div class="t m0 x32 h50 yd53 ff19 fs29 fc0 sc0 ls0 ws0">to a disk ﬁle.</div><div class="t m0 x3f h50 yd54 ff19 fs29 fc0 sc0 ls0 ws0">When <span class="_ _23"> </span>we <span class="_ _23"> </span>enable <span class="_ _42"> </span>synchronous <span class="_ _23"></span>writes, <span class="_ _23"> </span>the <span class="_ _23"> </span>system <span class="_ _42"> </span>and <span class="_ _23"> </span>clock <span class="_ _23"> </span>times <span class="_ _42"> </span>should <span class="_ _23"> </span>increase</div><div class="t m0 x32 h50 yd55 ff19 fs29 fc0 sc0 ls0 ws0">signiﬁcantly<span class="_ _4"></span><span class="ls433">.A<span class="_ _1d"></span><span class="ls434">st<span class="_ _4f"></span><span class="ls0">he <span class="_ _3"></span>thir<span class="ls434">dr<span class="_ _b"></span><span class="ls0">ow <span class="_ _3"></span>shows, <span class="_ _3"></span>the <span class="_ _2"></span>system <span class="_ _3"></span>time <span class="_ _3"></span>for <span class="_ _3"></span>writing <span class="_ _3"></span>synchronously <span class="_ _2"></span>is <span class="_ _3"></span>not</span></span></span></span></span></div><div class="t m0 x32 h50 yd56 ff19 fs29 fc0 sc0 ls0 ws0">much <span class="_ _3"></span>mor<span class="ls435">ee<span class="_ _b"></span><span class="ls0">xpensive <span class="_ _9"></span>than <span class="_ _9"></span>when <span class="_ _3"></span>we <span class="_ _9"></span>used <span class="_ _9"></span>delayed <span class="_ _9"></span>writes.<span class="_ _16"> </span>This <span class="_ _9"></span>implies <span class="_ _9"></span>that <span class="_ _3"></span>the <span class="_ _9"></span>Linux</span></span></div><div class="t m0 x32 h50 yd57 ff19 fs29 fc0 sc0 ls0 ws0">operating <span class="_"> </span>system <span class="_ _e"> </span>is <span class="_"> </span>doing <span class="_"> </span>the <span class="_"> </span>same <span class="_ _e"> </span>amount <span class="_"> </span>of <span class="_"> </span>work <span class="_ _e"> </span>for <span class="_"> </span>delayed <span class="_"> </span>and <span class="_"> </span>synchr<span class="_ _0"></span>onous</div><div class="t m0 x32 h5c yd58 ff19 fs29 fc0 sc0 ls0 ws0">writes (which is <span class="_ _2"></span>unlikely), or <span class="_ _2"></span>else the<span class="_ _66"> </span><span class="ff1a">O_SYNC<span class="_ _66"> </span></span>ﬂag isn’t <span class="_ _2"></span>having the desired effect. <span class="_"> </span>In<span class="_"> </span>this</div><div class="t m0 x32 h5c yd59 ff19 fs29 fc0 sc0 ls0 ws0">case, <span class="_ _3"></span>the <span class="_ _3"></span>Linux <span class="_ _3"></span>operating <span class="_ _3"></span>system <span class="_ _3"></span>isn’t <span class="_ _3"></span>allowing <span class="_ _3"></span>us <span class="_ _3"></span>to <span class="_ _3"></span>set <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">O_SYNC<span class="_ _66"> </span></span>ﬂag <span class="_ _9"></span>using<span class="_ _47"> </span><span class="ff1a">fcntl</span>,</div><div class="t m0 x32 h50 yd5a ff19 fs29 fc0 sc0 ls0 ws0">instead <span class="_ _42"> </span>failing <span class="_ _42"> </span>without <span class="_ _53"> </span>returning <span class="_ _42"> </span>an <span class="_ _42"> </span>error <span class="_ _42"> </span>(but <span class="_ _42"> </span>it <span class="_ _53"> </span>would <span class="_ _42"> </span>have <span class="_ _42"> </span>honored <span class="_ _42"> </span>the <span class="_ _53"> </span>ﬂag <span class="_ _42"> </span>if <span class="_ _42"> </span>we</div><div class="t m0 x32 h50 yd5b ff19 fs29 fc0 sc0 ls0 ws0">wer<span class="lsdd">ea<span class="_ _4f"></span><span class="ls0">ble to specify it when the ﬁle was opened).</span></span></div><div class="t m0 x3f h50 yd5c ff19 fs29 fc0 sc0 ls0 ws0">The <span class="_ _2"></span>clock <span class="_ _3"></span>time <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>last <span class="_ _3"></span>three <span class="_ _2"></span>rows <span class="_ _2"></span>reﬂects <span class="_ _2"></span>the <span class="_ _3"></span>extra <span class="_ _2"></span>time <span class="_ _3"></span>needed <span class="_ _3"></span>to <span class="_ _2"></span>wait <span class="_ _3"></span>for <span class="_ _3"></span>all <span class="_ _3"></span>of</div><div class="t m0 x32 h50 yd5d ff19 fs29 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>writes <span class="_ _3"></span>to <span class="_ _3"></span>be <span class="_ _2"></span>committed <span class="_ _3"></span>to <span class="_ _3"></span>disk.<span class="_ _61"> </span>After <span class="_ _3"></span>writing <span class="_ _2"></span>a <span class="_ _3"></span>ﬁle <span class="_ _3"></span>synchronously<span class="_ _4"></span>,<span class="_ _47"> </span>we<span class="_ _47"> </span>expect <span class="_ _2"></span>that <span class="_ _3"></span>a</div><div class="t m0 x32 h5c yd5e ff19 fs29 fc0 sc0 ls0 ws0">call <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">fsync<span class="_ _35"> </span></span>will <span class="_ _23"></span>have <span class="_ _23"></span>no <span class="_ _23"></span>effect. <span class="_ _45"> </span>This<span class="_ _35"> </span>case <span class="_ _9"></span>is <span class="_ _23"> </span>supposed <span class="_ _23"> </span>to <span class="_ _23"> </span>be <span class="_ _23"></span>repr<span class="_ _0"></span>esented <span class="_ _23"></span>by <span class="_ _9"></span>the <span class="_ _23"> </span>last</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
