<div id="pf31b" class="pf w4 h1f" data-page-no="31b"><div class="pc pc31b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg31b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">761</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">171 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">172 <span class="_ _8a"> </span>*<span class="_"> </span>Allocate an index buffer and a data buffer.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">173 <span class="_ _8a"> </span>*<span class="_"> </span>+2 for newline and null at end.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">174 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">175 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;idxbuf = malloc(IDXLEN_MAX + 2)) == NULL)</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">176 <span class="_ _186"> </span>err_dump(&quot;_db_alloc:<span class="_"> </span>malloc error for index buffer&quot;);</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">177 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;datbuf = malloc(DATLEN_MAX + 2)) == NULL)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">178 <span class="_ _186"> </span>err_dump(&quot;_db_alloc:<span class="_"> </span>malloc error for data buffer&quot;);</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">179 <span class="_ _15"> </span>return(db);</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">180 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y1fbc ff1a fs2d fc0 sc0 ls0 ws0">181 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y1fbd ff1a fs2d fc0 sc0 ls0 ws0">182 <span class="_ _68"> </span>*<span class="_"> </span>Relinquish access to the database.</div><div class="t m0 x32 h57 y1fbe ff1a fs2d fc0 sc0 ls0 ws0">183 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y1fbf ff1a fs2d fc0 sc0 ls0 ws0">184 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y1fc0 ff1a fs2d fc0 sc0 ls0 ws0">185 <span class="_ _d9"> </span>db_close(DBHANDLE<span class="_"> </span>h)</div><div class="t m0 x32 h57 y1fc1 ff1a fs2d fc0 sc0 ls0 ws0">186 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">187 <span class="_ _15"> </span>_db_free((DB<span class="_"> </span>*)h); <span class="_"> </span>/*<span class="_"> </span>closes fds, free buffers &amp; struct */</div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">188 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y458a ff1a fs2d fc0 sc0 ls0 ws0">189 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y458b ff1a fs2d fc0 sc0 ls0 ws0">190 <span class="_ _68"> </span>*<span class="_"> </span>Free up a DB structure, and all the malloc’ed buffers it</div><div class="t m0 x32 h57 y458c ff1a fs2d fc0 sc0 ls0 ws0">191 <span class="_ _68"> </span>*<span class="_"> </span>may point to.<span class="_ _3a"> </span>Also close the file descriptors if still open.</div><div class="t m0 x32 h57 y2ada ff1a fs2d fc0 sc0 ls0 ws0">192 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y2adb ff1a fs2d fc0 sc0 ls0 ws0">193 <span class="_ _d9"> </span>static<span class="_"> </span>void</div><div class="t m0 x32 h57 y2adc ff1a fs2d fc0 sc0 ls0 ws0">194 <span class="_ _d9"> </span>_db_free(DB<span class="_"> </span>*db)</div><div class="t m0 x32 h57 y2add ff1a fs2d fc0 sc0 ls0 ws0">195 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y2ade ff1a fs2d fc0 sc0 ls0 ws0">196 <span class="_ _15"> </span>if<span class="_"> </span>(db-&gt;idxfd &gt;= 0)</div><div class="t m0 x32 h57 y2c66 ff1a fs2d fc0 sc0 ls0 ws0">197 <span class="_ _186"> </span>close(db-&gt;idxfd);</div><div class="t m0 x32 h57 y2c67 ff1a fs2d fc0 sc0 ls0 ws0">198 <span class="_ _15"> </span>if<span class="_"> </span>(db-&gt;datfd &gt;= 0)</div><div class="t m0 x32 h57 y573f ff1a fs2d fc0 sc0 ls0 ws0">199 <span class="_ _186"> </span>close(db-&gt;datfd);</div><div class="t m0 x32 h49 y5740 ff19 fs26 fc0 sc0 ls0 ws0">[171 <span class="_ _a"></span>– <span class="_ _a"></span>180]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>a<span class="_ _9"></span></span>llocate space for buffers for the index and data ﬁles.<span class="_ _46"> </span>The buffer sizes ar<span class="_ _0"></span>e</div><div class="t m0 x11a h4d y5741 ff19 fs26 fc0 sc0 ls0 ws0">deﬁned <span class="_ _9"></span>in<span class="_ _35"> </span><span class="ff1a">apue_db.h</span><span class="ls1673">.A<span class="_ _26"></span><span class="ls701">ne<span class="_ _b"></span><span class="ls0">nhancement <span class="_ _9"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>database <span class="_ _23"></span>library <span class="_ _9"></span>would <span class="_ _23"></span>be</span></span></span></div><div class="t m0 x11a h49 y5742 ff19 fs26 fc0 sc0 ls0 ws0">to allow <span class="_ _2"></span>these buffers to <span class="_ _2"></span>expand <span class="_ _2"></span>as required. <span class="_"> </span>W<span class="_ _6"></span><span class="ls10ec">ec<span class="_ _4f"></span><span class="ls0">ould <span class="_ _2"></span>keep <span class="_ _2"></span>track of <span class="_ _2"></span>the <span class="_ _2"></span>size</span></span></div><div class="t m0 x11a h4d y5743 ff19 fs26 fc0 sc0 ls0 ws0">of <span class="_ _9"></span>these <span class="_ _9"></span>two <span class="_ _3"></span>buffers <span class="_ _9"></span>and <span class="_ _9"></span>call<span class="_ _45"> </span><span class="ff1a">realloc<span class="_ _47"> </span></span>whenever <span class="_ _9"></span>we <span class="_ _9"></span>ﬁnd <span class="_ _9"></span>we <span class="_ _9"></span>need <span class="_ _9"></span>a <span class="_ _9"></span>bigger</div><div class="t m0 x11a h4d y5744 ff19 fs26 fc0 sc0 ls0 ws0">buffer<span class="_ _6"></span><span class="ls199">.F<span class="_ _4a"></span><span class="ls0">inally<span class="_ _4"></span>,<span class="_"> </span>we<span class="_"> </span>return a pointer to the<span class="_"> </span><span class="ff1a">DB<span class="_ _80"> </span></span>structur<span class="lsd3">et<span class="_ _4f"></span><span class="ls0">hat we allocated.</span></span></span></span></div><div class="t m0 x32 h4d y5745 ff19 fs26 fc0 sc0 ls0 ws0">[181 <span class="_ _a"></span>– <span class="_ _a"></span>188]<span class="_ _65"> </span>The<span class="_ _35"> </span><span class="ff1a">db_close<span class="_ _35"> </span></span>function <span class="_ _23"> </span>is <span class="_ _23"> </span>a <span class="_ _42"> </span>wrapper <span class="_ _23"> </span>that <span class="_ _23"> </span>casts <span class="_ _42"> </span>a <span class="_ _23"></span>database <span class="_ _23"> </span>handle <span class="_ _23"> </span>to <span class="_ _42"> </span>a<span class="_ _35"> </span><span class="ff1a">DB</span></div><div class="t m0 x11a h4d y5746 ff19 fs26 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span><span class="ls1674">ep<span class="_ _b"></span><span class="ls0">ointer<span class="_ _6"></span><span class="ls1675">,p<span class="_ _b"></span><span class="ls0">assing <span class="_ _9"></span>it <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">_db_free<span class="_ _35"> </span></span>to <span class="_ _9"></span>release <span class="_ _9"></span>any <span class="_ _23"></span>resour<span class="_ _0"></span>ces <span class="_ _9"></span>and <span class="_ _23"></span>free</span></span></span></span></div><div class="t m0 x11a h4d y5747 ff19 fs26 fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">DB<span class="_ _80"> </span></span>structure.</div><div class="t m0 x32 h4d y5748 ff19 fs26 fc0 sc0 ls0 ws0">[189 <span class="_ _a"></span>– <span class="_ _a"></span>199]<span class="_ _65"> </span>The<span class="_ _61"> </span><span class="ff1a">_db_free<span class="_ _61"> </span></span>function <span class="_ _47"> </span>is <span class="_ _47"> </span>called <span class="_ _47"> </span>by<span class="_ _61"> </span><span class="ff1a">db_open<span class="_ _61"> </span></span>if <span class="_ _47"> </span>an <span class="_ _47"> </span>error <span class="_"> </span>occurs <span class="_ _47"> </span>while</div><div class="t m0 x11a h4d y5749 ff19 fs26 fc0 sc0 ls0 ws0">opening <span class="_ _9"></span>the <span class="_ _3"></span>index <span class="_ _9"></span>ﬁle <span class="_ _9"></span>or <span class="_ _9"></span>data <span class="_ _9"></span>ﬁle <span class="_ _9"></span>and <span class="_ _9"></span>is <span class="_ _9"></span>also <span class="_ _9"></span>called <span class="_ _3"></span>by<span class="_ _45"> </span><span class="ff1a">db_close<span class="_ _45"> </span></span>when <span class="_ _3"></span>an</div><div class="t m0 x11a h49 y574a ff19 fs26 fc0 sc0 ls0 ws0">application <span class="_ _2"></span>is <span class="_ _2"></span>done <span class="_ _2"></span>using <span class="_ _2"></span>the <span class="_ _2"></span>database.<span class="_ _61"> </span>If <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _3"></span>descriptor <span class="_ _2"></span>for <span class="_ _2"></span>the <span class="_ _2"></span>database</div><div class="t m0 x11a h49 y574b ff19 fs26 fc0 sc0 ls0 ws0">index <span class="_ _3"></span>ﬁle <span class="_ _9"></span>is <span class="_ _9"></span>valid, <span class="_ _3"></span>we <span class="_ _9"></span>close <span class="_ _3"></span>it.<span class="_ _5a"> </span>The <span class="_ _9"></span>same <span class="_ _3"></span>is <span class="_ _9"></span>done <span class="_ _3"></span>with <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _3"></span>descriptor <span class="_ _9"></span>for</div><div class="t m0 x11a h4d y574c ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _4b"> </span>data <span class="_ _4b"> </span>ﬁle.<span class="_ _7f"> </span>(Recall <span class="_ _4b"> </span>that <span class="_ _59"> </span>when <span class="_ _4b"> </span>we <span class="_ _4b"> </span>allocate <span class="_ _4b"> </span>a <span class="_ _59"> </span>new<span class="_ _65"> </span><span class="ff1a">DB<span class="_ _48"> </span></span>structur<span class="ls1676">ei<span class="_ _5d"></span><span class="ls0">n</span></span></div><div class="t m0 x11a h4d y574d ff1a fs26 fc0 sc0 ls0 ws0">_db_alloc<span class="ff19">,<span class="_"> </span>we<span class="_ _66"> </span>initialize <span class="_ _2"></span>each ﬁle <span class="_ _2"></span>descriptor <span class="_ _2"></span>to<span class="_"> </span><span class="ff20">−</span>1. <span class="_ _66"> </span>If<span class="_ _66"> </span>we <span class="_ _2"></span>ar<span class="ls1677">eu<span class="_ _4f"></span><span class="ls0">nable <span class="_ _2"></span>to open</span></span></span></div><div class="t m0 x11a h49 y574e ff19 fs26 fc0 sc0 ls0 ws0">one <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>database <span class="_ _3"></span>ﬁles, <span class="_ _9"></span>the <span class="_ _3"></span>corresponding <span class="_ _2"></span>ﬁle <span class="_ _9"></span>descriptor <span class="_ _3"></span>will <span class="_ _3"></span>still <span class="_ _3"></span>be <span class="_ _3"></span>set <span class="_ _9"></span>to</div><div class="t m0 x11a h49 y574f ff20 fs26 fc0 sc0 ls0 ws0">−<span class="ff19">1, and we will avoid trying to close it.)</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
