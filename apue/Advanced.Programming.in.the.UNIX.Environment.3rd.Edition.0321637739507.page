<div id="pf1fb" class="pf w4 h1f" data-page-no="1fb"><div class="pc pc1fb w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1fb.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>13.5<span class="_ _1fd"> </span>Single-Instance <span class="_"> </span>Daemons<span class="_ _1fb"> </span><span class="ff18">473</span></div><div class="t m0 x76 h52 y2a3 ff19 fs2a fc0 sc0 ls0 ws0">you <span class="_ _42"> </span>might <span class="_"> </span>need <span class="_ _23"> </span>to <span class="_"> </span>deﬁne <span class="_ _42"> </span>an <span class="_ _42"> </span>additional <span class="_ _42"> </span>symbol, <span class="_"> </span>such <span class="_ _42"> </span>as<span class="_ _45"> </span><span class="ff1a lsf8b">__<span class="_ _4"></span><span class="ls0">BSD_VISIBLE<span class="_ _35"> </span><span class="ff19">on <span class="_ _42"> </span>FreeBSD <span class="_ _42"> </span>or</span></span></span></div><div class="t m0 x76 h52 y2a4 ff1a fs2a fc0 sc0 lsf8b ws0">__<span class="_ _4"></span><span class="ls0">USE_BSD<span class="_ _53"> </span><span class="ff19">on Linux.</span></span></div><div class="t m0 x3f h26 y150 ff19 fsf fc0 sc0 ls0 ws0">Most<span class="_ _51"> </span><span class="ff1a">syslogd<span class="_ _51"> </span></span>implementations <span class="_ _35"> </span>will <span class="_ _35"> </span>queue <span class="_ _44"> </span>messages <span class="_ _35"> </span>for <span class="_ _35"> </span>a <span class="_ _35"> </span>short <span class="_ _35"> </span>time.<span class="_ _98"> </span>If <span class="_ _35"> </span>a</div><div class="t m0 x32 h26 y151 ff19 fsf fc0 sc0 ls0 ws0">duplicate <span class="_ _23"></span>message <span class="_ _9"></span>arrives <span class="_ _23"></span>during <span class="_ _23"></span>this <span class="_ _9"></span>period, <span class="_ _23"> </span>the<span class="_ _45"> </span><span class="ff1a">syslog<span class="_ _35"> </span></span>daemon <span class="_ _23"></span>will <span class="_ _9"></span>not <span class="_ _23"> </span>write <span class="_ _23"></span>it <span class="_ _9"></span>to</div><div class="t m0 x32 h2b ya63 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _e"> </span>log.<span class="_ _48"> </span>Instead, <span class="_ _e"> </span>the <span class="_ _e"> </span>daemon <span class="_ _e"> </span>prints <span class="_ _e"> </span>a <span class="_"> </span>message <span class="_ _53"> </span>similar <span class="_ _e"> </span>to <span class="_ _e"> </span>‘‘last <span class="_ _53"> </span>message <span class="_ _e"> </span>repeated<span class="_ _4b"> </span><span class="ff1b">N</span></div><div class="t m0 x32 h2a y31e ff19 fsf fc0 sc0 ls0 ws0">times.’<span class="_ _0"></span>’</div><div class="t m0 x35 h53 y198a ff16 fs2b fc0 sc0 ls0 ws0">13.5 <span class="_ _93"> </span>Single-Instance<span class="_ _54"> </span>Daemons</div><div class="t m0 x32 h2a y3a7c ff19 fsf fc0 sc0 ls0 ws0">Some <span class="_ _23"> </span>daemons <span class="_ _42"> </span>ar<span class="ls26b">ei<span class="_ _43"></span><span class="ls0">mplemented <span class="_ _23"></span>so <span class="_ _23"> </span>that <span class="_ _42"> </span>only <span class="_ _23"></span>a <span class="_ _23"> </span>single <span class="_ _42"> </span>copy <span class="_ _23"> </span>of <span class="_ _42"> </span>the <span class="_ _23"> </span>daemon <span class="_ _23"> </span>should <span class="_ _42"> </span>be</span></span></div><div class="t m0 x32 h2a y3a7d ff19 fsf fc0 sc0 ls4e ws0">ru<span class="ls0">nning at a <span class="_ _2"></span>time for proper operation.<span class="_ _46"> </span>Such a daemon <span class="_ _2"></span>might need exclusive access <span class="_ _2"></span>to a</span></div><div class="t m0 x32 h26 y3a7e ff19 fsf fc0 sc0 ls0 ws0">device, <span class="_ _47"> </span>for <span class="_ _66"> </span>example.<span class="_ _5f"> </span>In <span class="_ _47"> </span>the <span class="_ _47"> </span>case <span class="_ _47"> </span>of <span class="_ _66"> </span>the<span class="_ _16"> </span><span class="ff1a">cron<span class="_ _16"> </span></span>daemon, <span class="_ _47"> </span>if <span class="_ _47"> </span>multiple <span class="_ _66"> </span>instances <span class="_ _47"> </span>were</div><div class="t m0 x32 h2a y3a7f ff19 fsf fc0 sc0 ls4e ws0">ru<span class="ls0">nning, <span class="_ _35"> </span>each <span class="_ _45"> </span>copy <span class="_ _45"> </span>might <span class="_ _35"> </span>try <span class="_ _45"> </span>to <span class="_ _35"> </span>start <span class="_ _45"> </span>a <span class="_ _35"> </span>single <span class="_ _45"> </span>scheduled <span class="_ _35"> </span>operation, <span class="_ _45"> </span>resulting <span class="_ _45"> </span>in</span></div><div class="t m0 x32 h2a y3a80 ff19 fsf fc0 sc0 ls0 ws0">duplicate operations and probably an err<span class="_ _0"></span>or<span class="_ _6"></span>.</div><div class="t m0 x3f h2a y3a81 ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _23"> </span>the <span class="_ _23"> </span>daemon <span class="_ _23"> </span>needs <span class="_ _42"> </span>to <span class="_ _23"> </span>access <span class="_ _23"> </span>a <span class="_ _23"> </span>device, <span class="_ _42"> </span>the <span class="_ _23"></span>device <span class="_ _23"> </span>driver <span class="_ _23"> </span>will <span class="_ _42"> </span>sometimes <span class="_ _23"></span>prevent</div><div class="t m0 x32 h26 y3a82 ff19 fsf fc0 sc0 ls0 ws0">multiple <span class="_ _9"></span>attempts <span class="_ _9"></span>to <span class="_ _9"></span>open <span class="_ _3"></span>the <span class="_ _9"></span>corresponding <span class="_ _9"></span>device <span class="_ _9"></span>node <span class="_ _9"></span>in<span class="_ _45"> </span><span class="ff1a">/dev</span><span class="lsf8c">.T<span class="_ _26"></span><span class="ls0">his <span class="_ _9"></span>restricts <span class="_ _9"></span>us <span class="_ _9"></span>to</span></span></div><div class="t m0 x32 h2a y3a83 ff19 fsf fc0 sc0 ls0 ws0">one <span class="_ _3"></span>copy <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>daemon <span class="_ _3"></span>running <span class="_ _3"></span>at <span class="_ _3"></span>a <span class="_ _3"></span>time.<span class="_ _16"> </span>If <span class="_ _9"></span>no <span class="_ _3"></span>such <span class="_ _3"></span>device <span class="_ _3"></span>is <span class="_ _9"></span>available, <span class="_ _3"></span>however<span class="_ _1"></span><span class="lscb9">,w<span class="_ _8"></span><span class="ls0">e</span></span></div><div class="t m0 x32 h2a y3a84 ff19 fsf fc0 sc0 ls0 ws0">need to do the work ourselves.</div><div class="t m0 x3f h2a y3a85 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _23"> </span>ﬁle- <span class="_ _23"> </span>and <span class="_ _42"> </span>recor<span class="_ _1"></span>d</div><div class="t m0 x1d0 h2a y3a86 ff19 fsf fc0 sc0 ls0 ws0">-</div><div class="t m0 x2f h2a y3a85 ff19 fsf fc0 sc0 ls0 ws0">locking <span class="_ _23"> </span>mechanism <span class="_ _23"> </span>provides <span class="_ _23"> </span>the <span class="_ _23"> </span>basis <span class="_ _42"> </span>for <span class="_ _23"> </span>one <span class="_ _23"> </span>way <span class="_ _42"> </span>to <span class="_ _23"> </span>ensure</div><div class="t m0 x32 h2a y3a87 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _e"> </span>only <span class="_"> </span>one <span class="_ _53"> </span>copy <span class="_"> </span>of <span class="_ _53"> </span>a <span class="_"> </span>daemon <span class="_ _e"> </span>is <span class="_ _e"> </span>running. <span class="_"> </span>(W<span class="_ _4"></span><span class="lsf8d">ed<span class="_ _55"></span><span class="ls0">iscuss <span class="_"> </span>ﬁle <span class="_ _53"> </span>and <span class="_"> </span>r<span class="_ _0"></span>ecor<span class="lsf8e">dl<span class="_ _4a"></span><span class="ls0">ocking <span class="_ _e"> </span>in</span></span></span></span></div><div class="t m0 x32 h2a y3a88 ff19 fsf fc0 sc0 ls0 ws0">Section <span class="_ _2"></span>14.3.) <span class="_ _2"></span>If <span class="_ _3"></span>each <span class="_ _2"></span>daemon <span class="_ _3"></span>creates a <span class="_ _3"></span>ﬁle <span class="_ _2"></span>with <span class="_ _2"></span>a <span class="_ _3"></span>ﬁxed <span class="_ _2"></span>name <span class="_ _3"></span>and <span class="_ _2"></span>places <span class="_ _2"></span>a <span class="_ _3"></span>write <span class="_ _2"></span>lock <span class="_ _3"></span>on</div><div class="t m0 x32 h2a y3a89 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_"> </span>entir<span class="lsf8f">eﬁ<span class="_ _5b"></span><span class="ls0">le, <span class="_"> </span>only <span class="_"> </span>one <span class="_ _66"> </span>such <span class="_"> </span>write <span class="_"> </span>lock <span class="_ _66"> </span>will <span class="_"> </span>be <span class="_"> </span>allowed <span class="_ _66"> </span>to <span class="_"> </span>be <span class="_"> </span>created. <span class="_ _46"> </span>Successive</span></span></div><div class="t m0 x32 h2a y3a8a ff19 fsf fc0 sc0 ls0 ws0">attempts <span class="_ _9"></span>to <span class="_ _9"></span>create <span class="_ _9"></span>write <span class="_ _23"></span>locks <span class="_ _9"></span>will <span class="_ _9"></span>fail, <span class="_ _23"></span>serving <span class="_ _9"></span>as <span class="_ _9"></span>an <span class="_ _9"></span>indication <span class="_ _23"></span>to <span class="_ _9"></span>successive <span class="_ _9"></span>copies <span class="_ _23"></span>of</div><div class="t m0 x32 h2a y3a8b ff19 fsf fc0 sc0 ls0 ws0">the daemon that another instance is already r<span class="_ _0"></span>unning.</div><div class="t m0 x3f h2a y3a8c ff19 fsf fc0 sc0 ls0 ws0">File <span class="_ _3"></span>and <span class="_ _9"></span>recor<span class="_ _0"></span><span class="ls47b">dl<span class="_ _b"></span><span class="ls0">ocking <span class="_ _9"></span>provides <span class="_ _2"></span>a <span class="_ _9"></span>convenient <span class="_ _3"></span>mutual-exclusion <span class="_ _9"></span>mechanism.<span class="_ _16"> </span>If <span class="_ _9"></span>the</span></span></div><div class="t m0 x32 h2a y3a8d ff19 fsf fc0 sc0 ls0 ws0">daemon <span class="_ _3"></span>obtains <span class="_ _2"></span>a <span class="_ _3"></span>write-lock <span class="_ _3"></span>on <span class="_ _3"></span>an <span class="_ _3"></span>entir<span class="lsf90">eﬁ<span class="_ _8"></span><span class="ls0">le, <span class="_ _3"></span>the <span class="_ _3"></span>lock <span class="_ _3"></span>will <span class="_ _3"></span>be <span class="_ _3"></span>removed <span class="_ _2"></span>automatically <span class="_ _3"></span>if</span></span></div><div class="t m0 x32 h2a y3a8e ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _2"></span>daemon <span class="_ _2"></span>exits.<span class="_ _46"> </span>This <span class="_ _2"></span>simpliﬁes <span class="_ _2"></span>recovery<span class="_ _4"></span><span class="lsa7d">,e<span class="_ _d"></span><span class="ls0">liminating <span class="_ _2"></span>the <span class="_ _2"></span>need <span class="_ _2"></span>for <span class="_ _2"></span>us <span class="_ _2"></span>to <span class="_ _2"></span>clean <span class="_ _2"></span>up <span class="_ _2"></span>from</span></span></div><div class="t m0 x32 h2a y3a8f ff19 fsf fc0 sc0 ls0 ws0">the previous instance of the daemon.</div><div class="t m0 x35 h27 y3a90 ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y3a91 ff19 fsf fc0 sc0 ls0 ws0">The function <span class="_ _2"></span>shown <span class="_ _2"></span>in <span class="_ _2"></span>Figur<span class="lsf91">e1<span class="_ _4f"></span><span class="ls0">3.6 illustrates <span class="_ _2"></span>the <span class="_ _2"></span>use <span class="_ _2"></span>of <span class="_ _2"></span>ﬁle and <span class="_ _2"></span>recor<span class="lsf69">dl<span class="_ _8"></span><span class="ls0">ocking <span class="_ _2"></span>to <span class="_ _2"></span>ensure</span></span></span></span></div><div class="t m0 x32 h2a y3a92 ff19 fsf fc0 sc0 ls0 ws0">that only one copy of a daemon is running.</div><div class="t m0 x32 h4e y3a93 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x32 h4e y3a94 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;stdlib.h&gt;</div><div class="t m0 x32 h4e y3a95 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h4e y3a96 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;syslog.h&gt;</div><div class="t m0 x32 h4e y3a97 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;string.h&gt;</div><div class="t m0 x32 h4e y3a98 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h4e y3a99 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;stdio.h&gt;</div><div class="t m0 x32 h4e y3a9a ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/stat.h&gt;</div><div class="t m0 x32 h4e y3a9b ff1a fs28 fc0 sc0 ls0 ws0">#define LOCKFILE &quot;/var/run/daemon.pid&quot;</div><div class="t m0 x32 h4e y3a9c ff1a fs28 fc0 sc0 ls0 ws0">#define LOCKMODE (S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH)</div><div class="t m0 x32 h4e y3a9d ff1a fs28 fc0 sc0 ls0 ws0">extern int lockfile(int);</div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.891993px;bottom:1027.128966px;width:185.376014px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
