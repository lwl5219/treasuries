<div id="pf2bb" class="pf w4 h1f" data-page-no="2bb"><div class="pc pc2bb w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg2bb.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>17.6<span class="_ _67"> </span>An <span class="_"> </span>Open <span class="_"> </span>Server<span class="_ _6"></span><span class="ls30a">,V<span class="_ _1d"></span><span class="ls0">ersion <span class="_"> </span>2<span class="_ _1b"> </span><span class="ff18">665</span></span></span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">for ( ; ; ) {</div><div class="t m0 x9d h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">rset = allset;<span class="_ _d9"> </span>/* rset gets modified each time around */</div><div class="t m0 x9d h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">if ((n = select(maxfd + 1, &amp;rset, NULL, NULL, NULL)) &lt; 0)</div><div class="t m0 x1f h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">log_sys(&quot;select error&quot;);</div><div class="t m0 x9d h57 y124b ff1a fs2d fc0 sc0 ls0 ws0">if (FD_ISSET(listenfd, &amp;rset)) {</div><div class="t m0 x1f h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">/* accept new client request */</div><div class="t m0 x1f h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">if ((clifd = serv_accept(listenfd, &amp;uid)) &lt; 0)</div><div class="t m0 x1ca h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">log_sys(&quot;serv_accept error: %d&quot;, clifd);</div><div class="t m0 x1f h57 y124f ff1a fs2d fc0 sc0 ls15c ws0">i=c<span class="_ _1d"></span><span class="ls0">lient_add(clifd, uid);</span></div><div class="t m0 x1f h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">FD_SET(clifd, &amp;allset);</div><div class="t m0 x1f h57 y8d8 ff1a fs2d fc0 sc0 ls0 ws0">if (clifd &gt; maxfd)</div><div class="t m0 x1ca h57 y8d9 ff1a fs2d fc0 sc0 ls0 ws0">maxfd = clifd;<span class="_ _d9"> </span>/* max fd for select() */</div><div class="t m0 x1f h57 y8da ff1a fs2d fc0 sc0 ls0 ws0">if (i &gt; maxi)</div><div class="t m0 x1ca h57 y8db ff1a fs2d fc0 sc0 ls0 ws0">maxi = i;<span class="_ _68"> </span>/* max index in client[] array */</div><div class="t m0 x1f h57 y8dc ff1a fs2d fc0 sc0 ls0 ws0">log_msg(&quot;new connection: uid %d, fd %d&quot;, uid, clifd);</div><div class="t m0 x1f h57 y8dd ff1a fs2d fc0 sc0 ls0 ws0">continue;</div><div class="t m0 x9d h57 y8de ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y2f73 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt;= maxi; i++) {<span class="_ _68"> </span>/* go through client[] array */</div><div class="t m0 x1f h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">if ((clifd = client[i].fd) &lt; 0)</div><div class="t m0 x1ca h57 y8e1 ff1a fs2d fc0 sc0 ls0 ws0">continue;</div><div class="t m0 x1f h57 y2f74 ff1a fs2d fc0 sc0 ls0 ws0">if (FD_ISSET(clifd, &amp;rset)) {</div><div class="t m0 x1ca h57 y2f75 ff1a fs2d fc0 sc0 ls0 ws0">/* read argument buffer from client */</div><div class="t m0 x1ca h57 y2f76 ff1a fs2d fc0 sc0 ls0 ws0">if ((nread = read(clifd, buf, MAXLINE)) &lt; 0) {</div><div class="t m0 x36 h57 y2f77 ff1a fs2d fc0 sc0 ls0 ws0">log_sys(&quot;read error on fd %d&quot;, clifd);</div><div class="t m0 x1ca h57 y31bc ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (nread == 0) {</span></div><div class="t m0 x36 h57 y3264 ff1a fs2d fc0 sc0 ls0 ws0">log_msg(&quot;closed: uid %d, fd %d&quot;,</div><div class="t m0 x1f7 h57 y3265 ff1a fs2d fc0 sc0 ls0 ws0">client[i].uid, clifd);</div><div class="t m0 x36 h57 y3266 ff1a fs2d fc0 sc0 ls0 ws0">client_del(clifd); <span class="_"> </span>/*<span class="_"> </span>client has closed cxn */</div><div class="t m0 x36 h57 y3267 ff1a fs2d fc0 sc0 ls0 ws0">FD_CLR(clifd, &amp;allset);</div><div class="t m0 x36 h57 y3268 ff1a fs2d fc0 sc0 ls0 ws0">close(clifd);</div><div class="t m0 x1ca h57 y4853 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {<span class="_ _15"> </span>/* process client’s request */</span></div><div class="t m0 x36 h57 y4854 ff1a fs2d fc0 sc0 ls0 ws0">handle_request(buf, nread, clifd, client[i].uid);</div><div class="t m0 x1ca h57 y4855 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1f h57 y4856 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h57 y4857 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y4858 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y4218 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xbe h5e y4e37 ff18 fs10 fc0 sc0 ls0 ws0">Figure 17.29<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">loop<span class="_ _e"> </span></span>function using<span class="_"> </span><span class="ff1a">select</span></span></div><div class="t m0 x3f h4d y4e38 ff19 fs26 fc0 sc0 ls0 ws0">This <span class="_ _23"></span>function <span class="_ _23"></span>calls<span class="_ _35"> </span><span class="ff1a">serv_listen<span class="_ _35"> </span></span>(Figur<span class="_ _0"></span><span class="lsa0a">e1<span class="_ _43"></span><span class="ls0">7.8) <span class="_ _23"> </span>to <span class="_ _23"> </span>create <span class="_ _23"></span>the <span class="_ _23"></span>server<span class="_ _3"></span>’s <span class="_ _42"> </span>endpoint <span class="_ _23"></span>for</span></span></div><div class="t m0 x32 h49 y4e39 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>client <span class="_ _3"></span>connections.<span class="_ _16"> </span>The <span class="_ _3"></span>remainder <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>function <span class="_ _9"></span>is <span class="_ _3"></span>a <span class="_ _3"></span>loop <span class="_ _3"></span>that <span class="_ _3"></span>starts <span class="_ _9"></span>with <span class="_ _3"></span>a <span class="_ _3"></span>call <span class="_ _3"></span>to</div><div class="t m0 x32 h4d y4e3a ff1a fs26 fc0 sc0 ls0 ws0">select<span class="ff19 ls199">.T<span class="_ _26"></span><span class="ls0">wo conditions can be true after<span class="_"> </span><span class="ff1a">select<span class="_ _66"> </span></span><span class="lscc">re</span>turns.</span></span></div><div class="t m0 x3f h4d y4e3b ff19 fs26 fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>The<span class="_ _44"> </span>descriptor<span class="_ _35"> </span><span class="ff1a">listenfd<span class="_ _44"> </span></span>can <span class="_ _42"> </span>be <span class="_ _42"> </span>ready <span class="_ _23"> </span>for <span class="_ _42"> </span>reading, <span class="_ _42"> </span>which <span class="_ _42"> </span>means <span class="_ _42"> </span>that <span class="_ _42"> </span>a <span class="_ _42"> </span>new</div><div class="t m0 x41 h4d y4e3c ff19 fs26 fc0 sc0 ls0 ws0">client has <span class="_ _2"></span>called<span class="_ _47"> </span><span class="ff1a">cli_conn</span><span class="ls140e">.T<span class="_ _7"></span><span class="lsf45">oh<span class="_ _d"></span><span class="ls0">andle <span class="_ _2"></span>this, <span class="_ _2"></span>we <span class="_ _2"></span>call<span class="_ _66"> </span><span class="ff1a">serv_accept<span class="_ _47"> </span></span>(Figur<span class="_ _0"></span><span class="ls140f">e1<span class="_ _4f"></span><span class="ls0">7.9)</span></span></span></span></span></div><div class="t m0 x41 h4d y4e3d ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _2"></span>then <span class="_ _3"></span>update <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">client<span class="_ _47"> </span></span>array <span class="_ _2"></span>and <span class="_ _3"></span>associated <span class="_ _3"></span>bookkeeping <span class="_ _2"></span>information <span class="_ _3"></span>for</div><div class="t m0 x41 h49 y4e3e ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _42"> </span>new <span class="_ _42"> </span>client.<span class="_ _54"> </span>(W<span class="_ _6"></span><span class="ls1410">ek<span class="_ _43"></span><span class="ls0">eep <span class="_ _42"> </span>track <span class="_ _42"> </span>of <span class="_ _53"> </span>the <span class="_ _42"> </span>highest <span class="_ _53"> </span>descriptor <span class="_ _42"> </span>number <span class="_ _53"> </span>for <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁrst</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
