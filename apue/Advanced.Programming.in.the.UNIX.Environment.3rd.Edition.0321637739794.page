<div id="pf31a" class="pf w4 h1f" data-page-no="31a"><div class="pc pc31a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg31a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">760<span class="_ _1b"> </span><span class="ff19 ls30a">AD<span class="_ _55"></span><span class="ls0">atabase <span class="_"> </span>Library<span class="_ _245"> </span>Chapter <span class="_"> </span>20</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">138 <span class="_ _82"> </span>hash[0]<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">139 <span class="_ _82"> </span>for<span class="_"> </span>(i = 0; i &lt; NHASH_DEF + 1; i++)</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">140 <span class="_ _1e7"> </span>strcat(hash,<span class="_"> </span>asciiptr);</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">141 <span class="_ _82"> </span>strcat(hash,<span class="_"> </span>&quot;\n&quot;);</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">142 <span class="_ _82"> </span>i<span class="_"> </span><span class="ls15c">=s<span class="_ _1d"></span><span class="ls0">trlen(hash);</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">143 <span class="_ _82"> </span>if<span class="_"> </span>(write(db-&gt;idxfd, hash, i) != i)</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">144 <span class="_ _1e7"> </span>err_dump(&quot;db_open:<span class="_"> </span>index file init write error&quot;);</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">145 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">146 <span class="_ _186"> </span>if<span class="_"> </span>(un_lock(db-&gt;idxfd, 0, SEEK_SET, 0) &lt; 0)</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">147 <span class="_ _82"> </span>err_dump(&quot;db_open:<span class="_"> </span>un_lock error&quot;);</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">148 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">149 <span class="_ _15"> </span>db_rewind(db);</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">150 <span class="_ _15"> </span>return(db);</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">151 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y1fc0 ff1a fs2d fc0 sc0 ls0 ws0">152 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y1fc1 ff1a fs2d fc0 sc0 ls0 ws0">153 <span class="_ _68"> </span>*<span class="_"> </span>Allocate &amp; initialize a DB structure and its buffers.</div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">154 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">155 <span class="_ _d9"> </span>static<span class="_"> </span>DB *</div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">156 <span class="_ _d9"> </span>_db_alloc(int<span class="_"> </span>namelen)</div><div class="t m0 x32 h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">157 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">158 <span class="_ _15"> </span>DB<span class="_ _189"> </span>*db;</div><div class="t m0 x32 h57 y2ada ff1a fs2d fc0 sc0 ls0 ws0">159 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y2adb ff1a fs2d fc0 sc0 ls0 ws0">160 <span class="_ _8a"> </span>*<span class="_"> </span>Use calloc, to initialize the structure to zero.</div><div class="t m0 x32 h57 y2adc ff1a fs2d fc0 sc0 ls0 ws0">161 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2add ff1a fs2d fc0 sc0 ls0 ws0">162 <span class="_ _15"> </span>if<span class="_"> </span>((db = calloc(1, sizeof(DB))) == NULL)</div><div class="t m0 x32 h57 y2ade ff1a fs2d fc0 sc0 ls0 ws0">163 <span class="_ _186"> </span>err_dump(&quot;_db_alloc:<span class="_"> </span>calloc error for DB&quot;);</div><div class="t m0 x32 h57 y2c66 ff1a fs2d fc0 sc0 ls0 ws0">164 <span class="_ _15"> </span>db-&gt;idxfd<span class="_"> </span><span class="ls15c">=d<span class="_ _1d"></span><span class="ls0">b-&gt;datfd = -1;<span class="_ _166"> </span>/* descriptors */</span></span></div><div class="t m0 x32 h57 y2025 ff1a fs2d fc0 sc0 ls0 ws0">165 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y2026 ff1a fs2d fc0 sc0 ls0 ws0">166 <span class="_ _8a"> </span>*<span class="_"> </span>Allocate room for the name.</div><div class="t m0 x32 h57 y2027 ff1a fs2d fc0 sc0 ls0 ws0">167 <span class="_ _8a"> </span>*<span class="_"> </span>+5 for &quot;.idx&quot; or &quot;.dat&quot; plus null at end.</div><div class="t m0 x32 h57 y2028 ff1a fs2d fc0 sc0 ls0 ws0">168 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2029 ff1a fs2d fc0 sc0 ls0 ws0">169 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;name = malloc(namelen + 5)) == NULL)</div><div class="t m0 x32 h57 y202a ff1a fs2d fc0 sc0 ls0 ws0">170 <span class="_ _186"> </span>err_dump(&quot;_db_alloc:<span class="_"> </span>malloc error for name&quot;);</div><div class="t m0 x32 h49 y5733 ff19 fs26 fc0 sc0 ls0 ws0">[138 <span class="_ _a"></span>– <span class="_ _a"></span>151]<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>c<span class="_ _23"></span></span>ontinue <span class="_ _53"> </span>to <span class="_"> </span>initialize <span class="_ _53"> </span>the <span class="_"> </span>newly <span class="_ _53"> </span>created <span class="_ _e"> </span>database.<span class="_ _48"> </span><span class="ls164">We <span class="_ _35"> </span>b<span class="_ _23"></span></span>uild <span class="_ _e"> </span>the <span class="_ _e"> </span>hash</div><div class="t m0 x11a h49 y5734 ff19 fs26 fc0 sc0 ls0 ws0">table <span class="_ _9"></span>and <span class="_ _9"></span>write <span class="_ _9"></span>it <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>index <span class="_ _9"></span>ﬁle.<span class="_ _5a"> </span>Then <span class="_ _23"></span>we <span class="_ _3"></span>unlock <span class="_ _23"></span>the <span class="_ _9"></span>index <span class="_ _9"></span>ﬁle, <span class="_ _9"></span>reset <span class="_ _3"></span>the</div><div class="t m0 x11a h4d y5735 ff19 fs26 fc0 sc0 ls0 ws0">database <span class="_ _2"></span>ﬁle <span class="_ _2"></span>pointers, <span class="_ _2"></span>and <span class="_ _2"></span>return <span class="_ _2"></span>a <span class="_ _2"></span>pointer <span class="_ _2"></span>to <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">DB<span class="_ _47"> </span></span>structur<span class="ls63b">ea<span class="_ _8"></span><span class="ls166f">st<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>opaque</span></span></span></div><div class="t m0 x11a h49 y5736 ff19 fs26 fc0 sc0 ls0 ws0">handle for the caller to use with the other database functions.</div><div class="t m0 x32 h4d y5737 ff19 fs26 fc0 sc0 ls0 ws0">[152 <span class="_ _a"></span>– <span class="_ _a"></span>164]<span class="_ _65"> </span>The<span class="_"> </span><span class="ff1a">_db_alloc<span class="_ _66"> </span></span>function <span class="_ _2"></span>is <span class="_ _2"></span>called <span class="_ _2"></span>by<span class="_ _66"> </span><span class="ff1a">db_open<span class="_ _66"> </span></span>to <span class="_ _2"></span>allocate <span class="_ _2"></span>storage for <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">DB</span></div><div class="t m0 x11a h4d y5738 ff19 fs26 fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>e, <span class="_ _53"> </span>an <span class="_ _e"> </span>index <span class="_ _e"> </span>buffer<span class="_ _6"></span><span class="ls1670">,a<span class="_ _55"></span><span class="ls0">nd <span class="_ _e"> </span>a <span class="_ _e"> </span>data <span class="_ _e"> </span>buffer<span class="_ _6"></span><span class="ls1671">.W<span class="_ _49"></span><span class="ls1672">eu<span class="_ _55"></span><span class="ls0">se<span class="_ _4b"> </span><span class="ff1a">calloc<span class="_ _4b"> </span></span>to <span class="_ _53"> </span>allocate</span></span></span></span></span></div><div class="t m0 x11a h4d y5739 ff19 fs26 fc0 sc0 ls0 ws0">memory <span class="_ _2"></span>to <span class="_ _3"></span>hold <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">DB<span class="_ _66"> </span></span>structur<span class="ls13be">ea<span class="_ _8"></span><span class="ls0">nd <span class="_ _3"></span>ensur<span class="ls13be">et<span class="_ _8"></span><span class="ls0">hat <span class="_ _3"></span>it <span class="_ _2"></span>is <span class="_ _3"></span>initialized <span class="_ _3"></span>to <span class="_ _2"></span>all <span class="_ _3"></span>zeros.</span></span></span></span></div><div class="t m0 x11a h49 y573a ff19 fs26 fc0 sc0 ls0 ws0">Since <span class="_ _9"></span>this <span class="_ _9"></span>has <span class="_ _23"></span>the <span class="_ _9"></span>side <span class="_ _23"></span>ef<span class="_ _0"></span>fect <span class="_ _9"></span>of <span class="_ _23"></span>setting <span class="_ _9"></span>the <span class="_ _9"></span>database <span class="_ _23"></span>ﬁle <span class="_ _9"></span>descriptors <span class="_ _9"></span>to <span class="_ _23"></span>zero,</div><div class="t m0 x11a h49 y573b ff19 fs26 fc0 sc0 ls0 ws0">we need to reset them to<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>to<span class="_"> </span>indicate that they ar<span class="_ _0"></span><span class="lsd3">en<span class="_ _d"></span><span class="ls0">ot yet valid.</span></span></div><div class="t m0 x32 h49 y573c ff19 fs26 fc0 sc0 ls0 ws0">[165 <span class="_ _a"></span>– <span class="_ _a"></span>170]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>a<span class="_ _23"></span></span>llocate space to <span class="_ _2"></span>hold the <span class="_ _2"></span>name of <span class="_ _2"></span>the database <span class="_ _2"></span>ﬁle.<span class="_ _46"> </span><span class="ls164">We <span class="_ _e"> </span>u<span class="_ _9"></span></span>se <span class="_ _2"></span>this buffer to</div><div class="t m0 x11a h49 y573d ff19 fs26 fc0 sc0 ls0 ws0">create both ﬁlenames by changing the sufﬁx to refer to either the index ﬁle or</div><div class="t m0 x11a h4d y573e ff19 fs26 fc0 sc0 ls0 ws0">the data ﬁle, as we saw in<span class="_"> </span><span class="ff1a">db_open</span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
