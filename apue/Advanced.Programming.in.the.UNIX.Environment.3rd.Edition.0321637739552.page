<div id="pf228" class="pf w4 h1f" data-page-no="228"><div class="pc pc228 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg228.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">518<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">unsigned char</div><div class="t m0 x32 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">translate(unsigned char c)</div><div class="t m0 x32 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">/* same as before */</div><div class="t m0 x32 h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">main(int argc, char* argv[])</div><div class="t m0 x32 h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>ifd,<span class="_"> </span>ofd, i, j, n, err, numop;</div><div class="t m0 x8a h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">struct stat<span class="_ _176"> </span>sbuf;</div><div class="t m0 x8a h57 y8d8 ff1a fs2d fc0 sc0 ls0 ws0">const struct aiocb<span class="_ _d9"> </span>*aiolist[NBUF];</div><div class="t m0 x8a h57 y8d9 ff1a fs2d fc0 sc0 ls0 ws0">off_t <span class="_ _12d"> </span>off<span class="_"> </span><span class="ls15c">=0<span class="_ _5b"></span><span class="ls0">;</span></span></div><div class="t m0 x8a h57 y31b9 ff1a fs2d fc0 sc0 ls0 ws0">if (argc != 3)</div><div class="t m0 x9d h57 y31ba ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;usage: rot13 infile outfile&quot;);</div><div class="t m0 x8a h57 y31bb ff1a fs2d fc0 sc0 ls0 ws0">if ((ifd = open(argv[1], O_RDONLY)) &lt; 0)</div><div class="t m0 x9d h57 y2f71 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;can’t open %s&quot;, argv[1]);</div><div class="t m0 x8a h57 y2f72 ff1a fs2d fc0 sc0 ls0 ws0">if ((ofd = open(argv[2], O_RDWR|O_CREAT|O_TRUNC, FILE_MODE)) &lt; 0)</div><div class="t m0 x9d h57 y2f73 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;can’t create %s&quot;, argv[2]);</div><div class="t m0 x8a h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">if (fstat(ifd, &amp;sbuf) &lt; 0)</div><div class="t m0 x9d h57 y8e1 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fstat failed&quot;);</div><div class="t m0 x8a h57 y8e2 ff1a fs2d fc0 sc0 ls0 ws0">/* initialize the buffers */</div><div class="t m0 x8a h57 y8e3 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; NBUF; i++) {</div><div class="t m0 x9d h57 y8e4 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].op = UNUSED;</div><div class="t m0 x9d h57 y8e5 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].aiocb.aio_buf = bufs[i].data;</div><div class="t m0 x9d h57 y2f78 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].aiocb.aio_sigevent.sigev_notify = SIGEV_NONE;</div><div class="t m0 x9d h57 y2f79 ff1a fs2d fc0 sc0 ls0 ws0">aiolist[i] = NULL;</div><div class="t m0 x8a h57 y2f7a ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y3f7e ff1a fs2d fc0 sc0 ls0 ws0">numop = 0;</div><div class="t m0 x8a h57 y3f7f ff1a fs2d fc0 sc0 ls0 ws0">for (;;) {</div><div class="t m0 x9d h57 y3f80 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; NBUF; i++) {</div><div class="t m0 x1f h57 y3f81 ff1a fs2d fc0 sc0 ls0 ws0">switch (bufs[i].op) {</div><div class="t m0 x1f h57 y2f7f ff1a fs2d fc0 sc0 ls0 ws0">case UNUSED:</div><div class="t m0 x1ca h57 y2f80 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x4 h57 y3f82 ff1a fs2d fc0 sc0 ls15c ws0">*R<span class="_ _1d"></span><span class="ls0">ead from the input file if more data</span></div><div class="t m0 x4 h57 y3f83 ff1a fs2d fc0 sc0 ls15c ws0">*r<span class="_ _1d"></span><span class="ls0">emains unread.</span></div><div class="t m0 x4 h57 y3f84 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x1ca h57 y3f85 ff1a fs2d fc0 sc0 ls0 ws0">if (off &lt; sbuf.st_size) {</div><div class="t m0 x36 h57 y3f86 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].op = READ_PENDING;</div><div class="t m0 x36 h57 y3f87 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].aiocb.aio_fildes = ifd;</div><div class="t m0 x36 h57 y3f88 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].aiocb.aio_offset = off;</div><div class="t m0 x36 h57 y3f89 ff1a fs2d fc0 sc0 ls0 ws0">off += BSZ;</div><div class="t m0 x36 h57 y3f8a ff1a fs2d fc0 sc0 ls0 ws0">if (off &gt;= sbuf.st_size)</div><div class="t m0 xee h57 y3f8b ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].last = 1;</div><div class="t m0 x36 h57 y3f8c ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].aiocb.aio_nbytes = BSZ;</div><div class="t m0 x36 h57 y3f8d ff1a fs2d fc0 sc0 ls0 ws0">if (aio_read(&amp;bufs[i].aiocb) &lt; 0)</div><div class="t m0 xee h57 y3f8e ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;aio_read failed&quot;);</div><div class="t m0 x36 h57 y3f8f ff1a fs2d fc0 sc0 ls0 ws0">aiolist[i] = &amp;bufs[i].aiocb;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
