<div id="pf23c" class="pf w4 h1f" data-page-no="23c"><div class="pc pc23c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg23c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">538<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">Consider <span class="_ _9"></span>a <span class="_ _23"></span>pr<span class="_ _0"></span>ogram <span class="_ _9"></span>that <span class="_ _23"></span>displays <span class="_ _9"></span>some <span class="_ _9"></span>output <span class="_ _23"></span>that <span class="_ _9"></span>it <span class="_ _23"></span>has <span class="_ _9"></span>created, <span class="_ _9"></span>one <span class="_ _9"></span>page <span class="_ _23"></span>at <span class="_ _9"></span>a <span class="_ _9"></span>time.</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">Rather <span class="_ _3"></span>than <span class="_ _3"></span>reinvent <span class="_ _3"></span>the <span class="_ _3"></span>pagination <span class="_ _9"></span>done <span class="_ _3"></span>by <span class="_ _3"></span>several <span class="_ _3"></span>UNIX <span class="_ _9"></span>system <span class="_ _3"></span>utilities, <span class="_ _3"></span>we <span class="_ _9"></span>want <span class="_ _3"></span>to</div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">invoke <span class="_ _9"></span>the <span class="_ _9"></span>user<span class="_ _9"></span>’s <span class="_ _9"></span>favorite <span class="_ _23"></span>pager<span class="_ _6"></span><span class="ls6aa">.T<span class="_ _52"></span><span class="ls116d">oa<span class="_ _b"></span><span class="ls0">void <span class="_ _9"></span>writing <span class="_ _9"></span>all <span class="_ _9"></span>the <span class="_ _23"></span>data <span class="_ _9"></span>to <span class="_ _9"></span>a <span class="_ _9"></span>temporary <span class="_ _23"></span>ﬁle <span class="_ _9"></span>and</span></span></span></div><div class="t m0 x32 h26 y134 ff19 fsf fc0 sc0 ls0 ws0">calling<span class="_ _66"> </span><span class="ff1a">system<span class="_ _47"> </span></span>to <span class="_ _2"></span>display <span class="_ _2"></span>that <span class="_ _2"></span>ﬁle, <span class="_ _2"></span>we <span class="_ _2"></span>want <span class="_ _3"></span>to <span class="_ _2"></span>pipe <span class="_ _2"></span>the <span class="_ _2"></span>output <span class="_ _2"></span>directly <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>pager<span class="_ _1"></span><span class="ls116e">.T<span class="_ _7"></span><span class="ls0">o</span></span></div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls0 ws0">do <span class="_ _9"></span>this, <span class="_ _9"></span>we <span class="_ _9"></span>create <span class="_ _3"></span>a <span class="_ _9"></span>pipe,<span class="_ _45"> </span><span class="ff1a">fork<span class="_ _45"> </span></span><span class="ls116f">ac<span class="_ _b"></span><span class="ls0">hild <span class="_ _9"></span>process, <span class="_ _9"></span>set <span class="_ _9"></span>up <span class="_ _9"></span>the <span class="_ _9"></span>child’s <span class="_ _9"></span>standar<span class="ls116f">di<span class="_ _b"></span><span class="ls0">nput <span class="_ _3"></span>to <span class="_ _9"></span>be</span></span></span></span></div><div class="t m0 x32 h26 y136 ff19 fsf fc0 sc0 ls0 ws0">the read end of <span class="_ _2"></span>the pipe, and<span class="_ _66"> </span><span class="ff1a">exec<span class="_ _66"> </span></span>the <span class="_ _2"></span>user<span class="_ _3"></span>’s <span class="_ _2"></span>pager program. <span class="_"> </span>Figur<span class="ls54">e1<span class="_ _4f"></span><span class="ls0">5.6 <span class="_ _2"></span>shows how <span class="_ _2"></span>to</span></span></div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">do <span class="_ _3"></span>this.<span class="_ _5a"> </span>(This <span class="_ _3"></span>example <span class="_ _3"></span>takes <span class="_ _9"></span>a <span class="_ _3"></span>command</div><div class="t m0 x88 h2a y5cf ff19 fsf fc0 sc0 ls0 ws0">-</div><div class="t m0 x1ac h2a y137 ff19 fsf fc0 sc0 ls0 ws0">line <span class="_ _3"></span>argument <span class="_ _3"></span>to <span class="_ _3"></span>specify <span class="_ _9"></span>the <span class="_ _3"></span>name <span class="_ _9"></span>of <span class="_ _3"></span>a <span class="_ _9"></span>ﬁle <span class="_ _3"></span>to</div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">display<span class="_ _4"></span><span class="ls1170">.O<span class="_ _26"></span><span class="ls0">ften, <span class="_ _23"> </span>a <span class="_ _23"> </span>program <span class="_ _23"> </span>of <span class="_ _23"> </span>this <span class="_ _42"> </span>type <span class="_ _23"></span>would <span class="_ _23"> </span>already <span class="_ _23"> </span>have <span class="_ _23"> </span>the <span class="_ _42"> </span>data <span class="_ _23"> </span>to <span class="_ _23"> </span>display <span class="_ _42"> </span>to <span class="_ _23"></span>the</span></span></div><div class="t m0 x32 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">terminal in memory<span class="_ _4"></span>.)</div><div class="t m0 x32 h4e y4163 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y4164 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/wait.h&gt;</div><div class="t m0 x32 h4e y4165 ff1a fs28 fc0 sc0 ls0 ws0">#define DEF_PAGER<span class="_ _68"> </span>&quot;/bin/more&quot; <span class="_ _15"> </span>/*<span class="_"> </span>default pager program */</div><div class="t m0 x32 h4e y4166 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y4167 ff1a fs28 fc0 sc0 ls0 ws0">main(int argc, char *argv[])</div><div class="t m0 x32 h4e y4168 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y4169 ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>n;</div><div class="t m0 x8a h4e y416a ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>fd[2];</div><div class="t m0 x8a h4e y416b ff1a fs28 fc0 sc0 ls0 ws0">pid_t <span class="_ _d9"> </span>pid;</div><div class="t m0 x8a h4e y416c ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>*pager,<span class="_"> </span>*argv0;</div><div class="t m0 x8a h4e y416d ff1a fs28 fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>line[MAXLINE];</div><div class="t m0 x8a h4e y416e ff1a fs28 fc0 sc0 ls0 ws0">FILE <span class="_ _68"> </span>*fp;</div><div class="t m0 x8a h4e y416f ff1a fs28 fc0 sc0 ls0 ws0">if (argc != 2)</div><div class="t m0 x9d h4e y4170 ff1a fs28 fc0 sc0 ls0 ws0">err_quit(&quot;usage: a.out &lt;pathname&gt;&quot;);</div><div class="t m0 x8a h4e y4171 ff1a fs28 fc0 sc0 ls0 ws0">if ((fp = fopen(argv[1], &quot;r&quot;)) == NULL)</div><div class="t m0 x9d h4e y4172 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;can’t open %s&quot;, argv[1]);</div><div class="t m0 x8a h4e y4173 ff1a fs28 fc0 sc0 ls0 ws0">if (pipe(fd) &lt; 0)</div><div class="t m0 x9d h4e y4174 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;pipe error&quot;);</div><div class="t m0 x8a h4e y4175 ff1a fs28 fc0 sc0 ls0 ws0">if ((pid = fork()) &lt; 0) {</div><div class="t m0 x9d h4e y4176 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;fork error&quot;);</div><div class="t m0 x8a h4e y4177 ff1a fs28 fc0 sc0 ls1b6 ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pid &gt; 0) {<span class="_ _205"> </span>/* parent */</span></div><div class="t m0 x9d h4e y4178 ff1a fs28 fc0 sc0 ls0 ws0">close(fd[0]); <span class="_ _189"> </span>/*<span class="_"> </span>close read end */</div><div class="t m0 x9d h4e y4179 ff1a fs28 fc0 sc0 ls0 ws0">/* parent copies argv[1] to pipe */</div><div class="t m0 x9d h4e y417a ff1a fs28 fc0 sc0 ls0 ws0">while (fgets(line, MAXLINE, fp) != NULL) {</div><div class="t m0 x1f h4e y417b ff1a fs28 fc0 sc0 ls1b6 ws0">n=s<span class="_ _1d"></span><span class="ls0">trlen(line);</span></div><div class="t m0 x1f h4e y417c ff1a fs28 fc0 sc0 ls0 ws0">if (write(fd[1], line, n) != n)</div><div class="t m0 x1ca h4e y417d ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;write error to pipe&quot;);</div><div class="t m0 x9d h4e y417e ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x9d h4e y417f ff1a fs28 fc0 sc0 ls0 ws0">if (ferror(fp))</div><div class="t m0 x1f h4e y4180 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;fgets error&quot;);</div><div class="t m0 x9d h4e y4181 ff1a fs28 fc0 sc0 ls0 ws0">close(fd[1]); <span class="_ _d9"> </span>/*<span class="_"> </span>close write end of pipe for reader */</div><div class="t m0 x9d h4e y4182 ff1a fs28 fc0 sc0 ls0 ws0">if (waitpid(pid, NULL, 0) &lt; 0)</div><div class="t m0 x1f h4e y4183 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;waitpid error&quot;);</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
