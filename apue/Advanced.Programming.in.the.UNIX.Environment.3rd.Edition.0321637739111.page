<div id="pf6f" class="pf w4 h1f" data-page-no="6f"><div class="pc pc6f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg6f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>3.1<span class="_ _1"></span><span class="ls3dc">1A<span class="_ _175"></span><span class="ls0">tomic <span class="_"> </span>Operations<span class="_ _1b"> </span><span class="ff18">77</span></span></span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls49 ws0">•A<span class="_ _4d"></span><span class="ls0">fter <span class="_ _53"> </span>each<span class="_ _4b"> </span><span class="ff1a">write<span class="_ _4b"> </span></span>is <span class="_ _53"> </span>complete, <span class="_ _53"> </span>the <span class="_ _53"> </span>current <span class="_ _53"> </span>ﬁle <span class="_ _53"> </span>offset <span class="_ _53"> </span>in <span class="_ _53"> </span>the <span class="_ _e"> </span>ﬁle <span class="_ _53"> </span>table <span class="_ _53"> </span>entry <span class="_ _e"> </span>is</span></div><div class="t m0 x15 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">incremented by <span class="_ _2"></span>the <span class="_ _3"></span>number <span class="_ _2"></span>of <span class="_ _2"></span>bytes <span class="_ _2"></span>written.<span class="_ _61"> </span>If <span class="_ _3"></span>this <span class="_ _2"></span>causes <span class="_ _2"></span>the <span class="_ _2"></span>current <span class="_ _2"></span>ﬁle <span class="_ _2"></span>offset</div><div class="t m0 x15 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _2"></span>exceed <span class="_ _3"></span>the <span class="_ _3"></span>current <span class="_ _2"></span>ﬁle <span class="_ _2"></span>size, <span class="_ _3"></span>the <span class="_ _3"></span>current <span class="_ _2"></span>ﬁle <span class="_ _3"></span>size <span class="_ _2"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>i-node <span class="_ _2"></span>table <span class="_ _3"></span>entry <span class="_ _3"></span>is <span class="_ _2"></span>set</div><div class="t m0 x15 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">to the current ﬁle of<span class="_ _0"></span>fset (for example, the ﬁle is extended).</div><div class="t m0 x3f h26 y1ad ff19 fsf fc0 sc0 ls49 ws0">•I<span class="_ _4d"></span><span class="ls19d">faﬁ<span class="_ _8"></span><span class="ls0">le <span class="_ _3"></span>is <span class="_ _3"></span>opened <span class="_ _3"></span>with <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">O_APPEND<span class="_ _47"> </span></span>ﬂag, <span class="_ _3"></span>a <span class="_ _3"></span>corresponding <span class="_ _3"></span>ﬂag <span class="_ _3"></span>is <span class="_ _3"></span>set <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle</span></span></div><div class="t m0 x15 h26 y1ae ff19 fsf fc0 sc0 ls0 ws0">status ﬂags <span class="_ _2"></span>of the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>table entry<span class="_ _6"></span><span class="ls3dd">.E<span class="_ _5b"></span><span class="ls0">ach <span class="_ _2"></span>time a<span class="_ _66"> </span><span class="ff1a">write<span class="_ _47"> </span></span>is performed <span class="_ _2"></span>for a <span class="_ _2"></span>ﬁle with</span></span></div><div class="t m0 x15 h2a y1af ff19 fsf fc0 sc0 ls0 ws0">this <span class="_ _2"></span>append <span class="_ _3"></span>ﬂag <span class="_ _3"></span>set, <span class="_ _3"></span>the <span class="_ _3"></span>current <span class="_ _2"></span>ﬁle <span class="_ _3"></span>offset <span class="_ _2"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>table <span class="_ _3"></span>entry <span class="_ _3"></span>is <span class="_ _3"></span>ﬁrst <span class="_ _3"></span>set <span class="_ _2"></span>to <span class="_ _3"></span>the</div><div class="t m0 x15 h26 y1b0 ff19 fsf fc0 sc0 ls0 ws0">current <span class="_ _e"> </span>ﬁle <span class="_"> </span>size <span class="_"> </span>fr<span class="_ _0"></span>om <span class="_"> </span>the <span class="_ _e"> </span>i-node <span class="_"> </span>table <span class="_"> </span>entry<span class="_ _4"></span><span class="ls3de">.T<span class="_ _5d"></span><span class="ls0">his <span class="_"> </span>for<span class="_ _0"></span>ces <span class="_"> </span>every<span class="_ _4b"> </span><span class="ff1a">write<span class="_ _46"> </span></span>to <span class="_"> </span>be</span></span></div><div class="t m0 x15 h2a y153 ff19 fsf fc0 sc0 ls0 ws0">appended to the current end of ﬁle.</div><div class="t m0 x3f h26 y1b1 ff19 fsf fc0 sc0 ls49 ws0">•I<span class="_ _4d"></span><span class="ls3df">faﬁ<span class="_ _d"></span><span class="ls0">le is positioned to its <span class="_ _2"></span>current end of ﬁle using<span class="_"> </span><span class="ff1a">lseek</span><span class="ls3df">,a<span class="_ _d"></span><span class="ls0">ll that happens is <span class="_ _2"></span>the</span></span></span></span></div><div class="t m0 x15 h2a y157 ff19 fsf fc0 sc0 ls0 ws0">current <span class="_ _23"> </span>ﬁle <span class="_ _53"> </span>offset <span class="_ _42"> </span>in <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>table <span class="_ _42"> </span>entry <span class="_ _53"> </span>is <span class="_ _42"> </span>set <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _53"> </span>current <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>size <span class="_ _42"> </span>from <span class="_ _42"> </span>the</div><div class="t m0 x15 h2a y15a ff19 fsf fc0 sc0 ls0 ws0">i-node <span class="_ _3"></span>table <span class="_ _3"></span>entry<span class="_ _4"></span><span class="ls3e0">.(<span class="_ _1d"></span><span class="ls0">Note <span class="_ _3"></span>that <span class="_ _9"></span>this <span class="_ _2"></span>is <span class="_ _9"></span>not <span class="_ _2"></span>the <span class="_ _9"></span>same <span class="_ _2"></span>as <span class="_ _9"></span>if <span class="_ _2"></span>the <span class="_ _9"></span>ﬁle <span class="_ _2"></span>was <span class="_ _9"></span>opened <span class="_ _2"></span>with</span></span></div><div class="t m0 x15 h26 y15b ff19 fsf fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">O_APPEND<span class="_ _80"> </span></span>ﬂag, as we will see in Section 3.1<span class="_ _1"></span>1.)</div><div class="t m0 x3f h26 y13b ff19 fsf fc0 sc0 ls49 ws0">•T<span class="_ _4d"></span><span class="ls0">he<span class="_ _35"> </span><span class="ff1a">lseek<span class="_ _35"> </span></span>function <span class="_ _23"></span>modiﬁes <span class="_ _23"></span>only <span class="_ _23"></span>the <span class="_ _23"></span>current <span class="_ _23"></span>ﬁle <span class="_ _23"></span>offset <span class="_ _9"></span>in <span class="_ _23"> </span>the <span class="_ _42"> </span>ﬁle <span class="_ _23"></span>table <span class="_ _23"></span>entry<span class="_ _4"></span>.</span></div><div class="t m0 x15 h2a y13c ff19 fsf fc0 sc0 ls0 ws0">No I/O takes place.</div><div class="t m0 x3f h2a y257 ff19 fsf fc0 sc0 ls0 ws0">It <span class="_ _9"></span>is <span class="_ _23"></span>possible <span class="_ _9"></span>for <span class="_ _9"></span>mor<span class="ls3e1">et<span class="_ _b"></span><span class="ls0">han <span class="_ _9"></span>one <span class="_ _9"></span>ﬁle <span class="_ _23"></span>descriptor <span class="_ _9"></span>entry <span class="_ _9"></span>to <span class="_ _23"></span>point <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _23"></span>same <span class="_ _9"></span>ﬁle <span class="_ _9"></span>table</span></span></div><div class="t m0 x32 h26 y258 ff19 fsf fc0 sc0 ls0 ws0">entry<span class="_ _4"></span>,<span class="_ _47"> </span>as<span class="_ _47"> </span>we’ll <span class="_ _2"></span>see <span class="_ _3"></span>when <span class="_ _2"></span>we <span class="_ _3"></span>discuss <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">dup<span class="_ _66"> </span></span>function <span class="_ _3"></span>in <span class="_ _3"></span>Section <span class="_ _2"></span>3.12.<span class="_ _16"> </span>This <span class="_ _2"></span>also <span class="_ _3"></span>happens</div><div class="t m0 x32 h26 y161 ff19 fsf fc0 sc0 ls0 ws0">after a<span class="_ _47"> </span><span class="ff1a">fork<span class="_ _66"> </span></span>when <span class="_ _2"></span>the <span class="_ _2"></span>parent and <span class="_ _2"></span>the <span class="_ _2"></span>child <span class="_ _2"></span>shar<span class="ls3e2">et<span class="_ _8"></span><span class="ls0">he <span class="_ _2"></span>same <span class="_ _2"></span>ﬁle <span class="_ _2"></span>table <span class="_ _2"></span>entry <span class="_ _2"></span>for <span class="_ _2"></span>each <span class="_ _2"></span>open</span></span></div><div class="t m0 x32 h2a y162 ff19 fsf fc0 sc0 ls0 ws0">descriptor (Section 8.3).</div><div class="t m0 x3f h2a y1db ff19 fsf fc0 sc0 ls0 ws0">Note <span class="_ _53"> </span>the <span class="_ _53"> </span>difference <span class="_ _42"> </span>in <span class="_ _e"> </span>scope <span class="_ _53"> </span>between <span class="_ _53"> </span>the <span class="_ _e"> </span>ﬁle <span class="_ _53"> </span>descriptor <span class="_ _e"> </span>ﬂags <span class="_ _53"> </span>and <span class="_ _53"> </span>the <span class="_ _e"> </span>ﬁle <span class="_ _53"> </span>status</div><div class="t m0 x32 h2a y25a ff19 fsf fc0 sc0 ls0 ws0">ﬂags. <span class="_"> </span>The<span class="_"> </span>former apply only to a single descriptor in a single process, wher<span class="_ _0"></span>eas the latter</div><div class="t m0 x32 h2a y164 ff19 fsf fc0 sc0 ls0 ws0">apply <span class="_ _2"></span>to <span class="_ _3"></span>all <span class="_ _3"></span>descriptors <span class="_ _3"></span>in <span class="_ _2"></span>any <span class="_ _3"></span>process <span class="_ _2"></span>that <span class="_ _3"></span>point <span class="_ _3"></span>to <span class="_ _2"></span>the <span class="_ _3"></span>given <span class="_ _3"></span>ﬁle <span class="_ _3"></span>table <span class="_ _2"></span>entry<span class="_ _6"></span><span class="ls3e3">.W<span class="_ _1d"></span><span class="ls0">hen <span class="_ _3"></span>we</span></span></div><div class="t m0 x32 h26 y25b ff19 fsf fc0 sc0 ls0 ws0">describe <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">fcntl<span class="_ _66"> </span></span>function <span class="_ _3"></span>in <span class="_ _2"></span>Section <span class="_ _3"></span>3.14, <span class="_ _2"></span>we’ll <span class="_ _2"></span>see <span class="_ _3"></span>how <span class="_ _2"></span>to <span class="_ _3"></span>fetch <span class="_ _2"></span>and <span class="_ _2"></span>modify <span class="_ _3"></span>both <span class="_ _2"></span>the</div><div class="t m0 x32 h2a y165 ff19 fsf fc0 sc0 ls0 ws0">ﬁle descriptor ﬂags and the ﬁle status ﬂags.</div><div class="t m0 x3f h2a y167 ff19 fsf fc0 sc0 ls0 ws0">Everything <span class="_ _66"> </span>that <span class="_ _47"> </span>we’ve <span class="_ _66"> </span>described <span class="_ _47"> </span>so <span class="_"> </span>far <span class="_ _47"> </span>in <span class="_ _66"> </span>this <span class="_ _47"> </span>section <span class="_ _66"> </span>works <span class="_ _47"> </span>ﬁne <span class="_"> </span>for <span class="_ _47"> </span>multiple</div><div class="t m0 x32 h2a y168 ff19 fsf fc0 sc0 ls0 ws0">processes <span class="_ _3"></span>that <span class="_ _9"></span>ar<span class="ls1b0">er<span class="_ _b"></span><span class="ls0">eading <span class="_ _3"></span>the <span class="_ _9"></span>same <span class="_ _9"></span>ﬁle.<span class="_ _16"> </span>Each <span class="_ _9"></span>process <span class="_ _3"></span>has <span class="_ _9"></span>its <span class="_ _9"></span>own <span class="_ _9"></span>ﬁle <span class="_ _9"></span>table <span class="_ _9"></span>entry <span class="_ _9"></span>with</span></span></div><div class="t m0 x32 h2a y169 ff19 fsf fc0 sc0 ls0 ws0">its <span class="_ _47"> </span>own <span class="_ _47"> </span>current <span class="_ _47"> </span>ﬁle <span class="_ _47"> </span>offset. <span class="_ _61"> </span>Unexpected<span class="_ _16"> </span><span class="ls45">re<span class="_ _2"></span></span>sults <span class="_ _47"> </span>can <span class="_ _47"> </span>arise, <span class="_ _45"> </span>however<span class="_ _6"></span><span class="ls3e4">,w<span class="_ _1d"></span><span class="ls0">hen <span class="_ _47"> </span>multiple</span></span></div><div class="t m0 x32 h2a y16a ff19 fsf fc0 sc0 ls0 ws0">processes <span class="_ _e"> </span>write <span class="_"> </span>to <span class="_"> </span>the <span class="_ _e"> </span>same <span class="_"> </span>ﬁle.<span class="_ _60"> </span><span class="ls5f">To <span class="_ _44"> </span>s<span class="_ _9"></span></span>ee <span class="_"> </span>how <span class="_"> </span>to <span class="_ _e"> </span>avoid <span class="_"> </span>some <span class="_"> </span>surprises, <span class="_ _e"> </span>we <span class="_"> </span>need <span class="_"> </span>to</div><div class="t m0 x32 h2a y16b ff19 fsf fc0 sc0 ls0 ws0">understand the concept of atomic operations.</div><div class="t m0 x35 h53 yc22 ff16 fs2b fc0 sc0 ls0 ws0">3.11 <span class="_ _93"> </span>Atomic<span class="_ _54"> </span>Operations</div><div class="t m0 x35 h27 yc23 ff16 fsf fc0 sc0 ls0 ws0">Appending to a File</div><div class="t m0 x32 h2a yc24 ff19 fsf fc0 sc0 ls0 ws0">Consider <span class="_ _9"></span>a <span class="_ _23"></span>single <span class="_ _9"></span>process <span class="_ _9"></span>that <span class="_ _9"></span>wants <span class="_ _23"></span>to <span class="_ _9"></span>append <span class="_ _9"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>end <span class="_ _23"></span>of <span class="_ _9"></span>a <span class="_ _9"></span>ﬁle.<span class="_ _51"> </span>Older <span class="_ _9"></span>versions <span class="_ _9"></span>of</div><div class="t m0 x32 h26 yc25 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _23"> </span>UNIX <span class="_ _42"> </span>System <span class="_ _23"> </span>didn’t <span class="_ _42"> </span>support <span class="_ _23"> </span>the<span class="_ _44"> </span><span class="ff1a">O_APPEND<span class="_ _35"> </span></span>option <span class="_ _23"> </span>to<span class="_ _35"> </span><span class="ff1a">open</span>,<span class="_ _44"> </span>so<span class="_ _35"> </span>the <span class="_ _23"> </span>program <span class="_ _23"> </span>was</div><div class="t m0 x32 h2a yc26 ff19 fsf fc0 sc0 ls0 ws0">coded as follows:</div><div class="t m0 x3f h57 yc27 ff1a fs2d fc0 sc0 ls0 ws0">if (lseek(fd, 0L, 2) &lt; 0)<span class="_ _176"> </span>/* position to EOF */</div><div class="t m0 x41 h57 yc28 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;lseek error&quot;);</div><div class="t m0 x3f h57 yc29 ff1a fs2d fc0 sc0 ls0 ws0">if (write(fd, buf, 100) != 100)<span class="_ _68"> </span>/* and write */</div><div class="t m0 x41 h57 yc2a ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><a class="l" href="#pfc" data-dest-detail='[12,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892842px;bottom:404.688916px;width:146.687591px;height:19.678986px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
