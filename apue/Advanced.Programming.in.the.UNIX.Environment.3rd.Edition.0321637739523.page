<div id="pf20b" class="pf w4 h1f" data-page-no="20b"><div class="pc pc20b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg20b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.3<span class="_ _1f7"> </span>Recor<span class="ls30a">dL<span class="_ _55"></span><span class="ls0">ocking<span class="_ _1b"> </span><span class="ff18">489</span></span></span></div><div class="t m0 x35 h27 y12f ff16 fsf fc0 sc0 ls0 ws0">Example <span class="_ _84"></span>— <span class="_ _84"></span>Requesting<span class="_"> </span>and Releasing a Lock</div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _e"> </span>s<span class="_ _9"></span><span class="ls0">ave <span class="_ _2"></span>ourselves <span class="_ _2"></span>from having <span class="_ _2"></span>to allocate <span class="_ _2"></span>an<span class="_ _66"> </span><span class="ff1a">flock<span class="_ _47"> </span></span>structur<span class="_ _0"></span><span class="lsdb1">ea<span class="_ _4f"></span><span class="ls0">nd <span class="_ _2"></span>ﬁll <span class="_ _2"></span>in <span class="_ _2"></span>all the <span class="_ _2"></span>elements</span></span></span></div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">each time, the function<span class="_"> </span><span class="ff1a">lock_reg<span class="_ _80"> </span></span>in Figur<span class="ls44">e1<span class="_ _d"></span><span class="ls0">4.5 handles all these details.</span></span></div><div class="t m0 x32 h4e y2d71 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y31cf ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h4e y2d73 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y2d74 ff1a fs28 fc0 sc0 ls0 ws0">lock_reg(int fd, int cmd, int type, off_t offset, int whence, off_t len)</div><div class="t m0 x32 h4e y2d75 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y3bfb ff1a fs28 fc0 sc0 ls0 ws0">struct flock<span class="_ _15"> </span>lock;</div><div class="t m0 x8a h4e y2d77 ff1a fs28 fc0 sc0 ls0 ws0">lock.l_type = type;<span class="_ _8a"> </span>/* F_RDLCK, F_WRLCK, F_UNLCK */</div><div class="t m0 x8a h4e y2d78 ff1a fs28 fc0 sc0 ls0 ws0">lock.l_start = offset;<span class="_ _d9"> </span>/* byte offset, relative to l_whence */</div><div class="t m0 x8a h4e y2d79 ff1a fs28 fc0 sc0 ls0 ws0">lock.l_whence = whence; /* SEEK_SET, SEEK_CUR, SEEK_END */</div><div class="t m0 x8a h4e y2d7a ff1a fs28 fc0 sc0 ls0 ws0">lock.l_len = len;<span class="_ _b7"> </span>/* #bytes (0 means to EOF) */</div><div class="t m0 x8a h4e y3bfc ff1a fs28 fc0 sc0 ls0 ws0">return(fcntl(fd, cmd, &amp;lock));</div><div class="t m0 x32 h4e y3bfd ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x30 h2e y3bfe ff18 fs11 fc0 sc0 ls0 ws0">Figure 14.5<span class="_ _5a"> </span><span class="ff19">Function to lock or unlock a region of a ﬁle</span></div><div class="t m0 x32 h54 y3bff ff19 fs2c fc0 sc0 ls0 ws0">Since <span class="_ _2"></span>most <span class="_ _2"></span>locking <span class="_ _2"></span>calls <span class="_ _3"></span>are<span class="_"> </span>to<span class="_ _47"> </span>lock <span class="_ _2"></span>or <span class="_ _2"></span>unlock <span class="_ _2"></span>a <span class="_ _3"></span>region (the <span class="_ _2"></span>command<span class="_ _47"> </span><span class="ff1a">F_GETLK<span class="_ _66"> </span></span>is <span class="_ _3"></span>rarely</div><div class="t m0 x32 h54 y3c00 ff19 fs2c fc0 sc0 ls0 ws0">used), <span class="_ _3"></span>we <span class="_ _3"></span>normally <span class="_ _3"></span>use <span class="_ _3"></span>one <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _2"></span>following <span class="_ _9"></span>ﬁve <span class="_ _3"></span>macros, <span class="_ _2"></span>which <span class="_ _3"></span>ar<span class="lsfeb">ed<span class="_ _8"></span><span class="ls0">eﬁned <span class="_ _3"></span>in<span class="_ _47"> </span><span class="ff1a">apue.h</span></span></span></div><div class="t m0 x32 h55 y3c01 ff19 fs2c fc0 sc0 ls0 ws0">(Appendix B).</div><div class="t m0 x32 h5d y3c02 ff1a fs2f fc0 sc0 ls0 ws0">#define read_lock(fd, offset, whence, len) \</div><div class="t m0 x1f h5d y3c03 ff1a fs2f fc0 sc0 ls0 ws0">lock_reg((fd), F_SETLK, F_RDLCK, (offset), (whence), (len))</div><div class="t m0 x32 h5d y3c04 ff1a fs2f fc0 sc0 ls0 ws0">#define readw_lock(fd, offset, whence, len) \</div><div class="t m0 x1f h5d y3c05 ff1a fs2f fc0 sc0 ls0 ws0">lock_reg((fd), F_SETLKW, F_RDLCK, (offset), (whence), (len))</div><div class="t m0 x32 h5d y3c06 ff1a fs2f fc0 sc0 ls0 ws0">#define write_lock(fd, offset, whence, len) \</div><div class="t m0 x1f h5d y3c07 ff1a fs2f fc0 sc0 ls0 ws0">lock_reg((fd), F_SETLK, F_WRLCK, (offset), (whence), (len))</div><div class="t m0 x32 h5d y3c08 ff1a fs2f fc0 sc0 ls0 ws0">#define writew_lock(fd, offset, whence, len) \</div><div class="t m0 x1f h5d y3c09 ff1a fs2f fc0 sc0 ls0 ws0">lock_reg((fd), F_SETLKW, F_WRLCK, (offset), (whence), (len))</div><div class="t m0 x32 h5d y3c0a ff1a fs2f fc0 sc0 ls0 ws0">#define un_lock(fd, offset, whence, len) \</div><div class="t m0 x1f h5d y3c0b ff1a fs2f fc0 sc0 ls0 ws0">lock_reg((fd), F_SETLK, F_UNLCK, (offset), (whence), (len))</div><div class="t m0 x32 h55 y3c0c ff19 fs2c fc0 sc0 ls155 ws0">We <span class="_ _80"> </span>h<span class="_ _9"></span><span class="ls0">ave <span class="_ _3"></span>purposely <span class="_ _3"></span>deﬁned <span class="_ _3"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _3"></span>three <span class="_ _2"></span>arguments <span class="_ _2"></span>to <span class="_ _3"></span>these <span class="_ _3"></span>macros <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _2"></span>same <span class="_ _3"></span>order</span></div><div class="t m0 x32 h54 y3c0d ff19 fs2c fc0 sc0 ls0 ws0">as the<span class="_"> </span><span class="ff1a">lseek<span class="_ _80"> </span></span>function.</div><div class="t m0 x35 h5a y3c0e ff16 fs29 fc0 sc0 ls0 ws0">Example <span class="_ _84"></span>— <span class="_ _84"></span>T<span class="_ _1"></span>esting for a Lock</div><div class="t m0 x32 h5c y3c0f ff19 fs29 fc0 sc0 ls0 ws0">Figur<span class="lsdd">e1<span class="_ _4f"></span><span class="ls0">4.6 deﬁnes the function<span class="_"> </span><span class="ff1a">lock_test<span class="_ _66"> </span></span>that we’ll use to test for a lock.</span></span></div><div class="t m0 x32 h65 y3c10 ff1a fs32 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h65 y3c11 ff1a fs32 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h65 y3c12 ff1a fs32 fc0 sc0 ls0 ws0">pid_t</div><div class="t m0 x32 h65 y3c13 ff1a fs32 fc0 sc0 ls0 ws0">lock_test(int fd, int type, off_t offset, int whence, off_t len)</div><div class="t m0 x32 h65 y3c14 ff1a fs32 fc0 sc0 ls0 ws0">{</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
