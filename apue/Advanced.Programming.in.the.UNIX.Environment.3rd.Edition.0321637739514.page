<div id="pf202" class="pf w4 h1f" data-page-no="202"><div class="pc pc202 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg202.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">480<span class="_ _1b"> </span><span class="ff19">Daemon <span class="_"> </span>Processes <span class="_ _20f"> </span>Chapter<span class="_ _4b"> </span>13</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h57 y2012 ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y2013 ff1a fs2d fc0 sc0 ls0 ws0">set_cloexec(int fd)</div><div class="t m0 x32 h57 y2014 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y2015 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>val;</div><div class="t m0 x8a h57 y1cc2 ff1a fs2d fc0 sc0 ls0 ws0">if ((val = fcntl(fd, F_GETFD, 0)) &lt; 0)</div><div class="t m0 x9d h57 y1cc3 ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h57 y3b0a ff1a fs2d fc0 sc0 ls0 ws0">val |= FD_CLOEXEC;<span class="_ _189"> </span>/* enable close-on-exec */</div><div class="t m0 x8a h57 y1d37 ff1a fs2d fc0 sc0 ls0 ws0">return(fcntl(fd, F_SETFD, val));</div><div class="t m0 x32 h57 y1d38 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x5a h2d y3b0b ff18 fs10 fc0 sc0 ls0 ws0">Figure 13.9<span class="_ _5a"> </span><span class="ff19">Set close-on-exec ﬂag</span></div><div class="t m0 x35 h4b y3b0c ff16 fs27 fc0 sc0 ls0 ws0">13.8 <span class="_ _93"> </span>Summary</div><div class="t m0 x32 h49 y3b0d ff19 fs26 fc0 sc0 ls0 ws0">Daemon processes ar<span class="lsfaa">er<span class="_ _4f"></span><span class="ls0">unning all the <span class="_ _2"></span>time on most <span class="_ _2"></span>UNIX systems.<span class="_ _46"> </span>Initializing our <span class="_ _2"></span>own</span></span></div><div class="t m0 x32 h49 y3b0e ff19 fs26 fc0 sc0 ls0 ws0">process <span class="_"> </span>to <span class="_ _e"> </span>run <span class="_"> </span>as <span class="_"> </span>a <span class="_"> </span>daemon <span class="_"> </span>takes <span class="_"> </span>some <span class="_"> </span>car<span class="_ _0"></span><span class="lsfab">ea<span class="_ _4a"></span><span class="ls0">nd <span class="_"> </span>an <span class="_"> </span>understanding <span class="_"> </span>of <span class="_"> </span>the <span class="_ _e"> </span>process</span></span></div><div class="t m0 x32 h49 y3b0f ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">lationships <span class="_ _9"></span>described <span class="_ _3"></span>in <span class="_ _3"></span>Chapter <span class="_ _3"></span>9.<span class="_ _16"> </span>In <span class="_ _9"></span>this <span class="_ _3"></span>chapter<span class="_ _1"></span>,<span class="_ _47"> </span>we<span class="_ _47"> </span>d<span class="_ _2"></span>eveloped <span class="_ _3"></span>a <span class="_ _3"></span>function <span class="_ _3"></span>that <span class="_ _9"></span>can</span></div><div class="t m0 x32 h49 y3b10 ff19 fs26 fc0 sc0 ls0 ws0">be called by a daemon process to initialize itself corr<span class="_ _0"></span>ectly<span class="_ _4"></span>.</div><div class="t m0 x3f h49 y3b11 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _35"> </span>a<span class="_ _23"></span><span class="ls0">lso <span class="_ _e"> </span>discussed <span class="_ _e"> </span>the <span class="_"> </span>ways <span class="_ _53"> </span>a <span class="_"> </span>daemon <span class="_ _e"> </span>can <span class="_ _e"> </span>log <span class="_"> </span>err<span class="_ _0"></span>or <span class="_ _e"> </span>messages, <span class="_"> </span>since <span class="_ _53"> </span>a <span class="_"> </span>daemon</span></div><div class="t m0 x32 h49 y3b12 ff19 fs26 fc0 sc0 ls0 ws0">normally <span class="_ _42"> </span>doesn’t <span class="_ _42"> </span>have <span class="_ _42"> </span>a <span class="_ _42"> </span>controlling <span class="_ _42"> </span>terminal.<span class="_ _54"> </span><span class="ls164">We <span class="_ _45"> </span>d<span class="_ _9"></span></span>iscussed <span class="_ _42"> </span>several <span class="_ _42"> </span>conventions <span class="_ _42"> </span>that</div><div class="t m0 x32 h49 y3b13 ff19 fs26 fc0 sc0 ls0 ws0">daemons <span class="_ _42"> </span>follow <span class="_ _42"> </span>on <span class="_ _42"> </span>most <span class="_ _42"> </span>UNIX <span class="_ _23"> </span>systems <span class="_ _42"> </span>and <span class="_ _42"> </span>showed <span class="_ _42"> </span>examples <span class="_ _42"> </span>of <span class="_ _42"> </span>how <span class="_ _42"> </span>to <span class="_ _42"> </span>implement</div><div class="t m0 x32 h49 y3b14 ff19 fs26 fc0 sc0 ls0 ws0">some of these conventions.</div><div class="t m0 x32 h4b y3b15 ff16 fs27 fc0 sc0 ls0 ws0">Exer<span class="_ _0"></span>cises</div><div class="t m0 x32 h4e y3b16 ff18 fs28 fc0 sc0 ls0 ws0">13.1<span class="_ _288"> </span><span class="ff19">As <span class="_ _53"> </span>we <span class="_ _42"> </span>might <span class="_ _42"> </span>guess <span class="_ _53"> </span>from <span class="_ _42"> </span>Figur<span class="lsfac">e1<span class="_ _43"></span><span class="ls0">3.2, <span class="_ _42"> </span>when <span class="_ _42"> </span>the<span class="_ _35"> </span><span class="ff1a">syslog<span class="_ _44"> </span></span>facility <span class="_ _42"> </span>is <span class="_ _42"> </span>initialized, <span class="_ _42"> </span>either <span class="_ _53"> </span>by</span></span></span></div><div class="t m0 xe1 h4e y3b17 ff19 fs28 fc0 sc0 ls0 ws0">calling<span class="_"> </span><span class="ff1a">openlog<span class="_ _66"> </span></span>directly or on <span class="_ _2"></span>the <span class="_ _2"></span>ﬁrst <span class="_ _2"></span>call to<span class="_ _66"> </span><span class="ff1a">syslog</span><span class="lsfad">,t<span class="_ _d"></span><span class="ls0">he <span class="_ _2"></span>special <span class="_ _2"></span>device <span class="_ _2"></span>ﬁle for <span class="_ _2"></span>the <span class="_ _2"></span>UNIX</span></span></div><div class="t m0 xe1 h4e y3b18 ff19 fs28 fc0 sc0 ls0 ws0">domain <span class="_ _2"></span>datagram <span class="_ _3"></span>socket,<span class="_ _66"> </span><span class="ff1a">/dev/log</span><span class="lsfae">,h<span class="_ _d"></span><span class="ls0">as <span class="_ _3"></span>to <span class="_ _2"></span>be <span class="_ _3"></span>opened.<span class="_ _46"> </span>What <span class="_ _2"></span>happens <span class="_ _3"></span>if <span class="_ _3"></span>the <span class="_ _3"></span>user <span class="_ _2"></span>process</span></span></div><div class="t m0 xe1 h4e y3b19 ff19 fs28 fc0 sc0 ls0 ws0">(the daemon) calls<span class="_"> </span><span class="ff1a">chroot<span class="_ _e"> </span></span>befor<span class="ls396">ec<span class="_ _5"></span><span class="ls0">alling<span class="_"> </span><span class="ff1a">openlog</span>?</span></span></div><div class="t m0 x32 h4e y3b1a ff18 fs28 fc0 sc0 ls0 ws0">13.2<span class="_ _288"> </span><span class="ff19">Recall <span class="_ _42"> </span>the <span class="_ _23"> </span>sample<span class="_ _35"> </span><span class="ff1a">ps<span class="_ _45"> </span></span>output <span class="_ _23"> </span>from <span class="_ _23"> </span>Section <span class="_ _23"> </span>13.2.<span class="_ _5a"> </span>The <span class="_ _42"> </span>only <span class="_ _23"> </span>user-level <span class="_ _23"> </span>daemon <span class="_ _23"> </span>that <span class="_ _23"> </span>isn’t <span class="_ _42"> </span>a</span></div><div class="t m0 xe1 h4e y3b1b ff19 fs28 fc0 sc0 ls0 ws0">session leader <span class="_ _2"></span>is <span class="_ _2"></span>the<span class="_"> </span><span class="ff1a">rsyslogd<span class="_ _66"> </span></span>process. <span class="_"> </span>Explain<span class="_"> </span>why <span class="_ _2"></span>the<span class="_ _80"> </span><span class="ff1a">syslogd<span class="_ _66"> </span></span>daemon isn’t <span class="_ _2"></span>a <span class="_ _2"></span>session</div><div class="t m0 xe1 h7c y3b1c ff19 fs28 fc0 sc0 ls0 ws0">leader<span class="_ _1"></span>.</div><div class="t m0 x32 h7c y3b1d ff18 fs28 fc0 sc0 ls0 ws0">13.3<span class="_ _288"> </span><span class="ff19">List all the daemons active on your system, and identify the function of each one.</span></div><div class="t m0 x32 h4e y3b1e ff18 fs28 fc0 sc0 ls0 ws0">13.4<span class="_ _288"> </span><span class="ff19 lsfaf">Wr<span class="_ _9"></span><span class="ls0">ite <span class="_"> </span>a <span class="_"> </span>program <span class="_"> </span>that <span class="_ _53"> </span>calls <span class="_"> </span>the<span class="_ _4b"> </span><span class="ff1a">daemonize<span class="_ _4b"> </span></span>function <span class="_"> </span>in <span class="_"> </span>Figur<span class="lsfb0">e1<span class="_ _55"></span><span class="ls0">3.1. <span class="_ _4b"> </span>After<span class="_ _4b"> </span>calling <span class="_"> </span>this</span></span></span></span></div><div class="t m0 xe1 h4e y3b1f ff19 fs28 fc0 sc0 ls0 ws0">function, <span class="_ _9"></span>call<span class="_ _45"> </span><span class="ff1a">getlogin<span class="_ _45"> </span></span>(Section <span class="_ _9"></span>8.15) <span class="_ _23"></span>to <span class="_ _9"></span>see <span class="_ _23"></span>whether <span class="_ _9"></span>the <span class="_ _23"></span>pr<span class="_ _0"></span>ocess <span class="_ _9"></span>has <span class="_ _23"> </span>a <span class="_ _9"></span>login <span class="_ _23"> </span>name <span class="_ _9"></span>now</div><div class="t m0 xe1 h7c y3b20 ff19 fs28 fc0 sc0 ls0 ws0">that it has become a daemon.<span class="_ _4b"> </span>Print the results to a ﬁle.</div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.893050px;bottom:784.240780px;width:90.804497px;height:19.679016px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
