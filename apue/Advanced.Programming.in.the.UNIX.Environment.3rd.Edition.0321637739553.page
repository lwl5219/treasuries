<div id="pf229" class="pf w4 h1f" data-page-no="229"><div class="pc pc229 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg229.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.5<span class="_ _20d"> </span>Asynchronous <span class="_"> </span>I/O<span class="_ _1b"> </span><span class="ff18">519</span></div><div class="t m0 x36 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">numop++;</div><div class="t m0 x1ca h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1ca h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x1f h57 y31b5 ff1a fs2d fc0 sc0 ls0 ws0">case READ_PENDING:</div><div class="t m0 x1ca h57 y124b ff1a fs2d fc0 sc0 ls0 ws0">if ((err = aio_error(&amp;bufs[i].aiocb)) == EINPROGRESS)</div><div class="t m0 x36 h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">continue;</div><div class="t m0 x1ca h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">if (err != 0) {</div><div class="t m0 x36 h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">if (err == -1)</div><div class="t m0 xee h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;aio_error failed&quot;);</div><div class="t m0 x36 h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 xee h57 y8d8 ff1a fs2d fc0 sc0 ls0 ws0">err_exit(err, &quot;read failed&quot;);</div><div class="t m0 x1ca h57 y8d9 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1ca h57 y31b9 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x4 h57 y31ba ff1a fs2d fc0 sc0 ls15c ws0">*Ar<span class="_ _1d"></span><span class="ls0">ead is complete; translate the buffer</span></div><div class="t m0 x4 h57 y31bb ff1a fs2d fc0 sc0 ls15c ws0">*a<span class="_ _1d"></span><span class="ls0">nd write it.</span></div><div class="t m0 x4 h57 y2f71 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x1ca h57 y2f72 ff1a fs2d fc0 sc0 ls0 ws0">if ((n = aio_return(&amp;bufs[i].aiocb)) &lt; 0)</div><div class="t m0 x36 h57 y2f73 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;aio_return failed&quot;);</div><div class="t m0 x1ca h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">if (n != BSZ &amp;&amp; !bufs[i].last)</div><div class="t m0 x36 h57 y8e1 ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;short read (%d/%d)&quot;, n, BSZ);</div><div class="t m0 x1ca h57 y2f74 ff1a fs2d fc0 sc0 ls0 ws0">for (j = 0; j &lt; n; j++)</div><div class="t m0 x36 h57 y2f75 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].data[j] = translate(bufs[i].data[j]);</div><div class="t m0 x1ca h57 y2f76 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].op = WRITE_PENDING;</div><div class="t m0 x1ca h57 y2f77 ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].aiocb.aio_fildes = ofd;</div><div class="t m0 x1ca h57 y31bc ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].aiocb.aio_nbytes = n;</div><div class="t m0 x1ca h57 y3264 ff1a fs2d fc0 sc0 ls0 ws0">if (aio_write(&amp;bufs[i].aiocb) &lt; 0)</div><div class="t m0 x36 h57 y3265 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;aio_write failed&quot;);</div><div class="t m0 x1ca h57 y3266 ff1a fs2d fc0 sc0 ls0 ws0">/* retain our spot in aiolist */</div><div class="t m0 x1ca h57 y3267 ff1a fs2d fc0 sc0 ls0 ws0">break;</div><div class="t m0 x1f h57 y2f7d ff1a fs2d fc0 sc0 ls0 ws0">case WRITE_PENDING:</div><div class="t m0 x1ca h57 y2f7e ff1a fs2d fc0 sc0 ls0 ws0">if ((err = aio_error(&amp;bufs[i].aiocb)) == EINPROGRESS)</div><div class="t m0 x36 h57 y3269 ff1a fs2d fc0 sc0 ls0 ws0">continue;</div><div class="t m0 x1ca h57 y326a ff1a fs2d fc0 sc0 ls0 ws0">if (err != 0) {</div><div class="t m0 x36 h57 y326b ff1a fs2d fc0 sc0 ls0 ws0">if (err == -1)</div><div class="t m0 xee h57 y326c ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;aio_error failed&quot;);</div><div class="t m0 x36 h57 y326d ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 xee h57 y326e ff1a fs2d fc0 sc0 ls0 ws0">err_exit(err, &quot;write failed&quot;);</div><div class="t m0 x1ca h57 y326f ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1ca h57 y3f87 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x4 h57 y3f88 ff1a fs2d fc0 sc0 ls15c ws0">*Aw<span class="_ _1d"></span><span class="ls0">rite is complete; mark the buffer as unused.</span></div><div class="t m0 x4 h57 y3f89 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x1ca h57 y3f8a ff1a fs2d fc0 sc0 ls0 ws0">if ((n = aio_return(&amp;bufs[i].aiocb)) &lt; 0)</div><div class="t m0 x36 h57 y3f8b ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;aio_return failed&quot;);</div><div class="t m0 x1ca h57 y3f8c ff1a fs2d fc0 sc0 ls0 ws0">if (n != bufs[i].aiocb.aio_nbytes)</div><div class="t m0 x36 h57 y3f8d ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;short write (%d/%d)&quot;, n, BSZ);</div><div class="t m0 x1ca h57 y3f8e ff1a fs2d fc0 sc0 ls0 ws0">aiolist[i] = NULL;</div><div class="t m0 x1ca h57 y3f8f ff1a fs2d fc0 sc0 ls0 ws0">bufs[i].op = UNUSED;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
