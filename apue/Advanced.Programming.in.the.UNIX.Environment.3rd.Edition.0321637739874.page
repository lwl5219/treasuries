<div id="pf36a" class="pf w4 h1f" data-page-no="36a"><div class="pc pc36a w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg36a.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">840<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">853 <span class="_ _82"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">854 <span class="_ _166"> </span>*<span class="_"> </span>HTTP request was okay, but still need to check</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">855 <span class="_ _166"> </span>*<span class="_"> </span>IPP status.<span class="_ _3a"> </span>Search for the Content-Length.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">856 <span class="_ _166"> </span>*/</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">857 <span class="_ _82"> </span>i<span class="_"> </span>=<span class="_"> </span>cp<span class="_"> </span>-<span class="_"> </span>bp;</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">858 <span class="_ _82"> </span>for<span class="_"> </span>(;;) {</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">859 <span class="_ _1e7"> </span>while<span class="_"> </span>(*cp != ’C’ &amp;&amp; *cp != ’c’ &amp;&amp; i &lt; datsz) {</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">860 <span class="_ _296"> </span>cp++;</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">861 <span class="_ _296"> </span>i++;</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">862 <span class="_ _1e7"> </span>}</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">863 <span class="_ _1e7"> </span>if<span class="_"> </span>(i &gt;= datsz) {<span class="_ _68"> </span>/* get more header */</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">864 <span class="_ _296"> </span>if<span class="_"> </span>((nr = readmore(sfd, &amp;bp, i, &amp;bufsz)) &lt; 0) {</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">865 <span class="_ _1e6"> </span>goto<span class="_"> </span>out;</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">866 <span class="_ _296"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">867 <span class="_ _1e6"> </span>cp<span class="_"> </span><span class="ls15c">=&amp;<span class="_ _1d"></span><span class="ls0">bp[i];</span></span></div><div class="t m0 x32 h57 y56d0 ff1a fs2d fc0 sc0 ls0 ws0">868 <span class="_ _1e6"> </span>datsz<span class="_"> </span>+= nr;</div><div class="t m0 x32 h57 y56d1 ff1a fs2d fc0 sc0 ls0 ws0">869 <span class="_ _296"> </span>}</div><div class="t m0 x32 h57 y56d2 ff1a fs2d fc0 sc0 ls0 ws0">870 <span class="_ _1e7"> </span>}</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">871 <span class="_ _1e7"> </span>if<span class="_"> </span>(strncasecmp(cp, &quot;Content-Length:&quot;, 15) == 0) {</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">872 <span class="_ _296"> </span>cp<span class="_"> </span>+= 15;</div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">873 <span class="_ _296"> </span>while<span class="_"> </span>(isspace((int)*cp))</div><div class="t m0 x32 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">874 <span class="_ _1e6"> </span>cp++;</div><div class="t m0 x32 h57 y2f2f ff1a fs2d fc0 sc0 ls0 ws0">875 <span class="_ _296"> </span>contentlen<span class="_"> </span><span class="ls15c">=c<span class="_ _1d"></span><span class="ls0">p;</span></span></div><div class="t m0 x32 h57 y2f30 ff1a fs2d fc0 sc0 ls0 ws0">876 <span class="_ _296"> </span>while<span class="_"> </span>(isdigit((int)*cp))</div><div class="t m0 x32 h57 y56fd ff1a fs2d fc0 sc0 ls0 ws0">877 <span class="_ _1e6"> </span>cp++;</div><div class="t m0 x32 h57 y5848 ff1a fs2d fc0 sc0 ls0 ws0">878 <span class="_ _296"> </span>*cp++<span class="_"> </span><span class="ls15c">=’<span class="_ _1d"></span><span class="ls0">\0’;</span></span></div><div class="t m0 x32 h57 y5849 ff1a fs2d fc0 sc0 ls0 ws0">879 <span class="_ _296"> </span>i<span class="_"> </span>=<span class="_"> </span>cp<span class="_"> </span>-<span class="_"> </span>bp;</div><div class="t m0 x32 h57 y5a25 ff1a fs2d fc0 sc0 ls0 ws0">880 <span class="_ _296"> </span>len<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">toi(contentlen);</span></span></div><div class="t m0 x32 h57 y5a26 ff1a fs2d fc0 sc0 ls0 ws0">881 <span class="_ _296"> </span>break;</div><div class="t m0 x32 h57 y5a36 ff1a fs2d fc0 sc0 ls0 ws0">882 <span class="_ _1e7"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y5a37 ff1a fs2d fc0 sc0 ls0 ws0">883 <span class="_ _296"> </span>cp++;</div><div class="t m0 x32 h57 y5a38 ff1a fs2d fc0 sc0 ls0 ws0">884 <span class="_ _296"> </span>i++;</div><div class="t m0 x32 h57 y5a39 ff1a fs2d fc0 sc0 ls0 ws0">885 <span class="_ _1e7"> </span>}</div><div class="t m0 x32 h57 y5a3a ff1a fs2d fc0 sc0 ls0 ws0">886 <span class="_ _82"> </span>}</div><div class="t m0 x32 h49 y5cbe ff19 fs26 fc0 sc0 ls0 ws0">[853 <span class="_ _a"></span>– <span class="_ _a"></span>870]<span class="_ _65"> </span>If <span class="_ _23"></span>the <span class="_ _23"></span>HTTP <span class="_ _23"></span>request <span class="_ _9"></span>succeeds, <span class="_ _23"> </span>we <span class="_ _23"> </span>need <span class="_ _23"> </span>to <span class="_ _23"> </span>check <span class="_ _23"> </span>the <span class="_ _23"> </span>IPP <span class="_ _23"> </span>status.<span class="_ _51"> </span><span class="ls164">We <span class="_ _47"> </span>s<span class="_ _9"></span></span>earch</div><div class="t m0 x11a h4d y5cbf ff19 fs26 fc0 sc0 ls0 ws0">through <span class="_ _9"></span>the <span class="_ _23"> </span>message <span class="_ _23"> </span>until <span class="_ _42"> </span>we <span class="_ _23"></span>ﬁnd <span class="_ _23"></span>the<span class="_ _35"> </span><span class="ff1a">Content-Length<span class="_ _45"> </span></span>attribute. <span class="_ _35"> </span>HTTP</div><div class="t m0 x11a h49 y5cc0 ff19 fs26 fc0 sc0 ls0 ws0">header <span class="_ _23"> </span>keywords <span class="_ _23"></span>ar<span class="ls167f">ec<span class="_ _43"></span><span class="ls0">ase <span class="_ _23"></span>insensitive, <span class="_ _23"> </span>so <span class="_ _42"> </span>we <span class="_ _23"></span>need <span class="_ _23"> </span>to <span class="_ _42"> </span>check <span class="_ _23"></span>both <span class="_ _23"> </span>lowercase</span></span></div><div class="t m0 x11a h4d y5cc1 ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _3"></span>uppercase <span class="_ _2"></span>characters.<span class="_ _16"> </span>If <span class="_ _3"></span>we <span class="_ _3"></span>run <span class="_ _2"></span>out <span class="_ _3"></span>of <span class="_ _9"></span>buffer <span class="_ _2"></span>space, <span class="_ _3"></span>we <span class="_ _3"></span>call<span class="_ _47"> </span><span class="ff1a">readmore</span>,</div><div class="t m0 x11a h4d y5cc2 ff19 fs26 fc0 sc0 ls0 ws0">which <span class="_ _3"></span>uses<span class="_ _47"> </span><span class="ff1a">realloc<span class="_ _45"> </span></span>to <span class="_ _2"></span>increase <span class="_ _3"></span>the <span class="_ _3"></span>buffer <span class="_ _3"></span>size.<span class="_ _16"> </span>Because <span class="_ _3"></span>the <span class="_ _3"></span>buffer <span class="_ _3"></span>address</div><div class="t m0 x11a h4d y5cc3 ff19 fs26 fc0 sc0 ls0 ws0">might change, we need to adjust<span class="_ _66"> </span><span class="ff1a">cp<span class="_ _66"> </span></span>to point to the correct place in the buffer<span class="_ _6"></span>.</div><div class="t m0 x32 h4d y5cc4 ff19 fs26 fc0 sc0 ls0 ws0">[871 <span class="_ _a"></span>– <span class="_ _a"></span>886]<span class="_ _65"> </span><span class="ls164">We <span class="_ _47"> </span>u<span class="_ _9"></span></span>se <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">strncasecmp<span class="_ _35"> </span></span>function <span class="_ _9"></span>to <span class="_ _23"></span>do <span class="_ _23"></span>a <span class="_ _9"></span>case-insensitive <span class="_ _23"> </span>comparison.<span class="_ _51"> </span>If</div><div class="t m0 x11a h4d y5cc5 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _9"></span>ﬁnd <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">Content-Length<span class="_ _45"> </span></span>attribute <span class="_ _9"></span>string, <span class="_ _9"></span>we <span class="_ _9"></span>search <span class="_ _9"></span>for <span class="_ _9"></span>its <span class="_ _9"></span>value.<span class="_ _5a"> </span><span class="ls164">We</span></div><div class="t m0 x11a h4d y5cc6 ff19 fs26 fc0 sc0 ls0 ws0">convert <span class="_ _2"></span>this <span class="_ _2"></span>numeric <span class="_ _3"></span>string <span class="_ _2"></span>into <span class="_ _2"></span>an <span class="_ _3"></span>integer <span class="_ _2"></span>and <span class="_ _2"></span>break <span class="_ _2"></span>out <span class="_ _3"></span>of <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">for<span class="_ _66"> </span></span>loop. <span class="_ _47"> </span>If</div><div class="t m0 x11a h49 y5cc7 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _23"></span>comparison <span class="_ _23"></span>fails, <span class="_ _23"></span>we <span class="_ _23"></span>continue <span class="_ _23"></span>searching <span class="_ _9"></span>the <span class="_ _23"> </span>buffer <span class="_ _23"></span>byte <span class="_ _23"></span>by <span class="_ _23"></span>byte.<span class="_ _5a"> </span>If <span class="_ _23"> </span>we</div><div class="t m0 x11a h4d y5cc8 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ach <span class="_ _3"></span>the <span class="_ _3"></span>end <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>buffer <span class="_ _3"></span>without <span class="_ _3"></span>ﬁnding <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">Content-Length<span class="_ _47"> </span></span>attribute,</span></div><div class="t m0 x11a h49 y5cc9 ff19 fs26 fc0 sc0 ls0 ws0">we read mor<span class="_ _0"></span><span class="lsd3">ef<span class="_ _d"></span><span class="lscc">ro<span class="lsd3">mt<span class="_ _5"></span><span class="ls0">he printer and continue the search.</span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
