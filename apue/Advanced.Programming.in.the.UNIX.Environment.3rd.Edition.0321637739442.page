<div id="pf1ba" class="pf w4 h1f" data-page-no="1ba"><div class="pc pc1ba w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1ba.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">408<span class="_ _1b"> </span><span class="ff19">Threads <span class="_ _24b"> </span>Chapter<span class="_ _78"> </span><span class="ls7ed">11</span></span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;pthread.h&gt;</div><div class="t m0 x32 h57 y2012 ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y2013 ff1a fs2d fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h57 y2014 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y2015 ff1a fs2d fc0 sc0 ls0 ws0">int err;</div><div class="t m0 x8a h57 y33ad ff1a fs2d fc0 sc0 ls0 ws0">struct timespec tout;</div><div class="t m0 x8a h57 y33ae ff1a fs2d fc0 sc0 ls0 ws0">struct tm *tmp;</div><div class="t m0 x8a h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">char buf[64];</div><div class="t m0 x8a h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_t lock = PTHREAD_MUTEX_INITIALIZER;</div><div class="t m0 x8a h57 y2016 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_lock(&amp;lock);</div><div class="t m0 x8a h57 y2017 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;mutex is locked\n&quot;);</div><div class="t m0 x8a h57 y2018 ff1a fs2d fc0 sc0 ls0 ws0">clock_gettime(CLOCK_REALTIME, &amp;tout);</div><div class="t m0 x8a h57 y2ad4 ff1a fs2d fc0 sc0 ls0 ws0">tmp = localtime(&amp;tout.tv_sec);</div><div class="t m0 x8a h57 y2ad5 ff1a fs2d fc0 sc0 ls0 ws0">strftime(buf, sizeof(buf), &quot;%r&quot;, tmp);</div><div class="t m0 x8a h57 y2ad6 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;current time is %s\n&quot;, buf);</div><div class="t m0 x8a h57 y33b1 ff1a fs2d fc0 sc0 ls0 ws0">tout.tv_sec += 10;<span class="_ _d9"> </span>/* 10 seconds from now */</div><div class="t m0 x8a h57 y33b2 ff1a fs2d fc0 sc0 ls0 ws0">/* caution: this could lead to deadlock */</div><div class="t m0 x8a h57 y33b3 ff1a fs2d fc0 sc0 ls0 ws0">err = pthread_mutex_timedlock(&amp;lock, &amp;tout);</div><div class="t m0 x8a h57 y33b4 ff1a fs2d fc0 sc0 ls0 ws0">clock_gettime(CLOCK_REALTIME, &amp;tout);</div><div class="t m0 x8a h57 y33b5 ff1a fs2d fc0 sc0 ls0 ws0">tmp = localtime(&amp;tout.tv_sec);</div><div class="t m0 x8a h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">strftime(buf, sizeof(buf), &quot;%r&quot;, tmp);</div><div class="t m0 x8a h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;the time is now %s\n&quot;, buf);</div><div class="t m0 x8a h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">if (err == 0)</div><div class="t m0 x9d h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;mutex locked again!\n&quot;);</div><div class="t m0 x8a h57 y33b9 ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 x9d h57 y33ba ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;can’t lock mutex again: %s\n&quot;, strerror(err));</div><div class="t m0 x8a h57 y33bb ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y33bc ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xab h5e y33bd ff18 fs10 fc0 sc0 ls0 ws0">Figure 1<span class="_ _0"></span>1.13<span class="_ _54"> </span><span class="ff19">Using<span class="_"> </span><span class="ff1a">pthread_mutex_timedlock</span></span></div><div class="t m0 x3f h49 y33be ff19 fs26 fc0 sc0 ls0 ws0">Here<span class="_"> </span>is<span class="_"> </span>the output fr<span class="_ _0"></span>om the pr<span class="_ _0"></span>ogram in Figur<span class="lsd3">e1<span class="_ _b"></span><span class="ls0">1.13.</span></span></div><div class="t m0 x3f h4e y33bf ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h4e y33c0 ff1a fs28 fc0 sc0 ls0 ws0">mutex is locked</div><div class="t m0 x3f h4e y33c1 ff1a fs28 fc0 sc0 ls0 ws0">current time is 11:41:58 AM</div><div class="t m0 x3f h4e y33c2 ff1a fs28 fc0 sc0 ls0 ws0">the time is now 11:42:08 AM</div><div class="t m0 x3f h4e y33c3 ff1a fs28 fc0 sc0 ls0 ws0">can’t lock mutex again: Connection timed out</div><div class="t m0 x3f h49 y33c4 ff19 fs26 fc0 sc0 ls0 ws0">This <span class="_ _66"> </span>program <span class="_ _47"> </span>deliberately <span class="_ _66"> </span>locks <span class="_ _47"> </span>a <span class="_ _66"> </span>mutex <span class="_ _47"> </span>it <span class="_ _47"> </span>already <span class="_"> </span>owns <span class="_ _47"> </span>to <span class="_ _47"> </span>demonstrate <span class="_ _66"> </span>how</div><div class="t m0 x32 h4d y33c5 ff1a fs26 fc0 sc0 ls0 ws0">pthread_mutex_timedlock<span class="_ _44"> </span><span class="ff19">works. <span class="_ _44"> </span>This<span class="_ _44"> </span>strategy <span class="_ _42"> </span>is <span class="_ _42"> </span>not <span class="_ _53"> </span>recommended <span class="_ _42"> </span>in <span class="_ _42"> </span>practice,</span></div><div class="t m0 x32 h49 y33c6 ff19 fs26 fc0 sc0 ls0 ws0">because it can lead to deadlock.</div><div class="t m0 x3f h49 y33c7 ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _9"></span>that <span class="_ _23"></span>the <span class="_ _9"></span>time <span class="_ _23"></span>blocked <span class="_ _9"></span>can <span class="_ _23"> </span>vary <span class="_ _23"></span>for <span class="_ _9"></span>several <span class="_ _23"></span>reasons: <span class="_ _9"></span>the <span class="_ _9"></span>start <span class="_ _23"></span>time <span class="_ _9"></span>could <span class="_ _23"></span>have</div><div class="t m0 x32 h49 y33c8 ff19 fs26 fc0 sc0 ls0 ws0">been <span class="_ _23"></span>in <span class="_ _9"></span>the <span class="_ _23"> </span>middle <span class="_ _23"></span>of <span class="_ _23"></span>a <span class="_ _9"></span>second, <span class="_ _23"> </span>the <span class="_ _23"></span>resolution <span class="_ _9"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>system’s <span class="_ _9"></span>clock <span class="_ _23"> </span>might <span class="_ _23"></span>not <span class="_ _23"></span>be <span class="_ _9"></span>ﬁne</div><div class="t m0 x32 h49 y33c9 ff19 fs26 fc0 sc0 ls0 ws0">enough to support the resolution of our timeout, or scheduling delays could pr<span class="_ _0"></span>olong the</div><div class="t m0 x32 h49 y33ca ff19 fs26 fc0 sc0 ls0 ws0">amount of time until the program continues execution.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
