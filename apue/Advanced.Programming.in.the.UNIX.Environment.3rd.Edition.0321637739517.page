<div id="pf205" class="pf w4 h1f" data-page-no="205"><div class="pc pc205 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg205.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.2<span class="_ _23a"> </span>Nonblocking <span class="_"> </span>I/O<span class="_ _1b"> </span><span class="ff18">483</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h57 y2f1e ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>buf[500000];</div><div class="t m0 x32 h57 y1d7b ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y2197 ff1a fs2d fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h57 y2f21 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y2f22 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>ntowrite,<span class="_"> </span>nwrite;</div><div class="t m0 x8a h57 y2f23 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _68"> </span>*ptr;</div><div class="t m0 x8a h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">ntowrite = read(STDIN_FILENO, buf, sizeof(buf));</div><div class="t m0 x8a h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">fprintf(stderr, &quot;read %d bytes\n&quot;, ntowrite);</div><div class="t m0 x8a h57 y2c5c ff1a fs2d fc0 sc0 ls0 ws0">set_fl(STDOUT_FILENO, O_NONBLOCK);<span class="_ _d9"> </span>/* set nonblocking */</div><div class="t m0 x8a h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">ptr = buf;</div><div class="t m0 x8a h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">while (ntowrite &gt; 0) {</div><div class="t m0 x9d h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">errno = 0;</div><div class="t m0 x9d h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">nwrite = write(STDOUT_FILENO, ptr, ntowrite);</div><div class="t m0 x9d h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">fprintf(stderr, &quot;nwrite = %d, errno = %d\n&quot;, nwrite, errno);</div><div class="t m0 x9d h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">if (nwrite &gt; 0) {</div><div class="t m0 x1f h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">ptr += nwrite;</div><div class="t m0 x1f h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">ntowrite -= nwrite;</div><div class="t m0 x9d h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y33b9 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y3b4f ff1a fs2d fc0 sc0 ls0 ws0">clr_fl(STDOUT_FILENO, O_NONBLOCK);<span class="_ _d9"> </span>/* clear nonblocking */</div><div class="t m0 x8a h57 y3b50 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y3b51 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xa8 h5e y3b52 ff18 fs10 fc0 sc0 ls0 ws0">Figure 14.1<span class="_ _5a"> </span><span class="ff19">Large nonblocking<span class="_"> </span><span class="ff1a">write</span></span></div><div class="t m0 x3f h4d y3b53 ff19 fs26 fc0 sc0 ls0 ws0">If the standar<span class="lsd3">do<span class="_ _4f"></span><span class="ls0">utput is a regular ﬁle, we expect the<span class="_"> </span><span class="ff1a">write<span class="_ _80"> </span></span>to be executed once:</span></span></div><div class="t m0 x3f h4e y3b54 ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">ls -l /etc/services<span class="_ _168"> </span><span class="ff1b">print ﬁle size</span></span></div><div class="t m0 x3f h4e y3b55 ff1a fs28 fc0 sc0 ls0 ws0">-rw-r--r-- <span class="_"> </span>1<span class="_"> </span>root <span class="_ _15"> </span>677959<span class="_"> </span>Jun 23<span class="_ _d9"> </span>2009 /etc/services</div><div class="t m0 x3f h4e y3b56 ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out &lt; /etc/services &gt; temp.file<span class="_ _bc"> </span><span class="ff1b">try a regular ﬁle ﬁrst</span></span></div><div class="t m0 x3f h4e y3b57 ff1a fs28 fc0 sc0 ls0 ws0">read 500000 bytes</div><div class="t m0 x3f h4e y3b58 ff1a fs28 fc0 sc0 ls0 ws0">nwrite = 500000, errno = 0<span class="_ _29e"> </span><span class="ff1b ls396">as<span class="_ _5"></span><span class="ls0">ingle write</span></span></div><div class="t m0 x3f h4e y3b59 ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">ls -l temp.file<span class="_ _29f"> </span><span class="ff1b">verify size of output ﬁle</span></span></div><div class="t m0 x3f h4e y3b5a ff1a fs28 fc0 sc0 ls0 ws0">-rw-rw-r-- <span class="_"> </span>1<span class="_"> </span>sar <span class="_ _8a"> </span>500000<span class="_"> </span>Apr <span class="_"> </span>1<span class="_"> </span>13:03 temp.file</div><div class="t m0 x32 h4d y3b5b ff19 fs26 fc0 sc0 ls0 ws0">But <span class="_ _3"></span>if <span class="_ _9"></span>the <span class="_ _9"></span>standar<span class="lsfc9">do<span class="_ _b"></span><span class="ls0">utput <span class="_ _9"></span>is <span class="_ _3"></span>a <span class="_ _9"></span>terminal, <span class="_ _9"></span>we <span class="_ _9"></span>expect <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">write<span class="_ _45"> </span></span>to <span class="_ _3"></span>return <span class="_ _3"></span>a <span class="_ _9"></span>partial <span class="_ _9"></span>count</span></span></div><div class="t m0 x32 h49 y3b5c ff19 fs26 fc0 sc0 ls0 ws0">sometimes and an error at other times.<span class="_ _59"> </span>This is what we see:</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
