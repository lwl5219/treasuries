<div id="pf36b" class="pf w4 h1f" data-page-no="36b"><div class="pc pc36b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg36b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">841</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">887 <span class="_ _82"> </span>if<span class="_"> </span>(i &gt;= datsz) {<span class="_ _68"> </span>/* get more header */</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">888 <span class="_ _1e7"> </span>if<span class="_"> </span>((nr = readmore(sfd, &amp;bp, i, &amp;bufsz)) &lt; 0) {</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">889 <span class="_ _296"> </span>goto<span class="_"> </span>out;</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">890 <span class="_ _1e7"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">891 <span class="_ _296"> </span>cp<span class="_"> </span><span class="ls15c">=&amp;<span class="_ _1d"></span><span class="ls0">bp[i];</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">892 <span class="_ _296"> </span>datsz<span class="_"> </span>+= nr;</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">893 <span class="_ _1e7"> </span>}</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">894 <span class="_ _82"> </span>}</div><div class="t m0 x32 h57 y1fba ff1a fs2d fc0 sc0 ls0 ws0">895 <span class="_ _82"> </span>found<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y1fbb ff1a fs2d fc0 sc0 ls0 ws0">896 <span class="_ _82"> </span>while<span class="_"> </span>(!found) {<span class="_ _3a"> </span>/* look for end of HTTP header */</div><div class="t m0 x32 h57 y1fbc ff1a fs2d fc0 sc0 ls0 ws0">897 <span class="_ _1e7"> </span>while<span class="_"> </span>(i &lt; datsz - 2) {</div><div class="t m0 x32 h57 y1fbd ff1a fs2d fc0 sc0 ls0 ws0">898 <span class="_ _296"> </span>if<span class="_"> </span>(*cp == ’\n’ &amp;&amp; *(cp + 1) == ’\r’ &amp;&amp;</div><div class="t m0 x32 h57 y1fbe ff1a fs2d fc0 sc0 ls0 ws0">899 <span class="_ _1e5"> </span>*(cp<span class="_"> </span>+<span class="_"> </span>2)<span class="_"> </span>==<span class="_"> </span>’\n’) {</div><div class="t m0 x32 h57 y1fbf ff1a fs2d fc0 sc0 ls0 ws0">900 <span class="_ _1e6"> </span>found<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y1fc0 ff1a fs2d fc0 sc0 ls0 ws0">901 <span class="_ _1e6"> </span>cp<span class="_"> </span>+= 3;</div><div class="t m0 x32 h57 y1fc1 ff1a fs2d fc0 sc0 ls0 ws0">902 <span class="_ _1e6"> </span>i<span class="_"> </span>+= 3;</div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">903 <span class="_ _1e6"> </span>break;</div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">904 <span class="_ _296"> </span>}</div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">905 <span class="_ _296"> </span>cp++;</div><div class="t m0 x32 h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">906 <span class="_ _296"> </span>i++;</div><div class="t m0 x32 h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">907 <span class="_ _1e7"> </span>}</div><div class="t m0 x32 h57 y57b4 ff1a fs2d fc0 sc0 ls0 ws0">908 <span class="_ _1e7"> </span>if<span class="_"> </span>(i &gt;= datsz) {<span class="_ _68"> </span>/* get more header */</div><div class="t m0 x32 h57 y419b ff1a fs2d fc0 sc0 ls0 ws0">909 <span class="_ _296"> </span>if<span class="_"> </span>((nr = readmore(sfd, &amp;bp, i, &amp;bufsz)) &lt; 0) {</div><div class="t m0 x32 h57 y419c ff1a fs2d fc0 sc0 ls0 ws0">910 <span class="_ _1e6"> </span>goto<span class="_"> </span>out;</div><div class="t m0 x32 h57 y5bef ff1a fs2d fc0 sc0 ls0 ws0">911 <span class="_ _296"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y5bf0 ff1a fs2d fc0 sc0 ls0 ws0">912 <span class="_ _1e6"> </span>cp<span class="_"> </span><span class="ls15c">=&amp;<span class="_ _1d"></span><span class="ls0">bp[i];</span></span></div><div class="t m0 x32 h57 y5bf1 ff1a fs2d fc0 sc0 ls0 ws0">913 <span class="_ _1e6"> </span>datsz<span class="_"> </span>+= nr;</div><div class="t m0 x32 h57 y568e ff1a fs2d fc0 sc0 ls0 ws0">914 <span class="_ _296"> </span>}</div><div class="t m0 x32 h57 y5bf2 ff1a fs2d fc0 sc0 ls0 ws0">915 <span class="_ _1e7"> </span>}</div><div class="t m0 x32 h57 y5bf3 ff1a fs2d fc0 sc0 ls0 ws0">916 <span class="_ _82"> </span>}</div><div class="t m0 x32 h57 y57b6 ff1a fs2d fc0 sc0 ls0 ws0">917 <span class="_ _82"> </span>if<span class="_"> </span>(datsz - i &lt; len) {<span class="_ _3a"> </span>/* get more header */</div><div class="t m0 x32 h57 y57b7 ff1a fs2d fc0 sc0 ls0 ws0">918 <span class="_ _1e7"> </span>if<span class="_"> </span>((nr = readmore(sfd, &amp;bp, i, &amp;bufsz)) &lt; 0) {</div><div class="t m0 x32 h57 y57b8 ff1a fs2d fc0 sc0 ls0 ws0">919 <span class="_ _296"> </span>goto<span class="_"> </span>out;</div><div class="t m0 x32 h57 y57b9 ff1a fs2d fc0 sc0 ls0 ws0">920 <span class="_ _1e7"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y57ba ff1a fs2d fc0 sc0 ls0 ws0">921 <span class="_ _296"> </span>cp<span class="_"> </span><span class="ls15c">=&amp;<span class="_ _1d"></span><span class="ls0">bp[i];</span></span></div><div class="t m0 x32 h57 y5b81 ff1a fs2d fc0 sc0 ls0 ws0">922 <span class="_ _296"> </span>datsz<span class="_"> </span>+= nr;</div><div class="t m0 x32 h4d y5cca ff19 fs26 fc0 sc0 ls0 ws0">[887 <span class="_ _a"></span>– <span class="_ _a"></span>916]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>n<span class="_ _9"></span></span>ow know the length of the message (speciﬁed by the<span class="_"> </span><span class="ff1a">Content-Length</span></div><div class="t m0 x11a h49 y5ccb ff19 fs26 fc0 sc0 ls0 ws0">attribute). <span class="_ _47"> </span>If<span class="_ _47"> </span>we’ve <span class="_ _3"></span>exhausted <span class="_ _3"></span>the <span class="_ _3"></span>contents <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>buffer<span class="_ _6"></span>,<span class="_ _47"> </span>we<span class="_ _47"> </span>read <span class="_ _2"></span>mor<span class="lsf9d">ef<span class="_ _8"></span><span class="lscc">ro<span class="ls0">m</span></span></span></div><div class="t m0 x11a h49 y5ccc ff19 fs26 fc0 sc0 ls0 ws0">the printer<span class="_ _1"></span><span class="ls17df">.N<span class="_ _5b"></span><span class="ls0">ext <span class="_ _2"></span>we <span class="_ _2"></span>search for <span class="_ _2"></span>the <span class="_ _2"></span>end <span class="_ _2"></span>of the <span class="_ _2"></span>HTTP <span class="_ _2"></span>header <span class="_ _2"></span>(a <span class="_ _2"></span>blank <span class="_ _2"></span>line).<span class="_ _46"> </span>If</span></span></div><div class="t m0 x11a h4d y5ccd ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _2"></span>ﬁnd <span class="_ _3"></span>it, <span class="_ _3"></span>we <span class="_ _3"></span>set <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">found<span class="_ _47"> </span></span>ﬂag <span class="_ _3"></span>and <span class="_ _3"></span>skip <span class="_ _3"></span>the <span class="_ _2"></span>blank <span class="_ _3"></span>line.<span class="_ _16"> </span>Whenever <span class="_ _3"></span>we <span class="_ _2"></span>call</div><div class="t m0 x11a h4d y5cce ff1a fs26 fc0 sc0 ls0 ws0">readmore<span class="ff19">,<span class="_ _35"> </span>we<span class="_ _44"> </span>set<span class="_ _44"> </span></span>cp<span class="_ _35"> </span><span class="ff19">to <span class="_ _42"> </span>point <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _42"> </span>same <span class="_ _42"> </span>offset <span class="_ _42"> </span>in <span class="_ _42"> </span>the <span class="_ _42"> </span>buffer <span class="_ _23"> </span>that <span class="_ _42"> </span>it <span class="_ _42"> </span>had</span></div><div class="t m0 x11a h49 y5ccf ff19 fs26 fc0 sc0 ls0 ws0">previously just in case the buf<span class="_ _0"></span>fer addr<span class="_ _0"></span>ess changed when it was reallocated.</div><div class="t m0 x32 h49 y5cd0 ff19 fs26 fc0 sc0 ls0 ws0">[917 <span class="_ _a"></span>– <span class="_ _a"></span>922]<span class="_ _65"> </span>When we <span class="_ _2"></span>ﬁnd <span class="_ _2"></span>the end <span class="_ _2"></span>of <span class="_ _2"></span>the HTTP <span class="_ _2"></span>header<span class="_ _1"></span>,<span class="_"> </span>we<span class="_ _66"> </span>calculate <span class="_ _2"></span>the <span class="_ _2"></span>number of <span class="_ _2"></span>bytes</div><div class="t m0 x11a h49 y5cd1 ff19 fs26 fc0 sc0 ls0 ws0">that the HTTP header consumed.<span class="_ _59"> </span>If the amount we’ve read minus the size of</div><div class="t m0 x11a h49 y5cd2 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>HTTP <span class="_ _3"></span>header <span class="_ _3"></span>is <span class="_ _3"></span>not <span class="_ _3"></span>equal <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>amount <span class="_ _3"></span>of <span class="_ _3"></span>data <span class="_ _3"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>IPP <span class="_ _3"></span>message <span class="_ _3"></span>(the</div><div class="t m0 x11a h49 y5cd3 ff19 fs26 fc0 sc0 ls0 ws0">value we calculated from the content length), then we r<span class="_ _0"></span>ead some mor<span class="_ _0"></span>e.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
