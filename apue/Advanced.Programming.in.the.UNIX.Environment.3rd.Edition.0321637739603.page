<div id="pf25b" class="pf w4 h1f" data-page-no="25b"><div class="pc pc25b w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg25b.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>15.8<span class="_ _e9"> </span>Semaphor<span class="_ _0"></span>es<span class="_ _1b"> </span><span class="ff18">569</span></div><div class="t m0 xf8 h57 yf5f ff1a fs2d fc0 sc0 ls0 ws0">struct sembuf {</div><div class="t m0 x3f h57 yf60 ff1a fs2d fc0 sc0 ls0 ws0">unsigned short<span class="_ _d9"> </span>sem_num; <span class="_"> </span>/*<span class="_"> </span>member # in set (0, 1, ..., nsems-1) */</div><div class="t m0 x3f h57 yf61 ff1a fs2d fc0 sc0 ls0 ws0">short <span class="_ _74"> </span>sem_op;<span class="_ _87"> </span>/* operation (negative, 0, or positive) */</div><div class="t m0 x3f h57 yf62 ff1a fs2d fc0 sc0 ls0 ws0">short <span class="_ _74"> </span>sem_flg;<span class="_ _3a"> </span>/* IPC_NOWAIT, SEM_UNDO */</div><div class="t m0 xf8 h57 yf63 ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h2b y44d9 ff19 fsf fc0 sc0 ls0 ws0">The<span class="_"> </span><span class="ff1b">nops<span class="_"> </span></span>argument speciﬁes the number of operations (elements) in the array<span class="_ _4"></span>.</div><div class="t m0 x3f h26 y44da ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _2"></span>operation <span class="_ _3"></span>on <span class="_ _2"></span>each <span class="_ _3"></span>member <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>set <span class="_ _3"></span>is <span class="_ _3"></span>speciﬁed <span class="_ _2"></span>by <span class="_ _3"></span>the <span class="_ _2"></span>corresponding<span class="_ _66"> </span><span class="ff1a">sem_op</span></div><div class="t m0 x32 h2a y44db ff19 fsf fc0 sc0 ls0 ws0">value. <span class="_ _47"> </span>This<span class="_ _47"> </span>value <span class="_ _3"></span>can <span class="_ _3"></span>be <span class="_ _3"></span>negative, <span class="_ _3"></span>0, <span class="_ _3"></span>or <span class="_ _3"></span>positive.<span class="_ _16"> </span>(In <span class="_ _3"></span>the <span class="_ _3"></span>following <span class="_ _3"></span>discussion, <span class="_ _3"></span>we <span class="_ _3"></span>refer</div><div class="t m0 x32 h26 y44dc ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _9"></span>the <span class="_ _9"></span>‘<span class="_ _0"></span>‘undo’<span class="_ _1"></span><span class="ls4ff">’ﬂ<span class="_ _8"></span><span class="ls0">ag <span class="_ _9"></span>for <span class="_ _9"></span>a <span class="_ _9"></span>semaphore. <span class="_ _45"> </span>This<span class="_ _45"> </span>ﬂag <span class="_ _3"></span>corresponds <span class="_ _9"></span>to <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">SEM_UNDO<span class="_ _45"> </span></span>bit <span class="_ _9"></span>in <span class="_ _9"></span>the</span></span></div><div class="t m0 x32 h26 y44dd ff19 fsf fc0 sc0 ls0 ws0">corresponding<span class="_"> </span><span class="ff1a">sem_flg<span class="_ _80"> </span></span>member<span class="_ _6"></span>.)</div><div class="t m0 x3f h26 y44de ff19 fsf fc0 sc0 ls0 ws0">1. <span class="_ _51"> </span>The<span class="_ _46"> </span>easiest <span class="_ _66"> </span>case <span class="_"> </span>is <span class="_ _66"> </span>when<span class="_ _61"> </span><span class="ff1a">sem_op<span class="_ _46"> </span></span>is <span class="_"> </span>positive.<span class="_ _50"> </span>This <span class="_"> </span>case <span class="_ _66"> </span>corresponds <span class="_"> </span>to <span class="_"> </span>the</div><div class="t m0 x41 h26 y44df ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">turning <span class="_ _53"> </span>of <span class="_ _e"> </span>resour<span class="_ _0"></span>ces <span class="_ _53"> </span>by <span class="_ _53"> </span>the <span class="_ _53"> </span>process. <span class="_ _44"> </span>The<span class="_ _4b"> </span>value <span class="_ _53"> </span>of<span class="_ _4b"> </span><span class="ff1a">sem_op<span class="_ _4b"> </span></span>is <span class="_ _53"> </span>added <span class="_ _53"> </span>to <span class="_ _53"> </span>the</span></div><div class="t m0 x41 h26 y44e0 ff19 fsf fc0 sc0 ls0 ws0">semaphore’s value.<span class="_ _46"> </span>If <span class="_ _2"></span>the undo <span class="_ _2"></span>ﬂag <span class="_ _2"></span>is speciﬁed,<span class="_ _47"> </span><span class="ff1a">sem_op<span class="_ _66"> </span></span>is also <span class="_ _2"></span>subtracted from</div><div class="t m0 x41 h2a y44e1 ff19 fsf fc0 sc0 ls0 ws0">the semaphore’s adjustment value for this pr<span class="_ _0"></span>ocess.</div><div class="t m0 x3f h26 y44e2 ff19 fsf fc0 sc0 ls0 ws0">2. <span class="_ _51"> </span>If<span class="_ _66"> </span><span class="ff1a">sem_op<span class="_ _47"> </span></span>is <span class="_ _2"></span>negative, <span class="_ _2"></span>we <span class="_ _3"></span>want <span class="_ _2"></span>to <span class="_ _2"></span>obtain <span class="_ _2"></span>resources that <span class="_ _3"></span>the <span class="_ _2"></span>semaphor<span class="ls1250">ec<span class="_ _8"></span><span class="ls0">ontrols.</span></span></div><div class="t m0 x41 h2a y44e3 ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _66"> </span>the <span class="_ _47"> </span>semaphore’s <span class="_ _66"> </span>value <span class="_ _47"> </span>is <span class="_ _47"> </span>greater <span class="_"> </span>than <span class="_ _47"> </span>or <span class="_ _47"> </span>equal <span class="_ _66"> </span>to <span class="_ _47"> </span>the <span class="_ _47"> </span>absolute <span class="_ _47"> </span>value <span class="_ _66"> </span>of</div><div class="t m0 x41 h26 y44e4 ff1a fsf fc0 sc0 ls0 ws0">sem_op<span class="_ _80"> </span><span class="ff19">(the resources ar<span class="_ _0"></span><span class="ls1251">ea<span class="_ _d"></span><span class="ls0">vailable), the absolute value of<span class="_"> </span><span class="ff1a">sem_op<span class="_ _66"> </span></span>is subtracted</span></span></span></div><div class="t m0 x41 h2a y44e5 ff19 fsf fc0 sc0 ls0 ws0">from <span class="_ _3"></span>the <span class="_ _23"></span>semaphore’s <span class="_ _3"></span>value.<span class="_ _51"> </span>This <span class="_ _9"></span>guarantees <span class="_ _9"></span>the <span class="_ _9"></span>resulting <span class="_ _9"></span>semaphor<span class="ls4af">ev<span class="_ _b"></span><span class="ls0">alue <span class="_ _9"></span>is</span></span></div><div class="t m0 x41 h2a y44e6 ff19 fsf fc0 sc0 ls0 ws0">greater <span class="_ _23"></span>than <span class="_ _23"> </span>or <span class="_ _42"> </span>equal <span class="_ _23"> </span>to <span class="_ _42"> </span>0.<span class="_ _51"> </span>If <span class="_ _42"> </span>the <span class="_ _42"> </span>undo <span class="_ _23"> </span>ﬂag <span class="_ _42"> </span>is <span class="_ _23"> </span>speciﬁed, <span class="_ _42"> </span>the <span class="_ _23"> </span>absolute <span class="_ _42"> </span>value <span class="_ _23"> </span>of</div><div class="t m0 x41 h26 y44e7 ff1a fsf fc0 sc0 ls0 ws0">sem_op<span class="_ _80"> </span><span class="ff19">is also added to the semaphore’s adjustment value for this process.</span></div><div class="t m0 x41 h26 y44e8 ff19 fsf fc0 sc0 ls0 ws0">If the semaphore’s value is less than the absolute value of<span class="_"> </span><span class="ff1a">sem_op<span class="_ _80"> </span></span>(the resources</div><div class="t m0 x41 h2a y44e9 ff19 fsf fc0 sc0 ls0 ws0">ar<span class="ls44">en<span class="_ _4f"></span><span class="ls0">ot available), the following conditions apply<span class="_ _6"></span>.</span></span></div><div class="t m0 x41 h26 y44ea ff19 fsf fc0 sc0 ls0 ws0">a. <span class="_ _51"> </span>If<span class="_"> </span><span class="ff1a">IPC_NOWAIT<span class="_ _80"> </span></span>is speciﬁed,<span class="_"> </span><span class="ff1a">semop<span class="_ _66"> </span></span><span class="ls45">re</span>turns with an error of<span class="_"> </span><span class="ff1a">EAGAIN</span>.</div><div class="t m0 x41 h26 y44eb ff19 fsf fc0 sc0 ls0 ws0">b. <span class="_ _16"> </span>If<span class="_ _44"> </span><span class="ff1a">IPC_NOWAIT<span class="_ _44"> </span></span>is <span class="_ _23"> </span>not <span class="_ _42"> </span>speciﬁed, <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">semncnt<span class="_ _35"> </span></span>value <span class="_ _42"> </span>for <span class="_ _42"> </span>this <span class="_ _42"> </span>semaphor<span class="ls276">ei<span class="_ _43"></span><span class="ls0">s</span></span></div><div class="t m0 x122 h2a y44ec ff19 fsf fc0 sc0 ls0 ws0">incremented (since <span class="_ _3"></span>the <span class="_ _3"></span>caller <span class="_ _2"></span>is <span class="_ _3"></span>about <span class="_ _2"></span>to <span class="_ _3"></span>go <span class="_ _2"></span>to <span class="_ _3"></span>sleep), <span class="_ _2"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>calling <span class="_ _2"></span>process</div><div class="t m0 x122 h2a y44ed ff19 fsf fc0 sc0 ls0 ws0">is suspended until one of the following occurs.</div><div class="t m0 x122 h2a y44ee ff19 fsf fc0 sc0 ls0 ws0">i. <span class="_ _6e"> </span>The<span class="_ _44"> </span>semaphore’s <span class="_ _23"> </span>value <span class="_ _42"> </span>becomes <span class="_ _42"> </span>greater <span class="_ _23"></span>than <span class="_ _42"> </span>or <span class="_ _42"> </span>equal <span class="_ _23"> </span>to <span class="_ _42"> </span>the <span class="_ _42"> </span>absolute</div><div class="t m0 x6 h26 y44ef ff19 fsf fc0 sc0 ls0 ws0">value <span class="_ _2"></span>of<span class="_ _47"> </span><span class="ff1a">sem_op<span class="_ _47"> </span></span>(i.e., <span class="_ _3"></span>some <span class="_ _3"></span>other <span class="_ _3"></span>process <span class="_ _2"></span>has <span class="_ _3"></span>released <span class="_ _2"></span>some <span class="_ _3"></span>resources).</div><div class="t m0 x6 h26 y44f0 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _e"> </span>value <span class="_ _e"> </span>of<span class="_ _4b"> </span><span class="ff1a">semncnt<span class="_ _4b"> </span></span>for <span class="_"> </span>this <span class="_ _53"> </span>semaphore<span class="_ _4b"> </span>is<span class="_ _4b"> </span>decremented <span class="_ _53"> </span>(since <span class="_ _e"> </span>the</div><div class="t m0 x6 h26 y44f1 ff19 fsf fc0 sc0 ls0 ws0">calling <span class="_ _42"> </span>pr<span class="_ _0"></span>ocess <span class="_ _42"> </span>is <span class="_ _23"> </span>done <span class="_ _42"> </span>waiting), <span class="_ _42"> </span>and <span class="_ _42"> </span>the <span class="_ _23"> </span>absolute <span class="_ _42"> </span>value <span class="_ _42"> </span>of<span class="_ _35"> </span><span class="ff1a">sem_op<span class="_ _44"> </span></span>is</div><div class="t m0 x6 h2a y44f2 ff19 fsf fc0 sc0 ls0 ws0">subtracted from the semaphore’s value.<span class="_ _46"> </span>If <span class="_ _2"></span>the undo <span class="_ _2"></span>ﬂag is <span class="_ _2"></span>speciﬁed, the</div><div class="t m0 x6 h26 y44f3 ff19 fsf fc0 sc0 ls0 ws0">absolute <span class="_ _3"></span>value <span class="_ _9"></span>of<span class="_ _47"> </span><span class="ff1a">sem_op<span class="_ _45"> </span></span>is <span class="_ _3"></span>also <span class="_ _9"></span>added <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>semaphore’s <span class="_ _2"></span>adjustment</div><div class="t m0 x6 h2a y44f4 ff19 fsf fc0 sc0 ls0 ws0">value for this process.</div><div class="t m0 x122 h2a y44f5 ff19 fsf fc0 sc0 ls0 ws0">ii. <span class="_ _93"> </span>The<span class="_ _45"> </span>semaphore<span class="_ _45"> </span>is<span class="_ _45"> </span>removed <span class="_ _9"></span>from <span class="_ _9"></span>the <span class="_ _23"></span>system.<span class="_ _5a"> </span>In <span class="_ _23"></span>this <span class="_ _9"></span>case, <span class="_ _23"></span>the <span class="_ _9"></span>function</div><div class="t m0 x6 h26 y44f6 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">turns an error of<span class="_"> </span><span class="ff1a">EIDRM</span>.</span></div><div class="t m0 x122 h2a y44f7 ff19 fsf fc0 sc0 ls0 ws0">iii. <span class="_ _51"> </span>A<span class="_"> </span>signal is <span class="_ _2"></span>caught by the process, and the <span class="_ _2"></span>signal handler returns. <span class="_"> </span>In<span class="_"> </span>this</div><div class="t m0 x6 h26 y44f8 ff19 fsf fc0 sc0 ls0 ws0">case, the value of<span class="_"> </span><span class="ff1a">semncnt<span class="_ _80"> </span></span>for this semaphore<span class="_"> </span>is<span class="_"> </span>decremented (since the</div><div class="t m0 x6 h2a y44f9 ff19 fsf fc0 sc0 ls0 ws0">calling <span class="_ _9"></span>process <span class="_ _9"></span>is <span class="_ _9"></span>no <span class="_ _9"></span>longer <span class="_ _23"></span>waiting), <span class="_ _9"></span>and <span class="_ _9"></span>the <span class="_ _9"></span>function <span class="_ _23"></span>returns <span class="_ _3"></span>an <span class="_ _23"></span>err<span class="_ _0"></span>or</div><div class="t m0 x6 h26 y44fa ff19 fsf fc0 sc0 ls0 ws0">of<span class="_"> </span><span class="ff1a">EINTR</span>.</div><div class="t m0 x3f h26 y44fb ff19 fsf fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>If<span class="_ _46"> </span><span class="ff1a">sem_op<span class="_ _59"> </span></span>is <span class="_"> </span>0, <span class="_"> </span>this <span class="_"> </span>means <span class="_"> </span>that <span class="_"> </span>the <span class="_"> </span>calling <span class="_"> </span>process <span class="_"> </span>wants <span class="_"> </span>to <span class="_"> </span>wait <span class="_"> </span>until <span class="_"> </span>the</div><div class="t m0 x41 h2a y44fc ff19 fsf fc0 sc0 ls0 ws0">semaphore’s value becomes 0.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
