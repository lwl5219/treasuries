<div id="pf32d" class="pf w4 h1f" data-page-no="32d"><div class="pc pc32d w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg32d.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">779</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">720 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">721 <span class="_ _68"> </span>*<span class="_"> </span>Rewind the index file for db_nextrec.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">722 <span class="_ _68"> </span>*<span class="_"> </span>Automatically called by db_open.</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">723 <span class="_ _68"> </span>*<span class="_"> </span>Must be called before first db_nextrec.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">724 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">725 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">726 <span class="_ _d9"> </span>db_rewind(DBHANDLE<span class="_"> </span>h)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">727 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">728 <span class="_ _15"> </span>DB<span class="_ _189"> </span>*db = h;</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">729 <span class="_ _15"> </span>off_t<span class="_ _68"> </span>offset;</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">730 <span class="_ _15"> </span>offset<span class="_"> </span><span class="ls15c">=(<span class="_ _1d"></span><span class="ls0">db-&gt;nhash + 1) * PTR_SZ;<span class="_ _3a"> </span>/* +1 for free list ptr */</span></span></div><div class="t m0 x32 h57 y2017 ff1a fs2d fc0 sc0 ls0 ws0">731 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y2018 ff1a fs2d fc0 sc0 ls0 ws0">732 <span class="_ _8a"> </span>*<span class="_"> </span>We’re just setting the file offset for this process</div><div class="t m0 x32 h57 y2ad4 ff1a fs2d fc0 sc0 ls0 ws0">733 <span class="_ _8a"> </span>*<span class="_"> </span>to the start of the index records; no need to lock.</div><div class="t m0 x32 h57 y2ad5 ff1a fs2d fc0 sc0 ls0 ws0">734 <span class="_ _8a"> </span>*<span class="_"> </span>+1 below for newline at end of hash table.</div><div class="t m0 x32 h57 y2ad6 ff1a fs2d fc0 sc0 ls0 ws0">735 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y33b1 ff1a fs2d fc0 sc0 ls0 ws0">736 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;idxoff = lseek(db-&gt;idxfd, offset+1, SEEK_SET)) == -1)</div><div class="t m0 x32 h57 y33b2 ff1a fs2d fc0 sc0 ls0 ws0">737 <span class="_ _186"> </span>err_dump(&quot;db_rewind:<span class="_"> </span>lseek error&quot;);</div><div class="t m0 x32 h57 y33b3 ff1a fs2d fc0 sc0 ls0 ws0">738 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y201f ff1a fs2d fc0 sc0 ls0 ws0">739 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y2020 ff1a fs2d fc0 sc0 ls0 ws0">740 <span class="_ _68"> </span>*<span class="_"> </span>Return the next sequential record.</div><div class="t m0 x32 h57 y2021 ff1a fs2d fc0 sc0 ls0 ws0">741 <span class="_ _68"> </span>*<span class="_"> </span>We just step our way through the index file, ignoring deleted</div><div class="t m0 x32 h57 y2022 ff1a fs2d fc0 sc0 ls0 ws0">742 <span class="_ _68"> </span>*<span class="_"> </span>records. <span class="_"> </span>db_rewind<span class="_"> </span>must be called before this function is</div><div class="t m0 x32 h57 y5750 ff1a fs2d fc0 sc0 ls0 ws0">743 <span class="_ _68"> </span>*<span class="_"> </span>called the first time.</div><div class="t m0 x32 h57 y5751 ff1a fs2d fc0 sc0 ls0 ws0">744 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y5752 ff1a fs2d fc0 sc0 ls0 ws0">745 <span class="_ _d9"> </span>char<span class="_"> </span>*</div><div class="t m0 x32 h57 y5753 ff1a fs2d fc0 sc0 ls0 ws0">746 <span class="_ _d9"> </span>db_nextrec(DBHANDLE<span class="_"> </span>h, char *key)</div><div class="t m0 x32 h57 y5754 ff1a fs2d fc0 sc0 ls0 ws0">747 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y5755 ff1a fs2d fc0 sc0 ls0 ws0">748 <span class="_ _15"> </span>DB<span class="_ _189"> </span>*db = h;</div><div class="t m0 x32 h57 y5756 ff1a fs2d fc0 sc0 ls0 ws0">749 <span class="_ _15"> </span>char<span class="_ _15"> </span>c;</div><div class="t m0 x32 h57 y5794 ff1a fs2d fc0 sc0 ls0 ws0">750 <span class="_ _15"> </span>char<span class="_ _15"> </span>*ptr;</div><div class="t m0 x32 h4d y5795 ff19 fs26 fc0 sc0 ls0 ws0">[720 <span class="_ _a"></span>– <span class="_ _a"></span>738]<span class="_ _65"> </span>The<span class="_ _35"> </span><span class="ff1a">db_rewind<span class="_ _35"> </span></span>function <span class="_ _23"></span>is <span class="_ _23"></span>used <span class="_ _23"> </span>to <span class="_ _23"> </span>reset <span class="_ _23"></span>the <span class="_ _23"> </span>database <span class="_ _23"> </span>to <span class="_ _23"> </span>‘‘the <span class="_ _9"></span>beginning;’’</div><div class="t m0 x11a h49 y5796 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _2"></span>set <span class="_ _3"></span>the <span class="_ _2"></span>ﬁle <span class="_ _3"></span>offset <span class="_ _2"></span>for <span class="_ _2"></span>the <span class="_ _3"></span>index <span class="_ _3"></span>ﬁle <span class="_ _2"></span>to <span class="_ _3"></span>point <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _2"></span>recor<span class="_ _0"></span>d<span class="_ _47"> </span>in<span class="_ _66"> </span>the <span class="_ _3"></span>index</div><div class="t m0 x11a h49 y5797 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle (immediately following <span class="_ _2"></span>the hash <span class="_ _2"></span>table).<span class="_ _46"> </span>(Recall the <span class="_ _2"></span>structure<span class="_"> </span>of<span class="_"> </span>the index</div><div class="t m0 x11a h49 y5798 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle from Figur<span class="_ _0"></span><span class="lsd3">e2<span class="_ _d"></span><span class="ls0">0.2.)</span></span></div><div class="t m0 x32 h4d y5838 ff19 fs26 fc0 sc0 ls0 ws0">[739 <span class="_ _a"></span>– <span class="_ _a"></span>750]<span class="_ _65"> </span>The<span class="_ _59"> </span><span class="ff1a">db_nextrec<span class="_ _46"> </span></span>function <span class="_"> </span>returns <span class="_"> </span>the <span class="_"> </span>next <span class="_"> </span>r<span class="_ _0"></span>ecord<span class="_ _59"> </span>in<span class="_ _59"> </span>the <span class="_"> </span>database.<span class="_ _60"> </span>The</div><div class="t m0 x11a h49 y5839 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turn <span class="_ _9"></span>value <span class="_ _3"></span>is <span class="_ _3"></span>a <span class="_ _9"></span>pointer <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>data <span class="_ _3"></span>buffer<span class="_ _6"></span><span class="lsd3b">.I<span class="_ _1d"></span><span class="ls122c">ft<span class="_ _8"></span><span class="ls0">he <span class="_ _3"></span>caller <span class="_ _9"></span>provides <span class="_ _2"></span>a <span class="_ _9"></span>non-null</span></span></span></span></div><div class="t m0 x11a h4d y579b ff19 fs26 fc0 sc0 ls0 ws0">value for the<span class="_"> </span><span class="ff1a">key<span class="_ _66"> </span></span>parameter<span class="_ _1"></span><span class="ls16c0">,t<span class="_ _d"></span><span class="ls0">he corresponding key is copied <span class="_ _2"></span>to this address.</span></span></div><div class="t m0 x11a h49 y579d ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _9"></span>caller <span class="_ _9"></span>is <span class="_ _23"></span>responsible <span class="_ _9"></span>for <span class="_ _9"></span>allocating <span class="_ _9"></span>a <span class="_ _23"></span>buffer <span class="_ _3"></span>big <span class="_ _23"></span>enough <span class="_ _9"></span>to <span class="_ _9"></span>stor<span class="ls16c1">et<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>key<span class="_ _6"></span>.</span></span></div><div class="t m0 x11a h4d y579e ff19 fs26 fc0 sc0 lsd3 ws0">Ab<span class="_ _d"></span><span class="ls0">uffer whose size is<span class="_"> </span><span class="ff1a">IDXLEN_MAX<span class="_ _80"> </span></span>bytes is large enough to hold any key<span class="_ _4"></span>.</span></div><div class="t m0 x11a h49 y583a ff19 fs26 fc0 sc0 ls0 ws0">Records ar<span class="ls16c2">er<span class="_ _8"></span><span class="ls0">eturned <span class="_ _2"></span>sequentially<span class="_ _6"></span>,<span class="_"> </span>in<span class="_ _47"> </span>the <span class="_ _2"></span>order that <span class="_ _2"></span>they <span class="_ _3"></span>happen <span class="_ _2"></span>to <span class="_ _2"></span>be <span class="_ _2"></span>stored</span></span></div><div class="t m0 x11a h49 y583b ff19 fs26 fc0 sc0 ls0 ws0">in <span class="_ _42"> </span>the <span class="_ _42"> </span>database <span class="_ _42"> </span>ﬁle.<span class="_ _54"> </span>Thus, <span class="_ _53"> </span>the <span class="_ _42"> </span>recor<span class="_ _0"></span>ds <span class="_ _42"> </span>ar<span class="ls16c3">en<span class="_ _c"></span><span class="ls0">ot <span class="_ _42"> </span>sorted <span class="_ _42"> </span>by <span class="_ _53"> </span>key <span class="_ _42"> </span>value.<span class="_ _54"> </span>Also,</span></span></div><div class="t m0 x11a h49 y583c ff19 fs26 fc0 sc0 ls0 ws0">because <span class="_ _9"></span>we <span class="_ _9"></span>do <span class="_ _3"></span>not <span class="_ _9"></span>follow <span class="_ _9"></span>the <span class="_ _9"></span>hash <span class="_ _9"></span>chains, <span class="_ _9"></span>we <span class="_ _9"></span>can <span class="_ _9"></span>come <span class="_ _9"></span>across <span class="_ _3"></span>records <span class="_ _3"></span>that</div><div class="t m0 x11a h49 y583d ff19 fs26 fc0 sc0 ls0 ws0">have been deleted, but we will not return these to the caller<span class="_ _6"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
