<div id="pf1e9" class="pf w4 h1f" data-page-no="1e9"><div class="pc pc1e9 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1e9.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>12.8<span class="_ _298"> </span>Threads <span class="_"> </span>and <span class="_"> </span>Signals<span class="_ _1fb"> </span><span class="ff18">455</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">caught <span class="_ _2"></span>(the <span class="_ _2"></span>process has <span class="_ _2"></span>established <span class="_ _2"></span>a <span class="_ _2"></span>signal <span class="_ _3"></span>handler <span class="_ _2"></span>by <span class="_ _2"></span>using<span class="_ _66"> </span><span class="ff1a">sigaction</span><span class="lsf27">,f<span class="_ _d"></span><span class="ls0">or <span class="_ _2"></span>example)</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">and <span class="_ _42"> </span>a <span class="_ _42"> </span>thread <span class="_ _42"> </span>is <span class="_ _42"> </span>waiting <span class="_ _42"> </span>for <span class="_ _53"> </span>the <span class="_ _42"> </span>same <span class="_ _42"> </span>signal <span class="_ _42"> </span>in <span class="_ _53"> </span>a <span class="_ _42"> </span>call <span class="_ _42"> </span>to<span class="_ _44"> </span><span class="ff1a">sigwait</span>,<span class="_ _44"> </span>it<span class="_ _44"> </span>i<span class="lsb5b">sl<span class="_ _c"></span><span class="ls0">eft <span class="_ _53"> </span>up <span class="_ _42"> </span>to <span class="_ _42"> </span>the</span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">implementation <span class="_ _9"></span>to <span class="_ _9"></span>decide <span class="_ _23"></span>which <span class="_ _9"></span>way <span class="_ _9"></span>to <span class="_ _23"></span>deliver <span class="_ _9"></span>the <span class="_ _9"></span>signal.<span class="_ _5a"> </span>The <span class="_ _23"></span>implementation <span class="_ _9"></span>could</div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">either allow<span class="_"> </span><span class="ff1a">sigwait<span class="_ _80"> </span></span>to return or invoke the signal handler<span class="_ _6"></span><span class="ls44">,b<span class="_ _5"></span><span class="ls0">ut not both.</span></span></div><div class="t m0 x3f h26 y133 ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _45"> </span>s<span class="_ _9"></span><span class="ls0">end <span class="_ _42"> </span>a <span class="_ _42"> </span>signal <span class="_ _53"> </span>to <span class="_ _42"> </span>a <span class="_ _42"> </span>process, <span class="_ _42"> </span>we <span class="_ _42"> </span>call<span class="_ _44"> </span><span class="ff1a">kill<span class="_ _35"> </span></span>(Section <span class="_ _53"> </span>10.9).<span class="_ _54"> </span></span>To <span class="_ _45"> </span>s<span class="_ _9"></span><span class="ls0">end <span class="_ _42"> </span>a <span class="_ _42"> </span>signal <span class="_ _42"> </span>to <span class="_ _53"> </span>a</span></div><div class="t m0 x32 h26 y134 ff19 fsf fc0 sc0 ls0 ws0">thread, we call<span class="_"> </span><span class="ff1a">pthread_kill</span>.</div><div class="t m0 x3f h57 y33ed ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;signal.h&gt;</div><div class="t m0 x3f h57 y35cf ff1a fs2d fc0 sc0 ls0 ws0">int pthread_kill(pthread_t<span class="_"> </span><span class="ff1b">thread</span><span class="ls15c">,i<span class="_ _1d"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">signo</span>);</span></span></div><div class="t m0 x78 h5f y35d0 ff19 fs2d fc0 sc0 ls0 ws0">Returns: 0 if OK, error number on failur<span class="_ _0"></span>e</div><div class="t m0 x32 h4a y38a2 ff19 fs26 fc0 sc0 ls164 ws0">We <span class="_ _80"> </span>c<span class="_ _9"></span><span class="ls0">an <span class="_ _3"></span>pass <span class="_ _3"></span>a<span class="_ _47"> </span><span class="ff1b">signo<span class="_ _47"> </span></span>value <span class="_ _3"></span>of <span class="_ _3"></span>0 <span class="_ _3"></span>to <span class="_ _3"></span>check <span class="_ _3"></span>for <span class="_ _3"></span>existence <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>thread. <span class="_ _47"> </span>If<span class="_ _47"> </span>the <span class="_ _3"></span>default <span class="_ _3"></span>action</span></div><div class="t m0 x32 h49 y38a3 ff19 fs26 fc0 sc0 ls0 ws0">for <span class="_ _3"></span>a <span class="_ _3"></span>signal <span class="_ _3"></span>is <span class="_ _9"></span>to <span class="_ _3"></span>terminate <span class="_ _3"></span>the <span class="_ _3"></span>process, <span class="_ _3"></span>then <span class="_ _3"></span>sending <span class="_ _3"></span>the <span class="_ _9"></span>signal <span class="_ _3"></span>to <span class="_ _3"></span>a <span class="_ _3"></span>thread <span class="_ _3"></span>will <span class="_ _3"></span>still <span class="_ _9"></span>kill</div><div class="t m0 x32 h49 y38a4 ff19 fs26 fc0 sc0 ls0 ws0">the entir<span class="lsd3">ep<span class="_ _4f"></span><span class="lscc">ro<span class="_ _2"></span><span class="ls0">cess.</span></span></span></div><div class="t m0 x3f h49 y38a5 ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _3"></span>that <span class="_ _3"></span>alarm <span class="_ _3"></span>timers <span class="_ _3"></span>ar<span class="lsf28">ea <span class="_ _62"></span>p<span class="_ _4f"></span><span class="lscc">ro<span class="ls0">cess <span class="_ _3"></span>resource, <span class="_ _2"></span>and <span class="_ _3"></span>all <span class="_ _3"></span>threads <span class="_ _3"></span>shar<span class="lsf29">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>same <span class="_ _3"></span>set <span class="_ _3"></span>of</span></span></span></span></span></div><div class="t m0 x32 h49 y38a6 ff19 fs26 fc0 sc0 ls0 ws0">alarms. <span class="_ _35"> </span>Thus,<span class="_ _35"> </span>it <span class="_ _42"> </span>is <span class="_ _42"> </span>not <span class="_ _42"> </span>possible <span class="_ _23"> </span>for <span class="_ _42"> </span>multiple <span class="_ _42"> </span>threads <span class="_ _23"></span>in <span class="_ _23"> </span>a <span class="_ _42"> </span>process <span class="_ _23"> </span>to <span class="_ _42"> </span>use <span class="_ _42"> </span>alarm <span class="_ _23"> </span>timers</div><div class="t m0 x32 h49 y37b2 ff19 fs26 fc0 sc0 ls0 ws0">without <span class="_ _61"> </span>interfering <span class="_ _16"> </span>(or <span class="_ _16"> </span>cooperating) <span class="_ _16"> </span>with <span class="_ _16"> </span>one <span class="_ _16"> </span>another <span class="_ _16"> </span>(this <span class="_ _16"> </span>is <span class="_ _16"> </span>the <span class="_ _16"> </span>subject <span class="_ _16"> </span>of</div><div class="t m0 x32 h49 y37b3 ff19 fs26 fc0 sc0 ls0 ws0">Exercise 12.6).</div><div class="t m0 x35 h4c y38a7 ff16 fs26 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h49 y38a8 ff19 fs26 fc0 sc0 ls0 ws0">Recall <span class="_ _2"></span>that <span class="_ _3"></span>in <span class="_ _3"></span>Figur<span class="lsf2a">e1<span class="_ _8"></span><span class="ls0">0.23, <span class="_ _3"></span>we <span class="_ _3"></span>waited <span class="_ _3"></span>for <span class="_ _2"></span>the <span class="_ _3"></span>signal <span class="_ _3"></span>handler <span class="_ _3"></span>to <span class="_ _3"></span>set <span class="_ _3"></span>a <span class="_ _3"></span>ﬂag <span class="_ _2"></span>indicating <span class="_ _3"></span>that</span></span></div><div class="t m0 x32 h49 y38a9 ff19 fs26 fc0 sc0 ls0 ws0">the main program should exit.<span class="_ _59"> </span>The only threads of control that could run wer<span class="_ _0"></span><span class="lsf2b">et<span class="_ _d"></span><span class="ls0">he main</span></span></div><div class="t m0 x32 h49 y38aa ff19 fs26 fc0 sc0 ls0 ws0">thread <span class="_ _2"></span>and <span class="_ _9"></span>the <span class="_ _3"></span>signal <span class="_ _3"></span>handler<span class="_ _1"></span>,<span class="_ _47"> </span>so<span class="_ _45"> </span>blocking <span class="_ _3"></span>the <span class="_ _3"></span>signals <span class="_ _3"></span>was <span class="_ _9"></span>sufﬁcient <span class="_ _2"></span>to <span class="_ _9"></span>avoid <span class="_ _3"></span>missing <span class="_ _3"></span>a</div><div class="t m0 x32 h49 y38ab ff19 fs26 fc0 sc0 ls0 ws0">change to the <span class="_ _2"></span>ﬂag.<span class="_ _46"> </span><span class="ls3aa">Wi<span class="_ _3"></span></span>th <span class="_ _2"></span>threads, we need to <span class="_ _2"></span>use a mutex <span class="_ _2"></span>to protect the ﬂag, <span class="_ _2"></span>as we <span class="_ _2"></span>show</div><div class="t m0 x32 h49 y38ac ff19 fs26 fc0 sc0 ls0 ws0">in Figur<span class="lsd3">e1<span class="_ _4f"></span><span class="ls0">2.16.</span></span></div><div class="t m0 x32 h5d y38ad ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h5d y38ae ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;pthread.h&gt;</div><div class="t m0 x32 h5d y38af ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _186"> </span>quitflag;<span class="_ _68"> </span>/* set nonzero by thread */</div><div class="t m0 x32 h5d y38b0 ff1a fs2f fc0 sc0 ls0 ws0">sigset_t <span class="_ _68"> </span>mask;</div><div class="t m0 x32 h5d y38b1 ff1a fs2f fc0 sc0 ls0 ws0">pthread_mutex_t lock = PTHREAD_MUTEX_INITIALIZER;</div><div class="t m0 x32 h5d y38b2 ff1a fs2f fc0 sc0 ls0 ws0">pthread_cond_t waitloc = PTHREAD_COND_INITIALIZER;</div><div class="t m0 x32 h5d y38b3 ff1a fs2f fc0 sc0 ls0 ws0">void *</div><div class="t m0 x32 h5d y38b4 ff1a fs2f fc0 sc0 ls0 ws0">thr_fn(void *arg)</div><div class="t m0 x32 h5d y38b5 ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y38b6 ff1a fs2f fc0 sc0 ls0 ws0">int err, signo;</div><div class="t m0 x8a h5d y38b7 ff1a fs2f fc0 sc0 ls0 ws0">for (;;) {</div><div class="t m0 x9d h5d y38b8 ff1a fs2f fc0 sc0 ls0 ws0">err = sigwait(&amp;mask, &amp;signo);</div><div class="t m0 x9d h5d y38b9 ff1a fs2f fc0 sc0 ls0 ws0">if (err != 0)</div><div class="t m0 x1f h5d y38ba ff1a fs2f fc0 sc0 ls0 ws0">err_exit(err, &quot;sigwait failed&quot;);</div><div class="t m0 x9d h5d y38bb ff1a fs2f fc0 sc0 ls0 ws0">switch (signo) {</div><div class="t m0 x9d h5d y38bc ff1a fs2f fc0 sc0 ls0 ws0">case SIGINT:</div><div class="t m0 x1f h5d y38bd ff1a fs2f fc0 sc0 ls0 ws0">printf(&quot;\ninterrupt\n&quot;);</div><div class="t m0 x1f h5d y38be ff1a fs2f fc0 sc0 ls0 ws0">break;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
