<div id="pf260" class="pf w4 h1f" data-page-no="260"><div class="pc pc260 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg260.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">574<span class="_ _1b"> </span><span class="ff19">Interprocess <span class="_"> </span>Communication<span class="_ _2c"> </span>Chapter <span class="_"> </span>15</span></div><div class="t m0 x3f h2a y12f ff19 fsf fc0 sc0 ls0 ws0">Once a shared memory segment has been created, a process attaches it to its address</div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">space by calling<span class="_"> </span><span class="ff1a">shmat</span>.</div><div class="t m0 x3f h57 y1c09 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;sys/shm.h&gt;</div><div class="t m0 x3f h57 y43f6 ff1a fs2d fc0 sc0 ls0 ws0">void *shmat(int<span class="_"> </span><span class="ff1b">shmid</span><span class="ls15c">,c<span class="_ _1d"></span><span class="ls0">onst void *<span class="ff1b">addr</span><span class="ls15c">,i<span class="_ _5b"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">ﬂag</span>);</span></span></span></span></div><div class="t m0 x123 h5f y43f7 ff19 fs2d fc0 sc0 ls0 ws0">Returns: pointer to shared memory segment if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x32 h4a y43f8 ff19 fs26 fc0 sc0 ls0 ws0">The address <span class="_ _2"></span>in the <span class="_ _2"></span>calling <span class="_ _2"></span>process at <span class="_ _2"></span>which <span class="_ _2"></span>the <span class="_ _2"></span>segment <span class="_ _2"></span>is <span class="_ _2"></span>attached <span class="_ _2"></span>depends <span class="_ _2"></span>on the<span class="_ _47"> </span><span class="ff1b">addr</span></div><div class="t m0 x32 h4d y43f9 ff19 fs26 fc0 sc0 ls0 ws0">argument and whether the<span class="_"> </span><span class="ff1a">SHM_RND<span class="_ _80"> </span></span>bit is speciﬁed in<span class="_"> </span><span class="ff1b">ﬂag</span>.</div><div class="t m0 x3f h4a y456b ff19 fs26 fc0 sc0 ls15d ws0">•I<span class="_ _4d"></span><span class="ls0">f<span class="_ _47"> </span><span class="ff1b">addr<span class="_ _45"> </span></span>is <span class="_ _3"></span>0, <span class="_ _3"></span>the <span class="_ _9"></span>segment <span class="_ _3"></span>is <span class="_ _9"></span>attached <span class="_ _3"></span>at <span class="_ _9"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _9"></span>available <span class="_ _3"></span>address <span class="_ _3"></span>selected <span class="_ _3"></span>by <span class="_ _9"></span>the</span></div><div class="t m0 x15 h49 y43fb ff19 fs26 fc0 sc0 ls0 ws0">kernel. <span class="_"> </span>This<span class="_"> </span>is the recommended technique.</div><div class="t m0 x3f h4d y456c ff19 fs26 fc0 sc0 ls15d ws0">•I<span class="_ _4d"></span><span class="ls0">f<span class="_ _45"> </span><span class="ff1b">addr<span class="_ _45"> </span></span>is <span class="_ _9"></span>nonzer<span class="ls1271">oa<span class="_ _b"></span><span class="ls0">nd<span class="_ _45"> </span><span class="ff1a">SHM_RND<span class="_ _45"> </span></span>is <span class="_ _9"></span>not <span class="_ _23"></span>speciﬁed, <span class="_ _9"></span>the <span class="_ _9"></span>segment <span class="_ _9"></span>is <span class="_ _23"></span>attached <span class="_ _9"></span>at <span class="_ _9"></span>the</span></span></span></div><div class="t m0 x15 h4a y456d ff19 fs26 fc0 sc0 ls0 ws0">address given by<span class="_"> </span><span class="ff1b">addr</span>.</div><div class="t m0 x3f h4d y456e ff19 fs26 fc0 sc0 ls15d ws0">•I<span class="_ _4d"></span><span class="ls0">f<span class="_ _59"> </span><span class="ff1b">addr<span class="_ _59"> </span></span>is <span class="_"> </span>nonzer<span class="_ _0"></span><span class="ls6b5">oa<span class="_ _4a"></span><span class="ls0">nd<span class="_ _59"> </span><span class="ff1a">SHM_RND<span class="_ _46"> </span></span>is <span class="_"> </span>speciﬁed, <span class="_ _e"> </span>the <span class="_"> </span>segment <span class="_"> </span>is <span class="_ _e"> </span>attached <span class="_"> </span>at <span class="_ _e"> </span>the</span></span></span></div><div class="t m0 x15 h4d y456f ff19 fs26 fc0 sc0 ls0 ws0">address <span class="_ _e"> </span>given <span class="_"> </span>by <span class="_ _e"> </span>(<span class="ff1b">addr<span class="_ _59"> </span><span class="ff20">−<span class="_ _59"> </span></span></span>(<span class="ff1b">addr<span class="_ _59"> </span></span>modulus<span class="_ _59"> </span><span class="ff1a">SHMLBA</span>)). <span class="_ _59"> </span>The<span class="_ _59"> </span><span class="ff1a">SHM_RND<span class="_ _59"> </span></span>command</div><div class="t m0 x15 h4d y4570 ff19 fs26 fc0 sc0 ls0 ws0">stands for <span class="_ _2"></span>‘<span class="_ _0"></span>‘round.’<span class="_ _1"></span>’<span class="_ _46"> </span><span class="ff1a">SHMLBA<span class="_ _66"> </span></span>stands <span class="_ _2"></span>for ‘‘low boundary address multiple’<span class="_ _0"></span><span class="ls1272">’a<span class="_ _4f"></span><span class="ls0">nd <span class="_ _2"></span>is</span></span></div><div class="t m0 x15 h49 y4571 ff19 fs26 fc0 sc0 ls0 ws0">always a power <span class="_ _2"></span>of 2.<span class="_ _46"> </span>What <span class="_ _2"></span>the arithmetic <span class="_ _2"></span>does is <span class="_ _2"></span>round the address down to the</div><div class="t m0 x15 h4d y4572 ff19 fs26 fc0 sc0 ls0 ws0">next multiple of<span class="_"> </span><span class="ff1a">SHMLBA</span>.</div><div class="t m0 x32 h49 y4573 ff19 fs26 fc0 sc0 ls0 ws0">Unless <span class="_ _53"> </span>we <span class="_"> </span>plan <span class="_ _53"> </span>to <span class="_ _e"> </span>run <span class="_ _53"> </span>the <span class="_ _e"> </span>application <span class="_ _e"> </span>on <span class="_ _e"> </span>only <span class="_ _e"> </span>a <span class="_ _e"> </span>single <span class="_ _e"> </span>type <span class="_ _e"> </span>of <span class="_ _e"> </span>hardwar<span class="ls1273">e(<span class="_ _4a"></span><span class="ls0">which <span class="_ _e"> </span>is</span></span></div><div class="t m0 x32 h49 y4574 ff19 fs26 fc0 sc0 ls0 ws0">highly <span class="_ _23"></span>unlikely <span class="_ _23"></span>today), <span class="_ _9"></span>we <span class="_ _23"> </span>should <span class="_ _23"> </span>not <span class="_ _23"> </span>specify <span class="_ _23"> </span>the <span class="_ _23"></span>address <span class="_ _9"></span>wher<span class="ls1274">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>segment <span class="_ _23"> </span>is <span class="_ _23"> </span>to <span class="_ _23"> </span>be</span></span></div><div class="t m0 x32 h4a y4575 ff19 fs26 fc0 sc0 ls0 ws0">attached. <span class="_"> </span>Instead,<span class="_ _47"> </span>we should <span class="_ _2"></span>specify <span class="_ _2"></span>an<span class="_ _66"> </span><span class="ff1b">addr<span class="_ _66"> </span></span>of <span class="_ _2"></span>0 <span class="_ _2"></span>and <span class="_ _2"></span>let <span class="_ _2"></span>the <span class="_ _2"></span>system choose <span class="_ _2"></span>the <span class="_ _2"></span>address.</div><div class="t m0 x3f h4d y4576 ff19 fs26 fc0 sc0 ls0 ws0">If <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">SHM_RDONLY<span class="_ _4b"> </span></span>bit <span class="_ _53"> </span>is <span class="_ _e"> </span>speciﬁed <span class="_ _e"> </span>in<span class="_ _4b"> </span><span class="ff1b">ﬂag</span><span class="ls1275">,t<span class="_ _55"></span><span class="ls0">he <span class="_ _e"> </span>segment <span class="_ _53"> </span>is <span class="_ _e"> </span>attached <span class="_ _53"> </span>as <span class="_ _e"> </span>read-only<span class="_ _4"></span>.</span></span></div><div class="t m0 x32 h49 y2b50 ff19 fs26 fc0 sc0 ls0 ws0">Otherwise, the segment is attached as read–write.</div><div class="t m0 x3f h4d y4577 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _2"></span>value <span class="_ _2"></span>returned by<span class="_ _47"> </span><span class="ff1a">shmat<span class="_ _66"> </span></span>is <span class="_ _2"></span>the <span class="_ _2"></span>address <span class="_ _2"></span>at <span class="_ _2"></span>which <span class="_ _2"></span>the <span class="_ _2"></span>segment <span class="_ _2"></span>is <span class="_ _3"></span>attached, <span class="_ _2"></span>or<span class="_ _66"> </span><span class="ff20">−</span>1</div><div class="t m0 x32 h4d y4578 ff19 fs26 fc0 sc0 ls0 ws0">if <span class="_ _53"> </span>an <span class="_ _53"> </span>error <span class="_ _42"> </span>occurred. <span class="_ _44"> </span>If<span class="_ _44"> </span><span class="ff1a">shmat<span class="_ _4b"> </span></span>succeeds, <span class="_ _53"> </span>the <span class="_ _53"> </span>kernel <span class="_ _53"> </span>will <span class="_ _53"> </span>increment <span class="_ _42"> </span>the<span class="_ _4b"> </span><span class="ff1a">shm_nattch</span></div><div class="t m0 x32 h4d y4579 ff19 fs26 fc0 sc0 ls0 ws0">counter in the<span class="_"> </span><span class="ff1a">shmid_ds<span class="_ _80"> </span></span>structur<span class="lsd3">ea<span class="_ _4f"></span><span class="ls0">ssociated with the shared memory segment.</span></span></div><div class="t m0 x3f h4d y457a ff19 fs26 fc0 sc0 ls0 ws0">When we’r<span class="ls721">ed<span class="_ _4f"></span><span class="ls0">one <span class="_ _2"></span>with a <span class="_ _2"></span>shared memory segment, <span class="_ _2"></span>we <span class="_ _2"></span>call<span class="_"> </span><span class="ff1a">shmdt<span class="_ _66"> </span></span>to <span class="_ _2"></span>detach it.<span class="_ _61"> </span>Note</span></span></div><div class="t m0 x32 h49 y457b ff19 fs26 fc0 sc0 ls0 ws0">that <span class="_"> </span>this <span class="_"> </span>does <span class="_ _66"> </span>not <span class="_ _66"> </span>remove <span class="_"> </span>the <span class="_"> </span>identiﬁer <span class="_ _66"> </span>and <span class="_"> </span>its <span class="_ _66"> </span>associated <span class="_ _66"> </span>data <span class="_ _66"> </span>structur<span class="ls1276">ef<span class="_ _5b"></span><span class="lscc">ro<span class="ls1276">mt<span class="_ _4a"></span><span class="ls0">he</span></span></span></span></div><div class="t m0 x32 h49 y457c ff19 fs26 fc0 sc0 ls0 ws0">system. <span class="_ _54"> </span>The<span class="_ _54"> </span>identiﬁer <span class="_ _44"> </span>remains <span class="_ _44"> </span>in <span class="_ _44"> </span>existence <span class="_ _44"> </span>until <span class="_ _44"> </span>some <span class="_ _44"> </span>process <span class="_ _44"> </span>(often <span class="_ _44"> </span>a <span class="_ _44"> </span>server)</div><div class="t m0 x32 h4d y457d ff19 fs26 fc0 sc0 ls0 ws0">speciﬁcally removes it by calling<span class="_"> </span><span class="ff1a">shmctl<span class="_ _80"> </span></span>with a command of<span class="_"> </span><span class="ff1a">IPC_RMID</span>.</div><div class="t m0 x3f h4e y457e ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/shm.h&gt;</div><div class="t m0 x3f h4e y457f ff1a fs28 fc0 sc0 ls0 ws0">int shmdt(const void *<span class="ff1b">addr</span>);</div><div class="t m0 x153 h7c y4580 ff19 fs28 fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h54 y4581 ff19 fs2c fc0 sc0 ls0 ws0">The<span class="_ _59"> </span><span class="ff1b">addr<span class="_ _59"> </span></span>argument <span class="_ _e"> </span>is <span class="_"> </span>the <span class="_"> </span>value <span class="_ _e"> </span>that <span class="_"> </span>was <span class="_"> </span>r<span class="_ _1"></span>eturned <span class="_"> </span>by <span class="_"> </span>a <span class="_ _e"> </span>previous <span class="_"> </span>call <span class="_ _e"> </span>to<span class="_ _59"> </span><span class="ff1a">shmat</span><span class="ls1277">.I<span class="_ _5d"></span><span class="ls0">f</span></span></div><div class="t m0 x32 h54 y4582 ff19 fs2c fc0 sc0 ls0 ws0">successful,<span class="_"> </span><span class="ff1a">shmdt<span class="_ _80"> </span></span>will <span class="_ _2"></span>decrement the<span class="_"> </span><span class="ff1a">shm_nattch<span class="_ _80"> </span></span>counter in the <span class="_ _2"></span>associated<span class="_"> </span><span class="ff1a">shmid_ds</span></div><div class="t m0 x32 h55 y4583 ff19 fs2c fc0 sc0 ls0 ws0">structur<span class="_ _0"></span>e.</div><div class="t m0 x35 h61 y4584 ff16 fs2c fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h55 y4585 ff19 fs2c fc0 sc0 ls0 ws0">Wher<span class="ls1278">eak<span class="_ _b"></span><span class="ls0">ernel <span class="_ _3"></span>places <span class="_ _9"></span>shared <span class="_ _2"></span>memory <span class="_ _9"></span>segments <span class="_ _3"></span>that <span class="_ _9"></span>ar<span class="ls1279">ea<span class="_ _b"></span><span class="ls0">ttached <span class="_ _3"></span>with <span class="_ _9"></span>an <span class="_ _3"></span>address <span class="_ _3"></span>of <span class="_ _3"></span>0</span></span></span></span></div><div class="t m0 x32 h55 y4586 ff19 fs2c fc0 sc0 ls0 ws0">is <span class="_ _59"> </span>highly <span class="_ _59"> </span>system <span class="_ _46"> </span>dependent.<span class="_ _5e"> </span>Figur<span class="_ _1"></span><span class="ls127a">e1<span class="_ _64"></span><span class="ls0">5.31 <span class="_ _59"> </span>shows <span class="_ _59"> </span>a <span class="_ _46"> </span>program <span class="_ _4b"> </span>that <span class="_ _46"> </span>prints <span class="_ _59"> </span>some</span></span></div><div class="t m0 x32 h55 y4587 ff19 fs2c fc0 sc0 ls0 ws0">information on wher<span class="ls142">eo<span class="_ _4f"></span><span class="ls0">ne particular system places various types of data.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
