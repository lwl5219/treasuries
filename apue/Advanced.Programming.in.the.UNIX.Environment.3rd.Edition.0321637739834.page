<div id="pf342" class="pf w4 h1f" data-page-no="342"><div class="pc pc342 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg342.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">800<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">22 <span class="_ _d9"> </span>#define<span class="_"> </span>FILENMSZ <span class="_ _90"> </span>64</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">23 <span class="_ _d9"> </span>#define<span class="_"> </span>FILEPERM <span class="_ _90"> </span>(S_IRUSR|S_IWUSR)</div><div class="t m0 x32 h57 y2012 ff1a fs2d fc0 sc0 ls0 ws0">24 <span class="_ _d9"> </span>#define<span class="_"> </span>USERNM_MAX <span class="_ _8a"> </span>64</div><div class="t m0 x32 h57 y2013 ff1a fs2d fc0 sc0 ls0 ws0">25 <span class="_ _d9"> </span>#define<span class="_"> </span>JOBNM_MAX <span class="_ _88"> </span>256</div><div class="t m0 x32 h57 y2014 ff1a fs2d fc0 sc0 ls0 ws0">26 <span class="_ _d9"> </span>#define<span class="_"> </span>MSGLEN_MAX <span class="_ _8a"> </span>512</div><div class="t m0 x32 h57 y27e6 ff1a fs2d fc0 sc0 ls0 ws0">27 <span class="_ _d9"> </span>#ifndef<span class="_"> </span>HOST_NAME_MAX</div><div class="t m0 x32 h57 y1cc2 ff1a fs2d fc0 sc0 ls0 ws0">28 <span class="_ _d9"> </span>#define<span class="_"> </span>HOST_NAME_MAX <span class="_ _3a"> </span>256</div><div class="t m0 x32 h57 y1cc3 ff1a fs2d fc0 sc0 ls0 ws0">29 <span class="_ _d9"> </span>#endif</div><div class="t m0 x32 h57 y3b0a ff1a fs2d fc0 sc0 ls0 ws0">30 <span class="_ _d9"> </span>#define<span class="_"> </span>IPP_PORT <span class="_ _90"> </span>631</div><div class="t m0 x32 h57 y4c79 ff1a fs2d fc0 sc0 ls0 ws0">31 <span class="_ _d9"> </span>#define<span class="_"> </span>QLEN <span class="_ _1ef"> </span>10</div><div class="t m0 x32 h57 y1d38 ff1a fs2d fc0 sc0 ls0 ws0">32 <span class="_ _d9"> </span>#define<span class="_"> </span>IBUFSZ <span class="_ _176"> </span>512<span class="_ _15"> </span>/* IPP header buffer size */</div><div class="t m0 x32 h57 y3cb ff1a fs2d fc0 sc0 ls0 ws0">33 <span class="_ _d9"> </span>#define<span class="_"> </span>HBUFSZ <span class="_ _176"> </span>512<span class="_ _15"> </span>/* HTTP header buffer size */</div><div class="t m0 x32 h57 y3cc ff1a fs2d fc0 sc0 ls0 ws0">34 <span class="_ _d9"> </span>#define<span class="_"> </span>IOBUFSZ <span class="_ _186"> </span>8192<span class="_ _87"> </span>/* data buffer size */</div><div class="t m0 x32 h57 y850 ff1a fs2d fc0 sc0 ls0 ws0">35 <span class="_ _d9"> </span>#ifndef<span class="_"> </span>ETIME</div><div class="t m0 x32 h57 y851 ff1a fs2d fc0 sc0 ls0 ws0">36 <span class="_ _d9"> </span>#define<span class="_"> </span>ETIME ETIMEDOUT</div><div class="t m0 x32 h57 y852 ff1a fs2d fc0 sc0 ls0 ws0">37 <span class="_ _d9"> </span>#endif</div><div class="t m0 x32 h57 y27eb ff1a fs2d fc0 sc0 ls0 ws0">38 <span class="_ _d9"> </span>extern<span class="_"> </span>int getaddrlist(const char *, const char *,</div><div class="t m0 x32 h57 y348e ff1a fs2d fc0 sc0 ls0 ws0">39 <span class="_ _15"> </span>struct<span class="_"> </span>addrinfo **);</div><div class="t m0 x32 h57 y348f ff1a fs2d fc0 sc0 ls0 ws0">40 <span class="_ _d9"> </span>extern<span class="_"> </span>char *get_printserver(void);</div><div class="t m0 x32 h57 y3490 ff1a fs2d fc0 sc0 ls0 ws0">41 <span class="_ _d9"> </span>extern<span class="_"> </span>struct addrinfo *get_printaddr(void);</div><div class="t m0 x32 h57 y3491 ff1a fs2d fc0 sc0 ls0 ws0">42 <span class="_ _d9"> </span>extern<span class="_"> </span>ssize_t tread(int, void *, size_t, unsigned int);</div><div class="t m0 x32 h57 y3492 ff1a fs2d fc0 sc0 ls0 ws0">43 <span class="_ _d9"> </span>extern<span class="_"> </span>ssize_t treadn(int, void *, size_t, unsigned int);</div><div class="t m0 x32 h57 y5a6a ff1a fs2d fc0 sc0 ls0 ws0">44 <span class="_ _d9"> </span>extern<span class="_"> </span>int connect_retry(int, int, int, const struct sockaddr *,</div><div class="t m0 x32 h57 y5a6b ff1a fs2d fc0 sc0 ls0 ws0">45 <span class="_ _15"> </span>socklen_t);</div><div class="t m0 x32 h57 y5765 ff1a fs2d fc0 sc0 ls0 ws0">46 <span class="_ _d9"> </span>extern<span class="_"> </span>int initserver(int, const struct sockaddr *, socklen_t,</div><div class="t m0 x32 h57 y5766 ff1a fs2d fc0 sc0 ls0 ws0">47 <span class="_ _15"> </span>int);</div><div class="t m0 x32 h4d y5a6c ff19 fs26 fc0 sc0 ls0 ws0">[22 <span class="_ _a"></span>– <span class="_ _a"></span>34]<span class="_ _65"> </span>Next, we deﬁne limits <span class="_ _2"></span>and constants.<span class="_ _46"> </span><span class="ff1a">FILEPERM<span class="_ _66"> </span></span>is the <span class="_ _2"></span>permissions used when</div><div class="t m0 x2d h49 y5a6d ff19 fs26 fc0 sc0 ls0 ws0">creating copies <span class="_ _2"></span>of <span class="_ _2"></span>ﬁles <span class="_ _2"></span>submitted <span class="_ _2"></span>to <span class="_ _2"></span>be printed.<span class="_ _61"> </span>The <span class="_ _2"></span>permissions <span class="_ _2"></span>ar<span class="lsf45">er<span class="_ _8"></span><span class="ls0">estrictive</span></span></div><div class="t m0 x2d h49 y5a6e ff19 fs26 fc0 sc0 ls0 ws0">because <span class="_ _e"> </span>we <span class="_ _e"> </span>don’t <span class="_ _e"> </span>want <span class="_ _e"> </span>ordinary <span class="_ _53"> </span>users <span class="_"> </span>to <span class="_ _53"> </span>be <span class="_ _e"> </span>able <span class="_ _e"> </span>to <span class="_"> </span>r<span class="_ _1"></span>ead <span class="_"> </span>each <span class="_ _53"> </span>other<span class="_ _9"></span>’s <span class="_ _e"> </span>ﬁles</div><div class="t m0 x2d h4d y5a6f ff19 fs26 fc0 sc0 ls0 ws0">while <span class="_ _66"> </span>they <span class="_ _47"> </span>ar<span class="lsdb7">ew<span class="_ _1d"></span><span class="ls0">aiting <span class="_ _47"> </span>to <span class="_ _66"> </span>be <span class="_ _47"> </span>printed.<span class="_ _50"> </span><span class="ls164">We <span class="_ _59"> </span>d<span class="_ _9"></span></span>eﬁne<span class="_ _61"> </span><span class="ff1a">HOST_NAME_MAX<span class="_ _16"> </span></span>as <span class="_ _66"> </span>the</span></span></div><div class="t m0 x2d h49 y5a70 ff19 fs26 fc0 sc0 ls0 ws0">largest <span class="_ _3"></span>host <span class="_ _9"></span>name <span class="_ _9"></span>we <span class="_ _9"></span>will <span class="_ _9"></span>support <span class="_ _9"></span>if <span class="_ _9"></span>we <span class="_ _9"></span>ar<span class="ls1745">eu<span class="_ _b"></span><span class="ls0">nable <span class="_ _9"></span>to <span class="_ _9"></span>determine <span class="_ _9"></span>the <span class="_ _9"></span>system’s</span></span></div><div class="t m0 x2d h4d y5a71 ff19 fs26 fc0 sc0 ls0 ws0">limit with<span class="_"> </span><span class="ff1a">sysconf</span>.</div><div class="t m0 x2d h4d y5a72 ff19 fs26 fc0 sc0 ls0 ws0">IPP <span class="_ _3"></span>is <span class="_ _9"></span>deﬁned <span class="_ _3"></span>to <span class="_ _9"></span>use <span class="_ _9"></span>port <span class="_ _3"></span>631.<span class="_ _5a"> </span>The<span class="_ _47"> </span><span class="ff1a">QLEN<span class="_ _45"> </span></span>is <span class="_ _3"></span>the <span class="_ _9"></span>backlog <span class="_ _9"></span>parameter <span class="_ _3"></span>we <span class="_ _9"></span>pass <span class="_ _3"></span>to</div><div class="t m0 x2d h4d y5a73 ff1a fs26 fc0 sc0 ls0 ws0">listen<span class="_ _80"> </span><span class="ff19">(see Section 16.4 for details).</span></div><div class="t m0 x32 h4d y5a74 ff19 fs26 fc0 sc0 ls0 ws0">[35 <span class="_ _a"></span>– <span class="_ _a"></span>37]<span class="_ _65"> </span>Some <span class="_ _23"></span>platforms <span class="_ _23"></span>don’t <span class="_ _23"> </span>deﬁne <span class="_ _23"> </span>the <span class="_ _23"> </span>error<span class="_ _35"> </span><span class="ff1a">ETIME</span>,<span class="_ _45"> </span>so<span class="_ _35"> </span>we<span class="_ _35"> </span>deﬁne <span class="_ _23"> </span>it <span class="_ _23"> </span>to <span class="_ _23"> </span>an <span class="_ _23"> </span>alternate</div><div class="t m0 x2d h49 y5a75 ff19 fs26 fc0 sc0 ls0 ws0">error code <span class="_ _2"></span>that makes <span class="_ _2"></span>sense <span class="_ _2"></span>for <span class="_ _2"></span>these <span class="_ _2"></span>systems.<span class="_ _61"> </span>This <span class="_ _2"></span>is the <span class="_ _2"></span>error code <span class="_ _2"></span>we <span class="_ _2"></span>return</div><div class="t m0 x2d h49 y5a76 ff19 fs26 fc0 sc0 ls0 ws0">when <span class="_ _3"></span>a <span class="_ _3"></span>read <span class="_ _3"></span>times <span class="_ _3"></span>out <span class="_ _9"></span>(we <span class="_ _3"></span>don’t <span class="_ _3"></span>want <span class="_ _9"></span>the <span class="_ _3"></span>server <span class="_ _3"></span>to <span class="_ _9"></span>block <span class="_ _3"></span>indeﬁnitely <span class="_ _3"></span>reading</div><div class="t m0 x2d h49 y5a77 ff19 fs26 fc0 sc0 ls0 ws0">from a socket).</div><div class="t m0 x32 h4d y5a78 ff19 fs26 fc0 sc0 ls0 ws0">[38 <span class="_ _a"></span>– <span class="_ _a"></span>47]<span class="_ _65"> </span>Next, <span class="_ _42"> </span>we <span class="_ _53"> </span>declar<span class="ls1746">ea<span class="_ _c"></span><span class="ls0">ll <span class="_ _53"> </span>the <span class="_ _53"> </span>public <span class="_ _53"> </span>routines <span class="_ _42"> </span>contained <span class="_ _53"> </span>in<span class="_ _44"> </span><span class="ff1a">util.c<span class="_ _44"> </span></span>(we’ll <span class="_ _53"> </span>look <span class="_ _53"> </span>at</span></span></div><div class="t m0 x2d h4d y5a79 ff19 fs26 fc0 sc0 ls0 ws0">these shortly).<span class="_ _46"> </span>Note that the<span class="_"> </span><span class="ff1a">connect_retry<span class="_ _66"> </span></span>function, from Figur<span class="lsa2f">e1<span class="_ _4f"></span><span class="ls0">6.1<span class="_ _0"></span>1, and</span></span></div><div class="t m0 x2d h4d y5a7a ff19 fs26 fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">initserver<span class="_ _80"> </span></span>function, from Figur<span class="lsd3">e1<span class="_ _4f"></span><span class="ls0">6.22, ar<span class="lsd3">en<span class="_ _d"></span><span class="ls0">ot included in<span class="_"> </span><span class="ff1a">util.c</span>.</span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
