<div id="pf319" class="pf w4 h1f" data-page-no="319"><div class="pc pc319 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg319.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">759</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">121 <span class="_ _15"> </span>if<span class="_"> </span>((oflag &amp; (O_CREAT | O_TRUNC)) == (O_CREAT | O_TRUNC)) {</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">122 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">123 <span class="_ _176"> </span>*<span class="_"> </span>If the database was created, we have to initialize</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">124 <span class="_ _176"> </span>*<span class="_"> </span>it. <span class="_"> </span>Write<span class="_"> </span>lock the entire file so that we can stat</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">125 <span class="_ _176"> </span>*<span class="_"> </span>it, check its size, and initialize it, atomically.</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">126 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">127 <span class="_ _186"> </span>if<span class="_"> </span>(writew_lock(db-&gt;idxfd, 0, SEEK_SET, 0) &lt; 0)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">128 <span class="_ _82"> </span>err_dump(&quot;db_open:<span class="_"> </span>writew_lock error&quot;);</div><div class="t m0 x32 h57 y5710 ff1a fs2d fc0 sc0 ls0 ws0">129 <span class="_ _186"> </span>if<span class="_"> </span>(fstat(db-&gt;idxfd, &amp;statbuff) &lt; 0)</div><div class="t m0 x32 h57 y5711 ff1a fs2d fc0 sc0 ls0 ws0">130 <span class="_ _82"> </span>err_sys(&quot;db_open:<span class="_"> </span>fstat error&quot;);</div><div class="t m0 x32 h57 y2f25 ff1a fs2d fc0 sc0 ls0 ws0">131 <span class="_ _186"> </span>if<span class="_"> </span>(statbuff.st_size == 0) {</div><div class="t m0 x32 h57 y5712 ff1a fs2d fc0 sc0 ls0 ws0">132 <span class="_ _82"> </span>/*</div><div class="t m0 x32 h57 y5713 ff1a fs2d fc0 sc0 ls0 ws0">133 <span class="_ _166"> </span>*<span class="_"> </span>We have to build a list of (NHASH_DEF + 1) chain</div><div class="t m0 x32 h57 y5714 ff1a fs2d fc0 sc0 ls0 ws0">134 <span class="_ _166"> </span>*<span class="_"> </span>ptrs with a value of 0.<span class="_ _3a"> </span>The +1 is for the free</div><div class="t m0 x32 h57 y5715 ff1a fs2d fc0 sc0 ls0 ws0">135 <span class="_ _166"> </span>*<span class="_"> </span>list pointer that precedes the hash table.</div><div class="t m0 x32 h57 y5716 ff1a fs2d fc0 sc0 ls0 ws0">136 <span class="_ _166"> </span>*/</div><div class="t m0 x32 h57 y5717 ff1a fs2d fc0 sc0 ls0 ws0">137 <span class="_ _82"> </span>sprintf(asciiptr,<span class="_"> </span>&quot;%*d&quot;, PTR_SZ, 0);</div><div class="t m0 x32 h49 y5718 ff19 fs26 fc0 sc0 ls0 ws0">[121 <span class="_ _a"></span>– <span class="_ _a"></span>130]<span class="_ _65"> </span><span class="ls164">We <span class="_ _16"> </span>e<span class="_ _9"></span></span>ncounter <span class="_ _44"> </span>locking <span class="_ _35"> </span>if <span class="_ _35"> </span>the <span class="_ _35"> </span>database <span class="_ _35"> </span>is <span class="_ _44"> </span>being <span class="_ _35"> </span>created. <span class="_ _51"> </span>Consider<span class="_ _51"> </span>two</div><div class="t m0 x11a h49 y5719 ff19 fs26 fc0 sc0 ls0 ws0">processes <span class="_ _45"> </span>trying <span class="_ _35"> </span>to <span class="_ _35"> </span>cr<span class="_ _0"></span>eate <span class="_ _45"> </span>the <span class="_ _35"> </span>same <span class="_ _35"> </span>database <span class="_ _35"> </span>at <span class="_ _45"> </span>about <span class="_ _35"> </span>the <span class="_ _35"> </span>same <span class="_ _45"> </span>time.</div><div class="t m0 x11a h4d y571a ff19 fs26 fc0 sc0 ls0 ws0">Assume <span class="_ _3"></span>that <span class="_ _3"></span>the <span class="_ _9"></span>ﬁrst <span class="_ _3"></span>process <span class="_ _3"></span>calls<span class="_ _45"> </span><span class="ff1a">fstat<span class="_ _47"> </span></span>and <span class="_ _3"></span>is <span class="_ _9"></span>blocked <span class="_ _3"></span>by <span class="_ _3"></span>the <span class="_ _9"></span>kernel <span class="_ _3"></span>after</div><div class="t m0 x11a h4d y571b ff1a fs26 fc0 sc0 ls0 ws0">fstat<span class="_ _45"> </span><span class="ff19 lscc">re<span class="ls0">turns. <span class="_ _35"> </span>The<span class="_ _45"> </span>second <span class="_ _9"></span>process <span class="_ _9"></span>calls<span class="_ _45"> </span></span></span>db_open<span class="ff19 ls1668">,ﬁ<span class="_ _b"></span><span class="ls0">nds <span class="_ _9"></span>that <span class="_ _23"></span>the <span class="_ _9"></span>length <span class="_ _23"></span>of</span></span></div><div class="t m0 x11a h49 y571c ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _23"> </span>index <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>is <span class="_ _23"> </span>0, <span class="_ _42"> </span>and <span class="_ _42"> </span>initializes <span class="_ _42"> </span>the <span class="_ _23"> </span>free <span class="_ _23"> </span>list <span class="_ _42"> </span>and <span class="_ _42"> </span>hash <span class="_ _23"> </span>chain.<span class="_ _54"> </span>The <span class="_ _42"> </span>second</div><div class="t m0 x11a h49 y571d ff19 fs26 fc0 sc0 ls0 ws0">process <span class="_ _42"> </span>then <span class="_ _42"> </span>writes <span class="_ _53"> </span>one <span class="_ _53"> </span>record<span class="_ _35"> </span>to<span class="_ _4b"> </span>the <span class="_ _42"> </span>database.<span class="_ _65"> </span>At <span class="_ _53"> </span>this <span class="_ _53"> </span>point, <span class="_ _42"> </span>the <span class="_ _53"> </span>second</div><div class="t m0 x11a h49 y571e ff19 fs26 fc0 sc0 ls0 ws0">process <span class="_ _9"></span>is <span class="_ _23"> </span>blocked, <span class="_ _23"></span>and <span class="_ _23"></span>the <span class="_ _23"></span>ﬁrst <span class="_ _23"></span>pr<span class="_ _0"></span>ocess <span class="_ _23"></span>continues <span class="_ _9"></span>executing <span class="_ _23"> </span>right <span class="_ _23"> </span>after <span class="_ _23"> </span>the</div><div class="t m0 x11a h4d y571f ff19 fs26 fc0 sc0 ls0 ws0">call <span class="_ _3"></span>to<span class="_ _47"> </span><span class="ff1a">fstat</span><span class="ls1669">.T<span class="_ _1d"></span><span class="ls0">he <span class="_ _9"></span>ﬁrst <span class="_ _3"></span>process <span class="_ _2"></span>ﬁnds <span class="_ _9"></span>the <span class="_ _3"></span>size <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _3"></span>index <span class="_ _3"></span>ﬁle <span class="_ _9"></span>to <span class="_ _3"></span>be <span class="_ _3"></span>0 <span class="_ _9"></span>(since</span></span></div><div class="t m0 x11a h4d y5720 ff1a fs26 fc0 sc0 ls0 ws0">fstat<span class="_ _66"> </span><span class="ff19">was <span class="_ _3"></span>called <span class="_ _2"></span>befor<span class="ls166a">et<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>second <span class="_ _2"></span>process <span class="_ _2"></span>initialized <span class="_ _3"></span>the <span class="_ _2"></span>index <span class="_ _2"></span>ﬁle), <span class="_ _3"></span>so <span class="_ _2"></span>the</span></span></span></div><div class="t m0 x11a h49 y5721 ff19 fs26 fc0 sc0 ls0 ws0">ﬁrst process initializes the free list and hash chain, wiping out the recor<span class="_ _1"></span><span class="ls166b">dt<span class="_ _5"></span><span class="ls0">hat</span></span></div><div class="t m0 x11a h49 y5722 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>second <span class="_ _3"></span>process <span class="_ _2"></span>stored <span class="_ _2"></span>in <span class="_ _3"></span>the <span class="_ _3"></span>database.<span class="_ _16"> </span>The <span class="_ _3"></span>way <span class="_ _3"></span>to <span class="_ _9"></span>prevent <span class="_ _2"></span>this <span class="_ _3"></span>is <span class="_ _3"></span>to <span class="_ _3"></span>use</div><div class="t m0 x11a h4d y5723 ff19 fs26 fc0 sc0 ls0 ws0">locking. <span class="_ _59"> </span>W<span class="_ _6"></span><span class="ls166c">eu<span class="_ _4a"></span><span class="ls0">se <span class="_"> </span>the <span class="_ _e"> </span>macros<span class="_ _4b"> </span><span class="ff1a">readw_lock</span>,<span class="_ _59"> </span><span class="ff1a">writew_lock</span><span class="ls166d">,a<span class="_ _55"></span><span class="ls0">nd<span class="_ _59"> </span><span class="ff1a">un_lock</span></span></span></span></span></div><div class="t m0 x11a h49 y5724 ff19 fs26 fc0 sc0 ls0 ws0">from Section 14.3.</div><div class="t m0 x32 h49 y5725 ff19 fs26 fc0 sc0 ls0 ws0">[131 <span class="_ _a"></span>– <span class="_ _a"></span>137]<span class="_ _65"> </span>If <span class="_"> </span>the <span class="_ _e"> </span>size <span class="_"> </span>of <span class="_"> </span>the <span class="_ _e"> </span>index <span class="_"> </span>ﬁle <span class="_"> </span>is <span class="_ _e"> </span>0, <span class="_"> </span>we <span class="_"> </span>have <span class="_ _e"> </span>just <span class="_"> </span>created <span class="_ _e"> </span>it, <span class="_"> </span>so <span class="_"> </span>we <span class="_ _e"> </span>need <span class="_"> </span>to</div><div class="t m0 x11a h49 y5726 ff19 fs26 fc0 sc0 ls0 ws0">initialize <span class="_ _9"></span>the <span class="_ _9"></span>free <span class="_ _9"></span>list <span class="_ _9"></span>and <span class="_ _9"></span>hash <span class="_ _9"></span>chain <span class="_ _9"></span>pointers <span class="_ _9"></span>it <span class="_ _9"></span>contains.<span class="_ _51"> </span>Note <span class="_ _3"></span>that <span class="_ _23"></span>we <span class="_ _9"></span>use</div><div class="t m0 x11a h4d y5727 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _42"> </span>format <span class="_ _23"> </span>string<span class="_ _44"> </span><span class="ff1a">%*d<span class="_ _35"> </span></span>to <span class="_ _42"> </span>convert <span class="_ _42"> </span>a <span class="_ _42"> </span>database <span class="_ _23"> </span>pointer <span class="_ _42"> </span>from <span class="_ _23"> </span>an <span class="_ _42"> </span>integer <span class="_ _42"> </span>to <span class="_ _42"> </span>an</div><div class="t m0 x11a h4d y5728 ff19 fs26 fc0 sc0 ls0 ws0">ASCII <span class="_ _42"> </span>string.<span class="_ _54"> </span>(W<span class="_ _6"></span>e’ll <span class="_ _42"> </span>use <span class="_ _42"> </span>this <span class="_ _42"> </span>type <span class="_ _53"> </span>of <span class="_ _42"> </span>format <span class="_ _42"> </span>again <span class="_ _42"> </span>in<span class="_ _44"> </span><span class="ff1a">_db_writeidx<span class="_ _44"> </span></span>and</div><div class="t m0 x11a h4d y5729 ff1a fs26 fc0 sc0 ls0 ws0">_db_writeptr<span class="ff19">.) <span class="_ _45"> </span>This<span class="_ _45"> </span>format <span class="_ _9"></span>tells<span class="_ _45"> </span></span>sprintf<span class="_ _45"> </span><span class="ff19">to <span class="_ _9"></span>take <span class="_ _9"></span>the<span class="_ _45"> </span></span>PTR_SZ<span class="_ _45"> </span><span class="ff19">argument</span></div><div class="t m0 x11a h49 y572a ff19 fs26 fc0 sc0 ls0 ws0">and <span class="_ _3"></span>use <span class="_ _9"></span>it <span class="_ _9"></span>as <span class="_ _9"></span>the <span class="_ _3"></span>minimum <span class="_ _9"></span>ﬁeld <span class="_ _9"></span>width <span class="_ _9"></span>for <span class="_ _3"></span>the <span class="_ _9"></span>next <span class="_ _9"></span>argument, <span class="_ _3"></span>which <span class="_ _9"></span>is <span class="_ _9"></span>0 <span class="_ _3"></span>in</div><div class="t m0 x11a h49 y572b ff19 fs26 fc0 sc0 ls0 ws0">this <span class="_ _3"></span>instance <span class="_ _3"></span>(here<span class="_ _66"> </span>we<span class="_ _47"> </span>a<span class="lscc">re <span class="_ _23"></span>i</span>nitializing <span class="_ _3"></span>the <span class="_ _3"></span>pointers <span class="_ _3"></span>to <span class="_ _3"></span>0, <span class="_ _3"></span>since <span class="_ _3"></span>we <span class="_ _3"></span>ar<span class="lse99">ec<span class="_ _8"></span><span class="lscc">re<span class="ls0">ating</span></span></span></div><div class="t m0 x11a h49 y572c ff19 fs26 fc0 sc0 ls166e ws0">an<span class="_ _d"></span><span class="ls0">ew database).<span class="_ _46"> </span>This has the effect of forcing the string cr<span class="_ _1"></span>eated to <span class="_ _2"></span>be at least</span></div><div class="t m0 x11a h4d y572d ff1a fs26 fc0 sc0 ls0 ws0">PTR_SZ<span class="_ _66"> </span><span class="ff19">characters (padded <span class="_ _2"></span>on <span class="_ _2"></span>the left <span class="_ _2"></span>with spaces).<span class="_ _61"> </span>In<span class="_ _66"> </span></span>_db_writeidx<span class="_ _66"> </span><span class="ff19">and</span></div><div class="t m0 x11a h4d y572e ff1a fs26 fc0 sc0 ls0 ws0">_db_writeptr<span class="ff19">,<span class="_ _35"> </span>we<span class="_ _35"> </span>will <span class="_ _42"> </span>pass <span class="_ _42"> </span>a <span class="_ _23"> </span>pointer <span class="_ _42"> </span>value <span class="_ _23"> </span>instead <span class="_ _42"> </span>of <span class="_ _42"> </span>zer<span class="_ _0"></span>o, <span class="_ _23"> </span>but <span class="_ _42"> </span>we <span class="_ _42"> </span>will</span></div><div class="t m0 x11a h4d y572f ff19 fs26 fc0 sc0 ls0 ws0">ﬁrst <span class="_ _23"></span>verify <span class="_ _23"></span>that <span class="_ _23"> </span>the <span class="_ _23"> </span>pointer <span class="_ _23"> </span>value <span class="_ _23"> </span>isn’t <span class="_ _23"> </span>greater <span class="_ _23"> </span>than<span class="_ _35"> </span><span class="ff1a">PTR_MAX</span>,<span class="_ _35"> </span>to<span class="_ _35"> </span>guarantee</div><div class="t m0 x11a h4d y5730 ff19 fs26 fc0 sc0 ls0 ws0">that <span class="_ _9"></span>every <span class="_ _9"></span>pointer <span class="_ _9"></span>string <span class="_ _9"></span>we <span class="_ _9"></span>write <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>database <span class="_ _3"></span>occupies <span class="_ _9"></span>exactly<span class="_ _45"> </span><span class="ff1a">PTR_SZ</span></div><div class="t m0 x11a h49 y5731 ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x139 h49 y5732 ff19 fs26 fc0 sc0 ls0 ws0">7</div><div class="t m0 x227 h49 y5731 ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 x7b h49 y5732 ff19 fs26 fc0 sc0 ls0 ws0">characters.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
