<div id="pf3cf" class="pf w4 h1f" data-page-no="3cf"><div class="pc pc3cf w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg3cf.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Appendix <span class="_"> </span>C<span class="_ _89"> </span>Chapter <span class="_"> </span>17<span class="_ _54"> </span>Solutions<span class="_ _1b"> </span><span class="ff18">941</span></div><div class="t m0 xe2 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">void *</div><div class="t m0 xe2 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">helper(void *arg)</div><div class="t m0 xe2 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x60 h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>n;</div><div class="t m0 x60 h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">struct threadinfo<span class="_ _68"> </span>*tip = arg;</div><div class="t m0 x60 h57 y124c ff1a fs2d fc0 sc0 ls0 ws0">for(;;) {</div><div class="t m0 xb9 h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">memset(&amp;tip-&gt;m, 0, sizeof(struct mymsg));</div><div class="t m0 xb9 h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">if ((n = msgrcv(tip-&gt;qid, &amp;tip-&gt;m, MAXMSZ, 0,</div><div class="t m0 x1b h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">MSG_NOERROR)) &lt; 0)</div><div class="t m0 x1ce h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;msgrcv error&quot;);</div><div class="t m0 xb9 h57 y8d8 ff1a fs2d fc0 sc0 ls0 ws0">tip-&gt;len = n;</div><div class="t m0 xb9 h57 y8d9 ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_lock(&amp;tip-&gt;mutex);</div><div class="t m0 xb9 h57 y8da ff1a fs2d fc0 sc0 ls0 ws0">if (write(tip-&gt;fd, &quot;a&quot;, sizeof(char)) &lt; 0)</div><div class="t m0 x1ce h57 y8db ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><div class="t m0 xb9 h57 y8dc ff1a fs2d fc0 sc0 ls0 ws0">pthread_cond_wait(&amp;tip-&gt;ready, &amp;tip-&gt;mutex);</div><div class="t m0 xb9 h57 y8dd ff1a fs2d fc0 sc0 ls0 ws0">pthread_mutex_unlock(&amp;tip-&gt;mutex);</div><div class="t m0 x60 h57 y8de ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xe2 h57 y8df ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xe2 h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 xe2 h57 y8e1 ff1a fs2d fc0 sc0 ls0 ws0">main()</div><div class="t m0 xe2 h57 y2f74 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x60 h57 y2f75 ff1a fs2d fc0 sc0 ls0 ws0">char <span class="_ _227"> </span>c;</div><div class="t m0 x60 h57 y2f76 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>i,<span class="_"> </span>n, err;</div><div class="t m0 x60 h57 y2f77 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>fd[2];</div><div class="t m0 x60 h57 y31bc ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _1e7"> </span>qid[NQ];</div><div class="t m0 x60 h57 y3264 ff1a fs2d fc0 sc0 ls0 ws0">struct pollfd<span class="_ _b7"> </span>pfd[NQ];</div><div class="t m0 x60 h57 y3265 ff1a fs2d fc0 sc0 ls0 ws0">struct threadinfo<span class="_ _68"> </span>ti[NQ];</div><div class="t m0 x60 h57 y3266 ff1a fs2d fc0 sc0 ls0 ws0">pthread_t <span class="_ _74"> </span>tid[NQ];</div><div class="t m0 x60 h57 y2f7c ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; NQ; i++) {</div><div class="t m0 xb9 h57 y2f7d ff1a fs2d fc0 sc0 ls0 ws0">if ((qid[i] = msgget((KEY+i), IPC_CREAT|0666)) &lt; 0)</div><div class="t m0 x1ce h57 y2f7e ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;msgget error&quot;);</div><div class="t m0 xb9 h57 y2f7f ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;queue ID %d is %d\n&quot;, i, qid[i]);</div><div class="t m0 xb9 h57 y42b8 ff1a fs2d fc0 sc0 ls0 ws0">if (socketpair(AF_UNIX, SOCK_DGRAM, 0, fd) &lt; 0)</div><div class="t m0 x1ce h57 y42b9 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;socketpair error&quot;);</div><div class="t m0 xb9 h57 y42ba ff1a fs2d fc0 sc0 ls0 ws0">pfd[i].fd = fd[0];</div><div class="t m0 xb9 h57 y42bb ff1a fs2d fc0 sc0 ls0 ws0">pfd[i].events = POLLIN;</div><div class="t m0 xb9 h57 y42bc ff1a fs2d fc0 sc0 ls0 ws0">ti[i].qid = qid[i];</div><div class="t m0 xb9 h57 y42bd ff1a fs2d fc0 sc0 ls0 ws0">ti[i].fd = fd[1];</div><div class="t m0 xb9 h57 y42be ff1a fs2d fc0 sc0 ls0 ws0">if (pthread_cond_init(&amp;ti[i].ready, NULL) != 0)</div><div class="t m0 x1ce h57 y4d02 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;pthread_cond_init error&quot;);</div><div class="t m0 xb9 h57 y4d03 ff1a fs2d fc0 sc0 ls0 ws0">if (pthread_mutex_init(&amp;ti[i].mutex, NULL) != 0)</div><div class="t m0 x1ce h57 y4d04 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;pthread_mutex_init error&quot;);</div><div class="t m0 xb9 h57 y4e5d ff1a fs2d fc0 sc0 ls0 ws0">if ((err = pthread_create(&amp;tid[i], NULL, helper,</div><div class="t m0 x1b h57 y4e5e ff1a fs2d fc0 sc0 ls0 ws0">&amp;ti[i])) != 0)</div><div class="t m0 x1ce h57 y4e5f ff1a fs2d fc0 sc0 ls0 ws0">err_exit(err, &quot;pthread_create error&quot;);</div><div class="t m0 x60 h57 y4e60 ff1a fs2d fc0 sc0 ls0 ws0">}</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
