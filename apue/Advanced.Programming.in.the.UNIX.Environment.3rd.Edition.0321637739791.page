<div id="pf317" class="pf w4 h1f" data-page-no="317"><div class="pc pc317 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg317.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">757</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">60 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">61 <span class="_ _68"> </span>*<span class="_"> </span>Internal functions.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">62 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">63 <span class="_ _d9"> </span>static<span class="_"> </span>DB <span class="_ _15"> </span>*_db_alloc(int);</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">64 <span class="_ _d9"> </span>static<span class="_"> </span>void <span class="_ _87"> </span>_db_dodelete(DB<span class="_"> </span>*);</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">65 <span class="_ _d9"> </span>static<span class="_"> </span>int <span class="_ _15"> </span>_db_find_and_lock(DB<span class="_"> </span>*, const char *, int);</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">66 <span class="_ _d9"> </span>static<span class="_"> </span>int <span class="_ _15"> </span>_db_findfree(DB<span class="_"> </span>*, int, int);</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">67 <span class="_ _d9"> </span>static<span class="_"> </span>void <span class="_ _87"> </span>_db_free(DB<span class="_"> </span>*);</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">68 <span class="_ _d9"> </span>static<span class="_"> </span>DBHASH <span class="_"> </span>_db_hash(DB<span class="_"> </span>*, const char *);</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">69 <span class="_ _d9"> </span>static<span class="_"> </span>char <span class="_ _3a"> </span>*_db_readdat(DB<span class="_"> </span>*);</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">70 <span class="_ _d9"> </span>static<span class="_"> </span>off_t <span class="_ _3a"> </span>_db_readidx(DB<span class="_"> </span>*, off_t);</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">71 <span class="_ _d9"> </span>static<span class="_"> </span>off_t <span class="_ _3a"> </span>_db_readptr(DB<span class="_"> </span>*, off_t);</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">72 <span class="_ _d9"> </span>static<span class="_"> </span>void <span class="_ _87"> </span>_db_writedat(DB<span class="_"> </span>*, const char *, off_t, int);</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">73 <span class="_ _d9"> </span>static<span class="_"> </span>void <span class="_ _87"> </span>_db_writeidx(DB<span class="_"> </span>*, const char *, off_t, int, off_t);</div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">74 <span class="_ _d9"> </span>static<span class="_"> </span>void <span class="_ _87"> </span>_db_writeptr(DB<span class="_"> </span>*, off_t, off_t);</div><div class="t m0 x32 h57 y56d1 ff1a fs2d fc0 sc0 ls0 ws0">75 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y56d2 ff1a fs2d fc0 sc0 ls0 ws0">76 <span class="_ _68"> </span>*<span class="_"> </span>Open or create a database.<span class="_ _3a"> </span>Same arguments as open(2).</div><div class="t m0 x32 h57 y56d3 ff1a fs2d fc0 sc0 ls0 ws0">77 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56d4 ff1a fs2d fc0 sc0 ls0 ws0">78 <span class="_ _d9"> </span>DBHANDLE</div><div class="t m0 x32 h57 y56d5 ff1a fs2d fc0 sc0 ls0 ws0">79 <span class="_ _d9"> </span>db_open(const<span class="_"> </span>char *pathname, int oflag, ...)</div><div class="t m0 x32 h57 y56d6 ff1a fs2d fc0 sc0 ls0 ws0">80 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56d7 ff1a fs2d fc0 sc0 ls0 ws0">81 <span class="_ _8a"> </span>DB<span class="_ _74"> </span>*db;</div><div class="t m0 x32 h57 y56d8 ff1a fs2d fc0 sc0 ls0 ws0">82 <span class="_ _8a"> </span>int<span class="_ _176"> </span>len, mode;</div><div class="t m0 x32 h57 y56d9 ff1a fs2d fc0 sc0 ls0 ws0">83 <span class="_ _8a"> </span>size_t <span class="_ _8a"> </span>i;</div><div class="t m0 x32 h57 y56da ff1a fs2d fc0 sc0 ls0 ws0">84 <span class="_ _8a"> </span>char<span class="_ _186"> </span>asciiptr[PTR_SZ + 1],</div><div class="t m0 x32 h57 y56db ff1a fs2d fc0 sc0 ls0 ws0">85 <span class="_ _ce"> </span>hash[(NHASH_DEF<span class="_"> </span>+<span class="_"> </span>1)<span class="_"> </span>*<span class="_"> </span>PTR_SZ + 2];</div><div class="t m0 x32 h57 y56dc ff1a fs2d fc0 sc0 ls0 ws0">86 <span class="_ _17b"> </span>/*<span class="_"> </span>+2 for newline and null */</div><div class="t m0 x32 h57 y56dd ff1a fs2d fc0 sc0 ls0 ws0">87 <span class="_ _8a"> </span>struct<span class="_"> </span>stat statbuff;</div><div class="t m0 x32 h57 y56df ff1a fs2d fc0 sc0 ls0 ws0">88 <span class="_ _8a"> </span>/*</div><div class="t m0 x32 h57 y56e0 ff1a fs2d fc0 sc0 ls0 ws0">89 <span class="_ _189"> </span>*<span class="_"> </span>Allocate a DB structure, and the buffers it needs.</div><div class="t m0 x32 h57 y56e1 ff1a fs2d fc0 sc0 ls0 ws0">90 <span class="_ _189"> </span>*/</div><div class="t m0 x32 h57 y56ef ff1a fs2d fc0 sc0 ls0 ws0">91 <span class="_ _8a"> </span>len<span class="_"> </span><span class="ls15c">=s<span class="_ _1d"></span><span class="ls0">trlen(pathname);</span></span></div><div class="t m0 x32 h57 y56f0 ff1a fs2d fc0 sc0 ls0 ws0">92 <span class="_ _8a"> </span>if<span class="_"> </span>((db = _db_alloc(len)) == NULL)</div><div class="t m0 x32 h57 y56f1 ff1a fs2d fc0 sc0 ls0 ws0">93 <span class="_ _176"> </span>err_dump(&quot;db_open:<span class="_"> </span>_db_alloc error for DB&quot;);</div><div class="t m0 x32 h49 y56f2 ff19 fs26 fc0 sc0 ls0 ws0">[60 <span class="_ _a"></span>– <span class="_ _a"></span>74]<span class="_ _65"> </span><span class="ls164">We <span class="_ _47"> </span>h<span class="_ _9"></span></span>ave <span class="_ _23"> </span>chosen <span class="_ _23"> </span>to <span class="_ _23"> </span>name <span class="_ _23"> </span>all <span class="_ _23"> </span>the <span class="_ _23"> </span>user-callable <span class="_ _23"></span>(public) <span class="_ _23"></span>functions <span class="_ _23"></span>starting <span class="_ _23"></span>with</div><div class="t m0 x2d h4d y56f3 ff1a fs26 fc0 sc0 ls0 ws0">db_<span class="_ _44"> </span><span class="ff19">and <span class="_ _e"> </span>all <span class="_ _53"> </span>the <span class="_ _e"> </span>internal <span class="_ _53"> </span>(private) <span class="_ _e"> </span>functions <span class="_ _53"> </span>starting <span class="_ _53"> </span>with<span class="_ _4b"> </span></span>_db_<span class="ff19 ls165d">.T<span class="_ _52"></span><span class="ls0">he <span class="_ _53"> </span>public</span></span></div><div class="t m0 x2d h4d y56f4 ff19 fs26 fc0 sc0 ls0 ws0">functions <span class="_ _23"> </span>wer<span class="ls165e">ed<span class="_ _43"></span><span class="ls0">eclared <span class="_ _23"></span>in <span class="_ _23"> </span>the <span class="_ _23"> </span>library’s <span class="_ _42"> </span>header <span class="_ _23"> </span>ﬁle,<span class="_ _35"> </span><span class="ff1a">apue_db.h</span><span class="ls165f">.W<span class="_ _64"></span><span class="ls165e">ed<span class="_ _43"></span><span class="ls0">eclare</span></span></span></span></span></div><div class="t m0 x2d h4d y56f5 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _3"></span>internal <span class="_ _3"></span>functions <span class="_ _9"></span>as<span class="_ _47"> </span><span class="ff1a">static<span class="_ _45"> </span></span>so <span class="_ _2"></span>they <span class="_ _9"></span>ar<span class="ls1660">ev<span class="_ _b"></span><span class="ls0">isible <span class="_ _3"></span>only <span class="_ _9"></span>to <span class="_ _3"></span>functions <span class="_ _3"></span>residing</span></span></div><div class="t m0 x2d h49 y56f6 ff19 fs26 fc0 sc0 ls0 ws0">in the same ﬁle (the ﬁle containing the library implementation).</div><div class="t m0 x32 h4d y56f7 ff19 fs26 fc0 sc0 ls0 ws0">[75 <span class="_ _a"></span>– <span class="_ _a"></span>93]<span class="_ _65"> </span>The<span class="_ _66"> </span><span class="ff1a">db_open<span class="_ _47"> </span></span>function <span class="_ _2"></span>has <span class="_ _2"></span>the <span class="_ _2"></span>same <span class="_ _3"></span>arguments as<span class="_ _47"> </span><span class="ff1a">open</span></div><div class="t m0 x44 h49 y56f8 ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x15a h49 y56f7 ff19 fs26 fc0 sc0 ls0 ws0">2</div><div class="t m0 x12 h49 y56f8 ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 xfe h49 y56f7 ff19 fs26 fc0 sc0 ls1661 ws0">.I<span class="_ _1d"></span><span class="lsc4d">ft<span class="_ _d"></span><span class="ls0">he <span class="_ _2"></span>caller <span class="_ _2"></span>wants</span></span></div><div class="t m0 x2d h49 y56f9 ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _47"> </span>create <span class="_ _47"> </span>the <span class="_ _47"> </span>database <span class="_ _47"> </span>ﬁles, <span class="_ _47"> </span>the <span class="_ _47"> </span>optional <span class="_ _45"> </span>thir<span class="_ _0"></span><span class="ls966">da<span class="_ _1d"></span><span class="lscc">rg<span class="ls0">ument <span class="_ _45"> </span>speciﬁes <span class="_ _47"> </span>the <span class="_ _47"> </span>ﬁle</span></span></span></div><div class="t m0 x2d h4d y56fa ff19 fs26 fc0 sc0 ls0 ws0">permissions. <span class="_ _4b"> </span>The<span class="_ _59"> </span><span class="ff1a">db_open<span class="_ _4b"> </span></span>function <span class="_ _e"> </span>opens <span class="_ _e"> </span>the <span class="_"> </span>index <span class="_ _53"> </span>ﬁle <span class="_ _e"> </span>and <span class="_ _e"> </span>the <span class="_"> </span>data <span class="_ _53"> </span>ﬁle,</div><div class="t m0 x2d h49 y56fb ff19 fs26 fc0 sc0 ls0 ws0">initializing <span class="_ _46"> </span>the <span class="_ _46"> </span>index <span class="_ _46"> </span>ﬁle, <span class="_ _46"> </span>if <span class="_ _46"> </span>necessary<span class="_ _6"></span><span class="ls1662">.T<span class="_ _4e"></span><span class="ls0">he <span class="_ _59"> </span>function <span class="_ _46"> </span>starts <span class="_ _46"> </span>by <span class="_ _46"> </span>calling</span></span></div><div class="t m0 x2d h4d y56fc ff1a fs26 fc0 sc0 ls0 ws0">_db_alloc<span class="_ _80"> </span><span class="ff19">to allocate and initialize a<span class="_"> </span></span>DB<span class="_ _66"> </span><span class="ff19">structur<span class="_ _0"></span>e.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
