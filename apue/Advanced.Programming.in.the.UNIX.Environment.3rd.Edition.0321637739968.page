<div id="pf3c8" class="pf w4 h1f" data-page-no="3c8"><div class="pc pc3c8 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg3c8.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">934<span class="_ _1b"> </span><span class="ff19">Solutions <span class="_"> </span>to <span class="_"> </span>Selected <span class="_"> </span>Exercises <span class="_ _2eb"> </span>Appendix<span class="_ _4b"> </span>C</span></div><div class="t m0 xe2 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;poll.h&gt;</div><div class="t m0 xe2 h57 y363 ff1a fs2d fc0 sc0 ls0 ws0">void</div><div class="t m0 xe2 h57 y13a0 ff1a fs2d fc0 sc0 ls0 ws0">sleep_us(unsigned int nusecs)</div><div class="t m0 xe2 h57 y846 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x60 h57 y847 ff1a fs2d fc0 sc0 ls0 ws0">struct pollfd<span class="_ _68"> </span>dummy;</div><div class="t m0 x60 h57 y13a1 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>timeout;</div><div class="t m0 x60 h57 y368 ff1a fs2d fc0 sc0 ls0 ws0">if ((timeout = nusecs / 1000) &lt;= 0)</div><div class="t m0 xb9 h57 y848 ff1a fs2d fc0 sc0 ls0 ws0">timeout = 1;</div><div class="t m0 x60 h57 y849 ff1a fs2d fc0 sc0 ls0 ws0">poll(&amp;dummy, 0, timeout);</div><div class="t m0 xe2 h57 y84a ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x2f h5e y621c ff18 fs10 fc0 sc0 ls0 ws0">Figure C.17<span class="_ _5a"> </span><span class="ff19">Implementation of<span class="_"> </span><span class="ff1a">sleep_us<span class="_ _e"> </span></span>using<span class="_"> </span><span class="ff1a">poll</span></span></div><div class="t m0 xe2 h4d y621d ff19 fs26 fc0 sc0 ls0 ws0">As <span class="_ _45"> </span>the <span class="_ _35"> </span>BSD<span class="_ _51"> </span><span class="ff1a">usleep</span></div><div class="t m0 xee h49 y621e ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x66 h49 y621d ff19 fs26 fc0 sc0 ls0 ws0">3</div><div class="t m0 x17f h49 y621e ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 x1e2 h4d y621d ff19 fs26 fc0 sc0 ls0 ws0">manual <span class="_ _45"> </span>page <span class="_ _35"> </span>states,<span class="_ _51"> </span><span class="ff1a">usleep<span class="_"> </span></span>uses <span class="_ _35"> </span>the<span class="_ _5a"> </span><span class="ff1a">nanosleep</span></div><div class="t m0 xe2 h49 y621f ff19 fs26 fc0 sc0 ls0 ws0">function, which doesn’t interfer<span class="lsd3">ew<span class="_ _4f"></span><span class="ls0">ith timers set by the calling process.</span></span></div><div class="t m0 x32 h4d y6220 ff18 fs26 fc0 sc0 ls0 ws0">14.6<span class="_ _210"> </span><span class="ff19">No. <span class="_ _45"> </span>What<span class="_ _45"> </span>we <span class="_ _9"></span>would <span class="_ _9"></span>like <span class="_ _9"></span>to <span class="_ _9"></span>do <span class="_ _23"></span>is <span class="_ _3"></span>have<span class="_ _45"> </span><span class="ff1a">TELL_WAIT<span class="_ _45"> </span></span>create <span class="_ _9"></span>a <span class="_ _9"></span>temporary <span class="_ _9"></span>ﬁle <span class="_ _9"></span>and</span></div><div class="t m0 xe2 h4d y6221 ff19 fs26 fc0 sc0 ls0 ws0">use <span class="_ _42"> </span>1 <span class="_ _53"> </span>byte <span class="_ _53"> </span>for <span class="_ _42"> </span>the <span class="_ _53"> </span>parent’s <span class="_ _42"> </span>lock <span class="_ _53"> </span>and <span class="_ _53"> </span>1 <span class="_ _42"> </span>byte <span class="_ _53"> </span>for <span class="_ _53"> </span>the <span class="_ _53"> </span>child’s <span class="_ _42"> </span>lock.<span class="_ _65"> </span><span class="ff1a">WAIT_CHILD</span></div><div class="t m0 xe2 h49 y6222 ff19 fs26 fc0 sc0 ls0 ws0">would <span class="_ _59"> </span>have <span class="_ _59"> </span>the <span class="_ _4b"> </span>parent <span class="_ _59"> </span>wait <span class="_ _59"> </span>to <span class="_ _59"> </span>obtain <span class="_ _4b"> </span>a <span class="_ _59"> </span>lock <span class="_ _59"> </span>on <span class="_ _59"> </span>the <span class="_ _59"> </span>child’s <span class="_ _59"> </span>byte, <span class="_ _59"> </span>and</div><div class="t m0 xe2 h4d y6223 ff1a fs26 fc0 sc0 ls0 ws0">TELL_PARENT<span class="_ _44"> </span><span class="ff19">would <span class="_ _42"> </span>have <span class="_ _42"> </span>the <span class="_ _42"> </span>child <span class="_ _53"> </span>release <span class="_ _42"> </span>the <span class="_ _42"> </span>lock <span class="_ _42"> </span>on <span class="_ _42"> </span>the <span class="_ _42"> </span>child’s <span class="_ _53"> </span>byte.<span class="_ _54"> </span>The</span></div><div class="t m0 xe2 h4d y6224 ff19 fs26 fc0 sc0 ls0 ws0">problem, <span class="_ _3"></span>however<span class="_ _1"></span><span class="ls1867">,i<span class="_ _b"></span><span class="ls1868">st<span class="_ _b"></span><span class="ls0">hat <span class="_ _9"></span>calling<span class="_ _45"> </span><span class="ff1a">fork<span class="_ _45"> </span></span><span class="lscc">re<span class="_ _2"></span></span>leases <span class="_ _23"></span>all <span class="_ _9"></span>the <span class="_ _9"></span>locks <span class="_ _9"></span>in <span class="_ _23"></span>the <span class="_ _9"></span>child, <span class="_ _9"></span>so <span class="_ _23"></span>the</span></span></span></div><div class="t m0 xe2 h49 y6225 ff19 fs26 fc0 sc0 ls0 ws0">child can’t start of<span class="lsd3">fw<span class="_ _4f"></span><span class="ls0">ith any locks of its own.</span></span></div><div class="t m0 x32 h49 y6226 ff18 fs26 fc0 sc0 ls0 ws0">14.7<span class="_ _210"> </span><span class="ff19 lsd3">As<span class="_ _5"></span><span class="ls0">olution is shown in Figur<span class="lsd3">eC<span class="_ _4f"></span><span class="ls0">.18.</span></span></span></span></div><div class="t m0 xe2 h5d y6227 ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 xe2 h5d y6228 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 xe2 h5d y6229 ff1a fs2f fc0 sc0 ls0 ws0">int</div><div class="t m0 xe2 h5d y622a ff1a fs2f fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 xe2 h5d y622b ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x60 h5d y622c ff1a fs2f fc0 sc0 ls0 ws0">int i, n;</div><div class="t m0 x60 h5d y622d ff1a fs2f fc0 sc0 ls0 ws0">int fd[2];</div><div class="t m0 x60 h5d y622e ff1a fs2f fc0 sc0 ls0 ws0">if (pipe(fd) &lt; 0)</div><div class="t m0 xb9 h5d y622f ff1a fs2f fc0 sc0 ls0 ws0">err_sys(&quot;pipe error&quot;);</div><div class="t m0 x60 h5d y6230 ff1a fs2f fc0 sc0 ls0 ws0">set_fl(fd[1], O_NONBLOCK);</div><div class="t m0 x60 h5d y6231 ff1a fs2f fc0 sc0 ls0 ws0">/* write 1 byte at a time until pipe is full */</div><div class="t m0 x60 h5d y6232 ff1a fs2f fc0 sc0 ls0 ws0">for (n = 0; ; n++) {</div><div class="t m0 xb9 h5d y6233 ff1a fs2f fc0 sc0 ls0 ws0">if ((i = write(fd[1], &quot;a&quot;, 1)) != 1) {</div><div class="t m0 x1ce h5d y6234 ff1a fs2f fc0 sc0 ls0 ws0">printf(&quot;write ret %d, &quot;, i);</div><div class="t m0 x1ce h5d y6235 ff1a fs2f fc0 sc0 ls0 ws0">break;</div><div class="t m0 xb9 h5d y6236 ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x60 h5d y6237 ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x60 h5d y6238 ff1a fs2f fc0 sc0 ls0 ws0">printf(&quot;pipe capacity = %d\n&quot;, n);</div><div class="t m0 x60 h5d y6239 ff1a fs2f fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 xe2 h5d y623a ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x4 h2f y623b ff18 fs12 fc0 sc0 ls0 ws0">Figure C.18<span class="_ _5a"> </span><span class="ff19">Calculation of pipe capacity using nonblocking writes</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
