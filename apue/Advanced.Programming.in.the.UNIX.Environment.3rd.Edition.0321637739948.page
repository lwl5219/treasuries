<div id="pf3b4" class="pf w4 h1f" data-page-no="3b4"><div class="pc pc3b4 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg3b4.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">914<span class="_ _1b"> </span><span class="ff19">Solutions <span class="_"> </span>to <span class="_"> </span>Selected <span class="_"> </span>Exercises <span class="_ _2eb"> </span>Appendix<span class="_ _4b"> </span>C</span></div><div class="t m0 x215 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">static int type_to_flags(const char *__restrict type);</div><div class="t m0 x215 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">static off_t find_end(char *buf, size_t len);</div><div class="t m0 x215 h57 y1307 ff1a fs2d fc0 sc0 ls0 ws0">FILE *</div><div class="t m0 x215 h57 y1308 ff1a fs2d fc0 sc0 ls0 ws0">fmemopen(void *__restrict buf, size_t size,</div><div class="t m0 xc4 h57 y3508 ff1a fs2d fc0 sc0 ls0 ws0">const char *__restrict type)</div><div class="t m0 x215 h57 y3509 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 xc4 h57 y350a ff1a fs2d fc0 sc0 ls0 ws0">struct memstream *ms;</div><div class="t m0 xc4 h57 y350b ff1a fs2d fc0 sc0 ls0 ws0">FILE *fp;</div><div class="t m0 xc4 h57 y130d ff1a fs2d fc0 sc0 ls0 ws0">if (size == 0) {</div><div class="t m0 x206 h57 y130e ff1a fs2d fc0 sc0 ls0 ws0">errno = EINVAL;</div><div class="t m0 x206 h57 y130f ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 xc4 h57 y1310 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y1311 ff1a fs2d fc0 sc0 ls0 ws0">if ((ms = malloc(sizeof(struct memstream))) == NULL) {</div><div class="t m0 x206 h57 y1312 ff1a fs2d fc0 sc0 ls0 ws0">errno = ENOMEM;</div><div class="t m0 x206 h57 y1313 ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 xc4 h57 y1314 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y1315 ff1a fs2d fc0 sc0 ls0 ws0">if ((ms-&gt;flags = type_to_flags(type)) == 0) {</div><div class="t m0 x206 h57 y351c ff1a fs2d fc0 sc0 ls0 ws0">errno = EINVAL;</div><div class="t m0 x206 h57 y351d ff1a fs2d fc0 sc0 ls0 ws0">free(ms);</div><div class="t m0 x206 h57 y351e ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 xc4 h57 y351f ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y3520 ff1a fs2d fc0 sc0 ls0 ws0">if (buf == NULL) {</div><div class="t m0 x206 h57 y42b2 ff1a fs2d fc0 sc0 ls0 ws0">if ((ms-&gt;flags &amp; (MS_READ|MS_WRITE)) !=</div><div class="t m0 x132 h57 y42b3 ff1a fs2d fc0 sc0 ls0 ws0">(MS_READ|MS_WRITE)) {</div><div class="t m0 xe9 h57 y42b4 ff1a fs2d fc0 sc0 ls0 ws0">errno = EINVAL;</div><div class="t m0 xe9 h57 y38bf ff1a fs2d fc0 sc0 ls0 ws0">free(ms);</div><div class="t m0 xe9 h57 y38c0 ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 x206 h57 y38c1 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x206 h57 y42b5 ff1a fs2d fc0 sc0 ls0 ws0">if ((ms-&gt;buf = malloc(size)) == NULL) {</div><div class="t m0 xe9 h57 y3f7e ff1a fs2d fc0 sc0 ls0 ws0">errno = ENOMEM;</div><div class="t m0 xe9 h57 y3f7f ff1a fs2d fc0 sc0 ls0 ws0">free(ms);</div><div class="t m0 xe9 h57 y3f80 ff1a fs2d fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 x206 h57 y3f81 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x206 h57 y2f7f ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;rsize = size;</div><div class="t m0 x206 h57 y2f80 ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;flags |= MS_MYBUF;</div><div class="t m0 x206 h57 y3f82 ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;curpos = 0;</div><div class="t m0 xc4 h57 y3f83 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {</span></div><div class="t m0 x206 h57 y3f84 ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;buf = buf;</div><div class="t m0 x206 h57 y3f85 ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;rsize = size;</div><div class="t m0 x206 h57 y3f86 ff1a fs2d fc0 sc0 ls0 ws0">if (ms-&gt;flags &amp; MS_APPEND)</div><div class="t m0 xe9 h57 y3f87 ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;curpos = find_end(ms-&gt;buf, ms-&gt;rsize);</div><div class="t m0 x206 h57 y3f88 ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 xe9 h57 y3f89 ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;curpos = 0;</div><div class="t m0 xc4 h57 y3f8a ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xc4 h57 y3f8b ff1a fs2d fc0 sc0 ls0 ws0">if (ms-&gt;flags &amp; MS_APPEND) {<span class="_ _82"> </span>/* &quot;a&quot; mode */</div><div class="t m0 x206 h57 y3f8c ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;vsize = ms-&gt;curpos;</div><div class="t m0 xc4 h57 y3f8d ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (ms-&gt;flags &amp; MS_TRUNCATE) {<span class="_ _87"> </span>/* &quot;w&quot; mode */</span></div><div class="t m0 x206 h57 y3f8e ff1a fs2d fc0 sc0 ls0 ws0">ms-&gt;vsize = 0;</div><div class="t m0 xc4 h57 y3f8f ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {<span class="_ _26e"> </span>/* &quot;r&quot; mode */</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
