<div id="pf267" class="pf w4 h1f" data-page-no="267"><div class="pc pc267 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg267.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>15.10<span class="_ _282"> </span>POSIX <span class="_"> </span>Semaphores<span class="_ _1fb"> </span><span class="ff18">581</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _35"> </span><span class="ff1a">sem_unlink<span class="_ _45"> </span></span>function <span class="_ _23"> </span>removes <span class="_ _23"></span>the <span class="_ _23"></span>name <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>semaphore. <span class="_ _45"> </span>If<span class="_ _35"> </span>ther<span class="ls12a2">ea<span class="_ _43"></span><span class="ls45">re <span class="_ _42"> </span>n<span class="ls12a3">oo<span class="_ _b"></span><span class="ls0">pen</span></span></span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ferences <span class="_ _42"> </span>to <span class="_ _53"> </span>the <span class="_ _42"> </span>semaphore, <span class="_ _42"> </span>then <span class="_ _53"> </span>it <span class="_ _42"> </span>is <span class="_ _53"> </span>destroyed. <span class="_ _44"> </span>Otherwise,<span class="_ _44"> </span>destruction <span class="_ _42"> </span>is <span class="_ _42"> </span>deferred</span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">until the last open refer<span class="_ _0"></span>ence is closed.</div><div class="t m0 x3f h2a y132 ff19 fsf fc0 sc0 ls0 ws0">Unlike with XSI semaphores, we can only adjust the value of a POSIX semaphor<span class="_ _0"></span><span class="ls44">eb<span class="_ _d"></span><span class="ls0">y</span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">one with a single function <span class="_ _2"></span>call.<span class="_ _46"> </span>Decrementing the count is analogous to locking <span class="_ _2"></span>a binary</div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">semaphore<span class="_"> </span>or<span class="_"> </span>acquiring a r<span class="_ _0"></span>esour<span class="_ _0"></span>ce associated with a counting semaphore.</div><div class="t m0 x76 h51 y736 ff19 fs2a fc0 sc0 ls0 ws0">Note <span class="_ _2"></span>that <span class="_ _2"></span>there<span class="_ _80"> </span>is<span class="_ _80"> </span>no<span class="_ _80"> </span>distinction <span class="_ _3"></span>of <span class="_ _2"></span>semaphor<span class="lsc52">et<span class="_ _d"></span><span class="ls0">ype <span class="_ _3"></span>with <span class="_ _2"></span>POSIX <span class="_ _3"></span>semaphores. <span class="_ _e"> </span>Whether<span class="_ _80"> </span>we <span class="_ _3"></span>use</span></span></div><div class="t m0 x76 h51 ybc5 ff19 fs2a fc0 sc0 ls12a4 ws0">ab<span class="_ _43"></span><span class="ls0">inary <span class="_"> </span>semaphore<span class="_ _35"> </span>or<span class="_ _35"> </span>a<span class="_ _35"> </span>counting <span class="_"> </span>semaphor<span class="ls12a4">ed<span class="_ _43"></span><span class="ls0">epends <span class="_"> </span>on <span class="_"> </span>how <span class="_ _42"> </span>we <span class="_"> </span>initialize <span class="_"> </span>and <span class="_"> </span>use <span class="_"> </span>the</span></span></span></div><div class="t m0 x76 h51 ybc6 ff19 fs2a fc0 sc0 ls0 ws0">semaphore. <span class="_ _47"> </span>If<span class="_ _45"> </span><span class="lsc5c">as<span class="_ _b"></span><span class="ls0">emaphor<span class="lsc5c">eo<span class="_ _b"></span><span class="ls0">nly <span class="_ _23"> </span>ever <span class="_ _42"> </span>has <span class="_ _23"> </span>a <span class="_ _23"> </span>value <span class="_ _23"> </span>of <span class="_ _42"> </span>0 <span class="_ _23"> </span>or <span class="_ _23"> </span>1, <span class="_ _23"> </span>then <span class="_ _42"> </span>it <span class="_ _23"> </span>is <span class="_ _23"> </span>a <span class="_ _23"> </span>binary <span class="_ _23"> </span>semaphore.</span></span></span></span></div><div class="t m0 x76 h51 y1f1c ff19 fs2a fc0 sc0 ls0 ws0">When a <span class="_ _2"></span>binary semaphor<span class="ls12a5">eh<span class="_ _5"></span><span class="ls0">as <span class="_ _2"></span>a value <span class="_ _2"></span>of 1, <span class="_ _2"></span>we say <span class="_ _2"></span>that <span class="_ _2"></span>it is <span class="_ _2"></span>‘<span class="_ _0"></span>‘unlocked;’<span class="_ _0"></span><span class="ls12a5">’w<span class="_ _5"></span><span class="ls0">hen <span class="_ _2"></span>it has <span class="_ _2"></span>a value <span class="_ _2"></span>of</span></span></span></span></div><div class="t m0 x76 h51 y403a ff19 fs2a fc0 sc0 ls0 ws0">0, we say that it is ‘<span class="_ _0"></span>‘locked.’<span class="_ _0"></span>’</div><div class="t m0 x3f h26 y15a ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _59"> </span>d<span class="_ _9"></span><span class="ls0">ecrement <span class="_ _47"> </span>the <span class="_ _47"> </span>value <span class="_ _47"> </span>of <span class="_ _66"> </span>a <span class="_ _47"> </span>semaphore, <span class="_ _47"> </span>we <span class="_ _47"> </span>can <span class="_ _47"> </span>use <span class="_ _47"> </span>either <span class="_ _47"> </span>the<span class="_ _61"> </span><span class="ff1a">sem_wait<span class="_ _16"> </span></span>or</span></div><div class="t m0 x32 h26 y15b ff1a fsf fc0 sc0 ls0 ws0">sem_trywait<span class="_ _80"> </span><span class="ff19">function.</span></div><div class="t m0 x3f h57 y4605 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;semaphore.h&gt;</div><div class="t m0 x3f h57 y4606 ff1a fs2d fc0 sc0 ls0 ws0">int sem_trywait(sem_t *<span class="ff1b">sem</span>);</div><div class="t m0 x3f h57 y4607 ff1a fs2d fc0 sc0 ls0 ws0">int sem_wait(sem_t *<span class="ff1b">sem</span>);</div><div class="t m0 x1af h5f y4608 ff19 fs2d fc0 sc0 ls0 ws0">Both return: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x32 h4d y4609 ff19 fs26 fc0 sc0 ls3aa ws0">Wi<span class="_ _3"></span><span class="ls0">th <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">sem_wait<span class="_ _4b"> </span></span>function, <span class="_ _e"> </span>we <span class="_ _53"> </span>will <span class="_ _e"> </span>block <span class="_ _e"> </span>if <span class="_ _53"> </span>the <span class="_ _e"> </span>semaphor<span class="ls12a6">ec<span class="_ _55"></span><span class="ls0">ount <span class="_ _e"> </span>is <span class="_ _53"> </span>0.<span class="_ _48"> </span><span class="ls164">We <span class="_ _35"> </span>w<span class="_ _9"></span></span>on’t</span></span></span></div><div class="t m0 x32 h49 y460a ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turn <span class="_ _9"></span>until <span class="_ _3"></span>we <span class="_ _9"></span>have <span class="_ _3"></span>successfully <span class="_ _9"></span>decremented <span class="_ _3"></span>the <span class="_ _3"></span>semaphor<span class="ls12a7">ec<span class="_ _b"></span><span class="ls0">ount <span class="_ _9"></span>or <span class="_ _3"></span>ar<span class="ls12a7">ei<span class="_ _8"></span><span class="ls0">nterrupted</span></span></span></span></span></div><div class="t m0 x32 h4d y460b ff19 fs26 fc0 sc0 ls0 ws0">by a signal.<span class="_ _59"> </span><span class="ls164">We <span class="_ _e"> </span>c<span class="_ _9"></span></span>an use the<span class="_"> </span><span class="ff1a">sem_trywait<span class="_ _80"> </span></span>function to avoid blocking.<span class="_ _46"> </span>If the semaphore</div><div class="t m0 x32 h4d y460c ff19 fs26 fc0 sc0 ls0 ws0">count <span class="_ _3"></span>is <span class="_ _9"></span>zer<span class="ls12a8">ow<span class="_ _b"></span><span class="ls0">hen <span class="_ _9"></span>we <span class="_ _3"></span>call<span class="_ _45"> </span><span class="ff1a">sem_trywait</span>,<span class="_ _47"> </span>it<span class="_ _45"> </span>will <span class="_ _9"></span>return<span class="_ _47"> </span><span class="ff20">−</span><span class="ls12a9">1w<span class="_ _b"></span><span class="ls0">ith<span class="_ _45"> </span><span class="ff1a">errno<span class="_ _45"> </span></span>set <span class="_ _3"></span>to<span class="_ _45"> </span><span class="ff1a">EAGAIN</span></span></span></span></span></div><div class="t m0 x32 h49 y460d ff19 fs26 fc0 sc0 ls0 ws0">instead of blocking.</div><div class="t m0 x3f h49 y460e ff19 fs26 fc0 sc0 ls12aa ws0">At<span class="_ _4a"></span><span class="ls0">hir<span class="ls12aa">da<span class="_ _4a"></span><span class="ls0">lternative <span class="_"> </span>is <span class="_ _e"> </span>to <span class="_"> </span>block <span class="_ _e"> </span>for <span class="_"> </span>a <span class="_ _e"> </span>bounded <span class="_"> </span>amount <span class="_ _e"> </span>of <span class="_"> </span>time.<span class="_ _48"> </span><span class="ls164">We <span class="_ _44"> </span>c<span class="_ _9"></span></span>an <span class="_"> </span>use <span class="_ _e"> </span>the</span></span></span></div><div class="t m0 x32 h4d y460f ff1a fs26 fc0 sc0 ls0 ws0">sem_timedwait<span class="_ _80"> </span><span class="ff19">function for this purpose.</span></div><div class="t m0 x3f h4e y4610 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;semaphore.h&gt;</div><div class="t m0 x3f h4e y4611 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;time.h&gt;</div><div class="t m0 x3f h4e y4612 ff1a fs28 fc0 sc0 ls0 ws0">int sem_timedwait(sem_t *restrict<span class="_"> </span><span class="ff1b">sem</span>,</div><div class="t m0 x199 h4e y4613 ff1a fs28 fc0 sc0 ls0 ws0">const struct timespec *restrict<span class="_"> </span><span class="ff1b">tsptr</span>);</div><div class="t m0 x153 h7c y4614 ff19 fs28 fc0 sc0 ls0 ws0">Returns: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>error</div><div class="t m0 x32 h60 y4615 ff19 fs2c fc0 sc0 ls0 ws0">The<span class="_ _66"> </span><span class="ff1b">tsptr<span class="_ _47"> </span></span>argument speciﬁes <span class="_ _2"></span>the <span class="_ _2"></span>absolute <span class="_ _2"></span>time <span class="_ _2"></span>when <span class="_ _3"></span>we <span class="_ _2"></span>want <span class="_ _2"></span>to <span class="_ _2"></span>give <span class="_ _2"></span>up <span class="_ _2"></span>waiting <span class="_ _2"></span>for <span class="_ _2"></span>the</div><div class="t m0 x32 h54 y4616 ff19 fs2c fc0 sc0 ls0 ws0">semaphore. <span class="_ _66"> </span>The<span class="_ _45"> </span>timeout <span class="_ _2"></span>is <span class="_ _9"></span>based <span class="_ _3"></span>on <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">CLOCK_REALTIME<span class="_ _45"> </span></span>clock <span class="_ _2"></span>(recall <span class="_ _3"></span>Figur<span class="ls12ab">e6<span class="_ _b"></span><span class="ls0">.8). <span class="_ _45"> </span>If</span></span></div><div class="t m0 x32 h55 y4617 ff19 fs2c fc0 sc0 ls0 ws0">the <span class="_ _9"></span>semaphor<span class="ls12ac">ec<span class="_ _b"></span><span class="ls0">an <span class="_ _3"></span>be <span class="_ _9"></span>decremented <span class="_ _3"></span>immediately<span class="_ _6"></span><span class="ls12ac">,t<span class="_ _b"></span><span class="ls0">hen <span class="_ _9"></span>the <span class="_ _9"></span>value <span class="_ _9"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>timeout <span class="_ _9"></span>doesn’t</span></span></span></span></div><div class="t m0 x32 h55 y4618 ff19 fs2c fc0 sc0 ls0 ws0">matter <span class="_ _a"></span>— <span class="_ _a"></span>even<span class="_ _45"> </span>though <span class="_ _3"></span>it <span class="_ _9"></span>might <span class="_ _9"></span>specify <span class="_ _9"></span>some <span class="_ _3"></span>time <span class="_ _9"></span>in <span class="_ _9"></span>the <span class="_ _3"></span>past, <span class="_ _9"></span>the <span class="_ _9"></span>attempt <span class="_ _3"></span>to <span class="_ _9"></span>decrement</div><div class="t m0 x32 h55 y4619 ff19 fs2c fc0 sc0 ls0 ws0">the semaphor<span class="ls12ad">ew<span class="_ _4f"></span><span class="ls0">ill <span class="_ _2"></span>still succeed.<span class="_ _61"> </span>If the <span class="_ _2"></span>timeout expires without being <span class="_ _2"></span>able to <span class="_ _2"></span>decrement</span></span></div><div class="t m0 x32 h54 y461a ff19 fs2c fc0 sc0 ls0 ws0">the <span class="_ _44"> </span>semaphor<span class="ls12ae">ec<span class="_ _52"></span><span class="ls0">ount, <span class="_ _44"> </span>then<span class="_ _65"> </span><span class="ff1a">sem_timedwait<span class="_ _65"> </span></span>will <span class="_ _4b"> </span>return<span class="_ _54"> </span><span class="ff20">−</span><span class="ls12af">1w<span class="_ _52"></span><span class="ls0">ith<span class="_ _54"> </span><span class="ff1a">errno<span class="_ _65"> </span></span>set <span class="_ _4b"> </span>to</span></span></span></span></div><div class="t m0 x32 h54 y461b ff1a fs2c fc0 sc0 ls0 ws0">ETIMEDOUT<span class="ff19">.</span></div><div class="t m0 x3f h54 y461c ff19 fs2c fc0 sc0 ls155 ws0">To <span class="_ _45"> </span>i<span class="_ _23"></span><span class="ls0">ncr<span class="_ _0"></span>ement <span class="_ _42"> </span>the <span class="_ _53"> </span>value <span class="_ _53"> </span>of <span class="_ _53"> </span>a <span class="_ _42"> </span>semaphore, <span class="_ _42"> </span>we <span class="_ _53"> </span>call <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1a">sem_post<span class="_ _44"> </span></span>function. <span class="_ _4b"> </span>This<span class="_ _44"> </span>is</span></div><div class="t m0 x32 h55 y461d ff19 fs2c fc0 sc0 ls0 ws0">analogous <span class="_ _23"> </span>to <span class="_ _42"> </span>unlocking <span class="_ _23"> </span>a <span class="_ _42"> </span>binary <span class="_ _23"> </span>semaphore<span class="_ _35"> </span>or<span class="_ _35"> </span>releasing <span class="_ _23"> </span>a <span class="_ _42"> </span>resour<span class="_ _0"></span>ce <span class="_ _23"> </span>associated <span class="_ _42"> </span>with <span class="_ _23"> </span>a</div><div class="t m0 x32 h55 y461e ff19 fs2c fc0 sc0 ls0 ws0">counting semaphore.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
