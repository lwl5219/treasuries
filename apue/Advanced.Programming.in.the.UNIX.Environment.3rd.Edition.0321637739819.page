<div id="pf333" class="pf w4 h1f" data-page-no="333"><div class="pc pc333 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg333.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.9<span class="_ _24b"> </span>Performance<span class="_ _1fb"> </span><span class="ff18">785</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">grained <span class="_ _53"> </span>locking <span class="_ _e"> </span>to <span class="_ _e"> </span>ﬁne-grained <span class="_ _53"> </span>locking.<span class="_ _48"> </span>On <span class="_ _e"> </span>the <span class="_ _53"> </span>system <span class="_ _e"> </span>used <span class="_ _e"> </span>for <span class="_ _e"> </span>these <span class="_ _53"> </span>tests, <span class="_ _e"> </span>coarse-</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">grained <span class="_ _9"></span>locking <span class="_ _9"></span>is <span class="_ _9"></span>the <span class="_ _9"></span>same <span class="_ _9"></span>as <span class="_ _9"></span>ﬁne-grained <span class="_ _9"></span>locking <span class="_ _9"></span>for <span class="_ _3"></span>one <span class="_ _9"></span>process, <span class="_ _9"></span>but <span class="_ _9"></span>becomes <span class="_ _9"></span>more</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">expensive (by about 30%) with multiple processes.</div><div class="t m0 x3f h2a y132 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _59"> </span>w<span class="_ _9"></span><span class="ls0">ould <span class="_ _47"> </span>like <span class="_ _47"> </span>the <span class="_ _47"> </span>clock <span class="_ _47"> </span>time <span class="_ _47"> </span>to <span class="_ _47"> </span>decrease <span class="_ _47"> </span>from <span class="_ _66"> </span>coarse-grained <span class="_ _47"> </span>to <span class="_ _47"> </span>ﬁne-grained</span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">locking, <span class="_"> </span>which <span class="_ _e"> </span>it <span class="_"> </span>does <span class="_"> </span>as <span class="_ _e"> </span>soon <span class="_"> </span>as <span class="_"> </span>we <span class="_ _e"> </span>start <span class="_"> </span>using <span class="_"> </span>multiple <span class="_ _e"> </span>processes. <span class="_ _59"> </span>However<span class="_ _6"></span><span class="ls16ed">,w<span class="_ _55"></span><span class="ls0">e</span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">expect <span class="_ _53"> </span>the <span class="_ _53"> </span>system <span class="_ _53"> </span>time <span class="_ _42"> </span>to <span class="_ _53"> </span>remain <span class="_ _53"> </span>higher <span class="_ _53"> </span>for <span class="_ _53"> </span>ﬁne-grained <span class="_ _53"> </span>locking <span class="_ _53"> </span>for <span class="_ _53"> </span>any <span class="_ _53"> </span>number <span class="_ _53"> </span>of</div><div class="t m0 x32 h26 y135 ff19 fsf fc0 sc0 ls0 ws0">processes, because <span class="_ _2"></span>we ar<span class="ls980">ei<span class="_ _4f"></span><span class="ls0">ssuing <span class="_ _2"></span>more<span class="_"> </span><span class="ff1a">fcntl<span class="_ _66"> </span></span>calls <span class="_ _2"></span>with <span class="_ _2"></span>ﬁne-grained <span class="_ _2"></span>locking <span class="_ _2"></span>than <span class="_ _2"></span>with</span></span></div><div class="t m0 x32 h26 y136 ff19 fsf fc0 sc0 ls0 ws0">coarse-grained locking.<span class="_ _59"> </span>If we <span class="_ _2"></span>total the number of<span class="_"> </span><span class="ff1a">fcntl<span class="_ _80"> </span></span>calls in Figur<span class="ls15d7">e2<span class="_ _d"></span><span class="ls0">0.6, we have an</span></span></div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">average <span class="_ _23"></span>of <span class="_ _23"></span>87,858 <span class="_ _23"> </span>for <span class="_ _23"> </span>coarse-grained <span class="_ _23"> </span>locking <span class="_ _23"> </span>and <span class="_ _23"> </span>1<span class="_ _1"></span>15,520 <span class="_ _42"> </span>for <span class="_ _23"></span>ﬁne-grained <span class="_ _23"></span>locking.<span class="_ _51"> </span><span class="ls5f">We</span></div><div class="t m0 x32 h26 y138 ff19 fsf fc0 sc0 ls0 ws0">expect <span class="_ _9"></span>this <span class="_ _23"> </span>increase <span class="_ _9"></span>of <span class="_ _23"></span>31% <span class="_ _23"></span>mor<span class="_ _0"></span><span class="ls16ee">ec<span class="_ _b"></span><span class="ls0">alls <span class="_ _9"></span>to<span class="_ _45"> </span><span class="ff1a">fcntl<span class="_ _35"> </span></span>to <span class="_ _9"></span>result <span class="_ _23"></span>in <span class="_ _9"></span>increased <span class="_ _9"></span>system <span class="_ _23"> </span>time <span class="_ _23"></span>for</span></span></div><div class="t m0 x32 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">ﬁne-grained <span class="_ _42"> </span>locking.<span class="_ _65"> </span>Therefor<span class="_ _0"></span>e, <span class="_ _42"> </span>the <span class="_ _53"> </span>decrease <span class="_ _42"> </span>in <span class="_ _53"> </span>system <span class="_ _42"> </span>time <span class="_ _53"> </span>for <span class="_ _53"> </span>ﬁne-grained <span class="_ _53"> </span>locking</div><div class="t m0 x32 h2a y13a ff19 fsf fc0 sc0 ls0 ws0">with <span class="_ _9"></span>two <span class="_ _9"></span>processes, <span class="_ _9"></span>and <span class="_ _9"></span>the <span class="_ _9"></span>relatively <span class="_ _9"></span>small <span class="_ _9"></span>increase <span class="_ _9"></span>with <span class="_ _9"></span>mor<span class="ls3e5">et<span class="_ _b"></span><span class="ls0">han <span class="_ _9"></span>two <span class="_ _9"></span>processes, <span class="_ _9"></span>is</span></span></div><div class="t m0 x32 h2a y254 ff19 fsf fc0 sc0 ls0 ws0">puzzling.</div><div class="t m0 x3f h2a y255 ff19 fsf fc0 sc0 ls0 ws0">Ther<span class="ls16ef">ea<span class="_ _4f"></span><span class="ls45">re <span class="_ _3"></span>t<span class="ls0">wo <span class="_ _2"></span>reasons for this behavior<span class="_ _6"></span><span class="ls16f0">.F<span class="_ _4a"></span><span class="ls0">irst, recall from Figur<span class="_ _0"></span><span class="ls150e">e2<span class="_ _d"></span><span class="ls0">0.7 that there<span class="_"> </span>is<span class="_"> </span>no</span></span></span></span></span></span></span></div><div class="t m0 x32 h2a y13b ff19 fsf fc0 sc0 ls0 ws0">signiﬁcant <span class="_ _e"> </span>differ<span class="_ _0"></span>ence <span class="_ _e"> </span>between <span class="_ _e"> </span>coarse-grained <span class="_"> </span>locking <span class="_ _53"> </span>times <span class="_ _e"> </span>and <span class="_"> </span>ﬁne-grained <span class="_ _53"> </span>locking</div><div class="t m0 x32 h2a y13c ff19 fsf fc0 sc0 ls0 ws0">times <span class="_ _9"></span>when <span class="_ _9"></span>there<span class="_ _47"> </span>is<span class="_ _45"> </span>no<span class="_ _45"> </span>contention <span class="_ _3"></span>for <span class="_ _9"></span>the <span class="_ _9"></span>locks.<span class="_ _5a"> </span>This <span class="_ _9"></span>shows <span class="_ _3"></span>that <span class="_ _9"></span>the <span class="_ _9"></span>CPU <span class="_ _9"></span>overhead <span class="_ _3"></span>of</div><div class="t m0 x32 h26 y256 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _23"></span>extra<span class="_ _35"> </span><span class="ff1a">fcntl<span class="_ _35"> </span></span>calls <span class="_ _23"></span>doesn’t <span class="_ _23"></span>af<span class="_ _0"></span>fect <span class="_ _23"></span>the <span class="_ _23"> </span>performance <span class="_ _23"> </span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>test <span class="_ _23"> </span>program. <span class="_ _35"> </span>The<span class="_ _35"> </span>second</div><div class="t m0 x32 h2a y257 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ason <span class="_ _53"> </span>is <span class="_ _42"> </span>that <span class="_ _42"> </span>with <span class="_ _53"> </span>coarse-grained <span class="_ _42"> </span>locking, <span class="_ _53"> </span>we <span class="_ _42"> </span>hold <span class="_ _42"> </span>locks <span class="_ _53"> </span>for <span class="_ _42"> </span>longer <span class="_ _42"> </span>periods <span class="_ _53"> </span>of <span class="_ _42"> </span>time,</span></div><div class="t m0 x32 h2a y258 ff19 fsf fc0 sc0 ls0 ws0">thus <span class="_"> </span>incr<span class="_ _1"></span>easing <span class="_"> </span>the <span class="_"> </span>likelihood <span class="_ _53"> </span>that <span class="_"> </span>other <span class="_"> </span>pr<span class="_ _1"></span>ocesses <span class="_"> </span>will <span class="_"> </span>block <span class="_ _53"> </span>on <span class="_"> </span>a <span class="_"> </span>lock.<span class="_ _65"> </span><span class="ls65">Wi<span class="_ _3"></span></span>th <span class="_"> </span>ﬁne-</div><div class="t m0 x32 h2a y161 ff19 fsf fc0 sc0 ls0 ws0">grained <span class="_ _9"></span>locking, <span class="_ _23"></span>the <span class="_ _9"></span>locking <span class="_ _23"></span>is <span class="_ _9"></span>done <span class="_ _23"> </span>over <span class="_ _23"></span>shorter <span class="_ _9"></span>intervals, <span class="_ _23"></span>so <span class="_ _9"></span>there<span class="_ _45"> </span>is<span class="_ _45"> </span>less <span class="_ _23"></span>chance <span class="_ _9"></span>that</div><div class="t m0 x32 h26 y162 ff19 fsf fc0 sc0 ls0 ws0">processes <span class="_ _9"></span>will <span class="_ _23"></span>block.<span class="_ _5a"> </span>If <span class="_ _23"></span>we <span class="_ _9"></span>count <span class="_ _23"> </span>the <span class="_ _23"></span>number <span class="_ _9"></span>of <span class="_ _23"> </span>times<span class="_ _35"> </span><span class="ff1a">fcntl<span class="_ _45"> </span></span>blocks, <span class="_ _23"></span>we <span class="_ _9"></span>will <span class="_ _23"></span>see <span class="_ _9"></span>that</div><div class="t m0 x32 h2a y1db ff19 fsf fc0 sc0 ls0 ws0">processes <span class="_ _23"></span>block <span class="_ _23"></span>mor<span class="ls16f1">ef<span class="_ _43"></span><span class="ls45">re<span class="ls0">quently <span class="_ _23"> </span>with <span class="_ _42"> </span>coarse-grained <span class="_ _23"> </span>locking.<span class="_ _51"> </span>For <span class="_ _23"> </span>example, <span class="_ _42"> </span>with <span class="_ _23"> </span>four</span></span></span></div><div class="t m0 x32 h2a y25a ff19 fsf fc0 sc0 ls0 ws0">processes, <span class="_ _23"> </span>coarse-grained <span class="_ _42"> </span>locking <span class="_ _42"> </span>blocks <span class="_ _42"> </span>almost <span class="_ _42"> </span>ﬁve <span class="_ _42"> </span>times <span class="_ _42"> </span>mor<span class="ls16f2">ef<span class="_ _c"></span><span class="ls45">re<span class="_ _2"></span><span class="ls0">quently <span class="_ _42"> </span>than <span class="_ _42"> </span>with</span></span></span></div><div class="t m0 x32 h2a y164 ff19 fsf fc0 sc0 ls0 ws0">ﬁne-grained <span class="_ _42"> </span>locking.<span class="_ _54"> </span>The <span class="_ _42"> </span>extra <span class="_ _42"> </span>work <span class="_ _42"> </span>that <span class="_ _42"> </span>processes <span class="_ _23"> </span>need <span class="_ _53"> </span>to <span class="_ _42"> </span>do <span class="_ _42"> </span>to <span class="_ _42"> </span>put <span class="_ _42"> </span>themselves <span class="_ _42"> </span>to</div><div class="t m0 x32 h2a y25b ff19 fsf fc0 sc0 ls0 ws0">sleep <span class="_ _23"></span>and <span class="_ _9"></span>wake <span class="_ _23"> </span>up <span class="_ _23"> </span>mor<span class="ls16f3">eo<span class="_ _43"></span><span class="ls0">ften <span class="_ _23"> </span>with <span class="_ _23"> </span>coarse-grained <span class="_ _23"></span>locking <span class="_ _23"></span>increases <span class="_ _9"></span>the <span class="_ _23"></span>system <span class="_ _23"></span>time,</span></span></div><div class="t m0 x32 h2a y165 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ducing the difference in system times between the two locking appr<span class="_ _0"></span>oaches.</span></div><div class="t m0 x3f h2a y167 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _23"></span>ﬁnal <span class="_ _9"></span>column <span class="_ _23"> </span>in <span class="_ _23"> </span>Figur<span class="ls16f3">e2<span class="_ _43"></span><span class="ls0">0.8, <span class="_ _23"> </span>labeled <span class="_ _23"> </span>‘<span class="_ _0"></span>‘<span class="ff20">Δ<span class="_ _35"> </span></span>Sys,’<span class="_ _1"></span>’<span class="_ _35"> </span>is<span class="_ _45"> </span>the <span class="_ _23"> </span>percentage <span class="_ _23"></span>incr<span class="_ _0"></span>ease <span class="_ _23"></span>in <span class="_ _9"></span>the</span></span></div><div class="t m0 x32 h2a y168 ff19 fsf fc0 sc0 ls0 ws0">system <span class="_ _44"> </span>CPU <span class="_ _44"> </span>time <span class="_ _35"> </span>from <span class="_ _44"> </span>advisory <span class="_ _44"> </span>ﬁne-grained <span class="_ _35"> </span>locking <span class="_ _44"> </span>to <span class="_ _44"> </span>mandatory <span class="_ _44"> </span>ﬁne-grained</div><div class="t m0 x32 h2a y169 ff19 fsf fc0 sc0 ls0 ws0">locking. <span class="_ _35"> </span>These<span class="_ _35"> </span>percentages <span class="_ _23"> </span>show <span class="_ _23"> </span>that <span class="_ _42"> </span>mandatory <span class="_ _23"> </span>locking <span class="_ _42"> </span>adds <span class="_ _23"> </span>signiﬁcantly <span class="_ _42"> </span>(between</div><div class="t m0 x32 h2a y16a ff19 fsf fc0 sc0 ls0 ws0">20% and 76%) to the system time as concurrency incr<span class="_ _0"></span>eases.</div><div class="t m0 x3f h2a y16b ff19 fsf fc0 sc0 ls0 ws0">Since <span class="_ _3"></span>the <span class="_ _9"></span>user <span class="_ _9"></span>code <span class="_ _9"></span>for <span class="_ _9"></span>all <span class="_ _3"></span>these <span class="_ _9"></span>tests <span class="_ _9"></span>is <span class="_ _9"></span>almost <span class="_ _9"></span>identical <span class="_ _3"></span>(ther<span class="ls16f4">ea<span class="_ _b"></span><span class="ls45">re <span class="_ _23"></span>s<span class="ls0">ome <span class="_ _9"></span>additional</span></span></span></div><div class="t m0 x32 h26 y16c ff1a fsf fc0 sc0 ls0 ws0">fcntl<span class="_ _44"> </span><span class="ff19">calls <span class="_ _53"> </span>for <span class="_ _53"> </span>both <span class="_ _53"> </span>advisory <span class="_ _53"> </span>ﬁne-grained <span class="_ _53"> </span>and <span class="_ _53"> </span>mandatory <span class="_ _53"> </span>ﬁne-grained <span class="_ _53"> </span>locking), <span class="_ _53"> </span>we</span></div><div class="t m0 x32 h2a y16d ff19 fsf fc0 sc0 ls0 ws0">expect the user CPU times to be the same across any r<span class="_ _0"></span>ow<span class="_ _6"></span>.</div><div class="t m0 x76 h51 y58b4 ff19 fs2a fc0 sc0 ls0 ws0">The <span class="_ _2"></span>ﬁrst <span class="_ _3"></span>time <span class="_ _3"></span>we <span class="_ _3"></span>ran <span class="_ _2"></span>these <span class="_ _3"></span>tests, <span class="_ _3"></span>we <span class="_ _3"></span>measured <span class="_ _2"></span>the <span class="_ _3"></span>user <span class="_ _3"></span>times <span class="_ _3"></span>for <span class="_ _2"></span>coarse-grained <span class="_ _3"></span>locking <span class="_ _3"></span>to <span class="_ _3"></span>be</div><div class="t m0 x76 h51 y58b5 ff19 fs2a fc0 sc0 ls0 ws0">almost <span class="_ _3"></span>twice <span class="_ _3"></span>as <span class="_ _9"></span>long <span class="_ _3"></span>as <span class="_ _3"></span>the <span class="_ _9"></span>times <span class="_ _3"></span>for <span class="_ _3"></span>ﬁne-grained <span class="_ _9"></span>locking <span class="_ _3"></span>when <span class="_ _3"></span>multiple <span class="_ _9"></span>processes <span class="_ _3"></span>competed</div><div class="t m0 x76 h51 y58b6 ff19 fs2a fc0 sc0 ls0 ws0">for <span class="_ _2"></span>the <span class="_ _2"></span>locks.<span class="_ _4b"> </span>Because <span class="_ _2"></span>the <span class="_ _2"></span>two <span class="_ _2"></span>versions <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>database <span class="_ _3"></span>ar<span class="ls16f5">et<span class="_ _d"></span><span class="ls0">he <span class="_ _2"></span>same, <span class="_ _3"></span>except <span class="_ _2"></span>for <span class="_ _2"></span>the <span class="_ _2"></span>number <span class="_ _2"></span>of</span></span></div><div class="t m0 x76 h52 y58b7 ff19 fs2a fc0 sc0 ls0 ws0">calls <span class="_ _2"></span>to<span class="_ _80"> </span><span class="ff1a">fcntl</span><span class="ls16f6">,t<span class="_ _5"></span><span class="ls0">his <span class="_ _2"></span>made <span class="_ _2"></span>no <span class="_ _3"></span>sense.<span class="_ _44"> </span>After <span class="_ _3"></span>investigating, <span class="_ _2"></span>we <span class="_ _3"></span>discovered that <span class="_ _3"></span>because <span class="_ _2"></span>ther<span class="ls16f7">ew<span class="_ _d"></span><span class="ls0">as</span></span></span></span></div><div class="t m0 x76 h51 y58b8 ff19 fs2a fc0 sc0 ls0 ws0">mor<span class="ls16f8">ec<span class="_ _5"></span><span class="ls0">ontention with coarse-grained locking, processes wer<span class="lsd24">ew<span class="_ _5"></span><span class="ls0">aiting <span class="_ _2"></span>longer<span class="_ _1"></span><span class="lsd24">,a<span class="_ _84"></span><span class="ls0">nd the operating</span></span></span></span></span></span></div><div class="t m0 x76 h51 y58b9 ff19 fs2a fc0 sc0 ls0 ws0">system <span class="_ _3"></span>decided <span class="_ _3"></span>to <span class="_ _3"></span>reduce <span class="_ _2"></span>the <span class="_ _3"></span>CPU <span class="_ _9"></span>clock <span class="_ _2"></span>frequency <span class="_ _3"></span>to <span class="_ _3"></span>save <span class="_ _3"></span>power<span class="_ _1"></span><span class="ls16f9">.W<span class="_ _4a"></span><span class="ls0">ith <span class="_ _3"></span>ﬁne-grained <span class="_ _3"></span>locking,</span></span></div><div class="t m0 x76 h51 y58ba ff19 fs2a fc0 sc0 ls0 ws0">ther<span class="ls16fa">ew<span class="_ _b"></span><span class="ls0">as <span class="_ _23"> </span>mor<span class="ls16fb">ea<span class="_ _b"></span><span class="ls0">ctivity<span class="_ _1"></span>,<span class="_ _47"> </span>so<span class="_ _47"> </span>the <span class="_ _23"> </span>system <span class="_ _23"> </span>increased <span class="_ _9"></span>the <span class="_ _23"> </span>CPU <span class="_ _9"> </span>clock <span class="_ _23"> </span>frequency<span class="_ _6"></span><span class="ls16fc">.T<span class="_ _5b"></span><span class="ls0">his <span class="_ _23"> </span>(artiﬁcially)</span></span></span></span></span></span></div><div class="t m0 x76 h51 y58bb ff19 fs2a fc0 sc0 ls0 ws0">made <span class="_"> </span>the <span class="_"> </span>coarse-grained <span class="_"> </span>locking <span class="_"> </span>tests <span class="_"> </span>run <span class="_"> </span>mor<span class="_ _0"></span><span class="ls16fd">es<span class="_ _43"></span><span class="ls0">lowly <span class="_"> </span>than <span class="_"> </span>the <span class="_"> </span>ﬁne-grained <span class="_"> </span>tests.<span class="_ _5a"> </span>After</span></span></div><div class="t m0 x76 h51 y58bc ff19 fs2a fc0 sc0 ls0 ws0">disabling <span class="_ _2"></span>the <span class="_ _3"></span>frequency <span class="_ _2"></span>scaling <span class="_ _3"></span>feature, <span class="_ _2"></span>we <span class="_ _3"></span>measured <span class="_ _2"></span>the <span class="_ _3"></span>performance <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>test <span class="_ _2"></span>without <span class="_ _3"></span>this</div><div class="t m0 x76 h51 y58bd ff19 fs2a fc0 sc0 ls0 ws0">bias, and the differ<span class="_ _0"></span>ence in user times was much smaller<span class="_ _1"></span>.</div><div class="t m0 x3f h2b ya41 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _3"></span>values <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _9"></span>row <span class="_ _2"></span>of <span class="_ _9"></span>Figur<span class="ls1035">e2<span class="_ _b"></span><span class="ls0">0.8 <span class="_ _3"></span>ar<span class="ls1035">es<span class="_ _8"></span><span class="ls0">imilar <span class="_ _3"></span>to <span class="_ _3"></span>those <span class="_ _9"></span>for <span class="_ _3"></span>an<span class="_ _45"> </span><span class="ff1b">nr<span class="_ _0"></span>ec<span class="_ _47"> </span><span class="ff19">of <span class="_ _9"></span>2,000 <span class="_ _3"></span>in</span></span></span></span></span></span></div><div class="t m0 x32 h2a ya42 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls44">e2<span class="_ _4f"></span><span class="ls0">0.7. <span class="_"> </span>This<span class="_"> </span>corresponds to our expectation.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
