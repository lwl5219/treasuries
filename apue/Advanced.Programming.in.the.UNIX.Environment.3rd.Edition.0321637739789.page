<div id="pf315" class="pf w4 h1f" data-page-no="315"><div class="pc pc315 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg315.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">755</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _42"> </span>next <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>is<span class="_ _44"> </span><span class="ff1a">db.c</span><span class="ls164f">,t<span class="_ _43"></span><span class="ls0">he <span class="_ _42"> </span>C <span class="_ _42"> </span>source <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>for <span class="_ _42"> </span>the <span class="_ _42"> </span>library<span class="_ _6"></span><span class="ls1650">.F<span class="_ _52"></span><span class="ls0">or <span class="_ _42"> </span>simplicity<span class="_ _6"></span>,<span class="_ _44"> </span>we<span class="_ _44"> </span>include <span class="_ _42"> </span>all</span></span></span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">functions <span class="_ _3"></span>in <span class="_ _3"></span>a <span class="_ _3"></span>single <span class="_ _3"></span>ﬁle.<span class="_ _5a"> </span>This <span class="_ _3"></span>has <span class="_ _3"></span>the <span class="_ _3"></span>advantage <span class="_ _3"></span>that <span class="_ _9"></span>we <span class="_ _3"></span>can <span class="_ _3"></span>hide <span class="_ _3"></span>private <span class="_ _3"></span>functions <span class="_ _9"></span>by</div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 ls0 ws0">declaring them as<span class="_"> </span><span class="ff1a">static</span>.</div><div class="t m0 x140 h4e y1b56 ff1a fs28 fc0 sc0 ls1651 ws0">1#<span class="_ _244"></span><span class="ls0">include &quot;apue.h&quot;</span></div><div class="t m0 x140 h4e y56a1 ff1a fs28 fc0 sc0 ls1651 ws0">2#<span class="_ _244"></span><span class="ls0">include &quot;apue_db.h&quot;</span></div><div class="t m0 x140 h4e y1b57 ff1a fs28 fc0 sc0 ls1651 ws0">3#<span class="_ _244"></span><span class="ls0">include &lt;fcntl.h&gt;<span class="_ _12e"> </span>/* open &amp; db_open flags */</span></div><div class="t m0 x140 h4e y1b58 ff1a fs28 fc0 sc0 ls1651 ws0">4#<span class="_ _244"></span><span class="ls0">include &lt;stdarg.h&gt;</span></div><div class="t m0 x140 h4e y56a2 ff1a fs28 fc0 sc0 ls1651 ws0">5#<span class="_ _244"></span><span class="ls0">include &lt;errno.h&gt;</span></div><div class="t m0 x140 h4e y1b59 ff1a fs28 fc0 sc0 ls1651 ws0">6#<span class="_ _244"></span><span class="ls0">include &lt;sys/uio.h&gt;<span class="_ _68"> </span>/* struct iovec */</span></div><div class="t m0 x140 h4e y56a3 ff1a fs28 fc0 sc0 ls1651 ws0">7/<span class="_ _244"></span><span class="ls0">*</span></div><div class="t m0 x140 h4e y56a4 ff1a fs28 fc0 sc0 lsf75 ws0">8*<span class="_ _244"></span><span class="ls0">Internal index file constants.</span></div><div class="t m0 x140 h4e y56a5 ff1a fs28 fc0 sc0 lsf75 ws0">9*<span class="_ _244"></span><span class="ls0">These are used to construct records in the</span></div><div class="t m0 x32 h4e y56a6 ff1a fs28 fc0 sc0 ls0 ws0">10 <span class="_ _68"> </span>*<span class="_"> </span>index file and data file.</div><div class="t m0 x32 h4e y56a7 ff1a fs28 fc0 sc0 ls0 ws0">11 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h4e y56a8 ff1a fs28 fc0 sc0 ls0 ws0">12 <span class="_ _d9"> </span>#define<span class="_"> </span>IDXLEN_SZ <span class="_ _15"> </span>4<span class="_ _15"> </span>/* index record length (ASCII chars) */</div><div class="t m0 x32 h4e y56a9 ff1a fs28 fc0 sc0 ls0 ws0">13 <span class="_ _d9"> </span>#define<span class="_"> </span>SEP <span class="_ _186"> </span>’:’<span class="_ _15"> </span>/* separator char in index record */</div><div class="t m0 x32 h4e y56aa ff1a fs28 fc0 sc0 ls0 ws0">14 <span class="_ _d9"> </span>#define<span class="_"> </span>SPACE <span class="_ _88"> </span>’<span class="_"> </span><span class="lsf75">’/<span class="_ _19"></span><span class="ls1b6">*s<span class="_ _1d"></span><span class="ls0">pace character */</span></span></span></div><div class="t m0 x32 h4e y56ab ff1a fs28 fc0 sc0 ls0 ws0">15 <span class="_ _d9"> </span>#define<span class="_"> </span>NEWLINE <span class="_ _15"> </span>’\n’<span class="_ _87"> </span>/* newline character */</div><div class="t m0 x32 h4e y56ac ff1a fs28 fc0 sc0 ls0 ws0">16 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h4e y56ad ff1a fs28 fc0 sc0 ls0 ws0">17 <span class="_ _68"> </span>*<span class="_"> </span>The following definitions are for hash chains and free</div><div class="t m0 x32 h4e y56ae ff1a fs28 fc0 sc0 ls0 ws0">18 <span class="_ _68"> </span>*<span class="_"> </span>list chain in the index file.</div><div class="t m0 x32 h4e y56af ff1a fs28 fc0 sc0 ls0 ws0">19 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h4e y56b0 ff1a fs28 fc0 sc0 ls0 ws0">20 <span class="_ _d9"> </span>#define<span class="_"> </span>PTR_SZ <span class="_ _90"> </span>7<span class="_ _15"> </span>/* size of ptr field in hash chain */</div><div class="t m0 x32 h4e y56b1 ff1a fs28 fc0 sc0 ls0 ws0">21 <span class="_ _d9"> </span>#define<span class="_"> </span>PTR_MAX 9999999<span class="_ _15"> </span>/* max file offset = 10**PTR_SZ - 1 */</div><div class="t m0 x32 h4e y56b2 ff1a fs28 fc0 sc0 ls0 ws0">22 <span class="_ _d9"> </span>#define<span class="_"> </span>NHASH_DEF <span class="_ _3a"> </span>137<span class="_ _15"> </span>/* default hash table size */</div><div class="t m0 x32 h4e y56b3 ff1a fs28 fc0 sc0 ls0 ws0">23 <span class="_ _d9"> </span>#define<span class="_"> </span>FREE_OFF <span class="_ _8a"> </span>0<span class="_ _15"> </span>/* free list offset in index file */</div><div class="t m0 x32 h4e y56b4 ff1a fs28 fc0 sc0 ls0 ws0">24 <span class="_ _d9"> </span>#define<span class="_"> </span>HASH_OFF PTR_SZ<span class="_ _15"> </span>/* hash table offset in index file */</div><div class="t m0 x32 h4e y56b5 ff1a fs28 fc0 sc0 ls0 ws0">25 <span class="_ _d9"> </span>typedef<span class="_"> </span>unsigned long<span class="_ _3a"> </span>DBHASH; /* hash values */</div><div class="t m0 x32 h4e y56b6 ff1a fs28 fc0 sc0 ls0 ws0">26 <span class="_ _d9"> </span>typedef<span class="_"> </span>unsigned long<span class="_ _3a"> </span>COUNT; <span class="_"> </span>/*<span class="_"> </span>unsigned counter */</div><div class="t m0 x32 h54 y56b7 ff19 fs2c fc0 sc0 ls0 ws0">[1 <span class="_ _a"></span>– <span class="_ _a"></span>6]<span class="_ _75"> </span><span class="ls155">We <span class="_ _45"> </span>i<span class="_ _9"></span></span>nclude<span class="_ _44"> </span><span class="ff1a">apue.h<span class="_ _35"> </span></span>because <span class="_ _42"> </span>we <span class="_ _42"> </span>use <span class="_ _42"> </span>some <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>functions <span class="_ _42"> </span>from <span class="_ _42"> </span>our <span class="_ _42"> </span>private</div><div class="t m0 x2d h54 y56b8 ff19 fs2c fc0 sc0 ls0 ws0">library<span class="_ _4"></span><span class="ls1652">.I<span class="_ _49"></span><span class="ls1653">nt<span class="_ _1d"></span><span class="ls0">urn,<span class="_ _16"> </span><span class="ff1a">apue.h<span class="_ _61"> </span></span>includes <span class="_ _47"> </span>several <span class="_ _66"> </span>standar<span class="ls1654">dh<span class="_ _1d"></span><span class="ls0">eader <span class="_ _47"> </span>ﬁles, <span class="_ _47"> </span>including</span></span></span></span></span></div><div class="t m0 x2d h54 y56b9 ff1a fs2c fc0 sc0 ls0 ws0">&lt;stdio.h&gt;<span class="_ _1a3"> </span><span class="ff19">and<span class="_ _1a3"> </span></span>&lt;unistd.h&gt;<span class="ff19 ls1655">.W<span class="_ _de"></span><span class="ls1656">ei<span class="_ _56"></span><span class="ls0">nclude<span class="_ _1a3"> </span><span class="ff1a">&lt;stdarg.h&gt;<span class="_ _1a3"> </span></span>because <span class="_ _5a"> </span>the</span></span></span></div><div class="t m0 x2d h54 y56ba ff1a fs2c fc0 sc0 ls0 ws0">db_open<span class="_ _93"> </span><span class="ff19">function <span class="_ _54"> </span>uses <span class="_ _65"> </span>the <span class="_ _65"> </span>variable-argument <span class="_ _54"> </span>functions <span class="_ _65"> </span>declared <span class="_ _54"> </span>by</span></div><div class="t m0 x2d h54 y56bb ff1a fs2c fc0 sc0 ls0 ws0">&lt;stdarg.h&gt;<span class="ff19">.</span></div><div class="t m0 x32 h54 y56bc ff19 fs2c fc0 sc0 ls0 ws0">[7 <span class="_ _a"></span>– <span class="_ _a"></span>26]<span class="_ _288"> </span>The <span class="_ _35"> </span>size <span class="_ _35"> </span>of <span class="_ _35"> </span>an <span class="_ _35"> </span>index <span class="_ _35"> </span>r<span class="_ _0"></span>ecord<span class="_ _5a"> </span>is<span class="_ _51"> </span>speciﬁed <span class="_ _35"> </span>by<span class="_ _51"> </span><span class="ff1a">IDXLEN_SZ</span><span class="ls1657">.W<span class="_ _da"></span><span class="ls1658">eu<span class="_ _7"></span><span class="ls0">se <span class="_ _35"> </span>some</span></span></span></div><div class="t m0 x2d h55 y56bd ff19 fs2c fc0 sc0 ls0 ws0">characters, <span class="_ _23"></span>such <span class="_ _23"></span>as <span class="_ _23"></span>colon <span class="_ _23"></span>and <span class="_ _23"></span>newline, <span class="_ _23"> </span>as <span class="_ _23"> </span>delimiters <span class="_ _23"> </span>in <span class="_ _23"> </span>the <span class="_ _23"> </span>database.<span class="_ _51"> </span><span class="ls155">We <span class="_ _47"> </span>u<span class="_ _9"></span></span>se</div><div class="t m0 x2d h55 y56be ff19 fs2c fc0 sc0 ls0 ws0">the space character as ‘<span class="_ _0"></span>‘white out’<span class="_ _1"></span><span class="ls142">’w<span class="_ _5"></span><span class="ls0">hen we delete a recor<span class="_ _1"></span>d.</span></span></div><div class="t m0 x2d h55 y56bf ff19 fs2c fc0 sc0 ls0 ws0">Some <span class="_ _e"> </span>of <span class="_"> </span>the <span class="_ _53"> </span>values <span class="_"> </span>that <span class="_ _53"> </span>we <span class="_"> </span>have <span class="_ _53"> </span>deﬁned <span class="_"> </span>as <span class="_ _53"> </span>constants <span class="_"> </span>could <span class="_ _53"> </span>also <span class="_"> </span>be <span class="_ _53"> </span>made</div><div class="t m0 x2d h55 y56c0 ff19 fs2c fc0 sc0 ls0 ws0">variable, <span class="_ _42"> </span>with <span class="_ _53"> </span>some <span class="_ _42"> </span>added <span class="_ _53"> </span>complexity <span class="_ _42"> </span>in <span class="_ _53"> </span>the <span class="_ _42"> </span>implementation.<span class="_ _54"> </span>For <span class="_ _53"> </span>example,</div><div class="t m0 x2d h55 y56c1 ff19 fs2c fc0 sc0 ls0 ws0">we <span class="_ _2"></span>set <span class="_ _2"></span>the <span class="_ _3"></span>size <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _3"></span>hash <span class="_ _2"></span>table <span class="_ _2"></span>to <span class="_ _2"></span>137 <span class="_ _3"></span>entries.<span class="_ _61"> </span><span class="ls1659">Ab<span class="_ _4f"></span><span class="ls0">etter <span class="_ _2"></span>technique <span class="_ _3"></span>would <span class="_ _2"></span>be <span class="_ _2"></span>to</span></span></div><div class="t m0 x2d h54 y56c2 ff19 fs2c fc0 sc0 ls0 ws0">let <span class="_ _23"></span>the <span class="_ _9"></span>caller <span class="_ _23"> </span>specify <span class="_ _23"> </span>this <span class="_ _23"></span>as <span class="_ _23"></span>an <span class="_ _9"></span>argument <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">db_open</span><span class="ls165a">,b<span class="_ _b"></span><span class="ls0">ased <span class="_ _23"></span>on <span class="_ _9"></span>the <span class="_ _23"> </span>expected</span></span></div><div class="t m0 x2d h55 y381e ff19 fs2c fc0 sc0 ls0 ws0">size <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>database.<span class="_ _16"> </span><span class="ls155">We <span class="_ _80"> </span>w<span class="_ _9"></span></span>ould <span class="_ _2"></span>then <span class="_ _3"></span>have <span class="_ _2"></span>to <span class="_ _3"></span>stor<span class="lsf1e">et<span class="_ _8"></span><span class="ls0">his <span class="_ _3"></span>size <span class="_ _2"></span>at <span class="_ _3"></span>the <span class="_ _3"></span>beginning <span class="_ _2"></span>of</span></span></div><div class="t m0 x2d h55 y56c3 ff19 fs2c fc0 sc0 ls0 ws0">the index ﬁle.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
