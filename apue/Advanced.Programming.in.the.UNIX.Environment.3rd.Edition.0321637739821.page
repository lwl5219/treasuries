<div id="pf335" class="pf w4 h1f" data-page-no="335"><div class="pc pc335 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg335.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Chapter <span class="_"> </span>20<span class="_ _183"> </span>Exercises<span class="_ _1fb"> </span><span class="ff18">787</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">29% <span class="_ _2"></span>and <span class="_ _3"></span>59% <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _2"></span>clock <span class="_ _3"></span>time <span class="_ _3"></span>over <span class="_ _3"></span>no <span class="_ _3"></span>locking <span class="_ _2"></span>and <span class="_ _3"></span>that <span class="_ _3"></span>mandatory <span class="_ _3"></span>locking <span class="_ _2"></span>adds <span class="_ _3"></span>about</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">another 15% over advisory locking.</div><div class="t m0 x32 h53 y5925 ff16 fs2b fc0 sc0 ls0 ws0">Exer<span class="_ _0"></span>cises</div><div class="t m0 x32 h57 y5926 ff18 fs2d fc0 sc0 ls0 ws0">20.1<span class="_ _288"> </span><span class="ff19">The <span class="_ _23"> </span>locking <span class="_ _23"> </span>in<span class="_ _45"> </span><span class="ff1a">_db_dodelete<span class="_ _45"> </span></span>is <span class="_ _9"></span>somewhat <span class="_ _23"> </span>conservative.<span class="_ _16"> </span>For <span class="_ _23"> </span>example, <span class="_ _23"> </span>we <span class="_ _23"></span>could <span class="_ _9"></span>allow</span></div><div class="t m0 xe1 h5f y5927 ff19 fs2d fc0 sc0 ls0 ws0">mor<span class="ls1707">ec<span class="_ _8"></span><span class="ls0">oncurrency <span class="_ _3"></span>by <span class="_ _3"></span>not <span class="_ _2"></span>write <span class="_ _3"></span>locking <span class="_ _3"></span>the <span class="_ _3"></span>free <span class="_ _2"></span>list <span class="_ _3"></span>until <span class="_ _3"></span>we <span class="_ _3"></span>really <span class="_ _3"></span>need <span class="_ _2"></span>to; <span class="_ _3"></span>that <span class="_ _3"></span>is, <span class="_ _3"></span>the <span class="_ _3"></span>call</span></span></div><div class="t m0 xe1 h57 y5928 ff19 fs2d fc0 sc0 ls0 ws0">to<span class="_ _1a3"> </span><span class="ff1a">writew_lock<span class="_ _1a3"> </span></span>could <span class="_ _51"> </span>be <span class="_ _51"> </span>moved <span class="_ _5a"> </span>between <span class="_ _51"> </span>the <span class="_ _51"> </span>calls <span class="_ _51"> </span>to<span class="_ _1a3"> </span><span class="ff1a">_db_writedat<span class="_ _1a3"> </span></span>and</div><div class="t m0 xe1 h57 y5929 ff1a fs2d fc0 sc0 ls0 ws0">_db_readptr<span class="ff19 ls614">.W<span class="_ _55"></span><span class="ls0">hat happens if we do this?</span></span></div><div class="t m0 x32 h57 y592a ff18 fs2d fc0 sc0 ls0 ws0">20.2<span class="_ _288"> </span><span class="ff19">If<span class="_ _47"> </span><span class="ff1a">db_nextrec<span class="_ _66"> </span></span>did <span class="_ _3"></span>not <span class="_ _3"></span>read <span class="_ _2"></span>lock <span class="_ _3"></span>the <span class="_ _3"></span>free <span class="_ _2"></span>list <span class="_ _3"></span>and <span class="_ _3"></span>a <span class="_ _3"></span>recor<span class="ls1708">dt<span class="_ _8"></span><span class="ls0">hat <span class="_ _3"></span>it <span class="_ _3"></span>was <span class="_ _3"></span>reading <span class="_ _2"></span>was <span class="_ _3"></span>also <span class="_ _3"></span>in</span></span></span></div><div class="t m0 xe1 h57 y592b ff19 fs2d fc0 sc0 ls0 ws0">the <span class="_ _3"></span>process <span class="_ _9"></span>of <span class="_ _3"></span>being <span class="_ _9"></span>deleted, <span class="_ _9"></span>describe <span class="_ _9"></span>how<span class="_ _47"> </span><span class="ff1a">db_nextrec<span class="_ _47"> </span></span>could <span class="_ _9"></span>return <span class="_ _3"></span>the <span class="_ _9"></span>correct <span class="_ _3"></span>key <span class="_ _9"></span>but</div><div class="t m0 xe1 h57 y592c ff19 fs2d fc0 sc0 ls0 ws0">an all-blank (hence incorrect) data r<span class="_ _0"></span>ecord. <span class="_"> </span>(Hint:<span class="_"> </span>Look at<span class="_"> </span><span class="ff1a">_db_dodelete</span>.)</div><div class="t m0 x32 h57 y592d ff18 fs2d fc0 sc0 ls0 ws0">20.3<span class="_ _288"> </span><span class="ff19">At <span class="_ _42"> </span>the <span class="_ _23"> </span>end <span class="_ _23"> </span>of <span class="_ _23"> </span>Section <span class="_ _23"> </span>20.8, <span class="_ _23"> </span>we <span class="_ _23"> </span>described <span class="_ _42"> </span>the <span class="_ _23"> </span>locking <span class="_ _23"> </span>performed <span class="_ _23"> </span>by<span class="_ _45"> </span><span class="ff1a">_db_writeidx<span class="_ _35"> </span></span>and</span></div><div class="t m0 xe1 h57 y592e ff1a fs2d fc0 sc0 ls0 ws0">_db_writedat<span class="ff19 ls1709">.W<span class="_ _26"></span><span class="ls170a">es<span class="_ _4f"></span><span class="ls0">aid <span class="_ _3"></span>that <span class="_ _9"></span>this <span class="_ _3"></span>locking <span class="_ _3"></span>didn’t <span class="_ _9"></span>interfer<span class="ls170a">ew<span class="_ _8"></span><span class="ls0">ith <span class="_ _3"></span>other <span class="_ _9"></span>readers <span class="_ _2"></span>and <span class="_ _9"></span>writers</span></span></span></span></span></div><div class="t m0 xe1 h57 y592f ff19 fs2d fc0 sc0 ls0 ws0">except those making calls to<span class="_"> </span><span class="ff1a">db_store</span><span class="ls614">.I<span class="_ _55"></span><span class="ls110">st<span class="_ _5"></span><span class="ls0">his true if mandatory locking is being used?</span></span></span></div><div class="t m0 x32 h57 y5930 ff18 fs2d fc0 sc0 ls0 ws0">20.4<span class="_ _288"> </span><span class="ff19">How would you integrate the<span class="_"> </span><span class="ff1a">fsync<span class="_ _80"> </span></span>function into this database library?</span></div><div class="t m0 x32 h57 y5931 ff18 fs2d fc0 sc0 ls0 ws0">20.5<span class="_ _288"> </span><span class="ff19">In<span class="_ _80"> </span><span class="ff1a">db_store</span>,<span class="_ _66"> </span>we<span class="_"> </span>write <span class="_ _2"></span>the data <span class="_ _2"></span>recor<span class="_ _0"></span><span class="ls170b">db<span class="_ _d"></span><span class="ls0">efor<span class="ls170b">et<span class="_ _5"></span><span class="ls0">he index record. <span class="_"> </span>What<span class="_"> </span>happens <span class="_ _2"></span>if you <span class="_ _2"></span>do it</span></span></span></span></span></div><div class="t m0 xe1 h5f y5932 ff19 fs2d fc0 sc0 ls0 ws0">in the opposite order?</div><div class="t m0 x32 h5f y5933 ff18 fs2d fc0 sc0 ls0 ws0">20.6<span class="_ _288"> </span><span class="ff19">Create <span class="_ _66"> </span>a <span class="_ _66"> </span>new <span class="_ _80"> </span>database <span class="_ _66"> </span>and <span class="_ _66"> </span>write <span class="_ _66"> </span>some <span class="_ _66"> </span>number <span class="_ _66"> </span>of <span class="_ _66"> </span>recor<span class="_ _0"></span>ds <span class="_ _80"> </span>to <span class="_ _66"> </span>the <span class="_ _66"> </span>database.<span class="_ _48"> </span><span class="ls467">Wr<span class="_ _3"></span></span>ite <span class="_ _66"> </span>a</span></div><div class="t m0 xe1 h57 y5934 ff19 fs2d fc0 sc0 ls0 ws0">program that calls<span class="_ _80"> </span><span class="ff1a">db_nextrec<span class="_ _66"> </span></span>to read each <span class="_ _2"></span>recor<span class="_ _0"></span>d<span class="_"> </span>in<span class="_ _80"> </span>the <span class="_ _2"></span>database, <span class="_ _2"></span>and call<span class="_ _66"> </span><span class="ff1a">_db_hash<span class="_ _80"> </span></span>to</div><div class="t m0 xe1 h5f y5935 ff19 fs2d fc0 sc0 ls0 ws0">calculate <span class="_ _23"></span>the <span class="_ _9"></span>hash <span class="_ _23"> </span>value <span class="_ _23"> </span>for <span class="_ _23"> </span>each <span class="_ _23"> </span>recor<span class="_ _0"></span>d. <span class="_ _45"> </span>Print<span class="_ _45"> </span><span class="ls1425">ah<span class="_ _b"></span><span class="ls0">istogram <span class="_ _9"></span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>number <span class="_ _23"> </span>of <span class="_ _23"> </span>recor<span class="_ _1"></span>ds <span class="_ _23"> </span>on</span></span></div><div class="t m0 xe1 h57 y5936 ff19 fs2d fc0 sc0 ls0 ws0">each hash chain.<span class="_ _4b"> </span>Is the hashing function in<span class="_"> </span><span class="ff1a">_db_hash<span class="_ _e"> </span></span>adequate?</div><div class="t m0 x32 h5f y5937 ff18 fs2d fc0 sc0 ls0 ws0">20.7<span class="_ _288"> </span><span class="ff19">Modify <span class="_ _9"></span>the <span class="_ _9"></span>database <span class="_ _23"></span>functions <span class="_ _3"></span>so <span class="_ _9"></span>that <span class="_ _23"></span>the <span class="_ _3"></span>number <span class="_ _9"></span>of <span class="_ _23"></span>hash <span class="_ _3"></span>chains <span class="_ _23"></span>in <span class="_ _3"></span>the <span class="_ _9"></span>index <span class="_ _23"></span>ﬁle <span class="_ _3"></span>can <span class="_ _9"></span>be</span></div><div class="t m0 xe1 h5f y5938 ff19 fs2d fc0 sc0 ls0 ws0">speciﬁed when the database is created.</div><div class="t m0 x32 h5f y5939 ff18 fs2d fc0 sc0 ls0 ws0">20.8<span class="_ _288"> </span><span class="ff19">Compar<span class="ls170c">et<span class="_ _4f"></span><span class="ls0">he <span class="_ _3"></span>performance <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _3"></span>database <span class="_ _3"></span>functions <span class="_ _3"></span>when <span class="_ _3"></span>the <span class="_ _9"></span>database <span class="_ _3"></span>is <span class="_ _3"></span>(a) <span class="_ _3"></span>on <span class="_ _3"></span>the <span class="_ _9"></span>same</span></span></span></div><div class="t m0 xe1 h5f y593a ff19 fs2d fc0 sc0 ls0 ws0">host <span class="_ _23"> </span>as <span class="_ _42"> </span>the <span class="_ _23"> </span>test <span class="_ _42"> </span>program <span class="_ _23"> </span>and <span class="_ _23"> </span>(b) <span class="_ _42"> </span>on <span class="_ _23"> </span>a <span class="_ _42"> </span>differ<span class="_ _0"></span>ent <span class="_ _23"> </span>host <span class="_ _42"> </span>accessed <span class="_ _23"> </span>via <span class="_ _42"> </span>NFS.<span class="_ _5a"> </span>Does <span class="_ _23"> </span>the <span class="_ _42"> </span>recor<span class="_ _0"></span>d</div><div class="t m0 xe1 h5f y593b ff19 fs2d fc0 sc0 ls0 ws0">locking provided by the database library still work?</div><div class="t m0 x32 h5f y593c ff18 fs2d fc0 sc0 ls0 ws0">20.9<span class="_ _288"> </span><span class="ff19">The <span class="_ _42"> </span>database <span class="_ _42"> </span>reuses <span class="_ _42"> </span>free <span class="_ _23"> </span>list <span class="_ _42"> </span>records <span class="_ _23"> </span>only <span class="_ _42"> </span>if <span class="_ _42"> </span>the <span class="_ _42"> </span>sizes <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>key <span class="_ _42"> </span>buffer <span class="_ _23"> </span>and <span class="_ _42"> </span>data <span class="_ _42"> </span>buffer</span></div><div class="t m0 xe1 h5f y593d ff19 fs2d fc0 sc0 ls0 ws0">match the needed sizes exactly<span class="_ _6"></span><span class="ls170d">.M<span class="_ _55"></span><span class="ls0">odify the database <span class="_ _2"></span>to allow larger buffer sizes on the free</span></span></div><div class="t m0 xe1 h5f y593e ff19 fs2d fc0 sc0 ls0 ws0">list to satisfy the request. <span class="_"> </span>How<span class="_"> </span>do you have to change the persistent format of the database</div><div class="t m0 xe1 h5f y593f ff19 fs2d fc0 sc0 ls0 ws0">to support this feature?</div><div class="t m0 x32 h5f y5940 ff18 fs2d fc0 sc0 ls0 ws0">20.10<span class="_ _48"> </span><span class="ff19">After <span class="_ _2"></span>implementing <span class="_ _2"></span>a <span class="_ _2"></span>solution <span class="_ _2"></span>to <span class="_ _2"></span>Exercise 20.9, <span class="_ _2"></span>write <span class="_ _2"></span>a <span class="_ _2"></span>tool <span class="_ _2"></span>to <span class="_ _2"></span>convert <span class="_ _2"></span>one <span class="_ _2"></span>database <span class="_ _2"></span>format</span></div><div class="t m0 xe1 h5f y5941 ff19 fs2d fc0 sc0 ls0 ws0">to the other<span class="_ _1"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
