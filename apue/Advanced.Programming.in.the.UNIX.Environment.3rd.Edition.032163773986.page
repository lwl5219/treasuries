<div id="pf56" class="pf w4 h1f" data-page-no="56"><div class="pc pc56 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg56.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">52<span class="_ _1b"> </span><span class="ff19">UNIX <span class="_"> </span>Standardization <span class="_"> </span>and <span class="_"> </span>Implementations<span class="_ _99"> </span>Chapter <span class="_"> </span>2</span></div><div class="t m0 x3f h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">#include <span class="_"> </span>&lt;unistd.h&gt;</div><div class="t m0 x3f h57 y8f6 ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; sysconf(_SC_OPEN_MAX); i++)</div><div class="t m0 xc2 h57 y8f7 ff1a fs2d fc0 sc0 ls0 ws0">close(i);</div><div class="t m0 x32 h2a y8f8 ff19 fsf fc0 sc0 ls0 ws0">Our <span class="_ _47"> </span>best <span class="_ _45"> </span>option <span class="_ _47"> </span>in <span class="_ _45"> </span>this <span class="_ _47"> </span>case <span class="_ _45"> </span>is <span class="_ _47"> </span>just <span class="_ _47"> </span>to <span class="_ _45"> </span>close <span class="_ _47"> </span>all <span class="_ _45"> </span>descriptors <span class="_ _47"> </span>up <span class="_ _45"> </span>to <span class="_ _47"> </span>some <span class="_ _47"> </span>arbitrary</div><div class="t m0 x32 h2a y8f9 ff19 fsf fc0 sc0 ls0 ws0">limit <span class="_ _a"></span>— <span class="_ _a"></span>say<span class="_ _6"></span><span class="ls2e8">,2<span class="_ _26"></span><span class="ls0">56. <span class="_ _51"> </span>W<span class="_ _4"></span><span class="ls2e9">es<span class="_ _62"></span><span class="ls0">how <span class="_ _45"> </span>this <span class="_ _45"> </span>technique <span class="_ _35"> </span>in <span class="_ _45"> </span>Figur<span class="ls2e9">e2<span class="_ _7"></span><span class="ls0">.17. <span class="_ _51"> </span>As<span class="_ _5a"> </span>with <span class="_ _45"> </span>our <span class="_ _45"> </span>pathname</span></span></span></span></span></span></div><div class="t m0 x32 h2a y8fa ff19 fsf fc0 sc0 ls0 ws0">example, this <span class="_ _2"></span>strategy <span class="_ _2"></span>is not <span class="_ _2"></span>guaranteed <span class="_ _2"></span>to <span class="_ _2"></span>work for <span class="_ _2"></span>all <span class="_ _2"></span>cases, but <span class="_ _2"></span>it’s <span class="_ _2"></span>the <span class="_ _2"></span>best we <span class="_ _2"></span>can <span class="_ _2"></span>do</div><div class="t m0 x32 h2a y8fb ff19 fsf fc0 sc0 ls0 ws0">without using a mor<span class="ls44">ee<span class="_ _4f"></span><span class="ls0">xotic approach.</span></span></div><div class="t m0 x32 h4e y8fc ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y8fd ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h4e y8fe ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;limits.h&gt;</div><div class="t m0 x32 h4e y8ff ff1a fs28 fc0 sc0 ls0 ws0">#ifdef <span class="_"> </span>OPEN_MAX</div><div class="t m0 x32 h4e y900 ff1a fs28 fc0 sc0 ls0 ws0">static long openmax = OPEN_MAX;</div><div class="t m0 x32 h4e y901 ff1a fs28 fc0 sc0 ls0 ws0">#else</div><div class="t m0 x32 h4e y902 ff1a fs28 fc0 sc0 ls0 ws0">static long openmax = 0;</div><div class="t m0 x32 h4e y903 ff1a fs28 fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x32 h4e y904 ff1a fs28 fc0 sc0 ls0 ws0">/*</div><div class="t m0 x140 h4e y905 ff1a fs28 fc0 sc0 ls0 ws0">*<span class="_"> </span>If<span class="_"> </span>OPEN_MAX is indeterminate, this might be inadequate.</div><div class="t m0 x140 h4e y906 ff1a fs28 fc0 sc0 ls0 ws0">*/</div><div class="t m0 x32 h4e y907 ff1a fs28 fc0 sc0 ls0 ws0">#define OPEN_MAX_GUESS<span class="_ _d9"> </span>256</div><div class="t m0 x32 h4e y908 ff1a fs28 fc0 sc0 ls0 ws0">long</div><div class="t m0 x32 h4e y909 ff1a fs28 fc0 sc0 ls0 ws0">open_max(void)</div><div class="t m0 x32 h4e y90a ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y90b ff1a fs28 fc0 sc0 ls0 ws0">if (openmax == 0) {<span class="_ _8a"> </span>/* first time through */</div><div class="t m0 x9d h4e y90c ff1a fs28 fc0 sc0 ls0 ws0">errno = 0;</div><div class="t m0 x9d h4e y90d ff1a fs28 fc0 sc0 ls0 ws0">if ((openmax = sysconf(_SC_OPEN_MAX)) &lt; 0) {</div><div class="t m0 x1f h4e y90e ff1a fs28 fc0 sc0 ls0 ws0">if (errno == 0)</div><div class="t m0 x126 h4e y90f ff1a fs28 fc0 sc0 ls0 ws0">openmax = OPEN_MAX_GUESS;<span class="_ _68"> </span>/* it’s indeterminate */</div><div class="t m0 x1f h4e y910 ff1a fs28 fc0 sc0 ls0 ws0">else</div><div class="t m0 x126 h4e y911 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;sysconf error for _SC_OPEN_MAX&quot;);</div><div class="t m0 x9d h4e y912 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h4e y913 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h4e y914 ff1a fs28 fc0 sc0 ls0 ws0">return(openmax);</div><div class="t m0 x32 h4e y915 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x108 h2e y916 ff18 fs11 fc0 sc0 ls0 ws0">Figure 2.17<span class="_ _5a"> </span><span class="ff19">Determine the number of ﬁle descriptors</span></div><div class="t m0 x3f h54 y917 ff19 fs2c fc0 sc0 ls155 ws0">We <span class="_ _53"> </span>m<span class="_ _9"></span><span class="ls0">ight <span class="_ _2"></span>be tempted <span class="_ _2"></span>to call<span class="_"> </span><span class="ff1a">close<span class="_ _66"> </span></span>until we <span class="_ _2"></span>get an <span class="_ _2"></span>error return, but the error return</span></div><div class="t m0 x32 h54 y918 ff19 fs2c fc0 sc0 ls0 ws0">from<span class="_"> </span><span class="ff1a">close<span class="_ _80"> </span></span>(<span class="ff1a">EBADF</span><span class="ls2ea">)d<span class="_ _d"></span><span class="ls0">oesn’t distinguish between <span class="_ _2"></span>an invalid descriptor and a <span class="_ _2"></span>descriptor</span></span></div><div class="t m0 x32 h55 y919 ff19 fs2c fc0 sc0 ls0 ws0">that <span class="_ _47"> </span>wasn’t <span class="_ _45"> </span>open.<span class="_ _5f"> </span>If <span class="_ _47"> </span>we <span class="_ _45"> </span>tried <span class="_ _47"> </span>this <span class="_ _45"> </span>technique <span class="_ _47"> </span>and <span class="_ _45"> </span>descriptor <span class="_ _47"> </span>9 <span class="_ _45"> </span>was <span class="_ _47"> </span>not <span class="_ _45"> </span>open <span class="_ _47"> </span>but</div><div class="t m0 x32 h54 y91a ff19 fs2c fc0 sc0 ls0 ws0">descriptor <span class="_ _35"> </span>10 <span class="_ _45"> </span>was, <span class="_ _35"> </span>we <span class="_ _35"> </span>would <span class="_ _35"> </span>stop <span class="_ _35"> </span>on <span class="_ _45"> </span>9 <span class="_ _35"> </span>and <span class="_ _35"> </span>never <span class="_ _35"> </span>close <span class="_ _45"> </span>10.<span class="_ _98"> </span>The<span class="_ _51"> </span><span class="ff1a">dup<span class="_"> </span></span>function</div><div class="t m0 x32 h54 y91b ff19 fs2c fc0 sc0 ls0 ws0">(Section <span class="_ _3"></span>3.12) <span class="_ _3"></span>does <span class="_ _3"></span>return <span class="_ _2"></span>a <span class="_ _3"></span>speciﬁc <span class="_ _9"></span>error <span class="_ _2"></span>when<span class="_ _47"> </span><span class="ff1a">OPEN_MAX<span class="_ _47"> </span></span>is <span class="_ _3"></span>exceeded, <span class="_ _9"></span>but <span class="_ _3"></span>duplicating</div><div class="t m0 x32 h55 y91c ff19 fs2c fc0 sc0 ls142 ws0">ad<span class="_ _d"></span><span class="ls0">escriptor a couple of hundred times is an extreme way to determine this value.</span></div><div class="t m0 x3f h54 y91d ff19 fs2c fc0 sc0 ls0 ws0">Some <span class="_ _42"> </span>implementations <span class="_ _42"> </span>will <span class="_ _53"> </span>return<span class="_ _35"> </span><span class="ff1a">LONG_MAX<span class="_ _44"> </span></span>for <span class="_ _53"> </span>limit <span class="_ _42"> </span>values <span class="_ _53"> </span>that <span class="_ _42"> </span>ar<span class="ls2eb">ee<span class="_ _c"></span><span class="ls150">ff<span class="_ _2"></span><span class="ls0">ectively</span></span></span></div><div class="t m0 x32 h54 y91e ff19 fs2c fc0 sc0 ls0 ws0">unlimited. <span class="_"> </span>Such<span class="_"> </span>is the case <span class="_ _2"></span>with the Linux limit <span class="_ _2"></span>for<span class="_"> </span><span class="ff1a">ATEXIT_MAX</span></div><div class="t m0 x111 h55 y91f ff19 fs2c fc0 sc0 ls0 ws0">(</div><div class="t m0 x68 h55 y91e ff19 fs2c fc0 sc0 ls0 ws0">see Figur<span class="ls2ec">e2<span class="_ _4f"></span><span class="ls0">.15</span></span></div><div class="t m0 x141 h55 y91f ff19 fs2c fc0 sc0 ls0 ws0">)</div><div class="t m0 x142 h55 y91e ff19 fs2c fc0 sc0 ls2ed ws0">.T<span class="_ _5b"></span><span class="ls0">his</span></div><div class="t m0 x32 h55 y920 ff19 fs2c fc0 sc0 ls0 ws0">isn’t a good idea, because it can cause programs to behave badly<span class="_ _4"></span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
