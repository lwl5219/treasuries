<div id="pf31f" class="pf w4 h1f" data-page-no="31f"><div class="pc pc31f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg31f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">765</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">287 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">288 <span class="_ _68"> </span>*<span class="_"> </span>Read a chain ptr field from anywhere in the index file:</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">289 <span class="_ _68"> </span>*<span class="_"> </span>the free list pointer, a hash table chain ptr, or an</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">290 <span class="_ _68"> </span>*<span class="_"> </span>index record chain ptr.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">291 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">292 <span class="_ _d9"> </span>static<span class="_"> </span>off_t</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">293 <span class="_ _d9"> </span>_db_readptr(DB<span class="_"> </span>*db, off_t offset)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">294 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">295 <span class="_ _15"> </span>char<span class="_ _15"> </span>asciiptr[PTR_SZ + 1];</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">296 <span class="_ _15"> </span>if<span class="_"> </span>(lseek(db-&gt;idxfd, offset, SEEK_SET) == -1)</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">297 <span class="_ _186"> </span>err_dump(&quot;_db_readptr:<span class="_"> </span>lseek error to ptr field&quot;);</div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">298 <span class="_ _15"> </span>if<span class="_"> </span>(read(db-&gt;idxfd, asciiptr, PTR_SZ) != PTR_SZ)</div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">299 <span class="_ _186"> </span>err_dump(&quot;_db_readptr:<span class="_"> </span>read error of ptr field&quot;);</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">300 <span class="_ _15"> </span>asciiptr[PTR_SZ]<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls5d1">;/<span class="_ _1c2"></span><span class="ls15c">*n<span class="_ _1d"></span><span class="ls0">ull terminate */</span></span></span></span></div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">301 <span class="_ _15"> </span>return(atol(asciiptr));</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">302 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y33b1 ff1a fs2d fc0 sc0 ls0 ws0">303 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y33b2 ff1a fs2d fc0 sc0 ls0 ws0">304 <span class="_ _68"> </span>*<span class="_"> </span>Read the next index record.<span class="_ _3a"> </span>We start at the specified offset</div><div class="t m0 x32 h57 y33b3 ff1a fs2d fc0 sc0 ls0 ws0">305 <span class="_ _68"> </span>*<span class="_"> </span>in the index file.<span class="_ _3a"> </span>We read the index record into db-&gt;idxbuf</div><div class="t m0 x32 h57 y33b4 ff1a fs2d fc0 sc0 ls0 ws0">306 <span class="_ _68"> </span>*<span class="_"> </span>and replace the separators with null bytes.<span class="_ _3a"> </span>If all is OK we</div><div class="t m0 x32 h57 y33b5 ff1a fs2d fc0 sc0 ls0 ws0">307 <span class="_ _68"> </span>*<span class="_"> </span>set db-&gt;datoff and db-&gt;datlen to the offset and length of the</div><div class="t m0 x32 h57 y2c63 ff1a fs2d fc0 sc0 ls0 ws0">308 <span class="_ _68"> </span>*<span class="_"> </span>corresponding data record in the data file.</div><div class="t m0 x32 h57 y33b6 ff1a fs2d fc0 sc0 ls0 ws0">309 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y33b7 ff1a fs2d fc0 sc0 ls0 ws0">310 <span class="_ _d9"> </span>static<span class="_"> </span>off_t</div><div class="t m0 x32 h57 y33b8 ff1a fs2d fc0 sc0 ls0 ws0">311 <span class="_ _d9"> </span>_db_readidx(DB<span class="_"> </span>*db, off_t offset)</div><div class="t m0 x32 h57 y33b9 ff1a fs2d fc0 sc0 ls0 ws0">312 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y33ba ff1a fs2d fc0 sc0 ls0 ws0">313 <span class="_ _15"> </span>ssize_t<span class="_ _166"> </span>i;</div><div class="t m0 x32 h57 y33bb ff1a fs2d fc0 sc0 ls0 ws0">314 <span class="_ _15"> </span>char<span class="_ _82"> </span>*ptr1, *ptr2;</div><div class="t m0 x32 h57 y33bc ff1a fs2d fc0 sc0 ls0 ws0">315 <span class="_ _15"> </span>char<span class="_ _82"> </span>asciiptr[PTR_SZ + 1], asciilen[IDXLEN_SZ + 1];</div><div class="t m0 x32 h57 y5784 ff1a fs2d fc0 sc0 ls0 ws0">316 <span class="_ _15"> </span>struct<span class="_"> </span>iovec <span class="_ _68"> </span>iov[2];</div><div class="t m0 x32 h4d y5785 ff19 fs26 fc0 sc0 ls0 ws0">[287 <span class="_ _a"></span>– <span class="_ _a"></span>302]<span class="_ _65"> </span><span class="ff1a">_db_readptr<span class="_ _80"> </span></span><span class="lscc">re<span class="_ _2"></span></span>ads any one of three differ<span class="_ _0"></span>ent chain pointers: (a) the pointer</div><div class="t m0 x11a h49 y5786 ff19 fs26 fc0 sc0 ls0 ws0">at <span class="_ _3"></span>the <span class="_ _9"></span>beginning <span class="_ _9"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>index <span class="_ _9"></span>ﬁle <span class="_ _3"></span>that <span class="_ _9"></span>points <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>ﬁrst <span class="_ _9"></span>index <span class="_ _9"></span>r<span class="_ _0"></span>ecord<span class="_ _47"> </span>on<span class="_ _45"> </span>the</div><div class="t m0 x11a h49 y5787 ff19 fs26 fc0 sc0 ls0 ws0">free <span class="_ _2"></span>list, <span class="_ _3"></span>(b) <span class="_ _3"></span>the <span class="_ _9"></span>pointers <span class="_ _2"></span>in <span class="_ _9"></span>the <span class="_ _3"></span>hash <span class="_ _3"></span>table <span class="_ _3"></span>that <span class="_ _3"></span>point <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>ﬁrst <span class="_ _3"></span>index <span class="_ _3"></span>recor<span class="_ _0"></span>d</div><div class="t m0 x11a h49 y5788 ff19 fs26 fc0 sc0 ls0 ws0">on <span class="_ _9"></span>each <span class="_ _23"></span>hash <span class="_ _9"></span>chain, <span class="_ _9"></span>and <span class="_ _23"></span>(c) <span class="_ _9"></span>the <span class="_ _23"></span>pointers <span class="_ _9"></span>that <span class="_ _9"></span>ar<span class="lsef0">es<span class="_ _b"></span><span class="ls0">tored <span class="_ _3"></span>at <span class="_ _23"></span>the <span class="_ _9"></span>beginning <span class="_ _23"></span>of</span></span></div><div class="t m0 x11a h49 y5789 ff19 fs26 fc0 sc0 ls0 ws0">each index <span class="_ _2"></span>recor<span class="ls168c">d(<span class="_ _8"></span><span class="ls0">whether <span class="_ _2"></span>the <span class="_ _2"></span>index <span class="_ _2"></span>record<span class="_"> </span>is<span class="_ _66"> </span>part <span class="_ _2"></span>of <span class="_ _2"></span>a <span class="_ _2"></span>hash <span class="_ _2"></span>chain <span class="_ _2"></span>or <span class="_ _2"></span>on the</span></span></div><div class="t m0 x11a h49 y578a ff19 fs26 fc0 sc0 ls0 ws0">free <span class="_ _47"> </span>list).<span class="_ _5f"> </span><span class="ls164">We <span class="_ _46"> </span>c<span class="_ _9"></span></span>onvert <span class="_ _45"> </span>the <span class="_ _47"> </span>pointer <span class="_ _47"> </span>from <span class="_ _47"> </span>ASCII <span class="_ _45"> </span>to <span class="_ _47"> </span>a <span class="_ _45"> </span>long <span class="_ _47"> </span>integer <span class="_ _47"> </span>before</div><div class="t m0 x11a h49 y578b ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">turning it.<span class="_ _46"> </span>No locking is done by this function; that is up to the caller<span class="_ _1"></span>.</span></div><div class="t m0 x32 h4d y578c ff19 fs26 fc0 sc0 ls0 ws0">[303 <span class="_ _a"></span>– <span class="_ _a"></span>316]<span class="_ _65"> </span>The<span class="_ _47"> </span><span class="ff1a">_db_readidx<span class="_ _47"> </span></span>function <span class="_ _2"></span>is <span class="_ _3"></span>used <span class="_ _3"></span>to <span class="_ _2"></span>read <span class="_ _2"></span>the <span class="_ _3"></span>record<span class="_ _66"> </span>at<span class="_ _47"> </span>the <span class="_ _3"></span>speciﬁed <span class="_ _2"></span>offset</div><div class="t m0 x11a h49 y578d ff19 fs26 fc0 sc0 ls0 ws0">from the index <span class="_ _2"></span>ﬁle.<span class="_ _46"> </span>On <span class="_ _2"></span>success, the <span class="_ _2"></span>function <span class="_ _2"></span>will return the <span class="_ _2"></span>offset of the <span class="_ _2"></span>next</div><div class="t m0 x11a h49 y578e ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cord<span class="_ _66"> </span>in<span class="_ _66"> </span>the <span class="_ _3"></span>list.<span class="_ _46"> </span>In <span class="_ _2"></span>this <span class="_ _2"></span>case, <span class="_ _2"></span>the <span class="_ _2"></span>function <span class="_ _2"></span>will <span class="_ _2"></span>populate <span class="_ _3"></span>several <span class="_ _2"></span>ﬁelds <span class="_ _2"></span>in <span class="_ _2"></span>the</span></div><div class="t m0 x11a h4d y578f ff1a fs26 fc0 sc0 ls0 ws0">DB<span class="_ _35"> </span><span class="ff19">structur<span class="_ _0"></span>e:<span class="_ _45"> </span><span class="ff1a">idxoff<span class="_ _35"> </span></span>contains <span class="_ _23"> </span>the <span class="_ _23"> </span>offset <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>current <span class="_ _23"></span>recor<span class="_ _0"></span>d<span class="_ _35"> </span>in<span class="_ _45"> </span>the <span class="_ _23"> </span>index</span></div><div class="t m0 x11a h4d y5790 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle,<span class="_ _35"> </span><span class="ff1a">ptrval<span class="_ _45"> </span></span>contains <span class="_ _42"> </span>the <span class="_ _23"></span>offset <span class="_ _9"></span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>next <span class="_ _23"> </span>index <span class="_ _23"> </span>entry <span class="_ _42"> </span>in <span class="_ _23"></span>the <span class="_ _23"></span>list,<span class="_ _35"> </span><span class="ff1a">idxlen</span></div><div class="t m0 x11a h4d y5791 ff19 fs26 fc0 sc0 ls0 ws0">contains <span class="_ _9"></span>the <span class="_ _9"></span>length <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>current <span class="_ _9"></span>index <span class="_ _9"></span>record,<span class="_ _47"> </span><span class="ff1a">idxbuf<span class="_ _45"> </span></span>contains <span class="_ _9"></span>the <span class="_ _9"></span>actual</div><div class="t m0 x11a h4d y5792 ff19 fs26 fc0 sc0 ls0 ws0">index <span class="_ _23"></span>recor<span class="_ _1"></span>d,<span class="_ _35"> </span><span class="ff1a">datoff<span class="_ _35"> </span></span>contains <span class="_ _9"></span>the <span class="_ _23"> </span>offset <span class="_ _9"></span>of <span class="_ _23"> </span>the <span class="_ _23"></span>recor<span class="_ _0"></span>d<span class="_ _45"> </span>in<span class="_ _35"> </span>the <span class="_ _23"></span>data <span class="_ _23"></span>ﬁle, <span class="_ _9"></span>and</div><div class="t m0 x11a h4d y5793 ff1a fs26 fc0 sc0 ls0 ws0">datlen<span class="_ _80"> </span><span class="ff19">contains the length of the data record.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
