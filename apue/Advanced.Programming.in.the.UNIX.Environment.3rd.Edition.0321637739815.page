<div id="pf32f" class="pf w4 h1f" data-page-no="32f"><div class="pc pc32f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg32f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.9<span class="_ _24b"> </span>Performance<span class="_ _1fb"> </span><span class="ff18">781</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The normal use of<span class="_"> </span><span class="ff1a">db_rewind<span class="_ _80"> </span></span>and<span class="_"> </span><span class="ff1a">db_nextrec<span class="_ _66"> </span></span>is in a loop of the form</div><div class="t m0 x3f h57 ya9b ff1a fs2d fc0 sc0 ls0 ws0">db_rewind(db);</div><div class="t m0 x3f h57 yac1 ff1a fs2d fc0 sc0 ls0 ws0">while ((ptr = db_nextrec(db, key)) != NULL) {</div><div class="t m0 xc2 h57 yac2 ff1a fs2d fc0 sc0 ls0 ws0">/* process record */</div><div class="t m0 x3f h57 yac3 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h2a y3040 ff19 fsf fc0 sc0 ls0 ws0">As <span class="_ _42"> </span>we <span class="_ _53"> </span>warned <span class="_ _53"> </span>earlier<span class="_ _6"></span><span class="ls16c5">,t<span class="_ _43"></span><span class="ls0">her<span class="_ _0"></span>e<span class="_ _44"> </span>is<span class="_ _44"> </span>no<span class="_ _44"> </span>o<span class="ls45">rd<span class="_ _2"></span></span>er <span class="_ _42"> </span>to <span class="_ _53"> </span>the <span class="_ _53"> </span>returned <span class="_ _42"> </span>recor<span class="_ _0"></span>ds; <span class="_ _42"> </span>they <span class="_ _53"> </span>ar<span class="ls16c6">en<span class="_ _c"></span><span class="ls0">ot <span class="_ _42"> </span>in <span class="_ _53"> </span>key</span></span></span></span></div><div class="t m0 x32 h2a y5859 ff19 fsf fc0 sc0 ls0 ws0">order<span class="_ _6"></span>.</div><div class="t m0 x3f h26 y585a ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _e"> </span>the <span class="_ _e"> </span>database <span class="_ _e"> </span>is <span class="_ _e"> </span>being <span class="_"> </span>modiﬁed <span class="_ _53"> </span>while<span class="_ _4b"> </span><span class="ff1a">db_nextrec<span class="_ _59"> </span></span>is <span class="_ _e"> </span>called <span class="_ _e"> </span>from <span class="_ _53"> </span>a <span class="_"> </span>loop, <span class="_ _53"> </span>the</div><div class="t m0 x32 h26 y585b ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">cords returned by<span class="_"> </span><span class="ff1a">db_nextrec<span class="_ _66"> </span></span>ar<span class="ls16c7">es<span class="_ _4f"></span><span class="ls0">imply a <span class="_ _2"></span>snapshot of a <span class="_ _2"></span>changing database at <span class="_ _2"></span>some</span></span></span></div><div class="t m0 x32 h26 y3043 ff19 fsf fc0 sc0 ls0 ws0">point <span class="_ _3"></span>in <span class="_ _3"></span>time.<span class="_ _61"> </span><span class="ff1a">db_nextrec<span class="_ _45"> </span></span>always <span class="_ _2"></span>returns <span class="_ _3"></span>a <span class="_ _3"></span>‘<span class="_ _1"></span>‘correct’<span class="_ _0"></span><span class="ls16c8">’r<span class="_ _b"></span><span class="ls0">ecor<span class="ls16c8">dw<span class="_ _8"></span><span class="ls0">hen <span class="_ _3"></span>it <span class="_ _3"></span>is <span class="_ _3"></span>called; <span class="_ _3"></span>that <span class="_ _3"></span>is,</span></span></span></span></div><div class="t m0 x32 h2a y29af ff19 fsf fc0 sc0 ls0 ws0">it <span class="_ _42"> </span>won’t <span class="_ _42"> </span>r<span class="_ _0"></span>eturn <span class="_ _42"> </span>a <span class="_ _42"> </span>recor<span class="_ _1"></span><span class="ls276">dt<span class="_ _43"></span><span class="ls0">hat <span class="_ _42"> </span>was <span class="_ _42"> </span>deleted.<span class="_ _54"> </span>But <span class="_ _23"> </span>it <span class="_ _42"> </span>is <span class="_ _42"> </span>possible <span class="_ _42"> </span>for <span class="_ _42"> </span>a <span class="_ _42"> </span>recor<span class="_ _0"></span><span class="ls8f8">dr<span class="_ _c"></span><span class="ls0">eturned <span class="_ _42"> </span>by</span></span></span></span></div><div class="t m0 x32 h26 y29b0 ff1a fsf fc0 sc0 ls0 ws0">db_nextrec<span class="_ _46"> </span><span class="ff19">to <span class="_ _66"> </span>be <span class="_ _47"> </span>deleted <span class="_"> </span>immediately <span class="_ _47"> </span>after<span class="_ _46"> </span></span>db_nextrec<span class="_ _61"> </span><span class="ff19 ls45">re<span class="ls0">turns. <span class="_ _61"> </span>Similarly<span class="_ _6"></span>,<span class="_ _46"> </span>if<span class="_ _61"> </span>a</span></span></div><div class="t m0 x32 h26 y29b1 ff19 fsf fc0 sc0 ls0 ws0">deleted <span class="_ _e"> </span>record<span class="_ _4b"> </span>is<span class="_ _59"> </span>reused <span class="_ _e"> </span>right <span class="_"> </span>after<span class="_ _4b"> </span><span class="ff1a">db_nextrec<span class="_ _59"> </span></span>skips <span class="_ _e"> </span>over <span class="_"> </span>the <span class="_ _e"> </span>deleted <span class="_"> </span>r<span class="_ _1"></span>ecord, <span class="_"> </span>we</div><div class="t m0 x32 h2a y29b2 ff19 fsf fc0 sc0 ls0 ws0">won’t see that new <span class="_ _2"></span>recor<span class="_ _0"></span><span class="ls16c9">du<span class="_ _4f"></span><span class="ls0">nless <span class="_ _2"></span>we rewind the database and go <span class="_ _2"></span>through it again.<span class="_ _46"> </span>If it’s</span></span></div><div class="t m0 x32 h26 y29b3 ff19 fsf fc0 sc0 ls0 ws0">important <span class="_ _3"></span>to <span class="_ _3"></span>obtain <span class="_ _3"></span>an <span class="_ _3"></span>accurate <span class="_ _9"></span>‘<span class="_ _0"></span>‘fr<span class="_ _0"></span>ozen’<span class="_ _0"></span><span class="ls9aa">’s<span class="_ _8"></span><span class="ls0">napshot <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>database <span class="_ _3"></span>using<span class="_ _45"> </span><span class="ff1a">db_nextrec</span>,</span></span></div><div class="t m0 x32 h2a y3046 ff19 fsf fc0 sc0 ls0 ws0">then no insertions or deletions can be going on at the same time.</div><div class="t m0 x3f h26 y29b4 ff19 fsf fc0 sc0 ls0 ws0">Look at the locking used by<span class="_"> </span><span class="ff1a">db_nextrec</span><span class="ls16ca">.W<span class="_ _62"></span><span class="ls0">e’r<span class="ls653">en<span class="_ _4f"></span><span class="ls0">ot going <span class="_ _2"></span>through any hash chain,</span></span></span></span></div><div class="t m0 x32 h2a y3047 ff19 fsf fc0 sc0 ls0 ws0">and we can’t <span class="_ _2"></span>determine the hash <span class="_ _2"></span>chain that a <span class="_ _2"></span>recor<span class="_ _0"></span><span class="ls14aa">db<span class="_ _4f"></span><span class="ls0">elongs <span class="_ _2"></span>on.<span class="_ _46"> </span>Therefor<span class="_ _0"></span>e, it is <span class="_ _2"></span>possible</span></span></div><div class="t m0 x32 h26 y3049 ff19 fsf fc0 sc0 ls0 ws0">for <span class="_ _3"></span>an <span class="_ _3"></span>index <span class="_ _3"></span>record<span class="_ _47"> </span>to<span class="_ _47"> </span>be<span class="_ _45"> </span>in<span class="_ _47"> </span>the <span class="_ _3"></span>process <span class="_ _2"></span>of <span class="_ _9"></span>being <span class="_ _3"></span>deleted <span class="_ _3"></span>when<span class="_ _45"> </span><span class="ff1a">db_nextrec<span class="_ _47"> </span></span>is <span class="_ _3"></span>reading</div><div class="t m0 x32 h26 y304a ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _3"></span>recor<span class="_ _0"></span>d. <span class="_ _47"> </span>T<span class="_ _6"></span><span class="ls1005">op<span class="_ _8"></span><span class="ls45">re<span class="_ _2"></span><span class="ls0">vent <span class="_ _3"></span>this <span class="_ _3"></span>race,<span class="_ _47"> </span><span class="ff1a">db_nextrec<span class="_ _47"> </span></span></span>re<span class="_ _2"></span><span class="ls0">ad <span class="_ _3"></span>locks <span class="_ _3"></span>the <span class="_ _3"></span>free <span class="_ _2"></span>list, <span class="_ _3"></span>thereby <span class="_ _3"></span>avoiding</span></span></span></div><div class="t m0 x32 h26 y304b ff19 fsf fc0 sc0 ls0 ws0">any interaction with<span class="_"> </span><span class="ff1a">_db_dodelete<span class="_ _80"> </span></span>and<span class="_"> </span><span class="ff1a">_db_findfree</span>.</div><div class="t m0 x3f h26 y304c ff19 fsf fc0 sc0 ls0 ws0">Before<span class="_ _4b"> </span>we<span class="_ _4b"> </span>conclude <span class="_ _e"> </span>our <span class="_ _e"> </span>study <span class="_"> </span>of <span class="_ _53"> </span>the<span class="_ _4b"> </span><span class="ff1a">db.c<span class="_ _59"> </span></span>source <span class="_ _53"> </span>ﬁle, <span class="_ _e"> </span>we <span class="_"> </span>need <span class="_ _53"> </span>to <span class="_ _e"> </span>describe <span class="_ _e"> </span>the</div><div class="t m0 x32 h2a y304d ff19 fsf fc0 sc0 ls0 ws0">locking <span class="_ _2"></span>when <span class="_ _3"></span>new <span class="_ _2"></span>index <span class="_ _3"></span>records or <span class="_ _3"></span>data <span class="_ _2"></span>records <span class="_ _2"></span>ar<span class="ls267">ea<span class="_ _8"></span><span class="ls0">ppended <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>end <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>ﬁle.<span class="_ _16"> </span>In</span></span></div><div class="t m0 x32 h26 y304f ff19 fsf fc0 sc0 ls0 ws0">cases <span class="_ _9"></span>1 <span class="_ _23"></span>and <span class="_ _9"></span>3,<span class="_ _35"> </span><span class="ff1a">db_store<span class="_ _45"> </span></span>calls <span class="_ _9"></span>both<span class="_ _35"> </span><span class="ff1a">_db_writeidx<span class="_ _45"> </span></span>and<span class="_ _45"> </span><span class="ff1a">_db_writedat<span class="_ _45"> </span></span>with <span class="_ _23"></span>a <span class="_ _9"></span>third</div><div class="t m0 x32 h26 y3050 ff19 fsf fc0 sc0 ls0 ws0">argument of <span class="_ _2"></span>0 <span class="_ _2"></span>and <span class="_ _3"></span>a <span class="_ _2"></span>fourth <span class="_ _2"></span>argument of<span class="_ _47"> </span><span class="ff1a">SEEK_END</span><span class="ls16cb">.T<span class="_ _5b"></span><span class="ls0">his <span class="_ _2"></span>fourth <span class="_ _2"></span>argument is <span class="_ _3"></span>the <span class="_ _2"></span>ﬂag <span class="_ _2"></span>to</span></span></div><div class="t m0 x32 h2a y482 ff19 fsf fc0 sc0 ls0 ws0">these <span class="_ _9"></span>two <span class="_ _9"></span>functions, <span class="_ _23"></span>indicating <span class="_ _9"></span>that <span class="_ _23"></span>the <span class="_ _9"></span>new <span class="_ _9"></span>record<span class="_ _45"> </span>is<span class="_ _45"> </span>being <span class="_ _9"></span>appended <span class="_ _9"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>ﬁle.<span class="_ _5a"> </span>The</div><div class="t m0 x32 h26 y3051 ff19 fsf fc0 sc0 ls0 ws0">technique <span class="_ _23"> </span>used <span class="_ _42"> </span>by<span class="_ _35"> </span><span class="ff1a">_db_writeidx<span class="_ _35"> </span></span>is <span class="_ _23"> </span>to <span class="_ _42"> </span>write <span class="_ _23"> </span>lock <span class="_ _42"> </span>the <span class="_ _23"> </span>index <span class="_ _42"> </span>ﬁle <span class="_ _23"> </span>from <span class="_ _23"> </span>the <span class="_ _23"> </span>end <span class="_ _42"> </span>of <span class="_ _23"> </span>the</div><div class="t m0 x32 h2a y3052 ff19 fsf fc0 sc0 ls0 ws0">hash <span class="_ _9"></span>chain <span class="_ _9"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>end <span class="_ _9"></span>of <span class="_ _9"></span>ﬁle.<span class="_ _5a"> </span>This <span class="_ _9"></span>won’t <span class="_ _9"></span>interfer<span class="ls16cc">ew<span class="_ _b"></span><span class="ls0">ith <span class="_ _9"></span>any <span class="_ _9"></span>other <span class="_ _9"></span>readers <span class="_ _9"></span>or <span class="_ _9"></span>writers <span class="_ _9"></span>of</span></span></div><div class="t m0 x32 h2a y3053 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>database <span class="_ _53"> </span>(since <span class="_ _53"> </span>they <span class="_ _53"> </span>will <span class="_ _53"> </span>lock <span class="_ _53"> </span>a <span class="_ _53"> </span>hash <span class="_ _e"> </span>chain), <span class="_ _53"> </span>but <span class="_ _53"> </span>it <span class="_ _53"> </span>does <span class="_ _53"> </span>prevent <span class="_ _53"> </span>other <span class="_ _53"> </span>callers <span class="_ _53"> </span>of</div><div class="t m0 x32 h26 y3054 ff1a fsf fc0 sc0 ls0 ws0">db_store<span class="_ _60"> </span><span class="ff19">fr<span class="_ _0"></span>om <span class="_ _59"> </span>trying <span class="_ _59"> </span>to <span class="_ _46"> </span>append <span class="_ _59"> </span>at <span class="_ _46"> </span>the <span class="_ _59"> </span>same <span class="_ _46"> </span>time.<span class="_ _5e"> </span>The <span class="_ _59"> </span>technique <span class="_ _59"> </span>used <span class="_ _59"> </span>by</span></div><div class="t m0 x32 h26 y3055 ff1a fsf fc0 sc0 ls0 ws0">_db_writedat<span class="_ _44"> </span><span class="ff19">is <span class="_ _42"> </span>to <span class="_ _42"> </span>write <span class="_ _53"> </span>lock <span class="_ _42"> </span>the <span class="_ _53"> </span>entir<span class="ls1384">ed<span class="_ _c"></span><span class="ls0">ata <span class="_ _42"> </span>ﬁle.<span class="_ _54"> </span>Again, <span class="_ _53"> </span>this <span class="_ _42"> </span>won’t <span class="_ _53"> </span>interfer<span class="ls1384">ew<span class="_ _c"></span><span class="ls0">ith</span></span></span></span></span></div><div class="t m0 x32 h2a y3056 ff19 fsf fc0 sc0 ls0 ws0">other <span class="_ _3"></span>readers <span class="_ _2"></span>or <span class="_ _9"></span>writers <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>database <span class="_ _3"></span>(since <span class="_ _9"></span>they <span class="_ _3"></span>don’t <span class="_ _3"></span>even <span class="_ _3"></span>try <span class="_ _3"></span>to <span class="_ _9"></span>lock <span class="_ _3"></span>the <span class="_ _3"></span>data <span class="_ _3"></span>ﬁle),</div><div class="t m0 x32 h26 y3057 ff19 fsf fc0 sc0 ls0 ws0">but <span class="_ _3"></span>it <span class="_ _9"></span>does <span class="_ _3"></span>prevent <span class="_ _3"></span>other <span class="_ _9"></span>callers <span class="_ _3"></span>of<span class="_ _45"> </span><span class="ff1a">db_store<span class="_ _47"> </span></span>from <span class="_ _3"></span>trying <span class="_ _9"></span>to <span class="_ _3"></span>append <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>data <span class="_ _3"></span>ﬁle <span class="_ _9"></span>at</div><div class="t m0 x32 h2a y3058 ff19 fsf fc0 sc0 ls0 ws0">the same time.<span class="_ _59"> </span>(See Exercise 20.3.)</div><div class="t m0 x35 h53 y585c ff16 fs2b fc0 sc0 ls0 ws0">20.9 <span class="_ _93"> </span>P<span class="_ _0"></span>erf<span class="_ _0"></span>ormance</div><div class="t m0 x32 h2a y585d ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _59"> </span>w<span class="_ _9"></span><span class="ls45">ro<span class="_ _2"></span><span class="ls0">te <span class="_ _47"> </span>a <span class="_ _45"> </span>test <span class="_ _47"> </span>program <span class="_ _47"> </span>to <span class="_ _47"> </span>test <span class="_ _47"> </span>the <span class="_ _45"> </span>database <span class="_ _47"> </span>library <span class="_ _47"> </span>and <span class="_ _47"> </span>to <span class="_ _47"> </span>obtain <span class="_ _45"> </span>some <span class="_ _47"> </span>timing</span></span></div><div class="t m0 x32 h2a y585e ff19 fsf fc0 sc0 ls0 ws0">measurements <span class="_ _53"> </span>of <span class="_ _53"> </span>the <span class="_ _e"> </span>database <span class="_ _e"> </span>access <span class="_ _e"> </span>patterns <span class="_ _53"> </span>of <span class="_ _e"> </span>typical <span class="_ _e"> </span>applications.<span class="_ _48"> </span>This <span class="_ _53"> </span>program</div><div class="t m0 x32 h2a y585f ff19 fsf fc0 sc0 ls0 ws0">takes two command</div><div class="t m0 x185 h2a y5860 ff19 fsf fc0 sc0 ls0 ws0">-</div><div class="t m0 x161 h2a y585f ff19 fsf fc0 sc0 ls0 ws0">line arguments: the number of childr<span class="_ _0"></span>en to cr<span class="_ _0"></span>eate and the number of</div><div class="t m0 x32 h2b y5861 ff19 fsf fc0 sc0 ls0 ws0">database recor<span class="_ _0"></span>ds (<span class="ff1b">nrec</span><span class="lse68">)f<span class="_ _4f"></span><span class="ls0">or each <span class="_ _2"></span>child to write to <span class="_ _2"></span>the database.<span class="_ _46"> </span>The program then creates</span></span></div><div class="t m0 x32 h26 y39d4 ff19 fsf fc0 sc0 ls0 ws0">an <span class="_ _42"> </span>empty <span class="_ _53"> </span>database <span class="_ _42"> </span>(by <span class="_ _53"> </span>calling<span class="_ _44"> </span><span class="ff1a">db_open</span>),<span class="_ _4b"> </span><span class="ff1a">fork</span><span class="lsf5e">st<span class="_ _c"></span><span class="ls0">he <span class="_ _53"> </span>number <span class="_ _42"> </span>of <span class="_ _53"> </span>child <span class="_ _53"> </span>processes, <span class="_ _42"> </span>and</span></span></div><div class="t m0 x32 h2a y39d5 ff19 fsf fc0 sc0 ls0 ws0">waits for all the children to terminate.<span class="_ _59"> </span>Each child performs the following steps.</div><a class="l" href="#pf13" data-dest-detail='[19,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.897248px;bottom:314.806795px;width:108.755501px;height:19.680008px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
