<div id="pf350" class="pf w4 h1f" data-page-no="350"><div class="pc pc350 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg350.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">814<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">60 <span class="_ _d9"> </span>int32_t<span class="_ _301"> </span>nextjob;</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">61 <span class="_ _d9"> </span>pthread_mutex_t<span class="_ _186"> </span>joblock = PTHREAD_MUTEX_INITIALIZER;</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">62 <span class="_ _d9"> </span>pthread_cond_t<span class="_ _176"> </span>jobwait = PTHREAD_COND_INITIALIZER;</div><div class="t m0 x32 h57 y846 ff1a fs2d fc0 sc0 ls0 ws0">63 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y847 ff1a fs2d fc0 sc0 ls0 ws0">64 <span class="_ _68"> </span>*<span class="_"> </span>Function prototypes.</div><div class="t m0 x32 h57 y13a1 ff1a fs2d fc0 sc0 ls0 ws0">65 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y1fb8 ff1a fs2d fc0 sc0 ls0 ws0">66 <span class="_ _d9"> </span>void<span class="_ _90"> </span>init_request(void);</div><div class="t m0 x32 h57 y1fb9 ff1a fs2d fc0 sc0 ls0 ws0">67 <span class="_ _d9"> </span>void<span class="_ _90"> </span>init_printer(void);</div><div class="t m0 x32 h57 y1fba ff1a fs2d fc0 sc0 ls0 ws0">68 <span class="_ _d9"> </span>void<span class="_ _90"> </span>update_jobno(void);</div><div class="t m0 x32 h57 y1fbb ff1a fs2d fc0 sc0 ls0 ws0">69 <span class="_ _d9"> </span>int32_t<span class="_ _15"> </span>get_newjobno(void);</div><div class="t m0 x32 h57 y1fbc ff1a fs2d fc0 sc0 ls0 ws0">70 <span class="_ _d9"> </span>void<span class="_ _90"> </span>add_job(struct printreq *, int32_t);</div><div class="t m0 x32 h57 y1fbd ff1a fs2d fc0 sc0 ls0 ws0">71 <span class="_ _d9"> </span>void<span class="_ _90"> </span>replace_job(struct job *);</div><div class="t m0 x32 h57 y1fbe ff1a fs2d fc0 sc0 ls0 ws0">72 <span class="_ _d9"> </span>void<span class="_ _90"> </span>remove_job(struct job *);</div><div class="t m0 x32 h57 y1fbf ff1a fs2d fc0 sc0 ls0 ws0">73 <span class="_ _d9"> </span>void<span class="_ _90"> </span>build_qonstart(void);</div><div class="t m0 x32 h57 y1fc0 ff1a fs2d fc0 sc0 ls0 ws0">74 <span class="_ _d9"> </span>void<span class="_ _90"> </span>*client_thread(void *);</div><div class="t m0 x32 h57 y1fc1 ff1a fs2d fc0 sc0 ls0 ws0">75 <span class="_ _d9"> </span>void<span class="_ _90"> </span>*printer_thread(void *);</div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">76 <span class="_ _d9"> </span>void<span class="_ _90"> </span>*signal_thread(void *);</div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">77 <span class="_ _d9"> </span>ssize_t<span class="_ _15"> </span>readmore(int, char **, int, int *);</div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">78 <span class="_ _d9"> </span>int<span class="_ _186"> </span>printer_status(int, struct job *);</div><div class="t m0 x32 h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">79 <span class="_ _d9"> </span>void<span class="_ _90"> </span>add_worker(pthread_t, int);</div><div class="t m0 x32 h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">80 <span class="_ _d9"> </span>void<span class="_ _90"> </span>kill_workers(void);</div><div class="t m0 x32 h57 y57b4 ff1a fs2d fc0 sc0 ls0 ws0">81 <span class="_ _d9"> </span>void<span class="_ _90"> </span>client_cleanup(void *);</div><div class="t m0 x32 h57 y2adb ff1a fs2d fc0 sc0 ls0 ws0">82 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y2adc ff1a fs2d fc0 sc0 ls0 ws0">83 <span class="_ _68"> </span>*<span class="_"> </span>Main print server thread.<span class="_ _3a"> </span>Accepts connect requests from</div><div class="t m0 x32 h57 y2add ff1a fs2d fc0 sc0 ls0 ws0">84 <span class="_ _68"> </span>*<span class="_"> </span>clients and spawns additional threads to service requests.</div><div class="t m0 x32 h57 y2ade ff1a fs2d fc0 sc0 ls0 ws0">85 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y2c66 ff1a fs2d fc0 sc0 ls0 ws0">86 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h57 y2c67 ff1a fs2d fc0 sc0 ls0 ws0">87 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y573f ff1a fs2d fc0 sc0 ls0 ws0">88 <span class="_ _d9"> </span>int</div><div class="t m0 x32 h57 y57b5 ff1a fs2d fc0 sc0 ls0 ws0">89 <span class="_ _d9"> </span>main(int<span class="_"> </span>argc, char *argv[])</div><div class="t m0 x32 h57 y57b6 ff1a fs2d fc0 sc0 ls0 ws0">90 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y57b7 ff1a fs2d fc0 sc0 ls0 ws0">91 <span class="_ _8a"> </span>pthread_t<span class="_ _bd"> </span>tid;</div><div class="t m0 x32 h57 y57b8 ff1a fs2d fc0 sc0 ls0 ws0">92 <span class="_ _8a"> </span>struct<span class="_"> </span>addrinfo <span class="_ _15"> </span>*ailist,<span class="_"> </span>*aip;</div><div class="t m0 x32 h57 y57b9 ff1a fs2d fc0 sc0 ls0 ws0">93 <span class="_ _8a"> </span>int<span class="_ _ce"> </span>sockfd, err, i, n, maxfd;</div><div class="t m0 x32 h57 y57ba ff1a fs2d fc0 sc0 ls0 ws0">94 <span class="_ _8a"> </span>char<span class="_ _1e7"> </span>*host;</div><div class="t m0 x32 h57 y5b81 ff1a fs2d fc0 sc0 ls0 ws0">95 <span class="_ _8a"> </span>fd_set<span class="_ _12d"> </span>rendezvous, rset;</div><div class="t m0 x32 h57 y5b82 ff1a fs2d fc0 sc0 ls0 ws0">96 <span class="_ _8a"> </span>struct<span class="_"> </span>sigaction <span class="_ _68"> </span>sa;</div><div class="t m0 x32 h57 y5b83 ff1a fs2d fc0 sc0 ls0 ws0">97 <span class="_ _8a"> </span>struct<span class="_"> </span>passwd <span class="_ _189"> </span>*pwdp;</div><div class="t m0 x32 h4d y5b84 ff19 fs26 fc0 sc0 ls0 ws0">[60 <span class="_ _a"></span>– <span class="_ _a"></span>62]<span class="_ _65"> </span><span class="ff1a">nextjob<span class="_ _45"> </span></span>is <span class="_ _23"> </span>the <span class="_ _23"> </span>ID <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>next <span class="_ _9"></span>print <span class="_ _23"> </span>job <span class="_ _23"></span>to <span class="_ _23"></span>be <span class="_ _23"></span>r<span class="_ _0"></span>eceived. <span class="_ _45"> </span>The<span class="_ _35"> </span><span class="ff1a">joblock<span class="_ _35"> </span></span>mutex</div><div class="t m0 x2d h49 y5b85 ff19 fs26 fc0 sc0 ls0 ws0">protects <span class="_ _53"> </span>the <span class="_"> </span>linked <span class="_ _53"> </span>list <span class="_ _e"> </span>of <span class="_"> </span>jobs, <span class="_ _53"> </span>as <span class="_ _e"> </span>well <span class="_"> </span>as <span class="_ _53"> </span>the <span class="_ _e"> </span>condition <span class="_"> </span>r<span class="_ _1"></span>epresented <span class="_ _e"> </span>by <span class="_ _e"> </span>the</div><div class="t m0 x2d h4d y5b86 ff1a fs26 fc0 sc0 ls0 ws0">jobwait<span class="_ _80"> </span><span class="ff19">condition variable.</span></div><div class="t m0 x32 h49 y5b87 ff19 fs26 fc0 sc0 ls0 ws0">[63 <span class="_ _a"></span>– <span class="_ _a"></span>81]<span class="_ _65"> </span><span class="ls164">We <span class="_ _35"> </span>d<span class="_ _23"></span></span>eclar<span class="_ _0"></span><span class="ls1774">et<span class="_ _55"></span><span class="ls0">he <span class="_ _e"> </span>function <span class="_ _e"> </span>prototypes <span class="_ _e"> </span>for <span class="_ _e"> </span>the <span class="_"> </span>r<span class="_ _0"></span>emaining <span class="_ _53"> </span>functions <span class="_"> </span>in <span class="_ _53"> </span>this <span class="_"> </span>ﬁle.</span></span></div><div class="t m0 x2d h49 y5b88 ff19 fs26 fc0 sc0 ls0 ws0">Doing <span class="_ _45"> </span>this <span class="_ _47"> </span>up <span class="_ _45"> </span>front <span class="_ _47"> </span>allows <span class="_ _45"> </span>us <span class="_ _45"> </span>to <span class="_ _47"> </span>place <span class="_ _45"> </span>the <span class="_ _45"> </span>functions <span class="_ _47"> </span>in <span class="_ _45"> </span>the <span class="_ _45"> </span>ﬁle <span class="_ _47"> </span>without</div><div class="t m0 x2d h49 y5b89 ff19 fs26 fc0 sc0 ls0 ws0">worrying about the order in which each is called.</div><div class="t m0 x32 h4d y5b8a ff19 fs26 fc0 sc0 ls0 ws0">[82 <span class="_ _a"></span>– <span class="_ _a"></span>97]<span class="_ _65"> </span>The<span class="_ _47"> </span><span class="ff1a">main<span class="_ _45"> </span></span>function <span class="_ _3"></span>for <span class="_ _9"></span>the <span class="_ _9"></span>printer <span class="_ _3"></span>spooling <span class="_ _9"></span>daemon <span class="_ _3"></span>has <span class="_ _9"></span>two <span class="_ _3"></span>tasks <span class="_ _9"></span>to <span class="_ _9"></span>perform:</div><div class="t m0 x2d h49 y5b8b ff19 fs26 fc0 sc0 ls0 ws0">initialize the daemon and then process connect r<span class="_ _0"></span>equests fr<span class="_ _0"></span>om clients.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
