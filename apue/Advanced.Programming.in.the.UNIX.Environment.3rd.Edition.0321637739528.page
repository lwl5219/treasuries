<div id="pf210" class="pf w4 h1f" data-page-no="210"><div class="pc pc210 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg210.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">494<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _9"></span>linked <span class="_ _9"></span>list <span class="_ _23"></span>of <span class="_ _9"></span>locks <span class="_ _9"></span>for <span class="_ _9"></span>the <span class="_ _23"></span>corresponding <span class="_ _3"></span>i-node <span class="_ _9"></span>and <span class="_ _23"></span>releases <span class="_ _3"></span>the <span class="_ _23"></span>locks <span class="_ _9"></span>held <span class="_ _9"></span>by <span class="_ _9"></span>the</div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">calling <span class="_ _23"> </span>process. <span class="_ _35"> </span>The<span class="_ _44"> </span>kernel <span class="_ _23"> </span>can’t <span class="_ _42"> </span>tell <span class="_ _42"> </span>(and <span class="_ _42"> </span>doesn’t <span class="_ _23"> </span>care) <span class="_ _23"> </span>which <span class="_ _42"> </span>descriptor <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _23"> </span>three</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">was used by the parent to obtain the lock.</div><div class="t m0 x35 h27 y496 ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y498 ff19 fsf fc0 sc0 ls0 ws0">In <span class="_ _3"></span>the <span class="_ _3"></span>program <span class="_ _2"></span>in <span class="_ _3"></span>Figur<span class="ls1005">e1<span class="_ _8"></span><span class="ls0">3.6, <span class="_ _3"></span>we <span class="_ _3"></span>saw <span class="_ _3"></span>how <span class="_ _3"></span>a <span class="_ _3"></span>daemon <span class="_ _3"></span>can <span class="_ _3"></span>use <span class="_ _3"></span>a <span class="_ _3"></span>lock <span class="_ _3"></span>on <span class="_ _3"></span>a <span class="_ _3"></span>ﬁle <span class="_ _3"></span>to <span class="_ _3"></span>ensure</span></span></div><div class="t m0 x32 h2a y499 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _2"></span>only <span class="_ _3"></span>one <span class="_ _3"></span>copy <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>daemon <span class="_ _2"></span>is <span class="_ _3"></span>running. <span class="_ _47"> </span>Figur<span class="ls77">e1<span class="_ _8"></span><span class="ls0">4.9 <span class="_ _2"></span>shows <span class="_ _3"></span>the <span class="_ _3"></span>implementation <span class="_ _2"></span>of</span></span></div><div class="t m0 x32 h26 y49a ff19 fsf fc0 sc0 ls0 ws0">the<span class="_"> </span><span class="ff1a">lockfile<span class="_ _80"> </span></span>function used by the daemon to place a write lock on a ﬁle.</div><div class="t m0 x32 h4e y3c98 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x32 h4e y3c99 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h4e y3c9a ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y3c9b ff1a fs28 fc0 sc0 ls0 ws0">lockfile(int fd)</div><div class="t m0 x32 h4e y3c9c ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y3c9d ff1a fs28 fc0 sc0 ls0 ws0">struct flock fl;</div><div class="t m0 x8a h4e y3c9e ff1a fs28 fc0 sc0 ls0 ws0">fl.l_type = F_WRLCK;</div><div class="t m0 x8a h4e y3c9f ff1a fs28 fc0 sc0 ls0 ws0">fl.l_start = 0;</div><div class="t m0 x8a h4e y3ca0 ff1a fs28 fc0 sc0 ls0 ws0">fl.l_whence = SEEK_SET;</div><div class="t m0 x8a h4e y3ca1 ff1a fs28 fc0 sc0 ls0 ws0">fl.l_len = 0;</div><div class="t m0 x8a h4e y3ca2 ff1a fs28 fc0 sc0 ls0 ws0">return(fcntl(fd, F_SETLK, &amp;fl));</div><div class="t m0 x32 h4e y3ca3 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8c h2e y3ca4 ff18 fs11 fc0 sc0 ls0 ws0">Figure 14.9<span class="_ _5a"> </span><span class="ff19">Place a write lock on an entir<span class="lsdb">eﬁ<span class="_ _84"></span><span class="ls0">le</span></span></span></div><div class="t m0 x3f h54 y3ca5 ff19 fs2c fc0 sc0 ls0 ws0">Alternatively<span class="_ _4"></span>,<span class="_ _47"> </span>we<span class="_ _66"> </span>could <span class="_ _2"></span>deﬁne <span class="_ _3"></span>the<span class="_ _66"> </span><span class="ff1a">lockfile<span class="_ _47"> </span></span>function <span class="_ _2"></span>in <span class="_ _2"></span>terms <span class="_ _2"></span>of <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">write_lock</span></div><div class="t m0 x32 h55 y3ca6 ff19 fs2c fc0 sc0 ls0 ws0">function:</div><div class="t m0 x3f h5d y3ca7 ff1a fs2f fc0 sc0 ls0 ws0">#define lockfile(fd) write_lock((fd), 0, SEEK_SET, 0)</div><div class="t m0 x35 h5a y3ca8 ff16 fs29 fc0 sc0 ls0 ws0">Locks at End of File</div><div class="t m0 x32 h50 y3ca9 ff19 fs29 fc0 sc0 lse2 ws0">We <span class="_ _53"> </span>n<span class="_ _9"></span><span class="ls0">eed to use <span class="_ _2"></span>caution when locking or unlocking byte <span class="_ _2"></span>ranges relative to the end of ﬁle.</span></div><div class="t m0 x32 h5c y3caa ff19 fs29 fc0 sc0 ls0 ws0">Most <span class="_ _3"></span>implementations <span class="_ _3"></span>convert <span class="_ _3"></span>an<span class="_ _47"> </span><span class="ff1a">l_whence<span class="_ _45"> </span></span>value <span class="_ _2"></span>of<span class="_ _47"> </span><span class="ff1a">SEEK_CUR<span class="_ _45"> </span></span>or<span class="_ _47"> </span><span class="ff1a">SEEK_END<span class="_ _47"> </span></span>into <span class="_ _3"></span>an</div><div class="t m0 x32 h5c y3cab ff19 fs29 fc0 sc0 ls0 ws0">absolute <span class="_ _53"> </span>ﬁle <span class="_ _e"> </span>offset, <span class="_ _53"> </span>using<span class="_ _4b"> </span><span class="ff1a">l_start<span class="_ _4b"> </span></span>and <span class="_ _e"> </span>the <span class="_ _e"> </span>ﬁle’s <span class="_ _53"> </span>current <span class="_ _53"> </span>position <span class="_ _e"> </span>or <span class="_ _e"> </span>current <span class="_ _53"> </span>length.</div><div class="t m0 x32 h50 y3cac ff19 fs29 fc0 sc0 ls0 ws0">Often, <span class="_ _23"> </span>however<span class="_ _1"></span>,<span class="_ _35"> </span>we<span class="_ _35"> </span>need <span class="_ _23"></span>to <span class="_ _23"> </span>specify <span class="_ _23"> </span>a <span class="_ _42"> </span>lock <span class="_ _23"></span>relative <span class="_ _23"></span>to <span class="_ _23"></span>the <span class="_ _23"> </span>ﬁle’s <span class="_ _23"> </span>current <span class="_ _23"></span>length, <span class="_ _23"> </span>but <span class="_ _23"> </span>we</div><div class="t m0 x32 h5c y3cad ff19 fs29 fc0 sc0 ls0 ws0">can’t <span class="_ _23"></span>call<span class="_ _35"> </span><span class="ff1a">fstat<span class="_ _45"> </span></span>to <span class="_ _23"> </span>obtain <span class="_ _23"> </span>the <span class="_ _23"> </span>current <span class="_ _23"></span>ﬁle <span class="_ _23"></span>size, <span class="_ _23"></span>since <span class="_ _23"></span>we <span class="_ _23"></span>don’t <span class="_ _23"></span>have <span class="_ _23"></span>a <span class="_ _23"></span>lock <span class="_ _23"></span>on <span class="_ _23"></span>the <span class="_ _23"></span>ﬁle.</div><div class="t m0 x32 h50 y3cae ff19 fs29 fc0 sc0 ls0 ws0">(There’s a <span class="_ _3"></span>chance <span class="_ _2"></span>that <span class="_ _3"></span>another <span class="_ _2"></span>process <span class="_ _2"></span>could <span class="_ _2"></span>change <span class="_ _3"></span>the <span class="_ _2"></span>ﬁle’s <span class="_ _3"></span>length <span class="_ _2"></span>between <span class="_ _2"></span>the <span class="_ _3"></span>call <span class="_ _2"></span>to</div><div class="t m0 x32 h5c y3caf ff1a fs29 fc0 sc0 ls0 ws0">fstat<span class="_ _80"> </span><span class="ff19">and the lock call.)</span></div><div class="t m0 x3f h50 y3cb0 ff19 fs29 fc0 sc0 ls0 ws0">Consider the following sequence of steps:</div><div class="t m0 x3f h62 y3cb1 ff1a fs30 fc0 sc0 ls0 ws0">writew_lock(fd, 0, SEEK_END, 0);</div><div class="t m0 x3f h62 y3cb2 ff1a fs30 fc0 sc0 ls0 ws0">write(fd, buf, 1);</div><div class="t m0 x3f h62 y3cb3 ff1a fs30 fc0 sc0 ls0 ws0">un_lock(fd, 0, SEEK_END);</div><div class="t m0 x3f h62 y3cb4 ff1a fs30 fc0 sc0 ls0 ws0">write(fd, buf, 1);</div><div class="t m0 x32 h50 y3cb5 ff19 fs29 fc0 sc0 ls0 ws0">This <span class="_ _9"></span>sequence <span class="_ _9"></span>of <span class="_ _9"></span>code <span class="_ _23"></span>might <span class="_ _9"></span>not <span class="_ _9"></span>do <span class="_ _9"></span>what <span class="_ _23"></span>you <span class="_ _9"></span>expect.<span class="_ _5a"> </span>It <span class="_ _9"></span>obtains <span class="_ _9"></span>a <span class="_ _23"></span>write <span class="_ _9"></span>lock <span class="_ _9"></span>from <span class="_ _9"></span>the</div><div class="t m0 x32 h50 y3cb6 ff19 fs29 fc0 sc0 ls0 ws0">current <span class="_ _9"></span>end <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _9"></span>ﬁle <span class="_ _23"> </span>onward, <span class="_ _9"></span>covering <span class="_ _23"> </span>any <span class="_ _23"></span>futur<span class="ls1006">ed<span class="_ _43"></span><span class="ls0">ata <span class="_ _23"></span>we <span class="_ _23"></span>might <span class="_ _9"></span>append <span class="_ _23"> </span>to <span class="_ _23"> </span>the <span class="_ _23"></span>ﬁle.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
