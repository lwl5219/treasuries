<div id="pf185" class="pf w4 h1f" data-page-no="185"><div class="pc pc185 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg185.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h7a ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>10.15<span class="_ _197"> </span><span class="ff1a">sigsetjmp<span class="_ _4b"> </span></span>and<span class="_ _4b"> </span><span class="ff1a">siglongjmp<span class="_ _4b"> </span></span>Functions<span class="_ _1b"> </span><span class="ff18">355</span></div><div class="t m0 x35 h26 y12f ff16 fsf fc0 sc0 ls0 ws0">Example <span class="_ _84"></span>—<span class="_ _9"></span><span class="ff1f">signal_intr<span class="_ _66"> </span></span>Function</div><div class="t m0 x32 h26 y131 ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="lscbf">e1<span class="_ _52"></span><span class="ls0">0.19 <span class="_ _35"> </span>shows <span class="_ _35"> </span>a <span class="_ _35"> </span>version <span class="_ _35"> </span>of <span class="_ _35"> </span>the<span class="_ _51"> </span><span class="ff1a">signal<span class="_ _51"> </span></span>function <span class="_ _35"> </span>that <span class="_ _35"> </span>tries <span class="_ _35"> </span>to <span class="_ _35"> </span>prevent <span class="_ _45"> </span>any</span></span></div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">interrupted system calls fr<span class="_ _0"></span>om being restarted.</div><div class="t m0 x32 h4e y2d71 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y2d72 ff1a fs28 fc0 sc0 ls0 ws0">Sigfunc *</div><div class="t m0 x32 h4e y2d73 ff1a fs28 fc0 sc0 ls0 ws0">signal_intr(int signo, Sigfunc *func)</div><div class="t m0 x32 h4e y2d74 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y2d75 ff1a fs28 fc0 sc0 ls0 ws0">struct sigaction<span class="_ _15"> </span>act, oact;</div><div class="t m0 x8a h4e y2d76 ff1a fs28 fc0 sc0 ls0 ws0">act.sa_handler = func;</div><div class="t m0 x8a h4e y2d77 ff1a fs28 fc0 sc0 ls0 ws0">sigemptyset(&amp;act.sa_mask);</div><div class="t m0 x8a h4e y2d78 ff1a fs28 fc0 sc0 ls0 ws0">act.sa_flags = 0;</div><div class="t m0 x32 h4e y2d79 ff1a fs28 fc0 sc0 ls0 ws0">#ifdef <span class="_"> </span>SA_INTERRUPT</div><div class="t m0 x8a h4e y2d7a ff1a fs28 fc0 sc0 ls0 ws0">act.sa_flags |= SA_INTERRUPT;</div><div class="t m0 x32 h4e y2d7b ff1a fs28 fc0 sc0 ls0 ws0">#endif</div><div class="t m0 x8a h4e y2d7c ff1a fs28 fc0 sc0 ls0 ws0">if (sigaction(signo, &amp;act, &amp;oact) &lt; 0)</div><div class="t m0 x9d h4e y2d7d ff1a fs28 fc0 sc0 ls0 ws0">return(SIG_ERR);</div><div class="t m0 x8a h4e y2d7e ff1a fs28 fc0 sc0 ls0 ws0">return(oact.sa_handler);</div><div class="t m0 x32 h4e y2d7f ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x1d2 h4f y2d80 ff18 fs11 fc0 sc0 ls0 ws0">Figure 10.19<span class="_ _5a"> </span><span class="ff19">The<span class="_"> </span><span class="ff1a">signal_intr<span class="_ _e"> </span></span>function</span></div><div class="t m0 x32 h54 y2d81 ff19 fs2c fc0 sc0 ls0 ws0">For <span class="_ _2"></span>improved <span class="_ _2"></span>portability<span class="_ _6"></span>,<span class="_ _47"> </span>we<span class="_ _47"> </span>specify <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">SA_INTERRUPT<span class="_ _47"> </span></span>ﬂag, <span class="_ _3"></span>if <span class="_ _3"></span>deﬁned <span class="_ _3"></span>by <span class="_ _2"></span>the <span class="_ _3"></span>system,</div><div class="t m0 x32 h55 y2d82 ff19 fs2c fc0 sc0 ls0 ws0">to prevent interr<span class="_ _0"></span>upted system calls from being r<span class="_ _0"></span>estarted.</div><div class="t m0 x35 h93 y2d83 ff16 fs2e fc0 sc0 ls0 ws0">10.15<span class="_ _5a"> </span><span class="ff1f">sigsetjmp<span class="_ _54"> </span></span>and<span class="_ _54"> </span><span class="ff1f">siglongjmp<span class="_ _65"> </span></span>Functions</div><div class="t m0 x32 h5c y2d84 ff19 fs29 fc0 sc0 ls0 ws0">In <span class="_ _9"></span>Section <span class="_ _23"></span>7.10, <span class="_ _23"></span>we <span class="_ _9"></span>described <span class="_ _23"></span>the<span class="_ _45"> </span><span class="ff1a">setjmp<span class="_ _35"> </span></span>and<span class="_ _45"> </span><span class="ff1a">longjmp<span class="_ _45"> </span></span>functions, <span class="_ _23"></span>which <span class="_ _23"></span>can <span class="_ _9"></span>be <span class="_ _23"></span>used</div><div class="t m0 x32 h5c y2d85 ff19 fs29 fc0 sc0 ls0 ws0">for <span class="_ _3"></span>nonlocal <span class="_ _9"></span>branching.<span class="_ _16"> </span>The<span class="_ _45"> </span><span class="ff1a">longjmp<span class="_ _45"> </span></span>function <span class="_ _3"></span>is <span class="_ _9"></span>often <span class="_ _3"></span>called <span class="_ _9"></span>from <span class="_ _3"></span>a <span class="_ _3"></span>signal <span class="_ _9"></span>handler <span class="_ _9"></span>to</div><div class="t m0 x32 h50 y2d86 ff19 fs29 fc0 sc0 lsdf ws0">re<span class="ls0">turn <span class="_ _23"> </span>to <span class="_ _23"></span>the <span class="_ _23"></span>main <span class="_ _9"></span>loop <span class="_ _23"> </span>of <span class="_ _23"> </span>a <span class="_ _23"></span>program, <span class="_ _9"></span>instead <span class="_ _23"></span>of <span class="_ _23"></span>returning <span class="_ _9"></span>from <span class="_ _9"></span>the <span class="_ _23"> </span>handler<span class="_ _1"></span><span class="lscc0">.W<span class="_ _64"></span><span class="lscc1">es<span class="_ _b"></span><span class="ls0">aw</span></span></span></span></div><div class="t m0 x32 h50 y2d87 ff19 fs29 fc0 sc0 ls0 ws0">this approach in Figur<span class="_ _0"></span>es 10.8 and 10.1<span class="_ _1"></span>1.</div><div class="t m0 x3f h5c y2d88 ff19 fs29 fc0 sc0 ls0 ws0">There<span class="_ _4b"> </span>is<span class="_ _4b"> </span>a<span class="_ _59"> </span>p<span class="lsdf">ro</span>blem <span class="_ _e"> </span>in <span class="_"> </span>calling<span class="_ _44"> </span><span class="ff1a">longjmp</span><span class="lscc2">,h<span class="_ _55"></span><span class="ls0">owever<span class="_ _1"></span><span class="lscc3">.W<span class="_ _64"></span><span class="ls0">hen <span class="_ _e"> </span>a <span class="_"> </span>signal <span class="_ _53"> </span>is <span class="_ _e"> </span>caught, <span class="_"> </span>the</span></span></span></span></div><div class="t m0 x32 h50 y2d89 ff19 fs29 fc0 sc0 ls0 ws0">signal-catching function is entered, with the current signal automatically being <span class="_ _2"></span>added to</div><div class="t m0 x32 h50 y2d8a ff19 fs29 fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>signal <span class="_ _53"> </span>mask <span class="_ _e"> </span>of <span class="_ _53"> </span>the <span class="_ _e"> </span>process. <span class="_ _44"> </span>This<span class="_ _4b"> </span>prevents <span class="_ _42"> </span>subsequent <span class="_ _e"> </span>occurrences <span class="_ _53"> </span>of <span class="_ _53"> </span>that <span class="_ _53"> </span>signal</div><div class="t m0 x32 h5c y2d8b ff19 fs29 fc0 sc0 ls0 ws0">from <span class="_ _23"></span>interrupting <span class="_ _23"> </span>the <span class="_ _42"> </span>signal <span class="_ _42"> </span>handler<span class="_ _6"></span><span class="lscc4">.I<span class="_ _7"></span><span class="lscc5">fw<span class="_ _43"></span><span class="ls0">e<span class="_ _44"> </span><span class="ff1a">longjmp<span class="_ _35"> </span></span>out <span class="_ _42"> </span>of <span class="_ _23"> </span>the <span class="_ _42"> </span>signal <span class="_ _42"> </span>handler<span class="_ _6"></span><span class="lscc6">,w<span class="_ _43"></span><span class="ls0">hat</span></span></span></span></span></div><div class="t m0 x32 h50 y2d8c ff19 fs29 fc0 sc0 ls0 ws0">happens to the signal mask for the process?</div><div class="t m0 x76 h6d y2d8d ff19 fs12 fc0 sc0 ls0 ws0">Under <span class="_ _9"></span>FreeBSD <span class="_ _9"></span>8.0 <span class="_ _23"> </span>and <span class="_ _9"></span>Mac <span class="_ _9"> </span>OS <span class="_ _23"> </span>X <span class="_ _9"></span>10.6.8,<span class="_ _47"> </span><span class="ff1a">setjmp<span class="_ _47"> </span></span>and<span class="_ _47"> </span><span class="ff1a">longjmp<span class="_ _47"> </span></span>save <span class="_ _23"> </span>and <span class="_ _9"></span>restor<span class="lscc7">et<span class="_ _b"></span><span class="ls0">he <span class="_ _23"> </span>signal</span></span></div><div class="t m0 x76 h2f y2d8e ff19 fs12 fc0 sc0 ls0 ws0">mask. <span class="_ _80"> </span>Linux<span class="_ _80"> </span>3.2.0 <span class="_ _2"></span>and <span class="_ _2"></span>Solaris <span class="_ _3"></span>10, <span class="_ _2"></span>however<span class="_ _1"></span><span class="lscc8">,d<span class="_ _5"></span><span class="lscc9">on<span class="_ _5"></span><span class="ls0">ot <span class="_ _2"></span>do <span class="_ _2"></span>this, <span class="_ _3"></span>although <span class="_ _2"></span>Linux <span class="_ _3"></span>supports <span class="_ _2"></span>an <span class="_ _2"></span>option</span></span></span></div><div class="t m0 x76 h6d y2d8f ff19 fs12 fc0 sc0 ls0 ws0">to <span class="_ _80"> </span>provide <span class="_ _80"> </span>BSD <span class="_ _80"> </span>behavior<span class="_ _1"></span><span class="lscca">.F<span class="_ _7"></span><span class="ls222">re<span class="ls0">eBSD <span class="_ _66"> </span>and <span class="_ _80"> </span>Mac <span class="_ _80"> </span>OS <span class="_ _80"> </span>X <span class="_ _80"> </span>provide <span class="_ _80"> </span>the <span class="_ _80"> </span>functions<span class="_ _4b"> </span><span class="ff1a">_setjmp<span class="_ _4b"> </span></span>and</span></span></span></div><div class="t m0 x76 h6d y2d90 ff1a fs12 fc0 sc0 ls0 ws0">_longjmp<span class="ff19 ls38a">,w<span class="_ _84"></span><span class="ls0">hich do not save and restor<span class="_ _0"></span><span class="ls38a">et<span class="_ _84"></span><span class="ls0">he signal mask.</span></span></span></span></div><div class="t m0 x3f h5c y2d91 ff19 fs29 fc0 sc0 lse2 ws0">To <span class="_ _53"> </span>a<span class="_ _23"></span><span class="ls0">llow either <span class="_ _2"></span>form of <span class="_ _2"></span>behavior<span class="_ _1"></span><span class="lsccb">,P<span class="_ _4f"></span><span class="ls0">OSIX.1 <span class="_ _2"></span>does <span class="_ _2"></span>not specify <span class="_ _2"></span>the <span class="_ _2"></span>effect of<span class="_"> </span><span class="ff1a">setjmp<span class="_ _66"> </span></span>and</span></span></span></div><div class="t m0 x32 h5c y2d92 ff1a fs29 fc0 sc0 ls0 ws0">longjmp<span class="_ _47"> </span><span class="ff19">on <span class="_ _2"></span>signal <span class="_ _2"></span>masks.<span class="_ _16"> </span>Instead, <span class="_ _2"></span>two <span class="_ _3"></span>new <span class="_ _2"></span>functions,<span class="_ _47"> </span></span>sigsetjmp<span class="_ _47"> </span><span class="ff19">and<span class="_ _47"> </span></span>siglongjmp<span class="ff19">,</span></div><div class="t m0 x32 h50 y2d93 ff19 fs29 fc0 sc0 ls0 ws0">ar<span class="lsccc">ed<span class="_ _43"></span><span class="ls0">eﬁned <span class="_ _23"></span>by <span class="_ _23"></span>POSIX.1.<span class="_ _5a"> </span>These <span class="_ _23"></span>two <span class="_ _23"></span>functions <span class="_ _9"></span>should <span class="_ _23"></span>always <span class="_ _23"></span>be <span class="_ _9"></span>used <span class="_ _23"> </span>when <span class="_ _23"></span>branching</span></span></div><div class="t m0 x32 h50 y2d94 ff19 fs29 fc0 sc0 ls0 ws0">from a signal handler<span class="_ _6"></span>.</div><a class="l" href="#pf10" data-dest-detail='[16,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.893259px;bottom:589.192834px;width:271.488388px;height:19.679992px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
