<div id="pf35c" class="pf w4 h1f" data-page-no="35c"><div class="pc pc35c w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg35c.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">826<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">414 <span class="_ _186"> </span>nw<span class="_"> </span><span class="ls15c">=w<span class="_ _1d"></span><span class="ls0">rite(fd, buf, nr);</span></span></div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">415 <span class="_ _186"> </span>if<span class="_"> </span>(nw != nr) {</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">416 <span class="_ _82"> </span>res.jobid<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">417 <span class="_ _82"> </span>if<span class="_"> </span>(nw &lt; 0)</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">418 <span class="_ _1e7"> </span>res.retcode<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(errno);</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">419 <span class="_ _82"> </span>else</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">420 <span class="_ _1e7"> </span>res.retcode<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(EIO);</span></span></div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">421 <span class="_ _82"> </span>log_msg(&quot;client_thread:<span class="_"> </span>can’t write %s: %s&quot;, name,</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">422 <span class="_ _12d"> </span>strerror(res.retcode));</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">423 <span class="_ _82"> </span>close(fd);</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">424 <span class="_ _82"> </span>strncpy(res.msg,<span class="_"> </span>strerror(res.retcode), MSGLEN_MAX);</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">425 <span class="_ _82"> </span>writen(sockfd,<span class="_"> </span>&amp;res, sizeof(struct printresp));</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">426 <span class="_ _82"> </span>unlink(name);</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">427 <span class="_ _82"> </span>pthread_exit((void<span class="_"> </span>*)1);</div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">428 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y56d0 ff1a fs2d fc0 sc0 ls0 ws0">429 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y56d1 ff1a fs2d fc0 sc0 ls0 ws0">430 <span class="_ _15"> </span>close(fd);</div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">431 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">432 <span class="_ _8a"> </span>*<span class="_"> </span>Create the control file.<span class="_ _d9"> </span>Then write the</div><div class="t m0 x32 h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">433 <span class="_ _8a"> </span>*<span class="_"> </span>print request information to the control</div><div class="t m0 x32 h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">434 <span class="_ _8a"> </span>*<span class="_"> </span>file.</div><div class="t m0 x32 h57 y57b4 ff1a fs2d fc0 sc0 ls0 ws0">435 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y419b ff1a fs2d fc0 sc0 ls0 ws0">436 <span class="_ _15"> </span>sprintf(name,<span class="_"> </span>&quot;%s/%s/%d&quot;, SPOOLDIR, REQDIR, jobid);</div><div class="t m0 x32 h57 y419c ff1a fs2d fc0 sc0 ls0 ws0">437 <span class="_ _15"> </span>fd<span class="_"> </span><span class="ls15c">=c<span class="_ _1d"></span><span class="ls0">reat(name, FILEPERM);</span></span></div><div class="t m0 x32 h57 y5bef ff1a fs2d fc0 sc0 ls0 ws0">438 <span class="_ _15"> </span>if<span class="_"> </span>(fd &lt; 0) {</div><div class="t m0 x32 h57 y5bf0 ff1a fs2d fc0 sc0 ls0 ws0">439 <span class="_ _186"> </span>res.jobid<span class="_"> </span><span class="ls15c">=0<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y5bf1 ff1a fs2d fc0 sc0 ls0 ws0">440 <span class="_ _186"> </span>res.retcode<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(errno);</span></span></div><div class="t m0 x32 h57 y568e ff1a fs2d fc0 sc0 ls0 ws0">441 <span class="_ _186"> </span>log_msg(&quot;client_thread:<span class="_"> </span>can’t create %s: %s&quot;, name,</div><div class="t m0 x32 h57 y5bf2 ff1a fs2d fc0 sc0 ls0 ws0">442 <span class="_ _74"> </span>strerror(res.retcode));</div><div class="t m0 x32 h57 y5bf3 ff1a fs2d fc0 sc0 ls0 ws0">443 <span class="_ _186"> </span>strncpy(res.msg,<span class="_"> </span>strerror(res.retcode), MSGLEN_MAX);</div><div class="t m0 x32 h57 y5bf4 ff1a fs2d fc0 sc0 ls0 ws0">444 <span class="_ _186"> </span>writen(sockfd,<span class="_"> </span>&amp;res, sizeof(struct printresp));</div><div class="t m0 x32 h57 y5bf5 ff1a fs2d fc0 sc0 ls0 ws0">445 <span class="_ _186"> </span>sprintf(name,<span class="_"> </span>&quot;%s/%s/%d&quot;, SPOOLDIR, DATADIR, jobid);</div><div class="t m0 x32 h57 y5bf6 ff1a fs2d fc0 sc0 ls0 ws0">446 <span class="_ _186"> </span>unlink(name);</div><div class="t m0 x32 h57 y5bf7 ff1a fs2d fc0 sc0 ls0 ws0">447 <span class="_ _186"> </span>pthread_exit((void<span class="_"> </span>*)1);</div><div class="t m0 x32 h57 y5c10 ff1a fs2d fc0 sc0 ls0 ws0">448 <span class="_ _15"> </span>}</div><div class="t m0 x32 h4d y57eb ff19 fs26 fc0 sc0 ls0 ws0">[414 <span class="_ _a"></span>– <span class="_ _a"></span>430]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>w<span class="_ _9"></span></span>rite <span class="_ _2"></span>the data <span class="_ _2"></span>that we read from the client <span class="_ _2"></span>to the <span class="_ _2"></span>data ﬁle.<span class="_ _46"> </span>If<span class="_ _66"> </span><span class="ff1a">write<span class="_ _66"> </span></span>fails,</div><div class="t m0 x11a h49 y57ec ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _23"></span>log <span class="_ _23"></span>an <span class="_ _23"></span>error <span class="_ _9"></span>message, <span class="_ _23"> </span>close <span class="_ _23"> </span>the <span class="_ _23"> </span>ﬁle <span class="_ _23"> </span>descriptor <span class="_ _23"> </span>for <span class="_ _23"> </span>the <span class="_ _23"> </span>data <span class="_ _23"> </span>ﬁle, <span class="_ _23"> </span>send <span class="_ _23"> </span>an</div><div class="t m0 x11a h49 y57ed ff19 fs26 fc0 sc0 ls0 ws0">error message back to the client, delete the data ﬁle, and terminate the thr<span class="_ _0"></span>ead</div><div class="t m0 x11a h4d y57ee ff19 fs26 fc0 sc0 ls0 ws0">by <span class="_ _23"></span>calling<span class="_ _45"> </span><span class="ff1a">pthread_exit</span><span class="ls17aa">.N<span class="_ _26"></span><span class="ls0">ote <span class="_ _23"></span>that <span class="_ _23"></span>we <span class="_ _9"></span>do <span class="_ _23"> </span>not <span class="_ _23"></span>explicitly <span class="_ _23"></span>close <span class="_ _9"></span>the <span class="_ _23"></span>socket</span></span></div><div class="t m0 x11a h49 y57ef ff19 fs26 fc0 sc0 ls0 ws0">ﬁle <span class="_ _3"></span>descriptor<span class="_ _1"></span><span class="ls17ab">.T<span class="_ _62"></span><span class="ls0">his <span class="_ _9"></span>is <span class="_ _3"></span>done <span class="_ _9"></span>for <span class="_ _3"></span>us <span class="_ _9"></span>by <span class="_ _3"></span>our <span class="_ _9"></span>thread <span class="_ _2"></span>cleanup <span class="_ _9"></span>handler <span class="_ _3"></span>as <span class="_ _9"></span>part <span class="_ _3"></span>of</span></span></div><div class="t m0 x11a h4d y57f0 ff19 fs26 fc0 sc0 ls0 ws0">the processing that occurs when we call<span class="_"> </span><span class="ff1a">pthread_exit</span>.</div><div class="t m0 x11a h49 y5c11 ff19 fs26 fc0 sc0 ls0 ws0">When <span class="_ _23"></span>we <span class="_ _9"></span>receive <span class="_ _9"></span>all <span class="_ _23"> </span>the <span class="_ _23"></span>data <span class="_ _23"></span>to <span class="_ _9"></span>be <span class="_ _23"> </span>printed, <span class="_ _23"></span>we <span class="_ _23"></span>close <span class="_ _9"></span>the <span class="_ _23"> </span>ﬁle <span class="_ _23"></span>descriptor <span class="_ _23"></span>for</div><div class="t m0 x11a h49 y5c12 ff19 fs26 fc0 sc0 ls0 ws0">the data ﬁle.</div><div class="t m0 x32 h4d y5c13 ff19 fs26 fc0 sc0 ls0 ws0">[431 <span class="_ _a"></span>– <span class="_ _a"></span>448]<span class="_ _65"> </span>Next, we <span class="_ _2"></span>create a <span class="_ _2"></span>ﬁle,<span class="_ _66"> </span><span class="ff1a">/var/spool/printer/reqs/<span class="ff1b">jobid</span></span>,<span class="_ _66"> </span>to<span class="_ _66"> </span>remember the</div><div class="t m0 x11a h49 y5c14 ff19 fs26 fc0 sc0 ls0 ws0">print request. <span class="_"> </span>If<span class="_"> </span>this fails, we log an error message, send an error r<span class="_ _0"></span>esponse to</div><div class="t m0 x11a h49 y5c15 ff19 fs26 fc0 sc0 ls0 ws0">the client, remove the data ﬁle, and terminate the thr<span class="_ _0"></span>ead.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
