<div id="pf1de" class="pf w4 h1f" data-page-no="1de"><div class="pc pc1de w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1de.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">444<span class="_ _1b"> </span><span class="ff19">Thread <span class="_"> </span>Contr<span class="_ _0"></span>ol <span class="_ _177"> </span>Chapter<span class="_ _44"> </span>12</span></div><div class="t m0 x3f h57 y1295 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;stdio.h&gt;</div><div class="t m0 x3f h57 y1601 ff1a fs2d fc0 sc0 ls0 ws0">int getchar_unlocked(void);</div><div class="t m0 x3f h57 y1602 ff1a fs2d fc0 sc0 ls0 ws0">int getc_unlocked(FILE *<span class="ff1b">fp</span>);</div><div class="t m0 xf3 h57 y1603 ff19 fs2d fc0 sc0 ls0 ws0">Both return: the next character if OK,<span class="_"> </span><span class="ff1a">EOF<span class="_ _e"> </span></span>on end of ﬁle or error</div><div class="t m0 x3f h57 y1604 ff1a fs2d fc0 sc0 ls0 ws0">int putchar_unlocked(int<span class="_"> </span><span class="ff1b">c</span>);</div><div class="t m0 x3f h57 y1605 ff1a fs2d fc0 sc0 ls0 ws0">int putc_unlocked(int<span class="_"> </span><span class="ff1b">c</span><span class="ls15c">,F<span class="_ _1d"></span><span class="ls0">ILE *<span class="ff1b">fp</span>);</span></span></div><div class="t m0 x73 h57 y3754 ff19 fs2d fc0 sc0 ls0 ws0">Both return:<span class="_"> </span><span class="ff1b">c<span class="_"> </span></span>if OK,<span class="_"> </span><span class="ff1a">EOF<span class="_ _e"> </span></span>on error</div><div class="t m0 x3f h49 y3755 ff19 fs26 fc0 sc0 ls0 ws0">These <span class="_ _42"> </span>four <span class="_ _23"> </span>functions <span class="_ _42"> </span>should <span class="_ _42"> </span>not <span class="_ _42"> </span>be <span class="_ _42"> </span>called <span class="_ _42"> </span>unless <span class="_ _42"> </span>they <span class="_ _23"> </span>ar<span class="lsaa9">es<span class="_ _43"></span><span class="ls0">urrounded <span class="_ _23"> </span>by <span class="_ _42"> </span>calls <span class="_ _42"> </span>to</span></span></div><div class="t m0 x32 h4d y3756 ff1a fs26 fc0 sc0 ls0 ws0">flockfile<span class="_ _47"> </span><span class="ff19">(or<span class="_ _47"> </span></span>ftrylockfile<span class="ff19 lsedf">)a<span class="_ _8"></span><span class="ls0">nd<span class="_ _47"> </span><span class="ff1a">funlockfile</span><span class="lsee0">.O<span class="_ _1d"></span><span class="ls0">therwise, <span class="_ _3"></span>unpredictable <span class="_ _2"></span>results</span></span></span></span></div><div class="t m0 x32 h49 y3757 ff19 fs26 fc0 sc0 ls0 ws0">can <span class="_ _2"></span>occur <span class="_ _3"></span>(i.e., <span class="_ _3"></span>the <span class="_ _3"></span>types <span class="_ _3"></span>of <span class="_ _3"></span>problems <span class="_ _2"></span>that <span class="_ _3"></span>result <span class="_ _3"></span>from <span class="_ _2"></span>unsynchronized <span class="_ _2"></span>access <span class="_ _3"></span>to <span class="_ _3"></span>data <span class="_ _3"></span>by</div><div class="t m0 x32 h49 y3758 ff19 fs26 fc0 sc0 ls0 ws0">multiple threads of contr<span class="_ _0"></span>ol).</div><div class="t m0 x3f h4d y3759 ff19 fs26 fc0 sc0 ls0 ws0">Once <span class="_ _e"> </span>you <span class="_"> </span>lock <span class="_ _53"> </span>the<span class="_ _59"> </span><span class="ff1a">FILE<span class="_ _59"> </span></span>object, <span class="_ _e"> </span>you <span class="_"> </span>can <span class="_ _53"> </span>make <span class="_"> </span>multiple <span class="_ _53"> </span>calls <span class="_"> </span>to <span class="_ _e"> </span>these <span class="_ _e"> </span>functions</div><div class="t m0 x32 h49 y375a ff19 fs26 fc0 sc0 ls0 ws0">befor<span class="lsee1">er<span class="_ _55"></span><span class="ls0">eleasing <span class="_ _42"> </span>the <span class="_ _53"> </span>lock.<span class="_ _65"> </span>This <span class="_ _42"> </span>amortizes <span class="_ _53"> </span>the <span class="_ _53"> </span>locking <span class="_ _42"> </span>overhead <span class="_ _42"> </span>across <span class="_ _42"> </span>the <span class="_ _53"> </span>amount <span class="_ _53"> </span>of</span></span></div><div class="t m0 x32 h49 y375b ff19 fs26 fc0 sc0 ls0 ws0">data read or written.</div><div class="t m0 x35 h4c y375c ff16 fs26 fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h4d y375d ff19 fs26 fc0 sc0 ls0 ws0">Figur<span class="lsee2">e1<span class="_ _b"></span><span class="ls0">2.1<span class="_ _1"></span><span class="lsee2">1s<span class="_ _b"></span><span class="ls0">hows <span class="_ _9"></span>a <span class="_ _9"></span>possible <span class="_ _9"></span>implementation <span class="_ _9"></span>of<span class="_ _45"> </span><span class="ff1a">getenv<span class="_ _47"> </span></span>(Section <span class="_ _9"></span>7.9).<span class="_ _5a"> </span>This <span class="_ _9"></span>version <span class="_ _9"></span>is</span></span></span></span></div><div class="t m0 x32 h49 y375e ff19 fs26 fc0 sc0 ls0 ws0">not <span class="_ _9"></span>reentrant. <span class="_ _47"> </span>If<span class="_ _45"> </span>two <span class="_ _9"></span>threads <span class="_ _3"></span>call <span class="_ _9"></span>it <span class="_ _9"></span>at <span class="_ _3"></span>the <span class="_ _9"></span>same <span class="_ _9"></span>time, <span class="_ _9"></span>they <span class="_ _9"></span>will <span class="_ _9"></span>see <span class="_ _9"></span>inconsistent <span class="_ _9"></span>results,</div><div class="t m0 x32 h49 y375f ff19 fs26 fc0 sc0 ls0 ws0">because the <span class="_ _2"></span>string <span class="_ _2"></span>returned is <span class="_ _2"></span>stored in <span class="_ _2"></span>a single <span class="_ _2"></span>static <span class="_ _2"></span>buffer that <span class="_ _2"></span>is <span class="_ _2"></span>shared by <span class="_ _2"></span>all threads</div><div class="t m0 x32 h4d y3760 ff19 fs26 fc0 sc0 ls0 ws0">calling<span class="_"> </span><span class="ff1a">getenv</span>.</div><div class="t m0 x32 h5d y3761 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;limits.h&gt;</div><div class="t m0 x32 h5d y3762 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;string.h&gt;</div><div class="t m0 x32 h5d y3763 ff1a fs2f fc0 sc0 ls0 ws0">#define MAXSTRINGSZ 4096</div><div class="t m0 x32 h5d y3764 ff1a fs2f fc0 sc0 ls0 ws0">static char envbuf[MAXSTRINGSZ];</div><div class="t m0 x32 h5d y3765 ff1a fs2f fc0 sc0 ls0 ws0">extern char **environ;</div><div class="t m0 x32 h5d y3766 ff1a fs2f fc0 sc0 ls0 ws0">char *</div><div class="t m0 x32 h5d y3767 ff1a fs2f fc0 sc0 ls0 ws0">getenv(const char *name)</div><div class="t m0 x32 h5d y3768 ff1a fs2f fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h5d y3769 ff1a fs2f fc0 sc0 ls0 ws0">int i, len;</div><div class="t m0 x8a h5d y376a ff1a fs2f fc0 sc0 ls0 ws0">len = strlen(name);</div><div class="t m0 x8a h5d y376b ff1a fs2f fc0 sc0 ls0 ws0">for (i = 0; environ[i] != NULL; i++) {</div><div class="t m0 x9d h5d y376c ff1a fs2f fc0 sc0 ls0 ws0">if ((strncmp(name, environ[i], len) == 0) &amp;&amp;</div><div class="t m0 x76 h5d y376d ff1a fs2f fc0 sc0 ls0 ws0">(environ[i][len] == ’=’)) {</div><div class="t m0 x1f h5d y376e ff1a fs2f fc0 sc0 ls0 ws0">strncpy(envbuf, &amp;environ[i][len+1], MAXSTRINGSZ-1);</div><div class="t m0 x1f h5d y376f ff1a fs2f fc0 sc0 ls0 ws0">return(envbuf);</div><div class="t m0 x9d h5d y3770 ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h5d y3771 ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h5d y3772 ff1a fs2f fc0 sc0 ls0 ws0">return(NULL);</div><div class="t m0 x32 h5d y3773 ff1a fs2f fc0 sc0 ls0 ws0">}</div><div class="t m0 x1d0 h6d y3774 ff18 fs12 fc0 sc0 ls0 ws0">Figure 12.1<span class="_ _0"></span>1<span class="_ _54"> </span><span class="ff19 ls38a">An<span class="_ _84"></span><span class="ls0">onreentrant version of<span class="_"> </span><span class="ff1a">getenv</span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
