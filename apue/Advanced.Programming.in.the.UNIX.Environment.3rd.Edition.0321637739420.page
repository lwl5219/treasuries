<div id="pf1a4" class="pf w4 h1f" data-page-no="1a4"><div class="pc pc1a4 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg1a4.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">386<span class="_ _1b"> </span><span class="ff19">Threads <span class="_ _24b"> </span>Chapter<span class="_ _78"> </span><span class="ls7ed">11</span></span></div><div class="t m0 xe2 h51 y3121 ff19 fs2a fc0 sc0 ls0 ws0">thread</div><div class="t m0 x2d h51 y3122 ff19 fs2a fc0 sc0 ls0 ws0">2</div><div class="t m0 x54 h2d y3123 ff19 fs10 fc0 sc0 ls0 ws0">thread</div><div class="t m0 x50 h2d y3124 ff19 fs10 fc0 sc0 ls0 ws0">1</div><div class="t m0 x54 h2e y3125 ff19 fs11 fc0 sc0 ls0 ws0">thread</div><div class="t m0 x50 h2e y3126 ff19 fs11 fc0 sc0 ls0 ws0">3</div><div class="t m0 x66 h2f y3127 ff19 fs12 fc0 sc0 ls0 ws0">work</div><div class="t m0 x59 h2f y3128 ff19 fs12 fc0 sc0 ls0 ws0">queue</div><div class="t m0 x92 h31 y3129 ff19 fs14 fc0 sc0 ls0 ws0">job</div><div class="t m0 x67 h32 y312a ff19 fs15 fc0 sc0 ls0 ws0">TID 1</div><div class="t m0 x212 h83 y312b ff19 fs36 fc0 sc0 ls0 ws0">job</div><div class="t m0 x81 h34 y312c ff19 fs17 fc0 sc0 ls0 ws0">TID 3</div><div class="t m0 x111 h36 y312d ff19 fs19 fc0 sc0 ls0 ws0">job</div><div class="t m0 x213 h37 y312e ff19 fs1a fc0 sc0 ls0 ws0">TID 2</div><div class="t m0 xfa h39 y312f ff19 fs1c fc0 sc0 ls0 ws0">job</div><div class="t m0 x19f h88 y3130 ff19 fs43 fc0 sc0 ls0 ws0">TID 3</div><div class="t m0 x9c h3c y3131 ff19 fs1e fc0 sc0 ls0 ws0">master</div><div class="t m0 x9c h3c y3132 ff19 fs1e fc0 sc0 ls0 ws0">thread</div><div class="t m0 x186 h40 y3133 ff18 fs22 fc0 sc0 ls0 ws0">Figure 1<span class="_ _0"></span>1.1<span class="_ _d9"> </span><span class="ff19 lsd8b">Wo<span class="_ _9"></span><span class="ls0">rk queue example</span></span></div><div class="t m0 x32 h13b y3134 ff19 fsac fc0 sc0 ls0 ws0">The <span class="_ _42"> </span>memory <span class="_ _42"> </span>location <span class="_ _53"> </span>pointed <span class="_ _42"> </span>to <span class="_ _42"> </span>by<span class="_ _44"> </span><span class="ff1b">tidp<span class="_ _44"> </span></span>is <span class="_ _53"> </span>set <span class="_ _42"> </span>to <span class="_ _42"> </span>the <span class="_ _53"> </span>thread <span class="_ _42"> </span>ID <span class="_ _42"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>newly <span class="_ _53"> </span>created</div><div class="t m0 x32 h13c y3135 ff19 fsac fc0 sc0 ls0 ws0">thread <span class="_"> </span>when<span class="_ _46"> </span><span class="ff1a">pthread_create<span class="_ _46"> </span></span><span class="lsd8c">re<span class="_ _2"></span></span>turns <span class="_ _66"> </span>successfully<span class="_ _6"></span><span class="lsd8d">.T<span class="_ _49"></span><span class="ls0">he<span class="_ _46"> </span><span class="ff1b">attr<span class="_ _61"> </span></span>argument <span class="_"> </span>is <span class="_"> </span>used <span class="_ _66"> </span>to</span></span></div><div class="t m0 x32 h13d y3136 ff19 fsac fc0 sc0 ls0 ws0">customize <span class="_ _23"> </span>various <span class="_ _42"> </span>thread <span class="_ _23"></span>attributes.<span class="_ _51"> </span><span class="lsd8e">We<span class="_ _9"></span></span>’ll <span class="_ _42"> </span>cover <span class="_ _23"> </span>thread <span class="_ _23"> </span>attributes <span class="_ _42"> </span>in <span class="_ _23"> </span>Section <span class="_ _42"> </span>12.3, <span class="_ _23"> </span>but</div><div class="t m0 x32 h13c y3137 ff19 fsac fc0 sc0 ls0 ws0">for now<span class="_ _6"></span><span class="lsd8f">,w<span class="_ _d"></span><span class="ls0">e’ll set this to<span class="_"> </span><span class="ff1a">NULL<span class="_ _66"> </span></span>to create a thr<span class="_ _1"></span>ead with the default attributes.</span></span></div><div class="t m0 x3f h13b y3138 ff19 fsac fc0 sc0 ls0 ws0">The <span class="_ _53"> </span>newly <span class="_ _53"> </span>created <span class="_ _42"> </span>thread <span class="_ _42"> </span>starts <span class="_ _53"> </span>running <span class="_ _53"> </span>at <span class="_ _53"> </span>the <span class="_ _53"> </span>address <span class="_ _53"> </span>of <span class="_ _53"> </span>the<span class="_ _44"> </span><span class="ff1b">start_rtn<span class="_ _4b"> </span></span>function.</div><div class="t m0 x32 h13b y3139 ff19 fsac fc0 sc0 ls0 ws0">This <span class="_ _9"></span>function <span class="_ _23"></span>takes <span class="_ _9"></span>a <span class="_ _23"></span>single <span class="_ _9"></span>argument,<span class="_ _45"> </span><span class="ff1b">arg</span><span class="lsd90">,w<span class="_ _b"></span><span class="ls0">hich <span class="_ _9"></span>is <span class="_ _9"></span>a <span class="_ _23"></span>typeless <span class="_ _9"></span>pointer<span class="_ _1"></span><span class="lsd91">.I<span class="_ _26"></span><span class="lsd90">fy<span class="_ _b"></span><span class="ls0">ou <span class="_ _23"></span>need <span class="_ _9"></span>to</span></span></span></span></span></div><div class="t m0 x32 h13b y313a ff19 fsac fc0 sc0 ls0 ws0">pass <span class="_ _2"></span>mor<span class="lsd92">et<span class="_ _8"></span><span class="ls0">han <span class="_ _2"></span>one <span class="_ _3"></span>argument to <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1b">start_rtn<span class="_ _66"> </span></span>function, <span class="_ _2"></span>then <span class="_ _2"></span>you <span class="_ _3"></span>need <span class="_ _2"></span>to <span class="_ _2"></span>stor<span class="lsd93">et<span class="_ _4f"></span><span class="ls0">hem <span class="_ _2"></span>in <span class="_ _2"></span>a</span></span></span></span></div><div class="t m0 x32 h13b y313b ff19 fsac fc0 sc0 ls0 ws0">structur<span class="_ _0"></span><span class="lsd8f">ea<span class="_ _d"></span><span class="ls0">nd pass the address of the structur<span class="_ _0"></span><span class="lsd8f">ei<span class="_ _d"></span><span class="ls0">n<span class="_"> </span><span class="ff1b">arg</span>.</span></span></span></span></div><div class="t m0 x3f h13d y313c ff19 fsac fc0 sc0 ls0 ws0">When <span class="_ _53"> </span>a <span class="_"> </span>thr<span class="_ _1"></span>ead <span class="_"> </span>is <span class="_ _53"> </span>created, <span class="_ _53"> </span>there<span class="_ _44"> </span>is<span class="_ _59"> </span>no<span class="_ _4b"> </span>guarantee <span class="_ _e"> </span>which <span class="_ _e"> </span>will <span class="_ _e"> </span>run <span class="_ _53"> </span>ﬁrst: <span class="_ _e"> </span>the <span class="_ _e"> </span>newly</div><div class="t m0 x32 h13d y313d ff19 fsac fc0 sc0 ls0 ws0">created thread <span class="_ _2"></span>or <span class="_ _2"></span>the <span class="_ _2"></span>calling <span class="_ _2"></span>thread. <span class="_ _66"> </span>The<span class="_ _47"> </span>newly <span class="_ _2"></span>created <span class="_ _2"></span>thread has <span class="_ _3"></span>access <span class="_ _2"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>process</div><div class="t m0 x32 h13d y313e ff19 fsac fc0 sc0 ls0 ws0">address <span class="_ _23"> </span>space <span class="_ _42"> </span>and <span class="_ _42"> </span>inherits <span class="_ _42"> </span>the <span class="_ _42"> </span>calling <span class="_ _42"> </span>thread’s <span class="_ _42"> </span>ﬂoating-point <span class="_ _23"> </span>environment <span class="_ _42"> </span>and <span class="_ _42"> </span>signal</div><div class="t m0 x32 h13d y313f ff19 fsac fc0 sc0 ls0 ws0">mask; however<span class="_ _6"></span><span class="lsd8f">,t<span class="_ _5"></span><span class="ls0">he set of pending signals for the thread is clear<span class="_ _1"></span>ed.</span></span></div><div class="t m0 x3f h13d y3140 ff19 fsac fc0 sc0 ls0 ws0">Note <span class="_ _9"></span>that <span class="_ _9"></span>the <span class="_ _9"></span>pthread <span class="_ _3"></span>functions <span class="_ _9"></span>usually <span class="_ _9"></span>return <span class="_ _9"></span>an <span class="_ _9"></span>error <span class="_ _3"></span>code <span class="_ _9"></span>when <span class="_ _9"></span>they <span class="_ _9"></span>fail.<span class="_ _5a"> </span>They</div><div class="t m0 x32 h13c y3141 ff19 fsac fc0 sc0 ls0 ws0">don’t <span class="_"> </span>set<span class="_ _59"> </span><span class="ff1a">errno<span class="_ _46"> </span></span>like <span class="_"> </span>the <span class="_"> </span>other <span class="_"> </span>POSIX <span class="_"> </span>functions.<span class="_ _60"> </span>The <span class="_"> </span>per<span class="_ _0"></span>-thread <span class="_"> </span>copy <span class="_"> </span>of<span class="_ _59"> </span><span class="ff1a">errno<span class="_ _59"> </span></span>is</div><div class="t m0 x32 h13d y3142 ff19 fsac fc0 sc0 ls0 ws0">provided <span class="_ _9"></span>only <span class="_ _23"> </span>for <span class="_ _23"></span>compatibility <span class="_ _23"></span>with <span class="_ _23"></span>existing <span class="_ _23"></span>functions <span class="_ _23"></span>that <span class="_ _9"></span>use <span class="_ _23"> </span>it.<span class="_ _51"> </span><span class="lsd94">Wi<span class="_ _3"></span></span>th <span class="_ _23"> </span>threads, <span class="_ _9"></span>it <span class="_ _23"> </span>is</div><div class="t m0 x32 h13d y3143 ff19 fsac fc0 sc0 ls0 ws0">cleaner <span class="_ _23"></span>to <span class="_ _9"></span>return <span class="_ _23"></span>the <span class="_ _9"></span>error <span class="_ _23"></span>code <span class="_ _9"></span>from <span class="_ _23"></span>the <span class="_ _23"></span>function, <span class="_ _9"></span>thereby <span class="_ _23"></span>restricting <span class="_ _9"></span>the <span class="_ _23"></span>scope <span class="_ _9"></span>of <span class="_ _23"> </span>the</div><div class="t m0 x32 h13d y3144 ff19 fsac fc0 sc0 ls0 ws0">error <span class="_ _e"> </span>to <span class="_"> </span>the <span class="_"> </span>function <span class="_ _e"> </span>that <span class="_"> </span>caused <span class="_ _e"> </span>it, <span class="_"> </span>instead <span class="_"> </span>of <span class="_ _e"> </span>relying <span class="_"> </span>on <span class="_ _e"> </span>some <span class="_"> </span>global <span class="_ _e"> </span>state <span class="_"> </span>that <span class="_"> </span>is</div><div class="t m0 x32 h13d y3145 ff19 fsac fc0 sc0 ls0 ws0">changed as a side effect of the function.</div><div class="t m0 x35 h13e y3146 ff16 fsac fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h13d y3147 ff19 fsac fc0 sc0 ls0 ws0">Although <span class="_ _42"> </span>there<span class="_ _44"> </span>is<span class="_ _44"> </span>no<span class="_ _44"> </span>portable <span class="_ _53"> </span>way <span class="_ _53"> </span>to <span class="_ _42"> </span>print <span class="_ _53"> </span>the <span class="_ _53"> </span>thread <span class="_ _42"> </span>ID, <span class="_ _53"> </span>we <span class="_ _42"> </span>can <span class="_ _53"> </span>write <span class="_ _53"> </span>a <span class="_ _53"> </span>small <span class="_ _42"> </span>test</div><div class="t m0 x32 h13d y3148 ff19 fsac fc0 sc0 ls0 ws0">program <span class="_"> </span>that <span class="_"> </span>does, <span class="_"> </span>to <span class="_ _66"> </span>gain <span class="_ _66"> </span>some <span class="_ _66"> </span>insight <span class="_ _66"> </span>into <span class="_"> </span>how <span class="_ _66"> </span>threads <span class="_"> </span>work.<span class="_ _50"> </span>The <span class="_"> </span>program <span class="_"> </span>in</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
