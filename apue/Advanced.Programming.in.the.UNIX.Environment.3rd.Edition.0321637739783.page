<div id="pf30f" class="pf w4 h1f" data-page-no="30f"><div class="pc pc30f w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg30f.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.4<span class="_ _310"> </span>Implementation <span class="_"> </span>Overview<span class="_ _1b"> </span><span class="ff18">749</span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">when <span class="_ _3"></span>we <span class="_ _3"></span>wrote <span class="_ _2"></span>the <span class="_ _3"></span>record<span class="_ _47"> </span>to<span class="_ _47"> </span>the <span class="_ _3"></span>database.<span class="_ _16"> </span>The <span class="_ _3"></span>data <span class="_ _3"></span>offset</div><div class="t m0 x23a h2a y1ac ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x1e9 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">0</div><div class="t m0 x14c h2a y1ac ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x23c h2a y12f ff19 fsf fc0 sc0 ls0 ws0">and <span class="_ _3"></span>data <span class="_ _3"></span>length</div><div class="t m0 x1c9 h2a y1ac ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x190 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">6</div><div class="t m0 x57 h2a y1ac ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x14f h2a y12f ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">fer</span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">to <span class="_ _2"></span>the <span class="_ _2"></span>data <span class="_ _3"></span>ﬁle.<span class="_ _61"> </span><span class="ls5f">We <span class="_ _e"> </span>c<span class="_ _9"></span></span>an <span class="_ _3"></span>see <span class="_ _2"></span>that <span class="_ _2"></span>the <span class="_ _3"></span>data <span class="_ _2"></span>recor<span class="lse4d">dd<span class="_ _8"></span><span class="ls0">oes <span class="_ _2"></span>start <span class="_ _2"></span>at <span class="_ _3"></span>offset 0 <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _2"></span>data <span class="_ _3"></span>ﬁle <span class="_ _2"></span>and</span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">has a length of 6 bytes.</div><div class="t m0 x32 h4e y245e ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y245f ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue_db.h&quot;</div><div class="t m0 x32 h4e y2460 ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h4e y5601 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y5602 ff1a fs28 fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h4e y5603 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y5604 ff1a fs28 fc0 sc0 ls0 ws0">DBHANDLE <span class="_ _68"> </span>db;</div><div class="t m0 x8a h4e y5605 ff1a fs28 fc0 sc0 ls0 ws0">if ((db = db_open(&quot;db4&quot;, O_RDWR | O_CREAT | O_TRUNC,</div><div class="t m0 x194 h4e y5606 ff1a fs28 fc0 sc0 ls0 ws0">FILE_MODE)) == NULL)</div><div class="t m0 x9d h4e y5607 ff1a fs28 fc0 sc0 ls0 ws0">err_sys(&quot;db_open error&quot;);</div><div class="t m0 x8a h4e y5608 ff1a fs28 fc0 sc0 ls0 ws0">if (db_store(db, &quot;Alpha&quot;, &quot;data1&quot;, DB_INSERT) != 0)</div><div class="t m0 x9d h4e y5609 ff1a fs28 fc0 sc0 ls0 ws0">err_quit(&quot;db_store error for alpha&quot;);</div><div class="t m0 x8a h4e y560a ff1a fs28 fc0 sc0 ls0 ws0">if (db_store(db, &quot;beta&quot;, &quot;Data for beta&quot;, DB_INSERT) != 0)</div><div class="t m0 x9d h4e y560b ff1a fs28 fc0 sc0 ls0 ws0">err_quit(&quot;db_store error for beta&quot;);</div><div class="t m0 x8a h4e y560c ff1a fs28 fc0 sc0 ls0 ws0">if (db_store(db, &quot;gamma&quot;, &quot;record3&quot;, DB_INSERT) != 0)</div><div class="t m0 x9d h4e y560d ff1a fs28 fc0 sc0 ls0 ws0">err_quit(&quot;db_store error for gamma&quot;);</div><div class="t m0 x8a h4e y560e ff1a fs28 fc0 sc0 ls0 ws0">db_close(db);</div><div class="t m0 x8a h4e y560f ff1a fs28 fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h4e y5610 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 xe9 h2e y5611 ff18 fs11 fc0 sc0 ls0 ws0">Figure 20.3<span class="_ _5a"> </span><span class="ff19">Create a database and write three r<span class="_ _0"></span>ecords to it</span></div><div class="t m0 x32 h55 y5612 ff19 fs2c fc0 sc0 ls0 ws0">(As <span class="_ _9"></span>with <span class="_ _9"></span>the <span class="_ _9"></span>index <span class="_ _3"></span>ﬁle, <span class="_ _9"></span>we <span class="_ _9"></span>automatically <span class="_ _9"></span>append <span class="_ _9"></span>a <span class="_ _9"></span>newline <span class="_ _9"></span>to <span class="_ _9"></span>each <span class="_ _9"></span>data <span class="_ _9"></span>recor<span class="_ _0"></span>d, <span class="_ _9"></span>so <span class="_ _9"></span>we</div><div class="t m0 x32 h55 y5613 ff19 fs2c fc0 sc0 ls0 ws0">can <span class="_ _42"> </span>use <span class="_ _42"> </span>the <span class="_ _53"> </span>normal <span class="_ _42"> </span>UNIX <span class="_ _53"> </span>System <span class="_ _42"> </span>tools <span class="_ _42"> </span>with <span class="_ _53"> </span>the <span class="_ _42"> </span>ﬁle.<span class="_ _54"> </span>This <span class="_ _53"> </span>newline <span class="_ _42"> </span>at <span class="_ _53"> </span>the <span class="_ _42"> </span>end <span class="_ _53"> </span>is <span class="_ _42"> </span>not</div><div class="t m0 x32 h54 y5614 ff19 fs2c fc0 sc0 ls150 ws0">re<span class="ls0">turned to the caller by<span class="_"> </span><span class="ff1a">db_fetch</span>.)</span></div><div class="t m0 x3f h55 y5615 ff19 fs2c fc0 sc0 ls0 ws0">If we follow <span class="_ _2"></span>the three hash chains <span class="_ _2"></span>in this example, <span class="_ _2"></span>we see that <span class="_ _2"></span>the ﬁrst <span class="_ _2"></span>recor<span class="_ _0"></span><span class="ls162c">do<span class="_ _4f"></span><span class="ls162d">nt<span class="_ _d"></span><span class="ls0">he</span></span></span></div><div class="t m0 x32 h54 y5616 ff19 fs2c fc0 sc0 ls0 ws0">ﬁrst <span class="_ _42"> </span>hash <span class="_ _53"> </span>chain <span class="_ _42"> </span>is <span class="_ _53"> </span>at <span class="_ _42"> </span>offset <span class="_ _42"> </span>53 <span class="_ _53"> </span>(<span class="ff1a">gamma</span>). <span class="_ _44"> </span>The<span class="_ _44"> </span>next <span class="_ _42"> </span>record<span class="_ _35"> </span>on<span class="_ _44"> </span>this <span class="_ _53"> </span>chain <span class="_ _53"> </span>is <span class="_ _42"> </span>at <span class="_ _53"> </span>offset <span class="_ _42"> </span>17</div><div class="t m0 x32 h54 y5617 ff19 fs2c fc0 sc0 ls0 ws0">(<span class="ff1a">alpha</span>), <span class="_ _23"></span>and <span class="_ _23"></span>this <span class="_ _23"></span>is <span class="_ _23"></span>the <span class="_ _23"></span>last <span class="_ _23"> </span>recor<span class="_ _0"></span>d<span class="_ _35"> </span>on<span class="_ _45"> </span>the <span class="_ _23"> </span>chain.<span class="_ _51"> </span>The <span class="_ _23"> </span>ﬁrst <span class="_ _23"> </span>record<span class="_ _45"> </span>on<span class="_ _35"> </span>the <span class="_ _23"></span>second <span class="_ _23"></span>hash</div><div class="t m0 x32 h54 y5618 ff19 fs2c fc0 sc0 ls0 ws0">chain <span class="_ _2"></span>is <span class="_ _2"></span>at <span class="_ _2"></span>offset <span class="_ _2"></span>35 <span class="_ _2"></span>(<span class="ff1a">beta</span>), <span class="_ _2"></span>and <span class="_ _2"></span>it’s <span class="_ _2"></span>the <span class="_ _3"></span>last <span class="_ _2"></span>recor<span class="_ _0"></span>d<span class="_ _66"> </span>on<span class="_ _47"> </span>the <span class="_ _2"></span>chain.<span class="_ _61"> </span>The <span class="_ _2"></span>thir<span class="ls162e">dh<span class="_ _4f"></span><span class="ls0">ash <span class="_ _2"></span>chain <span class="_ _2"></span>is</span></span></div><div class="t m0 x32 h55 y5619 ff19 fs2c fc0 sc0 ls0 ws0">empty<span class="_ _4"></span>.</div><div class="t m0 x3f h55 y561a ff19 fs2c fc0 sc0 ls0 ws0">Note that <span class="_ _2"></span>the order of <span class="_ _2"></span>the keys <span class="_ _2"></span>in the <span class="_ _2"></span>index ﬁle <span class="_ _2"></span>and the <span class="_ _2"></span>order of their <span class="_ _2"></span>corresponding</div><div class="t m0 x32 h54 y561b ff19 fs2c fc0 sc0 ls150 ws0">re<span class="ls0">cords <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>data <span class="_ _3"></span>ﬁle <span class="_ _3"></span>is <span class="_ _3"></span>the <span class="_ _3"></span>same <span class="_ _3"></span>as <span class="_ _3"></span>the <span class="_ _3"></span>order <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>calls <span class="_ _3"></span>to<span class="_ _45"> </span><span class="ff1a">db_store<span class="_ _47"> </span></span>in <span class="_ _2"></span>Figur<span class="ls162f">e2<span class="_ _8"></span><span class="ls0">0.3.</span></span></span></div><div class="t m0 x32 h54 y561c ff19 fs2c fc0 sc0 ls0 ws0">Since <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">O_TRUNC<span class="_ _47"> </span></span>ﬂag <span class="_ _2"></span>was <span class="_ _2"></span>speciﬁed <span class="_ _2"></span>for<span class="_ _47"> </span><span class="ff1a">db_open</span><span class="ls1630">,t<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>index <span class="_ _2"></span>ﬁle <span class="_ _2"></span>and <span class="_ _2"></span>the <span class="_ _2"></span>data <span class="_ _3"></span>ﬁle <span class="_ _2"></span>were</span></span></div><div class="t m0 x32 h54 y561d ff19 fs2c fc0 sc0 ls0 ws0">both <span class="_ _23"> </span>truncated <span class="_ _23"></span>and <span class="_ _23"> </span>the <span class="_ _23"> </span>database <span class="_ _42"> </span>initialized <span class="_ _23"></span>from <span class="_ _23"></span>scratch.<span class="_ _51"> </span>In <span class="_ _23"></span>this <span class="_ _23"></span>case,<span class="_ _35"> </span><span class="ff1a">db_store<span class="_ _35"> </span></span>just</div><div class="t m0 x32 h55 y561e ff19 fs2c fc0 sc0 ls0 ws0">appends <span class="_ _23"></span>the <span class="_ _9"></span>new <span class="_ _23"> </span>index <span class="_ _23"></span>recor<span class="_ _1"></span>ds <span class="_ _23"> </span>and <span class="_ _23"></span>data <span class="_ _23"></span>recor<span class="_ _1"></span>ds <span class="_ _23"> </span>to <span class="_ _23"></span>the <span class="_ _23"></span>end <span class="_ _9"></span>of <span class="_ _23"> </span>the <span class="_ _23"></span>corresponding <span class="_ _9"></span>ﬁle.</div><div class="t m0 x32 h54 y561f ff19 fs2c fc0 sc0 ls155 ws0">We<span class="_ _9"></span><span class="ls0">’ll <span class="_ _2"></span>see <span class="_ _3"></span>later <span class="_ _3"></span>that<span class="_ _47"> </span><span class="ff1a">db_store<span class="_ _66"> </span></span>can <span class="_ _3"></span>also <span class="_ _2"></span>reuse <span class="_ _2"></span>portions <span class="_ _3"></span>of <span class="_ _2"></span>these <span class="_ _3"></span>two <span class="_ _2"></span>ﬁles <span class="_ _3"></span>that <span class="_ _2"></span>correspond</span></div><div class="t m0 x32 h55 y5620 ff19 fs2c fc0 sc0 ls0 ws0">to deleted recor<span class="_ _0"></span>ds.</div><div class="t m0 x3f h55 y5621 ff19 fs2c fc0 sc0 ls0 ws0">The <span class="_ _23"></span>choice <span class="_ _9"></span>of <span class="_ _23"> </span>a <span class="_ _23"></span>ﬁxed-size <span class="_ _23"></span>hash <span class="_ _23"></span>table <span class="_ _9"></span>for <span class="_ _23"> </span>the <span class="_ _23"></span>index <span class="_ _23"></span>is <span class="_ _9"></span>a <span class="_ _23"> </span>compromise. <span class="_ _45"> </span>It<span class="_ _35"> </span>allows <span class="_ _9"></span>fast</div><div class="t m0 x32 h55 y5622 ff19 fs2c fc0 sc0 ls0 ws0">access <span class="_ _9"></span>as <span class="_ _9"></span>long <span class="_ _23"></span>as <span class="_ _9"></span>each <span class="_ _23"></span>hash <span class="_ _9"></span>chain <span class="_ _9"></span>isn’t <span class="_ _23"></span>too <span class="_ _9"></span>long.<span class="_ _5a"> </span><span class="ls155">We <span class="_ _47"> </span>w<span class="_ _9"></span></span>ant <span class="_ _9"></span>to <span class="_ _23"></span>be <span class="_ _9"></span>able <span class="_ _9"></span>to <span class="_ _23"></span>sear<span class="_ _0"></span>ch <span class="_ _9"></span>for <span class="_ _23"></span>any</div><div class="t m0 x32 h55 y5623 ff19 fs2c fc0 sc0 ls0 ws0">key quickly<span class="_ _6"></span><span class="ls1631">,b<span class="_ _4f"></span><span class="ls0">ut <span class="_ _2"></span>we don’t <span class="_ _2"></span>want to <span class="_ _2"></span>complicate <span class="_ _2"></span>the data <span class="_ _2"></span>structures by using either <span class="_ _2"></span>a <span class="_ _2"></span>B-tree</span></span></div><div class="t m0 x32 h55 y5624 ff19 fs2c fc0 sc0 ls0 ws0">or <span class="_ _9"></span>dynamic <span class="_ _9"></span>hashing.<span class="_ _5a"> </span>Dynamic <span class="_ _9"></span>hashing <span class="_ _23"></span>has <span class="_ _9"></span>the <span class="_ _9"></span>advantage <span class="_ _9"></span>that <span class="_ _9"></span>any <span class="_ _9"></span>data <span class="_ _23"></span>r<span class="_ _0"></span>ecor<span class="ls1632">dc<span class="_ _b"></span><span class="ls0">an <span class="_ _3"></span>be</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
