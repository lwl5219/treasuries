<div id="pf1f6" class="pf w4 h1f" data-page-no="1f6"><div class="pc pc1f6 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg1f6.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">468<span class="_ _1b"> </span><span class="ff19">Daemon <span class="_"> </span>Processes <span class="_ _20f"> </span>Chapter<span class="_ _4b"> </span>13</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">sa.sa_flags = 0;</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">if (sigaction(SIGHUP, &amp;sa, NULL) &lt; 0)</div><div class="t m0 x9d h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;%s: can’t ignore SIGHUP&quot;, cmd);</div><div class="t m0 x8a h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">if ((pid = fork()) &lt; 0)</div><div class="t m0 x9d h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;%s: can’t fork&quot;, cmd);</div><div class="t m0 x8a h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">else if (pid != 0) /* parent */</div><div class="t m0 x9d h57 y804 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x8a h57 y350b ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y350c ff1a fs2d fc0 sc0 ls15c ws0">*C<span class="_ _1d"></span><span class="ls0">hange the current working directory to the root so</span></div><div class="t m0 x214 h57 y350d ff1a fs2d fc0 sc0 ls0 ws0">*<span class="_"> </span>we<span class="_"> </span>won’t prevent file systems from being unmounted.</div><div class="t m0 x214 h57 y31b6 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y31b7 ff1a fs2d fc0 sc0 ls0 ws0">if (chdir(&quot;/&quot;) &lt; 0)</div><div class="t m0 x9d h57 y31b8 ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;%s: can’t change directory to /&quot;, cmd);</div><div class="t m0 x8a h57 y1312 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y1313 ff1a fs2d fc0 sc0 ls15c ws0">*C<span class="_ _1d"></span><span class="ls0">lose all open file descriptors.</span></div><div class="t m0 x214 h57 y1314 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y1315 ff1a fs2d fc0 sc0 ls0 ws0">if (rl.rlim_max == RLIM_INFINITY)</div><div class="t m0 x9d h57 y351c ff1a fs2d fc0 sc0 ls0 ws0">rl.rlim_max = 1024;</div><div class="t m0 x8a h57 y351d ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; rl.rlim_max; i++)</div><div class="t m0 x9d h57 y351e ff1a fs2d fc0 sc0 ls0 ws0">close(i);</div><div class="t m0 x8a h57 y1319 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y131a ff1a fs2d fc0 sc0 ls15c ws0">*A<span class="_ _1d"></span><span class="ls0">ttach file descriptors 0, 1, and 2 to /dev/null.</span></div><div class="t m0 x214 h57 y131b ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y131c ff1a fs2d fc0 sc0 ls0 ws0">fd0 = open(&quot;/dev/null&quot;, O_RDWR);</div><div class="t m0 x8a h57 y131d ff1a fs2d fc0 sc0 ls0 ws0">fd1 = dup(0);</div><div class="t m0 x8a h57 y131e ff1a fs2d fc0 sc0 ls0 ws0">fd2 = dup(0);</div><div class="t m0 x8a h57 y1344 ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y1345 ff1a fs2d fc0 sc0 ls15c ws0">*I<span class="_ _1d"></span><span class="ls0">nitialize the log file.</span></div><div class="t m0 x214 h57 y1346 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y1347 ff1a fs2d fc0 sc0 ls0 ws0">openlog(cmd, LOG_CONS, LOG_DAEMON);</div><div class="t m0 x8a h57 y1323 ff1a fs2d fc0 sc0 ls0 ws0">if (fd0 != 0 || fd1 != 1 || fd2 != 2) {</div><div class="t m0 x9d h57 y1324 ff1a fs2d fc0 sc0 ls0 ws0">syslog(LOG_ERR, &quot;unexpected file descriptors %d %d %d&quot;,</div><div class="t m0 x76 h57 y1325 ff1a fs2d fc0 sc0 ls0 ws0">fd0, fd1, fd2);</div><div class="t m0 x9d h57 y1326 ff1a fs2d fc0 sc0 ls0 ws0">exit(1);</div><div class="t m0 x8a h57 y1348 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 y1349 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x123 h2d y39fa ff18 fs10 fc0 sc0 ls0 ws0">Figure 13.1<span class="_ _5a"> </span><span class="ff19">Initialize a daemon process</span></div><div class="t m0 x32 h4d y39fb ff19 fs26 fc0 sc0 ls0 ws0">If <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">daemonize<span class="_ _45"> </span></span>function <span class="_ _23"></span>is <span class="_ _9"></span>called <span class="_ _23"></span>fr<span class="_ _0"></span>om <span class="_ _9"></span>a<span class="_ _45"> </span><span class="ff1a">main<span class="_ _35"> </span></span>pr<span class="_ _0"></span>ogram <span class="_ _9"></span>that <span class="_ _9"></span>then <span class="_ _23"></span>goes <span class="_ _9"></span>to <span class="_ _9"></span>sleep, <span class="_ _23"></span>we</div><div class="t m0 x32 h4d y39fc ff19 fs26 fc0 sc0 ls0 ws0">can check the status of the daemon with the<span class="_"> </span><span class="ff1a">ps<span class="_ _80"> </span></span>command:</div><div class="t m0 x3f h4e y39fd ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h4e y39fe ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">ps -efj</span></div><div class="t m0 x3f h4e y39ff ff1a fs28 fc0 sc0 ls0 ws0">UID <span class="_ _15"> </span>PID<span class="_ _d9"> </span>PPID <span class="_"> </span>PGID<span class="_ _87"> </span>SID <span class="_"> </span>TTY <span class="_"> </span>CMD</div><div class="t m0 x3f h4e y3a00 ff1a fs28 fc0 sc0 ls0 ws0">sar <span class="_ _d9"> </span>13800<span class="_ _8a"> </span><span class="ls1b6">11<span class="_ _5b"></span><span class="ls0">3799 13799<span class="_ _3a"> </span><span class="lsf75">?.<span class="_ _19"></span><span class="ls0">/a.out</span></span></span></span></div><div class="t m0 x3f h4e y3a01 ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">ps -efj | grep 13799</span></div><div class="t m0 x3f h4e y3a02 ff1a fs28 fc0 sc0 ls0 ws0">sar <span class="_ _d9"> </span>13800<span class="_ _8a"> </span><span class="ls1b6">11<span class="_ _5b"></span><span class="ls0">3799 13799<span class="_ _3a"> </span><span class="lsf75">?.<span class="_ _19"></span><span class="ls0">/a.out</span></span></span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
