<div id="pf227" class="pf w4 h1f" data-page-no="227"><div class="pc pc227 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg227.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.5<span class="_ _20d"> </span>Asynchronous <span class="_"> </span>I/O<span class="_ _1b"> </span><span class="ff18">517</span></div><div class="t m0 x8a h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">if (argc != 3)</div><div class="t m0 x9d h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;usage: rot13 infile outfile&quot;);</div><div class="t m0 x8a h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">if ((ifd = open(argv[1], O_RDONLY)) &lt; 0)</div><div class="t m0 x9d h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;can’t open %s&quot;, argv[1]);</div><div class="t m0 x8a h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">if ((ofd = open(argv[2], O_RDWR|O_CREAT|O_TRUNC, FILE_MODE)) &lt; 0)</div><div class="t m0 x9d h57 y803 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;can’t create %s&quot;, argv[2]);</div><div class="t m0 x8a h57 y124d ff1a fs2d fc0 sc0 ls0 ws0">while ((n = read(ifd, buf, BSZ)) &gt; 0) {</div><div class="t m0 x9d h57 y124e ff1a fs2d fc0 sc0 ls0 ws0">for (i = 0; i &lt; n; i++)</div><div class="t m0 x1f h57 y124f ff1a fs2d fc0 sc0 ls0 ws0">buf[i] = translate(buf[i]);</div><div class="t m0 x9d h57 y1250 ff1a fs2d fc0 sc0 ls0 ws0">if ((nw = write(ofd, buf, n)) != n) {</div><div class="t m0 x1f h57 y8d8 ff1a fs2d fc0 sc0 ls0 ws0">if (nw &lt; 0)</div><div class="t m0 x1ca h57 y8d9 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write failed&quot;);</div><div class="t m0 x1f h57 y8da ff1a fs2d fc0 sc0 ls0 ws0">else</div><div class="t m0 x1ca h57 y8db ff1a fs2d fc0 sc0 ls0 ws0">err_quit(&quot;short write (%d/%d)&quot;, nw, n);</div><div class="t m0 x9d h57 y8dc ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y8dd ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y2f72 ff1a fs2d fc0 sc0 ls0 ws0">fsync(ofd);</div><div class="t m0 x8a h57 y2f73 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y8e0 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 xa7 h2d y3f65 ff18 fs10 fc0 sc0 ls0 ws0">Figure 14.20<span class="_ _5a"> </span><span class="ff19 ls277">Tr<span class="_ _9"></span><span class="ls0">anslate a ﬁle using ROT</span></span></div><div class="t m0 x153 h2d y3f66 ff19 fs10 fc0 sc0 ls0 ws0">-</div><div class="t m0 x1da h2d y3f65 ff19 fs10 fc0 sc0 ls0 ws0">13</div><div class="t m0 x3f h49 y3f67 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _3"></span>I/O <span class="_ _3"></span>portion <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>program <span class="_ _2"></span>is <span class="_ _3"></span>straightforward: <span class="_ _3"></span>we <span class="_ _3"></span>read <span class="_ _3"></span>a <span class="_ _3"></span>block <span class="_ _3"></span>from <span class="_ _3"></span>the <span class="_ _3"></span>input</div><div class="t m0 x32 h49 y3f68 ff19 fs26 fc0 sc0 ls0 ws0">ﬁle, <span class="_ _3"></span>translate <span class="_ _9"></span>it, <span class="_ _3"></span>and <span class="_ _9"></span>then <span class="_ _3"></span>write <span class="_ _9"></span>the <span class="_ _3"></span>block <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>output <span class="_ _3"></span>ﬁle.<span class="_ _16"> </span><span class="ls164">We <span class="_ _66"> </span>r<span class="_ _9"></span></span>epeat <span class="_ _3"></span>this <span class="_ _9"></span>until <span class="_ _3"></span>we <span class="_ _9"></span>hit</div><div class="t m0 x32 h4d y3f69 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _e"> </span>end <span class="_ _e"> </span>of <span class="_ _e"> </span>ﬁle <span class="_ _e"> </span>and<span class="_ _4b"> </span><span class="ff1a">read<span class="_ _4b"> </span></span><span class="lscc">re<span class="_ _2"></span></span>turns <span class="_ _e"> </span>zero. <span class="_ _4b"> </span>The<span class="_ _4b"> </span>program <span class="_ _53"> </span>in <span class="_"> </span>Figur<span class="_ _0"></span><span class="ls10c4">e1<span class="_ _55"></span><span class="ls0">4.21 <span class="_ _53"> </span>shows <span class="_"> </span>how <span class="_ _53"> </span>to</span></span></div><div class="t m0 x32 h49 y3f6a ff19 fs26 fc0 sc0 ls0 ws0">perform the same task using the equivalent asynchronous I/O functions.</div><div class="t m0 x32 h5d y3f6b ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h5d y3f6c ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;ctype.h&gt;</div><div class="t m0 x32 h5d y3f6d ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h5d y3f6e ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;aio.h&gt;</div><div class="t m0 x32 h5d y3f6f ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h5d y3f70 ff1a fs2f fc0 sc0 ls0 ws0">#define BSZ 4096</div><div class="t m0 x32 h5d y3f71 ff1a fs2f fc0 sc0 ls0 ws0">#define NBUF 8</div><div class="t m0 x32 h5d y3f72 ff1a fs2f fc0 sc0 ls0 ws0">enum rwop {</div><div class="t m0 x8a h5d y3f73 ff1a fs2f fc0 sc0 ls0 ws0">UNUSED = 0,</div><div class="t m0 x8a h5d y3f74 ff1a fs2f fc0 sc0 ls0 ws0">READ_PENDING = 1,</div><div class="t m0 x8a h5d y3f75 ff1a fs2f fc0 sc0 ls0 ws0">WRITE_PENDING = 2</div><div class="t m0 x32 h5d y3f76 ff1a fs2f fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h5d y3f77 ff1a fs2f fc0 sc0 ls0 ws0">struct buf {</div><div class="t m0 x8a h5d y3f78 ff1a fs2f fc0 sc0 ls0 ws0">enum rwop<span class="_ _8a"> </span>op;</div><div class="t m0 x8a h5d y3f79 ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _74"> </span>last;</div><div class="t m0 x8a h5d y3f7a ff1a fs2f fc0 sc0 ls0 ws0">struct aiocb<span class="_ _d9"> </span>aiocb;</div><div class="t m0 x8a h5d y3f7b ff1a fs2f fc0 sc0 ls0 ws0">unsigned char data[BSZ];</div><div class="t m0 x32 h5d y3f7c ff1a fs2f fc0 sc0 ls0 ws0">};</div><div class="t m0 x32 h5d y3f7d ff1a fs2f fc0 sc0 ls0 ws0">struct buf bufs[NBUF];</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
