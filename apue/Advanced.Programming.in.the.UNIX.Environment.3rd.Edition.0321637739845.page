<div id="pf34d" class="pf w4 h1f" data-page-no="34d"><div class="pc pc34d w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg34d.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _31b"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">811</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">107 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">108 <span class="_ _8a"> </span>*<span class="_"> </span>Now send the file.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">109 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">110 <span class="_ _15"> </span>while<span class="_"> </span>((nr = read(fd, buf, IOBUFSZ)) != 0) {</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">111 <span class="_ _186"> </span>nw<span class="_"> </span><span class="ls15c">=w<span class="_ _1d"></span><span class="ls0">riten(sockfd, buf, nr);</span></span></div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">112 <span class="_ _186"> </span>if<span class="_"> </span>(nw != nr) {</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">113 <span class="_ _82"> </span>if<span class="_"> </span>(nw &lt; 0)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">114 <span class="_ _1e7"> </span>err_sys(&quot;can’t<span class="_"> </span>write to print server&quot;);</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">115 <span class="_ _82"> </span>else</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">116 <span class="_ _1e7"> </span>err_quit(&quot;short<span class="_"> </span>write (%d/%d) to print server&quot;,</div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">117 <span class="_ _cb"> </span>nw,<span class="_"> </span>nr);</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">118 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">119 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">120 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">121 <span class="_ _8a"> </span>*<span class="_"> </span>Read the response.</div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">122 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">123 <span class="_ _15"> </span>if<span class="_"> </span>((nr = readn(sockfd, &amp;res, sizeof(struct printresp))) !=</div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">124 <span class="_ _189"> </span>sizeof(struct<span class="_"> </span>printresp))</div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">125 <span class="_ _186"> </span>err_sys(&quot;can’t<span class="_"> </span>read response from server&quot;);</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">126 <span class="_ _15"> </span>if<span class="_"> </span>(res.retcode != 0) {</div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">127 <span class="_ _186"> </span>printf(&quot;rejected:<span class="_"> </span>%s\n&quot;, res.msg);</div><div class="t m0 x32 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">128 <span class="_ _186"> </span>exit(1);</div><div class="t m0 x32 h57 y2f2f ff1a fs2d fc0 sc0 ls0 ws0">129 <span class="_ _15"> </span>}<span class="_"> </span>else {</div><div class="t m0 x32 h57 y2f30 ff1a fs2d fc0 sc0 ls0 ws0">130 <span class="_ _186"> </span>printf(&quot;job<span class="_"> </span>ID %ld\n&quot;, (long)ntohl(res.jobid));</div><div class="t m0 x32 h57 y56fd ff1a fs2d fc0 sc0 ls0 ws0">131 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y5848 ff1a fs2d fc0 sc0 ls0 ws0">132 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h49 y5b4f ff19 fs26 fc0 sc0 ls0 ws0">[107 <span class="_ _a"></span>– <span class="_ _a"></span>1<span class="_ _0"></span>19] <span class="_ _4b"> </span>After<span class="_ _45"> </span>sending <span class="_ _3"></span>the <span class="_ _3"></span>header <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>daemon, <span class="_ _3"></span>we <span class="_ _9"></span>send <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>to <span class="_ _9"></span>be <span class="_ _3"></span>printed.<span class="_ _16"> </span><span class="ls164">We</span></div><div class="t m0 x11a h4d y5b50 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ad the <span class="_ _2"></span>ﬁle<span class="_"> </span><span class="ff1a">IOBUFSZ<span class="_ _66"> </span></span>bytes at a time and use<span class="_ _66"> </span><span class="ff1a">writen<span class="_ _66"> </span></span>to send the data to <span class="_ _2"></span>the</span></div><div class="t m0 x11a h49 y5b51 ff19 fs26 fc0 sc0 ls0 ws0">daemon. <span class="_ _4b"> </span>As<span class="_ _4b"> </span>with <span class="_ _e"> </span>the <span class="_ _e"> </span>header<span class="_ _1"></span>,<span class="_ _4b"> </span>if<span class="_ _59"> </span>the <span class="_ _53"> </span>write <span class="_ _e"> </span>fails <span class="_ _e"> </span>or <span class="_"> </span>we <span class="_ _53"> </span>write <span class="_ _e"> </span>less <span class="_ _e"> </span>than <span class="_ _e"> </span>we</div><div class="t m0 x11a h49 y5b52 ff19 fs26 fc0 sc0 ls0 ws0">expect, we print an error message and exit.</div><div class="t m0 x32 h49 y5b53 ff19 fs26 fc0 sc0 ls0 ws0">[120 <span class="_ _a"></span>– <span class="_ _a"></span>132]<span class="_ _65"> </span>Once <span class="_ _23"></span>we <span class="_ _9"></span>have <span class="_ _23"> </span>sent <span class="_ _23"></span>the <span class="_ _23"></span>ﬁle <span class="_ _9"></span>to <span class="_ _23"> </span>be <span class="_ _23"></span>printed <span class="_ _23"></span>to <span class="_ _9"></span>the <span class="_ _23"> </span>print <span class="_ _23"></span>spooling <span class="_ _23"></span>daemon, <span class="_ _9"></span>we</div><div class="t m0 x11a h49 y5b54 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ad <span class="_"> </span>the <span class="_"> </span>daemon’s <span class="_"> </span>response. <span class="_ _59"> </span>If<span class="_ _59"> </span>the <span class="_"> </span>print <span class="_"> </span>request <span class="_"> </span>failed, <span class="_"> </span>the <span class="_"> </span>r<span class="_ _1"></span>eturn <span class="_"> </span>code</span></div><div class="t m0 x11a h4d y5b55 ff19 fs26 fc0 sc0 ls0 ws0">(<span class="ff1a">retcode</span><span class="ls176d">)w<span class="_ _b"></span><span class="ls0">ill <span class="_ _9"></span>be <span class="_ _9"></span>nonzero, <span class="_ _9"></span>so <span class="_ _9"></span>we <span class="_ _23"></span>print <span class="_ _9"></span>the <span class="_ _9"></span>textual <span class="_ _9"></span>error <span class="_ _9"></span>message <span class="_ _9"></span>included</span></span></div><div class="t m0 x11a h49 y5b56 ff19 fs26 fc0 sc0 ls0 ws0">in the response. <span class="_"> </span>If<span class="_"> </span>the request succeeded, we <span class="_ _2"></span>print the job <span class="_ _2"></span>ID so that the <span class="_ _2"></span>user</div><div class="t m0 x11a h49 y5b57 ff19 fs26 fc0 sc0 ls0 ws0">knows <span class="_ _53"> </span>how <span class="_ _53"> </span>to <span class="_ _53"> </span>refer <span class="_ _53"> </span>to <span class="_ _53"> </span>the <span class="_ _53"> </span>request <span class="_ _42"> </span>in <span class="_ _e"> </span>the <span class="_ _53"> </span>future. <span class="_ _44"> </span>(W<span class="_ _6"></span>riting <span class="_ _e"> </span>a <span class="_ _53"> </span>command <span class="_ _53"> </span>to</div><div class="t m0 x11a h49 y5b58 ff19 fs26 fc0 sc0 ls0 ws0">cancel a <span class="_ _2"></span>pending <span class="_ _2"></span>print <span class="_ _2"></span>request is <span class="_ _2"></span>left <span class="_ _2"></span>as an <span class="_ _2"></span>exercise; the <span class="_ _2"></span>job <span class="_ _2"></span>ID <span class="_ _2"></span>can <span class="_ _2"></span>be <span class="_ _2"></span>used in</div><div class="t m0 x11a h49 y5b59 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _53"> </span>cancellation <span class="_"> </span>r<span class="_ _1"></span>equest <span class="_"> </span>to <span class="_ _53"> </span>identify <span class="_ _e"> </span>the <span class="_ _e"> </span>job <span class="_ _e"> </span>to <span class="_ _e"> </span>be <span class="_ _e"> </span>removed <span class="_ _53"> </span>from <span class="_ _53"> </span>the <span class="_ _e"> </span>print</div><div class="t m0 x11a h4d y5b5a ff19 fs26 fc0 sc0 ls0 ws0">queue. <span class="_ _4b"> </span>See <span class="_ _4b"> </span>Exercise <span class="_ _44"> </span>21.5.)<span class="_ _93"> </span>When<span class="_ _48"> </span><span class="ff1a">submit_file<span class="_ _65"> </span></span><span class="lscc">re<span class="_ _2"></span></span>turns <span class="_ _4b"> </span>to <span class="_ _4b"> </span>the<span class="_ _65"> </span><span class="ff1a">main</span></div><div class="t m0 x11a h49 y5b5b ff19 fs26 fc0 sc0 ls0 ws0">function, we exit, indicating success.</div><div class="t m0 x11a h49 y5b5c ff19 fs26 fc0 sc0 ls0 ws0">Note <span class="_ _42"> </span>that <span class="_ _42"> </span>a <span class="_ _53"> </span>successful <span class="_ _42"> </span>response <span class="_ _42"> </span>from <span class="_ _42"> </span>the <span class="_ _42"> </span>daemon <span class="_ _53"> </span>does <span class="_ _42"> </span>not <span class="_ _53"> </span>mean <span class="_ _42"> </span>that <span class="_ _53"> </span>the</div><div class="t m0 x11a h49 y5b5d ff19 fs26 fc0 sc0 ls0 ws0">printer <span class="_ _44"> </span>was <span class="_ _44"> </span>able <span class="_ _44"> </span>to <span class="_ _44"> </span>print <span class="_ _44"> </span>the <span class="_ _44"> </span>ﬁle; <span class="_ _44"> </span>it <span class="_ _44"> </span>merely <span class="_ _44"> </span>means <span class="_ _44"> </span>that <span class="_ _44"> </span>the <span class="_ _44"> </span>daemon</div><div class="t m0 x11a h49 y5b5e ff19 fs26 fc0 sc0 ls0 ws0">successfully added the print job to the queue.</div><div class="t m0 x32 h49 y5b5f ff19 fs26 fc0 sc0 ls0 ws0">This <span class="_ _23"> </span>completes <span class="_ _42"> </span>our <span class="_ _23"> </span>look <span class="_ _42"> </span>at <span class="_ _23"> </span>the <span class="_ _42"> </span>print <span class="_ _42"> </span>command.<span class="_ _51"> </span>The <span class="_ _23"> </span>last <span class="_ _42"> </span>ﬁle <span class="_ _23"> </span>we <span class="_ _42"> </span>will <span class="_ _42"> </span>look <span class="_ _23"> </span>at <span class="_ _42"> </span>is <span class="_ _23"> </span>the <span class="_ _42"> </span>C</div><div class="t m0 x32 h49 y5b60 ff19 fs26 fc0 sc0 ls0 ws0">source ﬁle for the printer spooling daemon.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
