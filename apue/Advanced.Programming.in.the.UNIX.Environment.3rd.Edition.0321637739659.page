<div id="pf293" class="pf w4 h1f" data-page-no="293"><div class="pc pc293 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg293.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>16.6<span class="_ _177"> </span>Socket <span class="_"> </span>Options<span class="_ _1b"> </span><span class="ff18">625</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _35"> </span><span class="ff1b">lenp<span class="_ _35"> </span></span>argument <span class="_ _23"> </span>is <span class="_ _42"> </span>a <span class="_ _23"> </span>pointer <span class="_ _42"> </span>to <span class="_ _23"> </span>an <span class="_ _42"> </span>integer<span class="_ _6"></span><span class="ls1380">.B<span class="_ _7"></span><span class="ls0">efor<span class="ls1381">ec<span class="_ _43"></span><span class="ls0">alling<span class="_ _35"> </span><span class="ff1a">getsockopt</span>,<span class="_ _35"> </span>we<span class="_ _35"> </span>set <span class="_ _42"> </span>the</span></span></span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">integer to <span class="_ _2"></span>the <span class="_ _2"></span>size <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _2"></span>buffer wher<span class="ls110a">et<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>option <span class="_ _2"></span>is to <span class="_ _2"></span>be <span class="_ _2"></span>copied.<span class="_ _61"> </span>If <span class="_ _2"></span>the <span class="_ _2"></span>actual <span class="_ _2"></span>size of <span class="_ _2"></span>the</span></span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">option <span class="_ _3"></span>is <span class="_ _9"></span>greater <span class="_ _2"></span>than <span class="_ _9"></span>this <span class="_ _3"></span>size, <span class="_ _3"></span>the <span class="_ _9"></span>option <span class="_ _3"></span>is <span class="_ _9"></span>silently <span class="_ _3"></span>truncated. <span class="_ _47"> </span>If<span class="_ _45"> </span>the <span class="_ _3"></span>actual <span class="_ _3"></span>size <span class="_ _9"></span>of <span class="_ _3"></span>the</div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">option is less than this size, then the integer is updated with the actual size on return.</div><div class="t m0 x35 h27 yc36 ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a yc38 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _23"></span>function <span class="_ _23"></span>in <span class="_ _23"></span>Figur<span class="_ _0"></span><span class="ls535">e1<span class="_ _b"></span><span class="ls0">6.12 <span class="_ _9"></span>fails <span class="_ _23"></span>to <span class="_ _23"></span>operate <span class="_ _23"></span>properly <span class="_ _9"></span>when <span class="_ _23"> </span>the <span class="_ _23"> </span>server <span class="_ _23"> </span>terminates <span class="_ _23"></span>and</span></span></div><div class="t m0 x32 h2a yc39 ff19 fsf fc0 sc0 ls0 ws0">we <span class="_ _9"></span>try <span class="_ _3"></span>to <span class="_ _9"></span>restart <span class="_ _9"></span>it <span class="_ _9"></span>immediately<span class="_ _4"></span><span class="ls1382">.N<span class="_ _62"></span><span class="ls0">ormally<span class="_ _6"></span><span class="ls1383">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>implementation <span class="_ _9"></span>of <span class="_ _3"></span>TCP <span class="_ _9"></span>will <span class="_ _9"></span>prevent <span class="_ _9"></span>us</span></span></span></span></div><div class="t m0 x32 h2a yc3a ff19 fsf fc0 sc0 ls0 ws0">from binding <span class="_ _3"></span>the <span class="_ _2"></span>same <span class="_ _3"></span>address until <span class="_ _3"></span>a <span class="_ _2"></span>timeout <span class="_ _3"></span>expires, which <span class="_ _3"></span>is <span class="_ _2"></span>usually <span class="_ _3"></span>on <span class="_ _2"></span>the <span class="_ _3"></span>order of</div><div class="t m0 x32 h26 y39d7 ff19 fsf fc0 sc0 ls0 ws0">several <span class="_ _42"> </span>minutes.<span class="_ _54"> </span>Luckily<span class="_ _6"></span><span class="ls1384">,t<span class="_ _c"></span><span class="ls0">he<span class="_ _44"> </span><span class="ff1a">SO_REUSEADDR<span class="_ _44"> </span></span>socket <span class="_ _42"> </span>option <span class="_ _53"> </span>allows <span class="_ _42"> </span>us <span class="_ _53"> </span>to <span class="_ _42"> </span>bypass <span class="_ _53"> </span>this</span></span></div><div class="t m0 x32 h2a y39d8 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">striction, as illustrated in Figur<span class="ls44">e1<span class="_ _d"></span><span class="ls0">6.22.</span></span></span></div><div class="t m0 x32 h4e y39d9 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y39da ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h4e y39db ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x32 h4e y4aab ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y4a26 ff1a fs28 fc0 sc0 ls0 ws0">initserver(int type, const struct sockaddr *addr, socklen_t alen,</div><div class="t m0 xb8 h4e y4a27 ff1a fs28 fc0 sc0 ls0 ws0">int qlen)</div><div class="t m0 x32 h4e y4aac ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y4aad ff1a fs28 fc0 sc0 ls0 ws0">int fd, err;</div><div class="t m0 x8a h4e y4aae ff1a fs28 fc0 sc0 ls0 ws0">int reuse = 1;</div><div class="t m0 x8a h4e y39e3 ff1a fs28 fc0 sc0 ls0 ws0">if ((fd = socket(addr-&gt;sa_family, type, 0)) &lt; 0)</div><div class="t m0 x9d h4e y4aaf ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h4e y4ab0 ff1a fs28 fc0 sc0 ls0 ws0">if (setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &amp;reuse,</div><div class="t m0 x194 h4e y4ab1 ff1a fs28 fc0 sc0 ls0 ws0">sizeof(int)) &lt; 0)</div><div class="t m0 x9d h4e y4ab2 ff1a fs28 fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h4e y4ab3 ff1a fs28 fc0 sc0 ls0 ws0">if (bind(fd, addr, alen) &lt; 0)</div><div class="t m0 x9d h4e y4ab4 ff1a fs28 fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h4e y4ab5 ff1a fs28 fc0 sc0 ls0 ws0">if (type == SOCK_STREAM || type == SOCK_SEQPACKET)</div><div class="t m0 x9d h4e y4ab6 ff1a fs28 fc0 sc0 ls0 ws0">if (listen(fd, qlen) &lt; 0)</div><div class="t m0 x1f h4e y4ab7 ff1a fs28 fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h4e y4ab8 ff1a fs28 fc0 sc0 ls0 ws0">return(fd);</div><div class="t m0 x32 h4e y4ab9 ff1a fs28 fc0 sc0 ls0 ws0">errout:</div><div class="t m0 x8a h4e y4aba ff1a fs28 fc0 sc0 ls0 ws0">err = errno;</div><div class="t m0 x8a h4e y4abb ff1a fs28 fc0 sc0 ls0 ws0">close(fd);</div><div class="t m0 x8a h4e y4abc ff1a fs28 fc0 sc0 ls0 ws0">errno = err;</div><div class="t m0 x8a h4e y4abd ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x32 h4e y4abe ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x20c h2e y4abf ff18 fs11 fc0 sc0 ls0 ws0">Figure 16.22<span class="_ _5a"> </span><span class="ff19">Initialize a socket endpoint for use by a server with address reuse</span></div><div class="t m0 x32 h54 y4ac0 ff19 fs2c fc0 sc0 ls155 ws0">To <span class="_ _e"> </span>e<span class="_ _9"></span><span class="ls0">nable <span class="_ _2"></span>the<span class="_ _66"> </span><span class="ff1a">SO_REUSEADDR<span class="_ _47"> </span></span>option, <span class="_ _2"></span>we <span class="_ _2"></span>set <span class="_ _2"></span>an <span class="_ _2"></span>integer to <span class="_ _2"></span>a <span class="_ _2"></span>nonzer<span class="ls1385">ov<span class="_ _4f"></span><span class="ls0">alue <span class="_ _2"></span>and <span class="_ _2"></span>pass <span class="_ _2"></span>the</span></span></span></div><div class="t m0 x32 h54 y4ac1 ff19 fs2c fc0 sc0 ls0 ws0">address <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _3"></span>integer <span class="_ _3"></span>as <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1b">val<span class="_ _47"> </span></span>argument <span class="_ _2"></span>to<span class="_ _47"> </span><span class="ff1a">setsockopt</span><span class="ls1386">.W<span class="_ _7"></span><span class="ls1387">es<span class="_ _8"></span><span class="ls0">et <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1b">len<span class="_ _45"> </span></span>ar<span class="_ _0"></span>gument <span class="_ _3"></span>to</span></span></span></div><div class="t m0 x32 h60 y4ac2 ff19 fs2c fc0 sc0 ls0 ws0">the size of an integer to indicate the size of the object to which<span class="_"> </span><span class="ff1b">val<span class="_"> </span></span>points.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
