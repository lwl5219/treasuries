<div id="pf283" class="pf w4 h1f" data-page-no="283"><div class="pc pc283 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg283.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>16.4<span class="_ _1f"> </span>Connection <span class="_"> </span>Establishment<span class="_ _1b"> </span><span class="ff18">609</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _3"></span>no <span class="_ _2"></span>connect <span class="_ _3"></span>requests <span class="_ _3"></span>ar<span class="ls315">ep<span class="_ _8"></span><span class="ls0">ending,<span class="_ _47"> </span><span class="ff1a">accept<span class="_ _47"> </span></span>will <span class="_ _3"></span>block <span class="_ _3"></span>until <span class="_ _3"></span>one <span class="_ _3"></span>arrives.<span class="_ _61"> </span>If<span class="_ _47"> </span><span class="ff1b">sockfd<span class="_ _45"> </span></span>is</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">in <span class="_"> </span>nonblocking <span class="_ _47"> </span>mode,<span class="_ _46"> </span><span class="ff1a">accept<span class="_ _61"> </span></span>will <span class="_ _47"> </span>r<span class="_ _0"></span>eturn<span class="_ _46"> </span><span class="ff20">−</span><span class="ls1350">1a<span class="_ _4a"></span><span class="ls0">nd <span class="_"> </span>set<span class="_ _61"> </span><span class="ff1a">errno<span class="_ _61"> </span></span>to <span class="_ _66"> </span>either<span class="_ _61"> </span><span class="ff1a">EAGAIN<span class="_ _61"> </span></span>or</span></span></div><div class="t m0 x32 h26 y131 ff1a fsf fc0 sc0 ls0 ws0">EWOULDBLOCK<span class="ff19">.</span></div><div class="t m0 x76 h52 yba0 ff19 fs2a fc0 sc0 ls0 ws0">All four platforms discussed in this text deﬁne<span class="_"> </span><span class="ff1a">EAGAIN<span class="_ _53"> </span></span>to be the same as<span class="_"> </span><span class="ff1a">EWOULDBLOCK</span>.</div><div class="t m0 x3f h26 yaa ff19 fsf fc0 sc0 ls0 ws0">If <span class="_ _42"> </span>a <span class="_ _42"> </span>server <span class="_ _53"> </span>calls<span class="_ _44"> </span><span class="ff1a">accept<span class="_ _44"> </span></span>and <span class="_ _42"> </span>no <span class="_ _53"> </span>connect <span class="_ _42"> </span>request <span class="_ _42"> </span>is <span class="_ _42"> </span>present, <span class="_ _42"> </span>the <span class="_ _42"> </span>server <span class="_ _53"> </span>will <span class="_ _42"> </span>block</div><div class="t m0 x32 h26 yeca ff19 fsf fc0 sc0 ls0 ws0">until <span class="_ _23"></span>one <span class="_ _9"></span>arrives.<span class="_ _51"> </span>Alternatively<span class="_ _4"></span><span class="ls1351">,as<span class="_ _b"></span><span class="ls0">erver <span class="_ _9"></span>can <span class="_ _23"> </span>use <span class="_ _23"></span>either<span class="_ _45"> </span><span class="ff1a">poll<span class="_ _35"> </span></span>or<span class="_ _45"> </span><span class="ff1a">select<span class="_ _35"> </span></span>to <span class="_ _23"></span>wait <span class="_ _9"></span>for <span class="_ _23"> </span>a</span></span></div><div class="t m0 x32 h2a yecb ff19 fsf fc0 sc0 ls0 ws0">connect <span class="_ _53"> </span>request <span class="_ _e"> </span>to <span class="_ _e"> </span>arrive.<span class="_ _65"> </span>In <span class="_"> </span>this <span class="_ _53"> </span>case, <span class="_ _e"> </span>a <span class="_ _e"> </span>socket <span class="_ _e"> </span>with <span class="_ _e"> </span>pending <span class="_ _e"> </span>connect <span class="_ _53"> </span>requests <span class="_ _e"> </span>will</div><div class="t m0 x32 h2a yecc ff19 fsf fc0 sc0 ls0 ws0">appear to be readable.</div><div class="t m0 x35 h27 y48ea ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y48eb ff19 fsf fc0 sc0 ls0 ws0">Figur<span class="ls1352">e1<span class="_ _b"></span><span class="ls0">6.12 <span class="_ _3"></span>shows <span class="_ _3"></span>a <span class="_ _3"></span>function <span class="_ _3"></span>we <span class="_ _3"></span>can <span class="_ _3"></span>use <span class="_ _2"></span>to <span class="_ _3"></span>allocate <span class="_ _3"></span>and <span class="_ _3"></span>initialize <span class="_ _3"></span>a <span class="_ _3"></span>socket <span class="_ _3"></span>for <span class="_ _2"></span>use <span class="_ _3"></span>by <span class="_ _3"></span>a</span></span></div><div class="t m0 x32 h2a y48ec ff19 fsf fc0 sc0 ls0 ws0">server process.</div><div class="t m0 x32 h4e y48ed ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y48ee ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h4e y48ef ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 x32 h4e y48f0 ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y48f1 ff1a fs28 fc0 sc0 ls0 ws0">initserver(int type, const struct sockaddr *addr, socklen_t alen,</div><div class="t m0 xb8 h4e y48f2 ff1a fs28 fc0 sc0 ls0 ws0">int qlen)</div><div class="t m0 x32 h4e y48f3 ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y48f4 ff1a fs28 fc0 sc0 ls0 ws0">int fd;</div><div class="t m0 x8a h4e y48f5 ff1a fs28 fc0 sc0 ls0 ws0">int err = 0;</div><div class="t m0 x8a h4e y48f6 ff1a fs28 fc0 sc0 ls0 ws0">if ((fd = socket(addr-&gt;sa_family, type, 0)) &lt; 0)</div><div class="t m0 x9d h4e y48f7 ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x8a h4e y48f8 ff1a fs28 fc0 sc0 ls0 ws0">if (bind(fd, addr, alen) &lt; 0)</div><div class="t m0 x9d h4e y48f9 ff1a fs28 fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h4e y48fa ff1a fs28 fc0 sc0 ls0 ws0">if (type == SOCK_STREAM || type == SOCK_SEQPACKET) {</div><div class="t m0 x9d h4e y48fb ff1a fs28 fc0 sc0 ls0 ws0">if (listen(fd, qlen) &lt; 0)</div><div class="t m0 x1f h4e y48fc ff1a fs28 fc0 sc0 ls0 ws0">goto errout;</div><div class="t m0 x8a h4e y48fd ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h4e y48fe ff1a fs28 fc0 sc0 ls0 ws0">return(fd);</div><div class="t m0 x32 h4e y48ff ff1a fs28 fc0 sc0 ls0 ws0">errout:</div><div class="t m0 x8a h4e y4900 ff1a fs28 fc0 sc0 ls0 ws0">err = errno;</div><div class="t m0 x8a h4e y4901 ff1a fs28 fc0 sc0 ls0 ws0">close(fd);</div><div class="t m0 x8a h4e y4902 ff1a fs28 fc0 sc0 ls0 ws0">errno = err;</div><div class="t m0 x8a h4e y4903 ff1a fs28 fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x32 h4e y4904 ff1a fs28 fc0 sc0 ls0 ws0">}</div><div class="t m0 x185 h2e y4905 ff18 fs11 fc0 sc0 ls0 ws0">Figure 16.12<span class="_ _5a"> </span><span class="ff19">Initialize a socket endpoint for use by a server</span></div><div class="t m0 x3f h55 y4906 ff19 fs2c fc0 sc0 ls155 ws0">We<span class="_ _9"></span><span class="ls0">’ll <span class="_ _23"></span>see <span class="_ _23"></span>that <span class="_ _23"></span>TCP <span class="_ _9"></span>has <span class="_ _23"> </span>some <span class="_ _23"> </span>strange <span class="_ _23"></span>rules <span class="_ _23"></span>r<span class="_ _0"></span>egarding <span class="_ _9"></span>address <span class="_ _23"></span>r<span class="_ _0"></span>euse <span class="_ _23"></span>that <span class="_ _23"></span>make <span class="_ _9"></span>this</span></div><div class="t m0 x32 h55 y4907 ff19 fs2c fc0 sc0 ls0 ws0">example <span class="_ _3"></span>inadequate.<span class="_ _5a"> </span>Figur<span class="ls1353">e1<span class="_ _b"></span><span class="ls0">6.22 <span class="_ _9"></span>shows <span class="_ _9"></span>a <span class="_ _3"></span>version <span class="_ _9"></span>of <span class="_ _9"></span>this <span class="_ _9"></span>function <span class="_ _3"></span>that <span class="_ _9"></span>bypasses <span class="_ _9"></span>these</span></span></div><div class="t m0 x32 h55 y4908 ff19 fs2c fc0 sc0 ls5ee ws0">ru<span class="ls0">les, solving the major drawback with this version.</span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
