<div id="pf3ce" class="pf w4 h1f" data-page-no="3ce"><div class="pc pc3ce w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg3ce.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">940<span class="_ _1b"> </span><span class="ff19">Solutions <span class="_"> </span>to <span class="_"> </span>Selected <span class="_"> </span>Exercises <span class="_ _2eb"> </span>Appendix<span class="_ _4b"> </span>C</span></div><div class="t m0 xe2 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 xe2 h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">clrasync(int sockfd)</div><div class="t m0 xe2 h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x60 h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">int n;</div><div class="t m0 x60 h57 yaea ff1a fs2d fc0 sc0 ls15c ws0">n=0<span class="_ _1d"></span><span class="ls0">;</span></div><div class="t m0 x60 h57 yaeb ff1a fs2d fc0 sc0 ls0 ws0">if (ioctl(sockfd, FIOASYNC, &amp;n) &lt; 0)</div><div class="t m0 xb9 h57 y16f9 ff1a fs2d fc0 sc0 ls0 ws0">return(-1);</div><div class="t m0 x60 h57 y16df ff1a fs2d fc0 sc0 ls0 ws0">return(0);</div><div class="t m0 xe2 h57 y16e0 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x20e h2d y17db ff18 fs10 fc0 sc0 ls0 ws0">Figure C.23<span class="_ _5a"> </span><span class="ff19">Enable and disable asynchronous socket I/O</span></div><div class="t m0 x35 h4c y62e5 ff16 fs26 fc0 sc0 ls0 ws0">Chapter <span class="_"> </span>17</div><div class="t m0 x32 h49 y62e6 ff18 fs26 fc0 sc0 ls0 ws0">17.1<span class="_ _210"> </span><span class="ff19">Regular <span class="_ _53"> </span>pipes <span class="_ _42"> </span>provide <span class="_ _42"> </span>a <span class="_ _42"> </span>byte <span class="_ _42"> </span>stream <span class="_ _42"> </span>interface.<span class="_ _54"> </span><span class="ls164">To <span class="_ _35"> </span>d<span class="_ _9"></span></span>etect <span class="_ _42"> </span>message <span class="_ _42"> </span>boundaries,</span></div><div class="t m0 xe2 h49 y62e7 ff19 fs26 fc0 sc0 ls0 ws0">we’d <span class="_ _9"></span>have <span class="_ _9"></span>to <span class="_ _3"></span>add <span class="_ _9"></span>a <span class="_ _9"></span>header <span class="_ _9"></span>to <span class="_ _9"></span>each <span class="_ _9"></span>message <span class="_ _9"></span>to <span class="_ _9"></span>indicate <span class="_ _9"></span>the <span class="_ _9"></span>length.<span class="_ _16"> </span>But <span class="_ _9"></span>this <span class="_ _9"></span>still</div><div class="t m0 xe2 h49 y62e8 ff19 fs26 fc0 sc0 ls0 ws0">involves two extra copy <span class="_ _2"></span>operations: one to <span class="_ _2"></span>write to the <span class="_ _2"></span>pipe and one to <span class="_ _2"></span>read from</div><div class="t m0 xe2 h49 y62e9 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _23"> </span>pipe.<span class="_ _51"> </span><span class="ls1881">Am<span class="_ _b"></span><span class="ls0">or<span class="_ _1"></span><span class="ls1881">ee<span class="_ _b"></span><span class="lscc">fﬁ<span class="ls0">cient <span class="_ _23"> </span>approach <span class="_ _23"> </span>is <span class="_ _23"> </span>to <span class="_ _42"> </span>use <span class="_ _23"> </span>the <span class="_ _42"> </span>pipe <span class="_ _23"> </span>only <span class="_ _23"> </span>to <span class="_ _42"> </span>signal <span class="_ _23"> </span>the <span class="_ _42"> </span>main</span></span></span></span></span></div><div class="t m0 xe2 h49 y62ea ff19 fs26 fc0 sc0 ls0 ws0">thread <span class="_ _66"> </span>that <span class="_ _47"> </span>a <span class="_ _47"> </span>new <span class="_ _47"> </span>message <span class="_ _47"> </span>is <span class="_ _47"> </span>available.<span class="_ _50"> </span><span class="ls164">We <span class="_ _59"> </span>c<span class="_ _23"></span></span>an <span class="_ _66"> </span>use <span class="_ _47"> </span>a <span class="_ _47"> </span>single <span class="_ _47"> </span>byte <span class="_ _47"> </span>for <span class="_ _47"> </span>this</div><div class="t m0 xe2 h4d y62eb ff19 fs26 fc0 sc0 ls0 ws0">purpose. <span class="_ _4b"> </span>W<span class="_ _0"></span>ith <span class="_ _e"> </span>this <span class="_ _e"> </span>approach, <span class="_ _e"> </span>we <span class="_ _e"> </span>need <span class="_"> </span>to <span class="_ _53"> </span>move <span class="_"> </span>the<span class="_ _4b"> </span><span class="ff1a">mymesg<span class="_ _59"> </span></span>structur<span class="_ _0"></span>e<span class="_ _4b"> </span>to<span class="_ _59"> </span>the</div><div class="t m0 xe2 h4d y62ec ff1a fs26 fc0 sc0 ls0 ws0">threadinfo<span class="_ _47"> </span><span class="ff19">structur<span class="ls164e">ea<span class="_ _b"></span><span class="ls0">nd <span class="_ _9"></span>use <span class="_ _3"></span>a <span class="_ _9"></span>mutex <span class="_ _3"></span>and <span class="_ _3"></span>a <span class="_ _9"></span>condition <span class="_ _3"></span>variable <span class="_ _9"></span>to <span class="_ _3"></span>prevent <span class="_ _3"></span>the</span></span></span></div><div class="t m0 xe2 h4d y62ed ff19 fs26 fc0 sc0 ls0 ws0">helper <span class="_ _9"></span>thread <span class="_ _23"></span>fr<span class="_ _0"></span>om <span class="_ _23"></span>r<span class="_ _0"></span>eusing <span class="_ _9"></span>the<span class="_ _35"> </span><span class="ff1a">mymesg<span class="_ _45"> </span></span>structur<span class="ls598">eu<span class="_ _b"></span><span class="ls0">ntil <span class="_ _9"></span>the <span class="_ _9"></span>main <span class="_ _23"> </span>thread <span class="_ _9"></span>is <span class="_ _23"></span>done</span></span></div><div class="t m0 xe2 h49 y62ee ff19 fs26 fc0 sc0 ls0 ws0">with it.<span class="_ _59"> </span>The solution is shown in Figur<span class="lsd3">eC<span class="_ _d"></span><span class="ls0">.24.</span></span></div><div class="t m0 xe2 h5d y62ef ff1a fs2f fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 xe2 h5d y62f0 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;poll.h&gt;</div><div class="t m0 xe2 h5d y62f1 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;pthread.h&gt;</div><div class="t m0 xe2 h5d y62f2 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;sys/msg.h&gt;</div><div class="t m0 xe2 h5d y62f3 ff1a fs2f fc0 sc0 ls0 ws0">#include &lt;sys/socket.h&gt;</div><div class="t m0 xe2 h5d y62f4 ff1a fs2f fc0 sc0 ls0 ws0">#define NQ<span class="_ _189"> </span><span class="ls183a">3/<span class="_ _1c2"></span><span class="ls395">*n<span class="_ _1d"></span><span class="ls0">umber of queues */</span></span></span></div><div class="t m0 xe2 h5d y62f5 ff1a fs2f fc0 sc0 ls0 ws0">#define MAXMSZ<span class="_ _d9"> </span>512 <span class="_ _15"> </span>/*<span class="_"> </span>maximum message size */</div><div class="t m0 xe2 h5d y62f6 ff1a fs2f fc0 sc0 ls0 ws0">#define KEY<span class="_ _8a"> </span>0x123 <span class="_ _d9"> </span>/*<span class="_"> </span>key for first message queue */</div><div class="t m0 xe2 h5d y62f7 ff1a fs2f fc0 sc0 ls0 ws0">struct mymesg {</div><div class="t m0 x60 h5d y62f8 ff1a fs2f fc0 sc0 ls0 ws0">long <span class="_ _b7"> </span>mtype;</div><div class="t m0 x60 h5d y62f9 ff1a fs2f fc0 sc0 ls0 ws0">char <span class="_ _b7"> </span>mtext[MAXMSZ+1];</div><div class="t m0 xe2 h5d y62fa ff1a fs2f fc0 sc0 ls0 ws0">};</div><div class="t m0 xe2 h5d y62fb ff1a fs2f fc0 sc0 ls0 ws0">struct threadinfo {</div><div class="t m0 x60 h5d y62fc ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>qid;</div><div class="t m0 x60 h5d y62fd ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>fd;</div><div class="t m0 x60 h5d y62fe ff1a fs2f fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>len;</div><div class="t m0 x60 h5d y62ff ff1a fs2f fc0 sc0 ls0 ws0">pthread_mutex_t mutex;</div><div class="t m0 x60 h5d y6300 ff1a fs2f fc0 sc0 ls0 ws0">pthread_cond_t <span class="_"> </span>ready;</div><div class="t m0 x60 h5d y6301 ff1a fs2f fc0 sc0 ls0 ws0">struct mymesg<span class="_ _68"> </span>m;</div><div class="t m0 xe2 h5d y6302 ff1a fs2f fc0 sc0 ls0 ws0">};</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
