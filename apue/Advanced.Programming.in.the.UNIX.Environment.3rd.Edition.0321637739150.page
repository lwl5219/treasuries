<div id="pf96" class="pf w4 h1f" data-page-no="96"><div class="pc pc96 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg96.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls153 ws0">11<span class="_ _2"></span><span class="ls0">6<span class="_ _1b"> </span><span class="ff19">Files <span class="_"> </span>and <span class="_"> </span>Directories <span class="_ _199"> </span>Chapter<span class="_ _4b"> </span>4</span></span></div><div class="t m0 x32 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">number <span class="_ _9"></span>is <span class="_ _23"></span>1267 <span class="_ _9"></span>has <span class="_ _23"></span>a <span class="_ _9"></span>type <span class="_ _23"></span>ﬁeld <span class="_ _9"></span>of <span class="_ _23"></span>‘<span class="_ _0"></span>‘directory’<span class="_ _1"></span><span class="ls52a">’a<span class="_ _b"></span><span class="ls0">nd <span class="_ _9"></span>a <span class="_ _23"></span>link <span class="_ _9"></span>count <span class="_ _23"></span>that <span class="_ _9"></span>is <span class="_ _23"></span>gr<span class="_ _0"></span>eater <span class="_ _9"></span>than <span class="_ _23"></span>or</span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">equal <span class="_ _42"> </span>to <span class="_ _53"> </span>3.<span class="_ _54"> </span><span class="ls5f">We <span class="_ _35"> </span>k<span class="_ _9"></span></span>now <span class="_ _42"> </span>that <span class="_ _53"> </span>this <span class="_ _53"> </span>link <span class="_ _42"> </span>count <span class="_ _53"> </span>is <span class="_ _53"> </span>greater <span class="_ _42"> </span>than <span class="_ _42"> </span>or <span class="_ _53"> </span>equal <span class="_ _53"> </span>to <span class="_ _53"> </span>3 <span class="_ _42"> </span>because, <span class="_ _53"> </span>at <span class="_ _53"> </span>a</div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">minimum, <span class="_ _42"> </span>the <span class="_ _42"> </span>i-node <span class="_ _23"> </span>is <span class="_ _42"> </span>pointed <span class="_ _42"> </span>to <span class="_ _42"> </span>from <span class="_ _23"> </span>the <span class="_ _42"> </span>directory <span class="_ _42"> </span>entry <span class="_ _23"> </span>that <span class="_ _42"> </span>names <span class="_ _42"> </span>it <span class="_ _42"> </span>(which <span class="_ _42"> </span>we</div><div class="t m0 x32 h26 y132 ff19 fsf fc0 sc0 ls0 ws0">don’t <span class="_ _2"></span>show <span class="_ _3"></span>in <span class="_ _3"></span>Figur<span class="ls52b">e4<span class="_ _8"></span><span class="ls0">.15), <span class="_ _2"></span>from <span class="_ _3"></span>dot, <span class="_ _2"></span>and <span class="_ _3"></span>from <span class="_ _2"></span>dot-dot <span class="_ _3"></span>in <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">testdir<span class="_ _47"> </span></span>directory<span class="_ _4"></span><span class="ls3e3">.N<span class="_ _1d"></span><span class="ls0">ote</span></span></span></span></div><div class="t m0 x32 h2a y133 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _3"></span>every <span class="_ _3"></span>subdirectory <span class="_ _2"></span>in <span class="_ _3"></span>a <span class="_ _3"></span>parent <span class="_ _3"></span>directory <span class="_ _2"></span>causes <span class="_ _3"></span>the <span class="_ _9"></span>parent <span class="_ _2"></span>directory’s <span class="_ _2"></span>link <span class="_ _3"></span>count <span class="_ _9"></span>to</div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">be increased by 1.</div><div class="t m0 x3f h2a y135 ff19 fsf fc0 sc0 ls0 ws0">This <span class="_ _66"> </span>format <span class="_ _47"> </span>is <span class="_"> </span>similar <span class="_ _47"> </span>to <span class="_ _66"> </span>the <span class="_ _47"> </span>classic <span class="_ _66"> </span>format <span class="_ _66"> </span>of <span class="_ _47"> </span>the <span class="_ _66"> </span>UNIX <span class="_ _47"> </span>ﬁle <span class="_ _66"> </span>system, <span class="_ _47"> </span>which <span class="_"> </span>is</div><div class="t m0 x32 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">described <span class="_ _53"> </span>in <span class="_ _e"> </span>detail <span class="_ _e"> </span>in <span class="_ _e"> </span>Chapter <span class="_ _e"> </span>4 <span class="_ _53"> </span>of <span class="_ _e"> </span>Bach</div><div class="t m0 x114 h2a y5ce ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x115 h2a y136 ff19 fsf fc0 sc0 ls0 ws0">1986</div><div class="t m0 x93 h2a y5ce ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x94 h2a y136 ff19 fsf fc0 sc0 ls85 ws0">.R<span class="_ _64"></span><span class="ls0">efer <span class="_ _e"> </span>to <span class="_ _e"> </span>Chapter <span class="_ _53"> </span>7 <span class="_ _e"> </span>of <span class="_ _e"> </span>McKusick <span class="_ _e"> </span>et</span></div><div class="t m0 x32 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">al.</div><div class="t m0 x1a6 h2a y921 ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x12a h2a y137 ff19 fsf fc0 sc0 ls0 ws0">1996</div><div class="t m0 x135 h2a y921 ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x1a7 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">or <span class="_ _9"></span>Chapter <span class="_ _9"></span>8 <span class="_ _9"></span>of <span class="_ _9"></span>McKusick <span class="_ _9"></span>and <span class="_ _9"></span>Neville-Neil</div><div class="t m0 x1a8 h2a y921 ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x103 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">2005</div><div class="t m0 x1a9 h2a y921 ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x133 h2a y137 ff19 fsf fc0 sc0 ls0 ws0">for <span class="_ _9"></span>additional <span class="_ _9"></span>information</div><div class="t m0 x32 h2a y138 ff19 fsf fc0 sc0 ls0 ws0">on <span class="_ _9"></span>the <span class="_ _9"></span>changes <span class="_ _9"></span>made <span class="_ _9"></span>with <span class="_ _9"></span>the <span class="_ _9"></span>Berkeley <span class="_ _9"></span>fast <span class="_ _23"></span>ﬁle <span class="_ _3"></span>system.<span class="_ _51"> </span>See <span class="_ _3"></span>Chapter <span class="_ _23"></span>15 <span class="_ _9"></span>of <span class="_ _9"></span>McDougall</div><div class="t m0 x32 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">and <span class="_ _2"></span>Mauro</div><div class="t m0 x60 h2a y641 ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x197 h2a y139 ff19 fsf fc0 sc0 ls0 ws0">2007</div><div class="t m0 xae h2a y641 ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x144 h26 y139 ff19 fsf fc0 sc0 ls0 ws0">for <span class="_ _2"></span>details <span class="_ _2"></span>on<span class="_ _47"> </span><span class="ff1a">UFS</span><span class="ls52c">,t<span class="_ _4f"></span><span class="ls0">he <span class="_ _2"></span>Solaris <span class="_ _2"></span>version <span class="_ _2"></span>of <span class="_ _3"></span>the <span class="_ _2"></span>Berkeley <span class="_ _2"></span>fast <span class="_ _2"></span>ﬁle <span class="_ _3"></span>system.</span></span></div><div class="t m0 x32 h26 y13a ff19 fsf fc0 sc0 ls0 ws0">For <span class="_ _42"> </span>information <span class="_ _42"> </span>on <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">HFS<span class="_ _35"> </span></span>ﬁle <span class="_ _53"> </span>system <span class="_ _42"> </span>format <span class="_ _42"> </span>used <span class="_ _42"> </span>in <span class="_ _42"> </span>Mac <span class="_ _42"> </span>OS <span class="_ _42"> </span>X, <span class="_ _42"> </span>see <span class="_ _42"> </span>Chapter <span class="_ _42"> </span>12 <span class="_ _42"> </span>of</div><div class="t m0 x32 h2a y254 ff19 fsf fc0 sc0 ls0 ws0">Singh</div><div class="t m0 xe1 h2a y10ce ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 xe2 h2a y254 ff19 fsf fc0 sc0 ls0 ws0">2006</div><div class="t m0 x1aa h2a y10ce ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x5 h2a y254 ff19 fsf fc0 sc0 ls0 ws0">.</div><div class="t m0 x35 h75 y13c ff16 fs2b fc0 sc0 ls0 ws0">4.15<span class="_ _6d"> </span><span class="ff1f">link</span>,<span class="_ _54"> </span><span class="ff1f">linkat</span>,<span class="_ _54"> </span><span class="ff1f">unlink</span>,<span class="_ _54"> </span><span class="ff1f">unlinkat</span><span class="ls1c3">,a<span class="_ _52"></span><span class="ls0">nd<span class="_ _65"> </span><span class="ff1f">remove<span class="_ _54"> </span></span>Functions</span></span></div><div class="t m0 x32 h2a y6de ff19 fsf fc0 sc0 ls0 ws0">As <span class="_ _2"></span>we <span class="_ _2"></span>saw <span class="_ _3"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>previous section, <span class="_ _3"></span>a <span class="_ _2"></span>ﬁle <span class="_ _2"></span>can <span class="_ _3"></span>have <span class="_ _2"></span>multiple <span class="_ _3"></span>directory entries <span class="_ _3"></span>pointing <span class="_ _2"></span>to</div><div class="t m0 x32 h26 y10cf ff19 fsf fc0 sc0 ls0 ws0">its <span class="_ _2"></span>i-node.<span class="_ _16"> </span><span class="ls5f">We <span class="_ _80"> </span>c<span class="_ _23"></span></span>an <span class="_ _2"></span>use <span class="_ _3"></span>either <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">link<span class="_ _47"> </span></span>function <span class="_ _3"></span>or <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">linkat<span class="_ _47"> </span></span>function <span class="_ _3"></span>to <span class="_ _3"></span>create <span class="_ _2"></span>a <span class="_ _3"></span>link</div><div class="t m0 x32 h2a y10d0 ff19 fsf fc0 sc0 ls0 ws0">to an existing ﬁle.</div><div class="t m0 x3f h57 y10d1 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;unistd.h&gt;</div><div class="t m0 x3f h57 y10d2 ff1a fs2d fc0 sc0 ls0 ws0">int link(const char *<span class="ff1b">existingpath</span><span class="ls15c">,c<span class="_ _1d"></span><span class="ls0">onst char *<span class="ff1b">newpath</span>);</span></span></div><div class="t m0 x3f h57 y10d3 ff1a fs2d fc0 sc0 ls0 ws0">int linkat(int<span class="_"> </span><span class="ff1b">efd</span><span class="ls15c">,c<span class="_ _1d"></span><span class="ls0">onst char *<span class="ff1b">existingpath</span><span class="ls15c">,i<span class="_ _5b"></span><span class="ls0">nt<span class="_"> </span><span class="ff1b">nfd</span><span class="ls15c">,c<span class="_ _1d"></span><span class="ls0">onst char *<span class="ff1b">newpath</span>,</span></span></span></span></span></span></div><div class="t m0 x10c h57 y10d4 ff1a fs2d fc0 sc0 ls0 ws0">int<span class="_"> </span><span class="ff1b">ﬂag</span>);</div><div class="t m0 x103 h5f y10d5 ff19 fs2d fc0 sc0 ls0 ws0">Both return: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x32 h4a y10d6 ff19 fs26 fc0 sc0 ls0 ws0">These <span class="_ _23"> </span>functions <span class="_ _42"> </span>create <span class="_ _23"> </span>a <span class="_ _42"> </span>new <span class="_ _23"> </span>directory <span class="_ _23"> </span>entry<span class="_ _6"></span>,<span class="_ _35"> </span><span class="ff1b">newpath</span><span class="ls52d">,t<span class="_ _43"></span><span class="ls0">hat <span class="_ _42"> </span>refer<span class="_ _1"></span>ences <span class="_ _42"> </span>the <span class="_ _42"> </span>existing <span class="_ _23"> </span>ﬁle</span></span></div><div class="t m0 x32 h4a y10d7 ff1b fs26 fc0 sc0 ls0 ws0">existingpath<span class="ff19 ls52e">.I<span class="_ _5b"></span><span class="ls52f">ft<span class="_ _d"></span><span class="ls0">he<span class="_"> </span><span class="ff1b">newpath<span class="_ _66"> </span></span>already <span class="_ _2"></span>exists, an <span class="_ _2"></span>error is <span class="_ _2"></span>returned. <span class="_"> </span>Only<span class="_ _66"> </span>the <span class="_ _2"></span>last component</span></span></span></div><div class="t m0 x32 h4a y10d8 ff19 fs26 fc0 sc0 ls0 ws0">of the<span class="_"> </span><span class="ff1b">newpath<span class="_"> </span></span>is created. <span class="_"> </span>The<span class="_"> </span><span class="lscc">re</span>st of the path must already exist.</div><div class="t m0 x3f h4d y10d9 ff19 fs26 fc0 sc0 ls3aa ws0">Wi<span class="_ _3"></span><span class="ls0">th <span class="_ _45"> </span>the<span class="_ _51"> </span><span class="ff1a">linkat<span class="_"> </span></span>function, <span class="_ _45"> </span>the <span class="_ _35"> </span>existing <span class="_ _45"> </span>ﬁle <span class="_ _35"> </span>is <span class="_ _45"> </span>speciﬁed <span class="_ _45"> </span>by <span class="_ _35"> </span>both <span class="_ _45"> </span>the<span class="_ _5a"> </span><span class="ff1b">efd<span class="_ _51"> </span></span>and</span></div><div class="t m0 x32 h4a y10da ff1b fs26 fc0 sc0 ls0 ws0">existingpath<span class="_ _47"> </span><span class="ff19">arguments, <span class="_ _2"></span>and <span class="_ _3"></span>the <span class="_ _3"></span>new <span class="_ _3"></span>pathname <span class="_ _9"></span>is <span class="_ _2"></span>speciﬁed <span class="_ _9"></span>by <span class="_ _2"></span>both <span class="_ _9"></span>the<span class="_ _47"> </span></span>nfd<span class="_ _47"> </span><span class="ff19">and<span class="_ _47"> </span></span>newpath</div><div class="t m0 x32 h49 y10db ff19 fs26 fc0 sc0 ls0 ws0">arguments. <span class="_ _4b"> </span>By<span class="_ _4b"> </span>default, <span class="_"> </span>if <span class="_ _53"> </span>either <span class="_"> </span>pathname <span class="_ _53"> </span>is <span class="_"> </span>r<span class="_ _0"></span>elative, <span class="_ _e"> </span>it <span class="_"> </span>is <span class="_ _53"> </span>evaluated <span class="_"> </span>r<span class="_ _1"></span>elative <span class="_"> </span>to <span class="_ _53"> </span>the</div><div class="t m0 x32 h4d y10dc ff19 fs26 fc0 sc0 ls0 ws0">corresponding <span class="_"> </span>ﬁle <span class="_ _e"> </span>descriptor<span class="_ _1"></span><span class="ls530">.I<span class="_ _5d"></span><span class="ls531">fe<span class="_ _4a"></span><span class="ls0">ither <span class="_"> </span>ﬁle <span class="_"> </span>descriptor <span class="_"> </span>is <span class="_"> </span>set <span class="_ _e"> </span>to<span class="_ _46"> </span><span class="ff1a">AT_FDCWD</span><span class="ls531">,t<span class="_ _4a"></span><span class="ls0">hen <span class="_"> </span>the</span></span></span></span></span></div><div class="t m0 x32 h49 y10dd ff19 fs26 fc0 sc0 ls0 ws0">corresponding pathname, <span class="_ _2"></span>if it <span class="_ _2"></span>is <span class="_ _2"></span>a <span class="_ _2"></span>relative pathname, <span class="_ _2"></span>is <span class="_ _2"></span>evaluated <span class="_ _2"></span>relative to <span class="_ _2"></span>the <span class="_ _2"></span>current</div><div class="t m0 x32 h49 y10de ff19 fs26 fc0 sc0 ls0 ws0">directory<span class="_ _4"></span><span class="ls532">.I<span class="_ _4d"></span><span class="ls533">fe<span class="_ _52"></span><span class="ls0">ither <span class="_ _35"> </span>pathname <span class="_ _44"> </span>is <span class="_ _44"> </span>absolute, <span class="_ _35"> </span>then <span class="_ _44"> </span>the <span class="_ _44"> </span>corresponding <span class="_ _35"> </span>ﬁle <span class="_ _44"> </span>descriptor</span></span></span></div><div class="t m0 x32 h49 y10df ff19 fs26 fc0 sc0 ls0 ws0">argument is ignor<span class="_ _0"></span>ed.</div><div class="t m0 x3f h4a y10e0 ff19 fs26 fc0 sc0 ls0 ws0">When <span class="_ _42"> </span>the <span class="_ _42"> </span>existing <span class="_ _53"> </span>ﬁle <span class="_ _42"> </span>is <span class="_ _42"> </span>a <span class="_ _53"> </span>symbolic <span class="_ _42"> </span>link, <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1b">ﬂag<span class="_ _44"> </span></span>argument <span class="_ _42"> </span>controls <span class="_ _42"> </span>whether <span class="_ _42"> </span>the</div><div class="t m0 x32 h4d y10e1 ff1a fs26 fc0 sc0 ls0 ws0">linkat<span class="_ _47"> </span><span class="ff19">function <span class="_ _3"></span>creates <span class="_ _3"></span>a <span class="_ _3"></span>link <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>symbolic <span class="_ _9"></span>link <span class="_ _3"></span>or <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>ﬁle <span class="_ _3"></span>to <span class="_ _9"></span>which <span class="_ _3"></span>the <span class="_ _3"></span>symbolic</span></div><div class="t m0 x32 h4d y10e2 ff19 fs26 fc0 sc0 ls0 ws0">link <span class="_ _9"></span>points.<span class="_ _16"> </span>If <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">AT_SYMLINK_FOLLOW<span class="_ _45"> </span></span>ﬂag <span class="_ _3"></span>is <span class="_ _9"></span>set <span class="_ _9"></span>in <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1b">ﬂag<span class="_ _47"> </span></span>argument, <span class="_ _9"></span>then <span class="_ _9"></span>a <span class="_ _3"></span>link <span class="_ _9"></span>is</div><div class="t m0 x32 h49 y10e3 ff19 fs26 fc0 sc0 ls0 ws0">created to the <span class="_ _2"></span>target of <span class="_ _2"></span>the <span class="_ _2"></span>symbolic <span class="_ _2"></span>link.<span class="_ _46"> </span>If <span class="_ _2"></span>this <span class="_ _2"></span>ﬂag <span class="_ _2"></span>is <span class="_ _2"></span>clear<span class="_ _6"></span><span class="ls534">,t<span class="_ _d"></span><span class="ls0">hen <span class="_ _2"></span>a link <span class="_ _2"></span>is <span class="_ _2"></span>created to <span class="_ _2"></span>the</span></span></div><div class="t m0 x32 h49 y10e4 ff19 fs26 fc0 sc0 ls0 ws0">symbolic link itself.</div><div class="t m0 x3f h49 y10e5 ff19 fs26 fc0 sc0 ls0 ws0">The <span class="_ _2"></span>creation of <span class="_ _2"></span>the <span class="_ _2"></span>new <span class="_ _2"></span>directory <span class="_ _2"></span>entry <span class="_ _2"></span>and <span class="_ _2"></span>the <span class="_ _2"></span>increment of <span class="_ _3"></span>the <span class="_ _2"></span>link <span class="_ _2"></span>count <span class="_ _2"></span>must <span class="_ _2"></span>be</div><div class="t m0 x32 h49 y10e6 ff19 fs26 fc0 sc0 ls0 ws0">an atomic operation.<span class="_ _59"> </span>(Recall the discussion of atomic operations in Section 3.1<span class="_ _0"></span>1.)</div><a class="l" href="#pfd" data-dest-detail='[13,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.893259px;bottom:858.288916px;width:384.047409px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
