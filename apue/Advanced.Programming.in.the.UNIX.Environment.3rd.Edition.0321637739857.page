<div id="pf359" class="pf w4 h1f" data-page-no="359"><div class="pc pc359 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg359.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">823</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">318 <span class="_ _15"> </span>while<span class="_"> </span>((entp = readdir(dirp)) != NULL) {</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">319 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">320 <span class="_ _176"> </span>*<span class="_"> </span>Skip &quot;.&quot; and &quot;..&quot;</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">321 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">322 <span class="_ _186"> </span>if<span class="_"> </span>(strcmp(entp-&gt;d_name, &quot;.&quot;) == 0 ||</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">323 <span class="_ _74"> </span>strcmp(entp-&gt;d_name,<span class="_"> </span>&quot;..&quot;) == 0)</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">324 <span class="_ _82"> </span>continue;</div><div class="t m0 x32 h57 y1fb9 ff1a fs2d fc0 sc0 ls0 ws0">325 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y1fba ff1a fs2d fc0 sc0 ls0 ws0">326 <span class="_ _176"> </span>*<span class="_"> </span>Read the request structure.</div><div class="t m0 x32 h57 y1fbb ff1a fs2d fc0 sc0 ls0 ws0">327 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y1fbc ff1a fs2d fc0 sc0 ls0 ws0">328 <span class="_ _186"> </span>sprintf(fname,<span class="_"> </span>&quot;%s/%s/%s&quot;, SPOOLDIR, REQDIR, entp-&gt;d_name);</div><div class="t m0 x32 h57 y1fbd ff1a fs2d fc0 sc0 ls0 ws0">329 <span class="_ _186"> </span>if<span class="_"> </span>((fd = open(fname, O_RDONLY)) &lt; 0)</div><div class="t m0 x32 h57 y1fbe ff1a fs2d fc0 sc0 ls0 ws0">330 <span class="_ _82"> </span>continue;</div><div class="t m0 x32 h57 y1fbf ff1a fs2d fc0 sc0 ls0 ws0">331 <span class="_ _186"> </span>nr<span class="_"> </span><span class="ls15c">=r<span class="_ _1d"></span><span class="ls0">ead(fd, &amp;req, sizeof(struct printreq));</span></span></div><div class="t m0 x32 h57 y1fc0 ff1a fs2d fc0 sc0 ls0 ws0">332 <span class="_ _186"> </span>if<span class="_"> </span>(nr != sizeof(struct printreq)) {</div><div class="t m0 x32 h57 y1fc1 ff1a fs2d fc0 sc0 ls0 ws0">333 <span class="_ _82"> </span>if<span class="_"> </span>(nr &lt; 0)</div><div class="t m0 x32 h57 y1fc2 ff1a fs2d fc0 sc0 ls0 ws0">334 <span class="_ _1e7"> </span>err<span class="_"> </span><span class="ls15c">=e<span class="_ _1d"></span><span class="ls0">rrno;</span></span></div><div class="t m0 x32 h57 y1fc3 ff1a fs2d fc0 sc0 ls0 ws0">335 <span class="_ _82"> </span>else</div><div class="t m0 x32 h57 y1fc4 ff1a fs2d fc0 sc0 ls0 ws0">336 <span class="_ _1e7"> </span>err<span class="_"> </span><span class="ls15c">=E<span class="_ _1d"></span><span class="ls0">IO;</span></span></div><div class="t m0 x32 h57 y1fc5 ff1a fs2d fc0 sc0 ls0 ws0">337 <span class="_ _82"> </span>close(fd);</div><div class="t m0 x32 h57 y3b4e ff1a fs2d fc0 sc0 ls0 ws0">338 <span class="_ _82"> </span>log_msg(&quot;build_qonstart:<span class="_"> </span>can’t read %s: %s&quot;,</div><div class="t m0 x32 h57 y57b4 ff1a fs2d fc0 sc0 ls0 ws0">339 <span class="_ _12d"> </span>fname,<span class="_"> </span>strerror(err));</div><div class="t m0 x32 h57 y419b ff1a fs2d fc0 sc0 ls0 ws0">340 <span class="_ _82"> </span>unlink(fname);</div><div class="t m0 x32 h57 y419c ff1a fs2d fc0 sc0 ls0 ws0">341 <span class="_ _82"> </span>sprintf(fname,<span class="_"> </span>&quot;%s/%s/%s&quot;, SPOOLDIR, DATADIR,</div><div class="t m0 x32 h57 y5bef ff1a fs2d fc0 sc0 ls0 ws0">342 <span class="_ _12d"> </span>entp-&gt;d_name);</div><div class="t m0 x32 h57 y5bf0 ff1a fs2d fc0 sc0 ls0 ws0">343 <span class="_ _82"> </span>unlink(fname);</div><div class="t m0 x32 h57 y5bf1 ff1a fs2d fc0 sc0 ls0 ws0">344 <span class="_ _82"> </span>continue;</div><div class="t m0 x32 h57 y568e ff1a fs2d fc0 sc0 ls0 ws0">345 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y5bf2 ff1a fs2d fc0 sc0 ls0 ws0">346 <span class="_ _186"> </span>jobid<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">tol(entp-&gt;d_name);</span></span></div><div class="t m0 x32 h57 y5bf3 ff1a fs2d fc0 sc0 ls0 ws0">347 <span class="_ _186"> </span>log_msg(&quot;adding<span class="_"> </span>job %d to queue&quot;, jobid);</div><div class="t m0 x32 h57 y5bf4 ff1a fs2d fc0 sc0 ls0 ws0">348 <span class="_ _186"> </span>add_job(&amp;req,<span class="_"> </span>jobid);</div><div class="t m0 x32 h57 y5bf5 ff1a fs2d fc0 sc0 ls0 ws0">349 <span class="_ _15"> </span>}</div><div class="t m0 x32 h57 y5bf6 ff1a fs2d fc0 sc0 ls0 ws0">350 <span class="_ _15"> </span>closedir(dirp);</div><div class="t m0 x32 h57 y5bf7 ff1a fs2d fc0 sc0 ls0 ws0">351 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h49 y5733 ff19 fs26 fc0 sc0 ls0 ws0">[318 <span class="_ _a"></span>– <span class="_ _a"></span>324]<span class="_ _65"> </span><span class="ls164">We <span class="_ _53"> </span>r<span class="_ _9"></span></span>ead each entry in the directory<span class="_ _4"></span><span class="ls10bc">,o<span class="_ _5"></span><span class="ls0">ne at a time.<span class="_ _46"> </span><span class="ls164">We <span class="_ _53"> </span>s<span class="_ _23"></span></span>kip the entries for dot</span></span></div><div class="t m0 x11a h49 y5734 ff19 fs26 fc0 sc0 ls0 ws0">and dot-dot.</div><div class="t m0 x32 h49 y5bf8 ff19 fs26 fc0 sc0 ls0 ws0">[325 <span class="_ _a"></span>– <span class="_ _a"></span>345]<span class="_ _65"> </span>For <span class="_"> </span>each <span class="_ _47"> </span>entry<span class="_ _4"></span>,<span class="_ _61"> </span>we<span class="_ _46"> </span>c<span class="lscc">re<span class="_ _2"></span></span>ate <span class="_ _66"> </span>the <span class="_ _47"> </span>full <span class="_"> </span>pathname <span class="_ _66"> </span>of <span class="_ _47"> </span>the <span class="_"> </span>ﬁle <span class="_ _66"> </span>and <span class="_ _47"> </span>open <span class="_"> </span>it <span class="_ _66"> </span>for</div><div class="t m0 x11a h4d y5bf9 ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ading. <span class="_ _45"> </span>If<span class="_ _47"> </span>the<span class="_ _45"> </span><span class="ff1a">open<span class="_ _47"> </span></span>call <span class="_ _9"></span>fails, <span class="_ _3"></span>we <span class="_ _9"></span>just <span class="_ _9"></span>skip <span class="_ _3"></span>the <span class="_ _9"></span>ﬁle.<span class="_ _16"> </span>Otherwise, <span class="_ _9"></span>we <span class="_ _3"></span>read <span class="_ _3"></span>the</span></div><div class="t m0 x11a h4d y5737 ff1a fs26 fc0 sc0 ls0 ws0">printreq<span class="_ _35"> </span><span class="ff19">structur<span class="ls1186">es<span class="_ _43"></span><span class="ls0">tor<span class="_ _0"></span>ed <span class="_ _23"> </span>in <span class="_ _42"> </span>it.<span class="_ _54"> </span>If <span class="_ _23"> </span>we <span class="_ _42"> </span>don’t <span class="_ _42"> </span>read <span class="_ _23"></span>the <span class="_ _42"> </span>entir<span class="ls17a1">es<span class="_ _c"></span><span class="ls0">tructure, <span class="_ _23"> </span>we</span></span></span></span></span></div><div class="t m0 x11a h49 y5738 ff19 fs26 fc0 sc0 ls0 ws0">close <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle, <span class="_ _9"></span>log <span class="_ _9"></span>an <span class="_ _9"></span>error <span class="_ _9"></span>message, <span class="_ _9"></span>and <span class="_ _9"></span>unlink <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle.<span class="_ _5a"> </span>Then <span class="_ _9"></span>we <span class="_ _9"></span>create <span class="_ _9"></span>the</div><div class="t m0 x11a h49 y5739 ff19 fs26 fc0 sc0 ls0 ws0">full pathname of the corresponding data ﬁle and unlink it, too.</div><div class="t m0 x32 h4d y5bfa ff19 fs26 fc0 sc0 ls0 ws0">[346 <span class="_ _a"></span>– <span class="_ _a"></span>351]<span class="_ _65"> </span>If <span class="_ _e"> </span>we <span class="_ _e"> </span>wer<span class="ls17a2">ea<span class="_ _55"></span><span class="ls0">ble <span class="_ _e"> </span>to <span class="_ _e"> </span>read <span class="_ _e"> </span>a <span class="_ _e"> </span>complete<span class="_ _59"> </span><span class="ff1a">printreq<span class="_ _59"> </span></span>structur<span class="_ _0"></span>e, <span class="_ _e"> </span>we <span class="_ _e"> </span>convert <span class="_"> </span>the</span></span></div><div class="t m0 x11a h49 y5bfb ff19 fs26 fc0 sc0 ls0 ws0">ﬁlename <span class="_ _3"></span>into <span class="_ _3"></span>a <span class="_ _9"></span>job <span class="_ _3"></span>ID <span class="_ _3"></span>(the <span class="_ _9"></span>name <span class="_ _3"></span>of <span class="_ _3"></span>the <span class="_ _9"></span>ﬁle <span class="_ _3"></span>is <span class="_ _3"></span>its <span class="_ _9"></span>job <span class="_ _3"></span>ID), <span class="_ _3"></span>log <span class="_ _9"></span>a <span class="_ _3"></span>message, <span class="_ _3"></span>and</div><div class="t m0 x11a h49 y573c ff19 fs26 fc0 sc0 ls0 ws0">then <span class="_ _23"> </span>add <span class="_ _42"> </span>the <span class="_ _42"> </span>request <span class="_ _23"> </span>to <span class="_ _42"> </span>the <span class="_ _42"> </span>list <span class="_ _23"> </span>of <span class="_ _42"> </span>pending <span class="_ _42"> </span>print <span class="_ _23"> </span>jobs.<span class="_ _54"> </span>When <span class="_ _42"> </span>we <span class="_ _23"> </span>ar<span class="ls1186">ed<span class="_ _43"></span><span class="ls0">one</span></span></div><div class="t m0 x11a h4d y573d ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">ading <span class="_ _3"></span>the <span class="_ _2"></span>directory<span class="_ _4"></span>,<span class="_ _47"> </span><span class="ff1a">readdir<span class="_ _66"> </span></span>will <span class="_ _2"></span>return<span class="_ _66"> </span><span class="ff1a">NULL</span><span class="ls17a3">,a<span class="_ _4f"></span><span class="ls0">nd <span class="_ _3"></span>we <span class="_ _2"></span>close <span class="_ _2"></span>the <span class="_ _3"></span>directory</span></span></span></div><div class="t m0 x11a h49 y573e ff19 fs26 fc0 sc0 ls0 ws0">and return.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
