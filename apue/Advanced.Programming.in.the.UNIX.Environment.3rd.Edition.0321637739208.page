<div id="pfd0" class="pf w4 h1f" data-page-no="d0"><div class="pc pcd0 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bgd0.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">174<span class="_ _1b"> </span><span class="ff19">Standar<span class="ls30a">dI<span class="_ _55"></span><span class="ls0">/O <span class="_"> </span>Library<span class="_ _1c9"> </span>Chapter <span class="_"> </span>5</span></span></span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _54"> </span><span class="ff1a">open_memstream<span class="_ _54"> </span></span>function <span class="_ _44"> </span>creates <span class="_ _35"> </span>a <span class="_ _44"> </span>stream <span class="_ _44"> </span>that <span class="_ _44"> </span>is <span class="_ _35"> </span>byte <span class="_ _44"> </span>oriented, <span class="_ _44"> </span>and <span class="_ _44"> </span>the</div><div class="t m0 x32 h26 y130 ff1a fsf fc0 sc0 ls0 ws0">open_wmemstream<span class="_ _48"> </span><span class="ff19">function <span class="_ _59"> </span>creates <span class="_ _59"> </span>a <span class="_ _59"> </span>stream <span class="_ _4b"> </span>that <span class="_ _59"> </span>is <span class="_ _59"> </span>wide <span class="_ _46"> </span>oriented <span class="_ _59"> </span>(recall <span class="_ _4b"> </span>the</span></div><div class="t m0 x32 h2a y131 ff19 fsf fc0 sc0 ls0 ws0">discussion <span class="_"> </span>of <span class="_"> </span>multibyte <span class="_"> </span>characters <span class="_"> </span>in <span class="_"> </span>Section <span class="_ _66"> </span>5.2).<span class="_ _60"> </span>These <span class="_ _66"> </span>two <span class="_"> </span>functions <span class="_"> </span>differ <span class="_"> </span>from</div><div class="t m0 x32 h26 y132 ff1a fsf fc0 sc0 ls0 ws0">fmemopen<span class="_ _80"> </span><span class="ff19">in several ways:</span></div><div class="t m0 x3f h2a y345 ff19 fsf fc0 sc0 ls49 ws0">•T<span class="_ _4d"></span><span class="ls0">he stream cr<span class="_ _0"></span>eated is only open for writing.</span></div><div class="t m0 x3f h2a y1541 ff19 fsf fc0 sc0 ls49 ws0">•W<span class="_ _4e"></span><span class="ls744">ec<span class="_ _b"></span><span class="ls0">an’t <span class="_ _23"></span>specify <span class="_ _9"></span>our <span class="_ _23"> </span>own <span class="_ _23"> </span>buffer<span class="_ _6"></span><span class="ls745">,b<span class="_ _b"></span><span class="ls0">ut <span class="_ _23"></span>we <span class="_ _23"></span>can <span class="_ _23"></span>get <span class="_ _23"></span>access <span class="_ _23"></span>to <span class="_ _23"></span>the <span class="_ _9"></span>buffer <span class="_ _a"></span>’s<span class="_ _35"> </span>address</span></span></span></span></div><div class="t m0 x15 h2b y940 ff19 fsf fc0 sc0 ls0 ws0">and size through the<span class="_"> </span><span class="ff1b">bufp<span class="_"> </span></span>and<span class="_"> </span><span class="ff1b">sizep<span class="_"> </span></span>ar<span class="_ _0"></span>guments, r<span class="_ _0"></span>espectively<span class="_ _4"></span>.</div><div class="t m0 x3f h2a y1542 ff19 fsf fc0 sc0 ls49 ws0">•W<span class="_ _4e"></span><span class="ls44">en<span class="_ _5"></span><span class="ls0">eed to free the buf<span class="_ _1"></span>fer ourselves after closing the stream.</span></span></div><div class="t m0 x3f h2a y1d2 ff19 fsf fc0 sc0 ls49 ws0">•T<span class="_ _4d"></span><span class="ls0">he buffer will gr<span class="_ _0"></span>ow as we add bytes to the str<span class="_ _0"></span>eam.</span></div><div class="t m0 x3f h2a y17f8 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>m<span class="_ _9"></span><span class="ls0">ust follow <span class="_ _2"></span>some rules, however<span class="_ _1"></span><span class="ls746">,r<span class="_ _4f"></span><span class="ls0">egarding the use of the buffer address and its</span></span></span></div><div class="t m0 x32 h26 y17f9 ff19 fsf fc0 sc0 ls0 ws0">length. <span class="_ _44"> </span>First,<span class="_ _44"> </span>the <span class="_ _53"> </span>buffer <span class="_ _42"> </span>address <span class="_ _42"> </span>and <span class="_ _53"> </span>length <span class="_ _53"> </span>ar<span class="ls747">eo<span class="_ _c"></span><span class="ls0">nly <span class="_ _42"> </span>valid <span class="_ _53"> </span>after <span class="_ _53"> </span>a <span class="_ _53"> </span>call <span class="_ _53"> </span>to<span class="_ _44"> </span><span class="ff1a">fclose<span class="_ _44"> </span></span>or</span></span></div><div class="t m0 x32 h26 y17fa ff1a fsf fc0 sc0 ls0 ws0">fflush<span class="ff19 ls748">.S<span class="_ _1d"></span><span class="ls0">econd, <span class="_ _3"></span>these <span class="_ _3"></span>values <span class="_ _2"></span>ar<span class="ls749">eo<span class="_ _8"></span><span class="ls0">nly <span class="_ _3"></span>valid <span class="_ _3"></span>until <span class="_ _3"></span>the <span class="_ _3"></span>next <span class="_ _3"></span>write <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _2"></span>stream <span class="_ _3"></span>or <span class="_ _3"></span>a <span class="_ _2"></span>call</span></span></span></span></div><div class="t m0 x32 h26 y17fb ff19 fsf fc0 sc0 ls0 ws0">to<span class="_ _66"> </span><span class="ff1a">fclose</span><span class="ls74a">.B<span class="_ _5b"></span><span class="ls0">ecause <span class="_ _2"></span>the <span class="_ _2"></span>buffer can <span class="_ _3"></span>grow<span class="_ _4"></span>,<span class="_ _47"> </span>it<span class="_"> </span>may <span class="_ _2"></span>need <span class="_ _2"></span>to <span class="_ _2"></span>be <span class="_ _3"></span>reallocated. <span class="_"> </span>If<span class="_ _66"> </span>this <span class="_ _2"></span>happens,</span></span></div><div class="t m0 x32 h2a y17fc ff19 fsf fc0 sc0 ls0 ws0">then <span class="_ _23"></span>we <span class="_ _23"> </span>will <span class="_ _23"> </span>ﬁnd <span class="_ _23"> </span>that <span class="_ _42"> </span>the <span class="_ _23"></span>value <span class="_ _23"></span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>buffer <span class="_ _84"></span>’s<span class="_ _35"> </span>memory <span class="_ _23"> </span>address <span class="_ _23"> </span>will <span class="_ _23"> </span>change <span class="_ _23"> </span>the <span class="_ _42"> </span>next</div><div class="t m0 x32 h26 y17fd ff19 fsf fc0 sc0 ls0 ws0">time we call<span class="_"> </span><span class="ff1a">fclose<span class="_ _80"> </span></span>or<span class="_"> </span><span class="ff1a">fflush</span>.</div><div class="t m0 x3f h2a y17fe ff19 fsf fc0 sc0 ls0 ws0">Memory <span class="_ _42"> </span>streams <span class="_ _23"> </span>ar<span class="ls74b">ew<span class="_ _43"></span><span class="ls0">ell <span class="_ _23"> </span>suited <span class="_ _42"> </span>for <span class="_ _42"> </span>creating <span class="_ _23"> </span>strings, <span class="_ _42"> </span>because <span class="_ _42"> </span>they <span class="_ _42"> </span>prevent <span class="_ _23"> </span>buffer</span></span></div><div class="t m0 x32 h2a y17ff ff19 fsf fc0 sc0 ls0 ws0">overﬂows. <span class="_ _47"> </span>They<span class="_ _47"> </span>can <span class="_ _3"></span>also <span class="_ _3"></span>provide <span class="_ _2"></span>a <span class="_ _3"></span>performance <span class="_ _9"></span>boost <span class="_ _2"></span>for <span class="_ _3"></span>functions <span class="_ _3"></span>that <span class="_ _9"></span>take <span class="_ _2"></span>standard</div><div class="t m0 x32 h2a y1800 ff19 fsf fc0 sc0 ls0 ws0">I/O <span class="_ _23"></span>stream <span class="_ _9"></span>arguments <span class="_ _23"> </span>used <span class="_ _23"> </span>for <span class="_ _23"> </span>temporary <span class="_ _23"> </span>ﬁles, <span class="_ _23"> </span>because <span class="_ _42"> </span>memory <span class="_ _23"></span>streams <span class="_ _9"></span>access <span class="_ _23"> </span>only</div><div class="t m0 x32 h2a y1801 ff19 fsf fc0 sc0 ls0 ws0">main memory instead of a ﬁle stored on disk.</div><div class="t m0 x35 h53 y1802 ff16 fs2b fc0 sc0 ls0 ws0">5.15 <span class="_ _93"> </span>Alternatives<span class="_ _54"> </span>to <span class="_"> </span>Standar<span class="ls1c3">dI<span class="_ _52"></span><span class="ls0">/O</span></span></div><div class="t m0 x32 h2a y165 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _46"> </span>standar<span class="ls74c">dI<span class="_ _49"></span><span class="ls0">/O <span class="_ _46"> </span>library <span class="_ _61"> </span>is <span class="_ _61"> </span>not <span class="_ _61"> </span>perfect.<span class="_ _d9"> </span>Korn <span class="_ _46"> </span>and <span class="_ _61"> </span>V<span class="_ _6"></span>o</span></span></div><div class="t m0 x102 h2a y1803 ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x49 h2a y165 ff19 fsf fc0 sc0 ls0 ws0">1991</div><div class="t m0 x10e h2a y1803 ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x1c3 h2a y165 ff19 fsf fc0 sc0 ls0 ws0">list <span class="_ _46"> </span>numerous</div><div class="t m0 x32 h2a y167 ff19 fsf fc0 sc0 ls0 ws0">defects <span class="_ _a"></span>— <span class="_ _a"></span>some<span class="_"> </span>in the basic design, but most in the various implementations.</div><div class="t m0 x3f h2a y168 ff19 fsf fc0 sc0 ls0 ws0">One <span class="_ _2"></span>inefﬁciency <span class="_ _2"></span>inherent <span class="_ _2"></span>in <span class="_ _2"></span>the <span class="_ _3"></span>standar<span class="ls74d">dI<span class="_ _8"></span><span class="ls0">/O <span class="_ _2"></span>library <span class="_ _3"></span>is <span class="_ _2"></span>the <span class="_ _3"></span>amount <span class="_ _2"></span>of <span class="_ _3"></span>data <span class="_ _2"></span>copying</span></span></div><div class="t m0 x32 h26 y169 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _2"></span>takes <span class="_ _2"></span>place.<span class="_ _16"> </span>When <span class="_ _2"></span>we <span class="_ _2"></span>use <span class="_ _3"></span>the <span class="_ _2"></span>line-at-a-time <span class="_ _2"></span>functions,<span class="_ _47"> </span><span class="ff1a">fgets<span class="_ _47"> </span></span>and<span class="_ _66"> </span><span class="ff1a">fputs</span><span class="ls74e">,t<span class="_ _4f"></span><span class="ls0">he <span class="_ _3"></span>data</span></span></div><div class="t m0 x32 h2a y16a ff19 fsf fc0 sc0 ls0 ws0">is usually <span class="_ _2"></span>copied <span class="_ _2"></span>twice: <span class="_ _2"></span>once <span class="_ _2"></span>between <span class="_ _2"></span>the <span class="_ _2"></span>kernel <span class="_ _2"></span>and <span class="_ _2"></span>the <span class="_ _2"></span>standar<span class="ls74f">dI<span class="_ _4f"></span><span class="ls0">/O <span class="_ _2"></span>buffer (when <span class="_ _2"></span>the</span></span></div><div class="t m0 x32 h26 y16b ff19 fsf fc0 sc0 ls0 ws0">corresponding<span class="_ _35"> </span><span class="ff1a">read<span class="_ _35"> </span></span>or<span class="_ _44"> </span><span class="ff1a">write<span class="_ _35"> </span></span>is <span class="_ _42"> </span>issued) <span class="_ _42"> </span>and <span class="_ _42"> </span>again <span class="_ _23"> </span>between <span class="_ _42"> </span>the <span class="_ _42"> </span>standar<span class="ls750">dI<span class="_ _43"></span><span class="ls0">/O <span class="_ _23"> </span>buffer</span></span></div><div class="t m0 x32 h26 y16c ff19 fsf fc0 sc0 ls0 ws0">and <span class="_ _9"></span>our <span class="_ _23"> </span>line <span class="_ _23"></span>buffer<span class="_ _6"></span><span class="ls751">.T<span class="_ _26"></span><span class="ls0">he <span class="_ _23"></span>Fast <span class="_ _9"></span>I/O <span class="_ _23"></span>library <span class="_ _23"></span>[<span class="ff1a">fio</span>(3) <span class="_ _9"></span>in <span class="_ _23"> </span>A<span class="_ _1"></span>T&amp;T <span class="_ _9"></span>1990a] <span class="_ _23"> </span>gets <span class="_ _23"></span>around <span class="_ _9"></span>this <span class="_ _23"></span>by</span></span></div><div class="t m0 x32 h2a y16d ff19 fsf fc0 sc0 ls0 ws0">having <span class="_ _3"></span>the <span class="_ _9"></span>function <span class="_ _3"></span>that <span class="_ _9"></span>reads <span class="_ _3"></span>a <span class="_ _3"></span>line <span class="_ _9"></span>return <span class="_ _3"></span>a <span class="_ _9"></span>pointer <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _3"></span>line <span class="_ _9"></span>instead <span class="_ _3"></span>of <span class="_ _9"></span>copying <span class="_ _3"></span>the</div><div class="t m0 x32 h2a y25c ff19 fsf fc0 sc0 ls0 ws0">line <span class="_ _53"> </span>into <span class="_ _53"> </span>another <span class="_ _e"> </span>buffer<span class="_ _6"></span><span class="ls752">.H<span class="_ _64"></span><span class="ls0">ume</span></span></div><div class="t m0 x1b7 h2a yeae ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x157 h2a y25c ff19 fsf fc0 sc0 ls0 ws0">1988</div><div class="t m0 x9b h2a yeae ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x18c h2a y25c ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ports <span class="_ _e"> </span>a <span class="_ _53"> </span>threefold <span class="_ _53"> </span>increase <span class="_ _42"> </span>in <span class="_ _e"> </span>the <span class="_ _53"> </span>speed <span class="_ _e"> </span>of <span class="_ _53"> </span>a</span></div><div class="t m0 x32 h26 y25d ff19 fsf fc0 sc0 ls0 ws0">version of the<span class="_"> </span><span class="ff1a">grep</span></div><div class="t m0 x126 h2a y1804 ff19 fsf fc0 sc0 ls0 ws0">(</div><div class="t m0 x38 h2a y25d ff19 fsf fc0 sc0 ls0 ws0">1</div><div class="t m0 x1ce h2a y1804 ff19 fsf fc0 sc0 ls0 ws0">)</div><div class="t m0 x134 h2a y25d ff19 fsf fc0 sc0 ls0 ws0">utility simply by making this change.</div><div class="t m0 x3f h2a y1805 ff19 fsf fc0 sc0 ls0 ws0">Korn <span class="_ _3"></span>and <span class="_ _3"></span>V<span class="_ _6"></span>o</div><div class="t m0 x12f h2a y1806 ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x144 h2a y1805 ff19 fsf fc0 sc0 ls0 ws0">1991</div><div class="t m0 x134 h2a y1806 ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 x36 h2b y1805 ff19 fsf fc0 sc0 ls0 ws0">describe <span class="_ _3"></span>another <span class="_ _3"></span>replacement <span class="_ _3"></span>for <span class="_ _3"></span>the <span class="_ _9"></span>standar<span class="ls753">dI<span class="_ _b"></span><span class="ls0">/O <span class="_ _3"></span>library:<span class="_ _45"> </span><span class="ff1b">sﬁo</span>.</span></span></div><div class="t m0 x32 h2b y1807 ff19 fsf fc0 sc0 ls0 ws0">This <span class="_ _2"></span>package <span class="_ _3"></span>is <span class="_ _3"></span>similar <span class="_ _3"></span>in <span class="_ _3"></span>speed <span class="_ _3"></span>to <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1b">ﬁo<span class="_ _47"> </span></span>library <span class="_ _2"></span>and <span class="_ _3"></span>normally <span class="_ _3"></span>faster <span class="_ _3"></span>than <span class="_ _3"></span>the <span class="_ _3"></span>standard</div><div class="t m0 x32 h2b y1808 ff19 fsf fc0 sc0 ls0 ws0">I/O library<span class="_ _6"></span><span class="ls754">.T<span class="_ _5b"></span><span class="ls0">he<span class="_ _66"> </span><span class="ff1b">sﬁo<span class="_ _47"> </span></span>package also <span class="_ _2"></span>provides some <span class="_ _2"></span>new <span class="_ _2"></span>features that <span class="_ _2"></span>aren’t found <span class="_ _2"></span>in <span class="_ _2"></span>most</span></span></div><div class="t m0 x32 h2a y1809 ff19 fsf fc0 sc0 ls0 ws0">other <span class="_ _2"></span>packages: <span class="_ _3"></span>I/O <span class="_ _3"></span>streams <span class="_ _2"></span>generalized <span class="_ _3"></span>to <span class="_ _2"></span>represent <span class="_ _2"></span>both <span class="_ _2"></span>ﬁles <span class="_ _3"></span>and <span class="_ _3"></span>regions <span class="_ _2"></span>of <span class="_ _3"></span>memory<span class="_ _4"></span>,</div><div class="t m0 x32 h2a y180a ff19 fsf fc0 sc0 ls0 ws0">processing <span class="_ _23"> </span>modules <span class="_ _42"> </span>that <span class="_ _42"> </span>can <span class="_ _23"> </span>be <span class="_ _42"> </span>written <span class="_ _42"> </span>and <span class="_ _42"> </span>stacked <span class="_ _23"> </span>on <span class="_ _42"> </span>an <span class="_ _42"> </span>I/O <span class="_ _42"> </span>stream <span class="_ _23"></span>to <span class="_ _42"> </span>change <span class="_ _23"> </span>the</div><div class="t m0 x32 h2a y180b ff19 fsf fc0 sc0 ls0 ws0">operation of a stream, and better exception handling.</div><div class="t m0 x3f h2a y176 ff19 fsf fc0 sc0 ls0 ws0">Krieger<span class="_ _6"></span><span class="ls755">,S<span class="_ _43"></span><span class="ls0">tumm, <span class="_ _42"> </span>and <span class="_ _23"> </span>Unrau</span></span></div><div class="t m0 x15f h2a y180c ff19 fsf fc0 sc0 ls0 ws0">[</div><div class="t m0 x157 h2a y176 ff19 fsf fc0 sc0 ls0 ws0">1992</div><div class="t m0 x9b h2a y180c ff19 fsf fc0 sc0 ls0 ws0">]</div><div class="t m0 xde h2a y176 ff19 fsf fc0 sc0 ls0 ws0">describe <span class="_ _23"> </span>another <span class="_ _42"> </span>alternative <span class="_ _23"> </span>that <span class="_ _42"> </span>uses <span class="_ _23"> </span>mapped</div><div class="t m0 x32 h26 y177 ff19 fsf fc0 sc0 ls0 ws0">ﬁles <span class="_ _a"></span>— <span class="_ _a"></span>the<span class="_ _35"> </span><span class="ff1a">mmap<span class="_ _35"> </span></span>function <span class="_ _9"></span>that <span class="_ _23"> </span>we <span class="_ _23"></span>describe <span class="_ _23"></span>in <span class="_ _23"></span>Section <span class="_ _9"></span>14.8.<span class="_ _51"> </span>This <span class="_ _23"> </span>new <span class="_ _23"></span>package <span class="_ _23"></span>is <span class="_ _23"></span>called</div><div class="t m0 x32 h2a y178 ff19 fsf fc0 sc0 ls0 ws0">ASI, <span class="_ _45"> </span>the <span class="_ _45"> </span>Alloc <span class="_ _45"> </span>Str<span class="_ _0"></span>eam <span class="_ _45"> </span>Interface.<span class="_ _5f"> </span>The <span class="_ _45"> </span>programming <span class="_ _45"> </span>interface <span class="_ _47"> </span>resembles <span class="_ _45"> </span>the <span class="_ _45"> </span>UNIX</div><div class="t m0 x32 h26 y179 ff19 fsf fc0 sc0 ls0 ws0">System <span class="_ _45"> </span>memory <span class="_ _35"> </span>allocation <span class="_ _45"> </span>functions <span class="_ _35"> </span>(<span class="ff1a">malloc</span>,<span class="_ _5a"> </span><span class="ff1a">realloc</span><span class="ls756">,a<span class="_ _26"></span><span class="ls0">nd<span class="_ _51"> </span><span class="ff1a">free</span><span class="ls756">,d<span class="_ _26"></span><span class="ls0">escribed <span class="_ _45"> </span>in</span></span></span></span></div><a class="l" href="#pfe" data-dest-detail='[14,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.890102px;bottom:651.648928px;width:203.807915px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
