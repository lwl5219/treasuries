<div id="pf221" class="pf w4 h1f" data-page-no="221"><div class="pc pc221 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg221.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.5<span class="_ _2a6"> </span>Asynchronous <span class="_"> </span>I/O<span class="_ _1fb"> </span><span class="ff18">511</span></div><div class="t m0 x3f h26 y12f ff19 fsf fc0 sc0 ls0 ws0">3. <span class="_ _51"> </span>Enable<span class="_ _45"> </span>asynchr<span class="_ _0"></span>onous <span class="_ _9"></span>I/O <span class="_ _3"></span>on <span class="_ _9"></span>the <span class="_ _9"></span>descriptor <span class="_ _9"></span>by <span class="_ _3"></span>calling<span class="_ _45"> </span><span class="ff1a">fcntl<span class="_ _45"> </span></span>with <span class="_ _3"></span>a <span class="_ _9"></span>command</div><div class="t m0 x41 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">of<span class="_"> </span><span class="ff1a">F_SETFL<span class="_ _80"> </span></span>to set the<span class="_"> </span><span class="ff1a">O_ASYNC<span class="_ _66"> </span></span>ﬁle status ﬂag (Figur<span class="ls44">e3<span class="_ _4f"></span><span class="ls0">.10).</span></span></div><div class="t m0 x32 h2a y343 ff19 fsf fc0 sc0 ls0 ws0">Step <span class="_ _3"></span>3 <span class="_ _3"></span>can <span class="_ _3"></span>be <span class="_ _9"></span>performed <span class="_ _3"></span>only <span class="_ _3"></span>on <span class="_ _3"></span>descriptors <span class="_ _9"></span>that <span class="_ _3"></span>refer <span class="_ _2"></span>to <span class="_ _9"></span>terminals <span class="_ _3"></span>or <span class="_ _3"></span>networks, <span class="_ _3"></span>which</div><div class="t m0 x32 h2a y344 ff19 fsf fc0 sc0 ls0 ws0">is a fundamental limitation of the BSD asynchronous I/O facility<span class="_ _4"></span>.</div><div class="t m0 x3f h26 y345 ff19 fsf fc0 sc0 ls0 ws0">For <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">SIGURG<span class="_ _45"> </span></span>signal, <span class="_ _3"></span>we <span class="_ _9"></span>need <span class="_ _9"></span>perform <span class="_ _9"></span>only <span class="_ _9"></span>steps <span class="_ _3"></span>1 <span class="_ _9"></span>and <span class="_ _9"></span>2.<span class="_ _5a"> </span><span class="ff1a">SIGURG<span class="_ _45"> </span></span>is <span class="_ _3"></span>generated</div><div class="t m0 x32 h2a y346 ff19 fsf fc0 sc0 ls0 ws0">only <span class="_ _42"> </span>for <span class="_ _42"> </span>descriptors <span class="_ _42"> </span>that <span class="_ _42"> </span>refer <span class="_ _42"> </span>to <span class="_ _42"> </span>network <span class="_ _42"> </span>connections <span class="_ _42"> </span>that <span class="_ _53"> </span>support <span class="_ _42"> </span>out-of-band <span class="_ _42"> </span>data,</div><div class="t m0 x32 h2a y347 ff19 fsf fc0 sc0 ls0 ws0">such as TCP connections.</div><div class="t m0 x32 h53 y3e9c ff16 fs2b fc0 sc0 ls0 ws0">14.5.3 <span class="_ _54"> </span>POSIX<span class="_ _54"> </span>Asynchronous <span class="_"> </span>I/O</div><div class="t m0 x32 h2a y49b ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _59"> </span>POSIX <span class="_ _59"> </span>asynchronous <span class="_ _4b"> </span>I/O <span class="_ _59"> </span>interfaces <span class="_ _59"> </span>give <span class="_ _59"> </span>us <span class="_ _59"> </span>a <span class="_ _59"> </span>consistent <span class="_ _59"> </span>way <span class="_ _59"> </span>to <span class="_ _59"> </span>perform</div><div class="t m0 x32 h2a y3e9d ff19 fsf fc0 sc0 ls0 ws0">asynchronous <span class="_ _23"></span>I/O, <span class="_ _23"></span>regar<span class="_ _0"></span>dless <span class="_ _23"></span>of <span class="_ _23"> </span>the <span class="_ _23"> </span>type <span class="_ _42"> </span>of <span class="_ _23"></span>ﬁle.<span class="_ _51"> </span>These <span class="_ _23"> </span>interfaces <span class="_ _42"> </span>wer<span class="_ _0"></span><span class="ls10a1">ea<span class="_ _43"></span><span class="ls0">dopted <span class="_ _23"> </span>from</span></span></div><div class="t m0 x32 h2a y3e9e ff19 fsf fc0 sc0 ls0 ws0">the <span class="_"> </span>r<span class="_ _0"></span>eal-time <span class="_"> </span>draft <span class="_"> </span>standar<span class="_ _0"></span>d, <span class="_"> </span>which <span class="_"> </span>themselves <span class="_ _e"> </span>were<span class="_ _59"> </span>an<span class="_ _46"> </span>option <span class="_"> </span>in <span class="_"> </span>the <span class="_"> </span>Single <span class="_ _e"> </span>UNIX</div><div class="t m0 x32 h2a y3e9f ff19 fsf fc0 sc0 ls0 ws0">Speciﬁcation. <span class="_ _47"> </span>In<span class="_ _47"> </span><span class="lsc1">Ve<span class="_"> </span></span>rsion <span class="_ _2"></span>4, <span class="_ _3"></span>the <span class="_ _3"></span>Single <span class="_ _3"></span>UNIX <span class="_ _3"></span>Speciﬁcation <span class="_ _3"></span>moved <span class="_ _3"></span>these <span class="_ _2"></span>interfaces <span class="_ _3"></span>to <span class="_ _3"></span>the</div><div class="t m0 x32 h2a y3ea0 ff19 fsf fc0 sc0 ls0 ws0">base, so they ar<span class="ls44">en<span class="_ _4f"></span><span class="ls0">ow required to be supported by all platforms.</span></span></div><div class="t m0 x3f h2a y3ea1 ff19 fsf fc0 sc0 ls0 ws0">The asynchronous I/O interfaces use AIO control blocks to <span class="_ _2"></span>describe I/O operations.</div><div class="t m0 x32 h26 y3ea2 ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _47"> </span><span class="ff1a">aiocb<span class="_ _47"> </span></span>structur<span class="ls9d1">ed<span class="_ _b"></span><span class="ls0">eﬁnes <span class="_ _3"></span>an <span class="_ _3"></span>AIO <span class="_ _3"></span>control <span class="_ _2"></span>block.<span class="_ _16"> </span>It <span class="_ _3"></span>contains <span class="_ _3"></span>at <span class="_ _3"></span>least <span class="_ _3"></span>the <span class="_ _3"></span>ﬁelds <span class="_ _3"></span>shown</span></span></div><div class="t m0 x32 h2a y3ea3 ff19 fsf fc0 sc0 ls0 ws0">in the following structur<span class="_ _0"></span><span class="ls44">e(<span class="_ _d"></span><span class="ls0">implementations might include additional ﬁelds):</span></span></div><div class="t m0 x3f h57 y1974 ff1a fs2d fc0 sc0 ls0 ws0">struct aiocb {</div><div class="t m0 xf4 h57 y3ea4 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>aio_fildes;<span class="_ _189"> </span>/* file descriptor */</div><div class="t m0 xf4 h57 y3ea5 ff1a fs2d fc0 sc0 ls0 ws0">off_t <span class="_ _74"> </span>aio_offset;<span class="_ _189"> </span>/* file offset for I/O */</div><div class="t m0 xf4 h57 y3ea6 ff1a fs2d fc0 sc0 ls0 ws0">volatile void<span class="_ _d9"> </span>*aio_buf; <span class="_ _186"> </span>/*<span class="_"> </span>buffer for I/O */</div><div class="t m0 xf4 h57 y3ea7 ff1a fs2d fc0 sc0 ls0 ws0">size_t <span class="_ _176"> </span>aio_nbytes;<span class="_ _189"> </span>/* number of bytes to transfer */</div><div class="t m0 xf4 h57 y3ea8 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>aio_reqprio;<span class="_ _8a"> </span>/* priority */</div><div class="t m0 xf4 h57 y3ea9 ff1a fs2d fc0 sc0 ls0 ws0">struct sigevent aio_sigevent;<span class="_ _15"> </span>/* signal information */</div><div class="t m0 xf4 h57 y3eaa ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>aio_lio_opcode;<span class="_ _3a"> </span>/* operation for list I/O */</div><div class="t m0 x3f h57 y3eab ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x3f h26 y3eac ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _45"> </span><span class="ff1a">aio_fildes<span class="_ _45"> </span></span>ﬁeld <span class="_ _3"></span>is <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>descriptor <span class="_ _9"></span>open <span class="_ _9"></span>for <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _9"></span>to <span class="_ _9"></span>be <span class="_ _9"></span>read <span class="_ _9"></span>or <span class="_ _9"></span>written.</div><div class="t m0 x32 h26 y3ead ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _53"> </span>read <span class="_ _53"> </span>or <span class="_ _53"> </span>write <span class="_ _e"> </span>starts <span class="_ _53"> </span>at <span class="_ _e"> </span>the <span class="_ _53"> </span>offset <span class="_ _53"> </span>speciﬁed <span class="_ _e"> </span>by<span class="_ _4b"> </span><span class="ff1a">aio_offset</span><span class="ls125">.F<span class="_ _64"></span><span class="ls0">or <span class="_ _e"> </span>a <span class="_ _53"> </span>read, <span class="_ _53"> </span>data <span class="_ _e"> </span>is</span></span></div><div class="t m0 x32 h26 y3eae ff19 fsf fc0 sc0 ls0 ws0">copied <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>buffer <span class="_ _2"></span>that <span class="_ _3"></span>begins <span class="_ _3"></span>at <span class="_ _3"></span>the <span class="_ _9"></span>address <span class="_ _2"></span>speciﬁed <span class="_ _3"></span>by<span class="_ _47"> </span><span class="ff1a">aio_buf</span><span class="ls10a2">.F<span class="_ _1d"></span><span class="ls0">or <span class="_ _3"></span>a <span class="_ _3"></span>write, <span class="_ _3"></span>data</span></span></div><div class="t m0 x32 h26 y3eaf ff19 fsf fc0 sc0 ls0 ws0">is <span class="_ _2"></span>copied <span class="_ _3"></span>from <span class="_ _2"></span>this <span class="_ _3"></span>buffer<span class="_ _6"></span><span class="ls10a3">.T<span class="_ _1d"></span><span class="ls0">he<span class="_ _47"> </span><span class="ff1a">aio_nbytes<span class="_ _47"> </span></span>ﬁeld <span class="_ _3"></span>contains <span class="_ _3"></span>the <span class="_ _3"></span>number <span class="_ _2"></span>of <span class="_ _3"></span>bytes <span class="_ _3"></span>to <span class="_ _3"></span>read</span></span></div><div class="t m0 x32 h2a y3eb0 ff19 fsf fc0 sc0 ls0 ws0">or write.</div><div class="t m0 x3f h2a y3eb1 ff19 fsf fc0 sc0 ls0 ws0">Note <span class="_ _53"> </span>that <span class="_ _53"> </span>we <span class="_ _53"> </span>have <span class="_ _53"> </span>to <span class="_ _53"> </span>provide <span class="_ _42"> </span>an <span class="_ _53"> </span>explicit <span class="_ _53"> </span>offset <span class="_ _42"> </span>when <span class="_ _53"> </span>we <span class="_ _53"> </span>perform <span class="_ _53"> </span>asynchronous</div><div class="t m0 x32 h2a y3eb2 ff19 fsf fc0 sc0 ls0 ws0">I/O. <span class="_ _4b"> </span>The<span class="_ _4b"> </span>asynchronous <span class="_ _e"> </span>I/O <span class="_ _e"> </span>interfaces <span class="_ _e"> </span>don’t <span class="_ _e"> </span>affect <span class="_ _53"> </span>the <span class="_ _e"> </span>ﬁle <span class="_"> </span>of<span class="_ _1"></span>fset <span class="_"> </span>maintained <span class="_ _53"> </span>by <span class="_ _e"> </span>the</div><div class="t m0 x32 h2a y3eb3 ff19 fsf fc0 sc0 ls0 ws0">operating <span class="_ _2"></span>system.<span class="_ _16"> </span>This <span class="_ _3"></span>won’t <span class="_ _3"></span>be <span class="_ _3"></span>a <span class="_ _2"></span>problem <span class="_ _2"></span>as <span class="_ _3"></span>long <span class="_ _3"></span>as <span class="_ _3"></span>we <span class="_ _3"></span>never <span class="_ _3"></span>mix <span class="_ _2"></span>asynchronous <span class="_ _3"></span>I/O</div><div class="t m0 x32 h2a y3eb4 ff19 fsf fc0 sc0 ls0 ws0">functions <span class="_ _2"></span>with <span class="_ _3"></span>conventional <span class="_ _3"></span>I/O <span class="_ _3"></span>functions <span class="_ _3"></span>on <span class="_ _3"></span>the <span class="_ _3"></span>same <span class="_ _2"></span>ﬁle <span class="_ _3"></span>in <span class="_ _3"></span>a <span class="_ _3"></span>process. <span class="_ _47"> </span>Also<span class="_ _47"> </span>note <span class="_ _2"></span>that</div><div class="t m0 x32 h26 y3eb5 ff19 fsf fc0 sc0 ls0 ws0">if <span class="_ _9"></span>we <span class="_ _9"></span>write <span class="_ _23"></span>to <span class="_ _9"></span>a <span class="_ _9"></span>ﬁle <span class="_ _23"></span>opened <span class="_ _9"></span>in <span class="_ _9"></span>append <span class="_ _9"></span>mode <span class="_ _23"></span>(with<span class="_"> </span><span class="ff1a">O_APPEND</span><span class="lscb4">)u<span class="_ _b"></span><span class="ls0">sing <span class="_ _9"></span>an <span class="_ _9"></span>asynchronous</span></span></div><div class="t m0 x32 h26 y420 ff19 fsf fc0 sc0 ls0 ws0">interface, the<span class="_"> </span><span class="ff1a">aio_offset<span class="_ _80"> </span></span>ﬁeld in the AIO control block is ignored by the system.</div><div class="t m0 x3f h2a y3eb6 ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _59"> </span>other <span class="_ _46"> </span>ﬁelds <span class="_ _59"> </span>don’t <span class="_ _59"> </span>correspond <span class="_ _59"> </span>to <span class="_ _46"> </span>the <span class="_ _59"> </span>conventional <span class="_ _46"> </span>I/O <span class="_ _59"> </span>functions.<span class="_ _5e"> </span>The</div><div class="t m0 x32 h26 y3eb7 ff1a fsf fc0 sc0 ls0 ws0">aio_reqprio<span class="_ _80"> </span><span class="ff19">ﬁeld is a hint that gives applications a way to <span class="_ _2"></span>suggest an ordering for the</span></div><div class="t m0 x32 h2a y3eb8 ff19 fsf fc0 sc0 ls0 ws0">asynchronous <span class="_ _45"> </span>I/O <span class="_ _35"> </span>r<span class="_ _0"></span>equests. <span class="_ _51"> </span>The<span class="_ _5a"> </span>system <span class="_ _35"> </span>has <span class="_ _35"> </span>only <span class="_ _45"> </span>limited <span class="_ _35"> </span>control <span class="_ _45"> </span>over <span class="_ _35"> </span>the <span class="_ _45"> </span>exact</div><div class="t m0 x32 h2a y3eb9 ff19 fsf fc0 sc0 ls0 ws0">ordering, <span class="_ _45"> </span>however<span class="_ _6"></span>,<span class="_ _51"> </span>so<span class="_ _5a"> </span>there<span class="_ _5a"> </span>is<span class="_ _5a"> </span>no<span class="_ _51"> </span>guarantee <span class="_ _45"> </span>that <span class="_ _45"> </span>the <span class="_ _35"> </span>hint <span class="_ _45"> </span>will <span class="_ _45"> </span>be <span class="_ _35"> </span>honored. <span class="_ _5a"> </span>The</div><div class="t m0 x32 h26 y3eba ff1a fsf fc0 sc0 ls0 ws0">aio_lio_opcode<span class="_ _4b"> </span><span class="ff19">ﬁeld <span class="_ _53"> </span>is <span class="_ _e"> </span>used <span class="_ _e"> </span>only <span class="_ _e"> </span>with <span class="_ _53"> </span>list-based <span class="_ _e"> </span>asynchronous <span class="_ _53"> </span>I/O, <span class="_ _e"> </span>which <span class="_ _e"> </span>we’ll</span></div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:156.492009px;bottom:999.408941px;width:193.056000px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
