<div id="pf20d" class="pf w4 h1f" data-page-no="20d"><div class="pc pc20d w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg20d.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.3<span class="_ _1f7"> </span>Recor<span class="ls30a">dL<span class="_ _55"></span><span class="ls0">ocking<span class="_ _1b"> </span><span class="ff18">491</span></span></span></div><div class="t m0 x32 h57 y425 ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y426 ff1a fs2d fc0 sc0 ls0 ws0">if (writew_lock(fd, offset, SEEK_SET, 1) &lt; 0)</div><div class="t m0 x9d h57 y800 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;%s: writew_lock error&quot;, name);</div><div class="t m0 x8a h57 y801 ff1a fs2d fc0 sc0 ls0 ws0">printf(&quot;%s: got the lock, byte %lld\n&quot;, name, (long long)offset);</div><div class="t m0 x32 h57 y802 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x32 h57 yaeb ff1a fs2d fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h57 y16f9 ff1a fs2d fc0 sc0 ls0 ws0">main(void)</div><div class="t m0 x32 h57 y16df ff1a fs2d fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h57 y16e0 ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _15"> </span>fd;</div><div class="t m0 x8a h57 y16e1 ff1a fs2d fc0 sc0 ls0 ws0">pid_t <span class="_ _d9"> </span>pid;</div><div class="t m0 x8a h57 y16fa ff1a fs2d fc0 sc0 ls0 ws0">/*</div><div class="t m0 x214 h57 y340f ff1a fs2d fc0 sc0 ls15c ws0">*C<span class="_ _1d"></span><span class="ls0">reate a file and write two bytes to it.</span></div><div class="t m0 x214 h57 y3410 ff1a fs2d fc0 sc0 ls0 ws0">*/</div><div class="t m0 x8a h57 y3411 ff1a fs2d fc0 sc0 ls0 ws0">if ((fd = creat(&quot;templock&quot;, FILE_MODE)) &lt; 0)</div><div class="t m0 x9d h57 y3412 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;creat error&quot;);</div><div class="t m0 x8a h57 y3811 ff1a fs2d fc0 sc0 ls0 ws0">if (write(fd, &quot;ab&quot;, 2) != 2)</div><div class="t m0 x9d h57 y3812 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;write error&quot;);</div><div class="t m0 x8a h57 y3414 ff1a fs2d fc0 sc0 ls0 ws0">TELL_WAIT();</div><div class="t m0 x8a h57 y3415 ff1a fs2d fc0 sc0 ls0 ws0">if ((pid = fork()) &lt; 0) {</div><div class="t m0 x9d h57 y3416 ff1a fs2d fc0 sc0 ls0 ws0">err_sys(&quot;fork error&quot;);</div><div class="t m0 x8a h57 y3417 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse if (pid == 0) {<span class="_ _74"> </span>/* child */</span></div><div class="t m0 x9d h57 y3418 ff1a fs2d fc0 sc0 ls0 ws0">lockabyte(&quot;child&quot;, fd, 0);</div><div class="t m0 x9d h57 y16ed ff1a fs2d fc0 sc0 ls0 ws0">TELL_PARENT(getppid());</div><div class="t m0 x9d h57 y3c31 ff1a fs2d fc0 sc0 ls0 ws0">WAIT_PARENT();</div><div class="t m0 x9d h57 y3380 ff1a fs2d fc0 sc0 ls0 ws0">lockabyte(&quot;child&quot;, fd, 1);</div><div class="t m0 x8a h57 y3381 ff1a fs2d fc0 sc0 ls15c ws0">}e<span class="_ _1d"></span><span class="ls0">lse {<span class="_ _1e6"> </span>/* parent */</span></div><div class="t m0 x9d h57 y3382 ff1a fs2d fc0 sc0 ls0 ws0">lockabyte(&quot;parent&quot;, fd, 1);</div><div class="t m0 x9d h57 y3383 ff1a fs2d fc0 sc0 ls0 ws0">TELL_CHILD(pid);</div><div class="t m0 x9d h57 y3384 ff1a fs2d fc0 sc0 ls0 ws0">WAIT_CHILD();</div><div class="t m0 x9d h57 y3385 ff1a fs2d fc0 sc0 ls0 ws0">lockabyte(&quot;parent&quot;, fd, 0);</div><div class="t m0 x8a h57 y3386 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x8a h57 y3387 ff1a fs2d fc0 sc0 ls0 ws0">exit(0);</div><div class="t m0 x32 h57 y3388 ff1a fs2d fc0 sc0 ls0 ws0">}</div><div class="t m0 x1e h2d y3c32 ff18 fs10 fc0 sc0 ls0 ws0">Figure 14.7<span class="_ _5a"> </span><span class="ff19">Example of deadlock detection</span></div><div class="t m0 x32 h49 y3c33 ff19 fs26 fc0 sc0 ls0 ws0">Running the program in Figur<span class="_ _0"></span><span class="lsd3">e1<span class="_ _d"></span><span class="ls0">4.7 gives us</span></span></div><div class="t m0 x3f h4e y3c34 ff1a fs28 fc0 sc0 ls0 ws0">$<span class="_"> </span><span class="ff1f">./a.out</span></div><div class="t m0 x3f h4e y3c35 ff1a fs28 fc0 sc0 ls0 ws0">parent: got the lock, byte 1</div><div class="t m0 x3f h4e y3c36 ff1a fs28 fc0 sc0 ls0 ws0">child: got the lock, byte 0</div><div class="t m0 x3f h4e y3c37 ff1a fs28 fc0 sc0 ls0 ws0">parent: writew_lock error: Resource deadlock avoided</div><div class="t m0 x3f h4e y3c38 ff1a fs28 fc0 sc0 ls0 ws0">child: got the lock, byte 1</div><div class="t m0 x3f h49 y3c39 ff19 fs26 fc0 sc0 ls0 ws0">When <span class="_ _23"> </span>a <span class="_ _42"> </span>deadlock <span class="_ _42"> </span>is <span class="_ _23"> </span>detected, <span class="_ _42"> </span>the <span class="_ _23"> </span>kernel <span class="_ _42"> </span>has <span class="_ _42"> </span>to <span class="_ _23"> </span>choose <span class="_ _42"> </span>one <span class="_ _23"> </span>process <span class="_ _23"> </span>to <span class="_ _42"> </span>receive <span class="_ _23"></span>the</div><div class="t m0 x32 h49 y3c3a ff19 fs26 fc0 sc0 ls0 ws0">error <span class="_ _42"> </span>return. <span class="_ _44"> </span>In<span class="_ _4b"> </span>this <span class="_ _e"> </span>example, <span class="_ _53"> </span>the <span class="_ _53"> </span>parent <span class="_ _53"> </span>was <span class="_ _e"> </span>chosen, <span class="_ _53"> </span>but <span class="_ _53"> </span>this <span class="_ _e"> </span>is <span class="_ _53"> </span>an <span class="_ _53"> </span>implementation</div><div class="t m0 x32 h49 y3c3b ff19 fs26 fc0 sc0 ls0 ws0">detail. <span class="_ _44"> </span>On<span class="_ _44"> </span>some <span class="_ _42"> </span>systems, <span class="_ _53"> </span>the <span class="_ _42"> </span>child <span class="_ _53"> </span>always <span class="_ _42"> </span>receives <span class="_ _42"> </span>the <span class="_ _53"> </span>error<span class="_ _6"></span><span class="lsfee">.O<span class="_ _52"></span><span class="lsfef">no<span class="_ _c"></span><span class="ls0">ther <span class="_ _53"> </span>systems, <span class="_ _42"> </span>the</span></span></span></div><div class="t m0 x32 h49 y3c3c ff19 fs26 fc0 sc0 ls0 ws0">parent <span class="_ _42"> </span>always <span class="_ _53"> </span>gets <span class="_ _53"> </span>the <span class="_ _53"> </span>error<span class="_ _6"></span><span class="lsff0">.O<span class="_ _52"></span><span class="lsff1">ns<span class="_ _c"></span><span class="ls0">ome <span class="_ _42"> </span>systems, <span class="_ _53"> </span>you <span class="_ _53"> </span>might <span class="_ _53"> </span>even <span class="_ _53"> </span>see <span class="_ _53"> </span>the <span class="_ _53"> </span>errors <span class="_ _42"> </span>split</span></span></span></div><div class="t m0 x32 h49 y3c3d ff19 fs26 fc0 sc0 ls0 ws0">between the child and the parent as multiple lock attempts ar<span class="_ _0"></span><span class="lsd3">em<span class="_ _d"></span><span class="ls0">ade.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
