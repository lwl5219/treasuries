<div id="pf213" class="pf w4 h1f" data-page-no="213"><div class="pc pc213 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg213.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.3<span class="_ _1f7"> </span>Recor<span class="ls30a">dL<span class="_ _55"></span><span class="ls0">ocking<span class="_ _1b"> </span><span class="ff18">497</span></span></span></div><div class="t m0 x15 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">wrote <span class="_ _3"></span>the <span class="_ _23"></span>new <span class="_ _9"></span>contents <span class="_ _9"></span>to <span class="_ _9"></span>a <span class="_ _9"></span>temporary <span class="_ _9"></span>ﬁle, <span class="_ _23"></span>r<span class="_ _0"></span>emoved <span class="_ _9"></span>the <span class="_ _9"></span>original <span class="_ _9"></span>ﬁle, <span class="_ _9"></span>and <span class="_ _23"></span>then</div><div class="t m0 x15 h2a y130 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">named the <span class="_ _2"></span>temporary ﬁle to be the <span class="_ _2"></span>original ﬁle.<span class="_ _46"> </span>The mandatory recor<span class="lsd1c">dl<span class="_ _4f"></span><span class="ls0">ocking</span></span></span></div><div class="t m0 x15 h26 y131 ff19 fsf fc0 sc0 ls0 ws0">has no effect on the<span class="_"> </span><span class="ff1a">unlink<span class="_ _80"> </span></span>function, which allowed this to happen.</div><div class="t m0 xf6 h51 yba0 ff19 fs2a fc0 sc0 ls0 ws0">Under <span class="_ _3"></span>FreeBSD <span class="_ _3"></span>8.0 <span class="_ _9"></span>and <span class="_ _9"></span>Solaris <span class="_ _3"></span>10, <span class="_ _9"></span>we <span class="_ _9"></span>can <span class="_ _3"></span>obtain <span class="_ _9"></span>the <span class="_ _3"></span>system <span class="_ _9"></span>call <span class="_ _9"></span>trace <span class="_ _3"></span>of <span class="_ _9"></span>a <span class="_ _9"></span>process <span class="_ _3"></span>with</div><div class="t m0 xf6 h52 yba1 ff19 fs2a fc0 sc0 ls0 ws0">the<span class="_ _35"> </span><span class="ff1a">truss</span></div><div class="t m0 xbe h51 y3cfe ff19 fs2a fc0 sc0 ls0 ws0">(</div><div class="t m0 x220 h51 yba1 ff19 fs2a fc0 sc0 ls0 ws0">1</div><div class="t m0 x1e h51 y3cfe ff19 fs2a fc0 sc0 ls0 ws0">)</div><div class="t m0 x123 h52 yba1 ff19 fs2a fc0 sc0 ls0 ws0">command. <span class="_ _35"> </span>Linux<span class="_ _35"> </span>3.2.0 <span class="_"> </span>pr<span class="_ _1"></span>ovides <span class="_"> </span>the<span class="_ _35"> </span><span class="ff1a">strace</span></div><div class="t m0 x1a1 h51 y3cfe ff19 fs2a fc0 sc0 ls0 ws0">(</div><div class="t m0 x49 h51 yba1 ff19 fs2a fc0 sc0 ls0 ws0">1</div><div class="t m0 x119 h51 y3cfe ff19 fs2a fc0 sc0 ls0 ws0">)</div><div class="t m0 x18d h51 yba1 ff19 fs2a fc0 sc0 ls0 ws0">command <span class="_"> </span>for <span class="_ _42"> </span>the <span class="_"> </span>same</div><div class="t m0 xf6 h52 yba2 ff19 fs2a fc0 sc0 ls0 ws0">purpose. <span class="_ _80"> </span>Mac<span class="_ _66"> </span>OS <span class="_ _2"></span>X <span class="_ _3"></span>10.6.8 <span class="_ _3"></span>provides <span class="_ _3"></span>the<span class="_ _80"> </span><span class="ff1a">dtruss</span>(1m) <span class="_ _3"></span>command <span class="_ _3"></span>to <span class="_ _3"></span>trace <span class="_ _3"></span>system <span class="_ _3"></span>calls, <span class="_ _3"></span>but</div><div class="t m0 xf6 h51 yba3 ff19 fs2a fc0 sc0 ls0 ws0">its use requir<span class="_ _0"></span>es superuser privileges.</div><div class="t m0 x3f h26 y3cff ff19 fsf fc0 sc0 ls49 ws0">•T<span class="_ _4d"></span><span class="ls0">he<span class="_"> </span><span class="ff1a">vi<span class="_ _66"> </span></span>editor <span class="_ _2"></span>was never <span class="_ _2"></span>able to <span class="_ _2"></span>edit <span class="_ _2"></span>the ﬁle.<span class="_ _46"> </span>It <span class="_ _2"></span>could <span class="_ _2"></span>read the ﬁle’s <span class="_ _2"></span>contents, but</span></div><div class="t m0 x15 h26 y3d00 ff19 fsf fc0 sc0 ls0 ws0">whenever <span class="_ _23"> </span>we <span class="_ _23"> </span>tried <span class="_ _23"> </span>to <span class="_ _42"> </span>write <span class="_ _23"> </span>new <span class="_ _23"> </span>data <span class="_ _23"> </span>to <span class="_ _42"> </span>the <span class="_ _23"></span>ﬁle,<span class="_ _35"> </span><span class="ff1a">EAGAIN<span class="_ _35"> </span></span>was <span class="_ _23"> </span>returned. <span class="_ _35"> </span>If<span class="_ _35"> </span>we</div><div class="t m0 x15 h26 y3d01 ff19 fsf fc0 sc0 ls0 ws0">tried <span class="_ _2"></span>to <span class="_ _3"></span>append <span class="_ _3"></span>new <span class="_ _2"></span>data <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _2"></span>ﬁle, <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">write<span class="_ _47"> </span></span>blocked. <span class="_ _47"> </span>This<span class="_ _47"> </span>behavior <span class="_ _2"></span>from<span class="_ _66"> </span><span class="ff1a">vi</span></div><div class="t m0 x15 h2a y3d02 ff19 fsf fc0 sc0 ls0 ws0">is what we expect.</div><div class="t m0 x3f h26 y3d03 ff19 fsf fc0 sc0 ls49 ws0">•U<span class="_ _4d"></span><span class="ls0">sing <span class="_ _42"> </span>the <span class="_ _53"> </span>Korn <span class="_ _42"> </span>shell’s<span class="_ _44"> </span><span class="ff1a">&gt;<span class="_ _44"> </span></span>and<span class="_ _44"> </span><span class="ff1a">&gt;&gt;<span class="_ _44"> </span></span>operators <span class="_ _53"> </span>to <span class="_ _42"> </span>overwrite <span class="_ _53"> </span>or <span class="_ _42"> </span>append <span class="_ _53"> </span>to <span class="_ _42"> </span>the <span class="_ _53"> </span>ﬁle</span></div><div class="t m0 x15 h2a y3d04 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">sulted in the error ‘<span class="_ _0"></span>‘cannot cr<span class="_ _0"></span>eate.’<span class="_ _0"></span>’</span></div><div class="t m0 x3f h26 y3d05 ff19 fsf fc0 sc0 ls49 ws0">•U<span class="_ _4d"></span><span class="ls0">sing <span class="_ _9"></span>the <span class="_ _23"></span>same <span class="_ _9"></span>two <span class="_ _23"></span>operators <span class="_ _9"></span>with <span class="_ _23"></span>the <span class="_ _9"></span>Bourne <span class="_ _23"></span>shell <span class="_ _9"></span>resulted <span class="_ _9"></span>in <span class="_ _23"></span>an <span class="_ _9"></span>error <span class="_ _9"></span>for<span class="_ _35"> </span><span class="ff1a">&gt;</span>,</span></div><div class="t m0 x15 h26 y3d06 ff19 fsf fc0 sc0 ls0 ws0">but <span class="_ _42"> </span>the<span class="_ _44"> </span><span class="ff1a">&gt;&gt;<span class="_ _44"> </span></span>operator <span class="_ _42"> </span>just <span class="_ _42"> </span>blocked <span class="_ _42"> </span>until <span class="_ _53"> </span>the <span class="_ _42"> </span>mandatory <span class="_ _42"> </span>lock <span class="_ _42"> </span>was <span class="_ _53"> </span>removed, <span class="_ _23"> </span>and</div><div class="t m0 x15 h2a y3d07 ff19 fsf fc0 sc0 ls0 ws0">then <span class="_ _9"></span>proceeded. <span class="_ _47"> </span>(The<span class="_ _45"> </span>difference <span class="_ _3"></span>in <span class="_ _9"></span>the <span class="_ _9"></span>handling <span class="_ _9"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>append <span class="_ _9"></span>operator <span class="_ _9"></span>occurs</div><div class="t m0 x15 h26 y3d08 ff19 fsf fc0 sc0 ls0 ws0">because <span class="_ _42"> </span>the <span class="_ _42"> </span>Korn <span class="_ _53"> </span>shell<span class="_ _44"> </span><span class="ff1a">open</span><span class="ls1020">st<span class="_ _c"></span><span class="ls0">he <span class="_ _53"> </span>ﬁle <span class="_ _42"> </span>with<span class="_ _44"> </span><span class="ff1a">O_CREAT<span class="_ _44"> </span></span>and<span class="_ _44"> </span><span class="ff1a">O_APPEND</span><span class="ls1021">,a<span class="_ _43"></span><span class="ls0">nd <span class="_ _23"> </span>we</span></span></span></span></div><div class="t m0 x15 h26 y3d09 ff19 fsf fc0 sc0 ls0 ws0">mentioned <span class="_ _66"> </span>earlier <span class="_ _47"> </span>that <span class="_ _66"> </span>specifying<span class="_ _61"> </span><span class="ff1a">O_CREAT<span class="_ _16"> </span></span>generates <span class="_ _66"> </span>an <span class="_ _47"> </span>error<span class="_ _6"></span><span class="ls1022">.T<span class="_ _49"></span><span class="ls0">he <span class="_ _66"> </span>Bourne</span></span></div><div class="t m0 x15 h26 y3d0a ff19 fsf fc0 sc0 ls0 ws0">shell, <span class="_ _23"> </span>however<span class="_ _1"></span><span class="ls1023">,d<span class="_ _43"></span><span class="ls0">oesn’t <span class="_ _23"> </span>specify<span class="_ _35"> </span><span class="ff1a">O_CREAT<span class="_ _44"> </span></span>if <span class="_ _23"></span>the <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>already <span class="_ _23"></span>exists, <span class="_ _23"></span>so <span class="_ _23"> </span>the<span class="_ _35"> </span><span class="ff1a">open</span></span></span></div><div class="t m0 x15 h26 y3d0b ff19 fsf fc0 sc0 ls0 ws0">succeeds but the next<span class="_"> </span><span class="ff1a">write<span class="_ _80"> </span></span>blocks.)</div><div class="t m0 x32 h2a y3d0c ff19 fsf fc0 sc0 ls0 ws0">Results <span class="_ _2"></span>will <span class="_ _2"></span>vary<span class="_ _6"></span><span class="ls74e">,d<span class="_ _4f"></span><span class="ls0">epending <span class="_ _2"></span>on <span class="_ _2"></span>the <span class="_ _3"></span>version <span class="_ _2"></span>of <span class="_ _2"></span>the <span class="_ _3"></span>operating <span class="_ _2"></span>system <span class="_ _2"></span>you <span class="_ _3"></span>ar<span class="lsbe2">eu<span class="_ _8"></span><span class="ls0">sing. <span class="_ _47"> </span>The</span></span></span></span></div><div class="t m0 x32 h2a y3d0d ff19 fsf fc0 sc0 ls0 ws0">bottom <span class="_ _66"> </span>line, <span class="_ _66"> </span>as <span class="_ _47"> </span>demonstrated <span class="_ _66"> </span>by <span class="_ _47"> </span>this <span class="_"> </span>exercise, <span class="_ _66"> </span>is <span class="_ _47"> </span>to <span class="_"> </span>be <span class="_ _47"> </span>wary <span class="_"> </span>of <span class="_ _47"> </span>mandatory <span class="_ _66"> </span>record</div><div class="t m0 x32 h26 y3d0e ff19 fsf fc0 sc0 ls0 ws0">locking. <span class="_"> </span>As<span class="_"> </span>seen with the<span class="_"> </span><span class="ff1a">ed<span class="_ _80"> </span></span>example, it can be circumvented.</div><div class="t m0 x3f h2a y3d0f ff19 fsf fc0 sc0 ls0 ws0">Mandatory <span class="_ _3"></span>recor<span class="ls1024">dl<span class="_ _b"></span><span class="ls0">ocking <span class="_ _3"></span>can <span class="_ _3"></span>also <span class="_ _9"></span>be <span class="_ _3"></span>used <span class="_ _9"></span>by <span class="_ _3"></span>a <span class="_ _3"></span>malicious <span class="_ _9"></span>user <span class="_ _3"></span>to <span class="_ _3"></span>hold <span class="_ _9"></span>a <span class="_ _3"></span>read <span class="_ _3"></span>lock</span></span></div><div class="t m0 x32 h2a y3d10 ff19 fsf fc0 sc0 ls0 ws0">on <span class="_ _2"></span>a <span class="_ _2"></span>ﬁle <span class="_ _2"></span>that <span class="_ _3"></span>is <span class="_ _2"></span>publicly <span class="_ _2"></span>readable. <span class="_ _66"> </span>This<span class="_ _47"> </span>can <span class="_ _2"></span>prevent <span class="_ _2"></span>anyone <span class="_ _2"></span>from writing <span class="_ _3"></span>to <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle.<span class="_ _61"> </span>(Of</div><div class="t m0 x32 h2a y3d11 ff19 fsf fc0 sc0 ls0 ws0">course, <span class="_ _9"></span>the <span class="_ _23"> </span>ﬁle <span class="_ _23"></span>has <span class="_ _9"></span>to <span class="_ _23"></span>have <span class="_ _23"></span>mandatory <span class="_ _9"></span>recor<span class="ls1025">dl<span class="_ _43"></span><span class="ls0">ocking <span class="_ _23"></span>enabled <span class="_ _9"></span>for <span class="_ _23"></span>this <span class="_ _23"></span>to <span class="_ _9"></span>occur<span class="_ _1"></span><span class="ls1025">,w<span class="_ _b"></span><span class="ls0">hich</span></span></span></span></div><div class="t m0 x32 h2a y3d12 ff19 fsf fc0 sc0 ls0 ws0">may <span class="_ _23"></span>requir<span class="_ _0"></span><span class="ls8bc">et<span class="_ _43"></span><span class="ls0">he <span class="_ _23"> </span>user <span class="_ _23"> </span>to <span class="_ _23"> </span>be <span class="_ _23"> </span>able <span class="_ _23"> </span>to <span class="_ _42"> </span>change <span class="_ _23"></span>the <span class="_ _23"></span>permission <span class="_ _23"></span>bits <span class="_ _23"></span>of <span class="_ _23"></span>the <span class="_ _23"></span>ﬁle.)<span class="_ _51"> </span>Consider <span class="_ _23"></span>a</span></span></div><div class="t m0 x32 h2a y3d13 ff19 fsf fc0 sc0 ls0 ws0">database <span class="_ _42"> </span>ﬁle <span class="_ _53"> </span>that <span class="_ _42"> </span>is <span class="_ _53"> </span>world <span class="_ _42"> </span>readable <span class="_ _42"> </span>and <span class="_ _53"> </span>has <span class="_ _53"> </span>mandatory <span class="_ _42"> </span>recor<span class="ls1026">dl<span class="_ _55"></span><span class="ls0">ocking <span class="_ _53"> </span>enabled.<span class="_ _54"> </span>If <span class="_ _53"> </span>a</span></span></div><div class="t m0 x32 h2a y3d14 ff19 fsf fc0 sc0 ls0 ws0">malicious user <span class="_ _2"></span>were<span class="_ _66"> </span>to<span class="_ _66"> </span>hold <span class="_ _2"></span>a <span class="_ _2"></span>read lock <span class="_ _2"></span>on <span class="_ _2"></span>the <span class="_ _2"></span>entir<span class="ls3e2">eﬁ<span class="_ _4f"></span><span class="ls0">le, <span class="_ _2"></span>the <span class="_ _2"></span>ﬁle <span class="_ _2"></span>could <span class="_ _2"></span>not be <span class="_ _2"></span>written <span class="_ _2"></span>to</span></span></div><div class="t m0 x32 h2a y3d15 ff19 fsf fc0 sc0 ls0 ws0">by other processes.</div><div class="t m0 x35 h27 y3d16 ff16 fsf fc0 sc0 ls0 ws0">Example</div><div class="t m0 x32 h2a y3d17 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _35"> </span>c<span class="_ _9"></span><span class="ls0">an <span class="_ _53"> </span>run <span class="_ _53"> </span>the <span class="_ _53"> </span>program <span class="_ _42"> </span>in <span class="_ _53"> </span>Figur<span class="ls1027">e1<span class="_ _c"></span><span class="ls0">4.12 <span class="_ _53"> </span>to <span class="_ _53"> </span>determine <span class="_ _53"> </span>whether <span class="_ _53"> </span>our <span class="_ _e"> </span>system <span class="_ _53"> </span>supports</span></span></span></div><div class="t m0 x32 h2a y3d18 ff19 fsf fc0 sc0 ls0 ws0">mandatory locking.</div><div class="t m0 x32 h4e y3d19 ff1a fs28 fc0 sc0 ls0 ws0">#include &quot;apue.h&quot;</div><div class="t m0 x32 h4e y3d1a ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;errno.h&gt;</div><div class="t m0 x32 h4e y3d1b ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;fcntl.h&gt;</div><div class="t m0 x32 h4e y3d1c ff1a fs28 fc0 sc0 ls0 ws0">#include &lt;sys/wait.h&gt;</div><div class="t m0 x32 h4e y3d1d ff1a fs28 fc0 sc0 ls0 ws0">int</div><div class="t m0 x32 h4e y3d1e ff1a fs28 fc0 sc0 ls0 ws0">main(int argc, char *argv[])</div><div class="t m0 x32 h4e y3d1f ff1a fs28 fc0 sc0 ls0 ws0">{</div><div class="t m0 x8a h4e y3d20 ff1a fs28 fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>fd;</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
