<div id="pf364" class="pf w4 h1f" data-page-no="364"><div class="pc pc364 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg364.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">834<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">672 <span class="_ _186"> </span>if<span class="_"> </span>((sockfd = connect_retry(AF_INET, SOCK_STREAM, 0,</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">673 <span class="_ _74"> </span>printer-&gt;ai_addr,<span class="_"> </span>printer-&gt;ai_addrlen)) &lt; 0) {</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">674 <span class="_ _82"> </span>log_msg(&quot;job<span class="_"> </span>%d deferred - can’t contact printer: %s&quot;,</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">675 <span class="_ _12d"> </span>jp-&gt;jobid,<span class="_"> </span>strerror(errno));</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">676 <span class="_ _82"> </span>goto<span class="_"> </span>defer;</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">677 <span class="_ _186"> </span>}</div><div class="t m0 x32 h57 y33ad ff1a fs2d fc0 sc0 ls0 ws0">678 <span class="_ _186"> </span>/*</div><div class="t m0 x32 h57 y33ae ff1a fs2d fc0 sc0 ls0 ws0">679 <span class="_ _176"> </span>*<span class="_"> </span>Set up the IPP header.</div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">680 <span class="_ _176"> </span>*/</div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">681 <span class="_ _186"> </span>icp<span class="_"> </span><span class="ls15c">=i<span class="_ _1d"></span><span class="ls0">buf;</span></span></div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">682 <span class="_ _186"> </span>hp<span class="_"> </span><span class="ls15c">=(<span class="_ _1d"></span><span class="ls0">struct ipp_hdr *)icp;</span></span></div><div class="t m0 x32 h57 y3b4c ff1a fs2d fc0 sc0 ls0 ws0">683 <span class="_ _186"> </span>hp-&gt;major_version<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y3b4d ff1a fs2d fc0 sc0 ls0 ws0">684 <span class="_ _186"> </span>hp-&gt;minor_version<span class="_"> </span><span class="ls15c">=1<span class="_ _1d"></span><span class="ls0">;</span></span></div><div class="t m0 x32 h57 y2f26 ff1a fs2d fc0 sc0 ls0 ws0">685 <span class="_ _186"> </span>hp-&gt;operation<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tons(OP_PRINT_JOB);</span></span></div><div class="t m0 x32 h57 y2f27 ff1a fs2d fc0 sc0 ls0 ws0">686 <span class="_ _186"> </span>hp-&gt;request_id<span class="_"> </span><span class="ls15c">=h<span class="_ _1d"></span><span class="ls0">tonl(jp-&gt;jobid);</span></span></div><div class="t m0 x32 h57 y2f28 ff1a fs2d fc0 sc0 ls0 ws0">687 <span class="_ _186"> </span>icp<span class="_"> </span>+= offsetof(struct ipp_hdr, attr_group);</div><div class="t m0 x32 h57 y2f29 ff1a fs2d fc0 sc0 ls0 ws0">688 <span class="_ _186"> </span>*icp++<span class="_"> </span><span class="ls15c">=T<span class="_ _1d"></span><span class="ls0">AG_OPERATION_ATTR;</span></span></div><div class="t m0 x32 h57 y2f2a ff1a fs2d fc0 sc0 ls0 ws0">689 <span class="_ _186"> </span>icp<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">dd_option(icp, TAG_CHARSET, &quot;attributes-charset&quot;,</span></span></div><div class="t m0 x32 h57 y2f2b ff1a fs2d fc0 sc0 ls0 ws0">690 <span class="_ _74"> </span>&quot;utf-8&quot;);</div><div class="t m0 x32 h57 y2f2c ff1a fs2d fc0 sc0 ls0 ws0">691 <span class="_ _186"> </span>icp<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">dd_option(icp, TAG_NATULANG,</span></span></div><div class="t m0 x32 h57 y2f2d ff1a fs2d fc0 sc0 ls0 ws0">692 <span class="_ _74"> </span>&quot;attributes-natural-language&quot;,<span class="_"> </span>&quot;en-us&quot;);</div><div class="t m0 x32 h57 y2f2e ff1a fs2d fc0 sc0 ls0 ws0">693 <span class="_ _186"> </span>sprintf(str,<span class="_"> </span>&quot;http://%s/ipp&quot;, printer_name);</div><div class="t m0 x32 h57 y2f2f ff1a fs2d fc0 sc0 ls0 ws0">694 <span class="_ _186"> </span>icp<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">dd_option(icp, TAG_URI, &quot;printer-uri&quot;, str);</span></span></div><div class="t m0 x32 h57 y2f30 ff1a fs2d fc0 sc0 ls0 ws0">695 <span class="_ _186"> </span>icp<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">dd_option(icp, TAG_NAMEWOLANG,</span></span></div><div class="t m0 x32 h57 y56fd ff1a fs2d fc0 sc0 ls0 ws0">696 <span class="_ _74"> </span>&quot;requesting-user-name&quot;,<span class="_"> </span>jp-&gt;req.usernm);</div><div class="t m0 x32 h57 y5848 ff1a fs2d fc0 sc0 ls0 ws0">697 <span class="_ _186"> </span>icp<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">dd_option(icp, TAG_NAMEWOLANG, &quot;job-name&quot;,</span></span></div><div class="t m0 x32 h57 y5849 ff1a fs2d fc0 sc0 ls0 ws0">698 <span class="_ _74"> </span>jp-&gt;req.jobnm);</div><div class="t m0 x32 h4d y5c45 ff19 fs26 fc0 sc0 ls0 ws0">[672 <span class="_ _a"></span>– <span class="_ _a"></span>677]<span class="_ _65"> </span><span class="ls164">We <span class="_ _47"> </span>o<span class="_ _9"></span></span>pen <span class="_ _23"> </span>a <span class="_ _23"></span>stream <span class="_ _9"></span>socket <span class="_ _23"> </span>connected <span class="_ _23"> </span>to <span class="_ _23"> </span>the <span class="_ _23"> </span>printer<span class="_ _1"></span><span class="ls17c1">.I<span class="_ _7"></span><span class="ls165c">ft<span class="_ _b"></span><span class="ls0">he<span class="_ _45"> </span><span class="ff1a">connect_retry</span></span></span></span></div><div class="t m0 x11a h4d y5c46 ff19 fs26 fc0 sc0 ls0 ws0">call <span class="_ _9"></span>fails, <span class="_ _23"> </span>we <span class="_ _23"></span>jump <span class="_ _9"></span>down <span class="_ _23"></span>to<span class="_ _45"> </span><span class="ff1a">defer</span><span class="ls17c2">,w<span class="_ _b"></span><span class="ls0">her<span class="ls17c2">ew<span class="_ _43"></span><span class="ls17c3">ew<span class="_ _b"></span><span class="ls0">ill <span class="_ _23"></span>clean <span class="_ _9"></span>up, <span class="_ _23"></span>delay<span class="_ _4"></span><span class="ls17c3">,a<span class="_ _b"></span><span class="ls0">nd <span class="_ _9"></span>try</span></span></span></span></span></span></span></div><div class="t m0 x11a h49 y5c47 ff19 fs26 fc0 sc0 ls0 ws0">again later<span class="_ _6"></span>.</div><div class="t m0 x32 h49 y5c74 ff19 fs26 fc0 sc0 ls0 ws0">[678 <span class="_ _a"></span>– <span class="_ _a"></span>698]<span class="_ _65"> </span>Next, we <span class="_ _2"></span>set <span class="_ _2"></span>up <span class="_ _2"></span>the <span class="_ _2"></span>IPP header<span class="_ _1"></span><span class="ls17c4">.T<span class="_ _5b"></span><span class="ls0">he <span class="_ _2"></span>operation <span class="_ _2"></span>is <span class="_ _2"></span>a print-job <span class="_ _2"></span>request. <span class="_"> </span>W<span class="_ _6"></span><span class="ls17c5">eu<span class="_ _d"></span><span class="ls0">se</span></span></span></span></div><div class="t m0 x11a h4d y5c75 ff1a fs26 fc0 sc0 ls0 ws0">htons<span class="_ _45"> </span><span class="ff19">to <span class="_ _23"> </span>convert <span class="_ _23"> </span>the <span class="_ _23"></span>2</span></div><div class="t m0 x85 h49 y5c76 ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x121 h49 y5c75 ff19 fs26 fc0 sc0 ls0 ws0">byte <span class="_ _23"></span>operation <span class="_ _9"></span>ID <span class="_ _23"> </span>from <span class="_ _23"></span>host <span class="_ _9"></span>to <span class="_ _23"> </span>network <span class="_ _23"> </span>byte <span class="_ _23"></span>order</div><div class="t m0 x11a h4d y5c77 ff19 fs26 fc0 sc0 ls0 ws0">and<span class="_ _44"> </span><span class="ff1a">htonl<span class="_ _44"> </span></span>to <span class="_ _42"> </span>convert <span class="_ _42"> </span>the <span class="_ _53"> </span>4</div><div class="t m0 x1df h49 y5c78 ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x19a h49 y5c77 ff19 fs26 fc0 sc0 ls0 ws0">byte <span class="_ _42"> </span>job <span class="_ _42"> </span>ID <span class="_ _53"> </span>from <span class="_ _42"> </span>host <span class="_ _42"> </span>to <span class="_ _53"> </span>network <span class="_ _42"> </span>byte <span class="_ _53"> </span>order<span class="_ _6"></span>.</div><div class="t m0 x11a h49 y5c79 ff19 fs26 fc0 sc0 ls0 ws0">After <span class="_ _23"></span>the <span class="_ _9"></span>initial <span class="_ _23"> </span>portion <span class="_ _23"> </span>of <span class="_ _23"></span>the <span class="_ _23"></span>header<span class="_ _6"></span>,<span class="_ _35"> </span>we<span class="_ _45"> </span>set <span class="_ _23"> </span>the <span class="_ _23"></span>tag <span class="_ _23"></span>value <span class="_ _9"></span>to <span class="_ _23"> </span>indicate <span class="_ _23"></span>that</div><div class="t m0 x11a h4d y5c7a ff19 fs26 fc0 sc0 ls0 ws0">operation <span class="_ _42"> </span>attributes <span class="_ _53"> </span>follow<span class="_ _6"></span><span class="ls17c6">.W<span class="_ _49"></span><span class="ls17c7">ec<span class="_ _43"></span><span class="ls0">all<span class="_ _44"> </span><span class="ff1a">add_option<span class="_ _44"> </span></span>to <span class="_ _53"> </span>add <span class="_ _53"> </span>attributes <span class="_ _42"> </span>to <span class="_ _53"> </span>the</span></span></span></div><div class="t m0 x11a h49 y5c7b ff19 fs26 fc0 sc0 ls0 ws0">message. <span class="_ _45"> </span>Figur<span class="ls17c8">e2<span class="_ _b"></span><span class="ls0">1.5 <span class="_ _9"></span>lists <span class="_ _9"></span>the <span class="_ _23"></span>r<span class="_ _0"></span>equired <span class="_ _9"></span>and <span class="_ _9"></span>optional <span class="_ _23"></span>attributes <span class="_ _9"></span>for <span class="_ _23"></span>print-job</span></span></div><div class="t m0 x11a h49 y5c7c ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">quests; <span class="_"> </span>the <span class="_"> </span>ﬁrst <span class="_"> </span>three <span class="_"> </span>ar<span class="_ _0"></span><span class="ls17c9">er<span class="_ _5b"></span><span class="ls0">equired. <span class="_ _59"> </span>W<span class="_ _6"></span><span class="ls17c9">es<span class="_ _4a"></span><span class="ls0">pecify <span class="_"> </span>the <span class="_"> </span>character <span class="_"> </span>set <span class="_"> </span>to <span class="_"> </span>be</span></span></span></span></span></div><div class="t m0 x11a h49 y5c7d ff19 fs26 fc0 sc0 ls0 ws0">UTF</div><div class="t m0 x54 h49 y5c7e ff19 fs26 fc0 sc0 ls0 ws0">-</div><div class="t m0 x8 h4d y5c7d ff19 fs26 fc0 sc0 ls0 ws0">8, <span class="_ _3"></span>which <span class="_ _3"></span>the <span class="_ _3"></span>printer <span class="_ _9"></span>must <span class="_ _3"></span>support.<span class="_ _16"> </span><span class="ls164">We <span class="_ _80"> </span>s<span class="_ _9"></span></span>pecify <span class="_ _9"></span>the <span class="_ _3"></span>language <span class="_ _3"></span>as<span class="_ _47"> </span><span class="ff1a">en-us</span>,</div><div class="t m0 x11a h49 y5c7f ff19 fs26 fc0 sc0 ls0 ws0">which <span class="_"> </span>represents <span class="_"> </span>U.S. <span class="_"> </span>English.<span class="_ _50"> </span>Another <span class="_"> </span>required <span class="_"> </span>attribute <span class="_"> </span>is <span class="_ _66"> </span>the <span class="_ _66"> </span>printer</div><div class="t m0 x11a h49 y5c80 ff19 fs26 fc0 sc0 ls0 ws0">Universal <span class="_ _3"></span>Resource <span class="_ _2"></span>Identiﬁer</div><div class="t m0 x207 h49 y5c81 ff19 fs26 fc0 sc0 ls0 ws0">(</div><div class="t m0 x67 h49 y5c80 ff19 fs26 fc0 sc0 ls0 ws0">URI</div><div class="t m0 x8d h49 y5c81 ff19 fs26 fc0 sc0 ls0 ws0">)</div><div class="t m0 x1de h4d y5c80 ff19 fs26 fc0 sc0 ls0 ws0">;<span class="_ _47"> </span>we<span class="_ _47"> </span>set <span class="_ _9"></span>it <span class="_ _3"></span>to<span class="_ _47"> </span><span class="ff1a">http://<span class="ff1b">printer_name</span>/ipp</span>.</div><div class="t m0 x11a h4d y5c82 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _47"> </span><span class="ff1a">requesting-user-name<span class="_ _45"> </span></span>attribute <span class="_ _3"></span>is <span class="_ _9"></span>recommended, <span class="_ _2"></span>but <span class="_ _9"></span>not <span class="_ _3"></span>required.</div><div class="t m0 x11a h4d y5c83 ff19 fs26 fc0 sc0 ls0 ws0">The<span class="_ _47"> </span><span class="ff1a">job-name<span class="_ _47"> </span></span>attribute <span class="_ _3"></span>is <span class="_ _3"></span>optional.<span class="_ _5a"> </span>Recall <span class="_ _2"></span>that <span class="_ _9"></span>the<span class="_ _47"> </span><span class="ff1a">print<span class="_ _47"> </span></span>command <span class="_ _3"></span>sends</div><div class="t m0 x11a h49 y5c84 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _42"> </span>name <span class="_ _53"> </span>of <span class="_ _53"> </span>the <span class="_ _42"> </span>ﬁle <span class="_ _53"> </span>being <span class="_ _53"> </span>printed <span class="_ _42"> </span>as <span class="_ _53"> </span>the <span class="_ _53"> </span>job <span class="_ _42"> </span>name, <span class="_ _53"> </span>which <span class="_ _53"> </span>can <span class="_ _42"> </span>help <span class="_ _53"> </span>users</div><div class="t m0 x11a h49 y5c85 ff19 fs26 fc0 sc0 ls0 ws0">distinguish among multiple pending jobs.</div><a class="l" href="http://printer_name/ipp"><div class="d m1" style="border-style:none;position:absolute;left:716.125217px;bottom:246.117895px;width:123.511017px;height:14.980011px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
