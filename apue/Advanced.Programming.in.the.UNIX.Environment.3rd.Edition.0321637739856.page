<div id="pf358" class="pf w4 h1f" data-page-no="358"><div class="pc pc358 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg358.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">822<span class="_ _1b"> </span><span class="ff19">Communicating <span class="_"> </span>with <span class="_"> </span>a <span class="_"> </span>Network <span class="_"> </span>Printer<span class="_ _23b"> </span>Chapter <span class="_"> </span>21</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">284 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">285 <span class="_ _68"> </span>*<span class="_"> </span>Remove a job from the list of pending jobs.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">286 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">287 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: caller must hold joblock.</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">288 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y56c6 ff1a fs2d fc0 sc0 ls0 ws0">289 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y56c7 ff1a fs2d fc0 sc0 ls0 ws0">290 <span class="_ _d9"> </span>remove_job(struct<span class="_"> </span>job *target)</div><div class="t m0 x32 h57 y56c8 ff1a fs2d fc0 sc0 ls0 ws0">291 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y56c9 ff1a fs2d fc0 sc0 ls0 ws0">292 <span class="_ _15"> </span>if<span class="_"> </span>(target-&gt;next != NULL)</div><div class="t m0 x32 h57 y56ca ff1a fs2d fc0 sc0 ls0 ws0">293 <span class="_ _186"> </span>target-&gt;next-&gt;prev<span class="_"> </span><span class="ls15c">=t<span class="_ _1d"></span><span class="ls0">arget-&gt;prev;</span></span></div><div class="t m0 x32 h57 y56cb ff1a fs2d fc0 sc0 ls0 ws0">294 <span class="_ _15"> </span>else</div><div class="t m0 x32 h57 y56cc ff1a fs2d fc0 sc0 ls0 ws0">295 <span class="_ _186"> </span>jobtail<span class="_"> </span><span class="ls15c">=t<span class="_ _1d"></span><span class="ls0">arget-&gt;prev;</span></span></div><div class="t m0 x32 h57 y56cd ff1a fs2d fc0 sc0 ls0 ws0">296 <span class="_ _15"> </span>if<span class="_"> </span>(target-&gt;prev != NULL)</div><div class="t m0 x32 h57 y56ce ff1a fs2d fc0 sc0 ls0 ws0">297 <span class="_ _186"> </span>target-&gt;prev-&gt;next<span class="_"> </span><span class="ls15c">=t<span class="_ _1d"></span><span class="ls0">arget-&gt;next;</span></span></div><div class="t m0 x32 h57 y56cf ff1a fs2d fc0 sc0 ls0 ws0">298 <span class="_ _15"> </span>else</div><div class="t m0 x32 h57 y56d0 ff1a fs2d fc0 sc0 ls0 ws0">299 <span class="_ _186"> </span>jobhead<span class="_"> </span><span class="ls15c">=t<span class="_ _1d"></span><span class="ls0">arget-&gt;next;</span></span></div><div class="t m0 x32 h57 y56d1 ff1a fs2d fc0 sc0 ls0 ws0">300 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y5717 ff1a fs2d fc0 sc0 ls0 ws0">301 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y5844 ff1a fs2d fc0 sc0 ls0 ws0">302 <span class="_ _68"> </span>*<span class="_"> </span>Check the spool directory for pending jobs on start-up.</div><div class="t m0 x32 h57 y5845 ff1a fs2d fc0 sc0 ls0 ws0">303 <span class="_ _68"> </span>*</div><div class="t m0 x32 h57 y5846 ff1a fs2d fc0 sc0 ls0 ws0">304 <span class="_ _68"> </span>*<span class="_"> </span>LOCKING: none.</div><div class="t m0 x32 h57 y5847 ff1a fs2d fc0 sc0 ls0 ws0">305 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y5ae2 ff1a fs2d fc0 sc0 ls0 ws0">306 <span class="_ _d9"> </span>void</div><div class="t m0 x32 h57 y5ae3 ff1a fs2d fc0 sc0 ls0 ws0">307 <span class="_ _d9"> </span>build_qonstart(void)</div><div class="t m0 x32 h57 y5ae4 ff1a fs2d fc0 sc0 ls0 ws0">308 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y5ae5 ff1a fs2d fc0 sc0 ls0 ws0">309 <span class="_ _15"> </span>int<span class="_ _166"> </span>fd, err, nr;</div><div class="t m0 x32 h57 y5ae6 ff1a fs2d fc0 sc0 ls0 ws0">310 <span class="_ _15"> </span>int32_t<span class="_ _176"> </span>jobid;</div><div class="t m0 x32 h57 y5bcf ff1a fs2d fc0 sc0 ls0 ws0">311 <span class="_ _15"> </span>DIR<span class="_ _166"> </span>*dirp;</div><div class="t m0 x32 h57 y5bd0 ff1a fs2d fc0 sc0 ls0 ws0">312 <span class="_ _15"> </span>struct<span class="_"> </span>dirent <span class="_ _d9"> </span>*entp;</div><div class="t m0 x32 h57 y5bd1 ff1a fs2d fc0 sc0 ls0 ws0">313 <span class="_ _15"> </span>struct<span class="_"> </span>printreq req;</div><div class="t m0 x32 h57 y5be1 ff1a fs2d fc0 sc0 ls0 ws0">314 <span class="_ _15"> </span>char<span class="_ _82"> </span>dname[FILENMSZ], fname[FILENMSZ];</div><div class="t m0 x32 h57 y584c ff1a fs2d fc0 sc0 ls0 ws0">315 <span class="_ _15"> </span>sprintf(dname,<span class="_"> </span>&quot;%s/%s&quot;, SPOOLDIR, REQDIR);</div><div class="t m0 x32 h57 y5be2 ff1a fs2d fc0 sc0 ls0 ws0">316 <span class="_ _15"> </span>if<span class="_"> </span>((dirp = opendir(dname)) == NULL)</div><div class="t m0 x32 h57 y5be3 ff1a fs2d fc0 sc0 ls0 ws0">317 <span class="_ _186"> </span>return;</div><div class="t m0 x32 h4d y5be4 ff19 fs26 fc0 sc0 ls0 ws0">[284 <span class="_ _a"></span>– <span class="_ _a"></span>300]<span class="_ _65"> </span><span class="ff1a">remove_job<span class="_ _47"> </span></span><span class="lscc">re<span class="_ _2"></span></span>moves <span class="_ _9"></span>a <span class="_ _3"></span>job <span class="_ _9"></span>from <span class="_ _2"></span>the <span class="_ _9"></span>list <span class="_ _9"></span>of <span class="_ _3"></span>pending <span class="_ _9"></span>jobs <span class="_ _3"></span>given <span class="_ _9"></span>a <span class="_ _3"></span>pointer <span class="_ _9"></span>to</div><div class="t m0 x11a h4d y5be5 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _2"></span>job <span class="_ _2"></span>to <span class="_ _3"></span>be <span class="_ _2"></span>removed. <span class="_ _66"> </span>The<span class="_ _47"> </span>caller <span class="_ _2"></span>must <span class="_ _2"></span>already <span class="_ _2"></span>hold <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">joblock<span class="_ _47"> </span></span>mutex. <span class="_ _66"> </span>If</div><div class="t m0 x11a h49 y5be6 ff19 fs26 fc0 sc0 ls0 ws0">the <span class="_ _9"></span>next <span class="_ _9"></span>pointer <span class="_ _23"></span>is <span class="_ _9"></span>non-null, <span class="_ _9"></span>we <span class="_ _23"></span>set <span class="_ _9"></span>the <span class="_ _9"></span>next <span class="_ _9"></span>entry’s <span class="_ _23"></span>previous <span class="_ _3"></span>pointer <span class="_ _23"></span>to <span class="_ _9"></span>the</div><div class="t m0 x11a h49 y5be7 ff19 fs26 fc0 sc0 ls0 ws0">target’s <span class="_ _3"></span>previous <span class="_ _3"></span>pointer<span class="_ _1"></span><span class="ls179d">.O<span class="_ _62"></span><span class="ls0">therwise, <span class="_ _9"></span>the <span class="_ _9"></span>entry <span class="_ _9"></span>is <span class="_ _9"></span>the <span class="_ _9"></span>last <span class="_ _9"></span>one <span class="_ _9"></span>on <span class="_ _9"></span>the <span class="_ _9"></span>list, <span class="_ _9"></span>so</span></span></div><div class="t m0 x11a h4d y5be8 ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _53"> </span>set<span class="_ _59"> </span><span class="ff1a">jobtail<span class="_ _4b"> </span></span>to <span class="_ _e"> </span>the <span class="_ _e"> </span>target’s <span class="_ _53"> </span>previous <span class="_ _53"> </span>pointer<span class="_ _1"></span><span class="ls179e">.I<span class="_ _64"></span><span class="ls179f">ft<span class="_ _55"></span><span class="ls0">he <span class="_ _e"> </span>target’s <span class="_ _53"> </span>previous</span></span></span></div><div class="t m0 x11a h49 y5be9 ff19 fs26 fc0 sc0 ls0 ws0">pointer <span class="_ _53"> </span>is <span class="_ _e"> </span>non-null, <span class="_ _53"> </span>we <span class="_ _e"> </span>set <span class="_ _53"> </span>the <span class="_ _e"> </span>previous <span class="_ _53"> </span>entry’s <span class="_ _53"> </span>next <span class="_ _e"> </span>pointer <span class="_ _e"> </span>equal <span class="_ _53"> </span>to <span class="_ _e"> </span>the</div><div class="t m0 x11a h49 y5bea ff19 fs26 fc0 sc0 ls0 ws0">target’s <span class="_ _9"></span>next <span class="_ _23"> </span>pointer<span class="_ _1"></span><span class="ls17a0">.O<span class="_ _26"></span><span class="ls0">therwise, <span class="_ _23"></span>this <span class="_ _23"></span>is <span class="_ _23"></span>the <span class="_ _23"></span>ﬁrst <span class="_ _23"></span>entry <span class="_ _23"></span>in <span class="_ _23"></span>the <span class="_ _23"></span>list, <span class="_ _23"></span>so <span class="_ _23"></span>we <span class="_ _23"></span>set</span></span></div><div class="t m0 x11a h4d y5beb ff1a fs26 fc0 sc0 ls0 ws0">jobhead<span class="_ _80"> </span><span class="ff19">to point to the next entry in the list after the target.</span></div><div class="t m0 x32 h4d y5bec ff19 fs26 fc0 sc0 ls0 ws0">[301 <span class="_ _a"></span>– <span class="_ _a"></span>317]<span class="_ _65"> </span>When <span class="_ _9"></span>the <span class="_ _23"></span>daemon <span class="_ _9"></span>starts, <span class="_ _23"></span>it <span class="_ _9"></span>calls<span class="_ _45"> </span><span class="ff1a">build_qonstart<span class="_ _35"> </span></span>to <span class="_ _9"></span>build <span class="_ _23"></span>an <span class="_ _9"></span>in-memory</div><div class="t m0 x11a h4d y5bed ff19 fs26 fc0 sc0 ls0 ws0">list <span class="_ _2"></span>of <span class="_ _3"></span>print <span class="_ _3"></span>jobs <span class="_ _2"></span>from <span class="_ _2"></span>the <span class="_ _3"></span>disk <span class="_ _3"></span>ﬁles <span class="_ _2"></span>stored <span class="_ _2"></span>in<span class="_ _47"> </span><span class="ff1a">/var/spool/printer/reqs</span>.</div><div class="t m0 x11a h49 y5bee ff19 fs26 fc0 sc0 ls0 ws0">If we can’t open the directory<span class="_ _4"></span>,<span class="_"> </span>no<span class="_"> </span>print jobs ar<span class="lsd3">ep<span class="_ _4f"></span><span class="ls0">ending, so we return.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
