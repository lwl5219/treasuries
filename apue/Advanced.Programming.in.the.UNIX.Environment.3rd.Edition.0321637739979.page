<div id="pf3d3" class="pf w4 h1f" data-page-no="3d3"><div class="pc pc3d3 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg3d3.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Appendix <span class="_"> </span>C<span class="_ _89"> </span>Chapter <span class="_"> </span>21<span class="_ _54"> </span>Solutions<span class="_ _1b"> </span><span class="ff18">945</span></div><div class="t m0 xe2 h2a y12f ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _9"></span>it <span class="_ _23"> </span>was <span class="_ _23"></span>not <span class="_ _9"></span>blank, <span class="_ _23"></span>and <span class="_ _23"></span>then <span class="_ _9"></span>read <span class="_ _9"></span>the <span class="_ _23"></span>data <span class="_ _9"></span>record, <span class="_ _9"></span>which <span class="_ _23"></span>could <span class="_ _9"></span>be <span class="_ _23"> </span>erased <span class="_ _23"></span>by</div><div class="t m0 xe2 h26 y130 ff1a fsf fc0 sc0 ls0 ws0">_db_dodelete<span class="_ _51"> </span><span class="ff19">between <span class="_ _35"> </span>the <span class="_ _35"> </span>calls <span class="_ _35"> </span>to<span class="_ _51"> </span></span>_db_readidx<span class="_ _51"> </span><span class="ff19">and<span class="_ _51"> </span></span>_db_readdat<span class="_ _51"> </span><span class="ff19">in</span></div><div class="t m0 xe2 h26 y131 ff1a fsf fc0 sc0 ls0 ws0">db_nextrec<span class="ff19">.</span></div><div class="t m0 x32 h26 y114e ff18 fsf fc0 sc0 ls0 ws0">20.2<span class="_ _210"> </span><span class="ff19">Assume <span class="_"> </span>that<span class="_ _44"> </span><span class="ff1a">db_nextrec<span class="_ _59"> </span></span>calls<span class="_ _4b"> </span><span class="ff1a">_db_readidx</span><span class="ls861">,w<span class="_ _55"></span><span class="ls0">hich <span class="_"> </span>r<span class="_ _1"></span>eads <span class="_"> </span>the <span class="_ _53"> </span>key <span class="_ _e"> </span>into <span class="_ _e"> </span>the</span></span></span></div><div class="t m0 xe2 h2a y2936 ff19 fsf fc0 sc0 ls0 ws0">index <span class="_ _53"> </span>buffer <span class="_ _42"> </span>for <span class="_ _53"> </span>the <span class="_ _53"> </span>process. <span class="_ _44"> </span>This<span class="_ _4b"> </span>process <span class="_ _42"> </span>is <span class="_ _53"> </span>then <span class="_ _53"> </span>stopped <span class="_ _53"> </span>by <span class="_ _53"> </span>the <span class="_ _53"> </span>kernel, <span class="_ _e"> </span>and</div><div class="t m0 xe2 h26 y2914 ff19 fsf fc0 sc0 ls0 ws0">another <span class="_ _2"></span>process <span class="_ _2"></span>runs. <span class="_ _47"> </span>This<span class="_ _47"> </span>other <span class="_ _2"></span>process <span class="_ _2"></span>calls<span class="_ _47"> </span><span class="ff1a">db_delete</span><span class="ls4e9">,a<span class="_ _4f"></span><span class="ls0">nd <span class="_ _2"></span>the <span class="_ _3"></span>recor<span class="_ _0"></span><span class="ls4ea">db<span class="_ _8"></span><span class="ls0">eing</span></span></span></span></div><div class="t m0 xe2 h2a y2915 ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ad <span class="_ _2"></span>by <span class="_ _2"></span>the other <span class="_ _2"></span>process is <span class="_ _2"></span>deleted.<span class="_ _46"> </span>Both <span class="_ _2"></span>its key <span class="_ _2"></span>and <span class="_ _2"></span>its <span class="_ _2"></span>data ar<span class="lsc85">er<span class="_ _8"></span><span class="ls0">ewritten <span class="_ _2"></span>in <span class="_ _2"></span>the</span></span></span></div><div class="t m0 xe2 h26 y2937 ff19 fsf fc0 sc0 ls0 ws0">two <span class="_ _3"></span>ﬁles <span class="_ _9"></span>as <span class="_ _9"></span>all <span class="_ _9"></span>blanks.<span class="_ _16"> </span>The <span class="_ _9"></span>ﬁrst <span class="_ _9"></span>process <span class="_ _3"></span>resumes <span class="_ _3"></span>and <span class="_ _9"></span>calls<span class="_ _45"> </span><span class="ff1a">_db_readdat<span class="_ _47"> </span></span>(from</div><div class="t m0 xe2 h26 y2938 ff1a fsf fc0 sc0 ls0 ws0">db_nextrec<span class="ff19 ls188c">)a<span class="_ _95"></span><span class="ls0">nd <span class="_ _5a"> </span>reads <span class="_ _16"> </span>the <span class="_ _5a"> </span>all-blank <span class="_ _51"> </span>data <span class="_ _16"> </span>record. <span class="_ _5f"> </span>The<span class="_ _1a3"> </span><span class="ls45">re<span class="_ _2"></span></span>ad <span class="_ _5a"> </span>lock <span class="_ _5a"> </span>by</span></span></div><div class="t m0 xe2 h26 yeb6 ff1a fsf fc0 sc0 ls0 ws0">db_nextrec<span class="_ _66"> </span><span class="ff19">allows it to <span class="_ _2"></span>do the <span class="_ _2"></span>read of the <span class="_ _2"></span>index record, followed by the <span class="_ _2"></span>read of</span></div><div class="t m0 xe2 h2a yeb7 ff19 fsf fc0 sc0 ls0 ws0">the <span class="_ _45"> </span>data <span class="_ _45"> </span>recor<span class="_ _0"></span>d, <span class="_ _45"> </span>as <span class="_ _45"> </span>an <span class="_ _45"> </span>atomic <span class="_ _45"> </span>operation <span class="_ _45"> </span>(with <span class="_ _45"> </span>regard<span class="_ _5a"> </span>to<span class="_ _5a"> </span>other <span class="_ _45"> </span>cooperating</div><div class="t m0 xe2 h2a yeb8 ff19 fsf fc0 sc0 ls0 ws0">processes using the same database).</div><div class="t m0 x32 h2a y961 ff18 fsf fc0 sc0 ls0 ws0">20.3<span class="_ _210"> </span><span class="ff19 ls65">Wi<span class="_ _3"></span><span class="ls0">th <span class="_ _2"></span>mandatory <span class="_ _2"></span>locking, <span class="_ _2"></span>other readers and <span class="_ _2"></span>writers <span class="_ _2"></span>ar<span class="ls11e7">ea<span class="_ _4f"></span><span class="ls45">ff<span class="ls0">ected. <span class="_ _66"> </span>Other<span class="_ _47"> </span></span>re<span class="ls0">ads <span class="_ _2"></span>and</span></span></span></span></span></div><div class="t m0 xe2 h26 y962 ff19 fsf fc0 sc0 ls0 ws0">writes <span class="_ _23"></span>ar<span class="ls188d">eb<span class="_ _43"></span><span class="ls0">locked <span class="_ _23"></span>by <span class="_ _23"></span>the <span class="_ _23"></span>kernel <span class="_ _23"></span>until <span class="_ _9"></span>the <span class="_ _23"> </span>locks <span class="_ _23"> </span>placed <span class="_ _23"> </span>by<span class="_ _35"> </span><span class="ff1a">_db_writeidx<span class="_ _35"> </span></span>and</span></span></div><div class="t m0 xe2 h26 y963 ff1a fsf fc0 sc0 ls0 ws0">_db_writedat<span class="_ _80"> </span><span class="ff19">ar<span class="ls44">er<span class="_ _4f"></span><span class="ls0">emoved.</span></span></span></div><div class="t m0 x32 h2a y3553 ff18 fsf fc0 sc0 ls0 ws0">20.5<span class="_ _210"> </span><span class="ff19">By <span class="_ _42"> </span>writing <span class="_ _42"> </span>the <span class="_ _53"> </span>data <span class="_ _42"> </span>recor<span class="_ _0"></span><span class="ls188e">db<span class="_ _c"></span><span class="ls0">efor<span class="ls188e">et<span class="_ _43"></span><span class="ls0">he <span class="_ _42"> </span>index <span class="_ _42"> </span>r<span class="_ _0"></span>ecord, <span class="_ _23"> </span>we <span class="_ _42"> </span>protect <span class="_ _42"> </span>ourselves <span class="_ _42"> </span>from</span></span></span></span></span></div><div class="t m0 xe2 h2a y1d9 ff19 fsf fc0 sc0 ls0 ws0">generating <span class="_ _23"> </span>a <span class="_ _23"> </span>corrupt <span class="_ _23"> </span>record<span class="_ _35"> </span>if<span class="_ _35"> </span>the <span class="_ _23"></span>process <span class="_ _23"></span>should <span class="_ _23"></span>be <span class="_ _23"> </span>killed <span class="_ _23"> </span>in <span class="_ _42"> </span>between <span class="_ _23"></span>the <span class="_ _23"> </span>two</div><div class="t m0 xe2 h2a y1da ff19 fsf fc0 sc0 ls0 ws0">writes. <span class="_ _35"> </span>If<span class="_ _35"> </span>the <span class="_ _42"> </span>process <span class="_ _23"> </span>were<span class="_ _35"> </span>to<span class="_ _35"> </span>write <span class="_ _42"> </span>the <span class="_ _23"> </span>index <span class="_ _42"> </span>recor<span class="_ _0"></span><span class="ls7f0">dﬁ<span class="_ _43"></span><span class="ls0">rst, <span class="_ _23"> </span>but <span class="_ _42"> </span>be <span class="_ _42"> </span>killed <span class="_ _23"> </span>before</span></span></div><div class="t m0 xe2 h2a y28dd ff19 fsf fc0 sc0 ls0 ws0">writing <span class="_ _53"> </span>the <span class="_ _e"> </span>data <span class="_ _e"> </span>recor<span class="_ _0"></span>d, <span class="_ _53"> </span>then <span class="_ _e"> </span>we’d <span class="_ _e"> </span>have <span class="_ _53"> </span>a <span class="_ _e"> </span>valid <span class="_ _e"> </span>index <span class="_ _e"> </span>recor<span class="_ _0"></span><span class="ls8ea">dt<span class="_ _55"></span><span class="ls0">hat <span class="_ _e"> </span>pointed <span class="_ _e"> </span>to</span></span></div><div class="t m0 xe2 h2a yec0 ff19 fsf fc0 sc0 ls0 ws0">invalid data.</div><div class="t m0 x35 h27 y6353 ff16 fsf fc0 sc0 ls0 ws0">Chapter <span class="_"> </span>21</div><div class="t m0 x32 h2a y6354 ff18 fsf fc0 sc0 ls0 ws0">21.5<span class="_ _210"> </span><span class="ff19">Her<span class="ls188f">ea<span class="_ _b"></span><span class="ls45">re <span class="_ _23"> </span>s<span class="_ _2"></span><span class="ls0">ome <span class="_ _9"></span>hints.<span class="_ _16"> </span>Ther<span class="ls1890">ea<span class="_ _b"></span><span class="ls45">re <span class="_ _23"></span>t<span class="ls0">wo <span class="_ _9"></span>places <span class="_ _9"></span>to <span class="_ _9"></span>check <span class="_ _9"></span>for <span class="_ _9"></span>queued <span class="_ _3"></span>jobs: <span class="_ _9"></span>the <span class="_ _9"></span>printer</span></span></span></span></span></span></span></div><div class="t m0 xe2 h2a y6355 ff19 fsf fc0 sc0 ls0 ws0">spooling daemon’s <span class="_ _2"></span>queue <span class="_ _2"></span>and <span class="_ _2"></span>the <span class="_ _2"></span>network <span class="_ _2"></span>printer<span class="_ _9"></span>’s <span class="_ _2"></span>internal <span class="_ _2"></span>queue.<span class="_ _61"> </span><span class="ls5f">Ta<span class="_ _9"></span></span>ke <span class="_ _2"></span>car<span class="ls1853">et<span class="_ _4f"></span><span class="ls0">o</span></span></div><div class="t m0 xe2 h2a y6356 ff19 fsf fc0 sc0 ls0 ws0">prevent <span class="_ _3"></span>one <span class="_ _9"></span>user <span class="_ _9"></span>from <span class="_ _9"></span>being <span class="_ _9"></span>able <span class="_ _9"></span>to <span class="_ _9"></span>cancel <span class="_ _9"></span>someone <span class="_ _9"></span>else’s <span class="_ _23"></span>print <span class="_ _9"></span>job.<span class="_ _5a"> </span>Of <span class="_ _9"></span>course,</div><div class="t m0 xe2 h2a y1d9b ff19 fsf fc0 sc0 ls0 ws0">the superuser should be able to cancel any job.</div><div class="t m0 x32 h2a y5086 ff18 fsf fc0 sc0 ls0 ws0">21.7<span class="_ _210"> </span><span class="ff19 ls5f">We <span class="_ _46"> </span>d<span class="_ _23"></span><span class="ls0">on’t <span class="_ _47"> </span>need <span class="_ _45"> </span>to <span class="_ _47"> </span>prod <span class="_ _45"> </span>the <span class="_ _47"> </span>daemon, <span class="_ _45"> </span>because <span class="_ _47"> </span>we <span class="_ _45"> </span>don’t <span class="_ _47"> </span>need <span class="_ _45"> </span>to <span class="_ _45"> </span>r<span class="_ _0"></span>eread <span class="_ _47"> </span>the</span></span></div><div class="t m0 xe2 h26 y5087 ff19 fsf fc0 sc0 ls0 ws0">conﬁguration <span class="_ _9"></span>ﬁle <span class="_ _9"></span>until <span class="_ _23"></span>we <span class="_ _9"></span>need <span class="_ _23"></span>to <span class="_ _9"></span>print <span class="_ _9"></span>a <span class="_ _23"></span>ﬁle.<span class="_ _5a"> </span>The<span class="_ _45"> </span><span class="ff1a">printer_thread<span class="_ _45"> </span></span>function</div><div class="t m0 xe2 h2a y5088 ff19 fsf fc0 sc0 ls0 ws0">checks <span class="_ _23"> </span>whether <span class="_ _42"> </span>it <span class="_ _23"> </span>needs <span class="_ _42"> </span>to <span class="_ _23"> </span>rer<span class="_ _0"></span>ead <span class="_ _23"> </span>the <span class="_ _42"> </span>conﬁguration <span class="_ _23"> </span>ﬁle <span class="_ _42"> </span>befor<span class="_ _0"></span><span class="ls1891">ee<span class="_ _43"></span><span class="ls0">ach <span class="_ _23"> </span>attempt <span class="_ _42"> </span>to</span></span></div><div class="t m0 xe2 h2a y5089 ff19 fsf fc0 sc0 ls0 ws0">send a job to the printer<span class="_ _6"></span>.</div><div class="t m0 x32 h26 y4fa9 ff18 fsf fc0 sc0 ls0 ws0">21.9<span class="_ _210"> </span><span class="ff19 ls5f">We <span class="_ _66"> </span>n<span class="_ _9"></span><span class="ls0">eed <span class="_ _9"></span>to <span class="_ _9"></span>null-terminate <span class="_ _9"></span>the <span class="_ _3"></span>string <span class="_ _9"></span>we <span class="_ _9"></span>write <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>job <span class="_ _9"></span>ﬁle <span class="_ _3"></span>(recall <span class="_ _9"></span>that<span class="_ _47"> </span><span class="ff1a">strlen</span></span></span></div><div class="t m0 xe2 h2a y61a5 ff19 fsf fc0 sc0 ls0 ws0">doesn’t <span class="_"> </span>include <span class="_"> </span>the <span class="_ _66"> </span>terminating <span class="_ _66"> </span>null <span class="_"> </span>byte <span class="_ _66"> </span>when <span class="_ _66"> </span>it <span class="_ _66"> </span>calculates <span class="_"> </span>the <span class="_ _66"> </span>length <span class="_ _66"> </span>of <span class="_ _66"> </span>a</div><div class="t m0 xe2 h2a y61a6 ff19 fsf fc0 sc0 ls0 ws0">string). <span class="_ _47"> </span>Ther<span class="lsd4f">ea<span class="_ _b"></span><span class="ls45">re <span class="_ _23"></span>t<span class="ls0">wo <span class="_ _9"></span>simple <span class="_ _3"></span>approaches: <span class="_ _3"></span>either <span class="_ _3"></span>we <span class="_ _9"></span>can <span class="_ _3"></span>add <span class="_ _9"></span>1 <span class="_ _3"></span>to <span class="_ _3"></span>the <span class="_ _9"></span>number <span class="_ _3"></span>of</span></span></span></div><div class="t m0 xe2 h26 y61a7 ff19 fsf fc0 sc0 ls0 ws0">bytes <span class="_ _2"></span>we <span class="_ _3"></span>write, <span class="_ _3"></span>or <span class="_ _3"></span>we <span class="_ _3"></span>can <span class="_ _3"></span>use <span class="_ _3"></span>the<span class="_ _47"> </span><span class="ff1a">dprintf<span class="_ _47"> </span></span>function <span class="_ _2"></span>instead <span class="_ _3"></span>of <span class="_ _3"></span>calling<span class="_ _47"> </span><span class="ff1a">sprintf</span></div><div class="t m0 xe2 h26 y61a8 ff19 fsf fc0 sc0 ls0 ws0">and<span class="_"> </span><span class="ff1a">write</span>.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
