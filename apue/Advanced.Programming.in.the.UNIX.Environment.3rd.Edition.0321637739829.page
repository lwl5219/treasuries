<div id="pf33d" class="pf w4 h1f" data-page-no="33d"><div class="pc pc33d w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="bg33d.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>21.5<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">795</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">names <span class="_"> </span>ar<span class="_ _1"></span><span class="ls1734">el<span class="_ _55"></span><span class="ls0">isted <span class="_"> </span>in<span class="_ _4b"> </span><span class="ff1a">/etc/hosts<span class="_ _59"> </span></span>or <span class="_"> </span>register<span class="_ _0"></span>ed <span class="_"> </span>with <span class="_ _e"> </span>whatever <span class="_"> </span>name <span class="_ _e"> </span>service <span class="_"> </span>we <span class="_ _e"> </span>are</span></span></div><div class="t m0 x32 h2a y130 ff19 fsf fc0 sc0 ls0 ws0">using, so that we can translate the names to network addresses.</div><div class="t m0 x3f h26 y131 ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _66"> </span>c<span class="_ _9"></span><span class="ls0">an <span class="_ _9"></span>run <span class="_ _3"></span>the<span class="_ _45"> </span><span class="ff1a">print<span class="_ _45"> </span></span>command <span class="_ _3"></span>on <span class="_ _9"></span>the <span class="_ _9"></span>same <span class="_ _9"></span>machine <span class="_ _9"></span>wher<span class="ls9df">et<span class="_ _b"></span><span class="ls0">he <span class="_ _3"></span>printer <span class="_ _9"></span>spooling</span></span></span></div><div class="t m0 x32 h2a y132 ff19 fsf fc0 sc0 ls0 ws0">daemon <span class="_ _3"></span>is <span class="_ _3"></span>running, <span class="_ _3"></span>or <span class="_ _3"></span>we <span class="_ _9"></span>can <span class="_ _3"></span>run <span class="_ _3"></span>it <span class="_ _3"></span>from <span class="_ _3"></span>any <span class="_ _3"></span>machine <span class="_ _3"></span>on <span class="_ _3"></span>the <span class="_ _9"></span>same <span class="_ _3"></span>network.<span class="_ _16"> </span><span class="ls5f">We <span class="_ _80"> </span>o<span class="_ _23"></span></span>nly</div><div class="t m0 x32 h26 y133 ff19 fsf fc0 sc0 ls0 ws0">need <span class="_ _23"></span>to <span class="_ _23"></span>conﬁgur<span class="ls117">et<span class="_ _43"></span><span class="ls0">he<span class="_ _35"> </span><span class="ff1a">printserver<span class="_ _45"> </span></span>ﬁeld <span class="_ _23"> </span>in<span class="_ _35"> </span><span class="ff1a">/etc/printer.conf<span class="_ _35"> </span></span>in <span class="_ _23"></span>the <span class="_ _23"></span>latter <span class="_ _23"></span>case,</span></span></div><div class="t m0 x32 h2a y134 ff19 fsf fc0 sc0 ls0 ws0">because only the daemon needs to know the name of the printer<span class="_ _6"></span>.</div><div class="t m0 x35 h27 yc38 ff16 fsf fc0 sc0 ls0 ws0">Security</div><div class="t m0 x32 h2a y59ef ff19 fsf fc0 sc0 ls0 ws0">Programs <span class="_ _42"> </span>that <span class="_ _e"> </span>run <span class="_ _53"> </span>with <span class="_ _53"> </span>superuser <span class="_ _53"> </span>privileges <span class="_ _e"> </span>have <span class="_ _53"> </span>the <span class="_ _e"> </span>potential <span class="_ _53"> </span>to <span class="_ _53"> </span>open <span class="_ _e"> </span>a <span class="_ _53"> </span>computer</div><div class="t m0 x32 h2a y4890 ff19 fsf fc0 sc0 ls0 ws0">system <span class="_ _53"> </span>up <span class="_"> </span>to <span class="_ _53"> </span>attack.<span class="_ _65"> </span>Such <span class="_"> </span>pr<span class="_ _1"></span>ograms <span class="_"> </span>usually <span class="_ _53"> </span>aren’t <span class="_ _53"> </span>mor<span class="ls1065">ev<span class="_ _55"></span><span class="ls0">ulnerable <span class="_ _53"> </span>than <span class="_ _e"> </span>any <span class="_ _e"> </span>other</span></span></div><div class="t m0 x32 h2a y17f8 ff19 fsf fc0 sc0 ls0 ws0">program, <span class="_ _42"> </span>but <span class="_ _53"> </span>when <span class="_ _53"> </span>compromised <span class="_ _42"> </span>can <span class="_ _e"> </span>lead <span class="_ _53"> </span>to <span class="_ _53"> </span>attackers <span class="_ _53"> </span>obtaining <span class="_ _53"> </span>full <span class="_ _53"> </span>access <span class="_ _53"> </span>to <span class="_ _53"> </span>your</div><div class="t m0 x32 h2a y17f9 ff19 fsf fc0 sc0 ls0 ws0">system.</div><div class="t m0 x3f h2a y17fa ff19 fsf fc0 sc0 ls0 ws0">The <span class="_ _3"></span>printer <span class="_ _3"></span>spooling <span class="_ _3"></span>daemon <span class="_ _3"></span>in <span class="_ _3"></span>this <span class="_ _3"></span>chapter <span class="_ _3"></span>starts <span class="_ _3"></span>out <span class="_ _3"></span>with <span class="_ _3"></span>superuser <span class="_ _3"></span>privileges <span class="_ _3"></span>in</div><div class="t m0 x32 h2a y17fb ff19 fsf fc0 sc0 ls0 ws0">this <span class="_ _3"></span>example <span class="_ _3"></span>to <span class="_ _3"></span>be <span class="_ _3"></span>able <span class="_ _3"></span>to <span class="_ _3"></span>bind <span class="_ _3"></span>a <span class="_ _9"></span>socket <span class="_ _2"></span>to <span class="_ _9"></span>a <span class="_ _3"></span>privileged <span class="_ _3"></span>TCP <span class="_ _3"></span>port <span class="_ _3"></span>number<span class="_ _6"></span><span class="ls1735">.T<span class="_ _7"></span><span class="ls1736">om<span class="_ _8"></span><span class="ls0">ake <span class="_ _9"></span>the</span></span></span></div><div class="t m0 x32 h2a y17fc ff19 fsf fc0 sc0 ls0 ws0">daemon less vulnerable to attack, we can</div><div class="t m0 x3f h2a y40e ff19 fsf fc0 sc0 ls49 ws0">•D<span class="_ _4d"></span><span class="ls0">esign <span class="_ _3"></span>the <span class="_ _3"></span>daemon <span class="_ _3"></span>to <span class="_ _3"></span>conform <span class="_ _9"></span>to <span class="_ _3"></span>the <span class="_ _3"></span>principles <span class="_ _3"></span>of <span class="_ _3"></span>least <span class="_ _9"></span>privilege <span class="_ _3"></span>(Section <span class="_ _3"></span>8.1<span class="_ _1"></span>1).</span></div><div class="t m0 x15 h2a y15ec ff19 fsf fc0 sc0 ls0 ws0">After <span class="_ _3"></span>we <span class="_ _3"></span>obtain <span class="_ _3"></span>a <span class="_ _3"></span>socket <span class="_ _3"></span>bound <span class="_ _3"></span>to <span class="_ _3"></span>a <span class="_ _3"></span>privileged <span class="_ _3"></span>port <span class="_ _3"></span>address, <span class="_ _3"></span>we <span class="_ _3"></span>can <span class="_ _3"></span>change <span class="_ _3"></span>the</div><div class="t m0 x15 h26 y59f0 ff19 fsf fc0 sc0 ls0 ws0">user <span class="_"> </span>and <span class="_ _66"> </span>group <span class="_"> </span>IDs <span class="_ _66"> </span>of <span class="_ _66"> </span>the <span class="_ _66"> </span>daemon <span class="_ _66"> </span>to <span class="_ _47"> </span>something <span class="_"> </span>other <span class="_ _66"> </span>than<span class="_ _46"> </span><span class="ff1a">root<span class="_ _61"> </span></span>(<span class="ff1a">lp</span><span class="ls1737">,f<span class="_ _5b"></span><span class="ls0">or</span></span></div><div class="t m0 x15 h2a yea2 ff19 fsf fc0 sc0 ls0 ws0">example). <span class="_ _66"> </span>All<span class="_ _47"> </span>the <span class="_ _2"></span>ﬁles <span class="_ _2"></span>and <span class="_ _3"></span>directories used <span class="_ _3"></span>to <span class="_ _2"></span>stor<span class="ls1738">eq<span class="_ _4f"></span><span class="ls0">ueued <span class="_ _2"></span>print <span class="_ _2"></span>jobs <span class="_ _2"></span>should <span class="_ _3"></span>be</span></span></div><div class="t m0 x15 h2a yea3 ff19 fsf fc0 sc0 ls0 ws0">owned <span class="_ _3"></span>by <span class="_ _9"></span>this <span class="_ _3"></span>nonprivileged <span class="_ _9"></span>user<span class="_ _6"></span><span class="ls1739">.T<span class="_ _1d"></span><span class="ls0">his <span class="_ _3"></span>way<span class="_ _6"></span><span class="ls4e3">,t<span class="_ _b"></span><span class="ls0">he <span class="_ _9"></span>daemon, <span class="_ _3"></span>if <span class="_ _9"></span>compromised, <span class="_ _2"></span>will</span></span></span></span></div><div class="t m0 x15 h2a yea4 ff19 fsf fc0 sc0 ls0 ws0">provide <span class="_ _9"></span>the <span class="_ _23"> </span>attacker <span class="_ _23"> </span>with <span class="_ _23"> </span>access <span class="_ _23"> </span>only <span class="_ _23"> </span>to <span class="_ _23"> </span>the <span class="_ _23"> </span>printing <span class="_ _23"> </span>subsystem.<span class="_ _51"> </span>This <span class="_ _23"></span>is <span class="_ _23"></span>still <span class="_ _23"></span>a</div><div class="t m0 x15 h2a yea5 ff19 fsf fc0 sc0 ls0 ws0">concern, <span class="_ _53"> </span>but <span class="_ _e"> </span>it <span class="_ _53"> </span>is <span class="_ _e"> </span>far <span class="_ _e"> </span>less <span class="_ _53"> </span>serious <span class="_ _e"> </span>than <span class="_ _53"> </span>an <span class="_ _e"> </span>attacker <span class="_ _e"> </span>getting <span class="_ _53"> </span>full <span class="_ _e"> </span>access <span class="_ _e"> </span>to <span class="_ _53"> </span>your</div><div class="t m0 x15 h2a yea6 ff19 fsf fc0 sc0 ls0 ws0">system.</div><div class="t m0 x3f h2a y15f2 ff19 fsf fc0 sc0 ls49 ws0">•A<span class="_ _4d"></span><span class="ls0">udit <span class="_ _3"></span>the <span class="_ _9"></span>daemon’s <span class="_ _3"></span>source <span class="_ _3"></span>code <span class="_ _3"></span>for <span class="_ _9"></span>all <span class="_ _3"></span>known <span class="_ _9"></span>potential <span class="_ _3"></span>vulnerabilities, <span class="_ _3"></span>such <span class="_ _9"></span>as</span></div><div class="t m0 x15 h2a y15f3 ff19 fsf fc0 sc0 ls0 ws0">buffer overr<span class="_ _0"></span>uns.</div><div class="t m0 x3f h2a y1bf ff19 fsf fc0 sc0 ls49 ws0">•L<span class="_ _4d"></span><span class="ls0">og <span class="_ _23"> </span>unexpected <span class="_ _23"> </span>or <span class="_ _42"> </span>suspicious <span class="_ _23"> </span>behavior <span class="_ _42"> </span>so <span class="_ _23"></span>that <span class="_ _23"> </span>an <span class="_ _42"> </span>administrator <span class="_ _23"> </span>can <span class="_ _23"> </span>take <span class="_ _42"> </span>note</span></div><div class="t m0 x15 h2a y1c0 ff19 fsf fc0 sc0 ls0 ws0">and investigate further<span class="_ _6"></span>.</div><div class="t m0 x35 h53 y59f1 ff16 fs2b fc0 sc0 ls0 ws0">21.5 <span class="_ _93"> </span>Source <span class="_"> </span>Code</div><div class="t m0 x32 h2a y59f2 ff19 fsf fc0 sc0 ls0 ws0">The source code <span class="_ _2"></span>for <span class="_ _2"></span>this <span class="_ _2"></span>chapter comprises <span class="_ _2"></span>ﬁve <span class="_ _2"></span>ﬁles, <span class="_ _2"></span>not including <span class="_ _2"></span>some <span class="_ _2"></span>of <span class="_ _2"></span>the common</div><div class="t m0 x32 h2a y59f3 ff19 fsf fc0 sc0 ls0 ws0">library routines we’ve used in earlier chapters:</div><div class="t m0 x3f h26 y59f4 ff1a fsf fc0 sc0 ls0 ws0">ipp.h<span class="_ _14"> </span><span class="ff19">Header ﬁle containing IPP deﬁnitions</span></div><div class="t m0 x3f h26 y292f ff1a fsf fc0 sc0 ls0 ws0">print.h<span class="_ _1b"> </span><span class="ff19">Header <span class="_ _9"></span>containing <span class="_ _9"></span>common <span class="_ _9"></span>constants, <span class="_ _9"></span>data <span class="_ _9"></span>structur<span class="_ _0"></span><span class="ls173a">ed<span class="_ _b"></span><span class="ls0">eﬁnitions, <span class="_ _9"></span>and</span></span></span></div><div class="t m0 x1e5 h2a y59f5 ff19 fsf fc0 sc0 ls0 ws0">utility routine declarations</div><div class="t m0 x3f h26 y59f6 ff1a fsf fc0 sc0 ls0 ws0">util.c<span class="_ _78"> </span><span class="ff19">Utility routines used by the two pr<span class="_ _1"></span>ograms</span></div><div class="t m0 x3f h26 y59f7 ff1a fsf fc0 sc0 ls0 ws0">print.c<span class="_ _1b"> </span><span class="ff19">The C source ﬁle for the command used to print a ﬁle</span></div><div class="t m0 x3f h26 y59f8 ff1a fsf fc0 sc0 ls0 ws0">printd.c<span class="_ _6e"> </span><span class="ff19">The C source ﬁle for the printer spooling daemon</span></div><div class="t m0 x32 h2a y4fbd ff19 fsf fc0 sc0 ls5f ws0">We <span class="_ _53"> </span>w<span class="_ _9"></span><span class="ls0">ill study each ﬁle in the order listed.</span></div><a class="l" href="#pf14" data-dest-detail='[20,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.893883px;bottom:445.848928px;width:113.112098px;height:19.678986px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
