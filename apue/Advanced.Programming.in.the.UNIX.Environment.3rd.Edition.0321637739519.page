<div id="pf207" class="pf w4 h1f" data-page-no="207"><div class="pc pc207 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg207.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>14.3<span class="_ _1f7"> </span>Recor<span class="ls30a">dL<span class="_ _55"></span><span class="ls0">ocking<span class="_ _1b"> </span><span class="ff18">485</span></span></span></div><div class="t m0 x35 h53 y12f ff16 fs2b fc0 sc0 ls0 ws0">14.3 <span class="_ _93"> </span>Recor<span class="ls1c3">dL<span class="_ _64"></span><span class="ls0">ocking</span></span></div><div class="t m0 x32 h2a y681 ff19 fsf fc0 sc0 ls0 ws0">What <span class="_ _42"> </span>happens <span class="_ _42"> </span>when <span class="_ _23"> </span>two <span class="_ _42"> </span>people <span class="_ _42"> </span>edit <span class="_ _42"> </span>the <span class="_ _42"> </span>same <span class="_ _42"> </span>ﬁle <span class="_ _42"> </span>at <span class="_ _42"> </span>the <span class="_ _42"> </span>same <span class="_ _23"> </span>time?<span class="_ _54"> </span>In <span class="_ _42"> </span>most <span class="_ _42"> </span>UNIX</div><div class="t m0 x32 h2a y683 ff19 fsf fc0 sc0 ls0 ws0">systems, <span class="_ _3"></span>the <span class="_ _9"></span>ﬁnal <span class="_ _9"></span>state <span class="_ _3"></span>of <span class="_ _9"></span>the <span class="_ _9"></span>ﬁle <span class="_ _3"></span>corresponds <span class="_ _3"></span>to <span class="_ _9"></span>the <span class="_ _9"></span>last <span class="_ _3"></span>process <span class="_ _3"></span>that <span class="_ _9"></span>wrote <span class="_ _3"></span>the <span class="_ _9"></span>ﬁle.<span class="_ _16"> </span>In</div><div class="t m0 x32 h2a y685 ff19 fsf fc0 sc0 ls0 ws0">some <span class="_ _23"> </span>applications, <span class="_ _23"> </span>however<span class="_ _1"></span><span class="lsca9">,s<span class="_ _43"></span><span class="ls0">uch <span class="_ _42"> </span>as <span class="_ _23"> </span>a <span class="_ _23"> </span>database <span class="_ _42"> </span>system, <span class="_ _23"> </span>a <span class="_ _42"> </span>pr<span class="_ _0"></span>ocess <span class="_ _23"> </span>needs <span class="_ _42"> </span>to <span class="_ _23"></span>be <span class="_ _23"> </span>certain</span></span></div><div class="t m0 x32 h2a y686 ff19 fsf fc0 sc0 ls0 ws0">that <span class="_ _23"> </span>it <span class="_ _42"> </span>alone <span class="_ _42"> </span>is <span class="_ _23"> </span>writing <span class="_ _42"> </span>to <span class="_ _42"> </span>a <span class="_ _23"> </span>ﬁle.<span class="_ _54"> </span><span class="ls5f">To <span class="_ _45"> </span>p<span class="_ _9"></span><span class="ls45">ro</span></span>vide <span class="_ _42"> </span>this <span class="_ _23"> </span>capability <span class="_ _42"> </span>for <span class="_ _42"> </span>processes <span class="_ _23"></span>that <span class="_ _42"> </span>need <span class="_ _23"> </span>it,</div><div class="t m0 x32 h2a y687 ff19 fsf fc0 sc0 ls0 ws0">commercial <span class="_ _47"> </span>UNIX <span class="_ _47"> </span>systems <span class="_ _47"> </span>provide <span class="_ _47"> </span>recor<span class="lsfd1">dl<span class="_ _62"></span><span class="ls0">ocking. <span class="_ _16"> </span>(In<span class="_ _16"> </span>Chapter <span class="_ _45"> </span>20, <span class="_ _47"> </span>we <span class="_ _47"> </span>develop <span class="_ _47"> </span>a</span></span></div><div class="t m0 x32 h2a y689 ff19 fsf fc0 sc0 ls0 ws0">database library that uses recor<span class="_ _0"></span><span class="ls44">dl<span class="_ _d"></span><span class="ls0">ocking.)</span></span></div><div class="t m0 x3f h2b y68a ff1b fsf fc0 sc0 ls0 ws0">Record <span class="_"> </span>locking<span class="_ _59"> </span><span class="ff19">is <span class="_"> </span>the <span class="_"> </span>term <span class="_ _e"> </span>normally <span class="_"> </span>used <span class="_"> </span>to <span class="_"> </span>describe <span class="_"> </span>the <span class="_ _e"> </span>ability <span class="_"> </span>of <span class="_"> </span>a <span class="_"> </span>pr<span class="_ _0"></span>ocess <span class="_"> </span>to</span></div><div class="t m0 x32 h2a y68b ff19 fsf fc0 sc0 ls0 ws0">prevent <span class="_ _53"> </span>other <span class="_"> </span>pr<span class="_ _0"></span>ocesses <span class="_ _e"> </span>from <span class="_ _e"> </span>modifying <span class="_"> </span>a <span class="_ _53"> </span>region <span class="_ _e"> </span>of <span class="_"> </span>a <span class="_ _53"> </span>ﬁle <span class="_"> </span>while <span class="_ _e"> </span>the <span class="_ _e"> </span>ﬁrst <span class="_"> </span>pr<span class="_ _0"></span>ocess <span class="_ _e"> </span>is</div><div class="t m0 x32 h2a y68c ff19 fsf fc0 sc0 ls45 ws0">re<span class="ls0">ading <span class="_ _42"> </span>or <span class="_ _42"> </span>modifying <span class="_ _23"> </span>that <span class="_ _42"> </span>portion <span class="_ _23"> </span>of <span class="_ _42"> </span>the <span class="_ _42"> </span>ﬁle.<span class="_ _51"> </span>Under <span class="_ _42"> </span>the <span class="_ _23"> </span>UNIX <span class="_ _42"> </span>System, <span class="_ _42"> </span>‘<span class="_ _1"></span>‘record’<span class="_ _1"></span>’<span class="_ _35"> </span>is<span class="_ _44"> </span>a</span></div><div class="t m0 x32 h2a y68d ff19 fsf fc0 sc0 ls0 ws0">misnomer; <span class="_ _2"></span>the <span class="_ _3"></span>UNIX <span class="_ _2"></span>kernel <span class="_ _3"></span>does <span class="_ _2"></span>not <span class="_ _3"></span>have <span class="_ _2"></span>a <span class="_ _3"></span>notion <span class="_ _3"></span>of <span class="_ _2"></span>records in <span class="_ _3"></span>a <span class="_ _2"></span>ﬁle.<span class="_ _16"> </span><span class="ls3f3">Ab<span class="_ _4f"></span><span class="ls0">etter <span class="_ _2"></span>term <span class="_ _3"></span>is</span></span></div><div class="t m0 x32 h2b y68e ff1b fsf fc0 sc0 ls0 ws0">byte-range locking<span class="ff19 ls44">,g<span class="_ _d"></span><span class="ls0">iven that it is a range of a ﬁle (possibly the entir<span class="ls44">eﬁ<span class="_ _d"></span><span class="ls0">le) that is locked.</span></span></span></span></div><div class="t m0 x35 h27 y3b7c ff16 fsf fc0 sc0 ls0 ws0">Histor <span class="_ _4f"></span>y</div><div class="t m0 x32 h2a y3b7d ff19 fsf fc0 sc0 ls0 ws0">One <span class="_ _53"> </span>of <span class="_ _e"> </span>the <span class="_ _e"> </span>criticisms <span class="_ _53"> </span>of <span class="_ _e"> </span>early <span class="_ _e"> </span>UNIX <span class="_ _e"> </span>systems <span class="_ _53"> </span>was <span class="_ _e"> </span>that <span class="_ _e"> </span>they <span class="_ _e"> </span>couldn’t <span class="_ _53"> </span>be <span class="_ _e"> </span>used <span class="_ _e"> </span>to <span class="_ _e"> </span>run</div><div class="t m0 x32 h2a y3b7e ff19 fsf fc0 sc0 ls0 ws0">database <span class="_ _e"> </span>systems, <span class="_ _e"> </span>because <span class="_ _e"> </span>they <span class="_ _e"> </span>did <span class="_ _e"> </span>not <span class="_ _e"> </span>support <span class="_ _e"> </span>locking <span class="_ _e"> </span>portions <span class="_ _e"> </span>of <span class="_ _e"> </span>ﬁles.<span class="_ _48"> </span>As <span class="_ _e"> </span>UNIX</div><div class="t m0 x32 h2a y3b7f ff19 fsf fc0 sc0 ls0 ws0">systems <span class="_ _2"></span>found <span class="_ _2"></span>their <span class="_ _3"></span>way <span class="_ _2"></span>into <span class="_ _3"></span>business <span class="_ _2"></span>computing <span class="_ _3"></span>environments, various <span class="_ _3"></span>groups <span class="_ _2"></span>added</div><div class="t m0 x32 h2a y3b80 ff19 fsf fc0 sc0 ls0 ws0">support for recor<span class="_ _0"></span><span class="ls44">dl<span class="_ _d"></span><span class="ls0">ocking (differ<span class="_ _0"></span>ently<span class="_ _4"></span>,<span class="_"> </span>of<span class="_"> </span>course).</span></span></div><div class="t m0 x3f h26 y3b81 ff19 fsf fc0 sc0 ls0 ws0">Early <span class="_ _53"> </span>Berkeley <span class="_ _e"> </span>releases <span class="_ _53"> </span>supported <span class="_ _e"> </span>only <span class="_ _e"> </span>the<span class="_ _4b"> </span><span class="ff1a">flock<span class="_ _4b"> </span></span>function. <span class="_ _59"> </span>This<span class="_ _4b"> </span>function <span class="_ _53"> </span>locks</div><div class="t m0 x32 h2a y3b82 ff19 fsf fc0 sc0 ls0 ws0">only entir<span class="ls44">eﬁ<span class="_ _4f"></span><span class="ls0">les, not regions of a ﬁle.</span></span></div><div class="t m0 x3f h26 y3b83 ff19 fsf fc0 sc0 ls0 ws0">Recor<span class="ls962">dl<span class="_ _8"></span><span class="ls0">ocking <span class="_ _2"></span>was <span class="_ _3"></span>added <span class="_ _2"></span>to <span class="_ _3"></span>System <span class="_ _3"></span>V <span class="_ _2"></span>Release <span class="_ _3"></span>3 <span class="_ _2"></span>through <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">fcntl<span class="_ _47"> </span></span>function. <span class="_ _47"> </span>The</span></span></div><div class="t m0 x32 h26 y3b84 ff1a fsf fc0 sc0 ls0 ws0">lockf<span class="_ _16"> </span><span class="ff19">function <span class="_ _45"> </span>was <span class="_ _47"> </span>built <span class="_ _45"> </span>on <span class="_ _47"> </span>top <span class="_ _47"> </span>of <span class="_ _45"> </span>this, <span class="_ _47"> </span>providing <span class="_ _47"> </span>a <span class="_ _45"> </span>simpliﬁed <span class="_ _47"> </span>interface.<span class="_ _1a3"> </span>These</span></div><div class="t m0 x32 h2a y3b85 ff19 fsf fc0 sc0 ls0 ws0">functions <span class="_ _3"></span>allowed <span class="_ _9"></span>callers <span class="_ _9"></span>to <span class="_ _3"></span>lock <span class="_ _9"></span>arbitrary <span class="_ _3"></span>byte <span class="_ _9"></span>ranges <span class="_ _9"></span>in <span class="_ _3"></span>a <span class="_ _9"></span>ﬁle, <span class="_ _9"></span>ranging <span class="_ _3"></span>from <span class="_ _3"></span>the <span class="_ _9"></span>entire</div><div class="t m0 x32 h2a y3b86 ff19 fsf fc0 sc0 ls0 ws0">ﬁle down to a single byte within the ﬁle.</div><div class="t m0 x3f h26 y3b87 ff19 fsf fc0 sc0 ls0 ws0">POSIX.1 <span class="_ _2"></span>chose <span class="_ _2"></span>to <span class="_ _3"></span>standardize on <span class="_ _3"></span>the<span class="_ _66"> </span><span class="ff1a">fcntl<span class="_ _47"> </span></span>approach. <span class="_ _66"> </span>Figur<span class="lsb09">e1<span class="_ _8"></span><span class="ls0">4.2 <span class="_ _3"></span>shows <span class="_ _2"></span>the <span class="_ _2"></span>forms</span></span></div><div class="t m0 x32 h2a y3b88 ff19 fsf fc0 sc0 ls0 ws0">of recor<span class="ls80b">dl<span class="_ _4f"></span><span class="ls0">ocking provided by <span class="_ _2"></span>various <span class="_ _2"></span>systems.<span class="_ _46"> </span>Note <span class="_ _2"></span>that the <span class="_ _2"></span>Single <span class="_ _2"></span>UNIX Speciﬁcation</span></span></div><div class="t m0 x32 h26 y3b89 ff19 fsf fc0 sc0 ls0 ws0">includes<span class="_"> </span><span class="ff1a">lockf<span class="_ _80"> </span></span>in the XSI option.</div><div class="t m0 x132 h5e y3b8a ff19 fs10 fc0 sc0 ls0 ws0">System <span class="_ _7a"> </span>Advisory<span class="_ _6e"> </span>Mandatory<span class="_ _6e"> </span><span class="ff1a">fcntl <span class="_ _60"> </span>lockf <span class="_ _65"> </span>flock</span></div><div class="t m0 x7b h2e y3b8b ff19 fs11 fc0 sc0 ls0 ws0">SUS <span class="_ _ac"> </span>•<span class="_ _146"> </span><span class="lsfd2">•X<span class="_ _a7"></span><span class="ls0">SI</span></span></div><div class="t m0 x7b h2f yb25 ff19 fs12 fc0 sc0 ls0 ws0">FreeBSD 8.0<span class="_ _7d"> </span><span class="lsfd3">••<span class="_ _2a0"></span><span class="lsfd4">••</span></span></div><div class="t m0 x7b h2f y3b8c ff19 fs12 fc0 sc0 ls0 ws0">Linux 3.2.0<span class="_ _165"> </span><span class="lsfd5">••<span class="_ _55"></span><span class="lsfd4">•••</span></span></div><div class="t m0 x7b h2f y3b8d ff19 fs12 fc0 sc0 ls0 ws0">Mac OS X 10.6.8<span class="_ _dc"> </span><span class="lsfd3">••<span class="_ _2a1"></span><span class="lsfd4">••</span></span></div><div class="t m0 x7b h2f y3b8e ff19 fs12 fc0 sc0 ls0 ws0">Solaris 10<span class="_ _1f0"> </span><span class="lsfd5">••<span class="_ _55"></span><span class="lsfd4">•••</span></span></div><div class="t m0 x1f h30 y604 ff18 fs13 fc0 sc0 ls0 ws0">Figure 14.2<span class="_ _5a"> </span><span class="ff19">Forms of recor<span class="ls673">dl<span class="_ _5"></span><span class="ls0">ocking supported by various UNIX systems</span></span></span></div><div class="t m0 x3f h6e y3b8f ff19 fs31 fc0 sc0 ls43f ws0">We <span class="_ _53"> </span>d<span class="_ _9"></span><span class="ls0">escribe the difference between advisory locking and mandatory locking later in</span></div><div class="t m0 x32 h64 y3b90 ff19 fs31 fc0 sc0 ls0 ws0">this section.<span class="_ _59"> </span>In this text, we describe only the POSIX.1<span class="_"> </span><span class="ff1a">fcntl<span class="_ _66"> </span></span>locking.</div><div class="t m0 x76 h30 y3b91 ff19 fs13 fc0 sc0 ls0 ws0">Recor<span class="lsfd6">dl<span class="_ _d"></span><span class="ls0">ocking <span class="_ _2"></span>was <span class="_ _3"></span>originally <span class="_ _3"></span>added <span class="_ _3"></span>to <span class="_ _2"></span>V<span class="_ _6"></span>ersion <span class="_ _3"></span>7 <span class="_ _3"></span>in <span class="_ _3"></span>1980 <span class="_ _3"></span>by <span class="_ _2"></span>John <span class="_ _3"></span>Bass.<span class="_ _4b"> </span>The <span class="_ _3"></span>system <span class="_ _3"></span>call <span class="_ _2"></span>entry</span></span></div><div class="t m0 x76 h63 y3b92 ff19 fs13 fc0 sc0 ls0 ws0">into <span class="_ _23"> </span>the <span class="_ _23"> </span>kernel <span class="_ _42"> </span>was <span class="_ _23"> </span>a <span class="_ _23"> </span>function <span class="_ _23"> </span>named<span class="_ _45"> </span><span class="ff1a">locking</span><span class="lsfd7">.T<span class="_ _5b"></span><span class="ls0">his <span class="_ _23"> </span>function <span class="_ _42"> </span>provided <span class="_ _23"> </span>mandatory <span class="_ _23"> </span>recor<span class="_ _0"></span>d</span></span></div><div class="t m0 x76 h30 y120f ff19 fs13 fc0 sc0 ls0 ws0">locking <span class="_ _9"></span>and <span class="_ _9"></span>propagated <span class="_ _9"></span>through <span class="_ _9"></span>many <span class="_ _9"></span>versions <span class="_ _9"></span>of <span class="_ _9"></span>System <span class="_ _9"> </span>III.<span class="_ _46"> </span>Xenix <span class="_ _9"></span>systems <span class="_ _9"></span>picked <span class="_ _9"> </span>up <span class="_ _23"> </span>this</div><div class="t m0 x76 h30 y3b93 ff19 fs13 fc0 sc0 ls0 ws0">function, <span class="_"> </span>and <span class="_ _42"> </span>some <span class="_"> </span>Intel-based <span class="_ _42"> </span>System <span class="_"> </span>V <span class="_ _42"> </span>derivatives, <span class="_"> </span>such <span class="_ _42"> </span>as <span class="_"> </span>OpenServer <span class="_ _42"> </span>5, <span class="_"> </span>continued <span class="_ _42"> </span>to</div><div class="t m0 x76 h30 y3b94 ff19 fs13 fc0 sc0 ls0 ws0">support it in a Xenix-compatibility library<span class="_ _6"></span>.</div><a class="l" href="#pf11" data-dest-detail='[17,"XYZ",50,757,1]'><div class="d m1" style="border-style:none;position:absolute;left:80.892409px;bottom:1236.288916px;width:129.539802px;height:19.679993px;background-color:rgba(255,255,255,0.000001);"></div></a></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
