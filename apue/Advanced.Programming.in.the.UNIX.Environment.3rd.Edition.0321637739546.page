<div id="pf222" class="pf w4 h1f" data-page-no="222"><div class="pc pc222 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg222.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff18 fs0 fc0 sc0 ls0 ws0">512<span class="_ _1b"> </span><span class="ff19">Advanced <span class="_"> </span>I/O<span class="_ _16b"> </span>Chapter <span class="_"> </span>14</span></div><div class="t m0 x32 h26 y12f ff19 fsf fc0 sc0 ls0 ws0">discuss shortly<span class="_ _6"></span><span class="ls10a4">.T<span class="_ _5b"></span><span class="ls0">he<span class="_"> </span><span class="ff1a">aio_sigevent<span class="_ _66"> </span></span>ﬁeld <span class="_ _2"></span>controls how the application <span class="_ _2"></span>is notiﬁed about</span></span></div><div class="t m0 x32 h26 y130 ff19 fsf fc0 sc0 ls0 ws0">the completion of the I/O event.<span class="_ _59"> </span>It is described by a<span class="_"> </span><span class="ff1a">sigevent<span class="_ _66"> </span></span>structure.</div><div class="t m0 x3f h57 y1a79 ff1a fs2d fc0 sc0 ls0 ws0">struct sigevent {</div><div class="t m0 xf4 h57 y3ebb ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>sigev_notify;<span class="_ _1e7"> </span>/* notify type */</div><div class="t m0 xf4 h57 y3ebc ff1a fs2d fc0 sc0 ls0 ws0">int <span class="_ _82"> </span>sigev_signo;<span class="_ _ce"> </span>/* signal number */</div><div class="t m0 xf4 h57 y3ebd ff1a fs2d fc0 sc0 ls0 ws0">union sigval<span class="_ _15"> </span>sigev_value; <span class="_ _1e7"> </span>/*<span class="_"> </span>notify argument */</div><div class="t m0 xf4 h57 y3ebe ff1a fs2d fc0 sc0 ls0 ws0">void (*sigev_notify_function)(union sigval); /* notify function */</div><div class="t m0 xf4 h57 y3ebf ff1a fs2d fc0 sc0 ls0 ws0">pthread_attr_t *sigev_notify_attributes;<span class="_ _8a"> </span>/* notify attrs */</div><div class="t m0 x3f h57 y3ec0 ff1a fs2d fc0 sc0 ls0 ws0">};</div><div class="t m0 x3f h26 y3ec1 ff19 fsf fc0 sc0 ls0 ws0">The<span class="_ _44"> </span><span class="ff1a">sigev_notify<span class="_ _44"> </span></span>ﬁeld <span class="_ _42"> </span>controls <span class="_ _42"> </span>the <span class="_ _42"> </span>type <span class="_ _42"> </span>of <span class="_ _42"> </span>notiﬁcation.<span class="_ _54"> </span>It <span class="_ _53"> </span>can <span class="_ _42"> </span>take <span class="_ _42"> </span>on <span class="_ _53"> </span>one <span class="_ _42"> </span>of</div><div class="t m0 x32 h2a y3ec2 ff19 fsf fc0 sc0 ls0 ws0">three values.</div><div class="t m0 x3f h26 y3ec3 ff1a fsf fc0 sc0 ls0 ws0">SIGEV_NONE<span class="_ _13f"> </span><span class="ff19">The <span class="_ _42"> </span>process <span class="_ _23"> </span>is <span class="_ _42"> </span>not <span class="_ _23"> </span>notiﬁed <span class="_ _42"> </span>when <span class="_ _42"> </span>the <span class="_ _23"> </span>asynchronous <span class="_ _42"> </span>I/O <span class="_ _23"> </span>request</span></div><div class="t m0 x12b h2a y3ec4 ff19 fsf fc0 sc0 ls0 ws0">completes.</div><div class="t m0 x3f h26 y3ec5 ff1a fsf fc0 sc0 ls0 ws0">SIGEV_SIGNAL<span class="_ _5c"> </span><span class="ff19">The <span class="_ _45"> </span>signal <span class="_ _45"> </span>speciﬁed <span class="_ _45"> </span>by <span class="_ _45"> </span>the<span class="_ _16"> </span></span>sigev_signo<span class="_"> </span><span class="ff19">ﬁeld <span class="_ _45"> </span>is <span class="_ _45"> </span>generated</span></div><div class="t m0 x12b h2a y3ec6 ff19 fsf fc0 sc0 ls0 ws0">when the <span class="_ _2"></span>asynchronous I/O request completes.<span class="_ _46"> </span>If <span class="_ _2"></span>the application</div><div class="t m0 x12b h26 y3ec7 ff19 fsf fc0 sc0 ls0 ws0">has <span class="_ _2"></span>elected <span class="_ _2"></span>to <span class="_ _2"></span>catch <span class="_ _2"></span>the <span class="_ _2"></span>signal <span class="_ _2"></span>and <span class="_ _2"></span>has <span class="_ _2"></span>speciﬁed <span class="_ _2"></span>the<span class="_ _47"> </span><span class="ff1a">SA_SIGINFO</span></div><div class="t m0 x12b h2a y3ec8 ff19 fsf fc0 sc0 ls0 ws0">ﬂag <span class="_ _2"></span>when <span class="_ _3"></span>establishing <span class="_ _3"></span>the <span class="_ _3"></span>signal <span class="_ _3"></span>handler<span class="_ _1"></span><span class="ls526">,t<span class="_ _8"></span><span class="ls0">he <span class="_ _3"></span>signal <span class="_ _3"></span>is <span class="_ _3"></span>queued <span class="_ _2"></span>(if</span></span></div><div class="t m0 x12b h2a y3ec9 ff19 fsf fc0 sc0 ls0 ws0">the implementation supports queued signals).<span class="_ _46"> </span>The signal handler</div><div class="t m0 x12b h26 y3eca ff19 fsf fc0 sc0 ls0 ws0">is <span class="_ _42"> </span>passed <span class="_ _53"> </span>a<span class="_ _44"> </span><span class="ff1a">siginfo<span class="_ _44"> </span></span>structur<span class="ls10a5">ew<span class="_ _c"></span><span class="ls0">hose<span class="_ _44"> </span><span class="ff1a">si_value<span class="_ _4b"> </span></span>ﬁeld <span class="_ _42"> </span>is <span class="_ _53"> </span>set <span class="_ _53"> </span>to</span></span></div><div class="t m0 x12b h26 y3ecb ff1a fsf fc0 sc0 ls0 ws0">sigev_value<span class="_ _80"> </span><span class="ff19">(again, if<span class="_"> </span></span>SA_SIGINFO<span class="_ _66"> </span><span class="ff19">is used).</span></div><div class="t m0 x3f h26 y3ecc ff1a fsf fc0 sc0 ls0 ws0">SIGEV_THREAD<span class="_ _5c"> </span><span class="ff19">The <span class="_ _3"></span>function <span class="_ _2"></span>speciﬁed <span class="_ _2"></span>by <span class="_ _3"></span>the<span class="_ _47"> </span></span>sigev_notify_function<span class="_ _66"> </span><span class="ff19">ﬁeld <span class="_ _3"></span>is</span></div><div class="t m0 x12b h2a y3ecd ff19 fsf fc0 sc0 ls0 ws0">called <span class="_ _35"> </span>when <span class="_ _44"> </span>the <span class="_ _35"> </span>asynchronous <span class="_ _35"> </span>I/O <span class="_ _35"> </span>request <span class="_ _35"> </span>completes.<span class="_ _98"> </span>It <span class="_ _35"> </span>is</div><div class="t m0 x12b h26 y3ece ff19 fsf fc0 sc0 ls0 ws0">passed <span class="_ _4b"> </span>the<span class="_ _48"> </span><span class="ff1a">sigev_value<span class="_ _48"> </span></span>ﬁeld <span class="_ _4b"> </span>as <span class="_ _59"> </span>its <span class="_ _4b"> </span>only <span class="_ _59"> </span>argument. <span class="_ _65"> </span>The</div><div class="t m0 x12b h2a y3ecf ff19 fsf fc0 sc0 ls0 ws0">function <span class="_"> </span>is <span class="_"> </span>executed <span class="_ _66"> </span>in <span class="_"> </span>a <span class="_ _66"> </span>separate <span class="_ _66"> </span>thread <span class="_"> </span>in <span class="_"> </span>a <span class="_ _66"> </span>detached <span class="_"> </span>state,</div><div class="t m0 x12b h26 y3ed0 ff19 fsf fc0 sc0 ls0 ws0">unless <span class="_ _4b"> </span>the<span class="_ _48"> </span><span class="ff1a">sigev_notify_attributes<span class="_ _65"> </span></span>ﬁeld <span class="_ _59"> </span>is <span class="_ _4b"> </span>set <span class="_ _4b"> </span>to <span class="_ _4b"> </span>the</div><div class="t m0 x12b h2a y3ed1 ff19 fsf fc0 sc0 ls0 ws0">address <span class="_"> </span>of <span class="_ _47"> </span>a <span class="_ _47"> </span>pthread <span class="_ _66"> </span>attribute <span class="_ _47"> </span>structur<span class="_ _0"></span><span class="lsd05">es<span class="_ _1d"></span><span class="ls0">pecifying <span class="_ _47"> </span>alternative</span></span></div><div class="t m0 x12b h2a y3ed2 ff19 fsf fc0 sc0 ls0 ws0">attributes for the thread.</div><div class="t m0 x3f h2a y3ed3 ff19 fsf fc0 sc0 ls5f ws0">To <span class="_ _66"> </span>p<span class="_ _9"></span><span class="ls0">erform <span class="_ _23"></span>asynchronous <span class="_ _3"></span>I/O, <span class="_ _23"></span>we <span class="_ _9"></span>need <span class="_ _9"></span>to <span class="_ _9"></span>initialize <span class="_ _23"></span>an <span class="_ _9"></span>AIO <span class="_ _9"></span>control <span class="_ _9"></span>block <span class="_ _9"></span>and <span class="_ _23"></span>call</span></div><div class="t m0 x32 h26 y3ed4 ff19 fsf fc0 sc0 ls0 ws0">either <span class="_ _45"> </span>the<span class="_ _16"> </span><span class="ff1a">aio_read<span class="_"> </span></span>function <span class="_ _47"> </span>to <span class="_ _45"> </span>make <span class="_ _47"> </span>an <span class="_ _45"> </span>asynchronous <span class="_ _47"> </span>read <span class="_ _47"> </span>or <span class="_ _45"> </span>the<span class="_ _16"> </span><span class="ff1a">aio_write</span></div><div class="t m0 x32 h2a y3ed5 ff19 fsf fc0 sc0 ls0 ws0">function to make an asynchronous write.</div><div class="t m0 x3f h57 y3ed6 ff1a fs2d fc0 sc0 ls0 ws0">#include &lt;aio.h&gt;</div><div class="t m0 x3f h57 y3ed7 ff1a fs2d fc0 sc0 ls0 ws0">int aio_read(struct aiocb *<span class="ff1b">aiocb</span>);</div><div class="t m0 x3f h57 y3ed8 ff1a fs2d fc0 sc0 ls0 ws0">int aio_write(struct aiocb *<span class="ff1b">aiocb</span>);</div><div class="t m0 x1af h5f y3ed9 ff19 fs2d fc0 sc0 ls0 ws0">Both return: 0 if OK,<span class="_"> </span><span class="ff20">−</span>1<span class="_"> </span>on<span class="_"> </span>err<span class="_ _0"></span>or</div><div class="t m0 x32 h49 y3eda ff19 fs26 fc0 sc0 ls0 ws0">When <span class="_ _23"> </span>these <span class="_ _42"> </span>functions <span class="_ _23"></span>return <span class="_ _23"></span>success, <span class="_ _23"> </span>the <span class="_ _42"> </span>asynchronous <span class="_ _23"></span>I/O <span class="_ _23"></span>request <span class="_ _23"></span>has <span class="_ _23"> </span>been <span class="_ _42"> </span>queued</div><div class="t m0 x32 h49 y3edb ff19 fs26 fc0 sc0 ls0 ws0">for <span class="_ _2"></span>processing <span class="_ _2"></span>by <span class="_ _3"></span>the <span class="_ _3"></span>operating <span class="_ _2"></span>system.<span class="_ _16"> </span>The <span class="_ _3"></span>return <span class="_ _2"></span>value <span class="_ _2"></span>bears <span class="_ _3"></span>no <span class="_ _3"></span>relation <span class="_ _2"></span>to <span class="_ _3"></span>the <span class="_ _2"></span>result</div><div class="t m0 x32 h49 y3edc ff19 fs26 fc0 sc0 ls0 ws0">of <span class="_ _2"></span>the <span class="_ _3"></span>actual <span class="_ _3"></span>I/O <span class="_ _3"></span>operation.<span class="_ _16"> </span>While <span class="_ _3"></span>the <span class="_ _3"></span>I/O <span class="_ _3"></span>operation <span class="_ _3"></span>is <span class="_ _3"></span>pending, <span class="_ _3"></span>we <span class="_ _3"></span>have <span class="_ _3"></span>to <span class="_ _2"></span>be <span class="_ _3"></span>careful</div><div class="t m0 x32 h49 y3edd ff19 fs26 fc0 sc0 ls0 ws0">to <span class="_ _42"> </span>ensur<span class="ls10a6">et<span class="_ _c"></span><span class="ls0">hat <span class="_ _42"> </span>the <span class="_ _53"> </span>AIO <span class="_ _42"> </span>control <span class="_ _42"> </span>block <span class="_ _53"> </span>and <span class="_ _42"> </span>data <span class="_ _42"> </span>buffer <span class="_ _42"> </span>remain <span class="_ _42"> </span>stable; <span class="_ _42"> </span>their <span class="_ _53"> </span>underlying</span></span></div><div class="t m0 x32 h49 y3ede ff19 fs26 fc0 sc0 ls0 ws0">memory <span class="_ _2"></span>must <span class="_ _2"></span>remain <span class="_ _2"></span>valid <span class="_ _2"></span>and <span class="_ _2"></span>we <span class="_ _2"></span>can’t <span class="_ _3"></span>reuse them <span class="_ _3"></span>until <span class="_ _2"></span>the <span class="_ _2"></span>I/O <span class="_ _2"></span>operation <span class="_ _3"></span>completes.</div><div class="t m0 x3f h49 y3edf ff19 fs26 fc0 sc0 ls164 ws0">To <span class="_ _80"> </span>f<span class="_ _9"></span><span class="ls0">orce <span class="_ _3"></span>all <span class="_ _3"></span>pending <span class="_ _3"></span>asynchronous <span class="_ _2"></span>writes <span class="_ _9"></span>to <span class="_ _3"></span>persistent <span class="_ _3"></span>storage <span class="_ _3"></span>without <span class="_ _3"></span>waiting, <span class="_ _3"></span>we</span></div><div class="t m0 x32 h4d y3ee0 ff19 fs26 fc0 sc0 ls0 ws0">can set up an AIO control block and call the<span class="_"> </span><span class="ff1a">aio_fsync<span class="_ _80"> </span></span>function.</div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
