<div id="pf327" class="pf w4 h1f" data-page-no="327"><div class="pc pc327 w4 h1f"><img class="bi x0 y0 w3 h4" alt="" src="apue/bg327.png"/><div class="t m0 x31 h2 y8e ff1 fs0 fc0 sc0 ls0 ws0"><span class="fc1 sc0">ptg10805159</span></div><div class="t m0 x35 h24 ya4 ff19 fs0 fc0 sc0 ls0 ws0">Section <span class="_"> </span>20.8<span class="_ _eb"> </span>Source <span class="_"> </span>Code<span class="_ _1fb"> </span><span class="ff18">773</span></div><div class="t m0 x32 h57 y362 ff1a fs2d fc0 sc0 ls0 ws0">532 <span class="_ _15"> </span>/*</div><div class="t m0 x32 h57 y3c0 ff1a fs2d fc0 sc0 ls0 ws0">533 <span class="_ _8a"> </span>*<span class="_"> </span>Position the index file and record the offset.</div><div class="t m0 x32 h57 y845 ff1a fs2d fc0 sc0 ls0 ws0">534 <span class="_ _8a"> </span>*/</div><div class="t m0 x32 h57 y56c4 ff1a fs2d fc0 sc0 ls0 ws0">535 <span class="_ _15"> </span>if<span class="_"> </span>((db-&gt;idxoff = lseek(db-&gt;idxfd, offset, whence)) == -1)</div><div class="t m0 x32 h57 y56c5 ff1a fs2d fc0 sc0 ls0 ws0">536 <span class="_ _186"> </span>err_dump(&quot;_db_writeidx:<span class="_"> </span>lseek error&quot;);</div><div class="t m0 x32 h57 y2015 ff1a fs2d fc0 sc0 ls0 ws0">537 <span class="_ _15"> </span>iov[0].iov_base<span class="_"> </span><span class="ls15c">=a<span class="_ _1d"></span><span class="ls0">sciiptrlen;</span></span></div><div class="t m0 x32 h57 y33ad ff1a fs2d fc0 sc0 ls0 ws0">538 <span class="_ _15"> </span>iov[0].iov_len<span class="_ _d9"> </span><span class="ls15c">=P<span class="_ _5b"></span><span class="ls0">TR_SZ + IDXLEN_SZ;</span></span></div><div class="t m0 x32 h57 y33ae ff1a fs2d fc0 sc0 ls0 ws0">539 <span class="_ _15"> </span>iov[1].iov_base<span class="_"> </span><span class="ls15c">=d<span class="_ _1d"></span><span class="ls0">b-&gt;idxbuf;</span></span></div><div class="t m0 x32 h57 y33af ff1a fs2d fc0 sc0 ls0 ws0">540 <span class="_ _15"> </span>iov[1].iov_len<span class="_ _d9"> </span><span class="ls15c">=l<span class="_ _5b"></span><span class="ls0">en;</span></span></div><div class="t m0 x32 h57 y33b0 ff1a fs2d fc0 sc0 ls0 ws0">541 <span class="_ _15"> </span>if<span class="_"> </span>(writev(db-&gt;idxfd, &amp;iov[0], 2) != PTR_SZ + IDXLEN_SZ + len)</div><div class="t m0 x32 h57 y419a ff1a fs2d fc0 sc0 ls0 ws0">542 <span class="_ _186"> </span>err_dump(&quot;_db_writeidx:<span class="_"> </span>writev error of index record&quot;);</div><div class="t m0 x32 h57 y2017 ff1a fs2d fc0 sc0 ls0 ws0">543 <span class="_ _15"> </span>if<span class="_"> </span>(whence == SEEK_END)</div><div class="t m0 x32 h57 y2018 ff1a fs2d fc0 sc0 ls0 ws0">544 <span class="_ _186"> </span>if<span class="_"> </span>(un_lock(db-&gt;idxfd, ((db-&gt;nhash+1)*PTR_SZ)+1,</div><div class="t m0 x32 h57 y2ad4 ff1a fs2d fc0 sc0 ls0 ws0">545 <span class="_ _74"> </span>SEEK_SET,<span class="_"> </span>0) &lt; 0)</div><div class="t m0 x32 h57 y2ad5 ff1a fs2d fc0 sc0 ls0 ws0">546 <span class="_ _82"> </span>err_dump(&quot;_db_writeidx:<span class="_"> </span>un_lock error&quot;);</div><div class="t m0 x32 h57 y2ad6 ff1a fs2d fc0 sc0 ls0 ws0">547 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h57 y201c ff1a fs2d fc0 sc0 ls0 ws0">548 <span class="_ _d9"> </span>/*</div><div class="t m0 x32 h57 y201d ff1a fs2d fc0 sc0 ls0 ws0">549 <span class="_ _68"> </span>*<span class="_"> </span>Write a chain ptr field somewhere in the index file:</div><div class="t m0 x32 h57 y201e ff1a fs2d fc0 sc0 ls0 ws0">550 <span class="_ _68"> </span>*<span class="_"> </span>the free list, the hash table, or in an index record.</div><div class="t m0 x32 h57 y201f ff1a fs2d fc0 sc0 ls0 ws0">551 <span class="_ _68"> </span>*/</div><div class="t m0 x32 h57 y2020 ff1a fs2d fc0 sc0 ls0 ws0">552 <span class="_ _d9"> </span>static<span class="_"> </span>void</div><div class="t m0 x32 h57 y2021 ff1a fs2d fc0 sc0 ls0 ws0">553 <span class="_ _d9"> </span>_db_writeptr(DB<span class="_"> </span>*db, off_t offset, off_t ptrval)</div><div class="t m0 x32 h57 y2022 ff1a fs2d fc0 sc0 ls0 ws0">554 <span class="_ _d9"> </span>{</div><div class="t m0 x32 h57 y5750 ff1a fs2d fc0 sc0 ls0 ws0">555 <span class="_ _15"> </span>char<span class="_ _15"> </span>asciiptr[PTR_SZ + 1];</div><div class="t m0 x32 h57 y2024 ff1a fs2d fc0 sc0 ls0 ws0">556 <span class="_ _15"> </span>if<span class="_"> </span>(ptrval &lt; 0 || ptrval &gt; PTR_MAX)</div><div class="t m0 x32 h57 y2adf ff1a fs2d fc0 sc0 ls0 ws0">557 <span class="_ _186"> </span>err_quit(&quot;_db_writeptr:<span class="_"> </span>invalid ptr: %d&quot;, ptrval);</div><div class="t m0 x32 h57 y458e ff1a fs2d fc0 sc0 ls0 ws0">558 <span class="_ _15"> </span>sprintf(asciiptr,<span class="_"> </span>&quot;%*lld&quot;, PTR_SZ, (long long)ptrval);</div><div class="t m0 x32 h57 y2027 ff1a fs2d fc0 sc0 ls0 ws0">559 <span class="_ _15"> </span>if<span class="_"> </span>(lseek(db-&gt;idxfd, offset, SEEK_SET) == -1)</div><div class="t m0 x32 h57 y2028 ff1a fs2d fc0 sc0 ls0 ws0">560 <span class="_ _186"> </span>err_dump(&quot;_db_writeptr:<span class="_"> </span>lseek error to ptr field&quot;);</div><div class="t m0 x32 h57 y2029 ff1a fs2d fc0 sc0 ls0 ws0">561 <span class="_ _15"> </span>if<span class="_"> </span>(write(db-&gt;idxfd, asciiptr, PTR_SZ) != PTR_SZ)</div><div class="t m0 x32 h57 y202a ff1a fs2d fc0 sc0 ls0 ws0">562 <span class="_ _186"> </span>err_dump(&quot;_db_writeptr:<span class="_"> </span>write error of ptr field&quot;);</div><div class="t m0 x32 h57 y4c81 ff1a fs2d fc0 sc0 ls0 ws0">563 <span class="_ _d9"> </span>}</div><div class="t m0 x32 h49 y57eb ff19 fs26 fc0 sc0 ls0 ws0">[532 <span class="_ _a"></span>– <span class="_ _a"></span>547]<span class="_ _65"> </span><span class="ls164">We <span class="_ _47"> </span>s<span class="_ _9"></span></span>eek <span class="_ _23"></span>to <span class="_ _9"></span>the <span class="_ _23"></span>location <span class="_ _23"></span>where<span class="_ _45"> </span>we<span class="_ _45"> </span>want <span class="_ _23"></span>to <span class="_ _23"></span>write <span class="_ _9"></span>the <span class="_ _23"> </span>index <span class="_ _23"></span>recor<span class="_ _1"></span><span class="ls4db">da<span class="_ _b"></span><span class="ls0">nd <span class="_ _23"></span>save</span></span></div><div class="t m0 x11a h4d y57ec ff19 fs26 fc0 sc0 ls0 ws0">this <span class="_ _9"></span>offset <span class="_ _3"></span>in <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">idxoff<span class="_ _47"> </span></span>ﬁeld <span class="_ _9"></span>of <span class="_ _9"></span>the<span class="_ _45"> </span><span class="ff1a">DB<span class="_ _45"> </span></span>structur<span class="_ _1"></span>e. <span class="_ _45"> </span>Since<span class="_ _45"> </span>we <span class="_ _9"></span>built <span class="_ _3"></span>the <span class="_ _9"></span>index</div><div class="t m0 x11a h4d y57ed ff19 fs26 fc0 sc0 lscc ws0">re<span class="ls0">cord<span class="_ _66"> </span>in<span class="_ _47"> </span>two separate <span class="_ _3"></span>buffers, we <span class="_ _2"></span>use<span class="_ _47"> </span><span class="ff1a">writev<span class="_ _66"> </span></span>to <span class="_ _2"></span>stor<span class="ls16ac">ei<span class="_ _4f"></span><span class="ls0">t<span class="_ _66"> </span>in<span class="_ _47"> </span>the index <span class="_ _2"></span>ﬁle.<span class="_ _61"> </span>If</span></span></span></div><div class="t m0 x11a h49 y57ee ff19 fs26 fc0 sc0 ls0 ws0">we <span class="_ _66"> </span>wer<span class="ls16ad">ea<span class="_ _1d"></span><span class="ls0">ppending <span class="_ _47"> </span>to <span class="_ _66"> </span>the <span class="_ _47"> </span>ﬁle, <span class="_"> </span>we <span class="_ _47"> </span>release <span class="_"> </span>the <span class="_ _66"> </span>lock <span class="_ _47"> </span>we <span class="_"> </span>acquired <span class="_ _66"> </span>before</span></span></div><div class="t m0 x11a h49 y57ef ff19 fs26 fc0 sc0 ls0 ws0">seeking. <span class="_ _35"> </span>This<span class="_ _44"> </span>makes <span class="_ _42"> </span>the <span class="_ _42"> </span>seek <span class="_ _23"> </span>and <span class="_ _42"> </span>the <span class="_ _42"> </span>write <span class="_ _42"> </span>an <span class="_ _42"> </span>atomic <span class="_ _42"> </span>operation <span class="_ _42"> </span>fr<span class="_ _0"></span>om <span class="_ _42"> </span>the</div><div class="t m0 x11a h49 y57f0 ff19 fs26 fc0 sc0 ls0 ws0">perspective of <span class="_ _2"></span>concurrently running processes appending <span class="_ _2"></span>new <span class="_ _2"></span>recor<span class="_ _0"></span>ds to <span class="_ _2"></span>the</div><div class="t m0 x11a h49 y57f1 ff19 fs26 fc0 sc0 ls0 ws0">same database.</div><div class="t m0 x32 h4d y57f2 ff19 fs26 fc0 sc0 ls0 ws0">[548 <span class="_ _a"></span>– <span class="_ _a"></span>563]<span class="_ _65"> </span><span class="ff1a">_db_writeptr<span class="_ _61"> </span></span>is <span class="_ _45"> </span>used <span class="_ _47"> </span>to <span class="_ _47"> </span>write <span class="_ _47"> </span>a <span class="_ _47"> </span>chain <span class="_ _47"> </span>pointer <span class="_ _47"> </span>to <span class="_ _47"> </span>the <span class="_ _45"> </span>index <span class="_ _66"> </span>ﬁle.<span class="_ _5f"> </span><span class="ls164">We</span></div><div class="t m0 x11a h49 y57f3 ff19 fs26 fc0 sc0 ls0 ws0">validate <span class="_ _3"></span>that <span class="_ _3"></span>the <span class="_ _3"></span>chain <span class="_ _3"></span>pointer <span class="_ _3"></span>is <span class="_ _3"></span>within <span class="_ _3"></span>bounds, <span class="_ _3"></span>then <span class="_ _3"></span>convert <span class="_ _3"></span>it <span class="_ _3"></span>to <span class="_ _3"></span>an <span class="_ _3"></span>ASCII</div><div class="t m0 x11a h49 y57f4 ff19 fs26 fc0 sc0 ls0 ws0">string. <span class="_"> </span>W<span class="_ _6"></span><span class="lsd3">es<span class="_ _d"></span><span class="ls0">eek to the speciﬁed offset in the index ﬁle and write the pointer<span class="_ _6"></span>.</span></span></div></div><div class="pi" data-data='{"ctm":[2.100000,0.000000,0.000000,2.100000,-115.668004,-156.491993]}'></div></div>
